<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for disks.py &amp; test_boto_apigateway.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for disks.py &amp; test_boto_apigateway.py
      </h3>
<h1 align="center">
        2.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>disks.py (13.58885%)<th>test_boto_apigateway.py (1.4783927%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(184-191)<td><a href="#" name="0">(1396-1405)</a><td align="center"><font color="#ff0000">15</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(139-145)<td><a href="#" name="1">(1589-1596)</a><td align="center"><font color="#cc0000">12</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(91-94)<td><a href="#" name="2">(1956-1969)</a><td align="center"><font color="#cc0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>disks.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import glob
2 import logging
3 import re
4 import salt.modules.cmdmod
5 import salt.utils.files
6 import salt.utils.path
7 import salt.utils.platform
8 __salt__ = {
9     "cmd.run": salt.modules.cmdmod._run_quiet,
10     "cmd.run_all": salt.modules.cmdmod._run_all_quiet,
11 }
12 log = logging.getLogger(__name__)
13 def disks():
14     if salt.utils.platform.is_freebsd():
15         return _freebsd_geom()
16     elif salt.utils.platform.is_linux():
17         return _linux_disks()
18     elif salt.utils.platform.is_windows():
19         return _windows_disks()
20     else:
21         log.trace("Disk grain does not support OS")
22 class _geomconsts:
23     GEOMNAME = "Geom name"
24     MEDIASIZE = "Mediasize"
25     SECTORSIZE = "Sectorsize"
26     STRIPESIZE = "Stripesize"
27     STRIPEOFFSET = "Stripeoffset"
28     DESCR = "descr"  # model
29     LUNID = "lunid"
30     LUNNAME = "lunname"
31     IDENT = "ident"  # serial
32     ROTATIONRATE = "rotationrate"  # RPM or 0 for non-rotating
33     _aliases = {
34         DESCR: "device_model",
35         IDENT: "serial_number",
36         ROTATIONRATE: "media_RPM",
37         LUNID: "WWN",
38     }
39     _datatypes = {
40         MEDIASIZE: ("re_int", r"(\d+)"),
41         SECTORSIZE: "try_int",
42         STRIPESIZE: "try_int",
43         STRIPEOFFSET: "try_int",
44         ROTATIONRATE: "try_int",
45     }
46 def _datavalue(datatype, data):
47     if datatype == "try_int":
48         try:
49             return int(data)
50         except ValueError:
51             return None
52     elif datatype is tuple and datatype[0] == "re_int":
53         search = re.search(datatype[1], data)
54         if search:
55             try:
56                 return int(search.group(1))
57             except ValueError:
58                 return None
59         return None
60     else:
61         return data
62 _geom_attribs = [
63     _geomconsts.__dict__[key] for key in _geomconsts.__dict__ if not key.startswith("_")
64 ]
65 <a name="2"></a>
66 def _freebsd_geom():
67     geom <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= salt.utils.path.which("geom")
68     ret = {"disks": {}, "ssds": []}
69     devices = __salt__["cmd.run"]("{} disk list".format(</b></font>geom))
70     devices = devices.split("\n\n")
71     def parse_geom_attribs(device):
72         tmp = {}
73         for line in device.split("\n"):
74             for attrib in _geom_attribs:
75                 search = re.search(r"{}:\s(.*)".format(attrib), line)
76                 if search:
77                     value = _datavalue(
78                         _geomconsts._datatypes.get(attrib), search.group(1)
79                     )
80                     tmp[attrib] = value
81                     if attrib in _geomconsts._aliases:
82                         tmp[_geomconsts._aliases[attrib]] = value
83         name = tmp.pop(_geomconsts.GEOMNAME)
84         if name.startswith("cd"):
85             return
86         ret["disks"][name] = tmp
87         if tmp.get(_geomconsts.ROTATIONRATE) == 0:
88             log.trace("Device %s reports itself as an SSD", device)
89             ret["ssds"].append(name)
90     for device in devices:
91         parse_geom_attribs(device)
92     return ret
93 def _linux_disks():
94     ret = {"disks": [], "ssds": []}
95     for entry in glob.glob("/sys/block/*"):
96         virtual = salt.utils.path.readlink(entry).startswith("../devices/virtual/")
97         try:
98             if not virtual:
99                 with salt.utils.files.fopen(entry + "/queue/rotational") as entry_fp:
100 <a name="1"></a>                    device = entry.split("/")[3]
101                     flag = entry_fp.read(1)
102                     if flag == "0":
103                         ret<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["ssds"].append(device)
104                         log.trace("Device %s reports itself as an SSD", device)
105                     elif flag == "1":
106                         ret["disks"].append(device)
107                         log.trace("Device %s reports itself as an HDD", device)
108                     else:
109                         log.trace(</b></font>
110                             "Unable to identify device %s as an SSD or HDD. It does "
111                             "not report 0 or 1",
112                             device,
113                         )
114         except OSError:
115             pass
116     return ret
117 def _windows_disks():
118     wmic = salt.utils.path.which("wmic")
119     namespace = r"\\root\microsoft\windows\storage"
120     path = "MSFT_PhysicalDisk"
121     get = "DeviceID,MediaType"
122     ret = {"disks": [], "ssds": []}
123     cmdret = __salt__["cmd.run_all"](
124         "{} /namespace:{} path {} get {} /format:table".format(
125             wmic, namespace, path, get
126         )
127     )
128     if cmdret["retcode"] != 0:
129         log.trace("Disk grain does not support this version of Windows")
130     else:
131         for line in cmdret["stdout"].splitlines():
132             info = line.split()
133             if len(info) != 2 or not info[0].isdigit() or not info[1].isdigit():
134                 continue
135             device = r"\\.\PhysicalDrive{}".format(info[0])
136             mediatype = info[1]
137             if mediatype == "3":
138                 log.trace("Device %s reports itself as an HDD", device)
139 <a name="0"></a>                ret["disks"].append(device)
140             elif mediatype == "4":
141                 log.trace("Device %s reports itself as an SSD", device)
142                 ret["ssds"]<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.append(device)
143                 ret["disks"].append(device)
144             elif mediatype == "5":
145                 log.trace("Device %s reports itself as an SCM", device)
146                 ret["disks"].append(device)
147             else:
148                 log.trace("Device %s reports itself as Unspecified", device)
149                 ret["disks"].append(</b></font>device)
150     return ret
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_boto_apigateway.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import datetime
2 import logging
3 import os
4 import random
5 import string
6 import pytest
7 import salt.config
8 import salt.loader
9 import salt.states.boto_apigateway as boto_apigateway
10 import salt.utils.files
11 import salt.utils.yaml
12 from salt.utils.versions import LooseVersion
13 from tests.support.mixins import LoaderModuleMockMixin
14 from tests.support.mock import MagicMock, patch
15 from tests.support.unit import TestCase, skipIf
16 from tests.unit.modules.test_boto_apigateway import BotoApiGatewayTestCaseMixin
17 try:
18     import boto3
19     import botocore
20     from botocore.exceptions import ClientError
21     HAS_BOTO = True
22 except ImportError:
23     HAS_BOTO = False
24 required_boto3_version = "1.2.1"
25 required_botocore_version = "1.4.49"
26 region = "us-east-1"
27 access_key = "GKTADJGHEIQSXMKKRBJ08H"
28 secret_key = "askdjghsdfjkghWupUjasdflkdfklgjsdfjajkghs"
29 conn_parameters = {
30     "region": region,
31     "key": access_key,
32     "keyid": secret_key,
33     "profile": {},
34 }
35 error_message = (
36     "An error occurred (101) when calling the {0} operation: Test-defined error"
37 )
38 error_content = {"Error": {"Code": 101, "Message": "Test-defined error"}}
39 api_ret = dict(
40     description=(
41         '{\n    "context": "See deployment or stage description",\n   '
42         ' "provisioned_by": "Salt boto_apigateway.present State"\n}'
43     ),
44     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
45     id="vni0vq8wzi",
46     name="unit test api",
47 )
48 no_apis_ret = {"items": []}
49 apis_ret = {"items": [api_ret]}
50 mock_model_ret = dict(
51     contentType="application/json",
52     description="mock model",
53     id="123abc",
54     name="mock model",
55     schema=(
56         "{\n"
57         '    "$schema": "http://json-schema.org/draft-04/schema#",\n'
58         '    "properties": {\n'
59         '        "field": {\n'
60         '            "type": "string"\n'
61         "        }\n"
62         "    }\n"
63         "}"
64     ),
65 )
66 models_ret = {
67     "items": [
68         dict(
69             contentType="application/json",
70             description="Error",
71             id="50nw8r",
72             name="Error",
73             schema=(
74                 "{\n"
75                 '    "$schema": "http://json-schema.org/draft-04/schema#",\n'
76                 '    "properties": {\n'
77                 '        "code": {\n'
78                 '            "format": "int32",\n'
79                 '            "type": "integer"\n'
80                 "        },\n"
81                 '        "fields": {\n'
82                 '            "type": "string"\n'
83                 "        },\n"
84                 '        "message": {\n'
85                 '            "type": "string"\n'
86                 "        }\n"
87                 "    },\n"
88                 '    "title": "Error Schema",\n'
89                 '    "type": "object"\n'
90                 "}"
91             ),
92         ),
93         dict(
94             contentType="application/json",
95             description="User",
96             id="terlnw",
97             name="User",
98             schema=(
99                 "{\n"
100                 '    "$schema": "http://json-schema.org/draft-04/schema#",\n'
101                 '    "properties": {\n'
102                 '        "password": {\n'
103                 '            "description": "A password for the new user",\n'
104                 '            "type": "string"\n'
105                 "        },\n"
106                 '        "username": {\n'
107                 '            "description": "A unique username for the user",\n'
108                 '            "type": "string"\n'
109                 "        }\n"
110                 "    },\n"
111                 '    "title": "User Schema",\n'
112                 '    "type": "object"\n'
113                 "}"
114             ),
115         ),
116     ]
117 }
118 root_resources_ret = {"items": [dict(id="bgk0rk8rqb", path="/")]}
119 resources_ret = {
120     "items": [
121         dict(id="bgk0rk8rqb", path="/"),
122         dict(
123             id="9waiaz",
124             parentId="bgk0rk8rqb",
125             path="/users",
126             pathPart="users",
127             resourceMethods={"POST": {}},
128         ),
129     ]
130 }
131 no_resources_ret = {"items": []}
132 stage1_deployment1_ret = dict(
133     cacheClusterEnabled=False,
134     cacheClusterSize=0.5,
135     cacheClusterStatus="NOT_AVAILABLE",
136     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
137     deploymentId="kobnrb",
138     description=(
139         "{\n"
140         '    "current_deployment_label": {\n'
141         '        "api_name": "unit test api",\n'
142         '        "swagger_file": "temp-swagger-sample.yaml",\n'
143         '        "swagger_file_md5sum": "4fb17e43bab3a96e7f2410a1597cd0a5",\n'
144         '        "swagger_info_object": {\n'
145         '            "description": "salt boto apigateway unit test service",\n'
146         '            "title": "salt boto apigateway unit test service",\n'
147         '            "version": "0.0.0"\n'
148         "        }\n"
149         "    }\n"
150         "}"
151     ),
152     lastUpdatedDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
153     methodSettings=dict(),
154     stageName="test",
155     variables=dict(),
156 )
157 stage1_deployment1_vars_ret = dict(
158     cacheClusterEnabled=False,
159     cacheClusterSize=0.5,
160     cacheClusterStatus="NOT_AVAILABLE",
161     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
162     deploymentId="kobnrb",
163     description=(
164         "{\n"
165         '    "current_deployment_label": {\n'
166         '        "api_name": "unit test api",\n'
167         '        "swagger_file": "temp-swagger-sample.yaml",\n'
168         '        "swagger_file_md5sum": "4fb17e43bab3a96e7f2410a1597cd0a5",\n'
169         '        "swagger_info_object": {\n'
170         '            "description": "salt boto apigateway unit test service",\n'
171         '            "title": "salt boto apigateway unit test service",\n'
172         '            "version": "0.0.0"\n'
173         "        }\n"
174         "    }\n"
175         "}"
176     ),
177     lastUpdatedDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
178     methodSettings=dict(),
179     stageName="test",
180     variables={"var1": "val1"},
181 )
182 stage1_deployment2_ret = dict(
183     cacheClusterEnabled=False,
184     cacheClusterSize=0.5,
185     cacheClusterStatus="NOT_AVAILABLE",
186     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
187     deploymentId="kobnrc",
188     description=(
189         "{\n"
190         '    "current_deployment_label": {\n'
191         '        "api_name": "unit test api",\n'
192         '        "swagger_file": "temp-swagger-sample.yaml",\n'
193         '        "swagger_file_md5sum": "5fd538c4336ed5c54b4bf39ddf97c661",\n'
194         '        "swagger_info_object": {\n'
195         '            "description": "salt boto apigateway unit test service",\n'
196         '            "title": "salt boto apigateway unit test service",\n'
197         '            "version": "0.0.2"\n'
198         "        }\n"
199         "    }\n"
200         "}"
201     ),
202     lastUpdatedDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
203     methodSettings=dict(),
204     stageName="test",
205     variables=dict(),
206 )
207 stage2_ret = dict(
208     cacheClusterEnabled=False,
209     cacheClusterSize=0.5,
210     cacheClusterStatus="NOT_AVAILABLE",
211     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
212     deploymentId="kobnrb",
213     description=(
214         "{\n"
215         '    "current_deployment_label": {\n'
216         '        "api_name": "unit test api",\n'
217         '        "swagger_file": "temp-swagger-sample.yaml",\n'
218         '        "swagger_file_md5sum": "4fb17e43bab3a96e7f2410a1597cd0a5",\n'
219         '        "swagger_info_object": {\n'
220         '            "description": "salt boto apigateway unit test service",\n'
221         '            "title": "salt boto apigateway unit test service",\n'
222         '            "version": "0.0.0"\n'
223         "        }\n"
224         "    }\n"
225         "}"
226     ),
227     lastUpdatedDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
228     methodSettings=dict(),
229     stageName="dev",
230     variables=dict(),
231 )
232 stages_stage2_ret = {"item": [stage2_ret]}
233 no_stages_ret = {"item": []}
234 deployment1_ret = dict(
235     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
236     description=(
237         "{\n"
238         '    "api_name": "unit test api",\n'
239         '    "swagger_file": "temp-swagger-sample.yaml",\n'
240         '    "swagger_file_md5sum": "55a948ff90ad80ff747ec91657c7a299",\n'
241         '    "swagger_info_object": {\n'
242         '        "description": "salt boto apigateway unit test service",\n'
243         '        "title": "salt boto apigateway unit test service",\n'
244         '        "version": "0.0.0"\n'
245         "    }\n"
246         "}"
247     ),
248     id="kobnrb",
249 )
250 deployment2_ret = dict(
251     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
252     description=(
253         "{\n"
254         '    "api_name": "unit test api",\n'
255         '    "swagger_file": "temp-swagger-sample.yaml",\n'
256         '    "swagger_file_md5sum": "5fd538c4336ed5c54b4bf39ddf97c661",\n'
257         '    "swagger_info_object": {\n'
258         '        "description": "salt boto apigateway unit test service",\n'
259         '        "title": "salt boto apigateway unit test service",\n'
260         '        "version": "0.0.2"\n'
261         "    }\n"
262         "}"
263     ),
264     id="kobnrc",
265 )
266 deployments_ret = {"items": [deployment1_ret, deployment2_ret]}
267 function_ret = dict(
268     FunctionName="unit_test_api_users_post",
269     Runtime="python2.7",
270     Role=None,
271     Handler="handler",
272     Description="abcdefg",
273     Timeout=5,
274     MemorySize=128,
275     CodeSha256="abcdef",
276     CodeSize=199,
277     FunctionArn="arn:lambda:us-east-1:1234:Something",
278     LastModified="yes",
279 )
280 method_integration_response_200_ret = dict(
281     responseParameters={"method.response.header.Access-Control-Allow-Origin": "*"},
282     responseTemplates={},
283     selectionPattern=".*",
284     statusCode="200",
285 )
286 method_integration_ret = dict(
287     cacheKeyParameters={},
288     cacheNamespace="9waiaz",
289     credentials="arn:aws:iam::1234:role/apigatewayrole",
290     httpMethod="POST",
291     integrationResponses={"200": method_integration_response_200_ret},
292     requestParameters={},
293     requestTemplates={
294         "application/json": (
295             "#set($inputRoot = $input.path('$')){\"header-params\" : {#set ($map ="
296             ' $input.params().header)#foreach( $param in $map.entrySet() )"$param.key"'
297             ' : "$param.value" #if( $foreach.hasNext ), #end#end},"query-params" :'
298             " {#set ($map = $input.params().querystring)#foreach( $param in"
299             ' $map.entrySet() )"$param.key" : "$param.value" #if( $foreach.hasNext ),'
300             ' #end#end},"path-params" : {#set ($map = $input.params().path)#foreach('
301             ' $param in $map.entrySet() )"$param.key" : "$param.value" #if('
302             " $foreach.hasNext ), #end#end},\"body-params\" : $input.json('$')}"
303         )
304     },
305     type="AWS",
306     uri=(
307         "arn:aws:apigateway:us-west-2:"
308         "lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:1234567:"
309         "function:unit_test_api_api_users_post/invocations"
310     ),
311 )
312 method_response_200_ret = dict(
313     responseModels={"application/json": "User"},
314     responseParameters={"method.response.header.Access-Control-Allow-Origin": False},
315     statusCode="200",
316 )
317 method_ret = dict(
318     apiKeyRequired=False,
319     authorizationType="None",
320     httpMethod="POST",
321     methodIntegration=method_integration_ret,
322     methodResponses={"200": method_response_200_ret},
323     requestModels={"application/json": "User"},
324     requestParameters={},
325 )
326 throttle_rateLimit = 10.0
327 association_stage_1 = {"apiId": "apiId1", "stage": "stage1"}
328 association_stage_2 = {"apiId": "apiId1", "stage": "stage2"}
329 log = logging.getLogger(__name__)
330 def _has_required_boto():
331     if not HAS_BOTO:
332         return False
333     elif LooseVersion(boto3.__version__) &lt; LooseVersion(required_boto3_version):
334         return False
335     else:
336         return True
337 def _has_required_botocore():
338     if not HAS_BOTO:
339         return False
340     elif LooseVersion(botocore.__version__) &lt; LooseVersion(required_botocore_version):
341         return False
342     else:
343         return True
344 class TempSwaggerFile:
345     _tmp_swagger_dict = {
346         "info": {
347             "version": "0.0.0",
348             "description": "salt boto apigateway unit test service",
349             "title": "salt boto apigateway unit test service",
350         },
351         "paths": {
352             "/users": {
353                 "post": {
354                     "responses": {
355                         "200": {
356                             "headers": {
357                                 "Access-Control-Allow-Origin": {"type": "string"}
358                             },
359                             "description": "The username of the new user",
360                             "schema": {"$ref": "#/definitions/User"},
361                         }
362                     },
363                     "parameters": [
364                         {
365                             "in": "body",
366                             "description": "New user details.",
367                             "name": "NewUser",
368                             "schema": {"$ref": "#/definitions/User"},
369                         }
370                     ],
371                     "produces": ["application/json"],
372                     "description": "Creates a new user.",
373                     "tags": ["Auth"],
374                     "consumes": ["application/json"],
375                     "summary": "Registers a new user",
376                 }
377             }
378         },
379         "schemes": ["https"],
380         "produces": ["application/json"],
381         "basePath": "/api",
382         "host": "rm06h9oac4.execute-api.us-west-2.amazonaws.com",
383         "definitions": {
384             "User": {
385                 "properties": {
386                     "username": {
387                         "type": "string",
388                         "description": "A unique username for the user",
389                     },
390                     "password": {
391                         "type": "string",
392                         "description": "A password for the new user",
393                     },
394                 }
395             },
396             "Error": {
397                 "properties": {
398                     "fields": {"type": "string"},
399                     "message": {"type": "string"},
400                     "code": {"type": "integer", "format": "int32"},
401                 }
402             },
403         },
404         "swagger": "2.0",
405     }
406     def __enter__(self):
407         self.swaggerfile = "temp-swagger-sample.yaml"
408         with salt.utils.files.fopen(self.swaggerfile, "w") as fp_:
409             salt.utils.yaml.safe_dump(self.swaggerdict, fp_, default_flow_style=False)
410         return self.swaggerfile
411     def __exit__(self, objtype, value, traceback):
412         os.remove(self.swaggerfile)
413     def __init__(self, create_invalid_file=False):
414         if create_invalid_file:
415             self.swaggerdict = TempSwaggerFile._tmp_swagger_dict.copy()
416             self.swaggerdict["invalid_key"] = "invalid"
417             self.swaggerdict.pop("schemes", None)
418             self.swaggerdict["swagger"] = "3.0"
419             self.swaggerdict.pop("info", None)
420         else:
421             self.swaggerdict = TempSwaggerFile._tmp_swagger_dict
422 class BotoApiGatewayStateTestCaseBase(TestCase, LoaderModuleMockMixin):
423     conn = None
424     @classmethod
425     def setUpClass(cls):
426         cls.opts = salt.config.DEFAULT_MINION_OPTS.copy()
427         cls.opts["grains"] = salt.loader.grains(cls.opts)
428     @classmethod
429     def tearDownClass(cls):
430         del cls.opts
431     def setup_loader_modules(self):
432         context = {}
433         utils = salt.loader.utils(
434             self.opts,
435             whitelist=["boto", "boto3", "args", "systemd", "path", "platform", "reg"],
436             context=context,
437         )
438         serializers = salt.loader.serializers(self.opts)
439         self.funcs = salt.loader.minion_mods(
440             self.opts, context=context, utils=utils, whitelist=["boto_apigateway"]
441         )
442         self.salt_states = salt.loader.states(
443             opts=self.opts,
444             functions=self.funcs,
445             utils=utils,
446             whitelist=["boto_apigateway"],
447             serializers=serializers,
448         )
449         return {
450             boto_apigateway: {
451                 "__opts__": self.opts,
452                 "__utils__": utils,
453                 "__salt__": self.funcs,
454                 "__states__": self.salt_states,
455                 "__serializers__": serializers,
456             }
457         }
458     def setUp(self):
459         self.addCleanup(delattr, self, "funcs")
460         self.addCleanup(delattr, self, "salt_states")
461         conn_parameters["key"] = "".join(
462             random.choice(string.ascii_lowercase + string.digits) for _ in range(50)
463         )
464         patcher = patch("boto3.session.Session")
465         self.addCleanup(patcher.stop)
466         mock_session = patcher.start()
467         session_instance = mock_session.return_value
468         self.conn = MagicMock()
469         self.addCleanup(delattr, self, "conn")
470         session_instance.client.return_value = self.conn
471 @skipIf(HAS_BOTO is False, "The boto module must be installed.")
472 @skipIf(
473     _has_required_boto() is False,
474     "The boto3 module must be greater than or equal to version {}".format(
475         required_boto3_version
476     ),
477 )
478 class BotoApiGatewayTestCase(
479     BotoApiGatewayStateTestCaseBase, BotoApiGatewayTestCaseMixin
480 ):
481     def test_present_when_swagger_file_is_invalid(self):
482         result = {}
483         with TempSwaggerFile(create_invalid_file=True) as swagger_file:
484             result = self.salt_states["boto_apigateway.present"](
485                 "api present",
486                 "unit test api",
487                 swagger_file,
488                 "test",
489                 False,
490                 "arn:aws:iam::1234:role/apigatewayrole",
491                 **conn_parameters
492             )
493         self.assertFalse(result.get("result", True))
494     def test_present_when_stage_is_already_at_desired_deployment(self):
495         self.conn.get_rest_apis.return_value = apis_ret
496         self.conn.get_deployment.return_value = deployment1_ret
497         self.conn.get_stage.return_value = stage1_deployment1_ret
498         self.conn.update_stage.side_effect = ClientError(
499             error_content, "update_stage should not be called"
500         )
501         result = {}
502         with TempSwaggerFile() as swagger_file:
503             result = self.salt_states["boto_apigateway.present"](
504                 "api present",
505                 "unit test api",
506                 swagger_file,
507                 "test",
508                 False,
509                 "arn:aws:iam::1234:role/apigatewayrole",
510                 **conn_parameters
511             )
512         self.assertFalse(result.get("abort"))
513         self.assertTrue(result.get("current"))
514         self.assertIs(result.get("result"), True)
515         self.assertNotIn("update_stage should not be called", result.get("comment", ""))
516     def test_present_when_stage_is_already_at_desired_deployment_and_needs_stage_variables_update(
517         self,
518     ):
519         self.conn.get_rest_apis.return_value = apis_ret
520         self.conn.get_deployment.return_value = deployment1_ret
521         self.conn.get_stage.return_value = stage1_deployment1_ret
522         self.conn.update_stage.return_value = stage1_deployment1_vars_ret
523         result = {}
524         with TempSwaggerFile() as swagger_file:
525             result = self.salt_states["boto_apigateway.present"](
526                 "api present",
527                 "unit test api",
528                 swagger_file,
529                 "test",
530                 False,
531                 "arn:aws:iam::1234:role/apigatewayrole",
532                 stage_variables={"var1": "val1"},
533                 **conn_parameters
534             )
535         self.assertFalse(result.get("abort"))
536         self.assertTrue(result.get("current"))
537         self.assertIs(result.get("result"), True)
538     def test_present_when_stage_exists_and_is_to_associate_to_existing_deployment(self):
539         self.conn.get_rest_apis.return_value = apis_ret
540         self.conn.get_deployment.return_value = deployment2_ret
541         self.conn.get_deployments.return_value = deployments_ret
542         self.conn.get_stage.return_value = stage1_deployment2_ret
543         self.conn.update_stage.return_value = stage1_deployment1_ret
544         self.conn.create_stage.side_effect = ClientError(error_content, "create_stage")
545         self.conn.create_deployment.side_effect = ClientError(
546             error_content, "create_deployment"
547         )
548         result = {}
549         with TempSwaggerFile() as swagger_file:
550             result = self.salt_states["boto_apigateway.present"](
551                 "api present",
552                 "unit test api",
553                 swagger_file,
554                 "test",
555                 False,
556                 "arn:aws:iam::1234:role/apigatewayrole",
557                 **conn_parameters
558             )
559         self.assertTrue(result.get("publish"))
560         self.assertIs(result.get("result"), True)
561         self.assertFalse(result.get("abort"))
562         self.assertTrue(result.get("changes", {}).get("new", [{}])[0])
563     @pytest.mark.slow_test
564     def test_present_when_stage_is_to_associate_to_new_deployment(self):
565         self.conn.get_rest_apis.return_value = no_apis_ret
566         self.conn.create_rest_api.return_value = api_ret
567         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
568         self.conn.create_model.return_value = mock_model_ret
569         self.conn.get_resources.return_value = resources_ret
570         self.conn.create_resource.side_effect = ClientError(
571             error_content, "create_resource"
572         )
573         self.conn.put_method.return_value = method_ret
574         self.conn.put_integration.return_value = method_integration_ret
575         self.conn.put_method_response.return_value = method_response_200_ret
576         self.conn.put_intgration_response.return_value = (
577             method_integration_response_200_ret
578         )
579         result = {}
580         with patch.dict(
581             self.funcs,
582             {
583                 "boto_lambda.describe_function": MagicMock(
584                     return_value={"function": function_ret}
585                 )
586             },
587         ):
588             with TempSwaggerFile() as swagger_file:
589                 result = self.salt_states["boto_apigateway.present"](
590                     "api present",
591                     "unit test api",
592                     swagger_file,
593                     "test",
594                     False,
595                     "arn:aws:iam::1234:role/apigatewayrole",
596                     **conn_parameters
597                 )
598         self.assertIs(result.get("result"), True)
599         self.assertIs(result.get("abort"), None)
600     def test_present_when_stage_associating_to_new_deployment_errored_on_api_creation(
601         self,
602     ):
603         self.conn.get_rest_apis.return_value = no_apis_ret
604         self.conn.create_rest_api.side_effect = ClientError(
605             error_content, "create_rest_api"
606         )
607         result = {}
608         with TempSwaggerFile() as swagger_file:
609             result = self.salt_states["boto_apigateway.present"](
610                 "api present",
611                 "unit test api",
612                 swagger_file,
613                 "test",
614                 False,
615                 "arn:aws:iam::1234:role/apigatewayrole",
616                 **conn_parameters
617             )
618         self.assertIs(result.get("abort"), True)
619         self.assertIs(result.get("result"), False)
620         self.assertIn("create_rest_api", result.get("comment", ""))
621     def test_present_when_stage_associating_to_new_deployment_errored_on_model_creation(
622         self,
623     ):
624         self.conn.get_rest_apis.return_value = no_apis_ret
625         self.conn.create_rest_api.return_value = api_ret
626         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
627         self.conn.create_model.side_effect = ClientError(error_content, "create_model")
628         result = {}
629         with TempSwaggerFile() as swagger_file:
630             result = self.salt_states["boto_apigateway.present"](
631                 "api present",
632                 "unit test api",
633                 swagger_file,
634                 "test",
635                 False,
636                 "arn:aws:iam::1234:role/apigatewayrole",
637                 **conn_parameters
638             )
639         self.assertIs(result.get("abort"), True)
640         self.assertIs(result.get("result"), False)
641         self.assertIn("create_model", result.get("comment", ""))
642     def test_present_when_stage_associating_to_new_deployment_errored_on_resource_creation(
643         self,
644     ):
645         self.conn.get_rest_apis.return_value = no_apis_ret
646         self.conn.create_rest_api.return_value = api_ret
647         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
648         self.conn.create_model.return_value = mock_model_ret
649         self.conn.get_resources.return_value = root_resources_ret
650         self.conn.create_resource.side_effect = ClientError(
651             error_content, "create_resource"
652         )
653         result = {}
654         with TempSwaggerFile() as swagger_file:
655             result = self.salt_states["boto_apigateway.present"](
656                 "api present",
657                 "unit test api",
658                 swagger_file,
659                 "test",
660                 False,
661                 "arn:aws:iam::1234:role/apigatewayrole",
662                 **conn_parameters
663             )
664         self.assertIs(result.get("abort"), True)
665         self.assertIs(result.get("result"), False)
666         self.assertIn("create_resource", result.get("comment", ""))
667     @pytest.mark.slow_test
668     def test_present_when_stage_associating_to_new_deployment_errored_on_put_method(
669         self,
670     ):
671         self.conn.get_rest_apis.return_value = no_apis_ret
672         self.conn.create_rest_api.return_value = api_ret
673         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
674         self.conn.create_model.return_value = mock_model_ret
675         self.conn.get_resources.return_value = resources_ret
676         self.conn.create_resource.side_effect = ClientError(
677             error_content, "create_resource"
678         )
679         self.conn.put_method.side_effect = ClientError(error_content, "put_method")
680         result = {}
681         with patch.dict(
682             self.funcs,
683             {
684                 "boto_lambda.describe_function": MagicMock(
685                     return_value={"function": function_ret}
686                 )
687             },
688         ):
689             with TempSwaggerFile() as swagger_file:
690                 result = self.salt_states["boto_apigateway.present"](
691                     "api present",
692                     "unit test api",
693                     swagger_file,
694                     "test",
695                     False,
696                     "arn:aws:iam::1234:role/apigatewayrole",
697                     **conn_parameters
698                 )
699         self.assertIs(result.get("abort"), True)
700         self.assertIs(result.get("result"), False)
701         self.assertIn("put_method", result.get("comment", ""))
702     @pytest.mark.slow_test
703     def test_present_when_stage_associating_to_new_deployment_errored_on_lambda_function_lookup(
704         self,
705     ):
706         self.conn.get_rest_apis.return_value = no_apis_ret
707         self.conn.create_rest_api.return_value = api_ret
708         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
709         self.conn.create_model.return_value = mock_model_ret
710         self.conn.get_resources.return_value = resources_ret
711         self.conn.create_resource.side_effect = ClientError(
712             error_content, "create_resource"
713         )
714         self.conn.put_method.return_value = method_ret
715         self.conn.put_integration.side_effect = ClientError(
716             error_content, "put_integration should not be invoked"
717         )
718         result = {}
719         with patch.dict(
720             self.funcs,
721             {
722                 "boto_lambda.describe_function": MagicMock(
723                     return_value={"error": "no such lambda"}
724                 )
725             },
726         ):
727             with TempSwaggerFile() as swagger_file:
728                 result = self.salt_states["boto_apigateway.present"](
729                     "api present",
730                     "unit test api",
731                     swagger_file,
732                     "test",
733                     False,
734                     "arn:aws:iam::1234:role/apigatewayrole",
735                     **conn_parameters
736                 )
737         self.assertIs(result.get("result"), False)
738         self.assertNotIn(
739             "put_integration should not be invoked", result.get("comment", "")
740         )
741         self.assertIn("not find lambda function", result.get("comment", ""))
742     @pytest.mark.slow_test
743     def test_present_when_stage_associating_to_new_deployment_errored_on_put_integration(
744         self,
745     ):
746         self.conn.get_rest_apis.return_value = no_apis_ret
747         self.conn.create_rest_api.return_value = api_ret
748         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
749         self.conn.create_model.return_value = mock_model_ret
750         self.conn.get_resources.return_value = resources_ret
751         self.conn.create_resource.side_effect = ClientError(
752             error_content, "create_resource"
753         )
754         self.conn.put_method.return_value = method_ret
755         self.conn.put_integration.side_effect = ClientError(
756             error_content, "put_integration"
757         )
758         result = {}
759         with patch.dict(
760             self.funcs,
761             {
762                 "boto_lambda.describe_function": MagicMock(
763                     return_value={"function": function_ret}
764                 )
765             },
766         ):
767             with TempSwaggerFile() as swagger_file:
768                 result = self.salt_states["boto_apigateway.present"](
769                     "api present",
770                     "unit test api",
771                     swagger_file,
772                     "test",
773                     False,
774                     "arn:aws:iam::1234:role/apigatewayrole",
775                     **conn_parameters
776                 )
777         self.assertIs(result.get("abort"), True)
778         self.assertIs(result.get("result"), False)
779         self.assertIn("put_integration", result.get("comment", ""))
780     @pytest.mark.slow_test
781     def test_present_when_stage_associating_to_new_deployment_errored_on_put_method_response(
782         self,
783     ):
784         self.conn.get_rest_apis.return_value = no_apis_ret
785         self.conn.create_rest_api.return_value = api_ret
786         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
787         self.conn.create_model.return_value = mock_model_ret
788         self.conn.get_resources.return_value = resources_ret
789         self.conn.create_resource.side_effect = ClientError(
790             error_content, "create_resource"
791         )
792         self.conn.put_method.return_value = method_ret
793         self.conn.put_integration.return_value = method_integration_ret
794         self.conn.put_method_response.side_effect = ClientError(
795             error_content, "put_method_response"
796         )
797         result = {}
798         with patch.dict(
799             self.funcs,
800             {
801                 "boto_lambda.describe_function": MagicMock(
802                     return_value={"function": function_ret}
803                 )
804             },
805         ):
806             with TempSwaggerFile() as swagger_file:
807                 result = self.salt_states["boto_apigateway.present"](
808                     "api present",
809                     "unit test api",
810                     swagger_file,
811                     "test",
812                     False,
813                     "arn:aws:iam::1234:role/apigatewayrole",
814                     **conn_parameters
815                 )
816         self.assertIs(result.get("abort"), True)
817         self.assertIs(result.get("result"), False)
818         self.assertIn("put_method_response", result.get("comment", ""))
819     @pytest.mark.slow_test
820     def test_present_when_stage_associating_to_new_deployment_errored_on_put_integration_response(
821         self,
822     ):
823         self.conn.get_rest_apis.return_value = no_apis_ret
824         self.conn.create_rest_api.return_value = api_ret
825         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
826         self.conn.create_model.return_value = mock_model_ret
827         self.conn.get_resources.return_value = resources_ret
828         self.conn.create_resource.side_effect = ClientError(
829             error_content, "create_resource"
830         )
831         self.conn.put_method.return_value = method_ret
832         self.conn.put_integration.return_value = method_integration_ret
833         self.conn.put_method_response.return_value = method_response_200_ret
834         self.conn.put_integration_response.side_effect = ClientError(
835             error_content, "put_integration_response"
836         )
837         result = {}
838         with patch.dict(
839             self.funcs,
840             {
841                 "boto_lambda.describe_function": MagicMock(
842                     return_value={"function": function_ret}
843                 )
844             },
845         ):
846             with TempSwaggerFile() as swagger_file:
847                 result = self.salt_states["boto_apigateway.present"](
848                     "api present",
849                     "unit test api",
850                     swagger_file,
851                     "test",
852                     False,
853                     "arn:aws:iam::1234:role/apigatewayrole",
854                     **conn_parameters
855                 )
856         self.assertIs(result.get("abort"), True)
857         self.assertIs(result.get("result"), False)
858         self.assertIn("put_integration_response", result.get("comment", ""))
859     def test_absent_when_rest_api_does_not_exist(self):
860         self.conn.get_rest_apis.return_value = apis_ret
861         self.conn.get_stage.side_effect = ClientError(
862             error_content, "get_stage should not be called"
863         )
864         result = self.salt_states["boto_apigateway.absent"](
865             "api present",
866             "no_such_rest_api",
867             "no_such_stage",
868             nuke_api=False,
869             **conn_parameters
870         )
871         self.assertIs(result.get("result"), True)
872         self.assertNotIn("get_stage should not be called", result.get("comment", ""))
873         self.assertEqual(result.get("changes"), {})
874     def test_absent_when_stage_is_invalid(self):
875         self.conn.get_rest_apis.return_value = apis_ret
876         self.conn.get_stage.return_value = stage1_deployment1_ret
877         self.conn.delete_stage.side_effect = ClientError(error_content, "delete_stage")
878         result = self.salt_states["boto_apigateway.absent"](
879             "api present",
880             "unit test api",
881             "no_such_stage",
882             nuke_api=False,
883             **conn_parameters
884         )
885         self.assertTrue(result.get("abort", False))
886     def test_absent_when_stage_is_valid_and_only_one_stage_is_associated_to_deployment(
887         self,
888     ):
889         self.conn.get_rest_apis.return_value = apis_ret
890         self.conn.get_stage.return_value = stage1_deployment1_ret
891         self.conn.delete_stage.return_value = {
892             "ResponseMetadata": {
893                 "HTTPStatusCode": 200,
894                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
895             }
896         }
897         self.conn.get_stages.return_value = no_stages_ret
898         self.conn.delete_deployment.return_value = {
899             "ResponseMetadata": {
900                 "HTTPStatusCode": 200,
901                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
902             }
903         }
904         result = self.salt_states["boto_apigateway.absent"](
905             "api present", "unit test api", "test", nuke_api=False, **conn_parameters
906         )
907         self.assertTrue(result.get("result", False))
908     def test_absent_when_stage_is_valid_and_two_stages_are_associated_to_deployment(
909         self,
910     ):
911         self.conn.get_rest_apis.return_value = apis_ret
912         self.conn.get_stage.return_value = stage1_deployment1_ret
913         self.conn.delete_stage.return_value = {
914             "ResponseMetadata": {
915                 "HTTPStatusCode": 200,
916                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
917             }
918         }
919         self.conn.get_stages.return_value = stages_stage2_ret
920         result = self.salt_states["boto_apigateway.absent"](
921             "api present", "unit test api", "test", nuke_api=False, **conn_parameters
922         )
923         self.assertTrue(result.get("result", False))
924     def test_absent_when_failing_to_delete_a_deployment_no_longer_associated_with_any_stages(
925         self,
926     ):
927         self.conn.get_rest_apis.return_value = apis_ret
928         self.conn.get_stage.return_value = stage1_deployment1_ret
929         self.conn.delete_stage.return_value = {
930             "ResponseMetadata": {
931                 "HTTPStatusCode": 200,
932                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
933             }
934         }
935         self.conn.get_stages.return_value = no_stages_ret
936         self.conn.delete_deployment.side_effect = ClientError(
937             error_content, "delete_deployment"
938         )
939         result = self.salt_states["boto_apigateway.absent"](
940             "api present", "unit test api", "test", nuke_api=False, **conn_parameters
941         )
942         self.assertTrue(result.get("abort", False))
943     def test_absent_when_nuke_api_and_no_more_stages_deployments_remain(self):
944         self.conn.get_rest_apis.return_value = apis_ret
945         self.conn.get_stage.return_value = stage1_deployment1_ret
946         self.conn.delete_stage.return_value = {
947             "ResponseMetadata": {
948                 "HTTPStatusCode": 200,
949                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
950             }
951         }
952         self.conn.get_stages.return_value = no_stages_ret
953         self.conn.get_deployments.return_value = deployments_ret
954         self.conn.delete_rest_api.return_value = {
955             "ResponseMetadata": {
956                 "HTTPStatusCode": 200,
957                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
958             }
959         }
960         result = self.salt_states["boto_apigateway.absent"](
961             "api present", "unit test api", "test", nuke_api=True, **conn_parameters
962         )
963         self.assertIs(result.get("result"), True)
964         self.assertIsNot(result.get("abort"), True)
965         self.assertIs(
966             result.get("changes", {})
967             .get("new", [{}])[0]
968             .get("delete_api", {})
969             .get("deleted"),
970             True,
971         )
972     def test_absent_when_nuke_api_and_other_stages_deployments_exist(self):
973         self.conn.get_rest_apis.return_value = apis_ret
974         self.conn.get_stage.return_value = stage1_deployment1_ret
975         self.conn.delete_stage.return_value = {
976             "ResponseMetadata": {
977                 "HTTPStatusCode": 200,
978                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
979             }
980         }
981         self.conn.get_stages.return_value = stages_stage2_ret
982         self.conn.get_deployments.return_value = deployments_ret
983         self.conn.delete_rest_api.side_effect = ClientError(
984             error_content, "unexpected_api_delete"
985         )
986         result = self.salt_states["boto_apigateway.absent"](
987             "api present", "unit test api", "test", nuke_api=True, **conn_parameters
988         )
989         self.assertIs(result.get("result"), True)
990         self.assertIsNot(result.get("abort"), True)
991 @skipIf(HAS_BOTO is False, "The boto module must be installed.")
992 @skipIf(
993     _has_required_boto() is False,
994     "The boto3 module must be greater than or equal to version {}".format(
995         required_boto3_version
996     ),
997 )
998 @skipIf(
999     _has_required_botocore() is False,
1000     "The botocore module must be greater than or equal to version {}".format(
1001         required_botocore_version
1002     ),
1003 )
1004 class BotoApiGatewayUsagePlanTestCase(
1005     BotoApiGatewayStateTestCaseBase, BotoApiGatewayTestCaseMixin
1006 ):
1007     @pytest.mark.slow_test
1008     def test_usage_plan_present_if_describe_fails(self, *args):
1009         with patch.dict(
1010             boto_apigateway.__salt__,
1011             {
1012                 "boto_apigateway.describe_usage_plans": MagicMock(
1013                     return_value={"error": "error"}
1014                 )
1015             },
1016         ):
1017             result = boto_apigateway.usage_plan_present(
1018                 "name", "plan_name", **conn_parameters
1019             )
1020             self.assertIn("result", result)
1021             self.assertEqual(result["result"], False)
1022             self.assertIn("comment", result)
1023             self.assertEqual(
1024                 result["comment"], "Failed to describe existing usage plans"
1025             )
1026             self.assertIn("changes", result)
1027             self.assertEqual(result["changes"], {})
1028     @pytest.mark.slow_test
1029     def test_usage_plan_present_if_there_is_no_such_plan_and_test_option_is_set(
1030         self, *args
1031     ):
1032         with patch.dict(boto_apigateway.__opts__, {"test": True}):
1033             with patch.dict(
1034                 boto_apigateway.__salt__,
1035                 {
1036                     "boto_apigateway.describe_usage_plans": MagicMock(
1037                         return_value={"plans": []}
1038                     )
1039                 },
1040             ):
1041                 result = boto_apigateway.usage_plan_present(
1042                     "name", "plan_name", **conn_parameters
1043                 )
1044                 self.assertIn("comment", result)
1045                 self.assertEqual(
1046                     result["comment"], "a new usage plan plan_name would be created"
1047                 )
1048                 self.assertIn("result", result)
1049                 self.assertEqual(result["result"], None)
1050     @pytest.mark.slow_test
1051     def test_usage_plan_present_if_create_usage_plan_fails(self, *args):
1052         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1053             with patch.dict(
1054                 boto_apigateway.__salt__,
1055                 {
1056                     "boto_apigateway.describe_usage_plans": MagicMock(
1057                         return_value={"plans": []}
1058                     ),
1059                     "boto_apigateway.create_usage_plan": MagicMock(
1060                         return_value={"error": "error"}
1061                     ),
1062                 },
1063             ):
1064                 result = boto_apigateway.usage_plan_present(
1065                     "name", "plan_name", **conn_parameters
1066                 )
1067                 self.assertIn("result", result)
1068                 self.assertEqual(result["result"], False)
1069                 self.assertIn("comment", result)
1070                 self.assertEqual(
1071                     result["comment"], "Failed to create a usage plan plan_name, error"
1072                 )
1073                 self.assertIn("changes", result)
1074                 self.assertEqual(result["changes"], {})
1075     @pytest.mark.slow_test
1076     def test_usage_plan_present_if_plan_is_there_and_needs_no_updates(self, *args):
1077         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1078             with patch.dict(
1079                 boto_apigateway.__salt__,
1080                 {
1081                     "boto_apigateway.describe_usage_plans": MagicMock(
1082                         return_value={"plans": [{"id": "planid", "name": "planname"}]}
1083                     ),
1084                     "boto_apigateway.update_usage_plan": MagicMock(),
1085                 },
1086             ):
1087                 result = boto_apigateway.usage_plan_present(
1088                     "name", "plan_name", **conn_parameters
1089 <a name="0"></a>                )
1090                 self.assertIn("result", result)
1091                 self<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertEqual(result["result"], True)
1092                 self.assertIn("comment", result)
1093                 self.assertEqual(
1094                     result["comment"],
1095                     "usage plan plan_name is already in a correct state",
1096                 )
1097                 self.assertIn("changes", result)
1098                 self.assertEqual(result["changes"], {})
1099                 self.assertTrue(</b></font>
1100                     boto_apigateway.__salt__[
1101                         "boto_apigateway.update_usage_plan"
1102                     ].call_count
1103                     == 0
1104                 )
1105     @pytest.mark.slow_test
1106     def test_usage_plan_present_if_plan_is_there_and_needs_updates_but_test_is_set(
1107         self, *args
1108     ):
1109         with patch.dict(boto_apigateway.__opts__, {"test": True}):
1110             with patch.dict(
1111                 boto_apigateway.__salt__,
1112                 {
1113                     "boto_apigateway.describe_usage_plans": MagicMock(
1114                         return_value={
1115                             "plans": [
1116                                 {
1117                                     "id": "planid",
1118                                     "name": "planname",
1119                                     "throttle": {"rateLimit": 10.0},
1120                                 }
1121                             ]
1122                         }
1123                     ),
1124                     "boto_apigateway.update_usage_plan": MagicMock(),
1125                 },
1126             ):
1127                 result = boto_apigateway.usage_plan_present(
1128                     "name", "plan_name", **conn_parameters
1129                 )
1130                 self.assertIn("comment", result)
1131                 self.assertEqual(
1132                     result["comment"], "a new usage plan plan_name would be updated"
1133                 )
1134                 self.assertIn("result", result)
1135                 self.assertEqual(result["result"], None)
1136                 self.assertTrue(
1137                     boto_apigateway.__salt__[
1138                         "boto_apigateway.update_usage_plan"
1139                     ].call_count
1140                     == 0
1141                 )
1142     @pytest.mark.slow_test
1143     def test_usage_plan_present_if_plan_is_there_and_needs_updates_but_update_fails(
1144         self, *args
1145     ):
1146         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1147             with patch.dict(
1148                 boto_apigateway.__salt__,
1149                 {
1150                     "boto_apigateway.describe_usage_plans": MagicMock(
1151                         return_value={
1152                             "plans": [
1153                                 {
1154                                     "id": "planid",
1155                                     "name": "planname",
1156                                     "throttle": {"rateLimit": 10.0},
1157                                 }
1158                             ]
1159                         }
1160                     ),
1161                     "boto_apigateway.update_usage_plan": MagicMock(
1162                         return_value={"error": "error"}
1163                     ),
1164                 },
1165             ):
1166                 result = boto_apigateway.usage_plan_present(
1167                     "name", "plan_name", **conn_parameters
1168                 )
1169                 self.assertIn("result", result)
1170                 self.assertEqual(result["result"], False)
1171                 self.assertIn("comment", result)
1172                 self.assertEqual(
1173                     result["comment"], "Failed to update a usage plan plan_name, error"
1174                 )
1175     @pytest.mark.slow_test
1176     def test_usage_plan_present_if_plan_has_been_created(self, *args):
1177         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1178             with patch.dict(
1179                 boto_apigateway.__salt__,
1180                 {
1181                     "boto_apigateway.describe_usage_plans": MagicMock(
1182                         side_effect=[{"plans": []}, {"plans": [{"id": "id"}]}]
1183                     ),
1184                     "boto_apigateway.create_usage_plan": MagicMock(
1185                         return_value={"created": True}
1186                     ),
1187                 },
1188             ):
1189                 result = boto_apigateway.usage_plan_present(
1190                     "name", "plan_name", **conn_parameters
1191                 )
1192                 self.assertIn("result", result)
1193                 self.assertEqual(result["result"], True)
1194                 self.assertIn("comment", result)
1195                 self.assertEqual(
1196                     result["comment"], "A new usage plan plan_name has been created"
1197                 )
1198                 self.assertEqual(result["changes"]["old"], {"plan": None})
1199                 self.assertEqual(result["changes"]["new"], {"plan": {"id": "id"}})
1200     @pytest.mark.slow_test
1201     def test_usage_plan_present_if_plan_has_been_updated(self, *args):
1202         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1203             with patch.dict(
1204                 boto_apigateway.__salt__,
1205                 {
1206                     "boto_apigateway.describe_usage_plans": MagicMock(
1207                         side_effect=[
1208                             {"plans": [{"id": "id"}]},
1209                             {
1210                                 "plans": [
1211                                     {
1212                                         "id": "id",
1213                                         "throttle": {"rateLimit": throttle_rateLimit},
1214                                     }
1215                                 ]
1216                             },
1217                         ]
1218                     ),
1219                     "boto_apigateway.update_usage_plan": MagicMock(
1220                         return_value={"updated": True}
1221                     ),
1222                 },
1223             ):
1224                 result = boto_apigateway.usage_plan_present(
1225                     "name",
1226                     "plan_name",
1227                     throttle={"rateLimit": throttle_rateLimit},
1228                     **conn_parameters
1229                 )
1230                 self.assertIn("result", result)
1231                 self.assertEqual(result["result"], True)
1232                 self.assertIn("comment", result)
1233                 self.assertEqual(
1234                     result["comment"], "usage plan plan_name has been updated"
1235                 )
1236                 self.assertEqual(result["changes"]["old"], {"plan": {"id": "id"}})
1237                 self.assertEqual(
1238                     result["changes"]["new"],
1239                     {
1240                         "plan": {
1241                             "id": "id",
1242                             "throttle": {"rateLimit": throttle_rateLimit},
1243                         }
1244                     },
1245                 )
1246     @pytest.mark.slow_test
1247     def test_usage_plan_present_if_ValueError_is_raised(self, *args):
1248         with patch.dict(
1249             boto_apigateway.__salt__,
1250             {
1251                 "boto_apigateway.describe_usage_plans": MagicMock(
1252                     side_effect=ValueError("error")
1253                 )
1254             },
1255         ):
1256 <a name="1"></a>            result = boto_apigateway.usage_plan_present(
1257                 "name",
1258                 "plan_name",
1259                 throttle={<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>"rateLimit": throttle_rateLimit},
1260                 **conn_parameters
1261             )
1262             self.assertIn("result", result)
1263             self.assertEqual(result["result"], False)
1264             self.assertIn("comment", result)
1265             self.assertEqual(result["comment"], repr(</b></font>("error",)))
1266     @pytest.mark.slow_test
1267     def test_usage_plan_present_if_IOError_is_raised(self, *args):
1268         with patch.dict(
1269             boto_apigateway.__salt__,
1270             {
1271                 "boto_apigateway.describe_usage_plans": MagicMock(
1272                     side_effect=IOError("error")
1273                 )
1274             },
1275         ):
1276             result = boto_apigateway.usage_plan_present(
1277                 "name",
1278                 "plan_name",
1279                 throttle={"rateLimit": throttle_rateLimit},
1280                 **conn_parameters
1281             )
1282             self.assertIn("result", result)
1283             self.assertEqual(result["result"], False)
1284             self.assertIn("comment", result)
1285             self.assertEqual(result["comment"], repr(("error",)))
1286     @pytest.mark.slow_test
1287     def test_usage_plan_absent_if_describe_fails(self, *args):
1288         with patch.dict(
1289             boto_apigateway.__salt__,
1290             {
1291                 "boto_apigateway.describe_usage_plans": MagicMock(
1292                     return_value={"error": "error"}
1293                 )
1294             },
1295         ):
1296             result = {}
1297             result = boto_apigateway.usage_plan_absent(
1298                 "name", "plan_name", **conn_parameters
1299             )
1300             self.assertIn("result", result)
1301             self.assertEqual(result["result"], False)
1302             self.assertIn("comment", result)
1303             self.assertEqual(
1304                 result["comment"], "Failed to describe existing usage plans"
1305             )
1306             self.assertIn("changes", result)
1307             self.assertEqual(result["changes"], {})
1308     @pytest.mark.slow_test
1309     def test_usage_plan_absent_if_plan_is_not_present(self, *args):
1310         with patch.dict(
1311             boto_apigateway.__salt__,
1312             {
1313                 "boto_apigateway.describe_usage_plans": MagicMock(
1314                     return_value={"plans": []}
1315                 )
1316             },
1317         ):
1318             result = {}
1319             result = boto_apigateway.usage_plan_absent(
1320                 "name", "plan_name", **conn_parameters
1321             )
1322             self.assertIn("result", result)
1323             self.assertEqual(result["result"], True)
1324             self.assertIn("comment", result)
1325             self.assertEqual(
1326                 result["comment"], "Usage plan plan_name does not exist already"
1327             )
1328             self.assertIn("changes", result)
1329             self.assertEqual(result["changes"], {})
1330     @pytest.mark.slow_test
1331     def test_usage_plan_absent_if_plan_is_present_but_test_option_is_set(self, *args):
1332         with patch.dict(boto_apigateway.__opts__, {"test": True}):
1333             with patch.dict(
1334                 boto_apigateway.__salt__,
1335                 {
1336                     "boto_apigateway.describe_usage_plans": MagicMock(
1337                         return_value={"plans": [{"id": "id"}]}
1338                     )
1339                 },
1340             ):
1341                 result = {}
1342                 result = boto_apigateway.usage_plan_absent(
1343                     "name", "plan_name", **conn_parameters
1344                 )
1345                 self.assertIn("result", result)
1346                 self.assertEqual(result["result"], None)
1347                 self.assertIn("comment", result)
1348                 self.assertEqual(
1349                     result["comment"],
1350                     "Usage plan plan_name exists and would be deleted",
1351                 )
1352                 self.assertIn("changes", result)
1353                 self.assertEqual(result["changes"], {})
1354     @pytest.mark.slow_test
1355     def test_usage_plan_absent_if_plan_is_present_but_delete_fails(self, *args):
1356         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1357             with patch.dict(
1358                 boto_apigateway.__salt__,
1359                 {
1360                     "boto_apigateway.describe_usage_plans": MagicMock(
1361                         return_value={"plans": [{"id": "id"}]}
1362                     ),
1363                     "boto_apigateway.delete_usage_plan": MagicMock(
1364                         return_value={"error": "error"}
1365                     ),
1366                 },
1367             ):
1368                 result = boto_apigateway.usage_plan_absent(
1369                     "name", "plan_name", **conn_parameters
1370                 )
1371                 self.assertIn("result", result)
1372                 self.assertEqual(result["result"], False)
1373                 self.assertIn("comment", result)
1374                 self.assertEqual(
1375                     result["comment"],
1376                     "Failed to delete usage plan plan_name, "
1377                     + repr({"error": "error"}),
1378                 )
1379                 self.assertIn("changes", result)
1380                 self.assertEqual(result["changes"], {})
1381     @pytest.mark.slow_test
1382     def test_usage_plan_absent_if_plan_has_been_deleted(self, *args):
1383         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1384             with patch.dict(
1385                 boto_apigateway.__salt__,
1386                 {
1387                     "boto_apigateway.describe_usage_plans": MagicMock(
1388                         return_value={"plans": [{"id": "id"}]}
1389                     ),
1390                     "boto_apigateway.delete_usage_plan": MagicMock(
1391                         return_value={"deleted": True}
1392                     ),
1393                 },
1394             ):
1395                 result = boto_apigateway.usage_plan_absent(
1396                     "name", "plan_name", **conn_parameters
1397                 )
1398                 self.assertIn("result", result)
1399                 self.assertEqual(result["result"], True)
1400                 self.assertIn("comment", result)
1401                 self.assertEqual(
1402                     result["comment"], "Usage plan plan_name has been deleted"
1403                 )
1404                 self.assertIn("changes", result)
1405                 self.assertEqual(
1406                     result["changes"],
1407                     {"new": {"plan": None}, "old": {"plan": {"id": "id"}}},
1408                 )
1409     @pytest.mark.slow_test
1410     def test_usage_plan_absent_if_ValueError_is_raised(self, *args):
1411         with patch.dict(
1412             boto_apigateway.__salt__,
1413             {
1414                 "boto_apigateway.describe_usage_plans": MagicMock(
1415                     side_effect=ValueError("error")
1416                 )
1417             },
1418         ):
1419             result = boto_apigateway.usage_plan_absent(
1420                 "name", "plan_name", **conn_parameters
1421             )
1422             self.assertIn("result", result)
1423             self.assertEqual(result["result"], False)
1424             self.assertIn("comment", result)
1425             self.assertEqual(result["comment"], repr(("error",)))
1426     @pytest.mark.slow_test
1427     def test_usage_plan_absent_if_IOError_is_raised(self, *args):
1428         with patch.dict(
1429             boto_apigateway.__salt__,
1430             {
1431                 "boto_apigateway.describe_usage_plans": MagicMock(
1432                     side_effect=IOError("error")
1433                 )
1434             },
1435         ):
1436             result = boto_apigateway.usage_plan_absent(
1437                 "name", "plan_name", **conn_parameters
1438             )
1439             self.assertIn("result", result)
1440             self.assertEqual(result["result"], False)
1441             self.assertIn("comment", result)
1442             self.assertEqual(result["comment"], repr(("error",)))
1443 @skipIf(HAS_BOTO is False, "The boto module must be installed.")
1444 @skipIf(
1445     _has_required_boto() is False,
1446     "The boto3 module must be greater than or equal to version {}".format(
1447         required_boto3_version
1448     ),
1449 )
1450 @skipIf(
1451     _has_required_botocore() is False,
1452     "The botocore module must be greater than or equal to version {}".format(
1453         required_botocore_version
1454     ),
1455 )
1456 class BotoApiGatewayUsagePlanAssociationTestCase(
1457     BotoApiGatewayStateTestCaseBase, BotoApiGatewayTestCaseMixin
1458 ):
1459     @pytest.mark.slow_test
1460     def test_usage_plan_association_present_if_describe_fails(self, *args):
1461         with patch.dict(
1462             boto_apigateway.__salt__,
1463             {
1464                 "boto_apigateway.describe_usage_plans": MagicMock(
1465                     return_value={"error": "error"}
1466                 )
1467             },
1468         ):
1469             result = boto_apigateway.usage_plan_association_present(
1470                 "name", "plan_name", [association_stage_1], **conn_parameters
1471             )
1472             self.assertIn("result", result)
1473             self.assertEqual(result["result"], False)
1474             self.assertIn("comment", result)
1475             self.assertEqual(
1476                 result["comment"], "Failed to describe existing usage plans"
1477             )
1478             self.assertIn("changes", result)
1479             self.assertEqual(result["changes"], {})
1480     @pytest.mark.slow_test
1481     def test_usage_plan_association_present_if_plan_is_not_present(self, *args):
1482         with patch.dict(
1483             boto_apigateway.__salt__,
1484             {
1485                 "boto_apigateway.describe_usage_plans": MagicMock(
1486                     return_value={"plans": []}
1487                 )
1488             },
1489         ):
1490             result = boto_apigateway.usage_plan_association_present(
1491                 "name", "plan_name", [association_stage_1], **conn_parameters
1492             )
1493             self.assertIn("result", result)
1494             self.assertEqual(result["result"], False)
1495             self.assertIn("comment", result)
1496             self.assertEqual(result["comment"], "Usage plan plan_name does not exist")
1497             self.assertIn("changes", result)
1498             self.assertEqual(result["changes"], {})
1499     @pytest.mark.slow_test
1500     def test_usage_plan_association_present_if_multiple_plans_with_the_same_name_exist(
1501         self, *args
1502     ):
1503         with patch.dict(
1504             boto_apigateway.__salt__,
1505             {
1506                 "boto_apigateway.describe_usage_plans": MagicMock(
1507                     return_value={"plans": [{"id": "id1"}, {"id": "id2"}]}
1508                 )
1509             },
1510         ):
1511             result = boto_apigateway.usage_plan_association_present(
1512                 "name", "plan_name", [association_stage_1], **conn_parameters
1513             )
1514             self.assertIn("result", result)
1515             self.assertEqual(result["result"], False)
1516             self.assertIn("comment", result)
1517             self.assertEqual(
1518                 result["comment"],
1519                 "There are multiple usage plans with the same name - it is not"
1520                 " supported",
1521             )
1522             self.assertIn("changes", result)
1523             self.assertEqual(result["changes"], {})
1524     @pytest.mark.slow_test
1525     def test_usage_plan_association_present_if_association_already_exists(self, *args):
1526         with patch.dict(
1527             boto_apigateway.__salt__,
1528             {
1529                 "boto_apigateway.describe_usage_plans": MagicMock(
1530                     return_value={
1531                         "plans": [{"id": "id1", "apiStages": [association_stage_1]}]
1532                     }
1533                 )
1534             },
1535         ):
1536             result = boto_apigateway.usage_plan_association_present(
1537                 "name", "plan_name", [association_stage_1], **conn_parameters
1538             )
1539             self.assertIn("result", result)
1540             self.assertEqual(result["result"], True)
1541             self.assertIn("comment", result)
1542             self.assertEqual(
1543                 result["comment"], "Usage plan is already asssociated to all api stages"
1544             )
1545             self.assertIn("changes", result)
1546             self.assertEqual(result["changes"], {})
1547     @pytest.mark.slow_test
1548     def test_usage_plan_association_present_if_update_fails(self, *args):
1549         with patch.dict(
1550 <a name="2"></a>            boto_apigateway.__salt__,
1551             {
1552                 "boto_apigateway.describe_usage_plans": MagicMock(
1553                     return_value<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>={
1554                         "plans": [{"id": "id1", "apiStages": [association_stage_1]}]
1555                     }
1556                 ),
1557                 "boto_apigateway.attach_usage_plan_to_apis": MagicMock(
1558                     return_value={"error": "error"}
1559                 ),
1560             },
1561         ):
1562             result = boto_apigateway.usage_plan_association_present(
1563                 "name", "plan_name", [association_stage_2], **conn_parameters
1564             )
1565             self.assertIn(</b></font>"result", result)
1566             self.assertEqual(result["result"], False)
1567             self.assertIn("comment", result)
1568             self.assertTrue(
1569                 result["comment"].startswith("Failed to associate a usage plan")
1570             )
1571             self.assertIn("changes", result)
1572             self.assertEqual(result["changes"], {})
1573     @pytest.mark.slow_test
1574     def test_usage_plan_association_present_success(self, *args):
1575         with patch.dict(
1576             boto_apigateway.__salt__,
1577             {
1578                 "boto_apigateway.describe_usage_plans": MagicMock(
1579                     return_value={
1580                         "plans": [{"id": "id1", "apiStages": [association_stage_1]}]
1581                     }
1582                 ),
1583                 "boto_apigateway.attach_usage_plan_to_apis": MagicMock(
1584                     return_value={
1585                         "result": {
1586                             "apiStages": [association_stage_1, association_stage_2]
1587                         }
1588                     }
1589                 ),
1590             },
1591         ):
1592             result = boto_apigateway.usage_plan_association_present(
1593                 "name", "plan_name", [association_stage_2], **conn_parameters
1594             )
1595             self.assertIn("result", result)
1596             self.assertEqual(result["result"], True)
1597             self.assertIn("comment", result)
1598             self.assertEqual(
1599                 result["comment"], "successfully associated usage plan to apis"
1600             )
1601             self.assertIn("changes", result)
1602             self.assertEqual(
1603                 result["changes"],
1604                 {
1605                     "new": [association_stage_1, association_stage_2],
1606                     "old": [association_stage_1],
1607                 },
1608             )
1609     @pytest.mark.slow_test
1610     def test_usage_plan_association_present_if_value_error_is_thrown(self, *args):
1611         with patch.dict(
1612             boto_apigateway.__salt__,
1613             {
1614                 "boto_apigateway.describe_usage_plans": MagicMock(
1615                     side_effect=ValueError("error")
1616                 )
1617             },
1618         ):
1619             result = boto_apigateway.usage_plan_association_present(
1620                 "name", "plan_name", [], **conn_parameters
1621             )
1622             self.assertIn("result", result)
1623             self.assertEqual(result["result"], False)
1624             self.assertIn("comment", result)
1625             self.assertEqual(result["comment"], repr(("error",)))
1626             self.assertIn("changes", result)
1627             self.assertEqual(result["changes"], {})
1628     @pytest.mark.slow_test
1629     def test_usage_plan_association_present_if_io_error_is_thrown(self, *args):
1630         with patch.dict(
1631             boto_apigateway.__salt__,
1632             {
1633                 "boto_apigateway.describe_usage_plans": MagicMock(
1634                     side_effect=IOError("error")
1635                 )
1636             },
1637         ):
1638             result = boto_apigateway.usage_plan_association_present(
1639                 "name", "plan_name", [], **conn_parameters
1640             )
1641             self.assertIn("result", result)
1642             self.assertEqual(result["result"], False)
1643             self.assertIn("comment", result)
1644             self.assertEqual(result["comment"], repr(("error",)))
1645             self.assertIn("changes", result)
1646             self.assertEqual(result["changes"], {})
1647     @pytest.mark.slow_test
1648     def test_usage_plan_association_absent_if_describe_fails(self, *args):
1649         with patch.dict(
1650             boto_apigateway.__salt__,
1651             {
1652                 "boto_apigateway.describe_usage_plans": MagicMock(
1653                     return_value={"error": "error"}
1654                 )
1655             },
1656         ):
1657             result = boto_apigateway.usage_plan_association_absent(
1658                 "name", "plan_name", [association_stage_1], **conn_parameters
1659             )
1660             self.assertIn("result", result)
1661             self.assertEqual(result["result"], False)
1662             self.assertIn("comment", result)
1663             self.assertEqual(
1664                 result["comment"], "Failed to describe existing usage plans"
1665             )
1666             self.assertIn("changes", result)
1667             self.assertEqual(result["changes"], {})
1668     @pytest.mark.slow_test
1669     def test_usage_plan_association_absent_if_plan_is_not_present(self, *args):
1670         with patch.dict(
1671             boto_apigateway.__salt__,
1672             {
1673                 "boto_apigateway.describe_usage_plans": MagicMock(
1674                     return_value={"plans": []}
1675                 )
1676             },
1677         ):
1678             result = boto_apigateway.usage_plan_association_absent(
1679                 "name", "plan_name", [association_stage_1], **conn_parameters
1680             )
1681             self.assertIn("result", result)
1682             self.assertEqual(result["result"], False)
1683             self.assertIn("comment", result)
1684             self.assertEqual(result["comment"], "Usage plan plan_name does not exist")
1685             self.assertIn("changes", result)
1686             self.assertEqual(result["changes"], {})
1687     @pytest.mark.slow_test
1688     def test_usage_plan_association_absent_if_multiple_plans_with_the_same_name_exist(
1689         self, *args
1690     ):
1691         with patch.dict(
1692             boto_apigateway.__salt__,
1693             {
1694                 "boto_apigateway.describe_usage_plans": MagicMock(
1695                     return_value={"plans": [{"id": "id1"}, {"id": "id2"}]}
1696                 )
1697             },
1698         ):
1699             result = boto_apigateway.usage_plan_association_absent(
1700                 "name", "plan_name", [association_stage_1], **conn_parameters
1701             )
1702             self.assertIn("result", result)
1703             self.assertEqual(result["result"], False)
1704             self.assertIn("comment", result)
1705             self.assertEqual(
1706                 result["comment"],
1707                 "There are multiple usage plans with the same name - it is not"
1708                 " supported",
1709             )
1710             self.assertIn("changes", result)
1711             self.assertEqual(result["changes"], {})
1712     @pytest.mark.slow_test
1713     def test_usage_plan_association_absent_if_plan_has_no_associations(self, *args):
1714         with patch.dict(
1715             boto_apigateway.__salt__,
1716             {
1717                 "boto_apigateway.describe_usage_plans": MagicMock(
1718                     return_value={"plans": [{"id": "id1", "apiStages": []}]}
1719                 )
1720             },
1721         ):
1722             result = boto_apigateway.usage_plan_association_absent(
1723                 "name", "plan_name", [association_stage_1], **conn_parameters
1724             )
1725             self.assertIn("result", result)
1726             self.assertEqual(result["result"], True)
1727             self.assertIn("comment", result)
1728             self.assertEqual(
1729                 result["comment"],
1730                 "Usage plan plan_name has no associated stages already",
1731             )
1732             self.assertIn("changes", result)
1733             self.assertEqual(result["changes"], {})
1734     @pytest.mark.slow_test
1735     def test_usage_plan_association_absent_if_plan_has_no_specific_association(
1736         self, *args
1737     ):
1738         with patch.dict(
1739             boto_apigateway.__salt__,
1740             {
1741                 "boto_apigateway.describe_usage_plans": MagicMock(
1742                     return_value={
1743                         "plans": [{"id": "id1", "apiStages": [association_stage_1]}]
1744                     }
1745                 )
1746             },
1747         ):
1748             result = boto_apigateway.usage_plan_association_absent(
1749                 "name", "plan_name", [association_stage_2], **conn_parameters
1750             )
1751             self.assertIn("result", result)
1752             self.assertEqual(result["result"], True)
1753             self.assertIn("comment", result)
1754             self.assertEqual(
1755                 result["comment"],
1756                 "Usage plan is already not asssociated to any api stages",
1757             )
1758             self.assertIn("changes", result)
1759             self.assertEqual(result["changes"], {})
1760     @pytest.mark.slow_test
1761     def test_usage_plan_association_absent_if_detaching_association_fails(self, *args):
1762         with patch.dict(
1763             boto_apigateway.__salt__,
1764             {
1765                 "boto_apigateway.describe_usage_plans": MagicMock(
1766                     return_value={
1767                         "plans": [
1768                             {
1769                                 "id": "id1",
1770                                 "apiStages": [association_stage_1, association_stage_2],
1771                             }
1772                         ]
1773                     }
1774                 ),
1775                 "boto_apigateway.detach_usage_plan_from_apis": MagicMock(
1776                     return_value={"error": "error"}
1777                 ),
1778             },
1779         ):
1780             result = boto_apigateway.usage_plan_association_absent(
1781                 "name", "plan_name", [association_stage_2], **conn_parameters
1782             )
1783             self.assertIn("result", result)
1784             self.assertEqual(result["result"], False)
1785             self.assertIn("comment", result)
1786             self.assertTrue(
1787                 result["comment"].startswith(
1788                     "Failed to disassociate a usage plan plan_name from the apis"
1789                 )
1790             )
1791             self.assertIn("changes", result)
1792             self.assertEqual(result["changes"], {})
1793     @pytest.mark.slow_test
1794     def test_usage_plan_association_absent_success(self, *args):
1795         with patch.dict(
1796             boto_apigateway.__salt__,
1797             {
1798                 "boto_apigateway.describe_usage_plans": MagicMock(
1799                     return_value={
1800                         "plans": [
1801                             {
1802                                 "id": "id1",
1803                                 "apiStages": [association_stage_1, association_stage_2],
1804                             }
1805                         ]
1806                     }
1807                 ),
1808                 "boto_apigateway.detach_usage_plan_from_apis": MagicMock(
1809                     return_value={"result": {"apiStages": [association_stage_1]}}
1810                 ),
1811             },
1812         ):
1813             result = boto_apigateway.usage_plan_association_absent(
1814                 "name", "plan_name", [association_stage_2], **conn_parameters
1815             )
1816             self.assertIn("result", result)
1817             self.assertEqual(result["result"], True)
1818             self.assertIn("comment", result)
1819             self.assertEqual(
1820                 result["comment"], "successfully disassociated usage plan from apis"
1821             )
1822             self.assertIn("changes", result)
1823             self.assertEqual(
1824                 result["changes"],
1825                 {
1826                     "new": [association_stage_1],
1827                     "old": [association_stage_1, association_stage_2],
1828                 },
1829             )
1830     @pytest.mark.slow_test
1831     def test_usage_plan_association_absent_if_ValueError_is_raised(self, *args):
1832         with patch.dict(
1833             boto_apigateway.__salt__,
1834             {
1835                 "boto_apigateway.describe_usage_plans": MagicMock(
1836                     side_effect=ValueError("error")
1837                 )
1838             },
1839         ):
1840             result = boto_apigateway.usage_plan_association_absent(
1841                 "name", "plan_name", [association_stage_1], **conn_parameters
1842             )
1843             self.assertIn("result", result)
1844             self.assertEqual(result["result"], False)
1845             self.assertIn("comment", result)
1846             self.assertEqual(result["comment"], repr(("error",)))
1847             self.assertIn("changes", result)
1848             self.assertEqual(result["changes"], {})
1849     @pytest.mark.slow_test
1850     def test_usage_plan_association_absent_if_IOError_is_raised(self, *args):
1851         with patch.dict(
1852             boto_apigateway.__salt__,
1853             {
1854                 "boto_apigateway.describe_usage_plans": MagicMock(
1855                     side_effect=IOError("error")
1856                 )
1857             },
1858         ):
1859             result = boto_apigateway.usage_plan_association_absent(
1860                 "name", "plan_name", [association_stage_1], **conn_parameters
1861             )
1862             self.assertIn("result", result)
1863             self.assertEqual(result["result"], False)
1864             self.assertIn("comment", result)
1865             self.assertEqual(result["comment"], repr(("error",)))
1866             self.assertIn("changes", result)
1867             self.assertEqual(result["changes"], {})
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
