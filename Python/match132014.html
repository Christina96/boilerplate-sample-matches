<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for disks.py &amp; test_boto_apigateway.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for disks.py &amp; test_boto_apigateway.py
      </h3>
<h1 align="center">
        2.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>disks.py (13.58885%)<th>test_boto_apigateway.py (1.4783927%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(184-191)<td><a href="#" name="0">(1396-1405)</a><td align="center"><font color="#ff0000">15</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(139-145)<td><a href="#" name="1">(1589-1596)</a><td align="center"><font color="#cc0000">12</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(91-94)<td><a href="#" name="2">(1956-1969)</a><td align="center"><font color="#cc0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>disks.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import glob
2 import logging
3 import re
4 import salt.modules.cmdmod
5 import salt.utils.files
6 import salt.utils.path
7 import salt.utils.platform
8 __salt__ = {
9     "cmd.run": salt.modules.cmdmod._run_quiet,
10     "cmd.run_all": salt.modules.cmdmod._run_all_quiet,
11 }
12 log = logging.getLogger(__name__)
13 def disks():
14     if salt.utils.platform.is_freebsd():
15         return _freebsd_geom()
16     elif salt.utils.platform.is_linux():
17         return _linux_disks()
18     elif salt.utils.platform.is_windows():
19         return _windows_disks()
20     else:
21         log.trace("Disk grain does not support OS")
22 class _geomconsts:
23     GEOMNAME = "Geom name"
24     MEDIASIZE = "Mediasize"
25     SECTORSIZE = "Sectorsize"
26     STRIPESIZE = "Stripesize"
27     STRIPEOFFSET = "Stripeoffset"
28     DESCR = "descr"  # model
29     LUNID = "lunid"
30     LUNNAME = "lunname"
31     IDENT = "ident"  # serial
32     ROTATIONRATE = "rotationrate"  # RPM or 0 for non-rotating
33     _aliases = {
34         DESCR: "device_model",
35         IDENT: "serial_number",
36         ROTATIONRATE: "media_RPM",
37         LUNID: "WWN",
38     }
39     _datatypes = {
40         MEDIASIZE: ("re_int", r"(\d+)"),
41         SECTORSIZE: "try_int",
42         STRIPESIZE: "try_int",
43         STRIPEOFFSET: "try_int",
44         ROTATIONRATE: "try_int",
45     }
46 def _datavalue(datatype, data):
47     if datatype == "try_int":
48         try:
49             return int(data)
50         except ValueError:
51             return None
52     elif datatype is tuple and datatype[0] == "re_int":
53         search = re.search(datatype[1], data)
54         if search:
55             try:
56                 return int(search.group(1))
57             except ValueError:
58                 return None
59         return None
60     else:
61         return data
62 _geom_attribs = [
63     _geomconsts.__dict__[key] for key in _geomconsts.__dict__ if not key.startswith("_")
64 ]
65 def _freebsd_geom():
66     geom <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= salt.utils.path.which("geom")
67     ret = {"disks": {}, "ssds": []}
68     devices = __salt__["cmd.run"]("{} disk list".format(</b></font>geom))
69     devices = devices.split("\n\n")
70     def parse_geom_attribs(device):
71         tmp = {}
72         for line in device.split("\n"):
73             for attrib in _geom_attribs:
74                 search = re.search(r"{}:\s(.*)".format(attrib), line)
75                 if search:
76                     value = _datavalue(
77                         _geomconsts._datatypes.get(attrib), search.group(1)
78                     )
79                     tmp[attrib] = value
80                     if attrib in _geomconsts._aliases:
81                         tmp[_geomconsts._aliases[attrib]] = value
82         name = tmp.pop(_geomconsts.GEOMNAME)
83         if name.startswith("cd"):
84             return
85         ret["disks"][name] = tmp
86         if tmp.get(_geomconsts.ROTATIONRATE) == 0:
87             log.trace("Device %s reports itself as an SSD", device)
88             ret["ssds"].append(name)
89     for device in devices:
90         parse_geom_attribs(device)
91     return ret
92 def _linux_disks():
93     ret = {"disks": [], "ssds": []}
94     for entry in glob.glob("/sys/block/*"):
95         virtual = salt.utils.path.readlink(entry).startswith("../devices/virtual/")
96         try:
97             if not virtual:
98                 with salt.utils.files.fopen(entry + "/queue/rotational") as entry_fp:
99                     flag = entry_fp.read(1)
100                     if flag == "0":
101                         ret<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["ssds"].append(device)
102                         log.trace("Device %s reports itself as an SSD", device)
103                     elif flag == "1":
104                         ret["disks"].append(device)
105                         log.trace("Device %s reports itself as an HDD", device)
106                     else:
107                         log.trace(</b></font>
108                             "Unable to identify device %s as an SSD or HDD. It does "
109                             "not report 0 or 1",
110                             device,
111                         )
112         except OSError:
113             pass
114     return ret
115 def _windows_disks():
116     wmic = salt.utils.path.which("wmic")
117     namespace = r"\\root\microsoft\windows\storage"
118     path = "MSFT_PhysicalDisk"
119     get = "DeviceID,MediaType"
120     ret = {"disks": [], "ssds": []}
121     cmdret = __salt__["cmd.run_all"](
122         "{} /namespace:{} path {} get {} /format:table".format(
123             wmic, namespace, path, get
124         )
125     )
126     if cmdret["retcode"] != 0:
127         log.trace("Disk grain does not support this version of Windows")
128     else:
129         for line in cmdret["stdout"].splitlines():
130             info = line.split()
131             if len(info) != 2 or not info[0].isdigit() or not info[1].isdigit():
132                 continue
133             device = r"\\.\PhysicalDrive{}".format(info[0])
134             mediatype = info[1]
135             if mediatype == "3":
136                 log.trace("Device %s reports itself as an HDD", device)
137             elif mediatype == "4":
138                 log.trace("Device %s reports itself as an SSD", device)
139                 ret["ssds"]<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.append(device)
140                 ret["disks"].append(device)
141             elif mediatype == "5":
142                 log.trace("Device %s reports itself as an SCM", device)
143                 ret["disks"].append(device)
144             else:
145                 log.trace("Device %s reports itself as Unspecified", device)
146                 ret["disks"].append(</b></font>device)
147     return ret
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_boto_apigateway.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import datetime
2 import logging
3 import os
4 import random
5 import string
6 import pytest
7 import salt.config
8 import salt.loader
9 import salt.states.boto_apigateway as boto_apigateway
10 import salt.utils.files
11 import salt.utils.yaml
12 from salt.utils.versions import LooseVersion
13 from tests.support.mixins import LoaderModuleMockMixin
14 from tests.support.mock import MagicMock, patch
15 from tests.support.unit import TestCase, skipIf
16 from tests.unit.modules.test_boto_apigateway import BotoApiGatewayTestCaseMixin
17 try:
18     import boto3
19     import botocore
20     from botocore.exceptions import ClientError
21     HAS_BOTO = True
22 except ImportError:
23     HAS_BOTO = False
24 required_boto3_version = "1.2.1"
25 required_botocore_version = "1.4.49"
26 region = "us-east-1"
27 access_key = "GKTADJGHEIQSXMKKRBJ08H"
28 secret_key = "askdjghsdfjkghWupUjasdflkdfklgjsdfjajkghs"
29 conn_parameters = {
30     "region": region,
31     "key": access_key,
32     "keyid": secret_key,
33     "profile": {},
34 }
35 error_message = (
36     "An error occurred (101) when calling the {0} operation: Test-defined error"
37 )
38 error_content = {"Error": {"Code": 101, "Message": "Test-defined error"}}
39 api_ret = dict(
40     description=(
41         '{\n    "context": "See deployment or stage description",\n   '
42         ' "provisioned_by": "Salt boto_apigateway.present State"\n}'
43     ),
44     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
45     id="vni0vq8wzi",
46     name="unit test api",
47 )
48 no_apis_ret = {"items": []}
49 apis_ret = {"items": [api_ret]}
50 mock_model_ret = dict(
51     contentType="application/json",
52     description="mock model",
53     id="123abc",
54     name="mock model",
55     schema=(
56         "{\n"
57         '    "$schema": "http://json-schema.org/draft-04/schema#",\n'
58         '    "properties": {\n'
59         '        "field": {\n'
60         '            "type": "string"\n'
61         "        }\n"
62         "    }\n"
63         "}"
64     ),
65 )
66 models_ret = {
67     "items": [
68         dict(
69             contentType="application/json",
70             description="Error",
71             id="50nw8r",
72             name="Error",
73             schema=(
74                 "{\n"
75                 '    "$schema": "http://json-schema.org/draft-04/schema#",\n'
76                 '    "properties": {\n'
77                 '        "code": {\n'
78                 '            "format": "int32",\n'
79                 '            "type": "integer"\n'
80                 "        },\n"
81                 '        "fields": {\n'
82                 '            "type": "string"\n'
83                 "        },\n"
84                 '        "message": {\n'
85                 '            "type": "string"\n'
86                 "        }\n"
87                 "    },\n"
88                 '    "title": "Error Schema",\n'
89                 '    "type": "object"\n'
90                 "}"
91             ),
92         ),
93         dict(
94             contentType="application/json",
95             description="User",
96             id="terlnw",
97             name="User",
98             schema=(
99                 "{\n"
100                 '    "$schema": "http://json-schema.org/draft-04/schema#",\n'
101                 '    "properties": {\n'
102                 '        "password": {\n'
103                 '            "description": "A password for the new user",\n'
104                 '            "type": "string"\n'
105                 "        },\n"
106                 '        "username": {\n'
107                 '            "description": "A unique username for the user",\n'
108                 '            "type": "string"\n'
109                 "        }\n"
110                 "    },\n"
111                 '    "title": "User Schema",\n'
112                 '    "type": "object"\n'
113                 "}"
114             ),
115         ),
116     ]
117 }
118 root_resources_ret = {"items": [dict(id="bgk0rk8rqb", path="/")]}
119 resources_ret = {
120     "items": [
121         dict(id="bgk0rk8rqb", path="/"),
122         dict(
123             id="9waiaz",
124             parentId="bgk0rk8rqb",
125             path="/users",
126             pathPart="users",
127             resourceMethods={"POST": {}},
128         ),
129     ]
130 }
131 no_resources_ret = {"items": []}
132 stage1_deployment1_ret = dict(
133     cacheClusterEnabled=False,
134     cacheClusterSize=0.5,
135     cacheClusterStatus="NOT_AVAILABLE",
136     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
137     deploymentId="kobnrb",
138     description=(
139         "{\n"
140         '    "current_deployment_label": {\n'
141         '        "api_name": "unit test api",\n'
142         '        "swagger_file": "temp-swagger-sample.yaml",\n'
143         '        "swagger_file_md5sum": "4fb17e43bab3a96e7f2410a1597cd0a5",\n'
144         '        "swagger_info_object": {\n'
145         '            "description": "salt boto apigateway unit test service",\n'
146         '            "title": "salt boto apigateway unit test service",\n'
147         '            "version": "0.0.0"\n'
148         "        }\n"
149         "    }\n"
150         "}"
151     ),
152     lastUpdatedDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
153     methodSettings=dict(),
154     stageName="test",
155     variables=dict(),
156 )
157 stage1_deployment1_vars_ret = dict(
158     cacheClusterEnabled=False,
159     cacheClusterSize=0.5,
160     cacheClusterStatus="NOT_AVAILABLE",
161     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
162     deploymentId="kobnrb",
163     description=(
164         "{\n"
165         '    "current_deployment_label": {\n'
166         '        "api_name": "unit test api",\n'
167         '        "swagger_file": "temp-swagger-sample.yaml",\n'
168         '        "swagger_file_md5sum": "4fb17e43bab3a96e7f2410a1597cd0a5",\n'
169         '        "swagger_info_object": {\n'
170         '            "description": "salt boto apigateway unit test service",\n'
171         '            "title": "salt boto apigateway unit test service",\n'
172         '            "version": "0.0.0"\n'
173         "        }\n"
174         "    }\n"
175         "}"
176     ),
177     lastUpdatedDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
178     methodSettings=dict(),
179     stageName="test",
180     variables={"var1": "val1"},
181 )
182 stage1_deployment2_ret = dict(
183     cacheClusterEnabled=False,
184     cacheClusterSize=0.5,
185     cacheClusterStatus="NOT_AVAILABLE",
186     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
187     deploymentId="kobnrc",
188     description=(
189         "{\n"
190         '    "current_deployment_label": {\n'
191         '        "api_name": "unit test api",\n'
192         '        "swagger_file": "temp-swagger-sample.yaml",\n'
193         '        "swagger_file_md5sum": "5fd538c4336ed5c54b4bf39ddf97c661",\n'
194         '        "swagger_info_object": {\n'
195         '            "description": "salt boto apigateway unit test service",\n'
196         '            "title": "salt boto apigateway unit test service",\n'
197         '            "version": "0.0.2"\n'
198         "        }\n"
199         "    }\n"
200         "}"
201     ),
202     lastUpdatedDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
203     methodSettings=dict(),
204     stageName="test",
205     variables=dict(),
206 )
207 stage2_ret = dict(
208     cacheClusterEnabled=False,
209     cacheClusterSize=0.5,
210     cacheClusterStatus="NOT_AVAILABLE",
211     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
212     deploymentId="kobnrb",
213     description=(
214         "{\n"
215         '    "current_deployment_label": {\n'
216         '        "api_name": "unit test api",\n'
217         '        "swagger_file": "temp-swagger-sample.yaml",\n'
218         '        "swagger_file_md5sum": "4fb17e43bab3a96e7f2410a1597cd0a5",\n'
219         '        "swagger_info_object": {\n'
220         '            "description": "salt boto apigateway unit test service",\n'
221         '            "title": "salt boto apigateway unit test service",\n'
222         '            "version": "0.0.0"\n'
223         "        }\n"
224         "    }\n"
225         "}"
226     ),
227     lastUpdatedDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
228     methodSettings=dict(),
229     stageName="dev",
230     variables=dict(),
231 )
232 stages_stage2_ret = {"item": [stage2_ret]}
233 no_stages_ret = {"item": []}
234 deployment1_ret = dict(
235     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
236     description=(
237         "{\n"
238         '    "api_name": "unit test api",\n'
239         '    "swagger_file": "temp-swagger-sample.yaml",\n'
240         '    "swagger_file_md5sum": "55a948ff90ad80ff747ec91657c7a299",\n'
241         '    "swagger_info_object": {\n'
242         '        "description": "salt boto apigateway unit test service",\n'
243         '        "title": "salt boto apigateway unit test service",\n'
244         '        "version": "0.0.0"\n'
245         "    }\n"
246         "}"
247     ),
248     id="kobnrb",
249 )
250 deployment2_ret = dict(
251     createdDate=datetime.datetime(2015, 11, 17, 16, 33, 50),
252     description=(
253         "{\n"
254         '    "api_name": "unit test api",\n'
255         '    "swagger_file": "temp-swagger-sample.yaml",\n'
256         '    "swagger_file_md5sum": "5fd538c4336ed5c54b4bf39ddf97c661",\n'
257         '    "swagger_info_object": {\n'
258         '        "description": "salt boto apigateway unit test service",\n'
259         '        "title": "salt boto apigateway unit test service",\n'
260         '        "version": "0.0.2"\n'
261         "    }\n"
262         "}"
263     ),
264     id="kobnrc",
265 )
266 deployments_ret = {"items": [deployment1_ret, deployment2_ret]}
267 function_ret = dict(
268     FunctionName="unit_test_api_users_post",
269     Runtime="python2.7",
270     Role=None,
271     Handler="handler",
272     Description="abcdefg",
273     Timeout=5,
274     MemorySize=128,
275     CodeSha256="abcdef",
276     CodeSize=199,
277     FunctionArn="arn:lambda:us-east-1:1234:Something",
278     LastModified="yes",
279 )
280 method_integration_response_200_ret = dict(
281     responseParameters={"method.response.header.Access-Control-Allow-Origin": "*"},
282     responseTemplates={},
283     selectionPattern=".*",
284     statusCode="200",
285 )
286 method_integration_ret = dict(
287     cacheKeyParameters={},
288     cacheNamespace="9waiaz",
289     credentials="arn:aws:iam::1234:role/apigatewayrole",
290     httpMethod="POST",
291     integrationResponses={"200": method_integration_response_200_ret},
292     requestParameters={},
293     requestTemplates={
294         "application/json": (
295             "#set($inputRoot = $input.path('$')){\"header-params\" : {#set ($map ="
296             ' $input.params().header)#foreach( $param in $map.entrySet() )"$param.key"'
297             ' : "$param.value" #if( $foreach.hasNext ), #end#end},"query-params" :'
298             " {#set ($map = $input.params().querystring)#foreach( $param in"
299             ' $map.entrySet() )"$param.key" : "$param.value" #if( $foreach.hasNext ),'
300             ' #end#end},"path-params" : {#set ($map = $input.params().path)#foreach('
301             ' $param in $map.entrySet() )"$param.key" : "$param.value" #if('
302             " $foreach.hasNext ), #end#end},\"body-params\" : $input.json('$')}"
303         )
304     },
305     type="AWS",
306     uri=(
307         "arn:aws:apigateway:us-west-2:"
308         "lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:1234567:"
309         "function:unit_test_api_api_users_post/invocations"
310     ),
311 )
312 method_response_200_ret = dict(
313     responseModels={"application/json": "User"},
314     responseParameters={"method.response.header.Access-Control-Allow-Origin": False},
315     statusCode="200",
316 )
317 method_ret = dict(
318     apiKeyRequired=False,
319     authorizationType="None",
320     httpMethod="POST",
321     methodIntegration=method_integration_ret,
322     methodResponses={"200": method_response_200_ret},
323     requestModels={"application/json": "User"},
324     requestParameters={},
325 )
326 throttle_rateLimit = 10.0
327 association_stage_1 = {"apiId": "apiId1", "stage": "stage1"}
328 association_stage_2 = {"apiId": "apiId1", "stage": "stage2"}
329 log = logging.getLogger(__name__)
330 def _has_required_boto():
331     if not HAS_BOTO:
332         return False
333     elif LooseVersion(boto3.__version__) &lt; LooseVersion(required_boto3_version):
334         return False
335     else:
336         return True
337 def _has_required_botocore():
338     if not HAS_BOTO:
339         return False
340     elif LooseVersion(botocore.__version__) &lt; LooseVersion(required_botocore_version):
341         return False
342     else:
343         return True
344 class TempSwaggerFile:
345     _tmp_swagger_dict = {
346         "info": {
347             "version": "0.0.0",
348             "description": "salt boto apigateway unit test service",
349             "title": "salt boto apigateway unit test service",
350         },
351         "paths": {
352             "/users": {
353                 "post": {
354                     "responses": {
355                         "200": {
356                             "headers": {
357                                 "Access-Control-Allow-Origin": {"type": "string"}
358                             },
359                             "description": "The username of the new user",
360                             "schema": {"$ref": "#/definitions/User"},
361                         }
362                     },
363                     "parameters": [
364                         {
365                             "in": "body",
366                             "description": "New user details.",
367                             "name": "NewUser",
368                             "schema": {"$ref": "#/definitions/User"},
369                         }
370                     ],
371                     "produces": ["application/json"],
372                     "description": "Creates a new user.",
373                     "tags": ["Auth"],
374                     "consumes": ["application/json"],
375                     "summary": "Registers a new user",
376                 }
377             }
378         },
379         "schemes": ["https"],
380         "produces": ["application/json"],
381         "basePath": "/api",
382         "host": "rm06h9oac4.execute-api.us-west-2.amazonaws.com",
383         "definitions": {
384             "User": {
385                 "properties": {
386                     "username": {
387                         "type": "string",
388                         "description": "A unique username for the user",
389                     },
390                     "password": {
391                         "type": "string",
392                         "description": "A password for the new user",
393                     },
394                 }
395             },
396             "Error": {
397                 "properties": {
398                     "fields": {"type": "string"},
399                     "message": {"type": "string"},
400                     "code": {"type": "integer", "format": "int32"},
401                 }
402             },
403         },
404         "swagger": "2.0",
405     }
406     def __enter__(self):
407         self.swaggerfile = "temp-swagger-sample.yaml"
408         with salt.utils.files.fopen(self.swaggerfile, "w") as fp_:
409             salt.utils.yaml.safe_dump(self.swaggerdict, fp_, default_flow_style=False)
410         return self.swaggerfile
411     def __exit__(self, objtype, value, traceback):
412         os.remove(self.swaggerfile)
413     def __init__(self, create_invalid_file=False):
414         if create_invalid_file:
415             self.swaggerdict = TempSwaggerFile._tmp_swagger_dict.copy()
416             self.swaggerdict["invalid_key"] = "invalid"
417             self.swaggerdict.pop("schemes", None)
418             self.swaggerdict["swagger"] = "3.0"
419             self.swaggerdict.pop("info", None)
420         else:
421             self.swaggerdict = TempSwaggerFile._tmp_swagger_dict
422 class BotoApiGatewayStateTestCaseBase(TestCase, LoaderModuleMockMixin):
423     conn = None
424     @classmethod
425     def setUpClass(cls):
426         cls.opts = salt.config.DEFAULT_MINION_OPTS.copy()
427         cls.opts["grains"] = salt.loader.grains(cls.opts)
428     @classmethod
429     def tearDownClass(cls):
430         del cls.opts
431     def setup_loader_modules(self):
432         context = {}
433         utils = salt.loader.utils(
434             self.opts,
435             whitelist=["boto", "boto3", "args", "systemd", "path", "platform", "reg"],
436             context=context,
437         )
438         serializers = salt.loader.serializers(self.opts)
439         self.funcs = salt.loader.minion_mods(
440             self.opts, context=context, utils=utils, whitelist=["boto_apigateway"]
441         )
442         self.salt_states = salt.loader.states(
443             opts=self.opts,
444             functions=self.funcs,
445             utils=utils,
446             whitelist=["boto_apigateway"],
447             serializers=serializers,
448         )
449         return {
450             boto_apigateway: {
451                 "__opts__": self.opts,
452                 "__utils__": utils,
453                 "__salt__": self.funcs,
454                 "__states__": self.salt_states,
455                 "__serializers__": serializers,
456             }
457         }
458     def setUp(self):
459         self.addCleanup(delattr, self, "funcs")
460         self.addCleanup(delattr, self, "salt_states")
461         conn_parameters["key"] = "".join(
462             random.choice(string.ascii_lowercase + string.digits) for _ in range(50)
463         )
464         patcher = patch("boto3.session.Session")
465         self.addCleanup(patcher.stop)
466         mock_session = patcher.start()
467         session_instance = mock_session.return_value
468         self.conn = MagicMock()
469         self.addCleanup(delattr, self, "conn")
470         session_instance.client.return_value = self.conn
471 @skipIf(HAS_BOTO is False, "The boto module must be installed.")
472 @skipIf(
473     _has_required_boto() is False,
474     "The boto3 module must be greater than or equal to version {}".format(
475         required_boto3_version
476     ),
477 )
478 class BotoApiGatewayTestCase(
479     BotoApiGatewayStateTestCaseBase, BotoApiGatewayTestCaseMixin
480 ):
481     def test_present_when_swagger_file_is_invalid(self):
482         result = {}
483         with TempSwaggerFile(create_invalid_file=True) as swagger_file:
484             result = self.salt_states["boto_apigateway.present"](
485                 "api present",
486                 "unit test api",
487                 swagger_file,
488                 "test",
489                 False,
490                 "arn:aws:iam::1234:role/apigatewayrole",
491                 **conn_parameters
492             )
493         self.assertFalse(result.get("result", True))
494     def test_present_when_stage_is_already_at_desired_deployment(self):
495         self.conn.get_rest_apis.return_value = apis_ret
496         self.conn.get_deployment.return_value = deployment1_ret
497         self.conn.get_stage.return_value = stage1_deployment1_ret
498         self.conn.update_stage.side_effect = ClientError(
499             error_content, "update_stage should not be called"
500         )
501         result = {}
502         with TempSwaggerFile() as swagger_file:
503             result = self.salt_states["boto_apigateway.present"](
504                 "api present",
505                 "unit test api",
506                 swagger_file,
507                 "test",
508                 False,
509                 "arn:aws:iam::1234:role/apigatewayrole",
510                 **conn_parameters
511             )
512         self.assertFalse(result.get("abort"))
513         self.assertTrue(result.get("current"))
514         self.assertIs(result.get("result"), True)
515         self.assertNotIn("update_stage should not be called", result.get("comment", ""))
516     def test_present_when_stage_is_already_at_desired_deployment_and_needs_stage_variables_update(
517         self,
518     ):
519         self.conn.get_rest_apis.return_value = apis_ret
520         self.conn.get_deployment.return_value = deployment1_ret
521         self.conn.get_stage.return_value = stage1_deployment1_ret
522         self.conn.update_stage.return_value = stage1_deployment1_vars_ret
523         result = {}
524         with TempSwaggerFile() as swagger_file:
525             result = self.salt_states["boto_apigateway.present"](
526                 "api present",
527                 "unit test api",
528                 swagger_file,
529                 "test",
530                 False,
531                 "arn:aws:iam::1234:role/apigatewayrole",
532                 stage_variables={"var1": "val1"},
533                 **conn_parameters
534             )
535         self.assertFalse(result.get("abort"))
536         self.assertTrue(result.get("current"))
537         self.assertIs(result.get("result"), True)
538     def test_present_when_stage_exists_and_is_to_associate_to_existing_deployment(self):
539         self.conn.get_rest_apis.return_value = apis_ret
540         self.conn.get_deployment.return_value = deployment2_ret
541         self.conn.get_deployments.return_value = deployments_ret
542         self.conn.get_stage.return_value = stage1_deployment2_ret
543         self.conn.update_stage.return_value = stage1_deployment1_ret
544         self.conn.create_stage.side_effect = ClientError(error_content, "create_stage")
545         self.conn.create_deployment.side_effect = ClientError(
546             error_content, "create_deployment"
547         )
548         result = {}
549         with TempSwaggerFile() as swagger_file:
550             result = self.salt_states["boto_apigateway.present"](
551                 "api present",
552                 "unit test api",
553                 swagger_file,
554                 "test",
555                 False,
556                 "arn:aws:iam::1234:role/apigatewayrole",
557                 **conn_parameters
558             )
559         self.assertTrue(result.get("publish"))
560         self.assertIs(result.get("result"), True)
561         self.assertFalse(result.get("abort"))
562         self.assertTrue(result.get("changes", {}).get("new", [{}])[0])
563     @pytest.mark.slow_test
564     def test_present_when_stage_is_to_associate_to_new_deployment(self):
565         self.conn.get_rest_apis.return_value = no_apis_ret
566         self.conn.create_rest_api.return_value = api_ret
567         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
568         self.conn.create_model.return_value = mock_model_ret
569         self.conn.get_resources.return_value = resources_ret
570         self.conn.create_resource.side_effect = ClientError(
571             error_content, "create_resource"
572         )
573         self.conn.put_method.return_value = method_ret
574         self.conn.put_integration.return_value = method_integration_ret
575         self.conn.put_method_response.return_value = method_response_200_ret
576         self.conn.put_intgration_response.return_value = (
577             method_integration_response_200_ret
578         )
579         result = {}
580         with patch.dict(
581             self.funcs,
582             {
583                 "boto_lambda.describe_function": MagicMock(
584                     return_value={"function": function_ret}
585                 )
586             },
587         ):
588             with TempSwaggerFile() as swagger_file:
589                 result = self.salt_states["boto_apigateway.present"](
590                     "api present",
591                     "unit test api",
592                     swagger_file,
593                     "test",
594                     False,
595                     "arn:aws:iam::1234:role/apigatewayrole",
596                     **conn_parameters
597                 )
598         self.assertIs(result.get("result"), True)
599         self.assertIs(result.get("abort"), None)
600     def test_present_when_stage_associating_to_new_deployment_errored_on_api_creation(
601         self,
602     ):
603         self.conn.get_rest_apis.return_value = no_apis_ret
604         self.conn.create_rest_api.side_effect = ClientError(
605             error_content, "create_rest_api"
606         )
607         result = {}
608         with TempSwaggerFile() as swagger_file:
609             result = self.salt_states["boto_apigateway.present"](
610                 "api present",
611                 "unit test api",
612                 swagger_file,
613                 "test",
614                 False,
615                 "arn:aws:iam::1234:role/apigatewayrole",
616                 **conn_parameters
617             )
618         self.assertIs(result.get("abort"), True)
619         self.assertIs(result.get("result"), False)
620         self.assertIn("create_rest_api", result.get("comment", ""))
621     def test_present_when_stage_associating_to_new_deployment_errored_on_model_creation(
622         self,
623     ):
624         self.conn.get_rest_apis.return_value = no_apis_ret
625         self.conn.create_rest_api.return_value = api_ret
626         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
627         self.conn.create_model.side_effect = ClientError(error_content, "create_model")
628         result = {}
629         with TempSwaggerFile() as swagger_file:
630             result = self.salt_states["boto_apigateway.present"](
631                 "api present",
632                 "unit test api",
633                 swagger_file,
634                 "test",
635                 False,
636                 "arn:aws:iam::1234:role/apigatewayrole",
637                 **conn_parameters
638             )
639         self.assertIs(result.get("abort"), True)
640         self.assertIs(result.get("result"), False)
641         self.assertIn("create_model", result.get("comment", ""))
642     def test_present_when_stage_associating_to_new_deployment_errored_on_resource_creation(
643         self,
644     ):
645         self.conn.get_rest_apis.return_value = no_apis_ret
646         self.conn.create_rest_api.return_value = api_ret
647         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
648         self.conn.create_model.return_value = mock_model_ret
649         self.conn.get_resources.return_value = root_resources_ret
650         self.conn.create_resource.side_effect = ClientError(
651             error_content, "create_resource"
652         )
653         result = {}
654         with TempSwaggerFile() as swagger_file:
655             result = self.salt_states["boto_apigateway.present"](
656                 "api present",
657                 "unit test api",
658                 swagger_file,
659                 "test",
660                 False,
661                 "arn:aws:iam::1234:role/apigatewayrole",
662                 **conn_parameters
663             )
664         self.assertIs(result.get("abort"), True)
665         self.assertIs(result.get("result"), False)
666         self.assertIn("create_resource", result.get("comment", ""))
667     @pytest.mark.slow_test
668     def test_present_when_stage_associating_to_new_deployment_errored_on_put_method(
669         self,
670     ):
671         self.conn.get_rest_apis.return_value = no_apis_ret
672         self.conn.create_rest_api.return_value = api_ret
673         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
674         self.conn.create_model.return_value = mock_model_ret
675         self.conn.get_resources.return_value = resources_ret
676         self.conn.create_resource.side_effect = ClientError(
677             error_content, "create_resource"
678         )
679         self.conn.put_method.side_effect = ClientError(error_content, "put_method")
680         result = {}
681         with patch.dict(
682             self.funcs,
683             {
684                 "boto_lambda.describe_function": MagicMock(
685                     return_value={"function": function_ret}
686                 )
687             },
688         ):
689             with TempSwaggerFile() as swagger_file:
690                 result = self.salt_states["boto_apigateway.present"](
691                     "api present",
692                     "unit test api",
693                     swagger_file,
694                     "test",
695                     False,
696                     "arn:aws:iam::1234:role/apigatewayrole",
697                     **conn_parameters
698                 )
699         self.assertIs(result.get("abort"), True)
700         self.assertIs(result.get("result"), False)
701         self.assertIn("put_method", result.get("comment", ""))
702     @pytest.mark.slow_test
703     def test_present_when_stage_associating_to_new_deployment_errored_on_lambda_function_lookup(
704         self,
705     ):
706         self.conn.get_rest_apis.return_value = no_apis_ret
707         self.conn.create_rest_api.return_value = api_ret
708         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
709         self.conn.create_model.return_value = mock_model_ret
710         self.conn.get_resources.return_value = resources_ret
711         self.conn.create_resource.side_effect = ClientError(
712             error_content, "create_resource"
713         )
714         self.conn.put_method.return_value = method_ret
715         self.conn.put_integration.side_effect = ClientError(
716             error_content, "put_integration should not be invoked"
717         )
718         result = {}
719         with patch.dict(
720             self.funcs,
721             {
722                 "boto_lambda.describe_function": MagicMock(
723                     return_value={"error": "no such lambda"}
724                 )
725             },
726         ):
727             with TempSwaggerFile() as swagger_file:
728                 result = self.salt_states["boto_apigateway.present"](
729                     "api present",
730                     "unit test api",
731                     swagger_file,
732                     "test",
733                     False,
734                     "arn:aws:iam::1234:role/apigatewayrole",
735                     **conn_parameters
736                 )
737         self.assertIs(result.get("result"), False)
738         self.assertNotIn(
739             "put_integration should not be invoked", result.get("comment", "")
740         )
741         self.assertIn("not find lambda function", result.get("comment", ""))
742     @pytest.mark.slow_test
743     def test_present_when_stage_associating_to_new_deployment_errored_on_put_integration(
744         self,
745     ):
746         self.conn.get_rest_apis.return_value = no_apis_ret
747         self.conn.create_rest_api.return_value = api_ret
748         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
749         self.conn.create_model.return_value = mock_model_ret
750         self.conn.get_resources.return_value = resources_ret
751         self.conn.create_resource.side_effect = ClientError(
752             error_content, "create_resource"
753         )
754         self.conn.put_method.return_value = method_ret
755         self.conn.put_integration.side_effect = ClientError(
756             error_content, "put_integration"
757         )
758         result = {}
759         with patch.dict(
760             self.funcs,
761             {
762                 "boto_lambda.describe_function": MagicMock(
763                     return_value={"function": function_ret}
764                 )
765             },
766         ):
767             with TempSwaggerFile() as swagger_file:
768                 result = self.salt_states["boto_apigateway.present"](
769                     "api present",
770                     "unit test api",
771                     swagger_file,
772                     "test",
773                     False,
774                     "arn:aws:iam::1234:role/apigatewayrole",
775                     **conn_parameters
776                 )
777         self.assertIs(result.get("abort"), True)
778         self.assertIs(result.get("result"), False)
779         self.assertIn("put_integration", result.get("comment", ""))
780     @pytest.mark.slow_test
781     def test_present_when_stage_associating_to_new_deployment_errored_on_put_method_response(
782         self,
783     ):
784         self.conn.get_rest_apis.return_value = no_apis_ret
785         self.conn.create_rest_api.return_value = api_ret
786         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
787         self.conn.create_model.return_value = mock_model_ret
788         self.conn.get_resources.return_value = resources_ret
789         self.conn.create_resource.side_effect = ClientError(
790             error_content, "create_resource"
791         )
792         self.conn.put_method.return_value = method_ret
793         self.conn.put_integration.return_value = method_integration_ret
794         self.conn.put_method_response.side_effect = ClientError(
795             error_content, "put_method_response"
796         )
797         result = {}
798         with patch.dict(
799             self.funcs,
800             {
801                 "boto_lambda.describe_function": MagicMock(
802                     return_value={"function": function_ret}
803                 )
804             },
805         ):
806             with TempSwaggerFile() as swagger_file:
807                 result = self.salt_states["boto_apigateway.present"](
808                     "api present",
809                     "unit test api",
810                     swagger_file,
811                     "test",
812                     False,
813                     "arn:aws:iam::1234:role/apigatewayrole",
814                     **conn_parameters
815                 )
816         self.assertIs(result.get("abort"), True)
817         self.assertIs(result.get("result"), False)
818         self.assertIn("put_method_response", result.get("comment", ""))
819     @pytest.mark.slow_test
820     def test_present_when_stage_associating_to_new_deployment_errored_on_put_integration_response(
821         self,
822     ):
823         self.conn.get_rest_apis.return_value = no_apis_ret
824         self.conn.create_rest_api.return_value = api_ret
825         self.conn.get_model.side_effect = ClientError(error_content, "get_model")
826         self.conn.create_model.return_value = mock_model_ret
827         self.conn.get_resources.return_value = resources_ret
828         self.conn.create_resource.side_effect = ClientError(
829             error_content, "create_resource"
830         )
831         self.conn.put_method.return_value = method_ret
832         self.conn.put_integration.return_value = method_integration_ret
833         self.conn.put_method_response.return_value = method_response_200_ret
834         self.conn.put_integration_response.side_effect = ClientError(
835             error_content, "put_integration_response"
836         )
837         result = {}
838         with patch.dict(
839             self.funcs,
840             {
841                 "boto_lambda.describe_function": MagicMock(
842                     return_value={"function": function_ret}
843                 )
844             },
845         ):
846             with TempSwaggerFile() as swagger_file:
847                 result = self.salt_states["boto_apigateway.present"](
848                     "api present",
849                     "unit test api",
850                     swagger_file,
851                     "test",
852                     False,
853                     "arn:aws:iam::1234:role/apigatewayrole",
854                     **conn_parameters
855                 )
856         self.assertIs(result.get("abort"), True)
857         self.assertIs(result.get("result"), False)
858         self.assertIn("put_integration_response", result.get("comment", ""))
859     def test_absent_when_rest_api_does_not_exist(self):
860         self.conn.get_rest_apis.return_value = apis_ret
861         self.conn.get_stage.side_effect = ClientError(
862             error_content, "get_stage should not be called"
863         )
864         result = self.salt_states["boto_apigateway.absent"](
865             "api present",
866             "no_such_rest_api",
867             "no_such_stage",
868             nuke_api=False,
869             **conn_parameters
870         )
871         self.assertIs(result.get("result"), True)
872         self.assertNotIn("get_stage should not be called", result.get("comment", ""))
873         self.assertEqual(result.get("changes"), {})
874     def test_absent_when_stage_is_invalid(self):
875         self.conn.get_rest_apis.return_value = apis_ret
876         self.conn.get_stage.return_value = stage1_deployment1_ret
877         self.conn.delete_stage.side_effect = ClientError(error_content, "delete_stage")
878         result = self.salt_states["boto_apigateway.absent"](
879             "api present",
880             "unit test api",
881             "no_such_stage",
882             nuke_api=False,
883             **conn_parameters
884         )
885         self.assertTrue(result.get("abort", False))
886     def test_absent_when_stage_is_valid_and_only_one_stage_is_associated_to_deployment(
887         self,
888     ):
889         self.conn.get_rest_apis.return_value = apis_ret
890         self.conn.get_stage.return_value = stage1_deployment1_ret
891         self.conn.delete_stage.return_value = {
892             "ResponseMetadata": {
893                 "HTTPStatusCode": 200,
894                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
895             }
896         }
897         self.conn.get_stages.return_value = no_stages_ret
898         self.conn.delete_deployment.return_value = {
899             "ResponseMetadata": {
900                 "HTTPStatusCode": 200,
901                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
902             }
903         }
904         result = self.salt_states["boto_apigateway.absent"](
905             "api present", "unit test api", "test", nuke_api=False, **conn_parameters
906         )
907         self.assertTrue(result.get("result", False))
908     def test_absent_when_stage_is_valid_and_two_stages_are_associated_to_deployment(
909         self,
910     ):
911         self.conn.get_rest_apis.return_value = apis_ret
912         self.conn.get_stage.return_value = stage1_deployment1_ret
913         self.conn.delete_stage.return_value = {
914             "ResponseMetadata": {
915                 "HTTPStatusCode": 200,
916                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
917             }
918         }
919         self.conn.get_stages.return_value = stages_stage2_ret
920         result = self.salt_states["boto_apigateway.absent"](
921             "api present", "unit test api", "test", nuke_api=False, **conn_parameters
922         )
923         self.assertTrue(result.get("result", False))
924     def test_absent_when_failing_to_delete_a_deployment_no_longer_associated_with_any_stages(
925         self,
926     ):
927         self.conn.get_rest_apis.return_value = apis_ret
928         self.conn.get_stage.return_value = stage1_deployment1_ret
929         self.conn.delete_stage.return_value = {
930             "ResponseMetadata": {
931                 "HTTPStatusCode": 200,
932                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
933             }
934         }
935         self.conn.get_stages.return_value = no_stages_ret
936         self.conn.delete_deployment.side_effect = ClientError(
937             error_content, "delete_deployment"
938         )
939         result = self.salt_states["boto_apigateway.absent"](
940             "api present", "unit test api", "test", nuke_api=False, **conn_parameters
941         )
942         self.assertTrue(result.get("abort", False))
943     def test_absent_when_nuke_api_and_no_more_stages_deployments_remain(self):
944         self.conn.get_rest_apis.return_value = apis_ret
945         self.conn.get_stage.return_value = stage1_deployment1_ret
946         self.conn.delete_stage.return_value = {
947             "ResponseMetadata": {
948                 "HTTPStatusCode": 200,
949                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
950             }
951         }
952         self.conn.get_stages.return_value = no_stages_ret
953         self.conn.get_deployments.return_value = deployments_ret
954         self.conn.delete_rest_api.return_value = {
955             "ResponseMetadata": {
956                 "HTTPStatusCode": 200,
957                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
958             }
959         }
960         result = self.salt_states["boto_apigateway.absent"](
961             "api present", "unit test api", "test", nuke_api=True, **conn_parameters
962         )
963         self.assertIs(result.get("result"), True)
964         self.assertIsNot(result.get("abort"), True)
965         self.assertIs(
966             result.get("changes", {})
967             .get("new", [{}])[0]
968             .get("delete_api", {})
969             .get("deleted"),
970             True,
971         )
972     def test_absent_when_nuke_api_and_other_stages_deployments_exist(self):
973         self.conn.get_rest_apis.return_value = apis_ret
974         self.conn.get_stage.return_value = stage1_deployment1_ret
975         self.conn.delete_stage.return_value = {
976             "ResponseMetadata": {
977                 "HTTPStatusCode": 200,
978                 "RequestId": "2d31072c-9d15-11e5-9977-6d9fcfda9c0a",
979             }
980         }
981         self.conn.get_stages.return_value = stages_stage2_ret
982         self.conn.get_deployments.return_value = deployments_ret
983         self.conn.delete_rest_api.side_effect = ClientError(
984             error_content, "unexpected_api_delete"
985         )
986         result = self.salt_states["boto_apigateway.absent"](
987             "api present", "unit test api", "test", nuke_api=True, **conn_parameters
988         )
989         self.assertIs(result.get("result"), True)
990         self.assertIsNot(result.get("abort"), True)
991 @skipIf(HAS_BOTO is False, "The boto module must be installed.")
992 @skipIf(
993     _has_required_boto() is False,
994     "The boto3 module must be greater than or equal to version {}".format(
995         required_boto3_version
996     ),
997 )
998 @skipIf(
999     _has_required_botocore() is False,
1000     "The botocore module must be greater than or equal to version {}".format(
1001         required_botocore_version
1002     ),
1003 )
1004 class BotoApiGatewayUsagePlanTestCase(
1005     BotoApiGatewayStateTestCaseBase, BotoApiGatewayTestCaseMixin
1006 ):
1007     @pytest.mark.slow_test
1008     def test_usage_plan_present_if_describe_fails(self, *args):
1009         with patch.dict(
1010             boto_apigateway.__salt__,
1011             {
1012                 "boto_apigateway.describe_usage_plans": MagicMock(
1013                     return_value={"error": "error"}
1014                 )
1015             },
1016         ):
1017             result = boto_apigateway.usage_plan_present(
1018                 "name", "plan_name", **conn_parameters
1019             )
1020             self.assertIn("result", result)
1021             self.assertEqual(result["result"], False)
1022             self.assertIn("comment", result)
1023             self.assertEqual(
1024                 result["comment"], "Failed to describe existing usage plans"
1025             )
1026             self.assertIn("changes", result)
1027             self.assertEqual(result["changes"], {})
1028     @pytest.mark.slow_test
1029     def test_usage_plan_present_if_there_is_no_such_plan_and_test_option_is_set(
1030         self, *args
1031     ):
1032         with patch.dict(boto_apigateway.__opts__, {"test": True}):
1033             with patch.dict(
1034                 boto_apigateway.__salt__,
1035                 {
1036                     "boto_apigateway.describe_usage_plans": MagicMock(
1037                         return_value={"plans": []}
1038                     )
1039                 },
1040             ):
1041                 result = boto_apigateway.usage_plan_present(
1042                     "name", "plan_name", **conn_parameters
1043                 )
1044                 self.assertIn("comment", result)
1045                 self.assertEqual(
1046                     result["comment"], "a new usage plan plan_name would be created"
1047                 )
1048                 self.assertIn("result", result)
1049                 self.assertEqual(result["result"], None)
1050     @pytest.mark.slow_test
1051     def test_usage_plan_present_if_create_usage_plan_fails(self, *args):
1052         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1053             with patch.dict(
1054                 boto_apigateway.__salt__,
1055                 {
1056                     "boto_apigateway.describe_usage_plans": MagicMock(
1057                         return_value={"plans": []}
1058                     ),
1059                     "boto_apigateway.create_usage_plan": MagicMock(
1060                         return_value={"error": "error"}
1061                     ),
1062                 },
1063             ):
1064                 result = boto_apigateway.usage_plan_present(
1065                     "name", "plan_name", **conn_parameters
1066                 )
1067                 self.assertIn("result", result)
1068                 self.assertEqual(result["result"], False)
1069                 self.assertIn("comment", result)
1070                 self.assertEqual(
1071                     result["comment"], "Failed to create a usage plan plan_name, error"
1072                 )
1073                 self.assertIn("changes", result)
1074                 self.assertEqual(result["changes"], {})
1075     @pytest.mark.slow_test
1076     def test_usage_plan_present_if_plan_is_there_and_needs_no_updates(self, *args):
1077         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1078             with patch.dict(
1079                 boto_apigateway.__salt__,
1080                 {
1081                     "boto_apigateway.describe_usage_plans": MagicMock(
1082                         return_value={"plans": [{"id": "planid", "name": "planname"}]}
1083                     ),
1084                     "boto_apigateway.update_usage_plan": MagicMock(),
1085                 },
1086             ):
1087                 result = boto_apigateway.usage_plan_present(
1088                     "name", "plan_name", **conn_parameters
1089                 self.assertIn("result", result)
1090                 self<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertEqual(result["result"], True)
1091                 self.assertIn("comment", result)
1092                 self.assertEqual(
1093                     result["comment"],
1094                     "usage plan plan_name is already in a correct state",
1095                 )
1096                 self.assertIn("changes", result)
1097                 self.assertEqual(result["changes"], {})
1098                 self.assertTrue(</b></font>
1099                     boto_apigateway.__salt__[
1100                         "boto_apigateway.update_usage_plan"
1101                     ].call_count
1102                     == 0
1103                 )
1104     @pytest.mark.slow_test
1105     def test_usage_plan_present_if_plan_is_there_and_needs_updates_but_test_is_set(
1106         self, *args
1107     ):
1108         with patch.dict(boto_apigateway.__opts__, {"test": True}):
1109             with patch.dict(
1110                 boto_apigateway.__salt__,
1111                 {
1112                     "boto_apigateway.describe_usage_plans": MagicMock(
1113                         return_value={
1114                             "plans": [
1115                                 {
1116                                     "id": "planid",
1117                                     "name": "planname",
1118                                     "throttle": {"rateLimit": 10.0},
1119                                 }
1120                             ]
1121                         }
1122                     ),
1123                     "boto_apigateway.update_usage_plan": MagicMock(),
1124                 },
1125             ):
1126                 result = boto_apigateway.usage_plan_present(
1127                     "name", "plan_name", **conn_parameters
1128                 )
1129                 self.assertIn("comment", result)
1130                 self.assertEqual(
1131                     result["comment"], "a new usage plan plan_name would be updated"
1132                 )
1133                 self.assertIn("result", result)
1134                 self.assertEqual(result["result"], None)
1135                 self.assertTrue(
1136                     boto_apigateway.__salt__[
1137                         "boto_apigateway.update_usage_plan"
1138                     ].call_count
1139                     == 0
1140                 )
1141     @pytest.mark.slow_test
1142     def test_usage_plan_present_if_plan_is_there_and_needs_updates_but_update_fails(
1143         self, *args
1144     ):
1145         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1146             with patch.dict(
1147                 boto_apigateway.__salt__,
1148                 {
1149                     "boto_apigateway.describe_usage_plans": MagicMock(
1150                         return_value={
1151                             "plans": [
1152                                 {
1153                                     "id": "planid",
1154                                     "name": "planname",
1155                                     "throttle": {"rateLimit": 10.0},
1156                                 }
1157                             ]
1158                         }
1159                     ),
1160                     "boto_apigateway.update_usage_plan": MagicMock(
1161                         return_value={"error": "error"}
1162                     ),
1163                 },
1164             ):
1165                 result = boto_apigateway.usage_plan_present(
1166                     "name", "plan_name", **conn_parameters
1167                 )
1168                 self.assertIn("result", result)
1169                 self.assertEqual(result["result"], False)
1170                 self.assertIn("comment", result)
1171                 self.assertEqual(
1172                     result["comment"], "Failed to update a usage plan plan_name, error"
1173                 )
1174     @pytest.mark.slow_test
1175     def test_usage_plan_present_if_plan_has_been_created(self, *args):
1176         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1177             with patch.dict(
1178                 boto_apigateway.__salt__,
1179                 {
1180                     "boto_apigateway.describe_usage_plans": MagicMock(
1181                         side_effect=[{"plans": []}, {"plans": [{"id": "id"}]}]
1182                     ),
1183                     "boto_apigateway.create_usage_plan": MagicMock(
1184                         return_value={"created": True}
1185                     ),
1186                 },
1187             ):
1188                 result = boto_apigateway.usage_plan_present(
1189                     "name", "plan_name", **conn_parameters
1190                 )
1191                 self.assertIn("result", result)
1192                 self.assertEqual(result["result"], True)
1193                 self.assertIn("comment", result)
1194                 self.assertEqual(
1195                     result["comment"], "A new usage plan plan_name has been created"
1196                 )
1197                 self.assertEqual(result["changes"]["old"], {"plan": None})
1198                 self.assertEqual(result["changes"]["new"], {"plan": {"id": "id"}})
1199     @pytest.mark.slow_test
1200     def test_usage_plan_present_if_plan_has_been_updated(self, *args):
1201         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1202             with patch.dict(
1203                 boto_apigateway.__salt__,
1204                 {
1205                     "boto_apigateway.describe_usage_plans": MagicMock(
1206                         side_effect=[
1207                             {"plans": [{"id": "id"}]},
1208                             {
1209                                 "plans": [
1210                                     {
1211                                         "id": "id",
1212                                         "throttle": {"rateLimit": throttle_rateLimit},
1213                                     }
1214                                 ]
1215                             },
1216                         ]
1217                     ),
1218                     "boto_apigateway.update_usage_plan": MagicMock(
1219                         return_value={"updated": True}
1220                     ),
1221                 },
1222             ):
1223                 result = boto_apigateway.usage_plan_present(
1224                     "name",
1225                     "plan_name",
1226                     throttle={"rateLimit": throttle_rateLimit},
1227                     **conn_parameters
1228                 )
1229                 self.assertIn("result", result)
1230                 self.assertEqual(result["result"], True)
1231                 self.assertIn("comment", result)
1232                 self.assertEqual(
1233                     result["comment"], "usage plan plan_name has been updated"
1234                 )
1235                 self.assertEqual(result["changes"]["old"], {"plan": {"id": "id"}})
1236                 self.assertEqual(
1237                     result["changes"]["new"],
1238                     {
1239                         "plan": {
1240                             "id": "id",
1241                             "throttle": {"rateLimit": throttle_rateLimit},
1242                         }
1243                     },
1244                 )
1245     @pytest.mark.slow_test
1246     def test_usage_plan_present_if_ValueError_is_raised(self, *args):
1247         with patch.dict(
1248             boto_apigateway.__salt__,
1249             {
1250                 "boto_apigateway.describe_usage_plans": MagicMock(
1251                     side_effect=ValueError("error")
1252                 )
1253             },
1254         ):
1255                 "name",
1256                 "plan_name",
1257                 throttle={<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>"rateLimit": throttle_rateLimit},
1258                 **conn_parameters
1259             )
1260             self.assertIn("result", result)
1261             self.assertEqual(result["result"], False)
1262             self.assertIn("comment", result)
1263             self.assertEqual(result["comment"], repr(</b></font>("error",)))
1264     @pytest.mark.slow_test
1265     def test_usage_plan_present_if_IOError_is_raised(self, *args):
1266         with patch.dict(
1267             boto_apigateway.__salt__,
1268             {
1269                 "boto_apigateway.describe_usage_plans": MagicMock(
1270                     side_effect=IOError("error")
1271                 )
1272             },
1273         ):
1274             result = boto_apigateway.usage_plan_present(
1275                 "name",
1276                 "plan_name",
1277                 throttle={"rateLimit": throttle_rateLimit},
1278                 **conn_parameters
1279             )
1280             self.assertIn("result", result)
1281             self.assertEqual(result["result"], False)
1282             self.assertIn("comment", result)
1283             self.assertEqual(result["comment"], repr(("error",)))
1284     @pytest.mark.slow_test
1285     def test_usage_plan_absent_if_describe_fails(self, *args):
1286         with patch.dict(
1287             boto_apigateway.__salt__,
1288             {
1289                 "boto_apigateway.describe_usage_plans": MagicMock(
1290                     return_value={"error": "error"}
1291                 )
1292             },
1293         ):
1294             result = {}
1295             result = boto_apigateway.usage_plan_absent(
1296                 "name", "plan_name", **conn_parameters
1297             )
1298             self.assertIn("result", result)
1299             self.assertEqual(result["result"], False)
1300             self.assertIn("comment", result)
1301             self.assertEqual(
1302                 result["comment"], "Failed to describe existing usage plans"
1303             )
1304             self.assertIn("changes", result)
1305             self.assertEqual(result["changes"], {})
1306     @pytest.mark.slow_test
1307     def test_usage_plan_absent_if_plan_is_not_present(self, *args):
1308         with patch.dict(
1309             boto_apigateway.__salt__,
1310             {
1311                 "boto_apigateway.describe_usage_plans": MagicMock(
1312                     return_value={"plans": []}
1313                 )
1314             },
1315         ):
1316             result = {}
1317             result = boto_apigateway.usage_plan_absent(
1318                 "name", "plan_name", **conn_parameters
1319             )
1320             self.assertIn("result", result)
1321             self.assertEqual(result["result"], True)
1322             self.assertIn("comment", result)
1323             self.assertEqual(
1324                 result["comment"], "Usage plan plan_name does not exist already"
1325             )
1326             self.assertIn("changes", result)
1327             self.assertEqual(result["changes"], {})
1328     @pytest.mark.slow_test
1329     def test_usage_plan_absent_if_plan_is_present_but_test_option_is_set(self, *args):
1330         with patch.dict(boto_apigateway.__opts__, {"test": True}):
1331             with patch.dict(
1332                 boto_apigateway.__salt__,
1333                 {
1334                     "boto_apigateway.describe_usage_plans": MagicMock(
1335                         return_value={"plans": [{"id": "id"}]}
1336                     )
1337                 },
1338             ):
1339                 result = {}
1340                 result = boto_apigateway.usage_plan_absent(
1341                     "name", "plan_name", **conn_parameters
1342                 )
1343                 self.assertIn("result", result)
1344                 self.assertEqual(result["result"], None)
1345                 self.assertIn("comment", result)
1346                 self.assertEqual(
1347                     result["comment"],
1348                     "Usage plan plan_name exists and would be deleted",
1349                 )
1350                 self.assertIn("changes", result)
1351                 self.assertEqual(result["changes"], {})
1352     @pytest.mark.slow_test
1353     def test_usage_plan_absent_if_plan_is_present_but_delete_fails(self, *args):
1354         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1355             with patch.dict(
1356                 boto_apigateway.__salt__,
1357                 {
1358                     "boto_apigateway.describe_usage_plans": MagicMock(
1359                         return_value={"plans": [{"id": "id"}]}
1360                     ),
1361                     "boto_apigateway.delete_usage_plan": MagicMock(
1362                         return_value={"error": "error"}
1363                     ),
1364                 },
1365             ):
1366                 result = boto_apigateway.usage_plan_absent(
1367                     "name", "plan_name", **conn_parameters
1368                 )
1369                 self.assertIn("result", result)
1370                 self.assertEqual(result["result"], False)
1371                 self.assertIn("comment", result)
1372                 self.assertEqual(
1373                     result["comment"],
1374                     "Failed to delete usage plan plan_name, "
1375                     + repr({"error": "error"}),
1376                 )
1377                 self.assertIn("changes", result)
1378                 self.assertEqual(result["changes"], {})
1379     @pytest.mark.slow_test
1380     def test_usage_plan_absent_if_plan_has_been_deleted(self, *args):
1381         with patch.dict(boto_apigateway.__opts__, {"test": False}):
1382             with patch.dict(
1383                 boto_apigateway.__salt__,
1384                 {
1385                     "boto_apigateway.describe_usage_plans": MagicMock(
1386                         return_value={"plans": [{"id": "id"}]}
1387                     ),
1388                     "boto_apigateway.delete_usage_plan": MagicMock(
1389                         return_value={"deleted": True}
1390                     ),
1391                 },
1392             ):
1393                 result = boto_apigateway.usage_plan_absent(
1394                     "name", "plan_name", **conn_parameters
1395                 )
1396                 self.assertIn("result", result)
1397                 self.assertEqual(result["result"], True)
1398                 self.assertIn("comment", result)
1399                 self.assertEqual(
1400                     result["comment"], "Usage plan plan_name has been deleted"
1401                 )
1402                 self.assertIn("changes", result)
1403                 self.assertEqual(
1404                     result["changes"],
1405                     {"new": {"plan": None}, "old": {"plan": {"id": "id"}}},
1406                 )
1407     @pytest.mark.slow_test
1408     def test_usage_plan_absent_if_ValueError_is_raised(self, *args):
1409         with patch.dict(
1410             boto_apigateway.__salt__,
1411             {
1412                 "boto_apigateway.describe_usage_plans": MagicMock(
1413                     side_effect=ValueError("error")
1414                 )
1415             },
1416         ):
1417             result = boto_apigateway.usage_plan_absent(
1418                 "name", "plan_name", **conn_parameters
1419             )
1420             self.assertIn("result", result)
1421             self.assertEqual(result["result"], False)
1422             self.assertIn("comment", result)
1423             self.assertEqual(result["comment"], repr(("error",)))
1424     @pytest.mark.slow_test
1425     def test_usage_plan_absent_if_IOError_is_raised(self, *args):
1426         with patch.dict(
1427             boto_apigateway.__salt__,
1428             {
1429                 "boto_apigateway.describe_usage_plans": MagicMock(
1430                     side_effect=IOError("error")
1431                 )
1432             },
1433         ):
1434             result = boto_apigateway.usage_plan_absent(
1435                 "name", "plan_name", **conn_parameters
1436             )
1437             self.assertIn("result", result)
1438             self.assertEqual(result["result"], False)
1439             self.assertIn("comment", result)
1440             self.assertEqual(result["comment"], repr(("error",)))
1441 @skipIf(HAS_BOTO is False, "The boto module must be installed.")
1442 @skipIf(
1443     _has_required_boto() is False,
1444     "The boto3 module must be greater than or equal to version {}".format(
1445         required_boto3_version
1446     ),
1447 )
1448 @skipIf(
1449     _has_required_botocore() is False,
1450     "The botocore module must be greater than or equal to version {}".format(
1451         required_botocore_version
1452     ),
1453 )
1454 class BotoApiGatewayUsagePlanAssociationTestCase(
1455     BotoApiGatewayStateTestCaseBase, BotoApiGatewayTestCaseMixin
1456 ):
1457     @pytest.mark.slow_test
1458     def test_usage_plan_association_present_if_describe_fails(self, *args):
1459         with patch.dict(
1460             boto_apigateway.__salt__,
1461             {
1462                 "boto_apigateway.describe_usage_plans": MagicMock(
1463                     return_value={"error": "error"}
1464                 )
1465             },
1466         ):
1467             result = boto_apigateway.usage_plan_association_present(
1468                 "name", "plan_name", [association_stage_1], **conn_parameters
1469             )
1470             self.assertIn("result", result)
1471             self.assertEqual(result["result"], False)
1472             self.assertIn("comment", result)
1473             self.assertEqual(
1474                 result["comment"], "Failed to describe existing usage plans"
1475             )
1476             self.assertIn("changes", result)
1477             self.assertEqual(result["changes"], {})
1478     @pytest.mark.slow_test
1479     def test_usage_plan_association_present_if_plan_is_not_present(self, *args):
1480         with patch.dict(
1481             boto_apigateway.__salt__,
1482             {
1483                 "boto_apigateway.describe_usage_plans": MagicMock(
1484                     return_value={"plans": []}
1485                 )
1486             },
1487         ):
1488             result = boto_apigateway.usage_plan_association_present(
1489                 "name", "plan_name", [association_stage_1], **conn_parameters
1490             )
1491             self.assertIn("result", result)
1492             self.assertEqual(result["result"], False)
1493             self.assertIn("comment", result)
1494             self.assertEqual(result["comment"], "Usage plan plan_name does not exist")
1495             self.assertIn("changes", result)
1496             self.assertEqual(result["changes"], {})
1497     @pytest.mark.slow_test
1498     def test_usage_plan_association_present_if_multiple_plans_with_the_same_name_exist(
1499         self, *args
1500     ):
1501         with patch.dict(
1502             boto_apigateway.__salt__,
1503             {
1504                 "boto_apigateway.describe_usage_plans": MagicMock(
1505                     return_value={"plans": [{"id": "id1"}, {"id": "id2"}]}
1506                 )
1507             },
1508         ):
1509             result = boto_apigateway.usage_plan_association_present(
1510                 "name", "plan_name", [association_stage_1], **conn_parameters
1511             )
1512             self.assertIn("result", result)
1513             self.assertEqual(result["result"], False)
1514             self.assertIn("comment", result)
1515             self.assertEqual(
1516                 result["comment"],
1517                 "There are multiple usage plans with the same name - it is not"
1518                 " supported",
1519             )
1520             self.assertIn("changes", result)
1521             self.assertEqual(result["changes"], {})
1522     @pytest.mark.slow_test
1523     def test_usage_plan_association_present_if_association_already_exists(self, *args):
1524         with patch.dict(
1525             boto_apigateway.__salt__,
1526             {
1527                 "boto_apigateway.describe_usage_plans": MagicMock(
1528                     return_value={
1529                         "plans": [{"id": "id1", "apiStages": [association_stage_1]}]
1530                     }
1531                 )
1532             },
1533         ):
1534             result = boto_apigateway.usage_plan_association_present(
1535                 "name", "plan_name", [association_stage_1], **conn_parameters
1536             )
1537             self.assertIn("result", result)
1538             self.assertEqual(result["result"], True)
1539             self.assertIn("comment", result)
1540             self.assertEqual(
1541                 result["comment"], "Usage plan is already asssociated to all api stages"
1542             )
1543             self.assertIn("changes", result)
1544             self.assertEqual(result["changes"], {})
1545     @pytest.mark.slow_test
1546     def test_usage_plan_association_present_if_update_fails(self, *args):
1547         with patch.dict(
1548             {
1549                 "boto_apigateway.describe_usage_plans": MagicMock(
1550                     return_value<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>={
1551                         "plans": [{"id": "id1", "apiStages": [association_stage_1]}]
1552                     }
1553                 ),
1554                 "boto_apigateway.attach_usage_plan_to_apis": MagicMock(
1555                     return_value={"error": "error"}
1556                 ),
1557             },
1558         ):
1559             result = boto_apigateway.usage_plan_association_present(
1560                 "name", "plan_name", [association_stage_2], **conn_parameters
1561             )
1562             self.assertIn(</b></font>"result", result)
1563             self.assertEqual(result["result"], False)
1564             self.assertIn("comment", result)
1565             self.assertTrue(
1566                 result["comment"].startswith("Failed to associate a usage plan")
1567             )
1568             self.assertIn("changes", result)
1569             self.assertEqual(result["changes"], {})
1570     @pytest.mark.slow_test
1571     def test_usage_plan_association_present_success(self, *args):
1572         with patch.dict(
1573             boto_apigateway.__salt__,
1574             {
1575                 "boto_apigateway.describe_usage_plans": MagicMock(
1576                     return_value={
1577                         "plans": [{"id": "id1", "apiStages": [association_stage_1]}]
1578                     }
1579                 ),
1580                 "boto_apigateway.attach_usage_plan_to_apis": MagicMock(
1581                     return_value={
1582                         "result": {
1583                             "apiStages": [association_stage_1, association_stage_2]
1584                         }
1585                     }
1586                 ),
1587             },
1588         ):
1589             result = boto_apigateway.usage_plan_association_present(
1590                 "name", "plan_name", [association_stage_2], **conn_parameters
1591             )
1592             self.assertIn("result", result)
1593             self.assertEqual(result["result"], True)
1594             self.assertIn("comment", result)
1595             self.assertEqual(
1596                 result["comment"], "successfully associated usage plan to apis"
1597             )
1598             self.assertIn("changes", result)
1599             self.assertEqual(
1600                 result["changes"],
1601                 {
1602                     "new": [association_stage_1, association_stage_2],
1603                     "old": [association_stage_1],
1604                 },
1605             )
1606     @pytest.mark.slow_test
1607     def test_usage_plan_association_present_if_value_error_is_thrown(self, *args):
1608         with patch.dict(
1609             boto_apigateway.__salt__,
1610             {
1611                 "boto_apigateway.describe_usage_plans": MagicMock(
1612                     side_effect=ValueError("error")
1613                 )
1614             },
1615         ):
1616             result = boto_apigateway.usage_plan_association_present(
1617                 "name", "plan_name", [], **conn_parameters
1618             )
1619             self.assertIn("result", result)
1620             self.assertEqual(result["result"], False)
1621             self.assertIn("comment", result)
1622             self.assertEqual(result["comment"], repr(("error",)))
1623             self.assertIn("changes", result)
1624             self.assertEqual(result["changes"], {})
1625     @pytest.mark.slow_test
1626     def test_usage_plan_association_present_if_io_error_is_thrown(self, *args):
1627         with patch.dict(
1628             boto_apigateway.__salt__,
1629             {
1630                 "boto_apigateway.describe_usage_plans": MagicMock(
1631                     side_effect=IOError("error")
1632                 )
1633             },
1634         ):
1635             result = boto_apigateway.usage_plan_association_present(
1636                 "name", "plan_name", [], **conn_parameters
1637             )
1638             self.assertIn("result", result)
1639             self.assertEqual(result["result"], False)
1640             self.assertIn("comment", result)
1641             self.assertEqual(result["comment"], repr(("error",)))
1642             self.assertIn("changes", result)
1643             self.assertEqual(result["changes"], {})
1644     @pytest.mark.slow_test
1645     def test_usage_plan_association_absent_if_describe_fails(self, *args):
1646         with patch.dict(
1647             boto_apigateway.__salt__,
1648             {
1649                 "boto_apigateway.describe_usage_plans": MagicMock(
1650                     return_value={"error": "error"}
1651                 )
1652             },
1653         ):
1654             result = boto_apigateway.usage_plan_association_absent(
1655                 "name", "plan_name", [association_stage_1], **conn_parameters
1656             )
1657             self.assertIn("result", result)
1658             self.assertEqual(result["result"], False)
1659             self.assertIn("comment", result)
1660             self.assertEqual(
1661                 result["comment"], "Failed to describe existing usage plans"
1662             )
1663             self.assertIn("changes", result)
1664             self.assertEqual(result["changes"], {})
1665     @pytest.mark.slow_test
1666     def test_usage_plan_association_absent_if_plan_is_not_present(self, *args):
1667         with patch.dict(
1668             boto_apigateway.__salt__,
1669             {
1670                 "boto_apigateway.describe_usage_plans": MagicMock(
1671                     return_value={"plans": []}
1672                 )
1673             },
1674         ):
1675             result = boto_apigateway.usage_plan_association_absent(
1676                 "name", "plan_name", [association_stage_1], **conn_parameters
1677             )
1678             self.assertIn("result", result)
1679             self.assertEqual(result["result"], False)
1680             self.assertIn("comment", result)
1681             self.assertEqual(result["comment"], "Usage plan plan_name does not exist")
1682             self.assertIn("changes", result)
1683             self.assertEqual(result["changes"], {})
1684     @pytest.mark.slow_test
1685     def test_usage_plan_association_absent_if_multiple_plans_with_the_same_name_exist(
1686         self, *args
1687     ):
1688         with patch.dict(
1689             boto_apigateway.__salt__,
1690             {
1691                 "boto_apigateway.describe_usage_plans": MagicMock(
1692                     return_value={"plans": [{"id": "id1"}, {"id": "id2"}]}
1693                 )
1694             },
1695         ):
1696             result = boto_apigateway.usage_plan_association_absent(
1697                 "name", "plan_name", [association_stage_1], **conn_parameters
1698             )
1699             self.assertIn("result", result)
1700             self.assertEqual(result["result"], False)
1701             self.assertIn("comment", result)
1702             self.assertEqual(
1703                 result["comment"],
1704                 "There are multiple usage plans with the same name - it is not"
1705                 " supported",
1706             )
1707             self.assertIn("changes", result)
1708             self.assertEqual(result["changes"], {})
1709     @pytest.mark.slow_test
1710     def test_usage_plan_association_absent_if_plan_has_no_associations(self, *args):
1711         with patch.dict(
1712             boto_apigateway.__salt__,
1713             {
1714                 "boto_apigateway.describe_usage_plans": MagicMock(
1715                     return_value={"plans": [{"id": "id1", "apiStages": []}]}
1716                 )
1717             },
1718         ):
1719             result = boto_apigateway.usage_plan_association_absent(
1720                 "name", "plan_name", [association_stage_1], **conn_parameters
1721             )
1722             self.assertIn("result", result)
1723             self.assertEqual(result["result"], True)
1724             self.assertIn("comment", result)
1725             self.assertEqual(
1726                 result["comment"],
1727                 "Usage plan plan_name has no associated stages already",
1728             )
1729             self.assertIn("changes", result)
1730             self.assertEqual(result["changes"], {})
1731     @pytest.mark.slow_test
1732     def test_usage_plan_association_absent_if_plan_has_no_specific_association(
1733         self, *args
1734     ):
1735         with patch.dict(
1736             boto_apigateway.__salt__,
1737             {
1738                 "boto_apigateway.describe_usage_plans": MagicMock(
1739                     return_value={
1740                         "plans": [{"id": "id1", "apiStages": [association_stage_1]}]
1741                     }
1742                 )
1743             },
1744         ):
1745             result = boto_apigateway.usage_plan_association_absent(
1746                 "name", "plan_name", [association_stage_2], **conn_parameters
1747             )
1748             self.assertIn("result", result)
1749             self.assertEqual(result["result"], True)
1750             self.assertIn("comment", result)
1751             self.assertEqual(
1752                 result["comment"],
1753                 "Usage plan is already not asssociated to any api stages",
1754             )
1755             self.assertIn("changes", result)
1756             self.assertEqual(result["changes"], {})
1757     @pytest.mark.slow_test
1758     def test_usage_plan_association_absent_if_detaching_association_fails(self, *args):
1759         with patch.dict(
1760             boto_apigateway.__salt__,
1761             {
1762                 "boto_apigateway.describe_usage_plans": MagicMock(
1763                     return_value={
1764                         "plans": [
1765                             {
1766                                 "id": "id1",
1767                                 "apiStages": [association_stage_1, association_stage_2],
1768                             }
1769                         ]
1770                     }
1771                 ),
1772                 "boto_apigateway.detach_usage_plan_from_apis": MagicMock(
1773                     return_value={"error": "error"}
1774                 ),
1775             },
1776         ):
1777             result = boto_apigateway.usage_plan_association_absent(
1778                 "name", "plan_name", [association_stage_2], **conn_parameters
1779             )
1780             self.assertIn("result", result)
1781             self.assertEqual(result["result"], False)
1782             self.assertIn("comment", result)
1783             self.assertTrue(
1784                 result["comment"].startswith(
1785                     "Failed to disassociate a usage plan plan_name from the apis"
1786                 )
1787             )
1788             self.assertIn("changes", result)
1789             self.assertEqual(result["changes"], {})
1790     @pytest.mark.slow_test
1791     def test_usage_plan_association_absent_success(self, *args):
1792         with patch.dict(
1793             boto_apigateway.__salt__,
1794             {
1795                 "boto_apigateway.describe_usage_plans": MagicMock(
1796                     return_value={
1797                         "plans": [
1798                             {
1799                                 "id": "id1",
1800                                 "apiStages": [association_stage_1, association_stage_2],
1801                             }
1802                         ]
1803                     }
1804                 ),
1805                 "boto_apigateway.detach_usage_plan_from_apis": MagicMock(
1806                     return_value={"result": {"apiStages": [association_stage_1]}}
1807                 ),
1808             },
1809         ):
1810             result = boto_apigateway.usage_plan_association_absent(
1811                 "name", "plan_name", [association_stage_2], **conn_parameters
1812             )
1813             self.assertIn("result", result)
1814             self.assertEqual(result["result"], True)
1815             self.assertIn("comment", result)
1816             self.assertEqual(
1817                 result["comment"], "successfully disassociated usage plan from apis"
1818             )
1819             self.assertIn("changes", result)
1820             self.assertEqual(
1821                 result["changes"],
1822                 {
1823                     "new": [association_stage_1],
1824                     "old": [association_stage_1, association_stage_2],
1825                 },
1826             )
1827     @pytest.mark.slow_test
1828     def test_usage_plan_association_absent_if_ValueError_is_raised(self, *args):
1829         with patch.dict(
1830             boto_apigateway.__salt__,
1831             {
1832                 "boto_apigateway.describe_usage_plans": MagicMock(
1833                     side_effect=ValueError("error")
1834                 )
1835             },
1836         ):
1837             result = boto_apigateway.usage_plan_association_absent(
1838                 "name", "plan_name", [association_stage_1], **conn_parameters
1839             )
1840             self.assertIn("result", result)
1841             self.assertEqual(result["result"], False)
1842             self.assertIn("comment", result)
1843             self.assertEqual(result["comment"], repr(("error",)))
1844             self.assertIn("changes", result)
1845             self.assertEqual(result["changes"], {})
1846     @pytest.mark.slow_test
1847     def test_usage_plan_association_absent_if_IOError_is_raised(self, *args):
1848         with patch.dict(
1849             boto_apigateway.__salt__,
1850             {
1851                 "boto_apigateway.describe_usage_plans": MagicMock(
1852                     side_effect=IOError("error")
1853                 )
1854             },
1855         ):
1856             result = boto_apigateway.usage_plan_association_absent(
1857                 "name", "plan_name", [association_stage_1], **conn_parameters
1858             )
1859             self.assertIn("result", result)
1860             self.assertEqual(result["result"], False)
1861             self.assertIn("comment", result)
1862             self.assertEqual(result["comment"], repr(("error",)))
1863             self.assertIn("changes", result)
1864             self.assertEqual(result["changes"], {})
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
