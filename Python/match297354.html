<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for archive_1.py &amp; test_vsphere.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for archive_1.py &amp; test_vsphere.py
      </h3>
<h1 align="center">
        0.4%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>archive_1.py (1.0433387%)<th>test_vsphere.py (0.28901735%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(22-35)<td><a href="#" name="0">(8-26)</a><td align="center"><font color="#ff0000">13</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>archive_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import contextlib
2 import copy
3 import errno
4 import glob
5 import logging
6 import os
7 import re
8 import shlex
9 import stat
10 import subprocess
11 import tarfile
12 import urllib.parse
13 import salt.utils.decorators
14 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import salt.utils.decorators.path
15 import salt.utils.files
16 import salt.utils.path
17 import salt.utils.platform
18 import salt.utils.stringutils
19 import salt.utils.templates
20 from salt.exceptions import CommandExecutionError, SaltInvocationError
21 try:
22     import rarfile
23     HAS_RARFILE = True
24 except ImportError:
25     HAS_RARFILE =</b></font> False
26 if salt.utils.platform.is_windows():
27     import win32file
28 __func_alias__ = {"zip_": "zip", "list_": "list"}
29 log = logging.getLogger(__name__)
30 def list_(
31     name,
32     archive_format=None,
33     options=None,
34     strip_components=None,
35     clean=False,
36     verbose=False,
37     saltenv="base",
38     source_hash=None,
39     use_etag=False,
40 ):
41     def _list_tar(name, cached, decompress_cmd, failhard=False):
42         dirs = []
43         files = []
44         links = []
45         try:
46             open_kwargs = (
47                 {"name": cached}
48                 if not isinstance(cached, subprocess.Popen)
49                 else {"fileobj": cached.stdout, "mode": "r|"}
50             )
51             with contextlib.closing(tarfile.open(**open_kwargs)) as tar_archive:
52                 for member in tar_archive.getmembers():
53                     _member = salt.utils.data.decode(member.name)
54                     if member.issym():
55                         links.append(_member)
56                     elif member.isdir():
57                         dirs.append(_member + "/")
58                     else:
59                         files.append(_member)
60             return dirs, files, links
61         except tarfile.ReadError:
62             if failhard:
63                 if isinstance(cached, subprocess.Popen):
64                     stderr = cached.communicate()[1]
65                     if cached.returncode != 0:
66                         raise CommandExecutionError(
67                             "Failed to decompress {}".format(name),
68                             info={"error": stderr},
69                         )
70             else:
71                 if not salt.utils.path.which("tar"):
72                     raise CommandExecutionError("'tar' command not available")
73                 if decompress_cmd is not None and isinstance(decompress_cmd, str):
74                     try:
75                         decompress_cmd = [
76                             shlex.quote(x) for x in shlex.split(decompress_cmd)
77                         ]
78                     except AttributeError:
79                         raise CommandExecutionError("Invalid CLI options")
80                 else:
81                     if (
82                         salt.utils.path.which("xz")
83                         and __salt__["cmd.retcode"](
84                             ["xz", "-t", cached],
85                             python_shell=False,
86                             ignore_retcode=True,
87                         )
88                         == 0
89                     ):
90                         decompress_cmd = ["xz", "--decompress", "--stdout"]
91                 if decompress_cmd:
92                     decompressed = subprocess.Popen(
93                         decompress_cmd + [shlex.quote(cached)],
94                         stdout=subprocess.PIPE,
95                         stderr=subprocess.PIPE,
96                     )
97                     return _list_tar(name, decompressed, None, True)
98         raise CommandExecutionError(
99             "Unable to list contents of {}. If this is an XZ-compressed tar "
100             "archive, install XZ Utils to enable listing its contents. If it "
101             "is compressed using something other than XZ, it may be necessary "
102             "to specify CLI options to decompress the archive. See the "
103             "documentation for details.".format(name)
104         )
105     def _list_zip(name, cached):
106         dirs = set()
107         files = []
108         links = []
109         try:
110             with contextlib.closing(zipfile.ZipFile(cached)) as zip_archive:
111                 for member in zip_archive.infolist():
112                     path = member.filename
113                     if salt.utils.platform.is_windows():
114                         if path.endswith("/"):
115                             dirs.add(path)
116                         else:
117                             files.append(path)
118                     else:
119                         mode = member.external_attr &gt;&gt; 16
120                         if stat.S_ISLNK(mode):
121                             links.append(path)
122                         elif stat.S_ISDIR(mode):
123                             dirs.add(path)
124                         else:
125                             files.append(path)
126                 _files = copy.deepcopy(files)
127                 for path in _files:
128                     dirname = "".join(path.rpartition("/")[:2])
129                     if dirname:
130                         dirs.add(dirname)
131                         if dirname in files:
132                             files.remove(dirname)
133             return list(dirs), files, links
134         except zipfile.BadZipfile:
135             raise CommandExecutionError("{} is not a ZIP file".format(name))
136     def _list_rar(name, cached):
137         dirs = []
138         files = []
139         if HAS_RARFILE:
140             with rarfile.RarFile(cached) as rf:
141                 for member in rf.infolist():
142                     path = member.filename.replace("\\", "/")
143                     if member.isdir():
144                         dirs.append(path + "/")
145                     else:
146                         files.append(path)
147         else:
148             if not salt.utils.path.which("rar"):
149                 raise CommandExecutionError(
150                     "rar command not available, is it installed?"
151                 )
152             output = __salt__["cmd.run"](
153                 ["rar", "lt", name], python_shell=False, ignore_retcode=False
154             )
155             matches = re.findall(r"Name:\s*([^\n]+)\s*Type:\s*([^\n]+)", output)
156             for path, type_ in matches:
157                 if type_ == "Directory":
158                     dirs.append(path + "/")
159                 else:
160                     files.append(path)
161             if not dirs and not files:
162                 raise CommandExecutionError(
163                     "Failed to list {}, is it a rar file? If so, the "
164                     "installed version of rar may be too old to list data in "
165                     "a parsable format. Installing the rarfile Python module "
166                     "may be an easier workaround if newer rar is not readily "
167                     "available.".format(name),
168                     info={"error": output},
169                 )
170         return dirs, files, []
171     cached = __salt__["cp.cache_file"](
172         name, saltenv, source_hash=source_hash, use_etag=use_etag
173     )
174     if not cached:
175         raise CommandExecutionError("Failed to cache {}".format(name))
176     try:
177         if strip_components:
178             try:
179                 int(strip_components)
180             except ValueError:
181                 strip_components = -1
182             if strip_components &lt;= 0:
183                 raise CommandExecutionError(
184                     "'strip_components' must be a positive integer"
185                 )
186         parsed = urllib.parse.urlparse(name)
187         path = parsed.path or parsed.netloc
188         def _unsupported_format(archive_format):
189             if archive_format is None:
190                 raise CommandExecutionError(
191                     "Unable to guess archive format, please pass an "
192                     "'archive_format' argument."
193                 )
194             raise CommandExecutionError(
195                 "Unsupported archive format '{}'".format(archive_format)
196             )
197         if not archive_format:
198             guessed_format = salt.utils.files.guess_archive_type(path)
199             if guessed_format is None:
200                 _unsupported_format(archive_format)
201             archive_format = guessed_format
202         func = locals().get("_list_" + archive_format)
203         if not hasattr(func, "__call__"):
204             _unsupported_format(archive_format)
205         args = (options,) if archive_format == "tar" else ()
206         try:
207             dirs, files, links = func(name, cached, *args)
208         except OSError as exc:
209             raise CommandExecutionError(
210                 "Failed to list contents of {}: {}".format(name, exc.__str__())
211             )
212         except CommandExecutionError as exc:
213             raise
214         except Exception as exc:  # pylint: disable=broad-except
215             raise CommandExecutionError(
216                 "Uncaught exception '{}' when listing contents of {}".format(exc, name)
217             )
218         if clean:
219             try:
220                 os.remove(cached)
221                 log.debug("Cleaned cached archive %s", cached)
222             except OSError as exc:
223                 if exc.errno != errno.ENOENT:
224                     log.warning(
225                         "Failed to clean cached archive %s: %s", cached, exc.__str__()
226                     )
227         if strip_components:
228             for item in (dirs, files, links):
229                 for index, path in enumerate(item):
230                     try:
231                         item[index] = item[index].split(os.sep, strip_components)[
232                             strip_components
233                         ]
234                     except IndexError:
235                         item[index] = ""
236                 item[:] = (x for x in item if x)
237                 item.sort()
238         if verbose:
239             ret = {
240                 "dirs": sorted(salt.utils.data.decode_list(dirs)),
241                 "files": sorted(salt.utils.data.decode_list(files)),
242                 "links": sorted(salt.utils.data.decode_list(links)),
243             }
244             ret["top_level_dirs"] = [x for x in ret["dirs"] if x.count("/") == 1]
245             ret["top_level_files"] = [x for x in ret["files"] if x.count("/") == 0]
246             ret["top_level_links"] = [x for x in ret["links"] if x.count("/") == 0]
247         else:
248             ret = sorted(dirs + files + links)
249         return ret
250     except CommandExecutionError as exc:
251         info = exc.info or {}
252         info["archive location"] = cached
253         raise CommandExecutionError(exc.error, info=info)
254 _glob_wildcards = re.compile("[*?[]")
255 def _glob(pathname):
256     if _glob_wildcards.search(pathname) is None:
257         return [pathname]
258     else:
259         return glob.glob(pathname)
260 def _expand_sources(sources):
261     if sources is None:
262         return []
263     if isinstance(sources, str):
264         sources = [x.strip() for x in sources.split(",")]
265     elif isinstance(sources, (float, int)):
266         sources = [str(sources)]
267     return [path for source in sources for path in _glob(source)]
268 @salt.utils.decorators.path.which("tar")
269 def tar(options, tarfile, sources=None, dest=None, cwd=None, template=None, runas=None):
270     if not options:
271         raise SaltInvocationError("Tar options can not be empty")
272     cmd = ["tar"]
273     if options:
274         cmd.extend(options.split())
275     cmd.extend(["{}".format(tarfile)])
276     cmd.extend(_expand_sources(sources))
277     if dest:
278         cmd.extend(["-C", "{}".format(dest)])
279     return __salt__["cmd.run"](
280         cmd, cwd=cwd, template=template, runas=runas, python_shell=False
281     ).splitlines()
282 @salt.utils.decorators.path.which("gzip")
283 def gzip(sourcefile, template=None, runas=None, options=None):
284     cmd = ["gzip"]
285     if options:
286         cmd.append(options)
287     cmd.append("{}".format(sourcefile))
288     return __salt__["cmd.run"](
289         cmd, template=template, runas=runas, python_shell=False
290     ).splitlines()
291 @salt.utils.decorators.path.which("gunzip")
292 def gunzip(gzipfile, template=None, runas=None, options=None):
293     cmd = ["gunzip"]
294     if options:
295         cmd.append(options)
296     cmd.append("{}".format(gzipfile))
297     return __salt__["cmd.run"](
298         cmd, template=template, runas=runas, python_shell=False
299     ).splitlines()
300 @salt.utils.decorators.path.which("zip")
301 def cmd_zip(zip_file, sources, template=None, cwd=None, runas=None):
302     cmd = ["zip", "-r"]
303     cmd.append("{}".format(zip_file))
304     cmd.extend(_expand_sources(sources))
305     return __salt__["cmd.run"](
306         cmd, cwd=cwd, template=template, runas=runas, python_shell=False
307     ).splitlines()
308 @salt.utils.decorators.depends("zipfile", fallback_function=cmd_zip)
309 def zip_(zip_file, sources, template=None, cwd=None, runas=None, zip64=False):
310     if runas:
311         euid = os.geteuid()
312         egid = os.getegid()
313         uinfo = __salt__["user.info"](runas)
314         if not uinfo:
315             raise SaltInvocationError("User '{}' does not exist".format(runas))
316     zip_file, sources = _render_filenames(zip_file, sources, None, template)
317     sources = _expand_sources(sources)
318     if not cwd:
319         for src in sources:
320             if not os.path.isabs(src):
321                 raise SaltInvocationError("Relative paths require the 'cwd' parameter")
322     else:
323         err_msg = "cwd must be absolute"
324         try:
325             if not os.path.isabs(cwd):
326                 raise SaltInvocationError(err_msg)
327         except AttributeError:
328             raise SaltInvocationError(err_msg)
329     if runas and (euid != uinfo["uid"] or egid != uinfo["gid"]):
330         os.setegid(uinfo["gid"])
331         os.seteuid(uinfo["uid"])
332     try:
333         exc = None
334         archived_files = []
335         with contextlib.closing(
336             zipfile.ZipFile(zip_file, "w", zipfile.ZIP_DEFLATED, zip64)
337         ) as zfile:
338             for src in sources:
339                 if cwd:
340                     src = os.path.join(cwd, src)
341                 if os.path.exists(src):
342                     if os.path.isabs(src):
343                         rel_root = "/"
344                     else:
345                         rel_root = cwd if cwd is not None else "/"
346                     if os.path.isdir(src):
347                         for dir_name, sub_dirs, files in salt.utils.path.os_walk(src):
348                             if cwd and dir_name.startswith(cwd):
349                                 arc_dir = os.path.relpath(dir_name, cwd)
350                             else:
351                                 arc_dir = os.path.relpath(dir_name, rel_root)
352                             if arc_dir:
353                                 archived_files.append(arc_dir + "/")
354                                 zfile.write(dir_name, arc_dir)
355                             for filename in files:
356                                 abs_name = os.path.join(dir_name, filename)
357                                 arc_name = os.path.join(arc_dir, filename)
358                                 archived_files.append(arc_name)
359                                 zfile.write(abs_name, arc_name)
360                     else:
361                         if cwd and src.startswith(cwd):
362                             arc_name = os.path.relpath(src, cwd)
363                         else:
364                             arc_name = os.path.relpath(src, rel_root)
365                         archived_files.append(arc_name)
366                         zfile.write(src, arc_name)
367     except Exception as exc:  # pylint: disable=broad-except
368         pass
369     finally:
370         if runas:
371             os.seteuid(euid)
372             os.setegid(egid)
373         if exc is not None:
374             if exc == zipfile.LargeZipFile:
375                 raise CommandExecutionError(
376                     "Resulting zip file too large, would require ZIP64 support"
377                     "which has not been enabled. Rerun command with zip64=True"
378                 )
379             else:
380                 raise CommandExecutionError(
381                     "Exception encountered creating zipfile: {}".format(exc)
382                 )
383     return archived_files
384 @salt.utils.decorators.path.which("unzip")
385 def cmd_unzip(
386     zip_file,
387     dest,
388     excludes=None,
389     options=None,
390     template=None,
391     runas=None,
392     trim_output=False,
393     password=None,
394 ):
395     if isinstance(excludes, str):
396         excludes = [x.strip() for x in excludes.split(",")]
397     elif isinstance(excludes, (float, int)):
398         excludes = [str(excludes)]
399     cmd = ["unzip"]
400     if password:
401         cmd.extend(["-P", password])
402     if options:
403         cmd.extend(shlex.split(options))
404     cmd.extend(["{}".format(zip_file), "-d", "{}".format(dest)])
405     if excludes is not None:
406         cmd.append("-x")
407         cmd.extend(excludes)
408     result = __salt__["cmd.run_all"](
409         cmd,
410         template=template,
411         runas=runas,
412         python_shell=False,
413         redirect_stderr=True,
414         output_loglevel="quiet" if password else "debug",
415     )
416     if result["retcode"] != 0:
417         raise CommandExecutionError(result["stdout"])
418     return _trim_files(result["stdout"].splitlines(), trim_output)
419 def unzip(
420     zip_file,
421     dest,
422     excludes=None,
423     options=None,
424     template=None,
425     runas=None,
426     trim_output=False,
427     password=None,
428     extract_perms=True,
429 ):
430     if not excludes:
431         excludes = []
432     if runas:
433         euid = os.geteuid()
434         egid = os.getegid()
435         uinfo = __salt__["user.info"](runas)
436         if not uinfo:
437             raise SaltInvocationError("User '{}' does not exist".format(runas))
438     zip_file, dest = _render_filenames(zip_file, dest, None, template)
439     if runas and (euid != uinfo["uid"] or egid != uinfo["gid"]):
440         os.setegid(uinfo["gid"])
441         os.seteuid(uinfo["uid"])
442     try:
443         cleaned_files = []
444         with contextlib.closing(zipfile.ZipFile(zip_file, "r")) as zfile:
445             files = zfile.namelist()
446             if isinstance(excludes, str):
447                 excludes = [x.strip() for x in excludes.split(",")]
448             elif isinstance(excludes, (float, int)):
449                 excludes = [str(excludes)]
450             cleaned_files.extend([x for x in files if x not in excludes])
451             for target in cleaned_files:
452                 if target not in excludes:
453                     if salt.utils.platform.is_windows() is False:
454                         info = zfile.getinfo(target)
455                         if stat.S_ISLNK(info.external_attr &gt;&gt; 16):
456                             source = zfile.read(target)
457                             os.symlink(source, os.path.join(dest, target))
458                             continue
459                     zfile.extract(target, dest, password)
460                     if extract_perms:
461                         if not salt.utils.platform.is_windows():
462                             perm = zfile.getinfo(target).external_attr &gt;&gt; 16
463                             if perm == 0:
464                                 umask_ = salt.utils.files.get_umask()
465                                 if target.endswith("/"):
466                                     perm = 0o777 &amp; ~umask_
467                                 else:
468                                     perm = 0o666 &amp; ~umask_
469                             os.chmod(os.path.join(dest, target), perm)
470                         else:
471                             win32_attr = zfile.getinfo(target).external_attr &amp; 0xFF
472                             win32file.SetFileAttributes(
473                                 os.path.join(dest, target), win32_attr
474                             )
475     except Exception as exc:  # pylint: disable=broad-except
476         if runas:
477             os.seteuid(euid)
478             os.setegid(egid)
479         raise CommandExecutionError(
480             "Exception encountered unpacking zipfile: {}".format(exc)
481         )
482     finally:
483         if runas:
484             os.seteuid(euid)
485             os.setegid(egid)
486     return _trim_files(cleaned_files, trim_output)
487 def is_encrypted(name, clean=False, saltenv="base", source_hash=None, use_etag=False):
488     cached = __salt__["cp.cache_file"](
489         name, saltenv, source_hash=source_hash, use_etag=use_etag
490     )
491     if not cached:
492         raise CommandExecutionError("Failed to cache {}".format(name))
493     archive_info = {"archive location": cached}
494     try:
495         with contextlib.closing(zipfile.ZipFile(cached)) as zip_archive:
496             zip_archive.testzip()
497     except RuntimeError:
498         ret = True
499     except zipfile.BadZipfile:
500         raise CommandExecutionError(
501             "{} is not a ZIP file".format(name), info=archive_info
502         )
503     except Exception as exc:  # pylint: disable=broad-except
504         raise CommandExecutionError(exc.__str__(), info=archive_info)
505     else:
506         ret = False
507     if clean:
508         try:
509             os.remove(cached)
510             log.debug("Cleaned cached archive %s", cached)
511         except OSError as exc:
512             if exc.errno != errno.ENOENT:
513                 log.warning(
514                     "Failed to clean cached archive %s: %s", cached, exc.__str__()
515                 )
516     return ret
517 @salt.utils.decorators.path.which("rar")
518 def rar(rarfile, sources, template=None, cwd=None, runas=None):
519     cmd = ["rar", "a", "-idp", "{}".format(rarfile)]
520     cmd.extend(_expand_sources(sources))
521     return __salt__["cmd.run"](
522         cmd, cwd=cwd, template=template, runas=runas, python_shell=False
523     ).splitlines()
524 @salt.utils.decorators.path.which_bin(("unrar", "rar"))
525 def unrar(rarfile, dest, excludes=None, template=None, runas=None, trim_output=False):
526     if isinstance(excludes, str):
527         excludes = [entry.strip() for entry in excludes.split(",")]
528     cmd = [
529         salt.utils.path.which_bin(("unrar", "rar")),
530         "x",
531         "-idp",
532         "{}".format(rarfile),
533     ]
534     if excludes is not None:
535         for exclude in excludes:
536             cmd.extend(["-x", "{}".format(exclude)])
537     cmd.append("{}".format(dest))
538     files = __salt__["cmd.run"](
539         cmd, template=template, runas=runas, python_shell=False
540     ).splitlines()
541     return _trim_files(files, trim_output)
542 def _render_filenames(filenames, zip_file, saltenv, template):
543     if not template:
544         return (filenames, zip_file)
545     if template not in salt.utils.templates.TEMPLATE_REGISTRY:
546         raise CommandExecutionError(
547             "Attempted to render file paths with unavailable engine {}".format(template)
548         )
549     kwargs = {}
550     kwargs["salt"] = __salt__
551     kwargs["pillar"] = __pillar__
552     kwargs["grains"] = __grains__
553     kwargs["opts"] = __opts__
554     kwargs["saltenv"] = saltenv
555     def _render(contents):
556         tmp_path_fn = salt.utils.files.mkstemp()
557         with salt.utils.files.fopen(tmp_path_fn, "w+") as fp_:
558             fp_.write(salt.utils.stringutils.to_str(contents))
559         data = salt.utils.templates.TEMPLATE_REGISTRY[template](
560             tmp_path_fn, to_str=True, **kwargs
561         )
562         salt.utils.files.safe_rm(tmp_path_fn)
563         if not data["result"]:
564             raise CommandExecutionError(
565                 "Failed to render file path with error: {}".format(data["data"])
566             )
567         else:
568             return data["data"]
569     filenames = _render(filenames)
570     zip_file = _render(zip_file)
571     return (filenames, zip_file)
572 def _trim_files(files, trim_output):
573     count = 100
574     if not isinstance(trim_output, bool):
575         count = trim_output
576     if (
577         not (isinstance(trim_output, bool) and trim_output is False)
578         and len(files) &gt; count
579     ):
580         files = files[:count]
581         files.append("List trimmed after {} files.".format(count))
582     return files
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_vsphere.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import salt.modules.vsphere as vsphere
2 import salt.utils.args
3 import salt.utils.vmware
4 from salt.exceptions import (
5     ArgumentValueError,
6     CommandExecutionError,
7     VMwareObjectRetrievalError,
8     VMwareSaltError,
9 )
10 from tests.support.mixins import LoaderModuleMockMixin
11 from tests.support.mock import MagicMock, Mock, call, patch
12 from tests.support.unit import TestCase, skipIf
13 try:
14     from pyVmomi import vim, vmodl  # pylint: disable=unused-import,no-name-in-module
15     HAS_PYVMOMI = True
16 except ImportError:
17     HAS_PYVMOMI =</b></font> False
18 try:
19     from com.vmware.vapi.std_client import DynamicID  # pylint: disable=unused-import
20     HAS_VSPHERE_SDK = True
21 except ImportError:
22     HAS_VSPHERE_SDK = False
23 HOST = "1.2.3.4"
24 USER = "root"
25 PASSWORD = "SuperSecret!"
26 ERROR = "Some Testing Error Message"
27 class VsphereTestCase(TestCase, LoaderModuleMockMixin):
28     def setup_loader_modules(self):
29         return {vsphere: {}}
30     def test_get_coredump_network_config_esxi_hosts_not_list(self):
31         self.assertRaises(
32             CommandExecutionError,
33             vsphere.get_coredump_network_config,
34             HOST,
35             USER,
36             PASSWORD,
37             esxi_hosts="foo",
38         )
39     def test_get_coredump_network_config_host_list_bad_retcode(self):
40         with patch(
41             "salt.utils.vmware.esxcli",
42             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
43         ):
44             host_1 = "host_1.foo.com"
45             self.assertEqual(
46                 {host_1: {"Error": ERROR}},
47                 vsphere.get_coredump_network_config(
48                     HOST, USER, PASSWORD, esxi_hosts=[host_1]
49                 ),
50             )
51     def test_get_coredump_network_config_host_list_success(self):
52         with patch(
53             "salt.utils.vmware.esxcli",
54             MagicMock(return_value={"retcode": 0, "stdout": ""}),
55         ):
56             with patch(
57                 "salt.modules.vsphere._format_coredump_stdout",
58                 MagicMock(return_value={}),
59             ):
60                 host_1 = "host_1.foo.com"
61                 self.assertEqual(
62                     {host_1: {"Coredump Config": {}}},
63                     vsphere.get_coredump_network_config(
64                         HOST, USER, PASSWORD, esxi_hosts=[host_1]
65                     ),
66                 )
67     def test_get_coredump_network_config_bad_retcode(self):
68         with patch(
69             "salt.utils.vmware.esxcli",
70             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
71         ):
72             self.assertEqual(
73                 {HOST: {"Error": ERROR}},
74                 vsphere.get_coredump_network_config(HOST, USER, PASSWORD),
75             )
76     def test_get_coredump_network_config_success(self):
77         with patch(
78             "salt.utils.vmware.esxcli",
79             MagicMock(return_value={"retcode": 0, "stdout": ""}),
80         ):
81             with patch(
82                 "salt.modules.vsphere._format_coredump_stdout",
83                 MagicMock(return_value={}),
84             ):
85                 self.assertEqual(
86                     {HOST: {"Coredump Config": {}}},
87                     vsphere.get_coredump_network_config(HOST, USER, PASSWORD),
88                 )
89     def test_coredump_network_enable_esxi_hosts_not_list(self):
90         self.assertRaises(
91             CommandExecutionError,
92             vsphere.coredump_network_enable,
93             HOST,
94             USER,
95             PASSWORD,
96             True,
97             esxi_hosts="foo",
98         )
99     def test_coredump_network_enable_host_list_bad_retcode(self):
100         with patch(
101             "salt.utils.vmware.esxcli",
102             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
103         ):
104             host_1 = "host_1.foo.com"
105             self.assertEqual(
106                 {host_1: {"Error": ERROR}},
107                 vsphere.coredump_network_enable(
108                     HOST, USER, PASSWORD, True, esxi_hosts=[host_1]
109                 ),
110             )
111     def test_coredump_network_enable_host_list_success(self):
112         with patch(
113             "salt.utils.vmware.esxcli",
114             MagicMock(return_value={"retcode": 0, "stdout": ""}),
115         ):
116             with patch(
117                 "salt.modules.vsphere._format_coredump_stdout",
118                 MagicMock(return_value={}),
119             ):
120                 enabled = True
121                 host_1 = "host_1.foo.com"
122                 self.assertEqual(
123                     {host_1: {"Coredump Enabled": enabled}},
124                     vsphere.coredump_network_enable(
125                         HOST, USER, PASSWORD, enabled, esxi_hosts=[host_1]
126                     ),
127                 )
128     def test_coredump_network_enable_bad_retcode(self):
129         with patch(
130             "salt.utils.vmware.esxcli",
131             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
132         ):
133             self.assertEqual(
134                 {HOST: {"Error": ERROR}},
135                 vsphere.coredump_network_enable(HOST, USER, PASSWORD, True),
136             )
137     def test_coredump_network_enable_success(self):
138         with patch(
139             "salt.utils.vmware.esxcli",
140             MagicMock(return_value={"retcode": 0, "stdout": ""}),
141         ):
142             with patch(
143                 "salt.modules.vsphere._format_coredump_stdout",
144                 MagicMock(return_value={}),
145             ):
146                 enabled = True
147                 self.assertEqual(
148                     {HOST: {"Coredump Enabled": enabled}},
149                     vsphere.coredump_network_enable(HOST, USER, PASSWORD, enabled),
150                 )
151     def test_set_coredump_network_config_esxi_hosts_not_list(self):
152         self.assertRaises(
153             CommandExecutionError,
154             vsphere.set_coredump_network_config,
155             HOST,
156             USER,
157             PASSWORD,
158             "loghost",
159             "foo",
160             esxi_hosts="bar",
161         )
162     def test_set_coredump_network_config_host_list_bad_retcode(self):
163         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={"retcode": 1})):
164             host_1 = "host_1.foo.com"
165             self.assertEqual(
166                 {host_1: {"retcode": 1, "success": False}},
167                 vsphere.set_coredump_network_config(
168                     HOST, USER, PASSWORD, "dump-ip.test.com", esxi_hosts=[host_1]
169                 ),
170             )
171     def test_set_coredump_network_config_host_list_success(self):
172         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={"retcode": 0})):
173             host_1 = "host_1.foo.com"
174             self.assertEqual(
175                 {host_1: {"retcode": 0, "success": True}},
176                 vsphere.set_coredump_network_config(
177                     HOST, USER, PASSWORD, "dump-ip.test.com", esxi_hosts=[host_1]
178                 ),
179             )
180     def test_set_coredump_network_config_bad_retcode(self):
181         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={"retcode": 1})):
182             self.assertEqual(
183                 {HOST: {"retcode": 1, "success": False}},
184                 vsphere.set_coredump_network_config(
185                     HOST, USER, PASSWORD, "dump-ip.test.com"
186                 ),
187             )
188     def test_set_coredump_network_config_success(self):
189         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={"retcode": 0})):
190             self.assertEqual(
191                 {HOST: {"retcode": 0, "success": True}},
192                 vsphere.set_coredump_network_config(
193                     HOST, USER, PASSWORD, "dump-ip.test.com"
194                 ),
195             )
196     def test_get_firewall_status_esxi_hosts_not_list(self):
197         self.assertRaises(
198             CommandExecutionError,
199             vsphere.get_firewall_status,
200             HOST,
201             USER,
202             PASSWORD,
203             esxi_hosts="foo",
204         )
205     def test_get_firewall_status_host_list_bad_retcode(self):
206         with patch(
207             "salt.utils.vmware.esxcli",
208             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
209         ):
210             host_1 = "host_1.foo.com"
211             self.assertEqual(
212                 {host_1: {"success": False, "Error": ERROR, "rulesets": None}},
213                 vsphere.get_firewall_status(HOST, USER, PASSWORD, esxi_hosts=[host_1]),
214             )
215     def test_get_firewall_status_host_list_success(self):
216         with patch(
217             "salt.utils.vmware.esxcli",
218             MagicMock(return_value={"retcode": 0, "stdout": ""}),
219         ):
220             host_1 = "host_1.foo.com"
221             self.assertEqual(
222                 {host_1: {"rulesets": {}, "success": True}},
223                 vsphere.get_firewall_status(HOST, USER, PASSWORD, esxi_hosts=[host_1]),
224             )
225     def test_get_firewall_status_bad_retcode(self):
226         with patch(
227             "salt.utils.vmware.esxcli",
228             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
229         ):
230             self.assertEqual(
231                 {HOST: {"success": False, "Error": ERROR, "rulesets": None}},
232                 vsphere.get_firewall_status(HOST, USER, PASSWORD),
233             )
234     def test_get_firewall_status_success(self):
235         with patch(
236             "salt.utils.vmware.esxcli",
237             MagicMock(return_value={"retcode": 0, "stdout": ""}),
238         ):
239             self.assertEqual(
240                 {HOST: {"rulesets": {}, "success": True}},
241                 vsphere.get_firewall_status(HOST, USER, PASSWORD),
242             )
243     def test_enable_firewall_ruleset_esxi_hosts_not_list(self):
244         self.assertRaises(
245             CommandExecutionError,
246             vsphere.enable_firewall_ruleset,
247             HOST,
248             USER,
249             PASSWORD,
250             "foo",
251             "bar",
252             esxi_hosts="baz",
253         )
254     def test_syslog_service_reload_esxi_hosts_not_list(self):
255         self.assertRaises(
256             CommandExecutionError,
257             vsphere.syslog_service_reload,
258             HOST,
259             USER,
260             PASSWORD,
261             esxi_hosts="foo",
262         )
263     def test_set_syslog_config_esxi_hosts_not_list(self):
264         self.assertRaises(
265             CommandExecutionError,
266             vsphere.set_syslog_config,
267             HOST,
268             USER,
269             PASSWORD,
270             "foo",
271             "bar",
272             esxi_hosts="baz",
273         )
274     def test_set_syslog_config_esxi_hosts_not_list_firewall(self):
275         self.assertRaises(
276             CommandExecutionError,
277             vsphere.set_syslog_config,
278             HOST,
279             USER,
280             PASSWORD,
281             "loghost",
282             "foo",
283             firewall=True,
284             esxi_hosts="bar",
285         )
286     def test_set_syslog_config_host_list_firewall_bad_retcode(self):
287         with patch(
288             "salt.modules.vsphere.enable_firewall_ruleset",
289             MagicMock(return_value={"host_1.foo.com": {"retcode": 1, "stdout": ERROR}}),
290         ):
291             with patch(
292                 "salt.modules.vsphere._set_syslog_config_helper",
293                 MagicMock(return_value={}),
294             ):
295                 host_1 = "host_1.foo.com"
296                 self.assertEqual(
297                     {host_1: {"enable_firewall": {"message": ERROR, "success": False}}},
298                     vsphere.set_syslog_config(
299                         HOST,
300                         USER,
301                         PASSWORD,
302                         "loghost",
303                         "foo",
304                         firewall=True,
305                         esxi_hosts=[host_1],
306                     ),
307                 )
308     def test_set_syslog_config_host_list_firewall_success(self):
309         with patch(
310             "salt.modules.vsphere.enable_firewall_ruleset",
311             MagicMock(return_value={"host_1.foo.com": {"retcode": 0}}),
312         ):
313             with patch(
314                 "salt.modules.vsphere._set_syslog_config_helper",
315                 MagicMock(return_value={}),
316             ):
317                 host_1 = "host_1.foo.com"
318                 self.assertEqual(
319                     {host_1: {"enable_firewall": {"success": True}}},
320                     vsphere.set_syslog_config(
321                         HOST,
322                         USER,
323                         PASSWORD,
324                         "loghost",
325                         "foo",
326                         firewall=True,
327                         esxi_hosts=[host_1],
328                     ),
329                 )
330     def test_set_syslog_config_firewall_bad_retcode(self):
331         with patch(
332             "salt.modules.vsphere.enable_firewall_ruleset",
333             MagicMock(return_value={HOST: {"retcode": 1, "stdout": ERROR}}),
334         ):
335             with patch(
336                 "salt.modules.vsphere._set_syslog_config_helper",
337                 MagicMock(return_value={}),
338             ):
339                 self.assertEqual(
340                     {HOST: {"enable_firewall": {"message": ERROR, "success": False}}},
341                     vsphere.set_syslog_config(
342                         HOST, USER, PASSWORD, "loghost", "foo", firewall=True
343                     ),
344                 )
345     def test_set_syslog_config_firewall_success(self):
346         with patch(
347             "salt.modules.vsphere.enable_firewall_ruleset",
348             MagicMock(return_value={HOST: {"retcode": 0}}),
349         ):
350             with patch(
351                 "salt.modules.vsphere._set_syslog_config_helper",
352                 MagicMock(return_value={}),
353             ):
354                 self.assertEqual(
355                     {HOST: {"enable_firewall": {"success": True}}},
356                     vsphere.set_syslog_config(
357                         HOST, USER, PASSWORD, "loghost", "foo", firewall=True
358                     ),
359                 )
360     def test_get_syslog_config_esxi_hosts_not_list(self):
361         self.assertRaises(
362             CommandExecutionError,
363             vsphere.get_syslog_config,
364             HOST,
365             USER,
366             PASSWORD,
367             esxi_hosts="foo",
368         )
369     def test_get_syslog_config_host_list_bad_retcode(self):
370         with patch(
371             "salt.utils.vmware.esxcli",
372             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
373         ):
374             host_1 = "host_1.foo.com"
375             self.assertEqual(
376                 {host_1: {"message": ERROR, "success": False}},
377                 vsphere.get_syslog_config(HOST, USER, PASSWORD, esxi_hosts=[host_1]),
378             )
379     def test_get_syslog_config_host_list_success(self):
380         with patch(
381             "salt.utils.vmware.esxcli",
382             MagicMock(return_value={"retcode": 0, "stdout": ""}),
383         ):
384             host_1 = "host_1.foo.com"
385             self.assertEqual(
386                 {host_1: {"success": True}},
387                 vsphere.get_syslog_config(HOST, USER, PASSWORD, esxi_hosts=[host_1]),
388             )
389     def test_get_syslog_config_bad_retcode(self):
390         with patch(
391             "salt.utils.vmware.esxcli",
392             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
393         ):
394             self.assertEqual(
395                 {HOST: {"message": ERROR, "success": False}},
396                 vsphere.get_syslog_config(HOST, USER, PASSWORD),
397             )
398     def test_get_syslog_config_success(self):
399         with patch(
400             "salt.utils.vmware.esxcli",
401             MagicMock(return_value={"retcode": 0, "stdout": ""}),
402         ):
403             self.assertEqual(
404                 {HOST: {"success": True}},
405                 vsphere.get_syslog_config(HOST, USER, PASSWORD),
406             )
407     def test_reset_syslog_config_no_syslog_config(self):
408         self.assertRaises(
409             CommandExecutionError, vsphere.reset_syslog_config, HOST, USER, PASSWORD
410         )
411     def test_reset_syslog_config_esxi_hosts_not_list(self):
412         self.assertRaises(
413             CommandExecutionError,
414             vsphere.reset_syslog_config,
415             HOST,
416             USER,
417             PASSWORD,
418             syslog_config="test",
419             esxi_hosts="foo",
420         )
421     def test_reset_syslog_config_invalid_config_param(self):
422         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={})):
423             error = "Invalid syslog configuration parameter"
424             self.assertEqual(
425                 {
426                     HOST: {
427                         "success": False,
428                         "test": {"message": error, "success": False},
429                     }
430                 },
431                 vsphere.reset_syslog_config(HOST, USER, PASSWORD, syslog_config="test"),
432             )
433     def test_reset_syslog_config_host_list_bad_retcode(self):
434         with patch(
435             "salt.utils.vmware.esxcli",
436             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
437         ):
438             host_1 = "host_1.foo.com"
439             self.assertEqual(
440                 {
441                     host_1: {
442                         "success": False,
443                         "logdir": {"message": ERROR, "success": False},
444                     }
445                 },
446                 vsphere.reset_syslog_config(
447                     HOST, USER, PASSWORD, syslog_config="logdir", esxi_hosts=[host_1]
448                 ),
449             )
450     def test_reset_syslog_config_host_list_success(self):
451         with patch(
452             "salt.utils.vmware.esxcli",
453             MagicMock(return_value={"retcode": 0, "stdout": ""}),
454         ):
455             host_1 = "host_1.foo.com"
456             self.assertEqual(
457                 {host_1: {"success": True, "loghost": {"success": True}}},
458                 vsphere.reset_syslog_config(
459                     HOST, USER, PASSWORD, syslog_config="loghost", esxi_hosts=[host_1]
460                 ),
461             )
462     def test_reset_syslog_config_bad_retcode(self):
463         with patch(
464             "salt.utils.vmware.esxcli",
465             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
466         ):
467             self.assertEqual(
468                 {
469                     HOST: {
470                         "success": False,
471                         "logdir-unique": {"message": ERROR, "success": False},
472                     }
473                 },
474                 vsphere.reset_syslog_config(
475                     HOST, USER, PASSWORD, syslog_config="logdir-unique"
476                 ),
477             )
478     def test_reset_syslog_config_success(self):
479         with patch(
480             "salt.utils.vmware.esxcli",
481             MagicMock(return_value={"retcode": 0, "stdout": ""}),
482         ):
483             self.assertEqual(
484                 {HOST: {"success": True, "default-rotate": {"success": True}}},
485                 vsphere.reset_syslog_config(
486                     HOST, USER, PASSWORD, syslog_config="default-rotate"
487                 ),
488             )
489     def test_reset_syslog_config_success_multiple_configs(self):
490         with patch(
491             "salt.utils.vmware.esxcli",
492             MagicMock(return_value={"retcode": 0, "stdout": ""}),
493         ):
494             self.assertEqual(
495                 {
496                     HOST: {
497                         "success": True,
498                         "default-size": {"success": True},
499                         "default-timeout": {"success": True},
500                     }
501                 },
502                 vsphere.reset_syslog_config(
503                     HOST, USER, PASSWORD, syslog_config="default-size,default-timeout"
504                 ),
505             )
506     def test_reset_syslog_config_success_all_configs(self):
507         with patch(
508             "salt.utils.vmware.esxcli",
509             MagicMock(return_value={"retcode": 0, "stdout": ""}),
510         ):
511             self.assertEqual(
512                 {
513                     HOST: {
514                         "success": True,
515                         "logdir": {"success": True},
516                         "loghost": {"success": True},
517                         "default-rotate": {"success": True},
518                         "default-size": {"success": True},
519                         "default-timeout": {"success": True},
520                         "logdir-unique": {"success": True},
521                     }
522                 },
523                 vsphere.reset_syslog_config(HOST, USER, PASSWORD, syslog_config="all"),
524             )
525     def test_reset_syslog_config_params_no_valid_reset(self):
526         valid_resets = ["hello", "world"]
527         config = "foo"
528         ret = {
529             "success": False,
530             config: {
531                 "success": False,
532                 "message": "Invalid syslog configuration parameter",
533             },
534         }
535         self.assertEqual(
536             ret,
537             vsphere._reset_syslog_config_params(
538                 HOST, USER, PASSWORD, "cmd", config, valid_resets
539             ),
540         )
541     def test_reset_syslog_config_params_error(self):
542         with patch(
543             "salt.utils.vmware.esxcli",
544             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
545         ):
546             valid_resets = ["hello", "world"]
547             error_dict = {"success": False, "message": ERROR}
548             ret = {"success": False, "hello": error_dict, "world": error_dict}
549             self.assertDictEqual(
550                 ret,
551                 vsphere._reset_syslog_config_params(
552                     HOST, USER, PASSWORD, "cmd", valid_resets, valid_resets
553                 ),
554             )
555     def test_reset_syslog_config_params_success(self):
556         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={"retcode": 0})):
557             valid_resets = ["hello", "world"]
558             ret = {
559                 "success": True,
560                 "hello": {"success": True},
561                 "world": {"success": True},
562             }
563             self.assertDictEqual(
564                 ret,
565                 vsphere._reset_syslog_config_params(
566                     HOST, USER, PASSWORD, "cmd", valid_resets, valid_resets
567                 ),
568             )
569     def test_set_syslog_config_helper_no_valid_reset(self):
570         config = "foo"
571         ret = {
572             "success": False,
573             "message": "'{}' is not a valid config variable.".format(config),
574         }
575         self.assertEqual(
576             ret, vsphere._set_syslog_config_helper(HOST, USER, PASSWORD, config, "bar")
577         )
578     def test_set_syslog_config_helper_bad_retcode(self):
579         with patch(
580             "salt.utils.vmware.esxcli",
581             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
582         ):
583             config = "default-rotate"
584             self.assertEqual(
585                 {config: {"success": False, "message": ERROR}},
586                 vsphere._set_syslog_config_helper(HOST, USER, PASSWORD, config, "foo"),
587             )
588     def test_set_syslog_config_helper_success(self):
589         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={"retcode": 0})):
590             config = "logdir"
591             self.assertEqual(
592                 {config: {"success": True}},
593                 vsphere._set_syslog_config_helper(HOST, USER, PASSWORD, config, "foo"),
594             )
595 class GetProxyTypeTestCase(TestCase, LoaderModuleMockMixin):
596     def setup_loader_modules(self):
597         return {vsphere: {}}
598     def test_output(self):
599         with patch.dict(
600             vsphere.__pillar__, {"proxy": {"proxytype": "fake_proxy_type"}}
601         ):
602             ret = vsphere.get_proxy_type()
603         self.assertEqual("fake_proxy_type", ret)
604 class SupportsProxiesTestCase(TestCase, LoaderModuleMockMixin):
605     def setup_loader_modules(self):
606         return {vsphere: {}}
607     def test_supported_proxy(self):
608         @vsphere._supports_proxies("supported")
609         def mock_function():
610             return "fake_function"
611         with patch(
612             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="supported")
613         ):
614             ret = mock_function()
615         self.assertEqual("fake_function", ret)
616     def test_unsupported_proxy(self):
617         @vsphere._supports_proxies("supported")
618         def mock_function():
619             return "fake_function"
620         with patch(
621             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="unsupported")
622         ):
623             with self.assertRaises(CommandExecutionError) as excinfo:
624                 mock_function()
625         self.assertEqual(
626             "'unsupported' proxy is not supported by function mock_function",
627             excinfo.exception.strerror,
628         )
629 class _GetProxyConnectionDetailsTestCase(TestCase, LoaderModuleMockMixin):
630     def setup_loader_modules(self):
631         return {vsphere: {}}
632     def setUp(self):
633         self.esxi_host_details = {
634             "host": "fake_host",
635             "username": "fake_username",
636             "password": "fake_password",
637             "protocol": "fake_protocol",
638             "port": "fake_port",
639             "mechanism": "fake_mechanism",
640             "principal": "fake_principal",
641             "domain": "fake_domain",
642         }
643         self.esxi_vcenter_details = {
644             "vcenter": "fake_vcenter",
645             "username": "fake_username",
646             "password": "fake_password",
647             "protocol": "fake_protocol",
648             "port": "fake_port",
649             "mechanism": "fake_mechanism",
650             "principal": "fake_principal",
651             "domain": "fake_domain",
652         }
653         self.esxdatacenter_details = {
654             "vcenter": "fake_vcenter",
655             "datacenter": "fake_dc",
656             "username": "fake_username",
657             "password": "fake_password",
658             "protocol": "fake_protocol",
659             "port": "fake_port",
660             "mechanism": "fake_mechanism",
661             "principal": "fake_principal",
662             "domain": "fake_domain",
663         }
664         self.esxcluster_details = {
665             "vcenter": "fake_vcenter",
666             "datacenter": "fake_dc",
667             "cluster": "fake_cluster",
668             "username": "fake_username",
669             "password": "fake_password",
670             "protocol": "fake_protocol",
671             "port": "fake_port",
672             "mechanism": "fake_mechanism",
673             "principal": "fake_principal",
674             "domain": "fake_domain",
675         }
676         self.vcenter_details = {
677             "vcenter": "fake_vcenter",
678             "username": "fake_username",
679             "password": "fake_password",
680             "protocol": "fake_protocol",
681             "port": "fake_port",
682             "mechanism": "fake_mechanism",
683             "principal": "fake_principal",
684             "domain": "fake_domain",
685         }
686     def tearDown(self):
687         for attrname in (
688             "esxi_host_details",
689             "esxi_vcenter_details",
690             "esxdatacenter_details",
691             "esxcluster_details",
692         ):
693             try:
694                 delattr(self, attrname)
695             except AttributeError:
696                 continue
697     def test_esxi_proxy_host_details(self):
698         with patch(
699             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxi")
700         ):
701             with patch.dict(
702                 vsphere.__salt__,
703                 {"esxi.get_details": MagicMock(return_value=self.esxi_host_details)},
704             ):
705                 ret = vsphere._get_proxy_connection_details()
706         self.assertEqual(
707             (
708                 "fake_host",
709                 "fake_username",
710                 "fake_password",
711                 "fake_protocol",
712                 "fake_port",
713                 "fake_mechanism",
714                 "fake_principal",
715                 "fake_domain",
716             ),
717             ret,
718         )
719     def test_esxdatacenter_proxy_details(self):
720         with patch(
721             "salt.modules.vsphere.get_proxy_type",
722             MagicMock(return_value="esxdatacenter"),
723         ):
724             with patch.dict(
725                 vsphere.__salt__,
726                 {
727                     "esxdatacenter.get_details": MagicMock(
728                         return_value=self.esxdatacenter_details
729                     )
730                 },
731             ):
732                 ret = vsphere._get_proxy_connection_details()
733         self.assertEqual(
734             (
735                 "fake_vcenter",
736                 "fake_username",
737                 "fake_password",
738                 "fake_protocol",
739                 "fake_port",
740                 "fake_mechanism",
741                 "fake_principal",
742                 "fake_domain",
743             ),
744             ret,
745         )
746     def test_esxcluster_proxy_details(self):
747         with patch(
748             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxcluster")
749         ):
750             with patch.dict(
751                 vsphere.__salt__,
752                 {
753                     "esxcluster.get_details": MagicMock(
754                         return_value=self.esxcluster_details
755                     )
756                 },
757             ):
758                 ret = vsphere._get_proxy_connection_details()
759         self.assertEqual(
760             (
761                 "fake_vcenter",
762                 "fake_username",
763                 "fake_password",
764                 "fake_protocol",
765                 "fake_port",
766                 "fake_mechanism",
767                 "fake_principal",
768                 "fake_domain",
769             ),
770             ret,
771         )
772     def test_esxi_proxy_vcenter_details(self):
773         with patch(
774             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxi")
775         ):
776             with patch.dict(
777                 vsphere.__salt__,
778                 {"esxi.get_details": MagicMock(return_value=self.esxi_vcenter_details)},
779             ):
780                 ret = vsphere._get_proxy_connection_details()
781         self.assertEqual(
782             (
783                 "fake_vcenter",
784                 "fake_username",
785                 "fake_password",
786                 "fake_protocol",
787                 "fake_port",
788                 "fake_mechanism",
789                 "fake_principal",
790                 "fake_domain",
791             ),
792             ret,
793         )
794     def test_vcenter_proxy_details(self):
795         with patch(
796             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="vcenter")
797         ):
798             with patch.dict(
799                 vsphere.__salt__,
800                 {"vcenter.get_details": MagicMock(return_value=self.vcenter_details)},
801             ):
802                 ret = vsphere._get_proxy_connection_details()
803         self.assertEqual(
804             (
805                 "fake_vcenter",
806                 "fake_username",
807                 "fake_password",
808                 "fake_protocol",
809                 "fake_port",
810                 "fake_mechanism",
811                 "fake_principal",
812                 "fake_domain",
813             ),
814             ret,
815         )
816     def test_unsupported_proxy_details(self):
817         with patch(
818             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="unsupported")
819         ):
820             with self.assertRaises(CommandExecutionError) as excinfo:
821                 ret = vsphere._get_proxy_connection_details()
822         self.assertEqual(
823             "'unsupported' proxy is not supported", excinfo.exception.strerror
824         )
825     def test_vcenter_proxy_details_verify_ssl(self):
826         for verify_ssl in [True, False]:
827             details = self.vcenter_details.copy()
828             details["verify_ssl"] = verify_ssl
829             with patch(
830                 "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="vcenter")
831             ):
832                 with patch.dict(
833                     vsphere.__salt__,
834                     {"vcenter.get_details": MagicMock(return_value=details)},
835                 ):
836                     ret = vsphere._get_proxy_connection_details()
837             self.assertEqual(
838                 (
839                     "fake_vcenter",
840                     "fake_username",
841                     "fake_password",
842                     "fake_protocol",
843                     "fake_port",
844                     "fake_mechanism",
845                     "fake_principal",
846                     "fake_domain",
847                     verify_ssl,
848                 ),
849                 ret,
850             )
851 class GetsServiceInstanceViaProxyTestCase(TestCase, LoaderModuleMockMixin):
852     def setup_loader_modules(self):
853         patcher = patch("salt.utils.vmware.get_service_instance", MagicMock())
854         patcher.start()
855         self.addCleanup(patcher.stop)
856         patcher = patch("salt.utils.vmware.disconnect", MagicMock())
857         patcher.start()
858         self.addCleanup(patcher.stop)
859         return {vsphere: {"_get_proxy_connection_details": MagicMock()}}
860     def setUp(self):
861         self.mock_si = MagicMock()
862         self.mock_details1 = MagicMock()
863         self.mock_details2 = MagicMock()
864     def tearDown(self):
865         for attrname in ("mock_si", "mock_details1", "mock_details2"):
866             try:
867                 delattr(self, attrname)
868             except AttributeError:
869                 continue
870     def test_no_service_instance_or_kwargs_parameters(self):
871         @vsphere._gets_service_instance_via_proxy
872         def mock_function():
873             return "fake_function"
874         with self.assertRaises(CommandExecutionError) as excinfo:
875             mock_function()
876         self.assertEqual(
877             "Function mock_function must have either a "
878             "'service_instance', or a '**kwargs' type "
879             "parameter",
880             excinfo.exception.strerror,
881         )
882     def test___get_proxy_connection_details_call(self):
883         mock__get_proxy_connection_details = MagicMock()
884         @vsphere._gets_service_instance_via_proxy
885         def mock_function(service_instance=None):
886             return service_instance
887         with patch(
888             "salt.modules.vsphere._get_proxy_connection_details",
889             mock__get_proxy_connection_details,
890         ):
891             mock_function()
892         mock__get_proxy_connection_details.assert_called_once_with()
893     def test_service_instance_named_parameter_no_value(self):
894         mock_get_service_instance = MagicMock(return_value=self.mock_si)
895         mock_disconnect = MagicMock()
896         @vsphere._gets_service_instance_via_proxy
897         def mock_function(service_instance=None):
898             return service_instance
899         with patch(
900             "salt.modules.vsphere._get_proxy_connection_details",
901             MagicMock(return_value=(self.mock_details1, self.mock_details2)),
902         ):
903             with patch(
904                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
905             ):
906                 with patch("salt.utils.vmware.disconnect", mock_disconnect):
907                     ret = mock_function()
908         mock_get_service_instance.assert_called_once_with(
909             self.mock_details1, self.mock_details2
910         )
911         mock_disconnect.assert_called_once_with(self.mock_si)
912         self.assertEqual(ret, self.mock_si)
913     def test_service_instance_kwargs_parameter_no_value(self):
914         mock_get_service_instance = MagicMock(return_value=self.mock_si)
915         mock_disconnect = MagicMock()
916         @vsphere._gets_service_instance_via_proxy
917         def mock_function(**kwargs):
918             return kwargs["service_instance"]
919         with patch(
920             "salt.modules.vsphere._get_proxy_connection_details",
921             MagicMock(return_value=(self.mock_details1, self.mock_details2)),
922         ):
923             with patch(
924                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
925             ):
926                 with patch("salt.utils.vmware.disconnect", mock_disconnect):
927                     ret = mock_function()
928         mock_get_service_instance.assert_called_once_with(
929             self.mock_details1, self.mock_details2
930         )
931         mock_disconnect.assert_called_once_with(self.mock_si)
932         self.assertEqual(ret, self.mock_si)
933     def test_service_instance_positional_parameter_no_default_value(self):
934         mock_get_service_instance = MagicMock()
935         mock_disconnect = MagicMock()
936         @vsphere._gets_service_instance_via_proxy
937         def mock_function(service_instance):
938             return service_instance
939         with patch(
940             "salt.modules.vsphere._get_proxy_connection_details",
941             MagicMock(return_value=(self.mock_details1, self.mock_details2)),
942         ):
943             with patch(
944                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
945             ):
946                 with patch("salt.utils.vmware.disconnect", mock_disconnect):
947                     ret = mock_function(self.mock_si)
948         self.assertEqual(mock_get_service_instance.call_count, 0)
949         self.assertEqual(mock_disconnect.call_count, 0)
950         self.assertEqual(ret, self.mock_si)
951     def test_service_instance_positional_parameter_with_default_value(self):
952         mock_get_service_instance = MagicMock()
953         mock_disconnect = MagicMock()
954         @vsphere._gets_service_instance_via_proxy
955         def mock_function(service_instance=None):
956             return service_instance
957         with patch(
958             "salt.modules.vsphere._get_proxy_connection_details",
959             MagicMock(return_value=(self.mock_details1, self.mock_details2)),
960         ):
961             with patch(
962                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
963             ):
964                 with patch("salt.utils.vmware.disconnect", mock_disconnect):
965                     ret = mock_function(self.mock_si)
966         self.assertEqual(mock_get_service_instance.call_count, 0)
967         self.assertEqual(mock_disconnect.call_count, 0)
968         self.assertEqual(ret, self.mock_si)
969     def test_service_instance_named_parameter_with_default_value(self):
970         mock_get_service_instance = MagicMock()
971         mock_disconnect = MagicMock()
972         @vsphere._gets_service_instance_via_proxy
973         def mock_function(service_instance=None):
974             return service_instance
975         with patch(
976             "salt.modules.vsphere._get_proxy_connection_details",
977             MagicMock(return_value=(self.mock_details1, self.mock_details2)),
978         ):
979             with patch(
980                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
981             ):
982                 with patch("salt.utils.vmware.disconnect", mock_disconnect):
983                     ret = mock_function(service_instance=self.mock_si)
984         self.assertEqual(mock_get_service_instance.call_count, 0)
985         self.assertEqual(mock_disconnect.call_count, 0)
986         self.assertEqual(ret, self.mock_si)
987     def test_service_instance_kwargs_parameter_passthrough(self):
988         mock_get_service_instance = MagicMock()
989         mock_disconnect = MagicMock()
990         @vsphere._gets_service_instance_via_proxy
991         def mock_function(**kwargs):
992             return kwargs["service_instance"]
993         with patch(
994             "salt.modules.vsphere._get_proxy_connection_details",
995             MagicMock(return_value=(self.mock_details1, self.mock_details2)),
996         ):
997             with patch(
998                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
999             ):
1000                 with patch("salt.utils.vmware.disconnect", mock_disconnect):
1001                     ret = mock_function(service_instance=self.mock_si)
1002         self.assertEqual(mock_get_service_instance.call_count, 0)
1003         self.assertEqual(mock_disconnect.call_count, 0)
1004         self.assertEqual(ret, self.mock_si)
1005 class GetServiceInstanceViaProxyTestCase(TestCase, LoaderModuleMockMixin):
1006     def setup_loader_modules(self):
1007         patcher = patch("salt.utils.vmware.get_service_instance", MagicMock())
1008         patcher.start()
1009         self.addCleanup(patcher.stop)
1010         return {
1011             vsphere: {
1012                 "get_proxy_type": MagicMock(return_value="esxi"),
1013                 "_get_proxy_connection_details": MagicMock(),
1014             }
1015         }
1016     def test_supported_proxies(self):
1017         supported_proxies = ["esxi", "esxcluster", "esxdatacenter", "vcenter", "esxvm"]
1018         for proxy_type in supported_proxies:
1019             with patch(
1020                 "salt.modules.vsphere.get_proxy_type",
1021                 MagicMock(return_value=proxy_type),
1022             ):
1023                 vsphere.get_service_instance_via_proxy()
1024     def test_get_service_instance_call(self):
1025         mock_connection_details = [MagicMock(), MagicMock(), MagicMock()]
1026         mock_get_service_instance = MagicMock()
1027         with patch(
1028             "salt.modules.vsphere._get_proxy_connection_details",
1029             MagicMock(return_value=mock_connection_details),
1030         ):
1031             with patch(
1032                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
1033             ):
1034                 vsphere.get_service_instance_via_proxy()
1035         mock_get_service_instance.assert_called_once_with(*mock_connection_details)
1036     def test_output(self):
1037         mock_si = MagicMock()
1038         with patch(
1039             "salt.utils.vmware.get_service_instance", MagicMock(return_value=mock_si)
1040         ):
1041             res = vsphere.get_service_instance_via_proxy()
1042         self.assertEqual(res, mock_si)
1043 class DisconnectTestCase(TestCase, LoaderModuleMockMixin):
1044     def setup_loader_modules(self):
1045         self.mock_si = MagicMock()
1046         self.addCleanup(delattr, self, "mock_si")
1047         patcher = patch("salt.utils.vmware.disconnect", MagicMock())
1048         patcher.start()
1049         self.addCleanup(patcher.stop)
1050         return {
1051             vsphere: {
1052                 "_get_proxy_connection_details": MagicMock(),
1053                 "get_proxy_type": MagicMock(return_value="esxi"),
1054             }
1055         }
1056     def test_supported_proxies(self):
1057         supported_proxies = ["esxi", "esxcluster", "esxdatacenter", "vcenter", "esxvm"]
1058         for proxy_type in supported_proxies:
1059             with patch(
1060                 "salt.modules.vsphere.get_proxy_type",
1061                 MagicMock(return_value=proxy_type),
1062             ):
1063                 vsphere.disconnect(self.mock_si)
1064     def test_disconnect_call(self):
1065         mock_disconnect = MagicMock()
1066         with patch("salt.utils.vmware.disconnect", mock_disconnect):
1067             vsphere.disconnect(self.mock_si)
1068         mock_disconnect.assert_called_once_with(self.mock_si)
1069     def test_output(self):
1070         res = vsphere.disconnect(self.mock_si)
1071         self.assertEqual(res, True)
1072 class TestVcenterConnectionTestCase(TestCase, LoaderModuleMockMixin):
1073     def setup_loader_modules(self):
1074         self.mock_si = MagicMock()
1075         self.addCleanup(delattr, self, "mock_si")
1076         patcher = patch(
1077             "salt.utils.vmware.get_service_instance",
1078             MagicMock(return_value=self.mock_si),
1079         )
1080         patcher.start()
1081         self.addCleanup(patcher.stop)
1082         patcher = patch("salt.utils.vmware.disconnect", MagicMock())
1083         patcher.start()
1084         self.addCleanup(patcher.stop)
1085         patcher = patch("salt.utils.vmware.is_connection_to_a_vcenter", MagicMock())
1086         patcher.start()
1087         self.addCleanup(patcher.stop)
1088         return {
1089             vsphere: {
1090                 "_get_proxy_connection_details": MagicMock(),
1091                 "get_proxy_type": MagicMock(return_value="esxi"),
1092             }
1093         }
1094     def test_supported_proxies(self):
1095         supported_proxies = ["esxi", "esxcluster", "esxdatacenter", "vcenter", "esxvm"]
1096         for proxy_type in supported_proxies:
1097             with patch(
1098                 "salt.modules.vsphere.get_proxy_type",
1099                 MagicMock(return_value=proxy_type),
1100             ):
1101                 vsphere.test_vcenter_connection()
1102     def test_is_connection_to_a_vcenter_call_default_service_instance(self):
1103         mock_is_connection_to_a_vcenter = MagicMock()
1104         with patch(
1105             "salt.utils.vmware.is_connection_to_a_vcenter",
1106             mock_is_connection_to_a_vcenter,
1107         ):
1108             vsphere.test_vcenter_connection()
1109         mock_is_connection_to_a_vcenter.assert_called_once_with(self.mock_si)
1110     def test_is_connection_to_a_vcenter_call_explicit_service_instance(self):
1111         expl_mock_si = MagicMock()
1112         mock_is_connection_to_a_vcenter = MagicMock()
1113         with patch(
1114             "salt.utils.vmware.is_connection_to_a_vcenter",
1115             mock_is_connection_to_a_vcenter,
1116         ):
1117             vsphere.test_vcenter_connection(expl_mock_si)
1118         mock_is_connection_to_a_vcenter.assert_called_once_with(expl_mock_si)
1119     def test_is_connection_to_a_vcenter_raises_vmware_salt_error(self):
1120         exc = VMwareSaltError("VMwareSaltError")
1121         with patch(
1122             "salt.utils.vmware.is_connection_to_a_vcenter", MagicMock(side_effect=exc)
1123         ):
1124             res = vsphere.test_vcenter_connection()
1125         self.assertEqual(res, False)
1126     def test_is_connection_to_a_vcenter_raises_non_vmware_salt_error(self):
1127         exc = Exception("NonVMwareSaltError")
1128         with patch(
1129             "salt.utils.vmware.is_connection_to_a_vcenter", MagicMock(side_effect=exc)
1130         ):
1131             with self.assertRaises(Exception) as excinfo:
1132                 res = vsphere.test_vcenter_connection()
1133         self.assertEqual("NonVMwareSaltError", str(excinfo.exception))
1134     def test_output_true(self):
1135         with patch(
1136             "salt.utils.vmware.is_connection_to_a_vcenter", MagicMock(return_value=True)
1137         ):
1138             res = vsphere.test_vcenter_connection()
1139         self.assertEqual(res, True)
1140     def test_output_false(self):
1141         with patch(
1142             "salt.utils.vmware.is_connection_to_a_vcenter",
1143             MagicMock(return_value=False),
1144         ):
1145             res = vsphere.test_vcenter_connection()
1146         self.assertEqual(res, False)
1147 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1148 class ListDatacentersViaProxyTestCase(TestCase, LoaderModuleMockMixin):
1149     def setup_loader_modules(self):
1150         self.mock_si = MagicMock()
1151         self.addCleanup(delattr, self, "mock_si")
1152         patcher = patch(
1153             "salt.utils.vmware.get_service_instance",
1154             MagicMock(return_value=self.mock_si),
1155         )
1156         patcher.start()
1157         self.addCleanup(patcher.stop)
1158         patcher = patch("salt.utils.vmware.get_datacenters", MagicMock())
1159         patcher.start()
1160         self.addCleanup(patcher.stop)
1161         patcher = patch("salt.utils.vmware.get_managed_object_name", MagicMock())
1162         patcher.start()
1163         self.addCleanup(patcher.stop)
1164         return {
1165             vsphere: {
1166                 "_get_proxy_connection_details": MagicMock(),
1167                 "get_proxy_type": MagicMock(return_value="esxdatacenter"),
1168             }
1169         }
1170     def test_supported_proxies(self):
1171         supported_proxies = ["esxcluster", "esxdatacenter", "vcenter", "esxvm"]
1172         for proxy_type in supported_proxies:
1173             with patch(
1174                 "salt.modules.vsphere.get_proxy_type",
1175                 MagicMock(return_value=proxy_type),
1176             ):
1177                 vsphere.list_datacenters_via_proxy()
1178     def test_default_params(self):
1179         mock_get_datacenters = MagicMock()
1180         with patch("salt.utils.vmware.get_datacenters", mock_get_datacenters):
1181             vsphere.list_datacenters_via_proxy()
1182         mock_get_datacenters.assert_called_once_with(
1183             self.mock_si, get_all_datacenters=True
1184         )
1185     def test_defined_service_instance(self):
1186         mock_si = MagicMock()
1187         mock_get_datacenters = MagicMock()
1188         with patch("salt.utils.vmware.get_datacenters", mock_get_datacenters):
1189             vsphere.list_datacenters_via_proxy(service_instance=mock_si)
1190         mock_get_datacenters.assert_called_once_with(mock_si, get_all_datacenters=True)
1191     def test_defined_datacenter_names(self):
1192         mock_datacenters = MagicMock()
1193         mock_get_datacenters = MagicMock()
1194         with patch("salt.utils.vmware.get_datacenters", mock_get_datacenters):
1195             vsphere.list_datacenters_via_proxy(mock_datacenters)
1196         mock_get_datacenters.assert_called_once_with(self.mock_si, mock_datacenters)
1197     def test_get_managed_object_name_calls(self):
1198         mock_get_managed_object_name = MagicMock()
1199         mock_dcs = [MagicMock(), MagicMock()]
1200         with patch(
1201             "salt.utils.vmware.get_datacenters", MagicMock(return_value=mock_dcs)
1202         ):
1203             with patch(
1204                 "salt.utils.vmware.get_managed_object_name",
1205                 mock_get_managed_object_name,
1206             ):
1207                 vsphere.list_datacenters_via_proxy()
1208         mock_get_managed_object_name.assert_has_calls(
1209             [call(mock_dcs[0]), call(mock_dcs[1])]
1210         )
1211     def test_returned_array(self):
1212         with patch(
1213             "salt.utils.vmware.get_datacenters",
1214             MagicMock(return_value=[MagicMock(), MagicMock()]),
1215         ):
1216             with patch(
1217                 "salt.utils.vmware.get_managed_object_name",
1218                 MagicMock(side_effect=["fake_dc1", "fake_dc2", "fake_dc3"]),
1219             ):
1220                 res = vsphere.list_datacenters_via_proxy()
1221         self.assertEqual(res, [{"name": "fake_dc1"}, {"name": "fake_dc2"}])
1222 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1223 class CreateDatacenterTestCase(TestCase, LoaderModuleMockMixin):
1224     def setup_loader_modules(self):
1225         self.mock_si = MagicMock()
1226         self.addCleanup(delattr, self, "mock_si")
1227         patcher = patch(
1228             "salt.utils.vmware.get_service_instance",
1229             MagicMock(return_value=self.mock_si),
1230         )
1231         patcher.start()
1232         self.addCleanup(patcher.stop)
1233         patcher = patch("salt.utils.vmware.create_datacenter", MagicMock())
1234         patcher.start()
1235         self.addCleanup(patcher.stop)
1236         return {
1237             vsphere: {
1238                 "_get_proxy_connection_details": MagicMock(),
1239                 "get_proxy_type": MagicMock(return_value="esxdatacenter"),
1240             }
1241         }
1242     def test_supported_proxies(self):
1243         supported_proxies = ["esxdatacenter", "vcenter"]
1244         for proxy_type in supported_proxies:
1245             with patch(
1246                 "salt.modules.vsphere.get_proxy_type",
1247                 MagicMock(return_value=proxy_type),
1248             ):
1249                 vsphere.create_datacenter("fake_dc1")
1250     def test_default_service_instance(self):
1251         mock_create_datacenter = MagicMock()
1252         with patch("salt.utils.vmware.create_datacenter", mock_create_datacenter):
1253             vsphere.create_datacenter("fake_dc1")
1254         mock_create_datacenter.assert_called_once_with(self.mock_si, "fake_dc1")
1255     def test_defined_service_instance(self):
1256         mock_si = MagicMock()
1257         mock_create_datacenter = MagicMock()
1258         with patch("salt.utils.vmware.create_datacenter", mock_create_datacenter):
1259             vsphere.create_datacenter("fake_dc1", service_instance=mock_si)
1260         mock_create_datacenter.assert_called_once_with(mock_si, "fake_dc1")
1261     def test_returned_value(self):
1262         res = vsphere.create_datacenter("fake_dc1")
1263         self.assertEqual(res, {"create_datacenter": True})
1264 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1265 class EraseDiskPartitionsTestCase(TestCase, LoaderModuleMockMixin):
1266     def setup_loader_modules(self):
1267         return {
1268             vsphere: {
1269                 "_get_proxy_connection_details": MagicMock(),
1270                 "__proxy__": {
1271                     "esxi.get_details": MagicMock(
1272                         return_value={"esxi_host": "fake_host"}
1273                     )
1274                 },
1275             }
1276         }
1277     def setUp(self):
1278         attrs = (("mock_si", MagicMock()), ("mock_host", MagicMock()))
1279         for attr, mock_obj in attrs:
1280             setattr(self, attr, mock_obj)
1281             self.addCleanup(delattr, self, attr)
1282         attrs = (
1283             ("mock_proxy_target", MagicMock(return_value=self.mock_host)),
1284             ("mock_erase_disk_partitions", MagicMock()),
1285         )
1286         for attr, mock_obj in attrs:
1287             setattr(self, attr, mock_obj)
1288             self.addCleanup(delattr, self, attr)
1289         patches = (
1290             (
1291                 "salt.utils.vmware.get_service_instance",
1292                 MagicMock(return_value=self.mock_si),
1293             ),
1294             ("salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxi")),
1295             (
1296                 "salt.modules.vsphere._get_proxy_target",
1297                 MagicMock(return_value=self.mock_host),
1298             ),
1299             (
1300                 "salt.utils.vmware.erase_disk_partitions",
1301                 self.mock_erase_disk_partitions,
1302             ),
1303         )
1304         for module, mock_obj in patches:
1305             patcher = patch(module, mock_obj)
1306             patcher.start()
1307             self.addCleanup(patcher.stop)
1308     def test_supported_proxies(self):
1309         supported_proxies = ["esxi"]
1310         for proxy_type in supported_proxies:
1311             with patch(
1312                 "salt.modules.vsphere.get_proxy_type",
1313                 MagicMock(return_value=proxy_type),
1314             ):
1315                 vsphere.erase_disk_partitions(disk_id="fake_disk")
1316     def test_no_disk_id_or_scsi_address(self):
1317         with self.assertRaises(ArgumentValueError) as excinfo:
1318             vsphere.erase_disk_partitions()
1319         self.assertEqual(
1320             "Either 'disk_id' or 'scsi_address' needs to be specified",
1321             excinfo.exception.strerror,
1322         )
1323     def test_get_proxy_target(self):
1324         mock_test_proxy_target = MagicMock()
1325         with patch("salt.modules.vsphere._get_proxy_target", mock_test_proxy_target):
1326             vsphere.erase_disk_partitions(disk_id="fake_disk")
1327         mock_test_proxy_target.assert_called_once_with(self.mock_si)
1328     def test_scsi_address_not_found(self):
1329         mock = MagicMock(return_value={"bad_scsi_address": "bad_disk_id"})
1330         with patch("salt.utils.vmware.get_scsi_address_to_lun_map", mock):
1331             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
1332                 vsphere.erase_disk_partitions(scsi_address="fake_scsi_address")
1333         self.assertEqual(
1334             "Scsi lun with address 'fake_scsi_address' was "
1335             "not found on host 'fake_host'",
1336             excinfo.exception.strerror,
1337         )
1338     def test_scsi_address_to_disk_id_map(self):
1339         mock_disk_id = MagicMock(canonicalName="fake_scsi_disk_id")
1340         mock_get_scsi_addr_to_lun = MagicMock(
1341             return_value={"fake_scsi_address": mock_disk_id}
1342         )
1343         with patch(
1344             "salt.utils.vmware.get_scsi_address_to_lun_map", mock_get_scsi_addr_to_lun
1345         ):
1346             vsphere.erase_disk_partitions(scsi_address="fake_scsi_address")
1347         mock_get_scsi_addr_to_lun.assert_called_once_with(self.mock_host)
1348         self.mock_erase_disk_partitions.assert_called_once_with(
1349             self.mock_si, self.mock_host, "fake_scsi_disk_id", hostname="fake_host"
1350         )
1351     def test_erase_disk_partitions(self):
1352         vsphere.erase_disk_partitions(disk_id="fake_disk_id")
1353         self.mock_erase_disk_partitions.assert_called_once_with(
1354             self.mock_si, self.mock_host, "fake_disk_id", hostname="fake_host"
1355         )
1356 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1357 class RemoveDatastoreTestCase(TestCase, LoaderModuleMockMixin):
1358     def setup_loader_modules(self):
1359         return {
1360             vsphere: {
1361                 "_get_proxy_connection_details": MagicMock(),
1362                 "get_proxy_type": MagicMock(return_value="esxdatacenter"),
1363             }
1364         }
1365     def setUp(self):
1366         attrs = (
1367             ("mock_si", MagicMock()),
1368             ("mock_target", MagicMock()),
1369             ("mock_ds", MagicMock()),
1370         )
1371         for attr, mock_obj in attrs:
1372             setattr(self, attr, mock_obj)
1373             self.addCleanup(delattr, self, attr)
1374         patches = (
1375             (
1376                 "salt.utils.vmware.get_service_instance",
1377                 MagicMock(return_value=self.mock_si),
1378             ),
1379             (
1380                 "salt.modules.vsphere.get_proxy_type",
1381                 MagicMock(return_value="esxdatacenter"),
1382             ),
1383             (
1384                 "salt.modules.vsphere._get_proxy_target",
1385                 MagicMock(return_value=self.mock_target),
1386             ),
1387             (
1388                 "salt.utils.vmware.get_datastores",
1389                 MagicMock(return_value=[self.mock_ds]),
1390             ),
1391             ("salt.utils.vmware.remove_datastore", MagicMock()),
1392         )
1393         for module, mock_obj in patches:
1394             patcher = patch(module, mock_obj)
1395             patcher.start()
1396             self.addCleanup(patcher.stop)
1397     def test_supported_proxes(self):
1398         supported_proxies = ["esxi", "esxcluster", "esxdatacenter"]
1399         for proxy_type in supported_proxies:
1400             with patch(
1401                 "salt.modules.vsphere.get_proxy_type",
1402                 MagicMock(return_value=proxy_type),
1403             ):
1404                 vsphere.remove_datastore(datastore="fake_ds_name")
1405     def test__get_proxy_target_call(self):
1406         mock__get_proxy_target = MagicMock(return_value=self.mock_target)
1407         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
1408             vsphere.remove_datastore(datastore="fake_ds_name")
1409         mock__get_proxy_target.assert_called_once_with(self.mock_si)
1410     def test_get_datastores_call(self):
1411         mock_get_datastores = MagicMock()
1412         with patch("salt.utils.vmware.get_datastores", mock_get_datastores):
1413             vsphere.remove_datastore(datastore="fake_ds")
1414         mock_get_datastores.assert_called_once_with(
1415             self.mock_si, reference=self.mock_target, datastore_names=["fake_ds"]
1416         )
1417     def test_datastore_not_found(self):
1418         with patch("salt.utils.vmware.get_datastores", MagicMock(return_value=[])):
1419             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
1420                 vsphere.remove_datastore(datastore="fake_ds")
1421         self.assertEqual(
1422             "Datastore 'fake_ds' was not found", excinfo.exception.strerror
1423         )
1424     def test_multiple_datastores_found(self):
1425         with patch(
1426             "salt.utils.vmware.get_datastores",
1427             MagicMock(return_value=[MagicMock(), MagicMock()]),
1428         ):
1429             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
1430                 vsphere.remove_datastore(datastore="fake_ds")
1431         self.assertEqual(
1432             "Multiple datastores 'fake_ds' were found", excinfo.exception.strerror
1433         )
1434     def test_remove_datastore_call(self):
1435         mock_remove_datastore = MagicMock()
1436         with patch("salt.utils.vmware.remove_datastore", mock_remove_datastore):
1437             vsphere.remove_datastore(datastore="fake_ds")
1438         mock_remove_datastore.assert_called_once_with(self.mock_si, self.mock_ds)
1439     def test_success_output(self):
1440         res = vsphere.remove_datastore(datastore="fake_ds")
1441         self.assertTrue(res)
1442 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1443 class RemoveDiskgroupTestCase(TestCase, LoaderModuleMockMixin):
1444     def setup_loader_modules(self):
1445         return {
1446             vsphere: {
1447                 "_get_proxy_connection_details": MagicMock(),
1448                 "__proxy__": {
1449                     "esxi.get_details": MagicMock(
1450                         return_value={"esxi_host": "fake_host"}
1451                     )
1452                 },
1453             }
1454         }
1455     def setUp(self):
1456         attrs = (
1457             ("mock_si", MagicMock()),
1458             ("mock_host", MagicMock()),
1459             ("mock_diskgroup", MagicMock()),
1460         )
1461         for attr, mock_obj in attrs:
1462             setattr(self, attr, mock_obj)
1463             self.addCleanup(delattr, self, attr)
1464         patches = (
1465             (
1466                 "salt.utils.vmware.get_service_instance",
1467                 MagicMock(return_value=self.mock_si),
1468             ),
1469             ("salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxi")),
1470             (
1471                 "salt.modules.vsphere._get_proxy_target",
1472                 MagicMock(return_value=self.mock_host),
1473             ),
1474             (
1475                 "salt.utils.vmware.get_diskgroups",
1476                 MagicMock(return_value=[self.mock_diskgroup]),
1477             ),
1478             ("salt.utils.vsan.remove_diskgroup", MagicMock()),
1479         )
1480         for module, mock_obj in patches:
1481             patcher = patch(module, mock_obj)
1482             patcher.start()
1483             self.addCleanup(patcher.stop)
1484     def test_supported_proxes(self):
1485         supported_proxies = ["esxi"]
1486         for proxy_type in supported_proxies:
1487             with patch(
1488                 "salt.modules.vsphere.get_proxy_type",
1489                 MagicMock(return_value=proxy_type),
1490             ):
1491                 vsphere.remove_diskgroup(cache_disk_id="fake_disk_id")
1492     def test__get_proxy_target_call(self):
1493         mock__get_proxy_target = MagicMock(return_value=self.mock_host)
1494         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
1495             vsphere.remove_diskgroup(cache_disk_id="fake_disk_id")
1496         mock__get_proxy_target.assert_called_once_with(self.mock_si)
1497     def test_get_disk_groups(self):
1498         mock_get_diskgroups = MagicMock(return_value=[self.mock_diskgroup])
1499         with patch("salt.utils.vmware.get_diskgroups", mock_get_diskgroups):
1500             vsphere.remove_diskgroup(cache_disk_id="fake_disk_id")
1501         mock_get_diskgroups.assert_called_once_with(
1502             self.mock_host, cache_disk_ids=["fake_disk_id"]
1503         )
1504     def test_disk_group_not_found_safety_checks_set(self):
1505         with patch("salt.utils.vmware.get_diskgroups", MagicMock(return_value=[])):
1506             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
1507                 vsphere.remove_diskgroup(cache_disk_id="fake_disk_id")
1508         self.assertEqual(
1509             "No diskgroup with cache disk id "
1510             "'fake_disk_id' was found in ESXi host "
1511             "'fake_host'",
1512             excinfo.exception.strerror,
1513         )
1514     def test_remove_disk_group(self):
1515         mock_remove_diskgroup = MagicMock(return_value=None)
1516         with patch("salt.utils.vsan.remove_diskgroup", mock_remove_diskgroup):
1517             vsphere.remove_diskgroup(cache_disk_id="fake_disk_id")
1518         mock_remove_diskgroup.assert_called_once_with(
1519             self.mock_si, self.mock_host, self.mock_diskgroup, data_accessibility=True
1520         )
1521     def test_remove_disk_group_data_accessibility_false(self):
1522         mock_remove_diskgroup = MagicMock(return_value=None)
1523         with patch("salt.utils.vsan.remove_diskgroup", mock_remove_diskgroup):
1524             vsphere.remove_diskgroup(
1525                 cache_disk_id="fake_disk_id", data_accessibility=False
1526             )
1527         mock_remove_diskgroup.assert_called_once_with(
1528             self.mock_si, self.mock_host, self.mock_diskgroup, data_accessibility=False
1529         )
1530     def test_success_output(self):
1531         res = vsphere.remove_diskgroup(cache_disk_id="fake_disk_id")
1532         self.assertTrue(res)
1533 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1534 @skipIf(not vsphere.HAS_JSONSCHEMA, "The 'jsonschema' library is missing")
1535 class RemoveCapacityFromDiskgroupTestCase(TestCase, LoaderModuleMockMixin):
1536     def setup_loader_modules(self):
1537         return {
1538             vsphere: {
1539                 "_get_proxy_connection_details": MagicMock(),
1540                 "__proxy__": {
1541                     "esxi.get_details": MagicMock(
1542                         return_value={"esxi_host": "fake_host"}
1543                     )
1544                 },
1545             }
1546         }
1547     def setUp(self):
1548         attrs = (
1549             ("mock_si", MagicMock()),
1550             ("mock_schema", MagicMock()),
1551             ("mock_host", MagicMock()),
1552             ("mock_disk1", MagicMock(canonicalName="fake_disk1")),
1553             ("mock_disk2", MagicMock(canonicalName="fake_disk2")),
1554             ("mock_disk3", MagicMock(canonicalName="fake_disk3")),
1555             ("mock_diskgroup", MagicMock()),
1556         )
1557         for attr, mock_obj in attrs:
1558             setattr(self, attr, mock_obj)
1559             self.addCleanup(delattr, self, attr)
1560         patches = (
1561             (
1562                 "salt.utils.vmware.get_service_instance",
1563                 MagicMock(return_value=self.mock_si),
1564             ),
1565             (
1566                 "salt.modules.vsphere.DiskGroupsDiskIdSchema.serialize",
1567                 MagicMock(return_value=self.mock_schema),
1568             ),
1569             ("salt.modules.vsphere.jsonschema.validate", MagicMock()),
1570             ("salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxi")),
1571             (
1572                 "salt.modules.vsphere._get_proxy_target",
1573                 MagicMock(return_value=self.mock_host),
1574             ),
1575             (
1576                 "salt.utils.vmware.get_disks",
1577                 MagicMock(
1578                     return_value=[self.mock_disk1, self.mock_disk2, self.mock_disk3]
1579                 ),
1580             ),
1581             (
1582                 "salt.utils.vmware.get_diskgroups",
1583                 MagicMock(return_value=[self.mock_diskgroup]),
1584             ),
1585             ("salt.utils.vsan.remove_capacity_from_diskgroup", MagicMock()),
1586         )
1587         for module, mock_obj in patches:
1588             patcher = patch(module, mock_obj)
1589             patcher.start()
1590             self.addCleanup(patcher.stop)
1591     def test_validate(self):
1592         mock_schema_validate = MagicMock()
1593         with patch("salt.modules.vsphere.jsonschema.validate", mock_schema_validate):
1594             vsphere.remove_capacity_from_diskgroup(
1595                 cache_disk_id="fake_cache_disk_id",
1596                 capacity_disk_ids=["fake_disk1", "fake_disk2"],
1597             )
1598         mock_schema_validate.assert_called_once_with(
1599             {
1600                 "diskgroups": [
1601                     {
1602                         "cache_id": "fake_cache_disk_id",
1603                         "capacity_ids": ["fake_disk1", "fake_disk2"],
1604                     }
1605                 ]
1606             },
1607             self.mock_schema,
1608         )
1609     def test_invalid_schema_validation(self):
1610         mock_schema_validate = MagicMock(
1611             side_effect=vsphere.jsonschema.exceptions.ValidationError("err")
1612         )
1613         with patch("salt.modules.vsphere.jsonschema.validate", mock_schema_validate):
1614             with self.assertRaises(ArgumentValueError) as excinfo:
1615                 vsphere.remove_capacity_from_diskgroup(
1616                     cache_disk_id="fake_cache_disk_id",
1617                     capacity_disk_ids=["fake_disk1", "fake_disk2"],
1618                 )
1619         self.assertEqual("err", excinfo.exception.strerror)
1620     def test_supported_proxes(self):
1621         supported_proxies = ["esxi"]
1622         for proxy_type in supported_proxies:
1623             with patch(
1624                 "salt.modules.vsphere.get_proxy_type",
1625                 MagicMock(return_value=proxy_type),
1626             ):
1627                 vsphere.remove_capacity_from_diskgroup(
1628                     cache_disk_id="fake_cache_disk_id",
1629                     capacity_disk_ids=["fake_disk1", "fake_disk2"],
1630                 )
1631     def test__get_proxy_target_call(self):
1632         mock__get_proxy_target = MagicMock(return_value=self.mock_host)
1633         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
1634             vsphere.remove_capacity_from_diskgroup(
1635                 cache_disk_id="fake_cache_disk_id",
1636                 capacity_disk_ids=["fake_disk1", "fake_disk2"],
1637             )
1638         mock__get_proxy_target.assert_called_once_with(self.mock_si)
1639     def test_get_disks(self):
1640         mock_get_disks = MagicMock(
1641             return_value=[self.mock_disk1, self.mock_disk2, self.mock_disk3]
1642         )
1643         with patch("salt.utils.vmware.get_disks", mock_get_disks):
1644             vsphere.remove_capacity_from_diskgroup(
1645                 cache_disk_id="fake_cache_disk_id",
1646                 capacity_disk_ids=["fake_disk1", "fake_disk2"],
1647             )
1648         mock_get_disks.assert_called_once_with(
1649             self.mock_host, disk_ids=["fake_disk1", "fake_disk2"]
1650         )
1651     def test_disk_not_found_safety_checks_set(self):
1652         mock_get_disks = MagicMock(
1653             return_value=[self.mock_disk1, self.mock_disk2, self.mock_disk3]
1654         )
1655         with patch("salt.utils.vmware.get_disks", mock_get_disks):
1656             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
1657                 vsphere.remove_capacity_from_diskgroup(
1658                     cache_disk_id="fake_cache_disk_id",
1659                     capacity_disk_ids=["fake_disk1", "fake_disk4"],
1660                     safety_checks=True,
1661                 )
1662         self.assertEqual(
1663             "No disk with id 'fake_disk4' was found in ESXi host 'fake_host'",
1664             excinfo.exception.strerror,
1665         )
1666     def test_get_diskgroups(self):
1667         mock_get_diskgroups = MagicMock(return_value=[self.mock_diskgroup])
1668         with patch("salt.utils.vmware.get_diskgroups", mock_get_diskgroups):
1669             vsphere.remove_capacity_from_diskgroup(
1670                 cache_disk_id="fake_cache_disk_id",
1671                 capacity_disk_ids=["fake_disk1", "fake_disk2"],
1672             )
1673         mock_get_diskgroups.assert_called_once_with(
1674             self.mock_host, cache_disk_ids=["fake_cache_disk_id"]
1675         )
1676     def test_diskgroup_not_found(self):
1677         with patch("salt.utils.vmware.get_diskgroups", MagicMock(return_value=[])):
1678             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
1679                 vsphere.remove_capacity_from_diskgroup(
1680                     cache_disk_id="fake_cache_disk_id",
1681                     capacity_disk_ids=["fake_disk1", "fake_disk2"],
1682                 )
1683         self.assertEqual(
1684             "No diskgroup with cache disk id "
1685             "'fake_cache_disk_id' was found in ESXi host "
1686             "'fake_host'",
1687             excinfo.exception.strerror,
1688         )
1689     def test_remove_capacity_from_diskgroup(self):
1690         mock_remove_capacity_from_diskgroup = MagicMock()
1691         with patch(
1692             "salt.utils.vsan.remove_capacity_from_diskgroup",
1693             mock_remove_capacity_from_diskgroup,
1694         ):
1695             vsphere.remove_capacity_from_diskgroup(
1696                 cache_disk_id="fake_cache_disk_id",
1697                 capacity_disk_ids=["fake_disk1", "fake_disk2"],
1698             )
1699         mock_remove_capacity_from_diskgroup.assert_called_once_with(
1700             self.mock_si,
1701             self.mock_host,
1702             self.mock_diskgroup,
1703             capacity_disks=[self.mock_disk1, self.mock_disk2],
1704             data_evacuation=True,
1705         )
1706     def test_remove_capacity_from_diskgroup_data_evacuation_false(self):
1707         mock_remove_capacity_from_diskgroup = MagicMock()
1708         with patch(
1709             "salt.utils.vsan.remove_capacity_from_diskgroup",
1710             mock_remove_capacity_from_diskgroup,
1711         ):
1712             vsphere.remove_capacity_from_diskgroup(
1713                 cache_disk_id="fake_cache_disk_id",
1714                 capacity_disk_ids=["fake_disk1", "fake_disk2"],
1715                 data_evacuation=False,
1716             )
1717         mock_remove_capacity_from_diskgroup.assert_called_once_with(
1718             self.mock_si,
1719             self.mock_host,
1720             self.mock_diskgroup,
1721             capacity_disks=[self.mock_disk1, self.mock_disk2],
1722             data_evacuation=False,
1723         )
1724     def test_success_output(self):
1725         res = vsphere.remove_capacity_from_diskgroup(
1726             cache_disk_id="fake_cache_disk_id",
1727             capacity_disk_ids=["fake_disk1", "fake_disk2"],
1728         )
1729         self.assertTrue(res)
1730 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1731 class ListClusterTestCase(TestCase, LoaderModuleMockMixin):
1732     def setup_loader_modules(self):
1733         return {vsphere: {"_get_proxy_connection_details": MagicMock(), "__salt__": {}}}
1734     def setUp(self):
1735         attrs = (
1736             ("mock_si", MagicMock()),
1737             ("mock_dc", MagicMock()),
1738             ("mock_cl", MagicMock()),
1739             ("mock__get_cluster_dict", MagicMock()),
1740         )
1741         for attr, mock_obj in attrs:
1742             setattr(self, attr, mock_obj)
1743             self.addCleanup(delattr, self, attr)
1744         attrs = (("mock_get_cluster", MagicMock(return_value=self.mock_cl)),)
1745         for attr, mock_obj in attrs:
1746             setattr(self, attr, mock_obj)
1747             self.addCleanup(delattr, self, attr)
1748         patches = (
1749             (
1750                 "salt.utils.vmware.get_service_instance",
1751                 MagicMock(return_value=self.mock_si),
1752             ),
1753             (
1754                 "salt.modules.vsphere.get_proxy_type",
1755                 MagicMock(return_value="esxcluster"),
1756             ),
1757             (
1758                 "salt.modules.vsphere._get_proxy_target",
1759                 MagicMock(return_value=self.mock_cl),
1760             ),
1761             ("salt.utils.vmware.get_cluster", self.mock_get_cluster),
1762             ("salt.modules.vsphere._get_cluster_dict", self.mock__get_cluster_dict),
1763         )
1764         for module, mock_obj in patches:
1765             patcher = patch(module, mock_obj)
1766             patcher.start()
1767             self.addCleanup(patcher.stop)
1768         patcher = patch.dict(
1769             vsphere.__salt__,
1770             {"esxcluster.get_details": MagicMock(return_value={"cluster": "cl"})},
1771         )
1772         patcher.start()
1773         self.addCleanup(patcher.stop)
1774     def test_supported_proxies(self):
1775         supported_proxies = ["esxcluster", "esxdatacenter"]
1776         for proxy_type in supported_proxies:
1777             with patch(
1778                 "salt.modules.vsphere.get_proxy_type",
1779                 MagicMock(return_value=proxy_type),
1780             ):
1781                 vsphere.list_cluster(cluster="cl")
1782     def test_default_service_instance(self):
1783         mock__get_proxy_target = MagicMock()
1784         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
1785             vsphere.list_cluster()
1786         mock__get_proxy_target.assert_called_once_with(self.mock_si)
1787     def test_defined_service_instance(self):
1788         mock_si = MagicMock()
1789         mock__get_proxy_target = MagicMock()
1790         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
1791             vsphere.list_cluster(service_instance=mock_si)
1792         mock__get_proxy_target.assert_called_once_with(mock_si)
1793     def test_no_cluster_raises_argument_value_error(self):
1794         with patch(
1795             "salt.modules.vsphere.get_proxy_type",
1796             MagicMock(return_value="esxdatacenter"),
1797         ):
1798             with patch("salt.modules.vsphere._get_proxy_target", MagicMock()):
1799                 with self.assertRaises(ArgumentValueError) as excinfo:
1800                     vsphere.list_cluster()
1801         self.assertEqual(excinfo.exception.strerror, "'cluster' needs to be specified")
1802     def test_get_cluster_call(self):
1803         with patch(
1804             "salt.modules.vsphere.get_proxy_type",
1805             MagicMock(return_value="esxdatacenter"),
1806         ):
1807             with patch(
1808                 "salt.modules.vsphere._get_proxy_target",
1809                 MagicMock(return_value=self.mock_dc),
1810             ):
1811                 vsphere.list_cluster(cluster="cl")
1812         self.mock_get_cluster.assert_called_once_with(self.mock_dc, "cl")
1813     def test__get_cluster_dict_call(self):
1814         vsphere.list_cluster()
1815         self.mock__get_cluster_dict.assert_called_once_with("cl", self.mock_cl)
1816 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1817 class RenameDatastoreTestCase(TestCase, LoaderModuleMockMixin):
1818     def setup_loader_modules(self):
1819         return {
1820             vsphere: {
1821                 "_get_proxy_connection_details": MagicMock(),
1822                 "get_proxy_type": MagicMock(return_value="esxdatacenter"),
1823             }
1824         }
1825     def setUp(self):
1826         self.mock_si = MagicMock()
1827         self.mock_target = MagicMock()
1828         self.mock_ds_ref = MagicMock()
1829         self.mock_get_datastores = MagicMock(return_value=[self.mock_ds_ref])
1830         self.mock_rename_datastore = MagicMock()
1831         patches = (
1832             (
1833                 "salt.utils.vmware.get_service_instance",
1834                 MagicMock(return_value=self.mock_si),
1835             ),
1836             (
1837                 "salt.modules.vsphere._get_proxy_target",
1838                 MagicMock(return_value=self.mock_target),
1839             ),
1840             ("salt.utils.vmware.get_datastores", self.mock_get_datastores),
1841             ("salt.utils.vmware.rename_datastore", self.mock_rename_datastore),
1842         )
1843         for mod, mock in patches:
1844             patcher = patch(mod, mock)
1845             patcher.start()
1846             self.addCleanup(patcher.stop)
1847     def tearDown(self):
1848         for attr in (
1849             "mock_si",
1850             "mock_target",
1851             "mock_ds_ref",
1852             "mock_get_datastores",
1853             "mock_rename_datastore",
1854         ):
1855             delattr(self, attr)
1856     def test_supported_proxes(self):
1857         supported_proxies = ["esxi", "esxcluster", "esxdatacenter"]
1858         for proxy_type in supported_proxies:
1859             with patch(
1860                 "salt.modules.vsphere.get_proxy_type",
1861                 MagicMock(return_value=proxy_type),
1862             ):
1863                 vsphere.rename_datastore("current_ds_name", "new_ds_name")
1864     def test_default_service_instance(self):
1865         mock__get_proxy_target = MagicMock()
1866         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
1867             vsphere.rename_datastore("current_ds_name", "new_ds_name")
1868         mock__get_proxy_target.assert_called_once_with(self.mock_si)
1869     def test_defined_service_instance(self):
1870         mock_si = MagicMock()
1871         mock__get_proxy_target = MagicMock()
1872         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
1873             vsphere.rename_datastore(
1874                 "current_ds_name", "new_ds_name", service_instance=mock_si
1875             )
1876         mock__get_proxy_target.assert_called_once_with(mock_si)
1877     def test_get_datastore_call(self):
1878         vsphere.rename_datastore("current_ds_name", "new_ds_name")
1879         self.mock_get_datastores.assert_called_once_with(
1880             self.mock_si, self.mock_target, datastore_names=["current_ds_name"]
1881         )
1882     def test_get_no_datastores(self):
1883         with patch("salt.utils.vmware.get_datastores", MagicMock(return_value=[])):
1884             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
1885                 vsphere.rename_datastore("current_ds_name", "new_ds_name")
1886         self.assertEqual(
1887             excinfo.exception.strerror, "Datastore 'current_ds_name' was not found"
1888         )
1889     def test_rename_datastore_call(self):
1890         vsphere.rename_datastore("current_ds_name", "new_ds_name")
1891         self.mock_rename_datastore.assert_called_once_with(
1892             self.mock_ds_ref, "new_ds_name"
1893         )
1894 class _GetProxyTargetTestCase(TestCase, LoaderModuleMockMixin):
1895     def setup_loader_modules(self):
1896         return {
1897             vsphere: {
1898                 "_get_proxy_connection_details": MagicMock(),
1899                 "get_proxy_type": MagicMock(return_value="esxdatacenter"),
1900             }
1901         }
1902     def setUp(self):
1903         attrs = (
1904             ("mock_si", MagicMock()),
1905             ("mock_dc", MagicMock()),
1906             ("mock_cl", MagicMock()),
1907             ("mock_root", MagicMock()),
1908         )
1909         for attr, mock_obj in attrs:
1910             setattr(self, attr, mock_obj)
1911             self.addCleanup(delattr, self, attr)
1912         attrs = (
1913             ("mock_get_datacenter", MagicMock(return_value=self.mock_dc)),
1914             ("mock_get_cluster", MagicMock(return_value=self.mock_cl)),
1915             ("mock_get_root_folder", MagicMock(return_value=self.mock_root)),
1916         )
1917         for attr, mock_obj in attrs:
1918             setattr(self, attr, mock_obj)
1919             self.addCleanup(delattr, self, attr)
1920         patches = (
1921             (
1922                 "salt.modules.vsphere.get_proxy_type",
1923                 MagicMock(return_value="esxcluster"),
1924             ),
1925             (
1926                 "salt.utils.vmware.is_connection_to_a_vcenter",
1927                 MagicMock(return_value=True),
1928             ),
1929             (
1930                 "salt.modules.vsphere._get_esxcluster_proxy_details",
1931                 MagicMock(
1932                     return_value=(
1933                         None,
1934                         None,
1935                         None,
1936                         None,
1937                         None,
1938                         None,
1939                         None,
1940                         None,
1941                         "datacenter",
1942                         "cluster",
1943                     )
1944                 ),
1945             ),
1946             (
1947                 "salt.modules.vsphere._get_esxdatacenter_proxy_details",
1948                 MagicMock(
1949                     return_value=(
1950                         None,
1951                         None,
1952                         None,
1953                         None,
1954                         None,
1955                         None,
1956                         None,
1957                         None,
1958                         "datacenter",
1959                     )
1960                 ),
1961             ),
1962             ("salt.utils.vmware.get_datacenter", self.mock_get_datacenter),
1963             ("salt.utils.vmware.get_cluster", self.mock_get_cluster),
1964             ("salt.utils.vmware.get_root_folder", self.mock_get_root_folder),
1965         )
1966         for module, mock_obj in patches:
1967             patcher = patch(module, mock_obj)
1968             patcher.start()
1969             self.addCleanup(patcher.stop)
1970     def test_supported_proxies(self):
1971         supported_proxies = ["esxcluster", "esxdatacenter"]
1972         for proxy_type in supported_proxies:
1973             with patch(
1974                 "salt.modules.vsphere.get_proxy_type",
1975                 MagicMock(return_value=proxy_type),
1976             ):
1977                 vsphere._get_proxy_target(self.mock_si)
1978     def test_connected_to_esxi(self):
1979         with patch(
1980             "salt.utils.vmware.is_connection_to_a_vcenter",
1981             MagicMock(return_value=False),
1982         ):
1983             with self.assertRaises(CommandExecutionError) as excinfo:
1984                 vsphere._get_proxy_target(self.mock_si)
1985             self.assertEqual(
1986                 excinfo.exception.strerror,
1987                 "'_get_proxy_target' not supported when connected via the ESXi host",
1988             )
1989     def test_get_cluster_call(self):
1990         vsphere._get_proxy_target(self.mock_si)
1991         self.mock_get_datacenter.assert_called_once_with(self.mock_si, "datacenter")
1992         self.mock_get_cluster.assert_called_once_with(self.mock_dc, "cluster")
1993     def test_esxcluster_proxy_return(self):
1994         with patch(
1995             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxcluster")
1996         ):
1997             ret = vsphere._get_proxy_target(self.mock_si)
1998         self.assertEqual(ret, self.mock_cl)
1999     def test_get_datacenter_call(self):
2000         with patch(
2001             "salt.modules.vsphere.get_proxy_type",
2002             MagicMock(return_value="esxdatacenter"),
2003         ):
2004             vsphere._get_proxy_target(self.mock_si)
2005         self.mock_get_datacenter.assert_called_once_with(self.mock_si, "datacenter")
2006         self.assertEqual(self.mock_get_cluster.call_count, 0)
2007     def test_esxdatacenter_proxy_return(self):
2008         with patch(
2009             "salt.modules.vsphere.get_proxy_type",
2010             MagicMock(return_value="esxdatacenter"),
2011         ):
2012             ret = vsphere._get_proxy_target(self.mock_si)
2013         self.assertEqual(ret, self.mock_dc)
2014     def test_vcenter_proxy_return(self):
2015         with patch(
2016             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="vcenter")
2017         ):
2018             ret = vsphere._get_proxy_target(self.mock_si)
2019         self.mock_get_root_folder.assert_called_once_with(self.mock_si)
2020         self.assertEqual(ret, self.mock_root)
2021 @skipIf(not HAS_VSPHERE_SDK, "The 'vsphere-automation-sdk' library is missing")
2022 class TestVSphereTagging(TestCase, LoaderModuleMockMixin):
2023     def setup_loader_modules(self):
2024         return {
2025             vsphere: {
2026                 "_get_proxy_connection_details": MagicMock(),
2027                 "get_proxy_type": MagicMock(return_value="vcenter"),
2028             }
2029         }
2030     details = {key: None for key in ["vcenter", "username", "password"]}
2031     func_attrs = {
2032         key: None
2033         for key in [
2034             "category_id",
2035             "object_id",
2036             "tag_id",
2037             "name",
2038             "description",
2039             "cardinality",
2040         ]
2041     }
2042     create_tag_category = {
2043         "Category created": (
2044             "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL"
2045         )
2046     }
2047     create_tag = {
2048         "Tag created": (
2049             "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL"
2050         )
2051     }
2052     delete_tag_category = {
2053         "Category deleted": (
2054             "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL"
2055         )
2056     }
2057     delete_tag = {
2058         "Tag deleted": (
2059             "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL"
2060         )
2061     }
2062     list_tag_categories_return = [
2063         "urn:vmomi:InventoryServiceCategory:"
2064         "b13f4959-a3f3-48d0-8080-15bb586b4355:GLOBAL",
2065         "urn:vmomi:InventoryServiceCategory:"
2066         "f4d41f02-c317-422d-9013-dcbebfcd54ad:GLOBAL",
2067         "urn:vmomi:InventoryServiceCategory:"
2068         "2db5b00b-f211-4bba-ba42-e2658ebbb283:GLOBAL",
2069         "urn:vmomi:InventoryServiceCategory:"
2070         "cd847c3c-687c-4bd9-8e5a-0eb536f0a01d:GLOBAL",
2071         "urn:vmomi:InventoryServiceCategory:"
2072         "d51c24f9-cffb-4ce0-af56-7f18b6e649af:GLOBAL",
2073     ]
2074     list_tags_return = [
2075         "urn:vmomi:InventoryServiceTag:a584a83b-3015-45ad-8057-a3630613052f:GLOBAL",
2076         "urn:vmomi:InventoryServiceTag:db08019c-15de-4bbf-be46-d81aaf8d25c0:GLOBAL",
2077         "urn:vmomi:InventoryServiceTag:b55ecc77-f4a5-49f8-ab52-38865467cfbe:GLOBAL",
2078         "urn:vmomi:InventoryServiceTag:f009ab1b-e1b5-4c40-b8f7-951d9d716b39:GLOBAL",
2079         "urn:vmomi:InventoryServiceTag:102bb4c5-9b76-4d6c-882a-76a91ee3edcc:GLOBAL",
2080         "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL",
2081         "urn:vmomi:InventoryServiceTag:71d30f2d-bb23-48e1-995f-630adfb0dc89:GLOBAL",
2082     ]
2083     list_attached_tags_return = [
2084         "urn:vmomi:InventoryServiceTag:b55ecc77-f4a5-49f8-ab52-38865467cfbe:GLOBAL",
2085         "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL",
2086     ]
2087     list_create_category_return = [
2088         "urn:vmomi:InventoryServiceCategory:0af54c2d-e8cd-4248-931e-2f5807d8c477:GLOBAL"
2089     ]
2090     list_create_tag_return = [
2091         "urn:vmomi:InventoryServiceCategory:0af54c2d-e8cd-4248-931e-2f5807d8c477:GLOBAL"
2092     ]
2093     attach_tags_return = {
2094         "Tag attached": (
2095             "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL"
2096         )
2097     }
2098     def test_create_tag_category_client_none(self):
2099         get_details = MagicMock(return_value=self.details)
2100         with patch.object(
2101             vsphere, "get_proxy_type", return_value="vcenter"
2102         ) as get_proxy_type:
2103             with patch.object(
2104                 vsphere, "_get_proxy_connection_details", return_value=[]
2105             ) as get_proxy_connection:
2106                 with patch.object(
2107                     salt.utils.vmware, "get_service_instance", return_value=None
2108                 ) as get_service_instance:
2109                     with patch.dict(
2110                         vsphere.__salt__,
2111                         {"vcenter.get_details": get_details},
2112                         clear=True,
2113                     ) as get_vcenter_details:
2114                         with patch.object(
2115                             salt.utils.vmware, "get_vsphere_client", return_value=None
2116                         ) as get_vsphere_client:
2117                             ret = vsphere.create_tag_category(
2118                                 self.func_attrs["name"],
2119                                 self.func_attrs["description"],
2120                                 self.func_attrs["cardinality"],
2121                             )
2122                             get_proxy_type.assert_called_once()
2123                             get_proxy_connection.assert_called_once()
2124                             get_service_instance.assert_called_once()
2125                             get_vsphere_client.assert_called_once()
2126                             self.assertEqual(ret, {"Category created": None})
2127     def test_create_tag_category_client(self):
2128         for verify_ssl in [True, False, None]:
2129             details = self.details.copy()
2130             if verify_ssl is None:
2131                 verify_ssl = True
2132             else:
2133                 details["verify_ssl"] = verify_ssl
2134             get_details = MagicMock(return_value=details)
2135             mock_client = Mock(
2136                 tagging=Mock(
2137                     Category=Mock(
2138                         CreateSpec=Mock(return_value=Mock()),
2139                         create=Mock(
2140                             return_value=self.create_tag_category["Category created"]
2141                         ),
2142                     )
2143                 )
2144             )
2145             with patch.object(
2146                 vsphere, "get_proxy_type", return_value="vcenter"
2147             ) as get_proxy_type:
2148                 with patch.object(
2149                     vsphere, "_get_proxy_connection_details", return_value=[]
2150                 ) as get_proxy_connection:
2151                     with patch.object(
2152                         salt.utils.vmware, "get_service_instance", return_value=None
2153                     ) as get_service_instance:
2154                         with patch.dict(
2155                             vsphere.__salt__,
2156                             {"vcenter.get_details": get_details},
2157                             clear=True,
2158                         ) as get_vcenter_details:
2159                             with patch.object(
2160                                 salt.utils.vmware,
2161                                 "get_vsphere_client",
2162                                 return_value=mock_client,
2163                             ) as get_vsphere_client:
2164                                 ret = vsphere.create_tag_category(
2165                                     self.func_attrs["name"],
2166                                     self.func_attrs["description"],
2167                                     self.func_attrs["cardinality"],
2168                                 )
2169                                 get_proxy_type.assert_called_once()
2170                                 get_proxy_connection.assert_called_once()
2171                                 get_service_instance.assert_called_once()
2172                                 get_vsphere_client.assert_called_once()
2173                                 self.assertEqual(ret, self.create_tag_category)
2174                                 self.assertEqual(
2175                                     get_vsphere_client.call_args_list,
2176                                     [
2177                                         call(
2178                                             ca_bundle=None,
2179                                             password=None,
2180                                             server=None,
2181                                             username=None,
2182                                             verify_ssl=verify_ssl,
2183                                         )
2184                                     ],
2185                                 )
2186     def test_create_tag_client_none(self):
2187         get_details = MagicMock(return_value=self.details)
2188         with patch.object(
2189             vsphere, "get_proxy_type", return_value="vcenter"
2190         ) as get_proxy_type:
2191             with patch.object(
2192                 vsphere, "_get_proxy_connection_details", return_value=[]
2193             ) as get_proxy_connection:
2194                 with patch.object(
2195                     salt.utils.vmware, "get_service_instance", return_value=None
2196                 ) as get_service_instance:
2197                     with patch.dict(
2198                         vsphere.__salt__,
2199                         {"vcenter.get_details": get_details},
2200                         clear=True,
2201                     ) as get_vcenter_details:
2202                         with patch.object(
2203                             salt.utils.vmware, "get_vsphere_client", return_value=None
2204                         ) as get_vsphere_client:
2205                             ret = vsphere.create_tag(
2206                                 self.func_attrs["name"],
2207                                 self.func_attrs["description"],
2208                                 self.func_attrs["cardinality"],
2209                             )
2210                             get_proxy_type.assert_called_once()
2211                             get_proxy_connection.assert_called_once()
2212                             get_service_instance.assert_called_once()
2213                             get_vsphere_client.assert_called_once()
2214                             self.assertEqual(ret, {"Tag created": None})
2215     def test_create_tag_client(self):
2216         get_details = MagicMock(return_value=self.details)
2217         mock_client = Mock(
2218             tagging=Mock(
2219                 Tag=Mock(
2220                     CreateSpec=Mock(return_value=Mock()),
2221                     create=Mock(return_value=self.create_tag["Tag created"]),
2222                 )
2223             )
2224         )
2225         with patch.object(
2226             vsphere, "get_proxy_type", return_value="vcenter"
2227         ) as get_proxy_type:
2228             with patch.object(
2229                 vsphere, "_get_proxy_connection_details", return_value=[]
2230             ) as get_proxy_connection:
2231                 with patch.object(
2232                     salt.utils.vmware, "get_service_instance", return_value=None
2233                 ) as get_service_instance:
2234                     with patch.dict(
2235                         vsphere.__salt__,
2236                         {"vcenter.get_details": get_details},
2237                         clear=True,
2238                     ) as get_vcenter_details:
2239                         with patch.object(
2240                             salt.utils.vmware,
2241                             "get_vsphere_client",
2242                             return_value=mock_client,
2243                         ) as get_vsphere_client:
2244                             ret = vsphere.create_tag(
2245                                 self.func_attrs["name"],
2246                                 self.func_attrs["description"],
2247                                 self.func_attrs["cardinality"],
2248                             )
2249                             get_proxy_type.assert_called_once()
2250                             get_proxy_connection.assert_called_once()
2251                             get_service_instance.assert_called_once()
2252                             get_vsphere_client.assert_called_once()
2253                             self.assertEqual(ret, self.create_tag)
2254     def test_delete_tag_category_client_none(self):
2255         get_details = MagicMock(return_value=self.details)
2256         with patch.object(
2257             vsphere, "get_proxy_type", return_value="vcenter"
2258         ) as get_proxy_type:
2259             with patch.object(
2260                 vsphere, "_get_proxy_connection_details", return_value=[]
2261             ) as get_proxy_connection:
2262                 with patch.object(
2263                     salt.utils.vmware, "get_service_instance", return_value=None
2264                 ) as get_service_instance:
2265                     with patch.dict(
2266                         vsphere.__salt__,
2267                         {"vcenter.get_details": get_details},
2268                         clear=True,
2269                     ) as get_vcenter_details:
2270                         with patch.object(
2271                             salt.utils.vmware, "get_vsphere_client", return_value=None
2272                         ) as get_vsphere_client:
2273                             ret = vsphere.delete_tag_category(
2274                                 self.func_attrs["category_id"]
2275                             )
2276                             get_proxy_type.assert_called_once()
2277                             get_proxy_connection.assert_called_once()
2278                             get_service_instance.assert_called_once()
2279                             get_vsphere_client.assert_called_once()
2280                             self.assertEqual(ret, {"Category deleted": None})
2281     def test_delete_tag_category_client(self):
2282         for verify_ssl in [True, False, None]:
2283             details = self.details.copy()
2284             if verify_ssl is None:
2285                 verify_ssl = True
2286             else:
2287                 details["verify_ssl"] = verify_ssl
2288             get_details = MagicMock(return_value=details)
2289             mock_client = Mock(
2290                 tagging=Mock(
2291                     Category=Mock(
2292                         delete=Mock(
2293                             return_value=self.delete_tag_category["Category deleted"]
2294                         )
2295                     )
2296                 )
2297             )
2298             with patch.object(
2299                 vsphere, "get_proxy_type", return_value="vcenter"
2300             ) as get_proxy_type:
2301                 with patch.object(
2302                     vsphere, "_get_proxy_connection_details", return_value=[]
2303                 ) as get_proxy_connection:
2304                     with patch.object(
2305                         salt.utils.vmware, "get_service_instance", return_value=None
2306                     ) as get_service_instance:
2307                         with patch.dict(
2308                             vsphere.__salt__,
2309                             {"vcenter.get_details": get_details},
2310                             clear=True,
2311                         ) as get_vcenter_details:
2312                             with patch.object(
2313                                 salt.utils.vmware,
2314                                 "get_vsphere_client",
2315                                 return_value=mock_client,
2316                             ) as get_vsphere_client:
2317                                 ret = vsphere.delete_tag_category(
2318                                     self.func_attrs["category_id"]
2319                                 )
2320                                 get_proxy_type.assert_called_once()
2321                                 get_proxy_connection.assert_called_once()
2322                                 get_service_instance.assert_called_once()
2323                                 get_vsphere_client.assert_called_once()
2324                                 self.assertEqual(ret, self.delete_tag_category)
2325                                 self.assertEqual(
2326                                     get_vsphere_client.call_args_list,
2327                                     [
2328                                         call(
2329                                             ca_bundle=None,
2330                                             password=None,
2331                                             server=None,
2332                                             username=None,
2333                                             verify_ssl=verify_ssl,
2334                                         )
2335                                     ],
2336                                 )
2337     def test_delete_tag_client_none(self):
2338         get_details = MagicMock(return_value=self.details)
2339         with patch.object(
2340             vsphere, "get_proxy_type", return_value="vcenter"
2341         ) as get_proxy_type:
2342             with patch.object(
2343                 vsphere, "_get_proxy_connection_details", return_value=[]
2344             ) as get_proxy_connection:
2345                 with patch.object(
2346                     salt.utils.vmware, "get_service_instance", return_value=None
2347                 ) as get_service_instance:
2348                     with patch.dict(
2349                         vsphere.__salt__,
2350                         {"vcenter.get_details": get_details},
2351                         clear=True,
2352                     ) as get_vcenter_details:
2353                         with patch.object(
2354                             salt.utils.vmware, "get_vsphere_client", return_value=None
2355                         ) as get_vsphere_client:
2356                             ret = vsphere.delete_tag(self.func_attrs["tag_id"])
2357                             get_proxy_type.assert_called_once()
2358                             get_proxy_connection.assert_called_once()
2359                             get_service_instance.assert_called_once()
2360                             get_vsphere_client.assert_called_once()
2361                             self.assertEqual(ret, {"Tag deleted": None})
2362     def test_delete_tag_client(self):
2363         get_details = MagicMock(return_value=self.details)
2364         mock_client = Mock(
2365             tagging=Mock(
2366                 Tag=Mock(delete=Mock(return_value=self.delete_tag["Tag deleted"]))
2367             )
2368         )
2369         with patch.object(
2370             vsphere, "get_proxy_type", return_value="vcenter"
2371         ) as get_proxy_type:
2372             with patch.object(
2373                 vsphere, "_get_proxy_connection_details", return_value=[]
2374             ) as get_proxy_connection:
2375                 with patch.object(
2376                     salt.utils.vmware, "get_service_instance", return_value=None
2377                 ) as get_service_instance:
2378                     with patch.dict(
2379                         vsphere.__salt__,
2380                         {"vcenter.get_details": get_details},
2381                         clear=True,
2382                     ) as get_vcenter_details:
2383                         with patch.object(
2384                             salt.utils.vmware,
2385                             "get_vsphere_client",
2386                             return_value=mock_client,
2387                         ) as get_vsphere_client:
2388                             ret = vsphere.delete_tag(self.func_attrs["tag_id"])
2389                             get_proxy_type.assert_called_once()
2390                             get_proxy_connection.assert_called_once()
2391                             get_service_instance.assert_called_once()
2392                             get_vsphere_client.assert_called_once()
2393                             self.assertEqual(ret, self.delete_tag)
2394     def test_list_tag_categories_client_none(self):
2395         get_details = MagicMock(return_value=self.details)
2396         with patch.object(
2397             vsphere, "get_proxy_type", return_value="vcenter"
2398         ) as get_proxy_type:
2399             with patch.object(
2400                 vsphere, "_get_proxy_connection_details", return_value=[]
2401             ) as get_proxy_connection:
2402                 with patch.object(
2403                     salt.utils.vmware, "get_service_instance", return_value=None
2404                 ) as get_service_instance:
2405                     with patch.dict(
2406                         vsphere.__salt__,
2407                         {"vcenter.get_details": get_details},
2408                         clear=True,
2409                     ) as get_vcenter_details:
2410                         with patch.object(
2411                             salt.utils.vmware, "get_vsphere_client", return_value=None
2412                         ) as get_vsphere_client:
2413                             ret = vsphere.list_tag_categories()
2414                             get_proxy_type.assert_called_once()
2415                             get_proxy_connection.assert_called_once()
2416                             get_service_instance.assert_called_once()
2417                             get_vsphere_client.assert_called_once()
2418                             self.assertEqual(ret, {"Categories": None})
2419     def test_list_tag_categories_client(self):
2420         for verify_ssl in [True, False, None]:
2421             details = self.details.copy()
2422             if verify_ssl is not None:
2423                 details["verify_ssl"] = verify_ssl
2424             else:
2425                 verify_ssl = True
2426             get_details = MagicMock(return_value=details)
2427             mock_client = Mock(
2428                 tagging=Mock(
2429                     Category=Mock(
2430                         list=Mock(return_value=self.list_tag_categories_return)
2431                     )
2432                 )
2433             )
2434             with patch.object(
2435                 vsphere, "get_proxy_type", return_value="vcenter"
2436             ) as get_proxy_type:
2437                 with patch.object(
2438                     vsphere, "_get_proxy_connection_details", return_value=[]
2439                 ) as get_proxy_connection:
2440                     with patch.object(
2441                         salt.utils.vmware, "get_service_instance", return_value=None
2442                     ) as get_service_instance:
2443                         with patch.dict(
2444                             vsphere.__salt__,
2445                             {"vcenter.get_details": get_details},
2446                             clear=True,
2447                         ) as get_vcenter_details:
2448                             with patch.object(
2449                                 salt.utils.vmware,
2450                                 "get_vsphere_client",
2451                                 return_value=mock_client,
2452                             ) as get_vsphere_client:
2453                                 ret = vsphere.list_tag_categories()
2454                                 get_proxy_type.assert_called_once()
2455                                 get_proxy_connection.assert_called_once()
2456                                 get_service_instance.assert_called_once()
2457                                 get_vsphere_client.assert_called_once()
2458                                 self.assertEqual(
2459                                     get_vsphere_client.call_args_list,
2460                                     [
2461                                         call(
2462                                             ca_bundle=None,
2463                                             password=None,
2464                                             server=None,
2465                                             username=None,
2466                                             verify_ssl=verify_ssl,
2467                                         )
2468                                     ],
2469                                 )
2470                                 self.assertEqual(
2471                                     ret, {"Categories": self.list_tag_categories_return}
2472                                 )
2473     def test_list_tags_client_none(self):
2474         get_details = MagicMock(return_value=self.details)
2475         with patch.object(
2476             vsphere, "get_proxy_type", return_value="vcenter"
2477         ) as get_proxy_type:
2478             with patch.object(
2479                 vsphere, "_get_proxy_connection_details", return_value=[]
2480             ) as get_proxy_connection:
2481                 with patch.object(
2482                     salt.utils.vmware, "get_service_instance", return_value=None
2483                 ) as get_service_instance:
2484                     with patch.dict(
2485                         vsphere.__salt__,
2486                         {"vcenter.get_details": get_details},
2487                         clear=True,
2488                     ) as get_vcenter_details:
2489                         with patch.object(
2490                             salt.utils.vmware, "get_vsphere_client", return_value=None
2491                         ) as get_vsphere_client:
2492                             ret = vsphere.list_tags()
2493                             get_proxy_type.assert_called_once()
2494                             get_proxy_connection.assert_called_once()
2495                             get_service_instance.assert_called_once()
2496                             get_vsphere_client.assert_called_once()
2497                             self.assertEqual(ret, {"Tags": None})
2498     def test_list_tags_client(self):
2499         get_details = MagicMock(return_value=self.details)
2500         mock_client = Mock(
2501             tagging=Mock(Tag=Mock(list=Mock(return_value=self.list_tags_return)))
2502         )
2503         with patch.object(
2504             vsphere, "get_proxy_type", return_value="vcenter"
2505         ) as get_proxy_type:
2506             with patch.object(
2507                 vsphere, "_get_proxy_connection_details", return_value=[]
2508             ) as get_proxy_connection:
2509                 with patch.object(
2510                     salt.utils.vmware, "get_service_instance", return_value=None
2511                 ) as get_service_instance:
2512                     with patch.dict(
2513                         vsphere.__salt__,
2514                         {"vcenter.get_details": get_details},
2515                         clear=True,
2516                     ) as get_vcenter_details:
2517                         with patch.object(
2518                             salt.utils.vmware,
2519                             "get_vsphere_client",
2520                             return_value=mock_client,
2521                         ) as get_vsphere_client:
2522                             ret = vsphere.list_tags()
2523                             get_proxy_type.assert_called_once()
2524                             get_proxy_connection.assert_called_once()
2525                             get_service_instance.assert_called_once()
2526                             get_vsphere_client.assert_called_once()
2527                             self.assertEqual(ret, {"Tags": self.list_tags_return})
2528     def test_list_tags_client_verify_ssl(self):
2529         for verify_ssl in [True, False]:
2530             details = self.details.copy()
2531             if verify_ssl is not None:
2532                 details["verify_ssl"] = verify_ssl
2533             else:
2534                 verify_ssl = True
2535             get_details = MagicMock(return_value=details)
2536             mock_client = Mock(
2537                 tagging=Mock(Tag=Mock(list=Mock(return_value=self.list_tags_return)))
2538             )
2539             with patch.object(
2540                 vsphere, "get_proxy_type", return_value="vcenter"
2541             ) as get_proxy_type:
2542                 with patch.object(
2543                     vsphere, "_get_proxy_connection_details", return_value=[]
2544                 ) as get_proxy_connection:
2545                     with patch.object(
2546                         salt.utils.vmware, "get_service_instance", return_value=None
2547                     ) as get_service_instance:
2548                         with patch.dict(
2549                             vsphere.__salt__,
2550                             {"vcenter.get_details": get_details},
2551                             clear=True,
2552                         ) as get_vcenter_details:
2553                             with patch.object(
2554                                 salt.utils.vmware,
2555                                 "get_vsphere_client",
2556                                 return_value=mock_client,
2557                             ) as get_vsphere_client:
2558                                 ret = vsphere.list_tags()
2559                                 self.assertEqual(ret, {"Tags": self.list_tags_return})
2560                                 self.assertEqual(
2561                                     get_vsphere_client.call_args_list,
2562                                     [
2563                                         call(
2564                                             ca_bundle=None,
2565                                             password=None,
2566                                             server=None,
2567                                             username=None,
2568                                             verify_ssl=verify_ssl,
2569                                         )
2570                                     ],
2571                                 )
2572     def test_list_attached_tags_client_none(self):
2573         get_details = MagicMock(return_value=self.details)
2574         with patch.object(
2575             vsphere, "get_proxy_type", return_value="vcenter"
2576         ) as get_proxy_type:
2577             with patch.object(
2578                 vsphere, "_get_proxy_connection_details", return_value=[]
2579             ) as get_proxy_connection:
2580                 with patch.object(
2581                     salt.utils.vmware, "get_service_instance", return_value=None
2582                 ) as get_service_instance:
2583                     with patch.dict(
2584                         vsphere.__salt__,
2585                         {"vcenter.get_details": get_details},
2586                         clear=True,
2587                     ) as get_vcenter_details:
2588                         with patch.object(
2589                             salt.utils.vmware, "get_vsphere_client", return_value=None
2590                         ) as get_vsphere_client:
2591                             with patch.object(vsphere, "DynamicID") as dynamic_id:
2592                                 ret = vsphere.list_attached_tags("object_id")
2593                                 get_proxy_type.assert_called_once()
2594                                 get_proxy_connection.assert_called_once()
2595                                 get_service_instance.assert_called_once()
2596                                 get_vsphere_client.assert_called_once()
2597                                 self.assertEqual(ret, {"Attached tags": None})
2598     def test_list_attached_tags_client(self):
2599         for verify_ssl in [True, False, None]:
2600             details = self.details.copy()
2601             if verify_ssl is None:
2602                 verify_ssl = True
2603             else:
2604                 details["verify_ssl"] = verify_ssl
2605             get_details = MagicMock(return_value=details)
2606             mock_client = Mock(
2607                 tagging=Mock(
2608                     TagAssociation=Mock(
2609                         list_attached_tags=Mock(
2610                             return_value=self.list_attached_tags_return
2611                         )
2612                     )
2613                 )
2614             )
2615             with patch.object(
2616                 vsphere, "get_proxy_type", return_value="vcenter"
2617             ) as get_proxy_type:
2618                 with patch.object(
2619                     vsphere, "_get_proxy_connection_details", return_value=[]
2620                 ) as get_proxy_connection:
2621                     with patch.object(
2622                         salt.utils.vmware, "get_service_instance", return_value=None
2623                     ) as get_service_instance:
2624                         with patch.dict(
2625                             vsphere.__salt__,
2626                             {"vcenter.get_details": get_details},
2627                             clear=True,
2628                         ) as get_vcenter_details:
2629                             with patch.object(
2630                                 salt.utils.vmware,
2631                                 "get_vsphere_client",
2632                                 return_value=mock_client,
2633                             ) as get_vsphere_client:
2634                                 with patch.object(vsphere, "DynamicID") as dynamic_id:
2635                                     ret = vsphere.list_attached_tags(
2636                                         self.func_attrs["object_id"]
2637                                     )
2638                                     get_proxy_type.assert_called_once()
2639                                     get_proxy_connection.assert_called_once()
2640                                     get_service_instance.assert_called_once()
2641                                     get_vsphere_client.assert_called_once()
2642                                     self.assertEqual(
2643                                         ret,
2644                                         {
2645                                             "Attached tags": self.list_attached_tags_return
2646                                         },
2647                                     )
2648                                     self.assertEqual(
2649                                         get_vsphere_client.call_args_list,
2650                                         [
2651                                             call(
2652                                                 ca_bundle=None,
2653                                                 password=None,
2654                                                 server=None,
2655                                                 username=None,
2656                                                 verify_ssl=verify_ssl,
2657                                             )
2658                                         ],
2659                                     )
2660     def test_attach_tags_client_none(self):
2661         get_details = MagicMock(return_value=self.details)
2662         with patch.object(
2663             vsphere, "get_proxy_type", return_value="vcenter"
2664         ) as get_proxy_type:
2665             with patch.object(
2666                 vsphere, "_get_proxy_connection_details", return_value=[]
2667             ) as get_proxy_connection:
2668                 with patch.object(
2669                     salt.utils.vmware, "get_service_instance", return_value=None
2670                 ) as get_service_instance:
2671                     with patch.dict(
2672                         vsphere.__salt__,
2673                         {"vcenter.get_details": get_details},
2674                         clear=True,
2675                     ) as get_vcenter_details:
2676                         with patch.object(
2677                             salt.utils.vmware, "get_vsphere_client", return_value=None
2678                         ) as get_vsphere_client:
2679                             ret = vsphere.attach_tag(
2680                                 object_id=self.func_attrs["object_id"],
2681                                 tag_id=self.func_attrs["tag_id"],
2682                             )
2683                             get_proxy_type.assert_called_once()
2684                             get_proxy_connection.assert_called_once()
2685                             get_service_instance.assert_called_once()
2686                             get_vsphere_client.assert_called_once()
2687                             self.assertEqual(ret, {"Tag attached": None})
2688     def test_attach_tags_client(self):
2689         for verify_ssl in [True, False, None]:
2690             details = self.details.copy()
2691             if verify_ssl is None:
2692                 verify_ssl = True
2693             else:
2694                 details["verify_ssl"] = verify_ssl
2695             get_details = MagicMock(return_value=details)
2696             mock_client = Mock(
2697                 tagging=Mock(
2698                     TagAssociation=Mock(
2699                         attach=Mock(return_value=self.list_attached_tags_return)
2700                     )
2701                 )
2702             )
2703             with patch.object(
2704                 vsphere, "get_proxy_type", return_value="vcenter"
2705             ) as get_proxy_type:
2706                 with patch.object(
2707                     vsphere, "_get_proxy_connection_details", return_value=[]
2708                 ) as get_proxy_connection:
2709                     with patch.object(
2710                         salt.utils.vmware, "get_service_instance", return_value=None
2711                     ) as get_service_instance:
2712                         with patch.dict(
2713                             vsphere.__salt__,
2714                             {"vcenter.get_details": get_details},
2715                             clear=True,
2716                         ) as get_vcenter_details:
2717                             with patch.object(
2718                                 salt.utils.vmware,
2719                                 "get_vsphere_client",
2720                                 return_value=mock_client,
2721                             ) as get_vsphere_client:
2722                                 with patch.object(vsphere, "DynamicID") as dynamic_id:
2723                                     ret = vsphere.attach_tag(
2724                                         object_id=self.func_attrs["object_id"],
2725                                         tag_id=self.func_attrs["tag_id"],
2726                                     )
2727                                     get_proxy_type.assert_called_once()
2728                                     get_proxy_connection.assert_called_once()
2729                                     get_service_instance.assert_called_once()
2730                                     get_vsphere_client.assert_called_once()
2731                                     self.assertEqual(
2732                                         get_vsphere_client.call_args_list,
2733                                         [
2734                                             call(
2735                                                 ca_bundle=None,
2736                                                 password=None,
2737                                                 server=None,
2738                                                 username=None,
2739                                                 verify_ssl=verify_ssl,
2740                                             )
2741                                         ],
2742                                     )
2743                                     self.assertEqual(
2744                                         ret,
2745                                         {
2746                                             "Tag attached": self.list_attached_tags_return
2747                                         },
2748                                     )
2749     def test_get_client(self):
2750         mock_client = MagicMock(return_value=None)
2751         patch_client = patch("salt.utils.vmware.get_vsphere_client", mock_client)
2752         cert_path = "/test/ca-certificates.crt"
2753         mock_ca = MagicMock(return_value=cert_path)
2754         patch_ca = patch("salt.utils.http.get_ca_bundle", mock_ca)
2755         mock_details = MagicMock(return_value=self.details)
2756         patch_details = patch.dict(
2757             vsphere.__salt__, {"vcenter.get_details": mock_details}
2758         )
2759         with patch_client, patch_ca, patch_details:
2760             vsphere._get_client(
2761                 server="localhost", username="testuser", password="testpassword"
2762             )
2763             self.assertEqual(
2764                 mock_client.call_args_list,
2765                 [
2766                     call(
2767                         ca_bundle=None,
2768                         password="testpassword",
2769                         server="localhost",
2770                         username="testuser",
2771                         verify_ssl=True,
2772                     )
2773                 ],
2774             )
2775             self.assertEqual(mock_details.assert_called_once(), None)
2776             self.assertEqual(mock_ca.assert_not_called(), None)
2777     def test_get_client_verify_ssl_false(self):
2778         details = self.details.copy()
2779         details["verify_ssl"] = False
2780         mock_client = MagicMock(return_value=None)
2781         patch_client = patch("salt.utils.vmware.get_vsphere_client", mock_client)
2782         cert_path = "/test/ca-certificates.crt"
2783         mock_ca = MagicMock(return_value=cert_path)
2784         patch_ca = patch("salt.utils.http.get_ca_bundle", mock_ca)
2785         mock_details = MagicMock(return_value=details)
2786         patch_details = patch.dict(
2787             vsphere.__salt__, {"vcenter.get_details": mock_details}
2788         )
2789         with patch_client, patch_ca, patch_details:
2790             vsphere._get_client(
2791                 server="localhost", username="testuser", password="testpassword"
2792             )
2793             self.assertEqual(
2794                 mock_client.call_args_list,
2795                 [
2796                     call(
2797                         ca_bundle=None,
2798                         password="testpassword",
2799                         server="localhost",
2800                         username="testuser",
2801                         verify_ssl=False,
2802                     )
2803                 ],
2804             )
2805             self.assertEqual(mock_details.assert_called_once(), None)
2806             self.assertEqual(mock_ca.assert_not_called(), None)
2807     def test_get_client_verify_ssl_false_ca_bundle(self):
2808         details = self.details.copy()
2809         details["verify_ssl"] = False
2810         details["ca_bundle"] = "/tmp/test"
2811         mock_client = MagicMock(return_value=None)
2812         patch_client = patch("salt.utils.vmware.get_vsphere_client", mock_client)
2813         cert_path = "/test/ca-certificates.crt"
2814         mock_ca = MagicMock(return_value=cert_path)
2815         patch_ca = patch("salt.utils.http.get_ca_bundle", mock_ca)
2816         mock_details = MagicMock(return_value=details)
2817         patch_details = patch.dict(
2818             vsphere.__salt__, {"vcenter.get_details": mock_details}
2819         )
2820         with patch_client, patch_ca, patch_details:
2821             self.assertFalse(
2822                 vsphere._get_client(
2823                     server="localhost", username="testuser", password="testpassword"
2824                 )
2825             )
2826             self.assertEqual(mock_details.assert_called_once(), None)
2827             self.assertEqual(mock_ca.assert_not_called(), None)
2828     def test_get_client_ca_bundle(self):
2829         cert_path = "/test/ca-certificates.crt"
2830         details = self.details.copy()
2831         details["ca_bundle"] = cert_path
2832         mock_client = MagicMock(return_value=None)
2833         patch_client = patch("salt.utils.vmware.get_vsphere_client", mock_client)
2834         mock_ca = MagicMock(return_value=cert_path)
2835         patch_ca = patch("salt.utils.http.get_ca_bundle", mock_ca)
2836         mock_details = MagicMock(return_value=details)
2837         patch_details = patch.dict(
2838             vsphere.__salt__, {"vcenter.get_details": mock_details}
2839         )
2840         with patch_client, patch_ca, patch_details:
2841             vsphere._get_client(
2842                 server="localhost", username="testuser", password="testpassword"
2843             )
2844             self.assertEqual(
2845                 mock_client.call_args_list,
2846                 [
2847                     call(
2848                         ca_bundle=cert_path,
2849                         password="testpassword",
2850                         server="localhost",
2851                         username="testuser",
2852                         verify_ssl=True,
2853                     )
2854                 ],
2855             )
2856             self.assertEqual(mock_details.assert_called_once(), None)
2857             self.assertEqual(mock_ca.assert_called_once(), None)
2858             self.assertEqual(mock_ca.call_args_list, [call({"ca_bundle": cert_path})])
2859 class TestCertificateVerify(TestCase, LoaderModuleMockMixin):
2860     def setup_loader_modules(self):
2861         return {vsphere: {}}
2862     def test_upload_ssh_key(self):
2863         kwargs_values = [
2864             ("ssh_key", "TheSSHKeyFile"),
2865             ("ssh_key_file", "TheSSHKeyFile"),
2866         ]
2867         certificate_verify_values = (None, True, False)
2868         for kw_key, kw_value in kwargs_values:
2869             kwargs = {kw_key: kw_value}
2870             if kw_key == "ssh_key":
2871                 expected_kwargs = {"data": kw_value}
2872             else:
2873                 expected_kwargs = {"data_file": kw_value, "data_render": False}
2874             for certificate_verify_value in certificate_verify_values:
2875                 http_query_mock = MagicMock()
2876                 if certificate_verify_value is None:
2877                     certificate_verify_value = True
2878                 with patch("salt.utils.http.query", http_query_mock):
2879                     vsphere.upload_ssh_key(
2880                         HOST,
2881                         USER,
2882                         PASSWORD,
2883                         certificate_verify=certificate_verify_value,
2884                         **kwargs
2885                     )
2886                 http_query_mock.assert_called_once_with(
2887                     "https://1.2.3.4:443/host/ssh_root_authorized_keys",
2888                     method="PUT",
2889                     password="SuperSecret!",
2890                     status=True,
2891                     text=True,
2892                     username="root",
2893                     verify_ssl=certificate_verify_value,
2894                     **expected_kwargs
2895                 )
2896     def test_get_ssh_key(self):
2897         certificate_verify_values = (None, True, False)
2898         for certificate_verify_value in certificate_verify_values:
2899             http_query_mock = MagicMock()
2900             if certificate_verify_value is None:
2901                 certificate_verify_value = True
2902             with patch("salt.utils.http.query", http_query_mock):
2903                 vsphere.get_ssh_key(
2904                     HOST, USER, PASSWORD, certificate_verify=certificate_verify_value
2905                 )
2906             http_query_mock.assert_called_once_with(
2907                 "https://1.2.3.4:443/host/ssh_root_authorized_keys",
2908                 method="GET",
2909                 password="SuperSecret!",
2910                 status=True,
2911                 text=True,
2912                 username="root",
2913                 verify_ssl=certificate_verify_value,
2914             )
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
