<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for pkg_resource.py &amp; win_iis_1.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for pkg_resource.py &amp; win_iis_1.py
      </h3>
<h1 align="center">
        0.9%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>pkg_resource.py (3.1662269%)<th>win_iis_1.py (0.5479452%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(7-18)<td><a href="#" name="0">(11-23)</a><td align="center"><font color="#ff0000">12</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>pkg_resource.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <a name="0"></a>
2 import copy
3 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import fnmatch
4 import logging
5 import os
6 import pprint
7 import salt.utils.data
8 import salt.utils.versions
9 import salt.utils.yaml
10 from salt.exceptions import SaltInvocationError
11 log = logging.getLogger(__name__)
12 __SUFFIX_NOT_NEEDED =</b></font> ("x86_64", "noarch")
13 def _repack_pkgs(pkgs, normalize=True):
14     if normalize and "pkg.normalize_name" in __salt__:
15         _normalize_name = __salt__["pkg.normalize_name"]
16     else:
17         _normalize_name = lambda pkgname: pkgname
18     return {
19         _normalize_name(str(x)): str(y) if y is not None else y
20         for x, y in salt.utils.data.repack_dictlist(pkgs).items()
21     }
22 def pack_sources(sources, normalize=True):
23     if normalize and "pkg.normalize_name" in __salt__:
24         _normalize_name = __salt__["pkg.normalize_name"]
25     else:
26         _normalize_name = lambda pkgname: pkgname
27     if isinstance(sources, str):
28         try:
29             sources = salt.utils.yaml.safe_load(sources)
30         except salt.utils.yaml.parser.ParserError as err:
31             log.error(err)
32             return {}
33     ret = {}
34     for source in sources:
35         if (not isinstance(source, dict)) or len(source) != 1:
36             log.error("Invalid input: %s", pprint.pformat(sources))
37             log.error("Input must be a list of 1-element dicts")
38             return {}
39         else:
40             key = next(iter(source))
41             ret[_normalize_name(key)] = source[key]
42     return ret
43 def parse_targets(
44     name=None, pkgs=None, sources=None, saltenv="base", normalize=True, **kwargs
45 ):
46     if "__env__" in kwargs:
47         kwargs.pop("__env__")
48     if __grains__["os"] == "MacOS" and sources:
49         log.warning('Parameter "sources" ignored on MacOS hosts.')
50     version = kwargs.get("version")
51     if pkgs and sources:
52         log.error('Only one of "pkgs" and "sources" can be used.')
53         return None, None
54     elif "advisory_ids" in kwargs:
55         if pkgs:
56             log.error('Cannot use "advisory_ids" and "pkgs" at the same time')
57             return None, None
58         elif kwargs["advisory_ids"]:
59             return kwargs["advisory_ids"], "advisory"
60         else:
61             return [name], "advisory"
62     elif pkgs:
63         if version is not None:
64             log.warning(
65                 "'version' argument will be ignored for multiple package targets"
66             )
67         pkgs = _repack_pkgs(pkgs, normalize=normalize)
68         if not pkgs:
69             return None, None
70         else:
71             return pkgs, "repository"
72     elif sources and __grains__["os"] != "MacOS":
73         if version is not None:
74             log.warning(
75                 "'version' argument will be ignored for multiple package targets"
76             )
77         sources = pack_sources(sources, normalize=normalize)
78         if not sources:
79             return None, None
80         srcinfo = []
81         for pkg_name, pkg_src in sources.items():
82             if __salt__["config.valid_fileproto"](pkg_src):
83                 srcinfo.append(__salt__["cp.cache_file"](pkg_src, saltenv))
84             else:
85                 if not os.path.isabs(pkg_src):
86                     raise SaltInvocationError(
87                         "Path {} for package {} is either not absolute or "
88                         "an invalid protocol".format(pkg_src, pkg_name)
89                     )
90                 srcinfo.append(pkg_src)
91         return srcinfo, "file"
92     elif name:
93         if normalize:
94             _normalize_name = __salt__.get(
95                 "pkg.normalize_name", lambda pkgname: pkgname
96             )
97             packed = {_normalize_name(x): version for x in name.split(",")}
98         else:
99             packed = {x: version for x in name.split(",")}
100         return packed, "repository"
101     else:
102         log.error("No package sources provided")
103         return None, None
104 def version(*names, **kwargs):
105     ret = {}
106     versions_as_list = salt.utils.data.is_true(kwargs.pop("versions_as_list", False))
107     pkg_glob = False
108     if len(names) != 0:
109         pkgs = __salt__["pkg.list_pkgs"](versions_as_list=True, **kwargs)
110         for name in names:
111             if "*" in name:
112                 pkg_glob = True
113                 for match in fnmatch.filter(pkgs, name):
114                     ret[match] = pkgs.get(match, [])
115             else:
116                 ret[name] = pkgs.get(name, [])
117     if not versions_as_list:
118         __salt__["pkg_resource.stringify"](ret)
119     if len(ret) == 1 and not pkg_glob:
120         try:
121             return next(iter(ret.values()))
122         except StopIteration:
123             return ""
124     return ret
125 def add_pkg(pkgs, name, pkgver):
126     try:
127         pkgs.setdefault(name, []).append(pkgver)
128     except AttributeError as exc:
129         log.exception(exc)
130 def sort_pkglist(pkgs):
131     try:
132         for key in pkgs:
133             pkgs[key] = sorted(set(pkgs[key]))
134     except AttributeError as exc:
135         log.exception(exc)
136 def stringify(pkgs):
137     try:
138         for key in pkgs:
139             pkgs[key] = ",".join(pkgs[key])
140     except AttributeError as exc:
141         log.exception(exc)
142 def version_clean(verstr):
143     if verstr and "pkg.version_clean" in __salt__:
144         return __salt__["pkg.version_clean"](verstr)
145     return verstr
146 def version_compare(ver1, oper, ver2, ignore_epoch=False):
147     return salt.utils.versions.compare(
148         ver1,
149         oper,
150         ver2,
151         ignore_epoch=ignore_epoch,
152         cmp_func=__salt__.get("version_cmp"),
153     )
154 def check_extra_requirements(pkgname, pkgver):
155     if pkgver and "pkg.check_extra_requirements" in __salt__:
156         return __salt__["pkg.check_extra_requirements"](pkgname, pkgver)
157     return True
158 def format_pkg_list(packages, versions_as_list, attr):
159     ret = copy.deepcopy(packages)
160     if attr:
161         ret_attr = {}
162         requested_attr = {
163             "epoch",
164             "version",
165             "release",
166             "arch",
167             "install_date",
168             "install_date_time_t",
169         }
170         if attr != "all":
171             requested_attr &amp;= set(attr + ["version"] + ["arch"])
172         for name in ret:
173             if "pkg.parse_arch" in __salt__:
174                 _parse_arch = __salt__["pkg.parse_arch"](name)
175             else:
176                 _parse_arch = {"name": name, "arch": None}
177             _name = _parse_arch["name"]
178             _arch = _parse_arch["arch"]
179             versions = []
180             pkgname = None
181             for all_attr in ret[name]:
182                 filtered_attr = {}
183                 for key in requested_attr:
184                     if key in all_attr:
185                         filtered_attr[key] = all_attr[key]
186                 versions.append(filtered_attr)
187                 if _name and filtered_attr.get("arch", None) == _arch:
188                     pkgname = _name
189             ret_attr.setdefault(pkgname or name, []).extend(versions)
190         return ret_attr
191     for name in ret:
192         ret[name] = [
193             format_version(d["epoch"], d["version"], d["release"]) for d in ret[name]
194         ]
195     if not versions_as_list:
196         stringify(ret)
197     return ret
198 def format_version(epoch, version, release):
199     full_version = "{}:{}".format(epoch, version) if epoch else version
200     if release:
201         full_version += "-{}".format(release)
202     return full_version
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>win_iis_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import decimal
2 import logging
3 import os
4 import re
5 import salt.utils.json
6 import salt.utils.platform
7 import yaml
8 from salt.exceptions import CommandExecutionError, SaltInvocationError
9 log = logging.getLogger(__name__)
10 _DEFAULT_APP =</b></font> "/"
11 _VALID_PROTOCOLS = ("ftp", "http", "https")
12 _VALID_SSL_FLAGS = tuple(range(0, 4))
13 __virtualname__ = "win_iis"
14 def __virtual__():
15     if not salt.utils.platform.is_windows():
16         return False, "Only available on Windows systems"
17     powershell_info = __salt__["cmd.shell_info"]("powershell", True)
18     if not powershell_info["installed"]:
19         return False, "PowerShell not available"
20     if "WebAdministration" not in powershell_info["modules"]:
21         return False, "IIS is not installed"
22     return __virtualname__
23 def _get_binding_info(host_header="", ip_address="*", port=80):
24     return ":".join([ip_address, str(port), host_header.replace(" ", "")])
25 def _list_certs(certificate_store="My"):
26     ret = dict()
27     blacklist_keys = ["DnsNameList", "Thumbprint"]
28     ps_cmd = [
29         "Get-ChildItem",
30         "-Path",
31         r"'Cert:\LocalMachine\{}'".format(certificate_store),
32         "|",
33         "Select-Object DnsNameList, SerialNumber, Subject, Thumbprint, Version",
34     ]
35     cmd_ret = _srvmgr(cmd=ps_cmd, return_json=True)
36     try:
37         items = salt.utils.json.loads(cmd_ret["stdout"], strict=False)
38     except ValueError:
39         raise CommandExecutionError("Unable to parse return data as Json.")
40     for item in items:
41         cert_info = dict()
42         for key in item:
43             if key not in blacklist_keys:
44                 cert_info[key.lower()] = item[key]
45         cert_info["dnsnames"] = []
46         if item["DnsNameList"]:
47             cert_info["dnsnames"] = [name["Unicode"] for name in item["DnsNameList"]]
48         ret[item["Thumbprint"]] = cert_info
49     return ret
50 def _iisVersion():
51     pscmd = []
52     pscmd.append(r"Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\InetStp\\")
53     pscmd.append(" | Select-Object MajorVersion, MinorVersion")
54     cmd_ret = _srvmgr(pscmd, return_json=True)
55     try:
56         items = salt.utils.json.loads(cmd_ret["stdout"], strict=False)
57     except ValueError:
58         log.error("Unable to parse return data as Json.")
59         return -1
60     return decimal.Decimal(
61         "{}.{}".format(items[0]["MajorVersion"], items[0]["MinorVersion"])
62     )
63 def _srvmgr(cmd, return_json=False):
64     if isinstance(cmd, list):
65         cmd = " ".join(cmd)
66     if return_json:
67         cmd = "ConvertTo-Json -Compress -Depth 4 -InputObject @({})".format(cmd)
68     cmd = "Import-Module WebAdministration; {}".format(cmd)
69     ret = __salt__["cmd.run_all"](cmd, shell="powershell", python_shell=True)
70     if ret["retcode"] != 0:
71         log.error("Unable to execute command: %s\nError: %s", cmd, ret["stderr"])
72     return ret
73 def _collection_match_to_index(pspath, colfilter, name, match):
74     collection = get_webconfiguration_settings(
75         pspath, [{"name": name, "filter": colfilter}]
76     )[0]["value"]
77     for idx, collect_dict in enumerate(collection):
78         if all(item in collect_dict.items() for item in match.items()):
79             return idx
80     return -1
81 def _prepare_settings(pspath, settings):
82     prepared_settings = []
83     for setting in settings:
84         if setting.get("name", None) is None:
85             log.warning("win_iis: Setting has no name: %s", setting)
86             continue
87         if setting.get("filter", None) is None:
88             log.warning("win_iis: Setting has no filter: %s", setting)
89             continue
90         match = re.search(r"Collection\[(\{.*\})\]", setting["name"])
91         if match:
92             name = setting["name"][: match.start(1) - 1]
93             match_dict = yaml.load(match.group(1))
94             index = _collection_match_to_index(
95                 pspath, setting["filter"], name, match_dict
96             )
97             if index == -1:
98                 log.warning("win_iis: No match found for setting: %s", setting)
99             else:
100                 setting["name"] = setting["name"].replace(match.group(1), str(index))
101                 prepared_settings.append(setting)
102         else:
103             prepared_settings.append(setting)
104     return prepared_settings
105 def list_sites():
106     ret = dict()
107     ps_cmd = [
108         "Get-ChildItem",
109         "-Path",
110         r"'IIS:\Sites'",
111         "|",
112         "Select-Object applicationPool, Bindings, ID, Name, PhysicalPath, State",
113     ]
114     keep_keys = ("certificateHash", "certificateStoreName", "protocol", "sslFlags")
115     cmd_ret = _srvmgr(cmd=ps_cmd, return_json=True)
116     try:
117         items = salt.utils.json.loads(cmd_ret["stdout"], strict=False)
118     except ValueError:
119         raise CommandExecutionError("Unable to parse return data as Json.")
120     for item in items:
121         bindings = dict()
122         for binding in item["bindings"]["Collection"]:
123             if binding["protocol"] not in ["http", "https"]:
124                 continue
125             filtered_binding = dict()
126             for key in binding:
127                 if key in keep_keys:
128                     filtered_binding.update({key.lower(): binding[key]})
129             binding_info = binding["bindingInformation"].split(":", 2)
130             ipaddress, port, hostheader = (element.strip() for element in binding_info)
131             filtered_binding.update(
132                 {"hostheader": hostheader, "ipaddress": ipaddress, "port": port}
133             )
134             bindings[binding["bindingInformation"]] = filtered_binding
135         ret[item["name"]] = {
136             "apppool": item["applicationPool"],
137             "bindings": bindings,
138             "id": item["id"],
139             "state": item["state"],
140             "sourcepath": item["physicalPath"],
141         }
142     if not ret:
143         log.warning("No sites found in output: %s", cmd_ret["stdout"])
144     return ret
145 def create_site(
146     name, sourcepath, apppool="", hostheader="", ipaddress="*", port=80, protocol="http"
147 ):
148     protocol = str(protocol).lower()
149     site_path = r"IIS:\Sites\{}".format(name)
150     binding_info = _get_binding_info(hostheader, ipaddress, port)
151     current_sites = list_sites()
152     if name in current_sites:
153         log.debug("Site '%s' already present.", name)
154         return True
155     if protocol not in _VALID_PROTOCOLS:
156         message = "Invalid protocol '{}' specified. Valid formats: {}".format(
157             protocol, _VALID_PROTOCOLS
158         )
159         raise SaltInvocationError(message)
160     ps_cmd = [
161         "New-Item",
162         "-Path",
163         r"'{}'".format(site_path),
164         "-PhysicalPath",
165         r"'{}'".format(sourcepath),
166         "-Bindings",
167         "@{{ protocol='{0}'; bindingInformation='{1}' }};".format(
168             protocol, binding_info
169         ),
170     ]
171     if apppool:
172         if apppool in list_apppools():
173             log.debug("Utilizing pre-existing application pool: %s", apppool)
174         else:
175             log.debug("Application pool will be created: %s", apppool)
176             create_apppool(apppool)
177         ps_cmd.extend(
178             [
179                 "Set-ItemProperty",
180                 "-Path",
181                 "'{}'".format(site_path),
182                 "-Name",
183                 "ApplicationPool",
184                 "-Value",
185                 "'{}'".format(apppool),
186             ]
187         )
188     cmd_ret = _srvmgr(ps_cmd)
189     if cmd_ret["retcode"] != 0:
190         msg = "Unable to create site: {}\nError: {}".format(name, cmd_ret["stderr"])
191         raise CommandExecutionError(msg)
192     log.debug("Site created successfully: %s", name)
193     return True
194 def modify_site(name, sourcepath=None, apppool=None):
195     site_path = r"IIS:\Sites\{}".format(name)
196     current_sites = list_sites()
197     if name not in current_sites:
198         log.debug("Site '%s' not defined.", name)
199         return False
200     ps_cmd = list()
201     if sourcepath:
202         ps_cmd.extend(
203             [
204                 "Set-ItemProperty",
205                 "-Path",
206                 r"'{}'".format(site_path),
207                 "-Name",
208                 "PhysicalPath",
209                 "-Value",
210                 r"'{}'".format(sourcepath),
211             ]
212         )
213     if apppool:
214         if apppool in list_apppools():
215             log.debug("Utilizing pre-existing application pool: %s", apppool)
216         else:
217             log.debug("Application pool will be created: %s", apppool)
218             create_apppool(apppool)
219         if ps_cmd:
220             ps_cmd.append(";")
221         ps_cmd.extend(
222             [
223                 "Set-ItemProperty",
224                 "-Path",
225                 r"'{}'".format(site_path),
226                 "-Name",
227                 "ApplicationPool",
228                 "-Value",
229                 r"'{}'".format(apppool),
230             ]
231         )
232     cmd_ret = _srvmgr(ps_cmd)
233     if cmd_ret["retcode"] != 0:
234         msg = "Unable to modify site: {}\nError: {}".format(name, cmd_ret["stderr"])
235         raise CommandExecutionError(msg)
236     log.debug("Site modified successfully: %s", name)
237     return True
238 def remove_site(name):
239     current_sites = list_sites()
240     if name not in current_sites:
241         log.debug("Site already absent: %s", name)
242         return True
243     ps_cmd = ["Remove-WebSite", "-Name", r"'{}'".format(name)]
244     cmd_ret = _srvmgr(ps_cmd)
245     if cmd_ret["retcode"] != 0:
246         msg = "Unable to remove site: {}\nError: {}".format(name, cmd_ret["stderr"])
247         raise CommandExecutionError(msg)
248     log.debug("Site removed successfully: %s", name)
249     return True
250 def stop_site(name):
251     ps_cmd = ["Stop-WebSite", r"'{}'".format(name)]
252     cmd_ret = _srvmgr(ps_cmd)
253     return cmd_ret["retcode"] == 0
254 def start_site(name):
255     ps_cmd = ["Start-WebSite", r"'{}'".format(name)]
256     cmd_ret = _srvmgr(ps_cmd)
257     return cmd_ret["retcode"] == 0
258 def restart_site(name):
259     return stop_site(name) and start_site(name)
260 def list_bindings(site):
261     ret = dict()
262     sites = list_sites()
263     if site not in sites:
264         log.warning("Site not found: %s", site)
265         return ret
266     ret = sites[site]["bindings"]
267     if not ret:
268         log.warning("No bindings found for site: %s", site)
269     return ret
270 def create_binding(
271     site, hostheader="", ipaddress="*", port=80, protocol="http", sslflags=None
272 ):
273     protocol = str(protocol).lower()
274     name = _get_binding_info(hostheader, ipaddress, port)
275     if protocol not in _VALID_PROTOCOLS:
276         message = "Invalid protocol '{}' specified. Valid formats: {}".format(
277             protocol, _VALID_PROTOCOLS
278         )
279         raise SaltInvocationError(message)
280     if sslflags:
281         sslflags = int(sslflags)
282         if sslflags not in _VALID_SSL_FLAGS:
283             raise SaltInvocationError(
284                 "Invalid sslflags '{}' specified. Valid sslflags range: {}..{}".format(
285                     sslflags, _VALID_SSL_FLAGS[0], _VALID_SSL_FLAGS[-1]
286                 )
287             )
288     current_bindings = list_bindings(site)
289     if name in current_bindings:
290         log.debug("Binding already present: %s", name)
291         return True
292     if sslflags:
293         ps_cmd = [
294             "New-WebBinding",
295             "-Name",
296             "'{}'".format(site),
297             "-HostHeader",
298             "'{}'".format(hostheader),
299             "-IpAddress",
300             "'{}'".format(ipaddress),
301             "-Port",
302             "'{}'".format(port),
303             "-Protocol",
304             "'{}'".format(protocol),
305             "-SslFlags",
306             "{}".format(sslflags),
307         ]
308     else:
309         ps_cmd = [
310             "New-WebBinding",
311             "-Name",
312             "'{}'".format(site),
313             "-HostHeader",
314             "'{}'".format(hostheader),
315             "-IpAddress",
316             "'{}'".format(ipaddress),
317             "-Port",
318             "'{}'".format(port),
319             "-Protocol",
320             "'{}'".format(protocol),
321         ]
322     cmd_ret = _srvmgr(ps_cmd)
323     if cmd_ret["retcode"] != 0:
324         msg = "Unable to create binding: {}\nError: {}".format(site, cmd_ret["stderr"])
325         raise CommandExecutionError(msg)
326     if name in list_bindings(site):
327         log.debug("Binding created successfully: %s", site)
328         return True
329     log.error("Unable to create binding: %s", site)
330     return False
331 def modify_binding(
332     site, binding, hostheader=None, ipaddress=None, port=None, sslflags=None
333 ):
334     if sslflags is not None and sslflags not in _VALID_SSL_FLAGS:
335         raise SaltInvocationError(
336             "Invalid sslflags '{}' specified. Valid sslflags range: {}..{}".format(
337                 sslflags, _VALID_SSL_FLAGS[0], _VALID_SSL_FLAGS[-1]
338             )
339         )
340     current_sites = list_sites()
341     if site not in current_sites:
342         log.debug("Site '%s' not defined.", site)
343         return False
344     current_bindings = list_bindings(site)
345     if binding not in current_bindings:
346         log.debug("Binding '%s' not defined.", binding)
347         return False
348     i, p, h = binding.split(":")
349     new_binding = ":".join(
350         [
351             ipaddress if ipaddress is not None else i,
352             str(port) if port is not None else str(p),
353             hostheader if hostheader is not None else h,
354         ]
355     )
356     if new_binding != binding:
357         ps_cmd = [
358             "Set-WebBinding",
359             "-Name",
360             "'{}'".format(site),
361             "-BindingInformation",
362             "'{}'".format(binding),
363             "-PropertyName",
364             "BindingInformation",
365             "-Value",
366             "'{}'".format(new_binding),
367         ]
368         cmd_ret = _srvmgr(ps_cmd)
369         if cmd_ret["retcode"] != 0:
370             msg = "Unable to modify binding: {}\nError: {}".format(
371                 binding, cmd_ret["stderr"]
372             )
373             raise CommandExecutionError(msg)
374     if (
375         sslflags is not None
376         and sslflags != current_sites[site]["bindings"][binding]["sslflags"]
377     ):
378         ps_cmd = [
379             "Set-WebBinding",
380             "-Name",
381             "'{}'".format(site),
382             "-BindingInformation",
383             "'{}'".format(new_binding),
384             "-PropertyName",
385             "sslflags",
386             "-Value",
387             "'{}'".format(sslflags),
388         ]
389         cmd_ret = _srvmgr(ps_cmd)
390         if cmd_ret["retcode"] != 0:
391             msg = "Unable to modify binding SSL Flags: {}\nError: {}".format(
392                 sslflags, cmd_ret["stderr"]
393             )
394             raise CommandExecutionError(msg)
395     log.debug("Binding modified successfully: %s", binding)
396     return True
397 def remove_binding(site, hostheader="", ipaddress="*", port=80):
398     name = _get_binding_info(hostheader, ipaddress, port)
399     current_bindings = list_bindings(site)
400     if name not in current_bindings:
401         log.debug("Binding already absent: %s", name)
402         return True
403     ps_cmd = [
404         "Remove-WebBinding",
405         "-HostHeader",
406         "'{}'".format(hostheader),
407         "-IpAddress",
408         "'{}'".format(ipaddress),
409         "-Port",
410         "'{}'".format(port),
411     ]
412     cmd_ret = _srvmgr(ps_cmd)
413     if cmd_ret["retcode"] != 0:
414         msg = "Unable to remove binding: {}\nError: {}".format(site, cmd_ret["stderr"])
415         raise CommandExecutionError(msg)
416     if name not in list_bindings(site):
417         log.debug("Binding removed successfully: %s", site)
418         return True
419     log.error("Unable to remove binding: %s", site)
420     return False
421 def list_cert_bindings(site):
422     ret = dict()
423     sites = list_sites()
424     if site not in sites:
425         log.warning("Site not found: %s", site)
426         return ret
427     for binding in sites[site]["bindings"]:
428         if sites[site]["bindings"][binding]["certificatehash"]:
429             ret[binding] = sites[site]["bindings"][binding]
430     if not ret:
431         log.warning("No certificate bindings found for site: %s", site)
432     return ret
433 def create_cert_binding(name, site, hostheader="", ipaddress="*", port=443, sslflags=0):
434     name = str(name).upper()
435     binding_info = _get_binding_info(hostheader, ipaddress, port)
436     if _iisVersion() &lt; 8:
437         binding_info = binding_info.rpartition(":")[0] + ":"
438     binding_path = r"IIS:\SslBindings\{}".format(binding_info.replace(":", "!"))
439     if sslflags not in _VALID_SSL_FLAGS:
440         raise SaltInvocationError(
441             "Invalid sslflags '{}' specified. Valid sslflags range: {}..{}".format(
442                 sslflags, _VALID_SSL_FLAGS[0], _VALID_SSL_FLAGS[-1]
443             )
444         )
445     current_bindings = list_bindings(site)
446     if binding_info not in current_bindings:
447         log.error("Binding not present: %s", binding_info)
448         return False
449     current_name = None
450     for current_binding in current_bindings:
451         if binding_info == current_binding:
452             current_name = current_bindings[current_binding]["certificatehash"]
453     log.debug("Current certificate thumbprint: %s", current_name)
454     log.debug("New certificate thumbprint: %s", name)
455     if name == current_name:
456         log.debug("Certificate already present for binding: %s", name)
457         return True
458     certs = _list_certs()
459     if name not in certs:
460         log.error("Certificate not present: %s", name)
461         return False
462     if _iisVersion() &lt; 8:
463         iis7path = binding_path.replace(r"\*!", "\\0.0.0.0!")
464         if iis7path.endswith("!"):
465             iis7path = iis7path[:-1]
466         ps_cmd = [
467             "New-Item",
468             "-Path",
469             "'{}'".format(iis7path),
470             "-Thumbprint",
471             "'{}'".format(name),
472         ]
473     else:
474         ps_cmd = [
475             "New-Item",
476             "-Path",
477             "'{}'".format(binding_path),
478             "-Thumbprint",
479             "'{}'".format(name),
480             "-SSLFlags",
481             "{}".format(sslflags),
482         ]
483     cmd_ret = _srvmgr(ps_cmd)
484     if cmd_ret["retcode"] != 0:
485         msg = "Unable to create certificate binding: {}\nError: {}".format(
486             name, cmd_ret["stderr"]
487         )
488         raise CommandExecutionError(msg)
489     new_cert_bindings = list_cert_bindings(site)
490     if binding_info not in new_cert_bindings:
491         log.error("Binding not present: %s", binding_info)
492         return False
493     if name == new_cert_bindings[binding_info]["certificatehash"]:
494         log.debug("Certificate binding created successfully: %s", name)
495         return True
496     log.error("Unable to create certificate binding: %s", name)
497     return False
498 def remove_cert_binding(name, site, hostheader="", ipaddress="*", port=443):
499     name = str(name).upper()
500     binding_info = _get_binding_info(hostheader, ipaddress, port)
501     ps_cmd = [
502         "$Site = Get-ChildItem",
503         "-Path",
504         r"'IIS:\Sites'",
505         "|",
506         "Where-Object",
507         r" {{ $_.Name -Eq '{0}' }};".format(site),
508         "$Binding = $Site.Bindings.Collection",
509         r"| Where-Object { $_.bindingInformation",
510         r"-Eq '{0}' }};".format(binding_info),
511         "$Binding.RemoveSslCertificate()",
512     ]
513     current_cert_bindings = list_cert_bindings(site)
514     if binding_info not in current_cert_bindings:
515         log.warning("Binding not found: %s", binding_info)
516         return True
517     if name != current_cert_bindings[binding_info]["certificatehash"]:
518         log.debug("Certificate binding already absent: %s", name)
519         return True
520     cmd_ret = _srvmgr(ps_cmd)
521     if cmd_ret["retcode"] != 0:
522         msg = "Unable to remove certificate binding: {}\nError: {}".format(
523             name, cmd_ret["stderr"]
524         )
525         raise CommandExecutionError(msg)
526     new_cert_bindings = list_cert_bindings(site)
527     if binding_info not in new_cert_bindings:
528         log.warning("Binding not found: %s", binding_info)
529         return True
530     if name != new_cert_bindings[binding_info]["certificatehash"]:
531         log.debug("Certificate binding removed successfully: %s", name)
532         return True
533     log.error("Unable to remove certificate binding: %s", name)
534     return False
535 def list_apppools():
536     ret = dict()
537     ps_cmd = []
538     ps_cmd.append(r"Get-ChildItem -Path 'IIS:\AppPools' | Select-Object Name, State")
539     ps_cmd.append(r", @{ Name = 'Applications'; Expression = { $AppPool = $_.Name;")
540     ps_cmd.append("$AppPath = 'machine/webroot/apphost';")
541     ps_cmd.append("$FilterBase = '/system.applicationHost/sites/site/application';")
542     ps_cmd.append("$FilterBase += \"[@applicationPool = '$($AppPool)' and @path\";")
543     ps_cmd.append("$FilterRoot = \"$($FilterBase) = '/']/parent::*\";")
544     ps_cmd.append("$FilterNonRoot = \"$($FilterBase) != '/']\";")
545     ps_cmd.append(
546         "Get-WebConfigurationProperty -Filter $FilterRoot -PsPath $AppPath -Name Name"
547     )
548     ps_cmd.append(r"| ForEach-Object { $_.Value };")
549     ps_cmd.append(
550         "Get-WebConfigurationProperty -Filter $FilterNonRoot -PsPath $AppPath -Name"
551         " Path"
552     )
553     ps_cmd.append(r"| ForEach-Object { $_.Value } | Where-Object { $_ -ne '/' }")
554     ps_cmd.append("} }")
555     cmd_ret = _srvmgr(cmd=ps_cmd, return_json=True)
556     try:
557         items = salt.utils.json.loads(cmd_ret["stdout"], strict=False)
558     except ValueError:
559         raise CommandExecutionError("Unable to parse return data as Json.")
560     for item in items:
561         applications = list()
562         if isinstance(item["Applications"], dict):
563             if "value" in item["Applications"]:
564                 applications += item["Applications"]["value"]
565         else:
566             applications.append(item["Applications"])
567         ret[item["name"]] = {"state": item["state"], "applications": applications}
568     if not ret:
569         log.warning("No application pools found in output: %s", cmd_ret["stdout"])
570     return ret
571 def create_apppool(name):
572     current_apppools = list_apppools()
573     apppool_path = r"IIS:\AppPools\{}".format(name)
574     if name in current_apppools:
575         log.debug("Application pool '%s' already present.", name)
576         return True
577     ps_cmd = ["New-Item", "-Path", r"'{}'".format(apppool_path)]
578     cmd_ret = _srvmgr(ps_cmd)
579     if cmd_ret["retcode"] != 0:
580         msg = "Unable to create application pool: {}\nError: {}".format(
581             name, cmd_ret["stderr"]
582         )
583         raise CommandExecutionError(msg)
584     log.debug("Application pool created successfully: %s", name)
585     return True
586 def remove_apppool(name):
587     current_apppools = list_apppools()
588     apppool_path = r"IIS:\AppPools\{}".format(name)
589     if name not in current_apppools:
590         log.debug("Application pool already absent: %s", name)
591         return True
592     ps_cmd = ["Remove-Item", "-Path", r"'{}'".format(apppool_path), "-Recurse"]
593     cmd_ret = _srvmgr(ps_cmd)
594     if cmd_ret["retcode"] != 0:
595         msg = "Unable to remove application pool: {}\nError: {}".format(
596             name, cmd_ret["stderr"]
597         )
598         raise CommandExecutionError(msg)
599     log.debug("Application pool removed successfully: %s", name)
600     return True
601 def stop_apppool(name):
602     ps_cmd = ["Stop-WebAppPool", r"'{}'".format(name)]
603     cmd_ret = _srvmgr(ps_cmd)
604     return cmd_ret["retcode"] == 0
605 def start_apppool(name):
606     ps_cmd = ["Start-WebAppPool", r"'{}'".format(name)]
607     cmd_ret = _srvmgr(ps_cmd)
608     return cmd_ret["retcode"] == 0
609 def restart_apppool(name):
610     ps_cmd = ["Restart-WebAppPool", r"'{}'".format(name)]
611     cmd_ret = _srvmgr(ps_cmd)
612     return cmd_ret["retcode"] == 0
613 def get_container_setting(name, container, settings):
614     ret = dict()
615     ps_cmd = list()
616     ps_cmd_validate = list()
617     container_path = r"IIS:\{}\{}".format(container, name)
618     if not settings:
619         log.warning("No settings provided")
620         return ret
621     ps_cmd.append(r"$Settings = @{};")
622     for setting in settings:
623         ps_cmd_validate.extend(
624             [
625                 "Get-ItemProperty",
626                 "-Path",
627                 "'{}'".format(container_path),
628                 "-Name",
629                 "'{}'".format(setting),
630                 "-ErrorAction",
631                 "Stop",
632                 "|",
633                 "Out-Null;",
634             ]
635         )
636         ps_cmd.append("$Property = Get-ItemProperty -Path '{}'".format(container_path))
637         ps_cmd.append("-Name '{}' -ErrorAction Stop;".format(setting))
638         ps_cmd.append(r"if (([String]::IsNullOrEmpty($Property) -eq $False) -and")
639         ps_cmd.append(r"($Property.GetType()).Name -eq 'ConfigurationAttribute') {")
640         ps_cmd.append(r"$Property = $Property | Select-Object")
641         ps_cmd.append(r"-ExpandProperty Value };")
642         ps_cmd.append("$Settings['{}'] = [String] $Property;".format(setting))
643         ps_cmd.append(r"$Property = $Null;")
644     cmd_ret = _srvmgr(cmd=ps_cmd_validate, return_json=True)
645     if cmd_ret["retcode"] != 0:
646         message = (
647             "One or more invalid property names were specified for the provided"
648             " container."
649         )
650         raise SaltInvocationError(message)
651     ps_cmd.append("$Settings")
652     cmd_ret = _srvmgr(cmd=ps_cmd, return_json=True)
653     try:
654         items = salt.utils.json.loads(cmd_ret["stdout"], strict=False)
655         if isinstance(items, list):
656             ret.update(items[0])
657         else:
658             ret.update(items)
659     except ValueError:
660         raise CommandExecutionError("Unable to parse return data as Json.")
661     return ret
662 def set_container_setting(name, container, settings):
663     identityType_map2string = {
664         "0": "LocalSystem",
665         "1": "LocalService",
666         "2": "NetworkService",
667         "3": "SpecificUser",
668         "4": "ApplicationPoolIdentity",
669     }
670     identityType_map2numeric = {
671         "LocalSystem": "0",
672         "LocalService": "1",
673         "NetworkService": "2",
674         "SpecificUser": "3",
675         "ApplicationPoolIdentity": "4",
676     }
677     ps_cmd = list()
678     container_path = r"IIS:\{}\{}".format(container, name)
679     if not settings:
680         log.warning("No settings provided")
681         return False
682     for setting in settings:
683         settings[setting] = str(settings[setting])
684     current_settings = get_container_setting(
685         name=name, container=container, settings=settings.keys()
686     )
687     if settings == current_settings:
688         log.debug("Settings already contain the provided values.")
689         return True
690     for setting in settings:
691         try:
692             complex(settings[setting])
693             value = settings[setting]
694         except ValueError:
695             value = "'{}'".format(settings[setting])
696         if (
697             setting == "processModel.identityType"
698             and settings[setting] in identityType_map2numeric.keys()
699         ):
700             value = identityType_map2numeric[settings[setting]]
701         ps_cmd.extend(
702             [
703                 "Set-ItemProperty",
704                 "-Path",
705                 "'{}'".format(container_path),
706                 "-Name",
707                 "'{}'".format(setting),
708                 "-Value",
709                 "{};".format(value),
710             ]
711         )
712     cmd_ret = _srvmgr(ps_cmd)
713     if cmd_ret["retcode"] != 0:
714         msg = "Unable to set settings for {}: {}".format(container, name)
715         raise CommandExecutionError(msg)
716     new_settings = get_container_setting(
717         name=name, container=container, settings=settings.keys()
718     )
719     failed_settings = dict()
720     for setting in settings:
721         if (
722             setting == "processModel.identityType"
723             and settings[setting] in identityType_map2string.keys()
724         ):
725             settings[setting] = identityType_map2string[settings[setting]]
726         if str(settings[setting]) != str(new_settings[setting]):
727             failed_settings[setting] = settings[setting]
728     if failed_settings:
729         log.error("Failed to change settings: %s", failed_settings)
730         return False
731     log.debug("Settings configured successfully: %s", settings.keys())
732     return True
733 def list_apps(site):
734     ret = dict()
735     ps_cmd = list()
736     ps_cmd.append("Get-WebApplication -Site '{}'".format(site))
737     ps_cmd.append(
738         r"| Select-Object applicationPool, path, PhysicalPath, preloadEnabled,"
739     )
740     ps_cmd.append(r"@{ Name='name'; Expression={ $_.path.Split('/', 2)[-1] } },")
741     ps_cmd.append(
742         r"@{ Name='protocols'; Expression={ @( $_.enabledProtocols.Split(',')"
743     )
744     ps_cmd.append(r"| Foreach-Object { $_.Trim() } ) } }")
745     cmd_ret = _srvmgr(cmd=ps_cmd, return_json=True)
746     try:
747         items = salt.utils.json.loads(cmd_ret["stdout"], strict=False)
748     except ValueError:
749         raise CommandExecutionError("Unable to parse return data as Json.")
750     for item in items:
751         protocols = list()
752         if isinstance(item["protocols"], dict):
753             if "value" in item["protocols"]:
754                 protocols += item["protocols"]["value"]
755         else:
756             protocols.append(item["protocols"])
757         ret[item["name"]] = {
758             "apppool": item["applicationPool"],
759             "path": item["path"],
760             "preload": item["preloadEnabled"],
761             "protocols": protocols,
762             "sourcepath": item["PhysicalPath"],
763         }
764     if not ret:
765         log.warning("No apps found in output: %s", cmd_ret)
766     return ret
767 def create_app(name, site, sourcepath, apppool=None):
768     current_apps = list_apps(site)
769     if name in current_apps:
770         log.debug("Application already present: %s", name)
771         return True
772     if not os.path.isdir(sourcepath):
773         log.error("Path is not present: %s", sourcepath)
774         return False
775     ps_cmd = [
776         "New-WebApplication",
777         "-Name",
778         "'{}'".format(name),
779         "-Site",
780         "'{}'".format(site),
781         "-PhysicalPath",
782         "'{}'".format(sourcepath),
783     ]
784     if apppool:
785         ps_cmd.extend(["-ApplicationPool", "'{}'".format(apppool)])
786     cmd_ret = _srvmgr(ps_cmd)
787     if cmd_ret["retcode"] != 0:
788         msg = "Unable to create application: {}\nError: {}".format(
789             name, cmd_ret["stderr"]
790         )
791         raise CommandExecutionError(msg)
792     new_apps = list_apps(site)
793     if name in new_apps:
794         log.debug("Application created successfully: %s", name)
795         return True
796     log.error("Unable to create application: %s", name)
797     return False
798 def remove_app(name, site):
799     current_apps = list_apps(site)
800     if name not in current_apps:
801         log.debug("Application already absent: %s", name)
802         return True
803     ps_cmd = [
804         "Remove-WebApplication",
805         "-Name",
806         "'{}'".format(name),
807         "-Site",
808         "'{}'".format(site),
809     ]
810     cmd_ret = _srvmgr(ps_cmd)
811     if cmd_ret["retcode"] != 0:
812         msg = "Unable to remove application: {}\nError: {}".format(
813             name, cmd_ret["stderr"]
814         )
815         raise CommandExecutionError(msg)
816     new_apps = list_apps(site)
817     if name not in new_apps:
818         log.debug("Application removed successfully: %s", name)
819         return True
820     log.error("Unable to remove application: %s", name)
821     return False
822 def list_vdirs(site, app=_DEFAULT_APP):
823     ret = dict()
824     ps_cmd = [
825         "Get-WebVirtualDirectory",
826         "-Site",
827         r"'{}'".format(site),
828         "-Application",
829         r"'{}'".format(app),
830         "|",
831         "Select-Object PhysicalPath, @{ Name = 'name';",
832         r"Expression = { $_.path.Trim('/') } }",
833     ]
834     cmd_ret = _srvmgr(cmd=ps_cmd, return_json=True)
835     try:
836         items = salt.utils.json.loads(cmd_ret["stdout"], strict=False)
837     except ValueError:
838         raise CommandExecutionError("Unable to parse return data as Json.")
839     for item in items:
840         ret[item["name"]] = {"sourcepath": item["physicalPath"]}
841     if not ret:
842         log.warning("No vdirs found in output: %s", cmd_ret)
843     return ret
844 def create_vdir(name, site, sourcepath, app=_DEFAULT_APP):
845     current_vdirs = list_vdirs(site, app)
846     if name in current_vdirs:
847         log.debug("Virtual directory already present: %s", name)
848         return True
849     if not os.path.isdir(sourcepath):
850         log.error("Path is not present: %s", sourcepath)
851         return False
852     ps_cmd = [
853         "New-WebVirtualDirectory",
854         "-Name",
855         r"'{}'".format(name),
856         "-Site",
857         r"'{}'".format(site),
858         "-PhysicalPath",
859         r"'{}'".format(sourcepath),
860     ]
861     if app != _DEFAULT_APP:
862         ps_cmd.extend(["-Application", r"'{}'".format(app)])
863     cmd_ret = _srvmgr(ps_cmd)
864     if cmd_ret["retcode"] != 0:
865         msg = "Unable to create virtual directory: {}\nError: {}".format(
866             name, cmd_ret["stderr"]
867         )
868         raise CommandExecutionError(msg)
869     new_vdirs = list_vdirs(site, app)
870     if name in new_vdirs:
871         log.debug("Virtual directory created successfully: %s", name)
872         return True
873     log.error("Unable to create virtual directory: %s", name)
874     return False
875 def remove_vdir(name, site, app=_DEFAULT_APP):
876     current_vdirs = list_vdirs(site, app)
877     app_path = os.path.join(*app.rstrip("/").split("/"))
878     if app_path:
879         app_path = "{}\\".format(app_path)
880     vdir_path = r"IIS:\Sites\{}\{}{}".format(site, app_path, name)
881     if name not in current_vdirs:
882         log.debug("Virtual directory already absent: %s", name)
883         return True
884     ps_cmd = ["Remove-Item", "-Path", r"'{}'".format(vdir_path), "-Recurse"]
885     cmd_ret = _srvmgr(ps_cmd)
886     if cmd_ret["retcode"] != 0:
887         msg = "Unable to remove virtual directory: {}\nError: {}".format(
888             name, cmd_ret["stderr"]
889         )
890         raise CommandExecutionError(msg)
891     new_vdirs = list_vdirs(site, app)
892     if name not in new_vdirs:
893         log.debug("Virtual directory removed successfully: %s", name)
894         return True
895     log.error("Unable to remove virtual directory: %s", name)
896     return False
897 def list_backups():
898     r"""
899     List the IIS Configuration Backups on the System.
900     .. versionadded:: 2017.7.0
901     .. note::
902         Backups are made when a configuration is edited. Manual backups are
903         stored in the ``$env:Windir\System32\inetsrv\backup`` folder.
904     Returns:
905         dict: A dictionary of IIS Configurations backed up on the system.
906     CLI Example:
907     .. code-block:: bash
908         salt '*' win_iis.list_backups
909     if name in list_backups():
910         raise CommandExecutionError("Backup already present: {}".format(name))
911     ps_cmd = ["Backup-WebConfiguration", "-Name", "'{}'".format(name)]
912     cmd_ret = _srvmgr(ps_cmd)
913     if cmd_ret["retcode"] != 0:
914         msg = "Unable to backup web configuration: {}\nError: {}".format(
915             name, cmd_ret["stderr"]
916         )
917         raise CommandExecutionError(msg)
918     return name in list_backups()
919 def remove_backup(name):
920     if name not in list_backups():
921         log.debug("Backup already removed: %s", name)
922         return True
923     ps_cmd = ["Remove-WebConfigurationBackup", "-Name", "'{}'".format(name)]
924     cmd_ret = _srvmgr(ps_cmd)
925     if cmd_ret["retcode"] != 0:
926         msg = "Unable to remove web configuration: {}\nError: {}".format(
927             name, cmd_ret["stderr"]
928         )
929         raise CommandExecutionError(msg)
930     return name not in list_backups()
931 def list_worker_processes(apppool):
932     ps_cmd = ["Get-ChildItem", r"'IIS:\AppPools\{}\WorkerProcesses'".format(apppool)]
933     cmd_ret = _srvmgr(cmd=ps_cmd, return_json=True)
934     try:
935         items = salt.utils.json.loads(cmd_ret["stdout"], strict=False)
936     except ValueError:
937         raise CommandExecutionError("Unable to parse return data as Json.")
938     ret = dict()
939     for item in items:
940         ret[item["processId"]] = item["appPoolName"]
941     if not ret:
942         log.warning("No backups found in output: %s", cmd_ret)
943     return ret
944 def get_webapp_settings(name, site, settings):
945     r"""
946     .. versionadded:: 2017.7.0
947     Get the value of the setting for the IIS web application.
948     .. note::
949         Params are case sensitive
950     :param str name: The name of the IIS web application.
951     :param str site: The site name contains the web application.
952         Example: Default Web Site
953     :param str settings: A dictionary of the setting names and their values.
954         Available settings: physicalPath, applicationPool, userName, password
955     Returns:
956         dict: A dictionary of the provided settings and their values.
957     CLI Example:
958     .. code-block:: bash
959         salt '*' win_iis.get_webapp_settings name='app0' site='Default Web Site'
960             settings="['physicalPath','applicationPool']"
961     pscmd = list()
962     current_apps = list_apps(site)
963     current_sites = list_sites()
964     availableSettings = ("physicalPath", "applicationPool", "userName", "password")
965     if name not in current_apps:
966         msg = "Application" + name + "doesn't exist"
967         raise SaltInvocationError(msg)
968     if site not in current_sites:
969         msg = "Site" + site + "doesn't exist"
970         raise SaltInvocationError(msg)
971     if not settings:
972         msg = "No settings provided"
973         raise SaltInvocationError(msg)
974     for setting in settings.keys():
975         if setting in availableSettings:
976             settings[setting] = str(settings[setting])
977         else:
978             availSetStr = ", ".join(availableSettings)
979             log.error("Unexpected setting: %s ", setting)
980             log.error("Available settings: %s", availSetStr)
981             msg = "Unexpected setting:" + setting + " Available settings:" + availSetStr
982             raise SaltInvocationError(msg)
983     current_settings = get_webapp_settings(
984         name=name, site=site, settings=settings.keys()
985     )
986     if settings == current_settings:
987         log.warning("Settings already contain the provided values.")
988         return True
989     for setting in settings:
990         try:
991             complex(settings[setting])
992             value = settings[setting]
993         except ValueError:
994             value = "'{}'".format(settings[setting])
995         if setting == "userName" or setting == "password":
996             pscmd.append(
997                 " Set-WebConfigurationProperty -Filter"
998                 " \"system.applicationHost/sites/site[@name='{}']/application[@path='/{}']/virtualDirectory[@path='/']\"".format(
999                     site, name
1000                 )
1001             )
1002             pscmd.append(' -Name "{}" -Value {};'.format(setting, value))
1003         if setting == "physicalPath" or setting == "applicationPool":
1004             pscmd.append(
1005                 r' Set-ItemProperty "IIS:\Sites\{}\{}" -Name {} -Value {};'.format(
1006                     site, name, setting, value
1007                 )
1008             )
1009             if setting == "physicalPath":
1010                 if not os.path.isdir(settings[setting]):
1011                     msg = "Path is not present: " + settings[setting]
1012                     raise SaltInvocationError(msg)
1013     cmd_ret = _srvmgr(pscmd)
1014     if cmd_ret["retcode"] != 0:
1015         msg = "Unable to set settings for web application {}".format(name)
1016         raise SaltInvocationError(msg)
1017     new_settings = get_webapp_settings(name=name, site=site, settings=settings.keys())
1018     failed_settings = dict()
1019     for setting in settings:
1020         if str(settings[setting]) != str(new_settings[setting]):
1021             failed_settings[setting] = settings[setting]
1022     if failed_settings:
1023         log.error("Failed to change settings: %s", failed_settings)
1024         return False
1025     log.debug("Settings configured successfully: %s", list(settings))
1026     return True
1027 def get_webconfiguration_settings(name, settings):
1028     r"""
1029     Get the webconfiguration settings for the IIS PSPath.
1030     Args:
1031         name (str): The PSPath of the IIS webconfiguration settings.
1032         settings (list): A list of dictionaries containing setting name and filter.
1033     Returns:
1034         dict: A list of dictionaries containing setting name, filter and value.
1035     CLI Example:
1036     .. code-block:: bash
1037         salt '*' win_iis.get_webconfiguration_settings name='IIS:\' settings="[{'name': 'enabled', 'filter': 'system.webServer/security/authentication/anonymousAuthentication'}]"
1038     ps_cmd = []
1039     settings = _prepare_settings(name, settings)
1040     if not settings:
1041         log.warning("No settings provided")
1042         return False
1043     for idx, setting in enumerate(settings):
1044         if setting["name"].split(".")[-1] != "Collection":
1045             settings[idx]["value"] = str(setting["value"])
1046     current_settings = get_webconfiguration_settings(name=name, settings=settings)
1047     if settings == current_settings:
1048         log.debug("Settings already contain the provided values.")
1049         return True
1050     for setting in settings:
1051         if setting["name"].split(".")[-1] != "Collection":
1052             try:
1053                 complex(setting["value"])
1054                 value = setting["value"]
1055             except ValueError:
1056                 value = "'{}'".format(setting["value"])
1057         else:
1058             configelement_list = []
1059             for value_item in setting["value"]:
1060                 configelement_construct = []
1061                 for key, value in value_item.items():
1062                     configelement_construct.append("{}='{}'".format(key, value))
1063                 configelement_list.append(
1064                     "@{" + ";".join(configelement_construct) + "}"
1065                 )
1066             value = ",".join(configelement_list)
1067         ps_cmd.extend(
1068             [
1069                 "Set-WebConfigurationProperty",
1070                 "-PSPath",
1071                 "'{}'".format(name),
1072                 "-Filter",
1073                 "'{}'".format(setting["filter"]),
1074                 "-Name",
1075                 "'{}'".format(setting["name"]),
1076                 "-Value",
1077                 "{};".format(value),
1078             ]
1079         )
1080     cmd_ret = _srvmgr(ps_cmd)
1081     if cmd_ret["retcode"] != 0:
1082         msg = "Unable to set settings for {}".format(name)
1083         raise CommandExecutionError(msg)
1084     new_settings = get_webconfiguration_settings(name=name, settings=settings)
1085     failed_settings = []
1086     for idx, setting in enumerate(settings):
1087         is_collection = setting["name"].split(".")[-1] == "Collection"
1088         if (
1089             not is_collection
1090             and str(setting["value"]) != str(new_settings[idx]["value"])
1091         ) or (
1092             is_collection
1093             and list(map(dict, setting["value"]))
1094             != list(map(dict, new_settings[idx]["value"]))
1095         ):
1096             failed_settings.append(setting)
1097     if failed_settings:
1098         log.error("Failed to change settings: %s", failed_settings)
1099         return False
1100     log.debug("Settings configured successfully: %s", settings)
1101     return True
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
