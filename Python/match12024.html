<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for couchdb.py & journald.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for couchdb.py & journald.py
      </h3>
      <h1 align="center">
        13.7%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>couchdb.py (20.3125%)<TH>journald.py (10.4%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match12024-0.html#0',2,'match12024-1.html#0',3)" NAME="0">(40-57)<TD><A HREF="javascript:ZweiFrames('match12024-0.html#0',2,'match12024-1.html#0',3)" NAME="0">(4-19)</A><TD ALIGN=center><FONT COLOR="#ff0000">13</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>couchdb.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
CouchDB sdb Module

:maintainer:    SaltStack
:maturity:      New
:depends:       python2-couchdb
:platform:      all

This allow interaction between Salt and a CouchDB [couchdb.apache.org]
database. It uses salt's `sdb` system to allow for inserts and retrevals
using the `sdb://` prefix in salt configuration files.

To use the couchbase sdb module, it must first be configured in the salt
master or minion config. The following arguments are required:

.. code-block:: yaml

    couchdb_sdb:
      driver: couchdb
      host: localhost
      port: 5984
      database: salt_sdb

One could then query the CouchDB instance via an `sdb://` URI such as the
following:

.. code-block:: yaml

    password: sdb://couchdb_sdb/mykey

To use this interface, you must track IDs on your own or have another source
to do the map-reduce logic necessary to calculate the ID you wish to fetch.

Additional contributions to build true map-reduce functionality into this module
would be welcome.
&quot;&quot;&quot;
<A NAME="0"></A>

# Import Python libraries
<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match12024-1.html#0',3,'match12024-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>import logging
from uuid import uuid4

# Import Salt libraries
from salt.utils.decorators import memoize

try:
    import couchdb

    HAS_COUCH = True
except ImportError:
    HAS_COUCH = False


log = logging.getLogger(__name__)

# 'set' is a reserved word
__func_alias__ =</B></FONT> {&quot;set_&quot;: &quot;set&quot;}


def __virtual__():
    &quot;&quot;&quot;
    Require the python2-couchdb libraries
    &quot;&quot;&quot;
    return HAS_COUCH


@memoize
def _construct_uri(profile):
    &quot;&quot;&quot;
    Examine configuration and return
    a uri for the couchdb server in the following format:

    .. code-block:: bash

        http://localhost:5984/
    &quot;&quot;&quot;
    return &quot;http://{host}:{port}&quot;.format(**profile)


def _get_conn(profile):
    &quot;&quot;&quot;
    Get a connection to CouchDB
    &quot;&quot;&quot;
    DEFAULT_BASE_URL = _construct_uri(profile) or &quot;http://localhost:5984&quot;

    server = couchdb.Server()
    if profile[&quot;database&quot;] not in server:
        server.create(profile[&quot;database&quot;])
    return server


def set_(key, value, profile=None):
    &quot;&quot;&quot;
    Set a key/value pair in couchdb
    &quot;&quot;&quot;
    db = _get_db(profile)
    return db.save({&quot;_id&quot;: uuid4().hex, key: value})


def get(key, profile=None):
    &quot;&quot;&quot;
    Get a value from couchdb by id
    &quot;&quot;&quot;
    db = _get_db(profile)
    return db.get(key)


def _get_db(profile):
    &quot;&quot;&quot;
    Wraps _get_conn() to return a db
    &quot;&quot;&quot;
    server = _get_conn(profile)
    db = _get_db(profile)
    return db
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>journald.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
<A NAME="0"></A>&quot;&quot;&quot;
A simple beacon to watch journald for specific entries
&quot;&quot;&quot;
<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match12024-0.html#0',2,'match12024-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>import logging

import salt.utils.beacons
import salt.utils.data

try:
    import systemd.journal  # pylint: disable=no-name-in-module

    HAS_SYSTEMD = True
except ImportError:
    HAS_SYSTEMD = False


log = logging.getLogger(__name__)

__virtualname__ =</B></FONT> &quot;journald&quot;


def __virtual__():
    if HAS_SYSTEMD:
        return __virtualname__
    err_msg = &quot;systemd library is missing.&quot;
    log.error(&quot;Unable to load %s beacon: %s&quot;, __virtualname__, err_msg)
    return False, err_msg


def _get_journal():
    &quot;&quot;&quot;
    Return the active running journal object
    &quot;&quot;&quot;
    if &quot;systemd.journald&quot; in __context__:
        return __context__[&quot;systemd.journald&quot;]
    __context__[&quot;systemd.journald&quot;] = systemd.journal.Reader()
    # get to the end of the journal
    __context__[&quot;systemd.journald&quot;].seek_tail()
    __context__[&quot;systemd.journald&quot;].get_previous()
    return __context__[&quot;systemd.journald&quot;]


def validate(config):
    &quot;&quot;&quot;
    Validate the beacon configuration
    &quot;&quot;&quot;
    # Configuration for journald beacon should be a list of dicts
    if not isinstance(config, list):
        return (False, &quot;Configuration for journald beacon must be a list.&quot;)
    else:
        config = salt.utils.beacons.list_to_dict(config)

        for name in config.get(&quot;services&quot;, {}):
            if not isinstance(config[&quot;services&quot;][name], dict):
                return (
                    False,
                    &quot;Services configuration for journald beacon must be a list of&quot;
                    &quot; dictionaries.&quot;,
                )
    return True, &quot;Valid beacon configuration&quot;


def beacon(config):
    &quot;&quot;&quot;
    The journald beacon allows for the systemd journal to be parsed and linked
    objects to be turned into events.

    This beacons config will return all sshd jornal entries

    .. code-block:: yaml

        beacons:
          journald:
            - services:
                sshd:
                  SYSLOG_IDENTIFIER: sshd
                  PRIORITY: 6
    &quot;&quot;&quot;
    ret = []
    journal = _get_journal()

    config = salt.utils.beacons.list_to_dict(config)

    while True:
        cur = journal.get_next()
        if not cur:
            break

        for name in config.get(&quot;services&quot;, {}):
            n_flag = 0
            for key in config[&quot;services&quot;][name]:
                if isinstance(key, str):
                    key = salt.utils.data.decode(key)
                if key in cur:
                    if config[&quot;services&quot;][name][key] == cur[key]:
                        n_flag += 1
            if n_flag == len(config[&quot;services&quot;][name]):
                # Match!
                sub = salt.utils.data.simple_types_filter(cur)
                sub.update({&quot;tag&quot;: name})
                ret.append(sub)
    return ret
</PRE>
</div>
  </div>
</body>
</html>
