<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_state_format_slots.py & test_symlink_1.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_state_format_slots.py & test_symlink_1.py
      </h3>
      <h1 align="center">
        7.0%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_state_format_slots.py (9.404388%)<TH>test_symlink_1.py (5.6497173%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match36852-0.html#0',2,'match36852-1.html#0',3)" NAME="0">(130-137)<TD><A HREF="javascript:ZweiFrames('match36852-0.html#0',2,'match36852-1.html#0',3)" NAME="0">(72-77)</A><TD ALIGN=center><FONT COLOR="#ff0000">17</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match36852-0.html#1',2,'match36852-1.html#1',3)" NAME="1">(5-19)<TD><A HREF="javascript:ZweiFrames('match36852-0.html#1',2,'match36852-1.html#1',3)" NAME="1">(9-22)</A><TD ALIGN=center><FONT COLOR="#c30000">13</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_state_format_slots.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
<A NAME="1"></A>    :codeauthor: Nicole Thomas &lt;nicole@saltstack.com&gt;
&quot;&quot;&quot;

<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match36852-1.html#1',3,'match36852-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>import logging

import pytest  # pylint: disable=unused-import
import salt.exceptions
import salt.state
import salt.utils.files
import salt.utils.platform
from tests.support.mock import MagicMock, patch
from tests.support.unit import skipIf

log = logging.getLogger(__name__)


@pytest.fixture
def</B></FONT> state_obj():
    with patch(&quot;salt.state.State._gather_pillar&quot;):
        minion_opts = salt.config.DEFAULT_MINION_OPTS.copy()
        yield salt.state.State(minion_opts)


def test_format_slots_no_slots(state_obj):
    &quot;&quot;&quot;
    Test the format slots keeps data without slots untouched.
    &quot;&quot;&quot;
    cdata = {&quot;args&quot;: [&quot;arg&quot;], &quot;kwargs&quot;: {&quot;key&quot;: &quot;val&quot;}}
    state_obj.format_slots(cdata)
    assert cdata == {&quot;args&quot;: [&quot;arg&quot;], &quot;kwargs&quot;: {&quot;key&quot;: &quot;val&quot;}}


@pytest.mark.slow_test
def test_format_slots_arg(state_obj):
    &quot;&quot;&quot;
    Test the format slots is calling a slot specified in args with corresponding arguments.
    &quot;&quot;&quot;
    cdata = {
        &quot;args&quot;: [&quot;__slot__:salt:mod.fun(fun_arg, fun_key=fun_val)&quot;],
        &quot;kwargs&quot;: {&quot;key&quot;: &quot;val&quot;},
    }
    mock = MagicMock(return_value=&quot;fun_return&quot;)
    with patch.dict(state_obj.functions, {&quot;mod.fun&quot;: mock}):
        state_obj.format_slots(cdata)
    mock.assert_called_once_with(&quot;fun_arg&quot;, fun_key=&quot;fun_val&quot;)
    assert cdata == {&quot;args&quot;: [&quot;fun_return&quot;], &quot;kwargs&quot;: {&quot;key&quot;: &quot;val&quot;}}


@pytest.mark.slow_test
def test_format_slots_dict_arg(state_obj):
    &quot;&quot;&quot;
    Test the format slots is calling a slot specified in dict arg.
    &quot;&quot;&quot;
    cdata = {
        &quot;args&quot;: [{&quot;subarg&quot;: &quot;__slot__:salt:mod.fun(fun_arg, fun_key=fun_val)&quot;}],
        &quot;kwargs&quot;: {&quot;key&quot;: &quot;val&quot;},
    }
    mock = MagicMock(return_value=&quot;fun_return&quot;)
    with patch.dict(state_obj.functions, {&quot;mod.fun&quot;: mock}):
        state_obj.format_slots(cdata)
    mock.assert_called_once_with(&quot;fun_arg&quot;, fun_key=&quot;fun_val&quot;)
    assert cdata == {&quot;args&quot;: [{&quot;subarg&quot;: &quot;fun_return&quot;}], &quot;kwargs&quot;: {&quot;key&quot;: &quot;val&quot;}}


@pytest.mark.slow_test
def test_format_slots_listdict_arg(state_obj):
    &quot;&quot;&quot;
    Test the format slots is calling a slot specified in list containing a dict.
    &quot;&quot;&quot;
    cdata = {
        &quot;args&quot;: [[{&quot;subarg&quot;: &quot;__slot__:salt:mod.fun(fun_arg, fun_key=fun_val)&quot;}]],
        &quot;kwargs&quot;: {&quot;key&quot;: &quot;val&quot;},
    }
    mock = MagicMock(return_value=&quot;fun_return&quot;)
    with patch.dict(state_obj.functions, {&quot;mod.fun&quot;: mock}):
        state_obj.format_slots(cdata)
    mock.assert_called_once_with(&quot;fun_arg&quot;, fun_key=&quot;fun_val&quot;)
    assert cdata == {&quot;args&quot;: [[{&quot;subarg&quot;: &quot;fun_return&quot;}]], &quot;kwargs&quot;: {&quot;key&quot;: &quot;val&quot;}}


@pytest.mark.slow_test
def test_format_slots_liststr_arg(state_obj):
    &quot;&quot;&quot;
    Test the format slots is calling a slot specified in list containing a dict.
    &quot;&quot;&quot;
    cdata = {
        &quot;args&quot;: [[&quot;__slot__:salt:mod.fun(fun_arg, fun_key=fun_val)&quot;]],
        &quot;kwargs&quot;: {&quot;key&quot;: &quot;val&quot;},
    }
    mock = MagicMock(return_value=&quot;fun_return&quot;)
    with patch.dict(state_obj.functions, {&quot;mod.fun&quot;: mock}):
        state_obj.format_slots(cdata)
    mock.assert_called_once_with(&quot;fun_arg&quot;, fun_key=&quot;fun_val&quot;)
    assert cdata == {&quot;args&quot;: [[&quot;fun_return&quot;]], &quot;kwargs&quot;: {&quot;key&quot;: &quot;val&quot;}}


@pytest.mark.slow_test
def test_format_slots_kwarg(state_obj):
    &quot;&quot;&quot;
    Test the format slots is calling a slot specified in kwargs with corresponding arguments.
    &quot;&quot;&quot;
    cdata = {
        &quot;args&quot;: [&quot;arg&quot;],
        &quot;kwargs&quot;: {&quot;key&quot;: &quot;__slot__:salt:mod.fun(fun_arg, fun_key=fun_val)&quot;},
    }
    mock = MagicMock(return_value=&quot;fun_return&quot;)
    with patch.dict(state_obj.functions, {&quot;mod.fun&quot;: mock}):
        state_obj.format_slots(cdata)
    mock.assert_called_once_with(&quot;fun_arg&quot;, fun_key=&quot;fun_val&quot;)
    assert cdata == {&quot;args&quot;: [&quot;arg&quot;], &quot;kwargs&quot;: {&quot;key&quot;: &quot;fun_return&quot;}}


@pytest.mark.slow_test
def test_format_slots_multi(state_obj):
    &quot;&quot;&quot;
    Test the format slots is calling all slots with corresponding arguments when multiple slots
    specified.
    &quot;&quot;&quot;
    cdata = {
        &quot;args&quot;: [
            &quot;__slot__:salt:test_mod.fun_a(a_arg, a_key=a_kwarg)&quot;,
            &quot;__slot__:salt:test_mod.fun_b(b_arg, b_key=b_kwarg)&quot;,
        ],
        &quot;kwargs&quot;: {
            &quot;kw_key_1&quot;: &quot;__slot__:salt:test_mod.fun_c(c_arg, c_key=c_kwarg)&quot;,
<A NAME="0"></A>            &quot;kw_key_2&quot;: &quot;__slot__:salt:test_mod.fun_d(d_arg, d_key=d_kwarg)&quot;,
        },
    }
    mock_a <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match36852-1.html#0',3,'match36852-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= MagicMock(return_value=&quot;fun_a_return&quot;)
    mock_b = MagicMock(return_value=&quot;fun_b_return&quot;)
    mock_c = MagicMock(return_value=&quot;fun_c_return&quot;)
    mock_d = MagicMock(return_value=&quot;fun_d_return&quot;)
    with patch.dict(
        state_obj.functions,
        {
            &quot;test_mod.fun_a&quot;</B></FONT>: mock_a,
            &quot;test_mod.fun_b&quot;: mock_b,
            &quot;test_mod.fun_c&quot;: mock_c,
            &quot;test_mod.fun_d&quot;: mock_d,
        },
    ):
        state_obj.format_slots(cdata)
    mock_a.assert_called_once_with(&quot;a_arg&quot;, a_key=&quot;a_kwarg&quot;)
    mock_b.assert_called_once_with(&quot;b_arg&quot;, b_key=&quot;b_kwarg&quot;)
    mock_c.assert_called_once_with(&quot;c_arg&quot;, c_key=&quot;c_kwarg&quot;)
    mock_d.assert_called_once_with(&quot;d_arg&quot;, d_key=&quot;d_kwarg&quot;)
    assert cdata == {
        &quot;args&quot;: [&quot;fun_a_return&quot;, &quot;fun_b_return&quot;],
        &quot;kwargs&quot;: {&quot;kw_key_1&quot;: &quot;fun_c_return&quot;, &quot;kw_key_2&quot;: &quot;fun_d_return&quot;},
    }


@pytest.mark.slow_test
def test_format_slots_malformed(state_obj):
    &quot;&quot;&quot;
    Test the format slots keeps malformed slots untouched.
    &quot;&quot;&quot;
    sls_data = {
        &quot;args&quot;: [
            &quot;__slot__:NOT_SUPPORTED:not.called()&quot;,
            &quot;__slot__:salt:not.called(&quot;,
            &quot;__slot__:salt:&quot;,
            &quot;__slot__:salt&quot;,
            &quot;__slot__:&quot;,
            &quot;__slot__&quot;,
        ],
        &quot;kwargs&quot;: {
            &quot;key3&quot;: &quot;__slot__:NOT_SUPPORTED:not.called()&quot;,
            &quot;key4&quot;: &quot;__slot__:salt:not.called(&quot;,
            &quot;key5&quot;: &quot;__slot__:salt:&quot;,
            &quot;key6&quot;: &quot;__slot__:salt&quot;,
            &quot;key7&quot;: &quot;__slot__:&quot;,
            &quot;key8&quot;: &quot;__slot__&quot;,
        },
    }
    cdata = sls_data.copy()
    mock = MagicMock(return_value=&quot;return&quot;)
    with patch.dict(state_obj.functions, {&quot;not.called&quot;: mock}):
        state_obj.format_slots(cdata)
    mock.assert_not_called()
    assert cdata == sls_data


@pytest.mark.slow_test
def test_slot_traverse_dict(state_obj):
    &quot;&quot;&quot;
    Test the slot parsing of dict response.
    &quot;&quot;&quot;
    cdata = {
        &quot;args&quot;: [&quot;arg&quot;],
        &quot;kwargs&quot;: {&quot;key&quot;: &quot;__slot__:salt:mod.fun(fun_arg, fun_key=fun_val).key1&quot;},
    }
    return_data = {&quot;key1&quot;: &quot;value1&quot;}
    mock = MagicMock(return_value=return_data)
    with patch.dict(state_obj.functions, {&quot;mod.fun&quot;: mock}):
        state_obj.format_slots(cdata)
    mock.assert_called_once_with(&quot;fun_arg&quot;, fun_key=&quot;fun_val&quot;)
    assert cdata == {&quot;args&quot;: [&quot;arg&quot;], &quot;kwargs&quot;: {&quot;key&quot;: &quot;value1&quot;}}


@pytest.mark.slow_test
def test_slot_append(state_obj):
    &quot;&quot;&quot;
    Test the slot parsing of dict response.
    &quot;&quot;&quot;
    cdata = {
        &quot;args&quot;: [&quot;arg&quot;],
        &quot;kwargs&quot;: {
            &quot;key&quot;: &quot;__slot__:salt:mod.fun(fun_arg, fun_key=fun_val).key1 ~ thing~&quot;,
        },
    }
    return_data = {&quot;key1&quot;: &quot;value1&quot;}
    mock = MagicMock(return_value=return_data)
    with patch.dict(state_obj.functions, {&quot;mod.fun&quot;: mock}):
        state_obj.format_slots(cdata)
    mock.assert_called_once_with(&quot;fun_arg&quot;, fun_key=&quot;fun_val&quot;)
    assert cdata == {&quot;args&quot;: [&quot;arg&quot;], &quot;kwargs&quot;: {&quot;key&quot;: &quot;value1thing~&quot;}}


# Skip on windows like integration.modules.test_state.StateModuleTest.test_parallel_state_with_long_tag
@skipIf(
    salt.utils.platform.is_windows(),
    &quot;Skipped until parallel states can be fixed on Windows&quot;,
)
def test_format_slots_parallel(state_obj):
    &quot;&quot;&quot;
    Test if slots work with &quot;parallel: true&quot;.
    &quot;&quot;&quot;
    high_data = {
        &quot;always-changes-and-succeeds&quot;: {
            &quot;test&quot;: [
                {&quot;changes&quot;: True},
                {&quot;comment&quot;: &quot;__slot__:salt:test.echo(fun_return)&quot;},
                {&quot;parallel&quot;: True},
                &quot;configurable_test_state&quot;,
                {&quot;order&quot;: 10000},
            ],
            &quot;__env__&quot;: &quot;base&quot;,
            &quot;__sls__&quot;: &quot;parallel_slots&quot;,
        }
    }
    state_obj.jid = &quot;123&quot;
    res = state_obj.call_high(high_data)
    state_obj.jid = None
    [(_, data)] = res.items()
    assert data[&quot;comment&quot;] == &quot;fun_return&quot;
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_symlink_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
import logging
import os

import pytest
import salt.serializers.json as jsonserializer
<A NAME="1"></A>import salt.serializers.msgpack as msgpackserializer
import salt.serializers.plist as plistserializer
import salt.serializers.python as pythonserializer
<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match36852-0.html#1',2,'match36852-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>import salt.serializers.yaml as yamlserializer
import salt.states.file as filestate
import salt.utils.files
import salt.utils.json
import salt.utils.platform
import salt.utils.win_functions
import salt.utils.yaml
from tests.support.mock import MagicMock, patch

log = logging.getLogger(__name__)


@pytest.fixture
def</B></FONT> configure_loader_modules():
    return {
        filestate: {
            &quot;__env__&quot;: &quot;base&quot;,
            &quot;__salt__&quot;: {&quot;file.manage_file&quot;: False},
            &quot;__serializers__&quot;: {
                &quot;yaml.serialize&quot;: yamlserializer.serialize,
                &quot;yaml.seserialize&quot;: yamlserializer.serialize,
                &quot;python.serialize&quot;: pythonserializer.serialize,
                &quot;json.serialize&quot;: jsonserializer.serialize,
                &quot;plist.serialize&quot;: plistserializer.serialize,
                &quot;msgpack.serialize&quot;: msgpackserializer.serialize,
            },
            &quot;__opts__&quot;: {&quot;test&quot;: False, &quot;cachedir&quot;: &quot;&quot;},
            &quot;__instance_id__&quot;: &quot;&quot;,
            &quot;__low__&quot;: {},
            &quot;__utils__&quot;: {},
        }
    }


def test_symlink():
    &quot;&quot;&quot;
    Test to create a symlink.
    &quot;&quot;&quot;
    name = os.sep + os.path.join(&quot;tmp&quot;, &quot;testfile.txt&quot;)
    target = salt.utils.files.mkstemp()
    test_dir = os.sep + &quot;tmp&quot;
    user = &quot;salt&quot;

    if salt.utils.platform.is_windows():
        group = &quot;salt&quot;
    else:
        group = &quot;saltstack&quot;

    def return_val(kwargs):
        val = {
            &quot;name&quot;: name,
            &quot;result&quot;: False,
            &quot;comment&quot;: &quot;&quot;,
            &quot;changes&quot;: {},
        }
        val.update(kwargs)
        return val

    mock_t = MagicMock(return_value=True)
    mock_f = MagicMock(return_value=False)
<A NAME="0"></A>    mock_empty = MagicMock(return_value=&quot;&quot;)
    mock_uid = MagicMock(return_value=&quot;U1001&quot;)
    mock_gid = MagicMock(return_value=&quot;g1001&quot;)
    mock_target <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match36852-0.html#0',2,'match36852-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= MagicMock(return_value=target)
    mock_user = MagicMock(return_value=user)
    mock_grp = MagicMock(return_value=group)
    mock_os_error = MagicMock(side_effect=OSError)

    with patch.dict(filestate.__salt__, {&quot;config.manage_mode&quot;</B></FONT>: mock_t}):
        comt = &quot;Must provide name to file.symlink&quot;
        ret = return_val({&quot;comment&quot;: comt, &quot;name&quot;: &quot;&quot;})
        assert filestate.symlink(&quot;&quot;, target) == ret

    with patch.dict(
        filestate.__salt__,
        {
            &quot;config.manage_mode&quot;: mock_t,
            &quot;file.user_to_uid&quot;: mock_empty,
            &quot;file.group_to_gid&quot;: mock_empty,
            &quot;user.info&quot;: mock_empty,
            &quot;user.current&quot;: mock_user,
        },
    ):
        if salt.utils.platform.is_windows():
            comt = &quot;User {} does not exist&quot;.format(user)
            ret = return_val({&quot;comment&quot;: comt, &quot;name&quot;: name})
        else:
            comt = &quot;User {} does not exist. Group {} does not exist.&quot;.format(
                user, group
            )
            ret = return_val({&quot;comment&quot;: comt, &quot;name&quot;: name})
        assert filestate.symlink(name, target, user=user, group=group) == ret

    with patch.dict(
        filestate.__salt__,
        {
            &quot;config.manage_mode&quot;: mock_t,
            &quot;file.user_to_uid&quot;: mock_uid,
            &quot;file.group_to_gid&quot;: mock_gid,
            &quot;file.is_link&quot;: mock_f,
            &quot;user.info&quot;: mock_empty,
            &quot;user.current&quot;: mock_user,
        },
    ), patch.dict(filestate.__opts__, {&quot;test&quot;: True}), patch.object(
        os.path, &quot;exists&quot;, mock_f
    ):
        if salt.utils.platform.is_windows():
            comt = &quot;User {} does not exist&quot;.format(user)
            ret = return_val(
                {&quot;comment&quot;: comt, &quot;result&quot;: False, &quot;name&quot;: name, &quot;changes&quot;: {}}
            )
        else:
            comt = &quot;Symlink {} to {} is set for creation&quot;.format(name, target)
            ret = return_val(
                {&quot;comment&quot;: comt, &quot;result&quot;: None, &quot;changes&quot;: {&quot;new&quot;: name}}
            )
        assert filestate.symlink(name, target, user=user, group=group) == ret

    with patch.dict(
        filestate.__salt__,
        {
            &quot;config.manage_mode&quot;: mock_t,
            &quot;file.user_to_uid&quot;: mock_uid,
            &quot;file.group_to_gid&quot;: mock_gid,
            &quot;file.is_link&quot;: mock_f,
            &quot;user.info&quot;: mock_empty,
            &quot;user.current&quot;: mock_user,
        },
    ), patch.dict(filestate.__opts__, {&quot;test&quot;: False}), patch.object(
        os.path, &quot;isdir&quot;, mock_f
    ), patch.object(
        os.path, &quot;exists&quot;, mock_f
    ):
        if salt.utils.platform.is_windows():
            comt = &quot;User {} does not exist&quot;.format(user)
            ret = return_val(
                {&quot;comment&quot;: comt, &quot;result&quot;: False, &quot;name&quot;: name, &quot;changes&quot;: {}}
            )
        else:
            comt = &quot;Directory {} for symlink is not present&quot;.format(test_dir)
            ret = return_val({&quot;comment&quot;: comt, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert filestate.symlink(name, target, user=user, group=group) == ret

    with patch.dict(
        filestate.__salt__,
        {
            &quot;config.manage_mode&quot;: mock_t,
            &quot;file.user_to_uid&quot;: mock_uid,
            &quot;file.group_to_gid&quot;: mock_gid,
            &quot;file.is_link&quot;: mock_t,
            &quot;file.readlink&quot;: mock_target,
            &quot;user.info&quot;: mock_empty,
            &quot;user.current&quot;: mock_user,
        },
    ), patch.dict(filestate.__opts__, {&quot;test&quot;: False}), patch.object(
        os.path, &quot;isdir&quot;, mock_t
    ), patch.object(
        salt.states.file, &quot;_check_symlink_ownership&quot;, mock_t
    ), patch(
        &quot;salt.utils.win_functions.get_sid_from_name&quot;, return_value=&quot;test-sid&quot;
    ):
        if salt.utils.platform.is_windows():
            comt = &quot;Symlink {} is present and owned by {}&quot;.format(name, user)
        else:
            comt = &quot;Symlink {} is present and owned by {}:{}&quot;.format(name, user, group)
        ret = return_val({&quot;comment&quot;: comt, &quot;result&quot;: True, &quot;changes&quot;: {}})
        assert filestate.symlink(name, target, user=user, group=group) == ret

    with patch.dict(
        filestate.__salt__,
        {
            &quot;config.manage_mode&quot;: mock_t,
            &quot;file.user_to_uid&quot;: mock_uid,
            &quot;file.group_to_gid&quot;: mock_gid,
            &quot;file.is_link&quot;: mock_f,
            &quot;file.readlink&quot;: mock_target,
            &quot;user.info&quot;: mock_empty,
            &quot;user.current&quot;: mock_user,
        },
    ), patch.dict(filestate.__opts__, {&quot;test&quot;: False}), patch.object(
        os.path, &quot;isdir&quot;, mock_t
    ), patch.object(
        os.path, &quot;exists&quot;, mock_t
    ), patch.object(
        os.path, &quot;lexists&quot;, mock_t
    ), patch(
        &quot;salt.utils.win_functions.get_sid_from_name&quot;, return_value=&quot;test-sid&quot;
    ):
        comt = (
            &quot;Symlink &amp; backup dest exists and Force not set. {} -&gt; &quot;
            &quot;{} - backup: {}&quot;.format(name, target, os.path.join(test_dir, &quot;SALT&quot;))
        )
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert (
            filestate.symlink(name, target, user=user, group=group, backupname=&quot;SALT&quot;)
            == ret
        )

    with patch.dict(
        filestate.__salt__,
        {
            &quot;config.manage_mode&quot;: mock_t,
            &quot;file.user_to_uid&quot;: mock_uid,
            &quot;file.group_to_gid&quot;: mock_gid,
            &quot;file.is_link&quot;: mock_f,
            &quot;file.readlink&quot;: mock_target,
            &quot;user.info&quot;: mock_empty,
            &quot;user.current&quot;: mock_user,
        },
    ), patch.dict(filestate.__opts__, {&quot;test&quot;: False}), patch.object(
        os.path, &quot;exists&quot;, mock_t
    ), patch.object(
        os.path, &quot;isfile&quot;, mock_t
    ), patch.object(
        os.path, &quot;isdir&quot;, mock_t
    ), patch(
        &quot;salt.utils.win_functions.get_sid_from_name&quot;, return_value=&quot;test-sid&quot;
    ):
        comt = &quot;Backupname must be an absolute path or a file name: {}&quot;.format(
            &quot;tmp/SALT&quot;
        )
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert (
            filestate.symlink(
                name, target, user=user, group=group, backupname=&quot;tmp/SALT&quot;
            )
            == ret
        )

    with patch.dict(
        filestate.__salt__,
        {
            &quot;config.manage_mode&quot;: mock_t,
            &quot;file.user_to_uid&quot;: mock_uid,
            &quot;file.group_to_gid&quot;: mock_gid,
            &quot;file.is_link&quot;: mock_f,
            &quot;file.readlink&quot;: mock_target,
            &quot;user.info&quot;: mock_empty,
            &quot;user.current&quot;: mock_user,
        },
    ), patch.dict(filestate.__opts__, {&quot;test&quot;: False}), patch.object(
        os.path, &quot;isdir&quot;, mock_t
    ), patch.object(
        os.path, &quot;exists&quot;, mock_t
    ), patch.object(
        os.path, &quot;isfile&quot;, mock_t
    ), patch(
        &quot;salt.utils.win_functions.get_sid_from_name&quot;, return_value=&quot;test-sid&quot;
    ):
        comt = &quot;File exists where the symlink {} should be&quot;.format(name)
        ret = return_val({&quot;comment&quot;: comt, &quot;changes&quot;: {}, &quot;result&quot;: False})
        assert filestate.symlink(name, target, user=user, group=group) == ret

    with patch.dict(
        filestate.__salt__,
        {
            &quot;config.manage_mode&quot;: mock_t,
            &quot;file.user_to_uid&quot;: mock_uid,
            &quot;file.group_to_gid&quot;: mock_gid,
            &quot;file.is_link&quot;: mock_f,
            &quot;file.readlink&quot;: mock_target,
            &quot;file.symlink&quot;: mock_t,
            &quot;user.info&quot;: mock_t,
            &quot;file.lchown&quot;: mock_f,
        },
    ), patch.dict(filestate.__opts__, {&quot;test&quot;: False}), patch.object(
        os.path, &quot;isdir&quot;, MagicMock(side_effect=[True, False])
    ), patch.object(
        os.path, &quot;isdir&quot;, mock_t
    ), patch.object(
        os.path, &quot;exists&quot;, mock_t
    ), patch(
        &quot;salt.utils.win_functions.get_sid_from_name&quot;, return_value=&quot;test-sid&quot;
    ):
        comt = &quot;Directory exists where the symlink {} should be&quot;.format(name)
        ret = return_val({&quot;comment&quot;: comt, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert filestate.symlink(name, target, user=user, group=group) == ret

    with patch.dict(
        filestate.__salt__,
        {
            &quot;config.manage_mode&quot;: mock_t,
            &quot;file.user_to_uid&quot;: mock_uid,
            &quot;file.group_to_gid&quot;: mock_gid,
            &quot;file.is_link&quot;: mock_f,
            &quot;file.readlink&quot;: mock_target,
            &quot;file.symlink&quot;: mock_os_error,
            &quot;user.info&quot;: mock_t,
            &quot;file.lchown&quot;: mock_f,
        },
    ), patch.dict(filestate.__opts__, {&quot;test&quot;: False}), patch.object(
        os.path, &quot;isdir&quot;, MagicMock(side_effect=[True, False])
    ), patch.object(
        os.path, &quot;isfile&quot;, mock_f
    ), patch(
        &quot;salt.utils.win_functions.get_sid_from_name&quot;, return_value=&quot;test-sid&quot;
    ):
        comt = &quot;Unable to create new symlink {} -&gt; {}: &quot;.format(name, target)
        ret = return_val({&quot;comment&quot;: comt, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert filestate.symlink(name, target, user=user, group=group) == ret

    with patch.dict(
        filestate.__salt__,
        {
            &quot;config.manage_mode&quot;: mock_t,
            &quot;file.user_to_uid&quot;: mock_uid,
            &quot;file.group_to_gid&quot;: mock_gid,
            &quot;file.is_link&quot;: mock_f,
            &quot;file.readlink&quot;: mock_target,
            &quot;file.symlink&quot;: mock_t,
            &quot;user.info&quot;: mock_t,
            &quot;file.lchown&quot;: mock_f,
            &quot;file.get_user&quot;: mock_user,
            &quot;file.get_group&quot;: mock_grp,
        },
    ), patch.dict(filestate.__opts__, {&quot;test&quot;: False}), patch.object(
        os.path, &quot;isdir&quot;, MagicMock(side_effect=[True, False])
    ), patch.object(
        os.path, &quot;isfile&quot;, mock_f
    ), patch(
        &quot;salt.states.file._check_symlink_ownership&quot;, return_value=True
    ), patch(
        &quot;salt.utils.win_functions.get_sid_from_name&quot;, return_value=&quot;test-sid&quot;
    ):
        comt = &quot;Created new symlink {} -&gt; {}&quot;.format(name, target)
        ret = return_val({&quot;comment&quot;: comt, &quot;result&quot;: True, &quot;changes&quot;: {&quot;new&quot;: name}})
        assert filestate.symlink(name, target, user=user, group=group) == ret

    with patch.dict(
        filestate.__salt__,
        {
            &quot;config.manage_mode&quot;: mock_t,
            &quot;file.user_to_uid&quot;: mock_uid,
            &quot;file.group_to_gid&quot;: mock_gid,
            &quot;file.is_link&quot;: mock_f,
            &quot;file.readlink&quot;: mock_target,
            &quot;file.symlink&quot;: mock_t,
            &quot;user.info&quot;: mock_t,
            &quot;file.lchown&quot;: mock_f,
            &quot;file.get_user&quot;: mock_empty,
            &quot;file.get_group&quot;: mock_empty,
        },
    ), patch.dict(filestate.__opts__, {&quot;test&quot;: False}), patch.object(
        os.path, &quot;isdir&quot;, MagicMock(side_effect=[True, False])
    ), patch.object(
        os.path, &quot;isfile&quot;, mock_f
    ), patch(
        &quot;salt.utils.win_functions.get_sid_from_name&quot;, return_value=&quot;test-sid&quot;
    ), patch(
        &quot;salt.states.file._set_symlink_ownership&quot;, return_value=False
    ), patch(
        &quot;salt.states.file._check_symlink_ownership&quot;, return_value=False
    ):
        comt = (
            &quot;Created new symlink {} -&gt; {}, but was unable to set &quot;
            &quot;ownership to {}:{}&quot;.format(name, target, user, group)
        )
        ret = return_val({&quot;comment&quot;: comt, &quot;result&quot;: False, &quot;changes&quot;: {&quot;new&quot;: name}})
        assert filestate.symlink(name, target, user=user, group=group) == ret

    with patch.dict(
        filestate.__salt__,
        {
            &quot;config.manage_mode&quot;: mock_t,
            &quot;file.user_to_uid&quot;: mock_uid,
            &quot;file.group_to_gid&quot;: mock_gid,
            &quot;file.is_link&quot;: mock_f,
            &quot;file.readlink&quot;: mock_target,
            &quot;file.symlink&quot;: mock_t,
            &quot;user.info&quot;: mock_t,
            &quot;file.lchown&quot;: mock_f,
            &quot;file.get_user&quot;: mock_empty,
            &quot;file.get_group&quot;: mock_empty,
        },
    ), patch.dict(filestate.__opts__, {&quot;test&quot;: False}), patch.object(
        os.path, &quot;isdir&quot;, MagicMock(side_effect=[True, False])
    ), patch.object(
        os.path, &quot;isfile&quot;, mock_f
    ), patch(
        &quot;salt.utils.win_functions.get_sid_from_name&quot;, return_value=&quot;test-sid&quot;
    ), patch(
        &quot;salt.states.file._set_symlink_ownership&quot;, return_value=True
    ), patch(
        &quot;salt.states.file._check_symlink_ownership&quot;, return_value=True
    ):
        group = None

        comt = &quot;Created new symlink {} -&gt; {}&quot;.format(name, target)
        ret = return_val({&quot;comment&quot;: comt, &quot;result&quot;: True, &quot;changes&quot;: {&quot;new&quot;: name}})
        res = filestate.symlink(name, target, user=user, group=user)
        assert res == ret
</PRE>
</div>
  </div>
</body>
</html>
