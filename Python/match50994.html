<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for pillar_1.py &amp; test_file_selinux.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for pillar_1.py &amp; test_file_selinux.py
      </h3>
<h1 align="center">
        5.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>pillar_1.py (4.0229883%)<th>test_file_selinux.py (9.722222%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(5-20)<td><a href="#" name="0">(1-16)</a><td align="center"><font color="#ff0000">14</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>pillar_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import copy
2 import logging
3 import os
4 from collections.abc import Mapping
5 import salt.pillar
6 import salt.utils.crypt
7 import salt.utils.data
8 import salt.utils.dictupdate
9 import salt.utils.functools
10 import salt.utils.odict
11 import salt.utils.yaml
12 from salt.defaults import DEFAULT_TARGET_DELIM
13 from salt.exceptions import CommandExecutionError
14 __proxyenabled__ =</b></font> ["*"]
15 log = logging.getLogger(__name__)
16 def get(
17     key,
18     default=None,
19     merge=False,
20     merge_nested_lists=None,
21     delimiter=DEFAULT_TARGET_DELIM,
22     pillarenv=None,
23     saltenv=None,
24 ):
25     if default is None:
26         default = KeyError
27     if not __opts__.get("pillar_raise_on_missing"):
28         if default is KeyError:
29             default = ""
30     opt_merge_lists = (
31         __opts__.get("pillar_merge_lists", False)
32         if merge_nested_lists is None
33         else merge_nested_lists
34     )
35     pillar_dict = (
36         __pillar__
37         if all(x is None for x in (saltenv, pillarenv))
38         else items(saltenv=saltenv, pillarenv=pillarenv)
39     )
40     if merge:
41         if isinstance(default, dict):
42             ret = salt.utils.data.traverse_dict_and_list(
43                 pillar_dict, key, {}, delimiter
44             )
45             if isinstance(ret, Mapping):
46                 default = copy.deepcopy(default)
47                 return salt.utils.dictupdate.update(
48                     default, ret, merge_lists=opt_merge_lists
49                 )
50             else:
51                 log.error(
52                     "pillar.get: Default (%s) is a dict, but the returned "
53                     "pillar value (%s) is of type '%s'. Merge will be "
54                     "skipped.",
55                     default,
56                     ret,
57                     type(ret).__name__,
58                 )
59         elif isinstance(default, list):
60             ret = salt.utils.data.traverse_dict_and_list(
61                 pillar_dict, key, [], delimiter
62             )
63             if isinstance(ret, list):
64                 default = copy.deepcopy(default)
65                 default.extend([x for x in ret if x not in default])
66                 return default
67             else:
68                 log.error(
69                     "pillar.get: Default (%s) is a list, but the returned "
70                     "pillar value (%s) is of type '%s'. Merge will be "
71                     "skipped.",
72                     default,
73                     ret,
74                     type(ret).__name__,
75                 )
76         else:
77             log.error(
78                 "pillar.get: Default (%s) is of type '%s', must be a dict "
79                 "or list to merge. Merge will be skipped.",
80                 default,
81                 type(default).__name__,
82             )
83     ret = salt.utils.data.traverse_dict_and_list(pillar_dict, key, default, delimiter)
84     if ret is KeyError:
85         raise KeyError("Pillar key not found: {}".format(key))
86     return ret
87 def items(*args, **kwargs):
88     if args:
89         return item(*args)
90     pillarenv = kwargs.get("pillarenv")
91     if pillarenv is None:
92         if __opts__.get("pillarenv_from_saltenv", False):
93             pillarenv = kwargs.get("saltenv") or __opts__["saltenv"]
94         else:
95             pillarenv = __opts__["pillarenv"]
96     pillar_override = kwargs.get("pillar")
97     pillar_enc = kwargs.get("pillar_enc")
98     if pillar_override and pillar_enc:
99         try:
100             pillar_override = salt.utils.crypt.decrypt(
101                 pillar_override,
102                 pillar_enc,
103                 translate_newlines=True,
104                 opts=__opts__,
105                 valid_rend=__opts__["decrypt_pillar_renderers"],
106             )
107         except Exception as exc:  # pylint: disable=broad-except
108             raise CommandExecutionError(
109                 "Failed to decrypt pillar override: {}".format(exc)
110             )
111     pillar = salt.pillar.get_pillar(
112         __opts__,
113         dict(__grains__),
114         __opts__["id"],
115         pillar_override=pillar_override,
116         pillarenv=pillarenv,
117     )
118     return pillar.compile_pillar()
119 data = salt.utils.functools.alias_function(items, "data")
120 def _obfuscate_inner(var):
121     if isinstance(var, (dict, salt.utils.odict.OrderedDict)):
122         return var.__class__((key, _obfuscate_inner(val)) for key, val in var.items())
123     elif isinstance(var, (list, set, tuple)):
124         return type(var)(_obfuscate_inner(v) for v in var)
125     else:
126         return "&lt;{}&gt;".format(var.__class__.__name__)
127 def obfuscate(*args):
128     return _obfuscate_inner(items(*args))
129 def ls(*args):
130     return list(items(*args))
131 def item(*args, **kwargs):
132     ret = {}
133     default = kwargs.get("default", "")
134     delimiter = kwargs.get("delimiter", DEFAULT_TARGET_DELIM)
135     pillarenv = kwargs.get("pillarenv", None)
136     saltenv = kwargs.get("saltenv", None)
137     pillar_dict = (
138         __pillar__
139         if all(x is None for x in (saltenv, pillarenv))
140         else items(saltenv=saltenv, pillarenv=pillarenv)
141     )
142     try:
143         for arg in args:
144             ret[arg] = salt.utils.data.traverse_dict_and_list(
145                 pillar_dict, arg, default, delimiter
146             )
147     except KeyError:
148         pass
149     return ret
150 def raw(key=None):
151     if key:
152         ret = __pillar__.get(key, {})
153     else:
154         ret = dict(__pillar__)
155     return ret
156 def ext(external, pillar=None):
157     if isinstance(external, str):
158         external = salt.utils.yaml.safe_load(external)
159     pillar_obj = salt.pillar.get_pillar(
160         __opts__,
161         __grains__.value(),
162         __opts__["id"],
163         __opts__["saltenv"],
164         ext=external,
165         pillar_override=pillar,
166     )
167     ret = pillar_obj.compile_pillar()
168     return ret
169 def keys(key, delimiter=DEFAULT_TARGET_DELIM):
170     ret = salt.utils.data.traverse_dict_and_list(__pillar__, key, KeyError, delimiter)
171     if ret is KeyError:
172         raise KeyError("Pillar key not found: {}".format(key))
173     if not isinstance(ret, dict):
174         raise ValueError("Pillar value in key {} is not a dict".format(key))
175     return list(ret)
176 def file_exists(path, saltenv=None):
177     pillar_roots = __opts__.get("pillar_roots")
178     if not pillar_roots:
179         raise CommandExecutionError(
180             "No pillar_roots found. Are you running this on the master?"
181         )
182     if saltenv:
183         if saltenv in pillar_roots:
184             pillar_roots = {saltenv: pillar_roots[saltenv]}
185         else:
186             return False
187     for env in pillar_roots:
188         for pillar_dir in pillar_roots[env]:
189             full_path = os.path.join(pillar_dir, path)
190             if __salt__["file.file_exists"](full_path):
191                 return True
192     return False
193 fetch = get
194 def filter_by(lookup_dict, pillar, merge=None, default="default", base=None):
195     return salt.utils.data.filter_by(
196         lookup_dict=lookup_dict,
197         lookup=pillar,
198         traverse=__pillar__,
199         merge=merge,
200         default=default,
201         base=base,
202     )
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_file_selinux.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <a name="0"></a><font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import logging
2 import os
3 import shutil
4 import pytest
5 import salt.config
6 import salt.loader
7 import salt.modules.cmdmod as cmdmod
8 import salt.modules.file as filemod
9 import salt.utils.data
10 import salt.utils.files
11 import salt.utils.platform
12 import salt.utils.stringutils
13 from tests.support.mock import MagicMock, patch
14 log =</b></font> logging.getLogger(__name__)
15 pytestmark = pytest.mark.skipif(
16     salt.modules.selinux.getenforce() != "Enforcing",
17     reason="Skip if selinux not enabled",
18 )
19 @pytest.fixture
20 def configure_loader_modules():
21     return {
22         filemod: {
23             "__salt__": {
24                 "cmd.run": cmdmod.run,
25                 "cmd.run_all": cmdmod.run_all,
26                 "cmd.retcode": cmdmod.retcode,
27                 "selinux.fcontext_add_policy": MagicMock(
28                     return_value={"retcode": 0, "stdout": ""}
29                 ),
30             },
31             "__opts__": {"test": False},
32         }
33     }
34 @pytest.fixture
35 def subdir(tmp_path):
36     subdir = tmp_path / "file-selinux-test-dir"
37     subdir.mkdir()
38     yield subdir
39     shutil.rmtree(str(subdir))
40 @pytest.fixture
41 def tfile1(subdir):
42     filename = str(subdir / "tfile1")
43     with salt.utils.files.fopen(filename, "w+"):
44         pass
45     yield filename
46     os.remove(filename)
47 @pytest.fixture
48 def tfile2(subdir):
49     filename = str(subdir / "tfile2")
50     with salt.utils.files.fopen(filename, "w+"):
51         pass
52     yield filename
53     os.remove(filename)
54 @pytest.fixture
55 def tfile3(subdir):
56     filename = str(subdir / "tfile3")
57     with salt.utils.files.fopen(filename, "w+"):
58         pass
59     yield filename
60     os.remove(filename)
61 def test_selinux_getcontext(tfile1):
62     result = filemod.get_selinux_context(tfile1)
63     assert result == "unconfined_u:object_r:user_tmp_t:s0"
64 def test_selinux_setcontext(tfile2):
65     result = filemod.set_selinux_context(tfile2, user="system_u")
66     assert result == "system_u:object_r:user_tmp_t:s0"
67 def test_selinux_setcontext_persist(tfile2):
68     result = filemod.set_selinux_context(tfile2, user="system_u", persist=True)
69     assert result == "system_u:object_r:user_tmp_t:s0"
70 def test_file_check_perms(tfile3):
71     expected_result = (
72         {
73             "comment": "The file {} is set to be changed".format(tfile3),
74             "changes": {
75                 "selinux": {"New": "Type: lost_found_t", "Old": "Type: user_tmp_t"},
76                 "mode": "0664",
77             },
78             "name": tfile3,
79             "result": True,
80         },
81         {"luser": "root", "lmode": "0644", "lgroup": "root"},
82     )
83     with patch("salt.utils.path.which") as m_which:
84         m_which.return_value = None
85         result = filemod.check_perms(
86             tfile3,
87             {},
88             "root",
89             "root",
90             664,
91             seuser=None,
92             serole=None,
93             setype="lost_found_t",
94             serange=None,
95         )
96         assert result == expected_result
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
