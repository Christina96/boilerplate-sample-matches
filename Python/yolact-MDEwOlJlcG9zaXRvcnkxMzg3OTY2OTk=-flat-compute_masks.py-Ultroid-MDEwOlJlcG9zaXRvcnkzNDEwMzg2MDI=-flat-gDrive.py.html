
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 6.0606060606060606%, Tokens: 9</h2>
        <div class="column">
            <h3>yolact-MDEwOlJlcG9zaXRvcnkxMzg3OTY2OTk=-flat-compute_masks.py</h3>
            <pre><code>1  import numpy as np
2  import matplotlib.pyplot as plt
3  import cv2
4  import torch
5  import torch.nn.functional as F
6  COLORS = ((255, 0, 0, 128), (0, 255, 0, 128), (0, 0, 255, 128),
7            (0, 255, 255, 128), (255, 0, 255, 128), (255, 255, 0, 128))
8  def mask_iou(mask1, mask2):
9      intersection = torch.matmul(mask1, mask2.t())
10      area1 = torch.sum(mask1, dim=1).view(1, -1)
11      area2 = torch.sum(mask2, dim=1).view(1, -1)
12      union = (area1.t() + area2) - intersection
13      return intersection / union
14  def paint_mask(img_numpy, mask, color):
15  	h, w, _ = img_numpy.shape
16  	img_numpy = img_numpy.copy()
17  	mask = np.tile(mask.reshape(h, w, 1), (1, 1, 3))
18  	color_np = np.array(color[:3]).reshape(1, 1, 3)
19  	color_np = np.tile(color_np, (h, w, 1))
20  	mask_color = mask * color_np
21  	mask_alpha = 0.3
22  	image_crop = img_numpy * mask
23  	img_numpy *= (1-mask)
24  	img_numpy += image_crop * (1-mask_alpha) + mask_color * mask_alpha
25  	return img_numpy
26  def logit(x):
27  	return np.log(x / (1-x + 0.0001) + 0.0001)
28  def sigmoid(x):
29  	return 1 / (1 + np.exp(-x))
30  img_fmt = '../data/coco/images/%012d.jpg'
31  with open('info.txt', 'r') as f:
32  	img_id = int(f.read())
33  img = plt.imread(img_fmt % img_id).astype(np.float32)
34  h, w, _ = img.shape
35  gt_masks    = np.load('gt.npy').astype(np.float32).transpose(1, 2, 0)
36  proto_masks = np.load('proto.npy').astype(np.float32)
37  proto_masks = torch.Tensor(proto_masks).permute(2, 0, 1).contiguous().unsqueeze(0)
38  proto_masks = F.interpolate(proto_masks, (h, w), mode='bilinear', align_corners=False).squeeze(0)
39  proto_masks = proto_masks.permute(1, 2, 0).numpy()
<span onclick='openModal()' class='match'>40  ls_A = proto_masks.reshape(-1, proto_masks.shape[-1])
41  ls_b = gt_masks.reshape(-1, gt_masks.shape[-1])
</span>42  x = np.linalg.lstsq(ls_A, ls_b, rcond=None)[0]
43  approximated_masks = (np.matmul(proto_masks, x) > 0.5).astype(np.float32)
44  num_gt = approximated_masks.shape[2]
45  ious = mask_iou(torch.Tensor(approximated_masks.reshape(-1, num_gt).T),
46  				torch.Tensor(gt_masks.reshape(-1, num_gt).T))
47  ious = [int(ious[i, i].item() * 100) for i in range(num_gt)]
48  ious.sort(key=lambda x: -x)
49  print(ious)
50  gt_img = img.copy()
51  for i in range(num_gt):
52  	gt_img = paint_mask(gt_img, gt_masks[:, :, i], COLORS[i % len(COLORS)])
53  plt.imshow(gt_img / 255)
54  plt.title('GT')
55  plt.show()
56  for i in range(num_gt):
57  	img = paint_mask(img, approximated_masks[:, :, i], COLORS[i % len(COLORS)])
58  plt.imshow(img / 255)
59  plt.title('Approximated')
60  plt.show()
</code></pre>
        </div>
        <div class="column">
            <h3>Ultroid-MDEwOlJlcG9zaXRvcnkzNDEwMzg2MDI=-flat-gDrive.py</h3>
            <pre><code>1  import time
2  from io import FileIO
3  from logging import WARNING
4  from mimetypes import guess_type
5  from apiclient.http import LOGGER, MediaFileUpload, MediaIoBaseDownload
6  from googleapiclient.discovery import build, logger
7  from httplib2 import Http
8  from oauth2client.client import OOB_CALLBACK_URN, OAuth2WebServerFlow
9  from oauth2client.client import logger as _logger
10  from oauth2client.file import Storage
11  from .. import udB
12  from .helper import humanbytes, time_formatter
13  for log in [LOGGER, logger, _logger]:
14      log.setLevel(WARNING)
15  class GDriveManager:
16      def __init__(self):
17          self._flow = {}
18          self.gdrive_creds = {
19              "oauth_scope": [
20                  "https://www.googleapis.com/auth/drive",
21                  "https://www.googleapis.com/auth/drive.file",
22                  "https://www.googleapis.com/auth/drive.metadata",
23              ],
24              "dir_mimetype": "application/vnd.google-apps.folder",
25              "redirect_uri": OOB_CALLBACK_URN,
26          }
27          self.auth_token = udB.get_key("GDRIVE_AUTH_TOKEN")
28          self.folder_id = udB.get_key("GDRIVE_FOLDER_ID")
29          self.token_file = "resources/auth/gdrive_creds.json"
30      @staticmethod
31      def _create_download_link(fileId: str):
32          return f"https://drive.google.com/uc?id={fileId}&export=download"
33      @staticmethod
34      def _create_folder_link(folderId: str):
35          return f"https://drive.google.com/folderview?id={folderId}"
36      def _create_token_file(self, code: str = None):
37          if code and self._flow:
38              _auth_flow = self._flow["_"]
39              credentials = _auth_flow.step2_exchange(code)
40              Storage(self.token_file).put(credentials)
41              return udB.set_key("GDRIVE_AUTH_TOKEN", str(open(self.token_file).read()))
42          try:
43              _auth_flow = OAuth2WebServerFlow(
44                  udB.get_key("GDRIVE_CLIENT_ID")
45                  or "458306970678-jhfbv6o5sf1ar63o1ohp4c0grblp8qba.apps.googleusercontent.com",
46                  udB.get_key("GDRIVE_CLIENT_SECRET")
47                  or "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",
48                  self.gdrive_creds["oauth_scope"],
49                  redirect_uri=self.gdrive_creds["redirect_uri"],
50              )
51              self._flow["_"] = _auth_flow
52          except KeyError:
53              return "Fill GDRIVE client credentials"
54          return _auth_flow.step1_get_authorize_url()
55      @property
56      def _http(self):
57          storage = Storage(self.token_file)
58          creds = storage.get()
59          http = Http()
60          http.redirect_codes = http.redirect_codes - {308}
61          creds.refresh(http)
62          return creds.authorize(http)
63      @property
64      def _build(self):
65          return build("drive", "v2", http=self._http, cache_discovery=False)
66      def _set_permissions(self, fileId: str):
67          _permissions = {
68              "role": "reader",
69              "type": "anyone",
70              "value": None,
71              "withLink": True,
72          }
73          self._build.permissions().insert(
74              fileId=fileId, body=_permissions, supportsAllDrives=True
75          ).execute(http=self._http)
76      async def _upload_file(
77          self, event, path: str, filename: str = None, folder_id: str = None
78      ):
79          last_txt = ""
80          if not filename:
81              filename = path.split("/")[-1]
82          mime_type = guess_type(path)[0] or "application/octet-stream"
83          media_body = MediaFileUpload(path, mimetype=mime_type, resumable=True)
84          body = {
85              "title": filename,
86              "description": "Uploaded using Ultroid Userbot",
87              "mimeType": mime_type,
88          }
89          if folder_id:
90              body["parents"] = [{"id": folder_id}]
91          elif self.folder_id:
92              body["parents"] = [{"id": self.folder_id}]
93          upload = self._build.files().insert(
94              body=body, media_body=media_body, supportsAllDrives=True
95          )
96          start = time.time()
97          _status = None
98          while not _status:
99              _progress, _status = upload.next_chunk(num_retries=3)
100              if _progress:
101                  diff = time.time() - start
102                  completed = _progress.resumable_progress
103                  total_size = _progress.total_size
104                  percentage = round((completed / total_size) * 100, 2)
105                  speed = round(completed / diff, 2)
106                  eta = round((total_size - completed) / speed, 2) * 1000
107                  crnt_txt = (
108                      f"`Uploading {filename} to GDrive...\n\n"
109                      + f"Status: {humanbytes(completed)}/{humanbytes(total_size)} »» {percentage}%\n"
110                      + f"Speed: {humanbytes(speed)}/s\n"
111                      + f"ETA: {time_formatter(eta)}`"
112                  )
113                  if round((diff % 10.00) == 0) or last_txt != crnt_txt:
114                      await event.edit(crnt_txt)
115                      last_txt = crnt_txt
116          fileId = _status.get("id")
117          try:
118              self._set_permissions(fileId=fileId)
119          except BaseException:
120              pass
121          _url = self._build.files().get(fileId=fileId, supportsAllDrives=True).execute()
122          return _url.get("webContentLink")
123      async def _download_file(self, event, fileId: str, filename: str = None):
124          last_txt = ""
125          if fileId.startswith("http"):
126              if "=download" in fileId:
<span onclick='openModal()' class='match'>127                  fileId = fileId.split("=")[1][:-7]
128              elif "/view" in fileId:
129                  fileId = fileId.split("/")[::-1][1]
</span>130          try:
131              if not filename:
132                  filename = (
133                      self._build.files()
134                      .get(fileId=fileId, supportsAllDrives=True)
135                      .execute()["title"]
136                  )
137              downloader = self._build.files().get_media(
138                  fileId=fileId, supportsAllDrives=True
139              )
140          except Exception as ex:
141              return False, str(ex)
142          with FileIO(filename, "wb") as file:
143              start = time.time()
144              download = MediaIoBaseDownload(file, downloader)
145              _status = None
146              while not _status:
147                  _progress, _status = download.next_chunk(num_retries=3)
148                  if _progress:
149                      diff = time.time() - start
150                      completed = _progress.resumable_progress
151                      total_size = _progress.total_size
152                      percentage = round((completed / total_size) * 100, 2)
153                      speed = round(completed / diff, 2)
154                      eta = round((total_size - completed) / speed, 2) * 1000
155                      crnt_txt = (
156                          f"`Downloading {filename} from GDrive...\n\n"
157                          + f"Status: {humanbytes(completed)}/{humanbytes(total_size)} »» {percentage}%\n"
158                          + f"Speed: {humanbytes(speed)}/s\n"
159                          + f"ETA: {time_formatter(eta)}`"
160                      )
161                      if round((diff % 10.00) == 0) or last_txt != crnt_txt:
162                          await event.edit(crnt_txt)
163                          last_txt = crnt_txt
164          return True, filename
165      @property
166      def _list_files(self):
167          _items = (
168              self._build.files()
169              .list(
170                  supportsTeamDrives=True,
171                  includeTeamDriveItems=True,
172                  spaces="drive",
173                  fields="nextPageToken, items(id, title, mimeType)",
174                  pageToken=None,
175              )
176              .execute()
177          )
178          _files = {}
179          for files in _items["items"]:
180              if files["mimeType"] == self.gdrive_creds["dir_mimetype"]:
181                  _files[self._create_folder_link(files["id"])] = files["title"]
182              else:
183                  _files[self._create_download_link(files["id"])] = files["title"]
184          return _files
185      def create_directory(self, directory):
186          body = {
187              "title": directory,
188              "mimeType": self.gdrive_creds["dir_mimetype"],
189          }
190          if self.folder_id:
191              body["parents"] = [{"id": self.folder_id}]
192          file = self._build.files().insert(body=body, supportsAllDrives=True).execute()
193          fileId = file.get("id")
194          self._set_permissions(fileId=fileId)
195          return fileId
196      def search(self, title):
197          query = f"title contains '{title}'"
198          if self.folder_id:
199              query = f"'{self.folder_id}' in parents and (title contains '{title}')"
200          _items = (
201              self._build.files()
202              .list(
203                  supportsTeamDrives=True,
204                  includeTeamDriveItems=True,
205                  q=query,
206                  spaces="drive",
207                  fields="nextPageToken, items(id, title, mimeType)",
208                  pageToken=None,
209              )
210              .execute()
211          )
212          _files = {}
213          for files in _items["items"]:
214              _files[self._create_download_link(files["id"])] = files["title"]
215          return _files
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from yolact-MDEwOlJlcG9zaXRvcnkxMzg3OTY2OTk=-flat-compute_masks.py</div>
                <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Ultroid-MDEwOlJlcG9zaXRvcnkzNDEwMzg2MDI=-flat-gDrive.py</div>
                <div class="column column_space"><pre><code>40  ls_A = proto_masks.reshape(-1, proto_masks.shape[-1])
41  ls_b = gt_masks.reshape(-1, gt_masks.shape[-1])
</pre></code></div>
                <div class="column column_space"><pre><code>127                  fileId = fileId.split("=")[1][:-7]
128              elif "/view" in fileId:
129                  fileId = fileId.split("/")[::-1][1]
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    