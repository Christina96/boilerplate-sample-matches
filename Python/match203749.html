<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for cpan.py &amp; noxfile.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for cpan.py &amp; noxfile.py
      </h3>
<h1 align="center">
        1.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>cpan.py (4.3613706%)<th>noxfile.py (0.99361247%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(224-226)<td><a href="#" name="0">(47-49)</a><td align="center"><font color="#ff0000">14</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>cpan.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import os
3 import os.path
4 import salt.utils.files
5 import salt.utils.path
6 log = logging.getLogger(__name__)
7 __func_alias__ = {"list_": "list"}
8 def __virtual__():
9     if salt.utils.path.which("cpan"):
10         return True
11     return (False, "Unable to locate cpan. Make sure it is installed and in the PATH.")
12 def install(module):
13     ret = {
14         "old": None,
15         "new": None,
16     }
17     old_info = show(module)
18     cmd = "cpan -i {}".format(module)
19     out = __salt__["cmd.run"](cmd)
20     if "don't know what it is" in out:
21         ret["error"] = "CPAN cannot identify this package"
22         return ret
23     new_info = show(module)
24     ret["old"] = old_info.get("installed version", None)
25     ret["new"] = new_info["installed version"]
26     return ret
27 def remove(module, details=False):
28     ret = {
29         "old": None,
30         "new": None,
31     }
32     info = show(module)
33     if "error" in info:
34         return {"error": info["error"]}
35     version = info.get("installed version", None)
36     if version is None:
37         return ret
38     ret["old"] = version
39     if "cpan build dirs" not in info:
40         return {"error": "No CPAN data available to use for uninstalling"}
41     mod_pathfile = module.replace("::", "/") + ".pm"
42     ins_path = info["installed file"].replace(mod_pathfile, "")
43     files = []
44     for build_dir in info["cpan build dirs"]:
45         contents = os.listdir(build_dir)
46         if "MANIFEST" not in contents:
47             continue
48         mfile = os.path.join(build_dir, "MANIFEST")
49         with salt.utils.files.fopen(mfile, "r") as fh_:
50             for line in fh_.readlines():
51                 line = salt.utils.stringutils.to_unicode(line)
52                 if line.startswith("lib/"):
53                     files.append(line.replace("lib/", ins_path).strip())
54     rm_details = {}
55     for file_ in files:
56         if file_ in rm_details:
57             continue
58         log.trace("Removing %s", file_)
59         if __salt__["file.remove"](file_):
60             rm_details[file_] = "removed"
61         else:
62             rm_details[file_] = "unable to remove"
63     if details:
64         ret["details"] = rm_details
65     return ret
66 def list_():
67     ret = {}
68     cmd = "cpan -l"
69     out = __salt__["cmd.run"](cmd).splitlines()
70     for line in out:
71         comps = line.split()
72         ret[comps[0]] = comps[1]
73     return ret
74 def show(module):
75     ret = {}
76     ret["name"] = module
77     cmd = "cpan -D {}".format(module)
78     out = __salt__["cmd.run"](cmd).splitlines()
79     mode = "skip"
80     info = []
81     for line in out:
82         if line.startswith("-------------"):
83             mode = "parse"
84             continue
85         if mode == "skip":
86             continue
87         info.append(line)
88     if len(info) == 6:
89         info.insert(2, "")
90     if len(info) &lt; 6:
91         ret["error"] = "This package does not seem to exist"
92         return ret
93     ret["description"] = info[0].strip()
94     ret["cpan file"] = info[1].strip()
95     if info[2].strip():
96         ret["installed file"] = info[2].strip()
97     else:
98         ret["installed file"] = None
99     comps = info[3].split(":")
100     if len(comps) &gt; 1:
101         ret["installed version"] = comps[1].strip()
102     if "installed version" not in ret or not ret["installed version"]:
103         ret["installed version"] = None
104     comps = info[4].split(":")
105     comps = comps[1].split()
106     ret["cpan version"] = comps[0].strip()
107     ret["author name"] = info[5].strip()
108     ret["author email"] = info[6].strip()
109     config = show_config()
110     build_dir = config.get("build_dir", None)
111     if build_dir is not None:
112         ret["cpan build dirs"] = []
113         builds = os.listdir(build_dir)
114         pfile = module.replace("::", "-")
115         for file_ in builds:
116             if file_.startswith(pfile):
117                 ret["cpan build dirs"].append(os.path.join(build_dir, file_))
118     return ret
119 def show_config():
120     ret = {}
121     cmd = "cpan -J"
122     out = __salt__["cmd.run"](cmd).splitlines()
123     for line in out:
124 <a name="0"></a>        if "=&gt;" not in line:
125             continue
126         comps = line<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.split("=&gt;")
127         key = comps[0].replace("'", "").strip()
128         val = comps[1].replace("',", "").replace(</b></font>"'", "").strip()
129         ret[key] = val
130     return ret
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>noxfile.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import datetime
2 import glob
3 import os
4 import pathlib
5 import shutil
6 import sys
7 import tempfile
8 if __name__ == "__main__":
9     sys.stderr.write(
10         "Do not execute this file directly. Use nox instead, it will know how to handle this file\n"
11     )
12     sys.stderr.flush()
13     exit(1)
14 import nox  # isort:skip
15 from nox.command import CommandFailed  # isort:skip
16 IS_PY3 = sys.version_info &gt; (2,)
17 CI_RUN = (
18     os.environ.get("JENKINS_URL")
19     or os.environ.get("CI")
20     or os.environ.get("DRONE") is not None
21 )
22 PIP_INSTALL_SILENT = CI_RUN is False
23 SKIP_REQUIREMENTS_INSTALL = "SKIP_REQUIREMENTS_INSTALL" in os.environ
24 EXTRA_REQUIREMENTS_INSTALL = os.environ.get("EXTRA_REQUIREMENTS_INSTALL")
25 REPO_ROOT = pathlib.Path(os.path.dirname(__file__)).resolve()
26 <a name="0"></a>SITECUSTOMIZE_DIR = str(REPO_ROOT / "tests" / "support" / "coverage")
27 ARTIFACTS_DIR = REPO_ROOT / "artifacts"
28 COVERAGE_OUTPUT_DIR = ARTIFACTS_DIR / "coverage"
29 IS_DARWIN = sys.platform.lower()<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.startswith("darwin")
30 IS_WINDOWS = sys.platform.lower().startswith("win")
31 IS_FREEBSD = sys.platform.lower().startswith(</b></font>"freebsd")
32 _PYTHON_VERSIONS = ("3", "3.5", "3.6", "3.7", "3.8", "3.9", "3.10")
33 nox.options.reuse_existing_virtualenvs = True
34 nox.options.error_on_missing_interpreters = False
35 os.chdir(str(REPO_ROOT))
36 RUNTESTS_LOGFILE = ARTIFACTS_DIR.joinpath(
37     "logs",
38     "runtests-{}.log".format(datetime.datetime.now().strftime("%Y%m%d%H%M%S.%f")),
39 )
40 os.environ["PYTHONDONTWRITEBYTECODE"] = "1"
41 def find_session_runner(session, name, **kwargs):
42     for s, _ in session._runner.manifest.list_all_sessions():
43         if name not in s.signatures:
44             continue
45         for signature in s.signatures:
46             for key, value in kwargs.items():
47                 param = "{}={!r}".format(key, value)
48                 if IS_PY3:
49                     param = param.replace("u'", "'")
50                 if param not in signature:
51                     break
52             else:
53                 return s
54             continue
55     session.error(
56         "Could not find a nox session by the name {!r} with the following keyword arguments: {!r}".format(
57             name, kwargs
58         )
59     )
60 def _create_ci_directories():
61     ARTIFACTS_DIR.mkdir(parents=True, exist_ok=True)
62     ARTIFACTS_DIR.chmod(0o777)
63     COVERAGE_OUTPUT_DIR.mkdir(exist_ok=True)
64     COVERAGE_OUTPUT_DIR.chmod(0o777)
65     ARTIFACTS_DIR.joinpath("xml-unittests-output").mkdir(exist_ok=True)
66 def _get_session_python_version_info(session):
67     try:
68         version_info = session._runner._real_python_version_info
69     except AttributeError:
70         old_install_only_value = session._runner.global_config.install_only
71         try:
72             session._runner.global_config.install_only = False
73             session_py_version = session.run(
74                 "python",
75                 "-c",
76                 'import sys; sys.stdout.write("{}.{}.{}".format(*sys.version_info))',
77                 silent=True,
78                 log=False,
79             )
80             version_info = tuple(
81                 int(part) for part in session_py_version.split(".") if part.isdigit()
82             )
83             session._runner._real_python_version_info = version_info
84         finally:
85             session._runner.global_config.install_only = old_install_only_value
86     return version_info
87 def _get_session_python_site_packages_dir(session):
88     try:
89         site_packages_dir = session._runner._site_packages_dir
90     except AttributeError:
91         old_install_only_value = session._runner.global_config.install_only
92         try:
93             session._runner.global_config.install_only = False
94             site_packages_dir = session.run(
95                 "python",
96                 "-c",
97                 "import sys; from distutils.sysconfig import get_python_lib; sys.stdout.write(get_python_lib())",
98                 silent=True,
99                 log=False,
100             )
101             session._runner._site_packages_dir = site_packages_dir
102         finally:
103             session._runner.global_config.install_only = old_install_only_value
104     return site_packages_dir
105 def _get_pydir(session):
106     version_info = _get_session_python_version_info(session)
107     if version_info &lt; (3, 5):
108         session.error("Only Python &gt;= 3.5 is supported")
109     if IS_WINDOWS and version_info &lt; (3, 6):
110         session.error("Only Python &gt;= 3.6 is supported on Windows")
111     return "py{}.{}".format(*version_info)
112 def _install_system_packages(session):
113     version_info = _get_session_python_version_info(session)
114     py_version_keys = ["{}".format(*version_info), "{}.{}".format(*version_info)]
115     session_site_packages_dir = _get_session_python_site_packages_dir(session)
116     session_site_packages_dir = os.path.relpath(
117         session_site_packages_dir, str(REPO_ROOT)
118     )
119     for py_version in py_version_keys:
120         dist_packages_path = "/usr/lib/python{}/dist-packages".format(py_version)
121         if not os.path.isdir(dist_packages_path):
122             continue
123         for aptpkg in glob.glob(os.path.join(dist_packages_path, "*apt*")):
124             src = os.path.realpath(aptpkg)
125             dst = os.path.join(session_site_packages_dir, os.path.basename(src))
126             if os.path.exists(dst):
127                 session.log("Not overwritting already existing %s with %s", dst, src)
128                 continue
129             session.log("Copying %s into %s", src, dst)
130             if os.path.isdir(src):
131                 shutil.copytree(src, dst)
132             else:
133                 shutil.copyfile(src, dst)
134 def _get_pip_requirements_file(session, transport, crypto=None, requirements_type="ci"):
135     assert requirements_type in ("ci", "pkg")
136     pydir = _get_pydir(session)
137     if IS_WINDOWS:
138         if crypto is None:
139             _requirements_file = os.path.join(
140                 "requirements",
141                 "static",
142                 requirements_type,
143                 pydir,
144                 "{}-windows.txt".format(transport),
145             )
146             if os.path.exists(_requirements_file):
147                 return _requirements_file
148             _requirements_file = os.path.join(
149                 "requirements", "static", requirements_type, pydir, "windows.txt"
150             )
151             if os.path.exists(_requirements_file):
152                 return _requirements_file
153         _requirements_file = os.path.join(
154             "requirements", "static", requirements_type, pydir, "windows-crypto.txt"
155         )
156         if os.path.exists(_requirements_file):
157             return _requirements_file
158         session.error("Could not find a windows requirements file for {}".format(pydir))
159     elif IS_DARWIN:
160         if crypto is None:
161             _requirements_file = os.path.join(
162                 "requirements",
163                 "static",
164                 requirements_type,
165                 pydir,
166                 "{}-darwin.txt".format(transport),
167             )
168             if os.path.exists(_requirements_file):
169                 return _requirements_file
170             _requirements_file = os.path.join(
171                 "requirements", "static", requirements_type, pydir, "darwin.txt"
172             )
173             if os.path.exists(_requirements_file):
174                 return _requirements_file
175         _requirements_file = os.path.join(
176             "requirements", "static", requirements_type, pydir, "darwin-crypto.txt"
177         )
178         if os.path.exists(_requirements_file):
179             return _requirements_file
180         session.error("Could not find a darwin requirements file for {}".format(pydir))
181     elif IS_FREEBSD:
182         if crypto is None:
183             _requirements_file = os.path.join(
184                 "requirements",
185                 "static",
186                 requirements_type,
187                 pydir,
188                 "{}-freebsd.txt".format(transport),
189             )
190             if os.path.exists(_requirements_file):
191                 return _requirements_file
192             _requirements_file = os.path.join(
193                 "requirements", "static", requirements_type, pydir, "freebsd.txt"
194             )
195             if os.path.exists(_requirements_file):
196                 return _requirements_file
197         _requirements_file = os.path.join(
198             "requirements", "static", requirements_type, pydir, "freebsd-crypto.txt"
199         )
200         if os.path.exists(_requirements_file):
201             return _requirements_file
202         session.error("Could not find a freebsd requirements file for {}".format(pydir))
203     else:
204         _install_system_packages(session)
205         if crypto is None:
206             _requirements_file = os.path.join(
207                 "requirements",
208                 "static",
209                 requirements_type,
210                 pydir,
211                 "{}-linux.txt".format(transport),
212             )
213             if os.path.exists(_requirements_file):
214                 return _requirements_file
215             _requirements_file = os.path.join(
216                 "requirements", "static", requirements_type, pydir, "linux.txt"
217             )
218             if os.path.exists(_requirements_file):
219                 return _requirements_file
220         _requirements_file = os.path.join(
221             "requirements", "static", requirements_type, pydir, "linux-crypto.txt"
222         )
223         if os.path.exists(_requirements_file):
224             return _requirements_file
225         session.error("Could not find a linux requirements file for {}".format(pydir))
226 def _upgrade_pip_setuptools_and_wheel(session, upgrade=True):
227     if SKIP_REQUIREMENTS_INSTALL:
228         session.log(
229             "Skipping Python Requirements because SKIP_REQUIREMENTS_INSTALL was found in the environ"
230         )
231         return False
232     install_command = [
233         "python",
234         "-m",
235         "pip",
236         "install",
237         "--progress-bar=off",
238     ]
239     if upgrade:
240         install_command.append("-U")
241     install_command.extend(
242         [
243             "pip&gt;=20.2.4,&lt;21.2",
244             "setuptools!=50.*,!=51.*,!=52.*,&lt;59",
245             "wheel",
246         ]
247     )
248     session.run(*install_command, silent=PIP_INSTALL_SILENT)
249     return True
250 def _install_requirements(
251     session, transport, *extra_requirements, requirements_type="ci"
252 ):
253     if not _upgrade_pip_setuptools_and_wheel(session):
254         return
255 def _install_requirements(
256     session, transport, *extra_requirements, requirements_type="ci"
257 ):
258     if not _upgrade_pip_setuptools_and_wheel(session):
259         return False
260     requirements_file = _get_pip_requirements_file(
261         session, transport, requirements_type=requirements_type
262     )
263     install_command = ["--progress-bar=off", "-r", requirements_file]
264     session.install(*install_command, silent=PIP_INSTALL_SILENT)
265     if extra_requirements:
266         install_command = ["--progress-bar=off"]
267         install_command += list(extra_requirements)
268         session.install(*install_command, silent=PIP_INSTALL_SILENT)
269     if EXTRA_REQUIREMENTS_INSTALL:
270         session.log(
271             "Installing the following extra requirements because the"
272             " EXTRA_REQUIREMENTS_INSTALL environment variable was set: %s",
273             EXTRA_REQUIREMENTS_INSTALL,
274         )
275         install_command = ["--progress-bar=off", "--constraint", requirements_file]
276         install_command += EXTRA_REQUIREMENTS_INSTALL.split()
277         session.install(*install_command, silent=PIP_INSTALL_SILENT)
278     return True
279 def _run_with_coverage(session, *test_cmd, env=None):
280     if SKIP_REQUIREMENTS_INSTALL is False:
281         session.install(
282             "--progress-bar=off", "coverage==5.2", silent=PIP_INSTALL_SILENT
283         )
284     session.run("coverage", "erase")
285     python_path_env_var = os.environ.get("PYTHONPATH") or None
286     if python_path_env_var is None:
287         python_path_env_var = SITECUSTOMIZE_DIR
288     else:
289         python_path_entries = python_path_env_var.split(os.pathsep)
290         if SITECUSTOMIZE_DIR in python_path_entries:
291             python_path_entries.remove(SITECUSTOMIZE_DIR)
292         python_path_entries.insert(0, SITECUSTOMIZE_DIR)
293         python_path_env_var = os.pathsep.join(python_path_entries)
294     coverage_base_env = {
295         "COVERAGE_FILE": str(COVERAGE_OUTPUT_DIR / ".coverage")
296     }
297     if env is None:
298         env = {}
299     env.update(
300         {
301             "PYTHONPATH": python_path_env_var,
302             "COVERAGE_PROCESS_START": str(REPO_ROOT / ".coveragerc"),
303         },
304         **coverage_base_env
305     )
306     try:
307         session.run(*test_cmd, env=env)
308     finally:
309         try:
310             session.run("coverage", "combine", env=coverage_base_env)
311         except CommandFailed:
312             pass
313         session.run(
314             "coverage",
315             "xml",
316             "-o",
317             str(COVERAGE_OUTPUT_DIR.joinpath("salt.xml").relative_to(REPO_ROOT)),
318             "--omit=tests/*",
319             "--include=salt/*",
320             env=coverage_base_env,
321         )
322         session.run(
323             "coverage",
324             "xml",
325             "-o",
326             str(COVERAGE_OUTPUT_DIR.joinpath("tests.xml").relative_to(REPO_ROOT)),
327             "--omit=salt/*",
328             "--include=tests/*",
329             env=coverage_base_env,
330         )
331 def _runtests(session):
332     session.error(
333         "For more information, please check "
334         "https://docs.saltproject.io/en/latest/topics/development/tests/index.html#running-the-tests\n..".format(
335             session._runner.global_config.sessions[0].replace("runtests", "pytest")
336         )
337     )
338 @nox.session(python=_PYTHON_VERSIONS, name="runtests-parametrized")
339 @nox.parametrize("coverage", [False, True])
340 @nox.parametrize("transport", ["zeromq", "tcp"])
341 @nox.parametrize("crypto", [None, "m2crypto", "pycryptodome"])
342 def runtests_parametrized(session, coverage, transport, crypto):
343     _runtests(session)
344 @nox.session(python=_PYTHON_VERSIONS)
345 @nox.parametrize("coverage", [False, True])
346 def runtests(session, coverage):
347     _runtests(session)
348 @nox.session(python=_PYTHON_VERSIONS, name="runtests-tcp")
349 @nox.parametrize("coverage", [False, True])
350 def runtests_tcp(session, coverage):
351     _runtests(session)
352 @nox.session(python=_PYTHON_VERSIONS, name="runtests-zeromq")
353 @nox.parametrize("coverage", [False, True])
354 def runtests_zeromq(session, coverage):
355     _runtests(session)
356 @nox.session(python=_PYTHON_VERSIONS, name="runtests-m2crypto")
357 @nox.parametrize("coverage", [False, True])
358 def runtests_m2crypto(session, coverage):
359     _runtests(session)
360 @nox.session(python=_PYTHON_VERSIONS, name="runtests-tcp-m2crypto")
361 @nox.parametrize("coverage", [False, True])
362 def runtests_tcp_m2crypto(session, coverage):
363     _runtests(session)
364 @nox.session(python=_PYTHON_VERSIONS, name="runtests-zeromq-m2crypto")
365 @nox.parametrize("coverage", [False, True])
366 def runtests_zeromq_m2crypto(session, coverage):
367     _runtests(session)
368 @nox.session(python=_PYTHON_VERSIONS, name="runtests-pycryptodome")
369 @nox.parametrize("coverage", [False, True])
370 def runtests_pycryptodome(session, coverage):
371     _runtests(session)
372 @nox.session(python=_PYTHON_VERSIONS, name="runtests-tcp-pycryptodome")
373 @nox.parametrize("coverage", [False, True])
374 def runtests_tcp_pycryptodome(session, coverage):
375     _runtests(session)
376 @nox.session(python=_PYTHON_VERSIONS, name="runtests-zeromq-pycryptodome")
377 @nox.parametrize("coverage", [False, True])
378 def runtests_zeromq_pycryptodome(session, coverage):
379     _runtests(session)
380 @nox.session(python=_PYTHON_VERSIONS, name="runtests-cloud")
381 @nox.parametrize("coverage", [False, True])
382 def runtests_cloud(session, coverage):
383     _runtests(session)
384 @nox.session(python=_PYTHON_VERSIONS, name="runtests-tornado")
385 @nox.parametrize("coverage", [False, True])
386 def runtests_tornado(session, coverage):
387     _runtests(session)
388 @nox.session(python=_PYTHON_VERSIONS, name="pytest-parametrized")
389 @nox.parametrize("coverage", [False, True])
390 @nox.parametrize("transport", ["zeromq", "tcp"])
391 @nox.parametrize("crypto", [None, "m2crypto", "pycryptodome"])
392 def pytest_parametrized(session, coverage, transport, crypto):
393     if _install_requirements(session, transport):
394         if crypto:
395             session.run(
396                 "pip",
397                 "uninstall",
398                 "-y",
399                 "m2crypto",
400                 "pycrypto",
401                 "pycryptodome",
402                 "pycryptodomex",
403                 silent=True,
404             )
405             install_command = [
406                 "--progress-bar=off",
407                 "--constraint",
408                 _get_pip_requirements_file(session, transport, crypto=True),
409             ]
410             install_command.append(crypto)
411             session.install(*install_command, silent=PIP_INSTALL_SILENT)
412     cmd_args = [
413         "--rootdir",
414         str(REPO_ROOT),
415         "--log-file={}".format(RUNTESTS_LOGFILE),
416         "--log-file-level=debug",
417         "--show-capture=no",
418         "-ra",
419         "-s",
420         "--transport={}".format(transport),
421     ] + session.posargs
422     _pytest(session, coverage, cmd_args)
423 @nox.session(python=_PYTHON_VERSIONS)
424 @nox.parametrize("coverage", [False, True])
425 def pytest(session, coverage):
426     session.notify(
427         find_session_runner(
428             session,
429             "pytest-parametrized-{}".format(session.python),
430             coverage=coverage,
431             crypto=None,
432             transport="zeromq",
433         )
434     )
435 @nox.session(python=_PYTHON_VERSIONS, name="pytest-tcp")
436 @nox.parametrize("coverage", [False, True])
437 def pytest_tcp(session, coverage):
438     session.notify(
439         find_session_runner(
440             session,
441             "pytest-parametrized-{}".format(session.python),
442             coverage=coverage,
443             crypto=None,
444             transport="tcp",
445         )
446     )
447 @nox.session(python=_PYTHON_VERSIONS, name="pytest-zeromq")
448 @nox.parametrize("coverage", [False, True])
449 def pytest_zeromq(session, coverage):
450     session.notify(
451         find_session_runner(
452             session,
453             "pytest-parametrized-{}".format(session.python),
454             coverage=coverage,
455             crypto=None,
456             transport="zeromq",
457         )
458     )
459 @nox.session(python=_PYTHON_VERSIONS, name="pytest-m2crypto")
460 @nox.parametrize("coverage", [False, True])
461 def pytest_m2crypto(session, coverage):
462     session.notify(
463         find_session_runner(
464             session,
465             "pytest-parametrized-{}".format(session.python),
466             coverage=coverage,
467             crypto="m2crypto",
468             transport="zeromq",
469         )
470     )
471 @nox.session(python=_PYTHON_VERSIONS, name="pytest-tcp-m2crypto")
472 @nox.parametrize("coverage", [False, True])
473 def pytest_tcp_m2crypto(session, coverage):
474     session.notify(
475         find_session_runner(
476             session,
477             "pytest-parametrized-{}".format(session.python),
478             coverage=coverage,
479             crypto="m2crypto",
480             transport="tcp",
481         )
482     )
483 @nox.session(python=_PYTHON_VERSIONS, name="pytest-zeromq-m2crypto")
484 @nox.parametrize("coverage", [False, True])
485 def pytest_zeromq_m2crypto(session, coverage):
486     session.notify(
487         find_session_runner(
488             session,
489             "pytest-parametrized-{}".format(session.python),
490             coverage=coverage,
491             crypto="m2crypto",
492             transport="zeromq",
493         )
494     )
495 @nox.session(python=_PYTHON_VERSIONS, name="pytest-pycryptodome")
496 @nox.parametrize("coverage", [False, True])
497 def pytest_pycryptodome(session, coverage):
498     session.notify(
499         find_session_runner(
500             session,
501             "pytest-parametrized-{}".format(session.python),
502             coverage=coverage,
503             crypto="pycryptodome",
504             transport="zeromq",
505         )
506     )
507 @nox.session(python=_PYTHON_VERSIONS, name="pytest-tcp-pycryptodome")
508 @nox.parametrize("coverage", [False, True])
509 def pytest_tcp_pycryptodome(session, coverage):
510     session.notify(
511         find_session_runner(
512             session,
513             "pytest-parametrized-{}".format(session.python),
514             coverage=coverage,
515             crypto="pycryptodome",
516             transport="tcp",
517         )
518     )
519 @nox.session(python=_PYTHON_VERSIONS, name="pytest-zeromq-pycryptodome")
520 @nox.parametrize("coverage", [False, True])
521 def pytest_zeromq_pycryptodome(session, coverage):
522     session.notify(
523         find_session_runner(
524             session,
525             "pytest-parametrized-{}".format(session.python),
526             coverage=coverage,
527             crypto="pycryptodome",
528             transport="zeromq",
529         )
530     )
531 @nox.session(python=_PYTHON_VERSIONS, name="pytest-cloud")
532 @nox.parametrize("coverage", [False, True])
533 def pytest_cloud(session, coverage):
534     pydir = _get_pydir(session)
535     if pydir == "py3.5":
536         session.error(
537             "Due to conflicting and unsupported requirements the cloud tests only run on Py3.6+"
538         )
539     if _upgrade_pip_setuptools_and_wheel(session):
540         requirements_file = os.path.join(
541             "requirements", "static", "ci", pydir, "cloud.txt"
542         )
543         install_command = ["--progress-bar=off", "-r", requirements_file]
544         session.install(*install_command, silent=PIP_INSTALL_SILENT)
545     cmd_args = [
546         "--rootdir",
547         str(REPO_ROOT),
548         "--log-file={}".format(RUNTESTS_LOGFILE),
549         "--log-file-level=debug",
550         "--show-capture=no",
551         "-ra",
552         "-s",
553         "--run-expensive",
554         "-k",
555         "cloud",
556     ] + session.posargs
557     _pytest(session, coverage, cmd_args)
558 @nox.session(python=_PYTHON_VERSIONS, name="pytest-tornado")
559 @nox.parametrize("coverage", [False, True])
560 def pytest_tornado(session, coverage):
561     if _upgrade_pip_setuptools_and_wheel(session):
562         _install_requirements(session, "zeromq")
563         session.install(
564             "--progress-bar=off", "tornado==5.0.2", silent=PIP_INSTALL_SILENT
565         )
566         session.install(
567             "--progress-bar=off", "pyzmq==17.0.0", silent=PIP_INSTALL_SILENT
568         )
569     cmd_args = [
570         "--rootdir",
571         str(REPO_ROOT),
572         "--log-file={}".format(RUNTESTS_LOGFILE),
573         "--log-file-level=debug",
574         "--show-capture=no",
575         "-ra",
576         "-s",
577     ] + session.posargs
578     _pytest(session, coverage, cmd_args)
579 def _pytest(session, coverage, cmd_args):
580     _create_ci_directories()
581     env = {"CI_RUN": "1" if CI_RUN else "0"}
582     if IS_DARWIN:
583         env["OBJC_DISABLE_INITIALIZE_FORK_SAFETY"] = "YES"
584     if CI_RUN:
585         session.run(
586             "python", "-m", "pytest", *(cmd_args + ["--collect-only", "-qqq"]), env=env
587         )
588     try:
589         if coverage is True:
590             _run_with_coverage(
591                 session,
592                 "python",
593                 "-m",
594                 "coverage",
595                 "run",
596                 "-m",
597                 "pytest",
598                 "--showlocals",
599                 *cmd_args,
600                 env=env
601             )
602         else:
603             session.run("python", "-m", "pytest", *cmd_args, env=env)
604     except CommandFailed:  # pylint: disable=try-except-raise
605         raise
606         session.log("Re-running failed tests")
607         for idx, parg in enumerate(cmd_args):
608             if parg.startswith("--junitxml="):
609                 cmd_args[idx] = parg.replace(".xml", "-rerun-failed.xml")
610         cmd_args.append("--lf")
611         if coverage is True:
612             _run_with_coverage(
613                 session,
614                 "python",
615                 "-m",
616                 "coverage",
617                 "run",
618                 "-m",
619                 "pytest",
620                 "--showlocals",
621                 *cmd_args
622             )
623         else:
624             session.run("python", "-m", "pytest", *cmd_args, env=env)
625 class Tee:
626     def __init__(self, first, second):
627         self._first = first
628         self._second = second
629     def write(self, b):
630         wrote = self._first.write(b)
631         self._first.flush()
632         self._second.write(b)
633         self._second.flush()
634     def fileno(self):
635         return self._first.fileno()
636 def _lint(
637     session, rcfile, flags, paths, tee_output=True, upgrade_setuptools_and_pip=True
638 ):
639     if _upgrade_pip_setuptools_and_wheel(session, upgrade=upgrade_setuptools_and_pip):
640         requirements_file = os.path.join(
641             "requirements", "static", "ci", _get_pydir(session), "lint.txt"
642         )
643         install_command = ["--progress-bar=off", "-r", requirements_file]
644         session.install(*install_command, silent=PIP_INSTALL_SILENT)
645     if tee_output:
646         session.run("pylint", "--version")
647         pylint_report_path = os.environ.get("PYLINT_REPORT")
648     cmd_args = ["pylint", "--rcfile={}".format(rcfile)] + list(flags) + list(paths)
649     cmd_kwargs = {"env": {"PYTHONUNBUFFERED": "1"}}
650     if tee_output:
651         stdout = tempfile.TemporaryFile(mode="w+b")
652         cmd_kwargs["stdout"] = Tee(stdout, sys.__stdout__)
653     lint_failed = False
654     try:
655         session.run(*cmd_args, **cmd_kwargs)
656     except CommandFailed:
657         lint_failed = True
658         raise
659     finally:
660         if tee_output:
661             stdout.seek(0)
662             contents = stdout.read()
663             if contents:
664                 if IS_PY3:
665                     contents = contents.decode("utf-8")
666                 else:
667                     contents = contents.encode("utf-8")
668                 sys.stdout.write(contents)
669                 sys.stdout.flush()
670                 if pylint_report_path:
671                     with open(pylint_report_path, "w") as wfh:
672                         wfh.write(contents)
673                     session.log("Report file written to %r", pylint_report_path)
674             stdout.close()
675 def _lint_pre_commit(session, rcfile, flags, paths):
676     if "VIRTUAL_ENV" not in os.environ:
677         session.error(
678             "This should be running from within a virtualenv and "
679             "'VIRTUAL_ENV' was not found as an environment variable."
680         )
681     if "pre-commit" not in os.environ["VIRTUAL_ENV"]:
682         session.error(
683             "This should be running from within a pre-commit virtualenv and "
684             "'VIRTUAL_ENV'({}) does not appear to be a pre-commit virtualenv.".format(
685                 os.environ["VIRTUAL_ENV"]
686             )
687         )
688     from nox.virtualenv import VirtualEnv
689     try:
690         session._runner.venv = VirtualEnv(  # pylint: disable=unexpected-keyword-arg
691             os.environ["VIRTUAL_ENV"],
692             interpreter=session._runner.func.python,
693             reuse_existing=True,
694             venv=True,
695         )
696     except TypeError:
697         session._runner.venv = VirtualEnv(
698             os.environ["VIRTUAL_ENV"],
699             interpreter=session._runner.func.python,
700             reuse_existing=True,
701         )
702     _lint(
703         session,
704         rcfile,
705         flags,
706         paths,
707         tee_output=False,
708         upgrade_setuptools_and_pip=False,
709     )
710 @nox.session(python="3")
711 def lint(session):
712     session.notify("lint-salt-{}".format(session.python))
713     session.notify("lint-tests-{}".format(session.python))
714 @nox.session(python="3", name="lint-salt")
715 def lint_salt(session):
716     flags = ["--disable=I"]
717     if session.posargs:
718         paths = session.posargs
719     else:
720         paths = ["setup.py", "noxfile.py", "salt/", "tasks/"]
721     _lint(session, ".pylintrc", flags, paths)
722 @nox.session(python="3", name="lint-tests")
723 def lint_tests(session):
724     flags = ["--disable=I"]
725     if session.posargs:
726         paths = session.posargs
727     else:
728         paths = ["tests/"]
729     _lint(session, ".pylintrc", flags, paths)
730 @nox.session(python=False, name="lint-salt-pre-commit")
731 def lint_salt_pre_commit(session):
732     flags = ["--disable=I"]
733     if session.posargs:
734         paths = session.posargs
735     else:
736         paths = ["setup.py", "noxfile.py", "salt/"]
737     _lint_pre_commit(session, ".pylintrc", flags, paths)
738 @nox.session(python=False, name="lint-tests-pre-commit")
739 def lint_tests_pre_commit(session):
740     flags = ["--disable=I"]
741     if session.posargs:
742         paths = session.posargs
743     else:
744         paths = ["tests/"]
745     _lint_pre_commit(session, ".pylintrc", flags, paths)
746 @nox.session(python="3")
747 @nox.parametrize("clean", [False, True])
748 @nox.parametrize("update", [False, True])
749 @nox.parametrize("compress", [False, True])
750 def docs(session, compress, update, clean):
751     session.notify("docs-html-{}(compress={})".format(session.python, compress))
752     session.notify(
753         find_session_runner(
754             session,
755             "docs-man-{}".format(session.python),
756             compress=compress,
757             update=update,
758             clean=clean,
759         )
760     )
761 @nox.session(name="docs-html", python="3")
762 @nox.parametrize("clean", [False, True])
763 @nox.parametrize("compress", [False, True])
764 def docs_html(session, compress, clean):
765     if _upgrade_pip_setuptools_and_wheel(session):
766         requirements_file = os.path.join(
767             "requirements", "static", "ci", _get_pydir(session), "docs.txt"
768         )
769         install_command = ["--progress-bar=off", "-r", requirements_file]
770         session.install(*install_command, silent=PIP_INSTALL_SILENT)
771     os.chdir("doc/")
772     if clean:
773         session.run("make", "clean", external=True)
774     session.run("make", "html", "SPHINXOPTS=-W", external=True)
775     if compress:
776         session.run("tar", "-cJvf", "html-archive.tar.xz", "_build/html", external=True)
777     os.chdir("..")
778 @nox.session(name="docs-man", python="3")
779 @nox.parametrize("clean", [False, True])
780 @nox.parametrize("update", [False, True])
781 @nox.parametrize("compress", [False, True])
782 def docs_man(session, compress, update, clean):
783     if _upgrade_pip_setuptools_and_wheel(session):
784         requirements_file = os.path.join(
785             "requirements", "static", "ci", _get_pydir(session), "docs.txt"
786         )
787         install_command = ["--progress-bar=off", "-r", requirements_file]
788         session.install(*install_command, silent=PIP_INSTALL_SILENT)
789     os.chdir("doc/")
790     if clean:
791         session.run("make", "clean", external=True)
792     session.run("make", "man", "SPHINXOPTS=-W", external=True)
793     if update:
794         session.run("rm", "-rf", "man/", external=True)
795         session.run("cp", "-Rp", "_build/man", "man/", external=True)
796     if compress:
797         session.run("tar", "-cJvf", "man-archive.tar.xz", "_build/man", external=True)
798     os.chdir("..")
799 @nox.session(name="invoke", python="3")
800 def invoke(session):
801     if _upgrade_pip_setuptools_and_wheel(session):
802         _install_requirements(session, "zeromq")
803         requirements_file = os.path.join(
804             "requirements", "static", "ci", _get_pydir(session), "invoke.txt"
805         )
806         install_command = ["--progress-bar=off", "-r", requirements_file]
807         session.install(*install_command, silent=PIP_INSTALL_SILENT)
808     cmd = ["inv"]
809     files = []
810     for idx, posarg in enumerate(session.posargs):
811         if idx == 0:
812             cmd.append(posarg)
813             continue
814         if posarg.startswith("--"):
815             cmd.append(posarg)
816             continue
817         files.append(posarg)
818     if files:
819         cmd.append("--files={}".format(" ".join(files)))
820     session.run(*cmd)
821 @nox.session(name="changelog", python="3")
822 @nox.parametrize("draft", [False, True])
823 def changelog(session, draft):
824     if _upgrade_pip_setuptools_and_wheel(session):
825         requirements_file = os.path.join(
826             "requirements", "static", "ci", _get_pydir(session), "changelog.txt"
827         )
828         install_command = ["--progress-bar=off", "-r", requirements_file]
829         session.install(*install_command, silent=PIP_INSTALL_SILENT)
830     town_cmd = ["towncrier", "--version={}".format(session.posargs[0])]
831     if draft:
832         town_cmd.append("--draft")
833     session.run(*town_cmd)
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
