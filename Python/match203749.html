<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for cpan.py &amp; noxfile.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for cpan.py &amp; noxfile.py
      </h3>
<h1 align="center">
        1.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>cpan.py (4.3613706%)<th>noxfile.py (0.99361247%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(224-226)<td><a href="#" name="0">(47-49)</a><td align="center"><font color="#ff0000">14</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>cpan.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import os
3 import os.path
4 import salt.utils.files
5 import salt.utils.path
6 log = logging.getLogger(__name__)
7 __func_alias__ = {"list_": "list"}
8 def __virtual__():
9     if salt.utils.path.which("cpan"):
10         return True
11     return (False, "Unable to locate cpan. Make sure it is installed and in the PATH.")
12 def install(module):
13     ret = {
14         "old": None,
15         "new": None,
16     }
17     old_info = show(module)
18     cmd = "cpan -i {}".format(module)
19     out = __salt__["cmd.run"](cmd)
20     if "don't know what it is" in out:
21         ret["error"] = "CPAN cannot identify this package"
22         return ret
23     new_info = show(module)
24     ret["old"] = old_info.get("installed version", None)
25     ret["new"] = new_info["installed version"]
26     return ret
27 def remove(module, details=False):
28     ret = {
29         "old": None,
30         "new": None,
31     }
32     info = show(module)
33     if "error" in info:
34         return {"error": info["error"]}
35     version = info.get("installed version", None)
36     if version is None:
37         return ret
38     ret["old"] = version
39     if "cpan build dirs" not in info:
40         return {"error": "No CPAN data available to use for uninstalling"}
41     mod_pathfile = module.replace("::", "/") + ".pm"
42     ins_path = info["installed file"].replace(mod_pathfile, "")
43     files = []
44     for build_dir in info["cpan build dirs"]:
45         contents = os.listdir(build_dir)
46         if "MANIFEST" not in contents:
47             continue
48         mfile = os.path.join(build_dir, "MANIFEST")
49         with salt.utils.files.fopen(mfile, "r") as fh_:
50             for line in fh_.readlines():
51                 line = salt.utils.stringutils.to_unicode(line)
52                 if line.startswith("lib/"):
53                     files.append(line.replace("lib/", ins_path).strip())
54     rm_details = {}
55     for file_ in files:
56         if file_ in rm_details:
57             continue
58         log.trace("Removing %s", file_)
59         if __salt__["file.remove"](file_):
60             rm_details[file_] = "removed"
61         else:
62             rm_details[file_] = "unable to remove"
63     if details:
64         ret["details"] = rm_details
65     return ret
66 def list_():
67     ret = {}
68     cmd = "cpan -l"
69     out = __salt__["cmd.run"](cmd).splitlines()
70     for line in out:
71         comps = line.split()
72         ret[comps[0]] = comps[1]
73     return ret
74 def show(module):
75     ret = {}
76     ret["name"] = module
77     cmd = "cpan -D {}".format(module)
78     out = __salt__["cmd.run"](cmd).splitlines()
79     mode = "skip"
80     info = []
81     for line in out:
82         if line.startswith("-------------"):
83             mode = "parse"
84             continue
85         if mode == "skip":
86             continue
87         info.append(line)
88     if len(info) == 6:
89         info.insert(2, "")
90     if len(info) &lt; 6:
91         ret["error"] = "This package does not seem to exist"
92         return ret
93     ret["description"] = info[0].strip()
94     ret["cpan file"] = info[1].strip()
95     if info[2].strip():
96         ret["installed file"] = info[2].strip()
97     else:
98         ret["installed file"] = None
99     comps = info[3].split(":")
100     if len(comps) &gt; 1:
101         ret["installed version"] = comps[1].strip()
102     if "installed version" not in ret or not ret["installed version"]:
103         ret["installed version"] = None
104     comps = info[4].split(":")
105     comps = comps[1].split()
106     ret["cpan version"] = comps[0].strip()
107     ret["author name"] = info[5].strip()
108     ret["author email"] = info[6].strip()
109     config = show_config()
110     build_dir = config.get("build_dir", None)
111     if build_dir is not None:
112         ret["cpan build dirs"] = []
113         builds = os.listdir(build_dir)
114         pfile = module.replace("::", "-")
115         for file_ in builds:
116             if file_.startswith(pfile):
117                 ret["cpan build dirs"].append(os.path.join(build_dir, file_))
118     return ret
119 def show_config():
120     ret = {}
121     cmd = "cpan -J"
122     out = __salt__["cmd.run"](cmd).splitlines()
123     for line in out:
124             continue
125         comps = line<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.split("=&gt;")
126         key = comps[0].replace("'", "").strip()
127         val = comps[1].replace("',", "").replace(</b></font>"'", "").strip()
128         ret[key] = val
129     return ret
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>noxfile.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import datetime
2 import glob
3 import os
4 import pathlib
5 import shutil
6 import sys
7 import tempfile
8 if __name__ == "__main__":
9     sys.stderr.write(
10         "Do not execute this file directly. Use nox instead, it will know how to handle this file\n"
11     )
12     sys.stderr.flush()
13     exit(1)
14 import nox  # isort:skip
15 from nox.command import CommandFailed  # isort:skip
16 IS_PY3 = sys.version_info &gt; (2,)
17 CI_RUN = (
18     os.environ.get("JENKINS_URL")
19     or os.environ.get("CI")
20     or os.environ.get("DRONE") is not None
21 )
22 PIP_INSTALL_SILENT = CI_RUN is False
23 SKIP_REQUIREMENTS_INSTALL = "SKIP_REQUIREMENTS_INSTALL" in os.environ
24 EXTRA_REQUIREMENTS_INSTALL = os.environ.get("EXTRA_REQUIREMENTS_INSTALL")
25 REPO_ROOT = pathlib.Path(os.path.dirname(__file__)).resolve()
26 ARTIFACTS_DIR = REPO_ROOT / "artifacts"
27 COVERAGE_OUTPUT_DIR = ARTIFACTS_DIR / "coverage"
28 IS_DARWIN = sys.platform.lower()<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.startswith("darwin")
29 IS_WINDOWS = sys.platform.lower().startswith("win")
30 IS_FREEBSD = sys.platform.lower().startswith(</b></font>"freebsd")
31 _PYTHON_VERSIONS = ("3", "3.5", "3.6", "3.7", "3.8", "3.9", "3.10")
32 nox.options.reuse_existing_virtualenvs = True
33 nox.options.error_on_missing_interpreters = False
34 os.chdir(str(REPO_ROOT))
35 RUNTESTS_LOGFILE = ARTIFACTS_DIR.joinpath(
36     "logs",
37     "runtests-{}.log".format(datetime.datetime.now().strftime("%Y%m%d%H%M%S.%f")),
38 )
39 os.environ["PYTHONDONTWRITEBYTECODE"] = "1"
40 def find_session_runner(session, name, **kwargs):
41     for s, _ in session._runner.manifest.list_all_sessions():
42         if name not in s.signatures:
43             continue
44         for signature in s.signatures:
45             for key, value in kwargs.items():
46                 param = "{}={!r}".format(key, value)
47                 if IS_PY3:
48                     param = param.replace("u'", "'")
49                 if param not in signature:
50                     break
51             else:
52                 return s
53             continue
54     session.error(
55         "Could not find a nox session by the name {!r} with the following keyword arguments: {!r}".format(
56             name, kwargs
57         )
58     )
59 def _create_ci_directories():
60     ARTIFACTS_DIR.mkdir(parents=True, exist_ok=True)
61     ARTIFACTS_DIR.chmod(0o777)
62     COVERAGE_OUTPUT_DIR.mkdir(exist_ok=True)
63     COVERAGE_OUTPUT_DIR.chmod(0o777)
64     ARTIFACTS_DIR.joinpath("xml-unittests-output").mkdir(exist_ok=True)
65 def _get_session_python_version_info(session):
66     try:
67         version_info = session._runner._real_python_version_info
68     except AttributeError:
69         old_install_only_value = session._runner.global_config.install_only
70         try:
71             session._runner.global_config.install_only = False
72             session_py_version = session.run(
73                 "python",
74                 "-c",
75                 'import sys; sys.stdout.write("{}.{}.{}".format(*sys.version_info))',
76                 silent=True,
77                 log=False,
78             )
79             version_info = tuple(
80                 int(part) for part in session_py_version.split(".") if part.isdigit()
81             )
82             session._runner._real_python_version_info = version_info
83         finally:
84             session._runner.global_config.install_only = old_install_only_value
85     return version_info
86 def _get_session_python_site_packages_dir(session):
87     try:
88         site_packages_dir = session._runner._site_packages_dir
89     except AttributeError:
90         old_install_only_value = session._runner.global_config.install_only
91         try:
92             session._runner.global_config.install_only = False
93             site_packages_dir = session.run(
94                 "python",
95                 "-c",
96                 "import sys; from distutils.sysconfig import get_python_lib; sys.stdout.write(get_python_lib())",
97                 silent=True,
98                 log=False,
99             )
100             session._runner._site_packages_dir = site_packages_dir
101         finally:
102             session._runner.global_config.install_only = old_install_only_value
103     return site_packages_dir
104 def _get_pydir(session):
105     version_info = _get_session_python_version_info(session)
106     if version_info &lt; (3, 5):
107         session.error("Only Python &gt;= 3.5 is supported")
108     if IS_WINDOWS and version_info &lt; (3, 6):
109         session.error("Only Python &gt;= 3.6 is supported on Windows")
110     return "py{}.{}".format(*version_info)
111 def _install_system_packages(session):
112     version_info = _get_session_python_version_info(session)
113     py_version_keys = ["{}".format(*version_info), "{}.{}".format(*version_info)]
114     session_site_packages_dir = _get_session_python_site_packages_dir(session)
115     session_site_packages_dir = os.path.relpath(
116         session_site_packages_dir, str(REPO_ROOT)
117     )
118     for py_version in py_version_keys:
119         dist_packages_path = "/usr/lib/python{}/dist-packages".format(py_version)
120         if not os.path.isdir(dist_packages_path):
121             continue
122         for aptpkg in glob.glob(os.path.join(dist_packages_path, "*apt*")):
123             src = os.path.realpath(aptpkg)
124             dst = os.path.join(session_site_packages_dir, os.path.basename(src))
125             if os.path.exists(dst):
126                 session.log("Not overwritting already existing %s with %s", dst, src)
127                 continue
128             session.log("Copying %s into %s", src, dst)
129             if os.path.isdir(src):
130                 shutil.copytree(src, dst)
131             else:
132                 shutil.copyfile(src, dst)
133 def _get_pip_requirements_file(session, transport, crypto=None, requirements_type="ci"):
134     assert requirements_type in ("ci", "pkg")
135     pydir = _get_pydir(session)
136     if IS_WINDOWS:
137         if crypto is None:
138             _requirements_file = os.path.join(
139                 "requirements",
140                 "static",
141                 requirements_type,
142                 pydir,
143                 "{}-windows.txt".format(transport),
144             )
145             if os.path.exists(_requirements_file):
146                 return _requirements_file
147             _requirements_file = os.path.join(
148                 "requirements", "static", requirements_type, pydir, "windows.txt"
149             )
150             if os.path.exists(_requirements_file):
151                 return _requirements_file
152         _requirements_file = os.path.join(
153             "requirements", "static", requirements_type, pydir, "windows-crypto.txt"
154         )
155         if os.path.exists(_requirements_file):
156             return _requirements_file
157         session.error("Could not find a windows requirements file for {}".format(pydir))
158     elif IS_DARWIN:
159         if crypto is None:
160             _requirements_file = os.path.join(
161                 "requirements",
162                 "static",
163                 requirements_type,
164                 pydir,
165                 "{}-darwin.txt".format(transport),
166             )
167             if os.path.exists(_requirements_file):
168                 return _requirements_file
169             _requirements_file = os.path.join(
170                 "requirements", "static", requirements_type, pydir, "darwin.txt"
171             )
172             if os.path.exists(_requirements_file):
173                 return _requirements_file
174         _requirements_file = os.path.join(
175             "requirements", "static", requirements_type, pydir, "darwin-crypto.txt"
176         )
177         if os.path.exists(_requirements_file):
178             return _requirements_file
179         session.error("Could not find a darwin requirements file for {}".format(pydir))
180     elif IS_FREEBSD:
181         if crypto is None:
182             _requirements_file = os.path.join(
183                 "requirements",
184                 "static",
185                 requirements_type,
186                 pydir,
187                 "{}-freebsd.txt".format(transport),
188             )
189             if os.path.exists(_requirements_file):
190                 return _requirements_file
191             _requirements_file = os.path.join(
192                 "requirements", "static", requirements_type, pydir, "freebsd.txt"
193             )
194             if os.path.exists(_requirements_file):
195                 return _requirements_file
196         _requirements_file = os.path.join(
197             "requirements", "static", requirements_type, pydir, "freebsd-crypto.txt"
198         )
199         if os.path.exists(_requirements_file):
200             return _requirements_file
201         session.error("Could not find a freebsd requirements file for {}".format(pydir))
202     else:
203         _install_system_packages(session)
204         if crypto is None:
205             _requirements_file = os.path.join(
206                 "requirements",
207                 "static",
208                 requirements_type,
209                 pydir,
210                 "{}-linux.txt".format(transport),
211             )
212             if os.path.exists(_requirements_file):
213                 return _requirements_file
214             _requirements_file = os.path.join(
215                 "requirements", "static", requirements_type, pydir, "linux.txt"
216             )
217             if os.path.exists(_requirements_file):
218                 return _requirements_file
219         _requirements_file = os.path.join(
220             "requirements", "static", requirements_type, pydir, "linux-crypto.txt"
221         )
222         if os.path.exists(_requirements_file):
223             return _requirements_file
224         session.error("Could not find a linux requirements file for {}".format(pydir))
225 def _upgrade_pip_setuptools_and_wheel(session, upgrade=True):
226     if SKIP_REQUIREMENTS_INSTALL:
227         session.log(
228             "Skipping Python Requirements because SKIP_REQUIREMENTS_INSTALL was found in the environ"
229         )
230         return False
231     install_command = [
232         "python",
233         "-m",
234         "pip",
235         "install",
236         "--progress-bar=off",
237     ]
238     if upgrade:
239         install_command.append("-U")
240     install_command.extend(
241         [
242             "pip&gt;=20.2.4,&lt;21.2",
243             "setuptools!=50.*,!=51.*,!=52.*,&lt;59",
244             "wheel",
245         ]
246     )
247     session.run(*install_command, silent=PIP_INSTALL_SILENT)
248     return True
249 def _install_requirements(
250     session, transport, *extra_requirements, requirements_type="ci"
251 ):
252     if not _upgrade_pip_setuptools_and_wheel(session):
253         return
254 def _install_requirements(
255     session, transport, *extra_requirements, requirements_type="ci"
256 ):
257     if not _upgrade_pip_setuptools_and_wheel(session):
258         return False
259     requirements_file = _get_pip_requirements_file(
260         session, transport, requirements_type=requirements_type
261     )
262     install_command = ["--progress-bar=off", "-r", requirements_file]
263     session.install(*install_command, silent=PIP_INSTALL_SILENT)
264     if extra_requirements:
265         install_command = ["--progress-bar=off"]
266         install_command += list(extra_requirements)
267         session.install(*install_command, silent=PIP_INSTALL_SILENT)
268     if EXTRA_REQUIREMENTS_INSTALL:
269         session.log(
270             "Installing the following extra requirements because the"
271             " EXTRA_REQUIREMENTS_INSTALL environment variable was set: %s",
272             EXTRA_REQUIREMENTS_INSTALL,
273         )
274         install_command = ["--progress-bar=off", "--constraint", requirements_file]
275         install_command += EXTRA_REQUIREMENTS_INSTALL.split()
276         session.install(*install_command, silent=PIP_INSTALL_SILENT)
277     return True
278 def _run_with_coverage(session, *test_cmd, env=None):
279     if SKIP_REQUIREMENTS_INSTALL is False:
280         session.install(
281             "--progress-bar=off", "coverage==5.2", silent=PIP_INSTALL_SILENT
282         )
283     session.run("coverage", "erase")
284     python_path_env_var = os.environ.get("PYTHONPATH") or None
285     if python_path_env_var is None:
286         python_path_env_var = SITECUSTOMIZE_DIR
287     else:
288         python_path_entries = python_path_env_var.split(os.pathsep)
289         if SITECUSTOMIZE_DIR in python_path_entries:
290             python_path_entries.remove(SITECUSTOMIZE_DIR)
291         python_path_entries.insert(0, SITECUSTOMIZE_DIR)
292         python_path_env_var = os.pathsep.join(python_path_entries)
293     coverage_base_env = {
294         "COVERAGE_FILE": str(COVERAGE_OUTPUT_DIR / ".coverage")
295     }
296     if env is None:
297         env = {}
298     env.update(
299         {
300             "PYTHONPATH": python_path_env_var,
301             "COVERAGE_PROCESS_START": str(REPO_ROOT / ".coveragerc"),
302         },
303         **coverage_base_env
304     )
305     try:
306         session.run(*test_cmd, env=env)
307     finally:
308         try:
309             session.run("coverage", "combine", env=coverage_base_env)
310         except CommandFailed:
311             pass
312         session.run(
313             "coverage",
314             "xml",
315             "-o",
316             str(COVERAGE_OUTPUT_DIR.joinpath("salt.xml").relative_to(REPO_ROOT)),
317             "--omit=tests/*",
318             "--include=salt/*",
319             env=coverage_base_env,
320         )
321         session.run(
322             "coverage",
323             "xml",
324             "-o",
325             str(COVERAGE_OUTPUT_DIR.joinpath("tests.xml").relative_to(REPO_ROOT)),
326             "--omit=salt/*",
327             "--include=tests/*",
328             env=coverage_base_env,
329         )
330 def _runtests(session):
331     session.error(
332         "For more information, please check "
333         "https://docs.saltproject.io/en/latest/topics/development/tests/index.html#running-the-tests\n..".format(
334             session._runner.global_config.sessions[0].replace("runtests", "pytest")
335         )
336     )
337 @nox.session(python=_PYTHON_VERSIONS, name="runtests-parametrized")
338 @nox.parametrize("coverage", [False, True])
339 @nox.parametrize("transport", ["zeromq", "tcp"])
340 @nox.parametrize("crypto", [None, "m2crypto", "pycryptodome"])
341 def runtests_parametrized(session, coverage, transport, crypto):
342     _runtests(session)
343 @nox.session(python=_PYTHON_VERSIONS)
344 @nox.parametrize("coverage", [False, True])
345 def runtests(session, coverage):
346     _runtests(session)
347 @nox.session(python=_PYTHON_VERSIONS, name="runtests-tcp")
348 @nox.parametrize("coverage", [False, True])
349 def runtests_tcp(session, coverage):
350     _runtests(session)
351 @nox.session(python=_PYTHON_VERSIONS, name="runtests-zeromq")
352 @nox.parametrize("coverage", [False, True])
353 def runtests_zeromq(session, coverage):
354     _runtests(session)
355 @nox.session(python=_PYTHON_VERSIONS, name="runtests-m2crypto")
356 @nox.parametrize("coverage", [False, True])
357 def runtests_m2crypto(session, coverage):
358     _runtests(session)
359 @nox.session(python=_PYTHON_VERSIONS, name="runtests-tcp-m2crypto")
360 @nox.parametrize("coverage", [False, True])
361 def runtests_tcp_m2crypto(session, coverage):
362     _runtests(session)
363 @nox.session(python=_PYTHON_VERSIONS, name="runtests-zeromq-m2crypto")
364 @nox.parametrize("coverage", [False, True])
365 def runtests_zeromq_m2crypto(session, coverage):
366     _runtests(session)
367 @nox.session(python=_PYTHON_VERSIONS, name="runtests-pycryptodome")
368 @nox.parametrize("coverage", [False, True])
369 def runtests_pycryptodome(session, coverage):
370     _runtests(session)
371 @nox.session(python=_PYTHON_VERSIONS, name="runtests-tcp-pycryptodome")
372 @nox.parametrize("coverage", [False, True])
373 def runtests_tcp_pycryptodome(session, coverage):
374     _runtests(session)
375 @nox.session(python=_PYTHON_VERSIONS, name="runtests-zeromq-pycryptodome")
376 @nox.parametrize("coverage", [False, True])
377 def runtests_zeromq_pycryptodome(session, coverage):
378     _runtests(session)
379 @nox.session(python=_PYTHON_VERSIONS, name="runtests-cloud")
380 @nox.parametrize("coverage", [False, True])
381 def runtests_cloud(session, coverage):
382     _runtests(session)
383 @nox.session(python=_PYTHON_VERSIONS, name="runtests-tornado")
384 @nox.parametrize("coverage", [False, True])
385 def runtests_tornado(session, coverage):
386     _runtests(session)
387 @nox.session(python=_PYTHON_VERSIONS, name="pytest-parametrized")
388 @nox.parametrize("coverage", [False, True])
389 @nox.parametrize("transport", ["zeromq", "tcp"])
390 @nox.parametrize("crypto", [None, "m2crypto", "pycryptodome"])
391 def pytest_parametrized(session, coverage, transport, crypto):
392     if _install_requirements(session, transport):
393         if crypto:
394             session.run(
395                 "pip",
396                 "uninstall",
397                 "-y",
398                 "m2crypto",
399                 "pycrypto",
400                 "pycryptodome",
401                 "pycryptodomex",
402                 silent=True,
403             )
404             install_command = [
405                 "--progress-bar=off",
406                 "--constraint",
407                 _get_pip_requirements_file(session, transport, crypto=True),
408             ]
409             install_command.append(crypto)
410             session.install(*install_command, silent=PIP_INSTALL_SILENT)
411     cmd_args = [
412         "--rootdir",
413         str(REPO_ROOT),
414         "--log-file={}".format(RUNTESTS_LOGFILE),
415         "--log-file-level=debug",
416         "--show-capture=no",
417         "-ra",
418         "-s",
419         "--transport={}".format(transport),
420     ] + session.posargs
421     _pytest(session, coverage, cmd_args)
422 @nox.session(python=_PYTHON_VERSIONS)
423 @nox.parametrize("coverage", [False, True])
424 def pytest(session, coverage):
425     session.notify(
426         find_session_runner(
427             session,
428             "pytest-parametrized-{}".format(session.python),
429             coverage=coverage,
430             crypto=None,
431             transport="zeromq",
432         )
433     )
434 @nox.session(python=_PYTHON_VERSIONS, name="pytest-tcp")
435 @nox.parametrize("coverage", [False, True])
436 def pytest_tcp(session, coverage):
437     session.notify(
438         find_session_runner(
439             session,
440             "pytest-parametrized-{}".format(session.python),
441             coverage=coverage,
442             crypto=None,
443             transport="tcp",
444         )
445     )
446 @nox.session(python=_PYTHON_VERSIONS, name="pytest-zeromq")
447 @nox.parametrize("coverage", [False, True])
448 def pytest_zeromq(session, coverage):
449     session.notify(
450         find_session_runner(
451             session,
452             "pytest-parametrized-{}".format(session.python),
453             coverage=coverage,
454             crypto=None,
455             transport="zeromq",
456         )
457     )
458 @nox.session(python=_PYTHON_VERSIONS, name="pytest-m2crypto")
459 @nox.parametrize("coverage", [False, True])
460 def pytest_m2crypto(session, coverage):
461     session.notify(
462         find_session_runner(
463             session,
464             "pytest-parametrized-{}".format(session.python),
465             coverage=coverage,
466             crypto="m2crypto",
467             transport="zeromq",
468         )
469     )
470 @nox.session(python=_PYTHON_VERSIONS, name="pytest-tcp-m2crypto")
471 @nox.parametrize("coverage", [False, True])
472 def pytest_tcp_m2crypto(session, coverage):
473     session.notify(
474         find_session_runner(
475             session,
476             "pytest-parametrized-{}".format(session.python),
477             coverage=coverage,
478             crypto="m2crypto",
479             transport="tcp",
480         )
481     )
482 @nox.session(python=_PYTHON_VERSIONS, name="pytest-zeromq-m2crypto")
483 @nox.parametrize("coverage", [False, True])
484 def pytest_zeromq_m2crypto(session, coverage):
485     session.notify(
486         find_session_runner(
487             session,
488             "pytest-parametrized-{}".format(session.python),
489             coverage=coverage,
490             crypto="m2crypto",
491             transport="zeromq",
492         )
493     )
494 @nox.session(python=_PYTHON_VERSIONS, name="pytest-pycryptodome")
495 @nox.parametrize("coverage", [False, True])
496 def pytest_pycryptodome(session, coverage):
497     session.notify(
498         find_session_runner(
499             session,
500             "pytest-parametrized-{}".format(session.python),
501             coverage=coverage,
502             crypto="pycryptodome",
503             transport="zeromq",
504         )
505     )
506 @nox.session(python=_PYTHON_VERSIONS, name="pytest-tcp-pycryptodome")
507 @nox.parametrize("coverage", [False, True])
508 def pytest_tcp_pycryptodome(session, coverage):
509     session.notify(
510         find_session_runner(
511             session,
512             "pytest-parametrized-{}".format(session.python),
513             coverage=coverage,
514             crypto="pycryptodome",
515             transport="tcp",
516         )
517     )
518 @nox.session(python=_PYTHON_VERSIONS, name="pytest-zeromq-pycryptodome")
519 @nox.parametrize("coverage", [False, True])
520 def pytest_zeromq_pycryptodome(session, coverage):
521     session.notify(
522         find_session_runner(
523             session,
524             "pytest-parametrized-{}".format(session.python),
525             coverage=coverage,
526             crypto="pycryptodome",
527             transport="zeromq",
528         )
529     )
530 @nox.session(python=_PYTHON_VERSIONS, name="pytest-cloud")
531 @nox.parametrize("coverage", [False, True])
532 def pytest_cloud(session, coverage):
533     pydir = _get_pydir(session)
534     if pydir == "py3.5":
535         session.error(
536             "Due to conflicting and unsupported requirements the cloud tests only run on Py3.6+"
537         )
538     if _upgrade_pip_setuptools_and_wheel(session):
539         requirements_file = os.path.join(
540             "requirements", "static", "ci", pydir, "cloud.txt"
541         )
542         install_command = ["--progress-bar=off", "-r", requirements_file]
543         session.install(*install_command, silent=PIP_INSTALL_SILENT)
544     cmd_args = [
545         "--rootdir",
546         str(REPO_ROOT),
547         "--log-file={}".format(RUNTESTS_LOGFILE),
548         "--log-file-level=debug",
549         "--show-capture=no",
550         "-ra",
551         "-s",
552         "--run-expensive",
553         "-k",
554         "cloud",
555     ] + session.posargs
556     _pytest(session, coverage, cmd_args)
557 @nox.session(python=_PYTHON_VERSIONS, name="pytest-tornado")
558 @nox.parametrize("coverage", [False, True])
559 def pytest_tornado(session, coverage):
560     if _upgrade_pip_setuptools_and_wheel(session):
561         _install_requirements(session, "zeromq")
562         session.install(
563             "--progress-bar=off", "tornado==5.0.2", silent=PIP_INSTALL_SILENT
564         )
565         session.install(
566             "--progress-bar=off", "pyzmq==17.0.0", silent=PIP_INSTALL_SILENT
567         )
568     cmd_args = [
569         "--rootdir",
570         str(REPO_ROOT),
571         "--log-file={}".format(RUNTESTS_LOGFILE),
572         "--log-file-level=debug",
573         "--show-capture=no",
574         "-ra",
575         "-s",
576     ] + session.posargs
577     _pytest(session, coverage, cmd_args)
578 def _pytest(session, coverage, cmd_args):
579     _create_ci_directories()
580     env = {"CI_RUN": "1" if CI_RUN else "0"}
581     if IS_DARWIN:
582         env["OBJC_DISABLE_INITIALIZE_FORK_SAFETY"] = "YES"
583     if CI_RUN:
584         session.run(
585             "python", "-m", "pytest", *(cmd_args + ["--collect-only", "-qqq"]), env=env
586         )
587     try:
588         if coverage is True:
589             _run_with_coverage(
590                 session,
591                 "python",
592                 "-m",
593                 "coverage",
594                 "run",
595                 "-m",
596                 "pytest",
597                 "--showlocals",
598                 *cmd_args,
599                 env=env
600             )
601         else:
602             session.run("python", "-m", "pytest", *cmd_args, env=env)
603     except CommandFailed:  # pylint: disable=try-except-raise
604         raise
605         session.log("Re-running failed tests")
606         for idx, parg in enumerate(cmd_args):
607             if parg.startswith("--junitxml="):
608                 cmd_args[idx] = parg.replace(".xml", "-rerun-failed.xml")
609         cmd_args.append("--lf")
610         if coverage is True:
611             _run_with_coverage(
612                 session,
613                 "python",
614                 "-m",
615                 "coverage",
616                 "run",
617                 "-m",
618                 "pytest",
619                 "--showlocals",
620                 *cmd_args
621             )
622         else:
623             session.run("python", "-m", "pytest", *cmd_args, env=env)
624 class Tee:
625     def __init__(self, first, second):
626         self._first = first
627         self._second = second
628     def write(self, b):
629         wrote = self._first.write(b)
630         self._first.flush()
631         self._second.write(b)
632         self._second.flush()
633     def fileno(self):
634         return self._first.fileno()
635 def _lint(
636     session, rcfile, flags, paths, tee_output=True, upgrade_setuptools_and_pip=True
637 ):
638     if _upgrade_pip_setuptools_and_wheel(session, upgrade=upgrade_setuptools_and_pip):
639         requirements_file = os.path.join(
640             "requirements", "static", "ci", _get_pydir(session), "lint.txt"
641         )
642         install_command = ["--progress-bar=off", "-r", requirements_file]
643         session.install(*install_command, silent=PIP_INSTALL_SILENT)
644     if tee_output:
645         session.run("pylint", "--version")
646         pylint_report_path = os.environ.get("PYLINT_REPORT")
647     cmd_args = ["pylint", "--rcfile={}".format(rcfile)] + list(flags) + list(paths)
648     cmd_kwargs = {"env": {"PYTHONUNBUFFERED": "1"}}
649     if tee_output:
650         stdout = tempfile.TemporaryFile(mode="w+b")
651         cmd_kwargs["stdout"] = Tee(stdout, sys.__stdout__)
652     lint_failed = False
653     try:
654         session.run(*cmd_args, **cmd_kwargs)
655     except CommandFailed:
656         lint_failed = True
657         raise
658     finally:
659         if tee_output:
660             stdout.seek(0)
661             contents = stdout.read()
662             if contents:
663                 if IS_PY3:
664                     contents = contents.decode("utf-8")
665                 else:
666                     contents = contents.encode("utf-8")
667                 sys.stdout.write(contents)
668                 sys.stdout.flush()
669                 if pylint_report_path:
670                     with open(pylint_report_path, "w") as wfh:
671                         wfh.write(contents)
672                     session.log("Report file written to %r", pylint_report_path)
673             stdout.close()
674 def _lint_pre_commit(session, rcfile, flags, paths):
675     if "VIRTUAL_ENV" not in os.environ:
676         session.error(
677             "This should be running from within a virtualenv and "
678             "'VIRTUAL_ENV' was not found as an environment variable."
679         )
680     if "pre-commit" not in os.environ["VIRTUAL_ENV"]:
681         session.error(
682             "This should be running from within a pre-commit virtualenv and "
683             "'VIRTUAL_ENV'({}) does not appear to be a pre-commit virtualenv.".format(
684                 os.environ["VIRTUAL_ENV"]
685             )
686         )
687     from nox.virtualenv import VirtualEnv
688     try:
689         session._runner.venv = VirtualEnv(  # pylint: disable=unexpected-keyword-arg
690             os.environ["VIRTUAL_ENV"],
691             interpreter=session._runner.func.python,
692             reuse_existing=True,
693             venv=True,
694         )
695     except TypeError:
696         session._runner.venv = VirtualEnv(
697             os.environ["VIRTUAL_ENV"],
698             interpreter=session._runner.func.python,
699             reuse_existing=True,
700         )
701     _lint(
702         session,
703         rcfile,
704         flags,
705         paths,
706         tee_output=False,
707         upgrade_setuptools_and_pip=False,
708     )
709 @nox.session(python="3")
710 def lint(session):
711     session.notify("lint-salt-{}".format(session.python))
712     session.notify("lint-tests-{}".format(session.python))
713 @nox.session(python="3", name="lint-salt")
714 def lint_salt(session):
715     flags = ["--disable=I"]
716     if session.posargs:
717         paths = session.posargs
718     else:
719         paths = ["setup.py", "noxfile.py", "salt/", "tasks/"]
720     _lint(session, ".pylintrc", flags, paths)
721 @nox.session(python="3", name="lint-tests")
722 def lint_tests(session):
723     flags = ["--disable=I"]
724     if session.posargs:
725         paths = session.posargs
726     else:
727         paths = ["tests/"]
728     _lint(session, ".pylintrc", flags, paths)
729 @nox.session(python=False, name="lint-salt-pre-commit")
730 def lint_salt_pre_commit(session):
731     flags = ["--disable=I"]
732     if session.posargs:
733         paths = session.posargs
734     else:
735         paths = ["setup.py", "noxfile.py", "salt/"]
736     _lint_pre_commit(session, ".pylintrc", flags, paths)
737 @nox.session(python=False, name="lint-tests-pre-commit")
738 def lint_tests_pre_commit(session):
739     flags = ["--disable=I"]
740     if session.posargs:
741         paths = session.posargs
742     else:
743         paths = ["tests/"]
744     _lint_pre_commit(session, ".pylintrc", flags, paths)
745 @nox.session(python="3")
746 @nox.parametrize("clean", [False, True])
747 @nox.parametrize("update", [False, True])
748 @nox.parametrize("compress", [False, True])
749 def docs(session, compress, update, clean):
750     session.notify("docs-html-{}(compress={})".format(session.python, compress))
751     session.notify(
752         find_session_runner(
753             session,
754             "docs-man-{}".format(session.python),
755             compress=compress,
756             update=update,
757             clean=clean,
758         )
759     )
760 @nox.session(name="docs-html", python="3")
761 @nox.parametrize("clean", [False, True])
762 @nox.parametrize("compress", [False, True])
763 def docs_html(session, compress, clean):
764     if _upgrade_pip_setuptools_and_wheel(session):
765         requirements_file = os.path.join(
766             "requirements", "static", "ci", _get_pydir(session), "docs.txt"
767         )
768         install_command = ["--progress-bar=off", "-r", requirements_file]
769         session.install(*install_command, silent=PIP_INSTALL_SILENT)
770     os.chdir("doc/")
771     if clean:
772         session.run("make", "clean", external=True)
773     session.run("make", "html", "SPHINXOPTS=-W", external=True)
774     if compress:
775         session.run("tar", "-cJvf", "html-archive.tar.xz", "_build/html", external=True)
776     os.chdir("..")
777 @nox.session(name="docs-man", python="3")
778 @nox.parametrize("clean", [False, True])
779 @nox.parametrize("update", [False, True])
780 @nox.parametrize("compress", [False, True])
781 def docs_man(session, compress, update, clean):
782     if _upgrade_pip_setuptools_and_wheel(session):
783         requirements_file = os.path.join(
784             "requirements", "static", "ci", _get_pydir(session), "docs.txt"
785         )
786         install_command = ["--progress-bar=off", "-r", requirements_file]
787         session.install(*install_command, silent=PIP_INSTALL_SILENT)
788     os.chdir("doc/")
789     if clean:
790         session.run("make", "clean", external=True)
791     session.run("make", "man", "SPHINXOPTS=-W", external=True)
792     if update:
793         session.run("rm", "-rf", "man/", external=True)
794         session.run("cp", "-Rp", "_build/man", "man/", external=True)
795     if compress:
796         session.run("tar", "-cJvf", "man-archive.tar.xz", "_build/man", external=True)
797     os.chdir("..")
798 @nox.session(name="invoke", python="3")
799 def invoke(session):
800     if _upgrade_pip_setuptools_and_wheel(session):
801         _install_requirements(session, "zeromq")
802         requirements_file = os.path.join(
803             "requirements", "static", "ci", _get_pydir(session), "invoke.txt"
804         )
805         install_command = ["--progress-bar=off", "-r", requirements_file]
806         session.install(*install_command, silent=PIP_INSTALL_SILENT)
807     cmd = ["inv"]
808     files = []
809     for idx, posarg in enumerate(session.posargs):
810         if idx == 0:
811             cmd.append(posarg)
812             continue
813         if posarg.startswith("--"):
814             cmd.append(posarg)
815             continue
816         files.append(posarg)
817     if files:
818         cmd.append("--files={}".format(" ".join(files)))
819     session.run(*cmd)
820 @nox.session(name="changelog", python="3")
821 @nox.parametrize("draft", [False, True])
822 def changelog(session, draft):
823     if _upgrade_pip_setuptools_and_wheel(session):
824         requirements_file = os.path.join(
825             "requirements", "static", "ci", _get_pydir(session), "changelog.txt"
826         )
827         install_command = ["--progress-bar=off", "-r", requirements_file]
828         session.install(*install_command, silent=PIP_INSTALL_SILENT)
829     town_cmd = ["towncrier", "--version={}".format(session.posargs[0])]
830     if draft:
831         town_cmd.append("--draft")
832     session.run(*town_cmd)
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
