<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_glusterfs.py & test_influxdb08_user.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_glusterfs.py & test_influxdb08_user.py
      </h3>
      <h1 align="center">
        11.6%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_glusterfs.py (7.0198674%)<TH>test_influxdb08_user.py (33.75796%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match16076-0.html#0',2,'match16076-1.html#0',3)" NAME="0">(235-243)<TD><A HREF="javascript:ZweiFrames('match16076-0.html#0',2,'match16076-1.html#0',3)" NAME="0">(42-47)</A><TD ALIGN=center><FONT COLOR="#ff0000">15</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match16076-0.html#1',2,'match16076-1.html#1',3)" NAME="1">(216-223)<TD><A HREF="javascript:ZweiFrames('match16076-0.html#1',2,'match16076-1.html#1',3)" NAME="1">(37-41)</A><TD ALIGN=center><FONT COLOR="#dd0000">13</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match16076-0.html#2',2,'match16076-1.html#2',3)" NAME="2">(83-88)<TD><A HREF="javascript:ZweiFrames('match16076-0.html#2',2,'match16076-1.html#2',3)" NAME="2">(77-81)</A><TD ALIGN=center><FONT COLOR="#dd0000">13</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match16076-0.html#3',2,'match16076-1.html#3',3)" NAME="3">(20-33)<TD><A HREF="javascript:ZweiFrames('match16076-0.html#3',2,'match16076-1.html#3',3)" NAME="3">(57-69)</A><TD ALIGN=center><FONT COLOR="#cc0000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_glusterfs.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Jayesh Kariya &lt;jayeshk@saltstack.com&gt;
&quot;&quot;&quot;

import salt.modules.glusterfs as mod_glusterfs
import salt.states.glusterfs as glusterfs
import salt.utils.cloud
import salt.utils.network
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import MagicMock, patch
from tests.support.unit import TestCase


class GlusterfsTestCase(TestCase, LoaderModuleMockMixin):
    &quot;&quot;&quot;
    Test cases for salt.states.glusterfs
<A NAME="3"></A>    &quot;&quot;&quot;

    def setup_loader_modules(self):
        return {glusterfs: {&quot;__salt__&quot;: {&quot;glusterfs.peer&quot;: mod_glusterfs.<FONT color="#53858b"><A HREF="javascript:ZweiFrames('match16076-1.html#3',3,'match16076-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>peer}}}

    # 'peered' function tests: 1

    def test_peered(self):
        &quot;&quot;&quot;
        Test to verify if node is peered.
        &quot;&quot;&quot;
        name = &quot;server1&quot;

        ret = {&quot;name&quot;: name, &quot;result&quot;: True, &quot;comment&quot;: &quot;&quot;, &quot;changes&quot;: {}}

        mock_ip = MagicMock(return_value=[&quot;1.2.3.4&quot;, &quot;1.2.3.5&quot;])
        mock_ip6 = MagicMock(return_value=</B></FONT>[&quot;2001:db8::1&quot;])
        mock_host_ips = MagicMock(return_value=[&quot;1.2.3.5&quot;])
        mock_peer = MagicMock(return_value=True)
        mock_status = MagicMock(return_value={&quot;uuid1&quot;: {&quot;hostnames&quot;: [name]}})

        with patch.dict(
            glusterfs.__salt__,
            {&quot;glusterfs.peer_status&quot;: mock_status, &quot;glusterfs.peer&quot;: mock_peer},
        ):
            with patch.object(salt.utils.network, &quot;ip_addrs&quot;, mock_ip), patch.object(
                salt.utils.network, &quot;ip_addrs6&quot;, mock_ip6
            ), patch.object(salt.utils.network, &quot;host_to_ips&quot;, mock_host_ips):
                comt = &quot;Peering with localhost is not needed&quot;
                ret.update({&quot;comment&quot;: comt})
                self.assertDictEqual(glusterfs.peered(name), ret)

                mock_host_ips.return_value = [&quot;2001:db8::1&quot;]
                self.assertDictEqual(glusterfs.peered(name), ret)

                mock_host_ips.return_value = [&quot;1.2.3.42&quot;]
                comt = &quot;Host {} already peered&quot;.format(name)
                ret.update({&quot;comment&quot;: comt})
                self.assertDictEqual(glusterfs.peered(name), ret)

                with patch.dict(glusterfs.__opts__, {&quot;test&quot;: False}):
                    old = {&quot;uuid1&quot;: {&quot;hostnames&quot;: [&quot;other1&quot;]}}
                    new = {
                        &quot;uuid1&quot;: {&quot;hostnames&quot;: [&quot;other1&quot;]},
                        &quot;uuid2&quot;: {&quot;hostnames&quot;: [&quot;someAlias&quot;, name]},
                    }
                    mock_status.side_effect = [old, new]
                    comt = &quot;Host {} successfully peered&quot;.format(name)
                    ret.update({&quot;comment&quot;: comt, &quot;changes&quot;: {&quot;old&quot;: old, &quot;new&quot;: new}})
                    self.assertDictEqual(glusterfs.peered(name), ret)
                    mock_status.side_effect = None

                    mock_status.return_value = {&quot;uuid1&quot;: {&quot;hostnames&quot;: [&quot;other&quot;]}}
                    mock_peer.return_value = False

                    ret.update({&quot;result&quot;: False})

                    comt = (
                        &quot;Failed to peer with {0},&quot; + &quot; please check logs for errors&quot;
                    ).format(name)
                    ret.update({&quot;comment&quot;: comt, &quot;changes&quot;: {}})
                    self.assertDictEqual(glusterfs.peered(name), ret)

<A NAME="2"></A>                    comt = &quot;Invalid characters in peer name.&quot;
                    ret.update({&quot;comment&quot;: comt, &quot;name&quot;: &quot;:/&quot;})
                    self.assertDictEqual(glusterfs.peered(&quot;:/&quot;), ret)
                    ret.update({&quot;<FONT color="#980517"><A HREF="javascript:ZweiFrames('match16076-1.html#2',3,'match16076-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>name&quot;: name})

                with patch.dict(glusterfs.__opts__, {&quot;test&quot;: True}):
                    comt = &quot;Peer {} will be added.&quot;.format(name)
                    ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
                    self.</B></FONT>assertDictEqual(glusterfs.peered(name), ret)

    # 'volume_present' function tests: 1

    def test_volume_present(self):
        &quot;&quot;&quot;
        Test to ensure that a volume exists
        &quot;&quot;&quot;
        name = &quot;salt&quot;
        bricks = [&quot;host1:/brick1&quot;]
        ret = {&quot;name&quot;: name, &quot;result&quot;: True, &quot;comment&quot;: &quot;&quot;, &quot;changes&quot;: {}}

        started_info = {name: {&quot;status&quot;: &quot;1&quot;}}
        stopped_info = {name: {&quot;status&quot;: &quot;0&quot;}}

        mock_info = MagicMock()
        mock_list = MagicMock()
        mock_create = MagicMock()
        mock_start = MagicMock(return_value=True)

        with patch.dict(
            glusterfs.__salt__,
            {
                &quot;glusterfs.info&quot;: mock_info,
                &quot;glusterfs.list_volumes&quot;: mock_list,
                &quot;glusterfs.create_volume&quot;: mock_create,
                &quot;glusterfs.start_volume&quot;: mock_start,
            },
        ):
            with patch.dict(glusterfs.__opts__, {&quot;test&quot;: False}):
                mock_list.return_value = [name]
                mock_info.return_value = started_info
                comt = &quot;Volume {} already exists and is started&quot;.format(name)
                ret.update({&quot;comment&quot;: comt})
                self.assertDictEqual(
                    glusterfs.volume_present(name, bricks, start=True), ret
                )

                mock_info.return_value = stopped_info
                comt = &quot;Volume {} already exists and is now started&quot;.format(name)
                ret.update(
                    {&quot;comment&quot;: comt, &quot;changes&quot;: {&quot;old&quot;: &quot;stopped&quot;, &quot;new&quot;: &quot;started&quot;}}
                )
                self.assertDictEqual(
                    glusterfs.volume_present(name, bricks, start=True), ret
                )

                comt = &quot;Volume {} already exists&quot;.format(name)
                ret.update({&quot;comment&quot;: comt, &quot;changes&quot;: {}})
                self.assertDictEqual(
                    glusterfs.volume_present(name, bricks, start=False), ret
                )
            with patch.dict(glusterfs.__opts__, {&quot;test&quot;: True}):
                comt = &quot;Volume {} already exists&quot;.format(name)
                ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
                self.assertDictEqual(
                    glusterfs.volume_present(name, bricks, start=False), ret
                )

                comt = (&quot;Volume {0} already exists&quot; + &quot; and will be started&quot;).format(
                    name
                )
                ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
                self.assertDictEqual(
                    glusterfs.volume_present(name, bricks, start=True), ret
                )

                mock_list.return_value = []
                comt = &quot;Volume {} will be created&quot;.format(name)
                ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
                self.assertDictEqual(
                    glusterfs.volume_present(name, bricks, start=False), ret
                )

                comt = (&quot;Volume {0} will be created&quot; + &quot; and started&quot;).format(name)
                ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
                self.assertDictEqual(
                    glusterfs.volume_present(name, bricks, start=True), ret
                )

            with patch.dict(glusterfs.__opts__, {&quot;test&quot;: False}):
                mock_list.side_effect = [[], [name]]
                comt = &quot;Volume {} is created&quot;.format(name)
                ret.update(
                    {
                        &quot;comment&quot;: comt,
                        &quot;result&quot;: True,
                        &quot;changes&quot;: {&quot;old&quot;: [], &quot;new&quot;: [name]},
                    }
                )
                self.assertDictEqual(
                    glusterfs.volume_present(name, bricks, start=False), ret
                )

                mock_list.side_effect = [[], [name]]
                comt = &quot;Volume {} is created and is now started&quot;.format(name)
                ret.update({&quot;comment&quot;: comt, &quot;result&quot;: True})
                self.assertDictEqual(
                    glusterfs.volume_present(name, bricks, start=True), ret
                )

                mock_list.side_effect = None
                mock_list.return_value = []
                mock_create.return_value = False
                comt = &quot;Creation of volume {} failed&quot;.format(name)
                ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False, &quot;changes&quot;: {}})
                self.assertDictEqual(glusterfs.volume_present(name, bricks), ret)

            with patch.object(
                salt.utils.cloud, &quot;check_name&quot;, MagicMock(return_value=True)
            ):
                comt = &quot;Invalid characters in volume name.&quot;
                ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False})
                self.assertDictEqual(glusterfs.volume_present(name, bricks), ret)

    # 'started' function tests: 1

    def test_started(self):
        &quot;&quot;&quot;
        Test to check if volume has been started
        &quot;&quot;&quot;
        name = &quot;salt&quot;

        ret = {&quot;name&quot;: name, &quot;result&quot;: False, &quot;comment&quot;: &quot;&quot;, &quot;changes&quot;: {}}

<A NAME="1"></A>        started_info = {name: {&quot;status&quot;: &quot;1&quot;}}
        stopped_info = {name: {&quot;status&quot;: &quot;0&quot;}}
        mock_info = MagicMock(return_value={})
        mock_start = MagicMock<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match16076-1.html#1',3,'match16076-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>(return_value=True)

        with patch.dict(
            glusterfs.__salt__,
            {&quot;glusterfs.info&quot;: mock_info, &quot;glusterfs.start_volume&quot;: mock_start},
        ):
            comt = &quot;Volume {} does not exist&quot;.format(name)
            ret.update({&quot;comment&quot;</B></FONT>: comt})
            self.assertDictEqual(glusterfs.started(name), ret)

            mock_info.return_value = started_info
            comt = &quot;Volume {} is already started&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: True})
            self.assertDictEqual(glusterfs.started(name), ret)

            with patch.dict(glusterfs.__opts__, {&quot;test&quot;: True}):
<A NAME="0"></A>                mock_info.return_value = stopped_info
                comt = &quot;Volume {} will be started&quot;.format(name)
                ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
                self.assertDictEqual(glusterfs<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match16076-1.html#0',3,'match16076-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.started(name), ret)

            with patch.dict(glusterfs.__opts__, {&quot;test&quot;: False}):
                comt = &quot;Volume {} is started&quot;.format(name)
                ret.update(
                    {
                        &quot;comment&quot;: comt,
                        &quot;result&quot;: True,
                        &quot;change&quot;: {&quot;new&quot;</B></FONT>: &quot;started&quot;, &quot;old&quot;: &quot;stopped&quot;},
                    }
                )
                self.assertDictEqual(glusterfs.started(name), ret)

    # 'add_volume_bricks' function tests: 1

    def test_add_volume_bricks(self):
        &quot;&quot;&quot;
        Test to add brick(s) to an existing volume
        &quot;&quot;&quot;
        name = &quot;salt&quot;
        bricks = [&quot;host1:/drive1&quot;]
        old_bricks = [&quot;host1:/drive2&quot;]

        ret = {&quot;name&quot;: name, &quot;result&quot;: False, &quot;comment&quot;: &quot;&quot;, &quot;changes&quot;: {}}

        stopped_volinfo = {&quot;salt&quot;: {&quot;status&quot;: &quot;0&quot;}}
        volinfo = {
            &quot;salt&quot;: {&quot;status&quot;: &quot;1&quot;, &quot;bricks&quot;: {&quot;brick1&quot;: {&quot;path&quot;: old_bricks[0]}}}
        }
        new_volinfo = {
            &quot;salt&quot;: {
                &quot;status&quot;: &quot;1&quot;,
                &quot;bricks&quot;: {
                    &quot;brick1&quot;: {&quot;path&quot;: old_bricks[0]},
                    &quot;brick2&quot;: {&quot;path&quot;: bricks[0]},
                },
            }
        }

        mock_info = MagicMock(return_value={})
        mock_add = MagicMock(side_effect=[False, True])

        with patch.dict(
            glusterfs.__salt__,
            {&quot;glusterfs.info&quot;: mock_info, &quot;glusterfs.add_volume_bricks&quot;: mock_add},
        ):
            ret.update({&quot;comment&quot;: &quot;Volume salt does not exist&quot;})
            self.assertDictEqual(glusterfs.add_volume_bricks(name, bricks), ret)

            mock_info.return_value = stopped_volinfo
            ret.update({&quot;comment&quot;: &quot;Volume salt is not started&quot;})
            self.assertDictEqual(glusterfs.add_volume_bricks(name, bricks), ret)

            mock_info.return_value = volinfo
            ret.update({&quot;comment&quot;: &quot;Adding bricks to volume salt failed&quot;})
            self.assertDictEqual(glusterfs.add_volume_bricks(name, bricks), ret)

            ret.update({&quot;result&quot;: True})
            ret.update({&quot;comment&quot;: &quot;Bricks already added in volume salt&quot;})
            self.assertDictEqual(glusterfs.add_volume_bricks(name, old_bricks), ret)

            mock_info.side_effect = [volinfo, new_volinfo]
            ret.update(
                {
                    &quot;comment&quot;: &quot;Bricks successfully added to volume salt&quot;,
                    &quot;changes&quot;: {&quot;new&quot;: bricks + old_bricks, &quot;old&quot;: old_bricks},
                }
            )
            # Let's sort ourselves because the test under python 3 sometimes fails
            # just because of the new changes list order
            result = glusterfs.add_volume_bricks(name, bricks)
            ret[&quot;changes&quot;][&quot;new&quot;] = sorted(ret[&quot;changes&quot;][&quot;new&quot;])
            result[&quot;changes&quot;][&quot;new&quot;] = sorted(result[&quot;changes&quot;][&quot;new&quot;])
            self.assertDictEqual(result, ret)

    # 'op_version' function tests: 1

    def test_op_version(self):
        &quot;&quot;&quot;
        Test setting the Glusterfs op-version
        &quot;&quot;&quot;
        name = &quot;salt&quot;
        current = 30707
        new = 31200

        ret = {&quot;name&quot;: name, &quot;result&quot;: False, &quot;comment&quot;: &quot;&quot;, &quot;changes&quot;: {}}

        mock_get_version = MagicMock(return_value={})
        mock_set_version = MagicMock(return_value={})

        with patch.dict(
            glusterfs.__salt__,
            {
                &quot;glusterfs.get_op_version&quot;: mock_get_version,
                &quot;glusterfs.set_op_version&quot;: mock_set_version,
            },
        ):
            mock_get_version.return_value = [False, &quot;some error message&quot;]
            ret.update({&quot;result&quot;: False})
            ret.update({&quot;comment&quot;: &quot;some error message&quot;})
            self.assertDictEqual(glusterfs.op_version(name, current), ret)

            mock_get_version.return_value = current
            ret.update({&quot;result&quot;: True})
            ret.update(
                {
                    &quot;comment&quot;: (
                        &quot;Glusterfs cluster.op-version for {} already set to {}&quot;.format(
                            name, current
                        )
                    )
                }
            )
            self.assertDictEqual(glusterfs.op_version(name, current), ret)

            with patch.dict(glusterfs.__opts__, {&quot;test&quot;: True}):
                mock_set_version.return_value = [False, &quot;Failed to set version&quot;]
                ret.update({&quot;result&quot;: None})
                ret.update(
                    {
                        &quot;comment&quot;: (
                            &quot;An attempt would be made to set the cluster.op-version for&quot;
                            &quot; {} to {}.&quot;.format(name, new)
                        )
                    }
                )
                self.assertDictEqual(glusterfs.op_version(name, new), ret)

            with patch.dict(glusterfs.__opts__, {&quot;test&quot;: False}):
                mock_set_version.return_value = [False, &quot;Failed to set version&quot;]
                ret.update({&quot;result&quot;: False})
                ret.update({&quot;comment&quot;: &quot;Failed to set version&quot;})
                self.assertDictEqual(glusterfs.op_version(name, new), ret)

                mock_set_version.return_value = &quot;some success message&quot;
                ret.update({&quot;comment&quot;: &quot;some success message&quot;})
                ret.update({&quot;changes&quot;: {&quot;old&quot;: current, &quot;new&quot;: new}})
                ret.update({&quot;result&quot;: True})
                self.assertDictEqual(glusterfs.op_version(name, new), ret)

    # 'max_op_version' function tests: 1

    def test_max_op_version(self):
        &quot;&quot;&quot;
        Test setting the Glusterfs to its self reported max-op-version
        &quot;&quot;&quot;
        name = &quot;salt&quot;
        current = 30707
        new = 31200

        ret = {&quot;name&quot;: name, &quot;result&quot;: False, &quot;comment&quot;: &quot;&quot;, &quot;changes&quot;: {}}

        mock_get_version = MagicMock(return_value={})
        mock_get_max_op_version = MagicMock(return_value={})
        mock_set_version = MagicMock(return_value={})

        with patch.dict(
            glusterfs.__salt__,
            {
                &quot;glusterfs.get_op_version&quot;: mock_get_version,
                &quot;glusterfs.set_op_version&quot;: mock_set_version,
                &quot;glusterfs.get_max_op_version&quot;: mock_get_max_op_version,
            },
        ):
            mock_get_version.return_value = [False, &quot;some error message&quot;]
            ret.update({&quot;result&quot;: False})
            ret.update({&quot;comment&quot;: &quot;some error message&quot;})
            self.assertDictEqual(glusterfs.max_op_version(name), ret)

            mock_get_version.return_value = current
            mock_get_max_op_version.return_value = [False, &quot;some error message&quot;]
            ret.update({&quot;result&quot;: False})
            ret.update({&quot;comment&quot;: &quot;some error message&quot;})
            self.assertDictEqual(glusterfs.max_op_version(name), ret)

            mock_get_version.return_value = current
            mock_get_max_op_version.return_value = current
            ret.update({&quot;result&quot;: True})
            ret.update(
                {
                    &quot;comment&quot;: (
                        &quot;The cluster.op-version is already set to the&quot;
                        &quot; cluster.max-op-version of {}&quot;.format(current)
                    )
                }
            )
            self.assertDictEqual(glusterfs.max_op_version(name), ret)

            with patch.dict(glusterfs.__opts__, {&quot;test&quot;: True}):
                mock_get_max_op_version.return_value = new
                ret.update({&quot;result&quot;: None})
                ret.update(
                    {
                        &quot;comment&quot;: (
                            &quot;An attempt would be made to set the cluster.op-version&quot;
                            &quot; to {}.&quot;.format(new)
                        )
                    }
                )
                self.assertDictEqual(glusterfs.max_op_version(name), ret)

            with patch.dict(glusterfs.__opts__, {&quot;test&quot;: False}):
                mock_set_version.return_value = [False, &quot;Failed to set version&quot;]
                ret.update({&quot;result&quot;: False})
                ret.update({&quot;comment&quot;: &quot;Failed to set version&quot;})
                self.assertDictEqual(glusterfs.max_op_version(name), ret)

                mock_set_version.return_value = &quot;some success message&quot;
                ret.update({&quot;comment&quot;: &quot;some success message&quot;})
                ret.update({&quot;changes&quot;: {&quot;old&quot;: current, &quot;new&quot;: new}})
                ret.update({&quot;result&quot;: True})
                self.assertDictEqual(glusterfs.max_op_version(name), ret)
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_influxdb08_user.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Jayesh Kariya &lt;jayeshk@saltstack.com&gt;
&quot;&quot;&quot;

import pytest
import salt.states.influxdb08_user as influxdb08_user
from tests.support.mock import MagicMock, patch


@pytest.fixture
def configure_loader_modules():
    return {influxdb08_user: {}}


def test_present():
    &quot;&quot;&quot;
    Test to ensure that the cluster admin or database user is present.
    &quot;&quot;&quot;
    name = &quot;salt&quot;
    passwd = &quot;salt&quot;

    ret = {&quot;name&quot;: name, &quot;result&quot;: False, &quot;comment&quot;: &quot;&quot;, &quot;changes&quot;: {}}

    mock = MagicMock(side_effect=[False, False, False, True])
    mock_t = MagicMock(side_effect=[True, False])
    mock_f = MagicMock(return_value=False)
    with patch.dict(
        influxdb08_user.__salt__,
        {
            &quot;influxdb08.db_exists&quot;: mock_f,
            &quot;influxdb08.user_exists&quot;: mock,
            &quot;influxdb08.user_create&quot;: mock_t,
        },
<A NAME="1"></A>    ):
        comt = &quot;Database mydb does not exist&quot;
        ret.update({&quot;comment&quot;: comt})
        assert influxdb08_user.present<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match16076-0.html#1',2,'match16076-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>(name, passwd, database=&quot;mydb&quot;) == ret

<A NAME="0"></A>        with patch.dict(influxdb08_user.__opts__, {&quot;test&quot;: True}):
            comt = &quot;User {} is not present and needs to be created&quot;.format(name)
            ret.update({&quot;comment&quot;</B></FONT>: comt, &quot;result&quot;: None})
            assert influxdb08_user<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match16076-0.html#0',2,'match16076-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.present(name, passwd) == ret

        with patch.dict(influxdb08_user.__opts__, {&quot;test&quot;: False}):
            comt = &quot;User {} has been created&quot;.format(name)
            ret.update(
                {&quot;comment&quot;: comt, &quot;result&quot;: True, &quot;changes&quot;: {&quot;salt&quot;</B></FONT>: &quot;Present&quot;}}
            )
            assert influxdb08_user.present(name, passwd) == ret

            comt = &quot;Failed to create user {}&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False, &quot;changes&quot;: {}})
            assert influxdb08_user.present(name, passwd) == ret
<A NAME="3"></A>
        comt = &quot;User {} is already present&quot;.format(name)
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: True})
        assert influxdb08_user.present(n<FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match16076-0.html#3',2,'match16076-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>ame, passwd) == ret


def test_absent():
    &quot;&quot;&quot;
    Test to ensure that the named cluster admin or database user is absent.
    &quot;&quot;&quot;
    name = &quot;salt&quot;

    ret = {&quot;name&quot;: name, &quot;result&quot;: None, &quot;comment&quot;: &quot;&quot;, &quot;changes&quot;: {}}

    mock = MagicMock(side_effect=[True, True, True, False])
    mock_t = MagicMock(side_effect=</B></FONT>[True, False])
    with patch.dict(
        influxdb08_user.__salt__,
        {&quot;influxdb08.user_exists&quot;: mock, &quot;influxdb08.user_remove&quot;: mock_t},
    ):
<A NAME="2"></A>        with patch.dict(influxdb08_user.__opts__, {&quot;test&quot;: True}):
            comt = &quot;User {} is present and needs to be removed&quot;.format(name)
            ret.update({&quot;comment&quot;: comt})
            assert influxdb08_user.absent(<FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match16076-0.html#2',2,'match16076-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>name) == ret

        with patch.dict(influxdb08_user.__opts__, {&quot;test&quot;: False}):
            comt = &quot;User {} has been removed&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: True, &quot;changes&quot;: {&quot;salt&quot;</B></FONT>: &quot;Absent&quot;}})
            assert influxdb08_user.absent(name) == ret

            comt = &quot;Failed to remove user {}&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False, &quot;changes&quot;: {}})
            assert influxdb08_user.absent(name) == ret

        comt = &quot;User {} is not present, so it cannot be removed&quot;.format(name)
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: True})
        assert influxdb08_user.absent(name) == ret
</PRE>
</div>
  </div>
</body>
</html>
