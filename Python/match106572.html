<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for capirca_acl.py &amp; test_network_4.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for capirca_acl.py &amp; test_network_4.py
      </h3>
<h1 align="center">
        3.2%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>capirca_acl.py (4.506699%)<th>test_network_4.py (2.5255973%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(375-385)<td><a href="#" name="0">(209-214)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(628-874)<td><a href="#" name="1">(15-129)</a><td align="center"><font color="#eb0000">12</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(354-359)<td><a href="#" name="2">(202-206)</a><td align="center"><font color="#eb0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>capirca_acl.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import datetime
2 import inspect
3 import logging
4 import re
5 import salt.utils.files
6 log = logging.getLogger(__file__)
7 try:
8     import capirca
9     import capirca.aclgen
10     import capirca.lib.policy
11     import capirca.lib.aclgenerator
12     HAS_CAPIRCA = True
13 except ImportError:
14     HAS_CAPIRCA = False
15 __virtualname__ = "capirca"
16 __proxyenabled__ = ["*"]
17 def __virtual__():
18     if HAS_CAPIRCA:
19         return __virtualname__
20     else:
21         return (False, "The capirca module (capirca_acl) cannot be loaded.")
22 _TERM_FIELDS = {
23     "action": [],
24     "address": [],
25     "address_exclude": [],
26     "comment": [],
27     "counter": None,
28     "expiration": None,
29     "destination_address": [],
30     "destination_address_exclude": [],
31     "destination_port": [],
32     "destination_prefix": [],
33     "forwarding_class": [],
34     "forwarding_class_except": [],
35     "logging": [],
36     "log_name": None,
37     "loss_priority": None,
38     "option": [],
39     "owner": None,
40     "policer": None,
41     "port": [],
42     "precedence": [],
43     "principals": [],
44     "protocol": [],
45     "protocol_except": [],
46     "qos": None,
47     "pan_application": [],
48     "routing_instance": None,
49     "source_address": [],
50     "source_address_exclude": [],
51     "source_port": [],
52     "source_prefix": [],
53     "verbatim": [],
54     "packet_length": None,
55     "fragment_offset": None,
56     "hop_limit": None,
57     "icmp_type": [],
58     "icmp_code": None,
59     "ether_type": [],
60     "traffic_class_count": None,
61     "traffic_type": [],
62     "translated": False,
63     "dscp_set": None,
64     "dscp_match": [],
65     "dscp_except": [],
66     "next_ip": None,
67     "flexible_match_range": [],
68     "source_prefix_except": [],
69     "destination_prefix_except": [],
70     "vpn": None,
71     "source_tag": [],
72     "destination_tag": [],
73     "source_interface": None,
74     "destination_interface": None,
75     "platform": [],
76     "platform_exclude": [],
77     "timeout": None,
78     "flattened": False,
79     "flattened_addr": None,
80     "flattened_saddr": None,
81     "flattened_daddr": None,
82     "priority": None,
83     "ttl": None,
84 }
85 _IP_FILEDS = [
86     "source_address",
87     "source_address_exclude",
88     "destination_address",
89     "address",
90     "address_exclude",
91     "flattened_addr",
92     "flattened_saddr",
93     "flattened_daddr",
94     "next_ip",
95 ]
96 _SERVICES = {}
97 if HAS_CAPIRCA:
98     _TempTerm = capirca.lib.policy.Term
99     def _add_object(self, obj):
100         return
101     setattr(_TempTerm, "AddObject", _add_object)
102     dumy_term = _TempTerm(None)
103     for item in dir(dumy_term):
104         if hasattr(item, "__func__") or item.startswith("_") or item != item.lower():
105             continue
106         _TERM_FIELDS[item] = getattr(dumy_term, item)
107     class _Policy(capirca.lib.policy.Policy):
108         def __init__(self):
109             self.filters = []
110             self.filename = ""
111     class _Term(capirca.lib.policy.Term):
112         def __init__(self):
113             for field, default in _TERM_FIELDS.items():
114                 setattr(self, field, default)
115 def _import_platform_generator(platform):
116     log.debug("Using platform: %s", platform)
117     for mod_name, mod_obj in inspect.getmembers(capirca.aclgen):
118         if mod_name == platform and inspect.ismodule(mod_obj):
119             for plat_obj_name, plat_obj in inspect.getmembers(
120                 mod_obj
121             ):  # pylint: disable=unused-variable
122                 if inspect.isclass(plat_obj) and issubclass(
123                     plat_obj, capirca.lib.aclgenerator.ACLGenerator
124                 ):
125                     log.debug("Identified Capirca class %s for %s", plat_obj, platform)
126                     return plat_obj
127     log.error("Unable to identify any Capirca plaform class for %s", platform)
128 def _get_services_mapping():
129     if _SERVICES:
130         return _SERVICES
131     services_txt = ""
132     try:
133         with salt.utils.files.fopen("/etc/services", "r") as srv_f:
134             services_txt = salt.utils.stringutils.to_unicode(srv_f.read())
135     except OSError as ioe:
136         log.error("Unable to read from /etc/services:")
137         log.error(ioe)
138         return _SERVICES  # no mapping possible, sorry
139     service_rgx = re.compile(r"^([a-zA-Z0-9-]+)\s+(\d+)\/(tcp|udp)(.*)$")
140     for line in services_txt.splitlines():
141         service_rgx_s = service_rgx.search(line)
142         if service_rgx_s and len(service_rgx_s.groups()) == 4:
143             srv_name, port, protocol, _ = service_rgx_s.groups()
144             if srv_name not in _SERVICES:
145                 _SERVICES[srv_name] = {"port": [], "protocol": []}
146             try:
147                 _SERVICES[srv_name]["port"].append(int(port))
148             except ValueError as verr:
149                 log.error(verr)
150                 log.error("Did not read that properly:")
151                 log.error(line)
152                 log.error(
153                     "Please report the above error: %s does not seem a valid port"
154                     " value!",
155                     port,
156                 )
157             _SERVICES[srv_name]["protocol"].append(protocol)
158     return _SERVICES
159 def _translate_port(port):
160     services = _get_services_mapping()
161     if port in services and services[port]["port"]:
162         return services[port]["port"][0]
163     return port
164 def _make_it_list(dict_, field_name, value):
165     prev_value = []
166     if field_name in dict_:
167         prev_value = dict_[field_name]
168     if value is None:
169         return prev_value
170     elif isinstance(value, (tuple, list)):
171         if field_name in ("source_port", "destination_port"):
172             portval = []
173             for port in value:
174                 if not isinstance(port, (tuple, list)):
175                     portval.append((port, port))
176                 else:
177                     portval.append(port)
178             translated_portval = []
179             for port_start, port_end in portval:
180                 if not isinstance(port_start, int):
181                     port_start = _translate_port(port_start)
182                 if not isinstance(port_end, int):
183                     port_end = _translate_port(port_end)
184                 translated_portval.append((port_start, port_end))
185             return list(set(prev_value + translated_portval))
186         return list(set(prev_value + list(value)))
187     if field_name in ("source_port", "destination_port"):
188         if not isinstance(value, int):
189             value = _translate_port(value)
190         return list(set(prev_value + [(value, value)]))  # a list of tuples
191     return list(set(prev_value + [value]))
192 def _clean_term_opts(term_opts):
193     clean_opts = {}
194     _services = _get_services_mapping()
195     for field, value in term_opts.items():
196         if field == "source_service" and value:
197             if isinstance(value, str):
198                 value = _make_it_list(clean_opts, field, value)
199             log.debug("Processing special source services:")
200             log.debug(value)
201             for service in value:
202                 if service and service in _services:
203                     clean_opts["source_port"] = _make_it_list(
204                         clean_opts, "source_port", _services[service]["port"]
205                     )
206 <a name="2"></a>                    clean_opts["protocol"] = _make_it_list(
207                         clean_opts, "protocol", _services[service]["protocol"]
208                     )
209             log<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.debug(
210                 "Built source_port field, after processing special source services:"
211             )
212             log.debug(clean_opts.get("source_port"))
213             log.debug("Built protocol field, after processing special source services:")
214             log.debug(clean_opts.get(</b></font>"protocol"))
215         elif field == "destination_service" and value:
216             if isinstance(value, str):
217                 value = _make_it_list(clean_opts, field, value)
218             log.debug("Processing special destination services:")
219             log.debug(value)
220             for service in value:
221                 if service and service in _services:
222                     clean_opts["destination_port"] = _make_it_list(
223                         clean_opts, "destination_port", _services[service]["port"]
224                     )
225 <a name="0"></a>                    clean_opts["protocol"] = _make_it_list(
226                         clean_opts, "protocol", _services[service]["protocol"]
227                     )
228             log<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.debug(
229                 "Built source_port field, after processing special destination"
230                 " services:"
231             )
232             log.debug(clean_opts.get("destination_service"))
233             log.debug(
234                 "Built protocol field, after processing special destination services:"
235             )
236             log.debug(clean_opts.get("protocol"))
237         elif field in _TERM_FIELDS and value and value != _TERM_FIELDS[</b></font>field]:
238             if isinstance(_TERM_FIELDS[field], list):
239                 value = _make_it_list(clean_opts, field, value)
240             if field in _IP_FILEDS:
241                 ip_values = []
242                 for addr in value:
243                     ip_values.append(capirca.lib.policy.nacaddr.IP(addr))
244                 value = ip_values[:]
245             clean_opts[field] = value
246     return clean_opts
247 def _lookup_element(lst, key):
248     if not lst:
249         return {}
250     for ele in lst:
251         if not ele or not isinstance(ele, dict):
252             continue
253         if key in ele:
254             return ele[key]
255     return {}
256 def _get_pillar_cfg(pillar_key, pillarenv=None, saltenv=None):
257     pillar_cfg = __salt__["pillar.get"](
258         pillar_key, pillarenv=pillarenv, saltenv=saltenv
259     )
260     return pillar_cfg
261 def _cleanup(lst):
262     clean = []
263     for ele in lst:
264         if ele and isinstance(ele, dict):
265             clean.append(ele)
266     return clean
267 def _merge_list_of_dict(first, second, prepend=True):
268     first = _cleanup(first)
269     second = _cleanup(second)
270     if not first and not second:
271         return []
272     if not first and second:
273         return second
274     if first and not second:
275         return first
276     overlaps = []
277     merged = []
278     appended = []
279     for ele in first:
280         if _lookup_element(second, next(iter(ele))):
281             overlaps.append(ele)
282         elif prepend:
283             merged.append(ele)
284         elif not prepend:
285             appended.append(ele)
286     for ele in second:
287         ele_key = next(iter(ele))
288         if _lookup_element(overlaps, ele_key):
289             ele_val_first = _lookup_element(first, ele_key)
290             merged.append({ele_key: ele_val_first})
291         else:
292             merged.append(ele)
293     if not prepend:
294         merged.extend(appended)
295     return merged
296 def _get_term_object(
297     filter_name,
298     term_name,
299     pillar_key="acl",
300     pillarenv=None,
301     saltenv=None,
302     merge_pillar=True,
303     **term_fields
304 ):
305     log.debug("Generating config for term %s under filter %s", term_name, filter_name)
306     term = _Term()
307     term.name = term_name
308     term_opts = {}
309     if merge_pillar:
310         term_opts = get_term_pillar(
311             filter_name,
312             term_name,
313             pillar_key=pillar_key,
314             saltenv=saltenv,
315             pillarenv=pillarenv,
316         )
317         log.debug("Merging with pillar data:")
318         log.debug(term_opts)
319         term_opts = _clean_term_opts(term_opts)
320         log.debug("Cleaning up pillar data:")
321         log.debug(term_opts)
322     log.debug("Received processing opts:")
323     log.debug(term_fields)
324     log.debug("Cleaning up processing opts:")
325     term_fields = _clean_term_opts(term_fields)
326     log.debug(term_fields)
327     log.debug("Final term opts:")
328     term_opts.update(term_fields)
329     log.debug(term_fields)
330     for field, value in term_opts.items():
331         setattr(term, field, value)
332     log.debug("Term config:")
333     log.debug(str(term))
334     return term
335 def _get_policy_object(
336     platform,
337     filters=None,
338     pillar_key="acl",
339     pillarenv=None,
340     saltenv=None,
341     merge_pillar=True,
342 ):
343     policy = _Policy()
344     policy_filters = []
345     if not filters:
346         filters = []
347     for filter_ in filters:
348         if not filter_ or not isinstance(filter_, dict):
349             continue  # go to the next filter
350         filter_name, filter_config = next(iter(filter_.items()))
351         header = capirca.lib.policy.Header()  # same header everywhere
352         target_opts = [platform, filter_name]
353         filter_options = filter_config.pop("options", None)
354         if filter_options:
355             filter_options = _make_it_list({}, filter_name, filter_options)
356             target_opts.extend(filter_options)
357         target = capirca.lib.policy.Target(target_opts)
358         header.AddObject(target)
359         filter_terms = []
360         for term_ in filter_config.get("terms", []):
361             if term_ and isinstance(term_, dict):
362                 term_name, term_fields = next(iter(term_.items()))
363                 term = _get_term_object(
364                     filter_name,
365                     term_name,
366                     pillar_key=pillar_key,
367                     pillarenv=pillarenv,
368                     saltenv=saltenv,
369                     merge_pillar=merge_pillar,
370                     **term_fields
371                 )
372             filter_terms.append(term)
373         policy_filters.append((header, filter_terms))
374     policy.filters = policy_filters
375     log.debug("Policy config:")
376     log.debug(str(policy))
377     platform_generator = _import_platform_generator(platform)
378     policy_config = platform_generator(policy, 2)
379     log.debug("Generating policy config for %s:", platform)
380     log.debug(str(policy_config))
381     return policy_config
382 def _revision_tag(
383     text,
384     revision_id=None,
385     revision_no=None,
386     revision_date=True,
387     revision_date_format="%Y/%m/%d",
388 ):
389     timestamp = datetime.datetime.now().strftime(revision_date_format)
390     new_text = []
391     for line in text.splitlines():
392         if "$Id:$" in line:
393             if not revision_id:  # if no explicit revision ID required
394                 continue  # jump to next line, ignore this one
395             line = line.replace("$Id:$", "$Id: {rev_id} $".format(rev_id=revision_id))
396         if "$Revision:$" in line:
397             if not revision_no:  # if no explicit revision number required
398                 continue  # jump to next line, ignore this one
399             line = line.replace(
400                 "$Revision:$", "$Revision: {rev_no} $".format(rev_no=revision_no)
401             )
402         if "$Date:$" in line:
403             if not revision_date:
404                 continue  # jump
405             line = line.replace("$Date:$", "$Date: {ts} $".format(ts=timestamp))
406         new_text.append(line)
407     return "\n".join(new_text)
408 def get_term_config(
409     platform,
410     filter_name,
411     term_name,
412     filter_options=None,
413 <a name="1"></a>    pillar_key="acl",
414     pillarenv=None,
415     saltenv=None,
416     merge_pillar<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=True,
417     revision_id=None,
418     revision_no=None,
419     revision_date=True,
420     revision_date_format="%Y/%m/%d",
421     source_service=None,
422     destination_service=None,
423     **term_fields
424 ):
425     terms = []
426     term = {term_name: {}}
427     term[term_name].</b></font>update(term_fields)
428     term[term_name].update(
429         {
430             "source_service": _make_it_list({}, "source_service", source_service),
431             "destination_service": _make_it_list(
432                 {}, "destination_service", destination_service
433             ),
434         }
435     )
436     terms.append(term)
437     if not filter_options:
438         filter_options = []
439     return get_filter_config(
440         platform,
441         filter_name,
442         filter_options=filter_options,
443         terms=terms,
444         pillar_key=pillar_key,
445         pillarenv=pillarenv,
446         saltenv=saltenv,
447         merge_pillar=merge_pillar,
448         only_lower_merge=True,
449         revision_id=revision_id,
450         revision_no=revision_no,
451         revision_date=revision_date,
452         revision_date_format=revision_date_format,
453     )
454 def get_filter_config(
455     platform,
456     filter_name,
457     filter_options=None,
458     terms=None,
459     prepend=True,
460     pillar_key="acl",
461     pillarenv=None,
462     saltenv=None,
463     merge_pillar=True,
464     only_lower_merge=False,
465     revision_id=None,
466     revision_no=None,
467     revision_date=True,
468     revision_date_format="%Y/%m/%d",
469 ):
470     if not filter_options:
471         filter_options = []
472     if not terms:
473         terms = []
474     if merge_pillar and not only_lower_merge:
475         acl_pillar_cfg = _get_pillar_cfg(
476             pillar_key, saltenv=saltenv, pillarenv=pillarenv
477         )
478         filter_pillar_cfg = _lookup_element(acl_pillar_cfg, filter_name)
479         filter_options = filter_options or filter_pillar_cfg.pop("options", None)
480         if filter_pillar_cfg:
481             pillar_terms = filter_pillar_cfg.get(
482                 "terms", []
483             )  # No problem if empty in the pillar
484             terms = _merge_list_of_dict(terms, pillar_terms, prepend=prepend)
485     filters = []
486     filters.append(
487         {
488             filter_name: {
489                 "options": _make_it_list({}, filter_name, filter_options),
490                 "terms": terms,
491             }
492         }
493     )
494     return get_policy_config(
495         platform,
496         filters=filters,
497         pillar_key=pillar_key,
498         pillarenv=pillarenv,
499         saltenv=saltenv,
500         merge_pillar=merge_pillar,
501         only_lower_merge=True,
502         revision_id=revision_id,
503         revision_no=revision_no,
504         revision_date=revision_date,
505         revision_date_format=revision_date_format,
506     )
507 def get_policy_config(
508     platform,
509     filters=None,
510     prepend=True,
511     pillar_key="acl",
512     pillarenv=None,
513     saltenv=None,
514     merge_pillar=True,
515     only_lower_merge=False,
516     revision_id=None,
517     revision_no=None,
518     revision_date=True,
519     revision_date_format="%Y/%m/%d",
520 ):
521     if not filters:
522         filters = []
523     if merge_pillar and not only_lower_merge:
524         policy_pillar_cfg = _get_pillar_cfg(
525             pillar_key, saltenv=saltenv, pillarenv=pillarenv
526         )
527         filters = _merge_list_of_dict(filters, policy_pillar_cfg, prepend=prepend)
528     policy_object = _get_policy_object(
529         platform,
530         filters=filters,
531         pillar_key=pillar_key,
532         pillarenv=pillarenv,
533         saltenv=saltenv,
534         merge_pillar=merge_pillar,
535     )
536     policy_text = str(policy_object)
537     return _revision_tag(
538         policy_text,
539         revision_id=revision_id,
540         revision_no=revision_no,
541         revision_date=revision_date,
542         revision_date_format=revision_date_format,
543     )
544 def get_filter_pillar(filter_name, pillar_key="acl", pillarenv=None, saltenv=None):
545     pillar_cfg = _get_pillar_cfg(pillar_key, pillarenv=pillarenv, saltenv=saltenv)
546     return _lookup_element(pillar_cfg, filter_name)
547 def get_term_pillar(
548     filter_name, term_name, pillar_key="acl", pillarenv=None, saltenv=None
549 ):
550     filter_pillar_cfg = get_filter_pillar(
551         filter_name, pillar_key=pillar_key, pillarenv=pillarenv, saltenv=saltenv
552     )
553     term_pillar_cfg = filter_pillar_cfg.get("terms", [])
554     term_opts = _lookup_element(term_pillar_cfg, term_name)
555     return term_opts
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_network_4.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import socket
3 import textwrap
4 import time
5 import pytest
6 import salt.exceptions
7 import salt.utils.network as network
8 from salt._compat import ipaddress
9 from tests.support.mock import MagicMock, create_autospec, mock_open, patch
10 from tests.support.unit import TestCase
11 <a name="1"></a>
12 log = logging.getLogger(__name__)
13 LINUX <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= """\
14 eth0      Link encap:Ethernet  HWaddr e0:3f:49:85:6a:af
15           inet addr:10.10.10.56  Bcast:10.10.10.255  Mask:255.255.252.0
16           inet6 addr: fe80::e23f:49ff:fe85:6aaf/64 Scope:Link
17           UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
18           RX packets:643363 errors:0 dropped:0 overruns:0 frame:0
19           TX packets:196539 errors:0 dropped:0 overruns:0 carrier:0
20           collisions:0 txqueuelen:1000
21           RX bytes:386388355 (368.4 MiB)  TX bytes:25600939 (24.4 MiB)
22 lo        Link encap:Local Loopback
23           inet addr:127.0.0.1  Mask:255.0.0.0
24           inet6 addr: ::1/128 Scope:Host
25           UP LOOPBACK RUNNING  MTU:65536  Metric:1
26           RX packets:548901 errors:0 dropped:0 overruns:0 frame:0
27           TX packets:548901 errors:0 dropped:0 overruns:0 carrier:0
28           collisions:0 txqueuelen:0
29           RX bytes:613479895 (585.0 MiB)  TX bytes:613479895 (585.0 MiB)
30 SOLARIS = """\
31 lo0: flags=2001000849&lt;UP,LOOPBACK,RUNNING,MULTICAST,IPv4,VIRTUAL&gt; mtu 8232 index 1
32         inet 127.0.0.1 netmask ff000000
33 net0: flags=100001100943&lt;UP,BROADCAST,RUNNING,PROMISC,MULTICAST,ROUTER,IPv4,PHYSRUNNING&gt; mtu 1500 index 2
34         inet 10.10.10.38 netmask ffffffe0 broadcast 10.10.10.63
35 ilbint0: flags=110001100843&lt;UP,BROADCAST,RUNNING,MULTICAST,ROUTER,IPv4,VRRP,PHYSRUNNING&gt; mtu 1500 index 3
36         inet 10.6.0.11 netmask ffffff00 broadcast 10.6.0.255
37 ilbext0: flags=110001100843&lt;UP,BROADCAST,RUNNING,MULTICAST,ROUTER,IPv4,VRRP,PHYSRUNNING&gt; mtu 1500 index 4
38         inet 10.10.11.11 netmask ffffffe0 broadcast 10.10.11.31
39 ilbext0:1: flags=110001100843&lt;UP,BROADCAST,RUNNING,MULTICAST,ROUTER,IPv4,VRRP,PHYSRUNNING&gt; mtu 1500 index 4
40         inet 10.10.11.12 netmask ffffffe0 broadcast 10.10.11.31
41 vpn0: flags=1000011008d1&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST,ROUTER,IPv4,PHYSRUNNING&gt; mtu 1480 index 5
42         inet tunnel src 10.10.11.12 tunnel dst 10.10.5.5
43         tunnel hop limit 64
44         inet 10.6.0.14 --&gt; 10.6.0.15 netmask ff000000
45 lo0: flags=2002000849&lt;UP,LOOPBACK,RUNNING,MULTICAST,IPv6,VIRTUAL&gt; mtu 8252 index 1
46         inet6 ::1/128
47 net0: flags=120002004941&lt;UP,RUNNING,PROMISC,MULTICAST,DHCP,IPv6,PHYSRUNNING&gt; mtu 1500 index 2
48         inet6 fe80::221:9bff:fefd:2a22/10
49 ilbint0: flags=120002000840&lt;RUNNING,MULTICAST,IPv6,PHYSRUNNING&gt; mtu 1500 index 3
50         inet6 ::/0
51 ilbext0: flags=120002000840&lt;RUNNING,MULTICAST,IPv6,PHYSRUNNING&gt; mtu 1500 index 4
52         inet6 ::/0
53 vpn0: flags=120002200850&lt;POINTOPOINT,RUNNING,MULTICAST,NONUD,IPv6,PHYSRUNNING&gt; mtu 1480 index 5
54         inet tunnel src 10.10.11.12 tunnel dst 10.10.5.5
55         tunnel hop limit 64
56         inet6 ::/0 --&gt; fe80::b2d6:7c10
57 """
58 NETBSD = """\
59 vioif0: flags=0x8943&lt;UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; mtu 1500
60         ec_capabilities=1&lt;VLAN_MTU&gt;
61         ec_enabled=0
62         address: 00:a0:98:e6:83:18
63         inet 192.168.1.80/24 broadcast 192.168.1.255 flags 0x0
64         inet6 fe80::2a0:98ff:fee6:8318%vioif0/64 flags 0x0 scopeid 0x1
65 lo0: flags=0x8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; mtu 33624
66         inet 127.0.0.1/8 flags 0x0
67         inet6 ::1/128 flags 0x20&lt;NODAD&gt;
68         inet6 fe80::1%lo0/64 flags 0x0 scopeid 0x2
69 FREEBSD_SOCKSTAT_WITH_FAT_PID = """\
70 USER     COMMAND    PID   FD PROTO  LOCAL ADDRESS    FOREIGN ADDRESS
71 salt-master python2.781106 35 tcp4  127.0.0.1:61115  127.0.0.1:4506
72 LINUX_NETLINK_SS_OUTPUT = """\
73 State       Recv-Q Send-Q                                                            Local Address:Port                                                                           Peer Address:Port
74 TIME-WAIT   0      0                                                                         [::1]:8009                                                                                  [::1]:40368
75 LISTEN      0      128                                                                   127.0.0.1:5903                                                                                0.0.0.0:*
76 ESTAB       0      0                                                            [::ffff:127.0.0.1]:4506                                                                    [::ffff:127.0.0.1]:32315
77 ESTAB       0      0                                                                 192.168.122.1:4506                                                                       192.168.122.177:24545
78     False: ("10.10.0.0"</b></font>, "10.10.0.0/33", "FOO", 9, "0.9.800.1000/24"),
79 }
80 IPV6_SUBNETS = {
81     True: ("::1/128",),
82     False: ("::1", "::1/129", "FOO", 9, "aj01::feac/64"),
83 }
84 class NetworkTestCase(TestCase):
85     def test_sanitize_host_ip(self):
86         ret = network.sanitize_host("10.1./2.$3")
87         self.assertEqual(ret, "10.1.2.3")
88     def test_sanitize_host_name(self):
89         ret = network.sanitize_host("foo_bar")
90         self.assertEqual(ret, "foo_bar")
91     def test_host_to_ips(self):
92         def _side_effect(host, *args):
93             try:
94                 return {
95                     "github.com": [
96                         (2, 1, 6, "", ("192.30.255.112", 0)),
97                         (2, 1, 6, "", ("192.30.255.113", 0)),
98                     ],
99                     "ipv6host.foo": [
100                         (socket.AF_INET6, 1, 6, "", ("2001:a71::1", 0, 0, 0)),
101                     ],
102                 }[host]
103             except KeyError:
104                 raise socket.gaierror(-2, "Name or service not known")
105         getaddrinfo_mock = MagicMock(side_effect=_side_effect)
106         with patch.object(socket, "getaddrinfo", getaddrinfo_mock):
107             ret = network.host_to_ips("github.com")
108             self.assertEqual(ret, ["192.30.255.112", "192.30.255.113"])
109             ret = network.host_to_ips("ipv6host.foo")
110             self.assertEqual(ret, ["2001:a71::1"])
111             ret = network.host_to_ips("someothersite.com")
112             self.assertEqual(ret, None)
113     def test_generate_minion_id(self):
114         self.assertTrue(network.generate_minion_id())
115     def test__generate_minion_id_with_unicode_in_etc_hosts(self):
116         content = textwrap.dedent(
117         )
118         fopen_mock = mock_open(read_data={"/etc/hosts": content})
119         with patch("salt.utils.files.fopen", fopen_mock):
120 <a name="2"></a>            assert "thisismyhostname" in network._generate_minion_id()
121     def test_is_ip(self):
122         self<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertTrue(network.is_ip("10.10.0.3"))
123         self.assertFalse(network.is_ip("0.9.800.1000"))
124 <a name="0"></a>        self.assertFalse(network.is_ipv6(</b></font>"sixteen-char-str"))
125     def test_is_ipv4(self):
126         self<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertTrue(network.is_ipv4("10.10.0.3"))
127         self.assertFalse(network.is_ipv4("10.100.1"))
128         self.assertFalse(network.is_ipv4("2001:db8:0:1:1:1:1:1"))
129         self.</b></font>assertFalse(network.is_ipv4("sixteen-char-str"))
130     def test_is_ipv6(self):
131         self.assertTrue(network.is_ipv6("2001:db8:0:1:1:1:1:1"))
132         self.assertTrue(network.is_ipv6("0:0:0:0:0:0:0:1"))
133         self.assertTrue(network.is_ipv6("::1"))
134         self.assertTrue(network.is_ipv6("::"))
135         self.assertTrue(network.is_ipv6("2001:0db8:85a3:0000:0000:8a2e:0370:7334"))
136         self.assertTrue(network.is_ipv6("2001:0db8:85a3::8a2e:0370:7334"))
137         self.assertFalse(network.is_ipv6("2001:0db8:0370:7334"))
138         self.assertFalse(network.is_ipv6("2001:0db8:::0370:7334"))
139         self.assertFalse(network.is_ipv6("10.0.1.2"))
140         self.assertFalse(network.is_ipv6("2001.0db8.85a3.0000.0000.8a2e.0370.7334"))
141         self.assertFalse(network.is_ipv6("sixteen-char-str"))
142     def test_ipv6(self):
143         self.assertTrue(network.ipv6("2001:db8:0:1:1:1:1:1"))
144         self.assertTrue(network.ipv6("0:0:0:0:0:0:0:1"))
145         self.assertTrue(network.ipv6("::1"))
146         self.assertTrue(network.ipv6("::"))
147         self.assertTrue(network.ipv6("2001:0db8:85a3:0000:0000:8a2e:0370:7334"))
148         self.assertTrue(network.ipv6("2001:0db8:85a3::8a2e:0370:7334"))
149         self.assertTrue(network.ipv6("2001:67c:2e8::/48"))
150     def test_parse_host_port(self):
151         _ip = ipaddress.ip_address
152         good_host_ports = {
153             "10.10.0.3": (_ip("10.10.0.3").compressed, None),
154             "10.10.0.3:1234": (_ip("10.10.0.3").compressed, 1234),
155             "2001:0db8:85a3::8a2e:0370:7334": (
156                 _ip("2001:0db8:85a3::8a2e:0370:7334").compressed,
157                 None,
158             ),
159             "[2001:0db8:85a3::8a2e:0370:7334]:1234": (
160                 _ip("2001:0db8:85a3::8a2e:0370:7334").compressed,
161                 1234,
162             ),
163             "2001:0db8:85a3::7334": (_ip("2001:0db8:85a3::7334").compressed, None),
164             "[2001:0db8:85a3::7334]:1234": (
165                 _ip("2001:0db8:85a3::7334").compressed,
166                 1234,
167             ),
168         }
169         bad_host_ports = [
170             "10.10.0.3/24",
171             "10.10.0.3::1234",
172             "2001:0db8:0370:7334",
173             "2001:0db8:0370::7334]:1234",
174             "2001:0db8:0370:0:a:b:c:d:1234",
175             "host name",
176             "host name:1234",
177             "10.10.0.3:abcd",
178         ]
179         for host_port, assertion_value in good_host_ports.items():
180             host = port = None
181             host, port = network.parse_host_port(host_port)
182             self.assertEqual((host, port), assertion_value)
183         for host_port in bad_host_ports:
184             try:
185                 self.assertRaises(ValueError, network.parse_host_port, host_port)
186             except AssertionError as _e_:
187                 log.error(
188                     'bad host_port value: "%s" failed to trigger ValueError exception',
189                     host_port,
190                 )
191                 raise _e_
192     def test_dns_check(self):
193         hosts = [
194             {
195                 "host": "10.10.0.3",
196                 "port": "",
197                 "mocked": [(2, 1, 6, "", ("10.10.0.3", 0))],
198                 "ret": "10.10.0.3",
199             },
200             {
201                 "host": "10.10.0.3",
202                 "port": "1234",
203                 "mocked": [(2, 1, 6, "", ("10.10.0.3", 0))],
204                 "ret": "10.10.0.3",
205             },
206             {
207                 "host": "2001:0db8:85a3::8a2e:0370:7334",
208                 "port": "",
209                 "mocked": [(10, 1, 6, "", ("2001:db8:85a3::8a2e:370:7334", 0, 0, 0))],
210                 "ret": "[2001:db8:85a3::8a2e:370:7334]",
211             },
212             {
213                 "host": "2001:0db8:85a3::8a2e:370:7334",
214                 "port": "1234",
215                 "mocked": [(10, 1, 6, "", ("2001:db8:85a3::8a2e:370:7334", 0, 0, 0))],
216                 "ret": "[2001:db8:85a3::8a2e:370:7334]",
217             },
218             {
219                 "host": "salt-master",
220                 "port": "1234",
221                 "mocked": [(2, 1, 6, "", ("127.0.0.1", 0))],
222                 "ret": "127.0.0.1",
223             },
224         ]
225         for host in hosts:
226             with patch.object(
227                 socket,
228                 "getaddrinfo",
229                 create_autospec(socket.getaddrinfo, return_value=host["mocked"]),
230             ):
231                 with patch("socket.socket", create_autospec(socket.socket)):
232                     ret = network.dns_check(host["host"], host["port"])
233                     self.assertEqual(ret, host["ret"])
234     def test_dns_check_ipv6_filter(self):
235         with patch.object(
236             socket,
237             "getaddrinfo",
238             create_autospec(socket.getaddrinfo, side_effect=Exception),
239         ) as getaddrinfo:
240             for ipv6, param in [
241                 (None, socket.AF_UNSPEC),
242                 (True, socket.AF_INET6),
243                 (False, socket.AF_INET),
244             ]:
245                 with self.assertRaises(Exception):
246                     network.dns_check("foo", "1", ipv6=ipv6)
247                 getaddrinfo.assert_called_with("foo", "1", param, socket.SOCK_STREAM)
248     def test_dns_check_errors(self):
249         with patch.object(
250             socket, "getaddrinfo", create_autospec(socket.getaddrinfo, return_value=[])
251         ):
252             with self.assertRaisesRegex(
253                 salt.exceptions.SaltSystemExit,
254                 "DNS lookup or connection check of 'foo' failed",
255             ):
256                 network.dns_check("foo", "1")
257         with patch.object(
258             socket,
259             "getaddrinfo",
260             create_autospec(socket.getaddrinfo, side_effect=TypeError),
261         ):
262             with self.assertRaisesRegex(
263                 salt.exceptions.SaltSystemExit, "Invalid or unresolveable address"
264             ):
265                 network.dns_check("foo", "1")
266     def test_test_addrs(self):
267         addrinfo = [
268             (30, 2, 17, "", ("2600:9000:21eb:a800:8:1031:abc0:93a1", 0, 0, 0)),
269             (30, 1, 6, "", ("2600:9000:21eb:a800:8:1031:abc0:93a1", 0, 0, 0)),
270             (30, 2, 17, "", ("2600:9000:21eb:b400:8:1031:abc0:93a1", 0, 0, 0)),
271             (30, 1, 6, "", ("2600:9000:21eb:b400:8:1031:abc0:93a1", 0, 0, 0)),
272             (2, 1, 6, "", ("13.35.99.52", 0)),
273             (2, 2, 17, "", ("13.35.99.85", 0)),
274             (2, 1, 6, "", ("13.35.99.85", 0)),
275             (2, 2, 17, "", ("13.35.99.122", 0)),
276         ]
277         with patch("socket.socket", create_autospec(socket.socket)) as s:
278             addrs = network._test_addrs(addrinfo, 80)
279             self.assertTrue(len(addrs) == 1)
280             self.assertTrue(addrs[0] == addrinfo[0][4][0])
281             s.side_effect = [socket.error, MagicMock()]
282             addrs = network._test_addrs(addrinfo, 80)
283             self.assertTrue(len(addrs) == 1)
284             self.assertTrue(addrs[0] == addrinfo[2][4][0])
285             s.side_effect = socket.error
286             addrs = network._test_addrs(addrinfo, 80)
287             time.sleep(2)
288             self.assertFalse(len(addrs) == 0)
289             s.side_effect = socket.error
290             addrs = network._test_addrs(addrinfo, 80)
291             self.assertTrue(len(addrs) == 5)
292     def test_is_subnet(self):
293         for subnet_data in (IPV4_SUBNETS, IPV6_SUBNETS):
294             for item in subnet_data[True]:
295                 log.debug("Testing that %s is a valid subnet", item)
296                 self.assertTrue(network.is_subnet(item))
297             for item in subnet_data[False]:
298                 log.debug("Testing that %s is not a valid subnet", item)
299                 self.assertFalse(network.is_subnet(item))
300     def test_is_ipv4_subnet(self):
301         for item in IPV4_SUBNETS[True]:
302             log.debug("Testing that %s is a valid subnet", item)
303             self.assertTrue(network.is_ipv4_subnet(item))
304         for item in IPV4_SUBNETS[False]:
305             log.debug("Testing that %s is not a valid subnet", item)
306             self.assertFalse(network.is_ipv4_subnet(item))
307     def test_is_ipv6_subnet(self):
308         for item in IPV6_SUBNETS[True]:
309             log.debug("Testing that %s is a valid subnet", item)
310             self.assertTrue(network.is_ipv6_subnet(item))
311         for item in IPV6_SUBNETS[False]:
312             log.debug("Testing that %s is not a valid subnet", item)
313             self.assertFalse(network.is_ipv6_subnet(item))
314     def test_cidr_to_ipv4_netmask(self):
315         self.assertEqual(network.cidr_to_ipv4_netmask(24), "255.255.255.0")
316         self.assertEqual(network.cidr_to_ipv4_netmask(21), "255.255.248.0")
317         self.assertEqual(network.cidr_to_ipv4_netmask(17), "255.255.128.0")
318         self.assertEqual(network.cidr_to_ipv4_netmask(9), "255.128.0.0")
319         self.assertEqual(network.cidr_to_ipv4_netmask(36), "")
320         self.assertEqual(network.cidr_to_ipv4_netmask("lol"), "")
321     def test_number_of_set_bits_to_ipv4_netmask(self):
322         set_bits_to_netmask = network._number_of_set_bits_to_ipv4_netmask(0xFFFFFF00)
323         self.assertEqual(set_bits_to_netmask, "255.255.255.0")
324         set_bits_to_netmask = network._number_of_set_bits_to_ipv4_netmask(0xFFFF6400)
325     def test_hex2ip(self):
326         self.assertEqual(network.hex2ip("0x4A7D2B63"), "74.125.43.99")
327         self.assertEqual(network.hex2ip("0x4A7D2B63", invert=True), "99.43.125.74")
328         self.assertEqual(
329             network.hex2ip("00000000000000000000FFFF7F000001"), "127.0.0.1"
330         )
331         self.assertEqual(
332             network.hex2ip("0000000000000000FFFF00000100007F", invert=True), "127.0.0.1"
333         )
334         self.assertEqual(
335             network.hex2ip("20010DB8000000000000000000000000"), "2001:db8::"
336         )
337         self.assertEqual(
338             network.hex2ip("B80D0120000000000000000000000000", invert=True),
339             "2001:db8::",
340         )
341     def test_interfaces_ifconfig_linux(self):
342         interfaces = network._interfaces_ifconfig(LINUX)
343         self.assertEqual(
344             interfaces,
345             {
346                 "eth0": {
347                     "hwaddr": "e0:3f:49:85:6a:af",
348                     "inet": [
349                         {
350                             "address": "10.10.10.56",
351                             "broadcast": "10.10.10.255",
352                             "netmask": "255.255.252.0",
353                         }
354                     ],
355                     "inet6": [
356                         {
357                             "address": "fe80::e23f:49ff:fe85:6aaf",
358                             "prefixlen": "64",
359                             "scope": "link",
360                         }
361                     ],
362                     "up": True,
363                 },
364                 "lo": {
365                     "inet": [{"address": "127.0.0.1", "netmask": "255.0.0.0"}],
366                     "inet6": [{"address": "::1", "prefixlen": "128", "scope": "host"}],
367                     "up": True,
368                 },
369             },
370         )
371     def test_interfaces_ifconfig_freebsd(self):
372         interfaces = network._interfaces_ifconfig(FREEBSD)
373         self.assertEqual(
374             interfaces,
375             {
376                 "": {"up": False},
377                 "em0": {
378                     "hwaddr": "00:30:48:ff:ff:ff",
379                     "inet": [
380                         {
381                             "address": "10.10.10.250",
382                             "broadcast": "10.10.10.255",
383                             "netmask": "255.255.255.224",
384                         },
385                         {
386                             "address": "10.10.10.56",
387                             "broadcast": "10.10.10.63",
388                             "netmask": "255.255.255.192",
389                         },
390                     ],
391                     "up": True,
392                 },
393                 "em1": {"hwaddr": "00:30:48:aa:aa:aa", "up": False},
394                 "lo0": {
395                     "inet": [{"address": "127.0.0.1", "netmask": "255.0.0.0"}],
396                     "inet6": [
397                         {"address": "fe80::1", "prefixlen": "64", "scope": "0x8"},
398                         {"address": "::1", "prefixlen": "128", "scope": None},
399                     ],
400                     "up": True,
401                 },
402                 "plip0": {"up": False},
403                 "tun0": {
404                     "inet": [{"address": "10.12.0.1", "netmask": "255.255.255.255"}],
405                     "up": True,
406                 },
407             },
408         )
409     def test_interfaces_ifconfig_solaris(self):
410         with patch("salt.utils.platform.is_sunos", lambda: True):
411             interfaces = network._interfaces_ifconfig(SOLARIS)
412             expected_interfaces = {
413                 "ilbint0": {
414                     "inet6": [],
415                     "inet": [
416                         {
417                             "broadcast": "10.6.0.255",
418                             "netmask": "255.255.255.0",
419                             "address": "10.6.0.11",
420                         }
421                     ],
422                     "up": True,
423                 },
424                 "lo0": {
425                     "inet6": [{"prefixlen": "128", "address": "::1"}],
426                     "inet": [{"netmask": "255.0.0.0", "address": "127.0.0.1"}],
427                     "up": True,
428                 },
429                 "ilbext0": {
430                     "inet6": [],
431                     "inet": [
432                         {
433                             "broadcast": "10.10.11.31",
434                             "netmask": "255.255.255.224",
435                             "address": "10.10.11.11",
436                         },
437                         {
438                             "broadcast": "10.10.11.31",
439                             "netmask": "255.255.255.224",
440                             "address": "10.10.11.12",
441                         },
442                     ],
443                     "up": True,
444                 },
445                 "vpn0": {
446                     "inet6": [],
447                     "inet": [{"netmask": "255.0.0.0", "address": "10.6.0.14"}],
448                     "up": True,
449                 },
450                 "net0": {
451                     "inet6": [
452                         {"prefixlen": "10", "address": "fe80::221:9bff:fefd:2a22"}
453                     ],
454                     "inet": [
455                         {
456                             "broadcast": "10.10.10.63",
457                             "netmask": "255.255.255.224",
458                             "address": "10.10.10.38",
459                         }
460                     ],
461                     "up": True,
462                 },
463             }
464             self.assertEqual(interfaces, expected_interfaces)
465     def test_interfaces_ifconfig_netbsd(self):
466         interfaces = network._netbsd_interfaces_ifconfig(NETBSD)
467         self.assertEqual(
468             interfaces,
469             {
470                 "lo0": {
471                     "inet": [{"address": "127.0.0.1", "netmask": "255.0.0.0"}],
472                     "inet6": [
473                         {"address": "fe80::1", "prefixlen": "64", "scope": "lo0"}
474                     ],
475                     "up": True,
476                 },
477                 "vioif0": {
478                     "hwaddr": "00:a0:98:e6:83:18",
479                     "inet": [
480                         {
481                             "address": "192.168.1.80",
482                             "broadcast": "192.168.1.255",
483                             "netmask": "255.255.255.0",
484                         }
485                     ],
486                     "inet6": [
487                         {
488                             "address": "fe80::2a0:98ff:fee6:8318",
489                             "prefixlen": "64",
490                             "scope": "vioif0",
491                         }
492                     ],
493                     "up": True,
494                 },
495             },
496         )
497     def test_freebsd_remotes_on(self):
498         with patch("salt.utils.platform.is_sunos", lambda: False):
499             with patch("salt.utils.platform.is_freebsd", lambda: True):
500                 with patch("subprocess.check_output", return_value=FREEBSD_SOCKSTAT):
501                     remotes = network._freebsd_remotes_on("4506", "remote")
502                     self.assertEqual(remotes, {"127.0.0.1"})
503     def test_freebsd_remotes_on_with_fat_pid(self):
504         with patch("salt.utils.platform.is_sunos", lambda: False):
505             with patch("salt.utils.platform.is_freebsd", lambda: True):
506                 with patch(
507                     "subprocess.check_output",
508                     return_value=FREEBSD_SOCKSTAT_WITH_FAT_PID,
509                 ):
510                     remotes = network._freebsd_remotes_on("4506", "remote")
511                     self.assertEqual(remotes, {"127.0.0.1"})
512     def test_netlink_tool_remote_on_a(self):
513         with patch("salt.utils.platform.is_sunos", lambda: False):
514             with patch("salt.utils.platform.is_linux", lambda: True):
515                 with patch(
516                     "subprocess.check_output", return_value=LINUX_NETLINK_SS_OUTPUT
517                 ):
518                     remotes = network._netlink_tool_remote_on("4506", "local")
519                     self.assertEqual(remotes, {"192.168.122.177", "::ffff:127.0.0.1"})
520     def test_netlink_tool_remote_on_b(self):
521         with patch("subprocess.check_output", return_value=NETLINK_SS):
522             remotes = network._netlink_tool_remote_on("4505", "remote_port")
523             self.assertEqual(remotes, {"127.0.0.1", "::ffff:1.2.3.4"})
524     def test_generate_minion_id_distinct(self):
525         with patch("platform.node", MagicMock(return_value="nodename")), patch(
526             "socket.gethostname", MagicMock(return_value="hostname")
527         ), patch(
528             "socket.getfqdn", MagicMock(return_value="hostname.domainname.blank")
529         ), patch(
530             "socket.getaddrinfo",
531             MagicMock(return_value=[(2, 3, 0, "attrname", ("127.0.1.1", 0))]),
532         ), patch(
533             "salt.utils.files.fopen", mock_open()
534         ), patch(
535             "salt.utils.network.ip_addrs",
536             MagicMock(return_value=["1.2.3.4", "5.6.7.8"]),
537         ):
538             self.assertEqual(
539                 network._generate_minion_id(),
540                 [
541                     "hostname.domainname.blank",
542                     "nodename",
543                     "hostname",
544                     "1.2.3.4",
545                     "5.6.7.8",
546                 ],
547             )
548     def test_generate_minion_id_127_name(self):
549         with patch("platform.node", MagicMock(return_value="127")), patch(
550             "socket.gethostname", MagicMock(return_value="127")
551         ), patch(
552             "socket.getfqdn", MagicMock(return_value="127.domainname.blank")
553         ), patch(
554             "socket.getaddrinfo",
555             MagicMock(return_value=[(2, 3, 0, "attrname", ("127.0.1.1", 0))]),
556         ), patch(
557             "salt.utils.files.fopen", mock_open()
558         ), patch(
559             "salt.utils.network.ip_addrs",
560             MagicMock(return_value=["1.2.3.4", "5.6.7.8"]),
561         ):
562             self.assertEqual(
563                 network._generate_minion_id(),
564                 ["127.domainname.blank", "127", "1.2.3.4", "5.6.7.8"],
565             )
566     def test_generate_minion_id_127_name_startswith(self):
567         with patch("platform.node", MagicMock(return_value="127890")), patch(
568             "socket.gethostname", MagicMock(return_value="127890")
569         ), patch(
570             "socket.getfqdn", MagicMock(return_value="127890.domainname.blank")
571         ), patch(
572             "socket.getaddrinfo",
573             MagicMock(return_value=[(2, 3, 0, "attrname", ("127.0.1.1", 0))]),
574         ), patch(
575             "salt.utils.files.fopen", mock_open()
576         ), patch(
577             "salt.utils.network.ip_addrs",
578             MagicMock(return_value=["1.2.3.4", "5.6.7.8"]),
579         ):
580             self.assertEqual(
581                 network._generate_minion_id(),
582                 ["127890.domainname.blank", "127890", "1.2.3.4", "5.6.7.8"],
583             )
584     def test_generate_minion_id_duplicate(self):
585         with patch("platform.node", MagicMock(return_value="hostname")), patch(
586             "socket.gethostname", MagicMock(return_value="hostname")
587         ), patch("socket.getfqdn", MagicMock(return_value="hostname")), patch(
588             "socket.getaddrinfo",
589             MagicMock(return_value=[(2, 3, 0, "hostname", ("127.0.1.1", 0))]),
590         ), patch(
591             "salt.utils.files.fopen", mock_open()
592         ), patch(
593             "salt.utils.network.ip_addrs",
594             MagicMock(return_value=["1.2.3.4", "1.2.3.4", "1.2.3.4"]),
595         ):
596             self.assertEqual(network._generate_minion_id(), ["hostname", "1.2.3.4"])
597     def test_generate_minion_id_platform_used(self):
598         with patch(
599             "platform.node", MagicMock(return_value="very.long.and.complex.domain.name")
600         ), patch("socket.gethostname", MagicMock(return_value="hostname")), patch(
601             "socket.getfqdn", MagicMock(return_value="")
602         ), patch(
603             "socket.getaddrinfo",
604             MagicMock(return_value=[(2, 3, 0, "hostname", ("127.0.1.1", 0))]),
605         ), patch(
606             "salt.utils.files.fopen", mock_open()
607         ), patch(
608             "salt.utils.network.ip_addrs",
609             MagicMock(return_value=["1.2.3.4", "1.2.3.4", "1.2.3.4"]),
610         ):
611             self.assertEqual(
612                 network.generate_minion_id(), "very.long.and.complex.domain.name"
613             )
614     def test_generate_minion_id_platform_localhost_filtered(self):
615         with patch("platform.node", MagicMock(return_value="localhost")), patch(
616             "socket.gethostname", MagicMock(return_value="pick.me")
617         ), patch(
618             "socket.getfqdn", MagicMock(return_value="hostname.domainname.blank")
619         ), patch(
620             "socket.getaddrinfo",
621             MagicMock(return_value=[(2, 3, 0, "hostname", ("127.0.1.1", 0))]),
622         ), patch(
623             "salt.utils.files.fopen", mock_open()
624         ), patch(
625             "salt.utils.network.ip_addrs",
626             MagicMock(return_value=["1.2.3.4", "1.2.3.4", "1.2.3.4"]),
627         ):
628             self.assertEqual(network.generate_minion_id(), "hostname.domainname.blank")
629     def test_generate_minion_id_platform_localhost_filtered_all(self):
630         with patch("platform.node", MagicMock(return_value="localhost")), patch(
631             "socket.gethostname", MagicMock(return_value="ip6-loopback")
632         ), patch("socket.getfqdn", MagicMock(return_value="ip6-localhost")), patch(
633             "socket.getaddrinfo",
634             MagicMock(return_value=[(2, 3, 0, "localhost", ("127.0.1.1", 0))]),
635         ), patch(
636             "salt.utils.files.fopen", mock_open()
637         ), patch(
638             "salt.utils.network.ip_addrs",
639             MagicMock(
640                 return_value=["127.0.0.1", "::1", "fe00::0", "fe02::1", "1.2.3.4"]
641             ),
642         ):
643             self.assertEqual(network.generate_minion_id(), "1.2.3.4")
644     def test_generate_minion_id_platform_localhost_only(self):
645         with patch("platform.node", MagicMock(return_value="localhost")), patch(
646             "socket.gethostname", MagicMock(return_value="ip6-loopback")
647         ), patch("socket.getfqdn", MagicMock(return_value="ip6-localhost")), patch(
648             "socket.getaddrinfo",
649             MagicMock(return_value=[(2, 3, 0, "localhost", ("127.0.1.1", 0))]),
650         ), patch(
651             "salt.utils.files.fopen", mock_open()
652         ), patch(
653             "salt.utils.network.ip_addrs",
654             MagicMock(return_value=["127.0.0.1", "::1", "fe00::0", "fe02::1"]),
655         ):
656             self.assertEqual(network.generate_minion_id(), "localhost")
657     def test_generate_minion_id_platform_fqdn(self):
658         with patch("platform.node", MagicMock(return_value="localhost")), patch(
659             "socket.gethostname", MagicMock(return_value="ip6-loopback")
660         ), patch("socket.getfqdn", MagicMock(return_value="pick.me")), patch(
661             "socket.getaddrinfo",
662             MagicMock(return_value=[(2, 3, 0, "localhost", ("127.0.1.1", 0))]),
663         ), patch(
664             "salt.utils.files.fopen", mock_open()
665         ), patch(
666             "salt.utils.network.ip_addrs",
667             MagicMock(return_value=["127.0.0.1", "::1", "fe00::0", "fe02::1"]),
668         ):
669             self.assertEqual(network.generate_minion_id(), "pick.me")
670     def test_generate_minion_id_platform_localhost_addrinfo(self):
671         with patch("platform.node", MagicMock(return_value="localhost")), patch(
672             "socket.gethostname", MagicMock(return_value="ip6-loopback")
673         ), patch("socket.getfqdn", MagicMock(return_value="ip6-localhost")), patch(
674             "socket.getaddrinfo",
675             MagicMock(return_value=[(2, 3, 0, "pick.me", ("127.0.1.1", 0))]),
676         ), patch(
677             "salt.utils.files.fopen", mock_open()
678         ), patch(
679             "salt.utils.network.ip_addrs",
680             MagicMock(return_value=["127.0.0.1", "::1", "fe00::0", "fe02::1"]),
681         ):
682             self.assertEqual(network.generate_minion_id(), "pick.me")
683     def test_generate_minion_id_platform_ip_addr_only(self):
684         with patch("platform.node", MagicMock(return_value="localhost")), patch(
685             "socket.gethostname", MagicMock(return_value="ip6-loopback")
686         ), patch("socket.getfqdn", MagicMock(return_value="ip6-localhost")), patch(
687             "socket.getaddrinfo",
688             MagicMock(return_value=[(2, 3, 0, "localhost", ("127.0.1.1", 0))]),
689         ), patch(
690             "salt.utils.files.fopen", mock_open()
691         ), patch(
692             "salt.utils.network.ip_addrs",
693             MagicMock(
694                 return_value=["127.0.0.1", "::1", "fe00::0", "fe02::1", "1.2.3.4"]
695             ),
696         ):
697             self.assertEqual(network.generate_minion_id(), "1.2.3.4")
698     def test_gen_mac(self):
699         with patch("random.randint", return_value=1) as random_mock:
700             self.assertEqual(random_mock.return_value, 1)
701             ret = network.gen_mac("00:16:3E")
702             expected_mac = "00:16:3E:01:01:01"
703             self.assertEqual(ret, expected_mac)
704     def test_mac_str_to_bytes(self):
705         self.assertRaises(ValueError, network.mac_str_to_bytes, "31337")
706         self.assertRaises(ValueError, network.mac_str_to_bytes, "0001020304056")
707         self.assertRaises(ValueError, network.mac_str_to_bytes, "00:01:02:03:04:056")
708         self.assertRaises(ValueError, network.mac_str_to_bytes, "a0:b0:c0:d0:e0:fg")
709         self.assertEqual(
710             b"\x10\x08\x06\x04\x02\x00", network.mac_str_to_bytes("100806040200")
711         )
712         self.assertEqual(
713             b"\xf8\xe7\xd6\xc5\xb4\xa3", network.mac_str_to_bytes("f8e7d6c5b4a3")
714         )
715     @pytest.mark.slow_test
716     def test_generate_minion_id_with_long_hostname(self):
717         long_name = "localhost-abcdefghijklmnopqrstuvwxyz-abcdefghijklmnopqrstuvwxyz"
718         with patch("socket.gethostname", MagicMock(return_value=long_name)):
719             minion_id = network.generate_minion_id()
720         assert minion_id != "", minion_id
721     def test_filter_by_networks_with_no_filter(self):
722         ips = ["10.0.123.200", "10.10.10.10"]
723         with pytest.raises(TypeError):
724             network.filter_by_networks(ips)  # pylint: disable=no-value-for-parameter
725     def test_filter_by_networks_empty_filter(self):
726         ips = ["10.0.123.200", "10.10.10.10"]
727         assert network.filter_by_networks(ips, []) == []
728     def test_filter_by_networks_ips_list(self):
729         ips = [
730             "10.0.123.200",
731             "10.10.10.10",
732             "193.124.233.5",
733             "fe80::d210:cf3f:64e7:5423",
734         ]
735         networks = ["10.0.0.0/8", "fe80::/64"]
736         assert network.filter_by_networks(ips, networks) == [
737             "10.0.123.200",
738             "10.10.10.10",
739             "fe80::d210:cf3f:64e7:5423",
740         ]
741     def test_filter_by_networks_interfaces_dict(self):
742         interfaces = {
743             "wlan0": ["192.168.1.100", "217.5.140.67", "2001:db8::ff00:42:8329"],
744             "eth0": [
745                 "2001:0DB8:0:CD30:123:4567:89AB:CDEF",
746                 "192.168.1.101",
747                 "10.0.123.201",
748             ],
749         }
750         assert network.filter_by_networks(
751             interfaces, ["192.168.1.0/24", "2001:db8::/48"]
752         ) == {
753             "wlan0": ["192.168.1.100", "2001:db8::ff00:42:8329"],
754             "eth0": ["2001:0DB8:0:CD30:123:4567:89AB:CDEF", "192.168.1.101"],
755         }
756     def test_filter_by_networks_catch_all(self):
757         ips = [
758             "10.0.123.200",
759             "10.10.10.10",
760             "193.124.233.5",
761             "fe80::d210:cf3f:64e7:5423",
762         ]
763         assert ips == network.filter_by_networks(ips, ["0.0.0.0/0", "::/0"])
764     def test_ip_networks(self):
765         interface_data = network._interfaces_ifconfig(LINUX)
766         ret = network.ip_networks(interface_data=interface_data)
767         assert ret == ["10.10.8.0/22"], ret
768         ret = network.ip_networks(interface="eth0", interface_data=interface_data)
769         assert ret == ["10.10.8.0/22"], ret
770         ret = network.ip_networks(interface="eth0,lo", interface_data=interface_data)
771         assert ret == ["10.10.8.0/22"], ret
772         ret = network.ip_networks(interface="eth1", interface_data=interface_data)
773         assert ret == [], ret
774         ret = network.ip_networks(include_loopback=True, interface_data=interface_data)
775         assert ret == ["10.10.8.0/22", "127.0.0.0/8"], ret
776         ret = network.ip_networks(
777             interface="eth0", include_loopback=True, interface_data=interface_data
778         )
779         assert ret == ["10.10.8.0/22"], ret
780         ret = network.ip_networks(
781             interface="eth0,lo", include_loopback=True, interface_data=interface_data
782         )
783         assert ret == ["10.10.8.0/22", "127.0.0.0/8"], ret
784         ret = network.ip_networks(
785             interface="eth1", include_loopback=True, interface_data=interface_data
786         )
787         assert ret == [], ret
788         ret = network.ip_networks(verbose=True, interface_data=interface_data)
789         assert ret == {
790             "10.10.8.0/22": {
791                 "prefixlen": 22,
792                 "netmask": "255.255.252.0",
793                 "num_addresses": 1024,
794                 "address": "10.10.8.0",
795             },
796         }, ret
797         ret = network.ip_networks(
798             interface="eth0", verbose=True, interface_data=interface_data
799         )
800         assert ret == {
801             "10.10.8.0/22": {
802                 "prefixlen": 22,
803                 "netmask": "255.255.252.0",
804                 "num_addresses": 1024,
805                 "address": "10.10.8.0",
806             },
807         }, ret
808         ret = network.ip_networks(
809             interface="eth0,lo", verbose=True, interface_data=interface_data
810         )
811         assert ret == {
812             "10.10.8.0/22": {
813                 "prefixlen": 22,
814                 "netmask": "255.255.252.0",
815                 "num_addresses": 1024,
816                 "address": "10.10.8.0",
817             },
818         }, ret
819         ret = network.ip_networks(
820             interface="eth1", verbose=True, interface_data=interface_data
821         )
822         assert ret == {}, ret
823         ret = network.ip_networks(
824             include_loopback=True, verbose=True, interface_data=interface_data
825         )
826         assert ret == {
827             "10.10.8.0/22": {
828                 "prefixlen": 22,
829                 "netmask": "255.255.252.0",
830                 "num_addresses": 1024,
831                 "address": "10.10.8.0",
832             },
833             "127.0.0.0/8": {
834                 "prefixlen": 8,
835                 "netmask": "255.0.0.0",
836                 "num_addresses": 16777216,
837                 "address": "127.0.0.0",
838             },
839         }, ret
840         ret = network.ip_networks(
841             interface="eth0",
842             include_loopback=True,
843             verbose=True,
844             interface_data=interface_data,
845         )
846         assert ret == {
847             "10.10.8.0/22": {
848                 "prefixlen": 22,
849                 "netmask": "255.255.252.0",
850                 "num_addresses": 1024,
851                 "address": "10.10.8.0",
852             },
853         }, ret
854         ret = network.ip_networks(
855             interface="eth0,lo",
856             include_loopback=True,
857             verbose=True,
858             interface_data=interface_data,
859         )
860         assert ret == {
861             "10.10.8.0/22": {
862                 "prefixlen": 22,
863                 "netmask": "255.255.252.0",
864                 "num_addresses": 1024,
865                 "address": "10.10.8.0",
866             },
867             "127.0.0.0/8": {
868                 "prefixlen": 8,
869                 "netmask": "255.0.0.0",
870                 "num_addresses": 16777216,
871                 "address": "127.0.0.0",
872             },
873         }, ret
874         ret = network.ip_networks(
875             interface="eth1",
876             include_loopback=True,
877             verbose=True,
878             interface_data=interface_data,
879         )
880         assert ret == {}, ret
881     def test_ip_networks6(self):
882         interface_data = network._interfaces_ifconfig(LINUX)
883         ret = network.ip_networks6(interface_data=interface_data)
884         assert ret == ["fe80::/64"], ret
885         ret = network.ip_networks6(interface="eth0", interface_data=interface_data)
886         assert ret == ["fe80::/64"], ret
887         ret = network.ip_networks6(interface="eth0,lo", interface_data=interface_data)
888         assert ret == ["fe80::/64"], ret
889         ret = network.ip_networks6(interface="eth1", interface_data=interface_data)
890         assert ret == [], ret
891         ret = network.ip_networks6(include_loopback=True, interface_data=interface_data)
892         assert ret == ["::1/128", "fe80::/64"], ret
893         ret = network.ip_networks6(
894             interface="eth0", include_loopback=True, interface_data=interface_data
895         )
896         assert ret == ["fe80::/64"], ret
897         ret = network.ip_networks6(
898             interface="eth0,lo", include_loopback=True, interface_data=interface_data
899         )
900         assert ret == ["::1/128", "fe80::/64"], ret
901         ret = network.ip_networks6(
902             interface="eth1", include_loopback=True, interface_data=interface_data
903         )
904         assert ret == [], ret
905         ret = network.ip_networks6(verbose=True, interface_data=interface_data)
906         assert ret == {
907             "fe80::/64": {
908                 "prefixlen": 64,
909                 "netmask": "ffff:ffff:ffff:ffff::",
910                 "num_addresses": 18446744073709551616,
911                 "address": "fe80::",
912             },
913         }, ret
914         ret = network.ip_networks6(
915             interface="eth0", verbose=True, interface_data=interface_data
916         )
917         assert ret == {
918             "fe80::/64": {
919                 "prefixlen": 64,
920                 "netmask": "ffff:ffff:ffff:ffff::",
921                 "num_addresses": 18446744073709551616,
922                 "address": "fe80::",
923             },
924         }, ret
925         ret = network.ip_networks6(
926             interface="eth0,lo", verbose=True, interface_data=interface_data
927         )
928         assert ret == {
929             "fe80::/64": {
930                 "prefixlen": 64,
931                 "netmask": "ffff:ffff:ffff:ffff::",
932                 "num_addresses": 18446744073709551616,
933                 "address": "fe80::",
934             },
935         }, ret
936         ret = network.ip_networks6(
937             interface="eth1", verbose=True, interface_data=interface_data
938         )
939         assert ret == {}, ret
940         ret = network.ip_networks6(
941             include_loopback=True, verbose=True, interface_data=interface_data
942         )
943         assert ret == {
944             "fe80::/64": {
945                 "prefixlen": 64,
946                 "netmask": "ffff:ffff:ffff:ffff::",
947                 "num_addresses": 18446744073709551616,
948                 "address": "fe80::",
949             },
950             "::1/128": {
951                 "prefixlen": 128,
952                 "netmask": "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff",
953                 "num_addresses": 1,
954                 "address": "::1",
955             },
956         }, ret
957         ret = network.ip_networks6(
958             interface="eth0",
959             include_loopback=True,
960             verbose=True,
961             interface_data=interface_data,
962         )
963         assert ret == {
964             "fe80::/64": {
965                 "prefixlen": 64,
966                 "netmask": "ffff:ffff:ffff:ffff::",
967                 "num_addresses": 18446744073709551616,
968                 "address": "fe80::",
969             },
970         }, ret
971         ret = network.ip_networks6(
972             interface="eth0,lo",
973             include_loopback=True,
974             verbose=True,
975             interface_data=interface_data,
976         )
977         assert ret == {
978             "fe80::/64": {
979                 "prefixlen": 64,
980                 "netmask": "ffff:ffff:ffff:ffff::",
981                 "num_addresses": 18446744073709551616,
982                 "address": "fe80::",
983             },
984             "::1/128": {
985                 "prefixlen": 128,
986                 "netmask": "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff",
987                 "num_addresses": 1,
988                 "address": "::1",
989             },
990         }, ret
991         ret = network.ip_networks6(
992             interface="eth1",
993             include_loopback=True,
994             verbose=True,
995             interface_data=interface_data,
996         )
997         assert ret == {}, ret
998     def test_get_fqhostname_return(self):
999         with patch("socket.gethostname", MagicMock(return_value="hostname")), patch(
1000             "socket.getfqdn",
1001             MagicMock(return_value="very.long.and.complex.domain.name"),
1002         ), patch(
1003             "socket.getaddrinfo",
1004             MagicMock(return_value=[(2, 3, 0, "hostname", ("127.0.1.1", 0))]),
1005         ):
1006             self.assertEqual(network.get_fqhostname(), "hostname")
1007     def test_get_fqhostname_return_empty_hostname(self):
1008         host = "hostname"
1009         with patch("socket.gethostname", MagicMock(return_value=host)), patch(
1010             "socket.getfqdn",
1011             MagicMock(return_value="very.long.and.complex.domain.name"),
1012         ), patch(
1013             "socket.getaddrinfo",
1014             MagicMock(
1015                 return_value=[
1016                     (2, 3, 0, host, ("127.0.1.1", 0)),
1017                     (2, 3, 0, "", ("127.0.1.1", 0)),
1018                 ]
1019             ),
1020         ):
1021             self.assertEqual(network.get_fqhostname(), host)
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
