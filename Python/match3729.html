<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_database.py & test_consul.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_database.py & test_consul.py
      </h3>
      <h1 align="center">
        25.8%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_database.py (26.515152%)<TH>test_consul.py (25.179855%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match3729-0.html#0',2,'match3729-1.html#0',3)" NAME="0">(61-70)<TD><A HREF="javascript:ZweiFrames('match3729-0.html#0',2,'match3729-1.html#0',3)" NAME="0">(137-147)</A><TD ALIGN=center><FONT COLOR="#ff0000">22</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match3729-0.html#1',2,'match3729-1.html#1',3)" NAME="1">(22-28)<TD><A HREF="javascript:ZweiFrames('match3729-0.html#1',2,'match3729-1.html#1',3)" NAME="1">(100-117)</A><TD ALIGN=center><FONT COLOR="#960000">13</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_database.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Jayesh Kariya &lt;jayeshk@saltstack.com&gt;
&quot;&quot;&quot;

import pytest
import salt.states.postgres_database as postgres_database
from tests.support.mock import MagicMock, patch


@pytest.fixture
def configure_loader_modules():
    return {postgres_database: {}}


def test_present():
    &quot;&quot;&quot;
    Test to ensure that the named database is present
    with the specified properties.
<A NAME="1"></A>    &quot;&quot;&quot;
    name = &quot;frank&quot;

    ret = {<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match3729-1.html#1',3,'match3729-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>&quot;name&quot;: name, &quot;changes&quot;: {}, &quot;result&quot;: False, &quot;comment&quot;: &quot;&quot;}

    mock_t = MagicMock(return_value=True)
    mock = MagicMock(return_value={name: {}})
    with patch.dict(
        postgres_database.__salt__,
        {&quot;postgres.db_list&quot;</B></FONT>: mock, &quot;postgres.db_alter&quot;: mock_t},
    ):
        comt = &quot;Database {} is already present&quot;.format(name)
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: True})
        assert postgres_database.present(name) == ret

        comt = &quot;Database frank has wrong parameters which couldn't be changed on fly.&quot;
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False})
        assert postgres_database.present(name, tablespace=&quot;A&quot;, lc_collate=True) == ret

        with patch.dict(postgres_database.__opts__, {&quot;test&quot;: True}):
            comt = &quot;Database frank exists, but parameters need to be changed&quot;
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
            assert postgres_database.present(name, tablespace=&quot;A&quot;) == ret

        with patch.dict(postgres_database.__opts__, {&quot;test&quot;: False}):
            comt = &quot;Parameters for database frank have been changed&quot;
            ret.update(
                {
                    &quot;comment&quot;: comt,
                    &quot;result&quot;: True,
                    &quot;changes&quot;: {name: &quot;Parameters changed&quot;},
                }
            )
            assert postgres_database.present(name, tablespace=&quot;A&quot;) == ret


def test_absent():
    &quot;&quot;&quot;
    Test to ensure that the named database is absent.
<A NAME="0"></A>    &quot;&quot;&quot;
    name = &quot;frank&quot;

    ret <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match3729-1.html#0',3,'match3729-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= {&quot;name&quot;: name, &quot;changes&quot;: {}, &quot;result&quot;: False, &quot;comment&quot;: &quot;&quot;}

    mock_t = MagicMock(return_value=True)
    mock = MagicMock(side_effect=[True, True, False])
    with patch.dict(
        postgres_database.__salt__,
        {&quot;postgres.db_exists&quot;: mock, &quot;postgres.db_remove&quot;: mock_t},
    ):
        with patch.dict(postgres_database.__opts__, {&quot;test&quot;: True}):
            comt = &quot;Database {} is set to be removed&quot;.format(</B></FONT>name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
            assert postgres_database.absent(name) == ret

        with patch.dict(postgres_database.__opts__, {&quot;test&quot;: False}):
            comt = &quot;Database {} has been removed&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: True, &quot;changes&quot;: {name: &quot;Absent&quot;}})
            assert postgres_database.absent(name) == ret

            comt = &quot;Database {} is not present, so it cannot be removed&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: True, &quot;changes&quot;: {}})
            assert postgres_database.absent(name) == ret
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_consul.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
Test case for the consul state module
&quot;&quot;&quot;


import logging

import pytest
import salt.states.consul as consul
from tests.support.mock import MagicMock, patch

log = logging.getLogger(__name__)


@pytest.fixture
def configure_loader_modules():
    return {
        consul: {
            &quot;__opts__&quot;: {
                &quot;consul&quot;: {&quot;url&quot;: &quot;http://127.0.0.1&quot;, &quot;token&quot;: &quot;test_token&quot;},
                &quot;test&quot;: False,
            },
            &quot;__grains__&quot;: {&quot;id&quot;: &quot;test-minion&quot;},
        }
    }


def test_acl_present():
    &quot;&quot;&quot;
    Test salt.states.consul.acl_present function
    &quot;&quot;&quot;
    acl_info = {
        &quot;data&quot;: [
            {
                &quot;ID&quot;: &quot;1d53dcd6-8f4f-431e-818a-9987996701a1&quot;,
                &quot;Name&quot;: &quot;89530557-8f18-4e29-a2d6-5b2fc8bca713&quot;,
                &quot;Type&quot;: &quot;client&quot;,
                &quot;Rules&quot;: &quot;&quot;,
                &quot;CreateIndex&quot;: 419,
                &quot;ModifyIndex&quot;: 420,
            }
        ],
        &quot;res&quot;: True,
    }

    acl_info_mock = MagicMock(return_value=acl_info)
    with patch.dict(consul.__salt__, {&quot;consul.acl_info&quot;: acl_info_mock}):
        with patch.object(consul, &quot;_acl_changes&quot;, MagicMock(return_value=False)):
            consul_return = consul.acl_present(
                &quot;my_acl&quot;,
                id=&quot;1d53dcd6-8f4f-431e-818a-9987996701a1&quot;,
                token=&quot;89530557-8f18-4e29-a2d6-5b2fc8bca713&quot;,
                type=&quot;client&quot;,
                consul_url=&quot;http://localhost:8500&quot;,
            )

            _expected = {
                &quot;changes&quot;: {},
                &quot;comment&quot;: 'ACL &quot;my_acl&quot; exists and is up to date',
                &quot;name&quot;: &quot;my_acl&quot;,
                &quot;result&quot;: True,
            }
            assert consul_return == _expected

        acl_update_mock = MagicMock(
            return_value={
                &quot;data&quot;: {&quot;ID&quot;: &quot;1D53DCD6-8F4F-431E-818A-9987996701A1&quot;},
                &quot;res&quot;: True,
            }
        )
        with patch.object(consul, &quot;_acl_changes&quot;, MagicMock(return_value=True)):
            with patch.dict(consul.__salt__, {&quot;consul.acl_update&quot;: acl_update_mock}):
                consul_return = consul.acl_present(
                    &quot;my_acl&quot;,
                    id=&quot;1d53dcd6-8f4f-431e-818a-9987996701a1&quot;,
                    token=&quot;89530557-8f18-4e29-a2d6-5b2fc8bca713&quot;,
                    type=&quot;client&quot;,
                    consul_url=&quot;http://localhost:8500&quot;,
                )

            _expected = {
                &quot;changes&quot;: {},
                &quot;comment&quot;: &quot;The acl has been updated&quot;,
                &quot;name&quot;: &quot;my_acl&quot;,
                &quot;result&quot;: True,
            }
            assert consul_return == _expected


def test_acl_absent():
    &quot;&quot;&quot;
    Test salt.states.consul.acl_absent function
    &quot;&quot;&quot;
    #
    # Test when the ACL does exist
    #
<A NAME="1"></A>    acl_info = {
        &quot;data&quot;: [
            {
                <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match3729-0.html#1',2,'match3729-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>&quot;ID&quot;: &quot;1d53dcd6-8f4f-431e-818a-9987996701a1&quot;,
                &quot;Name&quot;: &quot;89530557-8f18-4e29-a2d6-5b2fc8bca713&quot;,
                &quot;Type&quot;: &quot;client&quot;,
                &quot;Rules&quot;: &quot;&quot;,
                &quot;CreateIndex&quot;: 419,
                &quot;ModifyIndex&quot;: 420,
            }
        ],
        &quot;res&quot;: True,
    }
    acl_info_mock = MagicMock(return_value=acl_info)
    acl_delete_mock = MagicMock(
        return_value={
            &quot;res&quot;: True,
            &quot;message&quot;: &quot;ACL 38AC8470-4A83-4140-8DFD-F924CD32917F deleted.&quot;,
        }
    )
    with patch.dict(consul.__salt__, {&quot;consul.acl_info&quot;</B></FONT>: acl_info_mock}):
        with patch.dict(consul.__salt__, {&quot;consul.acl_delete&quot;: acl_delete_mock}):
            consul_return = consul.acl_absent(
                &quot;my_acl&quot;,
                id=&quot;1d53dcd6-8f4f-431e-818a-9987996701a1&quot;,
                token=&quot;89530557-8f18-4e29-a2d6-5b2fc8bca713&quot;,
                consul_url=&quot;http://localhost:8500&quot;,
            )

            _expected = {
                &quot;changes&quot;: {},
                &quot;comment&quot;: &quot;The acl has been deleted&quot;,
                &quot;name&quot;: &quot;1d53dcd6-8f4f-431e-818a-9987996701a1&quot;,
                &quot;result&quot;: True,
            }
            assert consul_return == _expected

<A NAME="0"></A>    #
    # Test when the ACL does not exist
    #
    acl_info <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match3729-0.html#0',2,'match3729-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= {&quot;data&quot;: [], &quot;res&quot;: True}
    acl_info_mock = MagicMock(return_value=acl_info)
    acl_delete_mock = MagicMock(
        return_value={
            &quot;res&quot;: True,
            &quot;message&quot;: &quot;ACL 38AC8470-4A83-4140-8DFD-F924CD32917F deleted.&quot;,
        }
    )
    with patch.dict(consul.__salt__, {&quot;consul.acl_info&quot;: acl_info_mock}):
        with patch.dict(consul.__salt__, {&quot;consul.acl_delete&quot;: acl_delete_mock}):
            consul_return = consul.acl_absent(</B></FONT>
                &quot;my_acl&quot;,
                id=&quot;1d53dcd6-8f4f-431e-818a-9987996701a1&quot;,
                token=&quot;89530557-8f18-4e29-a2d6-5b2fc8bca713&quot;,
                consul_url=&quot;http://localhost:8500&quot;,
            )

            _expected = {
                &quot;changes&quot;: {},
                &quot;comment&quot;: 'ACL &quot;1d53dcd6-8f4f-431e-818a-9987996701a1&quot; does not exist',
                &quot;name&quot;: &quot;1d53dcd6-8f4f-431e-818a-9987996701a1&quot;,
                &quot;result&quot;: True,
            }
            assert consul_return == _expected
</PRE>
</div>
  </div>
</body>
</html>
