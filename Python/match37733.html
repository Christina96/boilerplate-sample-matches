<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html><head><title>Matches for grafana_datasource.py &amp; splunk.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for grafana_datasource.py &amp; splunk.py
      </h3>
<h1 align="center">
        6.9%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>grafana_datasource.py (6.467662%)<th>splunk.py (7.514451%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(122-128)<td><a href="#" name="0">(153-160)</a><td align="center"><font color="#ff0000">13</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>grafana_datasource.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
"""
Manage Grafana v2.0 data sources

.. versionadded:: 2016.3.0

.. code-block:: yaml

    grafana:
      grafana_timeout: 3
      grafana_token: qwertyuiop
      grafana_url: 'https://url.com'

.. code-block:: yaml

    Ensure influxdb data source is present:
      grafana_datasource.present:
        - name: influxdb
        - type: influxdb
        - url: http://localhost:8086
        - access: proxy
        - basic_auth: true
        - basic_auth_user: myuser
        - basic_auth_password: mypass
        - is_default: true
"""

import requests


def __virtual__():
    """Only load if grafana v2.0 is configured."""
    if __salt__["config.get"]("grafana_version", 1) == 2:
        return True
    return (False, "Not configured for grafana_version 2")


def present(
    name,
    type,
    url,
    access="proxy",
    user="",
    password="",
    database="",
    basic_auth=False,
    basic_auth_user="",
    basic_auth_password="",
    is_default=False,
    json_data=None,
    profile="grafana",
):
    """
    Ensure that a data source is present.

    name
        Name of the data source.

    type
        Which type of data source it is ('graphite', 'influxdb' etc.).

    url
        The URL to the data source API.

    user
        Optional - user to authenticate with the data source

    password
        Optional - password to authenticate with the data source

    basic_auth
        Optional - set to True to use HTTP basic auth to authenticate with the
        data source.

    basic_auth_user
        Optional - HTTP basic auth username.

    basic_auth_password
        Optional - HTTP basic auth password.

    is_default
        Default: False
    """
    if isinstance(profile, str):
        profile = __salt__["config.option"](profile)

    ret = {"name": name, "result": None, "comment": None, "changes": {}}
    datasource = _get_datasource(profile, name)
    data = _get_json_data(
        name,
        type,
        url,
        access,
        user,
        password,
        database,
        basic_auth,
        basic_auth_user,
        basic_auth_password,
        is_default,
        json_data,
    )

    if datasource:
        requests.put(
            _get_url(profile, datasource["id"]),
            data,
            headers=_get_headers(profile),
            timeout=profile.get("grafana_timeout", 3),
        )
        ret["result"] = True
        ret["changes"] = _diff(datasource, data)
        if ret["changes"]["new"] or ret["changes"]["old"]:
            ret["comment"] = "Data source {} updated".format(name)
        else:
            ret["changes"] = {}
            ret["comment"] = "Data source {} already up-to-date".format(name)
    else:
        requests.post(
<a name="0"></a>            "{}/api/datasources".format(profile["grafana_url"]),
            data,
            headers=_get_headers(profile),
            timeout=profile<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.get("grafana_timeout", 3),
        )
        ret["result"] = True
        ret["comment"] = "New data source {} added".format(name)
        ret["changes"] = data

    r</b></font>eturn ret


def absent(name, profile="grafana"):
    """
    Ensure that a data source is present.

    name
        Name of the data source to remove.
    """
    if isinstance(profile, str):
        profile = __salt__["config.option"](profile)

    ret = {"result": None, "comment": None, "changes": {}}
    datasource = _get_datasource(profile, name)

    if not datasource:
        ret["result"] = True
        ret["comment"] = "Data source {} already absent".format(name)
        return ret

    requests.delete(
        _get_url(profile, datasource["id"]),
        headers=_get_headers(profile),
        timeout=profile.get("grafana_timeout", 3),
    )

    ret["result"] = True
    ret["comment"] = "Data source {} was deleted".format(name)

    return ret


def _get_url(profile, datasource_id):
    return "{}/api/datasources/{}".format(profile["grafana_url"], datasource_id)


def _get_datasource(profile, name):
    response = requests.get(
        "{}/api/datasources".format(profile["grafana_url"]),
        headers=_get_headers(profile),
        timeout=profile.get("grafana_timeout", 3),
    )
    data = response.json()
    for datasource in data:
        if datasource["name"] == name:
            return datasource
    return None


def _get_headers(profile):
    return {
        "Accept": "application/json",
        "Authorization": "Bearer {}".format(profile["grafana_token"]),
    }


def _get_json_data(
    name,
    type,
    url,
    access="proxy",
    user="",
    password="",
    database="",
    basic_auth=False,
    basic_auth_user="",
    basic_auth_password="",
    is_default=False,
    json_data=None,
):
    return {
        "name": name,
        "type": type,
        "url": url,
        "access": access,
        "user": user,
        "password": password,
        "database": database,
        "basicAuth": basic_auth,
        "basicAuthUser": basic_auth_user,
        "basicAuthPassword": basic_auth_password,
        "isDefault": is_default,
        "jsonData": json_data,
    }


def _diff(old, new):
    old_keys = old.keys()
    old = old.copy()
    new = new.copy()
    for key in old_keys:
        if key == "id" or key == "orgId":
            del old[key]
        elif key not in new.keys():
            del old[key]
        elif old[key] == new[key]:
            del old[key]
            del new[key]
    return {"old": old, "new": new}
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>splunk.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
"""
Splunk User State Module

.. versionadded:: 2016.3.0

This state is used to ensure presence of users in splunk.

.. code-block:: yaml

    ensure example test user 1:
        splunk.present:
            - name: 'Example TestUser1'
            - email: example@domain.com
"""


def __virtual__():
    """
    Only load if the splunk module is available in __salt__
    """
    if "splunk.list_users" in __salt__:
        return "splunk"
    return (False, "splunk module could not be loaded")


def present(email, profile="splunk", **kwargs):
    """
    Ensure a user is present

    .. code-block:: yaml

        ensure example test user 1:
            splunk.user_present:
                - realname: 'Example TestUser1'
                - name: 'exampleuser'
                - email: 'example@domain.com'
                - roles: ['user']

    The following parameters are required:

    email
        This is the email of the user in splunk
    """

    name = kwargs.get("name")

    ret = {"name": name, "changes": {}, "result": None, "comment": ""}

    target = __salt__["splunk.get_user"](email, profile=profile, user_details=True)

    if not target:
        if __opts__["test"]:
            ret["comment"] = "User {} will be created".format(name)
            return ret

        # create the user
        result = __salt__["splunk.create_user"](email, profile=profile, **kwargs)
        if result:
            ret["changes"].setdefault("old", None)
            ret["changes"].setdefault("new", "User {} exists".format(name))
            ret["result"] = True
        else:
            ret["result"] = False
            ret["comment"] = "Failed to create {}".format(name)

        return ret
    else:
        ret["comment"] = "User {} set to be updated.".format(name)
        if __opts__["test"]:
            ret["result"] = None
            return ret

        # found a user... updating
        result = __salt__["splunk.update_user"](email, profile, **kwargs)

        if isinstance(result, bool) and result:
            # no update
            ret["result"] = None
            ret["comment"] = "No changes"
        else:
            diff = {}
            for field in [
                "name",
                "realname",
                "roles",
                "defaultApp",
                "tz",
                "capabilities",
            ]:
                if field == "roles":
                    diff["roles"] = list(
                        set(target.get(field, [])).symmetric_difference(
                            set(result.get(field, []))
                        )
                    )
                elif target.get(field) != result.get(field):
                    diff[field] = result.get(field)

            newvalues = result
            ret["result"] = True
            ret["changes"]["diff"] = diff
            ret["changes"]["old"] = target
            ret["changes"]["new"] = newvalues

    return ret


def absent(email, profile="splunk", **kwargs):
    """
    Ensure a splunk user is absent

    .. code-block:: yaml

        ensure example test user 1:
            splunk.absent:
                - email: 'example@domain.com'
                - name: 'exampleuser'

    The following parameters are required:

    email
        This is the email of the user in splunk
    name
        This is the splunk username used to identify the user.

    """
    user_identity = kwargs.get("name")

    ret = {
        "name": user_identity,
        "changes": {},
        "result": None,
        "comment": "User {} is absent.".format(user_identity),
    }

    target = __salt__["splunk.get_user"](email, profile=profile)

    if not target:
        ret["comment"] = "User {} does not exist".format(user_identity)
        ret["result"] = True
        return ret

    if __opts__["test"]:
        ret["comment"] = "User {} is all set to be deleted".format(user_identity)
        ret["result"] = None
        return ret

    result = __salt__["splunk.delete_user"](email, profile=profile)

<a name="0"></a>    if result:
        ret["comment"] = "Deleted user {}".format(user_identity)
        ret["changes"].setdefault("old", "User {} exists".format(user_identity))
        ret["changes"].setdefault("new", "User {} deleted"<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.format(user_identity))
        ret["result"] = True

    else:
        ret["comment"] = "Failed to delete {}".format(user_identity)
        ret["result"] = False

    r</b></font>eturn ret
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
