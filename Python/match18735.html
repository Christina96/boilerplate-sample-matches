<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for napalm_network.py &amp; netacl.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for napalm_network.py &amp; netacl.py
      </h3>
<h1 align="center">
        10.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>napalm_network.py (5.949198%)<th>netacl.py (50.857143%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(2346-2470)<td><a href="#" name="0">(448-659)</a><td align="center"><font color="#ff0000">18</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(2027-2040)<td><a href="#" name="1">(429-444)</a><td align="center"><font color="#e20000">16</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(1599-1614)<td><a href="#" name="2">(92-425)</a><td align="center"><font color="#e20000">16</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(1339-1548)<td><a href="#" name="3">(686-701)</a><td align="center"><font color="#d40000">15</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(2498-2585)<td><a href="#" name="4">(965-976)</a><td align="center"><font color="#aa0000">12</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(2474-2486)<td><a href="#" name="5">(665-675)</a><td align="center"><font color="#aa0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>napalm_network.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import datetime
2 import logging
3 import time
4 import salt.utils.files
5 import salt.utils.napalm
6 import salt.utils.templates
7 import salt.utils.versions
8 log = logging.getLogger(__name__)
9 try:
10     import jxmlease  # pylint: disable=unused-import
11     HAS_JXMLEASE = True
12 except ImportError:
13     HAS_JXMLEASE = False
14 __virtualname__ = "net"
15 __proxyenabled__ = ["*"]
16 __virtual_aliases__ = ("napalm_net",)
17 def __virtual__():
18     return salt.utils.napalm.virtual(__opts__, __virtualname__, __file__)
19 def _filter_list(input_list, search_key, search_value):
20     output_list = list()
21     for dictionary in input_list:
22         if dictionary.get(search_key) == search_value:
23             output_list.append(dictionary)
24     return output_list
25 def _filter_dict(input_dict, search_key, search_value):
26     output_dict = dict()
27     for key, key_list in input_dict.items():
28         key_list_filtered = _filter_list(key_list, search_key, search_value)
29         if key_list_filtered:
30             output_dict[key] = key_list_filtered
31     return output_dict
32 def _safe_commit_config(loaded_result, napalm_device):
33     _commit = commit(
34         inherit_napalm_device=napalm_device
35     )  # calls the function commit, defined below
36     if not _commit.get("result", False):
37         loaded_result["comment"] += (
38             _commit["comment"] if _commit.get("comment") else "Unable to commit."
39         )
40         loaded_result["result"] = False
41         discarded = _safe_dicard_config(loaded_result, napalm_device)
42         if not discarded["result"]:
43             return loaded_result
44     return _commit
45 def _safe_dicard_config(loaded_result, napalm_device):
46     log.debug("Discarding the config")
47     log.debug(loaded_result)
48     _discarded = discard_config(inherit_napalm_device=napalm_device)
49     if not _discarded.get("result", False):
50         loaded_result["comment"] += (
51             _discarded["comment"]
52             if _discarded.get("comment")
53             else "Unable to discard config."
54         )
55         loaded_result["result"] = False
56         _explicit_close(napalm_device)
57         __context__["retcode"] = 1
58         return loaded_result
59     return _discarded
60 def _explicit_close(napalm_device):
61     if salt.utils.napalm.not_always_alive(__opts__):
62         try:
63             napalm_device["DRIVER"].close()
64         except Exception as err:  # pylint: disable=broad-except
65             log.error("Unable to close the temp connection with the device:")
66             log.error(err)
67             log.error("Please report.")
68 def _config_logic(
69     napalm_device,
70     loaded_result,
71     test=False,
72     debug=False,
73     replace=False,
74     commit_config=True,
75     loaded_config=None,
76     commit_in=None,
77     commit_at=None,
78     revert_in=None,
79     revert_at=None,
80     commit_jid=None,
81     **kwargs
82 ):
83     current_jid = kwargs.get("__pub_jid")
84     if not current_jid:
85         current_jid = "{:%Y%m%d%H%M%S%f}".format(datetime.datetime.now())
86     loaded_result["already_configured"] = False
87     loaded_result["loaded_config"] = ""
88     if debug:
89         loaded_result["loaded_config"] = loaded_config
90     _compare = compare_config(inherit_napalm_device=napalm_device)
91     if _compare.get("result", False):
92         loaded_result["diff"] = _compare.get("out")
93         loaded_result.pop("out", "")  # not needed
94     else:
95         loaded_result["diff"] = None
96         loaded_result["result"] = False
97         loaded_result["comment"] = _compare.get("comment")
98         __context__["retcode"] = 1
99         return loaded_result
100     _loaded_res = loaded_result.get("result", False)
101     if not _loaded_res or test:
102         if loaded_result["comment"]:
103             loaded_result["comment"] += "\n"
104         if not len(loaded_result.get("diff", "")) &gt; 0:
105             loaded_result["already_configured"] = True
106         discarded = _safe_dicard_config(loaded_result, napalm_device)
107         if not discarded["result"]:
108             return loaded_result
109         loaded_result["comment"] += "Configuration discarded."
110         _explicit_close(napalm_device)
111         if not loaded_result["result"]:
112             __context__["retcode"] = 1
113         return loaded_result
114     if not test and commit_config:
115         if commit_jid:
116             log.info("Committing the JID: %s", str(commit_jid))
117             removed = cancel_commit(commit_jid)
118             log.debug("Cleaned up the commit from the schedule")
119             log.debug(removed["comment"])
120         if len(loaded_result.get("diff", "")) &gt; 0:
121             if commit_in or commit_at:
122                 commit_time = __utils__["timeutil.get_time_at"](
123                     time_in=commit_in, time_at=commit_in
124                 )
125                 scheduled_job_name = "__napalm_commit_{}".format(current_jid)
126                 temp_file = salt.utils.files.mkstemp()
127                 with salt.utils.files.fopen(temp_file, "w") as fp_:
128                     fp_.write(loaded_config)
129                 scheduled = __salt__["schedule.add"](
130                     scheduled_job_name,
131                     function="net.load_config",
132                     job_kwargs={
133                         "filename": temp_file,
134                         "commit_jid": current_jid,
135                         "replace": replace,
136                     },
137                     once=commit_time,
138                 )
139                 log.debug("Scheduling job")
140                 log.debug(scheduled)
141                 saved = __salt__["schedule.save"]()  # ensure the schedule is
142                 discarded = _safe_dicard_config(loaded_result, napalm_device)
143                 if not discarded["result"]:
144                     discarded["comment"] += (
145                         "Scheduled the job to be executed at {schedule_ts}, "
146                         "but was unable to discard the config: \n".format(
147                             schedule_ts=commit_time
148                         )
149                     )
150                     return discarded
151                 loaded_result["comment"] = (
152                     "Changes discarded for now, and scheduled commit at:"
153                     " {schedule_ts}.\nThe commit ID is: {current_jid}.\nTo discard this"
154                     " commit, you can execute: \n\nsalt {min_id} net.cancel_commit"
155                     " {current_jid}".format(
156                         schedule_ts=commit_time,
157                         min_id=__opts__["id"],
158                         current_jid=current_jid,
159                     )
160                 )
161                 loaded_result["commit_id"] = current_jid
162                 return loaded_result
163             log.debug("About to commit:")
164             log.debug(loaded_result["diff"])
165             if revert_in or revert_at:
166                 revert_time = __utils__["timeutil.get_time_at"](
167                     time_in=revert_in, time_at=revert_at
168                 )
169                 if __grains__["os"] == "junos":
170                     if not HAS_JXMLEASE:
171                         loaded_result["comment"] = (
172                             "This feature requires the library jxmlease to be"
173                             " installed.\nTo install, please execute: ``pip install"
174                             " jxmlease``."
175                         )
176                         loaded_result["result"] = False
177                         return loaded_result
178                     timestamp_at = __utils__["timeutil.get_timestamp_at"](
179                         time_in=revert_in, time_at=revert_at
180                     )
181                     minutes = int((timestamp_at - time.time()) / 60)
182                     _comm = __salt__["napalm.junos_commit"](confirm=minutes)
183                     if not _comm["out"]:
184                         loaded_result[
185                             "comment"
186                         ] = "Unable to commit confirm: {}".format(_comm["message"])
187                         loaded_result["result"] = False
188                         discarded = _safe_dicard_config(loaded_result, napalm_device)
189                         if not discarded["result"]:
190                             return loaded_result
191                 else:
192                     temp_file = salt.utils.files.mkstemp()
193                     running_config = __salt__["net.config"](source="running")["out"][
194                         "running"
195                     ]
196                     with salt.utils.files.fopen(temp_file, "w") as fp_:
197                         fp_.write(running_config)
198                     committed = _safe_commit_config(loaded_result, napalm_device)
199                     if not committed["result"]:
200                         return loaded_result
201                     scheduled_job_name = "__napalm_commit_{}".format(current_jid)
202                     scheduled = __salt__["schedule.add"](
203                         scheduled_job_name,
204                         function="net.load_config",
205                         job_kwargs={
206                             "filename": temp_file,
207                             "commit_jid": current_jid,
208                             "replace": True,
209                         },
210                         once=revert_time,
211                     )
212                     log.debug("Scheduling commit confirmed")
213                     log.debug(scheduled)
214                     saved = __salt__["schedule.save"]()
215                 loaded_result["comment"] = (
216                     "The commit ID is: {current_jid}.\nThis commit will be reverted at:"
217                     " {schedule_ts}, unless confirmed.\nTo confirm the commit and avoid"
218                     " reverting, you can execute:\n\nsalt {min_id} net.confirm_commit"
219                     " {current_jid}".format(
220                         schedule_ts=revert_time,
221                         min_id=__opts__["id"],
222                         current_jid=current_jid,
223                     )
224                 )
225                 loaded_result["commit_id"] = current_jid
226                 return loaded_result
227             committed = _safe_commit_config(loaded_result, napalm_device)
228             if not committed["result"]:
229                 return loaded_result
230         else:
231             discarded = _safe_dicard_config(loaded_result, napalm_device)
232             if not discarded["result"]:
233                 return loaded_result
234             loaded_result["already_configured"] = True
235             loaded_result["comment"] = "Already configured."
236     _explicit_close(napalm_device)
237     if not loaded_result["result"]:
238         __context__["retcode"] = 1
239     return loaded_result
240 @salt.utils.napalm.proxy_napalm_wrap
241 def connected(**kwargs):  # pylint: disable=unused-argument
242     return {"out": napalm_device.get("UP", False)}  # pylint: disable=undefined-variable
243 @salt.utils.napalm.proxy_napalm_wrap
244 def facts(**kwargs):  # pylint: disable=unused-argument
245     return salt.utils.napalm.call(
246         napalm_device, "get_facts", **{}  # pylint: disable=undefined-variable
247     )
248 @salt.utils.napalm.proxy_napalm_wrap
249 def environment(**kwargs):  # pylint: disable=unused-argument
250     return salt.utils.napalm.call(
251         napalm_device, "get_environment", **{}  # pylint: disable=undefined-variable
252     )
253 @salt.utils.napalm.proxy_napalm_wrap
254 def cli(*commands, **kwargs):  # pylint: disable=unused-argument
255     raw_cli_outputs = salt.utils.napalm.call(
256         napalm_device,  # pylint: disable=undefined-variable
257         "cli",
258         **{"commands": list(commands)}
259     )
260     if not raw_cli_outputs["result"]:
261         return raw_cli_outputs
262     textfsm_parse = (
263         kwargs.get("textfsm_parse")
264         or __opts__.get("napalm_cli_textfsm_parse")
265         or __pillar__.get("napalm_cli_textfsm_parse", False)
266     )
267     if not textfsm_parse:
268         log.debug("No TextFSM parsing requested.")
269         return raw_cli_outputs
270     if "textfsm.extract" not in __salt__ or "textfsm.index" not in __salt__:
271         raw_cli_outputs["comment"] += "Unable to process: is TextFSM installed?"
272         log.error(raw_cli_outputs["comment"])
273         return raw_cli_outputs
274     textfsm_template = kwargs.get("textfsm_template")
275     log.debug("textfsm_template: %s", textfsm_template)
276     textfsm_path = (
277         kwargs.get("textfsm_path")
278         or __opts__.get("textfsm_path")
279         or __pillar__.get("textfsm_path")
280     )
281     log.debug("textfsm_path: %s", textfsm_path)
282     textfsm_template_dict = (
283         kwargs.get("textfsm_template_dict")
284         or __opts__.get("napalm_cli_textfsm_template_dict")
285         or __pillar__.get("napalm_cli_textfsm_template_dict", {})
286     )
287     log.debug("TextFSM command-template mapping: %s", textfsm_template_dict)
288     index_file = (
289         kwargs.get("index_file")
290         or __opts__.get("textfsm_index_file")
291         or __pillar__.get("textfsm_index_file")
292     )
293     log.debug("index_file: %s", index_file)
294     platform_grain_name = (
295         kwargs.get("platform_grain_name")
296         or __opts__.get("textfsm_platform_grain")
297         or __pillar__.get("textfsm_platform_grain", "os")
298     )
299     log.debug("platform_grain_name: %s", platform_grain_name)
300     platform_column_name = (
301         kwargs.get("platform_column_name")
302         or __opts__.get("textfsm_platform_column_name")
303         or __pillar__.get("textfsm_platform_column_name", "Platform")
304     )
305     log.debug("platform_column_name: %s", platform_column_name)
306     saltenv = kwargs.get("saltenv", "base")
307     include_empty = kwargs.get("include_empty", False)
308     include_pat = kwargs.get("include_pat")
309     exclude_pat = kwargs.get("exclude_pat")
310     processed_cli_outputs = {
311         "comment": raw_cli_outputs.get("comment", ""),
312         "result": raw_cli_outputs["result"],
313         "out": {},
314     }
315     log.debug("Starting to analyse the raw outputs")
316     for command in list(commands):
317         command_output = raw_cli_outputs["out"][command]
318         log.debug("Output from command: %s", command)
319         log.debug(command_output)
320         processed_command_output = None
321         if textfsm_path:
322             log.debug("Using the templates under %s", textfsm_path)
323             processed_cli_output = __salt__["textfsm.index"](
324                 command,
325                 platform_grain_name=platform_grain_name,
326                 platform_column_name=platform_column_name,
327                 output=command_output.strip(),
328                 textfsm_path=textfsm_path,
329                 saltenv=saltenv,
330                 include_empty=include_empty,
331                 include_pat=include_pat,
332                 exclude_pat=exclude_pat,
333             )
334             log.debug("Processed CLI output:")
335             log.debug(processed_cli_output)
336             if not processed_cli_output["result"]:
337                 log.debug("Apparently this did not work, returning the raw output")
338                 processed_command_output = command_output
339                 processed_cli_outputs[
340                     "comment"
341                 ] += "\nUnable to process the output from {}: {}.".format(
342                     command, processed_cli_output["comment"]
343                 )
344                 log.error(processed_cli_outputs["comment"])
345             elif processed_cli_output["out"]:
346                 log.debug("All good, %s has a nice output!", command)
347                 processed_command_output = processed_cli_output["out"]
348             else:
349                 comment = """\nProcessing "{}" didn't fail, but didn't return anything either. Dumping raw.""".format(
350                     command
351                 )
352                 processed_cli_outputs["comment"] += comment
353                 log.error(comment)
354                 processed_command_output = command_output
355         elif textfsm_template or command in textfsm_template_dict:
356             if command in textfsm_template_dict:
357                 textfsm_template = textfsm_template_dict[command]
358             log.debug("Using %s to process the command: %s", textfsm_template, command)
359             processed_cli_output = __salt__["textfsm.extract"](
360                 textfsm_template, raw_text=command_output, saltenv=saltenv
361             )
362             log.debug("Processed CLI output:")
363             log.debug(processed_cli_output)
364             if not processed_cli_output["result"]:
365                 log.debug("Apparently this did not work, returning the raw output")
366                 processed_command_output = command_output
367                 processed_cli_outputs[
368                     "comment"
369                 ] += "\nUnable to process the output from {}: {}".format(
370                     command, processed_cli_output["comment"]
371                 )
372                 log.error(processed_cli_outputs["comment"])
373             elif processed_cli_output["out"]:
374                 log.debug("All good, %s has a nice output!", command)
375                 processed_command_output = processed_cli_output["out"]
376             else:
377                 log.debug(
378                     "Processing %s did not fail, but did not return"
379                     " anything either. Dumping raw.",
380                     command,
381                 )
382                 processed_command_output = command_output
383         else:
384             log.error("No TextFSM template specified, or no TextFSM path defined")
385             processed_command_output = command_output
386             processed_cli_outputs[
387                 "comment"
388             ] += "\nUnable to process the output from {}.".format(command)
389         processed_cli_outputs["out"][command] = processed_command_output
390     processed_cli_outputs["comment"] = processed_cli_outputs["comment"].strip()
391     return processed_cli_outputs
392 @salt.utils.napalm.proxy_napalm_wrap
393 def traceroute(
394     destination, source=None, ttl=None, timeout=None, vrf=None, **kwargs
395 ):  # pylint: disable=unused-argument
396     return salt.utils.napalm.call(
397         napalm_device,  # pylint: disable=undefined-variable
398         "traceroute",
399         **{
400             "destination": destination,
401             "source": source,
402             "ttl": ttl,
403             "timeout": timeout,
404             "vrf": vrf,
405         }
406     )
407 @salt.utils.napalm.proxy_napalm_wrap
408 def ping(
409     destination,
410     source=None,
411     ttl=None,
412     timeout=None,
413     size=None,
414     count=None,
415     vrf=None,
416     **kwargs
417 ):  # pylint: disable=unused-argument
418     return salt.utils.napalm.call(
419         napalm_device,  # pylint: disable=undefined-variable
420         "ping",
421         **{
422             "destination": destination,
423             "source": source,
424             "ttl": ttl,
425             "timeout": timeout,
426             "size": size,
427             "count": count,
428             "vrf": vrf,
429         }
430     )
431 @salt.utils.napalm.proxy_napalm_wrap
432 def arp(
433     interface="", ipaddr="", macaddr="", **kwargs
434 ):  # pylint: disable=unused-argument
435     proxy_output = salt.utils.napalm.call(
436         napalm_device, "get_arp_table", **{}  # pylint: disable=undefined-variable
437     )
438     if not proxy_output.get("result"):
439         return proxy_output
440     arp_table = proxy_output.get("out")
441     if interface:
442         arp_table = _filter_list(arp_table, "interface", interface)
443     if ipaddr:
444         arp_table = _filter_list(arp_table, "ip", ipaddr)
445     if macaddr:
446         arp_table = _filter_list(arp_table, "mac", macaddr)
447     proxy_output.update({"out": arp_table})
448     return proxy_output
449 @salt.utils.napalm.proxy_napalm_wrap
450 def ipaddrs(**kwargs):  # pylint: disable=unused-argument
451     return salt.utils.napalm.call(
452         napalm_device, "get_interfaces_ip", **{}  # pylint: disable=undefined-variable
453     )
454 @salt.utils.napalm.proxy_napalm_wrap
455 def interfaces(**kwargs):  # pylint: disable=unused-argument
456     return salt.utils.napalm.call(
457         napalm_device, "get_interfaces", **{}  # pylint: disable=undefined-variable
458     )
459 @salt.utils.napalm.proxy_napalm_wrap
460 def lldp(interface="", **kwargs):  # pylint: disable=unused-argument
461     proxy_output = salt.utils.napalm.call(
462         napalm_device,  # pylint: disable=undefined-variable
463         "get_lldp_neighbors_detail",
464         **{}
465     )
466     if not proxy_output.get("result"):
467         return proxy_output
468     lldp_neighbors = proxy_output.get("out")
469     if interface:
470         lldp_neighbors = {interface: lldp_neighbors.get(interface)}
471     proxy_output.update({"out": lldp_neighbors})
472     return proxy_output
473 @salt.utils.napalm.proxy_napalm_wrap
474 def mac(address="", interface="", vlan=0, **kwargs):  # pylint: disable=unused-argument
475     proxy_output = salt.utils.napalm.call(
476         napalm_device,  # pylint: disable=undefined-variable
477         "get_mac_address_table",
478         **{}
479     )
480     if not proxy_output.get("result"):
481         return proxy_output
482     mac_address_table = proxy_output.get("out")
483     if vlan and isinstance(vlan, int):
484         mac_address_table = _filter_list(mac_address_table, "vlan", vlan)
485     if address:
486         mac_address_table = _filter_list(mac_address_table, "mac", address)
487     if interface:
488         mac_address_table = _filter_list(mac_address_table, "interface", interface)
489     proxy_output.update({"out": mac_address_table})
490     return proxy_output
491 @salt.utils.napalm.proxy_napalm_wrap
492 def config(source=None, **kwargs):  # pylint: disable=unused-argument
493     return salt.utils.napalm.call(
494         napalm_device,  # pylint: disable=undefined-variable
495         "get_config",
496         **{"retrieve": source}
497     )
498 @salt.utils.napalm.proxy_napalm_wrap
499 def optics(**kwargs):  # pylint: disable=unused-argument
500     return salt.utils.napalm.call(
501         napalm_device, "get_optics", **{}  # pylint: disable=undefined-variable
502     )
503 @salt.utils.napalm.proxy_napalm_wrap
504 <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>def load_config(
505     filename=None,
506     text=None,
507     test=False,
508     commit=True,
509     debug=False,
510     replace=False,
511     commit_in=None,
512     commit_at=None,
513     revert_in=None,
514     revert_at=None,
515     commit_jid=None,
516     inherit_napalm_device=None,
517     saltenv="base",
518     **kwargs
519 ):  # pylint: disable=unused-argument
520     fun =</b></font> "load_merge_candidate"
521     if replace:
522         fun = "load_replace_candidate"
523     if salt.utils.napalm.not_always_alive(__opts__):
524         napalm_device["CLOSE"] = False  # pylint: disable=undefined-variable
525     if filename:
526         text = __salt__["cp.get_file_str"](filename, saltenv=saltenv)
527         if text is False:
528             ret = {"result": False, "out": None}
529             ret[
530                 "comment"
531             ] = "Unable to read from {}. Please specify a valid file or text.".format(
532                 filename
533             )
534             log.error(ret["comment"])
535             return ret
536         if commit_jid:
537             salt.utils.files.safe_rm(filename)
538     _loaded = salt.utils.napalm.call(
539         napalm_device, fun, **{"config": text}  # pylint: disable=undefined-variable
540     )
541     return _config_logic(
542         napalm_device,  # pylint: disable=undefined-variable
543         _loaded,
544         test=test,
545         debug=debug,
546         replace=replace,
547         commit_config=commit,
548         loaded_config=text,
549         commit_at=commit_at,
550         commit_in=commit_in,
551         revert_in=revert_in,
552         revert_at=revert_at,
553         commit_jid=commit_jid,
554         **kwargs
555     )
556 @salt.utils.napalm.proxy_napalm_wrap
557 <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>def load_template(
558     template_name=None,
559     template_source=None,
560     context=None,
561     defaults=None,
562     template_engine="jinja",
563     saltenv="base",
564     template_hash=None,
565     template_hash_name=None,
566     skip_verify=False,
567     test=False,
568     commit=True,
569     debug=False,
570     replace=False,
571     commit_in=None,
572     commit_at=</b></font>None,
573     revert_in=None,
574     revert_at=None,
575     inherit_napalm_device=None,  # pylint: disable=unused-argument
576     **template_vars
577 ):
578     _rendered = ""
579     _loaded = {"result": True, "comment": "", "out": None}
580     loaded_config = None
581     if template_engine not in salt.utils.templates.TEMPLATE_REGISTRY:
582         _loaded.update(
583             {
584                 "result": False,
585                 "comment": (
586                     "Invalid templating engine! Choose between: {tpl_eng_opts}".format(
587                         tpl_eng_opts=", ".join(
588                             list(salt.utils.templates.TEMPLATE_REGISTRY.keys())
589                         )
590                     )
591                 ),
592             }
593         )
594         return _loaded  # exit
595     salt_render_prefixes = ("salt://", "http://", "https://", "ftp://")
596     salt_render = False
597     file_exists = False
598     if not isinstance(template_name, (tuple, list)):
599         for salt_render_prefix in salt_render_prefixes:
600             if not salt_render:
601                 salt_render = salt_render or template_name.startswith(
602                     salt_render_prefix
603                 )
604         file_exists = __salt__["file.file_exists"](template_name)
605     if context is None:
606         context = {}
607     context.update(template_vars)
608     if template_source:
609         _rendered = __salt__["file.apply_template_on_contents"](
610             contents=template_source,
611             template=template_engine,
612             context=context,
613             defaults=defaults,
614             saltenv=saltenv,
615         )
616         if not isinstance(_rendered, str):
617             if "result" in _rendered:
618                 _loaded["result"] = _rendered["result"]
619             else:
620                 _loaded["result"] = False
621             if "comment" in _rendered:
622                 _loaded["comment"] = _rendered["comment"]
623             else:
624                 _loaded["comment"] = "Error while rendering the template."
625             return _loaded
626     else:
627         if not isinstance(template_name, (list, tuple)):
628             template_name = [template_name]
629         if template_hash_name and not isinstance(template_hash_name, (list, tuple)):
630             template_hash_name = [template_hash_name]
631         elif not template_hash_name:
632             template_hash_name = [None] * len(template_name)
633         if (
634             template_hash
635             and isinstance(template_hash, str)
636             and not (
637                 template_hash.startswith("salt://")
638                 or template_hash.startswith("file://")
639             )
640         ):
641             template_hash = [template_hash]
642         elif (
643             template_hash
644             and isinstance(template_hash, str)
645             and (
646                 template_hash.startswith("salt://")
647                 or template_hash.startswith("file://")
648             )
649         ):
650             template_hash = [template_hash] * len(template_name)
651         elif not template_hash:
652             template_hash = [None] * len(template_name)
653         for tpl_index, tpl_name in enumerate(template_name):
654             tpl_hash = template_hash[tpl_index]
655             _rand_filename = __salt__["random.hash"](tpl_name, "md5")
656             _temp_file = __salt__["file.join"]("/tmp", _rand_filename)
657             _managed <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= __salt__["file.get_managed"](
658                 name=_temp_file,
659                 source=tpl_name,
660                 source_hash=tpl_hash,
661                 source_hash_name=tpl_hash_name,
662                 user=None,
663                 group=None,
664                 mode=None,
665                 attrs=None,
666                 template=template_engine,
667                 context=context,
668                 defaults=defaults,
669                 saltenv=saltenv,
670                 skip_verify=</b></font>skip_verify,
671             )
672             if not isinstance(_managed, (list, tuple)) and isinstance(_managed, str):
673                 _loaded["comment"] += _managed
674                 _loaded["result"] = False
675             elif isinstance(_managed, (list, tuple)) and not len(_managed) &gt; 0:
676                 _loaded["result"] = False
677                 _loaded["comment"] += "Error while rendering the template."
678             elif isinstance(_managed, (list, tuple)) and not len(_managed[0]) &gt; 0:
679                 _loaded["result"] = False
680                 _loaded["comment"] += _managed[-1]  # contains the error message
681             if _loaded["result"]:  # all good
682                 _temp_tpl_file = _managed[0]
683                 _temp_tpl_file_exists = __salt__["file.file_exists"](_temp_tpl_file)
684                 if not _temp_tpl_file_exists:
685                     _loaded["result"] = False
686                     _loaded["comment"] += "Error while rendering the template."
687                     return _loaded
688                 _rendered += __salt__["file.read"](_temp_tpl_file)
689                 __salt__["file.remove"](_temp_tpl_file)
690             else:
691                 return _loaded  # exit
692     loaded_config = _rendered
693     if _loaded["result"]:  # all good
694         fun = "load_merge_candidate"
695         if replace:  # replace requested
696             fun = "load_replace_candidate"
697         if salt.utils.napalm.not_always_alive(__opts__):
698             napalm_device["CLOSE"] = False  # pylint: disable=undefined-variable
699         _loaded = salt.utils.napalm.call(
700             napalm_device,  # pylint: disable=undefined-variable
701             fun,
702             **{"config": _rendered}
703         )
704     return _config_logic(
705         napalm_device,  # pylint: disable=undefined-variable
706         _loaded,
707         test=test,
708         debug=debug,
709         replace=replace,
710         commit_config=commit,
711         loaded_config=loaded_config,
712         commit_at=commit_at,
713         commit_in=commit_in,
714         revert_in=revert_in,
715         revert_at=revert_at,
716         **template_vars
717     )
718 @salt.utils.napalm.proxy_napalm_wrap
719 def commit(inherit_napalm_device=None, **kwargs):  # pylint: disable=unused-argument
720     return salt.utils.napalm.call(
721         napalm_device, "commit_config", **{}  # pylint: disable=undefined-variable
722     )
723 @salt.utils.napalm.proxy_napalm_wrap
724 def discard_config(
725     inherit_napalm_device=None, **kwargs
726 ):  # pylint: disable=unused-argument
727     return salt.utils.napalm.call(
728         napalm_device, "discard_config", **{}  # pylint: disable=undefined-variable
729     )
730 @salt.utils.napalm.proxy_napalm_wrap
731 def compare_config(
732     inherit_napalm_device=None, **kwargs
733 ):  # pylint: disable=unused-argument
734     return salt.utils.napalm.call(
735         napalm_device, "compare_config", **{}  # pylint: disable=undefined-variable
736     )
737 @salt.utils.napalm.proxy_napalm_wrap
738 def rollback(inherit_napalm_device=None, **kwargs):  # pylint: disable=unused-argument
739     return salt.utils.napalm.call(
740         napalm_device, "rollback", **{}  # pylint: disable=undefined-variable
741     )
742 @salt.utils.napalm.proxy_napalm_wrap
743 def config_changed(
744     inherit_napalm_device=None, **kwargs
745 ):  # pylint: disable=unused-argument
746     is_config_changed = False
747     reason = ""
748     try_compare = compare_config(inherit_napalm_device=napalm_device)
749     if try_compare.get("result"):
750         if try_compare.get("out"):
751             is_config_changed = True
752         else:
753             reason = "Configuration was not changed on the device."
754     else:
755         reason = try_compare.get("comment")
756     return is_config_changed, reason
757 @salt.utils.napalm.proxy_napalm_wrap
758 def config_control(
759     inherit_napalm_device=None, **kwargs
760 ):  # pylint: disable=unused-argument
761     result = True
762     comment = ""
763     changed, not_changed_rsn = config_changed(inherit_napalm_device=napalm_device)
764     if not changed:
765         return (changed, not_changed_rsn)
766     try_commit = commit()
767     if not try_commit.get("result"):
768         result = False
769         comment = (
770             "Unable to commit the changes: {reason}.\nWill try to rollback now!".format(
771                 reason=try_commit.get("comment")
772             )
773         )
774         try_rollback = rollback()
775         if not try_rollback.get("result"):
776             comment += "\nCannot rollback! {reason}".format(
777                 reason=try_rollback.get("comment")
778             )
779     return result, comment
780 def cancel_commit(jid):
781     job_name = "__napalm_commit_{}".format(jid)
782     removed = __salt__["schedule.delete"](job_name)
783     if removed["result"]:
784         saved = __salt__["schedule.save"]()
785         removed["comment"] = "Commit #{jid} cancelled.".format(jid=jid)
786     else:
787         removed["comment"] = "Unable to find commit #{jid}.".format(jid=jid)
788     return removed
789 def confirm_commit(jid):
790     if __grains__["os"] == "junos":
791         confirmed = __salt__["napalm.junos_commit"]()
792         confirmed["result"] = confirmed.pop("out")
793         confirmed["comment"] = confirmed.pop("message")
794     else:
795         confirmed = cancel_commit(jid)
796     if confirmed["result"]:
797         confirmed["comment"] = "Commit #{jid} confirmed.".format(jid=jid)
798     return confirmed
799 def save_config(source=None, path=None):
800     if not source:
801         source = "running"
802     if not path:
803         path = salt.utils.files.mkstemp()
804     running_config = __salt__["net.config"](source=source)
805     if not running_config or not running_config["result"]:
806         log.error("Unable to retrieve the config")
807         return running_config
808     with salt.utils.files.fopen(path, "w") as fh_:
809         fh_.write(running_config["out"][source])
810         "result": True,
811         "out": path,
812         "comment": "{source} config saved to {path}".format(source=source, path=<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>path),
813     }
814 def replace_pattern(
815     pattern,
816     repl,
817     count=0,
818     flags=8,
819     bufsize=1,
820     append_if_not_found=False,
821     prepend_if_not_found=False,
822     not_found_content=None,
823     search_only=False,
824     show_changes=True,
825     backslash_literal=False,
826     source=None,
827     path=None,
828     test=False,
829     replace=True,
830     debug=False,
831     commit=True,
832 ):
833     config_saved =</b></font> save_config(source=source, path=path)
834         return config_saved
835     path = config_saved["out"]
836     replace_pattern <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= __salt__["file.replace"](
837         path,
838         pattern,
839         repl,
840         count=count,
841         flags=flags,
842         bufsize=bufsize,
843         append_if_not_found=append_if_not_found,
844         prepend_if_not_found=prepend_if_not_found,
845         not_found_content=not_found_content,
846         search_only=search_only,
847         show_changes=show_changes,
848         backslash_literal=</b></font>backslash_literal,
849     )
850     with salt.utils.files.fopen(path, "r") as fh_:
851         updated_config = fh_.read()
852     return __salt__["net.load_config"](
853         text=updated_config, test=test, debug=debug, replace=replace, commit=commit
854     )
855     marker_start,
856     marker_end,
857     content<font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>="",
858     append_if_not_found=False,
859     prepend_if_not_found=False,
860     show_changes=True,
861     append_newline=False,
862     source="running",
863     path=None,
864     test=False,
865     commit=True,
866     debug=False,
867     replace=True,
868 ):
869     config_saved =</b></font> save_config(source=source, path=path)
870     if not config_saved or not config_saved["result"]:
871         return config_saved
872     path = config_saved["out"]
873     replace_pattern = __salt__["file.blockreplace"](
874         path,
875         marker_start=marker_start,
876         marker_end=marker_end,
877         content=content,
878         append_if_not_found=append_if_not_found,
879         prepend_if_not_found=prepend_if_not_found,
880         show_changes=show_changes,
881         append_newline=append_newline,
882     )
883     with salt.utils.files.fopen(path, "r") as fh_:
884         updated_config = fh_.read()
885     return __salt__["net.load_config"](
886         text=updated_config, test=test, debug=debug, replace=replace, commit=commit
887     )
888 def patch(
889     patchfile,
890     options="",
891     saltenv="base",
892     source_hash=None,
893     show_changes=True,
894     source="running",
895     path=None,
896     test=False,
897     commit=True,
898     debug=False,
899     replace=True,
900 ):
901     config_saved = save_config(source=source, path=path)
902     if not config_saved or not config_saved["result"]:
903         return config_saved
904     path = config_saved["out"]
905     patchfile_cache = __salt__["cp.cache_file"](patchfile)
906     if patchfile_cache is False:
907         return {
908             "out": None,
909             "result": False,
910             "comment": 'The file "{}" does not exist.'.format(patchfile),
911         }
912     replace_pattern = __salt__["file.patch"](path, patchfile_cache, options=options)
913     with salt.utils.files.fopen(path, "r") as fh_:
914         updated_config = fh_.read()
915     return __salt__["net.load_config"](
916         text=updated_config, test=test, debug=debug, replace=replace, commit=commit
917     )
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>netacl.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import salt.utils.napalm
3 log = logging.getLogger(__file__)
4 try:
5     import capirca
6     import capirca.aclgen
7     import capirca.lib.policy
8     import capirca.lib.aclgenerator
9     HAS_CAPIRCA = True
10 except ImportError:
11     HAS_CAPIRCA = False
12 __virtualname__ = "netacl"
13 def __virtual__():
14     if HAS_CAPIRCA and salt.utils.napalm.virtual(__opts__, __virtualname__, __file__):
15         return __virtualname__
16     else:
17         return (
18             False,
19             "The netacl state cannot be loaded: Please install capirca and napalm.",
20         )
21 <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>def term(
22     name,
23     filter_name,
24     term_name,
25     filter_options=None,
26     pillar_key="acl",
27     pillarenv=None,
28     saltenv=None,
29     merge_pillar=False,
30     revision_id=None,
31     revision_no=None,
32     revision_date=True,
33     revision_date_format="%Y/%m/%d",
34     test=False,
35     commit=True,
36     debug=False,
37     source_service=None,
38     destination_service=None,
39     **term_fields
40 ):
41     ret =</b></font> salt.utils.napalm.default_ret(name)
42     if not filter_options:
43         filter_options = []
44     loaded <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= __salt__["netacl.load_term_config"](
45         filter_name,
46         term_name,
47         filter_options=filter_options,
48         pillar_key=pillar_key,
49         pillarenv=pillarenv,
50         saltenv=saltenv,
51         merge_pillar=merge_pillar,
52         revision_id=revision_id if revision_id else name,
53         revision_no=revision_no,
54         revision_date=revision_date,
55         revision_date_format=revision_date_format,
56         source_service=source_service,
57         destination_service=destination_service,
58         test=test,
59         commit=</b></font>commit,
60         **term_fields
61     )
62     return salt.utils.napalm.loaded_ret(<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>ret, loaded, test, debug)
63 def filter(
64     name,  # pylint: disable=redefined-builtin
65     filter_name,
66     filter_options=None,
67     terms=None,
68     prepend=True,
69     pillar_key="acl",
70     pillarenv=None,
71     saltenv=None,
72     merge_pillar=False,
73     only_lower_merge=False,
74     revision_id=None,
75     revision_no=None,
76     revision_date=True,
77     revision_date_format="%Y/%m/%d",
78     test=False,
79     commit=True,
80     debug=False,
81 ):
82     ret =</b></font> salt.utils.napalm.default_ret(name)
83     test = __opts__["test"] or test
84     if not filter_options:
85     if not terms:
86         terms = []
87     loaded <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= __salt__["netacl.load_filter_config"](
88         filter_name,
89         filter_options=filter_options,
90         terms=terms,
91         prepend=prepend,
92         pillar_key=pillar_key,
93         pillarenv=pillarenv,
94         saltenv=saltenv,
95         merge_pillar=merge_pillar,
96         only_lower_merge=only_lower_merge,
97         revision_id=</b></font>revision_id if revision_id else name,
98         revision_no=revision_no,
99         revision_date=revision_date,
100         revision_date_format=revision_date_format,
101         test=test,
102         commit=commit,
103         debug=debug,
104     )
105 <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>def managed(
106     name,
107     filters=None,
108     prepend=True,
109     pillar_key="acl",
110     pillarenv=None,
111     saltenv=None,
112     merge_pillar=False,
113     only_lower_merge=False,
114     revision_id=None,
115     revision_no=None,
116     revision_date=True,
117     revision_date_format="%Y/%m/%d",
118     test=False,
119     commit=True,
120     debug=</b></font>False,
121 ):
122     ret = salt.utils.napalm.default_ret(name)
123     test = __opts__["test"] or test
124         filters = []
125     loaded = __salt__["netacl.load_policy_config"](
126         filters<font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=filters,
127         prepend=prepend,
128         pillar_key=pillar_key,
129         pillarenv=pillarenv,
130         saltenv=saltenv,
131         merge_pillar=merge_pillar,
132         only_lower_merge=only_lower_merge,
133         revision_id=revision_id if revision_id else name,
134         revision_no=revision_no,
135         revision_date=revision_date,
136         revision_date_format=revision_date_format,
137         test=</b></font>test,
138         commit=commit,
139         debug=debug,
140     )
141     return salt.utils.napalm.loaded_ret(ret, loaded, test, debug)
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
