<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for napalm_network.py &amp; netacl.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for napalm_network.py &amp; netacl.py
      </h3>
<h1 align="center">
        10.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>napalm_network.py (5.949198%)<th>netacl.py (50.857143%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(2346-2470)<td><a href="#" name="0">(448-659)</a><td align="center"><font color="#ff0000">18</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(2027-2040)<td><a href="#" name="1">(429-444)</a><td align="center"><font color="#e20000">16</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(1599-1614)<td><a href="#" name="2">(92-425)</a><td align="center"><font color="#e20000">16</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(1339-1548)<td><a href="#" name="3">(686-701)</a><td align="center"><font color="#d40000">15</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(2498-2585)<td><a href="#" name="4">(965-976)</a><td align="center"><font color="#aa0000">12</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(2474-2486)<td><a href="#" name="5">(665-675)</a><td align="center"><font color="#aa0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>napalm_network.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import datetime
2 import logging
3 import time
4 import salt.utils.files
5 import salt.utils.napalm
6 import salt.utils.templates
7 import salt.utils.versions
8 log = logging.getLogger(__name__)
9 try:
10     import jxmlease  # pylint: disable=unused-import
11     HAS_JXMLEASE = True
12 except ImportError:
13     HAS_JXMLEASE = False
14 __virtualname__ = "net"
15 __proxyenabled__ = ["*"]
16 __virtual_aliases__ = ("napalm_net",)
17 def __virtual__():
18     return salt.utils.napalm.virtual(__opts__, __virtualname__, __file__)
19 def _filter_list(input_list, search_key, search_value):
20     output_list = list()
21     for dictionary in input_list:
22         if dictionary.get(search_key) == search_value:
23             output_list.append(dictionary)
24     return output_list
25 def _filter_dict(input_dict, search_key, search_value):
26     output_dict = dict()
27     for key, key_list in input_dict.items():
28         key_list_filtered = _filter_list(key_list, search_key, search_value)
29         if key_list_filtered:
30             output_dict[key] = key_list_filtered
31     return output_dict
32 def _safe_commit_config(loaded_result, napalm_device):
33     _commit = commit(
34         inherit_napalm_device=napalm_device
35     )  # calls the function commit, defined below
36     if not _commit.get("result", False):
37         loaded_result["comment"] += (
38             _commit["comment"] if _commit.get("comment") else "Unable to commit."
39         )
40         loaded_result["result"] = False
41         discarded = _safe_dicard_config(loaded_result, napalm_device)
42         if not discarded["result"]:
43             return loaded_result
44     return _commit
45 def _safe_dicard_config(loaded_result, napalm_device):
46     log.debug("Discarding the config")
47     log.debug(loaded_result)
48     _discarded = discard_config(inherit_napalm_device=napalm_device)
49     if not _discarded.get("result", False):
50         loaded_result["comment"] += (
51             _discarded["comment"]
52             if _discarded.get("comment")
53             else "Unable to discard config."
54         )
55         loaded_result["result"] = False
56         _explicit_close(napalm_device)
57         __context__["retcode"] = 1
58         return loaded_result
59     return _discarded
60 def _explicit_close(napalm_device):
61     if salt.utils.napalm.not_always_alive(__opts__):
62         try:
63             napalm_device["DRIVER"].close()
64         except Exception as err:  # pylint: disable=broad-except
65             log.error("Unable to close the temp connection with the device:")
66             log.error(err)
67             log.error("Please report.")
68 def _config_logic(
69     napalm_device,
70     loaded_result,
71     test=False,
72     debug=False,
73     replace=False,
74     commit_config=True,
75     loaded_config=None,
76     commit_in=None,
77     commit_at=None,
78     revert_in=None,
79     revert_at=None,
80     commit_jid=None,
81     **kwargs
82 ):
83     current_jid = kwargs.get("__pub_jid")
84     if not current_jid:
85         current_jid = "{:%Y%m%d%H%M%S%f}".format(datetime.datetime.now())
86     loaded_result["already_configured"] = False
87     loaded_result["loaded_config"] = ""
88     if debug:
89         loaded_result["loaded_config"] = loaded_config
90     _compare = compare_config(inherit_napalm_device=napalm_device)
91     if _compare.get("result", False):
92         loaded_result["diff"] = _compare.get("out")
93         loaded_result.pop("out", "")  # not needed
94     else:
95         loaded_result["diff"] = None
96         loaded_result["result"] = False
97         loaded_result["comment"] = _compare.get("comment")
98         __context__["retcode"] = 1
99         return loaded_result
100     _loaded_res = loaded_result.get("result", False)
101     if not _loaded_res or test:
102         if loaded_result["comment"]:
103             loaded_result["comment"] += "\n"
104         if not len(loaded_result.get("diff", "")) &gt; 0:
105             loaded_result["already_configured"] = True
106         discarded = _safe_dicard_config(loaded_result, napalm_device)
107         if not discarded["result"]:
108             return loaded_result
109         loaded_result["comment"] += "Configuration discarded."
110         _explicit_close(napalm_device)
111         if not loaded_result["result"]:
112             __context__["retcode"] = 1
113         return loaded_result
114     if not test and commit_config:
115         if commit_jid:
116             log.info("Committing the JID: %s", str(commit_jid))
117             removed = cancel_commit(commit_jid)
118             log.debug("Cleaned up the commit from the schedule")
119             log.debug(removed["comment"])
120         if len(loaded_result.get("diff", "")) &gt; 0:
121             if commit_in or commit_at:
122                 commit_time = __utils__["timeutil.get_time_at"](
123                     time_in=commit_in, time_at=commit_in
124                 )
125                 scheduled_job_name = "__napalm_commit_{}".format(current_jid)
126                 temp_file = salt.utils.files.mkstemp()
127                 with salt.utils.files.fopen(temp_file, "w") as fp_:
128                     fp_.write(loaded_config)
129                 scheduled = __salt__["schedule.add"](
130                     scheduled_job_name,
131                     function="net.load_config",
132                     job_kwargs={
133                         "filename": temp_file,
134                         "commit_jid": current_jid,
135                         "replace": replace,
136                     },
137                     once=commit_time,
138                 )
139                 log.debug("Scheduling job")
140                 log.debug(scheduled)
141                 saved = __salt__["schedule.save"]()  # ensure the schedule is
142                 discarded = _safe_dicard_config(loaded_result, napalm_device)
143                 if not discarded["result"]:
144                     discarded["comment"] += (
145                         "Scheduled the job to be executed at {schedule_ts}, "
146                         "but was unable to discard the config: \n".format(
147                             schedule_ts=commit_time
148                         )
149                     )
150                     return discarded
151                 loaded_result["comment"] = (
152                     "Changes discarded for now, and scheduled commit at:"
153                     " {schedule_ts}.\nThe commit ID is: {current_jid}.\nTo discard this"
154                     " commit, you can execute: \n\nsalt {min_id} net.cancel_commit"
155                     " {current_jid}".format(
156                         schedule_ts=commit_time,
157                         min_id=__opts__["id"],
158                         current_jid=current_jid,
159                     )
160                 )
161                 loaded_result["commit_id"] = current_jid
162                 return loaded_result
163             log.debug("About to commit:")
164             log.debug(loaded_result["diff"])
165             if revert_in or revert_at:
166                 revert_time = __utils__["timeutil.get_time_at"](
167                     time_in=revert_in, time_at=revert_at
168                 )
169                 if __grains__["os"] == "junos":
170                     if not HAS_JXMLEASE:
171                         loaded_result["comment"] = (
172                             "This feature requires the library jxmlease to be"
173                             " installed.\nTo install, please execute: ``pip install"
174                             " jxmlease``."
175                         )
176                         loaded_result["result"] = False
177                         return loaded_result
178                     timestamp_at = __utils__["timeutil.get_timestamp_at"](
179                         time_in=revert_in, time_at=revert_at
180                     )
181                     minutes = int((timestamp_at - time.time()) / 60)
182                     _comm = __salt__["napalm.junos_commit"](confirm=minutes)
183                     if not _comm["out"]:
184                         loaded_result[
185                             "comment"
186                         ] = "Unable to commit confirm: {}".format(_comm["message"])
187                         loaded_result["result"] = False
188                         discarded = _safe_dicard_config(loaded_result, napalm_device)
189                         if not discarded["result"]:
190                             return loaded_result
191                 else:
192                     temp_file = salt.utils.files.mkstemp()
193                     running_config = __salt__["net.config"](source="running")["out"][
194                         "running"
195                     ]
196                     with salt.utils.files.fopen(temp_file, "w") as fp_:
197                         fp_.write(running_config)
198                     committed = _safe_commit_config(loaded_result, napalm_device)
199                     if not committed["result"]:
200                         return loaded_result
201                     scheduled_job_name = "__napalm_commit_{}".format(current_jid)
202                     scheduled = __salt__["schedule.add"](
203                         scheduled_job_name,
204                         function="net.load_config",
205                         job_kwargs={
206                             "filename": temp_file,
207                             "commit_jid": current_jid,
208                             "replace": True,
209                         },
210                         once=revert_time,
211                     )
212                     log.debug("Scheduling commit confirmed")
213                     log.debug(scheduled)
214                     saved = __salt__["schedule.save"]()
215                 loaded_result["comment"] = (
216                     "The commit ID is: {current_jid}.\nThis commit will be reverted at:"
217                     " {schedule_ts}, unless confirmed.\nTo confirm the commit and avoid"
218                     " reverting, you can execute:\n\nsalt {min_id} net.confirm_commit"
219                     " {current_jid}".format(
220                         schedule_ts=revert_time,
221                         min_id=__opts__["id"],
222                         current_jid=current_jid,
223                     )
224                 )
225                 loaded_result["commit_id"] = current_jid
226                 return loaded_result
227             committed = _safe_commit_config(loaded_result, napalm_device)
228             if not committed["result"]:
229                 return loaded_result
230         else:
231             discarded = _safe_dicard_config(loaded_result, napalm_device)
232             if not discarded["result"]:
233                 return loaded_result
234             loaded_result["already_configured"] = True
235             loaded_result["comment"] = "Already configured."
236     _explicit_close(napalm_device)
237     if not loaded_result["result"]:
238         __context__["retcode"] = 1
239     return loaded_result
240 @salt.utils.napalm.proxy_napalm_wrap
241 def connected(**kwargs):  # pylint: disable=unused-argument
242     return {"out": napalm_device.get("UP", False)}  # pylint: disable=undefined-variable
243 @salt.utils.napalm.proxy_napalm_wrap
244 def facts(**kwargs):  # pylint: disable=unused-argument
245     return salt.utils.napalm.call(
246         napalm_device, "get_facts", **{}  # pylint: disable=undefined-variable
247     )
248 @salt.utils.napalm.proxy_napalm_wrap
249 def environment(**kwargs):  # pylint: disable=unused-argument
250     return salt.utils.napalm.call(
251         napalm_device, "get_environment", **{}  # pylint: disable=undefined-variable
252     )
253 @salt.utils.napalm.proxy_napalm_wrap
254 def cli(*commands, **kwargs):  # pylint: disable=unused-argument
255     raw_cli_outputs = salt.utils.napalm.call(
256         napalm_device,  # pylint: disable=undefined-variable
257         "cli",
258         **{"commands": list(commands)}
259     )
260     if not raw_cli_outputs["result"]:
261         return raw_cli_outputs
262     textfsm_parse = (
263         kwargs.get("textfsm_parse")
264         or __opts__.get("napalm_cli_textfsm_parse")
265         or __pillar__.get("napalm_cli_textfsm_parse", False)
266     )
267     if not textfsm_parse:
268         log.debug("No TextFSM parsing requested.")
269         return raw_cli_outputs
270     if "textfsm.extract" not in __salt__ or "textfsm.index" not in __salt__:
271         raw_cli_outputs["comment"] += "Unable to process: is TextFSM installed?"
272         log.error(raw_cli_outputs["comment"])
273         return raw_cli_outputs
274     textfsm_template = kwargs.get("textfsm_template")
275     log.debug("textfsm_template: %s", textfsm_template)
276     textfsm_path = (
277         kwargs.get("textfsm_path")
278         or __opts__.get("textfsm_path")
279         or __pillar__.get("textfsm_path")
280     )
281     log.debug("textfsm_path: %s", textfsm_path)
282     textfsm_template_dict = (
283         kwargs.get("textfsm_template_dict")
284         or __opts__.get("napalm_cli_textfsm_template_dict")
285         or __pillar__.get("napalm_cli_textfsm_template_dict", {})
286     )
287     log.debug("TextFSM command-template mapping: %s", textfsm_template_dict)
288     index_file = (
289         kwargs.get("index_file")
290         or __opts__.get("textfsm_index_file")
291         or __pillar__.get("textfsm_index_file")
292     )
293     log.debug("index_file: %s", index_file)
294     platform_grain_name = (
295         kwargs.get("platform_grain_name")
296         or __opts__.get("textfsm_platform_grain")
297         or __pillar__.get("textfsm_platform_grain", "os")
298     )
299     log.debug("platform_grain_name: %s", platform_grain_name)
300     platform_column_name = (
301         kwargs.get("platform_column_name")
302         or __opts__.get("textfsm_platform_column_name")
303         or __pillar__.get("textfsm_platform_column_name", "Platform")
304     )
305     log.debug("platform_column_name: %s", platform_column_name)
306     saltenv = kwargs.get("saltenv", "base")
307     include_empty = kwargs.get("include_empty", False)
308     include_pat = kwargs.get("include_pat")
309     exclude_pat = kwargs.get("exclude_pat")
310     processed_cli_outputs = {
311         "comment": raw_cli_outputs.get("comment", ""),
312         "result": raw_cli_outputs["result"],
313         "out": {},
314     }
315     log.debug("Starting to analyse the raw outputs")
316     for command in list(commands):
317         command_output = raw_cli_outputs["out"][command]
318         log.debug("Output from command: %s", command)
319         log.debug(command_output)
320         processed_command_output = None
321         if textfsm_path:
322             log.debug("Using the templates under %s", textfsm_path)
323             processed_cli_output = __salt__["textfsm.index"](
324                 command,
325                 platform_grain_name=platform_grain_name,
326                 platform_column_name=platform_column_name,
327                 output=command_output.strip(),
328                 textfsm_path=textfsm_path,
329                 saltenv=saltenv,
330                 include_empty=include_empty,
331                 include_pat=include_pat,
332                 exclude_pat=exclude_pat,
333             )
334             log.debug("Processed CLI output:")
335             log.debug(processed_cli_output)
336             if not processed_cli_output["result"]:
337                 log.debug("Apparently this did not work, returning the raw output")
338                 processed_command_output = command_output
339                 processed_cli_outputs[
340                     "comment"
341                 ] += "\nUnable to process the output from {}: {}.".format(
342                     command, processed_cli_output["comment"]
343                 )
344                 log.error(processed_cli_outputs["comment"])
345             elif processed_cli_output["out"]:
346                 log.debug("All good, %s has a nice output!", command)
347                 processed_command_output = processed_cli_output["out"]
348             else:
349                 comment = """\nProcessing "{}" didn't fail, but didn't return anything either. Dumping raw.""".format(
350                     command
351                 )
352                 processed_cli_outputs["comment"] += comment
353                 log.error(comment)
354                 processed_command_output = command_output
355         elif textfsm_template or command in textfsm_template_dict:
356             if command in textfsm_template_dict:
357                 textfsm_template = textfsm_template_dict[command]
358             log.debug("Using %s to process the command: %s", textfsm_template, command)
359             processed_cli_output = __salt__["textfsm.extract"](
360                 textfsm_template, raw_text=command_output, saltenv=saltenv
361             )
362             log.debug("Processed CLI output:")
363             log.debug(processed_cli_output)
364             if not processed_cli_output["result"]:
365                 log.debug("Apparently this did not work, returning the raw output")
366                 processed_command_output = command_output
367                 processed_cli_outputs[
368                     "comment"
369                 ] += "\nUnable to process the output from {}: {}".format(
370                     command, processed_cli_output["comment"]
371                 )
372                 log.error(processed_cli_outputs["comment"])
373             elif processed_cli_output["out"]:
374                 log.debug("All good, %s has a nice output!", command)
375                 processed_command_output = processed_cli_output["out"]
376             else:
377                 log.debug(
378                     "Processing %s did not fail, but did not return"
379                     " anything either. Dumping raw.",
380                     command,
381                 )
382                 processed_command_output = command_output
383         else:
384             log.error("No TextFSM template specified, or no TextFSM path defined")
385             processed_command_output = command_output
386             processed_cli_outputs[
387                 "comment"
388             ] += "\nUnable to process the output from {}.".format(command)
389         processed_cli_outputs["out"][command] = processed_command_output
390     processed_cli_outputs["comment"] = processed_cli_outputs["comment"].strip()
391     return processed_cli_outputs
392 @salt.utils.napalm.proxy_napalm_wrap
393 def traceroute(
394     destination, source=None, ttl=None, timeout=None, vrf=None, **kwargs
395 ):  # pylint: disable=unused-argument
396     return salt.utils.napalm.call(
397         napalm_device,  # pylint: disable=undefined-variable
398         "traceroute",
399         **{
400             "destination": destination,
401             "source": source,
402             "ttl": ttl,
403             "timeout": timeout,
404             "vrf": vrf,
405         }
406     )
407 @salt.utils.napalm.proxy_napalm_wrap
408 def ping(
409     destination,
410     source=None,
411     ttl=None,
412     timeout=None,
413     size=None,
414     count=None,
415     vrf=None,
416     **kwargs
417 ):  # pylint: disable=unused-argument
418     return salt.utils.napalm.call(
419         napalm_device,  # pylint: disable=undefined-variable
420         "ping",
421         **{
422             "destination": destination,
423             "source": source,
424             "ttl": ttl,
425             "timeout": timeout,
426             "size": size,
427             "count": count,
428             "vrf": vrf,
429         }
430     )
431 @salt.utils.napalm.proxy_napalm_wrap
432 def arp(
433     interface="", ipaddr="", macaddr="", **kwargs
434 ):  # pylint: disable=unused-argument
435     proxy_output = salt.utils.napalm.call(
436         napalm_device, "get_arp_table", **{}  # pylint: disable=undefined-variable
437     )
438     if not proxy_output.get("result"):
439         return proxy_output
440     arp_table = proxy_output.get("out")
441     if interface:
442         arp_table = _filter_list(arp_table, "interface", interface)
443     if ipaddr:
444         arp_table = _filter_list(arp_table, "ip", ipaddr)
445     if macaddr:
446         arp_table = _filter_list(arp_table, "mac", macaddr)
447     proxy_output.update({"out": arp_table})
448     return proxy_output
449 @salt.utils.napalm.proxy_napalm_wrap
450 def ipaddrs(**kwargs):  # pylint: disable=unused-argument
451     return salt.utils.napalm.call(
452         napalm_device, "get_interfaces_ip", **{}  # pylint: disable=undefined-variable
453     )
454 @salt.utils.napalm.proxy_napalm_wrap
455 def interfaces(**kwargs):  # pylint: disable=unused-argument
456     return salt.utils.napalm.call(
457         napalm_device, "get_interfaces", **{}  # pylint: disable=undefined-variable
458     )
459 @salt.utils.napalm.proxy_napalm_wrap
460 def lldp(interface="", **kwargs):  # pylint: disable=unused-argument
461     proxy_output = salt.utils.napalm.call(
462         napalm_device,  # pylint: disable=undefined-variable
463         "get_lldp_neighbors_detail",
464         **{}
465     )
466     if not proxy_output.get("result"):
467         return proxy_output
468     lldp_neighbors = proxy_output.get("out")
469     if interface:
470         lldp_neighbors = {interface: lldp_neighbors.get(interface)}
471     proxy_output.update({"out": lldp_neighbors})
472     return proxy_output
473 @salt.utils.napalm.proxy_napalm_wrap
474 def mac(address="", interface="", vlan=0, **kwargs):  # pylint: disable=unused-argument
475     proxy_output = salt.utils.napalm.call(
476         napalm_device,  # pylint: disable=undefined-variable
477         "get_mac_address_table",
478         **{}
479     )
480     if not proxy_output.get("result"):
481         return proxy_output
482     mac_address_table = proxy_output.get("out")
483     if vlan and isinstance(vlan, int):
484         mac_address_table = _filter_list(mac_address_table, "vlan", vlan)
485     if address:
486         mac_address_table = _filter_list(mac_address_table, "mac", address)
487     if interface:
488         mac_address_table = _filter_list(mac_address_table, "interface", interface)
489     proxy_output.update({"out": mac_address_table})
490     return proxy_output
491 @salt.utils.napalm.proxy_napalm_wrap
492 def config(source=None, **kwargs):  # pylint: disable=unused-argument
493     return salt.utils.napalm.call(
494         napalm_device,  # pylint: disable=undefined-variable
495         "get_config",
496         **{"retrieve": source}
497     )
498 @salt.utils.napalm.proxy_napalm_wrap
499 def optics(**kwargs):  # pylint: disable=unused-argument
500     return salt.utils.napalm.call(
501         napalm_device, "get_optics", **{}  # pylint: disable=undefined-variable
502     )
503 <a name="3"></a>
504 @salt.utils.napalm.proxy_napalm_wrap
505 <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>def load_config(
506     filename=None,
507     text=None,
508     test=False,
509     commit=True,
510     debug=False,
511     replace=False,
512     commit_in=None,
513     commit_at=None,
514     revert_in=None,
515     revert_at=None,
516     commit_jid=None,
517     inherit_napalm_device=None,
518     saltenv="base",
519     **kwargs
520 ):  # pylint: disable=unused-argument
521     fun =</b></font> "load_merge_candidate"
522     if replace:
523         fun = "load_replace_candidate"
524     if salt.utils.napalm.not_always_alive(__opts__):
525         napalm_device["CLOSE"] = False  # pylint: disable=undefined-variable
526     if filename:
527         text = __salt__["cp.get_file_str"](filename, saltenv=saltenv)
528         if text is False:
529             ret = {"result": False, "out": None}
530             ret[
531                 "comment"
532             ] = "Unable to read from {}. Please specify a valid file or text.".format(
533                 filename
534             )
535             log.error(ret["comment"])
536             return ret
537         if commit_jid:
538             salt.utils.files.safe_rm(filename)
539     _loaded = salt.utils.napalm.call(
540         napalm_device, fun, **{"config": text}  # pylint: disable=undefined-variable
541     )
542     return _config_logic(
543         napalm_device,  # pylint: disable=undefined-variable
544         _loaded,
545         test=test,
546         debug=debug,
547         replace=replace,
548         commit_config=commit,
549         loaded_config=text,
550         commit_at=commit_at,
551         commit_in=commit_in,
552         revert_in=revert_in,
553         revert_at=revert_at,
554         commit_jid=commit_jid,
555         **kwargs
556     )
557 <a name="2"></a>
558 @salt.utils.napalm.proxy_napalm_wrap
559 <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>def load_template(
560     template_name=None,
561     template_source=None,
562     context=None,
563     defaults=None,
564     template_engine="jinja",
565     saltenv="base",
566     template_hash=None,
567     template_hash_name=None,
568     skip_verify=False,
569     test=False,
570     commit=True,
571     debug=False,
572     replace=False,
573     commit_in=None,
574     commit_at=</b></font>None,
575     revert_in=None,
576     revert_at=None,
577     inherit_napalm_device=None,  # pylint: disable=unused-argument
578     **template_vars
579 ):
580     _rendered = ""
581     _loaded = {"result": True, "comment": "", "out": None}
582     loaded_config = None
583     if template_engine not in salt.utils.templates.TEMPLATE_REGISTRY:
584         _loaded.update(
585             {
586                 "result": False,
587                 "comment": (
588                     "Invalid templating engine! Choose between: {tpl_eng_opts}".format(
589                         tpl_eng_opts=", ".join(
590                             list(salt.utils.templates.TEMPLATE_REGISTRY.keys())
591                         )
592                     )
593                 ),
594             }
595         )
596         return _loaded  # exit
597     salt_render_prefixes = ("salt://", "http://", "https://", "ftp://")
598     salt_render = False
599     file_exists = False
600     if not isinstance(template_name, (tuple, list)):
601         for salt_render_prefix in salt_render_prefixes:
602             if not salt_render:
603                 salt_render = salt_render or template_name.startswith(
604                     salt_render_prefix
605                 )
606         file_exists = __salt__["file.file_exists"](template_name)
607     if context is None:
608         context = {}
609     context.update(template_vars)
610     if template_source:
611         _rendered = __salt__["file.apply_template_on_contents"](
612             contents=template_source,
613             template=template_engine,
614             context=context,
615             defaults=defaults,
616             saltenv=saltenv,
617         )
618         if not isinstance(_rendered, str):
619             if "result" in _rendered:
620                 _loaded["result"] = _rendered["result"]
621             else:
622                 _loaded["result"] = False
623             if "comment" in _rendered:
624                 _loaded["comment"] = _rendered["comment"]
625             else:
626                 _loaded["comment"] = "Error while rendering the template."
627             return _loaded
628     else:
629         if not isinstance(template_name, (list, tuple)):
630             template_name = [template_name]
631         if template_hash_name and not isinstance(template_hash_name, (list, tuple)):
632             template_hash_name = [template_hash_name]
633         elif not template_hash_name:
634             template_hash_name = [None] * len(template_name)
635         if (
636             template_hash
637             and isinstance(template_hash, str)
638             and not (
639                 template_hash.startswith("salt://")
640                 or template_hash.startswith("file://")
641             )
642         ):
643             template_hash = [template_hash]
644         elif (
645             template_hash
646             and isinstance(template_hash, str)
647             and (
648                 template_hash.startswith("salt://")
649                 or template_hash.startswith("file://")
650             )
651         ):
652             template_hash = [template_hash] * len(template_name)
653         elif not template_hash:
654             template_hash = [None] * len(template_name)
655         for tpl_index, tpl_name in enumerate(template_name):
656             tpl_hash = template_hash[tpl_index]
657 <a name="1"></a>            tpl_hash_name = template_hash_name[tpl_index]
658             _rand_filename = __salt__["random.hash"](tpl_name, "md5")
659             _temp_file = __salt__["file.join"]("/tmp", _rand_filename)
660             _managed <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= __salt__["file.get_managed"](
661                 name=_temp_file,
662                 source=tpl_name,
663                 source_hash=tpl_hash,
664                 source_hash_name=tpl_hash_name,
665                 user=None,
666                 group=None,
667                 mode=None,
668                 attrs=None,
669                 template=template_engine,
670                 context=context,
671                 defaults=defaults,
672                 saltenv=saltenv,
673                 skip_verify=</b></font>skip_verify,
674             )
675             if not isinstance(_managed, (list, tuple)) and isinstance(_managed, str):
676                 _loaded["comment"] += _managed
677                 _loaded["result"] = False
678             elif isinstance(_managed, (list, tuple)) and not len(_managed) &gt; 0:
679                 _loaded["result"] = False
680                 _loaded["comment"] += "Error while rendering the template."
681             elif isinstance(_managed, (list, tuple)) and not len(_managed[0]) &gt; 0:
682                 _loaded["result"] = False
683                 _loaded["comment"] += _managed[-1]  # contains the error message
684             if _loaded["result"]:  # all good
685                 _temp_tpl_file = _managed[0]
686                 _temp_tpl_file_exists = __salt__["file.file_exists"](_temp_tpl_file)
687                 if not _temp_tpl_file_exists:
688                     _loaded["result"] = False
689                     _loaded["comment"] += "Error while rendering the template."
690                     return _loaded
691                 _rendered += __salt__["file.read"](_temp_tpl_file)
692                 __salt__["file.remove"](_temp_tpl_file)
693             else:
694                 return _loaded  # exit
695     loaded_config = _rendered
696     if _loaded["result"]:  # all good
697         fun = "load_merge_candidate"
698         if replace:  # replace requested
699             fun = "load_replace_candidate"
700         if salt.utils.napalm.not_always_alive(__opts__):
701             napalm_device["CLOSE"] = False  # pylint: disable=undefined-variable
702         _loaded = salt.utils.napalm.call(
703             napalm_device,  # pylint: disable=undefined-variable
704             fun,
705             **{"config": _rendered}
706         )
707     return _config_logic(
708         napalm_device,  # pylint: disable=undefined-variable
709         _loaded,
710         test=test,
711         debug=debug,
712         replace=replace,
713         commit_config=commit,
714         loaded_config=loaded_config,
715         commit_at=commit_at,
716         commit_in=commit_in,
717         revert_in=revert_in,
718         revert_at=revert_at,
719         **template_vars
720     )
721 @salt.utils.napalm.proxy_napalm_wrap
722 def commit(inherit_napalm_device=None, **kwargs):  # pylint: disable=unused-argument
723     return salt.utils.napalm.call(
724         napalm_device, "commit_config", **{}  # pylint: disable=undefined-variable
725     )
726 @salt.utils.napalm.proxy_napalm_wrap
727 def discard_config(
728     inherit_napalm_device=None, **kwargs
729 ):  # pylint: disable=unused-argument
730     return salt.utils.napalm.call(
731         napalm_device, "discard_config", **{}  # pylint: disable=undefined-variable
732     )
733 @salt.utils.napalm.proxy_napalm_wrap
734 def compare_config(
735     inherit_napalm_device=None, **kwargs
736 ):  # pylint: disable=unused-argument
737     return salt.utils.napalm.call(
738         napalm_device, "compare_config", **{}  # pylint: disable=undefined-variable
739     )
740 @salt.utils.napalm.proxy_napalm_wrap
741 def rollback(inherit_napalm_device=None, **kwargs):  # pylint: disable=unused-argument
742     return salt.utils.napalm.call(
743         napalm_device, "rollback", **{}  # pylint: disable=undefined-variable
744     )
745 @salt.utils.napalm.proxy_napalm_wrap
746 def config_changed(
747     inherit_napalm_device=None, **kwargs
748 ):  # pylint: disable=unused-argument
749     is_config_changed = False
750     reason = ""
751     try_compare = compare_config(inherit_napalm_device=napalm_device)
752     if try_compare.get("result"):
753         if try_compare.get("out"):
754             is_config_changed = True
755         else:
756             reason = "Configuration was not changed on the device."
757     else:
758         reason = try_compare.get("comment")
759     return is_config_changed, reason
760 @salt.utils.napalm.proxy_napalm_wrap
761 def config_control(
762     inherit_napalm_device=None, **kwargs
763 ):  # pylint: disable=unused-argument
764     result = True
765     comment = ""
766     changed, not_changed_rsn = config_changed(inherit_napalm_device=napalm_device)
767     if not changed:
768         return (changed, not_changed_rsn)
769     try_commit = commit()
770     if not try_commit.get("result"):
771         result = False
772         comment = (
773             "Unable to commit the changes: {reason}.\nWill try to rollback now!".format(
774                 reason=try_commit.get("comment")
775             )
776         )
777         try_rollback = rollback()
778         if not try_rollback.get("result"):
779             comment += "\nCannot rollback! {reason}".format(
780                 reason=try_rollback.get("comment")
781             )
782     return result, comment
783 def cancel_commit(jid):
784     job_name = "__napalm_commit_{}".format(jid)
785     removed = __salt__["schedule.delete"](job_name)
786     if removed["result"]:
787         saved = __salt__["schedule.save"]()
788         removed["comment"] = "Commit #{jid} cancelled.".format(jid=jid)
789     else:
790         removed["comment"] = "Unable to find commit #{jid}.".format(jid=jid)
791     return removed
792 def confirm_commit(jid):
793     if __grains__["os"] == "junos":
794         confirmed = __salt__["napalm.junos_commit"]()
795         confirmed["result"] = confirmed.pop("out")
796         confirmed["comment"] = confirmed.pop("message")
797     else:
798         confirmed = cancel_commit(jid)
799     if confirmed["result"]:
800         confirmed["comment"] = "Commit #{jid} confirmed.".format(jid=jid)
801     return confirmed
802 def save_config(source=None, path=None):
803     if not source:
804         source = "running"
805     if not path:
806         path = salt.utils.files.mkstemp()
807     running_config = __salt__["net.config"](source=source)
808     if not running_config or not running_config["result"]:
809         log.error("Unable to retrieve the config")
810         return running_config
811     with salt.utils.files.fopen(path, "w") as fh_:
812         fh_.write(running_config["out"][source])
813 <a name="0"></a>    return {
814         "result": True,
815         "out": path,
816         "comment": "{source} config saved to {path}".format(source=source, path=<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>path),
817     }
818 def replace_pattern(
819     pattern,
820     repl,
821     count=0,
822     flags=8,
823     bufsize=1,
824     append_if_not_found=False,
825     prepend_if_not_found=False,
826     not_found_content=None,
827     search_only=False,
828     show_changes=True,
829     backslash_literal=False,
830     source=None,
831     path=None,
832     test=False,
833     replace=True,
834     debug=False,
835     commit=True,
836 ):
837     config_saved =</b></font> save_config(source=source, path=path)
838 <a name="5"></a>    if not config_saved or not config_saved["result"]:
839         return config_saved
840     path = config_saved["out"]
841     replace_pattern <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= __salt__["file.replace"](
842         path,
843         pattern,
844         repl,
845         count=count,
846         flags=flags,
847         bufsize=bufsize,
848         append_if_not_found=append_if_not_found,
849         prepend_if_not_found=prepend_if_not_found,
850         not_found_content=not_found_content,
851         search_only=search_only,
852         show_changes=show_changes,
853         backslash_literal=</b></font>backslash_literal,
854     )
855     with salt.utils.files.fopen(path, "r") as fh_:
856         updated_config = fh_.read()
857     return __salt__["net.load_config"](
858         text=updated_config, test=test, debug=debug, replace=replace, commit=commit
859     )
860 <a name="4"></a>def blockreplace(
861     marker_start,
862     marker_end,
863     content<font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>="",
864     append_if_not_found=False,
865     prepend_if_not_found=False,
866     show_changes=True,
867     append_newline=False,
868     source="running",
869     path=None,
870     test=False,
871     commit=True,
872     debug=False,
873     replace=True,
874 ):
875     config_saved =</b></font> save_config(source=source, path=path)
876     if not config_saved or not config_saved["result"]:
877         return config_saved
878     path = config_saved["out"]
879     replace_pattern = __salt__["file.blockreplace"](
880         path,
881         marker_start=marker_start,
882         marker_end=marker_end,
883         content=content,
884         append_if_not_found=append_if_not_found,
885         prepend_if_not_found=prepend_if_not_found,
886         show_changes=show_changes,
887         append_newline=append_newline,
888     )
889     with salt.utils.files.fopen(path, "r") as fh_:
890         updated_config = fh_.read()
891     return __salt__["net.load_config"](
892         text=updated_config, test=test, debug=debug, replace=replace, commit=commit
893     )
894 def patch(
895     patchfile,
896     options="",
897     saltenv="base",
898     source_hash=None,
899     show_changes=True,
900     source="running",
901     path=None,
902     test=False,
903     commit=True,
904     debug=False,
905     replace=True,
906 ):
907     config_saved = save_config(source=source, path=path)
908     if not config_saved or not config_saved["result"]:
909         return config_saved
910     path = config_saved["out"]
911     patchfile_cache = __salt__["cp.cache_file"](patchfile)
912     if patchfile_cache is False:
913         return {
914             "out": None,
915             "result": False,
916             "comment": 'The file "{}" does not exist.'.format(patchfile),
917         }
918     replace_pattern = __salt__["file.patch"](path, patchfile_cache, options=options)
919     with salt.utils.files.fopen(path, "r") as fh_:
920         updated_config = fh_.read()
921     return __salt__["net.load_config"](
922         text=updated_config, test=test, debug=debug, replace=replace, commit=commit
923     )
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>netacl.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import salt.utils.napalm
3 log = logging.getLogger(__file__)
4 try:
5     import capirca
6     import capirca.aclgen
7     import capirca.lib.policy
8     import capirca.lib.aclgenerator
9     HAS_CAPIRCA = True
10 except ImportError:
11     HAS_CAPIRCA = False
12 __virtualname__ = "netacl"
13 def __virtual__():
14     if HAS_CAPIRCA and salt.utils.napalm.virtual(__opts__, __virtualname__, __file__):
15         return __virtualname__
16     else:
17         return (
18             False,
19             "The netacl state cannot be loaded: Please install capirca and napalm.",
20         )
21 <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>def term(
22     name,
23     filter_name,
24     term_name,
25     filter_options=None,
26     pillar_key="acl",
27     pillarenv=None,
28     saltenv=None,
29     merge_pillar=False,
30     revision_id=None,
31     revision_no=None,
32     revision_date=True,
33     revision_date_format="%Y/%m/%d",
34     test=False,
35     commit=True,
36     debug=False,
37     source_service=None,
38     destination_service=None,
39     **term_fields
40 ):
41     ret =</b></font> salt.utils.napalm.default_ret(name)
42 <a name="1"></a>    test = __opts__["test"] or test
43     if not filter_options:
44         filter_options = []
45     loaded <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= __salt__["netacl.load_term_config"](
46         filter_name,
47         term_name,
48         filter_options=filter_options,
49         pillar_key=pillar_key,
50         pillarenv=pillarenv,
51         saltenv=saltenv,
52         merge_pillar=merge_pillar,
53         revision_id=revision_id if revision_id else name,
54         revision_no=revision_no,
55         revision_date=revision_date,
56         revision_date_format=revision_date_format,
57         source_service=source_service,
58         destination_service=destination_service,
59         test=test,
60         commit=</b></font>commit,
61 <a name="0"></a>        debug=debug,
62         **term_fields
63     )
64     return salt.utils.napalm.loaded_ret(<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>ret, loaded, test, debug)
65 def filter(
66     name,  # pylint: disable=redefined-builtin
67     filter_name,
68     filter_options=None,
69     terms=None,
70     prepend=True,
71     pillar_key="acl",
72     pillarenv=None,
73     saltenv=None,
74     merge_pillar=False,
75     only_lower_merge=False,
76     revision_id=None,
77     revision_no=None,
78     revision_date=True,
79     revision_date_format="%Y/%m/%d",
80     test=False,
81     commit=True,
82     debug=False,
83 ):
84     ret =</b></font> salt.utils.napalm.default_ret(name)
85     test = __opts__["test"] or test
86     if not filter_options:
87 <a name="5"></a>        filter_options = []
88     if not terms:
89         terms = []
90     loaded <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= __salt__["netacl.load_filter_config"](
91         filter_name,
92         filter_options=filter_options,
93         terms=terms,
94         prepend=prepend,
95         pillar_key=pillar_key,
96         pillarenv=pillarenv,
97         saltenv=saltenv,
98         merge_pillar=merge_pillar,
99         only_lower_merge=only_lower_merge,
100         revision_id=</b></font>revision_id if revision_id else name,
101         revision_no=revision_no,
102         revision_date=revision_date,
103         revision_date_format=revision_date_format,
104         test=test,
105         commit=commit,
106         debug=debug,
107     )
108 <a name="3"></a>    return salt.utils.napalm.loaded_ret(ret, loaded, test, debug)
109 <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>def managed(
110     name,
111     filters=None,
112     prepend=True,
113     pillar_key="acl",
114     pillarenv=None,
115     saltenv=None,
116     merge_pillar=False,
117     only_lower_merge=False,
118     revision_id=None,
119     revision_no=None,
120     revision_date=True,
121     revision_date_format="%Y/%m/%d",
122     test=False,
123     commit=True,
124     debug=</b></font>False,
125 ):
126     ret = salt.utils.napalm.default_ret(name)
127     test = __opts__["test"] or test
128 <a name="4"></a>    if not filters:
129         filters = []
130     loaded = __salt__["netacl.load_policy_config"](
131         filters<font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=filters,
132         prepend=prepend,
133         pillar_key=pillar_key,
134         pillarenv=pillarenv,
135         saltenv=saltenv,
136         merge_pillar=merge_pillar,
137         only_lower_merge=only_lower_merge,
138         revision_id=revision_id if revision_id else name,
139         revision_no=revision_no,
140         revision_date=revision_date,
141         revision_date_format=revision_date_format,
142         test=</b></font>test,
143         commit=commit,
144         debug=debug,
145     )
146     return salt.utils.napalm.loaded_ret(ret, loaded, test, debug)
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
