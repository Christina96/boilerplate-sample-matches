<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for rediscluster.py &amp; postgres_local_cache.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for rediscluster.py &amp; postgres_local_cache.py
      </h3>
<h1 align="center">
        8.1%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>rediscluster.py (15.068493%)<th>postgres_local_cache.py (5.5555553%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(17-46)<td><a href="#" name="0">(111-135)</a><td align="center"><font color="#ff0000">22</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>rediscluster.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import hashlib
2 import logging
3 import os
4 import salt.payload
5 try:
6     import rediscluster
7     HAS_REDIS = True
8 except ImportError:
9     HAS_REDIS = False
10 log = logging.getLogger(__name__)
11 __virtualname__ = "rediscluster"
12 def __virtual__():
13     if not HAS_REDIS:
14         return (
15             False,
16             "Could not use redis for tokens; "
17             "rediscluster python client is not installed.",
18         )
19     return __virtualname__
20 def</b></font> _redis_client(opts):
21     redis_host = opts.get("eauth_redis_host", "localhost")
22     redis_port = opts.get("eauth_redis_port", 6379)
23     try:
24         return rediscluster.StrictRedisCluster(
25             host=redis_host, port=redis_port, decode_responses=True
26         )
27     except rediscluster.exceptions.RedisClusterException as err:
28         log.warning(
29             "Failed to connect to redis at %s:%s - %s", redis_host, redis_port, err
30         )
31         return None
32 def mk_token(opts, tdata):
33     redis_client = _redis_client(opts)
34     if not redis_client:
35         return {}
36     hash_type = getattr(hashlib, opts.get("hash_type", "md5"))
37     tok = str(hash_type(os.urandom(512)).hexdigest())
38     try:
39         while redis_client.get(tok) is not None:
40             tok = str(hash_type(os.urandom(512)).hexdigest())
41     except Exception as err:  # pylint: disable=broad-except
42         log.warning(
43             "Authentication failure: cannot get token %s from redis: %s", tok, err
44         )
45         return {}
46     tdata["token"] = tok
47     try:
48         redis_client.set(tok, salt.payload.dumps(tdata))
49     except Exception as err:  # pylint: disable=broad-except
50         log.warning(
51             "Authentication failure: cannot save token %s to redis: %s", tok, err
52         )
53         return {}
54     return tdata
55 def get_token(opts, tok):
56     redis_client = _redis_client(opts)
57     if not redis_client:
58         return {}
59     try:
60         tdata = salt.payload.loads(redis_client.get(tok))
61         return tdata
62     except Exception as err:  # pylint: disable=broad-except
63         log.warning(
64             "Authentication failure: cannot get token %s from redis: %s", tok, err
65         )
66         return {}
67 def rm_token(opts, tok):
68     redis_client = _redis_client(opts)
69     if not redis_client:
70         return
71     try:
72         redis_client.delete(tok)
73         return {}
74     except Exception as err:  # pylint: disable=broad-except
75         log.warning("Could not remove token %s: %s", tok, err)
76 def list_tokens(opts):
77     ret = []
78     redis_client = _redis_client(opts)
79     if not redis_client:
80         return []
81     try:
82         return [k.decode("utf8") for k in redis_client.keys()]
83     except Exception as err:  # pylint: disable=broad-except
84         log.warning("Failed to list keys: %s", err)
85         return []
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>postgres_local_cache.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <a name="0"></a>
2 import logging
3 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import re
4 import sys
5 import salt.utils.jid
6 import salt.utils.json
7 try:
8     import psycopg2
9     HAS_POSTGRES = True
10 except ImportError:
11     HAS_POSTGRES = False
12 log = logging.getLogger(__name__)
13 __virtualname__ = "postgres_local_cache"
14 def __virtual__():
15     if not HAS_POSTGRES:
16         return (False, "Could not import psycopg2; postges_local_cache disabled")
17     return __virtualname__
18 def</b></font> _get_conn():
19     try:
20         conn = psycopg2.connect(
21             host=__opts__["master_job_cache.postgres.host"],
22             user=__opts__["master_job_cache.postgres.user"],
23             password=__opts__["master_job_cache.postgres.passwd"],
24             database=__opts__["master_job_cache.postgres.db"],
25             port=__opts__["master_job_cache.postgres.port"],
26         )
27     except psycopg2.OperationalError:
28         log.error("Could not connect to SQL server: %s", sys.exc_info()[0])
29         return None
30     return conn
31 def _close_conn(conn):
32     conn.commit()
33     conn.close()
34 def _format_job_instance(job):
35     ret = {
36         "Function": job.get("fun", "unknown-function"),
37         "Arguments": salt.utils.json.loads(job.get("arg", "[]")),
38         "Target": job.get("tgt", "unknown-target"),
39         "Target-type": job.get("tgt_type", "list"),
40         "User": job.get("user", "root"),
41     }
42     return ret
43 def _format_jid_instance(jid, job):
44     ret = _format_job_instance(job)
45     ret.update({"StartTime": salt.utils.jid.jid_to_time(jid)})
46     return ret
47 def _gen_jid(cur):
48     jid = salt.utils.jid.gen_jid(__opts__)
49     sql = """SELECT jid FROM jids WHERE jid = %s"""
50     cur.execute(sql, (jid,))
51     data = cur.fetchall()
52     if not data:
53         return jid
54     return None
55 def prep_jid(nocache=False, passed_jid=None):
56     conn = _get_conn()
57     if conn is None:
58         return None
59     cur = conn.cursor()
60     if passed_jid is None:
61         jid = _gen_jid(cur)
62     else:
63         jid = passed_jid
64     while not jid:
65         log.info("jid clash, generating a new one")
66         jid = _gen_jid(cur)
67     cur.close()
68     conn.close()
69     return jid
70 def returner(load):
71     conn = _get_conn()
72     if conn is None:
73         return None
74     cur = conn.cursor()
75     sql = """INSERT INTO salt_returns
76             (fun, jid, return, id, success)
77             VALUES (%s, %s, %s, %s, %s)"""
78     ret = str(load["return"])
79     job_ret = {"return": ret}
80     if "retcode" in load:
81         job_ret["retcode"] = load["retcode"]
82     if "success" in load:
83         job_ret["success"] = load["success"]
84     cur.execute(
85         sql,
86         (
87             load["fun"],
88             load["jid"],
89             salt.utils.json.dumps(job_ret),
90             load["id"],
91             load.get("success"),
92         ),
93     )
94     _close_conn(conn)
95 def event_return(events):
96     conn = _get_conn()
97     if conn is None:
98         return None
99     cur = conn.cursor()
100     for event in events:
101         tag = event.get("tag", "")
102         data = event.get("data", "")
103         sql = """INSERT INTO salt_events
104                 (tag, data, master_id)
105                 VALUES (%s, %s, %s)"""
106         cur.execute(sql, (tag, salt.utils.json.dumps(data), __opts__["id"]))
107     _close_conn(conn)
108 def save_load(jid, clear_load, minions=None):
109     jid = _escape_jid(jid)
110     conn = _get_conn()
111     if conn is None:
112         return None
113     cur = conn.cursor()
114     sql = (
115     )
116     cur.execute(
117         sql,
118         (
119             jid,
120             salt.utils.jid.jid_to_time(jid),
121             str(clear_load.get("tgt_type")),
122             str(clear_load.get("cmd")),
123             str(clear_load.get("tgt")),
124             str(clear_load.get("kwargs")),
125             str(clear_load.get("ret")),
126             str(clear_load.get("user")),
127             str(salt.utils.json.dumps(clear_load.get("arg"))),
128             str(clear_load.get("fun")),
129         ),
130     )
131     _close_conn(conn)
132 def save_minions(jid, minions, syndic_id=None):  # pylint: disable=unused-argument
133 def _escape_jid(jid):
134     jid = str(jid)
135     jid = re.sub(r"'*", "", jid)
136     return jid
137 def _build_dict(data):
138     result = {}
139     result["jid"] = data[0]
140     result["tgt_type"] = data[1]
141     result["cmd"] = data[2]
142     result["tgt"] = data[3]
143     result["kwargs"] = data[4]
144     result["ret"] = data[5]
145     result["user"] = data[6]
146     result["arg"] = data[7]
147     result["fun"] = data[8]
148     return result
149 def get_load(jid):
150     jid = _escape_jid(jid)
151     conn = _get_conn()
152     if conn is None:
153         return None
154     cur = conn.cursor()
155     sql = (
156     )
157     cur.execute(sql, (jid,))
158     data = cur.fetchone()
159     if data:
160         return _build_dict(data)
161     _close_conn(conn)
162     return {}
163 def get_jid(jid):
164     jid = _escape_jid(jid)
165     conn = _get_conn()
166     if conn is None:
167         return None
168     cur = conn.cursor()
169     sql = """SELECT id, return FROM salt_returns WHERE jid = %s"""
170     cur.execute(sql, (jid,))
171     data = cur.fetchall()
172     ret = {}
173     if data:
174         for minion, full_ret in data:
175             ret_data = salt.utils.json.loads(full_ret)
176             if not isinstance(ret_data, dict) or "return" not in ret_data:
177                 ret_data = {"return": ret_data}
178             ret[minion] = ret_data
179     _close_conn(conn)
180     return ret
181 def get_jids():
182     conn = _get_conn()
183     cur = conn.cursor()
184     sql = (
185     )
186     if __opts__["keep_jobs"] != 0:
187         sql = (
188             sql
189             + " WHERE started &gt; NOW() - INTERVAL '"
190             + str(__opts__["keep_jobs"])
191             + "' HOUR"
192         )
193     cur.execute(sql)
194     ret = {}
195     data = cur.fetchone()
196     while data:
197         data_dict = _build_dict(data)
198         ret[data_dict["jid"]] = _format_jid_instance(data_dict["jid"], data_dict)
199         data = cur.fetchone()
200     cur.close()
201     conn.close()
202     return ret
203 def clean_old_jobs():
204     return
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
