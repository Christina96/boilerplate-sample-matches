<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for template_test.py & test_mysql.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for template_test.py & test_mysql.py
      </h3>
      <h1 align="center">
        4.7%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>template_test.py (5.144291%)<TH>test_mysql.py (4.4372296%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match65600-0.html#0',2,'match65600-1.html#0',3)" NAME="0">(449-456)<TD><A HREF="javascript:ZweiFrames('match65600-0.html#0',2,'match65600-1.html#0',3)" NAME="0">(378-391)</A><TD ALIGN=center><FONT COLOR="#ff0000">14</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match65600-0.html#1',2,'match65600-1.html#1',3)" NAME="1">(444-449)<TD><A HREF="javascript:ZweiFrames('match65600-0.html#1',2,'match65600-1.html#1',3)" NAME="1">(352-364)</A><TD ALIGN=center><FONT COLOR="#ff0000">14</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match65600-0.html#2',2,'match65600-1.html#2',3)" NAME="2">(464-466)<TD><A HREF="javascript:ZweiFrames('match65600-0.html#2',2,'match65600-1.html#2',3)" NAME="2">(409-421)</A><TD ALIGN=center><FONT COLOR="#ec0000">13</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>template_test.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
# pylint: skip-file
from __future__ import absolute_import, division, print_function

import os
import sys
import traceback

from salt.ext.tornado.escape import utf8, native_str, to_unicode
from salt.ext.tornado.template import Template, DictLoader, ParseError, Loader
from salt.ext.tornado.test.util import unittest, is_coverage_running
from salt.ext.tornado.util import ObjectDict, unicode_type, PY3


class TemplateTest(unittest.TestCase):
    def test_simple(self):
        template = Template(&quot;Hello {{ name }}!&quot;)
        self.assertEqual(template.generate(name=&quot;Ben&quot;),
                         b&quot;Hello Ben!&quot;)

    def test_bytes(self):
        template = Template(&quot;Hello {{ name }}!&quot;)
        self.assertEqual(template.generate(name=utf8(&quot;Ben&quot;)),
                         b&quot;Hello Ben!&quot;)

    def test_expressions(self):
        template = Template(&quot;2 + 2 = {{ 2 + 2 }}&quot;)
        self.assertEqual(template.generate(), b&quot;2 + 2 = 4&quot;)

    def test_comment(self):
        template = Template(&quot;Hello{# TODO i18n #} {{ name }}!&quot;)
        self.assertEqual(template.generate(name=utf8(&quot;Ben&quot;)),
                         b&quot;Hello Ben!&quot;)

    def test_include(self):
        loader = DictLoader({
            &quot;index.html&quot;: '{% include &quot;header.html&quot; %}\nbody text',
            &quot;header.html&quot;: &quot;header text&quot;,
        })
        self.assertEqual(loader.load(&quot;index.html&quot;).generate(),
                         b&quot;header text\nbody text&quot;)

    def test_extends(self):
        loader = DictLoader({
            &quot;base.html&quot;: &quot;&quot;&quot;\
&lt;title&gt;{% block title %}default title{% end %}&lt;/title&gt;
&lt;body&gt;{% block body %}default body{% end %}&lt;/body&gt;
&quot;&quot;&quot;,
            &quot;page.html&quot;: &quot;&quot;&quot;\
{% extends &quot;base.html&quot; %}
{% block title %}page title{% end %}
{% block body %}page body{% end %}
&quot;&quot;&quot;,
        })
        self.assertEqual(loader.load(&quot;page.html&quot;).generate(),
                         b&quot;&lt;title&gt;page title&lt;/title&gt;\n&lt;body&gt;page body&lt;/body&gt;\n&quot;)

    def test_relative_load(self):
        loader = DictLoader({
            &quot;a/1.html&quot;: &quot;{% include '2.html' %}&quot;,
            &quot;a/2.html&quot;: &quot;{% include '../b/3.html' %}&quot;,
            &quot;b/3.html&quot;: &quot;ok&quot;,
        })
        self.assertEqual(loader.load(&quot;a/1.html&quot;).generate(),
                         b&quot;ok&quot;)

    def test_escaping(self):
        self.assertRaises(ParseError, lambda: Template(&quot;{{&quot;))
        self.assertRaises(ParseError, lambda: Template(&quot;{%&quot;))
        self.assertEqual(Template(&quot;{{!&quot;).generate(), b&quot;{{&quot;)
        self.assertEqual(Template(&quot;{%!&quot;).generate(), b&quot;{%&quot;)
        self.assertEqual(Template(&quot;{#!&quot;).generate(), b&quot;{#&quot;)
        self.assertEqual(Template(&quot;{{ 'expr' }} {{!jquery expr}}&quot;).generate(),
                         b&quot;expr {{jquery expr}}&quot;)

    def test_unicode_template(self):
        template = Template(utf8(u&quot;\u00e9&quot;))
        self.assertEqual(template.generate(), utf8(u&quot;\u00e9&quot;))

    def test_unicode_literal_expression(self):
        # Unicode literals should be usable in templates.  Note that this
        # test simulates unicode characters appearing directly in the
        # template file (with utf8 encoding), i.e. \u escapes would not
        # be used in the template file itself.
        if str is unicode_type:
            # python 3 needs a different version of this test since
            # 2to3 doesn't run on template internals
            template = Template(utf8(u'{{ &quot;\u00e9&quot; }}'))
        else:
            template = Template(utf8(u'{{ u&quot;\u00e9&quot; }}'))
        self.assertEqual(template.generate(), utf8(u&quot;\u00e9&quot;))

    def test_custom_namespace(self):
        loader = DictLoader({&quot;test.html&quot;: &quot;{{ inc(5) }}&quot;}, namespace={&quot;inc&quot;: lambda x: x + 1})
        self.assertEqual(loader.load(&quot;test.html&quot;).generate(), b&quot;6&quot;)

    def test_apply(self):
        def upper(s):
            return s.upper()
        template = Template(utf8(&quot;{% apply upper %}foo{% end %}&quot;))
        self.assertEqual(template.generate(upper=upper), b&quot;FOO&quot;)

    def test_unicode_apply(self):
        def upper(s):
            return to_unicode(s).upper()
        template = Template(utf8(u&quot;{% apply upper %}foo \u00e9{% end %}&quot;))
        self.assertEqual(template.generate(upper=upper), utf8(u&quot;FOO \u00c9&quot;))

    def test_bytes_apply(self):
        def upper(s):
            return utf8(to_unicode(s).upper())
        template = Template(utf8(u&quot;{% apply upper %}foo \u00e9{% end %}&quot;))
        self.assertEqual(template.generate(upper=upper), utf8(u&quot;FOO \u00c9&quot;))

    def test_if(self):
        template = Template(utf8(&quot;{% if x &gt; 4 %}yes{% else %}no{% end %}&quot;))
        self.assertEqual(template.generate(x=5), b&quot;yes&quot;)
        self.assertEqual(template.generate(x=3), b&quot;no&quot;)

    def test_if_empty_body(self):
        template = Template(utf8(&quot;{% if True %}{% else %}{% end %}&quot;))
        self.assertEqual(template.generate(), b&quot;&quot;)

    def test_try(self):
        template = Template(utf8(&quot;&quot;&quot;{% try %}
try{% set y = 1/x %}
{% except %}-except
{% else %}-else
{% finally %}-finally
{% end %}&quot;&quot;&quot;))
        self.assertEqual(template.generate(x=1), b&quot;\ntry\n-else\n-finally\n&quot;)
        self.assertEqual(template.generate(x=0), b&quot;\ntry-except\n-finally\n&quot;)

    def test_comment_directive(self):
        template = Template(utf8(&quot;{% comment blah blah %}foo&quot;))
        self.assertEqual(template.generate(), b&quot;foo&quot;)

    def test_break_continue(self):
        template = Template(utf8(&quot;&quot;&quot;\
{% for i in range(10) %}
    {% if i == 2 %}
        {% continue %}
    {% end %}
    {{ i }}
    {% if i == 6 %}
        {% break %}
    {% end %}
{% end %}&quot;&quot;&quot;))
        result = template.generate()
        # remove extraneous whitespace
        result = b''.join(result.split())
        self.assertEqual(result, b&quot;013456&quot;)

    def test_break_outside_loop(self):
        try:
            Template(utf8(&quot;{% break %}&quot;))
            raise Exception(&quot;Did not get expected exception&quot;)
        except ParseError:
            pass

    def test_break_in_apply(self):
        # This test verifies current behavior, although of course it would
        # be nice if apply didn't cause seemingly unrelated breakage
        try:
            Template(utf8(&quot;{% for i in [] %}{% apply foo %}{% break %}{% end %}{% end %}&quot;))
            raise Exception(&quot;Did not get expected exception&quot;)
        except ParseError:
            pass

    @unittest.skipIf(sys.version_info &gt;= division.getMandatoryRelease(),
                     'no testable future imports')
    def test_no_inherit_future(self):
        # This file has from __future__ import division...
        self.assertEqual(1 / 2, 0.5)
        # ...but the template doesn't
        template = Template('{{ 1 / 2 }}')
        self.assertEqual(template.generate(), '0')

    def test_non_ascii_name(self):
        if PY3 and is_coverage_running():
            try:
                os.fsencode(u&quot;t\u00e9st.html&quot;)
            except UnicodeEncodeError:
                self.skipTest(&quot;coverage tries to access unencodable filename&quot;)
        loader = DictLoader({u&quot;t\u00e9st.html&quot;: &quot;hello&quot;})
        self.assertEqual(loader.load(u&quot;t\u00e9st.html&quot;).generate(), b&quot;hello&quot;)


class StackTraceTest(unittest.TestCase):
    def test_error_line_number_expression(self):
        loader = DictLoader({&quot;test.html&quot;: &quot;&quot;&quot;one
two{{1/0}}
three
        &quot;&quot;&quot;})
        try:
            loader.load(&quot;test.html&quot;).generate()
            self.fail(&quot;did not get expected exception&quot;)
        except ZeroDivisionError:
            self.assertTrue(&quot;# test.html:2&quot; in traceback.format_exc())

    def test_error_line_number_directive(self):
        loader = DictLoader({&quot;test.html&quot;: &quot;&quot;&quot;one
two{%if 1/0%}
three{%end%}
        &quot;&quot;&quot;})
        try:
            loader.load(&quot;test.html&quot;).generate()
            self.fail(&quot;did not get expected exception&quot;)
        except ZeroDivisionError:
            self.assertTrue(&quot;# test.html:2&quot; in traceback.format_exc())

    def test_error_line_number_module(self):
        loader = DictLoader({
            &quot;base.html&quot;: &quot;{% module Template('sub.html') %}&quot;,
            &quot;sub.html&quot;: &quot;{{1/0}}&quot;,
        }, namespace={&quot;_tt_modules&quot;: ObjectDict(Template=lambda path, **kwargs: loader.load(path).generate(**kwargs))})
        try:
            loader.load(&quot;base.html&quot;).generate()
            self.fail(&quot;did not get expected exception&quot;)
        except ZeroDivisionError:
            exc_stack = traceback.format_exc()
            self.assertTrue('# base.html:1' in exc_stack)
            self.assertTrue('# sub.html:1' in exc_stack)

    def test_error_line_number_include(self):
        loader = DictLoader({
            &quot;base.html&quot;: &quot;{% include 'sub.html' %}&quot;,
            &quot;sub.html&quot;: &quot;{{1/0}}&quot;,
        })
        try:
            loader.load(&quot;base.html&quot;).generate()
            self.fail(&quot;did not get expected exception&quot;)
        except ZeroDivisionError:
            self.assertTrue(&quot;# sub.html:1 (via base.html:1)&quot; in
                            traceback.format_exc())

    def test_error_line_number_extends_base_error(self):
        loader = DictLoader({
            &quot;base.html&quot;: &quot;{{1/0}}&quot;,
            &quot;sub.html&quot;: &quot;{% extends 'base.html' %}&quot;,
        })
        try:
            loader.load(&quot;sub.html&quot;).generate()
            self.fail(&quot;did not get expected exception&quot;)
        except ZeroDivisionError:
            exc_stack = traceback.format_exc()
        self.assertTrue(&quot;# base.html:1&quot; in exc_stack)

    def test_error_line_number_extends_sub_error(self):
        loader = DictLoader({
            &quot;base.html&quot;: &quot;{% block 'block' %}{% end %}&quot;,
            &quot;sub.html&quot;: &quot;&quot;&quot;
{% extends 'base.html' %}
{% block 'block' %}
{{1/0}}
{% end %}
            &quot;&quot;&quot;})
        try:
            loader.load(&quot;sub.html&quot;).generate()
            self.fail(&quot;did not get expected exception&quot;)
        except ZeroDivisionError:
            self.assertTrue(&quot;# sub.html:4 (via base.html:1)&quot; in
                            traceback.format_exc())

    def test_multi_includes(self):
        loader = DictLoader({
            &quot;a.html&quot;: &quot;{% include 'b.html' %}&quot;,
            &quot;b.html&quot;: &quot;{% include 'c.html' %}&quot;,
            &quot;c.html&quot;: &quot;{{1/0}}&quot;,
        })
        try:
            loader.load(&quot;a.html&quot;).generate()
            self.fail(&quot;did not get expected exception&quot;)
        except ZeroDivisionError:
            self.assertTrue(&quot;# c.html:1 (via b.html:1, a.html:1)&quot; in
                            traceback.format_exc())


class ParseErrorDetailTest(unittest.TestCase):
    def test_details(self):
        loader = DictLoader({
            &quot;foo.html&quot;: &quot;\n\n{{&quot;,
        })
        with self.assertRaises(ParseError) as cm:
            loader.load(&quot;foo.html&quot;)
        self.assertEqual(&quot;Missing end expression }} at foo.html:3&quot;,
                         str(cm.exception))
        self.assertEqual(&quot;foo.html&quot;, cm.exception.filename)
        self.assertEqual(3, cm.exception.lineno)

    def test_custom_parse_error(self):
        # Make sure that ParseErrors remain compatible with their
        # pre-4.3 signature.
        self.assertEqual(&quot;asdf at None:0&quot;, str(ParseError(&quot;asdf&quot;)))


class AutoEscapeTest(unittest.TestCase):
    def setUp(self):
        self.templates = {
            &quot;escaped.html&quot;: &quot;{% autoescape xhtml_escape %}{{ name }}&quot;,
            &quot;unescaped.html&quot;: &quot;{% autoescape None %}{{ name }}&quot;,
            &quot;default.html&quot;: &quot;{{ name }}&quot;,

            &quot;include.html&quot;: &quot;&quot;&quot;\
escaped: {% include 'escaped.html' %}
unescaped: {% include 'unescaped.html' %}
default: {% include 'default.html' %}
&quot;&quot;&quot;,

            &quot;escaped_block.html&quot;: &quot;&quot;&quot;\
{% autoescape xhtml_escape %}\
{% block name %}base: {{ name }}{% end %}&quot;&quot;&quot;,
            &quot;unescaped_block.html&quot;: &quot;&quot;&quot;\
{% autoescape None %}\
{% block name %}base: {{ name }}{% end %}&quot;&quot;&quot;,

            # Extend a base template with different autoescape policy,
            # with and without overriding the base's blocks
            &quot;escaped_extends_unescaped.html&quot;: &quot;&quot;&quot;\
{% autoescape xhtml_escape %}\
{% extends &quot;unescaped_block.html&quot; %}&quot;&quot;&quot;,
            &quot;escaped_overrides_unescaped.html&quot;: &quot;&quot;&quot;\
{% autoescape xhtml_escape %}\
{% extends &quot;unescaped_block.html&quot; %}\
{% block name %}extended: {{ name }}{% end %}&quot;&quot;&quot;,
            &quot;unescaped_extends_escaped.html&quot;: &quot;&quot;&quot;\
{% autoescape None %}\
{% extends &quot;escaped_block.html&quot; %}&quot;&quot;&quot;,
            &quot;unescaped_overrides_escaped.html&quot;: &quot;&quot;&quot;\
{% autoescape None %}\
{% extends &quot;escaped_block.html&quot; %}\
{% block name %}extended: {{ name }}{% end %}&quot;&quot;&quot;,

            &quot;raw_expression.html&quot;: &quot;&quot;&quot;\
{% autoescape xhtml_escape %}\
expr: {{ name }}
raw: {% raw name %}&quot;&quot;&quot;,
        }

    def test_default_off(self):
        loader = DictLoader(self.templates, autoescape=None)
        name = &quot;Bobby &lt;table&gt;s&quot;
        self.assertEqual(loader.load(&quot;escaped.html&quot;).generate(name=name),
                         b&quot;Bobby &amp;lt;table&amp;gt;s&quot;)
        self.assertEqual(loader.load(&quot;unescaped.html&quot;).generate(name=name),
                         b&quot;Bobby &lt;table&gt;s&quot;)
        self.assertEqual(loader.load(&quot;default.html&quot;).generate(name=name),
                         b&quot;Bobby &lt;table&gt;s&quot;)

        self.assertEqual(loader.load(&quot;include.html&quot;).generate(name=name),
                         b&quot;escaped: Bobby &amp;lt;table&amp;gt;s\n&quot;
                         b&quot;unescaped: Bobby &lt;table&gt;s\n&quot;
                         b&quot;default: Bobby &lt;table&gt;s\n&quot;)

    def test_default_on(self):
        loader = DictLoader(self.templates, autoescape=&quot;xhtml_escape&quot;)
        name = &quot;Bobby &lt;table&gt;s&quot;
        self.assertEqual(loader.load(&quot;escaped.html&quot;).generate(name=name),
                         b&quot;Bobby &amp;lt;table&amp;gt;s&quot;)
        self.assertEqual(loader.load(&quot;unescaped.html&quot;).generate(name=name),
                         b&quot;Bobby &lt;table&gt;s&quot;)
        self.assertEqual(loader.load(&quot;default.html&quot;).generate(name=name),
                         b&quot;Bobby &amp;lt;table&amp;gt;s&quot;)

        self.assertEqual(loader.load(&quot;include.html&quot;).generate(name=name),
                         b&quot;escaped: Bobby &amp;lt;table&amp;gt;s\n&quot;
                         b&quot;unescaped: Bobby &lt;table&gt;s\n&quot;
                         b&quot;default: Bobby &amp;lt;table&amp;gt;s\n&quot;)

    def test_unextended_block(self):
        loader = DictLoader(self.templates)
        name = &quot;&lt;script&gt;&quot;
        self.assertEqual(loader.load(&quot;escaped_block.html&quot;).generate(name=name),
                         b&quot;base: &amp;lt;script&amp;gt;&quot;)
        self.assertEqual(loader.load(&quot;unescaped_block.html&quot;).generate(name=name),
                         b&quot;base: &lt;script&gt;&quot;)

    def test_extended_block(self):
        loader = DictLoader(self.templates)

        def render(name):
            return loader.load(name).generate(name=&quot;&lt;script&gt;&quot;)
        self.assertEqual(render(&quot;escaped_extends_unescaped.html&quot;),
                         b&quot;base: &lt;script&gt;&quot;)
        self.assertEqual(render(&quot;escaped_overrides_unescaped.html&quot;),
                         b&quot;extended: &amp;lt;script&amp;gt;&quot;)

        self.assertEqual(render(&quot;unescaped_extends_escaped.html&quot;),
                         b&quot;base: &amp;lt;script&amp;gt;&quot;)
        self.assertEqual(render(&quot;unescaped_overrides_escaped.html&quot;),
                         b&quot;extended: &lt;script&gt;&quot;)

    def test_raw_expression(self):
        loader = DictLoader(self.templates)

        def render(name):
            return loader.load(name).generate(name='&lt;&gt;&amp;&quot;')
        self.assertEqual(render(&quot;raw_expression.html&quot;),
                         b&quot;expr: &amp;lt;&amp;gt;&amp;amp;&amp;quot;\n&quot;
                         b&quot;raw: &lt;&gt;&amp;\&quot;&quot;)

    def test_custom_escape(self):
        loader = DictLoader({&quot;foo.py&quot;:
                             &quot;{% autoescape py_escape %}s = {{ name }}\n&quot;})

        def py_escape(s):
            self.assertEqual(type(s), bytes)
            return repr(native_str(s))

        def render(template, name):
            return loader.load(template).generate(py_escape=py_escape,
                                                  name=name)
        self.assertEqual(render(&quot;foo.py&quot;, &quot;&lt;html&gt;&quot;),
                         b&quot;s = '&lt;html&gt;'\n&quot;)
        self.assertEqual(render(&quot;foo.py&quot;, &quot;';sys.exit()&quot;),
                         b&quot;&quot;&quot;s = &quot;';sys.exit()&quot;\n&quot;&quot;&quot;)
        self.assertEqual(render(&quot;foo.py&quot;, [&quot;not a string&quot;]),
                         b&quot;&quot;&quot;s = &quot;['not a string']&quot;\n&quot;&quot;&quot;)

    def test_manual_minimize_whitespace(self):
        # Whitespace including newlines is allowed within template tags
        # and directives, and this is one way to avoid long lines while
        # keeping extra whitespace out of the rendered output.
        loader = DictLoader({'foo.txt': &quot;&quot;&quot;\
{% for i in items
  %}{% if i &gt; 0 %}, {% end %}{#
  #}{{i
  }}{% end
%}&quot;&quot;&quot;,
                             })
        self.assertEqual(loader.load(&quot;foo.txt&quot;).generate(items=range(5)),
                         b&quot;0, 1, 2, 3, 4&quot;)

    def test_whitespace_by_filename(self):
        # Default whitespace handling depends on the template filename.
        loader = DictLoader({
            &quot;foo.html&quot;: &quot;   \n\t\n asdf\t   &quot;,
            &quot;bar.js&quot;: &quot; \n\n\n\t qwer     &quot;,
            &quot;baz.txt&quot;: &quot;\t    zxcv\n\n&quot;,
            &quot;include.html&quot;: &quot;  {% include baz.txt %} \n &quot;,
            &quot;include.txt&quot;: &quot;\t\t{% include foo.html %}    &quot;,
<A NAME="1"></A>        })

        # HTML and JS files have whitespace compressed by default.
        self<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match65600-1.html#1',3,'match65600-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.assertEqual(loader.load(&quot;foo.html&quot;).generate(),
                         b&quot;\nasdf &quot;)
<A NAME="0"></A>        self.assertEqual(loader.load(&quot;bar.js&quot;).generate(),
                         b&quot;\nqwer &quot;)
        # TXT files do not.
        self.assertEqual(</B></FONT>loader<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match65600-1.html#0',3,'match65600-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.load(&quot;baz.txt&quot;).generate(),
                         b&quot;\t    zxcv\n\n&quot;)

        # Each file maintains its own status even when included in
        # a file of the other type.
        self.assertEqual(loader.load(&quot;include.html&quot;).generate(),
                         b&quot; \t    zxcv\n\n\n&quot;)
        self.assertEqual(loader.load(</B></FONT>&quot;include.txt&quot;).generate(),
                         b&quot;\t\t\nasdf     &quot;)

    def test_whitespace_by_loader(self):
        templates = {
<A NAME="2"></A>            &quot;foo.html&quot;: &quot;\t\tfoo\n\n&quot;,
            &quot;bar.txt&quot;: &quot;\t\tbar\n\n&quot;,
        }
        loader = DictLoader(templates, whitespace<FONT color="#980517"><A HREF="javascript:ZweiFrames('match65600-1.html#2',3,'match65600-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>='all')
        self.assertEqual(loader.load(&quot;foo.html&quot;).generate(), b&quot;\t\tfoo\n\n&quot;)
        self.assertEqual(loader.load(&quot;bar.txt&quot;).generate(</B></FONT>), b&quot;\t\tbar\n\n&quot;)

        loader = DictLoader(templates, whitespace='single')
        self.assertEqual(loader.load(&quot;foo.html&quot;).generate(), b&quot; foo\n&quot;)
        self.assertEqual(loader.load(&quot;bar.txt&quot;).generate(), b&quot; bar\n&quot;)

        loader = DictLoader(templates, whitespace='oneline')
        self.assertEqual(loader.load(&quot;foo.html&quot;).generate(), b&quot; foo &quot;)
        self.assertEqual(loader.load(&quot;bar.txt&quot;).generate(), b&quot; bar &quot;)

    def test_whitespace_directive(self):
        loader = DictLoader({
            &quot;foo.html&quot;: &quot;&quot;&quot;\
{% whitespace oneline %}
    {% for i in range(3) %}
        {{ i }}
    {% end %}
{% whitespace all %}
    pre\tformatted
&quot;&quot;&quot;})
        self.assertEqual(loader.load(&quot;foo.html&quot;).generate(),
                         b&quot;  0  1  2  \n    pre\tformatted\n&quot;)


class TemplateLoaderTest(unittest.TestCase):
    def setUp(self):
        self.loader = Loader(os.path.join(os.path.dirname(__file__), &quot;templates&quot;))

    def test_utf8_in_file(self):
        tmpl = self.loader.load(&quot;utf8.html&quot;)
        result = tmpl.generate()
        self.assertEqual(to_unicode(result).strip(), u&quot;H\u00e9llo&quot;)
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_mysql.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Mike Place (mp@saltstack.com)


    tests.unit.modules.mysql
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
&quot;&quot;&quot;


import logging

import pytest
import salt.modules.mysql as mysql
from tests.support.mock import MagicMock, call, mock_open, patch

try:
    import pymysql

    HAS_PYMYSQL = True
except ImportError:
    HAS_PYMYSQL = False


log = logging.getLogger(__name__)

__all_privileges__ = [
    &quot;ALTER&quot;,
    &quot;ALTER ROUTINE&quot;,
    &quot;BACKUP_ADMIN&quot;,
    &quot;BINLOG_ADMIN&quot;,
    &quot;CONNECTION_ADMIN&quot;,
    &quot;CREATE&quot;,
    &quot;CREATE ROLE&quot;,
    &quot;CREATE ROUTINE&quot;,
    &quot;CREATE TABLESPACE&quot;,
    &quot;CREATE TEMPORARY TABLES&quot;,
    &quot;CREATE USER&quot;,
    &quot;CREATE VIEW&quot;,
    &quot;DELETE&quot;,
    &quot;DROP&quot;,
    &quot;DROP ROLE&quot;,
    &quot;ENCRYPTION_KEY_ADMIN&quot;,
    &quot;EVENT&quot;,
    &quot;EXECUTE&quot;,
    &quot;FILE&quot;,
    &quot;GROUP_REPLICATION_ADMIN&quot;,
    &quot;INDEX&quot;,
    &quot;INSERT&quot;,
    &quot;LOCK TABLES&quot;,
    &quot;PERSIST_RO_VARIABLES_ADMIN&quot;,
    &quot;PROCESS&quot;,
    &quot;REFERENCES&quot;,
    &quot;RELOAD&quot;,
    &quot;REPLICATION CLIENT&quot;,
    &quot;REPLICATION SLAVE&quot;,
    &quot;REPLICATION_SLAVE_ADMIN&quot;,
    &quot;RESOURCE_GROUP_ADMIN&quot;,
    &quot;RESOURCE_GROUP_USER&quot;,
    &quot;ROLE_ADMIN&quot;,
    &quot;SELECT&quot;,
    &quot;SET_USER_ID&quot;,
    &quot;SHOW DATABASES&quot;,
    &quot;SHOW VIEW&quot;,
    &quot;SHUTDOWN&quot;,
    &quot;SUPER&quot;,
    &quot;SYSTEM_VARIABLES_ADMIN&quot;,
    &quot;TRIGGER&quot;,
    &quot;UPDATE&quot;,
    &quot;XA_RECOVER_ADMIN&quot;,
]

pytestmark = [
    pytest.mark.slow_test,
    pytest.mark.skipif(
        mysql.MySQLdb is None, reason=&quot;No python mysql client installed.&quot;
    ),
]


class MockMySQLConnect:
    def __init__(self, *args, **kwargs):
        self.args = args
        self.kwargs = kwargs

    def autocommit(self, *args, **kwards):
        return True


@pytest.fixture
def configure_loader_modules():
    return {mysql: {}}


def test_user_exists():
    &quot;&quot;&quot;
    Test to see if mysql module properly forms the MySQL query to see if a user exists

    Do it before test_user_create_when_user_exists mocks the user_exists call
    &quot;&quot;&quot;
    with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.10&quot;):
        _test_call(
            mysql.user_exists,
            {
                &quot;sql&quot;: (
                    &quot;SELECT User,Host FROM mysql.user WHERE &quot;
                    &quot;User = %(user)s AND Host = %(host)s AND &quot;
                    &quot;Password = PASSWORD(%(password)s)&quot;
                ),
                &quot;sql_args&quot;: {
                    &quot;host&quot;: &quot;localhost&quot;,
                    &quot;password&quot;: &quot;BLUECOW&quot;,
                    &quot;user&quot;: &quot;mytestuser&quot;,
                },
            },
            user=&quot;mytestuser&quot;,
            host=&quot;localhost&quot;,
            password=&quot;BLUECOW&quot;,
        )

    with patch.object(mysql, &quot;version&quot;, return_value=&quot;10.1.38-MariaDB&quot;):
        _test_call(
            mysql.user_exists,
            {
                &quot;sql&quot;: (
                    &quot;SELECT User,Host FROM mysql.user WHERE &quot;
                    &quot;User = %(user)s AND Host = %(host)s AND &quot;
                    &quot;Password = PASSWORD(%(password)s)&quot;
                ),
                &quot;sql_args&quot;: {
                    &quot;host&quot;: &quot;localhost&quot;,
                    &quot;password&quot;: &quot;BLUECOW&quot;,
                    &quot;user&quot;: &quot;mytestuser&quot;,
                },
            },
            user=&quot;mytestuser&quot;,
            host=&quot;localhost&quot;,
            password=&quot;BLUECOW&quot;,
        )

    with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.11&quot;):
        _test_call(
            mysql.user_exists,
            {
                &quot;sql&quot;: (
                    &quot;SELECT User,Host FROM mysql.user WHERE &quot;
                    &quot;User = %(user)s AND Host = %(host)s&quot;
                ),
                &quot;sql_args&quot;: {&quot;host&quot;: &quot;localhost&quot;, &quot;user&quot;: &quot;mytestuser&quot;},
            },
            user=&quot;mytestuser&quot;,
            host=&quot;localhost&quot;,
            password=&quot;BLUECOW&quot;,
        )

    with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.11&quot;):
        with patch.object(
            mysql,
            &quot;__get_auth_plugin&quot;,
            MagicMock(return_value=&quot;mysql_native_password&quot;),
        ):
            _test_call(
                mysql.user_exists,
                {
                    &quot;sql&quot;: (
                        &quot;SELECT User,Host FROM mysql.user WHERE &quot;
                        &quot;User = %(user)s AND Host = %(host)s AND &quot;
                        &quot;Password = %(password)s&quot;
                    ),
                    &quot;sql_args&quot;: {
                        &quot;host&quot;: &quot;%&quot;,
                        &quot;password&quot;: &quot;*1A01CF8FBE6425398935FB90359AD8B817399102&quot;,
                        &quot;user&quot;: &quot;mytestuser&quot;,
                    },
                },
                user=&quot;mytestuser&quot;,
                host=&quot;%&quot;,
                password=&quot;BLUECOW&quot;,
            )

    with patch.object(mysql, &quot;version&quot;, return_value=&quot;10.2.21-MariaDB&quot;):
        _test_call(
            mysql.user_exists,
            {
                &quot;sql&quot;: (
                    &quot;SELECT User,Host FROM mysql.user WHERE &quot;
                    &quot;User = %(user)s AND Host = %(host)s AND &quot;
                    &quot;Password = PASSWORD(%(password)s)&quot;
                ),
                &quot;sql_args&quot;: {
                    &quot;host&quot;: &quot;localhost&quot;,
                    &quot;password&quot;: &quot;BLUECOW&quot;,
                    &quot;user&quot;: &quot;mytestuser&quot;,
                },
            },
            user=&quot;mytestuser&quot;,
            host=&quot;localhost&quot;,
            password=&quot;BLUECOW&quot;,
        )

    with patch.object(
        mysql, &quot;version&quot;, side_effect=[&quot;&quot;, &quot;10.2.21-MariaDB&quot;, &quot;10.2.21-MariaDB&quot;]
    ):
        _test_call(
            mysql.user_exists,
            {
                &quot;sql&quot;: (
                    &quot;SELECT User,Host FROM mysql.user WHERE &quot;
                    &quot;User = %(user)s AND Host = %(host)s AND &quot;
                    &quot;Password = PASSWORD(%(password)s)&quot;
                ),
                &quot;sql_args&quot;: {
                    &quot;host&quot;: &quot;localhost&quot;,
                    &quot;password&quot;: &quot;new_pass&quot;,
                    &quot;user&quot;: &quot;root&quot;,
                },
            },
            user=&quot;root&quot;,
            host=&quot;localhost&quot;,
            password=&quot;new_pass&quot;,
            connection_user=&quot;root&quot;,
            connection_pass=&quot;old_pass&quot;,
        )

    # test_user_create_when_user_exists():
    # ensure we don't try to create a user when one already exists
    # mock the version of MySQL
    with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.10&quot;):
        with patch.object(mysql, &quot;user_exists&quot;, MagicMock(return_value=True)):
            with patch.dict(mysql.__salt__, {&quot;config.option&quot;: MagicMock()}):
                ret = mysql.user_create(&quot;testuser&quot;)
                assert not ret

    # test_user_create_when_user_exists():
    # ensure we don't try to create a user when one already exists
    # mock the version of MySQL
    with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.11&quot;):
        with patch.object(mysql, &quot;user_exists&quot;, MagicMock(return_value=True)):
            with patch.object(mysql, &quot;verify_login&quot;, MagicMock(return_value=True)):
                with patch.dict(mysql.__salt__, {&quot;config.option&quot;: MagicMock()}):
                    ret = mysql.user_create(&quot;testuser&quot;)
                    assert not False


def test_user_create():
    &quot;&quot;&quot;
    Test the creation of a MySQL user in mysql exec module
    &quot;&quot;&quot;
    with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.10&quot;):
        with patch.object(
            mysql,
            &quot;__get_auth_plugin&quot;,
            MagicMock(return_value=&quot;mysql_native_password&quot;),
        ):
            _test_call(
                mysql.user_create,
                {
                    &quot;sql&quot;: &quot;CREATE USER %(user)s@%(host)s IDENTIFIED BY %(password)s&quot;,
                    &quot;sql_args&quot;: {
                        &quot;password&quot;: &quot;BLUECOW&quot;,
                        &quot;user&quot;: &quot;testuser&quot;,
                        &quot;host&quot;: &quot;localhost&quot;,
                    },
                },
                &quot;testuser&quot;,
                password=&quot;BLUECOW&quot;,
            )

    with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.11&quot;):
        with patch.object(
            mysql,
            &quot;__get_auth_plugin&quot;,
            MagicMock(return_value=&quot;mysql_native_password&quot;),
        ):
            _test_call(
                mysql.user_create,
                {
                    &quot;sql&quot;: &quot;CREATE USER %(user)s@%(host)s IDENTIFIED WITH %(auth_plugin)s BY %(password)s&quot;,
                    &quot;sql_args&quot;: {
                        &quot;password&quot;: &quot;BLUECOW&quot;,
                        &quot;auth_plugin&quot;: &quot;mysql_native_password&quot;,
                        &quot;user&quot;: &quot;testuser&quot;,
                        &quot;host&quot;: &quot;localhost&quot;,
                    },
                },
                &quot;testuser&quot;,
                password=&quot;BLUECOW&quot;,
            )

    # Test creating a user with passwordless=True and unix_socket=True
    with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.10&quot;):
        with patch.object(mysql, &quot;plugin_status&quot;, MagicMock(return_value=&quot;ACTIVE&quot;)):
            _test_call(
                mysql.user_create,
                {
                    &quot;sql&quot;: &quot;CREATE USER %(user)s@%(host)s IDENTIFIED WITH auth_socket&quot;,
                    &quot;sql_args&quot;: {&quot;user&quot;: &quot;testuser&quot;, &quot;host&quot;: &quot;localhost&quot;},
                },
                &quot;testuser&quot;,
                allow_passwordless=True,
                unix_socket=True,
            )

    with patch.object(mysql, &quot;version&quot;, return_value=&quot;10.2.21-MariaDB&quot;):
        with patch.object(mysql, &quot;plugin_status&quot;, MagicMock(return_value=&quot;ACTIVE&quot;)):
            _test_call(
                mysql.user_create,
                {
                    &quot;sql&quot;: &quot;CREATE USER %(user)s@%(host)s IDENTIFIED VIA unix_socket&quot;,
                    &quot;sql_args&quot;: {&quot;user&quot;: &quot;testuser&quot;, &quot;host&quot;: &quot;localhost&quot;},
                },
                &quot;testuser&quot;,
                allow_passwordless=True,
                unix_socket=True,
            )

    with patch.object(mysql, &quot;version&quot;, side_effect=[&quot;&quot;, &quot;8.0.10&quot;, &quot;8.0.10&quot;]):
        with patch.object(
            mysql, &quot;user_exists&quot;, MagicMock(return_value=False)
        ), patch.object(
            mysql,
            &quot;__get_auth_plugin&quot;,
            MagicMock(return_value=&quot;mysql_native_password&quot;),
        ):
            _test_call(
                mysql.user_create,
                {
                    &quot;sql&quot;: &quot;CREATE USER %(user)s@%(host)s IDENTIFIED BY %(password)s&quot;,
                    &quot;sql_args&quot;: {
                        &quot;password&quot;: &quot;new_pass&quot;,
                        &quot;user&quot;: &quot;root&quot;,
                        &quot;host&quot;: &quot;localhost&quot;,
                    },
                },
                &quot;root&quot;,
                password=&quot;new_pass&quot;,
                connection_user=&quot;root&quot;,
                connection_pass=&quot;old_pass&quot;,
            )


def test_user_chpass():
    &quot;&quot;&quot;
    Test changing a MySQL user password in mysql exec module
    &quot;&quot;&quot;
    connect_mock = MagicMock()
    with patch.object(mysql, &quot;_connect&quot;, connect_mock):
        with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.10&quot;):
            with patch.object(mysql, &quot;user_exists&quot;, MagicMock(return_value=True)):
<A NAME="1"></A>                with patch.dict(mysql.__salt__, {&quot;config.option&quot;: MagicMock()}):
                    mysql.user_chpass(&quot;testuser&quot;, password=&quot;BLUECOW&quot;)
                    calls = (
                        <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match65600-0.html#1',2,'match65600-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>call()
                        .cursor()
                        .execute(
                            &quot;UPDATE mysql.user SET Password=PASSWORD(%(password)s) WHERE User=%(user)s AND Host = %(host)s;&quot;,
                            {
                                &quot;password&quot;: &quot;BLUECOW&quot;,
                                &quot;user&quot;: &quot;testuser&quot;,
                                &quot;host&quot;: &quot;localhost&quot;,
                            },
                        ),
                        call().cursor().execute(&quot;FLUSH PRIVILEGES;&quot;),
                    )
                    connect_mock.assert_has_calls(</B></FONT>calls, any_order=True)

    connect_mock = MagicMock()
    with patch.object(mysql, &quot;_connect&quot;, connect_mock):
        with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.11&quot;):
            with patch.object(mysql, &quot;user_exists&quot;, MagicMock(return_value=True)):
                with patch.object(
                    mysql,
                    &quot;__get_auth_plugin&quot;,
                    MagicMock(return_value=&quot;mysql_native_password&quot;),
                ):
<A NAME="0"></A>                    with patch.dict(mysql.__salt__, {&quot;config.option&quot;: MagicMock()}):
                        mysql.user_chpass(&quot;testuser&quot;, password=&quot;BLUECOW&quot;)
                        calls = (
                            <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match65600-0.html#0',2,'match65600-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>call()
                            .cursor()
                            .execute(
                                &quot;ALTER USER %(user)s@%(host)s IDENTIFIED WITH %(auth_plugin)s BY %(password)s;&quot;,
                                {
                                    &quot;password&quot;: &quot;BLUECOW&quot;,
                                    &quot;user&quot;: &quot;testuser&quot;,
                                    &quot;host&quot;: &quot;localhost&quot;,
                                    &quot;auth_plugin&quot;: &quot;mysql_native_password&quot;,
                                },
                            ),
                            call().cursor().execute(&quot;FLUSH PRIVILEGES;&quot;),
                        )
                        connect_mock.assert_has_calls(</B></FONT>calls, any_order=True)

    connect_mock = MagicMock()
    with patch.object(mysql, &quot;_connect&quot;, connect_mock):
        with patch.object(mysql, &quot;version&quot;, side_effect=[&quot;&quot;, &quot;8.0.11&quot;, &quot;8.0.11&quot;]):
            with patch.object(mysql, &quot;user_exists&quot;, MagicMock(return_value=True)):
                with patch.object(
                    mysql,
                    &quot;__get_auth_plugin&quot;,
                    MagicMock(return_value=&quot;mysql_native_password&quot;),
                ):
                    with patch.dict(mysql.__salt__, {&quot;config.option&quot;: MagicMock()}):
                        mysql.user_chpass(
                            &quot;root&quot;,
                            password=&quot;new_pass&quot;,
<A NAME="2"></A>                            connection_user=&quot;root&quot;,
                            connection_pass=&quot;old_pass&quot;,
                        )
                        calls <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match65600-0.html#2',2,'match65600-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= (
                            call()
                            .cursor()
                            .execute(
                                &quot;ALTER USER %(user)s@%(host)s IDENTIFIED WITH %(auth_plugin)s BY %(password)s;&quot;,
                                {
                                    &quot;password&quot;: &quot;new_pass&quot;,
                                    &quot;user&quot;: &quot;root&quot;,
                                    &quot;host&quot;: &quot;localhost&quot;,
                                    &quot;auth_plugin&quot;: &quot;mysql_native_password&quot;,
                                },
                            ),
                            call().cursor().execute(</B></FONT>&quot;FLUSH PRIVILEGES;&quot;),
                        )
                        connect_mock.assert_has_calls(calls, any_order=True)


def test_user_remove():
    &quot;&quot;&quot;
    Test the removal of a MySQL user in mysql exec module
    &quot;&quot;&quot;
    with patch.object(mysql, &quot;user_exists&quot;, MagicMock(return_value=True)):
        _test_call(
            mysql.user_remove,
            {
                &quot;sql&quot;: &quot;DROP USER %(user)s@%(host)s&quot;,
                &quot;sql_args&quot;: {&quot;user&quot;: &quot;testuser&quot;, &quot;host&quot;: &quot;localhost&quot;},
            },
            &quot;testuser&quot;,
        )


def test_db_check():
    &quot;&quot;&quot;
    Test MySQL db check function in mysql exec module
    &quot;&quot;&quot;
    _test_call(
        mysql.db_check,
        &quot;CHECK TABLE `test``'\&quot; db`.`my``'\&quot; table`&quot;,
        &quot;test`'\&quot; db&quot;,
        &quot;my`'\&quot; table&quot;,
    )


def test_db_repair():
    &quot;&quot;&quot;
    Test MySQL db repair function in mysql exec module
    &quot;&quot;&quot;
    _test_call(
        mysql.db_repair,
        &quot;REPAIR TABLE `test``'\&quot; db`.`my``'\&quot; table`&quot;,
        &quot;test`'\&quot; db&quot;,
        &quot;my`'\&quot; table&quot;,
    )


def test_db_optimize():
    &quot;&quot;&quot;
    Test MySQL db optimize function in mysql exec module
    &quot;&quot;&quot;
    _test_call(
        mysql.db_optimize,
        &quot;OPTIMIZE TABLE `test``'\&quot; db`.`my``'\&quot; table`&quot;,
        &quot;test`'\&quot; db&quot;,
        &quot;my`'\&quot; table&quot;,
    )


def test_db_remove():
    &quot;&quot;&quot;
    Test MySQL db remove function in mysql exec module
    &quot;&quot;&quot;
    with patch.object(mysql, &quot;db_exists&quot;, MagicMock(return_value=True)):
        _test_call(mysql.db_remove, &quot;DROP DATABASE `test``'\&quot; db`;&quot;, &quot;test`'\&quot; db&quot;)


def test_db_tables():
    &quot;&quot;&quot;
    Test MySQL db_tables function in mysql exec module
    &quot;&quot;&quot;
    with patch.object(mysql, &quot;db_exists&quot;, MagicMock(return_value=True)):
        _test_call(mysql.db_tables, &quot;SHOW TABLES IN `test``'\&quot; db`&quot;, &quot;test`'\&quot; db&quot;)


def test_db_exists():
    &quot;&quot;&quot;
    Test MySQL db_exists function in mysql exec module
    &quot;&quot;&quot;
    _test_call(
        mysql.db_exists,
        {
            &quot;sql&quot;: &quot;SHOW DATABASES LIKE %(dbname)s;&quot;,
            &quot;sql_args&quot;: {&quot;dbname&quot;: r&quot;&quot;&quot;test%_`&quot; db&quot;&quot;&quot;},
        },
        'test%_`&quot; db',
    )


def test_db_create():
    &quot;&quot;&quot;
    Test MySQL db_create function in mysql exec module
    &quot;&quot;&quot;
    _test_call(
        mysql.db_create,
        &quot;CREATE DATABASE IF NOT EXISTS `test``'\&quot; db`;&quot;,
        &quot;test`'\&quot; db&quot;,
    )


def test_alter_db():
    &quot;&quot;&quot;
    Test MySQL alter_db function in mysql exec module
    &quot;&quot;&quot;
    mock_get_db = {
        &quot;character_set&quot;: &quot;utf8&quot;,
        &quot;collate&quot;: &quot;utf8_unicode_ci&quot;,
        &quot;name&quot;: &quot;my_test&quot;,
    }
    mock = MagicMock(return_value=mock_get_db)
    with patch.object(mysql, &quot;db_get&quot;, return_value=mock) as mock_db_get:
        _test_call(
            mysql.alter_db,
            &quot;ALTER DATABASE `my_test` CHARACTER SET utf8 COLLATE utf8_unicode_ci;&quot;,
            &quot;my_test&quot;,
            &quot;utf8&quot;,
            &quot;utf8_unicode_ci&quot;,
        )


def test_user_list():
    &quot;&quot;&quot;
    Test MySQL user_list function in mysql exec module
    &quot;&quot;&quot;
    _test_call(mysql.user_list, &quot;SELECT User,Host FROM mysql.user&quot;)


def test_user_info():
    &quot;&quot;&quot;
    Test to see if the mysql execution module correctly forms the SQL for information on a MySQL user.
    &quot;&quot;&quot;
    _test_call(
        mysql.user_info,
        {
            &quot;sql&quot;: &quot;SELECT * FROM mysql.user WHERE User = %(user)s AND Host = %(host)s&quot;,
            &quot;sql_args&quot;: {&quot;host&quot;: &quot;localhost&quot;, &quot;user&quot;: &quot;mytestuser&quot;},
        },
        &quot;mytestuser&quot;,
    )


def test_user_grants():
    &quot;&quot;&quot;
    Test to ensure the mysql user_grants function returns properly formed SQL for a basic query
    &quot;&quot;&quot;
    with patch.object(mysql, &quot;user_exists&quot;, MagicMock(return_value=True)):
        _test_call(
            mysql.user_grants,
            {
                &quot;sql&quot;: &quot;SHOW GRANTS FOR %(user)s@%(host)s&quot;,
                &quot;sql_args&quot;: {&quot;host&quot;: &quot;localhost&quot;, &quot;user&quot;: &quot;testuser&quot;},
            },
            &quot;testuser&quot;,
        )


def test_grant_exists_true():
    &quot;&quot;&quot;
    Test to ensure that we can find a grant that exists
    &quot;&quot;&quot;
    mock_grants = [
        &quot;GRANT USAGE ON *.* TO 'testuser'@'%'&quot;,
        &quot;GRANT SELECT, INSERT, UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'&quot;,
        &quot;GRANT SELECT(column1,column2) ON `testdb`.`testtableone` TO 'testuser'@'%'&quot;,
        &quot;GRANT SELECT(column1,column2), INSERT(column1,column2) ON `testdb`.`testtableone` TO 'testuser'@'%'&quot;,
        &quot;GRANT SELECT(column1,column2), UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'&quot;,
        &quot;GRANT SELECT ON `testdb`.`testtabletwo` TO 'testuser'@'%'&quot;,
        &quot;GRANT SELECT ON `testdb`.`testtablethree` TO 'testuser'@'%'&quot;,
    ]
    with patch.object(mysql, &quot;version&quot;, return_value=&quot;5.6.41&quot;):
        mock = MagicMock(return_value=mock_grants)
        with patch.object(
            mysql, &quot;user_grants&quot;, return_value=mock_grants
        ) as mock_user_grants:
            ret = mysql.grant_exists(
                &quot;SELECT, INSERT, UPDATE&quot;, &quot;testdb.testtableone&quot;, &quot;testuser&quot;, &quot;%&quot;
            )
            assert ret


def test_grant_exists_false():
    &quot;&quot;&quot;
    Test to ensure that we don't find a grant that doesn't exist
    &quot;&quot;&quot;
    mock_grants = [
        &quot;GRANT USAGE ON *.* TO 'testuser'@'%'&quot;,
        &quot;GRANT SELECT, INSERT, UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'&quot;,
        &quot;GRANT SELECT(column1,column2) ON `testdb`.`testtableone` TO 'testuser'@'%'&quot;,
        &quot;GRANT SELECT(column1,column2), UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'&quot;,
        &quot;GRANT SELECT ON `testdb`.`testtablethree` TO 'testuser'@'%'&quot;,
    ]
    with patch.object(mysql, &quot;version&quot;, return_value=&quot;5.6.41&quot;):
        mock = MagicMock(return_value=mock_grants)
        with patch.object(
            mysql, &quot;user_grants&quot;, return_value=mock_grants
        ) as mock_user_grants:
            ret = mysql.grant_exists(&quot;SELECT&quot;, &quot;testdb.testtabletwo&quot;, &quot;testuser&quot;, &quot;%&quot;)
            assert not ret


def test_grant_exists_all():
    &quot;&quot;&quot;
    Test to ensure that we can find a grant that exists
    &quot;&quot;&quot;
    mock_grants = [&quot;GRANT ALL PRIVILEGES ON testdb.testtableone TO `testuser`@`%`&quot;]
    with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.10&quot;):
        mock = MagicMock(return_value=mock_grants)
        with patch.object(
            mysql, &quot;user_grants&quot;, return_value=mock_grants
        ) as mock_user_grants:
            ret = mysql.grant_exists(&quot;ALL&quot;, &quot;testdb.testtableone&quot;, &quot;testuser&quot;, &quot;%&quot;)
            assert ret

    with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.10&quot;):
        mock = MagicMock(return_value=mock_grants)
        with patch.object(
            mysql, &quot;user_grants&quot;, return_value=mock_grants
        ) as mock_user_grants:
            ret = mysql.grant_exists(
                &quot;all privileges&quot;, &quot;testdb.testtableone&quot;, &quot;testuser&quot;, &quot;%&quot;
            )
            assert ret

    mock_grants = [&quot;GRANT ALL PRIVILEGES ON testdb.testtableone TO `testuser`@`%`&quot;]
    with patch.object(mysql, &quot;version&quot;, return_value=&quot;5.6.41&quot;):
        mock = MagicMock(return_value=mock_grants)
        with patch.object(
            mysql, &quot;user_grants&quot;, return_value=mock_grants
        ) as mock_user_grants:
            ret = mysql.grant_exists(
                &quot;ALL PRIVILEGES&quot;, &quot;testdb.testtableone&quot;, &quot;testuser&quot;, &quot;%&quot;
            )
            assert ret

    mock_grants = [
        &quot;GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE, CREATE ROLE, DROP ROLE ON *.* TO `testuser`@`%`&quot;,
        &quot;GRANT BACKUP_ADMIN,BINLOG_ADMIN,CONNECTION_ADMIN,ENCRYPTION_KEY_ADMIN,GROUP_REPLICATION_ADMIN,PERSIST_RO_VARIABLES_ADMIN,REPLICATION_SLAVE_ADMIN,RESOURCE_GROUP_ADMIN,RESOURCE_GROUP_USER,ROLE_ADMIN,SET_USER_ID,SYSTEM_VARIABLES_ADMIN,XA_RECOVER_ADMIN ON *.* TO `testuser`@`%`&quot;,
    ]
    with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.10&quot;):
        mock = MagicMock(return_value=mock_grants)
        with patch.object(
            mysql, &quot;user_grants&quot;, return_value=mock_grants
        ) as mock_user_grants:
            ret = mysql.grant_exists(&quot;ALL&quot;, &quot;*.*&quot;, &quot;testuser&quot;, &quot;%&quot;)
            assert ret

    with patch.object(mysql, &quot;version&quot;, return_value=&quot;8.0.10&quot;):
        mock = MagicMock(return_value=mock_grants)
        with patch.object(
            mysql, &quot;user_grants&quot;, return_value=mock_grants
        ) as mock_user_grants:
            ret = mysql.grant_exists(&quot;all privileges&quot;, &quot;*.*&quot;, &quot;testuser&quot;, &quot;%&quot;)
            assert ret


@pytest.mark.skipif(True, reason=&quot;TODO: Mock up user_grants()&quot;)
def test_grant_add():
    &quot;&quot;&quot;
    Test grant_add function in mysql exec module
    &quot;&quot;&quot;
    _test_call(
        mysql.grant_add,
        &quot;&quot;,
        &quot;SELECT,INSERT,UPDATE&quot;,
        &quot;database.*&quot;,
        &quot;frank&quot;,
        &quot;localhost&quot;,
    )


@pytest.mark.skipif(True, reason=&quot;TODO: Mock up user_grants()&quot;)
def test_grant_revoke():
    &quot;&quot;&quot;
    Test grant revoke in mysql exec module
    &quot;&quot;&quot;
    _test_call(
        mysql.grant_revoke,
        &quot;&quot;,
        &quot;SELECT,INSERT,UPDATE&quot;,
        &quot;database.*&quot;,
        &quot;frank&quot;,
        &quot;localhost&quot;,
    )


def test_processlist():
    &quot;&quot;&quot;
    Test processlist function in mysql exec module
    &quot;&quot;&quot;
    _test_call(mysql.processlist, &quot;SHOW FULL PROCESSLIST&quot;)


def test_get_master_status():
    &quot;&quot;&quot;
    Test get_master_status in the mysql execution module
    &quot;&quot;&quot;
    _test_call(mysql.get_master_status, &quot;SHOW MASTER STATUS&quot;)


def test_get_slave_status():
    &quot;&quot;&quot;
    Test get_slave_status in the mysql execution module
    &quot;&quot;&quot;
    _test_call(mysql.get_slave_status, &quot;SHOW SLAVE STATUS&quot;)


def test_get_slave_status_bad_server():
    &quot;&quot;&quot;
    Test get_slave_status in the mysql execution module, simulating a broken server
    &quot;&quot;&quot;
    connect_mock = MagicMock(return_value=None)
    with patch.object(mysql, &quot;_connect&quot;, connect_mock):
        with patch.dict(mysql.__salt__, {&quot;config.option&quot;: MagicMock()}):
            rslt = mysql.get_slave_status()
            connect_mock.assert_has_calls([call()])
            assert rslt == []


@pytest.mark.skipif(
    True, reason=&quot;MySQL module claims this function is not ready for production&quot;
)
def test_free_slave():
    pass


def test_query():
    _test_call(mysql.query, &quot;SELECT * FROM testdb&quot;, &quot;testdb&quot;, &quot;SELECT * FROM testdb&quot;)


@pytest.mark.skipif(not HAS_PYMYSQL, reason=&quot;Could not import pymysql&quot;)
def test_query_error():
    connect_mock = MagicMock()
    with patch.object(mysql, &quot;_connect&quot;, connect_mock):
        with patch.dict(mysql.__salt__, {&quot;config.option&quot;: MagicMock()}):
            # Use the OperationalError from the salt mysql module because that
            # exception can come from either MySQLdb or pymysql
            side_effect = mysql.OperationalError(9999, &quot;Something Went Wrong&quot;)
            with patch.object(mysql, &quot;_execute&quot;, MagicMock(side_effect=side_effect)):
                mysql.query(&quot;testdb&quot;, &quot;SELECT * FROM testdb&quot;)
        assert &quot;mysql.error&quot; in mysql.__context__
        expected = &quot;MySQL Error 9999: Something Went Wrong&quot;
        assert mysql.__context__[&quot;mysql.error&quot;] == expected


def test_plugin_add():
    &quot;&quot;&quot;
    Test the adding/installing a MySQL / MariaDB plugin
    &quot;&quot;&quot;
    with patch.object(mysql, &quot;plugin_status&quot;, MagicMock(return_value=&quot;&quot;)):
        _test_call(
            mysql.plugin_add,
            'INSTALL PLUGIN auth_socket SONAME &quot;auth_socket.so&quot;',
            &quot;auth_socket&quot;,
        )


def test_plugin_remove():
    &quot;&quot;&quot;
    Test the removing/uninstalling a MySQL / MariaDB plugin
    &quot;&quot;&quot;
    with patch.object(mysql, &quot;plugin_status&quot;, MagicMock(return_value=&quot;ACTIVE&quot;)):
        _test_call(
            mysql.plugin_remove,
            &quot;UNINSTALL PLUGIN auth_socket&quot;,
            &quot;auth_socket&quot;,
        )


def test_plugin_status():
    &quot;&quot;&quot;
    Test checking the status of a MySQL / MariaDB plugin
    &quot;&quot;&quot;
    _test_call(
        mysql.plugin_status,
        {
            &quot;sql&quot;: &quot;SELECT PLUGIN_STATUS FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = %(name)s&quot;,
            &quot;sql_args&quot;: {&quot;name&quot;: &quot;auth_socket&quot;},
        },
        &quot;auth_socket&quot;,
    )


def test_sanitize_comment():
    &quot;&quot;&quot;
    Test comment sanitization
    &quot;&quot;&quot;
    input_data = &quot;&quot;&quot;/*
    multiline
    comment
    */
    CREATE TABLE test_update (a VARCHAR(25)); # end of line comment
    # example comment
    insert into test_update values (&quot;some #hash value&quot;);            -- ending comment
    insert into test_update values (&quot;crazy -- not comment&quot;); -- another ending comment
    -- another comment type
    &quot;&quot;&quot;
    expected_response = &quot;&quot;&quot;CREATE TABLE test_update (a VARCHAR(25));

insert into test_update values (&quot;some #hash value&quot;);
insert into test_update values (&quot;crazy -- not comment&quot;);

&quot;&quot;&quot;
    output = mysql._sanitize_comments(input_data)
    assert output == expected_response

    input_data = &quot;&quot;&quot;-- --------------------------------------------------------
                    -- SQL Commands to set up the pmadb as described in the documentation.
                    --
                    -- This file is meant for use with MySQL 5 and above!
                    --
                    -- This script expects the user pma to already be existing. If we would put a
                    -- line here to create them too many users might just use this script and end
                    -- up with having the same password for the controluser.
                    --
                    -- This user &quot;pma&quot; must be defined in config.inc.php (controluser/controlpass)
                    --
                    -- Please don't forget to set up the tablenames in config.inc.php
                    --
                    -- --------------------------------------------------------
                    --
                    CREATE DATABASE IF NOT EXISTS `phpmyadmin`
                      DEFAULT CHARACTER SET utf8 COLLATE utf8_bin;
                    USE phpmyadmin;
    &quot;&quot;&quot;

    expected_response = &quot;&quot;&quot;CREATE DATABASE IF NOT EXISTS `phpmyadmin`
                      DEFAULT CHARACTER SET utf8 COLLATE utf8_bin;
                    USE phpmyadmin;&quot;&quot;&quot;

    output = mysql._sanitize_comments(input_data)
    assert output == expected_response


def _test_call(function, expected_sql, *args, **kwargs):
    connect_mock = MagicMock()
    with patch.object(mysql, &quot;_connect&quot;, connect_mock):
        with patch.dict(mysql.__salt__, {&quot;config.option&quot;: MagicMock()}):
            function(*args, **kwargs)
            if isinstance(expected_sql, dict):
                calls = (
                    call()
                    .cursor()
                    .execute(&quot;{}&quot;.format(expected_sql[&quot;sql&quot;]), expected_sql[&quot;sql_args&quot;])
                )
            else:
                calls = call().cursor().execute(&quot;{}&quot;.format(expected_sql))
            connect_mock.assert_has_calls((calls,), True)


def test_file_query():
    &quot;&quot;&quot;
    Test file_query
    &quot;&quot;&quot;
    with patch.object(mysql, &quot;HAS_SQLPARSE&quot;, False):
        ret = mysql.file_query(&quot;database&quot;, &quot;filename&quot;)
        assert not ret

    file_data = &quot;&quot;&quot;-- --------------------------------------------------------
                   -- SQL Commands to set up the pmadb as described in the documentation.
                   --
                   -- This file is meant for use with MySQL 5 and above!
                   --
                   -- This script expects the user pma to already be existing. If we would put a
                   -- line here to create them too many users might just use this script and end
                   -- up with having the same password for the controluser.
                   --
                   -- This user &quot;pma&quot; must be defined in config.inc.php (controluser/controlpass)
                   --
                   -- Please don't forget to set up the tablenames in config.inc.php
                   --
                   -- --------------------------------------------------------
                   --
                   USE phpmyadmin;

                   --
                   -- Table structure for table `pma__bookmark`
                   --

                   CREATE TABLE IF NOT EXISTS `pma__bookmark` (
                     `id` int(10) unsigned NOT NULL auto_increment,
                     `dbase` varchar(255) NOT NULL default '',
                     `user` varchar(255) NOT NULL default '',
                     `label` varchar(255) COLLATE utf8_general_ci NOT NULL default '',
                     `query` text NOT NULL,
                     PRIMARY KEY  (`id`)
                   )
                     COMMENT='Bookmarks'
                     DEFAULT CHARACTER SET utf8 COLLATE utf8_bin;
    &quot;&quot;&quot;

    side_effect = [
        {&quot;query time&quot;: {&quot;human&quot;: &quot;0.4ms&quot;, &quot;raw&quot;: &quot;0.00038&quot;}, &quot;rows affected&quot;: 0},
        {&quot;query time&quot;: {&quot;human&quot;: &quot;8.9ms&quot;, &quot;raw&quot;: &quot;0.00893&quot;}, &quot;rows affected&quot;: 0},
    ]
    expected = {
        &quot;query time&quot;: {&quot;human&quot;: &quot;8.9ms&quot;, &quot;raw&quot;: &quot;0.00893&quot;},
        &quot;rows affected&quot;: 0,
    }

    with patch(&quot;os.path.exists&quot;, MagicMock(return_value=True)):
        with patch(&quot;salt.utils.files.fopen&quot;, mock_open(read_data=file_data)):
            with patch.object(mysql, &quot;query&quot;, side_effect=side_effect):
                ret = mysql.file_query(&quot;database&quot;, &quot;filename&quot;)
                assert ret, expected


@pytest.mark.skipif(not HAS_PYMYSQL, reason=&quot;Could not import pymysql&quot;)
def test__connect_pymysql_exception():
    &quot;&quot;&quot;
    Test the _connect function in the MySQL module
    &quot;&quot;&quot;
    with patch.dict(mysql.__salt__, {&quot;config.option&quot;: MagicMock()}):
        with patch(
            &quot;MySQLdb.connect&quot;,
            side_effect=pymysql.err.InternalError(
                1698, &quot;Access denied for user 'root'@'localhost'&quot;
            ),
        ):
            ret = mysql._connect()
            assert &quot;mysql.error&quot; in mysql.__context__
            assert (
                mysql.__context__[&quot;mysql.error&quot;]
                == &quot;MySQL Error 1698: Access denied for user 'root'@'localhost'&quot;
            )


def test__connect_mysqldb_exception():
    &quot;&quot;&quot;
    Test the _connect function in the MySQL module
    &quot;&quot;&quot;
    with patch.dict(mysql.__salt__, {&quot;config.option&quot;: MagicMock()}):
        with patch(
            &quot;MySQLdb.connect&quot;,
            side_effect=mysql.OperationalError(
                1698, &quot;Access denied for user 'root'@'localhost'&quot;
            ),
        ):
            ret = mysql._connect()
            assert &quot;mysql.error&quot; in mysql.__context__
            assert (
                mysql.__context__[&quot;mysql.error&quot;]
                == &quot;MySQL Error 1698: Access denied for user 'root'@'localhost'&quot;
            )


def test__connect_mysqldb():
    &quot;&quot;&quot;
    Test the _connect function in the MySQL module
    &quot;&quot;&quot;
    mysqldb_connect_mock = MagicMock(autospec=True, return_value=MockMySQLConnect())
    with patch.dict(mysql.__salt__, {&quot;config.option&quot;: MagicMock()}):
        with patch(&quot;MySQLdb.connect&quot;, mysqldb_connect_mock):
            mysql._connect()
            assert &quot;mysql.error&quot; not in mysql.__context__
</PRE>
</div>
  </div>
</body>
</html>
