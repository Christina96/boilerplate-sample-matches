<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for template_test.py &amp; test_mysql.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for template_test.py &amp; test_mysql.py
      </h3>
<h1 align="center">
        4.7%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>template_test.py (5.144291%)<th>test_mysql.py (4.4372296%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(449-456)<td><a href="#" name="0">(378-391)</a><td align="center"><font color="#ff0000">14</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(444-449)<td><a href="#" name="1">(352-364)</a><td align="center"><font color="#ff0000">14</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(464-466)<td><a href="#" name="2">(409-421)</a><td align="center"><font color="#ec0000">13</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>template_test.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 from __future__ import absolute_import, division, print_function
2 import os
3 import sys
4 import traceback
5 from salt.ext.tornado.escape import utf8, native_str, to_unicode
6 from salt.ext.tornado.template import Template, DictLoader, ParseError, Loader
7 from salt.ext.tornado.test.util import unittest, is_coverage_running
8 from salt.ext.tornado.util import ObjectDict, unicode_type, PY3
9 class TemplateTest(unittest.TestCase):
10     def test_simple(self):
11         template = Template("Hello {{ name }}!")
12         self.assertEqual(template.generate(name="Ben"),
13                          b"Hello Ben!")
14     def test_bytes(self):
15         template = Template("Hello {{ name }}!")
16         self.assertEqual(template.generate(name=utf8("Ben")),
17                          b"Hello Ben!")
18     def test_expressions(self):
19         template = Template("2 + 2 = {{ 2 + 2 }}")
20         self.assertEqual(template.generate(), b"2 + 2 = 4")
21     def test_comment(self):
22         template = Template("Hello{# TODO i18n #} {{ name }}!")
23         self.assertEqual(template.generate(name=utf8("Ben")),
24                          b"Hello Ben!")
25     def test_include(self):
26         loader = DictLoader({
27             "index.html": '{% include "header.html" %}\nbody text',
28             "header.html": "header text",
29         })
30         self.assertEqual(loader.load("index.html").generate(),
31                          b"header text\nbody text")
32     def test_extends(self):
33         loader = DictLoader({
34             "base.html": """\
35 &lt;title&gt;{% block title %}default title{% end %}&lt;/title&gt;
36 &lt;body&gt;{% block body %}default body{% end %}&lt;/body&gt;
37 """,
38             "page.html": """\
39 {% extends "base.html" %}
40 {% block title %}page title{% end %}
41 {% block body %}page body{% end %}
42         try:
43             loader.load("test.html").generate()
44             self.fail("did not get expected exception")
45         except ZeroDivisionError:
46             self.assertTrue("# test.html:2" in traceback.format_exc())
47     def test_error_line_number_directive(self):
48         loader = DictLoader({"test.html": """one
49 two{%if 1/0%}
50 three{%end%}
51         try:
52             loader.load("sub.html").generate()
53             self.fail("did not get expected exception")
54         except ZeroDivisionError:
55             self.assertTrue("# sub.html:4 (via base.html:1)" in
56                             traceback.format_exc())
57     def test_multi_includes(self):
58         loader = DictLoader({
59             "a.html": "{% include 'b.html' %}",
60             "b.html": "{% include 'c.html' %}",
61             "c.html": "{{1/0}}",
62         })
63         try:
64             loader.load("a.html").generate()
65             self.fail("did not get expected exception")
66         except ZeroDivisionError:
67             self.assertTrue("# c.html:1 (via b.html:1, a.html:1)" in
68                             traceback.format_exc())
69 class ParseErrorDetailTest(unittest.TestCase):
70     def test_details(self):
71         loader = DictLoader({
72             "foo.html": "\n\n{{",
73         })
74         with self.assertRaises(ParseError) as cm:
75             loader.load("foo.html")
76         self.assertEqual("Missing end expression }} at foo.html:3",
77                          str(cm.exception))
78         self.assertEqual("foo.html", cm.exception.filename)
79         self.assertEqual(3, cm.exception.lineno)
80     def test_custom_parse_error(self):
81         self.assertEqual("asdf at None:0", str(ParseError("asdf")))
82 class AutoEscapeTest(unittest.TestCase):
83     def setUp(self):
84         self.templates = {
85             "escaped.html": "{% autoescape xhtml_escape %}{{ name }}",
86             "unescaped.html": "{% autoescape None %}{{ name }}",
87             "default.html": "{{ name }}",
88             "include.html": """\
89 escaped: {% include 'escaped.html' %}
90 unescaped: {% include 'unescaped.html' %}
91 default: {% include 'default.html' %}
92 """,
93         self<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertEqual(loader.load("foo.html").generate(),
94                          b"\nasdf ")
95                          b"\nqwer ")
96         self.assertEqual(</b></font>loader<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.load("baz.txt").generate(),
97                          b"\t    zxcv\n\n")
98         self.assertEqual(loader.load("include.html").generate(),
99                          b" \t    zxcv\n\n\n")
100         self.assertEqual(loader.load(</b></font>"include.txt").generate(),
101                          b"\t\t\nasdf     ")
102     def test_whitespace_by_loader(self):
103         templates = {
104             "bar.txt": "\t\tbar\n\n",
105         }
106         loader = DictLoader(templates, whitespace<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>='all')
107         self.assertEqual(loader.load("foo.html").generate(), b"\t\tfoo\n\n")
108         self.assertEqual(loader.load("bar.txt").generate(</b></font>), b"\t\tbar\n\n")
109         loader = DictLoader(templates, whitespace='single')
110         self.assertEqual(loader.load("foo.html").generate(), b" foo\n")
111         self.assertEqual(loader.load("bar.txt").generate(), b" bar\n")
112         loader = DictLoader(templates, whitespace='oneline')
113         self.assertEqual(loader.load("foo.html").generate(), b" foo ")
114         self.assertEqual(loader.load("bar.txt").generate(), b" bar ")
115     def test_whitespace_directive(self):
116         loader = DictLoader({
117             "foo.html": """\
118 {% whitespace oneline %}
119     {% for i in range(3) %}
120         {{ i }}
121     {% end %}
122 {% whitespace all %}
123     pre\tformatted
124 """})
125         self.assertEqual(loader.load("foo.html").generate(),
126                          b"  0  1  2  \n    pre\tformatted\n")
127 class TemplateLoaderTest(unittest.TestCase):
128     def setUp(self):
129         self.loader = Loader(os.path.join(os.path.dirname(__file__), "templates"))
130     def test_utf8_in_file(self):
131         tmpl = self.loader.load("utf8.html")
132         result = tmpl.generate()
133         self.assertEqual(to_unicode(result).strip(), u"H\u00e9llo")
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_mysql.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 """
2     :codeauthor: Mike Place (mp@saltstack.com)
3     tests.unit.modules.mysql
4     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
5 """
6 import logging
7 import pytest
8 import salt.modules.mysql as mysql
9 from tests.support.mock import MagicMock, call, mock_open, patch
10 try:
11     import pymysql
12     HAS_PYMYSQL = True
13 except ImportError:
14     HAS_PYMYSQL = False
15 log = logging.getLogger(__name__)
16 __all_privileges__ = [
17     "ALTER",
18     "ALTER ROUTINE",
19     "BACKUP_ADMIN",
20     "BINLOG_ADMIN",
21     "CONNECTION_ADMIN",
22     "CREATE",
23     "CREATE ROLE",
24     "CREATE ROUTINE",
25     "CREATE TABLESPACE",
26     "CREATE TEMPORARY TABLES",
27     "CREATE USER",
28     "CREATE VIEW",
29     "DELETE",
30     "DROP",
31     "DROP ROLE",
32     "ENCRYPTION_KEY_ADMIN",
33     "EVENT",
34     "EXECUTE",
35     "FILE",
36     "GROUP_REPLICATION_ADMIN",
37     "INDEX",
38     "INSERT",
39     "LOCK TABLES",
40     "PERSIST_RO_VARIABLES_ADMIN",
41     "PROCESS",
42     "REFERENCES",
43     "RELOAD",
44     "REPLICATION CLIENT",
45     "REPLICATION SLAVE",
46     "REPLICATION_SLAVE_ADMIN",
47     "RESOURCE_GROUP_ADMIN",
48     "RESOURCE_GROUP_USER",
49     "ROLE_ADMIN",
50     "SELECT",
51     "SET_USER_ID",
52     "SHOW DATABASES",
53     "SHOW VIEW",
54     "SHUTDOWN",
55     "SUPER",
56     "SYSTEM_VARIABLES_ADMIN",
57     "TRIGGER",
58     "UPDATE",
59     "XA_RECOVER_ADMIN",
60 ]
61 pytestmark = [
62     pytest.mark.slow_test,
63     pytest.mark.skipif(
64         mysql.MySQLdb is None, reason="No python mysql client installed."
65     ),
66 ]
67 class MockMySQLConnect:
68     def __init__(self, *args, **kwargs):
69         self.args = args
70         self.kwargs = kwargs
71     def autocommit(self, *args, **kwards):
72         return True
73 @pytest.fixture
74 def configure_loader_modules():
75     return {mysql: {}}
76 def test_user_exists():
77     """
78     Test to see if mysql module properly forms the MySQL query to see if a user exists
79     Do it before test_user_create_when_user_exists mocks the user_exists call
80     """
81     with patch.object(mysql, "version", return_value="8.0.10"):
82         _test_call(
83             mysql.user_exists,
84             {
85                 "sql": (
86                     "SELECT User,Host FROM mysql.user WHERE "
87                     "User = %(user)s AND Host = %(host)s AND "
88                     "Password = PASSWORD(%(password)s)"
89                 ),
90                 "sql_args": {
91                     "host": "localhost",
92                     "password": "BLUECOW",
93                     "user": "mytestuser",
94                 },
95             },
96             user="mytestuser",
97             host="localhost",
98             password="BLUECOW",
99         )
100     with patch.object(mysql, "version", return_value="10.1.38-MariaDB"):
101         _test_call(
102             mysql.user_exists,
103             {
104                 "sql": (
105                     "SELECT User,Host FROM mysql.user WHERE "
106                     "User = %(user)s AND Host = %(host)s AND "
107                     "Password = PASSWORD(%(password)s)"
108                 ),
109                 "sql_args": {
110                     "host": "localhost",
111                     "password": "BLUECOW",
112                     "user": "mytestuser",
113                 },
114             },
115             user="mytestuser",
116             host="localhost",
117             password="BLUECOW",
118         )
119     with patch.object(mysql, "version", return_value="8.0.11"):
120         _test_call(
121             mysql.user_exists,
122             {
123                 "sql": (
124                     "SELECT User,Host FROM mysql.user WHERE "
125                     "User = %(user)s AND Host = %(host)s"
126                 ),
127                 "sql_args": {"host": "localhost", "user": "mytestuser"},
128             },
129             user="mytestuser",
130             host="localhost",
131             password="BLUECOW",
132         )
133     with patch.object(mysql, "version", return_value="8.0.11"):
134         with patch.object(
135             mysql,
136             "__get_auth_plugin",
137             MagicMock(return_value="mysql_native_password"),
138         ):
139             _test_call(
140                 mysql.user_exists,
141                 {
142                     "sql": (
143                         "SELECT User,Host FROM mysql.user WHERE "
144                         "User = %(user)s AND Host = %(host)s AND "
145                         "Password = %(password)s"
146                     ),
147                     "sql_args": {
148                         "host": "%",
149                         "password": "*1A01CF8FBE6425398935FB90359AD8B817399102",
150                         "user": "mytestuser",
151                     },
152                 },
153                 user="mytestuser",
154                 host="%",
155                 password="BLUECOW",
156             )
157     with patch.object(mysql, "version", return_value="10.2.21-MariaDB"):
158         _test_call(
159             mysql.user_exists,
160             {
161                 "sql": (
162                     "SELECT User,Host FROM mysql.user WHERE "
163                     "User = %(user)s AND Host = %(host)s AND "
164                     "Password = PASSWORD(%(password)s)"
165                 ),
166                 "sql_args": {
167                     "host": "localhost",
168                     "password": "BLUECOW",
169                     "user": "mytestuser",
170                 },
171             },
172             user="mytestuser",
173             host="localhost",
174             password="BLUECOW",
175         )
176     with patch.object(
177         mysql, "version", side_effect=["", "10.2.21-MariaDB", "10.2.21-MariaDB"]
178     ):
179         _test_call(
180             mysql.user_exists,
181             {
182                 "sql": (
183                     "SELECT User,Host FROM mysql.user WHERE "
184                     "User = %(user)s AND Host = %(host)s AND "
185                     "Password = PASSWORD(%(password)s)"
186                 ),
187                 "sql_args": {
188                     "host": "localhost",
189                     "password": "new_pass",
190                     "user": "root",
191                 },
192             },
193             user="root",
194             host="localhost",
195             password="new_pass",
196             connection_user="root",
197             connection_pass="old_pass",
198         )
199     with patch.object(mysql, "version", return_value="8.0.10"):
200         with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
201             with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
202                 ret = mysql.user_create("testuser")
203                 assert not ret
204     with patch.object(mysql, "version", return_value="8.0.11"):
205         with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
206             with patch.object(mysql, "verify_login", MagicMock(return_value=True)):
207                 with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
208                     ret = mysql.user_create("testuser")
209                     assert not False
210 def test_user_create():
211     """
212     Test the creation of a MySQL user in mysql exec module
213     """
214     with patch.object(mysql, "version", return_value="8.0.10"):
215         with patch.object(
216             mysql,
217             "__get_auth_plugin",
218             MagicMock(return_value="mysql_native_password"),
219         ):
220             _test_call(
221                 mysql.user_create,
222                 {
223                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED BY %(password)s",
224                     "sql_args": {
225                         "password": "BLUECOW",
226                         "user": "testuser",
227                         "host": "localhost",
228                     },
229                 },
230                 "testuser",
231                 password="BLUECOW",
232             )
233     with patch.object(mysql, "version", return_value="8.0.11"):
234         with patch.object(
235             mysql,
236             "__get_auth_plugin",
237             MagicMock(return_value="mysql_native_password"),
238         ):
239             _test_call(
240                 mysql.user_create,
241                 {
242                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED WITH %(auth_plugin)s BY %(password)s",
243                     "sql_args": {
244                         "password": "BLUECOW",
245                         "auth_plugin": "mysql_native_password",
246                         "user": "testuser",
247                         "host": "localhost",
248                     },
249                 },
250                 "testuser",
251                 password="BLUECOW",
252             )
253     with patch.object(mysql, "version", return_value="8.0.10"):
254         with patch.object(mysql, "plugin_status", MagicMock(return_value="ACTIVE")):
255             _test_call(
256                 mysql.user_create,
257                 {
258                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED WITH auth_socket",
259                     "sql_args": {"user": "testuser", "host": "localhost"},
260                 },
261                 "testuser",
262                 allow_passwordless=True,
263                 unix_socket=True,
264             )
265     with patch.object(mysql, "version", return_value="10.2.21-MariaDB"):
266         with patch.object(mysql, "plugin_status", MagicMock(return_value="ACTIVE")):
267             _test_call(
268                 mysql.user_create,
269                 {
270                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED VIA unix_socket",
271                     "sql_args": {"user": "testuser", "host": "localhost"},
272                 },
273                 "testuser",
274                 allow_passwordless=True,
275                 unix_socket=True,
276             )
277     with patch.object(mysql, "version", side_effect=["", "8.0.10", "8.0.10"]):
278         with patch.object(
279             mysql, "user_exists", MagicMock(return_value=False)
280         ), patch.object(
281             mysql,
282             "__get_auth_plugin",
283             MagicMock(return_value="mysql_native_password"),
284         ):
285             _test_call(
286                 mysql.user_create,
287                 {
288                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED BY %(password)s",
289                     "sql_args": {
290                         "password": "new_pass",
291                         "user": "root",
292                         "host": "localhost",
293                     },
294                 },
295                 "root",
296                 password="new_pass",
297                 connection_user="root",
298                 connection_pass="old_pass",
299             )
300 def test_user_chpass():
301     """
302     Test changing a MySQL user password in mysql exec module
303     """
304     connect_mock = MagicMock()
305     with patch.object(mysql, "_connect", connect_mock):
306         with patch.object(mysql, "version", return_value="8.0.10"):
307             with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
308                     mysql.user_chpass("testuser", password="BLUECOW")
309                     calls = (
310                         <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>call()
311                         .cursor()
312                         .execute(
313                             "UPDATE mysql.user SET Password=PASSWORD(%(password)s) WHERE User=%(user)s AND Host = %(host)s;",
314                             {
315                                 "password": "BLUECOW",
316                                 "user": "testuser",
317                                 "host": "localhost",
318                             },
319                         ),
320                         call().cursor().execute("FLUSH PRIVILEGES;"),
321                     )
322                     connect_mock.assert_has_calls(</b></font>calls, any_order=True)
323     connect_mock = MagicMock()
324     with patch.object(mysql, "_connect", connect_mock):
325         with patch.object(mysql, "version", return_value="8.0.11"):
326             with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
327                 with patch.object(
328                     mysql,
329                     "__get_auth_plugin",
330                     MagicMock(return_value="mysql_native_password"),
331                 ):
332                         mysql.user_chpass("testuser", password="BLUECOW")
333                         calls = (
334                             <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>call()
335                             .cursor()
336                             .execute(
337                                 "ALTER USER %(user)s@%(host)s IDENTIFIED WITH %(auth_plugin)s BY %(password)s;",
338                                 {
339                                     "password": "BLUECOW",
340                                     "user": "testuser",
341                                     "host": "localhost",
342                                     "auth_plugin": "mysql_native_password",
343                                 },
344                             ),
345                             call().cursor().execute("FLUSH PRIVILEGES;"),
346                         )
347                         connect_mock.assert_has_calls(</b></font>calls, any_order=True)
348     connect_mock = MagicMock()
349     with patch.object(mysql, "_connect", connect_mock):
350         with patch.object(mysql, "version", side_effect=["", "8.0.11", "8.0.11"]):
351             with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
352                 with patch.object(
353                     mysql,
354                     "__get_auth_plugin",
355                     MagicMock(return_value="mysql_native_password"),
356                 ):
357                     with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
358                         mysql.user_chpass(
359                             "root",
360                             password="new_pass",
361                             connection_pass="old_pass",
362                         )
363                         calls <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= (
364                             call()
365                             .cursor()
366                             .execute(
367                                 "ALTER USER %(user)s@%(host)s IDENTIFIED WITH %(auth_plugin)s BY %(password)s;",
368                                 {
369                                     "password": "new_pass",
370                                     "user": "root",
371                                     "host": "localhost",
372                                     "auth_plugin": "mysql_native_password",
373                                 },
374                             ),
375                             call().cursor().execute(</b></font>"FLUSH PRIVILEGES;"),
376                         )
377                         connect_mock.assert_has_calls(calls, any_order=True)
378 def test_user_remove():
379     """
380     Test the removal of a MySQL user in mysql exec module
381     """
382     with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
383         _test_call(
384             mysql.user_remove,
385             {
386                 "sql": "DROP USER %(user)s@%(host)s",
387                 "sql_args": {"user": "testuser", "host": "localhost"},
388             },
389             "testuser",
390         )
391 def test_db_check():
392     """
393     Test MySQL db check function in mysql exec module
394     """
395     _test_call(
396         mysql.db_check,
397         "CHECK TABLE `test``'\" db`.`my``'\" table`",
398         "test`'\" db",
399         "my`'\" table",
400     )
401 def test_db_repair():
402     """
403     Test MySQL db repair function in mysql exec module
404     """
405     _test_call(
406         mysql.db_repair,
407         "REPAIR TABLE `test``'\" db`.`my``'\" table`",
408         "test`'\" db",
409         "my`'\" table",
410     )
411 def test_db_optimize():
412     """
413     Test MySQL db optimize function in mysql exec module
414     """
415     _test_call(
416         mysql.db_optimize,
417         "OPTIMIZE TABLE `test``'\" db`.`my``'\" table`",
418         "test`'\" db",
419         "my`'\" table",
420     )
421 def test_db_remove():
422     """
423     Test MySQL db remove function in mysql exec module
424     """
425     with patch.object(mysql, "db_exists", MagicMock(return_value=True)):
426         _test_call(mysql.db_remove, "DROP DATABASE `test``'\" db`;", "test`'\" db")
427 def test_db_tables():
428     """
429     Test MySQL db_tables function in mysql exec module
430     """
431     with patch.object(mysql, "db_exists", MagicMock(return_value=True)):
432         _test_call(mysql.db_tables, "SHOW TABLES IN `test``'\" db`", "test`'\" db")
433 def test_db_exists():
434     """
435     Test MySQL db_exists function in mysql exec module
436     """
437     _test_call(
438         mysql.db_exists,
439         {
440             "sql": "SHOW DATABASES LIKE %(dbname)s;",
441             "sql_args": {"dbname": r"""test%_`" db"""},
442         },
443         'test%_`" db',
444     )
445 def test_db_create():
446     """
447     Test MySQL db_create function in mysql exec module
448     """
449     _test_call(
450         mysql.db_create,
451         "CREATE DATABASE IF NOT EXISTS `test``'\" db`;",
452         "test`'\" db",
453     )
454 def test_alter_db():
455     """
456     Test MySQL alter_db function in mysql exec module
457     """
458     mock_get_db = {
459         "character_set": "utf8",
460         "collate": "utf8_unicode_ci",
461         "name": "my_test",
462     }
463     mock = MagicMock(return_value=mock_get_db)
464     with patch.object(mysql, "db_get", return_value=mock) as mock_db_get:
465         _test_call(
466             mysql.alter_db,
467             "ALTER DATABASE `my_test` CHARACTER SET utf8 COLLATE utf8_unicode_ci;",
468             "my_test",
469             "utf8",
470             "utf8_unicode_ci",
471         )
472 def test_user_list():
473     """
474     Test MySQL user_list function in mysql exec module
475     """
476     _test_call(mysql.user_list, "SELECT User,Host FROM mysql.user")
477 def test_user_info():
478     """
479     Test to see if the mysql execution module correctly forms the SQL for information on a MySQL user.
480     """
481     _test_call(
482         mysql.user_info,
483         {
484             "sql": "SELECT * FROM mysql.user WHERE User = %(user)s AND Host = %(host)s",
485             "sql_args": {"host": "localhost", "user": "mytestuser"},
486         },
487         "mytestuser",
488     )
489 def test_user_grants():
490     """
491     Test to ensure the mysql user_grants function returns properly formed SQL for a basic query
492     """
493     with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
494         _test_call(
495             mysql.user_grants,
496             {
497                 "sql": "SHOW GRANTS FOR %(user)s@%(host)s",
498                 "sql_args": {"host": "localhost", "user": "testuser"},
499             },
500             "testuser",
501         )
502 def test_grant_exists_true():
503     """
504     Test to ensure that we can find a grant that exists
505     """
506     mock_grants = [
507         "GRANT USAGE ON *.* TO 'testuser'@'%'",
508         "GRANT SELECT, INSERT, UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'",
509         "GRANT SELECT(column1,column2) ON `testdb`.`testtableone` TO 'testuser'@'%'",
510         "GRANT SELECT(column1,column2), INSERT(column1,column2) ON `testdb`.`testtableone` TO 'testuser'@'%'",
511         "GRANT SELECT(column1,column2), UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'",
512         "GRANT SELECT ON `testdb`.`testtabletwo` TO 'testuser'@'%'",
513         "GRANT SELECT ON `testdb`.`testtablethree` TO 'testuser'@'%'",
514     ]
515     with patch.object(mysql, "version", return_value="5.6.41"):
516         mock = MagicMock(return_value=mock_grants)
517         with patch.object(
518             mysql, "user_grants", return_value=mock_grants
519         ) as mock_user_grants:
520             ret = mysql.grant_exists(
521                 "SELECT, INSERT, UPDATE", "testdb.testtableone", "testuser", "%"
522             )
523             assert ret
524 def test_grant_exists_false():
525     """
526     Test to ensure that we don't find a grant that doesn't exist
527     """
528     mock_grants = [
529         "GRANT USAGE ON *.* TO 'testuser'@'%'",
530         "GRANT SELECT, INSERT, UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'",
531         "GRANT SELECT(column1,column2) ON `testdb`.`testtableone` TO 'testuser'@'%'",
532         "GRANT SELECT(column1,column2), UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'",
533         "GRANT SELECT ON `testdb`.`testtablethree` TO 'testuser'@'%'",
534     ]
535     with patch.object(mysql, "version", return_value="5.6.41"):
536         mock = MagicMock(return_value=mock_grants)
537         with patch.object(
538             mysql, "user_grants", return_value=mock_grants
539         ) as mock_user_grants:
540             ret = mysql.grant_exists("SELECT", "testdb.testtabletwo", "testuser", "%")
541             assert not ret
542 def test_grant_exists_all():
543     """
544     Test to ensure that we can find a grant that exists
545     """
546     mock_grants = ["GRANT ALL PRIVILEGES ON testdb.testtableone TO `testuser`@`%`"]
547     with patch.object(mysql, "version", return_value="8.0.10"):
548         mock = MagicMock(return_value=mock_grants)
549         with patch.object(
550             mysql, "user_grants", return_value=mock_grants
551         ) as mock_user_grants:
552             ret = mysql.grant_exists("ALL", "testdb.testtableone", "testuser", "%")
553             assert ret
554     with patch.object(mysql, "version", return_value="8.0.10"):
555         mock = MagicMock(return_value=mock_grants)
556         with patch.object(
557             mysql, "user_grants", return_value=mock_grants
558         ) as mock_user_grants:
559             ret = mysql.grant_exists(
560                 "all privileges", "testdb.testtableone", "testuser", "%"
561             )
562             assert ret
563     mock_grants = ["GRANT ALL PRIVILEGES ON testdb.testtableone TO `testuser`@`%`"]
564     with patch.object(mysql, "version", return_value="5.6.41"):
565         mock = MagicMock(return_value=mock_grants)
566         with patch.object(
567             mysql, "user_grants", return_value=mock_grants
568         ) as mock_user_grants:
569             ret = mysql.grant_exists(
570                 "ALL PRIVILEGES", "testdb.testtableone", "testuser", "%"
571             )
572             assert ret
573     mock_grants = [
574         "GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE, CREATE ROLE, DROP ROLE ON *.* TO `testuser`@`%`",
575         "GRANT BACKUP_ADMIN,BINLOG_ADMIN,CONNECTION_ADMIN,ENCRYPTION_KEY_ADMIN,GROUP_REPLICATION_ADMIN,PERSIST_RO_VARIABLES_ADMIN,REPLICATION_SLAVE_ADMIN,RESOURCE_GROUP_ADMIN,RESOURCE_GROUP_USER,ROLE_ADMIN,SET_USER_ID,SYSTEM_VARIABLES_ADMIN,XA_RECOVER_ADMIN ON *.* TO `testuser`@`%`",
576     ]
577     with patch.object(mysql, "version", return_value="8.0.10"):
578         mock = MagicMock(return_value=mock_grants)
579         with patch.object(
580             mysql, "user_grants", return_value=mock_grants
581         ) as mock_user_grants:
582             ret = mysql.grant_exists("ALL", "*.*", "testuser", "%")
583             assert ret
584     with patch.object(mysql, "version", return_value="8.0.10"):
585         mock = MagicMock(return_value=mock_grants)
586         with patch.object(
587             mysql, "user_grants", return_value=mock_grants
588         ) as mock_user_grants:
589             ret = mysql.grant_exists("all privileges", "*.*", "testuser", "%")
590             assert ret
591 @pytest.mark.skipif(True, reason="TODO: Mock up user_grants()")
592 def test_grant_add():
593     """
594     Test grant_add function in mysql exec module
595     """
596     _test_call(
597         mysql.grant_add,
598         "",
599         "SELECT,INSERT,UPDATE",
600         "database.*",
601         "frank",
602         "localhost",
603     )
604 @pytest.mark.skipif(True, reason="TODO: Mock up user_grants()")
605 def test_grant_revoke():
606     """
607     Test grant revoke in mysql exec module
608     """
609     _test_call(
610         mysql.grant_revoke,
611         "",
612         "SELECT,INSERT,UPDATE",
613         "database.*",
614         "frank",
615         "localhost",
616     )
617 def test_processlist():
618     """
619     Test processlist function in mysql exec module
620     """
621     _test_call(mysql.processlist, "SHOW FULL PROCESSLIST")
622 def test_get_master_status():
623     """
624     Test get_master_status in the mysql execution module
625     """
626     _test_call(mysql.get_master_status, "SHOW MASTER STATUS")
627 def test_get_slave_status():
628     """
629     Test get_slave_status in the mysql execution module
630     """
631     _test_call(mysql.get_slave_status, "SHOW SLAVE STATUS")
632 def test_get_slave_status_bad_server():
633     """
634     Test get_slave_status in the mysql execution module, simulating a broken server
635     """
636     connect_mock = MagicMock(return_value=None)
637     with patch.object(mysql, "_connect", connect_mock):
638         with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
639             rslt = mysql.get_slave_status()
640             connect_mock.assert_has_calls([call()])
641             assert rslt == []
642 @pytest.mark.skipif(
643     True, reason="MySQL module claims this function is not ready for production"
644 )
645 def test_free_slave():
646     pass
647 def test_query():
648     _test_call(mysql.query, "SELECT * FROM testdb", "testdb", "SELECT * FROM testdb")
649 @pytest.mark.skipif(not HAS_PYMYSQL, reason="Could not import pymysql")
650 def test_query_error():
651     connect_mock = MagicMock()
652     with patch.object(mysql, "_connect", connect_mock):
653         with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
654             side_effect = mysql.OperationalError(9999, "Something Went Wrong")
655             with patch.object(mysql, "_execute", MagicMock(side_effect=side_effect)):
656                 mysql.query("testdb", "SELECT * FROM testdb")
657         assert "mysql.error" in mysql.__context__
658         expected = "MySQL Error 9999: Something Went Wrong"
659         assert mysql.__context__["mysql.error"] == expected
660 def test_plugin_add():
661     """
662     Test the adding/installing a MySQL / MariaDB plugin
663     """
664     with patch.object(mysql, "plugin_status", MagicMock(return_value="")):
665         _test_call(
666             mysql.plugin_add,
667             'INSTALL PLUGIN auth_socket SONAME "auth_socket.so"',
668             "auth_socket",
669         )
670 def test_plugin_remove():
671     """
672     Test the removing/uninstalling a MySQL / MariaDB plugin
673     """
674     with patch.object(mysql, "plugin_status", MagicMock(return_value="ACTIVE")):
675         _test_call(
676             mysql.plugin_remove,
677             "UNINSTALL PLUGIN auth_socket",
678             "auth_socket",
679         )
680 def test_plugin_status():
681     """
682     Test checking the status of a MySQL / MariaDB plugin
683     """
684     _test_call(
685         mysql.plugin_status,
686         {
687             "sql": "SELECT PLUGIN_STATUS FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = %(name)s",
688             "sql_args": {"name": "auth_socket"},
689         },
690         "auth_socket",
691     )
692 def test_sanitize_comment():
693     """
694     Test comment sanitization
695     """
696     input_data = """/*
697     multiline
698     comment
699     */
700     CREATE TABLE test_update (a VARCHAR(25)); # end of line comment
701     insert into test_update values ("some #hash value");            -- ending comment
702     insert into test_update values ("crazy -- not comment"); -- another ending comment
703     -- another comment type
704     """
705     expected_response = """CREATE TABLE test_update (a VARCHAR(25));
706 insert into test_update values ("some #hash value");
707 insert into test_update values ("crazy -- not comment");
708 """
709     output = mysql._sanitize_comments(input_data)
710     assert output == expected_response
711     input_data = """-- --------------------------------------------------------
712                     -- SQL Commands to set up the pmadb as described in the documentation.
713                     --
714                     -- This file is meant for use with MySQL 5 and above!
715                     --
716                     -- This script expects the user pma to already be existing. If we would put a
717                     -- line here to create them too many users might just use this script and end
718                     -- up with having the same password for the controluser.
719                     --
720                     -- This user "pma" must be defined in config.inc.php (controluser/controlpass)
721                     --
722                     -- Please don't forget to set up the tablenames in config.inc.php
723                     --
724                     -- --------------------------------------------------------
725                     --
726                     CREATE DATABASE IF NOT EXISTS `phpmyadmin`
727                       DEFAULT CHARACTER SET utf8 COLLATE utf8_bin;
728                     USE phpmyadmin;
729     """
730     expected_response = """CREATE DATABASE IF NOT EXISTS `phpmyadmin`
731                       DEFAULT CHARACTER SET utf8 COLLATE utf8_bin;
732                     USE phpmyadmin;"""
733     output = mysql._sanitize_comments(input_data)
734     assert output == expected_response
735 def _test_call(function, expected_sql, *args, **kwargs):
736     connect_mock = MagicMock()
737     with patch.object(mysql, "_connect", connect_mock):
738         with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
739             function(*args, **kwargs)
740             if isinstance(expected_sql, dict):
741                 calls = (
742                     call()
743                     .cursor()
744                     .execute("{}".format(expected_sql["sql"]), expected_sql["sql_args"])
745                 )
746             else:
747                 calls = call().cursor().execute("{}".format(expected_sql))
748             connect_mock.assert_has_calls((calls,), True)
749 def test_file_query():
750     """
751     Test file_query
752     """
753     with patch.object(mysql, "HAS_SQLPARSE", False):
754         ret = mysql.file_query("database", "filename")
755         assert not ret
756     file_data = """-- --------------------------------------------------------
757                    -- SQL Commands to set up the pmadb as described in the documentation.
758                    --
759                    -- This file is meant for use with MySQL 5 and above!
760                    --
761                    -- This script expects the user pma to already be existing. If we would put a
762                    -- line here to create them too many users might just use this script and end
763                    -- up with having the same password for the controluser.
764                    --
765                    -- This user "pma" must be defined in config.inc.php (controluser/controlpass)
766                    --
767                    -- Please don't forget to set up the tablenames in config.inc.php
768                    --
769                    -- --------------------------------------------------------
770                    --
771                    USE phpmyadmin;
772                    --
773                    -- Table structure for table `pma__bookmark`
774                    --
775                    CREATE TABLE IF NOT EXISTS `pma__bookmark` (
776                      `id` int(10) unsigned NOT NULL auto_increment,
777                      `dbase` varchar(255) NOT NULL default '',
778                      `user` varchar(255) NOT NULL default '',
779                      `label` varchar(255) COLLATE utf8_general_ci NOT NULL default '',
780                      `query` text NOT NULL,
781                      PRIMARY KEY  (`id`)
782                    )
783                      COMMENT='Bookmarks'
784                      DEFAULT CHARACTER SET utf8 COLLATE utf8_bin;
785     """
786     side_effect = [
787         {"query time": {"human": "0.4ms", "raw": "0.00038"}, "rows affected": 0},
788         {"query time": {"human": "8.9ms", "raw": "0.00893"}, "rows affected": 0},
789     ]
790     expected = {
791         "query time": {"human": "8.9ms", "raw": "0.00893"},
792         "rows affected": 0,
793     }
794     with patch("os.path.exists", MagicMock(return_value=True)):
795         with patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
796             with patch.object(mysql, "query", side_effect=side_effect):
797                 ret = mysql.file_query("database", "filename")
798                 assert ret, expected
799 @pytest.mark.skipif(not HAS_PYMYSQL, reason="Could not import pymysql")
800 def test__connect_pymysql_exception():
801     """
802     Test the _connect function in the MySQL module
803     """
804     with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
805         with patch(
806             "MySQLdb.connect",
807             side_effect=pymysql.err.InternalError(
808                 1698, "Access denied for user 'root'@'localhost'"
809             ),
810         ):
811             ret = mysql._connect()
812             assert "mysql.error" in mysql.__context__
813             assert (
814                 mysql.__context__["mysql.error"]
815                 == "MySQL Error 1698: Access denied for user 'root'@'localhost'"
816             )
817 def test__connect_mysqldb_exception():
818     """
819     Test the _connect function in the MySQL module
820     """
821     with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
822         with patch(
823             "MySQLdb.connect",
824             side_effect=mysql.OperationalError(
825                 1698, "Access denied for user 'root'@'localhost'"
826             ),
827         ):
828             ret = mysql._connect()
829             assert "mysql.error" in mysql.__context__
830             assert (
831                 mysql.__context__["mysql.error"]
832                 == "MySQL Error 1698: Access denied for user 'root'@'localhost'"
833             )
834 def test__connect_mysqldb():
835     """
836     Test the _connect function in the MySQL module
837     """
838     mysqldb_connect_mock = MagicMock(autospec=True, return_value=MockMySQLConnect())
839     with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
840         with patch("MySQLdb.connect", mysqldb_connect_mock):
841             mysql._connect()
842             assert "mysql.error" not in mysql.__context__
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
