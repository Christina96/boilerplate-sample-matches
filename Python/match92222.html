<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_docker_network.py &amp; test_mysql_2.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_docker_network.py &amp; test_mysql_2.py
      </h3>
<h1 align="center">
        3.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_docker_network.py (4.949054%)<th>test_mysql_2.py (2.905983%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(447-463)<td><a href="#" name="0">(50-145)</a><td align="center"><font color="#ff0000">20</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(397-407)<td><a href="#" name="1">(182-249)</a><td align="center"><font color="#b20000">14</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_docker_network.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import errno
2 import functools
3 import logging
4 import os
5 import subprocess
6 import tempfile
7 import pytest
8 import salt.utils.files
9 import salt.utils.network
10 import salt.utils.path
11 from salt.exceptions import CommandExecutionError
12 from tests.support.case import ModuleCase
13 from tests.support.docker import random_name, with_network
14 from tests.support.helpers import requires_system_grains
15 from tests.support.mixins import SaltReturnAssertsMixin
16 from tests.support.runtests import RUNTIME_VARS
17 from tests.support.unit import skipIf
18 log = logging.getLogger(__name__)
19 IMAGE_NAME = random_name(prefix="salt_busybox_")
20 IPV6_ENABLED = bool(salt.utils.network.ip_addrs6(include_loopback=True))
21 def network_name(func):
22     @functools.wraps(func)
23     def wrapper(self, *args, **kwargs):
24         name = random_name(prefix="salt_net_")
25         try:
26             return func(self, name, *args, **kwargs)
27         finally:
28             self.run_function("docker.disconnect_all_containers_from_network", [name])
29             try:
30                 self.run_function("docker.remove_network", [name])
31             except CommandExecutionError as exc:
32                 if "No such network" not in exc.__str__():
33                     raise
34     return wrapper
35 def container_name(func):
36     def build_image():
37         image_build_rootdir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)
38         script_path = os.path.join(RUNTIME_VARS.BASE_FILES, "mkimage-busybox-static")
39         cmd = [script_path, image_build_rootdir, IMAGE_NAME]
40         log.debug("Running '%s' to build busybox image", " ".join(cmd))
41         process = subprocess.Popen(
42             cmd, close_fds=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT
43         )
44         output = process.communicate()[0]
45         log.debug("Output from mkimge-busybox-static:\n%s", output)
46         if process.returncode != 0:
47             raise Exception("Failed to build image")
48         try:
49             salt.utils.files.rm_rf(image_build_rootdir)
50         except OSError as exc:
51             if exc.errno != errno.ENOENT:
52                 raise
53     @functools.wraps(func)
54     def wrapper(self, *args, **kwargs):
55         try:
56             self.run_function("docker.inspect_image", [IMAGE_NAME])
57         except CommandExecutionError:
58             pass
59         else:
60             build_image()
61         name = random_name(prefix="salt_test_")
62         self.run_function(
63             "docker.create",
64             name=name,
65             image=IMAGE_NAME,
66             command="sleep 600",
67             start=True,
68         )
69         try:
70             return func(self, name, *args, **kwargs)
71         finally:
72             try:
73                 self.run_function("docker.rm", [name], force=True)
74             except CommandExecutionError as exc:
75                 if "No such container" not in exc.__str__():
76                     raise
77     return wrapper
78 @pytest.mark.destructive_test
79 @pytest.mark.slow_test
80 @skipIf(salt.utils.platform.is_freebsd(), "No Docker on FreeBSD available")
81 @skipIf(not salt.utils.path.which("dockerd"), "Docker not installed")
82 class DockerNetworkTestCase(ModuleCase, SaltReturnAssertsMixin):
83     @classmethod
84     def tearDownClass(cls):
85         cmd = ["docker", "rmi", "--force", IMAGE_NAME]
86         log.debug("Running '%s' to destroy busybox image", " ".join(cmd))
87         process = subprocess.Popen(
88             cmd, close_fds=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT
89         )
90         output = process.communicate()[0]
91         log.debug("Output from %s:\n%s", " ".join(cmd), output)
92         if process.returncode != 0 and "No such image" not in str(output):
93             raise Exception("Failed to destroy image")
94     def run_state(self, function, **kwargs):
95         ret = super().run_state(function, **kwargs)
96         log.debug("ret = %s", ret)
97         return ret
98     @with_network(create=False)
99     @pytest.mark.slow_test
100     def test_absent(self, net):
101         self.assertSaltTrueReturn(
102             self.run_state("docker_network.present", name=net.name)
103         )
104         ret = self.run_state("docker_network.absent", name=net.name)
105         self.assertSaltTrueReturn(ret)
106         ret = ret[next(iter(ret))]
107         self.assertEqual(ret["changes"], {"removed": True})
108         self.assertEqual(ret["comment"], "Removed network '{}'".format(net.name))
109     @container_name
110     @with_network(create=False)
111     @pytest.mark.slow_test
112     @pytest.mark.skipif(
113         salt.utils.platform.is_photonos() is True,
114         reason="Skip on PhotonOS.  No busybox available.",
115     )
116     def test_absent_with_disconnected_container(self, net, container_name):
117         self.assertSaltTrueReturn(
118             self.run_state(
119                 "docker_network.present", name=net.name, containers=[container_name]
120             )
121         )
122         ret = self.run_state("docker_network.absent", name=net.name)
123         self.assertSaltTrueReturn(ret)
124         ret = ret[next(iter(ret))]
125         self.assertEqual(
126             ret["changes"], {"removed": True, "disconnected": [container_name]}
127         )
128         self.assertEqual(ret["comment"], "Removed network '{}'".format(net.name))
129     @with_network(create=False)
130     @pytest.mark.slow_test
131     def test_absent_when_not_present(self, net):
132         ret = self.run_state("docker_network.absent", name=net.name)
133         self.assertSaltTrueReturn(ret)
134         ret = ret[next(iter(ret))]
135         self.assertEqual(ret["changes"], {})
136         self.assertEqual(ret["comment"], "Network '{}' already absent".format(net.name))
137     @with_network(create=False)
138     @pytest.mark.slow_test
139     def test_present(self, net):
140         ret = self.run_state("docker_network.present", name=net.name)
141         self.assertSaltTrueReturn(ret)
142         ret = ret[next(iter(ret))]
143         self.assertEqual(ret["changes"], {"created": True})
144         self.assertEqual(ret["comment"], "Network '{}' created".format(net.name))
145         self.run_function("docker.inspect_network", [net.name])
146     @container_name
147     @with_network(create=False)
148     @pytest.mark.slow_test
149     @pytest.mark.skipif(
150         salt.utils.platform.is_photonos() is True,
151         reason="Skip on PhotonOS.  No busybox available.",
152     )
153     def test_present_with_containers(self, net, container_name):
154         ret = self.run_state(
155             "docker_network.present", name=net.name, containers=[container_name]
156         )
157         self.assertSaltTrueReturn(ret)
158         ret = ret[next(iter(ret))]
159         self.assertEqual(
160             ret["changes"], {"created": True, "connected": [container_name]}
161         )
162         self.assertEqual(ret["comment"], "Network '{}' created".format(net.name))
163         self.run_function("docker.inspect_network", [net.name])
164     def _test_present_reconnect(self, net, container_name, reconnect=True):
165         ret = self.run_state("docker_network.present", name=net.name, driver="bridge")
166         self.assertSaltTrueReturn(ret)
167         ret = ret[next(iter(ret))]
168         self.assertEqual(ret["changes"], {"created": True})
169         self.assertEqual(ret["comment"], "Network '{}' created".format(net.name))
170         self.run_function(
171             "docker.connect_container_to_network", [container_name, net.name]
172         )
173         ret = self.run_state(
174             "docker_network.present",
175             name=net.name,
176             driver="macvlan",
177             reconnect=reconnect,
178         )
179         self.assertSaltTrueReturn(ret)
180         ret = ret[next(iter(ret))]
181         self.assertEqual(
182             ret["changes"],
183             {
184                 "recreated": True,
185                 "reconnected" if reconnect else "disconnected": [container_name],
186                 net.name: {"Driver": {"old": "bridge", "new": "macvlan"}},
187             },
188         )
189         self.assertEqual(
190             ret["comment"],
191             "Network '{}' was replaced with updated config".format(net.name),
192         )
193     @container_name
194     @with_network(create=False)
195     @pytest.mark.slow_test
196     @pytest.mark.skipif(
197         salt.utils.platform.is_photonos() is True,
198         reason="Skip on PhotonOS.  No busybox available.",
199     )
200     def test_present_with_reconnect(self, net, container_name):
201         self._test_present_reconnect(net, container_name, reconnect=True)
202     @container_name
203     @with_network(create=False)
204     @pytest.mark.slow_test
205     @pytest.mark.skipif(
206         salt.utils.platform.is_photonos() is True,
207         reason="Skip on PhotonOS.  No busybox available.",
208     )
209     def test_present_with_no_reconnect(self, net, container_name):
210         self._test_present_reconnect(net, container_name, reconnect=False)
211     @with_network()
212     @pytest.mark.slow_test
213     def test_present_internal(self, net):
214         self.assertSaltTrueReturn(
215             self.run_state(
216                 "docker_network.present",
217                 name=net.name,
218                 internal=True,
219             )
220         )
221         net_info = self.run_function("docker.inspect_network", [net.name])
222         self.assertIs(net_info["Internal"], True)
223     @with_network()
224     @pytest.mark.slow_test
225     def test_present_labels(self, net):
226         self.assertSaltTrueReturn(
227             self.run_state(
228                 "docker_network.present",
229                 name=net.name,
230                 labels=["foo", "bar=baz", {"hello": "world"}],
231             )
232         )
233         net_info = self.run_function("docker.inspect_network", [net.name])
234         self.assertEqual(
235             net_info["Labels"],
236             {"foo": "", "bar": "baz", "hello": "world"},
237         )
238     @with_network(subnet="fe3f:2180:26:1::/123")
239     @with_network(subnet="10.247.197.96/27")
240     @skipIf(not IPV6_ENABLED, "IPv6 not enabled")
241     @pytest.mark.slow_test
242     def test_present_enable_ipv6(self, net1, net2):
243         self.assertSaltTrueReturn(
244             self.run_state(
245                 "docker_network.present",
246                 name=net1.name,
247                 enable_ipv6=True,
248                 ipam_pools=[{"subnet": net1.subnet}, {"subnet": net2.subnet}],
249             )
250         )
251         net_info = self.run_function("docker.inspect_network", [net1.name])
252         self.assertIs(net_info["EnableIPv6"], True)
253     @requires_system_grains
254     @with_network()
255     @pytest.mark.slow_test
256     def test_present_attachable(self, net, grains):
257         if grains["os_family"] == "RedHat" and grains.get("osmajorrelease", 0) &lt;= 7:
258             self.skipTest("Cannot reliably manage attachable on RHEL &lt;= 7")
259         self.assertSaltTrueReturn(
260             self.run_state(
261                 "docker_network.present",
262                 name=net.name,
263                 attachable=True,
264             )
265         )
266         net_info = self.run_function("docker.inspect_network", [net.name])
267         self.assertIs(net_info["Attachable"], True)
268     @skipIf(True, "Skip until we can set up docker swarm testing")
269     @with_network()
270     def test_present_scope(self, net):
271         self.assertSaltTrueReturn(
272             self.run_state(
273                 "docker_network.present",
274                 name=net.name,
275                 scope="global",
276             )
277         )
278         net_info = self.run_function("docker.inspect_network", [net.name])
279         self.assertIs(net_info["Scope"], "global")
280     @skipIf(True, "Skip until we can set up docker swarm testing")
281     @with_network()
282     def test_present_ingress(self, net):
283         self.assertSaltTrueReturn(
284             self.run_state(
285                 "docker_network.present",
286                 name=net.name,
287                 ingress=True,
288             )
289         )
290         net_info = self.run_function("docker.inspect_network", [net.name])
291         self.assertIs(net_info["Ingress"], True)
292     @with_network(subnet="10.247.197.128/27")
293     @with_network(subnet="10.247.197.96/27")
294     @pytest.mark.slow_test
295     def test_present_with_custom_ipv4(self, net1, net2):
296         self.assertSaltTrueReturn(
297             self.run_state(
298                 "docker_network.present",
299                 name=net1.name,
300                 subnet=net1.subnet,
301                 gateway=net1.gateway,
302             )
303         )
304         ret = self.run_state(
305             "docker_network.present",
306             name=net1.name,  # We want to keep the same network name
307             ipam_pools=[{"subnet": net2.subnet, "gateway": net2.gateway}],
308         )
309         self.assertSaltTrueReturn(ret)
310         ret = ret[next(iter(ret))]
311         expected = {
312             <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"recreated": True,
313             net1.name: {
314                 "IPAM": {
315                     "Config": {
316                         "old": [{"Subnet": net1.subnet, "Gateway": net1.gateway}],
317                         "new": [{"Subnet": net2.subnet, "Gateway": net2.gateway}],
318                     }
319                 }
320             },
321         }
322         self.</b></font>assertEqual(ret["changes"], expected)
323         self.assertEqual(
324             ret["comment"],
325             "Network '{}' was replaced with updated config".format(net1.name),
326         )
327     @with_network(subnet="fe3f:2180:26:1::20/123")
328     @with_network(subnet="fe3f:2180:26:1::/123")
329     @with_network(subnet="10.247.197.96/27")
330     @skipIf(not IPV6_ENABLED, "IPv6 not enabled")
331     @pytest.mark.slow_test
332     def test_present_with_custom_ipv6(self, ipv4_net, ipv6_net1, ipv6_net2):
333         self.assertSaltTrueReturn(
334             self.run_state(
335                 "docker_network.present",
336                 name=ipv4_net.name,
337                 enable_ipv6=True,
338                 ipam_pools=[
339                     {"subnet": ipv4_net.subnet, "gateway": ipv4_net.gateway},
340                     {"subnet": ipv6_net1.subnet, "gateway": ipv6_net1.gateway},
341                 ],
342             )
343         )
344         ret = self.run_state(
345             "docker_network.present",
346             name=ipv4_net.name,  # We want to keep the same network name
347             enable_ipv6=True,
348             ipam_pools=[
349                 {"subnet": ipv4_net.subnet, "gateway": ipv4_net.gateway},
350                 {"subnet": ipv6_net2.subnet, "gateway": ipv6_net2.gateway},
351             ],
352         )
353         self.assertSaltTrueReturn(ret)
354         ret = ret[next(iter(ret))]
355         expected = {
356             <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"recreated": True,
357             ipv4_net.name: {
358                 "IPAM": {
359                     "Config": {
360                         "old": [
361                             {"Subnet": ipv4_net.subnet, "Gateway": ipv4_net.gateway},
362                             {"Subnet": ipv6_net1.subnet, "Gateway": ipv6_net1.gateway},
363                         ],
364                         "new": [
365                             {"Subnet": ipv4_net.subnet, "Gateway": ipv4_net.gateway},
366                             {"Subnet": ipv6_net2.subnet, "Gateway": ipv6_net2.gateway},
367                         ],
368                     }
369                 }
370             },
371         }
372         self.</b></font>assertEqual(ret["changes"], expected)
373         self.assertEqual(
374             ret["comment"],
375             "Network '{}' was replaced with updated config".format(ipv4_net.name),
376         )
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_mysql_2.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import salt.pillar.mysql as mysql
2 from tests.support.unit import TestCase, skipIf
3 @skipIf(mysql.MySQLdb is None, "MySQL-python module not installed")
4 class MysqlPillarTestCase(TestCase):
5     maxDiff = None
6     def test_001_extract_queries_legacy(self):
7         return_data = mysql.MySQLExtPillar()
8         args, kwargs = ["SELECT blah"], {}
9         qbuffer = return_data.extract_queries(args, kwargs)
10         self.assertEqual(
11             [
12                 [
13                     None,
14                     {
15                         "query": "SELECT blah",
16                         "depth": 0,
17                         "as_list": False,
18                         "as_json": False,
19                         "with_lists": None,
20                         "ignore_null": False,
21                     },
22                 ]
23             ],
24             qbuffer,
25         )
26     def test_002_extract_queries_list(self):
27         return_data = mysql.MySQLExtPillar()
28         args, kwargs = (
29             [
30                 "SELECT blah",
31                 "SELECT blah2",
32                 ("SELECT blah3",),
33                 ("SELECT blah4", 2),
34                 {"query": "SELECT blah5"},
35                 {"query": "SELECT blah6", "depth": 2},
36                 {"query": "SELECT blah7", "as_list": True},
37                 {"query": "SELECT blah8", "with_lists": "1"},
38                 {"query": "SELECT blah9", "with_lists": "1,2"},
39                 {"query": "SELECT json1", "as_json": True},
40             ],
41             {},
42         )
43 <a name="0"></a>        qbuffer = return_data.extract_queries(args, kwargs)
44         self.assertEqual(
45             [
46                 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>[
47                     None,
48                     {
49                         "query": "SELECT blah",
50                         "depth": 0,
51                         "as_list": False,
52                         "as_json": False,
53                         "with_lists": None,
54                         "ignore_null": False,
55                     },
56                 ],
57                 [
58                     None,
59                     {
60                         "query": "SELECT blah2",
61                         "depth": 0,
62                         "as_list": False,
63                         "as_json": False,
64                         "with_lists": None,
65                         "ignore_null": False,
66                     },
67                 ],
68                 [
69                     None,
70                     {
71                         "query": "SELECT blah3",
72                         "depth": 0,
73                         "as_list": False,
74                         "as_json": False,
75                         "with_lists": None,
76                         "ignore_null": False,
77                     },
78                 ],
79                 [
80                     None,
81                     {
82                         "query": "SELECT blah4",
83                         "depth": 2,
84                         "as_list": False,
85                         "as_json": False,
86                         "with_lists": None,
87                         "ignore_null": False,
88                     },
89                 ],
90                 [
91                     None,
92                     {
93                         "query": "SELECT blah5",
94                         "depth": 0,
95                         "as_list": False,
96                         "as_json": False,
97                         "with_lists": None,
98                         "ignore_null": False,
99                     },
100                 ],
101                 [
102                     None,
103                     {
104                         "query": "SELECT blah6",
105                         "depth": 2,
106                         "as_list": False,
107                         "as_json": False,
108                         "with_lists": None,
109                         "ignore_null": False,
110                     },
111                 ],
112                 [
113                     None,
114                     {
115                         "query": "SELECT blah7",
116                         "depth": 0,
117                         "as_list": True,
118                         "as_json": False,
119                         "with_lists": None,
120                         "ignore_null": False,
121                     },
122                 ],
123                 [
124                     None,
125                     {
126                         "query": "SELECT blah8",
127                         "depth": 0,
128                         "as_list": False,
129                         "as_json": False,
130                         "with_lists": [1],
131                         "ignore_null": False,
132                     },
133                 ],
134                 [
135                     None,
136                     {
137                         "query": "SELECT blah9",
138                         "depth": 0,
139                         "as_list": False,
140                         "as_json": False,
141                         "with_lists": [1</b></font>, 2],
142                         "ignore_null": False,
143                     },
144                 ],
145                 [
146                     None,
147                     {
148                         "query": "SELECT json1",
149                         "depth": 0,
150                         "as_list": False,
151                         "as_json": True,
152                         "with_lists": None,
153                         "ignore_null": False,
154                     },
155                 ],
156             ],
157             qbuffer,
158         )
159     def test_003_extract_queries_kwarg(self):
160         return_data = mysql.MySQLExtPillar()
161         args, kwargs = (
162             [],
163             {
164                 "1": "SELECT blah",
165                 "2": "SELECT blah2",
166                 "3": ("SELECT blah3",),
167                 "4": ("SELECT blah4", 2),
168                 "5": {"query": "SELECT blah5"},
169                 "6": {"query": "SELECT blah6", "depth": 2},
170                 "7": {"query": "SELECT blah7", "as_list": True},
171                 "8": {"query": "SELECT json1", "as_json": True},
172             },
173         )
174 <a name="1"></a>        qbuffer = return_data.extract_queries(args, kwargs)
175         self.assertEqual(
176             [
177                 <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>[
178                     "1",
179                     {
180                         "query": "SELECT blah",
181                         "depth": 0,
182                         "as_list": False,
183                         "as_json": False,
184                         "with_lists": None,
185                         "ignore_null": False,
186                     },
187                 ],
188                 [
189                     "2",
190                     {
191                         "query": "SELECT blah2",
192                         "depth": 0,
193                         "as_list": False,
194                         "as_json": False,
195                         "with_lists": None,
196                         "ignore_null": False,
197                     },
198                 ],
199                 [
200                     "3",
201                     {
202                         "query": "SELECT blah3",
203                         "depth": 0,
204                         "as_list": False,
205                         "as_json": False,
206                         "with_lists": None,
207                         "ignore_null": False,
208                     },
209                 ],
210                 [
211                     "4",
212                     {
213                         "query": "SELECT blah4",
214                         "depth": 2,
215                         "as_list": False,
216                         "as_json": False,
217                         "with_lists": None,
218                         "ignore_null": False,
219                     },
220                 ],
221                 [
222                     "5",
223                     {
224                         "query": "SELECT blah5",
225                         "depth": 0,
226                         "as_list": False,
227                         "as_json": False,
228                         "with_lists": None,
229                         "ignore_null": False,
230                     },
231                 ],
232                 [
233                     "6",
234                     {
235                         "query": "SELECT blah6",
236                         "depth": 2,
237                         "as_list": False,
238                         "as_json": False,
239                         "with_lists": None,
240                         "ignore_null": False,
241                     },
242                 ],
243                 [
244                     "7"</b></font>,
245                     {
246                         "query": "SELECT blah7",
247                         "depth": 0,
248                         "as_list": True,
249                         "as_json": False,
250                         "with_lists": None,
251                         "ignore_null": False,
252                     },
253                 ],
254                 [
255                     "8",
256                     {
257                         "query": "SELECT json1",
258                         "depth": 0,
259                         "as_list": False,
260                         "as_json": True,
261                         "with_lists": None,
262                         "ignore_null": False,
263                     },
264                 ],
265             ],
266             qbuffer,
267         )
268     def test_004_extract_queries_mixed(self):
269         return_data = mysql.MySQLExtPillar()
270         args, kwargs = (
271             [
272                 "SELECT blah1",
273                 ("SELECT blah2", 2),
274                 {"query": "SELECT blah3", "as_list": True},
275             ],
276             {
277                 "1": "SELECT blah1",
278                 "2": ("SELECT blah2", 2),
279                 "3": {"query": "SELECT blah3", "as_list": True},
280             },
281         )
282         qbuffer = return_data.extract_queries(args, kwargs)
283         self.assertEqual(
284             [
285                 [
286                     None,
287                     {
288                         "query": "SELECT blah1",
289                         "depth": 0,
290                         "as_list": False,
291                         "as_json": False,
292                         "with_lists": None,
293                         "ignore_null": False,
294                     },
295                 ],
296                 [
297                     None,
298                     {
299                         "query": "SELECT blah2",
300                         "depth": 2,
301                         "as_list": False,
302                         "as_json": False,
303                         "with_lists": None,
304                         "ignore_null": False,
305                     },
306                 ],
307                 [
308                     None,
309                     {
310                         "query": "SELECT blah3",
311                         "depth": 0,
312                         "as_list": True,
313                         "as_json": False,
314                         "with_lists": None,
315                         "ignore_null": False,
316                     },
317                 ],
318                 [
319                     "1",
320                     {
321                         "query": "SELECT blah1",
322                         "depth": 0,
323                         "as_list": False,
324                         "as_json": False,
325                         "with_lists": None,
326                         "ignore_null": False,
327                     },
328                 ],
329                 [
330                     "2",
331                     {
332                         "query": "SELECT blah2",
333                         "depth": 2,
334                         "as_list": False,
335                         "as_json": False,
336                         "with_lists": None,
337                         "ignore_null": False,
338                     },
339                 ],
340                 [
341                     "3",
342                     {
343                         "query": "SELECT blah3",
344                         "depth": 0,
345                         "as_list": True,
346                         "as_json": False,
347                         "with_lists": None,
348                         "ignore_null": False,
349                     },
350                 ],
351             ],
352             qbuffer,
353         )
354     def test_005_extract_queries_bogus_list(self):
355         return_data = mysql.MySQLExtPillar()
356         args, kwargs = (
357             [
358                 "SELECT blah",
359                 "",
360                 "SELECT blah2",
361                 ("SELECT blah3",),
362                 ("",),
363                 ("SELECT blah4", 2),
364                 tuple(),
365                 ("SELECT blah5",),
366                 {"query": "SELECT blah6"},
367                 {"query": ""},
368                 {"query": "SELECT blah7", "depth": 2},
369                 {"not_a_query": "in sight!"},
370                 {"query": "SELECT blah8", "as_list": True},
371             ],
372             {},
373         )
374         qbuffer = return_data.extract_queries(args, kwargs)
375         self.assertEqual(
376             [
377                 [
378                     None,
379                     {
380                         "query": "SELECT blah",
381                         "depth": 0,
382                         "as_list": False,
383                         "as_json": False,
384                         "with_lists": None,
385                         "ignore_null": False,
386                     },
387                 ],
388                 [
389                     None,
390                     {
391                         "query": "SELECT blah2",
392                         "depth": 0,
393                         "as_list": False,
394                         "as_json": False,
395                         "with_lists": None,
396                         "ignore_null": False,
397                     },
398                 ],
399                 [
400                     None,
401                     {
402                         "query": "SELECT blah3",
403                         "depth": 0,
404                         "as_list": False,
405                         "as_json": False,
406                         "with_lists": None,
407                         "ignore_null": False,
408                     },
409                 ],
410                 [
411                     None,
412                     {
413                         "query": "SELECT blah4",
414                         "depth": 2,
415                         "as_list": False,
416                         "as_json": False,
417                         "with_lists": None,
418                         "ignore_null": False,
419                     },
420                 ],
421                 [
422                     None,
423                     {
424                         "query": "SELECT blah5",
425                         "depth": 0,
426                         "as_list": False,
427                         "as_json": False,
428                         "with_lists": None,
429                         "ignore_null": False,
430                     },
431                 ],
432                 [
433                     None,
434                     {
435                         "query": "SELECT blah6",
436                         "depth": 0,
437                         "as_list": False,
438                         "as_json": False,
439                         "with_lists": None,
440                         "ignore_null": False,
441                     },
442                 ],
443                 [
444                     None,
445                     {
446                         "query": "SELECT blah7",
447                         "depth": 2,
448                         "as_list": False,
449                         "as_json": False,
450                         "with_lists": None,
451                         "ignore_null": False,
452                     },
453                 ],
454                 [
455                     None,
456                     {
457                         "query": "SELECT blah8",
458                         "depth": 0,
459                         "as_list": True,
460                         "as_json": False,
461                         "with_lists": None,
462                         "ignore_null": False,
463                     },
464                 ],
465             ],
466             qbuffer,
467         )
468     def test_006_extract_queries_bogus_kwargs(self):
469         return_data = mysql.MySQLExtPillar()
470         args, kwargs = [], {"1": "SELECT blah", "2": "", "3": "SELECT blah2"}
471         qbuffer = return_data.extract_queries(args, kwargs)
472         self.assertEqual(
473             [
474                 [
475                     "1",
476                     {
477                         "query": "SELECT blah",
478                         "depth": 0,
479                         "as_list": False,
480                         "as_json": False,
481                         "with_lists": None,
482                         "ignore_null": False,
483                     },
484                 ],
485                 [
486                     "3",
487                     {
488                         "query": "SELECT blah2",
489                         "depth": 0,
490                         "as_list": False,
491                         "as_json": False,
492                         "with_lists": None,
493                         "ignore_null": False,
494                     },
495                 ],
496             ],
497             qbuffer,
498         )
499     def test_011_enter_root(self):
500         return_data = mysql.MySQLExtPillar()
501         return_data.enter_root("test")
502         self.assertEqual(return_data.result["test"], return_data.focus)
503         return_data.enter_root(None)
504         self.assertEqual(return_data.result, return_data.focus)
505     def test_021_process_fields(self):
506         return_data = mysql.MySQLExtPillar()
507         return_data.process_fields(["a", "b"], 0)
508         self.assertEqual(return_data.num_fields, 2)
509         self.assertEqual(return_data.depth, 1)
510         return_data.process_fields(["a", "b"], 2)
511         self.assertEqual(return_data.num_fields, 2)
512         self.assertEqual(return_data.depth, 1)
513         return_data.process_fields(["a", "b", "c", "d"], 0)
514         self.assertEqual(return_data.num_fields, 4)
515         self.assertEqual(return_data.depth, 3)
516         return_data.process_fields(["a", "b", "c", "d"], 1)
517         self.assertEqual(return_data.num_fields, 4)
518         self.assertEqual(return_data.depth, 1)
519         return_data.process_fields(["a", "b", "c", "d"], 2)
520         self.assertEqual(return_data.num_fields, 4)
521         self.assertEqual(return_data.depth, 2)
522         return_data.process_fields(["a", "b", "c", "d"], 3)
523         self.assertEqual(return_data.num_fields, 4)
524         self.assertEqual(return_data.depth, 3)
525         return_data.process_fields(["a", "b", "c", "d"], 4)
526         self.assertEqual(return_data.num_fields, 4)
527         self.assertEqual(return_data.depth, 3)
528     def test_111_process_results_legacy(self):
529         return_data = mysql.MySQLExtPillar()
530         return_data.process_fields(["a", "b"], 0)
531         return_data.with_lists = []
532         return_data.process_results([[1, 2]])
533         self.assertEqual({1: 2}, return_data.result)
534     def test_112_process_results_legacy_multiple(self):
535         return_data = mysql.MySQLExtPillar()
536         return_data.process_fields(["a", "b"], 0)
537         return_data.with_lists = []
538         return_data.process_results([[1, 2], [3, 4], [5, 6]])
539         self.assertEqual({1: 2, 3: 4, 5: 6}, return_data.result)
540     def test_121_process_results_depth_0(self):
541         return_data = mysql.MySQLExtPillar()
542         return_data.process_fields(["a", "b", "c", "d"], 0)
543         return_data.with_lists = []
544         return_data.enter_root(None)
545         return_data.process_results([[1, 2, 3, 4], [5, 6, 7, 8]])
546         self.assertEqual({1: {2: {3: 4}}, 5: {6: {7: 8}}}, return_data.result)
547     def test_122_process_results_depth_1(self):
548         return_data = mysql.MySQLExtPillar()
549         return_data.process_fields(["a", "b", "c", "d"], 1)
550         return_data.with_lists = []
551         return_data.enter_root(None)
552         return_data.process_results([[1, 2, 3, 4], [5, 6, 7, 8]])
553         self.assertEqual(
554             {1: {"b": 2, "c": 3, "d": 4}, 5: {"b": 6, "c": 7, "d": 8}},
555             return_data.result,
556         )
557     def test_123_process_results_depth_2(self):
558         return_data = mysql.MySQLExtPillar()
559         return_data.process_fields(["a", "b", "c", "d"], 2)
560         return_data.with_lists = []
561         return_data.enter_root(None)
562         return_data.process_results([[1, 2, 3, 4], [5, 6, 7, 8]])
563         self.assertEqual(
564             {1: {2: {"c": 3, "d": 4}}, 5: {6: {"c": 7, "d": 8}}}, return_data.result
565         )
566     def test_124_process_results_depth_3(self):
567         return_data = mysql.MySQLExtPillar()
568         return_data.process_fields(["a", "b", "c", "d"], 3)
569         return_data.with_lists = []
570         return_data.enter_root(None)
571         return_data.process_results([[1, 2, 3, 4], [5, 6, 7, 8]])
572         self.assertEqual({1: {2: {3: 4}}, 5: {6: {7: 8}}}, return_data.result)
573     def test_125_process_results_depth_4(self):
574         return_data = mysql.MySQLExtPillar()
575         return_data.process_fields(["a", "b", "c", "d"], 4)
576         return_data.with_lists = []
577         return_data.enter_root(None)
578         return_data.process_results([[1, 2, 3, 4], [5, 6, 7, 8]])
579         self.assertEqual({1: {2: {3: 4}}, 5: {6: {7: 8}}}, return_data.result)
580     def test_131_process_results_overwrite_legacy_multiple(self):
581         return_data = mysql.MySQLExtPillar()
582         return_data.process_fields(["a", "b"], 0)
583         return_data.with_lists = []
584         return_data.process_results([[1, 2], [3, 4], [1, 6]])
585         self.assertEqual({1: 6, 3: 4}, return_data.result)
586     def test_132_process_results_merge_depth_0(self):
587         return_data = mysql.MySQLExtPillar()
588         return_data.process_fields(["a", "b", "c", "d"], 0)
589         return_data.with_lists = []
590         return_data.enter_root(None)
591         return_data.process_results([[1, 2, 3, 4], [1, 6, 7, 8]])
592         self.assertEqual({1: {2: {3: 4}, 6: {7: 8}}}, return_data.result)
593     def test_133_process_results_overwrite_depth_0(self):
594         return_data = mysql.MySQLExtPillar()
595         return_data.process_fields(["a", "b", "c", "d"], 0)
596         return_data.with_lists = []
597         return_data.enter_root(None)
598         return_data.process_results([[1, 2, 3, 4], [1, 2, 3, 8]])
599         self.assertEqual({1: {2: {3: 8}}}, return_data.result)
600     def test_134_process_results_deepmerge_depth_0(self):
601         return_data = mysql.MySQLExtPillar()
602         return_data.process_fields(["a", "b", "c", "d"], 0)
603         return_data.with_lists = []
604         return_data.enter_root(None)
605         return_data.process_results([[1, 2, 3, 4], [1, 2, 7, 8]])
606         self.assertEqual({1: {2: {3: 4, 7: 8}}}, return_data.result)
607     def test_135_process_results_overwrite_depth_1(self):
608         return_data = mysql.MySQLExtPillar()
609         return_data.process_fields(["a", "b", "c", "d"], 1)
610         return_data.with_lists = []
611         return_data.enter_root(None)
612         return_data.process_results([[1, 2, 3, 4], [1, 6, 7, 8]])
613         self.assertEqual({1: {"b": 6, "c": 7, "d": 8}}, return_data.result)
614     def test_136_process_results_merge_depth_2(self):
615         return_data = mysql.MySQLExtPillar()
616         return_data.process_fields(["a", "b", "c", "d"], 2)
617         return_data.with_lists = []
618         return_data.enter_root(None)
619         return_data.process_results([[1, 2, 3, 4], [1, 6, 7, 8]])
620         self.assertEqual(
621             {1: {2: {"c": 3, "d": 4}, 6: {"c": 7, "d": 8}}}, return_data.result
622         )
623     def test_137_process_results_overwrite_depth_2(self):
624         return_data = mysql.MySQLExtPillar()
625         return_data.process_fields(["a", "b", "c", "d"], 2)
626         return_data.with_lists = []
627         return_data.enter_root(None)
628         return_data.process_results([[1, 2, 3, 4], [1, 2, 7, 8]])
629         self.assertEqual({1: {2: {"c": 7, "d": 8}}}, return_data.result)
630     def test_201_process_results_complexity_multiresults(self):
631         return_data = mysql.MySQLExtPillar()
632         return_data.process_fields(["a", "b", "c", "d"], 2)
633         return_data.with_lists = []
634         return_data.enter_root(None)
635         return_data.process_results([[1, 2, 3, 4]])
636         return_data.process_results([[1, 2, 7, 8]])
637         self.assertEqual({1: {2: {"c": 7, "d": 8}}}, return_data.result)
638     def test_202_process_results_complexity_as_list(self):
639         return_data = mysql.MySQLExtPillar()
640         return_data.process_fields(["a", "b", "c", "d"], 2)
641         return_data.with_lists = []
642         return_data.enter_root(None)
643         return_data.as_list = True
644         return_data.process_results([[1, 2, 3, 4]])
645         return_data.process_results([[1, 2, 7, 8]])
646         self.assertEqual({1: {2: {"c": [3, 7], "d": [4, 8]}}}, return_data.result)
647     def test_203_process_results_complexity_as_list_deeper(self):
648         return_data = mysql.MySQLExtPillar()
649         return_data.process_fields(["a", "b", "c", "d"], 0)
650         return_data.with_lists = []
651         return_data.enter_root(None)
652         return_data.as_list = True
653         return_data.process_results([[1, 2, 3, 4]])
654         return_data.process_results([[1, 2, 3, 8]])
655         self.assertEqual({1: {2: {3: [4, 8]}}}, return_data.result)
656     def test_204_process_results_complexity_as_list_mismatch_depth(self):
657         return_data = mysql.MySQLExtPillar()
658         return_data.as_list = True
659         return_data.with_lists = []
660         return_data.enter_root(None)
661         return_data.process_fields(["a", "b", "c", "d"], 0)
662         return_data.process_results([[1, 2, 3, 4]])
663         return_data.process_results([[1, 2, 3, 5]])
664         return_data.process_fields(["a", "b", "c", "d", "e"], 0)
665         return_data.process_results([[1, 2, 3, 6, 7]])
666         self.assertEqual({1: {2: {3: [4, 5, {6: 7}]}}}, return_data.result)
667     def test_205_process_results_complexity_as_list_mismatch_depth_reversed(self):
668         return_data = mysql.MySQLExtPillar()
669         return_data.as_list = True
670         return_data.with_lists = []
671         return_data.enter_root(None)
672         return_data.process_fields(["a", "b", "c", "d", "e"], 0)
673         return_data.process_results([[1, 2, 3, 6, 7]])
674         return_data.process_results([[1, 2, 3, 8, 9]])
675         return_data.process_fields(["a", "b", "c", "d"], 0)
676         return_data.process_results([[1, 2, 3, 4]])
677         return_data.process_results([[1, 2, 3, 5]])
678         self.assertEqual({1: {2: {3: [{6: 7, 8: 9}, 4, 5]}}}, return_data.result)
679     def test_206_process_results_complexity_as_list_mismatch_depth_weird_order(self):
680         return_data = mysql.MySQLExtPillar()
681         return_data.as_list = True
682         return_data.with_lists = []
683         return_data.enter_root(None)
684         return_data.process_fields(["a", "b", "c", "d", "e"], 0)
685         return_data.process_results([[1, 2, 3, 6, 7]])
686         return_data.process_fields(["a", "b", "c", "d"], 0)
687         return_data.process_results([[1, 2, 3, 4]])
688         return_data.process_fields(["a", "b", "c", "d", "e"], 0)
689         return_data.process_results([[1, 2, 3, 8, 9]])
690         return_data.process_fields(["a", "b", "c", "d"], 0)
691         return_data.process_results([[1, 2, 3, 5]])
692         self.assertEqual({1: {2: {3: [{6: 7}, 4, {8: 9}, 5]}}}, return_data.result)
693     def test_207_process_results_complexity_collision_mismatch_depth(self):
694         return_data = mysql.MySQLExtPillar()
695         return_data.as_list = False
696         return_data.with_lists = []
697         return_data.enter_root(None)
698         return_data.process_fields(["a", "b", "c", "d"], 0)
699         return_data.process_results([[1, 2, 3, 4]])
700         return_data.process_results([[1, 2, 3, 5]])
701         return_data.process_fields(["a", "b", "c", "d", "e"], 0)
702         return_data.process_results([[1, 2, 3, 6, 7]])
703         self.assertEqual({1: {2: {3: {6: 7}}}}, return_data.result)
704     def test_208_process_results_complexity_collision_mismatch_depth_reversed(self):
705         return_data = mysql.MySQLExtPillar()
706         return_data.as_list = False
707         return_data.with_lists = []
708         return_data.enter_root(None)
709         return_data.process_fields(["a", "b", "c", "d", "e"], 0)
710         return_data.process_results([[1, 2, 3, 6, 7]])
711         return_data.process_results([[1, 2, 3, 8, 9]])
712         return_data.process_fields(["a", "b", "c", "d"], 0)
713         return_data.process_results([[1, 2, 3, 4]])
714         return_data.process_results([[1, 2, 3, 5]])
715         self.assertEqual({1: {2: {3: 5}}}, return_data.result)
716     def test_209_process_results_complexity_collision_mismatch_depth_weird_order(self):
717         return_data = mysql.MySQLExtPillar()
718         return_data.as_list = False
719         return_data.with_lists = []
720         return_data.enter_root(None)
721         return_data.process_fields(["a", "b", "c", "d", "e"], 0)
722         return_data.process_results([[1, 2, 3, 6, 7]])
723         return_data.process_fields(["a", "b", "c", "d"], 0)
724         return_data.process_results([[1, 2, 3, 4]])
725         return_data.process_fields(["a", "b", "c", "d", "e"], 0)
726         return_data.process_results([[1, 2, 3, 8, 9]])
727         return_data.process_fields(["a", "b", "c", "d"], 0)
728         return_data.process_results([[1, 2, 3, 5]])
729         self.assertEqual({1: {2: {3: 5}}}, return_data.result)
730     def test_20A_process_results_complexity_as_list_vary(self):
731         return_data = mysql.MySQLExtPillar()
732         return_data.as_list = True
733         return_data.with_lists = []
734         return_data.enter_root(None)
735         return_data.process_fields(["a", "b", "c", "d", "e"], 0)
736         return_data.process_results([[1, 2, 3, 6, 7]])
737         return_data.process_results([[1, 2, 3, 8, 9]])
738         return_data.process_fields(["a", "b", "c", "d"], 0)
739         return_data.process_results([[1, 2, 3, 4]])
740         return_data.as_list = False
741         return_data.process_results([[1, 2, 3, 5]])
742         self.assertEqual({1: {2: {3: 5}}}, return_data.result)
743     def test_207_process_results_complexity_roots_collision(self):
744         return_data = mysql.MySQLExtPillar()
745         return_data.as_list = False
746         return_data.with_lists = []
747         return_data.enter_root(None)
748         return_data.process_fields(["a", "b", "c", "d"], 0)
749         return_data.process_results([[1, 2, 3, 4]])
750         return_data.enter_root(1)
751         return_data.process_results([[5, 6, 7, 8]])
752         self.assertEqual({1: {5: {6: {7: 8}}}}, return_data.result)
753     def test_301_process_results_with_lists(self):
754         return_data = mysql.MySQLExtPillar()
755         return_data.as_list = False
756         return_data.with_lists = [1, 3]
757         return_data.enter_root(None)
758         return_data.process_fields(["a", "b", "c", "d", "e", "v"], 0)
759         return_data.process_results(
760             [
761                 ["a", "b", "c", "d", "e", 1],
762                 ["a", "b", "c", "f", "g", 2],
763                 ["a", "z", "h", "y", "j", 3],
764                 ["a", "z", "h", "y", "k", 4],
765             ]
766         )
767         assert "a" in return_data.result
768         for x in return_data.result["a"]:
769             if "c" in x:
770                 assert list(x.keys()) == ["c"], x.keys()
771                 for y in x["c"]:
772                     if "e" in y:
773                         assert list(y.keys()) == ["e"]
774                         assert y["e"] == 1
775                     elif "g" in y:
776                         assert list(y.keys()) == ["g"]
777                         assert y["g"] == 2
778                     else:
779                         raise ValueError("Unexpected value {}".format(y))
780             elif "h" in x:
781                 assert len(x["h"]) == 1
782                 for y in x["h"]:
783                     if "j" in y:
784                         assert len(y.keys()) == 2
785                         assert y["j"] == 3
786                     elif "h" in y:
787                         assert len(y.keys()) == 2
788                         assert y["k"] == 4
789                     else:
790                         raise ValueError("Unexpected value {}".format(y))
791             else:
792                 raise ValueError("Unexpected value {}".format(x))
793     def test_302_process_results_with_lists_consecutive(self):
794         return_data = mysql.MySQLExtPillar()
795         return_data.as_list = False
796         return_data.with_lists = [1, 2, 3]
797         return_data.enter_root(None)
798         return_data.process_fields(["a", "b", "c", "d", "e", "v"], 0)
799         return_data.process_results(
800             [
801                 ["a", "b", "c", "d", "e", 1],
802                 ["a", "b", "c", "f", "g", 2],
803                 ["a", "z", "h", "y", "j", 3],
804                 ["a", "z", "h", "y", "k", 4],
805             ]
806         )
807         assert "a" in return_data.result
808         for x in return_data.result["a"]:
809             assert len(x) == 1
810             if len(x[0][0]) == 1:
811                 for y in x[0]:
812                     if "e" in y:
813                         assert list(y.keys()) == ["e"]
814                         assert y["e"] == 1
815                     elif "g" in y:
816                         assert list(y.keys()) == ["g"]
817                         assert y["g"] == 2
818                     else:
819                         raise ValueError("Unexpected value {}".format(y))
820             elif len(x[0][0]) == 2:
821                 for y in x[0]:
822                     if "j" in y:
823                         assert len(y.keys()) == 2
824                         assert y["j"] == 3
825                     elif "k" in y:
826                         assert len(y.keys()) == 2
827                         assert y["k"] == 4
828                     else:
829                         raise ValueError("Unexpected value {}".format(len(x[0][0])))
830             else:
831                 raise ValueError("Unexpected value {}".format(x))
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
