<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_tidied.py &amp; test_pydsl.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_tidied.py &amp; test_pydsl.py
      </h3>
<h1 align="center">
        6.0%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_tidied.py (16.470589%)<th>test_pydsl.py (3.6793692%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(27-32)<td><a href="#" name="0">(109-114)</a><td align="center"><font color="#ff0000">15</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(1-14)<td><a href="#" name="1">(7-20)</a><td align="center"><font color="#dd0000">13</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_tidied.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <a name="1"></a><font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import logging
2 import os
3 from datetime import datetime
4 import pytest
5 import salt.states.file as filestate
6 import salt.utils.files
7 import salt.utils.json
8 import salt.utils.platform
9 import salt.utils.win_functions
10 import salt.utils.yaml
11 from tests.support.mock import MagicMock, patch
12 log = logging.</b></font>getLogger(__name__)
13 @pytest.fixture
14 def configure_loader_modules():
15     return {filestate: {"__salt__": {}, "__opts__": {}}}
16 def test__tidied():
17     name = os.sep + "test"
18 <a name="0"></a>    if salt.utils.platform.is_windows():
19         name = "c:" + name
20     walker = [
21         (os<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.path.join("test", "test1"), [], ["file1"]),
22         (os.path.join("test", "test2", "test3"), [], []),
23         (os.path.join("test", "test2"), ["test3"], ["file2"]),
24         ("test", ["test1", "test2"], ["file3"]),
25     ]
26     today_delta = datetime.</b></font>today() - datetime.utcfromtimestamp(0)
27     remove = MagicMock(name="file.remove")
28     with patch("os.walk", return_value=walker), patch(
29         "os.path.islink", return_value=False
30     ), patch("os.path.getatime", return_value=today_delta.total_seconds()), patch(
31         "os.path.getsize", return_value=10
32     ), patch.dict(
33         filestate.__opts__, {"test": False}
34     ), patch.dict(
35         filestate.__salt__, {"file.remove": remove}
36     ), patch(
37         "os.path.isdir", return_value=True
38     ):
39         ret = filestate.tidied(name=name)
40     exp = {
41         "name": name,
42         "changes": {
43             "removed": [
44                 os.path.join("test", "test1", "file1"),
45                 os.path.join("test", "test2", "file2"),
46                 os.path.join("test", "file3"),
47             ]
48         },
49         "result": True,
50         "comment": "Removed 3 files or directories from directory {}".format(name),
51     }
52     assert exp == ret
53     assert remove.call_count == 3
54     remove.reset_mock()
55     with patch("os.walk", return_value=walker), patch(
56         "os.path.islink", return_value=False
57     ), patch("os.path.getatime", return_value=today_delta.total_seconds()), patch(
58         "os.path.getsize", return_value=10
59     ), patch.dict(
60         filestate.__opts__, {"test": False}
61     ), patch.dict(
62         filestate.__salt__, {"file.remove": remove}
63     ), patch(
64         "os.path.isdir", return_value=True
65     ):
66         ret = filestate.tidied(name=name, rmdirs=True)
67     exp = {
68         "name": name,
69         "changes": {
70             "removed": [
71                 os.path.join("test", "test1", "file1"),
72                 os.path.join("test", "test2", "file2"),
73                 os.path.join("test", "test2", "test3"),
74                 os.path.join("test", "file3"),
75                 os.path.join("test", "test1"),
76                 os.path.join("test", "test2"),
77             ]
78         },
79         "result": True,
80         "comment": "Removed 6 files or directories from directory {}".format(name),
81     }
82     assert exp == ret
83     assert remove.call_count == 6
84 def test__bad_input():
85     exp = {
86         "name": "test/",
87         "changes": {},
88         "result": False,
89         "comment": "Specified file test/ is not an absolute path",
90     }
91     assert filestate.tidied(name="test/") == exp
92     exp = {
93         "name": "/bad-directory-name/",
94         "changes": {},
95         "result": False,
96         "comment": "/bad-directory-name/ does not exist or is not a directory.",
97     }
98     assert filestate.tidied(name="/bad-directory-name/") == exp
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_pydsl.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import copy
2 import io
3 import os
4 <a name="1"></a>import shutil
5 import sys
6 import tempfile
7 <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import textwrap
8 import pytest
9 import salt.config
10 import salt.loader
11 import salt.utils.files
12 import salt.utils.versions
13 from salt.state import HighState
14 from salt.utils.pydsl import PyDslError
15 from tests.support.helpers import with_tempdir
16 from tests.support.runtests import RUNTIME_VARS
17 from tests.support.unit import TestCase
18 REQUISITES = ["require"</b></font>, "require_in", "use", "use_in", "watch", "watch_in"]
19 class CommonTestCaseBoilerplate(TestCase):
20     def setUp(self):
21         self.root_dir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)
22         self.addCleanup(shutil.rmtree, self.root_dir, ignore_errors=True)
23         self.state_tree_dir = os.path.join(self.root_dir, "state_tree")
24         self.cache_dir = os.path.join(self.root_dir, "cachedir")
25         if not os.path.isdir(self.root_dir):
26             os.makedirs(self.root_dir)
27         if not os.path.isdir(self.state_tree_dir):
28             os.makedirs(self.state_tree_dir)
29         if not os.path.isdir(self.cache_dir):
30             os.makedirs(self.cache_dir)
31         self.config = salt.config.minion_config(None)
32         self.config["root_dir"] = self.root_dir
33         self.config["state_events"] = False
34         self.config["id"] = "match"
35         self.config["file_client"] = "local"
36         self.config["file_roots"] = dict(base=[self.state_tree_dir])
37         self.config["cachedir"] = self.cache_dir
38         self.config["test"] = False
39         self.config["grains"] = salt.loader.grains(self.config)
40         self.HIGHSTATE = HighState(self.config)
41         self.HIGHSTATE.push_active()
42     def tearDown(self):
43         try:
44             self.HIGHSTATE.pop_active()
45         except IndexError:
46             pass
47         del self.config
48         del self.HIGHSTATE
49     def state_highstate(self, state, dirpath):
50         opts = copy.copy(self.config)
51         opts["file_roots"] = dict(base=[dirpath])
52         HIGHSTATE = HighState(opts)
53         HIGHSTATE.push_active()
54         try:
55             high, errors = HIGHSTATE.render_highstate(state)
56             if errors:
57                 import pprint
58                 pprint.pprint("\n".join(errors))
59                 pprint.pprint(high)
60             out = HIGHSTATE.state.call_high(high)
61         finally:
62             HIGHSTATE.pop_active()
63 class PyDSLRendererTestCase(CommonTestCaseBoilerplate):
64     def render_sls(self, content, sls="", saltenv="base", **kws):
65         if "env" in kws:
66             kws.pop("env")
67         return self.HIGHSTATE.state.rend["pydsl"](
68             io.StringIO(content), saltenv=saltenv, sls=sls, **kws
69         )
70     @pytest.mark.slow_test
71     def test_state_declarations(self):
72         result = self.render_sls(
73             textwrap.dedent(
74             )
75 <a name="0"></a>        )
76         self.assertTrue("A" in result and "X" in result)
77         A_cmd = result["A"]["cmd"]
78         self.assertEqual(A_cmd<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>[0], "run")
79         self.assertEqual(A_cmd[1]["name"], "ls -la")
80         self.assertEqual(A_cmd[2]["cwd"], "/var/tmp")
81         self.assertEqual(A_cmd[3]["shell"], "/bin/bash")
82         A_service = result[</b></font>"A"]["service"]
83         self.assertEqual(A_service[0], "running")
84         self.assertEqual(A_service[1]["name"], "apache")
85         X_cmd = result["X"]["cmd"]
86         self.assertEqual(X_cmd[0], "run")
87         self.assertEqual(X_cmd[1]["name"], "echo hello world")
88         self.assertEqual(X_cmd[2]["cwd"], "/")
89         del result["A"]
90         del result["X"]
91         self.assertEqual(len(result), 2)
92         s_iter = iter(result.values())
93         try:
94             s = next(s_iter)["file"]
95         except KeyError:
96             s = next(s_iter)["file"]
97         self.assertEqual(s[0], "managed")
98         self.assertEqual(s[1]["name"], "myfile.txt")
99         self.assertEqual(s[2]["source"], "salt://path/to/file")
100     @pytest.mark.slow_test
101     def test_requisite_declarations(self):
102         result = self.render_sls(
103             textwrap.dedent(
104             )
105         )
106         self.assertEqual(len(result), 6)
107         self.assertTrue(set("X A B G H".split()).issubset(set(result.keys())))
108         b = result["B"]["cmd"]
109         self.assertEqual(b[0], "run")
110         self.assertEqual(b[1]["name"], "ls -la")
111         self.assertEqual(b[2]["cwd"], "/var/tmp")
112         self.assertEqual(b[3]["require"][0]["cmd"], "X")
113         self.assertEqual(b[4]["require"][0]["cmd"], "A")
114         self.assertEqual(b[5]["watch"][0]["service"], "G")
115         self.assertEqual(result["G"]["service"][2]["watch_in"][0]["cmd"], "A")
116         self.assertEqual(result["H"]["cmd"][1]["require_in"][0]["cmd"], "echo hello")
117     @pytest.mark.slow_test
118     def test_include_extend(self):
119         result = self.render_sls(
120             textwrap.dedent(
121             )
122         )
123         self.assertEqual(len(result), 4)
124         self.assertEqual(
125             result["include"],
126             [
127                 {"base": sls}
128                 for sls in ("some.sls.file", "another.sls.file", "more.sls.file")
129             ],
130         )
131         extend = result["extend"]
132         self.assertEqual(extend["X"]["cmd"][0], "run")
133         self.assertEqual(extend["X"]["cmd"][1]["cwd"], "/a/b/c")
134         self.assertEqual(extend["Y"]["file"][0], "managed")
135         self.assertEqual(extend["Y"]["file"][1]["name"], "a_file.txt")
136         self.assertEqual(len(extend["Z"]["service"]), 1)
137         self.assertEqual(extend["Z"]["service"][0]["watch"][0]["file"], "A")
138         self.assertEqual(result["B"]["cmd"][0], "run")
139         self.assertTrue("A" not in result)
140         self.assertEqual(extend["A"]["cmd"][0], "run")
141     @pytest.mark.slow_test
142     def test_cmd_call(self):
143         result = self.HIGHSTATE.state.call_template_str(
144             textwrap.dedent(
145             )
146         )
147         ret = next(result[k] for k in result.keys() if "do_something" in k)
148         changes = ret["changes"]
149         self.assertEqual(
150             changes, dict(a=1, b=2, args=(3,), kws=dict(x=1, y=2), some_var=12345)
151         )
152         ret = next(result[k] for k in result.keys() if "-G_" in k)
153         self.assertEqual(ret["changes"]["stdout"], "this is state G")
154     @pytest.mark.slow_test
155     def test_multiple_state_func_in_state_mod(self):
156         with self.assertRaisesRegex(PyDslError, "Multiple state functions"):
157             self.render_sls(
158                 textwrap.dedent(
159                 )
160             )
161     @pytest.mark.slow_test
162     def test_no_state_func_in_state_mod(self):
163         with self.assertRaisesRegex(PyDslError, "No state function specified"):
164             self.render_sls(
165                 textwrap.dedent(
166                 )
167             )
168     @pytest.mark.slow_test
169     def test_load_highstate(self):
170         result = self.render_sls(
171             textwrap.dedent(
172             )
173         )
174         self.assertEqual(len(result), 3)
175         self.assertEqual(result["A"]["cmd"][0], "run")
176         self.assertIn({"name": "echo hello"}, result["A"]["cmd"])
177         self.assertIn({"cwd": "/"}, result["A"]["cmd"])
178         self.assertIn({"name": "echo hello world"}, result["A"]["cmd"])
179         self.assertEqual(len(result["A"]["cmd"]), 4)
180         self.assertEqual(len(result["B"]["pkg"]), 1)
181         self.assertEqual(result["B"]["pkg"][0], "installed")
182         self.assertEqual(result["B"]["service"][0], "running")
183         self.assertIn({"require": [{"pkg": "B"}]}, result["B"]["service"])
184         self.assertIn({"watch": [{"cmd": "A"}]}, result["B"]["service"])
185         self.assertEqual(len(result["B"]["service"]), 3)
186     @pytest.mark.slow_test
187     def test_ordered_states(self):
188         result = self.render_sls(
189             textwrap.dedent(
190             )
191         )
192         self.assertEqual(len(result["B"]["cmd"]), 3)
193         self.assertEqual(result["A"]["cmd"][1]["require"][0]["cmd"], "B")
194         self.assertEqual(result["C"]["cmd"][1]["require"][0]["cmd"], "A")
195         self.assertEqual(result["B"]["file"][1]["require"][0]["cmd"], "C")
196     @with_tempdir()
197     @pytest.mark.slow_test
198     def test_pipe_through_stateconf(self, dirpath):
199         output = os.path.join(dirpath, "output")
200         write_to(
201             os.path.join(dirpath, "xxx.sls"),
202             textwrap.dedent(
203                     output.replace("\\", "/")
204                 )
205             ),
206         )
207         write_to(
208             os.path.join(dirpath, "yyy.sls"),
209             textwrap.dedent(
210                     output.replace("\\", "/")
211                 )
212             ),
213         )
214         write_to(
215             os.path.join(dirpath, "aaa.sls"),
216             textwrap.dedent(
217                     output.replace("\\", "/")
218                 )
219             ),
220         )
221         self.state_highstate({"base": ["aaa"]}, dirpath)
222         with salt.utils.files.fopen(output, "r") as f:
223             self.assertEqual("".join(f.read().split()), "XYZABCDEF")
224     @with_tempdir()
225     @pytest.mark.slow_test
226     def test_compile_time_state_execution(self, dirpath):
227         if not sys.stdin.isatty():
228             self.skipTest("Not attached to a TTY")
229         write_to(
230             os.path.join(dirpath, "aaa.sls"),
231             textwrap.dedent(
232                     dirpath.replace("\\", "/")
233                 )
234             ),
235         )
236         self.state_highstate({"base": ["aaa"]}, dirpath)
237         with salt.utils.files.fopen(os.path.join(dirpath, "yyy.txt"), "rt") as f:
238             self.assertEqual(f.read(), "hehe" + os.linesep + "hoho" + os.linesep)
239         with salt.utils.files.fopen(os.path.join(dirpath, "xxx.txt"), "rt") as f:
240             self.assertEqual(f.read(), "hehe" + os.linesep)
241     @with_tempdir()
242     @pytest.mark.slow_test
243     def test_nested_high_state_execution(self, dirpath):
244         output = os.path.join(dirpath, "output")
245         write_to(
246             os.path.join(dirpath, "aaa.sls"),
247             textwrap.dedent(
248             ),
249         )
250         write_to(
251             os.path.join(dirpath, "bbb.sls"),
252             textwrap.dedent(
253             ),
254         )
255         write_to(
256             os.path.join(dirpath, "ccc.sls"),
257             textwrap.dedent(
258             ),
259         )
260         self.state_highstate({"base": ["aaa"]}, dirpath)
261     @with_tempdir()
262     @pytest.mark.slow_test
263     def test_repeat_includes(self, dirpath):
264         output = os.path.join(dirpath, "output")
265         write_to(
266             os.path.join(dirpath, "b.sls"),
267             textwrap.dedent(
268             ),
269         )
270         write_to(
271             os.path.join(dirpath, "c.sls"),
272             textwrap.dedent(
273             ),
274         )
275         write_to(
276             os.path.join(dirpath, "d.sls"),
277             textwrap.dedent(
278             ),
279         )
280         write_to(
281             os.path.join(dirpath, "e.sls"),
282             textwrap.dedent(
283             ),
284         )
285         self.state_highstate({"base": ["b"]}, dirpath)
286         self.state_highstate({"base": ["c", "d"]}, dirpath)
287 def write_to(fpath, content):
288     with salt.utils.files.fopen(fpath, "w") as f:
289         f.write(content)
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
