<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_parsers.py &amp; gce.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_parsers.py &amp; gce.py
      </h3>
<h1 align="center">
        1.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_parsers.py (2.0607376%)<th>gce.py (1.4100186%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(342-346)<td><a href="#" name="0">(269-272)</a><td align="center"><font color="#ff0000">14</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(554-558)<td><a href="#" name="1">(2437-2445)</a><td align="center"><font color="#da0000">12</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(5-17)<td><a href="#" name="2">(48-60)</a><td align="center"><font color="#da0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_parsers.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import os
2 import shutil
3 import tempfile
4 import salt.config
5 import salt.log.setup as log
6 import salt.syspaths
7 import salt.utils.jid
8 import salt.utils.parsers
9 import salt.utils.platform
10 from tests.support.mock import MagicMock, patch
11 from tests.support.runtests import RUNTIME_VARS
12 from</b></font> tests.support.unit import TestCase, skipIf
13 class ErrorMock:  # pylint: disable=too-few-public-methods
14     def __init__(self):
15         self.msg = None
16     def error(self, msg):
17         self.msg = msg
18 class LogSetupMock:
19     def __init__(self):
20         self.log_level = None
21         self.log_file = None
22         self.log_level_logfile = None
23         self.config = {}
24         self.temp_log_level = None
25     def setup_console_logger(
26         self, log_level="error", **kwargs
27     ):  # pylint: disable=unused-argument
28         self.log_level = log_level
29     def setup_extended_logging(self, opts):
30         self.config = opts
31     def setup_logfile_logger(
32         self, logfile, loglevel, **kwargs
33     ):  # pylint: disable=unused-argument
34         self.log_file = logfile
35         self.log_level_logfile = loglevel
36     @staticmethod
37     def get_multiprocessing_logging_queue():  # pylint: disable=invalid-name
38         import multiprocessing
39         return multiprocessing.Queue()
40     def setup_multiprocessing_logging_listener(
41         self, opts, *args
42     ):  # pylint: disable=invalid-name,unused-argument
43         self.config = opts
44     def setup_temp_logger(self, log_level="error"):
45         self.temp_log_level = log_level
46 class ObjectView:  # pylint: disable=too-few-public-methods
47     def __init__(self, d):
48         self.__dict__ = d
49 class ParserBase:
50     args = []
51     skip_console_logging_config = False
52     log_setup = None
53     loglevel_config_setting_name = "log_level"
54     logfile_config_setting_name = "log_file"
55     logfile_loglevel_config_setting_name = (
56         "log_level_logfile"  # pylint: disable=invalid-name
57     )
58     @classmethod
59     def setUpClass(cls):
60         cls.root_dir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)
61     @classmethod
62     def tearDownClass(cls):
63         shutil.rmtree(cls.root_dir, ignore_errors=True)
64     def setup_log(self):
65         testing_config = self.default_config.copy()
66         testing_config["root_dir"] = self.root_dir
67         for name in ("pki_dir", "cachedir"):
68             testing_config[name] = name
69         testing_config[self.logfile_config_setting_name] = getattr(
70             self, self.logfile_config_setting_name, self.log_file
71         )
72         self.testing_config = testing_config
73         self.addCleanup(setattr, self, "testing_config", None)
74         self.log_setup = LogSetupMock()
75         patcher = patch.multiple(
76             log,
77             setup_console_logger=self.log_setup.setup_console_logger,
78             setup_extended_logging=self.log_setup.setup_extended_logging,
79             setup_logfile_logger=self.log_setup.setup_logfile_logger,
80             get_multiprocessing_logging_queue=self.log_setup.get_multiprocessing_logging_queue,
81             setup_multiprocessing_logging_listener=self.log_setup.setup_multiprocessing_logging_listener,
82             setup_temp_logger=self.log_setup.setup_temp_logger,
83         )
84         patcher.start()
85         self.addCleanup(patcher.stop)
86         self.addCleanup(setattr, self, "log_setup", None)
87     def test_get_log_level_cli(self):
88         default_log_level = self.testing_config[self.loglevel_config_setting_name]
89         log_level = "critical"
90         args = ["--log-level", log_level] + self.args
91         parser = self.parser()
92         with patch(self.config_func, MagicMock(return_value=self.testing_config)):
93             parser.parse_args(args)
94         with patch("salt.utils.parsers.is_writeable", MagicMock(return_value=True)):
95             parser.setup_logfile_logger()
96         console_log_level = getattr(parser.options, self.loglevel_config_setting_name)
97         self.assertEqual(console_log_level, log_level)
98         self.assertEqual(self.log_setup.log_level, log_level)
99         self.assertEqual(
100             self.log_setup.config[self.loglevel_config_setting_name], log_level
101         )
102         self.assertEqual(self.log_setup.temp_log_level, log_level)
103         self.assertEqual(self.log_setup.log_level_logfile, default_log_level)
104     def test_get_log_level_config(self):
105         args = self.args
106         log_level = "info"
107         opts = self.testing_config.copy()
108         opts.update({self.loglevel_config_setting_name: log_level})
109         parser = self.parser()
110         with patch(self.config_func, MagicMock(return_value=opts)):
111             parser.parse_args(args)
112         with patch("salt.utils.parsers.is_writeable", MagicMock(return_value=True)):
113             parser.setup_logfile_logger()
114         console_log_level = getattr(parser.options, self.loglevel_config_setting_name)
115         self.assertEqual(console_log_level, log_level)
116         self.assertEqual(self.log_setup.log_level, log_level)
117         self.assertEqual(
118             self.log_setup.config[self.loglevel_config_setting_name], log_level
119         )
120         self.assertEqual(self.log_setup.temp_log_level, "error")
121         self.assertEqual(self.log_setup.log_level_logfile, log_level)
122     def test_get_log_level_default(self):
123         log_level = default_log_level = self.testing_config[
124             self.loglevel_config_setting_name
125         ]
126         args = self.args
127         parser = self.parser()
128         with patch(self.config_func, MagicMock(return_value=self.testing_config)):
129             parser.parse_args(args)
130         with patch("salt.utils.parsers.is_writeable", MagicMock(return_value=True)):
131             parser.setup_logfile_logger()
132         console_log_level = getattr(parser.options, self.loglevel_config_setting_name)
133         self.assertEqual(console_log_level, log_level)
134         self.assertEqual(self.log_setup.log_level, log_level)
135         self.assertEqual(
136             self.log_setup.config[self.loglevel_config_setting_name], log_level
137         )
138         self.assertEqual(self.log_setup.temp_log_level, "error")
139         self.assertEqual(self.log_setup.log_level_logfile, default_log_level)
140         self.assertIn(
141             "Default: '{}'.".format(default_log_level),
142             parser.get_option("--log-level").help,
143         )
144     def test_get_log_file_cli(self):
145         log_level = self.testing_config[self.loglevel_config_setting_name]
146         log_file = "{}_cli.log".format(self.log_file)
147         args = ["--log-file", log_file] + self.args
148         parser = self.parser()
149         with patch(self.config_func, MagicMock(return_value=self.testing_config)):
150             parser.parse_args(args)
151         with patch("salt.utils.parsers.is_writeable", MagicMock(return_value=True)):
152             parser.setup_logfile_logger()
153         log_file_option = getattr(parser.options, self.logfile_config_setting_name)
154         if not self.skip_console_logging_config:
155             self.assertEqual(self.log_setup.log_level, log_level)
156             self.assertEqual(
157                 self.log_setup.config[self.loglevel_config_setting_name], log_level
158             )
159             self.assertEqual(
160                 self.log_setup.config[self.logfile_config_setting_name], log_file
161             )
162         self.assertEqual(self.log_setup.temp_log_level, "error")
163         self.assertEqual(log_file_option, log_file)
164         self.assertEqual(self.log_setup.log_file, log_file)
165     def test_get_log_file_config(self):
166         log_level = self.testing_config[self.loglevel_config_setting_name]
167         args = self.args
168         log_file = "{}_config.log".format(self.log_file)
169         opts = self.testing_config.copy()
170         opts.update({self.logfile_config_setting_name: log_file})
171         parser = self.parser()
172         with patch(self.config_func, MagicMock(return_value=opts)):
173             parser.parse_args(args)
174         with patch("salt.utils.parsers.is_writeable", MagicMock(return_value=True)):
175             parser.setup_logfile_logger()
176         log_file_option = getattr(parser.options, self.logfile_config_setting_name)
177         if not self.skip_console_logging_config:
178             self.assertEqual(self.log_setup.log_level, log_level)
179             self.assertEqual(
180                 self.log_setup.config[self.loglevel_config_setting_name], log_level
181             )
182             self.assertEqual(
183                 self.log_setup.config[self.logfile_config_setting_name], log_file
184             )
185         self.assertEqual(self.log_setup.temp_log_level, "error")
186         self.assertEqual(log_file_option, log_file)
187         self.assertEqual(self.log_setup.log_file, log_file)
188     def test_get_log_file_default(self):
189         log_level <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= self.testing_config[self.loglevel_config_setting_name]
190         log_file = self.testing_config[self.logfile_config_setting_name]
191         default_log_file = self.default_config[self.logfile_config_setting_name]
192         args = self.</b></font>args
193         parser = self.parser()
194         with patch(self.config_func, MagicMock(return_value=self.testing_config)):
195             parser.parse_args(args)
196         with patch("salt.utils.parsers.is_writeable", MagicMock(return_value=True)):
197             parser.setup_logfile_logger()
198         log_file_option = getattr(parser.options, self.logfile_config_setting_name)
199         if not self.skip_console_logging_config:
200             self.assertEqual(self.log_setup.log_level, log_level)
201             self.assertEqual(
202                 self.log_setup.config[self.loglevel_config_setting_name], log_level
203             )
204             self.assertEqual(
205                 self.log_setup.config[self.logfile_config_setting_name], log_file
206             )
207         self.assertEqual(self.log_setup.temp_log_level, "error")
208         self.assertEqual(log_file_option, log_file)
209         self.assertEqual(self.log_setup.log_file, log_file)
210         self.assertIn(
211             "Default: '{}'.".format(default_log_file),
212             parser.get_option("--log-file").help,
213         )
214     def test_get_log_file_level_cli(self):
215         default_log_level = self.testing_config[self.loglevel_config_setting_name]
216         log_level_logfile = "error"
217         args = ["--log-file-level", log_level_logfile] + self.args
218         parser = self.parser()
219         with patch(self.config_func, MagicMock(return_value=self.testing_config)):
220             parser.parse_args(args)
221         with patch("salt.utils.parsers.is_writeable", MagicMock(return_value=True)):
222             parser.setup_logfile_logger()
223         log_level_logfile_option = getattr(
224             parser.options, self.logfile_loglevel_config_setting_name
225         )
226         if not self.skip_console_logging_config:
227             self.assertEqual(self.log_setup.log_level, default_log_level)
228             self.assertEqual(
229                 self.log_setup.config[self.loglevel_config_setting_name],
230                 default_log_level,
231             )
232             self.assertEqual(
233                 self.log_setup.config[self.logfile_loglevel_config_setting_name],
234                 log_level_logfile,
235             )
236         self.assertEqual(self.log_setup.temp_log_level, "error")
237         self.assertEqual(log_level_logfile_option, log_level_logfile)
238         self.assertEqual(self.log_setup.log_level_logfile, log_level_logfile)
239     def test_get_log_file_level_config(self):
240         log_level = self.testing_config[self.loglevel_config_setting_name]
241         args = self.args
242         log_level_logfile = "info"
243         opts = self.testing_config.copy()
244         opts.update({self.logfile_loglevel_config_setting_name: log_level_logfile})
245         parser = self.parser()
246         with patch(self.config_func, MagicMock(return_value=opts)):
247             parser.parse_args(args)
248         with patch("salt.utils.parsers.is_writeable", MagicMock(return_value=True)):
249             parser.setup_logfile_logger()
250         log_level_logfile_option = getattr(
251             parser.options, self.logfile_loglevel_config_setting_name
252         )
253         if not self.skip_console_logging_config:
254             self.assertEqual(self.log_setup.log_level, log_level)
255             self.assertEqual(
256                 self.log_setup.config[self.loglevel_config_setting_name], log_level
257             )
258             self.assertEqual(
259                 self.log_setup.config[self.logfile_loglevel_config_setting_name],
260                 log_level_logfile,
261             )
262         self.assertEqual(self.log_setup.temp_log_level, "error")
263         self.assertEqual(log_level_logfile_option, log_level_logfile)
264         self.assertEqual(self.log_setup.log_level_logfile, log_level_logfile)
265     def test_get_log_file_level_default(self):
266         default_log_level = self.testing_config[self.loglevel_config_setting_name]
267         log_level = default_log_level
268         log_level_logfile = default_log_level
269         args = self.args
270         parser = self.parser()
271         with patch(self.config_func, MagicMock(return_value=self.testing_config)):
272             parser.parse_args(args)
273         with patch("salt.utils.parsers.is_writeable", MagicMock(return_value=True)):
274             parser.setup_logfile_logger()
275         log_level_logfile_option = getattr(
276             parser.options, self.logfile_loglevel_config_setting_name
277         )
278         if not self.skip_console_logging_config:
279             self.assertEqual(self.log_setup.log_level, log_level)
280             self.assertEqual(
281                 self.log_setup.config[self.loglevel_config_setting_name], log_level
282             )
283             self.assertEqual(
284                 self.log_setup.config[self.logfile_loglevel_config_setting_name],
285                 log_level_logfile,
286             )
287         self.assertEqual(self.log_setup.temp_log_level, "error")
288         self.assertEqual(log_level_logfile_option, log_level_logfile)
289         self.assertEqual(self.log_setup.log_level_logfile, log_level_logfile)
290         self.assertIn(
291             "Default: '{}'.".format(default_log_level),
292             parser.get_option("--log-file-level").help,
293         )
294     def test_get_console_log_level_with_file_log_level(
295         self,
296     ):  # pylint: disable=invalid-name
297         log_level = "critical"
298         log_level_logfile = "debug"
299         args = ["--log-file-level", log_level_logfile] + self.args
300         opts = self.testing_config.copy()
301         opts.update({self.loglevel_config_setting_name: log_level})
302         parser = self.parser()
303         with patch(self.config_func, MagicMock(return_value=opts)):
304             parser.parse_args(args)
305         with patch("salt.utils.parsers.is_writeable", MagicMock(return_value=True)):
306             parser.setup_logfile_logger()
307         log_level_logfile_option = getattr(
308             parser.options, self.logfile_loglevel_config_setting_name
309         )
310         if not self.skip_console_logging_config:
311             self.assertEqual(self.log_setup.log_level, log_level)
312             self.assertEqual(
313                 self.log_setup.config[self.loglevel_config_setting_name], log_level
314             )
315             self.assertEqual(
316                 self.log_setup.config[self.logfile_loglevel_config_setting_name],
317                 log_level_logfile,
318             )
319         self.assertEqual(self.log_setup.temp_log_level, "error")
320         self.assertEqual(log_level_logfile_option, log_level_logfile)
321         self.assertEqual(self.log_setup.log_level_logfile, log_level_logfile)
322     @skipIf(salt.utils.platform.is_windows(), "Windows uses a logging listener")
323     def test_log_created(self):
324         Tests that log file is created
325         """
326         args = self<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.args
327         log_file = self.log_file
328         log_file_name = self.logfile_config_setting_name
329         opts = self.testing_config.copy()
330         opts.update({"log_file"</b></font>: log_file})
331         if log_file_name != "log_file":
332             opts.update({log_file_name: getattr(self, log_file_name)})
333         if log_file_name == "key_logfile":
334             self.skipTest("salt-key creates log file outside of parse_args.")
335         parser = self.parser()
336         with patch(self.config_func, MagicMock(return_value=opts)):
337             parser.parse_args(args)
338         if log_file_name == "log_file":
339             self.assertEqual(os.path.getsize(log_file), 0)
340         else:
341             self.assertEqual(os.path.getsize(getattr(self, log_file_name)), 0)
342     def test_callbacks_uniqueness(self):
343         """
344         Test that the callbacks are only added once, no matter
345         how many instances of the parser we create
346         """
347         mixin_container_names = (
348             "_mixin_setup_funcs",
349             "_mixin_process_funcs",
350             "_mixin_after_parsed_funcs",
351             "_mixin_before_exit_funcs",
352         )
353         parser = self.parser()
354         nums_1 = {}
355         for cb_container in mixin_container_names:
356             obj = getattr(parser, cb_container)
357             nums_1[cb_container] = len(obj)
358         parser = self.parser()
359         nums_2 = {}
360         for cb_container in mixin_container_names:
361             obj = getattr(parser, cb_container)
362             nums_2[cb_container] = len(obj)
363         self.assertDictEqual(nums_1, nums_2)
364 @skipIf(salt.utils.platform.is_windows(), "Windows uses a logging listener")
365 class MasterOptionParserTestCase(ParserBase, TestCase):
366     """
367     Tests parsing Salt Master options
368     """
369     def setUp(self):
370         """
371         Setting up
372         """
373         self.default_config = salt.config.DEFAULT_MASTER_OPTS.copy()
374         self.addCleanup(delattr, self, "default_config")
375         self.log_file = "/tmp/salt_master_parser_test"
376         self.config_func = "salt.config.master_config"
377         self.setup_log()
378         self.parser = salt.utils.parsers.MasterOptionParser
379         self.addCleanup(delattr, self, "parser")
380     def tearDown(self):
381         if os.path.exists(self.log_file):
382             os.unlink(self.log_file)
383 @skipIf(salt.utils.platform.is_windows(), "Windows uses a logging listener")
384 class MinionOptionParserTestCase(ParserBase, TestCase):
385     """
386     Tests parsing Salt Minion options
387     """
388     def setUp(self):
389         """
390         Setting up
391         """
392         self.default_config = salt.config.DEFAULT_MINION_OPTS.copy()
393         self.addCleanup(delattr, self, "default_config")
394         self.log_file = "/tmp/salt_minion_parser_test"
395         self.config_func = "salt.config.minion_config"
396         self.setup_log()
397         self.parser = salt.utils.parsers.MinionOptionParser
398         self.addCleanup(delattr, self, "parser")
399     def tearDown(self):
400         if os.path.exists(self.log_file):
401             os.unlink(self.log_file)
402 class ProxyMinionOptionParserTestCase(ParserBase, TestCase):
403     """
404     Tests parsing Salt Proxy Minion options
405     """
406     def setUp(self):
407         """
408         Setting up
409         """
410         self.default_config = salt.config.DEFAULT_MINION_OPTS.copy()
411         self.default_config.update(salt.config.DEFAULT_PROXY_MINION_OPTS)
412         self.addCleanup(delattr, self, "default_config")
413         self.log_file = "/tmp/salt_proxy_minion_parser_test"
414         self.config_func = "salt.config.proxy_config"
415         self.setup_log()
416         self.parser = salt.utils.parsers.ProxyMinionOptionParser
417         self.addCleanup(delattr, self, "parser")
418     def tearDown(self):
419         if os.path.exists(self.log_file):
420             os.unlink(self.log_file)
421 @skipIf(salt.utils.platform.is_windows(), "Windows uses a logging listener")
422 class SyndicOptionParserTestCase(ParserBase, TestCase):
423     """
424     Tests parsing Salt Syndic options
425     """
426     def setUp(self):
427         """
428         Setting up
429         """
430         self.logfile_config_setting_name = "syndic_log_file"
431         self.default_config = salt.config.DEFAULT_MASTER_OPTS.copy()
432         self.addCleanup(delattr, self, "default_config")
433         self.log_file = "/tmp/salt_syndic_parser_test"
434         self.syndic_log_file = "/tmp/salt_syndic_log"
435         self.config_func = "salt.config.syndic_config"
436         self.setup_log()
437         self.parser = salt.utils.parsers.SyndicOptionParser
438         self.addCleanup(delattr, self, "parser")
439     def tearDown(self):
440         if os.path.exists(self.log_file):
441             os.unlink(self.log_file)
442         if os.path.exists(self.syndic_log_file):
443             os.unlink(self.syndic_log_file)
444 class SaltCMDOptionParserTestCase(ParserBase, TestCase):
445     """
446     Tests parsing Salt CLI options
447     """
448     def setUp(self):
449         """
450         Setting up
451         """
452         self.args = ["foo", "bar.baz"]
453         self.default_config = salt.config.DEFAULT_MASTER_OPTS.copy()
454         self.addCleanup(delattr, self, "default_config")
455         self.log_file = "/tmp/salt_cmd_parser_test"
456         self.config_func = "salt.config.client_config"
457         self.setup_log()
458         self.parser = salt.utils.parsers.SaltCMDOptionParser
459         self.addCleanup(delattr, self, "parser")
460     def tearDown(self):
461         if os.path.exists(self.log_file):
462             os.unlink(self.log_file)
463 class SaltCPOptionParserTestCase(ParserBase, TestCase):
464     """
465     Tests parsing salt-cp options
466     """
467     def setUp(self):
468         """
469         Setting up
470         """
471         self.args = ["foo", "bar", "baz"]
472         self.default_config = salt.config.DEFAULT_MASTER_OPTS.copy()
473         self.addCleanup(delattr, self, "default_config")
474         self.log_file = "/tmp/salt_cp_parser_test"
475         self.config_func = "salt.config.master_config"
476         self.setup_log()
477         self.parser = salt.utils.parsers.SaltCPOptionParser
478         self.addCleanup(delattr, self, "parser")
479     def tearDown(self):
480         if os.path.exists(self.log_file):
481             os.unlink(self.log_file)
482 class SaltKeyOptionParserTestCase(ParserBase, TestCase):
483     """
484     Tests parsing salt-key options
485     """
486     def setUp(self):
487         """
488         Setting up
489         """
490         self.skip_console_logging_config = True
491         self.logfile_config_setting_name = "key_logfile"
492         self.default_config = salt.config.DEFAULT_MASTER_OPTS.copy()
493         self.addCleanup(delattr, self, "default_config")
494         self.log_file = "/tmp/salt_key_parser_test"
495         self.key_logfile = "/tmp/key_logfile"
496         self.config_func = "salt.config.client_config"
497         self.setup_log()
498         self.parser = salt.utils.parsers.SaltKeyOptionParser
499         self.addCleanup(delattr, self, "parser")
500     def test_get_log_level_cli(self):
501         """
502         Tests that console log level option is not recognized
503         """
504         log_level = default_log_level = None
505         option = "--log-level"
506         args = self.args + [option, "error"]
507         parser = self.parser()
508         mock_err = ErrorMock()
509         with patch("salt.utils.parsers.OptionParser.error", mock_err.error):
510             parser.parse_args(args)
511         self.assertEqual(mock_err.msg, "no such option: {}".format(option))
512         self.assertEqual(self.log_setup.log_level, log_level)
513         self.assertNotIn(self.loglevel_config_setting_name, self.log_setup.config)
514         self.assertEqual(self.log_setup.temp_log_level, "error")
515         self.assertEqual(self.log_setup.log_level_logfile, default_log_level)
516     def test_get_log_level_config(self):
517         """
518         Tests that log level set in config is ignored
519         """
520         log_level = "info"
521         args = self.args
522         opts = {
523             self.loglevel_config_setting_name: log_level,
524             self.logfile_config_setting_name: "key_logfile",
525             "log_fmt_logfile": None,
526             "log_datefmt_logfile": None,
527             "log_rotate_max_bytes": None,
528             "log_rotate_backup_count": None,
529         }
530         parser = self.parser()
531         with patch(self.config_func, MagicMock(return_value=opts)):
532             parser.parse_args(args)
533             with patch("salt.utils.parsers.is_writeable", MagicMock(return_value=True)):
534                 parser.setup_logfile_logger()
535         self.assertNotIn(self.loglevel_config_setting_name, parser.options.__dict__)
536         self.assertEqual(self.log_setup.log_level, None)
537         self.assertNotIn(self.loglevel_config_setting_name, self.log_setup.config)
538         self.assertEqual(self.log_setup.temp_log_level, "error")
539         self.assertEqual(self.log_setup.log_level_logfile, log_level)
540     def test_get_log_level_default(self):
541         """
542         Tests that log level default value is ignored
543         """
544         default_log_level = self.testing_config[self.loglevel_config_setting_name]
545         log_level = None
546         args = self.args
547         parser = self.parser()
548         parser.parse_args(args)
549         with patch("salt.utils.parsers.is_writeable", MagicMock(return_value=True)):
550             parser.setup_logfile_logger()
551         self.assertNotIn(self.loglevel_config_setting_name, parser.options.__dict__)
552         self.assertEqual(self.log_setup.log_level, log_level)
553         self.assertNotIn(self.loglevel_config_setting_name, self.log_setup.config)
554         self.assertEqual(self.log_setup.temp_log_level, "error")
555         self.assertEqual(self.log_setup.log_level_logfile, default_log_level)
556     def tearDown(self):
557         if os.path.exists(self.log_file):
558             os.unlink(self.log_file)
559         if os.path.exists(self.key_logfile):
560             os.unlink(self.key_logfile)
561 class SaltCallOptionParserTestCase(ParserBase, TestCase):
562     """
563     Tests parsing Salt Minion options
564     """
565     def setUp(self):
566         """
567         Setting up
568         """
569         self.args = ["foo.bar"]
570         self.default_config = salt.config.DEFAULT_MINION_OPTS.copy()
571         self.addCleanup(delattr, self, "default_config")
572         self.log_file = "/tmp/salt_call_parser_test"
573         self.config_func = "salt.config.minion_config"
574         self.setup_log()
575         self.parser = salt.utils.parsers.SaltCallOptionParser
576         self.addCleanup(delattr, self, "parser")
577     def tearDown(self):
578         if os.path.exists(self.log_file):
579             os.unlink(self.log_file)
580 class SaltRunOptionParserTestCase(ParserBase, TestCase):
581     """
582     Tests parsing Salt Master options
583     """
584     def setUp(self):
585         """
586         Setting up
587         """
588         self.args = ["foo.bar"]
589         self.default_config = salt.config.DEFAULT_MASTER_OPTS.copy()
590         self.addCleanup(delattr, self, "default_config")
591         self.log_file = "/tmp/salt_run_parser_test"
592         self.config_func = "salt.config.master_config"
593         self.setup_log()
594         self.parser = salt.utils.parsers.SaltRunOptionParser
595         self.addCleanup(delattr, self, "parser")
596     def tearDown(self):
597         if os.path.exists(self.log_file):
598             os.unlink(self.log_file)
599     def test_jid_option(self):
600         jid = salt.utils.jid.gen_jid({})
601         args = ["--jid", jid]
602         parser = self.parser()
603         parser.parse_args(args)
604         assert parser.options.jid == jid
605     def test_jid_option_invalid(self):
606         jid = salt.utils.jid.gen_jid({}) + "A"
607         args = ["--jid", jid]
608         parser = self.parser()
609         mock_err = ErrorMock()
610         with patch("salt.utils.parsers.OptionParser.error", mock_err.error):
611             parser.parse_args(args)
612         self.assertEqual(mock_err.msg, "'{}' is not a valid JID".format(jid))
613 class SaltSSHOptionParserTestCase(ParserBase, TestCase):
614     """
615     Tests parsing Salt Master options
616     """
617     def setUp(self):
618         """
619         Setting up
620         """
621         self.args = ["foo", "bar.baz"]
622         self.logfile_config_setting_name = "ssh_log_file"
623         self.default_config = salt.config.DEFAULT_MASTER_OPTS.copy()
624         self.addCleanup(delattr, self, "default_config")
625         self.log_file = "/tmp/salt_ssh_parser_test"
626         self.ssh_log_file = "/tmp/ssh_logfile"
627         self.config_func = "salt.config.master_config"
628         self.setup_log()
629         self.parser = salt.utils.parsers.SaltSSHOptionParser
630         self.addCleanup(delattr, self, "parser")
631     def tearDown(self):
632         if os.path.exists(self.log_file):
633             os.unlink(self.log_file)
634         if os.path.exists(self.ssh_log_file):
635             os.unlink(self.ssh_log_file)
636     def test_jid_option(self):
637         jid = salt.utils.jid.gen_jid({})
638         args = ["--jid", jid] + self.args
639         parser = self.parser()
640         parser.parse_args(args)
641         assert parser.options.jid == jid
642     def test_jid_option_invalid(self):
643         jid = salt.utils.jid.gen_jid({}) + "A"
644         args = ["--jid", jid] + self.args
645         parser = self.parser()
646         mock_err = ErrorMock()
647         with patch("salt.utils.parsers.OptionParser.error", mock_err.error):
648             parser.parse_args(args)
649         self.assertEqual(mock_err.msg, "'{}' is not a valid JID".format(jid))
650 class SaltCloudParserTestCase(ParserBase, TestCase):
651     """
652     Tests parsing Salt Cloud options
653     """
654     def setUp(self):
655         """
656         Setting up
657         """
658         self.args = ["-p", "foo", "bar"]
659         self.default_config = salt.config.DEFAULT_MASTER_OPTS.copy()
660         self.default_config.update(salt.config.DEFAULT_CLOUD_OPTS)
661         self.addCleanup(delattr, self, "default_config")
662         self.log_file = "/tmp/salt_cloud_parser_test"
663         self.config_func = "salt.config.cloud_config"
664         self.setup_log()
665         self.parser = salt.utils.parsers.SaltCloudParser
666         self.addCleanup(delattr, self, "parser")
667     def tearDown(self):
668         if os.path.exists(self.log_file):
669             os.unlink(self.log_file)
670 class SPMParserTestCase(ParserBase, TestCase):
671     """
672     Tests parsing Salt Cloud options
673     """
674     def setUp(self):
675         """
676         Setting up
677         """
678         self.args = ["foo", "bar"]
679         self.logfile_config_setting_name = "spm_logfile"
680         self.default_config = salt.config.DEFAULT_MASTER_OPTS.copy()
681         self.default_config.update(salt.config.DEFAULT_SPM_OPTS)
682         self.addCleanup(delattr, self, "default_config")
683         self.log_file = "/tmp/spm_parser_test"
684         self.spm_logfile = "/tmp/spm_logfile"
685         self.config_func = "salt.config.spm_config"
686         self.setup_log()
687         self.parser = salt.utils.parsers.SPMParser
688         self.addCleanup(delattr, self, "parser")
689     def tearDown(self):
690         if os.path.exists(self.log_file):
691             os.unlink(self.log_file)
692         if os.path.exists(self.spm_logfile):
693             os.unlink(self.spm_logfile)
694 class SaltAPIParserTestCase(ParserBase, TestCase):
695     """
696     Tests parsing Salt Cloud options
697     """
698     def setUp(self):
699         """
700         Setting up
701         """
702         self.args = []
703         self.logfile_config_setting_name = "api_logfile"
704         self.default_config = salt.config.DEFAULT_MASTER_OPTS.copy()
705         self.default_config.update(salt.config.DEFAULT_API_OPTS)
706         self.addCleanup(delattr, self, "default_config")
707         self.log_file = "/tmp/salt_api_parser_test"
708         self.api_logfile = "/tmp/api_logfile"
709         self.config_func = "salt.config.api_config"
710         self.setup_log()
711         self.parser = salt.utils.parsers.SaltAPIParser
712         self.addCleanup(delattr, self, "parser")
713     def tearDown(self):
714         if os.path.exists(self.log_file):
715             os.unlink(self.log_file)
716         if os.path.exists(self.api_logfile):
717             os.unlink(self.api_logfile)
718 class DaemonMixInTestCase(TestCase):
719     """
720     Tests the PIDfile deletion in the DaemonMixIn.
721     """
722     def setUp(self):
723         """
724         Setting up
725         """
726         self.daemon_mixin = salt.utils.parsers.DaemonMixIn()
727         self.daemon_mixin.config = {}
728         self.daemon_mixin.config["pidfile"] = "/some/fake.pid"
729     def tearDown(self):
730         """
731         Tear down test
732         :return:
733         """
734         del self.daemon_mixin
735     @patch("os.unlink", MagicMock())
736     @patch("os.path.isfile", MagicMock(return_value=True))
737     @patch("salt.utils.parsers.logger", MagicMock())
738     def test_pid_file_deletion(self):
739         """
740         PIDfile deletion without exception.
741         """
742         self.daemon_mixin._mixin_before_exit()
743         assert salt.utils.parsers.os.unlink.call_count == 1
744         salt.utils.parsers.logger.info.assert_not_called()
745         salt.utils.parsers.logger.debug.assert_not_called()
746     @patch("os.unlink", MagicMock(side_effect=OSError()))
747     @patch("os.path.isfile", MagicMock(return_value=True))
748     @patch("salt.utils.parsers.logger", MagicMock())
749     def test_pid_deleted_oserror_as_root(self):
750         """
751         PIDfile deletion with exception, running as root.
752         """
753         if salt.utils.platform.is_windows():
754             patch_args = (
755                 "salt.utils.win_functions.is_admin",
756                 MagicMock(return_value=True),
757             )
758         else:
759             patch_args = ("os.getuid", MagicMock(return_value=0))
760         with patch(*patch_args):
761             self.daemon_mixin._mixin_before_exit()
762             assert salt.utils.parsers.os.unlink.call_count == 1
763             salt.utils.parsers.logger.info.assert_called_with(
764                 "PIDfile could not be deleted: %s",
765                 format(self.daemon_mixin.config["pidfile"]),
766             )
767             salt.utils.parsers.logger.debug.assert_called()
768     @patch("os.unlink", MagicMock(side_effect=OSError()))
769     @patch("os.path.isfile", MagicMock(return_value=True))
770     @patch("salt.utils.parsers.logger", MagicMock())
771     def test_pid_deleted_oserror_as_non_root(self):
772         """
773         PIDfile deletion with exception, running as non-root.
774         """
775         if salt.utils.platform.is_windows():
776             patch_args = (
777                 "salt.utils.win_functions.is_admin",
778                 MagicMock(return_value=False),
779             )
780         else:
781             patch_args = ("os.getuid", MagicMock(return_value=1000))
782         with patch(*patch_args):
783             self.daemon_mixin._mixin_before_exit()
784             assert salt.utils.parsers.os.unlink.call_count == 1
785             salt.utils.parsers.logger.info.assert_not_called()
786             salt.utils.parsers.logger.debug.assert_not_called()
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>gce.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 """
2 Copyright 2013 Google Inc. All Rights Reserved.
3 Licensed under the Apache License, Version 2.0 (the "License");
4 you may not use this file except in compliance with the License.
5 You may obtain a copy of the License at
6     http://www.apache.org/licenses/LICENSE-2.0
7 Unless required by applicable law or agreed to in writing, software
8 distributed under the License is distributed on an "AS IS" BASIS,
9 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
10 See the License for the specific language governing permissions and
11 limitations under the License.
12 Google Compute Engine Module
13 ============================
14 The Google Compute Engine module. This module interfaces with Google Compute
15 Engine (GCE). To authenticate to GCE, you will need to create a Service Account.
16 To set up Service Account Authentication, follow the :ref:`gce_setup` instructions.
17 Example Provider Configuration
18 ------------------------------
19 .. code-block:: yaml
20     my-gce-config:
21       project: "my-project-id"
22       service_account_email_address: 1234567890@developer.gserviceaccount.com
23       service_account_private_key: /home/erjohnso/PRIVKEY.pem
24       driver: gce
25       ssh_interface: public_ips
26 :maintainer: Eric Johnson &lt;erjohnso@google.com&gt;
27 :maintainer: Russell Tolle &lt;russ.tolle@gmail.com&gt;
28 :depends: libcloud &gt;= 1.0.0
29 <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import logging
30 import os
31 import pprint
32 import re
33 import sys
34 from ast import literal_eval
35 import salt.config as config
36 import salt.utils.cloud
37 import salt.utils.files
38 import salt.utils.http
39 import salt.utils.msgpack
40 from</b></font> salt.cloud.libcloudfuncs import *  # pylint: disable=redefined-builtin,wildcard-import,unused-wildcard-import
41 from salt.exceptions import SaltCloudSystemExit
42 from salt.utils.functools import namespaced_function
43 from salt.utils.versions import LooseVersion as _LooseVersion
44 LIBCLOUD_IMPORT_ERROR = None
45 try:
46     import libcloud
47     from libcloud.compute.types import Provider
48     from libcloud.compute.providers import get_driver
49     from libcloud.loadbalancer.types import Provider as Provider_lb
50     from libcloud.loadbalancer.providers import get_driver as get_driver_lb
51     from libcloud.common.google import (
52         ResourceInUseError,
53         ResourceNotFoundError,
54     )
55     HAS_LIBCLOUD = True
56 except ImportError:
57     LIBCLOUD_IMPORT_ERROR = sys.exc_info()
58     HAS_LIBCLOUD = False
59 log = logging.getLogger(__name__)
60 __virtualname__ = "gce"
61 _UA_PRODUCT = "salt-cloud"
62 _UA_VERSION = "0.2.0"
63 avail_locations = namespaced_function(avail_locations, globals())
64 script = namespaced_function(script, globals())
65 destroy = namespaced_function(destroy, globals())
66 list_nodes = namespaced_function(list_nodes, globals())
67 list_nodes_full = namespaced_function(list_nodes_full, globals())
68 list_nodes_select = namespaced_function(list_nodes_select, globals())
69 GCE_VM_NAME_REGEX = re.compile(r"^(?:[a-z](?:[-a-z0-9]{0,61}[a-z0-9])?)$")
70 def __virtual__():
71     """
72     Set up the libcloud functions and check for GCE configurations.
73     """
74     if not HAS_LIBCLOUD:
75         return False, "apache-libcloud is not installed"
76     if _LooseVersion(libcloud.__version__) &lt; _LooseVersion("2.5.0"):
77         return False, "The salt-cloud GCE driver requires apache-libcloud&gt;=2.5.0"
78     if get_configured_provider() is False:
79         return False
80     if get_dependencies() is False:
81         return False
82     for provider, details in __opts__["providers"].items():
83         if "gce" not in details:
84             continue
85         parameters = details["gce"]
86         pathname = os.path.expanduser(parameters["service_account_private_key"])
87         if (
88             pathname
89             and salt.utils.cloud.check_key_path_and_mode(provider, pathname) is False
90         ):
91             return False
92     return __virtualname__
93 def _get_active_provider_name():
94     try:
95         return __active_provider_name__.value()
96     except AttributeError:
97         return __active_provider_name__
98 def get_configured_provider():
99     """
100     Return the first configured instance.
101     """
102     return config.is_provider_configured(
103         __opts__,
104         _get_active_provider_name() or "gce",
105         ("project", "service_account_email_address", "service_account_private_key"),
106     )
107 def get_dependencies():
108     """
109     Warn if dependencies aren't met.
110     """
111     if LIBCLOUD_IMPORT_ERROR:
112         log.error("Failure when importing LibCloud: ", exc_info=LIBCLOUD_IMPORT_ERROR)
113         log.error(
114             "Note: The libcloud dependency is called 'apache-libcloud' on PyPi/pip."
115         )
116     return config.check_driver_dependencies(__virtualname__, {"libcloud": HAS_LIBCLOUD})
117 def get_lb_conn(gce_driver=None):
118     """
119     Return a load-balancer conn object
120     """
121     if not gce_driver:
122         raise SaltCloudSystemExit("Missing gce_driver for get_lb_conn method.")
123     return get_driver_lb(Provider_lb.GCE)(gce_driver=gce_driver)
124 def get_conn():
125     """
126     Return a conn object for the passed VM data
127     """
128     driver = get_driver(Provider.GCE)
129     provider = get_configured_provider()
130     project = config.get_cloud_config_value("project", provider, __opts__)
131     email = config.get_cloud_config_value(
132         "service_account_email_address", provider, __opts__
133     )
134     private_key = config.get_cloud_config_value(
135         "service_account_private_key", provider, __opts__
136     )
137     gce = driver(email, private_key, project=project)
138     gce.connection.user_agent_append("{}/{}".format(_UA_PRODUCT, _UA_VERSION))
139     return gce
140 def _expand_item(item):
141     """
142     Convert the libcloud object into something more serializable.
143     """
144     ret = {}
145     ret.update(item.__dict__)
146     return ret
147 def _expand_node(node):
148     """
149     Convert the libcloud Node object into something more serializable.
150     """
151     ret = {}
152     ret.update(node.__dict__)
153     try:
154         del ret["extra"]["boot_disk"]
155     except Exception:  # pylint: disable=W0703
156         pass
157     zone = ret["extra"]["zone"]
158     ret["extra"]["zone"] = {}
159     ret["extra"]["zone"].update(zone.__dict__)
160     if "driver" in ret:
161         del ret["driver"]
162     if "driver" in ret["extra"]["zone"]:
163         del ret["extra"]["zone"]["driver"]
164     return ret
165 def _expand_disk(disk):
166     """
167     Convert the libcloud Volume object into something more serializable.
168     """
169     ret = {}
170     ret.update(disk.__dict__)
171     zone = ret["extra"]["zone"]
172     ret["extra"]["zone"] = {}
173     ret["extra"]["zone"].update(zone.__dict__)
174     return ret
175 def _expand_address(addy):
176     """
177     Convert the libcloud GCEAddress object into something more serializable.
178     """
179     ret = {}
180     ret.update(addy.__dict__)
181     ret["extra"]["zone"] = addy.region.name
182     return ret
183 def _expand_balancer(lb):
184     """
185     Convert the libcloud load-balancer object into something more serializable.
186     """
187     ret = {}
188     ret.update(lb.__dict__)
189     hc = ret["extra"]["healthchecks"]
190     ret["extra"]["healthchecks"] = []
191     for item in hc:
192         ret["extra"]["healthchecks"].append(_expand_item(item))
193     fwr = ret["extra"]["forwarding_rule"]
194     tp = ret["extra"]["forwarding_rule"].targetpool
195     reg = ret["extra"]["forwarding_rule"].region
196     ret["extra"]["forwarding_rule"] = {}
197     ret["extra"]["forwarding_rule"].update(fwr.__dict__)
198     ret["extra"]["forwarding_rule"]["targetpool"] = tp.name
199     tp = ret["extra"]["targetpool"]
200     hc <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= ret["extra"]["targetpool"].healthchecks
201     nodes = ret["extra"]["targetpool"].nodes
202     region = ret["extra"]["targetpool"].region
203     zones = ret[</b></font>"extra"]["targetpool"].region.zones
204     ret["extra"]["targetpool"] = {}
205     ret["extra"]["targetpool"].update(tp.__dict__)
206     ret["extra"]["targetpool"]["region"] = _expand_item(region)
207     ret["extra"]["targetpool"]["nodes"] = []
208     for n in nodes:
209         ret["extra"]["targetpool"]["nodes"].append(_expand_node(n))
210     ret["extra"]["targetpool"]["healthchecks"] = []
211     for hci in hc:
212         ret["extra"]["targetpool"]["healthchecks"].append(hci.name)
213     ret["extra"]["targetpool"]["region"]["zones"] = []
214     for z in zones:
215         ret["extra"]["targetpool"]["region"]["zones"].append(z.name)
216     return ret
217 def show_instance(vm_name, call=None):
218     """
219     Show the details of the existing instance.
220     """
221     if call != "action":
222         raise SaltCloudSystemExit(
223             "The show_instance action must be called with -a or --action."
224         )
225     conn = get_conn()
226     node = _expand_node(conn.ex_get_node(vm_name))
227     __utils__["cloud.cache_node"](node, _get_active_provider_name(), __opts__)
228     return node
229 def avail_sizes(conn=None):
230     """
231     Return a dict of available instances sizes (a.k.a machine types) and
232     convert them to something more serializable.
233     """
234     if not conn:
235         conn = get_conn()
236     raw_sizes = conn.list_sizes("all")  # get *all* the machine types!
237     sizes = []
238     for size in raw_sizes:
239         zone = size.extra["zone"]
240         size.extra["zone"] = {}
241         size.extra["zone"].update(zone.__dict__)
242         mtype = {}
243         mtype.update(size.__dict__)
244         sizes.append(mtype)
245     return sizes
246 def avail_images(conn=None):
247     """
248     Return a dict of all available VM images on the cloud provider with
249     relevant data.
250     Note that for GCE, there are custom images within the project, but the
251     generic images are in other projects.  This returns a dict of images in
252     the project plus images in well-known public projects that provide supported
253     images, as listed on this page:
254     https://cloud.google.com/compute/docs/operating-systems/
255     If image names overlap, the image in the current project is used.
256     """
257     if not conn:
258         conn = get_conn()
259     all_images = []
260     public_image_projects = (
261         "centos-cloud",
262         "coreos-cloud",
263         "debian-cloud",
264         "google-containers",
265         "opensuse-cloud",
266         "rhel-cloud",
267         "suse-cloud",
268         "ubuntu-os-cloud",
269         "windows-cloud",
270     )
271     for project in public_image_projects:
272         all_images.extend(conn.list_images(project))
273     all_images.extend(conn.list_images())
274     ret = {}
275     for img in all_images:
276         ret[img.name] = {}
277         for attr in dir(img):
278             if attr.startswith("_"):
279                 continue
280             ret[img.name][attr] = getattr(img, attr)
281     return ret
282 def __get_image(conn, vm_):
283     """
284     The get_image for GCE allows partial name matching and returns a
285     libcloud object.
286     """
287     img = config.get_cloud_config_value(
288         "image", vm_, __opts__, default="debian-7", search_global=False
289     )
290     return conn.ex_get_image(img)
291 def __get_location(conn, vm_):
292     """
293     Need to override libcloud to find the zone.
294     """
295     location = config.get_cloud_config_value("location", vm_, __opts__)
296     return conn.ex_get_zone(location)
297 def __get_size(conn, vm_):
298     """
299     Need to override libcloud to find the machine type in the proper zone.
300     """
301     size = config.get_cloud_config_value(
302         "size", vm_, __opts__, default="n1-standard-1", search_global=False
303     )
304     return conn.ex_get_size(size, __get_location(conn, vm_))
305 def __get_tags(vm_):
306     """
307     Get configured tags.
308     """
309     t = config.get_cloud_config_value(
310         "tags", vm_, __opts__, default="[]", search_global=False
311     )
312     try:
313         tags = literal_eval(t)
314     except Exception:  # pylint: disable=W0703
315         tags = None
316     if not tags or not isinstance(tags, list):
317         tags = None
318     return tags
319 def __get_metadata(vm_):
320     """
321     Get configured metadata and add 'salt-cloud-profile'.
322     """
323     md = config.get_cloud_config_value(
324         "metadata", vm_, __opts__, default="{}", search_global=False
325     )
326     try:
327         metadata = literal_eval(md)
328     except Exception:  # pylint: disable=W0703
329         metadata = None
330     if not metadata or not isinstance(metadata, dict):
331         metadata = {"items": [{"key": "salt-cloud-profile", "value": vm_["profile"]}]}
332     else:
333         metadata["salt-cloud-profile"] = vm_["profile"]
334         items = []
335         for k, v in metadata.items():
336             items.append({"key": k, "value": v})
337         metadata = {"items": items}
338     return metadata
339 def __get_host(node, vm_):
340     """
341     Return public IP, private IP, or hostname for the libcloud 'node' object
342     """
343     if __get_ssh_interface(vm_) == "private_ips" or vm_["external_ip"] is None:
344         ip_address = node.private_ips[0]
345         log.info("Salt node data. Private_ip: %s", ip_address)
346     else:
347         ip_address = node.public_ips[0]
348         log.info("Salt node data. Public_ip: %s", ip_address)
349     if ip_address:
350         return ip_address
351     return node.name
352 def __get_network(conn, vm_):
353     """
354     Return a GCE libcloud network object with matching name
355     """
356     network = config.get_cloud_config_value(
357         "network", vm_, __opts__, default="default", search_global=False
358     )
359     return conn.ex_get_network(network)
360 def __get_subnetwork(vm_):
361     """
362     Get configured subnetwork.
363     """
364     ex_subnetwork = config.get_cloud_config_value(
365         "subnetwork", vm_, __opts__, search_global=False
366     )
367     return ex_subnetwork
368 def __get_region(conn, vm_):
369     """
370     Return a GCE libcloud region object with matching name.
371     """
372     location = __get_location(conn, vm_)
373     region = "-".join(location.name.split("-")[:2])
374     return conn.ex_get_region(region)
375 def __get_ssh_interface(vm_):
376     """
377     Return the ssh_interface type to connect to. Either 'public_ips' (default)
378     or 'private_ips'.
379     """
380     return config.get_cloud_config_value(
381         "ssh_interface", vm_, __opts__, default="public_ips", search_global=False
382     )
383 def __create_orget_address(conn, name, region):
384     """
385     Reuse or create a static IP address.
386     Returns a native GCEAddress construct to use with libcloud.
387     """
388     try:
389         addy = conn.ex_get_address(name, region)
390     except ResourceNotFoundError:  # pylint: disable=W0703
391         addr_kwargs = {"name": name, "region": region}
392         new_addy = create_address(addr_kwargs, "function")
393         addy = conn.ex_get_address(new_addy["name"], new_addy["region"])
394     return addy
395 def _parse_allow(allow):
396     """
397     Convert firewall rule allowed user-string to specified REST API format.
398     """
399     seen_protos = {}
400     allow_dict = []
401     protocols = allow.split(",")
402     for p in protocols:
403         pairs = p.split(":")
404         if pairs[0].lower() not in ["tcp", "udp", "icmp"]:
405             raise SaltCloudSystemExit(
406                 "Unsupported protocol {}. Must be tcp, udp, or icmp.".format(pairs[0])
407             )
408         if len(pairs) == 1 or pairs[0].lower() == "icmp":
409             seen_protos[pairs[0]] = []
410         else:
411             if pairs[0] not in seen_protos:
412                 seen_protos[pairs[0]] = [pairs[1]]
413             else:
414                 seen_protos[pairs[0]].append(pairs[1])
415     for k in seen_protos:
416         d = {"IPProtocol": k}
417         if seen_protos[k]:
418             d["ports"] = seen_protos[k]
419         allow_dict.append(d)
420     log.debug("firewall allowed protocols/ports: %s", allow_dict)
421     return allow_dict
422 def __get_ssh_credentials(vm_):
423     """
424     Get configured SSH credentials.
425     """
426     ssh_user = config.get_cloud_config_value(
427         "ssh_username", vm_, __opts__, default=os.getenv("USER")
428     )
429     ssh_key = config.get_cloud_config_value(
430         "ssh_keyfile",
431         vm_,
432         __opts__,
433         default=os.path.expanduser("~/.ssh/google_compute_engine"),
434     )
435     return ssh_user, ssh_key
436 def create_network(kwargs=None, call=None):
437     """
438     .. versionchanged:: 2017.7.0
439     Create a GCE network. Must specify name and cidr.
440     CLI Example:
441     .. code-block:: bash
442         salt-cloud -f create_network gce name=mynet cidr=10.10.10.0/24 mode=legacy description=optional
443         salt-cloud -f create_network gce name=mynet description=optional
444     """
445     if call != "function":
446         raise SaltCloudSystemExit(
447             "The create_network function must be called with -f or --function."
448         )
449     if not kwargs or "name" not in kwargs:
450         log.error("A name must be specified when creating a network.")
451         return False
452     mode = kwargs.get("mode", "legacy")
453     cidr = kwargs.get("cidr", None)
454     if cidr is None and mode == "legacy":
455         log.error(
456             "A network CIDR range must be specified when creating a legacy network."
457         )
458         return False
459     name = kwargs["name"]
460     desc = kwargs.get("description", None)
461     conn = get_conn()
462     __utils__["cloud.fire_event"](
463         "event",
464         "creating network",
465         "salt/cloud/net/creating",
466         args={"name": name, "cidr": cidr, "description": desc, "mode": mode},
467         sock_dir=__opts__["sock_dir"],
468         transport=__opts__["transport"],
469     )
470     network = conn.ex_create_network(name, cidr, desc, mode)
471     __utils__["cloud.fire_event"](
472         "event",
473         "created network",
474         "salt/cloud/net/created",
475         args={"name": name, "cidr": cidr, "description": desc, "mode": mode},
476         sock_dir=__opts__["sock_dir"],
477         transport=__opts__["transport"],
478     )
479     return _expand_item(network)
480 def delete_network(kwargs=None, call=None):
481     """
482     Permanently delete a network.
483     CLI Example:
484     .. code-block:: bash
485         salt-cloud -f delete_network gce name=mynet
486     """
487     if call != "function":
488         raise SaltCloudSystemExit(
489             "The delete_network function must be called with -f or --function."
490         )
491     if not kwargs or "name" not in kwargs:
492         log.error("A name must be specified when deleting a network.")
493         return False
494     name = kwargs["name"]
495     conn = get_conn()
496     __utils__["cloud.fire_event"](
497         "event",
498         "deleting network",
499         "salt/cloud/net/deleting",
500         args={"name": name},
501         sock_dir=__opts__["sock_dir"],
502         transport=__opts__["transport"],
503     )
504     try:
505         result = conn.ex_destroy_network(conn.ex_get_network(name))
506     except ResourceNotFoundError as exc:
507         log.error(
508             "Nework %s was not found. Exception was: %s",
509             name,
510             exc,
511             exc_info_on_loglevel=logging.DEBUG,
512         )
513         return False
514     __utils__["cloud.fire_event"](
515         "event",
516         "deleted network",
517         "salt/cloud/net/deleted",
518         args={"name": name},
519         sock_dir=__opts__["sock_dir"],
520         transport=__opts__["transport"],
521     )
522     return result
523 def show_network(kwargs=None, call=None):
524     """
525     Show the details of an existing network.
526     CLI Example:
527     .. code-block:: bash
528         salt-cloud -f show_network gce name=mynet
529     """
530     if call != "function":
531         raise SaltCloudSystemExit(
532             "The show_network function must be called with -f or --function."
533         )
534     if not kwargs or "name" not in kwargs:
535         log.error("Must specify name of network.")
536         return False
537     conn = get_conn()
538     return _expand_item(conn.ex_get_network(kwargs["name"]))
539 def create_subnetwork(kwargs=None, call=None):
540     """
541     .. versionadded:: 2017.7.0
542     Create a GCE Subnetwork. Must specify name, cidr, network, and region.
543     CLI Example:
544     .. code-block:: bash
545         salt-cloud -f create_subnetwork gce name=mysubnet network=mynet1 region=us-west1 cidr=10.0.0.0/24 description=optional
546     """
547     if call != "function":
548         raise SaltCloudSystemExit(
549             "The create_subnetwork function must be called with -f or --function."
550         )
551     if not kwargs or "name" not in kwargs:
552         log.error("Must specify name of subnet.")
553         return False
554     if "network" not in kwargs:
555         log.errror("Must specify name of network to create subnet under.")
556         return False
557     if "cidr" not in kwargs:
558         log.errror("A network CIDR range must be specified when creating a subnet.")
559         return False
560     if "region" not in kwargs:
561         log.error("A region must be specified when creating a subnetwork.")
562         return False
563     name = kwargs["name"]
564     cidr = kwargs["cidr"]
565     network = kwargs["network"]
566     region = kwargs["region"]
567     desc = kwargs.get("description", None)
568     conn = get_conn()
569     __utils__["cloud.fire_event"](
570         "event",
571         "create subnetwork",
572         "salt/cloud/subnet/creating",
573         args={
574             "name": name,
575             "network": network,
576             "cidr": cidr,
577             "region": region,
578             "description": desc,
579         },
580         sock_dir=__opts__["sock_dir"],
581         transport=__opts__["transport"],
582     )
583     subnet = conn.ex_create_subnetwork(name, cidr, network, region, desc)
584     __utils__["cloud.fire_event"](
585         "event",
586         "created subnetwork",
587         "salt/cloud/subnet/created",
588         args={
589             "name": name,
590             "network": network,
591             "cidr": cidr,
592             "region": region,
593             "description": desc,
594         },
595         sock_dir=__opts__["sock_dir"],
596         transport=__opts__["transport"],
597     )
598     return _expand_item(subnet)
599 def delete_subnetwork(kwargs=None, call=None):
600     """
601     .. versionadded:: 2017.7.0
602     Delete a GCE Subnetwork. Must specify name and region.
603     CLI Example:
604     .. code-block:: bash
605         salt-cloud -f delete_subnetwork gce name=mysubnet network=mynet1 region=us-west1
606     """
607     if call != "function":
608         raise SaltCloudSystemExit(
609             "The delete_subnet function must be called with -f or --function."
610         )
611     if not kwargs or "name" not in kwargs:
612         log.error("Must specify name of subnet.")
613         return False
614     if "region" not in kwargs:
615         log.error("Must specify region of subnet.")
616         return False
617     name = kwargs["name"]
618     region = kwargs["region"]
619     conn = get_conn()
620     __utils__["cloud.fire_event"](
621         "event",
622         "deleting subnetwork",
623         "salt/cloud/subnet/deleting",
624         args={"name": name, "region": region},
625         sock_dir=__opts__["sock_dir"],
626         transport=__opts__["transport"],
627     )
628     try:
629         result = conn.ex_destroy_subnetwork(name, region)
630     except ResourceNotFoundError as exc:
631         log.error(
632             "Subnetwork %s was not found. Exception was: %s",
633             name,
634             exc,
635             exc_info_on_loglevel=logging.DEBUG,
636         )
637         return False
638     __utils__["cloud.fire_event"](
639         "event",
640         "deleted subnetwork",
641         "salt/cloud/subnet/deleted",
642         args={"name": name, "region": region},
643         sock_dir=__opts__["sock_dir"],
644         transport=__opts__["transport"],
645     )
646     return result
647 def show_subnetwork(kwargs=None, call=None):
648     """
649     .. versionadded:: 2017.7.0
650     Show details of an existing GCE Subnetwork. Must specify name and region.
651     CLI Example:
652     .. code-block:: bash
653         salt-cloud -f show_subnetwork gce name=mysubnet region=us-west1
654     """
655     if call != "function":
656         raise SaltCloudSystemExit(
657             "The show_subnetwork function must be called with -f or --function."
658         )
659     if not kwargs or "name" not in kwargs:
660         log.error("Must specify name of subnet.")
661         return False
662     if "region" not in kwargs:
663         log.error("Must specify region of subnet.")
664         return False
665     name = kwargs["name"]
666     region = kwargs["region"]
667     conn = get_conn()
668     return _expand_item(conn.ex_get_subnetwork(name, region))
669 def create_fwrule(kwargs=None, call=None):
670     """
671     Create a GCE firewall rule. The 'default' network is used if not specified.
672     CLI Example:
673     .. code-block:: bash
674         salt-cloud -f create_fwrule gce name=allow-http allow=tcp:80
675     """
676     if call != "function":
677         raise SaltCloudSystemExit(
678             "The create_fwrule function must be called with -f or --function."
679         )
680     if not kwargs or "name" not in kwargs:
681         log.error("A name must be specified when creating a firewall rule.")
682         return False
683     if "allow" not in kwargs:
684         log.error('Must use "allow" to specify allowed protocols/ports.')
685         return False
686     name = kwargs["name"]
687     network_name = kwargs.get("network", "default")
688     allow = _parse_allow(kwargs["allow"])
689     src_range = kwargs.get("src_range", "0.0.0.0/0")
690     src_tags = kwargs.get("src_tags", None)
691     dst_tags = kwargs.get("dst_tags", None)
692     if src_range:
693         src_range = src_range.split(",")
694     if src_tags:
695         src_tags = src_tags.split(",")
696     if dst_tags:
697         dst_tags = dst_tags.split(",")
698     conn = get_conn()
699     __utils__["cloud.fire_event"](
700         "event",
701         "create firewall",
702         "salt/cloud/firewall/creating",
703         args={"name": name, "network": network_name, "allow": kwargs["allow"]},
704         sock_dir=__opts__["sock_dir"],
705         transport=__opts__["transport"],
706     )
707     fwrule = conn.ex_create_firewall(
708         name,
709         allow,
710         network=network_name,
711         source_ranges=src_range,
712         source_tags=src_tags,
713         target_tags=dst_tags,
714     )
715     __utils__["cloud.fire_event"](
716         "event",
717         "created firewall",
718         "salt/cloud/firewall/created",
719         args={"name": name, "network": network_name, "allow": kwargs["allow"]},
720         sock_dir=__opts__["sock_dir"],
721         transport=__opts__["transport"],
722     )
723     return _expand_item(fwrule)
724 def delete_fwrule(kwargs=None, call=None):
725     """
726     Permanently delete a firewall rule.
727     CLI Example:
728     .. code-block:: bash
729         salt-cloud -f delete_fwrule gce name=allow-http
730     """
731     if call != "function":
732         raise SaltCloudSystemExit(
733             "The delete_fwrule function must be called with -f or --function."
734         )
735     if not kwargs or "name" not in kwargs:
736         log.error("A name must be specified when deleting a firewall rule.")
737         return False
738     name = kwargs["name"]
739     conn = get_conn()
740     __utils__["cloud.fire_event"](
741         "event",
742         "delete firewall",
743         "salt/cloud/firewall/deleting",
744         args={"name": name},
745         sock_dir=__opts__["sock_dir"],
746         transport=__opts__["transport"],
747     )
748     try:
749         result = conn.ex_destroy_firewall(conn.ex_get_firewall(name))
750     except ResourceNotFoundError as exc:
751         log.error(
752             "Rule %s was not found. Exception was: %s",
753             name,
754             exc,
755             exc_info_on_loglevel=logging.DEBUG,
756         )
757         return False
758     __utils__["cloud.fire_event"](
759         "event",
760         "deleted firewall",
761         "salt/cloud/firewall/deleted",
762         args={"name": name},
763         sock_dir=__opts__["sock_dir"],
764         transport=__opts__["transport"],
765     )
766     return result
767 def show_fwrule(kwargs=None, call=None):
768     """
769     Show the details of an existing firewall rule.
770     CLI Example:
771     .. code-block:: bash
772         salt-cloud -f show_fwrule gce name=allow-http
773     """
774     if call != "function":
775         raise SaltCloudSystemExit(
776             "The show_fwrule function must be called with -f or --function."
777         )
778     if not kwargs or "name" not in kwargs:
779         log.error("Must specify name of network.")
780         return False
781     conn = get_conn()
782     return _expand_item(conn.ex_get_firewall(kwargs["name"]))
783 def create_hc(kwargs=None, call=None):
784     """
785     Create an HTTP health check configuration.
786     CLI Example:
787     .. code-block:: bash
788         salt-cloud -f create_hc gce name=hc path=/healthy port=80
789     """
790     if call != "function":
791         raise SaltCloudSystemExit(
792             "The create_hc function must be called with -f or --function."
793         )
794     if not kwargs or "name" not in kwargs:
795         log.error("A name must be specified when creating a health check.")
796         return False
797     name = kwargs["name"]
798     host = kwargs.get("host", None)
799     path = kwargs.get("path", None)
800     port = kwargs.get("port", None)
801     interval = kwargs.get("interval", None)
802     timeout = kwargs.get("timeout", None)
803     unhealthy_threshold = kwargs.get("unhealthy_threshold", None)
804     healthy_threshold = kwargs.get("healthy_threshold", None)
805     conn = get_conn()
806     __utils__["cloud.fire_event"](
807         "event",
808         "create health_check",
809         "salt/cloud/healthcheck/creating",
810         args={
811             "name": name,
812             "host": host,
813             "path": path,
814             "port": port,
815             "interval": interval,
816             "timeout": timeout,
817             "unhealthy_threshold": unhealthy_threshold,
818             "healthy_threshold": healthy_threshold,
819         },
820         sock_dir=__opts__["sock_dir"],
821         transport=__opts__["transport"],
822     )
823     hc = conn.ex_create_healthcheck(
824         name,
825         host=host,
826         path=path,
827         port=port,
828         interval=interval,
829         timeout=timeout,
830         unhealthy_threshold=unhealthy_threshold,
831         healthy_threshold=healthy_threshold,
832     )
833     __utils__["cloud.fire_event"](
834         "event",
835         "created health_check",
836         "salt/cloud/healthcheck/created",
837         args={
838             "name": name,
839             "host": host,
840             "path": path,
841             "port": port,
842             "interval": interval,
843             "timeout": timeout,
844             "unhealthy_threshold": unhealthy_threshold,
845             "healthy_threshold": healthy_threshold,
846         },
847         sock_dir=__opts__["sock_dir"],
848         transport=__opts__["transport"],
849     )
850     return _expand_item(hc)
851 def delete_hc(kwargs=None, call=None):
852     """
853     Permanently delete a health check.
854     CLI Example:
855     .. code-block:: bash
856         salt-cloud -f delete_hc gce name=hc
857     """
858     if call != "function":
859         raise SaltCloudSystemExit(
860             "The delete_hc function must be called with -f or --function."
861         )
862     if not kwargs or "name" not in kwargs:
863         log.error("A name must be specified when deleting a health check.")
864         return False
865     name = kwargs["name"]
866     conn = get_conn()
867     __utils__["cloud.fire_event"](
868         "event",
869         "delete health_check",
870         "salt/cloud/healthcheck/deleting",
871         args={"name": name},
872         sock_dir=__opts__["sock_dir"],
873         transport=__opts__["transport"],
874     )
875     try:
876         result = conn.ex_destroy_healthcheck(conn.ex_get_healthcheck(name))
877     except ResourceNotFoundError as exc:
878         log.error(
879             "Health check %s was not found. Exception was: %s",
880             name,
881             exc,
882             exc_info_on_loglevel=logging.DEBUG,
883         )
884         return False
885     __utils__["cloud.fire_event"](
886         "event",
887         "deleted health_check",
888         "salt/cloud/healthcheck/deleted",
889         args={"name": name},
890         sock_dir=__opts__["sock_dir"],
891         transport=__opts__["transport"],
892     )
893     return result
894 def show_hc(kwargs=None, call=None):
895     """
896     Show the details of an existing health check.
897     CLI Example:
898     .. code-block:: bash
899         salt-cloud -f show_hc gce name=hc
900     """
901     if call != "function":
902         raise SaltCloudSystemExit(
903             "The show_hc function must be called with -f or --function."
904         )
905     if not kwargs or "name" not in kwargs:
906         log.error("Must specify name of health check.")
907         return False
908     conn = get_conn()
909     return _expand_item(conn.ex_get_healthcheck(kwargs["name"]))
910 def create_address(kwargs=None, call=None):
911     """
912     Create a static address in a region.
913     CLI Example:
914     .. code-block:: bash
915         salt-cloud -f create_address gce name=my-ip region=us-central1 address=IP
916     """
917     if call != "function":
918         raise SaltCloudSystemExit(
919             "The create_address function must be called with -f or --function."
920         )
921     if not kwargs or "name" not in kwargs:
922         log.error("A name must be specified when creating an address.")
923         return False
924     if "region" not in kwargs:
925         log.error("A region must be specified for the address.")
926         return False
927     name = kwargs["name"]
928     ex_region = kwargs["region"]
929     ex_address = kwargs.get("address", None)
930     kwargs["region"] = {"name": ex_region.name}
931     conn = get_conn()
932     __utils__["cloud.fire_event"](
933         "event",
934         "create address",
935         "salt/cloud/address/creating",
936         args=salt.utils.data.simple_types_filter(kwargs),
937         sock_dir=__opts__["sock_dir"],
938         transport=__opts__["transport"],
939     )
940     addy = conn.ex_create_address(name, ex_region, ex_address)
941     __utils__["cloud.fire_event"](
942         "event",
943         "created address",
944         "salt/cloud/address/created",
945         args=salt.utils.data.simple_types_filter(kwargs),
946         sock_dir=__opts__["sock_dir"],
947         transport=__opts__["transport"],
948     )
949     log.info("Created GCE Address %s", name)
950     return _expand_address(addy)
951 def delete_address(kwargs=None, call=None):
952     """
953     Permanently delete a static address.
954     CLI Example:
955     .. code-block:: bash
956         salt-cloud -f delete_address gce name=my-ip
957     """
958     if call != "function":
959         raise SaltCloudSystemExit(
960             "The delete_address function must be called with -f or --function."
961         )
962     if not kwargs or "name" not in kwargs:
963         log.error("A name must be specified when deleting an address.")
964         return False
965     if not kwargs or "region" not in kwargs:
966         log.error("A region must be specified when deleting an address.")
967         return False
968     name = kwargs["name"]
969     ex_region = kwargs["region"]
970     conn = get_conn()
971     __utils__["cloud.fire_event"](
972         "event",
973         "delete address",
974         "salt/cloud/address/deleting",
975         args={"name": name},
976         sock_dir=__opts__["sock_dir"],
977         transport=__opts__["transport"],
978     )
979     try:
980         result = conn.ex_destroy_address(conn.ex_get_address(name, ex_region))
981     except ResourceNotFoundError as exc:
982         log.error(
983             "Address %s in region %s was not found. Exception was: %s",
984             name,
985             ex_region,
986             exc,
987             exc_info_on_loglevel=logging.DEBUG,
988         )
989         return False
990     __utils__["cloud.fire_event"](
991         "event",
992         "deleted address",
993         "salt/cloud/address/deleted",
994         args={"name": name},
995         sock_dir=__opts__["sock_dir"],
996         transport=__opts__["transport"],
997     )
998     log.info("Deleted GCE Address %s", name)
999     return result
1000 def show_address(kwargs=None, call=None):
1001     """
1002     Show the details of an existing static address.
1003     CLI Example:
1004     .. code-block:: bash
1005         salt-cloud -f show_address gce name=mysnapshot region=us-central1
1006     """
1007     if call != "function":
1008         raise SaltCloudSystemExit(
1009             "The show_snapshot function must be called with -f or --function."
1010         )
1011     if not kwargs or "name" not in kwargs:
1012         log.error("Must specify name.")
1013         return False
1014     if not kwargs or "region" not in kwargs:
1015         log.error("Must specify region.")
1016         return False
1017     conn = get_conn()
1018     return _expand_address(conn.ex_get_address(kwargs["name"], kwargs["region"]))
1019 def create_lb(kwargs=None, call=None):
1020     """
1021     Create a load-balancer configuration.
1022     CLI Example:
1023     .. code-block:: bash
1024         salt-cloud -f create_lb gce name=lb region=us-central1 ports=80
1025     """
1026     if call != "function":
1027         raise SaltCloudSystemExit(
1028             "The create_lb function must be called with -f or --function."
1029         )
1030     if not kwargs or "name" not in kwargs:
1031         log.error("A name must be specified when creating a health check.")
1032         return False
1033     if "ports" not in kwargs:
1034         log.error("A port or port-range must be specified for the load-balancer.")
1035         return False
1036     if "region" not in kwargs:
1037         log.error("A region must be specified for the load-balancer.")
1038         return False
1039     if "members" not in kwargs:
1040         log.error("A comma-separated list of members must be specified.")
1041         return False
1042     name = kwargs["name"]
1043     ports = kwargs["ports"]
1044     ex_region = kwargs["region"]
1045     members = kwargs.get("members").split(",")
1046     protocol = kwargs.get("protocol", "tcp")
1047     algorithm = kwargs.get("algorithm", None)
1048     ex_healthchecks = kwargs.get("healthchecks", None)
1049     conn = get_conn()
1050     lb_conn = get_lb_conn(conn)
1051     ex_address = kwargs.get("address", None)
1052     if ex_address is not None:
1053         ex_address = __create_orget_address(conn, ex_address, ex_region)
1054     if ex_healthchecks:
1055         ex_healthchecks = ex_healthchecks.split(",")
1056     __utils__["cloud.fire_event"](
1057         "event",
1058         "create load_balancer",
1059         "salt/cloud/loadbalancer/creating",
1060         args=kwargs,
1061         sock_dir=__opts__["sock_dir"],
1062         transport=__opts__["transport"],
1063     )
1064     lb = lb_conn.create_balancer(
1065         name,
1066         ports,
1067         protocol,
1068         algorithm,
1069         members,
1070         ex_region=ex_region,
1071         ex_healthchecks=ex_healthchecks,
1072         ex_address=ex_address,
1073     )
1074     __utils__["cloud.fire_event"](
1075         "event",
1076         "created load_balancer",
1077         "salt/cloud/loadbalancer/created",
1078         args=kwargs,
1079         sock_dir=__opts__["sock_dir"],
1080         transport=__opts__["transport"],
1081     )
1082     return _expand_balancer(lb)
1083 def delete_lb(kwargs=None, call=None):
1084     """
1085     Permanently delete a load-balancer.
1086     CLI Example:
1087     .. code-block:: bash
1088         salt-cloud -f delete_lb gce name=lb
1089     """
1090     if call != "function":
1091         raise SaltCloudSystemExit(
1092             "The delete_hc function must be called with -f or --function."
1093         )
1094     if not kwargs or "name" not in kwargs:
1095         log.error("A name must be specified when deleting a health check.")
1096         return False
1097     name = kwargs["name"]
1098     lb_conn = get_lb_conn(get_conn())
1099     __utils__["cloud.fire_event"](
1100         "event",
1101         "delete load_balancer",
1102         "salt/cloud/loadbalancer/deleting",
1103         args={"name": name},
1104         sock_dir=__opts__["sock_dir"],
1105         transport=__opts__["transport"],
1106     )
1107     try:
1108         result = lb_conn.destroy_balancer(lb_conn.get_balancer(name))
1109     except ResourceNotFoundError as exc:
1110         log.error(
1111             "Load balancer %s was not found. Exception was: %s",
1112             name,
1113             exc,
1114             exc_info_on_loglevel=logging.DEBUG,
1115         )
1116         return False
1117     __utils__["cloud.fire_event"](
1118         "event",
1119         "deleted load_balancer",
1120         "salt/cloud/loadbalancer/deleted",
1121         args={"name": name},
1122         sock_dir=__opts__["sock_dir"],
1123         transport=__opts__["transport"],
1124     )
1125     return result
1126 def show_lb(kwargs=None, call=None):
1127     """
1128     Show the details of an existing load-balancer.
1129     CLI Example:
1130     .. code-block:: bash
1131         salt-cloud -f show_lb gce name=lb
1132     """
1133     if call != "function":
1134         raise SaltCloudSystemExit(
1135             "The show_lb function must be called with -f or --function."
1136         )
1137     if not kwargs or "name" not in kwargs:
1138         log.error("Must specify name of load-balancer.")
1139         return False
1140     lb_conn = get_lb_conn(get_conn())
1141     return _expand_balancer(lb_conn.get_balancer(kwargs["name"]))
1142 def attach_lb(kwargs=None, call=None):
1143     """
1144     Add an existing node/member to an existing load-balancer configuration.
1145     CLI Example:
1146     .. code-block:: bash
1147         salt-cloud -f attach_lb gce name=lb member=myinstance
1148     """
1149     if call != "function":
1150         raise SaltCloudSystemExit(
1151             "The attach_lb function must be called with -f or --function."
1152         )
1153     if not kwargs or "name" not in kwargs:
1154         log.error("A load-balancer name must be specified.")
1155         return False
1156     if "member" not in kwargs:
1157         log.error("A node name name must be specified.")
1158         return False
1159     conn = get_conn()
1160     node = conn.ex_get_node(kwargs["member"])
1161     lb_conn = get_lb_conn(conn)
1162     lb = lb_conn.get_balancer(kwargs["name"])
1163     __utils__["cloud.fire_event"](
1164         "event",
1165         "attach load_balancer",
1166         "salt/cloud/loadbalancer/attaching",
1167         args=kwargs,
1168         sock_dir=__opts__["sock_dir"],
1169         transport=__opts__["transport"],
1170     )
1171     result = lb_conn.balancer_attach_compute_node(lb, node)
1172     __utils__["cloud.fire_event"](
1173         "event",
1174         "attached load_balancer",
1175         "salt/cloud/loadbalancer/attached",
1176         args=kwargs,
1177         sock_dir=__opts__["sock_dir"],
1178         transport=__opts__["transport"],
1179     )
1180     return _expand_item(result)
1181 def detach_lb(kwargs=None, call=None):
1182     """
1183     Remove an existing node/member from an existing load-balancer configuration.
1184     CLI Example:
1185     .. code-block:: bash
1186         salt-cloud -f detach_lb gce name=lb member=myinstance
1187     """
1188     if call != "function":
1189         raise SaltCloudSystemExit(
1190             "The detach_lb function must be called with -f or --function."
1191         )
1192     if not kwargs or "name" not in kwargs:
1193         log.error("A load-balancer name must be specified.")
1194         return False
1195     if "member" not in kwargs:
1196         log.error("A node name name must be specified.")
1197         return False
1198     conn = get_conn()
1199     lb_conn = get_lb_conn(conn)
1200     lb = lb_conn.get_balancer(kwargs["name"])
1201     member_list = lb_conn.balancer_list_members(lb)
1202     remove_member = None
1203     for member in member_list:
1204         if member.id == kwargs["member"]:
1205             remove_member = member
1206             break
1207     if not remove_member:
1208         log.error(
1209             "The specified member %s was not a member of LB %s.",
1210             kwargs["member"],
1211             kwargs["name"],
1212         )
1213         return False
1214     __utils__["cloud.fire_event"](
1215         "event",
1216         "detach load_balancer",
1217         "salt/cloud/loadbalancer/detaching",
1218         args=kwargs,
1219         sock_dir=__opts__["sock_dir"],
1220         transport=__opts__["transport"],
1221     )
1222     result = lb_conn.balancer_detach_member(lb, remove_member)
1223     __utils__["cloud.fire_event"](
1224         "event",
1225         "detached load_balancer",
1226         "salt/cloud/loadbalancer/detached",
1227         args=kwargs,
1228         sock_dir=__opts__["sock_dir"],
1229         transport=__opts__["transport"],
1230     )
1231     return result
1232 def delete_snapshot(kwargs=None, call=None):
1233     """
1234     Permanently delete a disk snapshot.
1235     CLI Example:
1236     .. code-block:: bash
1237         salt-cloud -f delete_snapshot gce name=disk-snap-1
1238     """
1239     if call != "function":
1240         raise SaltCloudSystemExit(
1241             "The delete_snapshot function must be called with -f or --function."
1242         )
1243     if not kwargs or "name" not in kwargs:
1244         log.error("A name must be specified when deleting a snapshot.")
1245         return False
1246     name = kwargs["name"]
1247     conn = get_conn()
1248     __utils__["cloud.fire_event"](
1249         "event",
1250         "delete snapshot",
1251         "salt/cloud/snapshot/deleting",
1252         args={"name": name},
1253         sock_dir=__opts__["sock_dir"],
1254         transport=__opts__["transport"],
1255     )
1256     try:
1257         result = conn.destroy_volume_snapshot(conn.ex_get_snapshot(name))
1258     except ResourceNotFoundError as exc:
1259         log.error(
1260             "Snapshot %s was not found. Exception was: %s",
1261             name,
1262             exc,
1263             exc_info_on_loglevel=logging.DEBUG,
1264         )
1265         return False
1266     __utils__["cloud.fire_event"](
1267         "event",
1268         "deleted snapshot",
1269         "salt/cloud/snapshot/deleted",
1270         args={"name": name},
1271         sock_dir=__opts__["sock_dir"],
1272         transport=__opts__["transport"],
1273     )
1274     return result
1275 def delete_disk(kwargs=None, call=None):
1276     """
1277     Permanently delete a persistent disk.
1278     CLI Example:
1279     .. code-block:: bash
1280         salt-cloud -f delete_disk gce disk_name=pd
1281     """
1282     if call != "function":
1283         raise SaltCloudSystemExit(
1284             "The delete_disk function must be called with -f or --function."
1285         )
1286     if not kwargs or "disk_name" not in kwargs:
1287         log.error("A disk_name must be specified when deleting a disk.")
1288         return False
1289     conn = get_conn()
1290     disk = conn.ex_get_volume(kwargs.get("disk_name"))
1291     __utils__["cloud.fire_event"](
1292         "event",
1293         "delete disk",
1294         "salt/cloud/disk/deleting",
1295         args={
1296             "name": disk.name,
1297             "location": disk.extra["zone"].name,
1298             "size": disk.size,
1299         },
1300         sock_dir=__opts__["sock_dir"],
1301         transport=__opts__["transport"],
1302     )
1303     try:
1304         result = conn.destroy_volume(disk)
1305     except ResourceInUseError as exc:
1306         log.error(
1307             "Disk %s is in use and must be detached before deleting.\n"
1308             "The following exception was thrown by libcloud:\n%s",
1309             disk.name,
1310             exc,
1311             exc_info_on_loglevel=logging.DEBUG,
1312         )
1313         return False
1314     __utils__["cloud.fire_event"](
1315         "event",
1316         "deleted disk",
1317         "salt/cloud/disk/deleted",
1318         args={
1319             "name": disk.name,
1320             "location": disk.extra["zone"].name,
1321             "size": disk.size,
1322         },
1323         sock_dir=__opts__["sock_dir"],
1324         transport=__opts__["transport"],
1325     )
1326     return result
1327 def create_disk(kwargs=None, call=None):
1328     """
1329     Create a new persistent disk. Must specify `disk_name` and `location`,
1330     and optionally can specify 'disk_type' as pd-standard or pd-ssd, which
1331     defaults to pd-standard. Can also specify an `image` or `snapshot` but
1332     if neither of those are specified, a `size` (in GB) is required.
1333     CLI Example:
1334     .. code-block:: bash
1335         salt-cloud -f create_disk gce disk_name=pd size=300 location=us-central1-b
1336     """
1337     if call != "function":
1338         raise SaltCloudSystemExit(
1339             "The create_disk function must be called with -f or --function."
1340         )
1341     if kwargs is None:
1342         kwargs = {}
1343     name = kwargs.get("disk_name", None)
1344     image = kwargs.get("image", None)
1345     location = kwargs.get("location", None)
1346     size = kwargs.get("size", None)
1347     snapshot = kwargs.get("snapshot", None)
1348     disk_type = kwargs.get("type", "pd-standard")
1349     if location is None:
1350         log.error("A location (zone) must be specified when creating a disk.")
1351         return False
1352     if name is None:
1353         log.error("A disk_name must be specified when creating a disk.")
1354         return False
1355     if size is None and image is None and snapshot is None:
1356         log.error("Must specify image, snapshot, or size.")
1357         return False
1358     conn = get_conn()
1359     location = conn.ex_get_zone(kwargs["location"])
1360     use_existing = True
1361     __utils__["cloud.fire_event"](
1362         "event",
1363         "create disk",
1364         "salt/cloud/disk/creating",
1365         args={
1366             "name": name,
1367             "location": location.name,
1368             "image": image,
1369             "snapshot": snapshot,
1370         },
1371         sock_dir=__opts__["sock_dir"],
1372         transport=__opts__["transport"],
1373     )
1374     disk = conn.create_volume(
1375         size, name, location, snapshot, image, use_existing, disk_type
1376     )
1377     __utils__["cloud.fire_event"](
1378         "event",
1379         "created disk",
1380         "salt/cloud/disk/created",
1381         args={
1382             "name": name,
1383             "location": location.name,
1384             "image": image,
1385             "snapshot": snapshot,
1386         },
1387         sock_dir=__opts__["sock_dir"],
1388         transport=__opts__["transport"],
1389     )
1390     return _expand_disk(disk)
1391 def create_snapshot(kwargs=None, call=None):
1392     """
1393     Create a new disk snapshot. Must specify `name` and  `disk_name`.
1394     CLI Example:
1395     .. code-block:: bash
1396         salt-cloud -f create_snapshot gce name=snap1 disk_name=pd
1397     """
1398     if call != "function":
1399         raise SaltCloudSystemExit(
1400             "The create_snapshot function must be called with -f or --function."
1401         )
1402     if not kwargs or "name" not in kwargs:
1403         log.error("A name must be specified when creating a snapshot.")
1404         return False
1405     if "disk_name" not in kwargs:
1406         log.error("A disk_name must be specified when creating a snapshot.")
1407         return False
1408     conn = get_conn()
1409     name = kwargs.get("name")
1410     disk_name = kwargs.get("disk_name")
1411     try:
1412         disk = conn.ex_get_volume(disk_name)
1413     except ResourceNotFoundError as exc:
1414         log.error(
1415             "Disk %s was not found. Exception was: %s",
1416             disk_name,
1417             exc,
1418             exc_info_on_loglevel=logging.DEBUG,
1419         )
1420         return False
1421     __utils__["cloud.fire_event"](
1422         "event",
1423         "create snapshot",
1424         "salt/cloud/snapshot/creating",
1425         args={"name": name, "disk_name": disk_name},
1426         sock_dir=__opts__["sock_dir"],
1427         transport=__opts__["transport"],
1428     )
1429     snapshot = conn.create_volume_snapshot(disk, name)
1430     __utils__["cloud.fire_event"](
1431         "event",
1432         "created snapshot",
1433         "salt/cloud/snapshot/created",
1434         args={"name": name, "disk_name": disk_name},
1435         sock_dir=__opts__["sock_dir"],
1436         transport=__opts__["transport"],
1437     )
1438     return _expand_item(snapshot)
1439 def show_disk(name=None, kwargs=None, call=None):  # pylint: disable=W0613
1440     """
1441     Show the details of an existing disk.
1442     CLI Example:
1443     .. code-block:: bash
1444         salt-cloud -a show_disk myinstance disk_name=mydisk
1445         salt-cloud -f show_disk gce disk_name=mydisk
1446     """
1447     if not kwargs or "disk_name" not in kwargs:
1448         log.error("Must specify disk_name.")
1449         return False
1450     conn = get_conn()
1451     return _expand_disk(conn.ex_get_volume(kwargs["disk_name"]))
1452 def show_snapshot(kwargs=None, call=None):
1453     """
1454     Show the details of an existing snapshot.
1455     CLI Example:
1456     .. code-block:: bash
1457         salt-cloud -f show_snapshot gce name=mysnapshot
1458     """
1459     if call != "function":
1460         raise SaltCloudSystemExit(
1461             "The show_snapshot function must be called with -f or --function."
1462         )
1463     if not kwargs or "name" not in kwargs:
1464         log.error("Must specify name.")
1465         return False
1466     conn = get_conn()
1467     return _expand_item(conn.ex_get_snapshot(kwargs["name"]))
1468 def detach_disk(name=None, kwargs=None, call=None):
1469     """
1470     Detach a disk from an instance.
1471     CLI Example:
1472     .. code-block:: bash
1473         salt-cloud -a detach_disk myinstance disk_name=mydisk
1474     """
1475     if call != "action":
1476         raise SaltCloudSystemExit(
1477             "The detach_Disk action must be called with -a or --action."
1478         )
1479     if not name:
1480         log.error("Must specify an instance name.")
1481         return False
1482     if not kwargs or "disk_name" not in kwargs:
1483         log.error("Must specify a disk_name to detach.")
1484         return False
1485     node_name = name
1486     disk_name = kwargs["disk_name"]
1487     conn = get_conn()
1488     node = conn.ex_get_node(node_name)
1489     disk = conn.ex_get_volume(disk_name)
1490     __utils__["cloud.fire_event"](
1491         "event",
1492         "detach disk",
1493         "salt/cloud/disk/detaching",
1494         args={"name": node_name, "disk_name": disk_name},
1495         sock_dir=__opts__["sock_dir"],
1496         transport=__opts__["transport"],
1497     )
1498     result = conn.detach_volume(disk, node)
1499     __utils__["cloud.fire_event"](
1500         "event",
1501         "detached disk",
1502         "salt/cloud/disk/detached",
1503         args={"name": node_name, "disk_name": disk_name},
1504         sock_dir=__opts__["sock_dir"],
1505         transport=__opts__["transport"],
1506     )
1507     return result
1508 def attach_disk(name=None, kwargs=None, call=None):
1509     """
1510     Attach an existing disk to an existing instance.
1511     CLI Example:
1512     .. code-block:: bash
1513         salt-cloud -a attach_disk myinstance disk_name=mydisk mode=READ_WRITE
1514     """
1515     if call != "action":
1516         raise SaltCloudSystemExit(
1517             "The attach_disk action must be called with -a or --action."
1518         )
1519     if not name:
1520         log.error("Must specify an instance name.")
1521         return False
1522     if not kwargs or "disk_name" not in kwargs:
1523         log.error("Must specify a disk_name to attach.")
1524         return False
1525     node_name = name
1526     disk_name = kwargs["disk_name"]
1527     mode = kwargs.get("mode", "READ_WRITE").upper()
1528     boot = kwargs.get("boot", False)
1529     auto_delete = kwargs.get("auto_delete", False)
1530     if boot and boot.lower() in ["true", "yes", "enabled"]:
1531         boot = True
1532     else:
1533         boot = False
1534     if mode not in ["READ_WRITE", "READ_ONLY"]:
1535         log.error("Mode must be either READ_ONLY or (default) READ_WRITE.")
1536         return False
1537     conn = get_conn()
1538     node = conn.ex_get_node(node_name)
1539     disk = conn.ex_get_volume(disk_name)
1540     __utils__["cloud.fire_event"](
1541         "event",
1542         "attach disk",
1543         "salt/cloud/disk/attaching",
1544         args={"name": node_name, "disk_name": disk_name, "mode": mode, "boot": boot},
1545         sock_dir=__opts__["sock_dir"],
1546         transport=__opts__["transport"],
1547     )
1548     result = conn.attach_volume(
1549         node, disk, ex_mode=mode, ex_boot=boot, ex_auto_delete=auto_delete
1550     )
1551     __utils__["cloud.fire_event"](
1552         "event",
1553         "attached disk",
1554         "salt/cloud/disk/attached",
1555         args={"name": node_name, "disk_name": disk_name, "mode": mode, "boot": boot},
1556         sock_dir=__opts__["sock_dir"],
1557         transport=__opts__["transport"],
1558     )
1559     return result
1560 def reboot(vm_name, call=None):
1561     """
1562     Call GCE 'reset' on the instance.
1563     CLI Example:
1564     .. code-block:: bash
1565         salt-cloud -a reboot myinstance
1566     """
1567     if call != "action":
1568         raise SaltCloudSystemExit(
1569             "The reboot action must be called with -a or --action."
1570         )
1571     conn = get_conn()
1572     __utils__["cloud.fire_event"](
1573         "event",
1574         "reboot instance",
1575         "salt/cloud/{}/rebooting".format(vm_name),
1576         args={"name": vm_name},
1577         sock_dir=__opts__["sock_dir"],
1578         transport=__opts__["transport"],
1579     )
1580     result = conn.reboot_node(conn.ex_get_node(vm_name))
1581     __utils__["cloud.fire_event"](
1582         "event",
1583         "reboot instance",
1584         "salt/cloud/{}/rebooted".format(vm_name),
1585         args={"name": vm_name},
1586         sock_dir=__opts__["sock_dir"],
1587         transport=__opts__["transport"],
1588     )
1589     return result
1590 def start(vm_name, call=None):
1591     """
1592     Call GCE 'start on the instance.
1593     .. versionadded:: 2017.7.0
1594     CLI Example:
1595     .. code-block:: bash
1596         salt-cloud -a start myinstance
1597     """
1598     if call != "action":
1599         raise SaltCloudSystemExit(
1600             "The start action must be called with -a or --action."
1601         )
1602     conn = get_conn()
1603     __utils__["cloud.fire_event"](
1604         "event",
1605         "start instance",
1606         "salt/cloud/{}/starting".format(vm_name),
1607         args={"name": vm_name},
1608         sock_dir=__opts__["sock_dir"],
1609         transport=__opts__["transport"],
1610     )
1611     result = conn.ex_start_node(conn.ex_get_node(vm_name))
1612     __utils__["cloud.fire_event"](
1613         "event",
1614         "start instance",
1615         "salt/cloud/{}/started".format(vm_name),
1616         args={"name": vm_name},
1617         sock_dir=__opts__["sock_dir"],
1618         transport=__opts__["transport"],
1619     )
1620     return result
1621 def stop(vm_name, call=None):
1622     """
1623     Call GCE 'stop' on the instance.
1624     .. versionadded:: 2017.7.0
1625     CLI Example:
1626     .. code-block:: bash
1627         salt-cloud -a stop myinstance
1628     """
1629     if call != "action":
1630         raise SaltCloudSystemExit("The stop action must be called with -a or --action.")
1631     conn = get_conn()
1632     __utils__["cloud.fire_event"](
1633         "event",
1634         "stop instance",
1635         "salt/cloud/{}/stopping".format(vm_name),
1636         args={"name": vm_name},
1637         sock_dir=__opts__["sock_dir"],
1638         transport=__opts__["transport"],
1639     )
1640     result = conn.ex_stop_node(conn.ex_get_node(vm_name))
1641     __utils__["cloud.fire_event"](
1642         "event",
1643         "stop instance",
1644         "salt/cloud/{}/stopped".format(vm_name),
1645         args={"name": vm_name},
1646         sock_dir=__opts__["sock_dir"],
1647         transport=__opts__["transport"],
1648     )
1649     return result
1650 def destroy(vm_name, call=None):
1651     """
1652     Call 'destroy' on the instance.  Can be called with "-a destroy" or -d
1653     CLI Example:
1654     .. code-block:: bash
1655         salt-cloud -a destroy myinstance1 myinstance2 ...
1656         salt-cloud -d myinstance1 myinstance2 ...
1657     """
1658     if call and call != "action":
1659         raise SaltCloudSystemExit(
1660             'The destroy action must be called with -d or "-a destroy".'
1661         )
1662     conn = get_conn()
1663     try:
1664         node = conn.ex_get_node(vm_name)
1665     except Exception as exc:  # pylint: disable=W0703
1666         log.error(
1667             "Could not locate instance %s\n\n"
1668             "The following exception was thrown by libcloud when trying to "
1669             "run the initial deployment: \n%s",
1670             vm_name,
1671             exc,
1672             exc_info_on_loglevel=logging.DEBUG,
1673         )
1674         raise SaltCloudSystemExit("Could not find instance {}.".format(vm_name))
1675     __utils__["cloud.fire_event"](
1676         "event",
1677         "delete instance",
1678         "salt/cloud/{}/deleting".format(vm_name),
1679         args={"name": vm_name},
1680         sock_dir=__opts__["sock_dir"],
1681         transport=__opts__["transport"],
1682     )
1683     profile = None
1684     if node.extra["metadata"] and "items" in node.extra["metadata"]:
1685         for md in node.extra["metadata"]["items"]:
1686             if md["key"] == "salt-cloud-profile":
1687                 profile = md["value"]
1688     vm_ = get_configured_provider()
1689     delete_boot_pd = False
1690     if (
1691         profile
1692         and profile in vm_["profiles"]
1693         and "delete_boot_pd" in vm_["profiles"][profile]
1694     ):
1695         delete_boot_pd = vm_["profiles"][profile]["delete_boot_pd"]
1696     try:
1697         inst_deleted = conn.destroy_node(node)
1698     except Exception as exc:  # pylint: disable=W0703
1699         log.error(
1700             "Could not destroy instance %s\n\n"
1701             "The following exception was thrown by libcloud when trying to "
1702             "run the initial deployment: \n%s",
1703             vm_name,
1704             exc,
1705             exc_info_on_loglevel=logging.DEBUG,
1706         )
1707         raise SaltCloudSystemExit("Could not destroy instance {}.".format(vm_name))
1708     __utils__["cloud.fire_event"](
1709         "event",
1710         "delete instance",
1711         "salt/cloud/{}/deleted".format(vm_name),
1712         args={"name": vm_name},
1713         sock_dir=__opts__["sock_dir"],
1714         transport=__opts__["transport"],
1715     )
1716     if delete_boot_pd:
1717         log.info(
1718             "delete_boot_pd is enabled for the instance profile, "
1719             "attempting to delete disk"
1720         )
1721         __utils__["cloud.fire_event"](
1722             "event",
1723             "delete disk",
1724             "salt/cloud/disk/deleting",
1725             args={"name": vm_name},
1726             sock_dir=__opts__["sock_dir"],
1727             transport=__opts__["transport"],
1728         )
1729         try:
1730             conn.destroy_volume(conn.ex_get_volume(vm_name))
1731         except Exception as exc:  # pylint: disable=W0703
1732             log.error(
1733                 "Could not destroy disk %s\n\n"
1734                 "The following exception was thrown by libcloud when trying "
1735                 "to run the initial deployment: \n%s",
1736                 vm_name,
1737                 exc,
1738                 exc_info_on_loglevel=logging.DEBUG,
1739             )
1740         __utils__["cloud.fire_event"](
1741             "event",
1742             "deleted disk",
1743             "salt/cloud/disk/deleted",
1744             args={"name": vm_name},
1745             sock_dir=__opts__["sock_dir"],
1746             transport=__opts__["transport"],
1747         )
1748     if __opts__.get("update_cachedir", False) is True:
1749         __utils__["cloud.delete_minion_cachedir"](
1750             vm_name, _get_active_provider_name().split(":")[0], __opts__
1751         )
1752     return inst_deleted
1753 def create_attach_volumes(name, kwargs, call=None):
1754     """
1755     .. versionadded:: 2017.7.0
1756     Create and attach multiple volumes to a node. The 'volumes' and 'node'
1757     arguments are required, where 'node' is a libcloud node, and 'volumes'
1758     is a list of maps, where each map contains:
1759     size
1760         The size of the new disk in GB. Required.
1761     type
1762         The disk type, either pd-standard or pd-ssd. Optional, defaults to pd-standard.
1763     image
1764         An image to use for this new disk. Optional.
1765     snapshot
1766         A snapshot to use for this new disk. Optional.
1767     auto_delete
1768         An option(bool) to keep or remove the disk upon instance deletion.
1769         Optional, defaults to False.
1770     Volumes are attached in the order in which they are given, thus on a new
1771     node the first volume will be /dev/sdb, the second /dev/sdc, and so on.
1772     """
1773     if call != "action":
1774         raise SaltCloudSystemExit(
1775             "The create_attach_volumes action must be called with -a or --action."
1776         )
1777     volumes = literal_eval(kwargs["volumes"])
1778     node = kwargs["node"]
1779     conn = get_conn()
1780     node_data = _expand_node(conn.ex_get_node(node))
1781     letter = ord("a") - 1
1782     for idx, volume in enumerate(volumes):
1783         volume_name = "{}-sd{}".format(name, chr(letter + 2 + idx))
1784         volume_dict = {
1785             "disk_name": volume_name,
1786             "location": node_data["extra"]["zone"]["name"],
1787             "size": volume["size"],
1788             "type": volume.get("type", "pd-standard"),
1789             "image": volume.get("image", None),
1790             "snapshot": volume.get("snapshot", None),
1791             "auto_delete": volume.get("auto_delete", False),
1792         }
1793         create_disk(volume_dict, "function")
1794         attach_disk(name, volume_dict, "action")
1795 def request_instance(vm_):
1796     """
1797     Request a single GCE instance from a data dict.
1798     .. versionchanged:: 2017.7.0
1799     """
1800     if not GCE_VM_NAME_REGEX.match(vm_["name"]):
1801         raise SaltCloudSystemExit(
1802             "VM names must start with a letter, only contain letters, numbers, or"
1803             " dashes and cannot end in a dash."
1804         )
1805     try:
1806         if (
1807             vm_["profile"]
1808             and config.is_profile_configured(
1809                 __opts__, _get_active_provider_name() or "gce", vm_["profile"], vm_=vm_
1810             )
1811             is False
1812         ):
1813             return False
1814     except AttributeError:
1815         pass
1816     __utils__["cloud.fire_event"](
1817         "event",
1818         "create instance",
1819         "salt/cloud/{}/creating".format(vm_["name"]),
1820         args=__utils__["cloud.filter_event"](
1821             "creating", vm_, ["name", "profile", "provider", "driver"]
1822         ),
1823         sock_dir=__opts__["sock_dir"],
1824         transport=__opts__["transport"],
1825     )
1826     conn = get_conn()
1827     kwargs = {
1828         "name": vm_["name"],
1829         "size": __get_size(conn, vm_),
1830         "image": __get_image(conn, vm_),
1831         "location": __get_location(conn, vm_),
1832         "ex_network": __get_network(conn, vm_),
1833         "ex_subnetwork": __get_subnetwork(vm_),
1834         "ex_tags": __get_tags(vm_),
1835         "ex_metadata": __get_metadata(vm_),
1836     }
1837     external_ip = config.get_cloud_config_value(
1838         "external_ip", vm_, __opts__, default="ephemeral"
1839     )
1840     if external_ip.lower() == "ephemeral":
1841         external_ip = "ephemeral"
1842         vm_["external_ip"] = external_ip
1843     elif external_ip == "None":
1844         external_ip = None
1845         vm_["external_ip"] = external_ip
1846     else:
1847         region = __get_region(conn, vm_)
1848         external_ip = __create_orget_address(conn, external_ip, region)
1849         vm_["external_ip"] = {
1850             "name": external_ip.name,
1851             "address": external_ip.address,
1852             "region": external_ip.region.name,
1853         }
1854     kwargs["external_ip"] = external_ip
1855     if LIBCLOUD_VERSION_INFO &gt; (0, 15, 1):
1856         kwargs.update(
1857             {
1858                 "ex_disk_type": config.get_cloud_config_value(
1859                     "ex_disk_type", vm_, __opts__, default="pd-standard"
1860                 ),
1861                 "ex_disk_auto_delete": config.get_cloud_config_value(
1862                     "ex_disk_auto_delete", vm_, __opts__, default=True
1863                 ),
1864                 "ex_disks_gce_struct": config.get_cloud_config_value(
1865                     "ex_disks_gce_struct", vm_, __opts__, default=None
1866                 ),
1867                 "ex_service_accounts": config.get_cloud_config_value(
1868                     "ex_service_accounts", vm_, __opts__, default=None
1869                 ),
1870                 "ex_can_ip_forward": config.get_cloud_config_value(
1871                     "ip_forwarding", vm_, __opts__, default=False
1872                 ),
1873                 "ex_preemptible": config.get_cloud_config_value(
1874                     "preemptible", vm_, __opts__, default=False
1875                 ),
1876             }
1877         )
1878         if kwargs.get("ex_disk_type") not in ("pd-standard", "pd-ssd"):
1879             raise SaltCloudSystemExit(
1880                 "The value of 'ex_disk_type' needs to be one of: "
1881                 "'pd-standard', 'pd-ssd'"
1882             )
1883     if LIBCLOUD_VERSION_INFO &gt;= (2, 3, 0):
1884         kwargs.update(
1885             {
1886                 "ex_accelerator_type": config.get_cloud_config_value(
1887                     "ex_accelerator_type", vm_, __opts__, default=None
1888                 ),
1889                 "ex_accelerator_count": config.get_cloud_config_value(
1890                     "ex_accelerator_count", vm_, __opts__, default=None
1891                 ),
1892             }
1893         )
1894         if kwargs.get("ex_accelerator_type"):
1895             log.warning(
1896                 "An accelerator is being attached to this instance, "
1897                 "the ex_on_host_maintenance setting is being set to "
1898                 "'TERMINATE' as a result"
1899             )
1900             kwargs.update({"ex_on_host_maintenance": "TERMINATE"})
1901     log.info("Creating GCE instance %s in %s", vm_["name"], kwargs["location"].name)
1902     log.debug("Create instance kwargs %s", kwargs)
1903     __utils__["cloud.fire_event"](
1904         "event",
1905         "requesting instance",
1906         "salt/cloud/{}/requesting".format(vm_["name"]),
1907         args=__utils__["cloud.filter_event"](
1908             "requesting", vm_, ["name", "profile", "provider", "driver"]
1909         ),
1910         sock_dir=__opts__["sock_dir"],
1911         transport=__opts__["transport"],
1912     )
1913     try:
1914         node_data = conn.create_node(**kwargs)
1915     except Exception as exc:  # pylint: disable=W0703
1916         log.error(
1917             "Error creating %s on GCE\n\n"
1918             "The following exception was thrown by libcloud when trying to "
1919             "run the initial deployment: \n%s",
1920             vm_["name"],
1921             exc,
1922             exc_info_on_loglevel=logging.DEBUG,
1923         )
1924         return False
1925     volumes = config.get_cloud_config_value(
1926         "volumes", vm_, __opts__, search_global=True
1927     )
1928     if volumes:
1929             "event",
1930             "attaching volumes",
1931             "salt/cloud/{}/attaching_volumes".format(vm_<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["name"]),
1932             args={"volumes": volumes},
1933             sock_dir=__opts__["sock_dir"],
1934             transport=__opts__["transport"],
1935         )
1936         log.info("Create and attach volumes to node %s", vm_["name"])
1937         create_attach_volumes(
1938             vm_[</b></font>"name"], {"volumes": volumes, "node": node_data}, call="action"
1939         )
1940     try:
1941         node_dict = show_instance(node_data["name"], "action")
1942     except TypeError:
1943         node_dict = show_instance(node_data.name, "action")
1944     return node_dict, node_data
1945 def create(vm_=None, call=None):
1946     """
1947     Create a single GCE instance from a data dict.
1948     """
1949     if call:
1950         raise SaltCloudSystemExit("You cannot create an instance with -a or -f.")
1951     node_info = request_instance(vm_)
1952     if isinstance(node_info, bool):
1953         raise SaltCloudSystemExit("There was an error creating the GCE instance.")
1954     node_dict = node_info[0]
1955     node_data = node_info[1]
1956     ssh_user, ssh_key = __get_ssh_credentials(vm_)
1957     vm_["ssh_host"] = __get_host(node_data, vm_)
1958     vm_["key_filename"] = ssh_key
1959     ret = __utils__["cloud.bootstrap"](vm_, __opts__)
1960     ret.update(node_dict)
1961     log.info("Created Cloud VM '%s'", vm_["name"])
1962     log.trace("'%s' VM creation details:\n%s", vm_["name"], pprint.pformat(node_dict))
1963     __utils__["cloud.fire_event"](
1964         "event",
1965         "created instance",
1966         "salt/cloud/{}/created".format(vm_["name"]),
1967         args=__utils__["cloud.filter_event"](
1968             "created", vm_, ["name", "profile", "provider", "driver"]
1969         ),
1970         sock_dir=__opts__["sock_dir"],
1971         transport=__opts__["transport"],
1972     )
1973     return ret
1974 def update_pricing(kwargs=None, call=None):
1975     """
1976     Download most recent pricing information from GCE and save locally
1977     CLI Examples:
1978     .. code-block:: bash
1979         salt-cloud -f update_pricing my-gce-config
1980     .. versionadded:: 2015.8.0
1981     """
1982     url = "https://cloudpricingcalculator.appspot.com/static/data/pricelist.json"
1983     price_json = salt.utils.http.query(url, decode=True, decode_type="json")
1984     outfile = os.path.join(__opts__["cachedir"], "gce-pricing.p")
1985     with salt.utils.files.fopen(outfile, "w") as fho:
1986         salt.utils.msgpack.dump(price_json["dict"], fho)
1987     return True
1988 def show_pricing(kwargs=None, call=None):
1989     """
1990     Show pricing for a particular profile. This is only an estimate, based on
1991     unofficial pricing sources.
1992     .. versionadded:: 2015.8.0
1993     CLI Examples:
1994     .. code-block:: bash
1995         salt-cloud -f show_pricing my-gce-config profile=my-profile
1996     """
1997     profile = __opts__["profiles"].get(kwargs["profile"], {})
1998     if not profile:
1999         return {"Error": "The requested profile was not found"}
2000     provider = profile.get("provider", "0:0")
2001     comps = provider.split(":")
2002     if len(comps) &lt; 2 or comps[1] != "gce":
2003         return {"Error": "The requested profile does not belong to GCE"}
2004     comps = profile.get("location", "us").split("-")
2005     region = comps[0]
2006     size = "CP-COMPUTEENGINE-VMIMAGE-{}".format(profile["size"].upper())
2007     pricefile = os.path.join(__opts__["cachedir"], "gce-pricing.p")
2008     if not os.path.exists(pricefile):
2009         update_pricing()
2010     with salt.utils.files.fopen(pricefile, "r") as fho:
2011         sizes = salt.utils.msgpack.load(fho)
2012     per_hour = float(sizes["gcp_price_list"][size][region])
2013     week1_discount = float(sizes["gcp_price_list"]["sustained_use_tiers"]["0.25"])
2014     week2_discount = float(sizes["gcp_price_list"]["sustained_use_tiers"]["0.50"])
2015     week3_discount = float(sizes["gcp_price_list"]["sustained_use_tiers"]["0.75"])
2016     week4_discount = float(sizes["gcp_price_list"]["sustained_use_tiers"]["1.0"])
2017     week1 = per_hour * (730 / 4) * week1_discount
2018     week2 = per_hour * (730 / 4) * week2_discount
2019     week3 = per_hour * (730 / 4) * week3_discount
2020     week4 = per_hour * (730 / 4) * week4_discount
2021     raw = sizes
2022     ret = {}
2023     ret["per_hour"] = per_hour
2024     ret["per_day"] = ret["per_hour"] * 24
2025     ret["per_week"] = ret["per_day"] * 7
2026     ret["per_month"] = week1 + week2 + week3 + week4
2027     ret["per_year"] = ret["per_month"] * 12
2028     if kwargs.get("raw", False):
2029         ret["_raw"] = raw
2030     return {profile["profile"]: ret}
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
