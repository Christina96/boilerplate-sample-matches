<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for boto_elasticache.py &amp; boto_iam.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for boto_elasticache.py &amp; boto_iam.py
      </h3>
<h1 align="center">
        13.8%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>boto_elasticache.py (52.09302%)<th>boto_iam.py (8.005718%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(486-502)<td><a href="#" name="0">(1630-1641)</a><td align="center"><font color="#ff0000">29</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(353-391)<td><a href="#" name="1">(1742-1791)</a><td align="center"><font color="#ff0000">29</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(319-332)<td><a href="#" name="2">(1118-1131)</a><td align="center"><font color="#db0000">25</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(520-533)<td><a href="#" name="3">(1721-1731)</a><td align="center"><font color="#b80000">21</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(509-518)<td><a href="#" name="4">(881-887)</a><td align="center"><font color="#9e0000">18</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(333-342)<td><a href="#" name="5">(1914-1921)</a><td align="center"><font color="#950000">17</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(94-113)<td><a href="#" name="6">(1484-1557)</a><td align="center"><font color="#950000">17</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(450-468)<td><a href="#" name="7">(1278-1287)</a><td align="center"><font color="#8c0000">16</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(477-482)<td><a href="#" name="8">(841-846)</a><td align="center"><font color="#830000">15</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(268-280)<td><a href="#" name="9">(1310-1324)</a><td align="center"><font color="#720000">13</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(443-449)<td><a href="#" name="10">(649-653)</a><td align="center"><font color="#690000">12</font>
<tr onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b041ff"><font color="#b041ff">-</font><td><a href="#" name="11">(232-239)<td><a href="#" name="11">(429-432)</a><td align="center"><font color="#690000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>boto_elasticache.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 log = logging.getLogger(__name__)
3 def __virtual__():
4     if "boto_elasticache.exists" in __salt__:
5         return "boto_elasticache"
6     return (False, "boto_elasticache module could not be loaded")
7 def cache_cluster_present(*args, **kwargs):
8     return present(<font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>*args, **kwargs)
9 def present(
10     name,
11     engine=None,
12     cache_node_type=None,
13     num_cache_nodes=None,
14     preferred_availability_zone=None,
15     port=None,
16     cache_parameter_group_name=None,
17     cache_security_group_names=None,
18     replication_group_id=None,
19     auto_minor_version_upgrade=True,
20     security_group_ids=None,
21     cache_subnet_group_name=None,
22     engine_version=None,
23     notification_topic_arn=None,
24     preferred_maintenance_window=None,
25     wait=</b></font>None,
26     region=None,
27     key=None,
28     keyid=None,
29     profile=None,
30 ):
31     ret = {"name": name, "result": True, "comment": "", "changes": {}}
32     if cache_security_group_names and cache_subnet_group_name:
33         _subnet_group = __salt__["boto_elasticache.get_cache_subnet_group"](
34             cache_subnet_group_name, region, key, keyid, profile
35         )
36         vpc_id = _subnet_group["vpc_id"]
37         if not security_group_ids:
38             security_group_ids = []
39         _security_group_ids = __salt__["boto_secgroup.convert_to_group_ids"](
40             groups=cache_security_group_names,
41             vpc_id=vpc_id,
42             region=region,
43             key=key,
44             keyid=keyid,
45             profile=profile,
46         )
47         security_group_ids.extend(_security_group_ids)
48         cache_security_group_names = None
49     config = __salt__["boto_elasticache.get_config"](name, region, key, keyid, profile)
50     if config is None:
51         msg = "Failed to retrieve cache cluster info from AWS."
52         ret["comment"] = msg
53         ret["result"] = None
54         return ret
55     elif not config:
56             msg = "Cache cluster {} is set to be created.".format(name)
57             ret["comment"] = msg
58             ret<font color="#b041ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["result"] = None
59             return ret
60         created = __salt__["boto_elasticache.create"](
61             name=name,
62             num_cache_nodes=num_cache_nodes,
63             cache_node_type=cache_node_type,
64             engine=engine,
65             replication_group_id=</b></font>replication_group_id,
66             engine_version=engine_version,
67             cache_parameter_group_name=cache_parameter_group_name,
68             cache_subnet_group_name=cache_subnet_group_name,
69             cache_security_group_names=cache_security_group_names,
70             security_group_ids=security_group_ids,
71             preferred_availability_zone=preferred_availability_zone,
72             preferred_maintenance_window=preferred_maintenance_window,
73             port=port,
74             notification_topic_arn=notification_topic_arn,
75             auto_minor_version_upgrade=auto_minor_version_upgrade,
76             wait=wait,
77             region=region,
78             key=key,
79             keyid=keyid,
80             profile=profile,
81         )
82         if created:
83             ret["changes"]["old"] = None
84             config = __salt__["boto_elasticache.get_config"](
85                 name, region, key, keyid, profile
86             )
87             ret["changes"]["new"] = config
88         else:
89             ret["result"] = False
90             ret["comment"] = "Failed to create {} cache cluster.".format(name)
91     else:
92         ret["comment"] = "Cache cluster {} is present."<font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.format(name)
93     return ret
94 def subnet_group_present(
95     name,
96     subnet_ids=None,
97     subnet_names=None,
98     description=None,
99     tags=None,
100     region=None,
101     key=None,
102     keyid=</b></font>None,
103     profile=None,
104 ):
105     exists = __salt__["boto_elasticache.subnet_group_exists"](
106         name=name, tags<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=tags, region=region, key=key, keyid=keyid, profile=profile
107     )
108     if not exists:
109         if __opts__["test"]:
110             ret["comment"] = "Subnet group {} is set to be created.".format(name)
111             ret["result"] = None
112             return ret
113         created = __salt__["boto_elasticache.create_subnet_group"](
114             name=name,
115             subnet_ids=subnet_ids,
116             subnet_names=subnet_names,
117             tags=tags,
118             region=</b></font>region,
119             key<font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=key,
120             keyid=keyid,
121             profile=profile,
122         )
123         if not created:
124             ret["result"] = False
125             ret["comment"] = "Failed to create {} subnet group.".format(name)
126             return ret
127         ret["changes"]["old"] = None
128         ret["changes"][</b></font>"new"] = name
129         ret["comment"] = "Subnet group {} created.".format(name)
130         return ret
131     ret["comment"] = "Subnet group present."
132     return ret
133 def cache_cluster_absent(*args, **kwargs):
134 def absent(name, wait<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=True, region=None, key=None, keyid=None, profile=None):
135     ret = {"name": name, "result": True, "comment": "", "changes": {}}
136     is_present = __salt__["boto_elasticache.exists"](name, region, key, keyid, profile)
137     if is_present:
138         if __opts__["test"]:
139             ret["comment"] = "Cache cluster {} is set to be removed.".format(name)
140             ret["result"] = None
141             return ret
142         deleted = __salt__["boto_elasticache.delete"](
143             name, wait, region, key, keyid, profile
144         )
145         if deleted:
146             ret["changes"]["old"] = name
147             ret[</b></font>"changes"]["new"] = None
148         else:
149             ret["result"] = False
150             ret["comment"] = "Failed to delete {} cache cluster.".format(name)
151     else:
152         ret["comment"] = "{} does not exist in {}.".format(name, region)
153     return ret
154 def replication_group_present(*args, **kwargs):
155     return creategroup(*args, **kwargs)
156 def creategroup(
157     name,
158     primary_cluster_id,
159     replication_group_description,
160     wait=None,
161     region=None,
162     key=None,
163     keyid=None,
164     profile=None,
165 ):
166     ret = {"name": name, "result": None, "comment": "", "changes": {}}
167     is_present <font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= __salt__["boto_elasticache.group_exists"](
168         name, region, key, keyid, profile
169     )
170     if not is_present:
171             ret["comment"] = "Replication {} is set to be created.".format(name)
172             ret["result"] =</b></font> None
173         created <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= __salt__["boto_elasticache.create_replication_group"](
174             name,
175             primary_cluster_id,
176             replication_group_description,
177             wait,
178             region,
179             key,
180             keyid,
181             profile,
182         )
183         if created:
184             config = __salt__["boto_elasticache.describe_replication_group"](
185                 name, region, key, keyid, profile
186             )
187             ret["changes"]["old"] = None
188             ret["changes"]["new"] = config
189             ret["result"] = True
190         else:
191             ret[</b></font>"result"] = False
192             ret["comment"] = "Failed to create {} replication group.".format(name)
193     else:
194         ret["comment"] = "{} replication group exists .".format(name)
195         ret["result"] = True
196     return ret
197 def subnet_group_absent(
198     name, tags=None, region<font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=None, key=None, keyid=None, profile=None
199 ):
200     ret = {"name": name, "result": True, "comment": "", "changes": {}}
201     exists = __salt__["boto_elasticache.subnet_group_exists"](
202         name=name, tags=tags, region=region, key=key, keyid=keyid, profile=</b></font>profile
203     if not exists:
204         ret["result"] = True
205         ret<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["comment"] = "{} ElastiCache subnet group does not exist.".format(name)
206         return ret
207     if __opts__["test"]:
208         ret["comment"] = "ElastiCache subnet group {} is set to be removed.".format(
209             name
210         )
211         ret["result"] = None
212         return ret
213     deleted = __salt__["boto_elasticache.delete_subnet_group"](
214         name, region, key, keyid, profile
215     )
216     if not deleted:
217         ret["result"] = False
218         ret["comment"] = "Failed to delete {} ElastiCache subnet group.".format(name)
219         return ret
220     ret[</b></font>"changes"]["old"] = name
221     ret["changes"]["new"] = None
222     ret["comment"] = "ElastiCache subnet group {} deleted.".format(name)
223     return ret
224 def replication_group_absent(
225     name, tags=None, region<font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=None, key=None, keyid=None, profile=None
226 ):
227     ret = {"name": name, "result": True, "comment": "", "changes": {}}
228     exists = __salt__["boto_elasticache.group_exists"](
229         name=name, region=region, key=key, keyid=keyid, profile=profile
230     )
231     if not exists:
232         ret[</b></font>"comment"] = "{} ElastiCache replication group does not exist.".format(name)
233         log.info(ret["comment"])
234         <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>return ret
235     if __opts__["test"]:
236         ret[
237             "comment"
238         ] = "ElastiCache replication group {} is set to be removed.".format(name)
239         ret["result"] = True
240         return ret
241     deleted = __salt__["boto_elasticache.delete_replication_group"](
242         name, region, key, keyid, profile
243     )
244     if not deleted:
245         ret["result"] = False
246         log.error(ret[</b></font>"comment"])
247         ret["comment"] = "Failed to delete {} ElastiCache replication group.".format(
248             name
249         )
250         return ret
251     ret["changes"]["old"] = name
252     ret["changes"]["new"] = None
253     ret["comment"] = "ElastiCache replication group {} deleted.".format(name)
254     log.info(ret["comment"])
255     return ret
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>boto_iam.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import os
3 import xml.etree.ElementTree as ET
4 import salt.utils.data
5 import salt.utils.dictupdate as dictupdate
6 import salt.utils.files
7 import salt.utils.json
8 import salt.utils.odict as odict
9 import salt.utils.stringutils
10 log = logging.getLogger(__name__)
11 __virtualname__ = "boto_iam"
12 def __virtual__():
13     if "boto_iam.get_user" in __salt__:
14         return True
15     else:
16         return (
17             False,
18             "Cannot load {} state: boto_iam module unavailable".format(__virtualname__),
19         )
20 def user_absent(
21     name,
22     delete_keys=True,
23     delete_mfa_devices=True,
24     delete_profile=True,
25     region=None,
26     key=None,
27     keyid=None,
28     profile=None,
29 ):
30     ret = {"name": name, "result": True, "comment": "", "changes": {}}
31     if not __salt__["boto_iam.get_user"](name, region, key, keyid, profile):
32         ret["result"] = True
33         ret["comment"] = "IAM User {} does not exist.".format(name)
34         return ret
35     if delete_keys:
36         keys = __salt__["boto_iam.get_all_access_keys"](
37             user_name=name, region=region, key=key, keyid=keyid, profile=profile
38         )
39         log.debug("Keys for user %s are %s.", name, keys)
40         if isinstance(keys, dict):
41             keys = keys["list_access_keys_response"]["list_access_keys_result"][
42                 "access_key_metadata"
43             ]
44             for k in keys:
45                 if __opts__["test"]:
46                     ret["comment"] = " ".join(
47                         [
48                             ret["comment"],
49                             "Key {} is set to be deleted.".format(k["access_key_id"]),
50                         ]
51                     )
52                     ret["result"] = None
53                 else:
54                     if _delete_key(
55                         ret, k["access_key_id"], name, region, key, keyid, profile
56                     ):
57                         ret["comment"] = " ".join(
58                             [
59                                 ret["comment"],
60                                 "Key {} has been deleted.".format(k["access_key_id"]),
61                             ]
62                         )
63                         ret["changes"][k["access_key_id"]] = "deleted"
64     if delete_mfa_devices:
65         devices = __salt__["boto_iam.get_all_mfa_devices"](
66             user_name=name, region=region, key=key, keyid=keyid, profile=profile
67         )
68         if devices:
69             for d in devices:
70                 serial = d["serial_number"]
71                 if __opts__["test"]:
72                     ret["comment"] = " ".join(
73                         [
74                             ret["comment"],
75                             "IAM user {} MFA device {} is set to be deactivated.".format(
76                                 name, serial
77                             ),
78                         ]
79                     )
80                     ret["result"] = None
81                 else:
82                     mfa_deactivated = __salt__["boto_iam.deactivate_mfa_device"](
83                         user_name=name,
84                         serial=serial,
85                         region=region,
86                         key=key,
87                         keyid=keyid,
88                         profile=profile,
89                     )
90                     if mfa_deactivated:
91                         ret["comment"] = " ".join(
92                             [
93                                 ret["comment"],
94                                 "IAM user {} MFA device {} is deactivated.".format(
95                                     name, serial
96                                 ),
97                             ]
98                         )
99                 if __opts__["test"]:
100                     ret["comment"] = " ".join(
101                         [
102                             ret["comment"],
103                             "Virtual MFA device {} is set to be deleted.".format(
104                                 serial
105                             ),
106                         ]
107                     )
108                     ret["result"] = None
109                 else:
110                     mfa_deleted = __salt__["boto_iam.delete_virtual_mfa_device"](
111                         serial=serial,
112                         region=region,
113                         key=key,
114                         keyid=keyid,
115                         profile=profile,
116                     )
117                     if mfa_deleted:
118                         ret["comment"] = " ".join(
119                             [
120                                 ret["comment"],
121                                 "Virtual MFA device {} is deleted.".format(serial),
122                             ]
123                         )
124     if delete_profile:
125         if __opts__["test"]:
126             ret["comment"] = " ".join(
127                 [
128                     ret["comment"],
129                     "IAM user {} login profile is set to be deleted.".format(name),
130                 ]
131             )
132             ret["result"] = None
133         else:
134             profile_deleted = __salt__["boto_iam.delete_login_profile"](
135                 name, region, key, keyid, profile
136             )
137             if profile_deleted:
138                 ret["comment"] = " ".join(
139                     [
140                         ret["comment"],
141                         "IAM user {} login profile is deleted.".format(name),
142                     ]
143                 )
144     if __opts__["test"]:
145         ret["comment"] = " ".join(
146             [
147                 ret["comment"],
148                 "IAM user {} managed policies are set to be detached.".format(name),
149             ]
150         )
151         ret["result"] = None
152     else:
153         _ret = _user_policies_detached(name, region, key, keyid, profile)
154         ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
155         if not _ret["result"]:
156             ret["result"] = _ret["result"]
157             if ret["result"] is False:
158                 return ret
159     if __opts__["test"]:
160         ret["comment"] = " ".join(
161             [
162                 ret["comment"],
163                 "IAM user {} inline policies are set to be deleted.".format(name),
164             ]
165         )
166         ret["result"] = None
167     else:
168         _ret = _user_policies_deleted(name, region, key, keyid, profile)
169         ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
170         if not _ret["result"]:
171             ret["result"] = _ret["result"]
172             if ret["result"] is False:
173                 return ret
174     if __opts__["test"]:
175         ret["comment"] = " ".join(
176             [ret["comment"], "IAM user {} is set to be deleted.".format(name)]
177         )
178         ret["result"] = None
179         return ret
180     deleted = __salt__["boto_iam.delete_user"](name, region, key, keyid, profile)
181     if deleted is True:
182         ret["comment"] = " ".join(
183             [ret["comment"], "IAM user {} is deleted.".format(name)]
184         )
185         ret["result"] = True
186         ret["changes"]["deleted"] = name
187         return ret
188     ret["comment"] = "IAM user {} could not be deleted.\n {}".format(name, deleted)
189     ret["result"] = False
190     return ret
191 def keys_present(
192     name,
193     number,
194     save_dir,
195     region=None,
196     key=None,
197     keyid=None,
198     profile=None,
199     save_format="{2}\n{0}\n{3}\n{1}\n",
200 ):
201     ret = {"name": name, "result": True, "comment": "", "changes": {}}
202     if not __salt__["boto_iam.get_user"](name, region, key, keyid, profile):
203         ret["result"] = False
204         ret["comment"] = "IAM User {} does not exist.".format(name)
205         return ret
206     if not isinstance(number, int):
207         ret["comment"] = "The number of keys must be an integer."
208         ret["result"] = False
209     if not os.path.isdir(save_dir):
210         ret["comment"] = "The directory {} does not exist.".format(save_dir)
211         ret<font color="#b041ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["result"] = False
212         return ret
213     keys = __salt__["boto_iam.get_all_access_keys"](
214         user_name=name, region=region, key=key, keyid=keyid, profile=</b></font>profile
215     )
216     if isinstance(keys, str):
217         log.debug("keys are : false %s", keys)
218         error, message = _get_error(keys)
219         ret["comment"] = "Could not get keys.\n{}\n{}".format(error, message)
220         ret["result"] = False
221         return ret
222     keys = keys["list_access_keys_response"]["list_access_keys_result"][
223         "access_key_metadata"
224     ]
225     log.debug("Keys are : %s.", keys)
226     if len(keys) &gt;= number:
227         ret["comment"] = "The number of keys exist for user {}".format(name)
228         ret["result"] = True
229         return ret
230     if __opts__["test"]:
231         ret["comment"] = "Access key is set to be created for {}.".format(name)
232         ret["result"] = None
233         return ret
234     new_keys = {}
235     for i in range(number - len(keys)):
236         created = __salt__["boto_iam.create_access_key"](
237             name, region, key, keyid, profile
238         )
239         if isinstance(created, str):
240             error, message = _get_error(created)
241             ret["comment"] = "Could not create keys.\n{}\n{}".format(error, message)
242             ret["result"] = False
243             return ret
244         log.debug("Created is : %s", created)
245         response = "create_access_key_response"
246         result = "create_access_key_result"
247         new_keys[str(i)] = {}
248         new_keys[str(i)]["key_id"] = created[response][result]["access_key"][
249             "access_key_id"
250         ]
251         new_keys[str(i)]["secret_key"] = created[response][result]["access_key"][
252             "secret_access_key"
253         ]
254     try:
255         with salt.utils.files.fopen("{}/{}".format(save_dir, name), "a") as _wrf:
256             for key_num, key in new_keys.items():
257                 key_id = key["key_id"]
258                 secret_key = key["secret_key"]
259                 _wrf.write(
260                     salt.utils.stringutils.to_str(
261                         save_format.format(
262                             key_id,
263                             secret_key,
264                             "key_id-{}".format(key_num),
265                             "key-{}".format(key_num),
266                         )
267                     )
268                 )
269         ret["comment"] = "Keys have been written to file {}/{}.".format(save_dir, name)
270         ret["result"] = True
271         ret["changes"] = new_keys
272         return ret
273     except OSError:
274         ret["comment"] = "Could not write to file {}/{}.".format(save_dir, name)
275         ret["result"] = False
276         return ret
277 def keys_absent(
278     access_keys, user_name, region=None, key=None, keyid=None, profile=None
279 ):
280     ret = {"name": access_keys, "result": True, "comment": "", "changes": {}}
281     if not __salt__["boto_iam.get_user"](user_name, region, key, keyid, profile):
282         ret["result"] = False
283         ret["comment"] = "IAM User {} does not exist.".format(user_name)
284         return ret
285     for k in access_keys:
286         ret = _delete_key(ret, k, user_name, region, key, keyid, profile)
287     return ret
288 def _delete_key(
289     ret, access_key_id, user_name, region=None, key=None, keyid=None, profile=None
290 ):
291     keys = __salt__["boto_iam.get_all_access_keys"](
292         user_name=user_name, region=region, key=key, keyid=keyid, profile=profile
293     )
294     log.debug("Keys for user %s are : %s.", keys, user_name)
295     if isinstance(keys, str):
296         log.debug("Keys %s are a string. Something went wrong.", keys)
297         ret["comment"] = " ".join(
298             [ret["comment"], "Key {} could not be deleted.".format(access_key_id)]
299         )
300         return ret
301     keys = keys["list_access_keys_response"]["list_access_keys_result"][
302         "access_key_metadata"
303     ]
304     for k in keys:
305         log.debug(
306             "Key is: %s and is compared with: %s", k["access_key_id"], access_key_id
307         )
308         if str(k["access_key_id"]) == str(access_key_id):
309             if __opts__["test"]:
310                 ret["comment"] = "Access key {} is set to be deleted.".format(
311                     access_key_id
312                 )
313                 ret["result"] = None
314                 return ret
315             deleted = __salt__["boto_iam.delete_access_key"](
316                 access_key_id, user_name, region, key, keyid, profile
317             )
318             if deleted:
319                 ret["comment"] = " ".join(
320                     [ret["comment"], "Key {} has been deleted.".format(access_key_id)]
321                 )
322                 ret["changes"][access_key_id] = "deleted"
323                 return ret
324             ret["comment"] = " ".join(
325                 [ret["comment"], "Key {} could not be deleted.".format(access_key_id)]
326             )
327             return ret
328         ret["comment"] = " ".join([ret["comment"], "Key {} does not exist.".format(k)])
329         return ret
330 def user_present(
331     name,
332     policies=None,
333     policies_from_pillars=None,
334     managed_policies=None,
335     password=None,
336     path=None,
337     region=None,
338     key=None,
339     keyid=None,
340     profile=None,
341 ):
342     ret = {"name": name, "result": True, "comment": "", "changes": {}}
343     if not policies:
344         policies = {}
345     if not policies_from_pillars:
346         policies_from_pillars = []
347     if not managed_policies:
348         managed_policies = []
349     _policies = {}
350     for policy in policies_from_pillars:
351         _policies.update(_policy)
352     _policies.update(policies)
353     exists <font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= __salt__["boto_iam.get_user"](name, region, key, keyid, profile)
354     if not exists:
355         if __opts__["test"]:
356             ret["comment"] = "IAM user {} is set to be created.".format(name)
357             ret["result"] =</b></font> None
358             return ret
359         created = __salt__["boto_iam.create_user"](
360             name, path, region, key, keyid, profile
361         )
362         if created:
363             ret["changes"]["user"] = created
364             ret["comment"] = " ".join(
365                 [ret["comment"], "User {} has been created.".format(name)]
366             )
367             if password:
368                 ret = _case_password(ret, name, password, region, key, keyid, profile)
369             _ret = _user_policies_present(name, _policies, region, key, keyid, profile)
370             ret["changes"] = dictupdate.update(ret["changes"], _ret["changes"])
371             ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
372     else:
373         ret["comment"] = " ".join([ret["comment"], "User {} is present.".format(name)])
374         if password:
375             ret = _case_password(ret, name, password, region, key, keyid, profile)
376         _ret = _user_policies_present(name, _policies, region, key, keyid, profile)
377         ret["changes"] = dictupdate.update(ret["changes"], _ret["changes"])
378         ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
379     _ret = _user_policies_attached(name, managed_policies, region, key, keyid, profile)
380     ret["changes"] = dictupdate.update(ret["changes"], _ret["changes"])
381     ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
382     if not _ret["result"]:
383         ret["result"] = _ret["result"]
384         return ret
385     return ret
386 def _user_policies_present(
387     name, policies=None, region=None, key=None, keyid=None, profile=None
388 ):
389     ret = {"result": True, "comment": "", "changes": {}}
390     policies_to_create = {}
391     policies_to_delete = []
392     for policy_name, policy in policies.items():
393         if isinstance(policy, str):
394             dict_policy = salt.utils.json.loads(
395                 policy, object_pairs_hook=odict.OrderedDict
396             )
397         else:
398             dict_policy = policy
399         _policy = __salt__["boto_iam.get_user_policy"](
400             name, policy_name, region, key, keyid, profile
401         )
402         if _policy != dict_policy:
403             log.debug("Policy mismatch:\n%s\n%s", _policy, dict_policy)
404             policies_to_create[policy_name] = policy
405     _list = __salt__["boto_iam.get_all_user_policies"](
406         user_name=name, region=region, key=key, keyid=keyid, profile=profile
407     )
408     for policy_name in _list:
409         if policy_name not in policies:
410             policies_to_delete.append(policy_name)
411     if policies_to_create or policies_to_delete:
412         _to_modify = list(policies_to_delete)
413         _to_modify.extend(policies_to_create)
414         if __opts__["test"]:
415             ret["comment"] = "{} policies to be modified on user {}.".format(
416                 ", ".join(_to_modify), name
417             )
418             ret["result"] = None
419             return ret
420         ret["changes"]["old"] = {"policies": _list}
421         for policy_name, policy in policies_to_create.items():
422             policy_set = __salt__["boto_iam.put_user_policy"](
423                 name, policy_name, policy, region, key, keyid, profile
424             )
425             if not policy_set:
426                 _list = __salt__["boto_iam.get_all_user_policies"](
427                     user_name=name, region=region, key=key, keyid=keyid, profile=profile
428                 )
429                 ret["changes"]["new"] = {"policies": _list}
430                 ret["result"] = False
431                 ret["comment"] = "Failed to add policy {} for user {}".format(
432                     policy_name, name
433                 )
434                 return ret
435         for policy_name in policies_to_delete:
436             policy_unset = __salt__["boto_iam.delete_user_policy"](
437                 name, policy_name, region, key, keyid, profile
438             )
439             if not policy_unset:
440                 _list = __salt__["boto_iam.get_all_user_policies"](
441                     user_name=name, region=region, key=key, keyid=keyid, profile=profile
442                 )
443                 ret["changes"]["new"] = {"policies": _list}
444                 ret["result"] = False
445                 ret["comment"] = "Failed to add policy {} to user {}".format(
446                     policy_name, name
447                 )
448                 return ret
449         _list = __salt__["boto_iam.get_all_user_policies"](
450             user_name=name, region=region, key=key, keyid=keyid, profile=profile
451         )
452         ret["changes"]["new"] = {"policies": _list}
453         ret["comment"] = "{} policies modified on user {}.".format(
454             ", ".join(_list), name
455         )
456     return ret
457 def _user_policies_attached(
458     name, managed_policies=None, region=None, key=None, keyid=None, profile=None
459 ):
460     ret = {"result": True, "comment": "", "changes": {}}
461     policies_to_attach = []
462     policies_to_detach = []
463     for policy in managed_policies or []:
464         entities = __salt__["boto_iam.list_entities_for_policy"](
465             policy,
466             entity_filter="User",
467             region=region,
468             key=key,
469             keyid=keyid,
470             profile=profile,
471         )
472         found = False
473         for userdict in entities.get("policy_users", []):
474             if name == userdict.get("user_name"):
475                 found = True
476                 break
477         if not found:
478             policies_to_attach.append(policy)
479     _list = __salt__["boto_iam.list_attached_user_policies"](
480         name, region=region, key=key, keyid=keyid, profile=profile
481     )
482     oldpolicies = [x.get("policy_arn") for x in _list]
483     for policy_data in _list:
484         if (
485             policy_data.get("policy_name") not in managed_policies
486             and policy_data.get("policy_arn") not in managed_policies
487         ):
488             policies_to_detach.append(policy_data.get("policy_arn"))
489     if policies_to_attach or policies_to_detach:
490         _to_modify = list(policies_to_detach)
491         _to_modify.extend(policies_to_attach)
492         if __opts__["test"]:
493             ret["comment"] = "{} policies to be modified on user {}.".format(
494                 ", ".join(_to_modify), name
495             )
496             ret["result"] = None
497             return ret
498         ret["changes"]["old"] = {"managed_policies": oldpolicies}
499         for policy_name in policies_to_attach:
500             policy_set = __salt__["boto_iam.attach_user_policy"](
501                 policy_name, name, region=region, key=key, keyid=keyid, profile=profile
502             )
503             if not policy_set:
504                 _list = __salt__["boto_iam.list_attached_user_policies"](
505                     name, region=region, key=key, keyid=keyid, profile=profile
506                 )
507                 newpolicies = [x.get("policy_arn") for x in _list]
508                 ret["changes"]["new"] = {"managed_policies": newpolicies}
509                 ret["result"] = False
510                 ret["comment"] = "Failed to add policy {} to user {}".format(
511                     policy_name, name
512                 )
513                 return ret
514         for policy_name in policies_to_detach:
515             policy_unset = __salt__["boto_iam.detach_user_policy"](
516                 policy_name, name, region=region, key=key, keyid=keyid, profile=profile
517             )
518             if not policy_unset:
519                 _list = __salt__["boto_iam.list_attached_user_policies"](
520                     name, region=region, key=key, keyid=keyid, profile=profile
521                 )
522                 newpolicies = [x.get("policy_arn") for x in _list]
523                 ret["changes"]["new"] = {"managed_policies": newpolicies}
524                 ret["result"] = False
525                 ret["comment"] = "Failed to remove policy {} from user {}".format(
526                     policy_name, name
527                 )
528                 return ret
529         _list = __salt__["boto_iam.list_attached_user_policies"](
530             name, region=region, key=key, keyid=keyid, profile=profile
531         )
532         newpolicies = [x.get("policy_arn") for x in _list]
533         log.debug(newpolicies)
534         ret["changes"]["new"] = {"managed_policies": newpolicies}
535         ret["comment"] = "{} policies modified on user {}.".format(
536             ", ".join(newpolicies), name
537         )
538 def _user_policies_detached(name, region<font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=None, key=None, keyid=None, profile=None):
539     ret = {"result": True, "comment": "", "changes": {}}
540     _list = __salt__["boto_iam.list_attached_user_policies"](
541         user_name=name, region=region, key=key, keyid=keyid, profile=profile
542     )
543     oldpolicies =</b></font> [x.get("policy_arn") for x in _list]
544     if not _list:
545         ret["comment"] = "No attached policies in user {}.".format(name)
546         return ret
547     if __opts__["test"]:
548         ret["comment"] = "{} policies to be detached from user {}.".format(
549             ", ".join(oldpolicies), name
550         )
551         ret["result"] = None
552         return ret
553     ret["changes"]["old"] = {"managed_policies": oldpolicies}
554     for policy_arn in oldpolicies:
555         policy_unset = __salt__["boto_iam.detach_user_policy"](
556             policy_arn, name, region=region, key=key, keyid=keyid, profile=profile
557         )
558         if not policy_unset:
559             _list = __salt__["boto_iam.list_attached_user_policies"](
560                 name, region=region, key=key, keyid=keyid, profile=profile
561             )
562             newpolicies = [x.get("policy_arn") for x in _list]
563             ret["changes"]["new"] = {"managed_policies": newpolicies}
564             ret["result"] = False
565             ret["comment"] = "Failed to detach {} from user {}".format(policy_arn, name)
566             return ret
567     _list = __salt__["boto_iam.list_attached_user_policies"](
568         name, region=region, key=key, keyid=keyid, profile=profile
569     )
570     newpolicies = [x.get("policy_arn") for x in _list]
571     ret["changes"]["new"] = {"managed_policies": newpolicies}
572     ret["comment"] = "{} policies detached from user {}.".format(
573         ", ".join(oldpolicies), name
574     )
575 def _user_policies_deleted(name, region<font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=None, key=None, keyid=None, profile=None):
576     ret = {"result": True, "comment": "", "changes": {}}
577     oldpolicies = __salt__["boto_iam.get_all_user_policies"](
578         user_name=name, region=region, key=key, keyid=keyid, profile=profile
579     )
580     if not oldpolicies:
581         ret["comment"] = "No inline policies in user {}.".</b></font>format(name)
582         return ret
583     if __opts__["test"]:
584         ret["comment"] = "{} policies to be deleted from user {}.".format(
585             ", ".join(oldpolicies), name
586         )
587         ret["result"] = None
588         return ret
589     ret["changes"]["old"] = {"inline_policies": oldpolicies}
590     for policy_name in oldpolicies:
591         policy_deleted = __salt__["boto_iam.delete_user_policy"](
592             name, policy_name, region=region, key=key, keyid=keyid, profile=profile
593         )
594         if not policy_deleted:
595             newpolicies = __salt__["boto_iam.get_all_user_policies"](
596                 name, region=region, key=key, keyid=keyid, profile=profile
597             )
598             ret["changes"]["new"] = {"inline_policies": newpolicies}
599             ret["result"] = False
600             ret["comment"] = "Failed to detach {} from user {}".format(
601                 policy_name, name
602             )
603             return ret
604     newpolicies = __salt__["boto_iam.get_all_user_policies"](
605         name, region=region, key=key, keyid=keyid, profile=profile
606     )
607     ret["changes"]["new"] = {"inline_policies": newpolicies}
608     ret["comment"] = "{} policies deleted from user {}.".format(
609         ", ".join(oldpolicies), name
610     )
611     return ret
612 def _case_password(
613     ret, name, password, region=None, key=None, keyid=None, profile=None
614 ):
615     if __opts__["test"]:
616         ret["comment"] = "Login policy for {} is set to be changed.".format(name)
617         ret["result"] = None
618         return ret
619     login = __salt__["boto_iam.create_login_profile"](
620         name, password, region, key, keyid, profile
621     )
622     log.debug("Login is : %s.", login)
623     if login:
624         if "Conflict" in login:
625             ret["comment"] = " ".join(
626                 [ret["comment"], "Login profile for user {} exists.".format(name)]
627             )
628         else:
629             ret["comment"] = " ".join(
630                 [ret["comment"], "Password has been added to User {}.".format(name)]
631             )
632             ret["changes"]["password"] = "REDACTED"
633     else:
634         ret["result"] = False
635         ret["comment"] = " ".join(
636             [
637                 ret["comment"],
638                 "Password for user {} could not be set.\nPlease check your password"
639                 " policy.".format(name),
640             ]
641         )
642     return ret
643 def group_absent(name, region=None, key=None, keyid=None, profile=None):
644     ret = {"name": name, "result": True, "comment": "", "changes": {}}
645     if not __salt__["boto_iam.get_group"](name, region, key, keyid, profile):
646         ret["result"] = True
647         ret["comment"] = "IAM Group {} does not exist.".format(name)
648         return ret
649     if __opts__["test"]:
650         ret["comment"] = " ".join(
651             [
652                 ret["comment"],
653                 "IAM group {} managed policies are set to be detached.".format(name),
654             ]
655         )
656         ret["result"] = None
657     else:
658         _ret = _group_policies_detached(name, region, key, keyid, profile)
659         ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
660         if not _ret["result"]:
661             ret["result"] = _ret["result"]
662             if ret["result"] is False:
663                 return ret
664     if __opts__["test"]:
665         ret["comment"] = " ".join(
666             [
667                 ret["comment"],
668                 "IAM group {} inline policies are set to be deleted.".format(name),
669             ]
670         )
671         ret["result"] = None
672     else:
673         _ret = _group_policies_deleted(name, region, key, keyid, profile)
674         ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
675         if not _ret["result"]:
676             ret["result"] = _ret["result"]
677             if ret["result"] is False:
678                 return ret
679     ret["comment"] = " ".join(
680         [ret["comment"], "IAM group {} users are set to be removed.".format(name)]
681     )
682     existing_users = __salt__["boto_iam.get_group_members"](
683         group_name=name, region=region, key=key, keyid=keyid, profile=profile
684     )
685     _ret = _case_group(ret, [], name, existing_users, region, key, keyid, profile)
686     ret["changes"] = dictupdate.update(ret["changes"], _ret["changes"])
687     ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
688     if not _ret["result"]:
689         ret["result"] = _ret["result"]
690         return ret
691     if __opts__["test"]:
692         ret["comment"] = " ".join(
693             [ret["comment"], "IAM group {} is set to be deleted.".format(name)]
694         )
695         ret["result"] = None
696         return ret
697     deleted = __salt__["boto_iam.delete_group"](name, region, key, keyid, profile)
698     if deleted is True:
699         ret["comment"] = " ".join(
700             [ret["comment"], "IAM group {} is deleted.".format(name)]
701         )
702         ret["result"] = True
703         ret["changes"]["deleted"] = name
704         return ret
705     ret["comment"] = "IAM group {} could not be deleted.\n {}".format(name, deleted)
706     ret["result"] = False
707     return ret
708 def group_present(
709     name,
710     policies=None,
711     policies_from_pillars=None,
712     managed_policies=None,
713     users=None,
714     path="/",
715     region=None,
716     key=None,
717     keyid=None,
718     profile=None,
719     delete_policies=True,
720 ):
721     ret = {"name": name, "result": True, "comment": "", "changes": {}}
722     if not policies:
723         policies = {}
724     if not policies_from_pillars:
725         policies_from_pillars = []
726     if not managed_policies:
727         managed_policies = []
728     _policies = {}
729     for policy in policies_from_pillars:
730         _policy = __salt__["pillar.get"](policy)
731     _policies.update(policies)
732     exists = __salt__["boto_iam.get_group"](
733         group_name<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=name, region=region, key=key, keyid=keyid, profile=profile
734     )
735     if not exists:
736         if __opts__["test"]:
737             ret["comment"] = "IAM group {} is set to be created.".format(name)
738             ret["result"] = None
739             return ret
740         created = __salt__["boto_iam.create_group"](
741             group_name=name,
742             path=path,
743             region=region,
744             key=key,
745             keyid=keyid,
746             profile=</b></font>profile,
747         )
748         if not created:
749             ret["comment"] = "Failed to create IAM group {}.".format(name)
750             ret["result"] = False
751             return ret
752         ret["changes"]["group"] = created
753         ret["comment"] = " ".join(
754             [ret["comment"], "Group {} has been created.".format(name)]
755         )
756     else:
757         ret["comment"] = " ".join([ret["comment"], "Group {} is present.".format(name)])
758     _ret = _group_policies_present(
759         name, _policies, region, key, keyid, profile, delete_policies
760     )
761     ret["changes"] = dictupdate.update(ret["changes"], _ret["changes"])
762     ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
763     if not _ret["result"]:
764         ret["result"] = _ret["result"]
765         return ret
766     _ret = _group_policies_attached(
767         name, managed_policies, region, key, keyid, profile, delete_policies
768     )
769     ret["changes"] = dictupdate.update(ret["changes"], _ret["changes"])
770     ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
771     if not _ret["result"]:
772         ret["result"] = _ret["result"]
773         return ret
774     if users is not None:
775         log.debug("Users are : %s.", users)
776         existing_users = __salt__["boto_iam.get_group_members"](
777             group_name=name, region=region, key=key, keyid=keyid, profile=profile
778         )
779         ret = _case_group(ret, users, name, existing_users, region, key, keyid, profile)
780     return ret
781 def _case_group(ret, users, group_name, existing_users, region, key, keyid, profile):
782     _users = []
783     for user in existing_users:
784         _users.append(user["user_name"])
785     log.debug("upstream users are %s", _users)
786     for user in users:
787         log.debug("users are %s", user)
788         if user in _users:
789             log.debug("user exists")
790             ret["comment"] = " ".join(
791                 [
792                     ret["comment"],
793                     "User {} is already a member of group {}.".format(user, group_name),
794                 ]
795             )
796             continue
797         else:
798             log.debug("user is set to be added %s", user)
799             if __opts__["test"]:
800                 ret["comment"] = "User {} is set to be added to group {}.".format(
801                     user, group_name
802                 )
803                 ret["result"] = None
804             else:
805                 __salt__["boto_iam.add_user_to_group"](
806                     user, group_name, region, key, keyid, profile
807                 )
808                 ret["comment"] = " ".join(
809                     [
810                         ret["comment"],
811                         "User {} has been added to group {}.".format(user, group_name),
812                     ]
813                 )
814                 ret["changes"][user] = group_name
815     for user in _users:
816         if user not in users:
817             if __opts__["test"]:
818                 ret["comment"] = " ".join(
819                     [
820                         ret["comment"],
821                         "User {} is set to be removed from group {}.".format(
822                             user, group_name
823                         ),
824                     ]
825                 )
826                 ret["result"] = None
827             else:
828                 __salt__["boto_iam.remove_user_from_group"](
829                     group_name=group_name,
830                     user_name=user,
831                     region=region,
832                     key=key,
833                     keyid=keyid,
834                     profile=profile,
835                 )
836                 ret["comment"] = " ".join(
837                     [
838                         ret["comment"],
839                         "User {} has been removed from group {}.".format(
840                             user, group_name
841                         ),
842                     ]
843                 )
844                 ret["changes"][user] = "Removed from group {}.".format(group_name)
845     return ret
846 def _group_policies_present(
847     name,
848     policies=None,
849     region=None,
850     key=None,
851     keyid=None,
852     profile=None,
853     delete_policies=True,
854 ):
855     ret = {"result": True, "comment": "", "changes": {}}
856     policies_to_create = {}
857     policies_to_delete = []
858     for policy_name, policy in policies.items():
859         if isinstance(policy, str):
860             dict_policy = salt.utils.json.loads(
861                 policy, object_pairs_hook=odict.OrderedDict
862             )
863         else:
864             dict_policy = policy
865         _policy = __salt__["boto_iam.get_group_policy"](
866             name, policy_name, region, key, keyid, profile
867         )
868         if _policy != dict_policy:
869             log.debug("Policy mismatch:\n%s\n%s", _policy, dict_policy)
870             policies_to_create[policy_name] = policy
871     _list = __salt__["boto_iam.get_all_group_policies"](
872         name, region, key, keyid, profile
873     )
874     for policy_name in _list:
875         if delete_policies and policy_name not in policies:
876             policies_to_delete.append(policy_name)
877     if policies_to_create or policies_to_delete:
878         _to_modify = list(policies_to_delete)
879         _to_modify.extend(policies_to_create)
880         if __opts__["test"]:
881             ret["comment"] = "{} policies to be modified on group {}.".format(
882                 ", ".join(_to_modify), name
883             )
884             ret["result"] = None
885         ret["changes"]["old"] = {"policies": _list}
886         for policy_name, policy in policies_to_create.items():
887             policy_set <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= __salt__["boto_iam.put_group_policy"](
888                 name, policy_name, policy, region, key, keyid, profile
889             )
890             if not policy_set:
891                 _list = __salt__["boto_iam.get_all_group_policies"](
892                     name, region, key, keyid, profile
893                 )
894                 ret["changes"]["new"] = {"policies": _list}
895                 ret["result"] = False
896                 ret["comment"] = "Failed to add policy {} to group {}".</b></font>format(
897                     policy_name, name
898                 )
899                 return ret
900         for policy_name in policies_to_delete:
901             policy_unset = __salt__["boto_iam.delete_group_policy"](
902                 name, policy_name, region, key, keyid, profile
903             )
904             if not policy_unset:
905                 _list = __salt__["boto_iam.get_all_group_policies"](
906                     name, region, key, keyid, profile
907                 )
908                 ret["changes"]["new"] = {"policies": _list}
909                 ret["result"] = False
910                 ret["comment"] = "Failed to add policy {} to group {}".format(
911                     policy_name, name
912                 )
913                 return ret
914         _list = __salt__["boto_iam.get_all_group_policies"](
915             name, region, key, keyid, profile
916         ret["changes"]["new"] = {"policies": _list}
917         ret["comment"] = "{} policies modified on group {}.".format(
918             ", "<font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.join(_list), name
919         )
920     return ret
921 def _group_policies_attached(
922     name,
923     managed_policies=None,
924     region=None,
925     key=None,
926     keyid=None,
927     profile=None,
928     detach_policies=True,
929 ):
930     ret =</b></font> {"result": True, "comment": "", "changes": {}}
931     policies_to_attach = []
932     policies_to_detach = []
933     for policy in managed_policies or []:
934         entities = __salt__["boto_iam.list_entities_for_policy"](
935             policy,
936             entity_filter="Group",
937             region=region,
938             key=key,
939             keyid=keyid,
940             profile=profile,
941         )
942         found = False
943         for groupdict in entities.get("policy_groups", []):
944             if name == groupdict.get("group_name"):
945                 found = True
946                 break
947         if not found:
948             policies_to_attach.append(policy)
949     _list = __salt__["boto_iam.list_attached_group_policies"](
950         name, region=region, key=key, keyid=keyid, profile=profile
951     )
952     oldpolicies = [x.get("policy_arn") for x in _list]
953     for policy_data in _list:
954         if (
955             detach_policies
956             and policy_data.get("policy_name") not in managed_policies
957             and policy_data.get("policy_arn") not in managed_policies
958         ):
959             policies_to_detach.append(policy_data.get("policy_arn"))
960     if policies_to_attach or policies_to_detach:
961         _to_modify = list(policies_to_detach)
962         _to_modify.extend(policies_to_attach)
963         if __opts__["test"]:
964             ret["comment"] = "{} policies to be modified on group {}.".format(
965                 ", ".join(_to_modify), name
966             )
967             ret["result"] = None
968             return ret
969         ret["changes"]["old"] = {"managed_policies": oldpolicies}
970         for policy_name in policies_to_attach:
971             policy_set = __salt__["boto_iam.attach_group_policy"](
972                 policy_name, name, region=region, key=key, keyid=keyid, profile=profile
973             )
974             if not policy_set:
975                 _list = __salt__["boto_iam.list_attached_group_policies"](
976                     name, region=region, key=key, keyid=keyid, profile=profile
977                 )
978                 newpolicies = [x.get("policy_arn") for x in _list]
979                 ret["changes"]["new"] = {"managed_policies": newpolicies}
980                 ret["result"] = False
981                 ret["comment"] = "Failed to add policy {} to group {}".format(
982                     policy_name, name
983                 )
984                 return ret
985         for policy_name in policies_to_detach:
986             policy_unset = __salt__["boto_iam.detach_group_policy"](
987                 policy_name, name, region=region, key=key, keyid=keyid, profile=profile
988             )
989             if not policy_unset:
990                 _list = __salt__["boto_iam.list_attached_group_policies"](
991                     name, region=region, key=key, keyid=keyid, profile=profile
992                 )
993                 newpolicies = [x.get("policy_arn") for x in _list]
994                 ret["changes"]["new"] = {"managed_policies": newpolicies}
995                 ret["result"] = False
996                 ret["comment"] = "Failed to remove policy {} from group {}".format(
997                     policy_name, name
998                 )
999                 return ret
1000         _list = __salt__["boto_iam.list_attached_group_policies"](
1001             name, region=region, key=key, keyid=keyid, profile=profile
1002         )
1003         newpolicies = [x.get("policy_arn") for x in _list]
1004         log.debug(newpolicies)
1005         ret["changes"]["new"] = {"managed_policies": newpolicies}
1006         ret["comment"] = "{} policies modified on group {}.".format(
1007             ", ".join(newpolicies), name
1008         )
1009     return ret
1010 def _group_policies_detached(name, region=None, key=None, keyid=None, profile=None):
1011     ret = {"result": True, "comment": "", "changes": {}}
1012     _list = __salt__["boto_iam.list_attached_group_policies"](
1013         group_name=name, region=region, key=key, keyid=keyid, profile=profile
1014     )
1015     oldpolicies = [x.get("policy_arn") for x in _list]
1016     if not _list:
1017         ret["comment"] = "No attached policies in group {}.".format(name)
1018         return ret
1019     if __opts__["test"]:
1020         ret["comment"] = "{} policies to be detached from group {}.".format(
1021             ", ".join(oldpolicies), name
1022         )
1023         ret["result"] = None
1024         return ret
1025     ret["changes"]["old"] = {"managed_policies": oldpolicies}
1026     for policy_arn in oldpolicies:
1027         policy_unset = __salt__["boto_iam.detach_group_policy"](
1028             policy_arn, name, region=region, key=key, keyid=keyid, profile=profile
1029         )
1030         if not policy_unset:
1031             _list = __salt__["boto_iam.list_attached_group_policies"](
1032                 name, region=region, key=key, keyid=keyid, profile=profile
1033             )
1034             newpolicies = [x.get("policy_arn") for x in _list]
1035             ret["changes"]["new"] = {"managed_policies": newpolicies}
1036             ret["result"] = False
1037             ret["comment"] = "Failed to detach {} from group {}".format(
1038                 policy_arn, name
1039             )
1040             return ret
1041     _list = __salt__["boto_iam.list_attached_group_policies"](
1042         name, region=region, key=key, keyid=keyid, profile=profile
1043     )
1044     newpolicies = [x.get("policy_arn") for x in _list]
1045     ret["changes"]["new"] = {"managed_policies": newpolicies}
1046     ret["comment"] = "{} policies detached from group {}.".format(
1047         ", ".join(newpolicies), name
1048     )
1049     return ret
1050 def _group_policies_deleted(name, region=None, key=None, keyid=None, profile=None):
1051     ret = {"result": True, "comment": "", "changes": {}}
1052     oldpolicies = __salt__["boto_iam.get_all_group_policies"](
1053         group_name=name, region=region, key=key, keyid=keyid, profile=profile
1054     )
1055     if not oldpolicies:
1056         ret["comment"] = "No inline policies in group {}.".format(name)
1057         return ret
1058     if __opts__["test"]:
1059         ret["comment"] = "{} policies to be deleted from group {}.".format(
1060             ", ".join(oldpolicies), name
1061         )
1062         ret["result"] = None
1063         return ret
1064     ret["changes"]["old"] = {"inline_policies": oldpolicies}
1065     for policy_name in oldpolicies:
1066         policy_deleted = __salt__["boto_iam.delete_group_policy"](
1067             name, policy_name, region=region, key=key, keyid=keyid, profile=profile
1068         )
1069         if not policy_deleted:
1070             newpolicies = __salt__["boto_iam.get_all_group_policies"](
1071                 name, region=region, key=key, keyid=keyid, profile=profile
1072             )
1073             ret["changes"]["new"] = {"inline_policies": newpolicies}
1074             ret["result"] = False
1075             ret["comment"] = "Failed to detach {} from group {}".format(
1076                 policy_name, name
1077             )
1078             return ret
1079     newpolicies = __salt__["boto_iam.get_all_group_policies"](
1080         name, region=region, key=key, keyid=keyid, profile=profile
1081     )
1082     ret["changes"]["new"] = {"inline_policies": newpolicies}
1083         ", ".join(oldpolicies), name
1084     )
1085     r<font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>eturn ret
1086 def account_policy(
1087     name=None,
1088     allow_users_to_change_password=None,
1089     hard_expiry=None,
1090     max_password_age=None,
1091     minimum_password_length=None,
1092     password_reuse_prevention=None,
1093     require_lowercase_characters=None,
1094     require_numbers=None,
1095     require_symbols=None,
1096     require_uppercase_characters=None,
1097     region=None,
1098     key=None,
1099     keyid=None,
1100     profile=None,
1101 ):
1102     config =</b></font> locals()
1103     ret = {"name": "Account Policy", "result": True, "comment": "", "changes": {}}
1104     info = __salt__["boto_iam.get_account_policy"](region, key, keyid, profile)
1105     if not info:
1106         ret["comment"] = "Account policy is not Enabled."
1107         ret["result"] = False
1108         return ret
1109     for key, value in config.items():
1110         if key in ("region", "key", "keyid", "profile", "name"):
1111             continue
1112         if value is not None and str(info[key]) != str(value).lower():
1113             ret["comment"] = " ".join(
1114                 [
1115                     ret["comment"],
1116                     "Policy value {} has been set to {}.".format(value, info[key]),
1117                 ]
1118             )
1119             ret["changes"][key] = str(value).lower()
1120     if not ret["changes"]:
1121         ret["comment"] = "Account policy is not changed."
1122         return ret
1123     if __opts__["test"]:
1124         ret["comment"] = "Account policy is set to be changed."
1125         ret["result"] = None
1126         return ret
1127     if __salt__["boto_iam.update_account_password_policy"](
1128         allow_users_to_change_password,
1129         hard_expiry,
1130         max_password_age,
1131         minimum_password_length,
1132         password_reuse_prevention,
1133         require_lowercase_characters,
1134         require_numbers,
1135         require_symbols,
1136         require_uppercase_characters,
1137         region,
1138         key,
1139         keyid,
1140         profile,
1141     ):
1142         return ret
1143     ret["comment"] = "Account policy is not changed."
1144     ret["changes"] = {}
1145     ret["result"] = False
1146     return ret
1147 def server_cert_absent(name, region=None, key=None, keyid=None, profile=None):
1148     ret = {"name": name, "result": True, "comment": "", "changes": {}}
1149     exists = __salt__["boto_iam.get_server_certificate"](
1150     )
1151     if not exists:
1152         ret<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["comment"] = "Certificate {} does not exist.".format(name)
1153         return ret
1154     if __opts__["test"]:
1155         ret["comment"] = "Server certificate {} is set to be deleted.".format(name)
1156         ret["result"] = None
1157         return ret
1158     deleted = __salt__["boto_iam.delete_server_cert"](name, region, key, keyid, profile)
1159     if not deleted:
1160         ret["result"] = False
1161         ret["comment"] = "Certificate {} failed to be deleted.".format(name)
1162         return ret
1163     ret[</b></font>"comment"] = "Certificate {} was deleted.".format(name)
1164     ret["changes"] = deleted
1165     return ret
1166 def server_cert_present(
1167     name,
1168     public_key,
1169     private_key,
1170     cert_chain=None,
1171     path=None,
1172     region=None,
1173     key=None,
1174     keyid=None,
1175     profile=None,
1176 ):
1177     ret = {"name": name, "result": True, "comment": "", "changes": {}}
1178     exists = __salt__["boto_iam.get_server_certificate"](
1179         name, region, key, keyid, profile
1180     )
1181     log.debug("Variables are : %s.", locals())
1182     if exists:
1183         ret["comment"] = "Certificate {} exists.".format(name)
1184         return ret
1185     if "salt://" in public_key:
1186         try:
1187             public_key = __salt__["cp.get_file_str"](public_key)
1188         except OSError as e:
1189             log.debug(e)
1190             ret["comment"] = "File {} not found.".format(public_key)
1191             ret["result"] = False
1192             return ret
1193     if "salt://" in private_key:
1194         try:
1195             private_key = __salt__["cp.get_file_str"](private_key)
1196         except OSError as e:
1197             log.debug(e)
1198             ret["comment"] = "File {} not found.".format(private_key)
1199             ret["result"] = False
1200             return ret
1201     if cert_chain is not None and "salt://" in cert_chain:
1202         try:
1203             cert_chain = __salt__["cp.get_file_str"](cert_chain)
1204         except OSError as e:
1205             ret["comment"] = "File {} not found.".format(cert_chain)
1206             ret["result"] = False
1207             <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>return ret
1208     if __opts__["test"]:
1209         ret["comment"] = "Server certificate {} is set to be created.".format(name)
1210         ret["result"] = None
1211         return ret
1212     created = __salt__["boto_iam.upload_server_cert"](
1213         name, public_key, private_key, cert_chain, path, region, key, keyid, profile
1214     )
1215     if created is not False:
1216         ret["comment"] = "Certificate {} was created.".format(name)
1217         ret[</b></font>"changes"] = created
1218         return ret
1219     ret["result"] = False
1220     ret["comment"] = "Certificate {} failed to be created.".format(name)
1221     return ret
1222 def policy_present(
1223     policy_document,
1224     path=None,
1225     description<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=None,
1226     region=None,
1227     key=None,
1228     keyid=None,
1229     profile=None,
1230 ):
1231     ret = {"name": name, "result": True, "comment": "", "changes": {}}
1232     policy = __salt__["boto_iam.get_policy"](name, region, key, keyid, profile)
1233     if not policy:
1234         if __opts__["test"]:
1235             ret["comment"] = "IAM policy {} is set to be created.".format(name)
1236             ret["result"] = None
1237             return ret
1238         created = __salt__["boto_iam.create_policy"](
1239             name, policy_document, path, description, region, key, keyid, profile
1240         )
1241         if created:
1242             ret["changes"]["policy"] = created
1243             ret[</b></font>"comment"] = " ".join(
1244                 [ret["comment"], "Policy {} has been created.".format(name)]
1245             )
1246         else:
1247             ret["result"] = False
1248             ret["comment"] = "Failed to update policy."
1249             ret["changes"] = {}
1250             return ret
1251     else:
1252         policy = policy.get("policy", {})
1253         ret["comment"] = " ".join(
1254             [ret["comment"], "Policy {} is present.".format(name)]
1255         )
1256         _describe = __salt__["boto_iam.get_policy_version"](
1257             name, policy.get("default_version_id"), region, key, keyid, profile
1258         ).get("policy_version", {})
1259         if isinstance(_describe["document"], str):
1260             describeDict = salt.utils.json.loads(_describe["document"])
1261         else:
1262             describeDict = _describe["document"]
1263         if isinstance(policy_document, str):
1264             policy_document = salt.utils.json.loads(policy_document)
1265         r = salt.utils.data.compare_dicts(describeDict, policy_document)
1266         if bool(r):
1267             if __opts__["test"]:
1268                 ret["comment"] = "Policy {} set to be modified.".format(name)
1269                 ret["result"] = None
1270                 return ret
1271             ret["comment"] = " ".join([ret["comment"], "Policy to be modified"])
1272             policy_document = salt.utils.json.dumps(policy_document)
1273             r = __salt__["boto_iam.create_policy_version"](
1274                 policy_name=name,
1275                 policy_document=policy_document,
1276                 set_as_default=True,
1277                 region=region,
1278                 key=key,
1279                 keyid=keyid,
1280                 profile=profile,
1281             )
1282             if not r.get("created"):
1283                 ret["result"] = False
1284                 ret["comment"] = "Failed to update policy: {}.".format(
1285                     r["error"]["message"]
1286                 )
1287                 ret["changes"] = {}
1288                 return ret
1289             __salt__["boto_iam.delete_policy_version"](
1290                 policy_name=name,
1291                 version_id=policy["default_version_id"],
1292                 region=region,
1293                 key=key,
1294                 keyid=keyid,
1295                 profile=profile,
1296             )
1297             ret["changes"].setdefault("new", {})["document"] = policy_document
1298             ret["changes"].setdefault("old", {})["document"] = _describe["document"]
1299     return ret
1300 def policy_absent(name, region=None, key=None, keyid=None, profile=None):
1301     ret = {"name": name, "result": True, "comment": "", "changes": {}}
1302     r = __salt__["boto_iam.policy_exists"](
1303         name, region=region, key=key, keyid=keyid, profile=profile
1304     )
1305     if not r:
1306         ret["comment"] = "Policy {} does not exist.".format(name)
1307         return ret
1308     if __opts__["test"]:
1309         ret["comment"] = "Policy {} is set to be removed.".format(name)
1310         ret["result"] = None
1311         return ret
1312     versions = __salt__["boto_iam.list_policy_versions"](
1313         name, region=region, key=key, keyid=keyid, profile=profile
1314     )
1315     if versions:
1316         for version in versions:
1317             if version.get("is_default_version", False) in ("true", True):
1318                 continue
1319             r = __salt__["boto_iam.delete_policy_version"](
1320                 name,
1321                 version_id=version.get("version_id"),
1322                 region=region,
1323                 key=key,
1324                 keyid=keyid,
1325                 profile=profile,
1326             )
1327             if not r:
1328                 ret["result"] = False
1329                 return ret
1330     r = __salt__["boto_iam.delete_policy"](
1331         name, region=region, key<font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=key, keyid=keyid, profile=profile
1332     )
1333     if not r:
1334         ret["result"] = False
1335         ret["comment"] = "Failed to delete policy {}.".format(name)
1336         return ret
1337     ret["changes"]["old"] = {"policy": name}
1338     ret[</b></font>"changes"]["new"] = {"policy": None}
1339     ret["comment"] = "Policy {} deleted.".format(name)
1340     return ret
1341 def saml_provider_present(
1342     name, saml_metadata_document, region=None, key=None, keyid=None, profile=None
1343 ):
1344     ret = {"name": name, "result": True, "comment": "", "changes": {}}
1345     if "salt://" in saml_metadata_document:
1346         try:
1347             saml_metadata_document = __salt__["cp.get_file_str"](saml_metadata_document)
1348             ET.fromstring(saml_metadata_document)
1349         except OSError as e:
1350             log.debug(e)
1351             ret[
1352                 "comment"
1353             ] = "SAML document file {} not found or could not be loaded".format(name)
1354             ret["result"] = False
1355             return ret
1356     for provider in __salt__["boto_iam.list_saml_providers"](
1357         region=region, key=key, keyid=keyid, profile=profile
1358     ):
1359         if provider == name:
1360             ret["comment"] = "SAML provider {} is present.".format(name)
1361             return ret
1362     if __opts__["test"]:
1363         ret["comment"] = "SAML provider {} is set to be create.".format(name)
1364         ret["result"] = None
1365         return ret
1366     created = __salt__["boto_iam.create_saml_provider"](
1367         name,
1368         saml_metadata_document,
1369         region=region,
1370         key=key,
1371         keyid=keyid,
1372         profile=profile,
1373     )
1374     if created:
1375         ret["comment"] = "SAML provider {} was created.".format(name)
1376         ret["changes"]["new"] = name
1377         return ret
1378     ret["result"] = False
1379     ret["comment"] = "SAML provider {} failed to be created.".format(name)
1380     return ret
1381 def saml_provider_absent(name, region=None, key=None, keyid=None, profile=None):
1382     ret = {"name": name, "result": True, "comment": "", "changes": {}}
1383     provider = __salt__["boto_iam.list_saml_providers"](
1384         region=region, key=key, keyid=keyid, profile=profile
1385     )
1386     if len(provider) == 0:
1387         ret["comment"] = "SAML provider {} is absent.".format(name)
1388         return ret
1389     if __opts__["test"]:
1390         ret["comment"] = "SAML provider {} is set to be removed.".format(name)
1391         ret["result"] = None
1392         return ret
1393     deleted = __salt__["boto_iam.delete_saml_provider"](
1394         name, region=region, key=key, keyid=keyid, profile=profile
1395     )
1396     if deleted is not False:
1397         ret["comment"] = "SAML provider {} was deleted.".format(name)
1398         ret["changes"]["old"] = name
1399         return ret
1400     ret["result"] = False
1401     ret["comment"] = "SAML provider {} failed to be deleted.".format(name)
1402     return ret
1403 def _get_error(error):
1404     error = "\n".join(error.split("\n")[1:])
1405     error = ET.fromstring(error)
1406     code = error[0][1].text
1407     message = error[0][2].text
1408     return code, message
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
