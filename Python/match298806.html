<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for status_1.py &amp; test_vmware_2.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for status_1.py &amp; test_vmware_2.py
      </h3>
<h1 align="center">
        0.4%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>status_1.py (0.95129377%)<th>test_vmware_2.py (0.26263264%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(364-367)<td><a href="#" name="0">(2708-2719)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(100-110)<td><a href="#" name="1">(1243-1249)</a><td align="center"><font color="#eb0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>status_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import collections
2 import copy
3 import datetime
4 import fnmatch
5 import itertools
6 import logging
7 import os
8 import re
9 import time
10 import salt.channel
11 import salt.config
12 import salt.minion
13 import salt.utils.event
14 import salt.utils.files
15 import salt.utils.network
16 import salt.utils.path
17 import salt.utils.platform
18 import salt.utils.stringutils
19 from salt.exceptions import CommandExecutionError
20 log = logging.getLogger(__file__)
21 __virtualname__ = "status"
22 __func_alias__ = {"time_": "time"}
23 log = logging.getLogger(__name__)
24 def __virtual__():
25     if salt.utils.platform.is_windows():
26         return False, "Windows platform is not supported by this module"
27     return __virtualname__
28 def _number(text):
29     if text.isdigit():
30         return int(text)
31     try:
32         return float(text)
33     except ValueError:
34         return text
35 def _get_boot_time_aix():
36     res = __salt__["cmd.run_all"]("ps -o etime= -p 1")
37     if res["retcode"] &gt; 0:
38         raise CommandExecutionError("Unable to find boot_time for pid 1.")
39     bt_time = res["stdout"]
40     match = re.match(r"\s*(?:(\d+)-)?(?:(\d\d):)?(\d\d):(\d\d)\s*", bt_time)
41     if not match:
42         raise CommandExecutionError("Unexpected time format.")
43     groups = match.groups(default="00")
44     boot_secs = (
45         _number(groups[0]) * 86400
46         + _number(groups[1]) * 3600
47         + _number(groups[2]) * 60
48         + _number(groups[3])
49     )
50     return boot_secs
51 def _aix_loadavg():
52     uptime = __salt__["cmd.run"]("uptime")
53     load_avg = ldavg[1].split()
54     return {
55         <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"1-min": load_avg[1].strip(","),
56         "5-min": load_avg[2].strip(","),
57         "15-min": load_avg[3],
58     }
59 def _aix_nproc():
60     nprocs = __salt__[</b></font>"cmd.run"](
61         "lsattr -E -l sys0 | grep maxuproc", python_shell=True
62     ).split()
63     return _number(nprocs[1])
64 def procs():
65     ret = {}
66     uind = 0
67     pind = 0
68     cind = 0
69     plines = __salt__["cmd.run"](__grains__["ps"], python_shell=True).splitlines()
70     guide = plines.pop(0).split()
71     if "USER" in guide:
72         uind = guide.index("USER")
73     elif "UID" in guide:
74         uind = guide.index("UID")
75     if "PID" in guide:
76         pind = guide.index("PID")
77     if "COMMAND" in guide:
78         cind = guide.index("COMMAND")
79     elif "CMD" in guide:
80         cind = guide.index("CMD")
81     for line in plines:
82         if not line:
83             continue
84         comps = line.split()
85         ret[comps[pind]] = {"user": comps[uind], "cmd": " ".join(comps[cind:])}
86     return ret
87 def custom():
88     ret = {}
89     conf = __salt__["config.dot_vals"]("status")
90     for key, val in conf.items():
91         func = "{}()".format(key.split(".")[1])
92         vals = eval(func)  # pylint: disable=W0123
93         for item in val:
94             ret[item] = vals[item]
95     return ret
96 def uptime():
97     curr_seconds = time.time()
98     if salt.utils.platform.is_linux():
99         ut_path = "/proc/uptime"
100         if not os.path.exists(ut_path):
101             raise CommandExecutionError(
102                 "File {ut_path} was not found.".format(ut_path=ut_path)
103             )
104         with salt.utils.files.fopen(ut_path) as rfh:
105             seconds = int(float(rfh.read().split()[0]))
106     elif salt.utils.platform.is_sunos():
107         res = __salt__["cmd.run_all"]("kstat -p unix:0:system_misc:boot_time")
108         if res["retcode"] &gt; 0:
109             raise CommandExecutionError("The boot_time kstat was not found.")
110         seconds = int(curr_seconds - int(res["stdout"].split()[-1]))
111     elif salt.utils.platform.is_openbsd() or salt.utils.platform.is_netbsd():
112         bt_data = __salt__["sysctl.get"]("kern.boottime")
113         if not bt_data:
114             raise CommandExecutionError("Cannot find kern.boottime system parameter")
115         seconds = int(curr_seconds - int(bt_data))
116     elif salt.utils.platform.is_freebsd() or salt.utils.platform.is_darwin():
117         bt_data = __salt__["sysctl.get"]("kern.boottime")
118         if not bt_data:
119             raise CommandExecutionError("Cannot find kern.boottime system parameter")
120         data = bt_data.split("{")[-1].split("}")[0].strip().replace(" ", "")
121         uptime = {
122             k: int(
123                 v,
124             )
125             for k, v in [p.strip().split("=") for p in data.split(",")]
126         }
127         seconds = int(curr_seconds - uptime["sec"])
128     elif salt.utils.platform.is_aix():
129         seconds = _get_boot_time_aix()
130     else:
131         return __salt__["cmd.run"]("uptime")
132     boot_time = datetime.datetime.utcfromtimestamp(curr_seconds - seconds)
133     curr_time = datetime.datetime.utcfromtimestamp(curr_seconds)
134     up_time = curr_time - boot_time
135     ut_ret = {
136         "seconds": seconds,
137         "since_iso": boot_time.isoformat(),
138         "since_t": int(curr_seconds - seconds),
139         "days": up_time.days,
140         "time": "{}:{}".format(up_time.seconds // 3600, up_time.seconds % 3600 // 60),
141     }
142     if salt.utils.path.which("who"):
143         who_cmd = (
144             "who" if salt.utils.platform.is_openbsd() else "who -s"
145         )  # OpenBSD does not support -s
146         ut_ret["users"] = len(__salt__["cmd.run"](who_cmd).split(os.linesep))
147     return ut_ret
148 def loadavg():
149     if __grains__["kernel"] == "AIX":
150         return _aix_loadavg()
151     try:
152         load_avg = os.getloadavg()
153     except AttributeError:
154         raise salt.exceptions.CommandExecutionError(
155             "status.loadavag is not available on your platform"
156         )
157     return {"1-min": load_avg[0], "5-min": load_avg[1], "15-min": load_avg[2]}
158 def cpustats():
159     def linux_cpustats():
160         ret = {}
161         try:
162             with salt.utils.files.fopen("/proc/stat", "r") as fp_:
163                 stats = salt.utils.stringutils.to_unicode(fp_.read())
164         except OSError:
165             pass
166         else:
167             for line in stats.splitlines():
168                 if not line:
169                     continue
170                 comps = line.split()
171                 if comps[0] == "cpu":
172                     ret[comps[0]] = {
173                         "idle": _number(comps[4]),
174                         "iowait": _number(comps[5]),
175                         "irq": _number(comps[6]),
176                         "nice": _number(comps[2]),
177                         "softirq": _number(comps[7]),
178                         "steal": _number(comps[8]),
179                         "system": _number(comps[3]),
180                         "user": _number(comps[1]),
181                     }
182                 elif comps[0] == "intr":
183                     ret[comps[0]] = {
184                         "total": _number(comps[1]),
185                         "irqs": [_number(x) for x in comps[2:]],
186                     }
187                 elif comps[0] == "softirq":
188                     ret[comps[0]] = {
189                         "total": _number(comps[1]),
190                         "softirqs": [_number(x) for x in comps[2:]],
191                     }
192                 else:
193                     ret[comps[0]] = _number(comps[1])
194         return ret
195     def freebsd_cpustats():
196         vmstat = __salt__["cmd.run"]("vmstat -P").splitlines()
197         vm0 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= vmstat[0].split()
198         cpu0loc = vm0.index("cpu0")
199         vm1 = vmstat[1].split()
200         usloc = vm1.</b></font>index("us")
201         vm2 = vmstat[2].split()
202         cpuctr = 0
203         ret = {}
204         for cpu in vm0[cpu0loc:]:
205             ret[cpu] = {
206                 "us": _number(vm2[usloc + 3 * cpuctr]),
207                 "sy": _number(vm2[usloc + 1 + 3 * cpuctr]),
208                 "id": _number(vm2[usloc + 2 + 3 * cpuctr]),
209             }
210             cpuctr += 1
211         return ret
212     def sunos_cpustats():
213         mpstat = __salt__["cmd.run"]("mpstat 1 2").splitlines()
214         fields = mpstat[0].split()
215         ret = {}
216         for cpu in mpstat:
217             if cpu.startswith("CPU"):
218                 continue
219             cpu = cpu.split()
220             ret[_number(cpu[0])] = {}
221             for i in range(1, len(fields) - 1):
222                 ret[_number(cpu[0])][fields[i]] = _number(cpu[i])
223         return ret
224     def aix_cpustats():
225         ret = {}
226         ret["mpstat"] = []
227         procn = None
228         fields = []
229         for line in __salt__["cmd.run"]("mpstat -a").splitlines():
230             if not line:
231                 continue
232             procn = len(ret["mpstat"])
233             if line.startswith("System"):
234                 comps = line.split(":")
235                 ret["mpstat"].append({})
236                 ret["mpstat"][procn]["system"] = {}
237                 cpu_comps = comps[1].split()
238                 for comp in cpu_comps:
239                     cpu_vals = comp.split("=")
240                     ret["mpstat"][procn]["system"][cpu_vals[0]] = cpu_vals[1]
241             if line.startswith("cpu"):
242                 fields = line.split()
243                 continue
244             if fields:
245                 cpustat = line.split()
246                 ret[_number(cpustat[0])] = {}
247                 for i in range(1, len(fields) - 1):
248                     ret[_number(cpustat[0])][fields[i]] = _number(cpustat[i])
249         return ret
250     def openbsd_cpustats():
251         systat = __salt__["cmd.run"]("systat -s 2 -B cpu").splitlines()
252         fields = systat[3].split()
253         ret = {}
254         for cpu in systat[4:]:
255             cpu_line = cpu.split()
256             cpu_idx = cpu_line[0]
257             ret[cpu_idx] = {}
258             for idx, field in enumerate(fields[1:]):
259                 ret[cpu_idx][field] = cpu_line[idx + 1]
260         return ret
261     get_version = {
262         "Linux": linux_cpustats,
263         "FreeBSD": freebsd_cpustats,
264         "Junos": freebsd_cpustats,
265         "OpenBSD": openbsd_cpustats,
266         "SunOS": sunos_cpustats,
267         "AIX": aix_cpustats,
268     }
269     errmsg = "This method is unsupported on the current operating system!"
270     return get_version.get(__grains__["kernel"], lambda: errmsg)()
271 def meminfo():
272     def linux_meminfo():
273         ret = {}
274         try:
275             with salt.utils.files.fopen("/proc/meminfo", "r") as fp_:
276                 stats = salt.utils.stringutils.to_unicode(fp_.read())
277         except OSError:
278             pass
279         else:
280             for line in stats.splitlines():
281                 if not line:
282                     continue
283                 comps = line.split()
284                 comps[0] = comps[0].replace(":", "")
285                 ret[comps[0]] = {
286                     "value": comps[1],
287                 }
288                 if len(comps) &gt; 2:
289                     ret[comps[0]]["unit"] = comps[2]
290         return ret
291     def freebsd_meminfo():
292         sysctlvm = __salt__["cmd.run"]("sysctl vm").splitlines()
293         sysctlvm = [x for x in sysctlvm if x.startswith("vm")]
294         sysctlvm = [x.split(":") for x in sysctlvm]
295         sysctlvm = [[y.strip() for y in x] for x in sysctlvm]
296         sysctlvm = [x for x in sysctlvm if x[1]]  # If x[1] not empty
297         ret = {}
298         for line in sysctlvm:
299             ret[line[0]] = line[1]
300         sysctlvmtot = __salt__["cmd.run"]("sysctl -n vm.vmtotal").splitlines()
301         sysctlvmtot = [x for x in sysctlvmtot if x]
302         ret["vm.vmtotal"] = sysctlvmtot
303         return ret
304     def aix_meminfo():
305         ret = {}
306         ret["svmon"] = []
307         ret["vmstat"] = []
308         procn = None
309         fields = []
310         pagesize_flag = False
311         for line in __salt__["cmd.run"]("svmon -G").splitlines():
312             if not line:
313                 continue
314             if re.match(r"\s", line):
315                 fields = line.split()
316                 continue
317             if line.startswith("memory") or line.startswith("pin"):
318                 procn = len(ret["svmon"])
319                 ret["svmon"].append({})
320                 comps = line.split()
321                 ret["svmon"][procn][comps[0]] = {}
322                 for idx, field in enumerate(fields):
323                     if len(comps) &gt; idx + 1:
324                         ret["svmon"][procn][comps[0]][field] = comps[idx + 1]
325                 continue
326             if line.startswith("pg space") or line.startswith("in use"):
327                 procn = len(ret["svmon"])
328                 ret["svmon"].append({})
329                 comps = line.split()
330                 pg_space = "{} {}".format(comps[0], comps[1])
331                 ret["svmon"][procn][pg_space] = {}
332                 for idx, field in enumerate(fields):
333                     if len(comps) &gt; idx + 2:
334                         ret["svmon"][procn][pg_space][field] = comps[idx + 2]
335                 continue
336             if line.startswith("PageSize"):
337                 fields = line.split()
338                 pagesize_flag = False
339                 continue
340             if pagesize_flag:
341                 procn = len(ret["svmon"])
342                 ret["svmon"].append({})
343                 comps = line.split()
344                 ret["svmon"][procn][comps[0]] = {}
345                 for idx, field in enumerate(fields):
346                     if len(comps) &gt; idx:
347                         ret["svmon"][procn][comps[0]][field] = comps[idx]
348                 continue
349         for line in __salt__["cmd.run"]("vmstat -v").splitlines():
350             if not line:
351                 continue
352             procn = len(ret["vmstat"])
353             ret["vmstat"].append({})
354             comps = line.lstrip().split(" ", 1)
355             ret["vmstat"][procn][comps[1]] = comps[0]
356         return ret
357     def openbsd_meminfo():
358         vmstat = __salt__["cmd.run"]("vmstat").splitlines()
359         fields = [
360             "active virtual pages",
361             "free list size",
362             "page faults",
363             "pages reclaimed",
364             "pages paged in",
365             "pages paged out",
366             "pages freed",
367             "pages scanned",
368         ]
369         data = vmstat[2].split()[2:10]
370         ret = dict(zip(fields, data))
371         return ret
372     get_version = {
373         "Linux": linux_meminfo,
374         "FreeBSD": freebsd_meminfo,
375         "Junos": freebsd_meminfo,
376         "OpenBSD": openbsd_meminfo,
377         "AIX": aix_meminfo,
378     }
379     errmsg = "This method is unsupported on the current operating system!"
380     return get_version.get(__grains__["kernel"], lambda: errmsg)()
381 def cpuinfo():
382     def linux_cpuinfo():
383         ret = {}
384         try:
385             with salt.utils.files.fopen("/proc/cpuinfo", "r") as fp_:
386                 stats = salt.utils.stringutils.to_unicode(fp_.read())
387         except OSError:
388             pass
389         else:
390             for line in stats.splitlines():
391                 if not line:
392                     continue
393                 comps = line.split(":")
394                 comps[0] = comps[0].strip()
395                 if comps[0] == "flags":
396                     ret[comps[0]] = comps[1].split()
397                 else:
398                     ret[comps[0]] = comps[1].strip()
399         return ret
400     def bsd_cpuinfo():
401         bsd_cmd = "sysctl hw.model hw.ncpu"
402         ret = {}
403         if __grains__["kernel"].lower() in ["netbsd", "openbsd"]:
404             sep = "="
405         else:
406             sep = ":"
407         for line in __salt__["cmd.run"](bsd_cmd).splitlines():
408             if not line:
409                 continue
410             comps = line.split(sep)
411             comps[0] = comps[0].strip()
412             ret[comps[0]] = comps[1].strip()
413         return ret
414     def sunos_cpuinfo():
415         ret = {}
416         ret["isainfo"] = {}
417         for line in __salt__["cmd.run"]("isainfo -x").splitlines():
418             if not line:
419                 continue
420             comps = line.split(":")
421             comps[0] = comps[0].strip()
422             ret["isainfo"][comps[0]] = sorted(comps[1].strip().split())
423         ret["psrinfo"] = []
424         procn = None
425         for line in __salt__["cmd.run"]("psrinfo -v -p").splitlines():
426             if not line:
427                 continue
428             if line.startswith("The physical processor"):
429                 procn = len(ret["psrinfo"])
430                 line = line.split()
431                 ret["psrinfo"].append({})
432                 if "cores" in line:
433                     ret["psrinfo"][procn]["topology"] = {}
434                     ret["psrinfo"][procn]["topology"]["cores"] = _number(line[4])
435                     ret["psrinfo"][procn]["topology"]["threads"] = _number(line[7])
436                 elif "virtual" in line:
437                     ret["psrinfo"][procn]["topology"] = {}
438                     ret["psrinfo"][procn]["topology"]["threads"] = _number(line[4])
439             elif line.startswith(" " * 6):  # 3x2 space indent
440                 ret["psrinfo"][procn]["name"] = line.strip()
441             elif line.startswith(" " * 4):  # 2x2 space indent
442                 line = line.strip().split()
443                 ret["psrinfo"][procn]["vendor"] = line[1][1:]
444                 ret["psrinfo"][procn]["family"] = _number(line[4])
445                 ret["psrinfo"][procn]["model"] = _number(line[6])
446                 ret["psrinfo"][procn]["step"] = _number(line[8])
447                 ret["psrinfo"][procn]["clock"] = "{} {}".format(line[10], line[11][:-1])
448         return ret
449     def aix_cpuinfo():
450         ret = {}
451         ret["prtconf"] = []
452         ret["lparstat"] = []
453         procn = None
454         for line in __salt__["cmd.run"](
455             'prtconf | grep -i "Processor"', python_shell=True
456         ).splitlines():
457             if not line:
458                 continue
459             procn = len(ret["prtconf"])
460             if line.startswith("Processor") or line.startswith("Number"):
461                 ret["prtconf"].append({})
462                 comps = line.split(":")
463                 comps[0] = comps[0].rstrip()
464                 ret["prtconf"][procn][comps[0]] = comps[1]
465             else:
466                 continue
467         for line in __salt__["cmd.run"](
468             'prtconf | grep "CPU"', python_shell=True
469         ).splitlines():
470             if not line:
471                 continue
472             procn = len(ret["prtconf"])
473             if line.startswith("CPU"):
474                 ret["prtconf"].append({})
475                 comps = line.split(":")
476                 comps[0] = comps[0].rstrip()
477                 ret["prtconf"][procn][comps[0]] = comps[1]
478             else:
479                 continue
480         for line in __salt__["cmd.run"](
481             "lparstat -i | grep CPU", python_shell=True
482         ).splitlines():
483             if not line:
484                 continue
485             procn = len(ret["lparstat"])
486             ret["lparstat"].append({})
487             comps = line.split(":")
488             comps[0] = comps[0].rstrip()
489             ret["lparstat"][procn][comps[0]] = comps[1]
490         return ret
491     get_version = {
492         "Linux": linux_cpuinfo,
493         "FreeBSD": bsd_cpuinfo,
494         "Junos": bsd_cpuinfo,
495         "NetBSD": bsd_cpuinfo,
496         "OpenBSD": bsd_cpuinfo,
497         "SunOS": sunos_cpuinfo,
498         "AIX": aix_cpuinfo,
499     }
500     errmsg = "This method is unsupported on the current operating system!"
501     return get_version.get(__grains__["kernel"], lambda: errmsg)()
502 def diskstats():
503     def linux_diskstats():
504         ret = {}
505         try:
506             with salt.utils.files.fopen("/proc/diskstats", "r") as fp_:
507                 stats = salt.utils.stringutils.to_unicode(fp_.read())
508         except OSError:
509             pass
510         else:
511             for line in stats.splitlines():
512                 if not line:
513                     continue
514                 comps = line.split()
515                 ret[comps[2]] = {
516                     "major": _number(comps[0]),
517                     "minor": _number(comps[1]),
518                     "device": _number(comps[2]),
519                     "reads_issued": _number(comps[3]),
520                     "reads_merged": _number(comps[4]),
521                     "sectors_read": _number(comps[5]),
522                     "ms_spent_reading": _number(comps[6]),
523                     "writes_completed": _number(comps[7]),
524                     "writes_merged": _number(comps[8]),
525                     "sectors_written": _number(comps[9]),
526                     "ms_spent_writing": _number(comps[10]),
527                     "io_in_progress": _number(comps[11]),
528                     "ms_spent_in_io": _number(comps[12]),
529                     "weighted_ms_spent_in_io": _number(comps[13]),
530                 }
531         return ret
532     def generic_diskstats():
533         ret = {}
534         iostat = __salt__["cmd.run"]("iostat -xzd").splitlines()
535         header = iostat[1]
536         for line in iostat[2:]:
537             comps = line.split()
538             ret[comps[0]] = {}
539             for metric, value in zip(header.split()[1:], comps[1:]):
540                 ret[comps[0]][metric] = _number(value)
541         return ret
542     def aix_diskstats():
543         ret = {}
544         procn = None
545         fields = []
546         disk_name = ""
547         disk_mode = ""
548         for line in __salt__["cmd.run"]("iostat -dDV").splitlines():
549             if not line or line.startswith("System") or line.startswith("-----------"):
550                 continue
551             if not re.match(r"\s", line):
552                 dsk_comps = line.split(":")
553                 dsk_firsts = dsk_comps[0].split()
554                 disk_name = dsk_firsts[0]
555                 disk_mode = dsk_firsts[1]
556                 fields = dsk_comps[1].split()
557                 ret[disk_name] = []
558                 procn = len(ret[disk_name])
559                 ret[disk_name].append({})
560                 ret[disk_name][procn][disk_mode] = {}
561                 continue
562             if ":" in line:
563                 comps = line.split(":")
564                 fields = comps[1].split()
565                 disk_mode = comps[0].lstrip()
566                 procn = len(ret[disk_name])
567                 ret[disk_name].append({})
568                 ret[disk_name][procn][disk_mode] = {}
569             else:
570                 comps = line.split()
571                 for idx, field in enumerate(fields):
572                     if len(comps) &gt; idx:
573                         ret[disk_name][procn][disk_mode][field] = comps[idx]
574         return ret
575     get_version = {
576         "Linux": linux_diskstats,
577         "FreeBSD": generic_diskstats,
578         "Junos": generic_diskstats,
579         "SunOS": generic_diskstats,
580         "AIX": aix_diskstats,
581     }
582     errmsg = "This method is unsupported on the current operating system!"
583     return get_version.get(__grains__["kernel"], lambda: errmsg)()
584 def diskusage(*args):
585     selected = set()
586     fstypes = set()
587     if not args:
588         fstypes.add("*")
589     else:
590         for arg in args:
591             if arg.startswith("/"):
592                 selected.add(arg)
593             else:
594                 fstypes.add(arg)
595     if fstypes:
596         regex = re.compile(
597             "|".join(fnmatch.translate(fstype).format("(%s)") for fstype in fstypes)
598         )
599         if __grains__["kernel"] == "Linux":
600             try:
601                 with salt.utils.files.fopen("/proc/mounts", "r") as fp_:
602                     ifile = salt.utils.stringutils.to_unicode(fp_.read()).splitlines()
603             except OSError:
604                 return {}
605         elif __grains__["kernel"] in ("FreeBSD", "SunOS"):
606             ifile = __salt__["cmd.run"]("mount -p").splitlines()
607         else:
608             raise CommandExecutionError(
609                 "status.diskusage not yet supported on this platform"
610             )
611         for line in ifile:
612             comps = line.split()
613             if __grains__["kernel"] == "SunOS":
614                 if len(comps) &gt;= 4:
615                     mntpt = comps[2]
616                     fstype = comps[3]
617                     if regex.match(fstype):
618                         selected.add(mntpt)
619             else:
620                 if len(comps) &gt;= 3:
621                     mntpt = comps[1]
622                     fstype = comps[2]
623                     if regex.match(fstype):
624                         selected.add(mntpt)
625     ret = {}
626     for path in selected:
627         fsstats = os.statvfs(path)
628         blksz = fsstats.f_bsize
629         available = fsstats.f_bavail * blksz
630         total = fsstats.f_blocks * blksz
631         ret[path] = {"available": available, "total": total}
632     return ret
633 def vmstats():
634     def linux_vmstats():
635         ret = {}
636         try:
637             with salt.utils.files.fopen("/proc/vmstat", "r") as fp_:
638                 stats = salt.utils.stringutils.to_unicode(fp_.read())
639         except OSError:
640             pass
641         else:
642             for line in stats.splitlines():
643                 if not line:
644                     continue
645                 comps = line.split()
646                 ret[comps[0]] = _number(comps[1])
647         return ret
648     def generic_vmstats():
649         ret = {}
650         for line in __salt__["cmd.run"]("vmstat -s").splitlines():
651             comps = line.split()
652             if comps[0].isdigit():
653                 ret[" ".join(comps[1:])] = _number(comps[0].strip())
654         return ret
655     get_version = {
656         "Linux": linux_vmstats,
657         "FreeBSD": generic_vmstats,
658         "Junos": generic_vmstats,
659         "OpenBSD": generic_vmstats,
660         "SunOS": generic_vmstats,
661         "AIX": generic_vmstats,
662     }
663     errmsg = "This method is unsupported on the current operating system!"
664     return get_version.get(__grains__["kernel"], lambda: errmsg)()
665 def nproc():
666     def linux_nproc():
667         try:
668             return _number(__salt__["cmd.run"]("nproc").strip())
669         except ValueError:
670             return 0
671     def generic_nproc():
672         ncpu_data = __salt__["sysctl.get"]("hw.ncpu")
673         if not ncpu_data:
674             return 1
675         else:
676             return _number(ncpu_data)
677     get_version = {
678         "Linux": linux_nproc,
679         "Darwin": generic_nproc,
680         "FreeBSD": generic_nproc,
681         "Junos": generic_nproc,
682         "OpenBSD": generic_nproc,
683         "AIX": _aix_nproc,
684     }
685     errmsg = "This method is unsupported on the current operating system!"
686     return get_version.get(__grains__["kernel"], lambda: errmsg)()
687 def netstats():
688     def linux_netstats():
689         ret = {}
690         try:
691             with salt.utils.files.fopen("/proc/net/netstat", "r") as fp_:
692                 stats = salt.utils.stringutils.to_unicode(fp_.read())
693         except OSError:
694             pass
695         else:
696             headers = [""]
697             for line in stats.splitlines():
698                 if not line:
699                     continue
700                 comps = line.split()
701                 if comps[0] == headers[0]:
702                     index = len(headers) - 1
703                     row = {}
704                     for field in range(index):
705                         if field &lt; 1:
706                             continue
707                         else:
708                             row[headers[field]] = _number(comps[field])
709                     rowname = headers[0].replace(":", "")
710                     ret[rowname] = row
711                 else:
712                     headers = comps
713         return ret
714     def freebsd_netstats():
715         return bsd_netstats()
716     def bsd_netstats():
717         ret = {}
718         for line in __salt__["cmd.run"]("netstat -s").splitlines():
719             if line.startswith("\t\t"):
720                 continue  # Skip, too detailed
721             if not line.startswith("\t"):
722                 key = line.split()[0].replace(":", "")
723                 ret[key] = {}
724             else:
725                 comps = line.split()
726                 if comps[0].isdigit():
727                     ret[key][" ".join(comps[1:])] = comps[0]
728         return ret
729     def sunos_netstats():
730         ret = {}
731         for line in __salt__["cmd.run"]("netstat -s").splitlines():
732             line = line.replace("=", " = ").split()
733             if len(line) &gt; 6:
734                 line.pop(0)
735             if "=" in line:
736                 if len(line) &gt;= 3:
737                     if line[2].isdigit() or line[2][0] == "-":
738                         line[2] = _number(line[2])
739                     ret[line[0]] = line[2]
740                 if len(line) &gt;= 6:
741                     if line[5].isdigit() or line[5][0] == "-":
742                         line[5] = _number(line[5])
743                     ret[line[3]] = line[5]
744         return ret
745     def aix_netstats():
746         ret = {}
747         fields = []
748         procn = None
749         proto_name = None
750         for line in __salt__["cmd.run"]("netstat -s").splitlines():
751             if not line:
752                 continue
753             if not re.match(r"\s", line) and ":" in line:
754                 comps = line.split(":")
755                 proto_name = comps[0]
756                 ret[proto_name] = []
757                 procn = len(ret[proto_name])
758                 ret[proto_name].append({})
759                 continue
760             else:
761                 comps = line.split()
762                 comps[0] = comps[0].strip()
763                 if comps[0].isdigit():
764                     ret[proto_name][procn][" ".join(comps[1:])] = _number(comps[0])
765                 else:
766                     continue
767         return ret
768     get_version = {
769         "Linux": linux_netstats,
770         "FreeBSD": bsd_netstats,
771         "Junos": bsd_netstats,
772         "OpenBSD": bsd_netstats,
773         "SunOS": sunos_netstats,
774         "AIX": aix_netstats,
775     }
776     errmsg = "This method is unsupported on the current operating system!"
777     return get_version.get(__grains__["kernel"], lambda: errmsg)()
778 def netdev():
779     def linux_netdev():
780         ret = {}
781         try:
782             with salt.utils.files.fopen("/proc/net/dev", "r") as fp_:
783                 stats = salt.utils.stringutils.to_unicode(fp_.read())
784         except OSError:
785             pass
786         else:
787             for line in stats.splitlines():
788                 if not line:
789                     continue
790                 if line.find(":") &lt; 0:
791                     continue
792                 comps = line.split()
793                 comps[0] = line.split(":")[0].strip()
794                 comps.insert(1, line.split(":")[1].strip().split()[0])
795                 ret[comps[0]] = {
796                     "iface": comps[0],
797                     "rx_bytes": _number(comps[2]),
798                     "rx_compressed": _number(comps[8]),
799                     "rx_drop": _number(comps[5]),
800                     "rx_errs": _number(comps[4]),
801                     "rx_fifo": _number(comps[6]),
802                     "rx_frame": _number(comps[7]),
803                     "rx_multicast": _number(comps[9]),
804                     "rx_packets": _number(comps[3]),
805                     "tx_bytes": _number(comps[10]),
806                     "tx_carrier": _number(comps[16]),
807                     "tx_colls": _number(comps[15]),
808                     "tx_compressed": _number(comps[17]),
809                     "tx_drop": _number(comps[13]),
810                     "tx_errs": _number(comps[12]),
811                     "tx_fifo": _number(comps[14]),
812                     "tx_packets": _number(comps[11]),
813                 }
814         return ret
815     def freebsd_netdev():
816         _dict_tree = lambda: collections.defaultdict(_dict_tree)
817         ret = _dict_tree()
818         netstat = __salt__["cmd.run"]("netstat -i -n -4 -b -d").splitlines()
819         netstat += __salt__["cmd.run"]("netstat -i -n -6 -b -d").splitlines()[1:]
820         header = netstat[0].split()
821         for line in netstat[1:]:
822             comps = line.split()
823             for i in range(4, 13):  # The columns we want
824                 ret[comps[0]][comps[2]][comps[3]][header[i]] = _number(comps[i])
825         return ret
826     def sunos_netdev():
827         ret = {}
828         for dev in itertools.chain(
829             __grains__["ip4_interfaces"].keys(), __grains__["ip6_interfaces"].keys()
830         ):
831             netstat_ipv4 = __salt__["cmd.run"](
832                 "netstat -i -I {dev} -n -f inet".format(dev=dev)
833             ).splitlines()
834             netstat_ipv6 = __salt__["cmd.run"](
835                 "netstat -i -I {dev} -n -f inet6".format(dev=dev)
836             ).splitlines()
837             netstat_ipv4[0] = netstat_ipv4[0].split()
838             netstat_ipv4[1] = netstat_ipv4[1].split()
839             netstat_ipv6[0] = netstat_ipv6[0].split()
840             netstat_ipv6[1] = netstat_ipv6[1].split()
841             ret[dev] = {}
842             for val in netstat_ipv4[0][:-1]:
843                 if val == "Name":
844                     continue
845                 if val in ["Address", "Net/Dest"]:
846                     ret[dev]["IPv4 {field}".format(field=val)] = val
847                 else:
848                     ret[dev][val] = _number(val)
849             for val in netstat_ipv6[0][:-1]:
850                 if val == "Name":
851                     continue
852                 if val in ["Address", "Net/Dest"]:
853                     ret[dev]["IPv6 {field}".format(field=val)] = val
854                 else:
855                     ret[dev][val] = _number(val)
856         return ret
857     def aix_netdev():
858         ret = {}
859         fields = []
860         procn = None
861         for dev in itertools.chain(
862             __grains__["ip4_interfaces"].keys(), __grains__["ip6_interfaces"].keys()
863         ):
864             netstat_ipv4 = __salt__["cmd.run"](
865                 "netstat -i -n -I {dev} -f inet".format(dev=dev)
866             ).splitlines()
867             netstat_ipv6 = __salt__["cmd.run"](
868                 "netstat -i -n -I {dev} -f inet6".format(dev=dev)
869             ).splitlines()
870             ret[dev] = []
871             for line in netstat_ipv4:
872                 if line.startswith("Name"):
873                     fields = line.split()
874                     continue
875                 comps = line.split()
876                 if len(comps) &lt; 3:
877                     raise CommandExecutionError(
878                         "Insufficent data returned by command to process '{}'".format(
879                             line
880                         )
881                     )
882                 if comps[2].startswith("link"):
883                     continue
884                 procn = len(ret[dev])
885                 ret[dev].append({})
886                 ret[dev][procn]["ipv4"] = {}
887                 for i in range(1, len(fields)):
888                     if len(comps) &gt; i:
889                         ret[dev][procn]["ipv4"][fields[i]] = comps[i]
890             for line in netstat_ipv6:
891                 if line.startswith("Name"):
892                     fields = line.split()
893                     continue
894                 comps = line.split()
895                 if len(comps) &lt; 3:
896                     raise CommandExecutionError(
897                         "Insufficent data returned by command to process '{}'".format(
898                             line
899                         )
900                     )
901                 if comps[2].startswith("link"):
902                     continue
903                 procn = len(ret[dev])
904                 ret[dev].append({})
905                 ret[dev][procn]["ipv6"] = {}
906                 for i in range(1, len(fields)):
907                     if len(comps) &gt; i:
908                         ret[dev][procn]["ipv6"][fields[i]] = comps[i]
909         return ret
910     get_version = {
911         "Linux": linux_netdev,
912         "FreeBSD": freebsd_netdev,
913         "Junos": freebsd_netdev,
914         "SunOS": sunos_netdev,
915         "AIX": aix_netdev,
916     }
917     errmsg = "This method is unsupported on the current operating system!"
918     return get_version.get(__grains__["kernel"], lambda: errmsg)()
919 def w():  # pylint: disable=C0103
920     def linux_w():
921         user_list = []
922         users = __salt__["cmd.run"]("w -fh").splitlines()
923         for row in users:
924             if not row:
925                 continue
926             comps = row.split()
927             rec = {
928                 "idle": comps[3],
929                 "jcpu": comps[4],
930                 "login": comps[2],
931                 "pcpu": comps[5],
932                 "tty": comps[1],
933                 "user": comps[0],
934                 "what": " ".join(comps[6:]),
935             }
936             user_list.append(rec)
937         return user_list
938     def bsd_w():
939         user_list = []
940         users = __salt__["cmd.run"]("w -h").splitlines()
941         for row in users:
942             if not row:
943                 continue
944             comps = row.split()
945             rec = {
946                 "from": comps[2],
947                 "idle": comps[4],
948                 "login": comps[3],
949                 "tty": comps[1],
950                 "user": comps[0],
951                 "what": " ".join(comps[5:]),
952             }
953             user_list.append(rec)
954         return user_list
955     get_version = {
956         "Darwin": bsd_w,
957         "FreeBSD": bsd_w,
958         "Junos": bsd_w,
959         "Linux": linux_w,
960         "OpenBSD": bsd_w,
961     }
962     errmsg = "This method is unsupported on the current operating system!"
963     return get_version.get(__grains__["kernel"], lambda: errmsg)()
964 def all_status():
965     return {
966         "cpuinfo": cpuinfo(),
967         "cpustats": cpustats(),
968         "diskstats": diskstats(),
969         "diskusage": diskusage(),
970         "loadavg": loadavg(),
971         "meminfo": meminfo(),
972         "netdev": netdev(),
973         "netstats": netstats(),
974         "uptime": uptime(),
975         "vmstats": vmstats(),
976         "w": w(),
977     }
978 def pid(sig):
979     my_pid = str(os.getpid())
980     cmd = __grains__["ps"]
981     output = __salt__["cmd.run_stdout"](cmd, python_shell=True)
982     pids = ""
983     for line in output.splitlines():
984         if my_pid in line:
985             continue
986         if re.search(sig, line):
987             if pids:
988                 pids += "\n"
989             pids += line.split()[1]
990     return pids
991 def version():
992     def linux_version():
993         try:
994             with salt.utils.files.fopen("/proc/version", "r") as fp_:
995                 return salt.utils.stringutils.to_unicode(fp_.read()).strip()
996         except OSError:
997             return {}
998     def bsd_version():
999         return __salt__["cmd.run"]("sysctl -n kern.version")
1000     get_version = {
1001         "Linux": linux_version,
1002         "FreeBSD": bsd_version,
1003         "Junos": bsd_version,
1004         "OpenBSD": bsd_version,
1005         "AIX": lambda: __salt__["cmd.run"]("oslevel -s"),
1006     }
1007     errmsg = "This method is unsupported on the current operating system!"
1008     return get_version.get(__grains__["kernel"], lambda: errmsg)()
1009 def master(master=None, connected=True):
1010     master_ips = None
1011     if master:
1012         master_ips = salt.utils.network.host_to_ips(master)
1013     if not master_ips:
1014         return
1015     master_connection_status = False
1016     port = __salt__["config.get"]("publish_port", default=4505)
1017     connected_ips = salt.utils.network.remote_port_tcp(port)
1018     for master_ip in master_ips:
1019         if master_ip in connected_ips:
1020             master_connection_status = True
1021             break
1022     if master_connection_status is not connected:
1023         with salt.utils.event.get_event("minion", opts=__opts__, listen=False) as event:
1024             if master_connection_status:
1025                 event.fire_event(
1026                     {"master": master}, salt.minion.master_event(type="connected")
1027                 )
1028             else:
1029                 event.fire_event(
1030                     {"master": master}, salt.minion.master_event(type="disconnected")
1031                 )
1032     return master_connection_status
1033 def ping_master(master):
1034     if master is None or master == "":
1035         return False
1036     opts = copy.deepcopy(__opts__)
1037     opts["master"] = master
1038     if "master_ip" in opts:  # avoid 'master ip changed' warning
1039         del opts["master_ip"]
1040     opts.update(salt.minion.prep_ip_port(opts))
1041     try:
1042         opts.update(salt.minion.resolve_dns(opts, fallback=False))
1043     except Exception:  # pylint: disable=broad-except
1044         return False
1045     timeout = opts.get("auth_timeout", 60)
1046     load = {"cmd": "ping"}
1047     result = False
1048     with salt.channel.client.ReqChannel.factory(opts, crypt="clear") as channel:
1049         try:
1050             payload = channel.send(load, tries=0, timeout=timeout)
1051             result = True
1052         except Exception as e:  # pylint: disable=broad-except
1053             pass
1054         if result:
1055             with salt.utils.event.get_event(
1056                 "minion", opts=__opts__, listen=False
1057             ) as event:
1058                 event.fire_event(
1059                     {"master": master}, salt.minion.master_event(type="failback")
1060                 )
1061         return result
1062 def proxy_reconnect(proxy_name, opts=None):
1063     if not opts:
1064         opts = __opts__
1065     if "proxy" not in opts:
1066         return False  # fail
1067     proxy_keepalive_fn = proxy_name + ".alive"
1068     if proxy_keepalive_fn not in __proxy__:
1069         return False  # fail
1070     chk_reboot_active_key = proxy_name + ".get_reboot_active"
1071     if chk_reboot_active_key in __proxy__ and __proxy__[chk_reboot_active_key]():
1072         minion_id = opts.get("proxyid", "") or opts.get("id", "")
1073         log.info(
1074             "%s (%s proxy) is rebooting or shutting down. Don't probe connection.",
1075             minion_id,
1076             proxy_name,
1077         )
1078         return True
1079     is_alive = __proxy__[proxy_keepalive_fn](opts)
1080     if not is_alive:
1081         minion_id = opts.get("proxyid", "") or opts.get("id", "")
1082         log.info("%s (%s proxy) is down. Restarting.", minion_id, proxy_name)
1083         __proxy__[proxy_name + ".shutdown"](opts)  # safely close connection
1084         __proxy__[proxy_name + ".init"](opts)  # reopen connection
1085         log.debug("Restarted %s (%s proxy)!", minion_id, proxy_name)
1086     return True  # success
1087 def time_(format="%A, %d. %B %Y %I:%M%p"):
1088     dt = datetime.datetime.today()
1089     return dt.strftime(format)
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_vmware_2.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import base64
2 import logging
3 import ssl
4 import salt.utils.vmware
5 from salt.exceptions import (
6     ArgumentValueError,
7     CommandExecutionError,
8     VMwareApiError,
9     VMwareConnectionError,
10     VMwareObjectRetrievalError,
11     VMwareRuntimeError,
12     VMwareSystemError,
13 )
14 from tests.support.mixins import LoaderModuleMockMixin
15 from tests.support.mock import MagicMock, PropertyMock, call, patch
16 from tests.support.unit import TestCase, skipIf
17 try:
18     from pyVmomi import vim, vmodl  # pylint: disable=no-name-in-module
19     HAS_PYVMOMI = True
20 except ImportError:
21     HAS_PYVMOMI = False
22 try:
23     import gssapi
24     HAS_GSSAPI = True
25 except ImportError:
26     HAS_GSSAPI = False
27 log = logging.getLogger(__name__)
28 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
29 class GetClusterTestCase(TestCase):
30     def setUp(self):
31         patches = (
32             ("salt.utils.vmware.get_managed_object_name", MagicMock()),
33             ("salt.utils.vmware.get_service_instance_from_managed_object", MagicMock()),
34             (
35                 "salt.utils.vmware.get_mors_with_properties",
36                 MagicMock(
37                     return_value=[{"name": "fake_cluster", "object": MagicMock()}]
38                 ),
39             ),
40         )
41         for mod, mock in patches:
42             patcher = patch(mod, mock)
43             patcher.start()
44             self.addCleanup(patcher.stop)
45         self.mock_si = MagicMock()
46         self.mock_dc = MagicMock()
47         self.mock_cluster1 = MagicMock()
48         self.mock_cluster2 = MagicMock()
49         self.mock_entries = [
50             {"name": "fake_cluster1", "object": self.mock_cluster1},
51             {"name": "fake_cluster2", "object": self.mock_cluster2},
52         ]
53         for attr in (
54             "mock_si",
55             "mock_dc",
56             "mock_cluster1",
57             "mock_cluster2",
58             "mock_entries",
59         ):
60             self.addCleanup(delattr, self, attr)
61     def test_get_managed_object_name_call(self):
62         mock_get_managed_object_name = MagicMock()
63         with patch(
64             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
65         ):
66             salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster")
67         mock_get_managed_object_name.assert_called_once_with(self.mock_dc)
68     def test_get_service_instance_from_managed_object(self):
69         mock_dc_name = MagicMock()
70         mock_get_service_instance_from_managed_object = MagicMock()
71         with patch(
72             "salt.utils.vmware.get_managed_object_name",
73             MagicMock(return_value=mock_dc_name),
74         ):
75             with patch(
76                 "salt.utils.vmware.get_service_instance_from_managed_object",
77                 mock_get_service_instance_from_managed_object,
78             ):
79                 salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster")
80         mock_get_service_instance_from_managed_object.assert_called_once_with(
81             self.mock_dc, name=mock_dc_name
82         )
83     def test_traversal_spec_init(self):
84         mock_dc_name = MagicMock()
85         mock_traversal_spec = MagicMock()
86         mock_traversal_spec_ini = MagicMock(return_value=mock_traversal_spec)
87         mock_get_service_instance_from_managed_object = MagicMock()
88         patch_traversal_spec_str = (
89             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec"
90         )
91         with patch(patch_traversal_spec_str, mock_traversal_spec_ini):
92             salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster")
93         mock_traversal_spec_ini.assert_has_calls(
94             [
95                 call(path="childEntity", skip=False, type=vim.Folder),
96                 call(
97                     path="hostFolder",
98                     skip=True,
99                     type=vim.Datacenter,
100                     selectSet=[mock_traversal_spec],
101                 ),
102             ]
103         )
104     def test_get_mors_with_properties_call(self):
105         mock_get_mors_with_properties = MagicMock(
106             return_value=[{"name": "fake_cluster", "object": MagicMock()}]
107         )
108         mock_traversal_spec = MagicMock()
109         patch_traversal_spec_str = (
110             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec"
111         )
112         with patch(
113             "salt.utils.vmware.get_service_instance_from_managed_object",
114             MagicMock(return_value=self.mock_si),
115         ):
116             with patch(
117                 "salt.utils.vmware.get_mors_with_properties",
118                 mock_get_mors_with_properties,
119             ):
120                 with patch(
121                     patch_traversal_spec_str,
122                     MagicMock(return_value=mock_traversal_spec),
123                 ):
124                     salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster")
125         mock_get_mors_with_properties.assert_called_once_with(
126             self.mock_si,
127             vim.ClusterComputeResource,
128             container_ref=self.mock_dc,
129             property_list=["name"],
130             traversal_spec=mock_traversal_spec,
131         )
132     def test_get_mors_with_properties_returns_empty_array(self):
133         with patch(
134             "salt.utils.vmware.get_managed_object_name",
135             MagicMock(return_value="fake_dc"),
136         ):
137             with patch(
138                 "salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])
139             ):
140                 with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
141                     salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster")
142         self.assertEqual(
143             excinfo.exception.strerror,
144             "Cluster 'fake_cluster' was not found in datacenter 'fake_dc'",
145         )
146     def test_cluster_not_found(self):
147         with patch(
148             "salt.utils.vmware.get_managed_object_name",
149             MagicMock(return_value="fake_dc"),
150         ):
151             with patch(
152                 "salt.utils.vmware.get_mors_with_properties",
153                 MagicMock(return_value=self.mock_entries),
154             ):
155                 with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
156                     salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster")
157         self.assertEqual(
158             excinfo.exception.strerror,
159             "Cluster 'fake_cluster' was not found in datacenter 'fake_dc'",
160         )
161     def test_cluster_found(self):
162         with patch(
163             "salt.utils.vmware.get_managed_object_name",
164             MagicMock(return_value="fake_dc"),
165         ):
166             with patch(
167                 "salt.utils.vmware.get_mors_with_properties",
168                 MagicMock(return_value=self.mock_entries),
169             ):
170                 res = salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster2")
171         self.assertEqual(res, self.mock_cluster2)
172 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
173 class CreateClusterTestCase(TestCase):
174     def setUp(self):
175         patches = (("salt.utils.vmware.get_managed_object_name", MagicMock()),)
176         for mod, mock in patches:
177             patcher = patch(mod, mock)
178             patcher.start()
179             self.addCleanup(patcher.stop)
180         self.mock_create_cluster_ex = MagicMock()
181         self.mock_dc = MagicMock(
182             hostFolder=MagicMock(CreateClusterEx=self.mock_create_cluster_ex)
183         )
184         self.mock_cluster_spec = MagicMock()
185         for attr in ("mock_create_cluster_ex", "mock_dc", "mock_cluster_spec"):
186             self.addCleanup(delattr, self, attr)
187     def test_get_managed_object_name(self):
188         mock_get_managed_object_name = MagicMock()
189         with patch(
190             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
191         ):
192             salt.utils.vmware.create_cluster(
193                 self.mock_dc, "fake_cluster", self.mock_cluster_spec
194             )
195         mock_get_managed_object_name.assert_called_once_with(self.mock_dc)
196     def test_create_cluster_call(self):
197         salt.utils.vmware.create_cluster(
198             self.mock_dc, "fake_cluster", self.mock_cluster_spec
199         )
200         self.mock_create_cluster_ex.assert_called_once_with(
201             "fake_cluster", self.mock_cluster_spec
202         )
203     def test_create_cluster_raise_no_permission(self):
204         exc = vim.fault.NoPermission()
205         exc.privilegeId = "Fake privilege"
206         self.mock_dc.hostFolder.CreateClusterEx = MagicMock(side_effect=exc)
207         with self.assertRaises(VMwareApiError) as excinfo:
208             salt.utils.vmware.create_cluster(
209                 self.mock_dc, "fake_cluster", self.mock_cluster_spec
210             )
211         self.assertEqual(
212             excinfo.exception.strerror,
213             "Not enough permissions. Required privilege: Fake privilege",
214         )
215     def test_create_cluster_raise_vim_fault(self):
216         exc = vim.fault.VimFault()
217         exc.msg = "VimFault msg"
218         self.mock_dc.hostFolder.CreateClusterEx = MagicMock(side_effect=exc)
219         with self.assertRaises(VMwareApiError) as excinfo:
220             salt.utils.vmware.create_cluster(
221                 self.mock_dc, "fake_cluster", self.mock_cluster_spec
222             )
223         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
224     def test_create_cluster_raise_runtime_fault(self):
225         exc = vmodl.RuntimeFault()
226         exc.msg = "RuntimeFault msg"
227         self.mock_dc.hostFolder.CreateClusterEx = MagicMock(side_effect=exc)
228         with self.assertRaises(VMwareRuntimeError) as excinfo:
229             salt.utils.vmware.create_cluster(
230                 self.mock_dc, "fake_cluster", self.mock_cluster_spec
231             )
232         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
233 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
234 class UpdateClusterTestCase(TestCase):
235     def setUp(self):
236         patches = (
237             ("salt.utils.vmware.get_managed_object_name", MagicMock()),
238             ("salt.utils.vmware.wait_for_task", MagicMock()),
239         )
240         for mod, mock in patches:
241             patcher = patch(mod, mock)
242             patcher.start()
243             self.addCleanup(patcher.stop)
244         self.mock_task = MagicMock()
245         self.mock_reconfigure_compute_resource_task = MagicMock(
246             return_value=self.mock_task
247         )
248         self.mock_cluster = MagicMock(
249             ReconfigureComputeResource_Task=self.mock_reconfigure_compute_resource_task
250         )
251         self.mock_cluster_spec = MagicMock()
252         for attr in (
253             "mock_task",
254             "mock_reconfigure_compute_resource_task",
255             "mock_cluster",
256             "mock_cluster_spec",
257         ):
258             self.addCleanup(delattr, self, attr)
259     def test_get_managed_object_name(self):
260         mock_get_managed_object_name = MagicMock()
261         with patch(
262             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
263         ):
264             salt.utils.vmware.update_cluster(self.mock_cluster, self.mock_cluster_spec)
265         mock_get_managed_object_name.assert_called_once_with(self.mock_cluster)
266     def test_reconfigure_compute_resource_task_call(self):
267         salt.utils.vmware.update_cluster(self.mock_cluster, self.mock_cluster_spec)
268         self.mock_reconfigure_compute_resource_task.assert_called_once_with(
269             self.mock_cluster_spec, modify=True
270         )
271     def test_reconfigure_compute_resource_raise_no_permission(self):
272         exc = vim.fault.NoPermission()
273         exc.privilegeId = "Fake privilege"
274         self.mock_cluster.ReconfigureComputeResource_Task = MagicMock(side_effect=exc)
275         with self.assertRaises(VMwareApiError) as excinfo:
276             salt.utils.vmware.update_cluster(self.mock_cluster, self.mock_cluster_spec)
277         self.assertEqual(
278             excinfo.exception.strerror,
279             "Not enough permissions. Required privilege: Fake privilege",
280         )
281     def test_reconfigure_compute_resource_raise_vim_fault(self):
282         exc = vim.fault.VimFault()
283         exc.msg = "VimFault msg"
284         self.mock_cluster.ReconfigureComputeResource_Task = MagicMock(side_effect=exc)
285         with self.assertRaises(VMwareApiError) as excinfo:
286             salt.utils.vmware.update_cluster(self.mock_cluster, self.mock_cluster_spec)
287         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
288     def test_reconfigure_compute_resource_raise_runtime_fault(self):
289         exc = vmodl.RuntimeFault()
290         exc.msg = "RuntimeFault msg"
291         self.mock_cluster.ReconfigureComputeResource_Task = MagicMock(side_effect=exc)
292         with self.assertRaises(VMwareRuntimeError) as excinfo:
293             salt.utils.vmware.update_cluster(self.mock_cluster, self.mock_cluster_spec)
294         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
295     def test_wait_for_task_call(self):
296         mock_wait_for_task = MagicMock()
297         with patch(
298             "salt.utils.vmware.get_managed_object_name",
299             MagicMock(return_value="fake_cluster"),
300         ):
301             with patch("salt.utils.vmware.wait_for_task", mock_wait_for_task):
302                 salt.utils.vmware.update_cluster(
303                     self.mock_cluster, self.mock_cluster_spec
304                 )
305         mock_wait_for_task.assert_called_once_with(
306             self.mock_task, "fake_cluster", "ClusterUpdateTask"
307         )
308 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
309 class WaitForTaskTestCase(TestCase):
310     def setUp(self):
311         patches = (
312             ("salt.utils.vmware.time.time", MagicMock(return_value=1)),
313             ("salt.utils.vmware.time.sleep", MagicMock(return_value=None)),
314         )
315         for mod, mock in patches:
316             patcher = patch(mod, mock)
317             patcher.start()
318             self.addCleanup(patcher.stop)
319     def test_first_task_info_raise_no_permission(self):
320         exc = vim.fault.NoPermission()
321         exc.privilegeId = "Fake privilege"
322         mock_task = MagicMock()
323         type(mock_task).info = PropertyMock(side_effect=exc)
324         with self.assertRaises(VMwareApiError) as excinfo:
325             salt.utils.vmware.wait_for_task(
326                 mock_task, "fake_instance_name", "task_type"
327             )
328         self.assertEqual(
329             excinfo.exception.strerror,
330             "Not enough permissions. Required privilege: Fake privilege",
331         )
332     def test_first_task_info_raise_vim_fault(self):
333         exc = vim.fault.VimFault()
334         exc.msg = "VimFault msg"
335         mock_task = MagicMock()
336         type(mock_task).info = PropertyMock(side_effect=exc)
337         with self.assertRaises(VMwareApiError) as excinfo:
338             salt.utils.vmware.wait_for_task(
339                 mock_task, "fake_instance_name", "task_type"
340             )
341         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
342     def test_first_task_info_raise_runtime_fault(self):
343         exc = vmodl.RuntimeFault()
344         exc.msg = "RuntimeFault msg"
345         mock_task = MagicMock()
346         type(mock_task).info = PropertyMock(side_effect=exc)
347         with self.assertRaises(VMwareRuntimeError) as excinfo:
348             salt.utils.vmware.wait_for_task(
349                 mock_task, "fake_instance_name", "task_type"
350             )
351         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
352     def test_inner_loop_task_info_raise_no_permission(self):
353         exc = vim.fault.NoPermission()
354         exc.privilegeId = "Fake privilege"
355         mock_task = MagicMock()
356         mock_info1 = MagicMock()
357         type(mock_task).info = PropertyMock(side_effect=[mock_info1, exc])
358         type(mock_info1).state = PropertyMock(side_effect=["running", "bad"])
359         with self.assertRaises(VMwareApiError) as excinfo:
360             salt.utils.vmware.wait_for_task(
361                 mock_task, "fake_instance_name", "task_type"
362             )
363         self.assertEqual(
364             excinfo.exception.strerror,
365             "Not enough permissions. Required privilege: Fake privilege",
366         )
367     def test_inner_loop_task_info_raise_vim_fault(self):
368         exc = vim.fault.VimFault()
369         exc.msg = "VimFault msg"
370         mock_task = MagicMock()
371         mock_info1 = MagicMock()
372         type(mock_task).info = PropertyMock(side_effect=[mock_info1, exc])
373         type(mock_info1).state = PropertyMock(side_effect=["running", "bad"])
374         with self.assertRaises(VMwareApiError) as excinfo:
375             salt.utils.vmware.wait_for_task(
376                 mock_task, "fake_instance_name", "task_type"
377             )
378         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
379     def test_inner_loop_task_info_raise_runtime_fault(self):
380         exc = vmodl.RuntimeFault()
381         exc.msg = "RuntimeFault msg"
382         mock_task = MagicMock()
383         mock_info1 = MagicMock()
384         type(mock_task).info = PropertyMock(side_effect=[mock_info1, exc])
385         type(mock_info1).state = PropertyMock(side_effect=["running", "bad"])
386         with self.assertRaises(VMwareRuntimeError) as excinfo:
387             salt.utils.vmware.wait_for_task(
388                 mock_task, "fake_instance_name", "task_type"
389             )
390         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
391     def test_info_state_running(self):
392         mock_task = MagicMock()
393         prop_mock_state = PropertyMock(side_effect=["running", "bad", "bad", "success"])
394         prop_mock_result = PropertyMock()
395         type(mock_task.info).state = prop_mock_state
396         type(mock_task.info).result = prop_mock_result
397         salt.utils.vmware.wait_for_task(mock_task, "fake_instance_name", "task_type")
398         self.assertEqual(prop_mock_state.call_count, 4)
399         self.assertEqual(prop_mock_result.call_count, 1)
400     def test_info_state_running_continues_loop(self):
401         mock_task = MagicMock()
402         prop_mock_state = PropertyMock(
403             side_effect=["running", "fake", "fake", "success"]
404         )
405         prop_mock_result = PropertyMock()
406         type(mock_task.info).state = prop_mock_state
407         type(mock_task.info).result = prop_mock_result
408         salt.utils.vmware.wait_for_task(mock_task, "fake_instance_name", "task_type")
409         self.assertEqual(prop_mock_state.call_count, 4)
410         self.assertEqual(prop_mock_result.call_count, 1)
411     def test_info_state_queued_continues_loop(self):
412         mock_task = MagicMock()
413         prop_mock_state = PropertyMock(
414             side_effect=["fake", "queued", "fake", "fake", "success"]
415         )
416         prop_mock_result = PropertyMock()
417         type(mock_task.info).state = prop_mock_state
418         type(mock_task.info).result = prop_mock_result
419         salt.utils.vmware.wait_for_task(mock_task, "fake_instance_name", "task_type")
420         self.assertEqual(prop_mock_state.call_count, 5)
421         self.assertEqual(prop_mock_result.call_count, 1)
422     def test_info_state_success(self):
423         mock_task = MagicMock()
424         prop_mock_state = PropertyMock(return_value="success")
425         prop_mock_result = PropertyMock()
426         type(mock_task.info).state = prop_mock_state
427         type(mock_task.info).result = prop_mock_result
428         salt.utils.vmware.wait_for_task(mock_task, "fake_instance_name", "task_type")
429         self.assertEqual(prop_mock_state.call_count, 3)
430         self.assertEqual(prop_mock_result.call_count, 1)
431     def test_info_error_exception(self):
432         mock_task = MagicMock()
433         prop_mock_state = PropertyMock(return_value="error")
434         prop_mock_error = PropertyMock(side_effect=Exception("error exc"))
435         type(mock_task.info).state = prop_mock_state
436         type(mock_task.info).error = prop_mock_error
437         with self.assertRaises(Exception) as excinfo:
438             salt.utils.vmware.wait_for_task(
439                 mock_task, "fake_instance_name", "task_type"
440             )
441         self.assertEqual(str(excinfo.exception), "error exc")
442     def test_info_error_no_permission(self):
443         exc = vim.fault.NoPermission()
444         exc.privilegeId = "Fake privilege"
445         mock_task = MagicMock()
446         prop_mock_state = PropertyMock(return_value="error")
447         prop_mock_error = PropertyMock(side_effect=exc)
448         type(mock_task.info).state = prop_mock_state
449         type(mock_task.info).error = prop_mock_error
450         with self.assertRaises(VMwareApiError) as excinfo:
451             salt.utils.vmware.wait_for_task(
452                 mock_task, "fake_instance_name", "task_type"
453             )
454         self.assertEqual(
455             excinfo.exception.strerror,
456             "Not enough permissions. Required privilege: Fake privilege",
457         )
458     def test_info_error_vim_fault(self):
459         exc = vim.fault.VimFault()
460         exc.msg = "VimFault msg"
461         mock_task = MagicMock()
462         prop_mock_state = PropertyMock(return_value="error")
463         prop_mock_error = PropertyMock(side_effect=exc)
464         type(mock_task.info).state = prop_mock_state
465         type(mock_task.info).error = prop_mock_error
466         with self.assertRaises(VMwareApiError) as excinfo:
467             salt.utils.vmware.wait_for_task(
468                 mock_task, "fake_instance_name", "task_type"
469             )
470         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
471     def test_info_error_system_fault(self):
472         exc = vmodl.fault.SystemError()
473         exc.msg = "SystemError msg"
474         mock_task = MagicMock()
475         prop_mock_state = PropertyMock(return_value="error")
476         prop_mock_error = PropertyMock(side_effect=exc)
477         type(mock_task.info).state = prop_mock_state
478         type(mock_task.info).error = prop_mock_error
479         with self.assertRaises(VMwareSystemError) as excinfo:
480             salt.utils.vmware.wait_for_task(
481                 mock_task, "fake_instance_name", "task_type"
482             )
483         self.assertEqual(excinfo.exception.strerror, "SystemError msg")
484     def test_info_error_invalid_argument_no_fault_message(self):
485         exc = vmodl.fault.InvalidArgument()
486         exc.faultMessage = None
487         exc.msg = "InvalidArgumentFault msg"
488         mock_task = MagicMock()
489         prop_mock_state = PropertyMock(return_value="error")
490         prop_mock_error = PropertyMock(side_effect=exc)
491         type(mock_task.info).state = prop_mock_state
492         type(mock_task.info).error = prop_mock_error
493         with self.assertRaises(VMwareApiError) as excinfo:
494             salt.utils.vmware.wait_for_task(
495                 mock_task, "fake_instance_name", "task_type"
496             )
497         self.assertEqual(excinfo.exception.strerror, "InvalidArgumentFault msg")
498     def test_info_error_invalid_argument_with_fault_message(self):
499         exc = vmodl.fault.InvalidArgument()
500         fault_message = vim.LocalizableMessage()
501         fault_message.message = "LocalFault msg"
502         exc.faultMessage = [fault_message]
503         exc.msg = "InvalidArgumentFault msg"
504         mock_task = MagicMock()
505         prop_mock_state = PropertyMock(return_value="error")
506         prop_mock_error = PropertyMock(side_effect=exc)
507         type(mock_task.info).state = prop_mock_state
508         type(mock_task.info).error = prop_mock_error
509         with self.assertRaises(VMwareApiError) as excinfo:
510             salt.utils.vmware.wait_for_task(
511                 mock_task, "fake_instance_name", "task_type"
512             )
513         self.assertEqual(
514             excinfo.exception.strerror, "InvalidArgumentFault msg (LocalFault msg)"
515         )
516 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
517 class GetMorsWithPropertiesTestCase(TestCase):
518     si = None
519     obj_type = None
520     prop_list = None
521     container_ref = None
522     traversal_spec = None
523     def setUp(self):
524         self.si = MagicMock()
525         self.obj_type = MagicMock()
526         self.prop_list = MagicMock()
527         self.container_ref = MagicMock()
528         self.traversal_spec = MagicMock()
529     def test_empty_content(self):
530         get_content = MagicMock(return_value=[])
531         with patch("salt.utils.vmware.get_content", get_content):
532             ret = salt.utils.vmware.get_mors_with_properties(
533                 self.si,
534                 self.obj_type,
535                 self.prop_list,
536                 self.container_ref,
537                 self.traversal_spec,
538             )
539         get_content.assert_called_once_with(
540             self.si,
541             self.obj_type,
542             property_list=self.prop_list,
543             container_ref=self.container_ref,
544             traversal_spec=self.traversal_spec,
545             local_properties=False,
546         )
547         self.assertEqual(ret, [])
548     def test_local_properties_set(self):
549         obj_mock = MagicMock()
550         propSet_prop = PropertyMock(return_value=[])
551         type(obj_mock).propSet = propSet_prop
552         inner_obj_mock = MagicMock()
553         obj_prop = PropertyMock(return_value=inner_obj_mock)
554         type(obj_mock).obj = obj_prop
555         get_content = MagicMock(return_value=[obj_mock])
556         with patch("salt.utils.vmware.get_content", get_content):
557             ret = salt.utils.vmware.get_mors_with_properties(
558                 self.si,
559                 self.obj_type,
560                 self.prop_list,
561                 self.container_ref,
562                 self.traversal_spec,
563                 local_properties=True,
564             )
565         get_content.assert_called_once_with(
566             self.si,
567             self.obj_type,
568             property_list=self.prop_list,
569             container_ref=self.container_ref,
570             traversal_spec=self.traversal_spec,
571             local_properties=True,
572         )
573     def test_one_element_content(self):
574         obj_mock = MagicMock()
575         propSet_prop = PropertyMock(return_value=[])
576         type(obj_mock).propSet = propSet_prop
577         inner_obj_mock = MagicMock()
578         obj_prop = PropertyMock(return_value=inner_obj_mock)
579         type(obj_mock).obj = obj_prop
580         get_content = MagicMock(return_value=[obj_mock])
581         with patch("salt.utils.vmware.get_content", get_content):
582             ret = salt.utils.vmware.get_mors_with_properties(
583                 self.si,
584                 self.obj_type,
585                 self.prop_list,
586                 self.container_ref,
587                 self.traversal_spec,
588             )
589             get_content.assert_called_once_with(
590                 self.si,
591                 self.obj_type,
592                 property_list=self.prop_list,
593                 container_ref=self.container_ref,
594                 traversal_spec=self.traversal_spec,
595                 local_properties=False,
596             )
597         self.assertEqual(propSet_prop.call_count, 1)
598         self.assertEqual(obj_prop.call_count, 1)
599         self.assertEqual(len(ret), 1)
600         self.assertDictEqual(ret[0], {"object": inner_obj_mock})
601     def test_multiple_element_content(self):
602         obj1_mock = MagicMock()
603         obj1_propSet_prop = PropertyMock(return_value=[])
604         type(obj1_mock).propSet = obj1_propSet_prop
605         obj1_inner_obj_mock = MagicMock()
606         obj1_obj_prop = PropertyMock(return_value=obj1_inner_obj_mock)
607         type(obj1_mock).obj = obj1_obj_prop
608         obj2_mock = MagicMock()
609         obj2_propSet_prop = PropertyMock(return_value=[])
610         type(obj2_mock).propSet = obj2_propSet_prop
611         obj2_inner_obj_mock = MagicMock()
612         obj2_obj_prop = PropertyMock(return_value=obj2_inner_obj_mock)
613         type(obj2_mock).obj = obj2_obj_prop
614         get_content = MagicMock(return_value=[obj1_mock, obj2_mock])
615         with patch("salt.utils.vmware.get_content", get_content):
616             ret = salt.utils.vmware.get_mors_with_properties(
617                 self.si,
618                 self.obj_type,
619                 self.prop_list,
620                 self.container_ref,
621                 self.traversal_spec,
622             )
623         get_content.assert_called_once_with(
624             self.si,
625             self.obj_type,
626             property_list=self.prop_list,
627             container_ref=self.container_ref,
628             traversal_spec=self.traversal_spec,
629             local_properties=False,
630         )
631         self.assertEqual(obj1_propSet_prop.call_count, 1)
632         self.assertEqual(obj2_propSet_prop.call_count, 1)
633         self.assertEqual(obj1_obj_prop.call_count, 1)
634         self.assertEqual(obj2_obj_prop.call_count, 1)
635         self.assertEqual(len(ret), 2)
636         self.assertDictEqual(ret[0], {"object": obj1_inner_obj_mock})
637         self.assertDictEqual(ret[1], {"object": obj2_inner_obj_mock})
638     def test_one_elem_one_property(self):
639         obj_mock = MagicMock()
640         prop_set_obj_mock = MagicMock()
641         prop_set_obj_name_prop = PropertyMock(return_value="prop_name")
642         prop_set_obj_val_prop = PropertyMock(return_value="prop_value")
643         type(prop_set_obj_mock).name = prop_set_obj_name_prop
644         type(prop_set_obj_mock).val = prop_set_obj_val_prop
645         propSet_prop = PropertyMock(return_value=[prop_set_obj_mock])
646         type(obj_mock).propSet = propSet_prop
647         inner_obj_mock = MagicMock()
648         obj_prop = PropertyMock(return_value=inner_obj_mock)
649         type(obj_mock).obj = obj_prop
650         get_content = MagicMock(return_value=[obj_mock])
651         with patch("salt.utils.vmware.get_content", get_content):
652             ret = salt.utils.vmware.get_mors_with_properties(
653                 self.si,
654                 self.obj_type,
655                 self.prop_list,
656                 self.container_ref,
657                 self.traversal_spec,
658                 local_properties=False,
659             )
660         get_content.assert_called_once_with(
661             self.si,
662             self.obj_type,
663             property_list=self.prop_list,
664             container_ref=self.container_ref,
665             traversal_spec=self.traversal_spec,
666             local_properties=False,
667         )
668         self.assertEqual(propSet_prop.call_count, 1)
669         self.assertEqual(prop_set_obj_name_prop.call_count, 1)
670         self.assertEqual(prop_set_obj_val_prop.call_count, 1)
671         self.assertEqual(obj_prop.call_count, 1)
672         self.assertEqual(len(ret), 1)
673         self.assertDictEqual(
674             ret[0], {"prop_name": "prop_value", "object": inner_obj_mock}
675         )
676     def test_one_elem_multiple_properties(self):
677         obj_mock = MagicMock()
678         prop_set_obj1_mock = MagicMock()
679         prop_set_obj1_name_prop = PropertyMock(return_value="prop_name1")
680         prop_set_obj1_val_prop = PropertyMock(return_value="prop_value1")
681         type(prop_set_obj1_mock).name = prop_set_obj1_name_prop
682         type(prop_set_obj1_mock).val = prop_set_obj1_val_prop
683         prop_set_obj2_mock = MagicMock()
684         prop_set_obj2_name_prop = PropertyMock(return_value="prop_name2")
685         prop_set_obj2_val_prop = PropertyMock(return_value="prop_value2")
686         type(prop_set_obj2_mock).name = prop_set_obj2_name_prop
687         type(prop_set_obj2_mock).val = prop_set_obj2_val_prop
688         propSet_prop = PropertyMock(
689             return_value=[prop_set_obj1_mock, prop_set_obj2_mock]
690         )
691         type(obj_mock).propSet = propSet_prop
692         inner_obj_mock = MagicMock()
693         obj_prop = PropertyMock(return_value=inner_obj_mock)
694         type(obj_mock).obj = obj_prop
695         get_content = MagicMock(return_value=[obj_mock])
696         with patch("salt.utils.vmware.get_content", get_content):
697             ret = salt.utils.vmware.get_mors_with_properties(
698                 self.si,
699                 self.obj_type,
700                 self.prop_list,
701                 self.container_ref,
702                 self.traversal_spec,
703             )
704         get_content.assert_called_once_with(
705             self.si,
706             self.obj_type,
707             property_list=self.prop_list,
708             container_ref=self.container_ref,
709             traversal_spec=self.traversal_spec,
710             local_properties=False,
711         )
712         self.assertEqual(propSet_prop.call_count, 1)
713         self.assertEqual(prop_set_obj1_name_prop.call_count, 1)
714         self.assertEqual(prop_set_obj1_val_prop.call_count, 1)
715         self.assertEqual(prop_set_obj2_name_prop.call_count, 1)
716         self.assertEqual(prop_set_obj2_val_prop.call_count, 1)
717         self.assertEqual(obj_prop.call_count, 1)
718         self.assertEqual(len(ret), 1)
719         self.assertDictEqual(
720             ret[0],
721             {
722                 "prop_name1": "prop_value1",
723                 "prop_name2": "prop_value2",
724                 "object": inner_obj_mock,
725             },
726         )
727 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
728 class GetPropertiesOfManagedObjectTestCase(TestCase):
729     def setUp(self):
730         patches = (
731             ("salt.utils.vmware.get_service_instance_from_managed_object", MagicMock()),
732             (
733                 "salt.utils.vmware.get_mors_with_properties",
734                 MagicMock(return_value=[MagicMock()]),
735             ),
736         )
737         for mod, mock in patches:
738             patcher = patch(mod, mock)
739             patcher.start()
740             self.addCleanup(patcher.stop)
741         self.mock_si = MagicMock()
742         self.fake_mo_ref = vim.ManagedEntity("Fake")
743         self.mock_props = MagicMock()
744         self.mock_item_name = {"name": "fake_name"}
745         self.mock_item = MagicMock()
746     def test_get_service_instance_from_managed_object_call(self):
747         mock_get_instance_from_managed_object = MagicMock()
748         with patch(
749             "salt.utils.vmware.get_service_instance_from_managed_object",
750             mock_get_instance_from_managed_object,
751         ):
752             salt.utils.vmware.get_properties_of_managed_object(
753                 self.fake_mo_ref, self.mock_props
754             )
755         mock_get_instance_from_managed_object.assert_called_once_with(self.fake_mo_ref)
756     def test_get_mors_with_properties_calls(self):
757         mock_get_mors_with_properties = MagicMock(return_value=[MagicMock()])
758         with patch(
759             "salt.utils.vmware.get_service_instance_from_managed_object",
760             MagicMock(return_value=self.mock_si),
761         ):
762             with patch(
763                 "salt.utils.vmware.get_mors_with_properties",
764                 mock_get_mors_with_properties,
765             ):
766                 salt.utils.vmware.get_properties_of_managed_object(
767                     self.fake_mo_ref, self.mock_props
768                 )
769         mock_get_mors_with_properties.assert_has_calls(
770             [
771                 call(
772                     self.mock_si,
773                     vim.ManagedEntity,
774                     container_ref=self.fake_mo_ref,
775                     property_list=["name"],
776                     local_properties=True,
777                 ),
778                 call(
779                     self.mock_si,
780                     vim.ManagedEntity,
781                     container_ref=self.fake_mo_ref,
782                     property_list=self.mock_props,
783                     local_properties=True,
784                 ),
785             ]
786         )
787     def test_managed_object_no_name_property(self):
788         with patch(
789             "salt.utils.vmware.get_mors_with_properties",
790             MagicMock(side_effect=[vmodl.query.InvalidProperty(), []]),
791         ):
792             with self.assertRaises(VMwareApiError) as excinfo:
793                 salt.utils.vmware.get_properties_of_managed_object(
794                     self.fake_mo_ref, self.mock_props
795                 )
796         self.assertEqual(
797             "Properties of managed object '&lt;unnamed&gt;' weren't retrieved",
798             excinfo.exception.strerror,
799         )
800     def test_no_items_named_object(self):
801         with patch(
802             "salt.utils.vmware.get_mors_with_properties",
803             MagicMock(side_effect=[[self.mock_item_name], []]),
804         ):
805             with self.assertRaises(VMwareApiError) as excinfo:
806                 salt.utils.vmware.get_properties_of_managed_object(
807                     self.fake_mo_ref, self.mock_props
808                 )
809         self.assertEqual(
810             "Properties of managed object 'fake_name' weren't retrieved",
811             excinfo.exception.strerror,
812         )
813 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
814 class GetManagedObjectName(TestCase):
815     def setUp(self):
816         patches = (
817             (
818                 "salt.utils.vmware.get_properties_of_managed_object",
819                 MagicMock(return_value={"key": "value"}),
820             ),
821         )
822         for mod, mock in patches:
823             patcher = patch(mod, mock)
824             patcher.start()
825             self.addCleanup(patcher.stop)
826         self.mock_mo_ref = MagicMock()
827     def test_get_properties_of_managed_object_call(self):
828         mock_get_properties_of_managed_object = MagicMock()
829         with patch(
830             "salt.utils.vmware.get_properties_of_managed_object",
831             mock_get_properties_of_managed_object,
832         ):
833             salt.utils.vmware.get_managed_object_name(self.mock_mo_ref)
834         mock_get_properties_of_managed_object.assert_called_once_with(
835             self.mock_mo_ref, ["name"]
836         )
837     def test_no_name_in_property_dict(self):
838         ret = salt.utils.vmware.get_managed_object_name(self.mock_mo_ref)
839         self.assertIsNone(ret)
840     def test_return_managed_object_name(self):
841         mock_get_properties_of_managed_object = MagicMock()
842         with patch(
843             "salt.utils.vmware.get_properties_of_managed_object",
844             MagicMock(return_value={"name": "fake_name"}),
845         ):
846             ret = salt.utils.vmware.get_managed_object_name(self.mock_mo_ref)
847         self.assertEqual(ret, "fake_name")
848 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
849 class GetContentTestCase(TestCase):
850     traversal_spec_method_name = (
851         "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec"
852     )
853     property_spec_method_name = (
854         "salt.utils.vmware.vmodl.query.PropertyCollector.PropertySpec"
855     )
856     obj_spec_method_name = "salt.utils.vmware.vmodl.query.PropertyCollector.ObjectSpec"
857     filter_spec_method_name = (
858         "salt.utils.vmware.vmodl.query.PropertyCollector.FilterSpec"
859     )
860     si_mock = None
861     root_folder_mock = None
862     root_folder_prop = None
863     container_view_mock = None
864     create_container_view_mock = None
865     result_mock = None
866     retrieve_contents_mock = None
867     destroy_mock = None
868     obj_type_mock = None
869     traversal_spec_ret_mock = None
870     traversal_spec_mock = None
871     property_spec_ret_mock = None
872     property_spec_mock = None
873     obj_spec_ret_mock = None
874     obj_spec_mock = None
875     filter_spec_ret_mock = None
876     filter_spec_mock = None
877     def setUp(self):
878         patches = (
879             ("salt.utils.vmware.get_root_folder", MagicMock()),
880             (
881                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
882                 MagicMock(return_value=MagicMock()),
883             ),
884             (
885                 "salt.utils.vmware.vmodl.query.PropertyCollector.PropertySpec",
886                 MagicMock(return_value=MagicMock()),
887             ),
888             (
889                 "salt.utils.vmware.vmodl.query.PropertyCollector.ObjectSpec",
890                 MagicMock(return_value=MagicMock()),
891             ),
892             (
893                 "salt.utils.vmware.vmodl.query.PropertyCollector.FilterSpec",
894                 MagicMock(return_value=MagicMock()),
895             ),
896         )
897         for mod, mock in patches:
898             patcher = patch(mod, mock)
899             patcher.start()
900             self.addCleanup(patcher.stop)
901         self.si_mock = MagicMock()
902         self.root_folder_mock = MagicMock()
903         self.get_root_folder_mock = MagicMock(return_value=self.root_folder_mock)
904         self.container_view_mock = MagicMock()
905         self.create_container_view_mock = MagicMock(
906             return_value=self.container_view_mock
907         )
908         self.si_mock.content.viewManager.CreateContainerView = (
909             self.create_container_view_mock
910         )
911         self.result_mock = MagicMock()
912         self.retrieve_contents_mock = MagicMock(return_value=self.result_mock)
913         self.si_mock.content.propertyCollector.RetrieveContents = (
914             self.retrieve_contents_mock
915         )
916         self.destroy_mock = MagicMock()
917         self.container_view_mock.Destroy = self.destroy_mock
918         self.obj_type_mock = MagicMock()
919         self.traversal_spec_ret_mock = MagicMock()
920         self.traversal_spec_mock = MagicMock(return_value=self.traversal_spec_ret_mock)
921         self.property_spec_ret_mock = MagicMock()
922         self.property_spec_mock = MagicMock(return_value=self.property_spec_ret_mock)
923         self.obj_spec_ret_mock = MagicMock()
924         self.obj_spec_mock = MagicMock(return_value=self.obj_spec_ret_mock)
925         self.filter_spec_ret_mock = MagicMock()
926         self.filter_spec_mock = MagicMock(return_value=self.filter_spec_ret_mock)
927     def test_empty_container_ref(self):
928         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
929             salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
930         self.get_root_folder_mock.assert_called_once_with(self.si_mock)
931         self.create_container_view_mock.assert_called_once_with(
932             self.root_folder_mock, [self.obj_type_mock], True
933         )
934     def test_defined_container_ref(self):
935         container_ref_mock = MagicMock()
936         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
937             with patch(self.obj_spec_method_name, self.obj_type_mock):
938                 salt.utils.vmware.get_content(
939                     self.si_mock, self.obj_type_mock, container_ref=container_ref_mock
940                 )
941         self.assertEqual(self.get_root_folder_mock.call_count, 0)
942         self.create_container_view_mock.assert_called_once_with(
943             container_ref_mock, [self.obj_type_mock], True
944         )
945     def test_local_traversal_spec(self):
946         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
947             with patch(self.traversal_spec_method_name, self.traversal_spec_mock):
948                 with patch(self.obj_spec_method_name, self.obj_spec_mock):
949                     ret = salt.utils.vmware.get_content(
950                         self.si_mock, self.obj_type_mock
951                     )
952         self.create_container_view_mock.assert_called_once_with(
953             self.root_folder_mock, [self.obj_type_mock], True
954         )
955         self.traversal_spec_mock.assert_called_once_with(
956             name="traverseEntities",
957             path="view",
958             skip=False,
959             type=vim.view.ContainerView,
960         )
961         self.obj_spec_mock.assert_called_once_with(
962             obj=self.container_view_mock,
963             skip=True,
964             selectSet=[self.traversal_spec_ret_mock],
965         )
966         self.assertEqual(self.destroy_mock.call_count, 1)
967     def test_create_container_view_raise_no_permission(self):
968         exc = vim.fault.NoPermission()
969         exc.privilegeId = "Fake privilege"
970         self.si_mock.content.viewManager.CreateContainerView = MagicMock(
971             side_effect=exc
972         )
973         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
974             with self.assertRaises(VMwareApiError) as excinfo:
975                 salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
976         self.assertEqual(
977             excinfo.exception.strerror,
978             "Not enough permissions. Required privilege: Fake privilege",
979         )
980     def test_create_container_view_raise_vim_fault(self):
981         exc = vim.fault.VimFault()
982         exc.msg = "VimFault msg"
983         self.si_mock.content.viewManager.CreateContainerView = MagicMock(
984             side_effect=exc
985         )
986         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
987             with self.assertRaises(VMwareApiError) as excinfo:
988                 salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
989         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
990     def test_create_container_view_raise_runtime_fault(self):
991         exc = vmodl.RuntimeFault()
992         exc.msg = "RuntimeFault msg"
993         self.si_mock.content.viewManager.CreateContainerView = MagicMock(
994             side_effect=exc
995         )
996         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
997             with self.assertRaises(VMwareRuntimeError) as excinfo:
998                 salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
999         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1000     def test_destroy_raise_no_permission(self):
1001         exc = vim.fault.NoPermission()
1002         exc.privilegeId = "Fake privilege"
1003         self.si_mock.content.viewManager.CreateContainerView = MagicMock(
1004             return_value=MagicMock(Destroy=MagicMock(side_effect=exc))
1005         )
1006         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
1007             with self.assertRaises(VMwareApiError) as excinfo:
1008                 salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
1009         self.assertEqual(
1010             excinfo.exception.strerror,
1011             "Not enough permissions. Required privilege: Fake privilege",
1012         )
1013     def test_destroy_raise_vim_fault(self):
1014         exc = vim.fault.VimFault()
1015         exc.msg = "VimFault msg"
1016         self.si_mock.content.viewManager.CreateContainerView = MagicMock(
1017             return_value=MagicMock(Destroy=MagicMock(side_effect=exc))
1018         )
1019         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
1020             with self.assertRaises(VMwareApiError) as excinfo:
1021                 salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
1022         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1023     def test_destroy_raise_runtime_fault(self):
1024         exc = vmodl.RuntimeFault()
1025         exc.msg = "RuntimeFault msg"
1026         self.si_mock.content.viewManager.CreateContainerView = MagicMock(
1027             return_value=MagicMock(Destroy=MagicMock(side_effect=exc))
1028         )
1029         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
1030             with self.assertRaises(VMwareRuntimeError) as excinfo:
1031                 salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
1032         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1033     def test_external_traversal_spec(self):
1034         traversal_spec_obj_mock = MagicMock()
1035         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
1036             with patch(self.traversal_spec_method_name, self.traversal_spec_mock):
1037                 with patch(self.obj_spec_method_name, self.obj_spec_mock):
1038                     salt.utils.vmware.get_content(
1039                         self.si_mock,
1040                         self.obj_type_mock,
1041                         traversal_spec=traversal_spec_obj_mock,
1042                     )
1043         self.obj_spec_mock.assert_called_once_with(
1044             obj=self.root_folder_mock, skip=True, selectSet=[traversal_spec_obj_mock]
1045         )
1046         self.assertEqual(self.create_container_view_mock.call_count, 0)
1047         self.assertEqual(self.traversal_spec_mock.call_count, 0)
1048         self.assertEqual(self.destroy_mock.call_count, 0)
1049     def test_property_obj_filter_specs_and_contents(self):
1050         with patch(self.traversal_spec_method_name, self.traversal_spec_mock):
1051             with patch(self.property_spec_method_name, self.property_spec_mock):
1052                 with patch(self.obj_spec_method_name, self.obj_spec_mock):
1053                     with patch(self.filter_spec_method_name, self.filter_spec_mock):
1054                         ret = salt.utils.vmware.get_content(
1055                             self.si_mock, self.obj_type_mock
1056                         )
1057         self.traversal_spec_mock.assert_called_once_with(
1058             name="traverseEntities",
1059             path="view",
1060             skip=False,
1061             type=vim.view.ContainerView,
1062         )
1063         self.property_spec_mock.assert_called_once_with(
1064             type=self.obj_type_mock, all=True, pathSet=None
1065         )
1066             obj=self.container_view_mock,
1067             skip=True,
1068             selectSet=[self<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.traversal_spec_ret_mock],
1069         )
1070         self.retrieve_contents_mock.assert_called_once_with([self.filter_spec_ret_mock])
1071         self.assertEqual(ret, self.result_mock)
1072     def test_retrieve_contents_raise_no_permission(self):
1073         exc = vim.</b></font>fault.NoPermission()
1074         exc.privilegeId = "Fake privilege"
1075         self.si_mock.content.propertyCollector.RetrieveContents = MagicMock(
1076             side_effect=exc
1077         )
1078         with self.assertRaises(VMwareApiError) as excinfo:
1079             salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
1080         self.assertEqual(
1081             excinfo.exception.strerror,
1082             "Not enough permissions. Required privilege: Fake privilege",
1083         )
1084     def test_retrieve_contents_raise_vim_fault(self):
1085         exc = vim.fault.VimFault()
1086         exc.msg = "VimFault msg"
1087         self.si_mock.content.propertyCollector.RetrieveContents = MagicMock(
1088             side_effect=exc
1089         )
1090         with self.assertRaises(VMwareApiError) as excinfo:
1091             salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
1092         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1093     def test_retrieve_contents_raise_runtime_fault(self):
1094         exc = vmodl.RuntimeFault()
1095         exc.msg = "RuntimeFault msg"
1096         self.si_mock.content.propertyCollector.RetrieveContents = MagicMock(
1097             side_effect=exc
1098         )
1099         with self.assertRaises(VMwareRuntimeError) as excinfo:
1100             salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
1101         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1102     def test_local_properties_set(self):
1103         container_ref_mock = MagicMock()
1104         with patch(self.traversal_spec_method_name, self.traversal_spec_mock):
1105             with patch(self.property_spec_method_name, self.property_spec_mock):
1106                 with patch(self.obj_spec_method_name, self.obj_spec_mock):
1107                     salt.utils.vmware.get_content(
1108                         self.si_mock,
1109                         self.obj_type_mock,
1110                         container_ref=container_ref_mock,
1111                         local_properties=True,
1112                     )
1113         self.assertEqual(self.traversal_spec_mock.call_count, 0)
1114         self.obj_spec_mock.assert_called_once_with(
1115             obj=container_ref_mock, skip=False, selectSet=None
1116         )
1117 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1118 class GetRootFolderTestCase(TestCase):
1119     def setUp(self):
1120         self.mock_root_folder = MagicMock()
1121         self.mock_content = MagicMock(rootFolder=self.mock_root_folder)
1122         self.mock_si = MagicMock(
1123             RetrieveContent=MagicMock(return_value=self.mock_content)
1124         )
1125     def test_raise_no_permission(self):
1126         exc = vim.fault.NoPermission()
1127         exc.privilegeId = "Fake privilege"
1128         type(self.mock_content).rootFolder = PropertyMock(side_effect=exc)
1129         with self.assertRaises(VMwareApiError) as excinfo:
1130             salt.utils.vmware.get_root_folder(self.mock_si)
1131         self.assertEqual(
1132             excinfo.exception.strerror,
1133             "Not enough permissions. Required privilege: Fake privilege",
1134         )
1135     def test_raise_vim_fault(self):
1136         exc = vim.fault.VimFault()
1137         exc.msg = "VimFault msg"
1138         type(self.mock_content).rootFolder = PropertyMock(side_effect=exc)
1139         with self.assertRaises(VMwareApiError) as excinfo:
1140             salt.utils.vmware.get_root_folder(self.mock_si)
1141         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1142     def test_raise_runtime_fault(self):
1143         exc = vmodl.RuntimeFault()
1144         exc.msg = "RuntimeFault msg"
1145         type(self.mock_content).rootFolder = PropertyMock(side_effect=exc)
1146         with self.assertRaises(VMwareRuntimeError) as excinfo:
1147             salt.utils.vmware.get_root_folder(self.mock_si)
1148         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1149     def test_return(self):
1150         ret = salt.utils.vmware.get_root_folder(self.mock_si)
1151         self.assertEqual(ret, self.mock_root_folder)
1152 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1153 class GetServiceInfoTestCase(TestCase):
1154     def setUp(self):
1155         self.mock_about = MagicMock()
1156         self.mock_si = MagicMock(content=MagicMock())
1157         type(self.mock_si.content).about = PropertyMock(return_value=self.mock_about)
1158     def tearDown(self):
1159         for attr in ("mock_si", "mock_about"):
1160             delattr(self, attr)
1161     def test_about_ret(self):
1162         ret = salt.utils.vmware.get_service_info(self.mock_si)
1163         self.assertEqual(ret, self.mock_about)
1164     def test_about_raises_no_permission(self):
1165         exc = vim.fault.NoPermission()
1166         exc.privilegeId = "Fake privilege"
1167         type(self.mock_si.content).about = PropertyMock(side_effect=exc)
1168         with self.assertRaises(VMwareApiError) as excinfo:
1169             salt.utils.vmware.get_service_info(self.mock_si)
1170         self.assertEqual(
1171             excinfo.exception.strerror,
1172             "Not enough permissions. Required privilege: Fake privilege",
1173         )
1174     def test_about_raises_vim_fault(self):
1175         exc = vim.fault.VimFault()
1176         exc.msg = "VimFault msg"
1177         type(self.mock_si.content).about = PropertyMock(side_effect=exc)
1178         with self.assertRaises(VMwareApiError) as excinfo:
1179             salt.utils.vmware.get_service_info(self.mock_si)
1180         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1181     def test_about_raises_runtime_fault(self):
1182         exc = vmodl.RuntimeFault()
1183         exc.msg = "RuntimeFault msg"
1184         type(self.mock_si.content).about = PropertyMock(side_effect=exc)
1185         with self.assertRaises(VMwareRuntimeError) as excinfo:
1186             salt.utils.vmware.get_service_info(self.mock_si)
1187         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1188 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1189 @skipIf(not HAS_GSSAPI, "The 'gssapi' library is missing")
1190 class GssapiTokenTest(TestCase):
1191     def setUp(self):
1192         patches = (
1193             ("gssapi.Name", MagicMock(return_value="service")),
1194             ("gssapi.InitContext", MagicMock()),
1195         )
1196         for mod, mock in patches:
1197             patcher = patch(mod, mock)
1198             patcher.start()
1199             self.addCleanup(patcher.stop)
1200     def test_no_gssapi(self):
1201         with patch("salt.utils.vmware.HAS_GSSAPI", False):
1202             with self.assertRaises(ImportError) as excinfo:
1203                 salt.utils.vmware.get_gssapi_token("principal", "host", "domain")
1204                 self.assertIn(
1205                     "The gssapi library is not imported.", excinfo.exception.message
1206                 )
1207     @skipIf(not HAS_GSSAPI, "The 'gssapi' library is missing")
1208     def test_service_name(self):
1209         mock_name = MagicMock()
1210         with patch.object(salt.utils.vmware.gssapi, "Name", mock_name):
1211             with self.assertRaises(CommandExecutionError):
1212                 salt.utils.vmware.get_gssapi_token("principal", "host", "domain")
1213             mock_name.assert_called_once_with(
1214                 "principal/host@domain", gssapi.C_NT_USER_NAME
1215             )
1216     @skipIf(not HAS_GSSAPI, "The 'gssapi' library is missing")
1217     def test_out_token_defined(self):
1218         mock_context = MagicMock(return_value=MagicMock())
1219         mock_context.return_value.established = False
1220         mock_context.return_value.step = MagicMock(return_value="out_token")
1221         with patch.object(salt.utils.vmware.gssapi, "InitContext", mock_context):
1222             ret = salt.utils.vmware.get_gssapi_token("principal", "host", "domain")
1223             self.assertEqual(mock_context.return_value.step.called, 1)
1224             self.assertEqual(ret, base64.b64encode(b"out_token"))
1225     @skipIf(not HAS_GSSAPI, "The 'gssapi' library is missing")
1226     def test_out_token_undefined(self):
1227         mock_context = MagicMock(return_value=MagicMock())
1228         mock_context.return_value.established = False
1229         mock_context.return_value.step = MagicMock(return_value=None)
1230         with patch.object(salt.utils.vmware.gssapi, "InitContext", mock_context):
1231             with self.assertRaises(CommandExecutionError) as excinfo:
1232                 salt.utils.vmware.get_gssapi_token("principal", "host", "domain")
1233             self.assertEqual(mock_context.return_value.step.called, 1)
1234             self.assertIn("Can't receive token", excinfo.exception.strerror)
1235     @skipIf(not HAS_GSSAPI, "The 'gssapi' library is missing")
1236     def test_context_extablished(self):
1237         mock_context = MagicMock(return_value=MagicMock())
1238         mock_context.return_value.established = True
1239         mock_context.return_value.step = MagicMock(return_value="out_token")
1240         with patch.object(salt.utils.vmware.gssapi, "InitContext", mock_context):
1241             mock_context.established = True
1242             mock_context.step = MagicMock(return_value=None)
1243             with self.assertRaises(CommandExecutionError) as excinfo:
1244                 salt.utils.vmware.get_gssapi_token("principal", "host", "domain")
1245             self.assertEqual(mock_context.step.called, 0)
1246             self.assertIn(
1247                 "Context established, but didn't receive token",
1248                 excinfo.exception.strerror,
1249             )
1250 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1251 class PrivateGetServiceInstanceTestCase(TestCase):
1252     def setUp(self):
1253         patches = (
1254             ("salt.utils.vmware.SmartConnect", MagicMock()),
1255             ("salt.utils.vmware.Disconnect", MagicMock()),
1256             (
1257                 "salt.utils.vmware.get_gssapi_token",
1258                 MagicMock(return_value="fake_token"),
1259             ),
1260         )
1261         for mod, mock in patches:
1262             patcher = patch(mod, mock)
1263             patcher.start()
1264             self.addCleanup(patcher.stop)
1265     def test_invalid_mechianism(self):
1266         with self.assertRaises(CommandExecutionError) as excinfo:
1267             salt.utils.vmware._get_service_instance(
1268                 host="fake_host.fqdn",
1269                 username="fake_username",
1270                 password="fake_password",
1271                 protocol="fake_protocol",
1272                 port=1,
1273                 mechanism="invalid_mechanism",
1274                 principal="fake principal",
1275                 domain="fake_domain",
1276             )
1277         self.assertIn("Unsupported mechanism", excinfo.exception.strerror)
1278     def test_userpass_mechanism_empty_username(self):
1279         with self.assertRaises(CommandExecutionError) as excinfo:
1280             salt.utils.vmware._get_service_instance(
1281                 host="fake_host.fqdn",
1282                 username=None,
1283                 password="fake_password",
1284                 protocol="fake_protocol",
1285                 port=1,
1286                 mechanism="userpass",
1287                 principal="fake principal",
1288                 domain="fake_domain",
1289             )
1290         self.assertIn("mandatory parameter 'username'", excinfo.exception.strerror)
1291     def test_userpass_mechanism_empty_password(self):
1292         with self.assertRaises(CommandExecutionError) as excinfo:
1293             salt.utils.vmware._get_service_instance(
1294                 host="fake_host.fqdn",
1295                 username="fake_username",
1296                 password=None,
1297                 protocol="fake_protocol",
1298                 port=1,
1299                 mechanism="userpass",
1300                 principal="fake principal",
1301                 domain="fake_domain",
1302             )
1303         self.assertIn("mandatory parameter 'password'", excinfo.exception.strerror)
1304     def test_userpass_mechanism_no_domain(self):
1305         mock_sc = MagicMock()
1306         with patch("salt.utils.vmware.SmartConnect", mock_sc):
1307             salt.utils.vmware._get_service_instance(
1308                 host="fake_host.fqdn",
1309                 username="fake_username",
1310                 password="fake_password",
1311                 protocol="fake_protocol",
1312                 port=1,
1313                 mechanism="userpass",
1314                 principal="fake principal",
1315                 domain=None,
1316             )
1317             mock_sc.assert_called_once_with(
1318                 host="fake_host.fqdn",
1319                 user="fake_username",
1320                 pwd="fake_password",
1321                 protocol="fake_protocol",
1322                 port=1,
1323                 b64token=None,
1324                 mechanism="userpass",
1325             )
1326     def test_userpass_mech_domain_unused(self):
1327         mock_sc = MagicMock()
1328         with patch("salt.utils.vmware.SmartConnect", mock_sc):
1329             salt.utils.vmware._get_service_instance(
1330                 host="fake_host.fqdn",
1331                 username="fake_username@domain",
1332                 password="fake_password",
1333                 protocol="fake_protocol",
1334                 port=1,
1335                 mechanism="userpass",
1336                 principal="fake principal",
1337                 domain="fake_domain",
1338             )
1339             mock_sc.assert_called_once_with(
1340                 host="fake_host.fqdn",
1341                 user="fake_username@domain",
1342                 pwd="fake_password",
1343                 protocol="fake_protocol",
1344                 port=1,
1345                 b64token=None,
1346                 mechanism="userpass",
1347             )
1348             mock_sc.reset_mock()
1349             salt.utils.vmware._get_service_instance(
1350                 host="fake_host.fqdn",
1351                 username="domain\\fake_username",
1352                 password="fake_password",
1353                 protocol="fake_protocol",
1354                 port=1,
1355                 mechanism="userpass",
1356                 principal="fake principal",
1357                 domain="fake_domain",
1358             )
1359             mock_sc.assert_called_once_with(
1360                 host="fake_host.fqdn",
1361                 user="domain\\fake_username",
1362                 pwd="fake_password",
1363                 protocol="fake_protocol",
1364                 port=1,
1365                 b64token=None,
1366                 mechanism="userpass",
1367             )
1368     def test_sspi_empty_principal(self):
1369         with self.assertRaises(CommandExecutionError) as excinfo:
1370             salt.utils.vmware._get_service_instance(
1371                 host="fake_host.fqdn",
1372                 username="fake_username",
1373                 password="fake_password",
1374                 protocol="fake_protocol",
1375                 port=1,
1376                 mechanism="sspi",
1377                 principal=None,
1378                 domain="fake_domain",
1379             )
1380         self.assertIn("mandatory parameters are missing", excinfo.exception.strerror)
1381     def test_sspi_empty_domain(self):
1382         with self.assertRaises(CommandExecutionError) as excinfo:
1383             salt.utils.vmware._get_service_instance(
1384                 host="fake_host.fqdn",
1385                 username="fake_username",
1386                 password="fake_password",
1387                 protocol="fake_protocol",
1388                 port=1,
1389                 mechanism="sspi",
1390                 principal="fake_principal",
1391                 domain=None,
1392             )
1393         self.assertIn("mandatory parameters are missing", excinfo.exception.strerror)
1394     def test_sspi_get_token_error(self):
1395         mock_token = MagicMock(side_effect=Exception("Exception"))
1396         with patch("salt.utils.vmware.get_gssapi_token", mock_token):
1397             with self.assertRaises(VMwareConnectionError) as excinfo:
1398                 salt.utils.vmware._get_service_instance(
1399                     host="fake_host.fqdn",
1400                     username="fake_username",
1401                     password="fake_password",
1402                     protocol="fake_protocol",
1403                     port=1,
1404                     mechanism="sspi",
1405                     principal="fake_principal",
1406                     domain="fake_domain",
1407                 )
1408             mock_token.assert_called_once_with(
1409                 "fake_principal", "fake_host.fqdn", "fake_domain"
1410             )
1411             self.assertEqual("Exception", excinfo.exception.strerror)
1412     def test_sspi_get_token_success_(self):
1413         mock_token = MagicMock(return_value="fake_token")
1414         mock_sc = MagicMock()
1415         with patch("salt.utils.vmware.get_gssapi_token", mock_token):
1416             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1417                 salt.utils.vmware._get_service_instance(
1418                     host="fake_host.fqdn",
1419                     username="fake_username",
1420                     password="fake_password",
1421                     protocol="fake_protocol",
1422                     port=1,
1423                     mechanism="sspi",
1424                     principal="fake_principal",
1425                     domain="fake_domain",
1426                 )
1427             mock_token.assert_called_once_with(
1428                 "fake_principal", "fake_host.fqdn", "fake_domain"
1429             )
1430             mock_sc.assert_called_once_with(
1431                 host="fake_host.fqdn",
1432                 user="fake_username",
1433                 pwd="fake_password",
1434                 protocol="fake_protocol",
1435                 port=1,
1436                 b64token="fake_token",
1437                 mechanism="sspi",
1438             )
1439     def test_first_attempt_successful_connection(self):
1440         mock_sc = MagicMock()
1441         with patch("salt.utils.vmware.SmartConnect", mock_sc):
1442             salt.utils.vmware._get_service_instance(
1443                 host="fake_host.fqdn",
1444                 username="fake_username",
1445                 password="fake_password",
1446                 protocol="fake_protocol",
1447                 port=1,
1448                 mechanism="sspi",
1449                 principal="fake_principal",
1450                 domain="fake_domain",
1451             )
1452             mock_sc.assert_called_once_with(
1453                 host="fake_host.fqdn",
1454                 user="fake_username",
1455                 pwd="fake_password",
1456                 protocol="fake_protocol",
1457                 port=1,
1458                 b64token="fake_token",
1459                 mechanism="sspi",
1460             )
1461     def test_first_attempt_successful_connection_verify_ssl_false(self):
1462         with patch("ssl.SSLContext", MagicMock()), patch(
1463             "ssl._create_unverified_context", MagicMock()
1464         ):
1465             exc = vim.fault.HostConnectFault()
1466             exc.msg = "[SSL: CERTIFICATE_VERIFY_FAILED]"
1467             mock_sc = MagicMock(side_effect=[None])
1468             mock_ssl = MagicMock()
1469             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1470                 with patch("ssl._create_unverified_context", mock_ssl):
1471                     salt.utils.vmware._get_service_instance(
1472                         host="fake_host.fqdn",
1473                         username="fake_username",
1474                         password="fake_password",
1475                         protocol="fake_protocol",
1476                         port=1,
1477                         mechanism="sspi",
1478                         principal="fake_principal",
1479                         domain="fake_domain",
1480                         verify_ssl=False,
1481                     )
1482                     mock_ssl.assert_called_once_with()
1483                     calls = [
1484                         call(
1485                             host="fake_host.fqdn",
1486                             user="fake_username",
1487                             pwd="fake_password",
1488                             protocol="fake_protocol",
1489                             port=1,
1490                             sslContext=mock_ssl.return_value,
1491                             b64token="fake_token",
1492                             mechanism="sspi",
1493                         ),
1494                     ]
1495                     mock_sc.assert_has_calls(calls)
1496     def test_second_attempt_successful_connection_verify_ssl_false(self):
1497         with patch("ssl.SSLContext", MagicMock()), patch(
1498             "ssl._create_unverified_context", MagicMock()
1499         ):
1500             exc = Exception("certificate verify failed")
1501             mock_sc = MagicMock(side_effect=[exc, None])
1502             mock_ssl_unverif = MagicMock()
1503             mock_ssl_context = MagicMock()
1504             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1505                 with patch("ssl._create_unverified_context", mock_ssl_unverif):
1506                     with patch("ssl.SSLContext", mock_ssl_context):
1507                         salt.utils.vmware._get_service_instance(
1508                             host="fake_host.fqdn",
1509                             username="fake_username",
1510                             password="fake_password",
1511                             protocol="fake_protocol",
1512                             port=1,
1513                             mechanism="sspi",
1514                             principal="fake_principal",
1515                             domain="fake_domain",
1516                             verify_ssl=False,
1517                         )
1518                         mock_ssl_context.assert_called_once_with(ssl.PROTOCOL_TLSv1)
1519                         mock_ssl_unverif.assert_called_once_with()
1520                         calls = [
1521                             call(
1522                                 host="fake_host.fqdn",
1523                                 user="fake_username",
1524                                 pwd="fake_password",
1525                                 protocol="fake_protocol",
1526                                 port=1,
1527                                 sslContext=mock_ssl_unverif.return_value,
1528                                 b64token="fake_token",
1529                                 mechanism="sspi",
1530                             ),
1531                             call(
1532                                 host="fake_host.fqdn",
1533                                 user="fake_username",
1534                                 pwd="fake_password",
1535                                 protocol="fake_protocol",
1536                                 port=1,
1537                                 sslContext=mock_ssl_context.return_value,
1538                                 b64token="fake_token",
1539                                 mechanism="sspi",
1540                             ),
1541                         ]
1542                         mock_sc.assert_has_calls(calls)
1543     def test_attempt_unsuccessful_connection_default_error(self):
1544         exc = Exception("Exception")
1545         mock_sc = MagicMock(side_effect=exc)
1546         with patch("salt.utils.vmware.SmartConnect", mock_sc):
1547             with self.assertRaises(VMwareConnectionError) as excinfo:
1548                 salt.utils.vmware._get_service_instance(
1549                     host="fake_host.fqdn",
1550                     username="fake_username",
1551                     password="fake_password",
1552                     protocol="fake_protocol",
1553                     port=1,
1554                     mechanism="sspi",
1555                     principal="fake_principal",
1556                     domain="fake_domain",
1557                 )
1558         self.assertEqual(mock_sc.call_count, 1)
1559         self.assertIn(
1560             "Could not connect to host 'fake_host.fqdn'",
1561             excinfo.exception.message,
1562         )
1563     def test_attempt_unsuccessful_connection_vim_fault(self):
1564         exc = vim.fault.VimFault()
1565         exc.msg = "VimFault"
1566         mock_sc = MagicMock(side_effect=exc)
1567         with patch("salt.utils.vmware.SmartConnect", mock_sc):
1568             with self.assertRaises(VMwareConnectionError) as excinfo:
1569                 salt.utils.vmware._get_service_instance(
1570                     host="fake_host.fqdn",
1571                     username="fake_username",
1572                     password="fake_password",
1573                     protocol="fake_protocol",
1574                     port=1,
1575                     mechanism="sspi",
1576                     principal="fake_principal",
1577                     domain="fake_domain",
1578                 )
1579         self.assertEqual(mock_sc.call_count, 1)
1580         self.assertEqual("VimFault", excinfo.exception.message)
1581     def test_first_attempt_unsuccsessful_connection_default_error(self):
1582         with patch("ssl.SSLContext", MagicMock()), patch(
1583             "ssl._create_unverified_context", MagicMock()
1584         ):
1585             exc = vim.fault.HostConnectFault()
1586             exc.msg = "certificate verify failed"
1587             exc2 = Exception("Exception")
1588             mock_sc = MagicMock(side_effect=[exc, exc2])
1589             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1590                 with self.assertRaises(VMwareConnectionError) as excinfo:
1591                     salt.utils.vmware._get_service_instance(
1592                         host="fake_host.fqdn",
1593                         username="fake_username",
1594                         password="fake_password",
1595                         protocol="fake_protocol",
1596                         port=1,
1597                         mechanism="sspi",
1598                         principal="fake_principal",
1599                         domain="fake_domain",
1600                         verify_ssl=False,
1601                     )
1602             self.assertEqual(mock_sc.call_count, 2)
1603             self.assertIn(
1604                 "Could not connect to host 'fake_host.fqdn'", excinfo.exception.message
1605             )
1606     def test_first_attempt_unsuccsessful_cannot_vim_fault_verify_ssl(self):
1607         with patch("ssl.SSLContext", MagicMock()), patch(
1608             "ssl._create_unverified_context", MagicMock()
1609         ):
1610             exc = vim.fault.VimFault()
1611             exc.msg = "VimFault"
1612             mock_sc = MagicMock(side_effect=[exc])
1613             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1614                 with self.assertRaises(VMwareConnectionError) as excinfo:
1615                     salt.utils.vmware._get_service_instance(
1616                         host="fake_host.fqdn",
1617                         username="fake_username",
1618                         password="fake_password",
1619                         protocol="fake_protocol",
1620                         port=1,
1621                         mechanism="sspi",
1622                         principal="fake_principal",
1623                         domain="fake_domain",
1624                         verify_ssl=False,
1625                     )
1626             self.assertEqual(mock_sc.call_count, 1)
1627             self.assertIn("VimFault", excinfo.exception.message)
1628     def test_third_attempt_unsuccessful_connection_detault_error(self):
1629         with patch("ssl.SSLContext", MagicMock()), patch(
1630             "ssl._create_unverified_context", MagicMock()
1631         ):
1632             exc = vim.fault.HostConnectFault()
1633             exc.msg = "certificate verify failed"
1634             exc2 = Exception("Exception")
1635             mock_sc = MagicMock(side_effect=[exc, exc2])
1636             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1637                 with self.assertRaises(VMwareConnectionError) as excinfo:
1638                     salt.utils.vmware._get_service_instance(
1639                         host="fake_host.fqdn",
1640                         username="fake_username",
1641                         password="fake_password",
1642                         protocol="fake_protocol",
1643                         port=1,
1644                         mechanism="sspi",
1645                         principal="fake_principal",
1646                         domain="fake_domain",
1647                         verify_ssl=False,
1648                     )
1649             self.assertEqual(mock_sc.call_count, 2)
1650             self.assertIn(
1651                 "Could not connect to host 'fake_host.fqdn", excinfo.exception.message
1652             )
1653     def test_second_attempt_unsuccessful_connection_vim_fault(self):
1654         with patch("ssl.SSLContext", MagicMock()), patch(
1655             "ssl._create_unverified_context", MagicMock()
1656         ):
1657             exc = vim.fault.VimFault()
1658             exc.msg = "VimFault"
1659             mock_sc = MagicMock(side_effect=[exc])
1660             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1661                 with self.assertRaises(VMwareConnectionError) as excinfo:
1662                     salt.utils.vmware._get_service_instance(
1663                         host="fake_host.fqdn",
1664                         username="fake_username",
1665                         password="fake_password",
1666                         protocol="fake_protocol",
1667                         port=1,
1668                         mechanism="sspi",
1669                         principal="fake_principal",
1670                         domain="fake_domain",
1671                         verify_ssl=False,
1672                     )
1673             self.assertEqual(mock_sc.call_count, 1)
1674             self.assertIn("VimFault", excinfo.exception.message)
1675 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1676 class GetServiceInstanceTestCase(TestCase):
1677     def setUp(self):
1678         patches = (
1679             ("salt.utils.vmware.GetSi", MagicMock(return_value=None)),
1680             (
1681                 "salt.utils.vmware._get_service_instance",
1682                 MagicMock(return_value=MagicMock()),
1683             ),
1684         )
1685         for mod, mock in patches:
1686             patcher = patch(mod, mock)
1687             patcher.start()
1688             self.addCleanup(patcher.stop)
1689     def test_default_params(self):
1690         mock_get_si = MagicMock()
1691         with patch("salt.utils.vmware._get_service_instance", mock_get_si):
1692             salt.utils.vmware.get_service_instance(host="fake_host")
1693             mock_get_si.assert_called_once_with(
1694                 "fake_host",
1695                 None,
1696                 None,
1697                 "https",
1698                 443,
1699                 "userpass",
1700                 None,
1701                 None,
1702                 verify_ssl=True,
1703             )
1704     def test_no_cached_service_instance_same_host_on_proxy(self):
1705         with patch("salt.utils.platform.is_proxy", MagicMock(return_value=True)):
1706             mock_get_si = MagicMock()
1707             with patch("salt.utils.vmware._get_service_instance", mock_get_si):
1708                 salt.utils.vmware.get_service_instance(
1709                     host="fake_host",
1710                     username="fake_username",
1711                     password="fake_password",
1712                     protocol="fake_protocol",
1713                     port=1,
1714                     mechanism="fake_mechanism",
1715                     principal="fake_principal",
1716                     domain="fake_domain",
1717                 )
1718                 mock_get_si.assert_called_once_with(
1719                     "fake_host",
1720                     "fake_username",
1721                     "fake_password",
1722                     "fake_protocol",
1723                     1,
1724                     "fake_mechanism",
1725                     "fake_principal",
1726                     "fake_domain",
1727                     verify_ssl=True,
1728                 )
1729     def test_cached_service_instance_different_host(self):
1730         mock_si = MagicMock()
1731         mock_disconnect = MagicMock()
1732         mock_get_si = MagicMock(return_value=mock_si)
1733         mock_getstub = MagicMock()
1734         with patch("salt.utils.vmware.GetSi", mock_get_si):
1735             with patch("salt.utils.vmware.GetStub", mock_getstub):
1736                 with patch("salt.utils.vmware.Disconnect", mock_disconnect):
1737                     salt.utils.vmware.get_service_instance(
1738                         host="fake_host",
1739                         username="fake_username",
1740                         password="fake_password",
1741                         protocol="fake_protocol",
1742                         port=1,
1743                         mechanism="fake_mechanism",
1744                         principal="fake_principal",
1745                         domain="fake_domain",
1746                     )
1747             self.assertEqual(mock_get_si.call_count, 1)
1748             self.assertEqual(mock_getstub.call_count, 1)
1749             self.assertEqual(mock_disconnect.call_count, 1)
1750     def test_uncached_service_instance(self):
1751         mock_get_si = MagicMock()
1752         with patch("salt.utils.vmware._get_service_instance", mock_get_si):
1753             salt.utils.vmware.get_service_instance(
1754                 host="fake_host",
1755                 username="fake_username",
1756                 password="fake_password",
1757                 protocol="fake_protocol",
1758                 port=1,
1759                 mechanism="fake_mechanism",
1760                 principal="fake_principal",
1761                 domain="fake_domain",
1762                 verify_ssl=True,
1763             )
1764             mock_get_si.assert_called_once_with(
1765                 "fake_host",
1766                 "fake_username",
1767                 "fake_password",
1768                 "fake_protocol",
1769                 1,
1770                 "fake_mechanism",
1771                 "fake_principal",
1772                 "fake_domain",
1773                 verify_ssl=True,
1774             )
1775     def test_unauthenticated_service_instance(self):
1776         mock_si_current_time = MagicMock(side_effect=vim.fault.NotAuthenticated)
1777         mock_si = MagicMock()
1778         mock_get_si = MagicMock(return_value=mock_si)
1779         mock_si.CurrentTime = mock_si_current_time
1780         mock_disconnect = MagicMock()
1781         with patch("salt.utils.vmware._get_service_instance", mock_get_si):
1782             with patch("salt.utils.vmware.Disconnect", mock_disconnect):
1783                 salt.utils.vmware.get_service_instance(
1784                     host="fake_host",
1785                     username="fake_username",
1786                     password="fake_password",
1787                     protocol="fake_protocol",
1788                     port=1,
1789                     mechanism="fake_mechanism",
1790                     principal="fake_principal",
1791                     domain="fake_domain",
1792                 )
1793                 self.assertEqual(mock_si_current_time.call_count, 1)
1794                 self.assertEqual(mock_disconnect.call_count, 1)
1795                 self.assertEqual(mock_get_si.call_count, 2)
1796     def test_cached_unauthenticated_service_instance(self):
1797         mock_si_current_time = MagicMock(side_effect=vim.fault.NotAuthenticated)
1798         mock_si = MagicMock()
1799         mock_get_si = MagicMock(return_value=mock_si)
1800         mock_getsi = MagicMock(return_value=mock_si)
1801         mock_si.CurrentTime = mock_si_current_time
1802         mock_disconnect = MagicMock()
1803         with patch("salt.utils.vmware.GetSi", mock_getsi):
1804             with patch("salt.utils.vmware._get_service_instance", mock_get_si):
1805                 with patch("salt.utils.vmware.Disconnect", mock_disconnect):
1806                     salt.utils.vmware.get_service_instance(
1807                         host="fake_host",
1808                         username="fake_username",
1809                         password="fake_password",
1810                         protocol="fake_protocol",
1811                         port=1,
1812                         mechanism="fake_mechanism",
1813                         principal="fake_principal",
1814                         domain="fake_domain",
1815                     )
1816                     self.assertEqual(mock_si_current_time.call_count, 1)
1817                     self.assertEqual(mock_disconnect.call_count, 1)
1818                     self.assertEqual(mock_get_si.call_count, 1)
1819     def test_current_time_raise_no_permission(self):
1820         exc = vim.fault.NoPermission()
1821         exc.privilegeId = "Fake privilege"
1822         with patch(
1823             "salt.utils.vmware._get_service_instance",
1824             MagicMock(return_value=MagicMock(CurrentTime=MagicMock(side_effect=exc))),
1825         ):
1826             with self.assertRaises(VMwareApiError) as excinfo:
1827                 salt.utils.vmware.get_service_instance(
1828                     host="fake_host",
1829                     username="fake_username",
1830                     password="fake_password",
1831                     protocol="fake_protocol",
1832                     port=1,
1833                     mechanism="fake_mechanism",
1834                     principal="fake_principal",
1835                     domain="fake_domain",
1836                 )
1837         self.assertEqual(
1838             excinfo.exception.strerror,
1839             "Not enough permissions. Required privilege: Fake privilege",
1840         )
1841     def test_current_time_raise_vim_fault(self):
1842         exc = vim.fault.VimFault()
1843         exc.msg = "VimFault msg"
1844         with patch(
1845             "salt.utils.vmware._get_service_instance",
1846             MagicMock(return_value=MagicMock(CurrentTime=MagicMock(side_effect=exc))),
1847         ):
1848             with self.assertRaises(VMwareApiError) as excinfo:
1849                 salt.utils.vmware.get_service_instance(
1850                     host="fake_host",
1851                     username="fake_username",
1852                     password="fake_password",
1853                     protocol="fake_protocol",
1854                     port=1,
1855                     mechanism="fake_mechanism",
1856                     principal="fake_principal",
1857                     domain="fake_domain",
1858                 )
1859         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1860     def test_current_time_raise_runtime_fault(self):
1861         exc = vmodl.RuntimeFault()
1862         exc.msg = "RuntimeFault msg"
1863         with patch(
1864             "salt.utils.vmware._get_service_instance",
1865             MagicMock(return_value=MagicMock(CurrentTime=MagicMock(side_effect=exc))),
1866         ):
1867             with self.assertRaises(VMwareRuntimeError) as excinfo:
1868                 salt.utils.vmware.get_service_instance(
1869                     host="fake_host",
1870                     username="fake_username",
1871                     password="fake_password",
1872                     protocol="fake_protocol",
1873                     port=1,
1874                     mechanism="fake_mechanism",
1875                     principal="fake_principal",
1876                     domain="fake_domain",
1877                 )
1878         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1879 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1880 class DisconnectTestCase(TestCase):
1881     def setUp(self):
1882         self.mock_si = MagicMock()
1883         self.addCleanup(delattr, self, "mock_si")
1884     def test_disconnect(self):
1885         mock_disconnect = MagicMock()
1886         with patch("salt.utils.vmware.Disconnect", mock_disconnect):
1887             salt.utils.vmware.disconnect(service_instance=self.mock_si)
1888             mock_disconnect.assert_called_once_with(self.mock_si)
1889     def test_disconnect_raise_no_permission(self):
1890         exc = vim.fault.NoPermission()
1891         exc.privilegeId = "Fake privilege"
1892         with patch("salt.utils.vmware.Disconnect", MagicMock(side_effect=exc)):
1893             with self.assertRaises(VMwareApiError) as excinfo:
1894                 salt.utils.vmware.disconnect(service_instance=self.mock_si)
1895         self.assertEqual(
1896             excinfo.exception.strerror,
1897             "Not enough permissions. Required privilege: Fake privilege",
1898         )
1899     def test_disconnect_raise_vim_fault(self):
1900         exc = vim.fault.VimFault()
1901         exc.msg = "VimFault msg"
1902         with patch("salt.utils.vmware.Disconnect", MagicMock(side_effect=exc)):
1903             with self.assertRaises(VMwareApiError) as excinfo:
1904                 salt.utils.vmware.disconnect(service_instance=self.mock_si)
1905         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1906     def test_disconnect_raise_runtime_fault(self):
1907         exc = vmodl.RuntimeFault()
1908         exc.msg = "RuntimeFault msg"
1909         with patch("salt.utils.vmware.Disconnect", MagicMock(side_effect=exc)):
1910             with self.assertRaises(VMwareRuntimeError) as excinfo:
1911                 salt.utils.vmware.disconnect(service_instance=self.mock_si)
1912         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1913 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1914 class IsConnectionToAVCenterTestCase(TestCase):
1915     def test_api_type_raise_no_permission(self):
1916         exc = vim.fault.NoPermission()
1917         exc.privilegeId = "Fake privilege"
1918         mock_si = MagicMock()
1919         type(mock_si.content.about).apiType = PropertyMock(side_effect=exc)
1920         with self.assertRaises(VMwareApiError) as excinfo:
1921             salt.utils.vmware.is_connection_to_a_vcenter(mock_si)
1922         self.assertEqual(
1923             excinfo.exception.strerror,
1924             "Not enough permissions. Required privilege: Fake privilege",
1925         )
1926     def test_api_type_raise_vim_fault(self):
1927         exc = vim.fault.VimFault()
1928         exc.msg = "VimFault msg"
1929         mock_si = MagicMock()
1930         type(mock_si.content.about).apiType = PropertyMock(side_effect=exc)
1931         with self.assertRaises(VMwareApiError) as excinfo:
1932             salt.utils.vmware.is_connection_to_a_vcenter(mock_si)
1933         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1934     def test_api_type_raise_runtime_fault(self):
1935         exc = vmodl.RuntimeFault()
1936         exc.msg = "RuntimeFault msg"
1937         mock_si = MagicMock()
1938         type(mock_si.content.about).apiType = PropertyMock(side_effect=exc)
1939         with self.assertRaises(VMwareRuntimeError) as excinfo:
1940             salt.utils.vmware.is_connection_to_a_vcenter(mock_si)
1941         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1942     def test_connected_to_a_vcenter(self):
1943         mock_si = MagicMock()
1944         mock_si.content.about.apiType = "VirtualCenter"
1945         ret = salt.utils.vmware.is_connection_to_a_vcenter(mock_si)
1946         self.assertTrue(ret)
1947     def test_connected_to_a_host(self):
1948         mock_si = MagicMock()
1949         mock_si.content.about.apiType = "HostAgent"
1950         ret = salt.utils.vmware.is_connection_to_a_vcenter(mock_si)
1951         self.assertFalse(ret)
1952     def test_connected_to_invalid_entity(self):
1953         mock_si = MagicMock()
1954         mock_si.content.about.apiType = "UnsupportedType"
1955         with self.assertRaises(VMwareApiError) as excinfo:
1956             salt.utils.vmware.is_connection_to_a_vcenter(mock_si)
1957         self.assertIn(
1958             "Unexpected api type 'UnsupportedType'", excinfo.exception.strerror
1959         )
1960 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1961 class GetNewServiceInstanceStub(TestCase, LoaderModuleMockMixin):
1962     def setup_loader_modules(self):
1963         return {salt.utils.vmware: {"sys": MagicMock(), "ssl": MagicMock()}}
1964     def setUp(self):
1965         self.mock_stub = MagicMock(host="fake_host:1000", cookie='ignore"fake_cookie')
1966         self.mock_si = MagicMock(_stub=self.mock_stub)
1967         self.mock_ret = MagicMock()
1968         self.mock_new_stub = MagicMock()
1969         self.context_dict = {}
1970         patches = (
1971             (
1972                 "salt.utils.vmware.VmomiSupport.GetRequestContext",
1973                 MagicMock(return_value=self.context_dict),
1974             ),
1975             (
1976                 "salt.utils.vmware.SoapStubAdapter",
1977                 MagicMock(return_value=self.mock_new_stub),
1978             ),
1979         )
1980         for mod, mock in patches:
1981             patcher = patch(mod, mock)
1982             patcher.start()
1983             self.addCleanup(patcher.stop)
1984         self.mock_context = MagicMock()
1985         self.mock_create_default_context = MagicMock(return_value=self.mock_context)
1986         salt.utils.vmware.ssl.create_default_context = self.mock_create_default_context
1987     def tearDown(self):
1988         for attr in (
1989             "mock_stub",
1990             "mock_si",
1991             "mock_ret",
1992             "mock_new_stub",
1993             "context_dict",
1994             "mock_context",
1995             "mock_create_default_context",
1996         ):
1997             delattr(self, attr)
1998     def test_ssl_default_context_loaded(self):
1999         salt.utils.vmware.get_new_service_instance_stub(self.mock_si, "fake_path")
2000         self.mock_create_default_context.assert_called_once_with()
2001         self.assertFalse(self.mock_context.check_hostname)
2002         self.assertEqual(self.mock_context.verify_mode, salt.utils.vmware.ssl.CERT_NONE)
2003     def test_session_cookie_in_context(self):
2004         salt.utils.vmware.get_new_service_instance_stub(self.mock_si, "fake_path")
2005         self.assertEqual(self.context_dict["vcSessionCookie"], "fake_cookie")
2006     def test_get_new_stub(self):
2007         mock_get_new_stub = MagicMock()
2008         with patch("salt.utils.vmware.SoapStubAdapter", mock_get_new_stub):
2009             salt.utils.vmware.get_new_service_instance_stub(
2010                 self.mock_si, "fake_path", "fake_ns", "fake_version"
2011             )
2012         mock_get_new_stub.assert_called_once_with(
2013             host="fake_host",
2014             ns="fake_ns",
2015             path="fake_path",
2016             version="fake_version",
2017             poolSize=0,
2018             sslContext=self.mock_context,
2019         )
2020     def test_new_stub_returned(self):
2021         ret = salt.utils.vmware.get_new_service_instance_stub(self.mock_si, "fake_path")
2022         self.assertEqual(self.mock_new_stub.cookie, 'ignore"fake_cookie')
2023         self.assertEqual(ret, self.mock_new_stub)
2024 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2025 class GetServiceInstanceFromManagedObjectTestCase(TestCase):
2026     def setUp(self):
2027         patches = (("salt.utils.vmware.vim.ServiceInstance", MagicMock()),)
2028         for mod, mock in patches:
2029             patcher = patch(mod, mock)
2030             patcher.start()
2031             self.addCleanup(patcher.stop)
2032         self.mock_si = MagicMock()
2033         self.mock_stub = PropertyMock()
2034         self.mock_mo_ref = MagicMock(_stub=self.mock_stub)
2035         for attr in ("mock_si", "mock_stub", "mock_mo_ref"):
2036             self.addCleanup(delattr, self, attr)
2037     def test_default_name_parameter(self):
2038         mock_trace = MagicMock()
2039         type(salt.utils.vmware.log).trace = mock_trace
2040         salt.utils.vmware.get_service_instance_from_managed_object(self.mock_mo_ref)
2041         mock_trace.assert_called_once_with(
2042             "[%s] Retrieving service instance from managed object", "&lt;unnamed&gt;"
2043         )
2044     def test_name_parameter_passed_in(self):
2045         mock_trace = MagicMock()
2046         type(salt.utils.vmware.log).trace = mock_trace
2047         salt.utils.vmware.get_service_instance_from_managed_object(
2048             self.mock_mo_ref, "fake_mo_name"
2049         )
2050         mock_trace.assert_called_once_with(
2051             "[%s] Retrieving service instance from managed object", "fake_mo_name"
2052         )
2053     def test_service_instance_instantiation(self):
2054         mock_service_instance_ini = MagicMock()
2055         with patch("salt.utils.vmware.vim.ServiceInstance", mock_service_instance_ini):
2056             salt.utils.vmware.get_service_instance_from_managed_object(self.mock_mo_ref)
2057         mock_service_instance_ini.assert_called_once_with("ServiceInstance")
2058     def test_si_return_and_stub_assignment(self):
2059         with patch(
2060             "salt.utils.vmware.vim.ServiceInstance",
2061             MagicMock(return_value=self.mock_si),
2062         ):
2063             ret = salt.utils.vmware.get_service_instance_from_managed_object(
2064                 self.mock_mo_ref
2065             )
2066         self.assertEqual(ret, self.mock_si)
2067         self.assertEqual(ret._stub, self.mock_stub)
2068 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2069 class GetDatacentersTestCase(TestCase):
2070     def setUp(self):
2071         patches = (
2072             (
2073                 "salt.utils.vmware.get_mors_with_properties",
2074                 MagicMock(return_value=[{"name": "fake_dc", "object": MagicMock()}]),
2075             ),
2076         )
2077         for mod, mock in patches:
2078             patcher = patch(mod, mock)
2079             patcher.start()
2080             self.addCleanup(patcher.stop)
2081         self.mock_si = MagicMock()
2082         self.mock_dc1 = MagicMock()
2083         self.mock_dc2 = MagicMock()
2084         self.mock_entries = [
2085             {"name": "fake_dc1", "object": self.mock_dc1},
2086             {"name": "fake_dc2", "object": self.mock_dc2},
2087         ]
2088     def test_get_mors_with_properties_call(self):
2089         mock_get_mors_with_properties = MagicMock(
2090             return_value=[{"name": "fake_dc", "object": MagicMock()}]
2091         )
2092         with patch(
2093             "salt.utils.vmware.get_mors_with_properties", mock_get_mors_with_properties
2094         ):
2095             salt.utils.vmware.get_datacenters(
2096                 self.mock_si, datacenter_names=["fake_dc1"]
2097             )
2098         mock_get_mors_with_properties.assert_called_once_with(
2099             self.mock_si, vim.Datacenter, property_list=["name"]
2100         )
2101     def test_get_mors_with_properties_returns_empty_array(self):
2102         with patch(
2103             "salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])
2104         ):
2105             res = salt.utils.vmware.get_datacenters(
2106                 self.mock_si, datacenter_names=["fake_dc1"]
2107             )
2108         self.assertEqual(res, [])
2109     def test_no_parameters(self):
2110         with patch(
2111             "salt.utils.vmware.get_mors_with_properties",
2112             MagicMock(return_value=self.mock_entries),
2113         ):
2114             res = salt.utils.vmware.get_datacenters(self.mock_si)
2115         self.assertEqual(res, [])
2116     def test_datastore_not_found(self):
2117         with patch(
2118             "salt.utils.vmware.get_mors_with_properties",
2119             MagicMock(return_value=self.mock_entries),
2120         ):
2121             res = salt.utils.vmware.get_datacenters(
2122                 self.mock_si, datacenter_names=["fake_dc"]
2123             )
2124         self.assertEqual(res, [])
2125     def test_datastore_found(self):
2126         with patch(
2127             "salt.utils.vmware.get_mors_with_properties",
2128             MagicMock(return_value=self.mock_entries),
2129         ):
2130             res = salt.utils.vmware.get_datacenters(
2131                 self.mock_si, datacenter_names=["fake_dc2"]
2132             )
2133         self.assertEqual(res, [self.mock_dc2])
2134     def test_get_all_datastores(self):
2135         with patch(
2136             "salt.utils.vmware.get_mors_with_properties",
2137             MagicMock(return_value=self.mock_entries),
2138         ):
2139             res = salt.utils.vmware.get_datacenters(
2140                 self.mock_si, get_all_datacenters=True
2141             )
2142         self.assertEqual(res, [self.mock_dc1, self.mock_dc2])
2143 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2144 class GetDatacenterTestCase(TestCase):
2145     def setUp(self):
2146         patches = (
2147             (
2148                 "salt.utils.vmware.get_datacenters",
2149                 MagicMock(return_value=[MagicMock()]),
2150             ),
2151         )
2152         for mod, mock in patches:
2153             patcher = patch(mod, mock)
2154             patcher.start()
2155             self.addCleanup(patcher.stop)
2156         self.mock_si = MagicMock()
2157         self.mock_dc = MagicMock()
2158     def test_get_datacenters_call(self):
2159         mock_get_datacenters = MagicMock(return_value=[MagicMock()])
2160         with patch("salt.utils.vmware.get_datacenters", mock_get_datacenters):
2161             salt.utils.vmware.get_datacenter(self.mock_si, "fake_dc1")
2162         mock_get_datacenters.assert_called_once_with(
2163             self.mock_si, datacenter_names=["fake_dc1"]
2164         )
2165     def test_no_datacenters_returned(self):
2166         with patch("salt.utils.vmware.get_datacenters", MagicMock(return_value=[])):
2167             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
2168                 salt.utils.vmware.get_datacenter(self.mock_si, "fake_dc1")
2169         self.assertEqual(
2170             "Datacenter 'fake_dc1' was not found", excinfo.exception.strerror
2171         )
2172     def test_get_datacenter_return(self):
2173         with patch(
2174             "salt.utils.vmware.get_datacenters", MagicMock(return_value=[self.mock_dc])
2175         ):
2176             res = salt.utils.vmware.get_datacenter(self.mock_si, "fake_dc1")
2177         self.assertEqual(res, self.mock_dc)
2178 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2179 class CreateDatacenterTestCase(TestCase):
2180     def setUp(self):
2181         patches = (("salt.utils.vmware.get_root_folder", MagicMock()),)
2182         for mod, mock in patches:
2183             patcher = patch(mod, mock)
2184             patcher.start()
2185             self.addCleanup(patcher.stop)
2186         self.mock_si = MagicMock()
2187         self.mock_dc = MagicMock()
2188         self.mock_create_datacenter = MagicMock(return_value=self.mock_dc)
2189         self.mock_root_folder = MagicMock(CreateDatacenter=self.mock_create_datacenter)
2190     def test_get_root_folder(self):
2191         mock_get_root_folder = MagicMock()
2192         with patch("salt.utils.vmware.get_root_folder", mock_get_root_folder):
2193             salt.utils.vmware.create_datacenter(self.mock_si, "fake_dc")
2194         mock_get_root_folder.assert_called_once_with(self.mock_si)
2195     def test_create_datacenter_call(self):
2196         with patch(
2197             "salt.utils.vmware.get_root_folder",
2198             MagicMock(return_value=self.mock_root_folder),
2199         ):
2200             salt.utils.vmware.create_datacenter(self.mock_si, "fake_dc")
2201         self.mock_create_datacenter.assert_called_once_with("fake_dc")
2202     def test_create_datacenter_raise_no_permission(self):
2203         exc = vim.fault.NoPermission()
2204         exc.privilegeId = "Fake privilege"
2205         self.mock_root_folder = MagicMock(CreateDatacenter=MagicMock(side_effect=exc))
2206         with patch(
2207             "salt.utils.vmware.get_root_folder",
2208             MagicMock(return_value=self.mock_root_folder),
2209         ):
2210             with self.assertRaises(VMwareApiError) as excinfo:
2211                 salt.utils.vmware.create_datacenter(self.mock_si, "fake_dc")
2212         self.assertEqual(
2213             excinfo.exception.strerror,
2214             "Not enough permissions. Required privilege: Fake privilege",
2215         )
2216     def test_create_datacenter_raise_vim_fault(self):
2217         exc = vim.VimFault()
2218         exc.msg = "VimFault msg"
2219         self.mock_root_folder = MagicMock(CreateDatacenter=MagicMock(side_effect=exc))
2220         with patch(
2221             "salt.utils.vmware.get_root_folder",
2222             MagicMock(return_value=self.mock_root_folder),
2223         ):
2224             with self.assertRaises(VMwareApiError) as excinfo:
2225                 salt.utils.vmware.create_datacenter(self.mock_si, "fake_dc")
2226         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
2227     def test_create_datacenter_runtime_fault(self):
2228         exc = vmodl.RuntimeFault()
2229         exc.msg = "RuntimeFault msg"
2230         self.mock_root_folder = MagicMock(CreateDatacenter=MagicMock(side_effect=exc))
2231         with patch(
2232             "salt.utils.vmware.get_root_folder",
2233             MagicMock(return_value=self.mock_root_folder),
2234         ):
2235             with self.assertRaises(VMwareRuntimeError) as excinfo:
2236                 salt.utils.vmware.create_datacenter(self.mock_si, "fake_dc")
2237         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
2238     def test_datastore_successfully_created(self):
2239         with patch(
2240             "salt.utils.vmware.get_root_folder",
2241             MagicMock(return_value=self.mock_root_folder),
2242         ):
2243             res = salt.utils.vmware.create_datacenter(self.mock_si, "fake_dc")
2244         self.assertEqual(res, self.mock_dc)
2245 class FakeTaskClass:
2246     pass
2247 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2248 class GetDvssTestCase(TestCase):
2249     def setUp(self):
2250         self.mock_si = MagicMock()
2251         self.mock_dc_ref = MagicMock()
2252         self.mock_traversal_spec = MagicMock()
2253         self.mock_items = [
2254             {"object": MagicMock(), "name": "fake_dvs1"},
2255             {"object": MagicMock(), "name": "fake_dvs2"},
2256             {"object": MagicMock(), "name": "fake_dvs3"},
2257         ]
2258         self.mock_get_mors = MagicMock(return_value=self.mock_items)
2259         patches = (
2260             ("salt.utils.vmware.get_managed_object_name", MagicMock()),
2261             ("salt.utils.vmware.get_mors_with_properties", self.mock_get_mors),
2262             (
2263                 "salt.utils.vmware.get_service_instance_from_managed_object",
2264                 MagicMock(return_value=self.mock_si),
2265             ),
2266             (
2267                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2268                 MagicMock(return_value=self.mock_traversal_spec),
2269             ),
2270         )
2271         for mod, mock in patches:
2272             patcher = patch(mod, mock)
2273             patcher.start()
2274             self.addCleanup(patcher.stop)
2275     def tearDown(self):
2276         for attr in (
2277             "mock_si",
2278             "mock_dc_ref",
2279             "mock_traversal_spec",
2280             "mock_items",
2281             "mock_get_mors",
2282         ):
2283             delattr(self, attr)
2284     def test_get_managed_object_name_call(self):
2285         mock_get_managed_object_name = MagicMock()
2286         with patch(
2287             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2288         ):
2289             salt.utils.vmware.get_dvss(self.mock_dc_ref)
2290         mock_get_managed_object_name.assert_called_once_with(self.mock_dc_ref)
2291     def test_traversal_spec(self):
2292         mock_traversal_spec = MagicMock(return_value="traversal_spec")
2293         with patch(
2294             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2295             mock_traversal_spec,
2296         ):
2297             salt.utils.vmware.get_dvss(self.mock_dc_ref)
2298         mock_traversal_spec.assert_has_calls(
2299             [
2300                 call(path="childEntity", skip=False, type=vim.Folder),
2301                 call(
2302                     path="networkFolder",
2303                     skip=True,
2304                     type=vim.Datacenter,
2305                     selectSet=["traversal_spec"],
2306                 ),
2307             ]
2308         )
2309     def test_get_mors_with_properties(self):
2310         salt.utils.vmware.get_dvss(self.mock_dc_ref)
2311         self.mock_get_mors.assert_called_once_with(
2312             self.mock_si,
2313             vim.DistributedVirtualSwitch,
2314             container_ref=self.mock_dc_ref,
2315             property_list=["name"],
2316             traversal_spec=self.mock_traversal_spec,
2317         )
2318     def test_get_no_dvss(self):
2319         ret = salt.utils.vmware.get_dvss(self.mock_dc_ref)
2320         self.assertEqual(ret, [])
2321     def test_get_all_dvss(self):
2322         ret = salt.utils.vmware.get_dvss(self.mock_dc_ref, get_all_dvss=True)
2323         self.assertEqual(ret, [i["object"] for i in self.mock_items])
2324     def test_filtered_all_dvss(self):
2325         ret = salt.utils.vmware.get_dvss(
2326             self.mock_dc_ref, dvs_names=["fake_dvs1", "fake_dvs3", "no_dvs"]
2327         )
2328         self.assertEqual(
2329             ret, [self.mock_items[0]["object"], self.mock_items[2]["object"]]
2330         )
2331 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2332 class GetNetworkFolderTestCase(TestCase):
2333     def setUp(self):
2334         self.mock_si = MagicMock()
2335         self.mock_dc_ref = MagicMock()
2336         self.mock_traversal_spec = MagicMock()
2337         self.mock_get_mors = MagicMock(return_value=self.mock_entries)
2338         patches <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= (
2339             (
2340                 "salt.utils.vmware.get_managed_object_name",
2341                 MagicMock(return_value="fake_dc"),
2342             ),
2343             (
2344                 "salt.utils.vmware.get_service_instance_from_managed_object",
2345                 MagicMock(return_value=self.mock_si),
2346             ),
2347             (
2348                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2349                 MagicMock(return_value=self.</b></font>mock_traversal_spec),
2350             ),
2351             ("salt.utils.vmware.get_mors_with_properties", self.mock_get_mors),
2352         )
2353         for mod, mock in patches:
2354             patcher = patch(mod, mock)
2355             patcher.start()
2356             self.addCleanup(patcher.stop)
2357     def tearDown(self):
2358         for attr in (
2359             "mock_si",
2360             "mock_dc_ref",
2361             "mock_traversal_spec",
2362             "mock_entries",
2363             "mock_get_mors",
2364         ):
2365             delattr(self, attr)
2366     def test_get_managed_object_name_call(self):
2367         mock_get_managed_object_name = MagicMock()
2368         with patch(
2369             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2370         ):
2371             salt.utils.vmware.get_network_folder(self.mock_dc_ref)
2372         mock_get_managed_object_name.assert_called_once_with(self.mock_dc_ref)
2373     def test_traversal_spec(self):
2374         mock_traversal_spec = MagicMock(return_value="traversal_spec")
2375         with patch(
2376             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2377             mock_traversal_spec,
2378         ):
2379             salt.utils.vmware.get_network_folder(self.mock_dc_ref)
2380         mock_traversal_spec.assert_called_once_with(
2381             path="networkFolder", skip=False, type=vim.Datacenter
2382         )
2383     def test_get_mors_with_properties(self):
2384         salt.utils.vmware.get_network_folder(self.mock_dc_ref)
2385         self.mock_get_mors.assert_called_once_with(
2386             self.mock_si,
2387             vim.Folder,
2388             container_ref=self.mock_dc_ref,
2389             property_list=["name"],
2390             traversal_spec=self.mock_traversal_spec,
2391         )
2392     def test_get_no_network_folder(self):
2393         with patch(
2394             "salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])
2395         ):
2396             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
2397                 salt.utils.vmware.get_network_folder(self.mock_dc_ref)
2398         self.assertEqual(
2399             excinfo.exception.strerror,
2400             "Network folder in datacenter 'fake_dc' wasn't retrieved",
2401         )
2402     def test_get_network_folder(self):
2403         ret = salt.utils.vmware.get_network_folder(self.mock_dc_ref)
2404         self.assertEqual(ret, self.mock_entries[0]["object"])
2405 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2406 class CreateDvsTestCase(TestCase):
2407     def setUp(self):
2408         self.mock_dc_ref = MagicMock()
2409         self.mock_dvs_create_spec = MagicMock()
2410         self.mock_task = MagicMock(spec=FakeTaskClass)
2411         self.mock_netw_folder = MagicMock(
2412             CreateDVS_Task=MagicMock(return_value=self.mock_task)
2413         )
2414         self.mock_wait_for_task = MagicMock()
2415         patches = (
2416             (
2417                 "salt.utils.vmware.get_managed_object_name",
2418                 MagicMock(return_value="fake_dc"),
2419             ),
2420             (
2421                 "salt.utils.vmware.get_network_folder",
2422                 MagicMock(return_value=self.mock_netw_folder),
2423             ),
2424             ("salt.utils.vmware.wait_for_task", self.mock_wait_for_task),
2425         )
2426         for mod, mock in patches:
2427             patcher = patch(mod, mock)
2428             patcher.start()
2429             self.addCleanup(patcher.stop)
2430     def tearDown(self):
2431         for attr in (
2432             "mock_dc_ref",
2433             "mock_dvs_create_spec",
2434             "mock_task",
2435             "mock_netw_folder",
2436             "mock_wait_for_task",
2437         ):
2438             delattr(self, attr)
2439     def test_get_managed_object_name_call(self):
2440         mock_get_managed_object_name = MagicMock()
2441         with patch(
2442             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2443         ):
2444             salt.utils.vmware.create_dvs(self.mock_dc_ref, "fake_dvs")
2445         mock_get_managed_object_name.assert_called_once_with(self.mock_dc_ref)
2446     def test_no_dvs_create_spec(self):
2447         mock_spec = MagicMock(configSpec=None)
2448         mock_config_spec = MagicMock()
2449         mock_dvs_create_spec = MagicMock(return_value=mock_spec)
2450         mock_vmware_dvs_config_spec = MagicMock(return_value=mock_config_spec)
2451         with patch("salt.utils.vmware.vim.DVSCreateSpec", mock_dvs_create_spec):
2452             with patch(
2453                 "salt.utils.vmware.vim.VMwareDVSConfigSpec", mock_vmware_dvs_config_spec
2454             ):
2455                 salt.utils.vmware.create_dvs(self.mock_dc_ref, "fake_dvs")
2456         mock_dvs_create_spec.assert_called_once_with()
2457         mock_vmware_dvs_config_spec.assert_called_once_with()
2458         self.assertEqual(mock_spec.configSpec, mock_config_spec)
2459         self.assertEqual(mock_config_spec.name, "fake_dvs")
2460         self.mock_netw_folder.CreateDVS_Task.assert_called_once_with(mock_spec)
2461     def test_get_network_folder(self):
2462         mock_get_network_folder = MagicMock()
2463         with patch("salt.utils.vmware.get_network_folder", mock_get_network_folder):
2464             salt.utils.vmware.create_dvs(self.mock_dc_ref, "fake_dvs")
2465         mock_get_network_folder.assert_called_once_with(self.mock_dc_ref)
2466     def test_create_dvs_task_passed_in_spec(self):
2467         salt.utils.vmware.create_dvs(
2468             self.mock_dc_ref, "fake_dvs", dvs_create_spec=self.mock_dvs_create_spec
2469         )
2470         self.mock_netw_folder.CreateDVS_Task.assert_called_once_with(
2471             self.mock_dvs_create_spec
2472         )
2473     def test_create_dvs_task_raises_no_permission(self):
2474         exc = vim.fault.NoPermission()
2475         exc.privilegeId = "Fake privilege"
2476         self.mock_netw_folder.CreateDVS_Task = MagicMock(side_effect=exc)
2477         with self.assertRaises(VMwareApiError) as excinfo:
2478             salt.utils.vmware.create_dvs(
2479                 self.mock_dc_ref, "fake_dvs", dvs_create_spec=self.mock_dvs_create_spec
2480             )
2481         self.assertEqual(
2482             excinfo.exception.strerror,
2483             "Not enough permissions. Required privilege: Fake privilege",
2484         )
2485     def test_create_dvs_task_raises_vim_fault(self):
2486         exc = vim.fault.VimFault()
2487         exc.msg = "VimFault msg"
2488         self.mock_netw_folder.CreateDVS_Task = MagicMock(side_effect=exc)
2489         with self.assertRaises(VMwareApiError) as excinfo:
2490             salt.utils.vmware.create_dvs(
2491                 self.mock_dc_ref, "fake_dvs", dvs_create_spec=self.mock_dvs_create_spec
2492             )
2493         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
2494     def test_create_dvs_task_raises_runtime_fault(self):
2495         exc = vmodl.RuntimeFault()
2496         exc.msg = "RuntimeFault msg"
2497         self.mock_netw_folder.CreateDVS_Task = MagicMock(side_effect=exc)
2498         with self.assertRaises(VMwareRuntimeError) as excinfo:
2499             salt.utils.vmware.create_dvs(
2500                 self.mock_dc_ref, "fake_dvs", dvs_create_spec=self.mock_dvs_create_spec
2501             )
2502         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
2503     def test_wait_for_tasks(self):
2504         salt.utils.vmware.create_dvs(
2505             self.mock_dc_ref, "fake_dvs", dvs_create_spec=self.mock_dvs_create_spec
2506         )
2507         self.mock_wait_for_task.assert_called_once_with(
2508             self.mock_task,
2509             "fake_dvs",
2510             "&lt;class 'tests.unit.utils.test_vmware.FakeTaskClass'&gt;",
2511         )
2512 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2513 class UpdateDvsTestCase(TestCase):
2514     def setUp(self):
2515         self.mock_task = MagicMock(spec=FakeTaskClass)
2516         self.mock_dvs_ref = MagicMock(
2517             ReconfigureDvs_Task=MagicMock(return_value=self.mock_task)
2518         )
2519         self.mock_dvs_spec = MagicMock()
2520         self.mock_wait_for_task = MagicMock()
2521         patches = (
2522             (
2523                 "salt.utils.vmware.get_managed_object_name",
2524                 MagicMock(return_value="fake_dvs"),
2525             ),
2526             ("salt.utils.vmware.wait_for_task", self.mock_wait_for_task),
2527         )
2528         for mod, mock in patches:
2529             patcher = patch(mod, mock)
2530             patcher.start()
2531             self.addCleanup(patcher.stop)
2532     def tearDown(self):
2533         for attr in (
2534             "mock_dvs_ref",
2535             "mock_task",
2536             "mock_dvs_spec",
2537             "mock_wait_for_task",
2538         ):
2539             delattr(self, attr)
2540     def test_get_managed_object_name_call(self):
2541         mock_get_managed_object_name = MagicMock()
2542         with patch(
2543             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2544         ):
2545             salt.utils.vmware.update_dvs(self.mock_dvs_ref, self.mock_dvs_spec)
2546         mock_get_managed_object_name.assert_called_once_with(self.mock_dvs_ref)
2547     def test_reconfigure_dvs_task(self):
2548         salt.utils.vmware.update_dvs(self.mock_dvs_ref, self.mock_dvs_spec)
2549         self.mock_dvs_ref.ReconfigureDvs_Task.assert_called_once_with(
2550             self.mock_dvs_spec
2551         )
2552     def test_reconfigure_dvs_task_raises_no_permission(self):
2553         exc = vim.fault.NoPermission()
2554         exc.privilegeId = "Fake privilege"
2555         self.mock_dvs_ref.ReconfigureDvs_Task = MagicMock(side_effect=exc)
2556         with self.assertRaises(VMwareApiError) as excinfo:
2557             salt.utils.vmware.update_dvs(self.mock_dvs_ref, self.mock_dvs_spec)
2558         self.assertEqual(
2559             excinfo.exception.strerror,
2560             "Not enough permissions. Required privilege: Fake privilege",
2561         )
2562     def test_reconfigure_dvs_task_raises_vim_fault(self):
2563         exc = vim.fault.VimFault()
2564         exc.msg = "VimFault msg"
2565         self.mock_dvs_ref.ReconfigureDvs_Task = MagicMock(side_effect=exc)
2566         with self.assertRaises(VMwareApiError) as excinfo:
2567             salt.utils.vmware.update_dvs(self.mock_dvs_ref, self.mock_dvs_spec)
2568         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
2569     def test_reconfigure_dvs_task_raises_runtime_fault(self):
2570         exc = vmodl.RuntimeFault()
2571         exc.msg = "RuntimeFault msg"
2572         self.mock_dvs_ref.ReconfigureDvs_Task = MagicMock(side_effect=exc)
2573         with self.assertRaises(VMwareRuntimeError) as excinfo:
2574             salt.utils.vmware.update_dvs(self.mock_dvs_ref, self.mock_dvs_spec)
2575         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
2576     def test_wait_for_tasks(self):
2577         salt.utils.vmware.update_dvs(self.mock_dvs_ref, self.mock_dvs_spec)
2578         self.mock_wait_for_task.assert_called_once_with(
2579             self.mock_task,
2580             "fake_dvs",
2581             "&lt;class 'tests.unit.utils.test_vmware.FakeTaskClass'&gt;",
2582         )
2583 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2584 class SetDvsNetworkResourceManagementEnabledTestCase(TestCase):
2585     def setUp(self):
2586         self.mock_enabled = MagicMock()
2587         self.mock_dvs_ref = MagicMock(EnableNetworkResourceManagement=MagicMock())
2588         patches = (
2589             (
2590                 "salt.utils.vmware.get_managed_object_name",
2591                 MagicMock(return_value="fake_dvs"),
2592             ),
2593         )
2594         for mod, mock in patches:
2595             patcher = patch(mod, mock)
2596             patcher.start()
2597             self.addCleanup(patcher.stop)
2598     def tearDown(self):
2599         for attr in ("mock_dvs_ref", "mock_enabled"):
2600             delattr(self, attr)
2601     def test_get_managed_object_name_call(self):
2602         mock_get_managed_object_name = MagicMock()
2603         with patch(
2604             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2605         ):
2606             salt.utils.vmware.set_dvs_network_resource_management_enabled(
2607                 self.mock_dvs_ref, self.mock_enabled
2608             )
2609         mock_get_managed_object_name.assert_called_once_with(self.mock_dvs_ref)
2610     def test_enable_network_resource_management(self):
2611         salt.utils.vmware.set_dvs_network_resource_management_enabled(
2612             self.mock_dvs_ref, self.mock_enabled
2613         )
2614         self.mock_dvs_ref.EnableNetworkResourceManagement.assert_called_once_with(
2615             enable=self.mock_enabled
2616         )
2617     def test_enable_network_resource_management_raises_no_permission(self):
2618         exc = vim.fault.NoPermission()
2619         exc.privilegeId = "Fake privilege"
2620         self.mock_dvs_ref.EnableNetworkResourceManagement = MagicMock(side_effect=exc)
2621         with self.assertRaises(VMwareApiError) as excinfo:
2622             salt.utils.vmware.set_dvs_network_resource_management_enabled(
2623                 self.mock_dvs_ref, self.mock_enabled
2624             )
2625         self.assertEqual(
2626             excinfo.exception.strerror,
2627             "Not enough permissions. Required privilege: Fake privilege",
2628         )
2629     def test_enable_network_resource_management_raises_vim_fault(self):
2630         exc = vim.fault.VimFault()
2631         exc.msg = "VimFault msg"
2632         self.mock_dvs_ref.EnableNetworkResourceManagement = MagicMock(side_effect=exc)
2633         with self.assertRaises(VMwareApiError) as excinfo:
2634             salt.utils.vmware.set_dvs_network_resource_management_enabled(
2635                 self.mock_dvs_ref, self.mock_enabled
2636             )
2637     def test_enable_network_resource_management_raises_runtime_fault(self):
2638         exc = vmodl.RuntimeFault()
2639         exc.msg = "RuntimeFault msg"
2640         self.mock_dvs_ref.EnableNetworkResourceManagement = MagicMock(side_effect=exc)
2641         with self.assertRaises(VMwareRuntimeError) as excinfo:
2642             salt.utils.vmware.set_dvs_network_resource_management_enabled(
2643                 self.mock_dvs_ref, self.mock_enabled
2644             )
2645         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
2646 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2647 class GetDvportgroupsTestCase(TestCase):
2648     def setUp(self):
2649         self.mock_si = MagicMock()
2650         self.mock_dc_ref = MagicMock(spec=vim.Datacenter)
2651         self.mock_dvs_ref = MagicMock(spec=vim.DistributedVirtualSwitch)
2652         self.mock_traversal_spec = MagicMock()
2653         self.mock_items = [
2654             {"object": MagicMock(), "name": "fake_pg1"},
2655             {"object": MagicMock(), "name": "fake_pg2"},
2656             {"object": MagicMock(), "name": "fake_pg3"},
2657         ]
2658         self.mock_get_mors = MagicMock(return_value=self.mock_items)
2659         patches = (
2660             ("salt.utils.vmware.get_managed_object_name", MagicMock()),
2661             ("salt.utils.vmware.get_mors_with_properties", self.mock_get_mors),
2662             (
2663                 "salt.utils.vmware.get_service_instance_from_managed_object",
2664                 MagicMock(return_value=self.mock_si),
2665             ),
2666             (
2667                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2668                 MagicMock(return_value=self.mock_traversal_spec),
2669             ),
2670         )
2671         for mod, mock in patches:
2672             patcher = patch(mod, mock)
2673             patcher.start()
2674             self.addCleanup(patcher.stop)
2675     def tearDown(self):
2676         for attr in (
2677             "mock_si",
2678             "mock_dc_ref",
2679             "mock_dvs_ref",
2680             "mock_traversal_spec",
2681             "mock_items",
2682             "mock_get_mors",
2683         ):
2684             delattr(self, attr)
2685     def test_unsupported_parrent(self):
2686         with self.assertRaises(ArgumentValueError) as excinfo:
2687             salt.utils.vmware.get_dvportgroups(MagicMock())
2688         self.assertEqual(
2689             excinfo.exception.strerror,
2690             "Parent has to be either a datacenter, or a distributed virtual switch",
2691         )
2692     def test_get_managed_object_name_call(self):
2693         mock_get_managed_object_name = MagicMock()
2694         with patch(
2695             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2696         ):
2697             salt.utils.vmware.get_dvportgroups(self.mock_dc_ref)
2698         mock_get_managed_object_name.assert_called_once_with(self.mock_dc_ref)
2699     def test_traversal_spec_datacenter_parent(self):
2700         mock_traversal_spec = MagicMock(return_value="traversal_spec")
2701         with patch(
2702             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2703             mock_traversal_spec,
2704         ):
2705             salt.utils.vmware.get_dvportgroups(self.mock_dc_ref)
2706         mock_traversal_spec.assert_has_calls(
2707             [
2708                 call(path="childEntity", skip=False, type=vim.Folder),
2709                 call(
2710                     path="networkFolder",
2711                     skip=True,
2712                     type=vim.Datacenter,
2713                     selectSet=["traversal_spec"],
2714                 ),
2715             ]
2716         )
2717     def test_traversal_spec_dvs_parent(self):
2718         mock_traversal_spec = MagicMock(return_value="traversal_spec")
2719         with patch(
2720             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2721             mock_traversal_spec,
2722         ):
2723             salt.utils.vmware.get_dvportgroups(self.mock_dvs_ref)
2724         mock_traversal_spec.assert_called_once_with(
2725             path="portgroup", skip=False, type=vim.DistributedVirtualSwitch
2726         )
2727     def test_get_mors_with_properties(self):
2728         salt.utils.vmware.get_dvportgroups(self.mock_dvs_ref)
2729         self.mock_get_mors.assert_called_once_with(
2730             self.mock_si,
2731             vim.DistributedVirtualPortgroup,
2732             container_ref=self.mock_dvs_ref,
2733             property_list=["name"],
2734             traversal_spec=self.mock_traversal_spec,
2735         )
2736     def test_get_no_pgs(self):
2737         ret = salt.utils.vmware.get_dvportgroups(self.mock_dvs_ref)
2738         self.assertEqual(ret, [])
2739     def test_get_all_pgs(self):
2740         ret = salt.utils.vmware.get_dvportgroups(
2741             self.mock_dvs_ref, get_all_portgroups=True
2742         )
2743         self.assertEqual(ret, [i["object"] for i in self.mock_items])
2744     def test_filtered_pgs(self):
2745         ret = salt.utils.vmware.get_dvss(
2746             self.mock_dc_ref, dvs_names=["fake_pg1", "fake_pg3", "no_pg"]
2747         )
2748         self.assertEqual(
2749             ret, [self.mock_items[0]["object"], self.mock_items[2]["object"]]
2750         )
2751 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2752 class GetUplinkDvportgroupTestCase(TestCase):
2753     def setUp(self):
2754         self.mock_si = MagicMock()
2755         self.mock_dvs_ref = MagicMock(spec=vim.DistributedVirtualSwitch)
2756         self.mock_traversal_spec = MagicMock()
2757         self.mock_items = [
2758             {"object": MagicMock(), "tag": [MagicMock(key="fake_tag")]},
2759             {"object": MagicMock(), "tag": [MagicMock(key="SYSTEM/DVS.UPLINKPG")]},
2760         ]
2761         self.mock_get_mors = MagicMock(return_value=self.mock_items)
2762         patches = (
2763             (
2764                 "salt.utils.vmware.get_managed_object_name",
2765                 MagicMock(return_value="fake_dvs"),
2766             ),
2767             ("salt.utils.vmware.get_mors_with_properties", self.mock_get_mors),
2768             (
2769                 "salt.utils.vmware.get_service_instance_from_managed_object",
2770                 MagicMock(return_value=self.mock_si),
2771             ),
2772             (
2773                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2774                 MagicMock(return_value=self.mock_traversal_spec),
2775             ),
2776         )
2777         for mod, mock in patches:
2778             patcher = patch(mod, mock)
2779             patcher.start()
2780             self.addCleanup(patcher.stop)
2781     def tearDown(self):
2782         for attr in (
2783             "mock_si",
2784             "mock_dvs_ref",
2785             "mock_traversal_spec",
2786             "mock_items",
2787             "mock_get_mors",
2788         ):
2789             delattr(self, attr)
2790     def test_get_managed_object_name_call(self):
2791         mock_get_managed_object_name = MagicMock()
2792         with patch(
2793             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2794         ):
2795             salt.utils.vmware.get_uplink_dvportgroup(self.mock_dvs_ref)
2796         mock_get_managed_object_name.assert_called_once_with(self.mock_dvs_ref)
2797     def test_traversal_spec(self):
2798         mock_traversal_spec = MagicMock(return_value="traversal_spec")
2799         with patch(
2800             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2801             mock_traversal_spec,
2802         ):
2803             salt.utils.vmware.get_uplink_dvportgroup(self.mock_dvs_ref)
2804         mock_traversal_spec.assert_called_once_with(
2805             path="portgroup", skip=False, type=vim.DistributedVirtualSwitch
2806         )
2807     def test_get_mors_with_properties(self):
2808         salt.utils.vmware.get_uplink_dvportgroup(self.mock_dvs_ref)
2809         self.mock_get_mors.assert_called_once_with(
2810             self.mock_si,
2811             vim.DistributedVirtualPortgroup,
2812             container_ref=self.mock_dvs_ref,
2813             property_list=["tag"],
2814             traversal_spec=self.mock_traversal_spec,
2815         )
2816     def test_get_no_uplink_pg(self):
2817         with patch(
2818             "salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])
2819         ):
2820             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
2821                 salt.utils.vmware.get_uplink_dvportgroup(self.mock_dvs_ref)
2822         self.assertEqual(
2823             excinfo.exception.strerror,
2824             "Uplink portgroup of DVS 'fake_dvs' wasn't found",
2825         )
2826     def test_get_uplink_pg(self):
2827         ret = salt.utils.vmware.get_uplink_dvportgroup(self.mock_dvs_ref)
2828         self.assertEqual(ret, self.mock_items[1]["object"])
2829 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2830 class CreateDvportgroupTestCase(TestCase):
2831     def setUp(self):
2832         self.mock_pg_spec = MagicMock()
2833         self.mock_task = MagicMock(spec=FakeTaskClass)
2834         self.mock_dvs_ref = MagicMock(
2835             CreateDVPortgroup_Task=MagicMock(return_value=self.mock_task)
2836         )
2837         self.mock_wait_for_task = MagicMock()
2838         patches = (
2839             (
2840                 "salt.utils.vmware.get_managed_object_name",
2841                 MagicMock(return_value="fake_dvs"),
2842             ),
2843             ("salt.utils.vmware.wait_for_task", self.mock_wait_for_task),
2844         )
2845         for mod, mock in patches:
2846             patcher = patch(mod, mock)
2847             patcher.start()
2848             self.addCleanup(patcher.stop)
2849     def tearDown(self):
2850         for attr in ("mock_pg_spec", "mock_dvs_ref", "mock_task", "mock_wait_for_task"):
2851             delattr(self, attr)
2852     def test_get_managed_object_name_call(self):
2853         mock_get_managed_object_name = MagicMock()
2854         with patch(
2855             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2856         ):
2857             salt.utils.vmware.create_dvportgroup(self.mock_dvs_ref, self.mock_pg_spec)
2858         mock_get_managed_object_name.assert_called_once_with(self.mock_dvs_ref)
2859     def test_create_dvporgroup_task(self):
2860         salt.utils.vmware.create_dvportgroup(self.mock_dvs_ref, self.mock_pg_spec)
2861         self.mock_dvs_ref.CreateDVPortgroup_Task.assert_called_once_with(
2862             self.mock_pg_spec
2863         )
2864     def test_create_dvporgroup_task_raises_no_permission(self):
2865         exc = vim.fault.NoPermission()
2866         exc.privilegeId = "Fake privilege"
2867         self.mock_dvs_ref.CreateDVPortgroup_Task = MagicMock(side_effect=exc)
2868         with self.assertRaises(VMwareApiError) as excinfo:
2869             salt.utils.vmware.create_dvportgroup(self.mock_dvs_ref, self.mock_pg_spec)
2870         self.assertEqual(
2871             excinfo.exception.strerror,
2872             "Not enough permissions. Required privilege: Fake privilege",
2873         )
2874     def test_create_dvporgroup_task_raises_vim_fault(self):
2875         exc = vim.fault.VimFault()
2876         exc.msg = "VimFault msg"
2877         self.mock_dvs_ref.CreateDVPortgroup_Task = MagicMock(side_effect=exc)
2878         with self.assertRaises(VMwareApiError) as excinfo:
2879             salt.utils.vmware.create_dvportgroup(self.mock_dvs_ref, self.mock_pg_spec)
2880         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
2881     def test_create_dvporgroup_task_raises_runtime_fault(self):
2882         exc = vmodl.RuntimeFault()
2883         exc.msg = "RuntimeFault msg"
2884         self.mock_dvs_ref.CreateDVPortgroup_Task = MagicMock(side_effect=exc)
2885         with self.assertRaises(VMwareRuntimeError) as excinfo:
2886             salt.utils.vmware.create_dvportgroup(self.mock_dvs_ref, self.mock_pg_spec)
2887         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
2888     def test_wait_for_tasks(self):
2889         salt.utils.vmware.create_dvportgroup(self.mock_dvs_ref, self.mock_pg_spec)
2890         self.mock_wait_for_task.assert_called_once_with(
2891             self.mock_task,
2892             "fake_dvs",
2893             "&lt;class 'tests.unit.utils.test_vmware.FakeTaskClass'&gt;",
2894         )
2895 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2896 class UpdateDvportgroupTestCase(TestCase):
2897     def setUp(self):
2898         self.mock_pg_spec = MagicMock()
2899         self.mock_task = MagicMock(spec=FakeTaskClass)
2900         self.mock_pg_ref = MagicMock(
2901             ReconfigureDVPortgroup_Task=MagicMock(return_value=self.mock_task)
2902         )
2903         self.mock_wait_for_task = MagicMock()
2904         patches = (
2905             (
2906                 "salt.utils.vmware.get_managed_object_name",
2907                 MagicMock(return_value="fake_pg"),
2908             ),
2909             ("salt.utils.vmware.wait_for_task", self.mock_wait_for_task),
2910         )
2911         for mod, mock in patches:
2912             patcher = patch(mod, mock)
2913             patcher.start()
2914             self.addCleanup(patcher.stop)
2915     def tearDown(self):
2916         for attr in ("mock_pg_spec", "mock_pg_ref", "mock_task", "mock_wait_for_task"):
2917             delattr(self, attr)
2918     def test_get_managed_object_name_call(self):
2919         mock_get_managed_object_name = MagicMock()
2920         with patch(
2921             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2922         ):
2923             salt.utils.vmware.update_dvportgroup(self.mock_pg_ref, self.mock_pg_spec)
2924         mock_get_managed_object_name.assert_called_once_with(self.mock_pg_ref)
2925     def test_reconfigure_dvporgroup_task(self):
2926         salt.utils.vmware.update_dvportgroup(self.mock_pg_ref, self.mock_pg_spec)
2927         self.mock_pg_ref.ReconfigureDVPortgroup_Task.assert_called_once_with(
2928             self.mock_pg_spec
2929         )
2930     def test_reconfigure_dvporgroup_task_raises_no_permission(self):
2931         exc = vim.fault.NoPermission()
2932         exc.privilegeId = "Fake privilege"
2933         self.mock_pg_ref.ReconfigureDVPortgroup_Task = MagicMock(side_effect=exc)
2934         with self.assertRaises(VMwareApiError) as excinfo:
2935             salt.utils.vmware.update_dvportgroup(self.mock_pg_ref, self.mock_pg_spec)
2936         self.assertEqual(
2937             excinfo.exception.strerror,
2938             "Not enough permissions. Required privilege: Fake privilege",
2939         )
2940     def test_reconfigure_dvporgroup_task_raises_vim_fault(self):
2941         exc = vim.fault.VimFault()
2942         exc.msg = "VimFault msg"
2943         self.mock_pg_ref.ReconfigureDVPortgroup_Task = MagicMock(side_effect=exc)
2944         with self.assertRaises(VMwareApiError) as excinfo:
2945             salt.utils.vmware.update_dvportgroup(self.mock_pg_ref, self.mock_pg_spec)
2946         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
2947     def test_reconfigure_dvporgroup_task_raises_runtime_fault(self):
2948         exc = vmodl.RuntimeFault()
2949         exc.msg = "RuntimeFault msg"
2950         self.mock_pg_ref.ReconfigureDVPortgroup_Task = MagicMock(side_effect=exc)
2951         with self.assertRaises(VMwareRuntimeError) as excinfo:
2952             salt.utils.vmware.update_dvportgroup(self.mock_pg_ref, self.mock_pg_spec)
2953         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
2954     def test_wait_for_tasks(self):
2955         salt.utils.vmware.update_dvportgroup(self.mock_pg_ref, self.mock_pg_spec)
2956         self.mock_wait_for_task.assert_called_once_with(
2957             self.mock_task,
2958             "fake_pg",
2959             "&lt;class 'tests.unit.utils.test_vmware.FakeTaskClass'&gt;",
2960         )
2961 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2962 class RemoveDvportgroupTestCase(TestCase):
2963     def setUp(self):
2964         self.mock_task = MagicMock(spec=FakeTaskClass)
2965         self.mock_pg_ref = MagicMock(
2966             Destroy_Task=MagicMock(return_value=self.mock_task)
2967         )
2968         self.mock_wait_for_task = MagicMock()
2969         patches = (
2970             (
2971                 "salt.utils.vmware.get_managed_object_name",
2972                 MagicMock(return_value="fake_pg"),
2973             ),
2974             ("salt.utils.vmware.wait_for_task", self.mock_wait_for_task),
2975         )
2976         for mod, mock in patches:
2977             patcher = patch(mod, mock)
2978             patcher.start()
2979             self.addCleanup(patcher.stop)
2980     def tearDown(self):
2981         for attr in ("mock_pg_ref", "mock_task", "mock_wait_for_task"):
2982             delattr(self, attr)
2983     def test_get_managed_object_name_call(self):
2984         mock_get_managed_object_name = MagicMock()
2985         with patch(
2986             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2987         ):
2988             salt.utils.vmware.remove_dvportgroup(self.mock_pg_ref)
2989         mock_get_managed_object_name.assert_called_once_with(self.mock_pg_ref)
2990     def test_destroy_task(self):
2991         salt.utils.vmware.remove_dvportgroup(self.mock_pg_ref)
2992         self.mock_pg_ref.Destroy_Task.assert_called_once_with()
2993     def test_destroy_task_raises_no_permission(self):
2994         exc = vim.fault.NoPermission()
2995         exc.privilegeId = "Fake privilege"
2996         self.mock_pg_ref.Destroy_Task = MagicMock(side_effect=exc)
2997         with self.assertRaises(VMwareApiError) as excinfo:
2998             salt.utils.vmware.remove_dvportgroup(self.mock_pg_ref)
2999         self.assertEqual(
3000             excinfo.exception.strerror,
3001             "Not enough permissions. Required privilege: Fake privilege",
3002         )
3003     def test_destroy_treconfigure_dvporgroup_task_raises_vim_fault(self):
3004         exc = vim.fault.VimFault()
3005         exc.msg = "VimFault msg"
3006         self.mock_pg_ref.Destroy_Task = MagicMock(side_effect=exc)
3007         with self.assertRaises(VMwareApiError) as excinfo:
3008             salt.utils.vmware.remove_dvportgroup(self.mock_pg_ref)
3009         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3010     def test_destroy_treconfigure_dvporgroup_task_raises_runtime_fault(self):
3011         exc = vmodl.RuntimeFault()
3012         exc.msg = "RuntimeFault msg"
3013         self.mock_pg_ref.Destroy_Task = MagicMock(side_effect=exc)
3014         with self.assertRaises(VMwareRuntimeError) as excinfo:
3015             salt.utils.vmware.remove_dvportgroup(self.mock_pg_ref)
3016         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3017     def test_wait_for_tasks(self):
3018         salt.utils.vmware.remove_dvportgroup(self.mock_pg_ref)
3019         self.mock_wait_for_task.assert_called_once_with(
3020             self.mock_task,
3021             "fake_pg",
3022             "&lt;class 'tests.unit.utils.test_vmware.FakeTaskClass'&gt;",
3023         )
3024 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3025 class GetHostsTestCase(TestCase):
3026     def setUp(self):
3027         patches = (
3028             ("salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])),
3029             ("salt.utils.vmware.get_datacenter", MagicMock(return_value=None)),
3030             ("salt.utils.vmware.get_cluster", MagicMock(return_value=None)),
3031         )
3032         for mod, mock in patches:
3033             patcher = patch(mod, mock)
3034             patcher.start()
3035             self.addCleanup(patcher.stop)
3036         self.mock_root_folder = MagicMock()
3037         self.mock_si = MagicMock()
3038         self.mock_host1, self.mock_host2, self.mock_host3 = (
3039             MagicMock(),
3040             MagicMock(),
3041             MagicMock(),
3042         )
3043         self.mock_prop_host1 = {"name": "fake_hostname1", "object": self.mock_host1}
3044         self.mock_prop_host2 = {"name": "fake_hostname2", "object": self.mock_host2}
3045         self.mock_prop_host3 = {"name": "fake_hostname3", "object": self.mock_host3}
3046         self.mock_prop_hosts = [
3047             self.mock_prop_host1,
3048             self.mock_prop_host2,
3049             self.mock_prop_host3,
3050         ]
3051     def test_cluster_no_datacenter(self):
3052         with self.assertRaises(ArgumentValueError) as excinfo:
3053             salt.utils.vmware.get_hosts(self.mock_si, cluster_name="fake_cluster")
3054         self.assertEqual(
3055             excinfo.exception.strerror,
3056             "Must specify the datacenter when specifying the cluster",
3057         )
3058     def test_get_si_no_datacenter_no_cluster(self):
3059         mock_get_mors = MagicMock()
3060         mock_get_root_folder = MagicMock(return_value=self.mock_root_folder)
3061         with patch("salt.utils.vmware.get_root_folder", mock_get_root_folder):
3062             with patch("salt.utils.vmware.get_mors_with_properties", mock_get_mors):
3063                 salt.utils.vmware.get_hosts(self.mock_si)
3064         mock_get_root_folder.assert_called_once_with(self.mock_si)
3065         mock_get_mors.assert_called_once_with(
3066             self.mock_si,
3067             vim.HostSystem,
3068             container_ref=self.mock_root_folder,
3069             property_list=["name"],
3070         )
3071     def test_get_si_datacenter_name_no_cluster_name(self):
3072         mock_dc = MagicMock()
3073         mock_get_dc = MagicMock(return_value=mock_dc)
3074         mock_get_mors = MagicMock()
3075         with patch("salt.utils.vmware.get_datacenter", mock_get_dc):
3076             with patch("salt.utils.vmware.get_mors_with_properties", mock_get_mors):
3077                 salt.utils.vmware.get_hosts(
3078                     self.mock_si, datacenter_name="fake_datacenter"
3079                 )
3080         mock_get_dc.assert_called_once_with(self.mock_si, "fake_datacenter")
3081         mock_get_mors.assert_called_once_with(
3082             self.mock_si, vim.HostSystem, container_ref=mock_dc, property_list=["name"]
3083         )
3084     def test_get_si_datacenter_name_and_cluster_name(self):
3085         mock_dc = MagicMock()
3086         mock_get_dc = MagicMock(return_value=mock_dc)
3087         mock_get_cl = MagicMock()
3088         mock_get_mors = MagicMock()
3089         with patch("salt.utils.vmware.get_datacenter", mock_get_dc):
3090             with patch("salt.utils.vmware.get_cluster", mock_get_cl):
3091                 with patch("salt.utils.vmware.get_mors_with_properties", mock_get_mors):
3092                     salt.utils.vmware.get_hosts(
3093                         self.mock_si,
3094                         datacenter_name="fake_datacenter",
3095                         cluster_name="fake_cluster",
3096                     )
3097         mock_get_dc.assert_called_once_with(self.mock_si, "fake_datacenter")
3098         mock_get_mors.assert_called_once_with(
3099             self.mock_si,
3100             vim.HostSystem,
3101             container_ref=mock_dc,
3102             property_list=["name", "parent"],
3103         )
3104     def test_host_get_all_hosts(self):
3105         with patch(
3106             "salt.utils.vmware.get_root_folder",
3107             MagicMock(return_value=self.mock_root_folder),
3108         ):
3109             with patch(
3110                 "salt.utils.vmware.get_mors_with_properties",
3111                 MagicMock(return_value=self.mock_prop_hosts),
3112             ):
3113                 res = salt.utils.vmware.get_hosts(self.mock_si, get_all_hosts=True)
3114         self.assertEqual(res, [self.mock_host1, self.mock_host2, self.mock_host3])
3115     def test_filter_hostname(self):
3116         with patch(
3117             "salt.utils.vmware.get_mors_with_properties",
3118             MagicMock(return_value=self.mock_prop_hosts),
3119         ):
3120             res = salt.utils.vmware.get_hosts(
3121                 self.mock_si, host_names=["fake_hostname1", "fake_hostname2"]
3122             )
3123         self.assertEqual(res, [self.mock_host1, self.mock_host2])
3124     def test_get_all_host_flag_not_set_and_no_host_names(self):
3125         with patch(
3126             "salt.utils.vmware.get_mors_with_properties",
3127             MagicMock(return_value=self.mock_prop_hosts),
3128         ):
3129             res = salt.utils.vmware.get_hosts(self.mock_si)
3130         self.assertEqual(res, [])
3131     def test_filter_cluster(self):
3132         self.mock_prop_host1["parent"] = vim.ClusterComputeResource("cluster")
3133         self.mock_prop_host2["parent"] = vim.ClusterComputeResource("cluster")
3134         self.mock_prop_host3["parent"] = vim.Datacenter("dc")
3135         mock_get_cl_name = MagicMock(
3136             side_effect=["fake_bad_cluster", "fake_good_cluster"]
3137         )
3138         with patch(
3139             "salt.utils.vmware.get_mors_with_properties",
3140             MagicMock(return_value=self.mock_prop_hosts),
3141         ):
3142             with patch("salt.utils.vmware.get_managed_object_name", mock_get_cl_name):
3143                 res = salt.utils.vmware.get_hosts(
3144                     self.mock_si,
3145                     datacenter_name="fake_datacenter",
3146                     cluster_name="fake_good_cluster",
3147                     get_all_hosts=True,
3148                 )
3149         self.assertEqual(mock_get_cl_name.call_count, 2)
3150         self.assertEqual(res, [self.mock_host2])
3151     def test_no_hosts(self):
3152         with patch(
3153             "salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])
3154         ):
3155             res = salt.utils.vmware.get_hosts(self.mock_si, get_all_hosts=True)
3156         self.assertEqual(res, [])
3157     def test_one_host_returned(self):
3158         with patch(
3159             "salt.utils.vmware.get_mors_with_properties",
3160             MagicMock(return_value=[self.mock_prop_host1]),
3161         ):
3162             res = salt.utils.vmware.get_hosts(self.mock_si, get_all_hosts=True)
3163         self.assertEqual(res, [self.mock_host1])
3164 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3165 class GetLicenseManagerTestCase(TestCase):
3166     def setUp(self):
3167         self.mock_si = MagicMock()
3168         self.mock_lic_mgr = MagicMock()
3169         type(self.mock_si.content).licenseManager = PropertyMock(
3170             return_value=self.mock_lic_mgr
3171         )
3172     def tearDown(self):
3173         for attr in ("mock_si", "mock_lic_mgr"):
3174             delattr(self, attr)
3175     def test_raise_no_permission(self):
3176         exc = vim.fault.NoPermission()
3177         exc.privilegeId = "Fake privilege"
3178         type(self.mock_si.content).licenseManager = PropertyMock(side_effect=exc)
3179         with self.assertRaises(VMwareApiError) as excinfo:
3180             salt.utils.vmware.get_license_manager(self.mock_si)
3181         self.assertEqual(
3182             excinfo.exception.strerror,
3183             "Not enough permissions. Required privilege: Fake privilege",
3184         )
3185     def test_raise_vim_fault(self):
3186         exc = vim.fault.VimFault()
3187         exc.msg = "VimFault msg"
3188         type(self.mock_si.content).licenseManager = PropertyMock(side_effect=exc)
3189         with self.assertRaises(VMwareApiError) as excinfo:
3190             salt.utils.vmware.get_license_manager(self.mock_si)
3191         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3192     def test_raise_runtime_fault(self):
3193         exc = vmodl.RuntimeFault()
3194         exc.msg = "RuntimeFault msg"
3195         type(self.mock_si.content).licenseManager = PropertyMock(side_effect=exc)
3196         with self.assertRaises(VMwareRuntimeError) as excinfo:
3197             salt.utils.vmware.get_license_manager(self.mock_si)
3198         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3199     def test_valid_assignment_manager(self):
3200         ret = salt.utils.vmware.get_license_manager(self.mock_si)
3201         self.assertEqual(ret, self.mock_lic_mgr)
3202 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3203 class GetLicenseAssignmentManagerTestCase(TestCase):
3204     def setUp(self):
3205         self.mock_si = MagicMock()
3206         self.mock_lic_assign_mgr = MagicMock()
3207         type(
3208             self.mock_si.content.licenseManager
3209         ).licenseAssignmentManager = PropertyMock(return_value=self.mock_lic_assign_mgr)
3210     def tearDown(self):
3211         for attr in ("mock_si", "mock_lic_assign_mgr"):
3212             delattr(self, attr)
3213     def test_raise_no_permission(self):
3214         exc = vim.fault.NoPermission()
3215         exc.privilegeId = "Fake privilege"
3216         type(
3217             self.mock_si.content.licenseManager
3218         ).licenseAssignmentManager = PropertyMock(side_effect=exc)
3219         with self.assertRaises(VMwareApiError) as excinfo:
3220             salt.utils.vmware.get_license_assignment_manager(self.mock_si)
3221         self.assertEqual(
3222             excinfo.exception.strerror,
3223             "Not enough permissions. Required privilege: Fake privilege",
3224         )
3225     def test_raise_vim_fault(self):
3226         exc = vim.fault.VimFault()
3227         exc.msg = "VimFault msg"
3228         type(
3229             self.mock_si.content.licenseManager
3230         ).licenseAssignmentManager = PropertyMock(side_effect=exc)
3231         with self.assertRaises(VMwareApiError) as excinfo:
3232             salt.utils.vmware.get_license_assignment_manager(self.mock_si)
3233         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3234     def test_raise_runtime_fault(self):
3235         exc = vmodl.RuntimeFault()
3236         exc.msg = "RuntimeFault msg"
3237         type(
3238             self.mock_si.content.licenseManager
3239         ).licenseAssignmentManager = PropertyMock(side_effect=exc)
3240         with self.assertRaises(VMwareRuntimeError) as excinfo:
3241             salt.utils.vmware.get_license_assignment_manager(self.mock_si)
3242         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3243     def test_empty_license_assignment_manager(self):
3244         type(
3245             self.mock_si.content.licenseManager
3246         ).licenseAssignmentManager = PropertyMock(return_value=None)
3247         with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
3248             salt.utils.vmware.get_license_assignment_manager(self.mock_si)
3249         self.assertEqual(
3250             excinfo.exception.strerror, "License assignment manager was not retrieved"
3251         )
3252     def test_valid_assignment_manager(self):
3253         ret = salt.utils.vmware.get_license_assignment_manager(self.mock_si)
3254         self.assertEqual(ret, self.mock_lic_assign_mgr)
3255 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3256 class GetLicensesTestCase(TestCase):
3257     def setUp(self):
3258         self.mock_si = MagicMock()
3259         self.mock_licenses = [MagicMock(), MagicMock()]
3260         self.mock_lic_mgr = MagicMock()
3261         type(self.mock_lic_mgr).licenses = PropertyMock(return_value=self.mock_licenses)
3262         patches = (
3263             (
3264                 "salt.utils.vmware.get_license_manager",
3265                 MagicMock(return_value=self.mock_lic_mgr),
3266             ),
3267         )
3268         for mod, mock in patches:
3269             patcher = patch(mod, mock)
3270             patcher.start()
3271             self.addCleanup(patcher.stop)
3272     def tearDown(self):
3273         for attr in ("mock_si", "mock_lic_mgr", "mock_licenses"):
3274             delattr(self, attr)
3275     def test_no_license_manager_passed_in(self):
3276         mock_get_license_manager = MagicMock()
3277         with patch("salt.utils.vmware.get_license_manager", mock_get_license_manager):
3278             salt.utils.vmware.get_licenses(self.mock_si)
3279         mock_get_license_manager.assert_called_once_with(self.mock_si)
3280     def test_license_manager_passed_in(self):
3281         mock_licenses = PropertyMock()
3282         mock_lic_mgr = MagicMock()
3283         type(mock_lic_mgr).licenses = mock_licenses
3284         mock_get_license_manager = MagicMock()
3285         with patch("salt.utils.vmware.get_license_manager", mock_get_license_manager):
3286             salt.utils.vmware.get_licenses(self.mock_si, license_manager=mock_lic_mgr)
3287         self.assertEqual(mock_get_license_manager.call_count, 0)
3288         self.assertEqual(mock_licenses.call_count, 1)
3289     def test_raise_no_permission(self):
3290         exc = vim.fault.NoPermission()
3291         exc.privilegeId = "Fake privilege"
3292         type(self.mock_lic_mgr).licenses = PropertyMock(side_effect=exc)
3293         with self.assertRaises(VMwareApiError) as excinfo:
3294             salt.utils.vmware.get_licenses(self.mock_si)
3295         self.assertEqual(
3296             excinfo.exception.strerror,
3297             "Not enough permissions. Required privilege: Fake privilege",
3298         )
3299     def test_raise_vim_fault(self):
3300         exc = vim.fault.VimFault()
3301         exc.msg = "VimFault msg"
3302         type(self.mock_lic_mgr).licenses = PropertyMock(side_effect=exc)
3303         with self.assertRaises(VMwareApiError) as excinfo:
3304             salt.utils.vmware.get_licenses(self.mock_si)
3305         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3306     def test_raise_runtime_fault(self):
3307         exc = vmodl.RuntimeFault()
3308         exc.msg = "RuntimeFault msg"
3309         type(self.mock_lic_mgr).licenses = PropertyMock(side_effect=exc)
3310         with self.assertRaises(VMwareRuntimeError) as excinfo:
3311             salt.utils.vmware.get_licenses(self.mock_si)
3312         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3313     def test_valid_licenses(self):
3314         ret = salt.utils.vmware.get_licenses(self.mock_si)
3315         self.assertEqual(ret, self.mock_licenses)
3316 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3317 class AddLicenseTestCase(TestCase):
3318     def setUp(self):
3319         self.mock_si = MagicMock()
3320         self.mock_license = MagicMock()
3321         self.mock_add_license = MagicMock(return_value=self.mock_license)
3322         self.mock_lic_mgr = MagicMock(AddLicense=self.mock_add_license)
3323         self.mock_label = MagicMock()
3324         patches = (
3325             (
3326                 "salt.utils.vmware.get_license_manager",
3327                 MagicMock(return_value=self.mock_lic_mgr),
3328             ),
3329             ("salt.utils.vmware.vim.KeyValue", MagicMock(return_value=self.mock_label)),
3330         )
3331         for mod, mock in patches:
3332             patcher = patch(mod, mock)
3333             patcher.start()
3334             self.addCleanup(patcher.stop)
3335     def tearDown(self):
3336         for attr in (
3337             "mock_si",
3338             "mock_lic_mgr",
3339             "mock_license",
3340             "mock_add_license",
3341             "mock_label",
3342         ):
3343             delattr(self, attr)
3344     def test_no_license_manager_passed_in(self):
3345         mock_get_license_manager = MagicMock()
3346         with patch("salt.utils.vmware.get_license_manager", mock_get_license_manager):
3347             salt.utils.vmware.add_license(
3348                 self.mock_si, "fake_license_key", "fake_license_description"
3349             )
3350         mock_get_license_manager.assert_called_once_with(self.mock_si)
3351     def test_license_manager_passed_in(self):
3352         mock_get_license_manager = MagicMock()
3353         with patch("salt.utils.vmware.get_license_manager", mock_get_license_manager):
3354             salt.utils.vmware.add_license(
3355                 self.mock_si,
3356                 "fake_license_key",
3357                 "fake_license_description",
3358                 license_manager=self.mock_lic_mgr,
3359             )
3360         self.assertEqual(mock_get_license_manager.call_count, 0)
3361         self.assertEqual(self.mock_add_license.call_count, 1)
3362     def test_label_settings(self):
3363         salt.utils.vmware.add_license(
3364             self.mock_si, "fake_license_key", "fake_license_description"
3365         )
3366         self.assertEqual(self.mock_label.key, "VpxClientLicenseLabel")
3367         self.assertEqual(self.mock_label.value, "fake_license_description")
3368     def test_add_license_arguments(self):
3369         salt.utils.vmware.add_license(
3370             self.mock_si, "fake_license_key", "fake_license_description"
3371         )
3372         self.mock_add_license.assert_called_once_with(
3373             "fake_license_key", [self.mock_label]
3374         )
3375     def test_add_license_raises_no_permission(self):
3376         exc = vim.fault.NoPermission()
3377         exc.privilegeId = "Fake privilege"
3378         self.mock_lic_mgr.AddLicense = MagicMock(side_effect=exc)
3379         with self.assertRaises(VMwareApiError) as excinfo:
3380             salt.utils.vmware.add_license(
3381                 self.mock_si, "fake_license_key", "fake_license_description"
3382             )
3383         self.assertEqual(
3384             excinfo.exception.strerror,
3385             "Not enough permissions. Required privilege: Fake privilege",
3386         )
3387     def test_add_license_raises_vim_fault(self):
3388         exc = vim.fault.VimFault()
3389         exc.msg = "VimFault msg"
3390         self.mock_lic_mgr.AddLicense = MagicMock(side_effect=exc)
3391         with self.assertRaises(VMwareApiError) as excinfo:
3392             salt.utils.vmware.add_license(
3393                 self.mock_si, "fake_license_key", "fake_license_description"
3394             )
3395         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3396     def test_add_license_raises_runtime_fault(self):
3397         exc = vmodl.RuntimeFault()
3398         exc.msg = "RuntimeFault msg"
3399         self.mock_lic_mgr.AddLicense = MagicMock(side_effect=exc)
3400         with self.assertRaises(VMwareRuntimeError) as excinfo:
3401             salt.utils.vmware.add_license(
3402                 self.mock_si, "fake_license_key", "fake_license_description"
3403             )
3404         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3405     def test_valid_license_added(self):
3406         ret = salt.utils.vmware.add_license(
3407             self.mock_si, "fake_license_key", "fake_license_description"
3408         )
3409         self.assertEqual(ret, self.mock_license)
3410 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3411 class GetAssignedLicensesTestCase(TestCase):
3412     def setUp(self):
3413         self.mock_ent_id = MagicMock()
3414         self.mock_si = MagicMock()
3415         type(self.mock_si.content.about).instanceUuid = PropertyMock(
3416             return_value=self.mock_ent_id
3417         )
3418         self.mock_moid = MagicMock()
3419         self.prop_mock_moid = PropertyMock(return_value=self.mock_moid)
3420         self.mock_entity_ref = MagicMock()
3421         type(self.mock_entity_ref)._moId = self.prop_mock_moid
3422         self.mock_assignments = [
3423             MagicMock(entityDisplayName="fake_ent1"),
3424             MagicMock(entityDisplayName="fake_ent2"),
3425         ]
3426         self.mock_query_assigned_licenses = MagicMock(
3427             return_value=[
3428                 MagicMock(assignedLicense=self.mock_assignments[0]),
3429                 MagicMock(assignedLicense=self.mock_assignments[1]),
3430             ]
3431         )
3432         self.mock_lic_assign_mgr = MagicMock(
3433             QueryAssignedLicenses=self.mock_query_assigned_licenses
3434         )
3435         patches = (
3436             (
3437                 "salt.utils.vmware.get_license_assignment_manager",
3438                 MagicMock(return_value=self.mock_lic_assign_mgr),
3439             ),
3440         )
3441         for mod, mock in patches:
3442             patcher = patch(mod, mock)
3443             patcher.start()
3444             self.addCleanup(patcher.stop)
3445     def tearDown(self):
3446         for attr in (
3447             "mock_ent_id",
3448             "mock_si",
3449             "mock_moid",
3450             "prop_mock_moid",
3451             "mock_entity_ref",
3452             "mock_assignments",
3453             "mock_query_assigned_licenses",
3454             "mock_lic_assign_mgr",
3455         ):
3456             delattr(self, attr)
3457     def test_no_license_assignment_manager_passed_in(self):
3458         mock_get_license_assign_manager = MagicMock()
3459         with patch(
3460             "salt.utils.vmware.get_license_assignment_manager",
3461             mock_get_license_assign_manager,
3462         ):
3463             salt.utils.vmware.get_assigned_licenses(
3464                 self.mock_si, self.mock_entity_ref, "fake_entity_name"
3465             )
3466         mock_get_license_assign_manager.assert_called_once_with(self.mock_si)
3467     def test_license_assignment_manager_passed_in(self):
3468         mock_get_license_assign_manager = MagicMock()
3469         with patch(
3470             "salt.utils.vmware.get_license_assignment_manager",
3471             mock_get_license_assign_manager,
3472         ):
3473             salt.utils.vmware.get_assigned_licenses(
3474                 self.mock_si,
3475                 self.mock_entity_ref,
3476                 "fake_entity_name",
3477                 license_assignment_manager=self.mock_lic_assign_mgr,
3478             )
3479         self.assertEqual(mock_get_license_assign_manager.call_count, 0)
3480     def test_entity_name(self):
3481         mock_trace = MagicMock()
3482         with patch("salt._logging.impl.SaltLoggingClass.trace", mock_trace):
3483             salt.utils.vmware.get_assigned_licenses(
3484                 self.mock_si, self.mock_entity_ref, "fake_entity_name"
3485             )
3486         mock_trace.assert_called_once_with(
3487             "Retrieving licenses assigned to '%s'", "fake_entity_name"
3488         )
3489     def test_instance_uuid(self):
3490         mock_instance_uuid_prop = PropertyMock()
3491         type(self.mock_si.content.about).instanceUuid = mock_instance_uuid_prop
3492         self.mock_lic_assign_mgr.QueryAssignedLicenses = MagicMock(
3493             return_value=[MagicMock(entityDisplayName="fake_vcenter")]
3494         )
3495         salt.utils.vmware.get_assigned_licenses(
3496             self.mock_si, entity_name="fake_vcenter"
3497         )
3498         self.assertEqual(mock_instance_uuid_prop.call_count, 1)
3499     def test_instance_uuid_raises_no_permission(self):
3500         exc = vim.fault.NoPermission()
3501         exc.privilegeId = "Fake privilege"
3502         type(self.mock_si.content.about).instanceUuid = PropertyMock(side_effect=exc)
3503         with self.assertRaises(VMwareApiError) as excinfo:
3504             salt.utils.vmware.get_assigned_licenses(
3505                 self.mock_si, entity_name="fake_vcenter"
3506             )
3507         self.assertEqual(
3508             excinfo.exception.strerror,
3509             "Not enough permissions. Required privilege: Fake privilege",
3510         )
3511     def test_instance_uuid_raises_vim_fault(self):
3512         exc = vim.fault.VimFault()
3513         exc.msg = "VimFault msg"
3514         type(self.mock_si.content.about).instanceUuid = PropertyMock(side_effect=exc)
3515         with self.assertRaises(VMwareApiError) as excinfo:
3516             salt.utils.vmware.get_assigned_licenses(
3517                 self.mock_si, entity_name="fake_vcenter"
3518             )
3519         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3520     def test_instance_uuid_raises_runtime_fault(self):
3521         exc = vmodl.RuntimeFault()
3522         exc.msg = "RuntimeFault msg"
3523         type(self.mock_si.content.about).instanceUuid = PropertyMock(side_effect=exc)
3524         with self.assertRaises(VMwareRuntimeError) as excinfo:
3525             salt.utils.vmware.get_assigned_licenses(
3526                 self.mock_si, entity_name="fake_vcenter"
3527             )
3528         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3529     def test_vcenter_entity_too_many_assignements(self):
3530         self.mock_lic_assign_mgr.QueryAssignedLicenses = MagicMock(
3531             return_value=[MagicMock(), MagicMock()]
3532         )
3533         with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
3534             salt.utils.vmware.get_assigned_licenses(
3535                 self.mock_si, entity_name="fake_vcenter"
3536             )
3537         self.assertEqual(
3538             excinfo.exception.strerror,
3539             "Unexpected return. Expect only a single assignment",
3540         )
3541     def test_wrong_vcenter_name(self):
3542         self.mock_lic_assign_mgr.QueryAssignedLicenses = MagicMock(
3543             return_value=[MagicMock(entityDisplayName="bad_vcenter")]
3544         )
3545         with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
3546             salt.utils.vmware.get_assigned_licenses(
3547                 self.mock_si, entity_name="fake_vcenter"
3548             )
3549         self.assertEqual(
3550             excinfo.exception.strerror,
3551             "Got license assignment info for a different vcenter",
3552         )
3553     def test_query_assigned_licenses_vcenter(self):
3554         with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
3555             salt.utils.vmware.get_assigned_licenses(
3556                 self.mock_si, entity_name="fake_vcenter"
3557             )
3558         self.mock_query_assigned_licenses.assert_called_once_with(self.mock_ent_id)
3559     def test_query_assigned_licenses_with_entity(self):
3560         salt.utils.vmware.get_assigned_licenses(
3561             self.mock_si, self.mock_entity_ref, "fake_entity_name"
3562         )
3563         self.mock_query_assigned_licenses.assert_called_once_with(self.mock_moid)
3564     def test_query_assigned_licenses_raises_no_permission(self):
3565         exc = vim.fault.NoPermission()
3566         exc.privilegeId = "Fake privilege"
3567         self.mock_lic_assign_mgr.QueryAssignedLicenses = MagicMock(side_effect=exc)
3568         with self.assertRaises(VMwareApiError) as excinfo:
3569             salt.utils.vmware.get_assigned_licenses(
3570                 self.mock_si, self.mock_entity_ref, "fake_entity_name"
3571             )
3572         self.assertEqual(
3573             excinfo.exception.strerror,
3574             "Not enough permissions. Required privilege: Fake privilege",
3575         )
3576     def test_query_assigned_licenses_raises_vim_fault(self):
3577         exc = vim.fault.VimFault()
3578         exc.msg = "VimFault msg"
3579         self.mock_lic_assign_mgr.QueryAssignedLicenses = MagicMock(side_effect=exc)
3580         with self.assertRaises(VMwareApiError) as excinfo:
3581             salt.utils.vmware.get_assigned_licenses(
3582                 self.mock_si, self.mock_entity_ref, "fake_entity_name"
3583             )
3584         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3585     def test_query_assigned_licenses_raises_runtime_fault(self):
3586         exc = vmodl.RuntimeFault()
3587         exc.msg = "RuntimeFault msg"
3588         self.mock_lic_assign_mgr.QueryAssignedLicenses = MagicMock(side_effect=exc)
3589         with self.assertRaises(VMwareRuntimeError) as excinfo:
3590             salt.utils.vmware.get_assigned_licenses(
3591                 self.mock_si, self.mock_entity_ref, "fake_entity_name"
3592             )
3593         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3594     def test_valid_assignments(self):
3595         ret = salt.utils.vmware.get_assigned_licenses(
3596             self.mock_si, self.mock_entity_ref, "fake_entity_name"
3597         )
3598         self.assertEqual(ret, self.mock_assignments)
3599 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3600 class AssignLicenseTestCase(TestCase):
3601     def setUp(self):
3602         self.mock_ent_id = MagicMock()
3603         self.mock_si = MagicMock()
3604         type(self.mock_si.content.about).instanceUuid = PropertyMock(
3605             return_value=self.mock_ent_id
3606         )
3607         self.mock_lic_key = MagicMock()
3608         self.mock_moid = MagicMock()
3609         self.prop_mock_moid = PropertyMock(return_value=self.mock_moid)
3610         self.mock_entity_ref = MagicMock()
3611         type(self.mock_entity_ref)._moId = self.prop_mock_moid
3612         self.mock_license = MagicMock()
3613         self.mock_update_assigned_license = MagicMock(return_value=self.mock_license)
3614         self.mock_lic_assign_mgr = MagicMock(
3615             UpdateAssignedLicense=self.mock_update_assigned_license
3616         )
3617         patches = (
3618             (
3619                 "salt.utils.vmware.get_license_assignment_manager",
3620                 MagicMock(return_value=self.mock_lic_assign_mgr),
3621             ),
3622         )
3623         for mod, mock in patches:
3624             patcher = patch(mod, mock)
3625             patcher.start()
3626             self.addCleanup(patcher.stop)
3627     def test_no_license_assignment_manager_passed_in(self):
3628         mock_get_license_assign_manager = MagicMock()
3629         with patch(
3630             "salt.utils.vmware.get_license_assignment_manager",
3631             mock_get_license_assign_manager,
3632         ):
3633             salt.utils.vmware.assign_license(
3634                 self.mock_si,
3635                 self.mock_lic_key,
3636                 "fake_license_name",
3637                 self.mock_entity_ref,
3638                 "fake_entity_name",
3639             )
3640         mock_get_license_assign_manager.assert_called_once_with(self.mock_si)
3641     def test_license_assignment_manager_passed_in(self):
3642         mock_get_license_assign_manager = MagicMock()
3643         with patch(
3644             "salt.utils.vmware.get_license_assignment_manager",
3645             mock_get_license_assign_manager,
3646         ):
3647             salt.utils.vmware.assign_license(
3648                 self.mock_si,
3649                 self.mock_lic_key,
3650                 "fake_license_name",
3651                 self.mock_entity_ref,
3652                 "fake_entity_name",
3653                 license_assignment_manager=self.mock_lic_assign_mgr,
3654             )
3655         self.assertEqual(mock_get_license_assign_manager.call_count, 0)
3656         self.assertEqual(self.mock_update_assigned_license.call_count, 1)
3657     def test_entity_name(self):
3658         mock_trace = MagicMock()
3659         with patch("salt._logging.impl.SaltLoggingClass.trace", mock_trace):
3660             salt.utils.vmware.assign_license(
3661                 self.mock_si,
3662                 self.mock_lic_key,
3663                 "fake_license_name",
3664                 self.mock_entity_ref,
3665                 "fake_entity_name",
3666             )
3667         mock_trace.assert_called_once_with(
3668             "Assigning license to '%s'", "fake_entity_name"
3669         )
3670     def test_instance_uuid(self):
3671         mock_instance_uuid_prop = PropertyMock()
3672         type(self.mock_si.content.about).instanceUuid = mock_instance_uuid_prop
3673         self.mock_lic_assign_mgr.UpdateAssignedLicense = MagicMock(
3674             return_value=[MagicMock(entityDisplayName="fake_vcenter")]
3675         )
3676         salt.utils.vmware.assign_license(
3677             self.mock_si,
3678             self.mock_lic_key,
3679             "fake_license_name",
3680             entity_name="fake_entity_name",
3681         )
3682         self.assertEqual(mock_instance_uuid_prop.call_count, 1)
3683     def test_instance_uuid_raises_no_permission(self):
3684         exc = vim.fault.NoPermission()
3685         exc.privilegeId = "Fake privilege"
3686         type(self.mock_si.content.about).instanceUuid = PropertyMock(side_effect=exc)
3687         with self.assertRaises(VMwareApiError) as excinfo:
3688             salt.utils.vmware.assign_license(
3689                 self.mock_si,
3690                 self.mock_lic_key,
3691                 "fake_license_name",
3692                 entity_name="fake_entity_name",
3693             )
3694         self.assertEqual(
3695             excinfo.exception.strerror,
3696             "Not enough permissions. Required privilege: Fake privilege",
3697         )
3698     def test_instance_uuid_raises_vim_fault(self):
3699         exc = vim.fault.VimFault()
3700         exc.msg = "VimFault msg"
3701         type(self.mock_si.content.about).instanceUuid = PropertyMock(side_effect=exc)
3702         with self.assertRaises(VMwareApiError) as excinfo:
3703             salt.utils.vmware.assign_license(
3704                 self.mock_si,
3705                 self.mock_lic_key,
3706                 "fake_license_name",
3707                 entity_name="fake_entity_name",
3708             )
3709         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3710     def test_instance_uuid_raises_runtime_fault(self):
3711         exc = vmodl.RuntimeFault()
3712         exc.msg = "RuntimeFault msg"
3713         type(self.mock_si.content.about).instanceUuid = PropertyMock(side_effect=exc)
3714         with self.assertRaises(VMwareRuntimeError) as excinfo:
3715             salt.utils.vmware.assign_license(
3716                 self.mock_si,
3717                 self.mock_lic_key,
3718                 "fake_license_name",
3719                 entity_name="fake_entity_name",
3720             )
3721         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3722     def test_update_assigned_licenses_vcenter(self):
3723         salt.utils.vmware.assign_license(
3724             self.mock_si,
3725             self.mock_lic_key,
3726             "fake_license_name",
3727             entity_name="fake_entity_name",
3728         )
3729         self.mock_update_assigned_license.assert_called_once_with(
3730             self.mock_ent_id, self.mock_lic_key, "fake_license_name"
3731         )
3732     def test_update_assigned_licenses_call_with_entity(self):
3733         salt.utils.vmware.assign_license(
3734             self.mock_si,
3735             self.mock_lic_key,
3736             "fake_license_name",
3737             self.mock_entity_ref,
3738             "fake_entity_name",
3739         )
3740         self.mock_update_assigned_license.assert_called_once_with(
3741             self.mock_moid, self.mock_lic_key, "fake_license_name"
3742         )
3743     def test_update_assigned_licenses_raises_no_permission(self):
3744         exc = vim.fault.NoPermission()
3745         exc.privilegeId = "Fake privilege"
3746         self.mock_lic_assign_mgr.UpdateAssignedLicense = MagicMock(side_effect=exc)
3747         with self.assertRaises(VMwareApiError) as excinfo:
3748             salt.utils.vmware.assign_license(
3749                 self.mock_si,
3750                 self.mock_lic_key,
3751                 "fake_license_name",
3752                 self.mock_entity_ref,
3753                 "fake_entity_name",
3754             )
3755         self.assertEqual(
3756             excinfo.exception.strerror,
3757             "Not enough permissions. Required privilege: Fake privilege",
3758         )
3759     def test_update_assigned_licenses_raises_vim_fault(self):
3760         exc = vim.fault.VimFault()
3761         exc.msg = "VimFault msg"
3762         self.mock_lic_assign_mgr.UpdateAssignedLicense = MagicMock(side_effect=exc)
3763         with self.assertRaises(VMwareApiError) as excinfo:
3764             salt.utils.vmware.assign_license(
3765                 self.mock_si,
3766                 self.mock_lic_key,
3767                 "fake_license_name",
3768                 self.mock_entity_ref,
3769                 "fake_entity_name",
3770             )
3771         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3772     def test_update_assigned_licenses_raises_runtime_fault(self):
3773         exc = vmodl.RuntimeFault()
3774         exc.msg = "RuntimeFault msg"
3775         self.mock_lic_assign_mgr.UpdateAssignedLicense = MagicMock(side_effect=exc)
3776         with self.assertRaises(VMwareRuntimeError) as excinfo:
3777             salt.utils.vmware.assign_license(
3778                 self.mock_si,
3779                 self.mock_lic_key,
3780                 "fake_license_name",
3781                 self.mock_entity_ref,
3782                 "fake_entity_name",
3783             )
3784         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3785     def test_valid_assignments(self):
3786         ret = salt.utils.vmware.assign_license(
3787             self.mock_si,
3788             self.mock_lic_key,
3789             "fake_license_name",
3790             self.mock_entity_ref,
3791             "fake_entity_name",
3792         )
3793         self.assertEqual(ret, self.mock_license)
3794 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3795 class GetStorageSystemTestCase(TestCase):
3796     def setUp(self):
3797         self.mock_si = MagicMock(content=MagicMock())
3798         self.mock_host_ref = MagicMock()
3799         self.mock_get_managed_object_name = MagicMock(return_value="fake_host")
3800         self.mock_traversal_spec = MagicMock()
3801         self.mock_obj = MagicMock()
3802         self.mock_get_mors = MagicMock(return_value=[{"object": self.mock_obj}])
3803         patches = (
3804             (
3805                 "salt.utils.vmware.get_managed_object_name",
3806                 self.mock_get_managed_object_name,
3807             ),
3808             ("salt.utils.vmware.get_mors_with_properties", self.mock_get_mors),
3809             (
3810                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
3811                 MagicMock(return_value=self.mock_traversal_spec),
3812             ),
3813         )
3814         for mod, mock in patches:
3815             patcher = patch(mod, mock)
3816             patcher.start()
3817             self.addCleanup(patcher.stop)
3818     def tearDown(self):
3819         for attr in (
3820             "mock_si",
3821             "mock_host_ref",
3822             "mock_get_managed_object_name",
3823             "mock_traversal_spec",
3824             "mock_obj",
3825         ):
3826             delattr(self, attr)
3827     def test_no_hostname_argument(self):
3828         salt.utils.vmware.get_storage_system(self.mock_si, self.mock_host_ref)
3829         self.mock_get_managed_object_name.assert_called_once_with(self.mock_host_ref)
3830     def test_hostname_argument(self):
3831         salt.utils.vmware.get_storage_system(
3832             self.mock_si, self.mock_host_ref, hostname="fake_host"
3833         )
3834         self.assertEqual(self.mock_get_managed_object_name.call_count, 0)
3835     def test_traversal_spec(self):
3836         mock_traversal_spec = MagicMock(return_value=[{"object": self.mock_obj}])
3837         with patch(
3838             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
3839             mock_traversal_spec,
3840         ):
3841             salt.utils.vmware.get_storage_system(self.mock_si, self.mock_host_ref)
3842         mock_traversal_spec.assert_called_once_with(
3843             path="configManager.storageSystem", type=vim.HostSystem, skip=False
3844         )
3845     def test_get_mors_with_properties(self):
3846         salt.utils.vmware.get_storage_system(self.mock_si, self.mock_host_ref)
3847         self.mock_get_mors.assert_called_once_with(
3848             self.mock_si,
3849             vim.HostStorageSystem,
3850             property_list=["systemFile"],
3851             container_ref=self.mock_host_ref,
3852             traversal_spec=self.mock_traversal_spec,
3853         )
3854     def test_empty_mors_result(self):
3855         with patch(
3856             "salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])
3857         ):
3858             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
3859                 salt.utils.vmware.get_storage_system(self.mock_si, self.mock_host_ref)
3860         self.assertEqual(
3861             excinfo.exception.strerror,
3862             "Host's 'fake_host' storage system was not retrieved",
3863         )
3864     def test_valid_mors_result(self):
3865         res = salt.utils.vmware.get_storage_system(self.mock_si, self.mock_host_ref)
3866         self.assertEqual(res, self.mock_obj)
3867 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3868 class GetDatastoresTestCase(TestCase):
3869     def setUp(self):
3870         self.mock_si = MagicMock()
3871         self.mock_reference = MagicMock(spec=vim.HostSystem)
3872         self.mock_mount_infos = [
3873             MagicMock(
3874                 volume=MagicMock(
3875                     spec=vim.HostVmfsVolume, extent=[MagicMock(diskName="fake_disk2")]
3876                 )
3877             ),
3878             MagicMock(
3879                 volume=MagicMock(
3880                     spec=vim.HostVmfsVolume, extent=[MagicMock(diskName="fake_disk3")]
3881                 )
3882             ),
3883         ]
3884         self.mock_mount_infos[0].volume.name = "fake_ds2"
3885         self.mock_mount_infos[1].volume.name = "fake_ds3"
3886         self.mock_entries = [
3887             {"name": "fake_ds1", "object": MagicMock()},
3888             {"name": "fake_ds2", "object": MagicMock()},
3889             {"name": "fake_ds3", "object": MagicMock()},
3890         ]
3891         self.mock_storage_system = MagicMock()
3892         self.mock_get_storage_system = MagicMock(return_value=self.mock_storage_system)
3893         self.mock_get_managed_object_name = MagicMock(return_value="fake_host")
3894         self.mock_traversal_spec = MagicMock()
3895         patches = (
3896             (
3897                 "salt.utils.vmware.get_managed_object_name",
3898                 self.mock_get_managed_object_name,
3899             ),
3900             ("salt.utils.vmware.get_storage_system", self.mock_get_storage_system),
3901             (
3902                 "salt.utils.vmware.get_properties_of_managed_object",
3903                 MagicMock(
3904                     return_value={
3905                         "fileSystemVolumeInfo.mountInfo": self.mock_mount_infos
3906                     }
3907                 ),
3908             ),
3909             (
3910                 "salt.utils.vmware.get_mors_with_properties",
3911                 MagicMock(return_value=self.mock_entries),
3912             ),
3913             (
3914                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
3915                 MagicMock(return_value=self.mock_traversal_spec),
3916             ),
3917         )
3918         for mod, mock in patches:
3919             patcher = patch(mod, mock)
3920             patcher.start()
3921             self.addCleanup(patcher.stop)
3922     def tearDown(self):
3923         for attr in (
3924             "mock_si",
3925             "mock_reference",
3926             "mock_storage_system",
3927             "mock_get_storage_system",
3928             "mock_mount_infos",
3929             "mock_entries",
3930             "mock_get_managed_object_name",
3931             "mock_traversal_spec",
3932         ):
3933             delattr(self, attr)
3934     def test_get_reference_name_call(self):
3935         salt.utils.vmware.get_datastores(self.mock_si, self.mock_reference)
3936         self.mock_get_managed_object_name.assert_called_once_with(self.mock_reference)
3937     def test_get_no_datastores(self):
3938         res = salt.utils.vmware.get_datastores(self.mock_si, self.mock_reference)
3939         self.assertEqual(res, [])
3940     def test_get_storage_system_call(self):
3941         salt.utils.vmware.get_datastores(
3942             self.mock_si, self.mock_reference, backing_disk_ids=["fake_disk1"]
3943         )
3944         self.mock_get_storage_system.assert_called_once_with(
3945             self.mock_si, self.mock_reference, "fake_host"
3946         )
3947     def test_get_mount_info_call(self):
3948         mock_get_properties_of_managed_object = MagicMock()
3949         with patch(
3950             "salt.utils.vmware.get_properties_of_managed_object",
3951             mock_get_properties_of_managed_object,
3952         ):
3953             salt.utils.vmware.get_datastores(
3954                 self.mock_si, self.mock_reference, backing_disk_ids=["fake_disk1"]
3955             )
3956         mock_get_properties_of_managed_object.assert_called_once_with(
3957             self.mock_storage_system, ["fileSystemVolumeInfo.mountInfo"]
3958         )
3959     def test_backing_disks_no_mount_info(self):
3960         with patch(
3961             "salt.utils.vmware.get_properties_of_managed_object",
3962             MagicMock(return_value={}),
3963         ):
3964             res = salt.utils.vmware.get_datastores(
3965                 self.mock_si, self.mock_reference, backing_disk_ids=["fake_disk_id"]
3966             )
3967         self.assertEqual(res, [])
3968     def test_host_traversal_spec(self):
3969         mock_traversal_spec_init = MagicMock()
3970         with patch(
3971             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
3972             mock_traversal_spec_init,
3973         ):
3974             salt.utils.vmware.get_datastores(
3975                 self.mock_si, self.mock_reference, get_all_datastores=True
3976             )
3977         mock_traversal_spec_init.assert_called_once_with(
3978             name="host_datastore_traversal",
3979             path="datastore",
3980             skip=False,
3981             type=vim.HostSystem,
3982         )
3983     def test_cluster_traversal_spec(self):
3984         mock_traversal_spec_init = MagicMock()
3985         mock_reference = MagicMock(spec=vim.ClusterComputeResource)
3986         with patch(
3987             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
3988             mock_traversal_spec_init,
3989         ):
3990             salt.utils.vmware.get_datastores(
3991                 self.mock_si, mock_reference, get_all_datastores=True
3992             )
3993         mock_traversal_spec_init.assert_called_once_with(
3994             name="cluster_datastore_traversal",
3995             path="datastore",
3996             skip=False,
3997             type=vim.ClusterComputeResource,
3998         )
3999     def test_datacenter_traversal_spec(self):
4000         mock_traversal_spec_init = MagicMock()
4001         mock_reference = MagicMock(spec=vim.Datacenter)
4002         with patch(
4003             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
4004             mock_traversal_spec_init,
4005         ):
4006             salt.utils.vmware.get_datastores(
4007                 self.mock_si, mock_reference, get_all_datastores=True
4008             )
4009         mock_traversal_spec_init.assert_called_once_with(
4010             name="datacenter_datastore_traversal",
4011             path="datastore",
4012             skip=False,
4013             type=vim.Datacenter,
4014         )
4015     def test_root_folder_traversal_spec(self):
4016         mock_traversal_spec_init = MagicMock(return_value="traversal")
4017         mock_reference = MagicMock(spec=vim.Folder)
4018         with patch(
4019             "salt.utils.vmware.get_managed_object_name",
4020             MagicMock(side_effect=["fake_host", "Datacenters"]),
4021         ):
4022             with patch(
4023                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
4024                 mock_traversal_spec_init,
4025             ):
4026                 salt.utils.vmware.get_datastores(
4027                     self.mock_si, mock_reference, get_all_datastores=True
4028                 )
4029         mock_traversal_spec_init.assert_has_calls(
4030             [
4031                 call(path="datastore", skip=False, type=vim.Datacenter),
4032                 call(
4033                     path="childEntity",
4034                     selectSet=["traversal"],
4035                     skip=False,
4036                     type=vim.Folder,
4037                 ),
4038             ]
4039         )
4040     def test_unsupported_reference_type(self):
4041         class FakeClass:
4042             pass
4043         mock_reference = MagicMock(spec=FakeClass)
4044         with self.assertRaises(ArgumentValueError) as excinfo:
4045             salt.utils.vmware.get_datastores(
4046                 self.mock_si, mock_reference, get_all_datastores=True
4047             )
4048         self.assertEqual(
4049             excinfo.exception.strerror, "Unsupported reference type 'FakeClass'"
4050         )
4051     def test_get_mors_with_properties(self):
4052         mock_get_mors_with_properties = MagicMock()
4053         with patch(
4054             "salt.utils.vmware.get_mors_with_properties", mock_get_mors_with_properties
4055         ):
4056             salt.utils.vmware.get_datastores(
4057                 self.mock_si, self.mock_reference, get_all_datastores=True
4058             )
4059         mock_get_mors_with_properties.assert_called_once_with(
4060             self.mock_si,
4061             object_type=vim.Datastore,
4062             property_list=["name"],
4063             container_ref=self.mock_reference,
4064             traversal_spec=self.mock_traversal_spec,
4065         )
4066     def test_get_all_datastores(self):
4067         res = salt.utils.vmware.get_datastores(
4068             self.mock_si, self.mock_reference, get_all_datastores=True
4069         )
4070         self.assertEqual(
4071             res,
4072             [
4073                 self.mock_entries[0]["object"],
4074                 self.mock_entries[1]["object"],
4075                 self.mock_entries[2]["object"],
4076             ],
4077         )
4078     def test_get_datastores_filtered_by_name(self):
4079         res = salt.utils.vmware.get_datastores(
4080             self.mock_si, self.mock_reference, datastore_names=["fake_ds1", "fake_ds2"]
4081         )
4082         self.assertEqual(
4083             res, [self.mock_entries[0]["object"], self.mock_entries[1]["object"]]
4084         )
4085     def test_get_datastores_filtered_by_backing_disk(self):
4086         res = salt.utils.vmware.get_datastores(
4087             self.mock_si,
4088             self.mock_reference,
4089             backing_disk_ids=["fake_disk2", "fake_disk3"],
4090         )
4091         self.assertEqual(
4092             res, [self.mock_entries[1]["object"], self.mock_entries[2]["object"]]
4093         )
4094     def test_get_datastores_filtered_by_both_name_and_backing_disk(self):
4095         res = salt.utils.vmware.get_datastores(
4096             self.mock_si,
4097             self.mock_reference,
4098             datastore_names=["fake_ds1"],
4099             backing_disk_ids=["fake_disk3"],
4100         )
4101         self.assertEqual(
4102             res, [self.mock_entries[0]["object"], self.mock_entries[2]["object"]]
4103         )
4104 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
4105 class RenameDatastoreTestCase(TestCase):
4106     def setUp(self):
4107         self.mock_ds_ref = MagicMock()
4108         self.mock_get_managed_object_name = MagicMock(return_value="fake_ds")
4109         patches = (
4110             (
4111                 "salt.utils.vmware.get_managed_object_name",
4112                 self.mock_get_managed_object_name,
4113             ),
4114         )
4115         for mod, mock in patches:
4116             patcher = patch(mod, mock)
4117             patcher.start()
4118             self.addCleanup(patcher.stop)
4119     def tearDown(self):
4120         for attr in ("mock_ds_ref", "mock_get_managed_object_name"):
4121             delattr(self, attr)
4122     def test_datastore_name_call(self):
4123         salt.utils.vmware.rename_datastore(self.mock_ds_ref, "fake_new_name")
4124         self.mock_get_managed_object_name.assert_called_once_with(self.mock_ds_ref)
4125     def test_rename_datastore_raise_no_permission(self):
4126         exc = vim.fault.NoPermission()
4127         exc.privilegeId = "Fake privilege"
4128         type(self.mock_ds_ref).RenameDatastore = MagicMock(side_effect=exc)
4129         with self.assertRaises(VMwareApiError) as excinfo:
4130             salt.utils.vmware.rename_datastore(self.mock_ds_ref, "fake_new_name")
4131         self.assertEqual(
4132             excinfo.exception.strerror,
4133             "Not enough permissions. Required privilege: Fake privilege",
4134         )
4135     def test_rename_datastore_raise_vim_fault(self):
4136         exc = vim.VimFault()
4137         exc.msg = "vim_fault"
4138         type(self.mock_ds_ref).RenameDatastore = MagicMock(side_effect=exc)
4139         with self.assertRaises(VMwareApiError) as excinfo:
4140             salt.utils.vmware.rename_datastore(self.mock_ds_ref, "fake_new_name")
4141         self.assertEqual(excinfo.exception.strerror, "vim_fault")
4142     def test_rename_datastore_raise_runtime_fault(self):
4143         exc = vmodl.RuntimeFault()
4144         exc.msg = "runtime_fault"
4145         type(self.mock_ds_ref).RenameDatastore = MagicMock(side_effect=exc)
4146         with self.assertRaises(VMwareRuntimeError) as excinfo:
4147             salt.utils.vmware.rename_datastore(self.mock_ds_ref, "fake_new_name")
4148         self.assertEqual(excinfo.exception.strerror, "runtime_fault")
4149     def test_rename_datastore(self):
4150         salt.utils.vmware.rename_datastore(self.mock_ds_ref, "fake_new_name")
4151         self.mock_ds_ref.RenameDatastore.assert_called_once_with("fake_new_name")
4152 class ConvertToKbTestCase(TestCase):
4153     def setUp(self):
4154         pass
4155     def test_gb_conversion_call(self):
4156         self.assertEqual(
4157             salt.utils.vmware.convert_to_kb("Gb", 10),
4158             {"size": int(10485760), "unit": "KB"},
4159         )
4160     def test_mb_conversion_call(self):
4161         self.assertEqual(
4162             salt.utils.vmware.convert_to_kb("Mb", 10),
4163             {"size": int(10240), "unit": "KB"},
4164         )
4165     def test_kb_conversion_call(self):
4166         self.assertEqual(
4167             salt.utils.vmware.convert_to_kb("Kb", 10), {"size": int(10), "unit": "KB"}
4168         )
4169     def test_conversion_bad_input_argument_fault(self):
4170         self.assertRaises(
4171             ArgumentValueError, salt.utils.vmware.convert_to_kb, "test", 10
4172         )
4173 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
4174 @patch("salt.utils.vmware.get_managed_object_name", MagicMock())
4175 @patch("salt.utils.vmware.wait_for_task", MagicMock())
4176 class CreateVirtualMachineTestCase(TestCase):
4177     def setUp(self):
4178         self.vm_name = "fake_vm"
4179         self.mock_task = MagicMock()
4180         self.mock_config_spec = MagicMock()
4181         self.mock_resourcepool_object = MagicMock()
4182         self.mock_host_object = MagicMock()
4183         self.mock_vm_create_task = MagicMock(return_value=self.mock_task)
4184         self.mock_folder_object = MagicMock(CreateVM_Task=self.mock_vm_create_task)
4185     def test_create_vm_pool_task_call(self):
4186         salt.utils.vmware.create_vm(
4187             self.vm_name,
4188             self.mock_config_spec,
4189             self.mock_folder_object,
4190             self.mock_resourcepool_object,
4191         )
4192         self.mock_vm_create_task.assert_called_once()
4193     def test_create_vm_host_task_call(self):
4194         salt.utils.vmware.create_vm(
4195             self.vm_name,
4196             self.mock_config_spec,
4197             self.mock_folder_object,
4198             self.mock_resourcepool_object,
4199             host_object=self.mock_host_object,
4200         )
4201         self.mock_vm_create_task.assert_called_once()
4202     def test_create_vm_raise_no_permission(self):
4203         exception = vim.fault.NoPermission()
4204         exception.msg = "vim.fault.NoPermission msg"
4205         self.mock_folder_object.CreateVM_Task = MagicMock(side_effect=exception)
4206         with self.assertRaises(VMwareApiError) as exc:
4207             salt.utils.vmware.create_vm(
4208                 self.vm_name,
4209                 self.mock_config_spec,
4210                 self.mock_folder_object,
4211                 self.mock_resourcepool_object,
4212             )
4213         self.assertEqual(
4214             exc.exception.strerror, "Not enough permissions. Required privilege: "
4215         )
4216     def test_create_vm_raise_vim_fault(self):
4217         exception = vim.fault.VimFault()
4218         exception.msg = "vim.fault.VimFault msg"
4219         self.mock_folder_object.CreateVM_Task = MagicMock(side_effect=exception)
4220         with self.assertRaises(VMwareApiError) as exc:
4221             salt.utils.vmware.create_vm(
4222                 self.vm_name,
4223                 self.mock_config_spec,
4224                 self.mock_folder_object,
4225                 self.mock_resourcepool_object,
4226             )
4227         self.assertEqual(exc.exception.strerror, "vim.fault.VimFault msg")
4228     def test_create_vm_raise_runtime_fault(self):
4229         exception = vmodl.RuntimeFault()
4230         exception.msg = "vmodl.RuntimeFault msg"
4231         self.mock_folder_object.CreateVM_Task = MagicMock(side_effect=exception)
4232         with self.assertRaises(VMwareRuntimeError) as exc:
4233             salt.utils.vmware.create_vm(
4234                 self.vm_name,
4235                 self.mock_config_spec,
4236                 self.mock_folder_object,
4237                 self.mock_resourcepool_object,
4238             )
4239         self.assertEqual(exc.exception.strerror, "vmodl.RuntimeFault msg")
4240     def test_create_vm_wait_for_task(self):
4241         mock_wait_for_task = MagicMock()
4242         with patch("salt.utils.vmware.wait_for_task", mock_wait_for_task):
4243             salt.utils.vmware.create_vm(
4244                 self.vm_name,
4245                 self.mock_config_spec,
4246                 self.mock_folder_object,
4247                 self.mock_resourcepool_object,
4248             )
4249         mock_wait_for_task.assert_called_once_with(
4250             self.mock_task, self.vm_name, "CreateVM Task", 10, "info"
4251         )
4252 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
4253 @patch("salt.utils.vmware.get_managed_object_name", MagicMock())
4254 @patch("salt.utils.vmware.wait_for_task", MagicMock())
4255 class RegisterVirtualMachineTestCase(TestCase):
4256     def setUp(self):
4257         self.vm_name = "fake_vm"
4258         self.mock_task = MagicMock()
4259         self.mock_vmx_path = MagicMock()
4260         self.mock_resourcepool_object = MagicMock()
4261         self.mock_host_object = MagicMock()
4262         self.mock_vm_register_task = MagicMock(return_value=self.mock_task)
4263         self.vm_folder_object = MagicMock(RegisterVM_Task=self.mock_vm_register_task)
4264         self.datacenter = MagicMock(vmFolder=self.vm_folder_object)
4265     def test_register_vm_pool_task_call(self):
4266         salt.utils.vmware.register_vm(
4267             self.datacenter,
4268             self.vm_name,
4269             self.mock_vmx_path,
4270             self.mock_resourcepool_object,
4271         )
4272         self.mock_vm_register_task.assert_called_once()
4273     def test_register_vm_host_task_call(self):
4274         salt.utils.vmware.register_vm(
4275             self.datacenter,
4276             self.vm_name,
4277             self.mock_vmx_path,
4278             self.mock_resourcepool_object,
4279             host_object=self.mock_host_object,
4280         )
4281         self.mock_vm_register_task.assert_called_once()
4282     def test_register_vm_raise_no_permission(self):
4283         exception = vim.fault.NoPermission()
4284         self.vm_folder_object.RegisterVM_Task = MagicMock(side_effect=exception)
4285         with self.assertRaises(VMwareApiError) as exc:
4286             salt.utils.vmware.register_vm(
4287                 self.datacenter,
4288                 self.vm_name,
4289                 self.mock_vmx_path,
4290                 self.mock_resourcepool_object,
4291             )
4292         self.assertEqual(
4293             exc.exception.strerror, "Not enough permissions. Required privilege: "
4294         )
4295     def test_register_vm_raise_vim_fault(self):
4296         exception = vim.fault.VimFault()
4297         exception.msg = "vim.fault.VimFault msg"
4298         self.vm_folder_object.RegisterVM_Task = MagicMock(side_effect=exception)
4299         with self.assertRaises(VMwareApiError) as exc:
4300             salt.utils.vmware.register_vm(
4301                 self.datacenter,
4302                 self.vm_name,
4303                 self.mock_vmx_path,
4304                 self.mock_resourcepool_object,
4305             )
4306         self.assertEqual(exc.exception.strerror, "vim.fault.VimFault msg")
4307     def test_register_vm_raise_runtime_fault(self):
4308         exception = vmodl.RuntimeFault()
4309         exception.msg = "vmodl.RuntimeFault msg"
4310         self.vm_folder_object.RegisterVM_Task = MagicMock(side_effect=exception)
4311         with self.assertRaises(VMwareRuntimeError) as exc:
4312             salt.utils.vmware.register_vm(
4313                 self.datacenter,
4314                 self.vm_name,
4315                 self.mock_vmx_path,
4316                 self.mock_resourcepool_object,
4317             )
4318         self.assertEqual(exc.exception.strerror, "vmodl.RuntimeFault msg")
4319     def test_register_vm_wait_for_task(self):
4320         mock_wait_for_task = MagicMock()
4321         with patch("salt.utils.vmware.wait_for_task", mock_wait_for_task):
4322             salt.utils.vmware.register_vm(
4323                 self.datacenter,
4324                 self.vm_name,
4325                 self.mock_vmx_path,
4326                 self.mock_resourcepool_object,
4327             )
4328         mock_wait_for_task.assert_called_once_with(
4329             self.mock_task, self.vm_name, "RegisterVM Task"
4330         )
4331 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
4332 @patch("salt.utils.vmware.get_managed_object_name", MagicMock())
4333 @patch("salt.utils.vmware.wait_for_task", MagicMock())
4334 class UpdateVirtualMachineTestCase(TestCase):
4335     def setUp(self):
4336         self.mock_task = MagicMock()
4337         self.mock_config_spec = MagicMock()
4338         self.mock_vm_update_task = MagicMock(return_value=self.mock_task)
4339         self.mock_vm_ref = MagicMock(ReconfigVM_Task=self.mock_vm_update_task)
4340     def test_update_vm_task_call(self):
4341         salt.utils.vmware.update_vm(self.mock_vm_ref, self.mock_config_spec)
4342         self.mock_vm_update_task.assert_called_once()
4343     def test_update_vm_raise_vim_fault(self):
4344         exception = vim.fault.VimFault()
4345         exception.msg = "vim.fault.VimFault"
4346         self.mock_vm_ref.ReconfigVM_Task = MagicMock(side_effect=exception)
4347         with self.assertRaises(VMwareApiError) as exc:
4348             salt.utils.vmware.update_vm(self.mock_vm_ref, self.mock_config_spec)
4349         self.assertEqual(exc.exception.strerror, "vim.fault.VimFault")
4350     def test_update_vm_raise_runtime_fault(self):
4351         exception = vmodl.RuntimeFault()
4352         exception.msg = "vmodl.RuntimeFault"
4353         self.mock_vm_ref.ReconfigVM_Task = MagicMock(side_effect=exception)
4354         with self.assertRaises(VMwareRuntimeError) as exc:
4355             salt.utils.vmware.update_vm(self.mock_vm_ref, self.mock_config_spec)
4356         self.assertEqual(exc.exception.strerror, "vmodl.RuntimeFault")
4357     def test_update_vm_wait_for_task(self):
4358         mock_wait_for_task = MagicMock()
4359         with patch(
4360             "salt.utils.vmware.get_managed_object_name", MagicMock(return_value="my_vm")
4361         ):
4362             with patch("salt.utils.vmware.wait_for_task", mock_wait_for_task):
4363                 salt.utils.vmware.update_vm(self.mock_vm_ref, self.mock_config_spec)
4364         mock_wait_for_task.assert_called_once_with(
4365             self.mock_task, "my_vm", "ReconfigureVM Task"
4366         )
4367 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
4368 @patch("salt.utils.vmware.get_managed_object_name", MagicMock())
4369 @patch("salt.utils.vmware.wait_for_task", MagicMock())
4370 class DeleteVirtualMachineTestCase(TestCase):
4371     def setUp(self):
4372         self.mock_task = MagicMock()
4373         self.mock_vm_destroy_task = MagicMock(return_value=self.mock_task)
4374         self.mock_vm_ref = MagicMock(Destroy_Task=self.mock_vm_destroy_task)
4375     def test_destroy_vm_task_call(self):
4376         salt.utils.vmware.delete_vm(self.mock_vm_ref)
4377         self.mock_vm_destroy_task.assert_called_once()
4378     def test_destroy_vm_raise_vim_fault(self):
4379         exception = vim.fault.VimFault()
4380         exception.msg = "vim.fault.VimFault"
4381         self.mock_vm_ref.Destroy_Task = MagicMock(side_effect=exception)
4382         with self.assertRaises(VMwareApiError) as exc:
4383             salt.utils.vmware.delete_vm(self.mock_vm_ref)
4384         self.assertEqual(exc.exception.strerror, "vim.fault.VimFault")
4385     def test_destroy_vm_raise_runtime_fault(self):
4386         exception = vmodl.RuntimeFault()
4387         exception.msg = "vmodl.RuntimeFault"
4388         self.mock_vm_ref.Destroy_Task = MagicMock(side_effect=exception)
4389         with self.assertRaises(VMwareRuntimeError) as exc:
4390             salt.utils.vmware.delete_vm(self.mock_vm_ref)
4391         self.assertEqual(exc.exception.strerror, "vmodl.RuntimeFault")
4392     def test_destroy_vm_wait_for_task(self):
4393         mock_wait_for_task = MagicMock()
4394         with patch(
4395             "salt.utils.vmware.get_managed_object_name", MagicMock(return_value="my_vm")
4396         ):
4397             with patch("salt.utils.vmware.wait_for_task", mock_wait_for_task):
4398                 salt.utils.vmware.delete_vm(self.mock_vm_ref)
4399         mock_wait_for_task.assert_called_once_with(
4400             self.mock_task, "my_vm", "Destroy Task"
4401         )
4402 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
4403 @patch("salt.utils.vmware.get_managed_object_name", MagicMock())
4404 class UnregisterVirtualMachineTestCase(TestCase):
4405     def setUp(self):
4406         self.mock_vm_unregister = MagicMock()
4407         self.mock_vm_ref = MagicMock(UnregisterVM=self.mock_vm_unregister)
4408     def test_unregister_vm_task_call(self):
4409         salt.utils.vmware.unregister_vm(self.mock_vm_ref)
4410         self.mock_vm_unregister.assert_called_once()
4411     def test_unregister_vm_raise_vim_fault(self):
4412         exception = vim.fault.VimFault()
4413         exception.msg = "vim.fault.VimFault"
4414         self.mock_vm_ref.UnregisterVM = MagicMock(side_effect=exception)
4415         with self.assertRaises(VMwareApiError) as exc:
4416             salt.utils.vmware.unregister_vm(self.mock_vm_ref)
4417         self.assertEqual(exc.exception.strerror, "vim.fault.VimFault")
4418     def test_unregister_vm_raise_runtime_fault(self):
4419         exception = vmodl.RuntimeFault()
4420         exception.msg = "vmodl.RuntimeFault"
4421         self.mock_vm_ref.UnregisterVM = MagicMock(side_effect=exception)
4422         with self.assertRaises(VMwareRuntimeError) as exc:
4423             salt.utils.vmware.unregister_vm(self.mock_vm_ref)
4424         self.assertEqual(exc.exception.strerror, "vmodl.RuntimeFault")
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
