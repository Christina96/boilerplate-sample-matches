<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for status_1.py &amp; test_vmware_2.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for status_1.py &amp; test_vmware_2.py
      </h3>
<h1 align="center">
        0.4%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>status_1.py (0.95129377%)<th>test_vmware_2.py (0.26263264%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(364-367)<td><a href="#" name="0">(2708-2719)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(100-110)<td><a href="#" name="1">(1243-1249)</a><td align="center"><font color="#eb0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>status_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import collections
2 import copy
3 import datetime
4 import fnmatch
5 import itertools
6 import logging
7 import os
8 import re
9 import time
10 import salt.channel
11 import salt.config
12 import salt.minion
13 import salt.utils.event
14 import salt.utils.files
15 import salt.utils.network
16 import salt.utils.path
17 import salt.utils.platform
18 import salt.utils.stringutils
19 from salt.exceptions import CommandExecutionError
20 log = logging.getLogger(__file__)
21 __virtualname__ = "status"
22 __func_alias__ = {"time_": "time"}
23 log = logging.getLogger(__name__)
24 def __virtual__():
25     if salt.utils.platform.is_windows():
26         return False, "Windows platform is not supported by this module"
27     return __virtualname__
28 def _number(text):
29     if text.isdigit():
30         return int(text)
31     try:
32         return float(text)
33     except ValueError:
34         return text
35 def _get_boot_time_aix():
36     res = __salt__["cmd.run_all"]("ps -o etime= -p 1")
37     if res["retcode"] &gt; 0:
38         raise CommandExecutionError("Unable to find boot_time for pid 1.")
39     bt_time = res["stdout"]
40     match = re.match(r"\s*(?:(\d+)-)?(?:(\d\d):)?(\d\d):(\d\d)\s*", bt_time)
41     if not match:
42         raise CommandExecutionError("Unexpected time format.")
43     groups = match.groups(default="00")
44     boot_secs = (
45         _number(groups[0]) * 86400
46         + _number(groups[1]) * 3600
47         + _number(groups[2]) * 60
48         + _number(groups[3])
49     )
50     return boot_secs
51 def _aix_loadavg():
52     uptime = __salt__["cmd.run"]("uptime")
53 <a name="1"></a>    ldavg = uptime.split("load average")
54     load_avg = ldavg[1].split()
55     return {
56         <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"1-min": load_avg[1].strip(","),
57         "5-min": load_avg[2].strip(","),
58         "15-min": load_avg[3],
59     }
60 def _aix_nproc():
61     nprocs = __salt__[</b></font>"cmd.run"](
62         "lsattr -E -l sys0 | grep maxuproc", python_shell=True
63     ).split()
64     return _number(nprocs[1])
65 def procs():
66     ret = {}
67     uind = 0
68     pind = 0
69     cind = 0
70     plines = __salt__["cmd.run"](__grains__["ps"], python_shell=True).splitlines()
71     guide = plines.pop(0).split()
72     if "USER" in guide:
73         uind = guide.index("USER")
74     elif "UID" in guide:
75         uind = guide.index("UID")
76     if "PID" in guide:
77         pind = guide.index("PID")
78     if "COMMAND" in guide:
79         cind = guide.index("COMMAND")
80     elif "CMD" in guide:
81         cind = guide.index("CMD")
82     for line in plines:
83         if not line:
84             continue
85         comps = line.split()
86         ret[comps[pind]] = {"user": comps[uind], "cmd": " ".join(comps[cind:])}
87     return ret
88 def custom():
89     ret = {}
90     conf = __salt__["config.dot_vals"]("status")
91     for key, val in conf.items():
92         func = "{}()".format(key.split(".")[1])
93         vals = eval(func)  # pylint: disable=W0123
94         for item in val:
95             ret[item] = vals[item]
96     return ret
97 def uptime():
98     curr_seconds = time.time()
99     if salt.utils.platform.is_linux():
100         ut_path = "/proc/uptime"
101         if not os.path.exists(ut_path):
102             raise CommandExecutionError(
103                 "File {ut_path} was not found.".format(ut_path=ut_path)
104             )
105         with salt.utils.files.fopen(ut_path) as rfh:
106             seconds = int(float(rfh.read().split()[0]))
107     elif salt.utils.platform.is_sunos():
108         res = __salt__["cmd.run_all"]("kstat -p unix:0:system_misc:boot_time")
109         if res["retcode"] &gt; 0:
110             raise CommandExecutionError("The boot_time kstat was not found.")
111         seconds = int(curr_seconds - int(res["stdout"].split()[-1]))
112     elif salt.utils.platform.is_openbsd() or salt.utils.platform.is_netbsd():
113         bt_data = __salt__["sysctl.get"]("kern.boottime")
114         if not bt_data:
115             raise CommandExecutionError("Cannot find kern.boottime system parameter")
116         seconds = int(curr_seconds - int(bt_data))
117     elif salt.utils.platform.is_freebsd() or salt.utils.platform.is_darwin():
118         bt_data = __salt__["sysctl.get"]("kern.boottime")
119         if not bt_data:
120             raise CommandExecutionError("Cannot find kern.boottime system parameter")
121         data = bt_data.split("{")[-1].split("}")[0].strip().replace(" ", "")
122         uptime = {
123             k: int(
124                 v,
125             )
126             for k, v in [p.strip().split("=") for p in data.split(",")]
127         }
128         seconds = int(curr_seconds - uptime["sec"])
129     elif salt.utils.platform.is_aix():
130         seconds = _get_boot_time_aix()
131     else:
132         return __salt__["cmd.run"]("uptime")
133     boot_time = datetime.datetime.utcfromtimestamp(curr_seconds - seconds)
134     curr_time = datetime.datetime.utcfromtimestamp(curr_seconds)
135     up_time = curr_time - boot_time
136     ut_ret = {
137         "seconds": seconds,
138         "since_iso": boot_time.isoformat(),
139         "since_t": int(curr_seconds - seconds),
140         "days": up_time.days,
141         "time": "{}:{}".format(up_time.seconds // 3600, up_time.seconds % 3600 // 60),
142     }
143     if salt.utils.path.which("who"):
144         who_cmd = (
145             "who" if salt.utils.platform.is_openbsd() else "who -s"
146         )  # OpenBSD does not support -s
147         ut_ret["users"] = len(__salt__["cmd.run"](who_cmd).split(os.linesep))
148     return ut_ret
149 def loadavg():
150     if __grains__["kernel"] == "AIX":
151         return _aix_loadavg()
152     try:
153         load_avg = os.getloadavg()
154     except AttributeError:
155         raise salt.exceptions.CommandExecutionError(
156             "status.loadavag is not available on your platform"
157         )
158     return {"1-min": load_avg[0], "5-min": load_avg[1], "15-min": load_avg[2]}
159 def cpustats():
160     def linux_cpustats():
161         ret = {}
162         try:
163             with salt.utils.files.fopen("/proc/stat", "r") as fp_:
164                 stats = salt.utils.stringutils.to_unicode(fp_.read())
165         except OSError:
166             pass
167         else:
168             for line in stats.splitlines():
169                 if not line:
170                     continue
171                 comps = line.split()
172                 if comps[0] == "cpu":
173                     ret[comps[0]] = {
174                         "idle": _number(comps[4]),
175                         "iowait": _number(comps[5]),
176                         "irq": _number(comps[6]),
177                         "nice": _number(comps[2]),
178                         "softirq": _number(comps[7]),
179                         "steal": _number(comps[8]),
180                         "system": _number(comps[3]),
181                         "user": _number(comps[1]),
182                     }
183                 elif comps[0] == "intr":
184                     ret[comps[0]] = {
185                         "total": _number(comps[1]),
186                         "irqs": [_number(x) for x in comps[2:]],
187                     }
188                 elif comps[0] == "softirq":
189                     ret[comps[0]] = {
190                         "total": _number(comps[1]),
191                         "softirqs": [_number(x) for x in comps[2:]],
192                     }
193                 else:
194                     ret[comps[0]] = _number(comps[1])
195         return ret
196     def freebsd_cpustats():
197         vmstat = __salt__["cmd.run"]("vmstat -P").splitlines()
198         vm0 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= vmstat[0].split()
199         cpu0loc = vm0.index("cpu0")
200         vm1 = vmstat[1].split()
201         usloc = vm1.</b></font>index("us")
202         vm2 = vmstat[2].split()
203         cpuctr = 0
204         ret = {}
205         for cpu in vm0[cpu0loc:]:
206             ret[cpu] = {
207                 "us": _number(vm2[usloc + 3 * cpuctr]),
208                 "sy": _number(vm2[usloc + 1 + 3 * cpuctr]),
209                 "id": _number(vm2[usloc + 2 + 3 * cpuctr]),
210             }
211             cpuctr += 1
212         return ret
213     def sunos_cpustats():
214         mpstat = __salt__["cmd.run"]("mpstat 1 2").splitlines()
215         fields = mpstat[0].split()
216         ret = {}
217         for cpu in mpstat:
218             if cpu.startswith("CPU"):
219                 continue
220             cpu = cpu.split()
221             ret[_number(cpu[0])] = {}
222             for i in range(1, len(fields) - 1):
223                 ret[_number(cpu[0])][fields[i]] = _number(cpu[i])
224         return ret
225     def aix_cpustats():
226         ret = {}
227         ret["mpstat"] = []
228         procn = None
229         fields = []
230         for line in __salt__["cmd.run"]("mpstat -a").splitlines():
231             if not line:
232                 continue
233             procn = len(ret["mpstat"])
234             if line.startswith("System"):
235                 comps = line.split(":")
236                 ret["mpstat"].append({})
237                 ret["mpstat"][procn]["system"] = {}
238                 cpu_comps = comps[1].split()
239                 for comp in cpu_comps:
240                     cpu_vals = comp.split("=")
241                     ret["mpstat"][procn]["system"][cpu_vals[0]] = cpu_vals[1]
242             if line.startswith("cpu"):
243                 fields = line.split()
244                 continue
245             if fields:
246                 cpustat = line.split()
247                 ret[_number(cpustat[0])] = {}
248                 for i in range(1, len(fields) - 1):
249                     ret[_number(cpustat[0])][fields[i]] = _number(cpustat[i])
250         return ret
251     def openbsd_cpustats():
252         systat = __salt__["cmd.run"]("systat -s 2 -B cpu").splitlines()
253         fields = systat[3].split()
254         ret = {}
255         for cpu in systat[4:]:
256             cpu_line = cpu.split()
257             cpu_idx = cpu_line[0]
258             ret[cpu_idx] = {}
259             for idx, field in enumerate(fields[1:]):
260                 ret[cpu_idx][field] = cpu_line[idx + 1]
261         return ret
262     get_version = {
263         "Linux": linux_cpustats,
264         "FreeBSD": freebsd_cpustats,
265         "Junos": freebsd_cpustats,
266         "OpenBSD": openbsd_cpustats,
267         "SunOS": sunos_cpustats,
268         "AIX": aix_cpustats,
269     }
270     errmsg = "This method is unsupported on the current operating system!"
271     return get_version.get(__grains__["kernel"], lambda: errmsg)()
272 def meminfo():
273     def linux_meminfo():
274         ret = {}
275         try:
276             with salt.utils.files.fopen("/proc/meminfo", "r") as fp_:
277                 stats = salt.utils.stringutils.to_unicode(fp_.read())
278         except OSError:
279             pass
280         else:
281             for line in stats.splitlines():
282                 if not line:
283                     continue
284                 comps = line.split()
285                 comps[0] = comps[0].replace(":", "")
286                 ret[comps[0]] = {
287                     "value": comps[1],
288                 }
289                 if len(comps) &gt; 2:
290                     ret[comps[0]]["unit"] = comps[2]
291         return ret
292     def freebsd_meminfo():
293         sysctlvm = __salt__["cmd.run"]("sysctl vm").splitlines()
294         sysctlvm = [x for x in sysctlvm if x.startswith("vm")]
295         sysctlvm = [x.split(":") for x in sysctlvm]
296         sysctlvm = [[y.strip() for y in x] for x in sysctlvm]
297         sysctlvm = [x for x in sysctlvm if x[1]]  # If x[1] not empty
298         ret = {}
299         for line in sysctlvm:
300             ret[line[0]] = line[1]
301         sysctlvmtot = __salt__["cmd.run"]("sysctl -n vm.vmtotal").splitlines()
302         sysctlvmtot = [x for x in sysctlvmtot if x]
303         ret["vm.vmtotal"] = sysctlvmtot
304         return ret
305     def aix_meminfo():
306         ret = {}
307         ret["svmon"] = []
308         ret["vmstat"] = []
309         procn = None
310         fields = []
311         pagesize_flag = False
312         for line in __salt__["cmd.run"]("svmon -G").splitlines():
313             if not line:
314                 continue
315             if re.match(r"\s", line):
316                 fields = line.split()
317                 continue
318             if line.startswith("memory") or line.startswith("pin"):
319                 procn = len(ret["svmon"])
320                 ret["svmon"].append({})
321                 comps = line.split()
322                 ret["svmon"][procn][comps[0]] = {}
323                 for idx, field in enumerate(fields):
324                     if len(comps) &gt; idx + 1:
325                         ret["svmon"][procn][comps[0]][field] = comps[idx + 1]
326                 continue
327             if line.startswith("pg space") or line.startswith("in use"):
328                 procn = len(ret["svmon"])
329                 ret["svmon"].append({})
330                 comps = line.split()
331                 pg_space = "{} {}".format(comps[0], comps[1])
332                 ret["svmon"][procn][pg_space] = {}
333                 for idx, field in enumerate(fields):
334                     if len(comps) &gt; idx + 2:
335                         ret["svmon"][procn][pg_space][field] = comps[idx + 2]
336                 continue
337             if line.startswith("PageSize"):
338                 fields = line.split()
339                 pagesize_flag = False
340                 continue
341             if pagesize_flag:
342                 procn = len(ret["svmon"])
343                 ret["svmon"].append({})
344                 comps = line.split()
345                 ret["svmon"][procn][comps[0]] = {}
346                 for idx, field in enumerate(fields):
347                     if len(comps) &gt; idx:
348                         ret["svmon"][procn][comps[0]][field] = comps[idx]
349                 continue
350         for line in __salt__["cmd.run"]("vmstat -v").splitlines():
351             if not line:
352                 continue
353             procn = len(ret["vmstat"])
354             ret["vmstat"].append({})
355             comps = line.lstrip().split(" ", 1)
356             ret["vmstat"][procn][comps[1]] = comps[0]
357         return ret
358     def openbsd_meminfo():
359         vmstat = __salt__["cmd.run"]("vmstat").splitlines()
360         fields = [
361             "active virtual pages",
362             "free list size",
363             "page faults",
364             "pages reclaimed",
365             "pages paged in",
366             "pages paged out",
367             "pages freed",
368             "pages scanned",
369         ]
370         data = vmstat[2].split()[2:10]
371         ret = dict(zip(fields, data))
372         return ret
373     get_version = {
374         "Linux": linux_meminfo,
375         "FreeBSD": freebsd_meminfo,
376         "Junos": freebsd_meminfo,
377         "OpenBSD": openbsd_meminfo,
378         "AIX": aix_meminfo,
379     }
380     errmsg = "This method is unsupported on the current operating system!"
381     return get_version.get(__grains__["kernel"], lambda: errmsg)()
382 def cpuinfo():
383     def linux_cpuinfo():
384         ret = {}
385         try:
386             with salt.utils.files.fopen("/proc/cpuinfo", "r") as fp_:
387                 stats = salt.utils.stringutils.to_unicode(fp_.read())
388         except OSError:
389             pass
390         else:
391             for line in stats.splitlines():
392                 if not line:
393                     continue
394                 comps = line.split(":")
395                 comps[0] = comps[0].strip()
396                 if comps[0] == "flags":
397                     ret[comps[0]] = comps[1].split()
398                 else:
399                     ret[comps[0]] = comps[1].strip()
400         return ret
401     def bsd_cpuinfo():
402         bsd_cmd = "sysctl hw.model hw.ncpu"
403         ret = {}
404         if __grains__["kernel"].lower() in ["netbsd", "openbsd"]:
405             sep = "="
406         else:
407             sep = ":"
408         for line in __salt__["cmd.run"](bsd_cmd).splitlines():
409             if not line:
410                 continue
411             comps = line.split(sep)
412             comps[0] = comps[0].strip()
413             ret[comps[0]] = comps[1].strip()
414         return ret
415     def sunos_cpuinfo():
416         ret = {}
417         ret["isainfo"] = {}
418         for line in __salt__["cmd.run"]("isainfo -x").splitlines():
419             if not line:
420                 continue
421             comps = line.split(":")
422             comps[0] = comps[0].strip()
423             ret["isainfo"][comps[0]] = sorted(comps[1].strip().split())
424         ret["psrinfo"] = []
425         procn = None
426         for line in __salt__["cmd.run"]("psrinfo -v -p").splitlines():
427             if not line:
428                 continue
429             if line.startswith("The physical processor"):
430                 procn = len(ret["psrinfo"])
431                 line = line.split()
432                 ret["psrinfo"].append({})
433                 if "cores" in line:
434                     ret["psrinfo"][procn]["topology"] = {}
435                     ret["psrinfo"][procn]["topology"]["cores"] = _number(line[4])
436                     ret["psrinfo"][procn]["topology"]["threads"] = _number(line[7])
437                 elif "virtual" in line:
438                     ret["psrinfo"][procn]["topology"] = {}
439                     ret["psrinfo"][procn]["topology"]["threads"] = _number(line[4])
440             elif line.startswith(" " * 6):  # 3x2 space indent
441                 ret["psrinfo"][procn]["name"] = line.strip()
442             elif line.startswith(" " * 4):  # 2x2 space indent
443                 line = line.strip().split()
444                 ret["psrinfo"][procn]["vendor"] = line[1][1:]
445                 ret["psrinfo"][procn]["family"] = _number(line[4])
446                 ret["psrinfo"][procn]["model"] = _number(line[6])
447                 ret["psrinfo"][procn]["step"] = _number(line[8])
448                 ret["psrinfo"][procn]["clock"] = "{} {}".format(line[10], line[11][:-1])
449         return ret
450     def aix_cpuinfo():
451         ret = {}
452         ret["prtconf"] = []
453         ret["lparstat"] = []
454         procn = None
455         for line in __salt__["cmd.run"](
456             'prtconf | grep -i "Processor"', python_shell=True
457         ).splitlines():
458             if not line:
459                 continue
460             procn = len(ret["prtconf"])
461             if line.startswith("Processor") or line.startswith("Number"):
462                 ret["prtconf"].append({})
463                 comps = line.split(":")
464                 comps[0] = comps[0].rstrip()
465                 ret["prtconf"][procn][comps[0]] = comps[1]
466             else:
467                 continue
468         for line in __salt__["cmd.run"](
469             'prtconf | grep "CPU"', python_shell=True
470         ).splitlines():
471             if not line:
472                 continue
473             procn = len(ret["prtconf"])
474             if line.startswith("CPU"):
475                 ret["prtconf"].append({})
476                 comps = line.split(":")
477                 comps[0] = comps[0].rstrip()
478                 ret["prtconf"][procn][comps[0]] = comps[1]
479             else:
480                 continue
481         for line in __salt__["cmd.run"](
482             "lparstat -i | grep CPU", python_shell=True
483         ).splitlines():
484             if not line:
485                 continue
486             procn = len(ret["lparstat"])
487             ret["lparstat"].append({})
488             comps = line.split(":")
489             comps[0] = comps[0].rstrip()
490             ret["lparstat"][procn][comps[0]] = comps[1]
491         return ret
492     get_version = {
493         "Linux": linux_cpuinfo,
494         "FreeBSD": bsd_cpuinfo,
495         "Junos": bsd_cpuinfo,
496         "NetBSD": bsd_cpuinfo,
497         "OpenBSD": bsd_cpuinfo,
498         "SunOS": sunos_cpuinfo,
499         "AIX": aix_cpuinfo,
500     }
501     errmsg = "This method is unsupported on the current operating system!"
502     return get_version.get(__grains__["kernel"], lambda: errmsg)()
503 def diskstats():
504     def linux_diskstats():
505         ret = {}
506         try:
507             with salt.utils.files.fopen("/proc/diskstats", "r") as fp_:
508                 stats = salt.utils.stringutils.to_unicode(fp_.read())
509         except OSError:
510             pass
511         else:
512             for line in stats.splitlines():
513                 if not line:
514                     continue
515                 comps = line.split()
516                 ret[comps[2]] = {
517                     "major": _number(comps[0]),
518                     "minor": _number(comps[1]),
519                     "device": _number(comps[2]),
520                     "reads_issued": _number(comps[3]),
521                     "reads_merged": _number(comps[4]),
522                     "sectors_read": _number(comps[5]),
523                     "ms_spent_reading": _number(comps[6]),
524                     "writes_completed": _number(comps[7]),
525                     "writes_merged": _number(comps[8]),
526                     "sectors_written": _number(comps[9]),
527                     "ms_spent_writing": _number(comps[10]),
528                     "io_in_progress": _number(comps[11]),
529                     "ms_spent_in_io": _number(comps[12]),
530                     "weighted_ms_spent_in_io": _number(comps[13]),
531                 }
532         return ret
533     def generic_diskstats():
534         ret = {}
535         iostat = __salt__["cmd.run"]("iostat -xzd").splitlines()
536         header = iostat[1]
537         for line in iostat[2:]:
538             comps = line.split()
539             ret[comps[0]] = {}
540             for metric, value in zip(header.split()[1:], comps[1:]):
541                 ret[comps[0]][metric] = _number(value)
542         return ret
543     def aix_diskstats():
544         ret = {}
545         procn = None
546         fields = []
547         disk_name = ""
548         disk_mode = ""
549         for line in __salt__["cmd.run"]("iostat -dDV").splitlines():
550             if not line or line.startswith("System") or line.startswith("-----------"):
551                 continue
552             if not re.match(r"\s", line):
553                 dsk_comps = line.split(":")
554                 dsk_firsts = dsk_comps[0].split()
555                 disk_name = dsk_firsts[0]
556                 disk_mode = dsk_firsts[1]
557                 fields = dsk_comps[1].split()
558                 ret[disk_name] = []
559                 procn = len(ret[disk_name])
560                 ret[disk_name].append({})
561                 ret[disk_name][procn][disk_mode] = {}
562                 continue
563             if ":" in line:
564                 comps = line.split(":")
565                 fields = comps[1].split()
566                 disk_mode = comps[0].lstrip()
567                 procn = len(ret[disk_name])
568                 ret[disk_name].append({})
569                 ret[disk_name][procn][disk_mode] = {}
570             else:
571                 comps = line.split()
572                 for idx, field in enumerate(fields):
573                     if len(comps) &gt; idx:
574                         ret[disk_name][procn][disk_mode][field] = comps[idx]
575         return ret
576     get_version = {
577         "Linux": linux_diskstats,
578         "FreeBSD": generic_diskstats,
579         "Junos": generic_diskstats,
580         "SunOS": generic_diskstats,
581         "AIX": aix_diskstats,
582     }
583     errmsg = "This method is unsupported on the current operating system!"
584     return get_version.get(__grains__["kernel"], lambda: errmsg)()
585 def diskusage(*args):
586     selected = set()
587     fstypes = set()
588     if not args:
589         fstypes.add("*")
590     else:
591         for arg in args:
592             if arg.startswith("/"):
593                 selected.add(arg)
594             else:
595                 fstypes.add(arg)
596     if fstypes:
597         regex = re.compile(
598             "|".join(fnmatch.translate(fstype).format("(%s)") for fstype in fstypes)
599         )
600         if __grains__["kernel"] == "Linux":
601             try:
602                 with salt.utils.files.fopen("/proc/mounts", "r") as fp_:
603                     ifile = salt.utils.stringutils.to_unicode(fp_.read()).splitlines()
604             except OSError:
605                 return {}
606         elif __grains__["kernel"] in ("FreeBSD", "SunOS"):
607             ifile = __salt__["cmd.run"]("mount -p").splitlines()
608         else:
609             raise CommandExecutionError(
610                 "status.diskusage not yet supported on this platform"
611             )
612         for line in ifile:
613             comps = line.split()
614             if __grains__["kernel"] == "SunOS":
615                 if len(comps) &gt;= 4:
616                     mntpt = comps[2]
617                     fstype = comps[3]
618                     if regex.match(fstype):
619                         selected.add(mntpt)
620             else:
621                 if len(comps) &gt;= 3:
622                     mntpt = comps[1]
623                     fstype = comps[2]
624                     if regex.match(fstype):
625                         selected.add(mntpt)
626     ret = {}
627     for path in selected:
628         fsstats = os.statvfs(path)
629         blksz = fsstats.f_bsize
630         available = fsstats.f_bavail * blksz
631         total = fsstats.f_blocks * blksz
632         ret[path] = {"available": available, "total": total}
633     return ret
634 def vmstats():
635     def linux_vmstats():
636         ret = {}
637         try:
638             with salt.utils.files.fopen("/proc/vmstat", "r") as fp_:
639                 stats = salt.utils.stringutils.to_unicode(fp_.read())
640         except OSError:
641             pass
642         else:
643             for line in stats.splitlines():
644                 if not line:
645                     continue
646                 comps = line.split()
647                 ret[comps[0]] = _number(comps[1])
648         return ret
649     def generic_vmstats():
650         ret = {}
651         for line in __salt__["cmd.run"]("vmstat -s").splitlines():
652             comps = line.split()
653             if comps[0].isdigit():
654                 ret[" ".join(comps[1:])] = _number(comps[0].strip())
655         return ret
656     get_version = {
657         "Linux": linux_vmstats,
658         "FreeBSD": generic_vmstats,
659         "Junos": generic_vmstats,
660         "OpenBSD": generic_vmstats,
661         "SunOS": generic_vmstats,
662         "AIX": generic_vmstats,
663     }
664     errmsg = "This method is unsupported on the current operating system!"
665     return get_version.get(__grains__["kernel"], lambda: errmsg)()
666 def nproc():
667     def linux_nproc():
668         try:
669             return _number(__salt__["cmd.run"]("nproc").strip())
670         except ValueError:
671             return 0
672     def generic_nproc():
673         ncpu_data = __salt__["sysctl.get"]("hw.ncpu")
674         if not ncpu_data:
675             return 1
676         else:
677             return _number(ncpu_data)
678     get_version = {
679         "Linux": linux_nproc,
680         "Darwin": generic_nproc,
681         "FreeBSD": generic_nproc,
682         "Junos": generic_nproc,
683         "OpenBSD": generic_nproc,
684         "AIX": _aix_nproc,
685     }
686     errmsg = "This method is unsupported on the current operating system!"
687     return get_version.get(__grains__["kernel"], lambda: errmsg)()
688 def netstats():
689     def linux_netstats():
690         ret = {}
691         try:
692             with salt.utils.files.fopen("/proc/net/netstat", "r") as fp_:
693                 stats = salt.utils.stringutils.to_unicode(fp_.read())
694         except OSError:
695             pass
696         else:
697             headers = [""]
698             for line in stats.splitlines():
699                 if not line:
700                     continue
701                 comps = line.split()
702                 if comps[0] == headers[0]:
703                     index = len(headers) - 1
704                     row = {}
705                     for field in range(index):
706                         if field &lt; 1:
707                             continue
708                         else:
709                             row[headers[field]] = _number(comps[field])
710                     rowname = headers[0].replace(":", "")
711                     ret[rowname] = row
712                 else:
713                     headers = comps
714         return ret
715     def freebsd_netstats():
716         return bsd_netstats()
717     def bsd_netstats():
718         ret = {}
719         for line in __salt__["cmd.run"]("netstat -s").splitlines():
720             if line.startswith("\t\t"):
721                 continue  # Skip, too detailed
722             if not line.startswith("\t"):
723                 key = line.split()[0].replace(":", "")
724                 ret[key] = {}
725             else:
726                 comps = line.split()
727                 if comps[0].isdigit():
728                     ret[key][" ".join(comps[1:])] = comps[0]
729         return ret
730     def sunos_netstats():
731         ret = {}
732         for line in __salt__["cmd.run"]("netstat -s").splitlines():
733             line = line.replace("=", " = ").split()
734             if len(line) &gt; 6:
735                 line.pop(0)
736             if "=" in line:
737                 if len(line) &gt;= 3:
738                     if line[2].isdigit() or line[2][0] == "-":
739                         line[2] = _number(line[2])
740                     ret[line[0]] = line[2]
741                 if len(line) &gt;= 6:
742                     if line[5].isdigit() or line[5][0] == "-":
743                         line[5] = _number(line[5])
744                     ret[line[3]] = line[5]
745         return ret
746     def aix_netstats():
747         ret = {}
748         fields = []
749         procn = None
750         proto_name = None
751         for line in __salt__["cmd.run"]("netstat -s").splitlines():
752             if not line:
753                 continue
754             if not re.match(r"\s", line) and ":" in line:
755                 comps = line.split(":")
756                 proto_name = comps[0]
757                 ret[proto_name] = []
758                 procn = len(ret[proto_name])
759                 ret[proto_name].append({})
760                 continue
761             else:
762                 comps = line.split()
763                 comps[0] = comps[0].strip()
764                 if comps[0].isdigit():
765                     ret[proto_name][procn][" ".join(comps[1:])] = _number(comps[0])
766                 else:
767                     continue
768         return ret
769     get_version = {
770         "Linux": linux_netstats,
771         "FreeBSD": bsd_netstats,
772         "Junos": bsd_netstats,
773         "OpenBSD": bsd_netstats,
774         "SunOS": sunos_netstats,
775         "AIX": aix_netstats,
776     }
777     errmsg = "This method is unsupported on the current operating system!"
778     return get_version.get(__grains__["kernel"], lambda: errmsg)()
779 def netdev():
780     def linux_netdev():
781         ret = {}
782         try:
783             with salt.utils.files.fopen("/proc/net/dev", "r") as fp_:
784                 stats = salt.utils.stringutils.to_unicode(fp_.read())
785         except OSError:
786             pass
787         else:
788             for line in stats.splitlines():
789                 if not line:
790                     continue
791                 if line.find(":") &lt; 0:
792                     continue
793                 comps = line.split()
794                 comps[0] = line.split(":")[0].strip()
795                 comps.insert(1, line.split(":")[1].strip().split()[0])
796                 ret[comps[0]] = {
797                     "iface": comps[0],
798                     "rx_bytes": _number(comps[2]),
799                     "rx_compressed": _number(comps[8]),
800                     "rx_drop": _number(comps[5]),
801                     "rx_errs": _number(comps[4]),
802                     "rx_fifo": _number(comps[6]),
803                     "rx_frame": _number(comps[7]),
804                     "rx_multicast": _number(comps[9]),
805                     "rx_packets": _number(comps[3]),
806                     "tx_bytes": _number(comps[10]),
807                     "tx_carrier": _number(comps[16]),
808                     "tx_colls": _number(comps[15]),
809                     "tx_compressed": _number(comps[17]),
810                     "tx_drop": _number(comps[13]),
811                     "tx_errs": _number(comps[12]),
812                     "tx_fifo": _number(comps[14]),
813                     "tx_packets": _number(comps[11]),
814                 }
815         return ret
816     def freebsd_netdev():
817         _dict_tree = lambda: collections.defaultdict(_dict_tree)
818         ret = _dict_tree()
819         netstat = __salt__["cmd.run"]("netstat -i -n -4 -b -d").splitlines()
820         netstat += __salt__["cmd.run"]("netstat -i -n -6 -b -d").splitlines()[1:]
821         header = netstat[0].split()
822         for line in netstat[1:]:
823             comps = line.split()
824             for i in range(4, 13):  # The columns we want
825                 ret[comps[0]][comps[2]][comps[3]][header[i]] = _number(comps[i])
826         return ret
827     def sunos_netdev():
828         ret = {}
829         for dev in itertools.chain(
830             __grains__["ip4_interfaces"].keys(), __grains__["ip6_interfaces"].keys()
831         ):
832             netstat_ipv4 = __salt__["cmd.run"](
833                 "netstat -i -I {dev} -n -f inet".format(dev=dev)
834             ).splitlines()
835             netstat_ipv6 = __salt__["cmd.run"](
836                 "netstat -i -I {dev} -n -f inet6".format(dev=dev)
837             ).splitlines()
838             netstat_ipv4[0] = netstat_ipv4[0].split()
839             netstat_ipv4[1] = netstat_ipv4[1].split()
840             netstat_ipv6[0] = netstat_ipv6[0].split()
841             netstat_ipv6[1] = netstat_ipv6[1].split()
842             ret[dev] = {}
843             for val in netstat_ipv4[0][:-1]:
844                 if val == "Name":
845                     continue
846                 if val in ["Address", "Net/Dest"]:
847                     ret[dev]["IPv4 {field}".format(field=val)] = val
848                 else:
849                     ret[dev][val] = _number(val)
850             for val in netstat_ipv6[0][:-1]:
851                 if val == "Name":
852                     continue
853                 if val in ["Address", "Net/Dest"]:
854                     ret[dev]["IPv6 {field}".format(field=val)] = val
855                 else:
856                     ret[dev][val] = _number(val)
857         return ret
858     def aix_netdev():
859         ret = {}
860         fields = []
861         procn = None
862         for dev in itertools.chain(
863             __grains__["ip4_interfaces"].keys(), __grains__["ip6_interfaces"].keys()
864         ):
865             netstat_ipv4 = __salt__["cmd.run"](
866                 "netstat -i -n -I {dev} -f inet".format(dev=dev)
867             ).splitlines()
868             netstat_ipv6 = __salt__["cmd.run"](
869                 "netstat -i -n -I {dev} -f inet6".format(dev=dev)
870             ).splitlines()
871             ret[dev] = []
872             for line in netstat_ipv4:
873                 if line.startswith("Name"):
874                     fields = line.split()
875                     continue
876                 comps = line.split()
877                 if len(comps) &lt; 3:
878                     raise CommandExecutionError(
879                         "Insufficent data returned by command to process '{}'".format(
880                             line
881                         )
882                     )
883                 if comps[2].startswith("link"):
884                     continue
885                 procn = len(ret[dev])
886                 ret[dev].append({})
887                 ret[dev][procn]["ipv4"] = {}
888                 for i in range(1, len(fields)):
889                     if len(comps) &gt; i:
890                         ret[dev][procn]["ipv4"][fields[i]] = comps[i]
891             for line in netstat_ipv6:
892                 if line.startswith("Name"):
893                     fields = line.split()
894                     continue
895                 comps = line.split()
896                 if len(comps) &lt; 3:
897                     raise CommandExecutionError(
898                         "Insufficent data returned by command to process '{}'".format(
899                             line
900                         )
901                     )
902                 if comps[2].startswith("link"):
903                     continue
904                 procn = len(ret[dev])
905                 ret[dev].append({})
906                 ret[dev][procn]["ipv6"] = {}
907                 for i in range(1, len(fields)):
908                     if len(comps) &gt; i:
909                         ret[dev][procn]["ipv6"][fields[i]] = comps[i]
910         return ret
911     get_version = {
912         "Linux": linux_netdev,
913         "FreeBSD": freebsd_netdev,
914         "Junos": freebsd_netdev,
915         "SunOS": sunos_netdev,
916         "AIX": aix_netdev,
917     }
918     errmsg = "This method is unsupported on the current operating system!"
919     return get_version.get(__grains__["kernel"], lambda: errmsg)()
920 def w():  # pylint: disable=C0103
921     def linux_w():
922         user_list = []
923         users = __salt__["cmd.run"]("w -fh").splitlines()
924         for row in users:
925             if not row:
926                 continue
927             comps = row.split()
928             rec = {
929                 "idle": comps[3],
930                 "jcpu": comps[4],
931                 "login": comps[2],
932                 "pcpu": comps[5],
933                 "tty": comps[1],
934                 "user": comps[0],
935                 "what": " ".join(comps[6:]),
936             }
937             user_list.append(rec)
938         return user_list
939     def bsd_w():
940         user_list = []
941         users = __salt__["cmd.run"]("w -h").splitlines()
942         for row in users:
943             if not row:
944                 continue
945             comps = row.split()
946             rec = {
947                 "from": comps[2],
948                 "idle": comps[4],
949                 "login": comps[3],
950                 "tty": comps[1],
951                 "user": comps[0],
952                 "what": " ".join(comps[5:]),
953             }
954             user_list.append(rec)
955         return user_list
956     get_version = {
957         "Darwin": bsd_w,
958         "FreeBSD": bsd_w,
959         "Junos": bsd_w,
960         "Linux": linux_w,
961         "OpenBSD": bsd_w,
962     }
963     errmsg = "This method is unsupported on the current operating system!"
964     return get_version.get(__grains__["kernel"], lambda: errmsg)()
965 def all_status():
966     return {
967         "cpuinfo": cpuinfo(),
968         "cpustats": cpustats(),
969         "diskstats": diskstats(),
970         "diskusage": diskusage(),
971         "loadavg": loadavg(),
972         "meminfo": meminfo(),
973         "netdev": netdev(),
974         "netstats": netstats(),
975         "uptime": uptime(),
976         "vmstats": vmstats(),
977         "w": w(),
978     }
979 def pid(sig):
980     my_pid = str(os.getpid())
981     cmd = __grains__["ps"]
982     output = __salt__["cmd.run_stdout"](cmd, python_shell=True)
983     pids = ""
984     for line in output.splitlines():
985         if my_pid in line:
986             continue
987         if re.search(sig, line):
988             if pids:
989                 pids += "\n"
990             pids += line.split()[1]
991     return pids
992 def version():
993     def linux_version():
994         try:
995             with salt.utils.files.fopen("/proc/version", "r") as fp_:
996                 return salt.utils.stringutils.to_unicode(fp_.read()).strip()
997         except OSError:
998             return {}
999     def bsd_version():
1000         return __salt__["cmd.run"]("sysctl -n kern.version")
1001     get_version = {
1002         "Linux": linux_version,
1003         "FreeBSD": bsd_version,
1004         "Junos": bsd_version,
1005         "OpenBSD": bsd_version,
1006         "AIX": lambda: __salt__["cmd.run"]("oslevel -s"),
1007     }
1008     errmsg = "This method is unsupported on the current operating system!"
1009     return get_version.get(__grains__["kernel"], lambda: errmsg)()
1010 def master(master=None, connected=True):
1011     master_ips = None
1012     if master:
1013         master_ips = salt.utils.network.host_to_ips(master)
1014     if not master_ips:
1015         return
1016     master_connection_status = False
1017     port = __salt__["config.get"]("publish_port", default=4505)
1018     connected_ips = salt.utils.network.remote_port_tcp(port)
1019     for master_ip in master_ips:
1020         if master_ip in connected_ips:
1021             master_connection_status = True
1022             break
1023     if master_connection_status is not connected:
1024         with salt.utils.event.get_event("minion", opts=__opts__, listen=False) as event:
1025             if master_connection_status:
1026                 event.fire_event(
1027                     {"master": master}, salt.minion.master_event(type="connected")
1028                 )
1029             else:
1030                 event.fire_event(
1031                     {"master": master}, salt.minion.master_event(type="disconnected")
1032                 )
1033     return master_connection_status
1034 def ping_master(master):
1035     if master is None or master == "":
1036         return False
1037     opts = copy.deepcopy(__opts__)
1038     opts["master"] = master
1039     if "master_ip" in opts:  # avoid 'master ip changed' warning
1040         del opts["master_ip"]
1041     opts.update(salt.minion.prep_ip_port(opts))
1042     try:
1043         opts.update(salt.minion.resolve_dns(opts, fallback=False))
1044     except Exception:  # pylint: disable=broad-except
1045         return False
1046     timeout = opts.get("auth_timeout", 60)
1047     load = {"cmd": "ping"}
1048     result = False
1049     with salt.channel.client.ReqChannel.factory(opts, crypt="clear") as channel:
1050         try:
1051             payload = channel.send(load, tries=0, timeout=timeout)
1052             result = True
1053         except Exception as e:  # pylint: disable=broad-except
1054             pass
1055         if result:
1056             with salt.utils.event.get_event(
1057                 "minion", opts=__opts__, listen=False
1058             ) as event:
1059                 event.fire_event(
1060                     {"master": master}, salt.minion.master_event(type="failback")
1061                 )
1062         return result
1063 def proxy_reconnect(proxy_name, opts=None):
1064     if not opts:
1065         opts = __opts__
1066     if "proxy" not in opts:
1067         return False  # fail
1068     proxy_keepalive_fn = proxy_name + ".alive"
1069     if proxy_keepalive_fn not in __proxy__:
1070         return False  # fail
1071     chk_reboot_active_key = proxy_name + ".get_reboot_active"
1072     if chk_reboot_active_key in __proxy__ and __proxy__[chk_reboot_active_key]():
1073         minion_id = opts.get("proxyid", "") or opts.get("id", "")
1074         log.info(
1075             "%s (%s proxy) is rebooting or shutting down. Don't probe connection.",
1076             minion_id,
1077             proxy_name,
1078         )
1079         return True
1080     is_alive = __proxy__[proxy_keepalive_fn](opts)
1081     if not is_alive:
1082         minion_id = opts.get("proxyid", "") or opts.get("id", "")
1083         log.info("%s (%s proxy) is down. Restarting.", minion_id, proxy_name)
1084         __proxy__[proxy_name + ".shutdown"](opts)  # safely close connection
1085         __proxy__[proxy_name + ".init"](opts)  # reopen connection
1086         log.debug("Restarted %s (%s proxy)!", minion_id, proxy_name)
1087     return True  # success
1088 def time_(format="%A, %d. %B %Y %I:%M%p"):
1089     dt = datetime.datetime.today()
1090     return dt.strftime(format)
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_vmware_2.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import base64
2 import logging
3 import ssl
4 import salt.utils.vmware
5 from salt.exceptions import (
6     ArgumentValueError,
7     CommandExecutionError,
8     VMwareApiError,
9     VMwareConnectionError,
10     VMwareObjectRetrievalError,
11     VMwareRuntimeError,
12     VMwareSystemError,
13 )
14 from tests.support.mixins import LoaderModuleMockMixin
15 from tests.support.mock import MagicMock, PropertyMock, call, patch
16 from tests.support.unit import TestCase, skipIf
17 try:
18     from pyVmomi import vim, vmodl  # pylint: disable=no-name-in-module
19     HAS_PYVMOMI = True
20 except ImportError:
21     HAS_PYVMOMI = False
22 try:
23     import gssapi
24     HAS_GSSAPI = True
25 except ImportError:
26     HAS_GSSAPI = False
27 log = logging.getLogger(__name__)
28 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
29 class GetClusterTestCase(TestCase):
30     def setUp(self):
31         patches = (
32             ("salt.utils.vmware.get_managed_object_name", MagicMock()),
33             ("salt.utils.vmware.get_service_instance_from_managed_object", MagicMock()),
34             (
35                 "salt.utils.vmware.get_mors_with_properties",
36                 MagicMock(
37                     return_value=[{"name": "fake_cluster", "object": MagicMock()}]
38                 ),
39             ),
40         )
41         for mod, mock in patches:
42             patcher = patch(mod, mock)
43             patcher.start()
44             self.addCleanup(patcher.stop)
45         self.mock_si = MagicMock()
46         self.mock_dc = MagicMock()
47         self.mock_cluster1 = MagicMock()
48         self.mock_cluster2 = MagicMock()
49         self.mock_entries = [
50             {"name": "fake_cluster1", "object": self.mock_cluster1},
51             {"name": "fake_cluster2", "object": self.mock_cluster2},
52         ]
53         for attr in (
54             "mock_si",
55             "mock_dc",
56             "mock_cluster1",
57             "mock_cluster2",
58             "mock_entries",
59         ):
60             self.addCleanup(delattr, self, attr)
61     def test_get_managed_object_name_call(self):
62         mock_get_managed_object_name = MagicMock()
63         with patch(
64             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
65         ):
66             salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster")
67         mock_get_managed_object_name.assert_called_once_with(self.mock_dc)
68     def test_get_service_instance_from_managed_object(self):
69         mock_dc_name = MagicMock()
70         mock_get_service_instance_from_managed_object = MagicMock()
71         with patch(
72             "salt.utils.vmware.get_managed_object_name",
73             MagicMock(return_value=mock_dc_name),
74         ):
75             with patch(
76                 "salt.utils.vmware.get_service_instance_from_managed_object",
77                 mock_get_service_instance_from_managed_object,
78             ):
79                 salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster")
80         mock_get_service_instance_from_managed_object.assert_called_once_with(
81             self.mock_dc, name=mock_dc_name
82         )
83     def test_traversal_spec_init(self):
84         mock_dc_name = MagicMock()
85         mock_traversal_spec = MagicMock()
86         mock_traversal_spec_ini = MagicMock(return_value=mock_traversal_spec)
87         mock_get_service_instance_from_managed_object = MagicMock()
88         patch_traversal_spec_str = (
89             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec"
90         )
91         with patch(patch_traversal_spec_str, mock_traversal_spec_ini):
92             salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster")
93         mock_traversal_spec_ini.assert_has_calls(
94             [
95                 call(path="childEntity", skip=False, type=vim.Folder),
96                 call(
97                     path="hostFolder",
98                     skip=True,
99                     type=vim.Datacenter,
100                     selectSet=[mock_traversal_spec],
101                 ),
102             ]
103         )
104     def test_get_mors_with_properties_call(self):
105         mock_get_mors_with_properties = MagicMock(
106             return_value=[{"name": "fake_cluster", "object": MagicMock()}]
107         )
108         mock_traversal_spec = MagicMock()
109         patch_traversal_spec_str = (
110             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec"
111         )
112         with patch(
113             "salt.utils.vmware.get_service_instance_from_managed_object",
114             MagicMock(return_value=self.mock_si),
115         ):
116             with patch(
117                 "salt.utils.vmware.get_mors_with_properties",
118                 mock_get_mors_with_properties,
119             ):
120                 with patch(
121                     patch_traversal_spec_str,
122                     MagicMock(return_value=mock_traversal_spec),
123                 ):
124                     salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster")
125         mock_get_mors_with_properties.assert_called_once_with(
126             self.mock_si,
127             vim.ClusterComputeResource,
128             container_ref=self.mock_dc,
129             property_list=["name"],
130             traversal_spec=mock_traversal_spec,
131         )
132     def test_get_mors_with_properties_returns_empty_array(self):
133         with patch(
134             "salt.utils.vmware.get_managed_object_name",
135             MagicMock(return_value="fake_dc"),
136         ):
137             with patch(
138                 "salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])
139             ):
140                 with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
141                     salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster")
142         self.assertEqual(
143             excinfo.exception.strerror,
144             "Cluster 'fake_cluster' was not found in datacenter 'fake_dc'",
145         )
146     def test_cluster_not_found(self):
147         with patch(
148             "salt.utils.vmware.get_managed_object_name",
149             MagicMock(return_value="fake_dc"),
150         ):
151             with patch(
152                 "salt.utils.vmware.get_mors_with_properties",
153                 MagicMock(return_value=self.mock_entries),
154             ):
155                 with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
156                     salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster")
157         self.assertEqual(
158             excinfo.exception.strerror,
159             "Cluster 'fake_cluster' was not found in datacenter 'fake_dc'",
160         )
161     def test_cluster_found(self):
162         with patch(
163             "salt.utils.vmware.get_managed_object_name",
164             MagicMock(return_value="fake_dc"),
165         ):
166             with patch(
167                 "salt.utils.vmware.get_mors_with_properties",
168                 MagicMock(return_value=self.mock_entries),
169             ):
170                 res = salt.utils.vmware.get_cluster(self.mock_dc, "fake_cluster2")
171         self.assertEqual(res, self.mock_cluster2)
172 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
173 class CreateClusterTestCase(TestCase):
174     def setUp(self):
175         patches = (("salt.utils.vmware.get_managed_object_name", MagicMock()),)
176         for mod, mock in patches:
177             patcher = patch(mod, mock)
178             patcher.start()
179             self.addCleanup(patcher.stop)
180         self.mock_create_cluster_ex = MagicMock()
181         self.mock_dc = MagicMock(
182             hostFolder=MagicMock(CreateClusterEx=self.mock_create_cluster_ex)
183         )
184         self.mock_cluster_spec = MagicMock()
185         for attr in ("mock_create_cluster_ex", "mock_dc", "mock_cluster_spec"):
186             self.addCleanup(delattr, self, attr)
187     def test_get_managed_object_name(self):
188         mock_get_managed_object_name = MagicMock()
189         with patch(
190             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
191         ):
192             salt.utils.vmware.create_cluster(
193                 self.mock_dc, "fake_cluster", self.mock_cluster_spec
194             )
195         mock_get_managed_object_name.assert_called_once_with(self.mock_dc)
196     def test_create_cluster_call(self):
197         salt.utils.vmware.create_cluster(
198             self.mock_dc, "fake_cluster", self.mock_cluster_spec
199         )
200         self.mock_create_cluster_ex.assert_called_once_with(
201             "fake_cluster", self.mock_cluster_spec
202         )
203     def test_create_cluster_raise_no_permission(self):
204         exc = vim.fault.NoPermission()
205         exc.privilegeId = "Fake privilege"
206         self.mock_dc.hostFolder.CreateClusterEx = MagicMock(side_effect=exc)
207         with self.assertRaises(VMwareApiError) as excinfo:
208             salt.utils.vmware.create_cluster(
209                 self.mock_dc, "fake_cluster", self.mock_cluster_spec
210             )
211         self.assertEqual(
212             excinfo.exception.strerror,
213             "Not enough permissions. Required privilege: Fake privilege",
214         )
215     def test_create_cluster_raise_vim_fault(self):
216         exc = vim.fault.VimFault()
217         exc.msg = "VimFault msg"
218         self.mock_dc.hostFolder.CreateClusterEx = MagicMock(side_effect=exc)
219         with self.assertRaises(VMwareApiError) as excinfo:
220             salt.utils.vmware.create_cluster(
221                 self.mock_dc, "fake_cluster", self.mock_cluster_spec
222             )
223         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
224     def test_create_cluster_raise_runtime_fault(self):
225         exc = vmodl.RuntimeFault()
226         exc.msg = "RuntimeFault msg"
227         self.mock_dc.hostFolder.CreateClusterEx = MagicMock(side_effect=exc)
228         with self.assertRaises(VMwareRuntimeError) as excinfo:
229             salt.utils.vmware.create_cluster(
230                 self.mock_dc, "fake_cluster", self.mock_cluster_spec
231             )
232         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
233 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
234 class UpdateClusterTestCase(TestCase):
235     def setUp(self):
236         patches = (
237             ("salt.utils.vmware.get_managed_object_name", MagicMock()),
238             ("salt.utils.vmware.wait_for_task", MagicMock()),
239         )
240         for mod, mock in patches:
241             patcher = patch(mod, mock)
242             patcher.start()
243             self.addCleanup(patcher.stop)
244         self.mock_task = MagicMock()
245         self.mock_reconfigure_compute_resource_task = MagicMock(
246             return_value=self.mock_task
247         )
248         self.mock_cluster = MagicMock(
249             ReconfigureComputeResource_Task=self.mock_reconfigure_compute_resource_task
250         )
251         self.mock_cluster_spec = MagicMock()
252         for attr in (
253             "mock_task",
254             "mock_reconfigure_compute_resource_task",
255             "mock_cluster",
256             "mock_cluster_spec",
257         ):
258             self.addCleanup(delattr, self, attr)
259     def test_get_managed_object_name(self):
260         mock_get_managed_object_name = MagicMock()
261         with patch(
262             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
263         ):
264             salt.utils.vmware.update_cluster(self.mock_cluster, self.mock_cluster_spec)
265         mock_get_managed_object_name.assert_called_once_with(self.mock_cluster)
266     def test_reconfigure_compute_resource_task_call(self):
267         salt.utils.vmware.update_cluster(self.mock_cluster, self.mock_cluster_spec)
268         self.mock_reconfigure_compute_resource_task.assert_called_once_with(
269             self.mock_cluster_spec, modify=True
270         )
271     def test_reconfigure_compute_resource_raise_no_permission(self):
272         exc = vim.fault.NoPermission()
273         exc.privilegeId = "Fake privilege"
274         self.mock_cluster.ReconfigureComputeResource_Task = MagicMock(side_effect=exc)
275         with self.assertRaises(VMwareApiError) as excinfo:
276             salt.utils.vmware.update_cluster(self.mock_cluster, self.mock_cluster_spec)
277         self.assertEqual(
278             excinfo.exception.strerror,
279             "Not enough permissions. Required privilege: Fake privilege",
280         )
281     def test_reconfigure_compute_resource_raise_vim_fault(self):
282         exc = vim.fault.VimFault()
283         exc.msg = "VimFault msg"
284         self.mock_cluster.ReconfigureComputeResource_Task = MagicMock(side_effect=exc)
285         with self.assertRaises(VMwareApiError) as excinfo:
286             salt.utils.vmware.update_cluster(self.mock_cluster, self.mock_cluster_spec)
287         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
288     def test_reconfigure_compute_resource_raise_runtime_fault(self):
289         exc = vmodl.RuntimeFault()
290         exc.msg = "RuntimeFault msg"
291         self.mock_cluster.ReconfigureComputeResource_Task = MagicMock(side_effect=exc)
292         with self.assertRaises(VMwareRuntimeError) as excinfo:
293             salt.utils.vmware.update_cluster(self.mock_cluster, self.mock_cluster_spec)
294         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
295     def test_wait_for_task_call(self):
296         mock_wait_for_task = MagicMock()
297         with patch(
298             "salt.utils.vmware.get_managed_object_name",
299             MagicMock(return_value="fake_cluster"),
300         ):
301             with patch("salt.utils.vmware.wait_for_task", mock_wait_for_task):
302                 salt.utils.vmware.update_cluster(
303                     self.mock_cluster, self.mock_cluster_spec
304                 )
305         mock_wait_for_task.assert_called_once_with(
306             self.mock_task, "fake_cluster", "ClusterUpdateTask"
307         )
308 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
309 class WaitForTaskTestCase(TestCase):
310     def setUp(self):
311         patches = (
312             ("salt.utils.vmware.time.time", MagicMock(return_value=1)),
313             ("salt.utils.vmware.time.sleep", MagicMock(return_value=None)),
314         )
315         for mod, mock in patches:
316             patcher = patch(mod, mock)
317             patcher.start()
318             self.addCleanup(patcher.stop)
319     def test_first_task_info_raise_no_permission(self):
320         exc = vim.fault.NoPermission()
321         exc.privilegeId = "Fake privilege"
322         mock_task = MagicMock()
323         type(mock_task).info = PropertyMock(side_effect=exc)
324         with self.assertRaises(VMwareApiError) as excinfo:
325             salt.utils.vmware.wait_for_task(
326                 mock_task, "fake_instance_name", "task_type"
327             )
328         self.assertEqual(
329             excinfo.exception.strerror,
330             "Not enough permissions. Required privilege: Fake privilege",
331         )
332     def test_first_task_info_raise_vim_fault(self):
333         exc = vim.fault.VimFault()
334         exc.msg = "VimFault msg"
335         mock_task = MagicMock()
336         type(mock_task).info = PropertyMock(side_effect=exc)
337         with self.assertRaises(VMwareApiError) as excinfo:
338             salt.utils.vmware.wait_for_task(
339                 mock_task, "fake_instance_name", "task_type"
340             )
341         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
342     def test_first_task_info_raise_runtime_fault(self):
343         exc = vmodl.RuntimeFault()
344         exc.msg = "RuntimeFault msg"
345         mock_task = MagicMock()
346         type(mock_task).info = PropertyMock(side_effect=exc)
347         with self.assertRaises(VMwareRuntimeError) as excinfo:
348             salt.utils.vmware.wait_for_task(
349                 mock_task, "fake_instance_name", "task_type"
350             )
351         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
352     def test_inner_loop_task_info_raise_no_permission(self):
353         exc = vim.fault.NoPermission()
354         exc.privilegeId = "Fake privilege"
355         mock_task = MagicMock()
356         mock_info1 = MagicMock()
357         type(mock_task).info = PropertyMock(side_effect=[mock_info1, exc])
358         type(mock_info1).state = PropertyMock(side_effect=["running", "bad"])
359         with self.assertRaises(VMwareApiError) as excinfo:
360             salt.utils.vmware.wait_for_task(
361                 mock_task, "fake_instance_name", "task_type"
362             )
363         self.assertEqual(
364             excinfo.exception.strerror,
365             "Not enough permissions. Required privilege: Fake privilege",
366         )
367     def test_inner_loop_task_info_raise_vim_fault(self):
368         exc = vim.fault.VimFault()
369         exc.msg = "VimFault msg"
370         mock_task = MagicMock()
371         mock_info1 = MagicMock()
372         type(mock_task).info = PropertyMock(side_effect=[mock_info1, exc])
373         type(mock_info1).state = PropertyMock(side_effect=["running", "bad"])
374         with self.assertRaises(VMwareApiError) as excinfo:
375             salt.utils.vmware.wait_for_task(
376                 mock_task, "fake_instance_name", "task_type"
377             )
378         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
379     def test_inner_loop_task_info_raise_runtime_fault(self):
380         exc = vmodl.RuntimeFault()
381         exc.msg = "RuntimeFault msg"
382         mock_task = MagicMock()
383         mock_info1 = MagicMock()
384         type(mock_task).info = PropertyMock(side_effect=[mock_info1, exc])
385         type(mock_info1).state = PropertyMock(side_effect=["running", "bad"])
386         with self.assertRaises(VMwareRuntimeError) as excinfo:
387             salt.utils.vmware.wait_for_task(
388                 mock_task, "fake_instance_name", "task_type"
389             )
390         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
391     def test_info_state_running(self):
392         mock_task = MagicMock()
393         prop_mock_state = PropertyMock(side_effect=["running", "bad", "bad", "success"])
394         prop_mock_result = PropertyMock()
395         type(mock_task.info).state = prop_mock_state
396         type(mock_task.info).result = prop_mock_result
397         salt.utils.vmware.wait_for_task(mock_task, "fake_instance_name", "task_type")
398         self.assertEqual(prop_mock_state.call_count, 4)
399         self.assertEqual(prop_mock_result.call_count, 1)
400     def test_info_state_running_continues_loop(self):
401         mock_task = MagicMock()
402         prop_mock_state = PropertyMock(
403             side_effect=["running", "fake", "fake", "success"]
404         )
405         prop_mock_result = PropertyMock()
406         type(mock_task.info).state = prop_mock_state
407         type(mock_task.info).result = prop_mock_result
408         salt.utils.vmware.wait_for_task(mock_task, "fake_instance_name", "task_type")
409         self.assertEqual(prop_mock_state.call_count, 4)
410         self.assertEqual(prop_mock_result.call_count, 1)
411     def test_info_state_queued_continues_loop(self):
412         mock_task = MagicMock()
413         prop_mock_state = PropertyMock(
414             side_effect=["fake", "queued", "fake", "fake", "success"]
415         )
416         prop_mock_result = PropertyMock()
417         type(mock_task.info).state = prop_mock_state
418         type(mock_task.info).result = prop_mock_result
419         salt.utils.vmware.wait_for_task(mock_task, "fake_instance_name", "task_type")
420         self.assertEqual(prop_mock_state.call_count, 5)
421         self.assertEqual(prop_mock_result.call_count, 1)
422     def test_info_state_success(self):
423         mock_task = MagicMock()
424         prop_mock_state = PropertyMock(return_value="success")
425         prop_mock_result = PropertyMock()
426         type(mock_task.info).state = prop_mock_state
427         type(mock_task.info).result = prop_mock_result
428         salt.utils.vmware.wait_for_task(mock_task, "fake_instance_name", "task_type")
429         self.assertEqual(prop_mock_state.call_count, 3)
430         self.assertEqual(prop_mock_result.call_count, 1)
431     def test_info_error_exception(self):
432         mock_task = MagicMock()
433         prop_mock_state = PropertyMock(return_value="error")
434         prop_mock_error = PropertyMock(side_effect=Exception("error exc"))
435         type(mock_task.info).state = prop_mock_state
436         type(mock_task.info).error = prop_mock_error
437         with self.assertRaises(Exception) as excinfo:
438             salt.utils.vmware.wait_for_task(
439                 mock_task, "fake_instance_name", "task_type"
440             )
441         self.assertEqual(str(excinfo.exception), "error exc")
442     def test_info_error_no_permission(self):
443         exc = vim.fault.NoPermission()
444         exc.privilegeId = "Fake privilege"
445         mock_task = MagicMock()
446         prop_mock_state = PropertyMock(return_value="error")
447         prop_mock_error = PropertyMock(side_effect=exc)
448         type(mock_task.info).state = prop_mock_state
449         type(mock_task.info).error = prop_mock_error
450         with self.assertRaises(VMwareApiError) as excinfo:
451             salt.utils.vmware.wait_for_task(
452                 mock_task, "fake_instance_name", "task_type"
453             )
454         self.assertEqual(
455             excinfo.exception.strerror,
456             "Not enough permissions. Required privilege: Fake privilege",
457         )
458     def test_info_error_vim_fault(self):
459         exc = vim.fault.VimFault()
460         exc.msg = "VimFault msg"
461         mock_task = MagicMock()
462         prop_mock_state = PropertyMock(return_value="error")
463         prop_mock_error = PropertyMock(side_effect=exc)
464         type(mock_task.info).state = prop_mock_state
465         type(mock_task.info).error = prop_mock_error
466         with self.assertRaises(VMwareApiError) as excinfo:
467             salt.utils.vmware.wait_for_task(
468                 mock_task, "fake_instance_name", "task_type"
469             )
470         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
471     def test_info_error_system_fault(self):
472         exc = vmodl.fault.SystemError()
473         exc.msg = "SystemError msg"
474         mock_task = MagicMock()
475         prop_mock_state = PropertyMock(return_value="error")
476         prop_mock_error = PropertyMock(side_effect=exc)
477         type(mock_task.info).state = prop_mock_state
478         type(mock_task.info).error = prop_mock_error
479         with self.assertRaises(VMwareSystemError) as excinfo:
480             salt.utils.vmware.wait_for_task(
481                 mock_task, "fake_instance_name", "task_type"
482             )
483         self.assertEqual(excinfo.exception.strerror, "SystemError msg")
484     def test_info_error_invalid_argument_no_fault_message(self):
485         exc = vmodl.fault.InvalidArgument()
486         exc.faultMessage = None
487         exc.msg = "InvalidArgumentFault msg"
488         mock_task = MagicMock()
489         prop_mock_state = PropertyMock(return_value="error")
490         prop_mock_error = PropertyMock(side_effect=exc)
491         type(mock_task.info).state = prop_mock_state
492         type(mock_task.info).error = prop_mock_error
493         with self.assertRaises(VMwareApiError) as excinfo:
494             salt.utils.vmware.wait_for_task(
495                 mock_task, "fake_instance_name", "task_type"
496             )
497         self.assertEqual(excinfo.exception.strerror, "InvalidArgumentFault msg")
498     def test_info_error_invalid_argument_with_fault_message(self):
499         exc = vmodl.fault.InvalidArgument()
500         fault_message = vim.LocalizableMessage()
501         fault_message.message = "LocalFault msg"
502         exc.faultMessage = [fault_message]
503         exc.msg = "InvalidArgumentFault msg"
504         mock_task = MagicMock()
505         prop_mock_state = PropertyMock(return_value="error")
506         prop_mock_error = PropertyMock(side_effect=exc)
507         type(mock_task.info).state = prop_mock_state
508         type(mock_task.info).error = prop_mock_error
509         with self.assertRaises(VMwareApiError) as excinfo:
510             salt.utils.vmware.wait_for_task(
511                 mock_task, "fake_instance_name", "task_type"
512             )
513         self.assertEqual(
514             excinfo.exception.strerror, "InvalidArgumentFault msg (LocalFault msg)"
515         )
516 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
517 class GetMorsWithPropertiesTestCase(TestCase):
518     si = None
519     obj_type = None
520     prop_list = None
521     container_ref = None
522     traversal_spec = None
523     def setUp(self):
524         self.si = MagicMock()
525         self.obj_type = MagicMock()
526         self.prop_list = MagicMock()
527         self.container_ref = MagicMock()
528         self.traversal_spec = MagicMock()
529     def test_empty_content(self):
530         get_content = MagicMock(return_value=[])
531         with patch("salt.utils.vmware.get_content", get_content):
532             ret = salt.utils.vmware.get_mors_with_properties(
533                 self.si,
534                 self.obj_type,
535                 self.prop_list,
536                 self.container_ref,
537                 self.traversal_spec,
538             )
539         get_content.assert_called_once_with(
540             self.si,
541             self.obj_type,
542             property_list=self.prop_list,
543             container_ref=self.container_ref,
544             traversal_spec=self.traversal_spec,
545             local_properties=False,
546         )
547         self.assertEqual(ret, [])
548     def test_local_properties_set(self):
549         obj_mock = MagicMock()
550         propSet_prop = PropertyMock(return_value=[])
551         type(obj_mock).propSet = propSet_prop
552         inner_obj_mock = MagicMock()
553         obj_prop = PropertyMock(return_value=inner_obj_mock)
554         type(obj_mock).obj = obj_prop
555         get_content = MagicMock(return_value=[obj_mock])
556         with patch("salt.utils.vmware.get_content", get_content):
557             ret = salt.utils.vmware.get_mors_with_properties(
558                 self.si,
559                 self.obj_type,
560                 self.prop_list,
561                 self.container_ref,
562                 self.traversal_spec,
563                 local_properties=True,
564             )
565         get_content.assert_called_once_with(
566             self.si,
567             self.obj_type,
568             property_list=self.prop_list,
569             container_ref=self.container_ref,
570             traversal_spec=self.traversal_spec,
571             local_properties=True,
572         )
573     def test_one_element_content(self):
574         obj_mock = MagicMock()
575         propSet_prop = PropertyMock(return_value=[])
576         type(obj_mock).propSet = propSet_prop
577         inner_obj_mock = MagicMock()
578         obj_prop = PropertyMock(return_value=inner_obj_mock)
579         type(obj_mock).obj = obj_prop
580         get_content = MagicMock(return_value=[obj_mock])
581         with patch("salt.utils.vmware.get_content", get_content):
582             ret = salt.utils.vmware.get_mors_with_properties(
583                 self.si,
584                 self.obj_type,
585                 self.prop_list,
586                 self.container_ref,
587                 self.traversal_spec,
588             )
589             get_content.assert_called_once_with(
590                 self.si,
591                 self.obj_type,
592                 property_list=self.prop_list,
593                 container_ref=self.container_ref,
594                 traversal_spec=self.traversal_spec,
595                 local_properties=False,
596             )
597         self.assertEqual(propSet_prop.call_count, 1)
598         self.assertEqual(obj_prop.call_count, 1)
599         self.assertEqual(len(ret), 1)
600         self.assertDictEqual(ret[0], {"object": inner_obj_mock})
601     def test_multiple_element_content(self):
602         obj1_mock = MagicMock()
603         obj1_propSet_prop = PropertyMock(return_value=[])
604         type(obj1_mock).propSet = obj1_propSet_prop
605         obj1_inner_obj_mock = MagicMock()
606         obj1_obj_prop = PropertyMock(return_value=obj1_inner_obj_mock)
607         type(obj1_mock).obj = obj1_obj_prop
608         obj2_mock = MagicMock()
609         obj2_propSet_prop = PropertyMock(return_value=[])
610         type(obj2_mock).propSet = obj2_propSet_prop
611         obj2_inner_obj_mock = MagicMock()
612         obj2_obj_prop = PropertyMock(return_value=obj2_inner_obj_mock)
613         type(obj2_mock).obj = obj2_obj_prop
614         get_content = MagicMock(return_value=[obj1_mock, obj2_mock])
615         with patch("salt.utils.vmware.get_content", get_content):
616             ret = salt.utils.vmware.get_mors_with_properties(
617                 self.si,
618                 self.obj_type,
619                 self.prop_list,
620                 self.container_ref,
621                 self.traversal_spec,
622             )
623         get_content.assert_called_once_with(
624             self.si,
625             self.obj_type,
626             property_list=self.prop_list,
627             container_ref=self.container_ref,
628             traversal_spec=self.traversal_spec,
629             local_properties=False,
630         )
631         self.assertEqual(obj1_propSet_prop.call_count, 1)
632         self.assertEqual(obj2_propSet_prop.call_count, 1)
633         self.assertEqual(obj1_obj_prop.call_count, 1)
634         self.assertEqual(obj2_obj_prop.call_count, 1)
635         self.assertEqual(len(ret), 2)
636         self.assertDictEqual(ret[0], {"object": obj1_inner_obj_mock})
637         self.assertDictEqual(ret[1], {"object": obj2_inner_obj_mock})
638     def test_one_elem_one_property(self):
639         obj_mock = MagicMock()
640         prop_set_obj_mock = MagicMock()
641         prop_set_obj_name_prop = PropertyMock(return_value="prop_name")
642         prop_set_obj_val_prop = PropertyMock(return_value="prop_value")
643         type(prop_set_obj_mock).name = prop_set_obj_name_prop
644         type(prop_set_obj_mock).val = prop_set_obj_val_prop
645         propSet_prop = PropertyMock(return_value=[prop_set_obj_mock])
646         type(obj_mock).propSet = propSet_prop
647         inner_obj_mock = MagicMock()
648         obj_prop = PropertyMock(return_value=inner_obj_mock)
649         type(obj_mock).obj = obj_prop
650         get_content = MagicMock(return_value=[obj_mock])
651         with patch("salt.utils.vmware.get_content", get_content):
652             ret = salt.utils.vmware.get_mors_with_properties(
653                 self.si,
654                 self.obj_type,
655                 self.prop_list,
656                 self.container_ref,
657                 self.traversal_spec,
658                 local_properties=False,
659             )
660         get_content.assert_called_once_with(
661             self.si,
662             self.obj_type,
663             property_list=self.prop_list,
664             container_ref=self.container_ref,
665             traversal_spec=self.traversal_spec,
666             local_properties=False,
667         )
668         self.assertEqual(propSet_prop.call_count, 1)
669         self.assertEqual(prop_set_obj_name_prop.call_count, 1)
670         self.assertEqual(prop_set_obj_val_prop.call_count, 1)
671         self.assertEqual(obj_prop.call_count, 1)
672         self.assertEqual(len(ret), 1)
673         self.assertDictEqual(
674             ret[0], {"prop_name": "prop_value", "object": inner_obj_mock}
675         )
676     def test_one_elem_multiple_properties(self):
677         obj_mock = MagicMock()
678         prop_set_obj1_mock = MagicMock()
679         prop_set_obj1_name_prop = PropertyMock(return_value="prop_name1")
680         prop_set_obj1_val_prop = PropertyMock(return_value="prop_value1")
681         type(prop_set_obj1_mock).name = prop_set_obj1_name_prop
682         type(prop_set_obj1_mock).val = prop_set_obj1_val_prop
683         prop_set_obj2_mock = MagicMock()
684         prop_set_obj2_name_prop = PropertyMock(return_value="prop_name2")
685         prop_set_obj2_val_prop = PropertyMock(return_value="prop_value2")
686         type(prop_set_obj2_mock).name = prop_set_obj2_name_prop
687         type(prop_set_obj2_mock).val = prop_set_obj2_val_prop
688         propSet_prop = PropertyMock(
689             return_value=[prop_set_obj1_mock, prop_set_obj2_mock]
690         )
691         type(obj_mock).propSet = propSet_prop
692         inner_obj_mock = MagicMock()
693         obj_prop = PropertyMock(return_value=inner_obj_mock)
694         type(obj_mock).obj = obj_prop
695         get_content = MagicMock(return_value=[obj_mock])
696         with patch("salt.utils.vmware.get_content", get_content):
697             ret = salt.utils.vmware.get_mors_with_properties(
698                 self.si,
699                 self.obj_type,
700                 self.prop_list,
701                 self.container_ref,
702                 self.traversal_spec,
703             )
704         get_content.assert_called_once_with(
705             self.si,
706             self.obj_type,
707             property_list=self.prop_list,
708             container_ref=self.container_ref,
709             traversal_spec=self.traversal_spec,
710             local_properties=False,
711         )
712         self.assertEqual(propSet_prop.call_count, 1)
713         self.assertEqual(prop_set_obj1_name_prop.call_count, 1)
714         self.assertEqual(prop_set_obj1_val_prop.call_count, 1)
715         self.assertEqual(prop_set_obj2_name_prop.call_count, 1)
716         self.assertEqual(prop_set_obj2_val_prop.call_count, 1)
717         self.assertEqual(obj_prop.call_count, 1)
718         self.assertEqual(len(ret), 1)
719         self.assertDictEqual(
720             ret[0],
721             {
722                 "prop_name1": "prop_value1",
723                 "prop_name2": "prop_value2",
724                 "object": inner_obj_mock,
725             },
726         )
727 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
728 class GetPropertiesOfManagedObjectTestCase(TestCase):
729     def setUp(self):
730         patches = (
731             ("salt.utils.vmware.get_service_instance_from_managed_object", MagicMock()),
732             (
733                 "salt.utils.vmware.get_mors_with_properties",
734                 MagicMock(return_value=[MagicMock()]),
735             ),
736         )
737         for mod, mock in patches:
738             patcher = patch(mod, mock)
739             patcher.start()
740             self.addCleanup(patcher.stop)
741         self.mock_si = MagicMock()
742         self.fake_mo_ref = vim.ManagedEntity("Fake")
743         self.mock_props = MagicMock()
744         self.mock_item_name = {"name": "fake_name"}
745         self.mock_item = MagicMock()
746     def test_get_service_instance_from_managed_object_call(self):
747         mock_get_instance_from_managed_object = MagicMock()
748         with patch(
749             "salt.utils.vmware.get_service_instance_from_managed_object",
750             mock_get_instance_from_managed_object,
751         ):
752             salt.utils.vmware.get_properties_of_managed_object(
753                 self.fake_mo_ref, self.mock_props
754             )
755         mock_get_instance_from_managed_object.assert_called_once_with(self.fake_mo_ref)
756     def test_get_mors_with_properties_calls(self):
757         mock_get_mors_with_properties = MagicMock(return_value=[MagicMock()])
758         with patch(
759             "salt.utils.vmware.get_service_instance_from_managed_object",
760             MagicMock(return_value=self.mock_si),
761         ):
762             with patch(
763                 "salt.utils.vmware.get_mors_with_properties",
764                 mock_get_mors_with_properties,
765             ):
766                 salt.utils.vmware.get_properties_of_managed_object(
767                     self.fake_mo_ref, self.mock_props
768                 )
769         mock_get_mors_with_properties.assert_has_calls(
770             [
771                 call(
772                     self.mock_si,
773                     vim.ManagedEntity,
774                     container_ref=self.fake_mo_ref,
775                     property_list=["name"],
776                     local_properties=True,
777                 ),
778                 call(
779                     self.mock_si,
780                     vim.ManagedEntity,
781                     container_ref=self.fake_mo_ref,
782                     property_list=self.mock_props,
783                     local_properties=True,
784                 ),
785             ]
786         )
787     def test_managed_object_no_name_property(self):
788         with patch(
789             "salt.utils.vmware.get_mors_with_properties",
790             MagicMock(side_effect=[vmodl.query.InvalidProperty(), []]),
791         ):
792             with self.assertRaises(VMwareApiError) as excinfo:
793                 salt.utils.vmware.get_properties_of_managed_object(
794                     self.fake_mo_ref, self.mock_props
795                 )
796         self.assertEqual(
797             "Properties of managed object '&lt;unnamed&gt;' weren't retrieved",
798             excinfo.exception.strerror,
799         )
800     def test_no_items_named_object(self):
801         with patch(
802             "salt.utils.vmware.get_mors_with_properties",
803             MagicMock(side_effect=[[self.mock_item_name], []]),
804         ):
805             with self.assertRaises(VMwareApiError) as excinfo:
806                 salt.utils.vmware.get_properties_of_managed_object(
807                     self.fake_mo_ref, self.mock_props
808                 )
809         self.assertEqual(
810             "Properties of managed object 'fake_name' weren't retrieved",
811             excinfo.exception.strerror,
812         )
813 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
814 class GetManagedObjectName(TestCase):
815     def setUp(self):
816         patches = (
817             (
818                 "salt.utils.vmware.get_properties_of_managed_object",
819                 MagicMock(return_value={"key": "value"}),
820             ),
821         )
822         for mod, mock in patches:
823             patcher = patch(mod, mock)
824             patcher.start()
825             self.addCleanup(patcher.stop)
826         self.mock_mo_ref = MagicMock()
827     def test_get_properties_of_managed_object_call(self):
828         mock_get_properties_of_managed_object = MagicMock()
829         with patch(
830             "salt.utils.vmware.get_properties_of_managed_object",
831             mock_get_properties_of_managed_object,
832         ):
833             salt.utils.vmware.get_managed_object_name(self.mock_mo_ref)
834         mock_get_properties_of_managed_object.assert_called_once_with(
835             self.mock_mo_ref, ["name"]
836         )
837     def test_no_name_in_property_dict(self):
838         ret = salt.utils.vmware.get_managed_object_name(self.mock_mo_ref)
839         self.assertIsNone(ret)
840     def test_return_managed_object_name(self):
841         mock_get_properties_of_managed_object = MagicMock()
842         with patch(
843             "salt.utils.vmware.get_properties_of_managed_object",
844             MagicMock(return_value={"name": "fake_name"}),
845         ):
846             ret = salt.utils.vmware.get_managed_object_name(self.mock_mo_ref)
847         self.assertEqual(ret, "fake_name")
848 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
849 class GetContentTestCase(TestCase):
850     traversal_spec_method_name = (
851         "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec"
852     )
853     property_spec_method_name = (
854         "salt.utils.vmware.vmodl.query.PropertyCollector.PropertySpec"
855     )
856     obj_spec_method_name = "salt.utils.vmware.vmodl.query.PropertyCollector.ObjectSpec"
857     filter_spec_method_name = (
858         "salt.utils.vmware.vmodl.query.PropertyCollector.FilterSpec"
859     )
860     si_mock = None
861     root_folder_mock = None
862     root_folder_prop = None
863     container_view_mock = None
864     create_container_view_mock = None
865     result_mock = None
866     retrieve_contents_mock = None
867     destroy_mock = None
868     obj_type_mock = None
869     traversal_spec_ret_mock = None
870     traversal_spec_mock = None
871     property_spec_ret_mock = None
872     property_spec_mock = None
873     obj_spec_ret_mock = None
874     obj_spec_mock = None
875     filter_spec_ret_mock = None
876     filter_spec_mock = None
877     def setUp(self):
878         patches = (
879             ("salt.utils.vmware.get_root_folder", MagicMock()),
880             (
881                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
882                 MagicMock(return_value=MagicMock()),
883             ),
884             (
885                 "salt.utils.vmware.vmodl.query.PropertyCollector.PropertySpec",
886                 MagicMock(return_value=MagicMock()),
887             ),
888             (
889                 "salt.utils.vmware.vmodl.query.PropertyCollector.ObjectSpec",
890                 MagicMock(return_value=MagicMock()),
891             ),
892             (
893                 "salt.utils.vmware.vmodl.query.PropertyCollector.FilterSpec",
894                 MagicMock(return_value=MagicMock()),
895             ),
896         )
897         for mod, mock in patches:
898             patcher = patch(mod, mock)
899             patcher.start()
900             self.addCleanup(patcher.stop)
901         self.si_mock = MagicMock()
902         self.root_folder_mock = MagicMock()
903         self.get_root_folder_mock = MagicMock(return_value=self.root_folder_mock)
904         self.container_view_mock = MagicMock()
905         self.create_container_view_mock = MagicMock(
906             return_value=self.container_view_mock
907         )
908         self.si_mock.content.viewManager.CreateContainerView = (
909             self.create_container_view_mock
910         )
911         self.result_mock = MagicMock()
912         self.retrieve_contents_mock = MagicMock(return_value=self.result_mock)
913         self.si_mock.content.propertyCollector.RetrieveContents = (
914             self.retrieve_contents_mock
915         )
916         self.destroy_mock = MagicMock()
917         self.container_view_mock.Destroy = self.destroy_mock
918         self.obj_type_mock = MagicMock()
919         self.traversal_spec_ret_mock = MagicMock()
920         self.traversal_spec_mock = MagicMock(return_value=self.traversal_spec_ret_mock)
921         self.property_spec_ret_mock = MagicMock()
922         self.property_spec_mock = MagicMock(return_value=self.property_spec_ret_mock)
923         self.obj_spec_ret_mock = MagicMock()
924         self.obj_spec_mock = MagicMock(return_value=self.obj_spec_ret_mock)
925         self.filter_spec_ret_mock = MagicMock()
926         self.filter_spec_mock = MagicMock(return_value=self.filter_spec_ret_mock)
927     def test_empty_container_ref(self):
928         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
929             salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
930         self.get_root_folder_mock.assert_called_once_with(self.si_mock)
931         self.create_container_view_mock.assert_called_once_with(
932             self.root_folder_mock, [self.obj_type_mock], True
933         )
934     def test_defined_container_ref(self):
935         container_ref_mock = MagicMock()
936         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
937             with patch(self.obj_spec_method_name, self.obj_type_mock):
938                 salt.utils.vmware.get_content(
939                     self.si_mock, self.obj_type_mock, container_ref=container_ref_mock
940                 )
941         self.assertEqual(self.get_root_folder_mock.call_count, 0)
942         self.create_container_view_mock.assert_called_once_with(
943             container_ref_mock, [self.obj_type_mock], True
944         )
945     def test_local_traversal_spec(self):
946         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
947             with patch(self.traversal_spec_method_name, self.traversal_spec_mock):
948                 with patch(self.obj_spec_method_name, self.obj_spec_mock):
949                     ret = salt.utils.vmware.get_content(
950                         self.si_mock, self.obj_type_mock
951                     )
952         self.create_container_view_mock.assert_called_once_with(
953             self.root_folder_mock, [self.obj_type_mock], True
954         )
955         self.traversal_spec_mock.assert_called_once_with(
956             name="traverseEntities",
957             path="view",
958             skip=False,
959             type=vim.view.ContainerView,
960         )
961         self.obj_spec_mock.assert_called_once_with(
962             obj=self.container_view_mock,
963             skip=True,
964             selectSet=[self.traversal_spec_ret_mock],
965         )
966         self.assertEqual(self.destroy_mock.call_count, 1)
967     def test_create_container_view_raise_no_permission(self):
968         exc = vim.fault.NoPermission()
969         exc.privilegeId = "Fake privilege"
970         self.si_mock.content.viewManager.CreateContainerView = MagicMock(
971             side_effect=exc
972         )
973         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
974             with self.assertRaises(VMwareApiError) as excinfo:
975                 salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
976         self.assertEqual(
977             excinfo.exception.strerror,
978             "Not enough permissions. Required privilege: Fake privilege",
979         )
980     def test_create_container_view_raise_vim_fault(self):
981         exc = vim.fault.VimFault()
982         exc.msg = "VimFault msg"
983         self.si_mock.content.viewManager.CreateContainerView = MagicMock(
984             side_effect=exc
985         )
986         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
987             with self.assertRaises(VMwareApiError) as excinfo:
988                 salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
989         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
990     def test_create_container_view_raise_runtime_fault(self):
991         exc = vmodl.RuntimeFault()
992         exc.msg = "RuntimeFault msg"
993         self.si_mock.content.viewManager.CreateContainerView = MagicMock(
994             side_effect=exc
995         )
996         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
997             with self.assertRaises(VMwareRuntimeError) as excinfo:
998                 salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
999         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1000     def test_destroy_raise_no_permission(self):
1001         exc = vim.fault.NoPermission()
1002         exc.privilegeId = "Fake privilege"
1003         self.si_mock.content.viewManager.CreateContainerView = MagicMock(
1004             return_value=MagicMock(Destroy=MagicMock(side_effect=exc))
1005         )
1006         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
1007             with self.assertRaises(VMwareApiError) as excinfo:
1008                 salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
1009         self.assertEqual(
1010             excinfo.exception.strerror,
1011             "Not enough permissions. Required privilege: Fake privilege",
1012         )
1013     def test_destroy_raise_vim_fault(self):
1014         exc = vim.fault.VimFault()
1015         exc.msg = "VimFault msg"
1016         self.si_mock.content.viewManager.CreateContainerView = MagicMock(
1017             return_value=MagicMock(Destroy=MagicMock(side_effect=exc))
1018         )
1019         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
1020             with self.assertRaises(VMwareApiError) as excinfo:
1021                 salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
1022         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1023     def test_destroy_raise_runtime_fault(self):
1024         exc = vmodl.RuntimeFault()
1025         exc.msg = "RuntimeFault msg"
1026         self.si_mock.content.viewManager.CreateContainerView = MagicMock(
1027             return_value=MagicMock(Destroy=MagicMock(side_effect=exc))
1028         )
1029         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
1030             with self.assertRaises(VMwareRuntimeError) as excinfo:
1031                 salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
1032         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1033     def test_external_traversal_spec(self):
1034         traversal_spec_obj_mock = MagicMock()
1035         with patch("salt.utils.vmware.get_root_folder", self.get_root_folder_mock):
1036             with patch(self.traversal_spec_method_name, self.traversal_spec_mock):
1037                 with patch(self.obj_spec_method_name, self.obj_spec_mock):
1038                     salt.utils.vmware.get_content(
1039                         self.si_mock,
1040                         self.obj_type_mock,
1041                         traversal_spec=traversal_spec_obj_mock,
1042                     )
1043         self.obj_spec_mock.assert_called_once_with(
1044             obj=self.root_folder_mock, skip=True, selectSet=[traversal_spec_obj_mock]
1045         )
1046         self.assertEqual(self.create_container_view_mock.call_count, 0)
1047         self.assertEqual(self.traversal_spec_mock.call_count, 0)
1048         self.assertEqual(self.destroy_mock.call_count, 0)
1049     def test_property_obj_filter_specs_and_contents(self):
1050         with patch(self.traversal_spec_method_name, self.traversal_spec_mock):
1051             with patch(self.property_spec_method_name, self.property_spec_mock):
1052                 with patch(self.obj_spec_method_name, self.obj_spec_mock):
1053                     with patch(self.filter_spec_method_name, self.filter_spec_mock):
1054                         ret = salt.utils.vmware.get_content(
1055                             self.si_mock, self.obj_type_mock
1056                         )
1057         self.traversal_spec_mock.assert_called_once_with(
1058             name="traverseEntities",
1059             path="view",
1060             skip=False,
1061             type=vim.view.ContainerView,
1062         )
1063         self.property_spec_mock.assert_called_once_with(
1064             type=self.obj_type_mock, all=True, pathSet=None
1065         )
1066 <a name="1"></a>        self.obj_spec_mock.assert_called_once_with(
1067             obj=self.container_view_mock,
1068             skip=True,
1069             selectSet=[self<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.traversal_spec_ret_mock],
1070         )
1071         self.retrieve_contents_mock.assert_called_once_with([self.filter_spec_ret_mock])
1072         self.assertEqual(ret, self.result_mock)
1073     def test_retrieve_contents_raise_no_permission(self):
1074         exc = vim.</b></font>fault.NoPermission()
1075         exc.privilegeId = "Fake privilege"
1076         self.si_mock.content.propertyCollector.RetrieveContents = MagicMock(
1077             side_effect=exc
1078         )
1079         with self.assertRaises(VMwareApiError) as excinfo:
1080             salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
1081         self.assertEqual(
1082             excinfo.exception.strerror,
1083             "Not enough permissions. Required privilege: Fake privilege",
1084         )
1085     def test_retrieve_contents_raise_vim_fault(self):
1086         exc = vim.fault.VimFault()
1087         exc.msg = "VimFault msg"
1088         self.si_mock.content.propertyCollector.RetrieveContents = MagicMock(
1089             side_effect=exc
1090         )
1091         with self.assertRaises(VMwareApiError) as excinfo:
1092             salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
1093         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1094     def test_retrieve_contents_raise_runtime_fault(self):
1095         exc = vmodl.RuntimeFault()
1096         exc.msg = "RuntimeFault msg"
1097         self.si_mock.content.propertyCollector.RetrieveContents = MagicMock(
1098             side_effect=exc
1099         )
1100         with self.assertRaises(VMwareRuntimeError) as excinfo:
1101             salt.utils.vmware.get_content(self.si_mock, self.obj_type_mock)
1102         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1103     def test_local_properties_set(self):
1104         container_ref_mock = MagicMock()
1105         with patch(self.traversal_spec_method_name, self.traversal_spec_mock):
1106             with patch(self.property_spec_method_name, self.property_spec_mock):
1107                 with patch(self.obj_spec_method_name, self.obj_spec_mock):
1108                     salt.utils.vmware.get_content(
1109                         self.si_mock,
1110                         self.obj_type_mock,
1111                         container_ref=container_ref_mock,
1112                         local_properties=True,
1113                     )
1114         self.assertEqual(self.traversal_spec_mock.call_count, 0)
1115         self.obj_spec_mock.assert_called_once_with(
1116             obj=container_ref_mock, skip=False, selectSet=None
1117         )
1118 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1119 class GetRootFolderTestCase(TestCase):
1120     def setUp(self):
1121         self.mock_root_folder = MagicMock()
1122         self.mock_content = MagicMock(rootFolder=self.mock_root_folder)
1123         self.mock_si = MagicMock(
1124             RetrieveContent=MagicMock(return_value=self.mock_content)
1125         )
1126     def test_raise_no_permission(self):
1127         exc = vim.fault.NoPermission()
1128         exc.privilegeId = "Fake privilege"
1129         type(self.mock_content).rootFolder = PropertyMock(side_effect=exc)
1130         with self.assertRaises(VMwareApiError) as excinfo:
1131             salt.utils.vmware.get_root_folder(self.mock_si)
1132         self.assertEqual(
1133             excinfo.exception.strerror,
1134             "Not enough permissions. Required privilege: Fake privilege",
1135         )
1136     def test_raise_vim_fault(self):
1137         exc = vim.fault.VimFault()
1138         exc.msg = "VimFault msg"
1139         type(self.mock_content).rootFolder = PropertyMock(side_effect=exc)
1140         with self.assertRaises(VMwareApiError) as excinfo:
1141             salt.utils.vmware.get_root_folder(self.mock_si)
1142         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1143     def test_raise_runtime_fault(self):
1144         exc = vmodl.RuntimeFault()
1145         exc.msg = "RuntimeFault msg"
1146         type(self.mock_content).rootFolder = PropertyMock(side_effect=exc)
1147         with self.assertRaises(VMwareRuntimeError) as excinfo:
1148             salt.utils.vmware.get_root_folder(self.mock_si)
1149         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1150     def test_return(self):
1151         ret = salt.utils.vmware.get_root_folder(self.mock_si)
1152         self.assertEqual(ret, self.mock_root_folder)
1153 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1154 class GetServiceInfoTestCase(TestCase):
1155     def setUp(self):
1156         self.mock_about = MagicMock()
1157         self.mock_si = MagicMock(content=MagicMock())
1158         type(self.mock_si.content).about = PropertyMock(return_value=self.mock_about)
1159     def tearDown(self):
1160         for attr in ("mock_si", "mock_about"):
1161             delattr(self, attr)
1162     def test_about_ret(self):
1163         ret = salt.utils.vmware.get_service_info(self.mock_si)
1164         self.assertEqual(ret, self.mock_about)
1165     def test_about_raises_no_permission(self):
1166         exc = vim.fault.NoPermission()
1167         exc.privilegeId = "Fake privilege"
1168         type(self.mock_si.content).about = PropertyMock(side_effect=exc)
1169         with self.assertRaises(VMwareApiError) as excinfo:
1170             salt.utils.vmware.get_service_info(self.mock_si)
1171         self.assertEqual(
1172             excinfo.exception.strerror,
1173             "Not enough permissions. Required privilege: Fake privilege",
1174         )
1175     def test_about_raises_vim_fault(self):
1176         exc = vim.fault.VimFault()
1177         exc.msg = "VimFault msg"
1178         type(self.mock_si.content).about = PropertyMock(side_effect=exc)
1179         with self.assertRaises(VMwareApiError) as excinfo:
1180             salt.utils.vmware.get_service_info(self.mock_si)
1181         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1182     def test_about_raises_runtime_fault(self):
1183         exc = vmodl.RuntimeFault()
1184         exc.msg = "RuntimeFault msg"
1185         type(self.mock_si.content).about = PropertyMock(side_effect=exc)
1186         with self.assertRaises(VMwareRuntimeError) as excinfo:
1187             salt.utils.vmware.get_service_info(self.mock_si)
1188         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1189 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1190 @skipIf(not HAS_GSSAPI, "The 'gssapi' library is missing")
1191 class GssapiTokenTest(TestCase):
1192     def setUp(self):
1193         patches = (
1194             ("gssapi.Name", MagicMock(return_value="service")),
1195             ("gssapi.InitContext", MagicMock()),
1196         )
1197         for mod, mock in patches:
1198             patcher = patch(mod, mock)
1199             patcher.start()
1200             self.addCleanup(patcher.stop)
1201     def test_no_gssapi(self):
1202         with patch("salt.utils.vmware.HAS_GSSAPI", False):
1203             with self.assertRaises(ImportError) as excinfo:
1204                 salt.utils.vmware.get_gssapi_token("principal", "host", "domain")
1205                 self.assertIn(
1206                     "The gssapi library is not imported.", excinfo.exception.message
1207                 )
1208     @skipIf(not HAS_GSSAPI, "The 'gssapi' library is missing")
1209     def test_service_name(self):
1210         mock_name = MagicMock()
1211         with patch.object(salt.utils.vmware.gssapi, "Name", mock_name):
1212             with self.assertRaises(CommandExecutionError):
1213                 salt.utils.vmware.get_gssapi_token("principal", "host", "domain")
1214             mock_name.assert_called_once_with(
1215                 "principal/host@domain", gssapi.C_NT_USER_NAME
1216             )
1217     @skipIf(not HAS_GSSAPI, "The 'gssapi' library is missing")
1218     def test_out_token_defined(self):
1219         mock_context = MagicMock(return_value=MagicMock())
1220         mock_context.return_value.established = False
1221         mock_context.return_value.step = MagicMock(return_value="out_token")
1222         with patch.object(salt.utils.vmware.gssapi, "InitContext", mock_context):
1223             ret = salt.utils.vmware.get_gssapi_token("principal", "host", "domain")
1224             self.assertEqual(mock_context.return_value.step.called, 1)
1225             self.assertEqual(ret, base64.b64encode(b"out_token"))
1226     @skipIf(not HAS_GSSAPI, "The 'gssapi' library is missing")
1227     def test_out_token_undefined(self):
1228         mock_context = MagicMock(return_value=MagicMock())
1229         mock_context.return_value.established = False
1230         mock_context.return_value.step = MagicMock(return_value=None)
1231         with patch.object(salt.utils.vmware.gssapi, "InitContext", mock_context):
1232             with self.assertRaises(CommandExecutionError) as excinfo:
1233                 salt.utils.vmware.get_gssapi_token("principal", "host", "domain")
1234             self.assertEqual(mock_context.return_value.step.called, 1)
1235             self.assertIn("Can't receive token", excinfo.exception.strerror)
1236     @skipIf(not HAS_GSSAPI, "The 'gssapi' library is missing")
1237     def test_context_extablished(self):
1238         mock_context = MagicMock(return_value=MagicMock())
1239         mock_context.return_value.established = True
1240         mock_context.return_value.step = MagicMock(return_value="out_token")
1241         with patch.object(salt.utils.vmware.gssapi, "InitContext", mock_context):
1242             mock_context.established = True
1243             mock_context.step = MagicMock(return_value=None)
1244             with self.assertRaises(CommandExecutionError) as excinfo:
1245                 salt.utils.vmware.get_gssapi_token("principal", "host", "domain")
1246             self.assertEqual(mock_context.step.called, 0)
1247             self.assertIn(
1248                 "Context established, but didn't receive token",
1249                 excinfo.exception.strerror,
1250             )
1251 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1252 class PrivateGetServiceInstanceTestCase(TestCase):
1253     def setUp(self):
1254         patches = (
1255             ("salt.utils.vmware.SmartConnect", MagicMock()),
1256             ("salt.utils.vmware.Disconnect", MagicMock()),
1257             (
1258                 "salt.utils.vmware.get_gssapi_token",
1259                 MagicMock(return_value="fake_token"),
1260             ),
1261         )
1262         for mod, mock in patches:
1263             patcher = patch(mod, mock)
1264             patcher.start()
1265             self.addCleanup(patcher.stop)
1266     def test_invalid_mechianism(self):
1267         with self.assertRaises(CommandExecutionError) as excinfo:
1268             salt.utils.vmware._get_service_instance(
1269                 host="fake_host.fqdn",
1270                 username="fake_username",
1271                 password="fake_password",
1272                 protocol="fake_protocol",
1273                 port=1,
1274                 mechanism="invalid_mechanism",
1275                 principal="fake principal",
1276                 domain="fake_domain",
1277             )
1278         self.assertIn("Unsupported mechanism", excinfo.exception.strerror)
1279     def test_userpass_mechanism_empty_username(self):
1280         with self.assertRaises(CommandExecutionError) as excinfo:
1281             salt.utils.vmware._get_service_instance(
1282                 host="fake_host.fqdn",
1283                 username=None,
1284                 password="fake_password",
1285                 protocol="fake_protocol",
1286                 port=1,
1287                 mechanism="userpass",
1288                 principal="fake principal",
1289                 domain="fake_domain",
1290             )
1291         self.assertIn("mandatory parameter 'username'", excinfo.exception.strerror)
1292     def test_userpass_mechanism_empty_password(self):
1293         with self.assertRaises(CommandExecutionError) as excinfo:
1294             salt.utils.vmware._get_service_instance(
1295                 host="fake_host.fqdn",
1296                 username="fake_username",
1297                 password=None,
1298                 protocol="fake_protocol",
1299                 port=1,
1300                 mechanism="userpass",
1301                 principal="fake principal",
1302                 domain="fake_domain",
1303             )
1304         self.assertIn("mandatory parameter 'password'", excinfo.exception.strerror)
1305     def test_userpass_mechanism_no_domain(self):
1306         mock_sc = MagicMock()
1307         with patch("salt.utils.vmware.SmartConnect", mock_sc):
1308             salt.utils.vmware._get_service_instance(
1309                 host="fake_host.fqdn",
1310                 username="fake_username",
1311                 password="fake_password",
1312                 protocol="fake_protocol",
1313                 port=1,
1314                 mechanism="userpass",
1315                 principal="fake principal",
1316                 domain=None,
1317             )
1318             mock_sc.assert_called_once_with(
1319                 host="fake_host.fqdn",
1320                 user="fake_username",
1321                 pwd="fake_password",
1322                 protocol="fake_protocol",
1323                 port=1,
1324                 b64token=None,
1325                 mechanism="userpass",
1326             )
1327     def test_userpass_mech_domain_unused(self):
1328         mock_sc = MagicMock()
1329         with patch("salt.utils.vmware.SmartConnect", mock_sc):
1330             salt.utils.vmware._get_service_instance(
1331                 host="fake_host.fqdn",
1332                 username="fake_username@domain",
1333                 password="fake_password",
1334                 protocol="fake_protocol",
1335                 port=1,
1336                 mechanism="userpass",
1337                 principal="fake principal",
1338                 domain="fake_domain",
1339             )
1340             mock_sc.assert_called_once_with(
1341                 host="fake_host.fqdn",
1342                 user="fake_username@domain",
1343                 pwd="fake_password",
1344                 protocol="fake_protocol",
1345                 port=1,
1346                 b64token=None,
1347                 mechanism="userpass",
1348             )
1349             mock_sc.reset_mock()
1350             salt.utils.vmware._get_service_instance(
1351                 host="fake_host.fqdn",
1352                 username="domain\\fake_username",
1353                 password="fake_password",
1354                 protocol="fake_protocol",
1355                 port=1,
1356                 mechanism="userpass",
1357                 principal="fake principal",
1358                 domain="fake_domain",
1359             )
1360             mock_sc.assert_called_once_with(
1361                 host="fake_host.fqdn",
1362                 user="domain\\fake_username",
1363                 pwd="fake_password",
1364                 protocol="fake_protocol",
1365                 port=1,
1366                 b64token=None,
1367                 mechanism="userpass",
1368             )
1369     def test_sspi_empty_principal(self):
1370         with self.assertRaises(CommandExecutionError) as excinfo:
1371             salt.utils.vmware._get_service_instance(
1372                 host="fake_host.fqdn",
1373                 username="fake_username",
1374                 password="fake_password",
1375                 protocol="fake_protocol",
1376                 port=1,
1377                 mechanism="sspi",
1378                 principal=None,
1379                 domain="fake_domain",
1380             )
1381         self.assertIn("mandatory parameters are missing", excinfo.exception.strerror)
1382     def test_sspi_empty_domain(self):
1383         with self.assertRaises(CommandExecutionError) as excinfo:
1384             salt.utils.vmware._get_service_instance(
1385                 host="fake_host.fqdn",
1386                 username="fake_username",
1387                 password="fake_password",
1388                 protocol="fake_protocol",
1389                 port=1,
1390                 mechanism="sspi",
1391                 principal="fake_principal",
1392                 domain=None,
1393             )
1394         self.assertIn("mandatory parameters are missing", excinfo.exception.strerror)
1395     def test_sspi_get_token_error(self):
1396         mock_token = MagicMock(side_effect=Exception("Exception"))
1397         with patch("salt.utils.vmware.get_gssapi_token", mock_token):
1398             with self.assertRaises(VMwareConnectionError) as excinfo:
1399                 salt.utils.vmware._get_service_instance(
1400                     host="fake_host.fqdn",
1401                     username="fake_username",
1402                     password="fake_password",
1403                     protocol="fake_protocol",
1404                     port=1,
1405                     mechanism="sspi",
1406                     principal="fake_principal",
1407                     domain="fake_domain",
1408                 )
1409             mock_token.assert_called_once_with(
1410                 "fake_principal", "fake_host.fqdn", "fake_domain"
1411             )
1412             self.assertEqual("Exception", excinfo.exception.strerror)
1413     def test_sspi_get_token_success_(self):
1414         mock_token = MagicMock(return_value="fake_token")
1415         mock_sc = MagicMock()
1416         with patch("salt.utils.vmware.get_gssapi_token", mock_token):
1417             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1418                 salt.utils.vmware._get_service_instance(
1419                     host="fake_host.fqdn",
1420                     username="fake_username",
1421                     password="fake_password",
1422                     protocol="fake_protocol",
1423                     port=1,
1424                     mechanism="sspi",
1425                     principal="fake_principal",
1426                     domain="fake_domain",
1427                 )
1428             mock_token.assert_called_once_with(
1429                 "fake_principal", "fake_host.fqdn", "fake_domain"
1430             )
1431             mock_sc.assert_called_once_with(
1432                 host="fake_host.fqdn",
1433                 user="fake_username",
1434                 pwd="fake_password",
1435                 protocol="fake_protocol",
1436                 port=1,
1437                 b64token="fake_token",
1438                 mechanism="sspi",
1439             )
1440     def test_first_attempt_successful_connection(self):
1441         mock_sc = MagicMock()
1442         with patch("salt.utils.vmware.SmartConnect", mock_sc):
1443             salt.utils.vmware._get_service_instance(
1444                 host="fake_host.fqdn",
1445                 username="fake_username",
1446                 password="fake_password",
1447                 protocol="fake_protocol",
1448                 port=1,
1449                 mechanism="sspi",
1450                 principal="fake_principal",
1451                 domain="fake_domain",
1452             )
1453             mock_sc.assert_called_once_with(
1454                 host="fake_host.fqdn",
1455                 user="fake_username",
1456                 pwd="fake_password",
1457                 protocol="fake_protocol",
1458                 port=1,
1459                 b64token="fake_token",
1460                 mechanism="sspi",
1461             )
1462     def test_first_attempt_successful_connection_verify_ssl_false(self):
1463         with patch("ssl.SSLContext", MagicMock()), patch(
1464             "ssl._create_unverified_context", MagicMock()
1465         ):
1466             exc = vim.fault.HostConnectFault()
1467             exc.msg = "[SSL: CERTIFICATE_VERIFY_FAILED]"
1468             mock_sc = MagicMock(side_effect=[None])
1469             mock_ssl = MagicMock()
1470             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1471                 with patch("ssl._create_unverified_context", mock_ssl):
1472                     salt.utils.vmware._get_service_instance(
1473                         host="fake_host.fqdn",
1474                         username="fake_username",
1475                         password="fake_password",
1476                         protocol="fake_protocol",
1477                         port=1,
1478                         mechanism="sspi",
1479                         principal="fake_principal",
1480                         domain="fake_domain",
1481                         verify_ssl=False,
1482                     )
1483                     mock_ssl.assert_called_once_with()
1484                     calls = [
1485                         call(
1486                             host="fake_host.fqdn",
1487                             user="fake_username",
1488                             pwd="fake_password",
1489                             protocol="fake_protocol",
1490                             port=1,
1491                             sslContext=mock_ssl.return_value,
1492                             b64token="fake_token",
1493                             mechanism="sspi",
1494                         ),
1495                     ]
1496                     mock_sc.assert_has_calls(calls)
1497     def test_second_attempt_successful_connection_verify_ssl_false(self):
1498         with patch("ssl.SSLContext", MagicMock()), patch(
1499             "ssl._create_unverified_context", MagicMock()
1500         ):
1501             exc = Exception("certificate verify failed")
1502             mock_sc = MagicMock(side_effect=[exc, None])
1503             mock_ssl_unverif = MagicMock()
1504             mock_ssl_context = MagicMock()
1505             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1506                 with patch("ssl._create_unverified_context", mock_ssl_unverif):
1507                     with patch("ssl.SSLContext", mock_ssl_context):
1508                         salt.utils.vmware._get_service_instance(
1509                             host="fake_host.fqdn",
1510                             username="fake_username",
1511                             password="fake_password",
1512                             protocol="fake_protocol",
1513                             port=1,
1514                             mechanism="sspi",
1515                             principal="fake_principal",
1516                             domain="fake_domain",
1517                             verify_ssl=False,
1518                         )
1519                         mock_ssl_context.assert_called_once_with(ssl.PROTOCOL_TLSv1)
1520                         mock_ssl_unverif.assert_called_once_with()
1521                         calls = [
1522                             call(
1523                                 host="fake_host.fqdn",
1524                                 user="fake_username",
1525                                 pwd="fake_password",
1526                                 protocol="fake_protocol",
1527                                 port=1,
1528                                 sslContext=mock_ssl_unverif.return_value,
1529                                 b64token="fake_token",
1530                                 mechanism="sspi",
1531                             ),
1532                             call(
1533                                 host="fake_host.fqdn",
1534                                 user="fake_username",
1535                                 pwd="fake_password",
1536                                 protocol="fake_protocol",
1537                                 port=1,
1538                                 sslContext=mock_ssl_context.return_value,
1539                                 b64token="fake_token",
1540                                 mechanism="sspi",
1541                             ),
1542                         ]
1543                         mock_sc.assert_has_calls(calls)
1544     def test_attempt_unsuccessful_connection_default_error(self):
1545         exc = Exception("Exception")
1546         mock_sc = MagicMock(side_effect=exc)
1547         with patch("salt.utils.vmware.SmartConnect", mock_sc):
1548             with self.assertRaises(VMwareConnectionError) as excinfo:
1549                 salt.utils.vmware._get_service_instance(
1550                     host="fake_host.fqdn",
1551                     username="fake_username",
1552                     password="fake_password",
1553                     protocol="fake_protocol",
1554                     port=1,
1555                     mechanism="sspi",
1556                     principal="fake_principal",
1557                     domain="fake_domain",
1558                 )
1559         self.assertEqual(mock_sc.call_count, 1)
1560         self.assertIn(
1561             "Could not connect to host 'fake_host.fqdn'",
1562             excinfo.exception.message,
1563         )
1564     def test_attempt_unsuccessful_connection_vim_fault(self):
1565         exc = vim.fault.VimFault()
1566         exc.msg = "VimFault"
1567         mock_sc = MagicMock(side_effect=exc)
1568         with patch("salt.utils.vmware.SmartConnect", mock_sc):
1569             with self.assertRaises(VMwareConnectionError) as excinfo:
1570                 salt.utils.vmware._get_service_instance(
1571                     host="fake_host.fqdn",
1572                     username="fake_username",
1573                     password="fake_password",
1574                     protocol="fake_protocol",
1575                     port=1,
1576                     mechanism="sspi",
1577                     principal="fake_principal",
1578                     domain="fake_domain",
1579                 )
1580         self.assertEqual(mock_sc.call_count, 1)
1581         self.assertEqual("VimFault", excinfo.exception.message)
1582     def test_first_attempt_unsuccsessful_connection_default_error(self):
1583         with patch("ssl.SSLContext", MagicMock()), patch(
1584             "ssl._create_unverified_context", MagicMock()
1585         ):
1586             exc = vim.fault.HostConnectFault()
1587             exc.msg = "certificate verify failed"
1588             exc2 = Exception("Exception")
1589             mock_sc = MagicMock(side_effect=[exc, exc2])
1590             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1591                 with self.assertRaises(VMwareConnectionError) as excinfo:
1592                     salt.utils.vmware._get_service_instance(
1593                         host="fake_host.fqdn",
1594                         username="fake_username",
1595                         password="fake_password",
1596                         protocol="fake_protocol",
1597                         port=1,
1598                         mechanism="sspi",
1599                         principal="fake_principal",
1600                         domain="fake_domain",
1601                         verify_ssl=False,
1602                     )
1603             self.assertEqual(mock_sc.call_count, 2)
1604             self.assertIn(
1605                 "Could not connect to host 'fake_host.fqdn'", excinfo.exception.message
1606             )
1607     def test_first_attempt_unsuccsessful_cannot_vim_fault_verify_ssl(self):
1608         with patch("ssl.SSLContext", MagicMock()), patch(
1609             "ssl._create_unverified_context", MagicMock()
1610         ):
1611             exc = vim.fault.VimFault()
1612             exc.msg = "VimFault"
1613             mock_sc = MagicMock(side_effect=[exc])
1614             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1615                 with self.assertRaises(VMwareConnectionError) as excinfo:
1616                     salt.utils.vmware._get_service_instance(
1617                         host="fake_host.fqdn",
1618                         username="fake_username",
1619                         password="fake_password",
1620                         protocol="fake_protocol",
1621                         port=1,
1622                         mechanism="sspi",
1623                         principal="fake_principal",
1624                         domain="fake_domain",
1625                         verify_ssl=False,
1626                     )
1627             self.assertEqual(mock_sc.call_count, 1)
1628             self.assertIn("VimFault", excinfo.exception.message)
1629     def test_third_attempt_unsuccessful_connection_detault_error(self):
1630         with patch("ssl.SSLContext", MagicMock()), patch(
1631             "ssl._create_unverified_context", MagicMock()
1632         ):
1633             exc = vim.fault.HostConnectFault()
1634             exc.msg = "certificate verify failed"
1635             exc2 = Exception("Exception")
1636             mock_sc = MagicMock(side_effect=[exc, exc2])
1637             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1638                 with self.assertRaises(VMwareConnectionError) as excinfo:
1639                     salt.utils.vmware._get_service_instance(
1640                         host="fake_host.fqdn",
1641                         username="fake_username",
1642                         password="fake_password",
1643                         protocol="fake_protocol",
1644                         port=1,
1645                         mechanism="sspi",
1646                         principal="fake_principal",
1647                         domain="fake_domain",
1648                         verify_ssl=False,
1649                     )
1650             self.assertEqual(mock_sc.call_count, 2)
1651             self.assertIn(
1652                 "Could not connect to host 'fake_host.fqdn", excinfo.exception.message
1653             )
1654     def test_second_attempt_unsuccessful_connection_vim_fault(self):
1655         with patch("ssl.SSLContext", MagicMock()), patch(
1656             "ssl._create_unverified_context", MagicMock()
1657         ):
1658             exc = vim.fault.VimFault()
1659             exc.msg = "VimFault"
1660             mock_sc = MagicMock(side_effect=[exc])
1661             with patch("salt.utils.vmware.SmartConnect", mock_sc):
1662                 with self.assertRaises(VMwareConnectionError) as excinfo:
1663                     salt.utils.vmware._get_service_instance(
1664                         host="fake_host.fqdn",
1665                         username="fake_username",
1666                         password="fake_password",
1667                         protocol="fake_protocol",
1668                         port=1,
1669                         mechanism="sspi",
1670                         principal="fake_principal",
1671                         domain="fake_domain",
1672                         verify_ssl=False,
1673                     )
1674             self.assertEqual(mock_sc.call_count, 1)
1675             self.assertIn("VimFault", excinfo.exception.message)
1676 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1677 class GetServiceInstanceTestCase(TestCase):
1678     def setUp(self):
1679         patches = (
1680             ("salt.utils.vmware.GetSi", MagicMock(return_value=None)),
1681             (
1682                 "salt.utils.vmware._get_service_instance",
1683                 MagicMock(return_value=MagicMock()),
1684             ),
1685         )
1686         for mod, mock in patches:
1687             patcher = patch(mod, mock)
1688             patcher.start()
1689             self.addCleanup(patcher.stop)
1690     def test_default_params(self):
1691         mock_get_si = MagicMock()
1692         with patch("salt.utils.vmware._get_service_instance", mock_get_si):
1693             salt.utils.vmware.get_service_instance(host="fake_host")
1694             mock_get_si.assert_called_once_with(
1695                 "fake_host",
1696                 None,
1697                 None,
1698                 "https",
1699                 443,
1700                 "userpass",
1701                 None,
1702                 None,
1703                 verify_ssl=True,
1704             )
1705     def test_no_cached_service_instance_same_host_on_proxy(self):
1706         with patch("salt.utils.platform.is_proxy", MagicMock(return_value=True)):
1707             mock_get_si = MagicMock()
1708             with patch("salt.utils.vmware._get_service_instance", mock_get_si):
1709                 salt.utils.vmware.get_service_instance(
1710                     host="fake_host",
1711                     username="fake_username",
1712                     password="fake_password",
1713                     protocol="fake_protocol",
1714                     port=1,
1715                     mechanism="fake_mechanism",
1716                     principal="fake_principal",
1717                     domain="fake_domain",
1718                 )
1719                 mock_get_si.assert_called_once_with(
1720                     "fake_host",
1721                     "fake_username",
1722                     "fake_password",
1723                     "fake_protocol",
1724                     1,
1725                     "fake_mechanism",
1726                     "fake_principal",
1727                     "fake_domain",
1728                     verify_ssl=True,
1729                 )
1730     def test_cached_service_instance_different_host(self):
1731         mock_si = MagicMock()
1732         mock_disconnect = MagicMock()
1733         mock_get_si = MagicMock(return_value=mock_si)
1734         mock_getstub = MagicMock()
1735         with patch("salt.utils.vmware.GetSi", mock_get_si):
1736             with patch("salt.utils.vmware.GetStub", mock_getstub):
1737                 with patch("salt.utils.vmware.Disconnect", mock_disconnect):
1738                     salt.utils.vmware.get_service_instance(
1739                         host="fake_host",
1740                         username="fake_username",
1741                         password="fake_password",
1742                         protocol="fake_protocol",
1743                         port=1,
1744                         mechanism="fake_mechanism",
1745                         principal="fake_principal",
1746                         domain="fake_domain",
1747                     )
1748             self.assertEqual(mock_get_si.call_count, 1)
1749             self.assertEqual(mock_getstub.call_count, 1)
1750             self.assertEqual(mock_disconnect.call_count, 1)
1751     def test_uncached_service_instance(self):
1752         mock_get_si = MagicMock()
1753         with patch("salt.utils.vmware._get_service_instance", mock_get_si):
1754             salt.utils.vmware.get_service_instance(
1755                 host="fake_host",
1756                 username="fake_username",
1757                 password="fake_password",
1758                 protocol="fake_protocol",
1759                 port=1,
1760                 mechanism="fake_mechanism",
1761                 principal="fake_principal",
1762                 domain="fake_domain",
1763                 verify_ssl=True,
1764             )
1765             mock_get_si.assert_called_once_with(
1766                 "fake_host",
1767                 "fake_username",
1768                 "fake_password",
1769                 "fake_protocol",
1770                 1,
1771                 "fake_mechanism",
1772                 "fake_principal",
1773                 "fake_domain",
1774                 verify_ssl=True,
1775             )
1776     def test_unauthenticated_service_instance(self):
1777         mock_si_current_time = MagicMock(side_effect=vim.fault.NotAuthenticated)
1778         mock_si = MagicMock()
1779         mock_get_si = MagicMock(return_value=mock_si)
1780         mock_si.CurrentTime = mock_si_current_time
1781         mock_disconnect = MagicMock()
1782         with patch("salt.utils.vmware._get_service_instance", mock_get_si):
1783             with patch("salt.utils.vmware.Disconnect", mock_disconnect):
1784                 salt.utils.vmware.get_service_instance(
1785                     host="fake_host",
1786                     username="fake_username",
1787                     password="fake_password",
1788                     protocol="fake_protocol",
1789                     port=1,
1790                     mechanism="fake_mechanism",
1791                     principal="fake_principal",
1792                     domain="fake_domain",
1793                 )
1794                 self.assertEqual(mock_si_current_time.call_count, 1)
1795                 self.assertEqual(mock_disconnect.call_count, 1)
1796                 self.assertEqual(mock_get_si.call_count, 2)
1797     def test_cached_unauthenticated_service_instance(self):
1798         mock_si_current_time = MagicMock(side_effect=vim.fault.NotAuthenticated)
1799         mock_si = MagicMock()
1800         mock_get_si = MagicMock(return_value=mock_si)
1801         mock_getsi = MagicMock(return_value=mock_si)
1802         mock_si.CurrentTime = mock_si_current_time
1803         mock_disconnect = MagicMock()
1804         with patch("salt.utils.vmware.GetSi", mock_getsi):
1805             with patch("salt.utils.vmware._get_service_instance", mock_get_si):
1806                 with patch("salt.utils.vmware.Disconnect", mock_disconnect):
1807                     salt.utils.vmware.get_service_instance(
1808                         host="fake_host",
1809                         username="fake_username",
1810                         password="fake_password",
1811                         protocol="fake_protocol",
1812                         port=1,
1813                         mechanism="fake_mechanism",
1814                         principal="fake_principal",
1815                         domain="fake_domain",
1816                     )
1817                     self.assertEqual(mock_si_current_time.call_count, 1)
1818                     self.assertEqual(mock_disconnect.call_count, 1)
1819                     self.assertEqual(mock_get_si.call_count, 1)
1820     def test_current_time_raise_no_permission(self):
1821         exc = vim.fault.NoPermission()
1822         exc.privilegeId = "Fake privilege"
1823         with patch(
1824             "salt.utils.vmware._get_service_instance",
1825             MagicMock(return_value=MagicMock(CurrentTime=MagicMock(side_effect=exc))),
1826         ):
1827             with self.assertRaises(VMwareApiError) as excinfo:
1828                 salt.utils.vmware.get_service_instance(
1829                     host="fake_host",
1830                     username="fake_username",
1831                     password="fake_password",
1832                     protocol="fake_protocol",
1833                     port=1,
1834                     mechanism="fake_mechanism",
1835                     principal="fake_principal",
1836                     domain="fake_domain",
1837                 )
1838         self.assertEqual(
1839             excinfo.exception.strerror,
1840             "Not enough permissions. Required privilege: Fake privilege",
1841         )
1842     def test_current_time_raise_vim_fault(self):
1843         exc = vim.fault.VimFault()
1844         exc.msg = "VimFault msg"
1845         with patch(
1846             "salt.utils.vmware._get_service_instance",
1847             MagicMock(return_value=MagicMock(CurrentTime=MagicMock(side_effect=exc))),
1848         ):
1849             with self.assertRaises(VMwareApiError) as excinfo:
1850                 salt.utils.vmware.get_service_instance(
1851                     host="fake_host",
1852                     username="fake_username",
1853                     password="fake_password",
1854                     protocol="fake_protocol",
1855                     port=1,
1856                     mechanism="fake_mechanism",
1857                     principal="fake_principal",
1858                     domain="fake_domain",
1859                 )
1860         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1861     def test_current_time_raise_runtime_fault(self):
1862         exc = vmodl.RuntimeFault()
1863         exc.msg = "RuntimeFault msg"
1864         with patch(
1865             "salt.utils.vmware._get_service_instance",
1866             MagicMock(return_value=MagicMock(CurrentTime=MagicMock(side_effect=exc))),
1867         ):
1868             with self.assertRaises(VMwareRuntimeError) as excinfo:
1869                 salt.utils.vmware.get_service_instance(
1870                     host="fake_host",
1871                     username="fake_username",
1872                     password="fake_password",
1873                     protocol="fake_protocol",
1874                     port=1,
1875                     mechanism="fake_mechanism",
1876                     principal="fake_principal",
1877                     domain="fake_domain",
1878                 )
1879         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1880 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1881 class DisconnectTestCase(TestCase):
1882     def setUp(self):
1883         self.mock_si = MagicMock()
1884         self.addCleanup(delattr, self, "mock_si")
1885     def test_disconnect(self):
1886         mock_disconnect = MagicMock()
1887         with patch("salt.utils.vmware.Disconnect", mock_disconnect):
1888             salt.utils.vmware.disconnect(service_instance=self.mock_si)
1889             mock_disconnect.assert_called_once_with(self.mock_si)
1890     def test_disconnect_raise_no_permission(self):
1891         exc = vim.fault.NoPermission()
1892         exc.privilegeId = "Fake privilege"
1893         with patch("salt.utils.vmware.Disconnect", MagicMock(side_effect=exc)):
1894             with self.assertRaises(VMwareApiError) as excinfo:
1895                 salt.utils.vmware.disconnect(service_instance=self.mock_si)
1896         self.assertEqual(
1897             excinfo.exception.strerror,
1898             "Not enough permissions. Required privilege: Fake privilege",
1899         )
1900     def test_disconnect_raise_vim_fault(self):
1901         exc = vim.fault.VimFault()
1902         exc.msg = "VimFault msg"
1903         with patch("salt.utils.vmware.Disconnect", MagicMock(side_effect=exc)):
1904             with self.assertRaises(VMwareApiError) as excinfo:
1905                 salt.utils.vmware.disconnect(service_instance=self.mock_si)
1906         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1907     def test_disconnect_raise_runtime_fault(self):
1908         exc = vmodl.RuntimeFault()
1909         exc.msg = "RuntimeFault msg"
1910         with patch("salt.utils.vmware.Disconnect", MagicMock(side_effect=exc)):
1911             with self.assertRaises(VMwareRuntimeError) as excinfo:
1912                 salt.utils.vmware.disconnect(service_instance=self.mock_si)
1913         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1914 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1915 class IsConnectionToAVCenterTestCase(TestCase):
1916     def test_api_type_raise_no_permission(self):
1917         exc = vim.fault.NoPermission()
1918         exc.privilegeId = "Fake privilege"
1919         mock_si = MagicMock()
1920         type(mock_si.content.about).apiType = PropertyMock(side_effect=exc)
1921         with self.assertRaises(VMwareApiError) as excinfo:
1922             salt.utils.vmware.is_connection_to_a_vcenter(mock_si)
1923         self.assertEqual(
1924             excinfo.exception.strerror,
1925             "Not enough permissions. Required privilege: Fake privilege",
1926         )
1927     def test_api_type_raise_vim_fault(self):
1928         exc = vim.fault.VimFault()
1929         exc.msg = "VimFault msg"
1930         mock_si = MagicMock()
1931         type(mock_si.content.about).apiType = PropertyMock(side_effect=exc)
1932         with self.assertRaises(VMwareApiError) as excinfo:
1933             salt.utils.vmware.is_connection_to_a_vcenter(mock_si)
1934         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
1935     def test_api_type_raise_runtime_fault(self):
1936         exc = vmodl.RuntimeFault()
1937         exc.msg = "RuntimeFault msg"
1938         mock_si = MagicMock()
1939         type(mock_si.content.about).apiType = PropertyMock(side_effect=exc)
1940         with self.assertRaises(VMwareRuntimeError) as excinfo:
1941             salt.utils.vmware.is_connection_to_a_vcenter(mock_si)
1942         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
1943     def test_connected_to_a_vcenter(self):
1944         mock_si = MagicMock()
1945         mock_si.content.about.apiType = "VirtualCenter"
1946         ret = salt.utils.vmware.is_connection_to_a_vcenter(mock_si)
1947         self.assertTrue(ret)
1948     def test_connected_to_a_host(self):
1949         mock_si = MagicMock()
1950         mock_si.content.about.apiType = "HostAgent"
1951         ret = salt.utils.vmware.is_connection_to_a_vcenter(mock_si)
1952         self.assertFalse(ret)
1953     def test_connected_to_invalid_entity(self):
1954         mock_si = MagicMock()
1955         mock_si.content.about.apiType = "UnsupportedType"
1956         with self.assertRaises(VMwareApiError) as excinfo:
1957             salt.utils.vmware.is_connection_to_a_vcenter(mock_si)
1958         self.assertIn(
1959             "Unexpected api type 'UnsupportedType'", excinfo.exception.strerror
1960         )
1961 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1962 class GetNewServiceInstanceStub(TestCase, LoaderModuleMockMixin):
1963     def setup_loader_modules(self):
1964         return {salt.utils.vmware: {"sys": MagicMock(), "ssl": MagicMock()}}
1965     def setUp(self):
1966         self.mock_stub = MagicMock(host="fake_host:1000", cookie='ignore"fake_cookie')
1967         self.mock_si = MagicMock(_stub=self.mock_stub)
1968         self.mock_ret = MagicMock()
1969         self.mock_new_stub = MagicMock()
1970         self.context_dict = {}
1971         patches = (
1972             (
1973                 "salt.utils.vmware.VmomiSupport.GetRequestContext",
1974                 MagicMock(return_value=self.context_dict),
1975             ),
1976             (
1977                 "salt.utils.vmware.SoapStubAdapter",
1978                 MagicMock(return_value=self.mock_new_stub),
1979             ),
1980         )
1981         for mod, mock in patches:
1982             patcher = patch(mod, mock)
1983             patcher.start()
1984             self.addCleanup(patcher.stop)
1985         self.mock_context = MagicMock()
1986         self.mock_create_default_context = MagicMock(return_value=self.mock_context)
1987         salt.utils.vmware.ssl.create_default_context = self.mock_create_default_context
1988     def tearDown(self):
1989         for attr in (
1990             "mock_stub",
1991             "mock_si",
1992             "mock_ret",
1993             "mock_new_stub",
1994             "context_dict",
1995             "mock_context",
1996             "mock_create_default_context",
1997         ):
1998             delattr(self, attr)
1999     def test_ssl_default_context_loaded(self):
2000         salt.utils.vmware.get_new_service_instance_stub(self.mock_si, "fake_path")
2001         self.mock_create_default_context.assert_called_once_with()
2002         self.assertFalse(self.mock_context.check_hostname)
2003         self.assertEqual(self.mock_context.verify_mode, salt.utils.vmware.ssl.CERT_NONE)
2004     def test_session_cookie_in_context(self):
2005         salt.utils.vmware.get_new_service_instance_stub(self.mock_si, "fake_path")
2006         self.assertEqual(self.context_dict["vcSessionCookie"], "fake_cookie")
2007     def test_get_new_stub(self):
2008         mock_get_new_stub = MagicMock()
2009         with patch("salt.utils.vmware.SoapStubAdapter", mock_get_new_stub):
2010             salt.utils.vmware.get_new_service_instance_stub(
2011                 self.mock_si, "fake_path", "fake_ns", "fake_version"
2012             )
2013         mock_get_new_stub.assert_called_once_with(
2014             host="fake_host",
2015             ns="fake_ns",
2016             path="fake_path",
2017             version="fake_version",
2018             poolSize=0,
2019             sslContext=self.mock_context,
2020         )
2021     def test_new_stub_returned(self):
2022         ret = salt.utils.vmware.get_new_service_instance_stub(self.mock_si, "fake_path")
2023         self.assertEqual(self.mock_new_stub.cookie, 'ignore"fake_cookie')
2024         self.assertEqual(ret, self.mock_new_stub)
2025 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2026 class GetServiceInstanceFromManagedObjectTestCase(TestCase):
2027     def setUp(self):
2028         patches = (("salt.utils.vmware.vim.ServiceInstance", MagicMock()),)
2029         for mod, mock in patches:
2030             patcher = patch(mod, mock)
2031             patcher.start()
2032             self.addCleanup(patcher.stop)
2033         self.mock_si = MagicMock()
2034         self.mock_stub = PropertyMock()
2035         self.mock_mo_ref = MagicMock(_stub=self.mock_stub)
2036         for attr in ("mock_si", "mock_stub", "mock_mo_ref"):
2037             self.addCleanup(delattr, self, attr)
2038     def test_default_name_parameter(self):
2039         mock_trace = MagicMock()
2040         type(salt.utils.vmware.log).trace = mock_trace
2041         salt.utils.vmware.get_service_instance_from_managed_object(self.mock_mo_ref)
2042         mock_trace.assert_called_once_with(
2043             "[%s] Retrieving service instance from managed object", "&lt;unnamed&gt;"
2044         )
2045     def test_name_parameter_passed_in(self):
2046         mock_trace = MagicMock()
2047         type(salt.utils.vmware.log).trace = mock_trace
2048         salt.utils.vmware.get_service_instance_from_managed_object(
2049             self.mock_mo_ref, "fake_mo_name"
2050         )
2051         mock_trace.assert_called_once_with(
2052             "[%s] Retrieving service instance from managed object", "fake_mo_name"
2053         )
2054     def test_service_instance_instantiation(self):
2055         mock_service_instance_ini = MagicMock()
2056         with patch("salt.utils.vmware.vim.ServiceInstance", mock_service_instance_ini):
2057             salt.utils.vmware.get_service_instance_from_managed_object(self.mock_mo_ref)
2058         mock_service_instance_ini.assert_called_once_with("ServiceInstance")
2059     def test_si_return_and_stub_assignment(self):
2060         with patch(
2061             "salt.utils.vmware.vim.ServiceInstance",
2062             MagicMock(return_value=self.mock_si),
2063         ):
2064             ret = salt.utils.vmware.get_service_instance_from_managed_object(
2065                 self.mock_mo_ref
2066             )
2067         self.assertEqual(ret, self.mock_si)
2068         self.assertEqual(ret._stub, self.mock_stub)
2069 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2070 class GetDatacentersTestCase(TestCase):
2071     def setUp(self):
2072         patches = (
2073             (
2074                 "salt.utils.vmware.get_mors_with_properties",
2075                 MagicMock(return_value=[{"name": "fake_dc", "object": MagicMock()}]),
2076             ),
2077         )
2078         for mod, mock in patches:
2079             patcher = patch(mod, mock)
2080             patcher.start()
2081             self.addCleanup(patcher.stop)
2082         self.mock_si = MagicMock()
2083         self.mock_dc1 = MagicMock()
2084         self.mock_dc2 = MagicMock()
2085         self.mock_entries = [
2086             {"name": "fake_dc1", "object": self.mock_dc1},
2087             {"name": "fake_dc2", "object": self.mock_dc2},
2088         ]
2089     def test_get_mors_with_properties_call(self):
2090         mock_get_mors_with_properties = MagicMock(
2091             return_value=[{"name": "fake_dc", "object": MagicMock()}]
2092         )
2093         with patch(
2094             "salt.utils.vmware.get_mors_with_properties", mock_get_mors_with_properties
2095         ):
2096             salt.utils.vmware.get_datacenters(
2097                 self.mock_si, datacenter_names=["fake_dc1"]
2098             )
2099         mock_get_mors_with_properties.assert_called_once_with(
2100             self.mock_si, vim.Datacenter, property_list=["name"]
2101         )
2102     def test_get_mors_with_properties_returns_empty_array(self):
2103         with patch(
2104             "salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])
2105         ):
2106             res = salt.utils.vmware.get_datacenters(
2107                 self.mock_si, datacenter_names=["fake_dc1"]
2108             )
2109         self.assertEqual(res, [])
2110     def test_no_parameters(self):
2111         with patch(
2112             "salt.utils.vmware.get_mors_with_properties",
2113             MagicMock(return_value=self.mock_entries),
2114         ):
2115             res = salt.utils.vmware.get_datacenters(self.mock_si)
2116         self.assertEqual(res, [])
2117     def test_datastore_not_found(self):
2118         with patch(
2119             "salt.utils.vmware.get_mors_with_properties",
2120             MagicMock(return_value=self.mock_entries),
2121         ):
2122             res = salt.utils.vmware.get_datacenters(
2123                 self.mock_si, datacenter_names=["fake_dc"]
2124             )
2125         self.assertEqual(res, [])
2126     def test_datastore_found(self):
2127         with patch(
2128             "salt.utils.vmware.get_mors_with_properties",
2129             MagicMock(return_value=self.mock_entries),
2130         ):
2131             res = salt.utils.vmware.get_datacenters(
2132                 self.mock_si, datacenter_names=["fake_dc2"]
2133             )
2134         self.assertEqual(res, [self.mock_dc2])
2135     def test_get_all_datastores(self):
2136         with patch(
2137             "salt.utils.vmware.get_mors_with_properties",
2138             MagicMock(return_value=self.mock_entries),
2139         ):
2140             res = salt.utils.vmware.get_datacenters(
2141                 self.mock_si, get_all_datacenters=True
2142             )
2143         self.assertEqual(res, [self.mock_dc1, self.mock_dc2])
2144 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2145 class GetDatacenterTestCase(TestCase):
2146     def setUp(self):
2147         patches = (
2148             (
2149                 "salt.utils.vmware.get_datacenters",
2150                 MagicMock(return_value=[MagicMock()]),
2151             ),
2152         )
2153         for mod, mock in patches:
2154             patcher = patch(mod, mock)
2155             patcher.start()
2156             self.addCleanup(patcher.stop)
2157         self.mock_si = MagicMock()
2158         self.mock_dc = MagicMock()
2159     def test_get_datacenters_call(self):
2160         mock_get_datacenters = MagicMock(return_value=[MagicMock()])
2161         with patch("salt.utils.vmware.get_datacenters", mock_get_datacenters):
2162             salt.utils.vmware.get_datacenter(self.mock_si, "fake_dc1")
2163         mock_get_datacenters.assert_called_once_with(
2164             self.mock_si, datacenter_names=["fake_dc1"]
2165         )
2166     def test_no_datacenters_returned(self):
2167         with patch("salt.utils.vmware.get_datacenters", MagicMock(return_value=[])):
2168             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
2169                 salt.utils.vmware.get_datacenter(self.mock_si, "fake_dc1")
2170         self.assertEqual(
2171             "Datacenter 'fake_dc1' was not found", excinfo.exception.strerror
2172         )
2173     def test_get_datacenter_return(self):
2174         with patch(
2175             "salt.utils.vmware.get_datacenters", MagicMock(return_value=[self.mock_dc])
2176         ):
2177             res = salt.utils.vmware.get_datacenter(self.mock_si, "fake_dc1")
2178         self.assertEqual(res, self.mock_dc)
2179 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2180 class CreateDatacenterTestCase(TestCase):
2181     def setUp(self):
2182         patches = (("salt.utils.vmware.get_root_folder", MagicMock()),)
2183         for mod, mock in patches:
2184             patcher = patch(mod, mock)
2185             patcher.start()
2186             self.addCleanup(patcher.stop)
2187         self.mock_si = MagicMock()
2188         self.mock_dc = MagicMock()
2189         self.mock_create_datacenter = MagicMock(return_value=self.mock_dc)
2190         self.mock_root_folder = MagicMock(CreateDatacenter=self.mock_create_datacenter)
2191     def test_get_root_folder(self):
2192         mock_get_root_folder = MagicMock()
2193         with patch("salt.utils.vmware.get_root_folder", mock_get_root_folder):
2194             salt.utils.vmware.create_datacenter(self.mock_si, "fake_dc")
2195         mock_get_root_folder.assert_called_once_with(self.mock_si)
2196     def test_create_datacenter_call(self):
2197         with patch(
2198             "salt.utils.vmware.get_root_folder",
2199             MagicMock(return_value=self.mock_root_folder),
2200         ):
2201             salt.utils.vmware.create_datacenter(self.mock_si, "fake_dc")
2202         self.mock_create_datacenter.assert_called_once_with("fake_dc")
2203     def test_create_datacenter_raise_no_permission(self):
2204         exc = vim.fault.NoPermission()
2205         exc.privilegeId = "Fake privilege"
2206         self.mock_root_folder = MagicMock(CreateDatacenter=MagicMock(side_effect=exc))
2207         with patch(
2208             "salt.utils.vmware.get_root_folder",
2209             MagicMock(return_value=self.mock_root_folder),
2210         ):
2211             with self.assertRaises(VMwareApiError) as excinfo:
2212                 salt.utils.vmware.create_datacenter(self.mock_si, "fake_dc")
2213         self.assertEqual(
2214             excinfo.exception.strerror,
2215             "Not enough permissions. Required privilege: Fake privilege",
2216         )
2217     def test_create_datacenter_raise_vim_fault(self):
2218         exc = vim.VimFault()
2219         exc.msg = "VimFault msg"
2220         self.mock_root_folder = MagicMock(CreateDatacenter=MagicMock(side_effect=exc))
2221         with patch(
2222             "salt.utils.vmware.get_root_folder",
2223             MagicMock(return_value=self.mock_root_folder),
2224         ):
2225             with self.assertRaises(VMwareApiError) as excinfo:
2226                 salt.utils.vmware.create_datacenter(self.mock_si, "fake_dc")
2227         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
2228     def test_create_datacenter_runtime_fault(self):
2229         exc = vmodl.RuntimeFault()
2230         exc.msg = "RuntimeFault msg"
2231         self.mock_root_folder = MagicMock(CreateDatacenter=MagicMock(side_effect=exc))
2232         with patch(
2233             "salt.utils.vmware.get_root_folder",
2234             MagicMock(return_value=self.mock_root_folder),
2235         ):
2236             with self.assertRaises(VMwareRuntimeError) as excinfo:
2237                 salt.utils.vmware.create_datacenter(self.mock_si, "fake_dc")
2238         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
2239     def test_datastore_successfully_created(self):
2240         with patch(
2241             "salt.utils.vmware.get_root_folder",
2242             MagicMock(return_value=self.mock_root_folder),
2243         ):
2244             res = salt.utils.vmware.create_datacenter(self.mock_si, "fake_dc")
2245         self.assertEqual(res, self.mock_dc)
2246 class FakeTaskClass:
2247     pass
2248 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2249 class GetDvssTestCase(TestCase):
2250     def setUp(self):
2251         self.mock_si = MagicMock()
2252         self.mock_dc_ref = MagicMock()
2253         self.mock_traversal_spec = MagicMock()
2254         self.mock_items = [
2255             {"object": MagicMock(), "name": "fake_dvs1"},
2256             {"object": MagicMock(), "name": "fake_dvs2"},
2257             {"object": MagicMock(), "name": "fake_dvs3"},
2258         ]
2259         self.mock_get_mors = MagicMock(return_value=self.mock_items)
2260         patches = (
2261             ("salt.utils.vmware.get_managed_object_name", MagicMock()),
2262             ("salt.utils.vmware.get_mors_with_properties", self.mock_get_mors),
2263             (
2264                 "salt.utils.vmware.get_service_instance_from_managed_object",
2265                 MagicMock(return_value=self.mock_si),
2266             ),
2267             (
2268                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2269                 MagicMock(return_value=self.mock_traversal_spec),
2270             ),
2271         )
2272         for mod, mock in patches:
2273             patcher = patch(mod, mock)
2274             patcher.start()
2275             self.addCleanup(patcher.stop)
2276     def tearDown(self):
2277         for attr in (
2278             "mock_si",
2279             "mock_dc_ref",
2280             "mock_traversal_spec",
2281             "mock_items",
2282             "mock_get_mors",
2283         ):
2284             delattr(self, attr)
2285     def test_get_managed_object_name_call(self):
2286         mock_get_managed_object_name = MagicMock()
2287         with patch(
2288             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2289         ):
2290             salt.utils.vmware.get_dvss(self.mock_dc_ref)
2291         mock_get_managed_object_name.assert_called_once_with(self.mock_dc_ref)
2292     def test_traversal_spec(self):
2293         mock_traversal_spec = MagicMock(return_value="traversal_spec")
2294         with patch(
2295             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2296             mock_traversal_spec,
2297         ):
2298             salt.utils.vmware.get_dvss(self.mock_dc_ref)
2299         mock_traversal_spec.assert_has_calls(
2300             [
2301                 call(path="childEntity", skip=False, type=vim.Folder),
2302                 call(
2303                     path="networkFolder",
2304                     skip=True,
2305                     type=vim.Datacenter,
2306                     selectSet=["traversal_spec"],
2307                 ),
2308             ]
2309         )
2310     def test_get_mors_with_properties(self):
2311         salt.utils.vmware.get_dvss(self.mock_dc_ref)
2312         self.mock_get_mors.assert_called_once_with(
2313             self.mock_si,
2314             vim.DistributedVirtualSwitch,
2315             container_ref=self.mock_dc_ref,
2316             property_list=["name"],
2317             traversal_spec=self.mock_traversal_spec,
2318         )
2319     def test_get_no_dvss(self):
2320         ret = salt.utils.vmware.get_dvss(self.mock_dc_ref)
2321         self.assertEqual(ret, [])
2322     def test_get_all_dvss(self):
2323         ret = salt.utils.vmware.get_dvss(self.mock_dc_ref, get_all_dvss=True)
2324         self.assertEqual(ret, [i["object"] for i in self.mock_items])
2325     def test_filtered_all_dvss(self):
2326         ret = salt.utils.vmware.get_dvss(
2327             self.mock_dc_ref, dvs_names=["fake_dvs1", "fake_dvs3", "no_dvs"]
2328         )
2329         self.assertEqual(
2330             ret, [self.mock_items[0]["object"], self.mock_items[2]["object"]]
2331         )
2332 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2333 class GetNetworkFolderTestCase(TestCase):
2334     def setUp(self):
2335         self.mock_si = MagicMock()
2336         self.mock_dc_ref = MagicMock()
2337         self.mock_traversal_spec = MagicMock()
2338 <a name="0"></a>        self.mock_entries = [{"object": MagicMock(), "name": "fake_netw_folder"}]
2339         self.mock_get_mors = MagicMock(return_value=self.mock_entries)
2340         patches <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= (
2341             (
2342                 "salt.utils.vmware.get_managed_object_name",
2343                 MagicMock(return_value="fake_dc"),
2344             ),
2345             (
2346                 "salt.utils.vmware.get_service_instance_from_managed_object",
2347                 MagicMock(return_value=self.mock_si),
2348             ),
2349             (
2350                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2351                 MagicMock(return_value=self.</b></font>mock_traversal_spec),
2352             ),
2353             ("salt.utils.vmware.get_mors_with_properties", self.mock_get_mors),
2354         )
2355         for mod, mock in patches:
2356             patcher = patch(mod, mock)
2357             patcher.start()
2358             self.addCleanup(patcher.stop)
2359     def tearDown(self):
2360         for attr in (
2361             "mock_si",
2362             "mock_dc_ref",
2363             "mock_traversal_spec",
2364             "mock_entries",
2365             "mock_get_mors",
2366         ):
2367             delattr(self, attr)
2368     def test_get_managed_object_name_call(self):
2369         mock_get_managed_object_name = MagicMock()
2370         with patch(
2371             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2372         ):
2373             salt.utils.vmware.get_network_folder(self.mock_dc_ref)
2374         mock_get_managed_object_name.assert_called_once_with(self.mock_dc_ref)
2375     def test_traversal_spec(self):
2376         mock_traversal_spec = MagicMock(return_value="traversal_spec")
2377         with patch(
2378             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2379             mock_traversal_spec,
2380         ):
2381             salt.utils.vmware.get_network_folder(self.mock_dc_ref)
2382         mock_traversal_spec.assert_called_once_with(
2383             path="networkFolder", skip=False, type=vim.Datacenter
2384         )
2385     def test_get_mors_with_properties(self):
2386         salt.utils.vmware.get_network_folder(self.mock_dc_ref)
2387         self.mock_get_mors.assert_called_once_with(
2388             self.mock_si,
2389             vim.Folder,
2390             container_ref=self.mock_dc_ref,
2391             property_list=["name"],
2392             traversal_spec=self.mock_traversal_spec,
2393         )
2394     def test_get_no_network_folder(self):
2395         with patch(
2396             "salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])
2397         ):
2398             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
2399                 salt.utils.vmware.get_network_folder(self.mock_dc_ref)
2400         self.assertEqual(
2401             excinfo.exception.strerror,
2402             "Network folder in datacenter 'fake_dc' wasn't retrieved",
2403         )
2404     def test_get_network_folder(self):
2405         ret = salt.utils.vmware.get_network_folder(self.mock_dc_ref)
2406         self.assertEqual(ret, self.mock_entries[0]["object"])
2407 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2408 class CreateDvsTestCase(TestCase):
2409     def setUp(self):
2410         self.mock_dc_ref = MagicMock()
2411         self.mock_dvs_create_spec = MagicMock()
2412         self.mock_task = MagicMock(spec=FakeTaskClass)
2413         self.mock_netw_folder = MagicMock(
2414             CreateDVS_Task=MagicMock(return_value=self.mock_task)
2415         )
2416         self.mock_wait_for_task = MagicMock()
2417         patches = (
2418             (
2419                 "salt.utils.vmware.get_managed_object_name",
2420                 MagicMock(return_value="fake_dc"),
2421             ),
2422             (
2423                 "salt.utils.vmware.get_network_folder",
2424                 MagicMock(return_value=self.mock_netw_folder),
2425             ),
2426             ("salt.utils.vmware.wait_for_task", self.mock_wait_for_task),
2427         )
2428         for mod, mock in patches:
2429             patcher = patch(mod, mock)
2430             patcher.start()
2431             self.addCleanup(patcher.stop)
2432     def tearDown(self):
2433         for attr in (
2434             "mock_dc_ref",
2435             "mock_dvs_create_spec",
2436             "mock_task",
2437             "mock_netw_folder",
2438             "mock_wait_for_task",
2439         ):
2440             delattr(self, attr)
2441     def test_get_managed_object_name_call(self):
2442         mock_get_managed_object_name = MagicMock()
2443         with patch(
2444             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2445         ):
2446             salt.utils.vmware.create_dvs(self.mock_dc_ref, "fake_dvs")
2447         mock_get_managed_object_name.assert_called_once_with(self.mock_dc_ref)
2448     def test_no_dvs_create_spec(self):
2449         mock_spec = MagicMock(configSpec=None)
2450         mock_config_spec = MagicMock()
2451         mock_dvs_create_spec = MagicMock(return_value=mock_spec)
2452         mock_vmware_dvs_config_spec = MagicMock(return_value=mock_config_spec)
2453         with patch("salt.utils.vmware.vim.DVSCreateSpec", mock_dvs_create_spec):
2454             with patch(
2455                 "salt.utils.vmware.vim.VMwareDVSConfigSpec", mock_vmware_dvs_config_spec
2456             ):
2457                 salt.utils.vmware.create_dvs(self.mock_dc_ref, "fake_dvs")
2458         mock_dvs_create_spec.assert_called_once_with()
2459         mock_vmware_dvs_config_spec.assert_called_once_with()
2460         self.assertEqual(mock_spec.configSpec, mock_config_spec)
2461         self.assertEqual(mock_config_spec.name, "fake_dvs")
2462         self.mock_netw_folder.CreateDVS_Task.assert_called_once_with(mock_spec)
2463     def test_get_network_folder(self):
2464         mock_get_network_folder = MagicMock()
2465         with patch("salt.utils.vmware.get_network_folder", mock_get_network_folder):
2466             salt.utils.vmware.create_dvs(self.mock_dc_ref, "fake_dvs")
2467         mock_get_network_folder.assert_called_once_with(self.mock_dc_ref)
2468     def test_create_dvs_task_passed_in_spec(self):
2469         salt.utils.vmware.create_dvs(
2470             self.mock_dc_ref, "fake_dvs", dvs_create_spec=self.mock_dvs_create_spec
2471         )
2472         self.mock_netw_folder.CreateDVS_Task.assert_called_once_with(
2473             self.mock_dvs_create_spec
2474         )
2475     def test_create_dvs_task_raises_no_permission(self):
2476         exc = vim.fault.NoPermission()
2477         exc.privilegeId = "Fake privilege"
2478         self.mock_netw_folder.CreateDVS_Task = MagicMock(side_effect=exc)
2479         with self.assertRaises(VMwareApiError) as excinfo:
2480             salt.utils.vmware.create_dvs(
2481                 self.mock_dc_ref, "fake_dvs", dvs_create_spec=self.mock_dvs_create_spec
2482             )
2483         self.assertEqual(
2484             excinfo.exception.strerror,
2485             "Not enough permissions. Required privilege: Fake privilege",
2486         )
2487     def test_create_dvs_task_raises_vim_fault(self):
2488         exc = vim.fault.VimFault()
2489         exc.msg = "VimFault msg"
2490         self.mock_netw_folder.CreateDVS_Task = MagicMock(side_effect=exc)
2491         with self.assertRaises(VMwareApiError) as excinfo:
2492             salt.utils.vmware.create_dvs(
2493                 self.mock_dc_ref, "fake_dvs", dvs_create_spec=self.mock_dvs_create_spec
2494             )
2495         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
2496     def test_create_dvs_task_raises_runtime_fault(self):
2497         exc = vmodl.RuntimeFault()
2498         exc.msg = "RuntimeFault msg"
2499         self.mock_netw_folder.CreateDVS_Task = MagicMock(side_effect=exc)
2500         with self.assertRaises(VMwareRuntimeError) as excinfo:
2501             salt.utils.vmware.create_dvs(
2502                 self.mock_dc_ref, "fake_dvs", dvs_create_spec=self.mock_dvs_create_spec
2503             )
2504         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
2505     def test_wait_for_tasks(self):
2506         salt.utils.vmware.create_dvs(
2507             self.mock_dc_ref, "fake_dvs", dvs_create_spec=self.mock_dvs_create_spec
2508         )
2509         self.mock_wait_for_task.assert_called_once_with(
2510             self.mock_task,
2511             "fake_dvs",
2512             "&lt;class 'tests.unit.utils.test_vmware.FakeTaskClass'&gt;",
2513         )
2514 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2515 class UpdateDvsTestCase(TestCase):
2516     def setUp(self):
2517         self.mock_task = MagicMock(spec=FakeTaskClass)
2518         self.mock_dvs_ref = MagicMock(
2519             ReconfigureDvs_Task=MagicMock(return_value=self.mock_task)
2520         )
2521         self.mock_dvs_spec = MagicMock()
2522         self.mock_wait_for_task = MagicMock()
2523         patches = (
2524             (
2525                 "salt.utils.vmware.get_managed_object_name",
2526                 MagicMock(return_value="fake_dvs"),
2527             ),
2528             ("salt.utils.vmware.wait_for_task", self.mock_wait_for_task),
2529         )
2530         for mod, mock in patches:
2531             patcher = patch(mod, mock)
2532             patcher.start()
2533             self.addCleanup(patcher.stop)
2534     def tearDown(self):
2535         for attr in (
2536             "mock_dvs_ref",
2537             "mock_task",
2538             "mock_dvs_spec",
2539             "mock_wait_for_task",
2540         ):
2541             delattr(self, attr)
2542     def test_get_managed_object_name_call(self):
2543         mock_get_managed_object_name = MagicMock()
2544         with patch(
2545             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2546         ):
2547             salt.utils.vmware.update_dvs(self.mock_dvs_ref, self.mock_dvs_spec)
2548         mock_get_managed_object_name.assert_called_once_with(self.mock_dvs_ref)
2549     def test_reconfigure_dvs_task(self):
2550         salt.utils.vmware.update_dvs(self.mock_dvs_ref, self.mock_dvs_spec)
2551         self.mock_dvs_ref.ReconfigureDvs_Task.assert_called_once_with(
2552             self.mock_dvs_spec
2553         )
2554     def test_reconfigure_dvs_task_raises_no_permission(self):
2555         exc = vim.fault.NoPermission()
2556         exc.privilegeId = "Fake privilege"
2557         self.mock_dvs_ref.ReconfigureDvs_Task = MagicMock(side_effect=exc)
2558         with self.assertRaises(VMwareApiError) as excinfo:
2559             salt.utils.vmware.update_dvs(self.mock_dvs_ref, self.mock_dvs_spec)
2560         self.assertEqual(
2561             excinfo.exception.strerror,
2562             "Not enough permissions. Required privilege: Fake privilege",
2563         )
2564     def test_reconfigure_dvs_task_raises_vim_fault(self):
2565         exc = vim.fault.VimFault()
2566         exc.msg = "VimFault msg"
2567         self.mock_dvs_ref.ReconfigureDvs_Task = MagicMock(side_effect=exc)
2568         with self.assertRaises(VMwareApiError) as excinfo:
2569             salt.utils.vmware.update_dvs(self.mock_dvs_ref, self.mock_dvs_spec)
2570         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
2571     def test_reconfigure_dvs_task_raises_runtime_fault(self):
2572         exc = vmodl.RuntimeFault()
2573         exc.msg = "RuntimeFault msg"
2574         self.mock_dvs_ref.ReconfigureDvs_Task = MagicMock(side_effect=exc)
2575         with self.assertRaises(VMwareRuntimeError) as excinfo:
2576             salt.utils.vmware.update_dvs(self.mock_dvs_ref, self.mock_dvs_spec)
2577         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
2578     def test_wait_for_tasks(self):
2579         salt.utils.vmware.update_dvs(self.mock_dvs_ref, self.mock_dvs_spec)
2580         self.mock_wait_for_task.assert_called_once_with(
2581             self.mock_task,
2582             "fake_dvs",
2583             "&lt;class 'tests.unit.utils.test_vmware.FakeTaskClass'&gt;",
2584         )
2585 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2586 class SetDvsNetworkResourceManagementEnabledTestCase(TestCase):
2587     def setUp(self):
2588         self.mock_enabled = MagicMock()
2589         self.mock_dvs_ref = MagicMock(EnableNetworkResourceManagement=MagicMock())
2590         patches = (
2591             (
2592                 "salt.utils.vmware.get_managed_object_name",
2593                 MagicMock(return_value="fake_dvs"),
2594             ),
2595         )
2596         for mod, mock in patches:
2597             patcher = patch(mod, mock)
2598             patcher.start()
2599             self.addCleanup(patcher.stop)
2600     def tearDown(self):
2601         for attr in ("mock_dvs_ref", "mock_enabled"):
2602             delattr(self, attr)
2603     def test_get_managed_object_name_call(self):
2604         mock_get_managed_object_name = MagicMock()
2605         with patch(
2606             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2607         ):
2608             salt.utils.vmware.set_dvs_network_resource_management_enabled(
2609                 self.mock_dvs_ref, self.mock_enabled
2610             )
2611         mock_get_managed_object_name.assert_called_once_with(self.mock_dvs_ref)
2612     def test_enable_network_resource_management(self):
2613         salt.utils.vmware.set_dvs_network_resource_management_enabled(
2614             self.mock_dvs_ref, self.mock_enabled
2615         )
2616         self.mock_dvs_ref.EnableNetworkResourceManagement.assert_called_once_with(
2617             enable=self.mock_enabled
2618         )
2619     def test_enable_network_resource_management_raises_no_permission(self):
2620         exc = vim.fault.NoPermission()
2621         exc.privilegeId = "Fake privilege"
2622         self.mock_dvs_ref.EnableNetworkResourceManagement = MagicMock(side_effect=exc)
2623         with self.assertRaises(VMwareApiError) as excinfo:
2624             salt.utils.vmware.set_dvs_network_resource_management_enabled(
2625                 self.mock_dvs_ref, self.mock_enabled
2626             )
2627         self.assertEqual(
2628             excinfo.exception.strerror,
2629             "Not enough permissions. Required privilege: Fake privilege",
2630         )
2631     def test_enable_network_resource_management_raises_vim_fault(self):
2632         exc = vim.fault.VimFault()
2633         exc.msg = "VimFault msg"
2634         self.mock_dvs_ref.EnableNetworkResourceManagement = MagicMock(side_effect=exc)
2635         with self.assertRaises(VMwareApiError) as excinfo:
2636             salt.utils.vmware.set_dvs_network_resource_management_enabled(
2637                 self.mock_dvs_ref, self.mock_enabled
2638             )
2639     def test_enable_network_resource_management_raises_runtime_fault(self):
2640         exc = vmodl.RuntimeFault()
2641         exc.msg = "RuntimeFault msg"
2642         self.mock_dvs_ref.EnableNetworkResourceManagement = MagicMock(side_effect=exc)
2643         with self.assertRaises(VMwareRuntimeError) as excinfo:
2644             salt.utils.vmware.set_dvs_network_resource_management_enabled(
2645                 self.mock_dvs_ref, self.mock_enabled
2646             )
2647         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
2648 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2649 class GetDvportgroupsTestCase(TestCase):
2650     def setUp(self):
2651         self.mock_si = MagicMock()
2652         self.mock_dc_ref = MagicMock(spec=vim.Datacenter)
2653         self.mock_dvs_ref = MagicMock(spec=vim.DistributedVirtualSwitch)
2654         self.mock_traversal_spec = MagicMock()
2655         self.mock_items = [
2656             {"object": MagicMock(), "name": "fake_pg1"},
2657             {"object": MagicMock(), "name": "fake_pg2"},
2658             {"object": MagicMock(), "name": "fake_pg3"},
2659         ]
2660         self.mock_get_mors = MagicMock(return_value=self.mock_items)
2661         patches = (
2662             ("salt.utils.vmware.get_managed_object_name", MagicMock()),
2663             ("salt.utils.vmware.get_mors_with_properties", self.mock_get_mors),
2664             (
2665                 "salt.utils.vmware.get_service_instance_from_managed_object",
2666                 MagicMock(return_value=self.mock_si),
2667             ),
2668             (
2669                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2670                 MagicMock(return_value=self.mock_traversal_spec),
2671             ),
2672         )
2673         for mod, mock in patches:
2674             patcher = patch(mod, mock)
2675             patcher.start()
2676             self.addCleanup(patcher.stop)
2677     def tearDown(self):
2678         for attr in (
2679             "mock_si",
2680             "mock_dc_ref",
2681             "mock_dvs_ref",
2682             "mock_traversal_spec",
2683             "mock_items",
2684             "mock_get_mors",
2685         ):
2686             delattr(self, attr)
2687     def test_unsupported_parrent(self):
2688         with self.assertRaises(ArgumentValueError) as excinfo:
2689             salt.utils.vmware.get_dvportgroups(MagicMock())
2690         self.assertEqual(
2691             excinfo.exception.strerror,
2692             "Parent has to be either a datacenter, or a distributed virtual switch",
2693         )
2694     def test_get_managed_object_name_call(self):
2695         mock_get_managed_object_name = MagicMock()
2696         with patch(
2697             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2698         ):
2699             salt.utils.vmware.get_dvportgroups(self.mock_dc_ref)
2700         mock_get_managed_object_name.assert_called_once_with(self.mock_dc_ref)
2701     def test_traversal_spec_datacenter_parent(self):
2702         mock_traversal_spec = MagicMock(return_value="traversal_spec")
2703         with patch(
2704             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2705             mock_traversal_spec,
2706         ):
2707             salt.utils.vmware.get_dvportgroups(self.mock_dc_ref)
2708         mock_traversal_spec.assert_has_calls(
2709             [
2710                 call(path="childEntity", skip=False, type=vim.Folder),
2711                 call(
2712                     path="networkFolder",
2713                     skip=True,
2714                     type=vim.Datacenter,
2715                     selectSet=["traversal_spec"],
2716                 ),
2717             ]
2718         )
2719     def test_traversal_spec_dvs_parent(self):
2720         mock_traversal_spec = MagicMock(return_value="traversal_spec")
2721         with patch(
2722             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2723             mock_traversal_spec,
2724         ):
2725             salt.utils.vmware.get_dvportgroups(self.mock_dvs_ref)
2726         mock_traversal_spec.assert_called_once_with(
2727             path="portgroup", skip=False, type=vim.DistributedVirtualSwitch
2728         )
2729     def test_get_mors_with_properties(self):
2730         salt.utils.vmware.get_dvportgroups(self.mock_dvs_ref)
2731         self.mock_get_mors.assert_called_once_with(
2732             self.mock_si,
2733             vim.DistributedVirtualPortgroup,
2734             container_ref=self.mock_dvs_ref,
2735             property_list=["name"],
2736             traversal_spec=self.mock_traversal_spec,
2737         )
2738     def test_get_no_pgs(self):
2739         ret = salt.utils.vmware.get_dvportgroups(self.mock_dvs_ref)
2740         self.assertEqual(ret, [])
2741     def test_get_all_pgs(self):
2742         ret = salt.utils.vmware.get_dvportgroups(
2743             self.mock_dvs_ref, get_all_portgroups=True
2744         )
2745         self.assertEqual(ret, [i["object"] for i in self.mock_items])
2746     def test_filtered_pgs(self):
2747         ret = salt.utils.vmware.get_dvss(
2748             self.mock_dc_ref, dvs_names=["fake_pg1", "fake_pg3", "no_pg"]
2749         )
2750         self.assertEqual(
2751             ret, [self.mock_items[0]["object"], self.mock_items[2]["object"]]
2752         )
2753 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2754 class GetUplinkDvportgroupTestCase(TestCase):
2755     def setUp(self):
2756         self.mock_si = MagicMock()
2757         self.mock_dvs_ref = MagicMock(spec=vim.DistributedVirtualSwitch)
2758         self.mock_traversal_spec = MagicMock()
2759         self.mock_items = [
2760             {"object": MagicMock(), "tag": [MagicMock(key="fake_tag")]},
2761             {"object": MagicMock(), "tag": [MagicMock(key="SYSTEM/DVS.UPLINKPG")]},
2762         ]
2763         self.mock_get_mors = MagicMock(return_value=self.mock_items)
2764         patches = (
2765             (
2766                 "salt.utils.vmware.get_managed_object_name",
2767                 MagicMock(return_value="fake_dvs"),
2768             ),
2769             ("salt.utils.vmware.get_mors_with_properties", self.mock_get_mors),
2770             (
2771                 "salt.utils.vmware.get_service_instance_from_managed_object",
2772                 MagicMock(return_value=self.mock_si),
2773             ),
2774             (
2775                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2776                 MagicMock(return_value=self.mock_traversal_spec),
2777             ),
2778         )
2779         for mod, mock in patches:
2780             patcher = patch(mod, mock)
2781             patcher.start()
2782             self.addCleanup(patcher.stop)
2783     def tearDown(self):
2784         for attr in (
2785             "mock_si",
2786             "mock_dvs_ref",
2787             "mock_traversal_spec",
2788             "mock_items",
2789             "mock_get_mors",
2790         ):
2791             delattr(self, attr)
2792     def test_get_managed_object_name_call(self):
2793         mock_get_managed_object_name = MagicMock()
2794         with patch(
2795             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2796         ):
2797             salt.utils.vmware.get_uplink_dvportgroup(self.mock_dvs_ref)
2798         mock_get_managed_object_name.assert_called_once_with(self.mock_dvs_ref)
2799     def test_traversal_spec(self):
2800         mock_traversal_spec = MagicMock(return_value="traversal_spec")
2801         with patch(
2802             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
2803             mock_traversal_spec,
2804         ):
2805             salt.utils.vmware.get_uplink_dvportgroup(self.mock_dvs_ref)
2806         mock_traversal_spec.assert_called_once_with(
2807             path="portgroup", skip=False, type=vim.DistributedVirtualSwitch
2808         )
2809     def test_get_mors_with_properties(self):
2810         salt.utils.vmware.get_uplink_dvportgroup(self.mock_dvs_ref)
2811         self.mock_get_mors.assert_called_once_with(
2812             self.mock_si,
2813             vim.DistributedVirtualPortgroup,
2814             container_ref=self.mock_dvs_ref,
2815             property_list=["tag"],
2816             traversal_spec=self.mock_traversal_spec,
2817         )
2818     def test_get_no_uplink_pg(self):
2819         with patch(
2820             "salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])
2821         ):
2822             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
2823                 salt.utils.vmware.get_uplink_dvportgroup(self.mock_dvs_ref)
2824         self.assertEqual(
2825             excinfo.exception.strerror,
2826             "Uplink portgroup of DVS 'fake_dvs' wasn't found",
2827         )
2828     def test_get_uplink_pg(self):
2829         ret = salt.utils.vmware.get_uplink_dvportgroup(self.mock_dvs_ref)
2830         self.assertEqual(ret, self.mock_items[1]["object"])
2831 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2832 class CreateDvportgroupTestCase(TestCase):
2833     def setUp(self):
2834         self.mock_pg_spec = MagicMock()
2835         self.mock_task = MagicMock(spec=FakeTaskClass)
2836         self.mock_dvs_ref = MagicMock(
2837             CreateDVPortgroup_Task=MagicMock(return_value=self.mock_task)
2838         )
2839         self.mock_wait_for_task = MagicMock()
2840         patches = (
2841             (
2842                 "salt.utils.vmware.get_managed_object_name",
2843                 MagicMock(return_value="fake_dvs"),
2844             ),
2845             ("salt.utils.vmware.wait_for_task", self.mock_wait_for_task),
2846         )
2847         for mod, mock in patches:
2848             patcher = patch(mod, mock)
2849             patcher.start()
2850             self.addCleanup(patcher.stop)
2851     def tearDown(self):
2852         for attr in ("mock_pg_spec", "mock_dvs_ref", "mock_task", "mock_wait_for_task"):
2853             delattr(self, attr)
2854     def test_get_managed_object_name_call(self):
2855         mock_get_managed_object_name = MagicMock()
2856         with patch(
2857             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2858         ):
2859             salt.utils.vmware.create_dvportgroup(self.mock_dvs_ref, self.mock_pg_spec)
2860         mock_get_managed_object_name.assert_called_once_with(self.mock_dvs_ref)
2861     def test_create_dvporgroup_task(self):
2862         salt.utils.vmware.create_dvportgroup(self.mock_dvs_ref, self.mock_pg_spec)
2863         self.mock_dvs_ref.CreateDVPortgroup_Task.assert_called_once_with(
2864             self.mock_pg_spec
2865         )
2866     def test_create_dvporgroup_task_raises_no_permission(self):
2867         exc = vim.fault.NoPermission()
2868         exc.privilegeId = "Fake privilege"
2869         self.mock_dvs_ref.CreateDVPortgroup_Task = MagicMock(side_effect=exc)
2870         with self.assertRaises(VMwareApiError) as excinfo:
2871             salt.utils.vmware.create_dvportgroup(self.mock_dvs_ref, self.mock_pg_spec)
2872         self.assertEqual(
2873             excinfo.exception.strerror,
2874             "Not enough permissions. Required privilege: Fake privilege",
2875         )
2876     def test_create_dvporgroup_task_raises_vim_fault(self):
2877         exc = vim.fault.VimFault()
2878         exc.msg = "VimFault msg"
2879         self.mock_dvs_ref.CreateDVPortgroup_Task = MagicMock(side_effect=exc)
2880         with self.assertRaises(VMwareApiError) as excinfo:
2881             salt.utils.vmware.create_dvportgroup(self.mock_dvs_ref, self.mock_pg_spec)
2882         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
2883     def test_create_dvporgroup_task_raises_runtime_fault(self):
2884         exc = vmodl.RuntimeFault()
2885         exc.msg = "RuntimeFault msg"
2886         self.mock_dvs_ref.CreateDVPortgroup_Task = MagicMock(side_effect=exc)
2887         with self.assertRaises(VMwareRuntimeError) as excinfo:
2888             salt.utils.vmware.create_dvportgroup(self.mock_dvs_ref, self.mock_pg_spec)
2889         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
2890     def test_wait_for_tasks(self):
2891         salt.utils.vmware.create_dvportgroup(self.mock_dvs_ref, self.mock_pg_spec)
2892         self.mock_wait_for_task.assert_called_once_with(
2893             self.mock_task,
2894             "fake_dvs",
2895             "&lt;class 'tests.unit.utils.test_vmware.FakeTaskClass'&gt;",
2896         )
2897 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2898 class UpdateDvportgroupTestCase(TestCase):
2899     def setUp(self):
2900         self.mock_pg_spec = MagicMock()
2901         self.mock_task = MagicMock(spec=FakeTaskClass)
2902         self.mock_pg_ref = MagicMock(
2903             ReconfigureDVPortgroup_Task=MagicMock(return_value=self.mock_task)
2904         )
2905         self.mock_wait_for_task = MagicMock()
2906         patches = (
2907             (
2908                 "salt.utils.vmware.get_managed_object_name",
2909                 MagicMock(return_value="fake_pg"),
2910             ),
2911             ("salt.utils.vmware.wait_for_task", self.mock_wait_for_task),
2912         )
2913         for mod, mock in patches:
2914             patcher = patch(mod, mock)
2915             patcher.start()
2916             self.addCleanup(patcher.stop)
2917     def tearDown(self):
2918         for attr in ("mock_pg_spec", "mock_pg_ref", "mock_task", "mock_wait_for_task"):
2919             delattr(self, attr)
2920     def test_get_managed_object_name_call(self):
2921         mock_get_managed_object_name = MagicMock()
2922         with patch(
2923             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2924         ):
2925             salt.utils.vmware.update_dvportgroup(self.mock_pg_ref, self.mock_pg_spec)
2926         mock_get_managed_object_name.assert_called_once_with(self.mock_pg_ref)
2927     def test_reconfigure_dvporgroup_task(self):
2928         salt.utils.vmware.update_dvportgroup(self.mock_pg_ref, self.mock_pg_spec)
2929         self.mock_pg_ref.ReconfigureDVPortgroup_Task.assert_called_once_with(
2930             self.mock_pg_spec
2931         )
2932     def test_reconfigure_dvporgroup_task_raises_no_permission(self):
2933         exc = vim.fault.NoPermission()
2934         exc.privilegeId = "Fake privilege"
2935         self.mock_pg_ref.ReconfigureDVPortgroup_Task = MagicMock(side_effect=exc)
2936         with self.assertRaises(VMwareApiError) as excinfo:
2937             salt.utils.vmware.update_dvportgroup(self.mock_pg_ref, self.mock_pg_spec)
2938         self.assertEqual(
2939             excinfo.exception.strerror,
2940             "Not enough permissions. Required privilege: Fake privilege",
2941         )
2942     def test_reconfigure_dvporgroup_task_raises_vim_fault(self):
2943         exc = vim.fault.VimFault()
2944         exc.msg = "VimFault msg"
2945         self.mock_pg_ref.ReconfigureDVPortgroup_Task = MagicMock(side_effect=exc)
2946         with self.assertRaises(VMwareApiError) as excinfo:
2947             salt.utils.vmware.update_dvportgroup(self.mock_pg_ref, self.mock_pg_spec)
2948         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
2949     def test_reconfigure_dvporgroup_task_raises_runtime_fault(self):
2950         exc = vmodl.RuntimeFault()
2951         exc.msg = "RuntimeFault msg"
2952         self.mock_pg_ref.ReconfigureDVPortgroup_Task = MagicMock(side_effect=exc)
2953         with self.assertRaises(VMwareRuntimeError) as excinfo:
2954             salt.utils.vmware.update_dvportgroup(self.mock_pg_ref, self.mock_pg_spec)
2955         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
2956     def test_wait_for_tasks(self):
2957         salt.utils.vmware.update_dvportgroup(self.mock_pg_ref, self.mock_pg_spec)
2958         self.mock_wait_for_task.assert_called_once_with(
2959             self.mock_task,
2960             "fake_pg",
2961             "&lt;class 'tests.unit.utils.test_vmware.FakeTaskClass'&gt;",
2962         )
2963 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2964 class RemoveDvportgroupTestCase(TestCase):
2965     def setUp(self):
2966         self.mock_task = MagicMock(spec=FakeTaskClass)
2967         self.mock_pg_ref = MagicMock(
2968             Destroy_Task=MagicMock(return_value=self.mock_task)
2969         )
2970         self.mock_wait_for_task = MagicMock()
2971         patches = (
2972             (
2973                 "salt.utils.vmware.get_managed_object_name",
2974                 MagicMock(return_value="fake_pg"),
2975             ),
2976             ("salt.utils.vmware.wait_for_task", self.mock_wait_for_task),
2977         )
2978         for mod, mock in patches:
2979             patcher = patch(mod, mock)
2980             patcher.start()
2981             self.addCleanup(patcher.stop)
2982     def tearDown(self):
2983         for attr in ("mock_pg_ref", "mock_task", "mock_wait_for_task"):
2984             delattr(self, attr)
2985     def test_get_managed_object_name_call(self):
2986         mock_get_managed_object_name = MagicMock()
2987         with patch(
2988             "salt.utils.vmware.get_managed_object_name", mock_get_managed_object_name
2989         ):
2990             salt.utils.vmware.remove_dvportgroup(self.mock_pg_ref)
2991         mock_get_managed_object_name.assert_called_once_with(self.mock_pg_ref)
2992     def test_destroy_task(self):
2993         salt.utils.vmware.remove_dvportgroup(self.mock_pg_ref)
2994         self.mock_pg_ref.Destroy_Task.assert_called_once_with()
2995     def test_destroy_task_raises_no_permission(self):
2996         exc = vim.fault.NoPermission()
2997         exc.privilegeId = "Fake privilege"
2998         self.mock_pg_ref.Destroy_Task = MagicMock(side_effect=exc)
2999         with self.assertRaises(VMwareApiError) as excinfo:
3000             salt.utils.vmware.remove_dvportgroup(self.mock_pg_ref)
3001         self.assertEqual(
3002             excinfo.exception.strerror,
3003             "Not enough permissions. Required privilege: Fake privilege",
3004         )
3005     def test_destroy_treconfigure_dvporgroup_task_raises_vim_fault(self):
3006         exc = vim.fault.VimFault()
3007         exc.msg = "VimFault msg"
3008         self.mock_pg_ref.Destroy_Task = MagicMock(side_effect=exc)
3009         with self.assertRaises(VMwareApiError) as excinfo:
3010             salt.utils.vmware.remove_dvportgroup(self.mock_pg_ref)
3011         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3012     def test_destroy_treconfigure_dvporgroup_task_raises_runtime_fault(self):
3013         exc = vmodl.RuntimeFault()
3014         exc.msg = "RuntimeFault msg"
3015         self.mock_pg_ref.Destroy_Task = MagicMock(side_effect=exc)
3016         with self.assertRaises(VMwareRuntimeError) as excinfo:
3017             salt.utils.vmware.remove_dvportgroup(self.mock_pg_ref)
3018         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3019     def test_wait_for_tasks(self):
3020         salt.utils.vmware.remove_dvportgroup(self.mock_pg_ref)
3021         self.mock_wait_for_task.assert_called_once_with(
3022             self.mock_task,
3023             "fake_pg",
3024             "&lt;class 'tests.unit.utils.test_vmware.FakeTaskClass'&gt;",
3025         )
3026 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3027 class GetHostsTestCase(TestCase):
3028     def setUp(self):
3029         patches = (
3030             ("salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])),
3031             ("salt.utils.vmware.get_datacenter", MagicMock(return_value=None)),
3032             ("salt.utils.vmware.get_cluster", MagicMock(return_value=None)),
3033         )
3034         for mod, mock in patches:
3035             patcher = patch(mod, mock)
3036             patcher.start()
3037             self.addCleanup(patcher.stop)
3038         self.mock_root_folder = MagicMock()
3039         self.mock_si = MagicMock()
3040         self.mock_host1, self.mock_host2, self.mock_host3 = (
3041             MagicMock(),
3042             MagicMock(),
3043             MagicMock(),
3044         )
3045         self.mock_prop_host1 = {"name": "fake_hostname1", "object": self.mock_host1}
3046         self.mock_prop_host2 = {"name": "fake_hostname2", "object": self.mock_host2}
3047         self.mock_prop_host3 = {"name": "fake_hostname3", "object": self.mock_host3}
3048         self.mock_prop_hosts = [
3049             self.mock_prop_host1,
3050             self.mock_prop_host2,
3051             self.mock_prop_host3,
3052         ]
3053     def test_cluster_no_datacenter(self):
3054         with self.assertRaises(ArgumentValueError) as excinfo:
3055             salt.utils.vmware.get_hosts(self.mock_si, cluster_name="fake_cluster")
3056         self.assertEqual(
3057             excinfo.exception.strerror,
3058             "Must specify the datacenter when specifying the cluster",
3059         )
3060     def test_get_si_no_datacenter_no_cluster(self):
3061         mock_get_mors = MagicMock()
3062         mock_get_root_folder = MagicMock(return_value=self.mock_root_folder)
3063         with patch("salt.utils.vmware.get_root_folder", mock_get_root_folder):
3064             with patch("salt.utils.vmware.get_mors_with_properties", mock_get_mors):
3065                 salt.utils.vmware.get_hosts(self.mock_si)
3066         mock_get_root_folder.assert_called_once_with(self.mock_si)
3067         mock_get_mors.assert_called_once_with(
3068             self.mock_si,
3069             vim.HostSystem,
3070             container_ref=self.mock_root_folder,
3071             property_list=["name"],
3072         )
3073     def test_get_si_datacenter_name_no_cluster_name(self):
3074         mock_dc = MagicMock()
3075         mock_get_dc = MagicMock(return_value=mock_dc)
3076         mock_get_mors = MagicMock()
3077         with patch("salt.utils.vmware.get_datacenter", mock_get_dc):
3078             with patch("salt.utils.vmware.get_mors_with_properties", mock_get_mors):
3079                 salt.utils.vmware.get_hosts(
3080                     self.mock_si, datacenter_name="fake_datacenter"
3081                 )
3082         mock_get_dc.assert_called_once_with(self.mock_si, "fake_datacenter")
3083         mock_get_mors.assert_called_once_with(
3084             self.mock_si, vim.HostSystem, container_ref=mock_dc, property_list=["name"]
3085         )
3086     def test_get_si_datacenter_name_and_cluster_name(self):
3087         mock_dc = MagicMock()
3088         mock_get_dc = MagicMock(return_value=mock_dc)
3089         mock_get_cl = MagicMock()
3090         mock_get_mors = MagicMock()
3091         with patch("salt.utils.vmware.get_datacenter", mock_get_dc):
3092             with patch("salt.utils.vmware.get_cluster", mock_get_cl):
3093                 with patch("salt.utils.vmware.get_mors_with_properties", mock_get_mors):
3094                     salt.utils.vmware.get_hosts(
3095                         self.mock_si,
3096                         datacenter_name="fake_datacenter",
3097                         cluster_name="fake_cluster",
3098                     )
3099         mock_get_dc.assert_called_once_with(self.mock_si, "fake_datacenter")
3100         mock_get_mors.assert_called_once_with(
3101             self.mock_si,
3102             vim.HostSystem,
3103             container_ref=mock_dc,
3104             property_list=["name", "parent"],
3105         )
3106     def test_host_get_all_hosts(self):
3107         with patch(
3108             "salt.utils.vmware.get_root_folder",
3109             MagicMock(return_value=self.mock_root_folder),
3110         ):
3111             with patch(
3112                 "salt.utils.vmware.get_mors_with_properties",
3113                 MagicMock(return_value=self.mock_prop_hosts),
3114             ):
3115                 res = salt.utils.vmware.get_hosts(self.mock_si, get_all_hosts=True)
3116         self.assertEqual(res, [self.mock_host1, self.mock_host2, self.mock_host3])
3117     def test_filter_hostname(self):
3118         with patch(
3119             "salt.utils.vmware.get_mors_with_properties",
3120             MagicMock(return_value=self.mock_prop_hosts),
3121         ):
3122             res = salt.utils.vmware.get_hosts(
3123                 self.mock_si, host_names=["fake_hostname1", "fake_hostname2"]
3124             )
3125         self.assertEqual(res, [self.mock_host1, self.mock_host2])
3126     def test_get_all_host_flag_not_set_and_no_host_names(self):
3127         with patch(
3128             "salt.utils.vmware.get_mors_with_properties",
3129             MagicMock(return_value=self.mock_prop_hosts),
3130         ):
3131             res = salt.utils.vmware.get_hosts(self.mock_si)
3132         self.assertEqual(res, [])
3133     def test_filter_cluster(self):
3134         self.mock_prop_host1["parent"] = vim.ClusterComputeResource("cluster")
3135         self.mock_prop_host2["parent"] = vim.ClusterComputeResource("cluster")
3136         self.mock_prop_host3["parent"] = vim.Datacenter("dc")
3137         mock_get_cl_name = MagicMock(
3138             side_effect=["fake_bad_cluster", "fake_good_cluster"]
3139         )
3140         with patch(
3141             "salt.utils.vmware.get_mors_with_properties",
3142             MagicMock(return_value=self.mock_prop_hosts),
3143         ):
3144             with patch("salt.utils.vmware.get_managed_object_name", mock_get_cl_name):
3145                 res = salt.utils.vmware.get_hosts(
3146                     self.mock_si,
3147                     datacenter_name="fake_datacenter",
3148                     cluster_name="fake_good_cluster",
3149                     get_all_hosts=True,
3150                 )
3151         self.assertEqual(mock_get_cl_name.call_count, 2)
3152         self.assertEqual(res, [self.mock_host2])
3153     def test_no_hosts(self):
3154         with patch(
3155             "salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])
3156         ):
3157             res = salt.utils.vmware.get_hosts(self.mock_si, get_all_hosts=True)
3158         self.assertEqual(res, [])
3159     def test_one_host_returned(self):
3160         with patch(
3161             "salt.utils.vmware.get_mors_with_properties",
3162             MagicMock(return_value=[self.mock_prop_host1]),
3163         ):
3164             res = salt.utils.vmware.get_hosts(self.mock_si, get_all_hosts=True)
3165         self.assertEqual(res, [self.mock_host1])
3166 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3167 class GetLicenseManagerTestCase(TestCase):
3168     def setUp(self):
3169         self.mock_si = MagicMock()
3170         self.mock_lic_mgr = MagicMock()
3171         type(self.mock_si.content).licenseManager = PropertyMock(
3172             return_value=self.mock_lic_mgr
3173         )
3174     def tearDown(self):
3175         for attr in ("mock_si", "mock_lic_mgr"):
3176             delattr(self, attr)
3177     def test_raise_no_permission(self):
3178         exc = vim.fault.NoPermission()
3179         exc.privilegeId = "Fake privilege"
3180         type(self.mock_si.content).licenseManager = PropertyMock(side_effect=exc)
3181         with self.assertRaises(VMwareApiError) as excinfo:
3182             salt.utils.vmware.get_license_manager(self.mock_si)
3183         self.assertEqual(
3184             excinfo.exception.strerror,
3185             "Not enough permissions. Required privilege: Fake privilege",
3186         )
3187     def test_raise_vim_fault(self):
3188         exc = vim.fault.VimFault()
3189         exc.msg = "VimFault msg"
3190         type(self.mock_si.content).licenseManager = PropertyMock(side_effect=exc)
3191         with self.assertRaises(VMwareApiError) as excinfo:
3192             salt.utils.vmware.get_license_manager(self.mock_si)
3193         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3194     def test_raise_runtime_fault(self):
3195         exc = vmodl.RuntimeFault()
3196         exc.msg = "RuntimeFault msg"
3197         type(self.mock_si.content).licenseManager = PropertyMock(side_effect=exc)
3198         with self.assertRaises(VMwareRuntimeError) as excinfo:
3199             salt.utils.vmware.get_license_manager(self.mock_si)
3200         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3201     def test_valid_assignment_manager(self):
3202         ret = salt.utils.vmware.get_license_manager(self.mock_si)
3203         self.assertEqual(ret, self.mock_lic_mgr)
3204 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3205 class GetLicenseAssignmentManagerTestCase(TestCase):
3206     def setUp(self):
3207         self.mock_si = MagicMock()
3208         self.mock_lic_assign_mgr = MagicMock()
3209         type(
3210             self.mock_si.content.licenseManager
3211         ).licenseAssignmentManager = PropertyMock(return_value=self.mock_lic_assign_mgr)
3212     def tearDown(self):
3213         for attr in ("mock_si", "mock_lic_assign_mgr"):
3214             delattr(self, attr)
3215     def test_raise_no_permission(self):
3216         exc = vim.fault.NoPermission()
3217         exc.privilegeId = "Fake privilege"
3218         type(
3219             self.mock_si.content.licenseManager
3220         ).licenseAssignmentManager = PropertyMock(side_effect=exc)
3221         with self.assertRaises(VMwareApiError) as excinfo:
3222             salt.utils.vmware.get_license_assignment_manager(self.mock_si)
3223         self.assertEqual(
3224             excinfo.exception.strerror,
3225             "Not enough permissions. Required privilege: Fake privilege",
3226         )
3227     def test_raise_vim_fault(self):
3228         exc = vim.fault.VimFault()
3229         exc.msg = "VimFault msg"
3230         type(
3231             self.mock_si.content.licenseManager
3232         ).licenseAssignmentManager = PropertyMock(side_effect=exc)
3233         with self.assertRaises(VMwareApiError) as excinfo:
3234             salt.utils.vmware.get_license_assignment_manager(self.mock_si)
3235         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3236     def test_raise_runtime_fault(self):
3237         exc = vmodl.RuntimeFault()
3238         exc.msg = "RuntimeFault msg"
3239         type(
3240             self.mock_si.content.licenseManager
3241         ).licenseAssignmentManager = PropertyMock(side_effect=exc)
3242         with self.assertRaises(VMwareRuntimeError) as excinfo:
3243             salt.utils.vmware.get_license_assignment_manager(self.mock_si)
3244         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3245     def test_empty_license_assignment_manager(self):
3246         type(
3247             self.mock_si.content.licenseManager
3248         ).licenseAssignmentManager = PropertyMock(return_value=None)
3249         with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
3250             salt.utils.vmware.get_license_assignment_manager(self.mock_si)
3251         self.assertEqual(
3252             excinfo.exception.strerror, "License assignment manager was not retrieved"
3253         )
3254     def test_valid_assignment_manager(self):
3255         ret = salt.utils.vmware.get_license_assignment_manager(self.mock_si)
3256         self.assertEqual(ret, self.mock_lic_assign_mgr)
3257 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3258 class GetLicensesTestCase(TestCase):
3259     def setUp(self):
3260         self.mock_si = MagicMock()
3261         self.mock_licenses = [MagicMock(), MagicMock()]
3262         self.mock_lic_mgr = MagicMock()
3263         type(self.mock_lic_mgr).licenses = PropertyMock(return_value=self.mock_licenses)
3264         patches = (
3265             (
3266                 "salt.utils.vmware.get_license_manager",
3267                 MagicMock(return_value=self.mock_lic_mgr),
3268             ),
3269         )
3270         for mod, mock in patches:
3271             patcher = patch(mod, mock)
3272             patcher.start()
3273             self.addCleanup(patcher.stop)
3274     def tearDown(self):
3275         for attr in ("mock_si", "mock_lic_mgr", "mock_licenses"):
3276             delattr(self, attr)
3277     def test_no_license_manager_passed_in(self):
3278         mock_get_license_manager = MagicMock()
3279         with patch("salt.utils.vmware.get_license_manager", mock_get_license_manager):
3280             salt.utils.vmware.get_licenses(self.mock_si)
3281         mock_get_license_manager.assert_called_once_with(self.mock_si)
3282     def test_license_manager_passed_in(self):
3283         mock_licenses = PropertyMock()
3284         mock_lic_mgr = MagicMock()
3285         type(mock_lic_mgr).licenses = mock_licenses
3286         mock_get_license_manager = MagicMock()
3287         with patch("salt.utils.vmware.get_license_manager", mock_get_license_manager):
3288             salt.utils.vmware.get_licenses(self.mock_si, license_manager=mock_lic_mgr)
3289         self.assertEqual(mock_get_license_manager.call_count, 0)
3290         self.assertEqual(mock_licenses.call_count, 1)
3291     def test_raise_no_permission(self):
3292         exc = vim.fault.NoPermission()
3293         exc.privilegeId = "Fake privilege"
3294         type(self.mock_lic_mgr).licenses = PropertyMock(side_effect=exc)
3295         with self.assertRaises(VMwareApiError) as excinfo:
3296             salt.utils.vmware.get_licenses(self.mock_si)
3297         self.assertEqual(
3298             excinfo.exception.strerror,
3299             "Not enough permissions. Required privilege: Fake privilege",
3300         )
3301     def test_raise_vim_fault(self):
3302         exc = vim.fault.VimFault()
3303         exc.msg = "VimFault msg"
3304         type(self.mock_lic_mgr).licenses = PropertyMock(side_effect=exc)
3305         with self.assertRaises(VMwareApiError) as excinfo:
3306             salt.utils.vmware.get_licenses(self.mock_si)
3307         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3308     def test_raise_runtime_fault(self):
3309         exc = vmodl.RuntimeFault()
3310         exc.msg = "RuntimeFault msg"
3311         type(self.mock_lic_mgr).licenses = PropertyMock(side_effect=exc)
3312         with self.assertRaises(VMwareRuntimeError) as excinfo:
3313             salt.utils.vmware.get_licenses(self.mock_si)
3314         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3315     def test_valid_licenses(self):
3316         ret = salt.utils.vmware.get_licenses(self.mock_si)
3317         self.assertEqual(ret, self.mock_licenses)
3318 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3319 class AddLicenseTestCase(TestCase):
3320     def setUp(self):
3321         self.mock_si = MagicMock()
3322         self.mock_license = MagicMock()
3323         self.mock_add_license = MagicMock(return_value=self.mock_license)
3324         self.mock_lic_mgr = MagicMock(AddLicense=self.mock_add_license)
3325         self.mock_label = MagicMock()
3326         patches = (
3327             (
3328                 "salt.utils.vmware.get_license_manager",
3329                 MagicMock(return_value=self.mock_lic_mgr),
3330             ),
3331             ("salt.utils.vmware.vim.KeyValue", MagicMock(return_value=self.mock_label)),
3332         )
3333         for mod, mock in patches:
3334             patcher = patch(mod, mock)
3335             patcher.start()
3336             self.addCleanup(patcher.stop)
3337     def tearDown(self):
3338         for attr in (
3339             "mock_si",
3340             "mock_lic_mgr",
3341             "mock_license",
3342             "mock_add_license",
3343             "mock_label",
3344         ):
3345             delattr(self, attr)
3346     def test_no_license_manager_passed_in(self):
3347         mock_get_license_manager = MagicMock()
3348         with patch("salt.utils.vmware.get_license_manager", mock_get_license_manager):
3349             salt.utils.vmware.add_license(
3350                 self.mock_si, "fake_license_key", "fake_license_description"
3351             )
3352         mock_get_license_manager.assert_called_once_with(self.mock_si)
3353     def test_license_manager_passed_in(self):
3354         mock_get_license_manager = MagicMock()
3355         with patch("salt.utils.vmware.get_license_manager", mock_get_license_manager):
3356             salt.utils.vmware.add_license(
3357                 self.mock_si,
3358                 "fake_license_key",
3359                 "fake_license_description",
3360                 license_manager=self.mock_lic_mgr,
3361             )
3362         self.assertEqual(mock_get_license_manager.call_count, 0)
3363         self.assertEqual(self.mock_add_license.call_count, 1)
3364     def test_label_settings(self):
3365         salt.utils.vmware.add_license(
3366             self.mock_si, "fake_license_key", "fake_license_description"
3367         )
3368         self.assertEqual(self.mock_label.key, "VpxClientLicenseLabel")
3369         self.assertEqual(self.mock_label.value, "fake_license_description")
3370     def test_add_license_arguments(self):
3371         salt.utils.vmware.add_license(
3372             self.mock_si, "fake_license_key", "fake_license_description"
3373         )
3374         self.mock_add_license.assert_called_once_with(
3375             "fake_license_key", [self.mock_label]
3376         )
3377     def test_add_license_raises_no_permission(self):
3378         exc = vim.fault.NoPermission()
3379         exc.privilegeId = "Fake privilege"
3380         self.mock_lic_mgr.AddLicense = MagicMock(side_effect=exc)
3381         with self.assertRaises(VMwareApiError) as excinfo:
3382             salt.utils.vmware.add_license(
3383                 self.mock_si, "fake_license_key", "fake_license_description"
3384             )
3385         self.assertEqual(
3386             excinfo.exception.strerror,
3387             "Not enough permissions. Required privilege: Fake privilege",
3388         )
3389     def test_add_license_raises_vim_fault(self):
3390         exc = vim.fault.VimFault()
3391         exc.msg = "VimFault msg"
3392         self.mock_lic_mgr.AddLicense = MagicMock(side_effect=exc)
3393         with self.assertRaises(VMwareApiError) as excinfo:
3394             salt.utils.vmware.add_license(
3395                 self.mock_si, "fake_license_key", "fake_license_description"
3396             )
3397         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3398     def test_add_license_raises_runtime_fault(self):
3399         exc = vmodl.RuntimeFault()
3400         exc.msg = "RuntimeFault msg"
3401         self.mock_lic_mgr.AddLicense = MagicMock(side_effect=exc)
3402         with self.assertRaises(VMwareRuntimeError) as excinfo:
3403             salt.utils.vmware.add_license(
3404                 self.mock_si, "fake_license_key", "fake_license_description"
3405             )
3406         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3407     def test_valid_license_added(self):
3408         ret = salt.utils.vmware.add_license(
3409             self.mock_si, "fake_license_key", "fake_license_description"
3410         )
3411         self.assertEqual(ret, self.mock_license)
3412 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3413 class GetAssignedLicensesTestCase(TestCase):
3414     def setUp(self):
3415         self.mock_ent_id = MagicMock()
3416         self.mock_si = MagicMock()
3417         type(self.mock_si.content.about).instanceUuid = PropertyMock(
3418             return_value=self.mock_ent_id
3419         )
3420         self.mock_moid = MagicMock()
3421         self.prop_mock_moid = PropertyMock(return_value=self.mock_moid)
3422         self.mock_entity_ref = MagicMock()
3423         type(self.mock_entity_ref)._moId = self.prop_mock_moid
3424         self.mock_assignments = [
3425             MagicMock(entityDisplayName="fake_ent1"),
3426             MagicMock(entityDisplayName="fake_ent2"),
3427         ]
3428         self.mock_query_assigned_licenses = MagicMock(
3429             return_value=[
3430                 MagicMock(assignedLicense=self.mock_assignments[0]),
3431                 MagicMock(assignedLicense=self.mock_assignments[1]),
3432             ]
3433         )
3434         self.mock_lic_assign_mgr = MagicMock(
3435             QueryAssignedLicenses=self.mock_query_assigned_licenses
3436         )
3437         patches = (
3438             (
3439                 "salt.utils.vmware.get_license_assignment_manager",
3440                 MagicMock(return_value=self.mock_lic_assign_mgr),
3441             ),
3442         )
3443         for mod, mock in patches:
3444             patcher = patch(mod, mock)
3445             patcher.start()
3446             self.addCleanup(patcher.stop)
3447     def tearDown(self):
3448         for attr in (
3449             "mock_ent_id",
3450             "mock_si",
3451             "mock_moid",
3452             "prop_mock_moid",
3453             "mock_entity_ref",
3454             "mock_assignments",
3455             "mock_query_assigned_licenses",
3456             "mock_lic_assign_mgr",
3457         ):
3458             delattr(self, attr)
3459     def test_no_license_assignment_manager_passed_in(self):
3460         mock_get_license_assign_manager = MagicMock()
3461         with patch(
3462             "salt.utils.vmware.get_license_assignment_manager",
3463             mock_get_license_assign_manager,
3464         ):
3465             salt.utils.vmware.get_assigned_licenses(
3466                 self.mock_si, self.mock_entity_ref, "fake_entity_name"
3467             )
3468         mock_get_license_assign_manager.assert_called_once_with(self.mock_si)
3469     def test_license_assignment_manager_passed_in(self):
3470         mock_get_license_assign_manager = MagicMock()
3471         with patch(
3472             "salt.utils.vmware.get_license_assignment_manager",
3473             mock_get_license_assign_manager,
3474         ):
3475             salt.utils.vmware.get_assigned_licenses(
3476                 self.mock_si,
3477                 self.mock_entity_ref,
3478                 "fake_entity_name",
3479                 license_assignment_manager=self.mock_lic_assign_mgr,
3480             )
3481         self.assertEqual(mock_get_license_assign_manager.call_count, 0)
3482     def test_entity_name(self):
3483         mock_trace = MagicMock()
3484         with patch("salt._logging.impl.SaltLoggingClass.trace", mock_trace):
3485             salt.utils.vmware.get_assigned_licenses(
3486                 self.mock_si, self.mock_entity_ref, "fake_entity_name"
3487             )
3488         mock_trace.assert_called_once_with(
3489             "Retrieving licenses assigned to '%s'", "fake_entity_name"
3490         )
3491     def test_instance_uuid(self):
3492         mock_instance_uuid_prop = PropertyMock()
3493         type(self.mock_si.content.about).instanceUuid = mock_instance_uuid_prop
3494         self.mock_lic_assign_mgr.QueryAssignedLicenses = MagicMock(
3495             return_value=[MagicMock(entityDisplayName="fake_vcenter")]
3496         )
3497         salt.utils.vmware.get_assigned_licenses(
3498             self.mock_si, entity_name="fake_vcenter"
3499         )
3500         self.assertEqual(mock_instance_uuid_prop.call_count, 1)
3501     def test_instance_uuid_raises_no_permission(self):
3502         exc = vim.fault.NoPermission()
3503         exc.privilegeId = "Fake privilege"
3504         type(self.mock_si.content.about).instanceUuid = PropertyMock(side_effect=exc)
3505         with self.assertRaises(VMwareApiError) as excinfo:
3506             salt.utils.vmware.get_assigned_licenses(
3507                 self.mock_si, entity_name="fake_vcenter"
3508             )
3509         self.assertEqual(
3510             excinfo.exception.strerror,
3511             "Not enough permissions. Required privilege: Fake privilege",
3512         )
3513     def test_instance_uuid_raises_vim_fault(self):
3514         exc = vim.fault.VimFault()
3515         exc.msg = "VimFault msg"
3516         type(self.mock_si.content.about).instanceUuid = PropertyMock(side_effect=exc)
3517         with self.assertRaises(VMwareApiError) as excinfo:
3518             salt.utils.vmware.get_assigned_licenses(
3519                 self.mock_si, entity_name="fake_vcenter"
3520             )
3521         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3522     def test_instance_uuid_raises_runtime_fault(self):
3523         exc = vmodl.RuntimeFault()
3524         exc.msg = "RuntimeFault msg"
3525         type(self.mock_si.content.about).instanceUuid = PropertyMock(side_effect=exc)
3526         with self.assertRaises(VMwareRuntimeError) as excinfo:
3527             salt.utils.vmware.get_assigned_licenses(
3528                 self.mock_si, entity_name="fake_vcenter"
3529             )
3530         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3531     def test_vcenter_entity_too_many_assignements(self):
3532         self.mock_lic_assign_mgr.QueryAssignedLicenses = MagicMock(
3533             return_value=[MagicMock(), MagicMock()]
3534         )
3535         with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
3536             salt.utils.vmware.get_assigned_licenses(
3537                 self.mock_si, entity_name="fake_vcenter"
3538             )
3539         self.assertEqual(
3540             excinfo.exception.strerror,
3541             "Unexpected return. Expect only a single assignment",
3542         )
3543     def test_wrong_vcenter_name(self):
3544         self.mock_lic_assign_mgr.QueryAssignedLicenses = MagicMock(
3545             return_value=[MagicMock(entityDisplayName="bad_vcenter")]
3546         )
3547         with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
3548             salt.utils.vmware.get_assigned_licenses(
3549                 self.mock_si, entity_name="fake_vcenter"
3550             )
3551         self.assertEqual(
3552             excinfo.exception.strerror,
3553             "Got license assignment info for a different vcenter",
3554         )
3555     def test_query_assigned_licenses_vcenter(self):
3556         with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
3557             salt.utils.vmware.get_assigned_licenses(
3558                 self.mock_si, entity_name="fake_vcenter"
3559             )
3560         self.mock_query_assigned_licenses.assert_called_once_with(self.mock_ent_id)
3561     def test_query_assigned_licenses_with_entity(self):
3562         salt.utils.vmware.get_assigned_licenses(
3563             self.mock_si, self.mock_entity_ref, "fake_entity_name"
3564         )
3565         self.mock_query_assigned_licenses.assert_called_once_with(self.mock_moid)
3566     def test_query_assigned_licenses_raises_no_permission(self):
3567         exc = vim.fault.NoPermission()
3568         exc.privilegeId = "Fake privilege"
3569         self.mock_lic_assign_mgr.QueryAssignedLicenses = MagicMock(side_effect=exc)
3570         with self.assertRaises(VMwareApiError) as excinfo:
3571             salt.utils.vmware.get_assigned_licenses(
3572                 self.mock_si, self.mock_entity_ref, "fake_entity_name"
3573             )
3574         self.assertEqual(
3575             excinfo.exception.strerror,
3576             "Not enough permissions. Required privilege: Fake privilege",
3577         )
3578     def test_query_assigned_licenses_raises_vim_fault(self):
3579         exc = vim.fault.VimFault()
3580         exc.msg = "VimFault msg"
3581         self.mock_lic_assign_mgr.QueryAssignedLicenses = MagicMock(side_effect=exc)
3582         with self.assertRaises(VMwareApiError) as excinfo:
3583             salt.utils.vmware.get_assigned_licenses(
3584                 self.mock_si, self.mock_entity_ref, "fake_entity_name"
3585             )
3586         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3587     def test_query_assigned_licenses_raises_runtime_fault(self):
3588         exc = vmodl.RuntimeFault()
3589         exc.msg = "RuntimeFault msg"
3590         self.mock_lic_assign_mgr.QueryAssignedLicenses = MagicMock(side_effect=exc)
3591         with self.assertRaises(VMwareRuntimeError) as excinfo:
3592             salt.utils.vmware.get_assigned_licenses(
3593                 self.mock_si, self.mock_entity_ref, "fake_entity_name"
3594             )
3595         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3596     def test_valid_assignments(self):
3597         ret = salt.utils.vmware.get_assigned_licenses(
3598             self.mock_si, self.mock_entity_ref, "fake_entity_name"
3599         )
3600         self.assertEqual(ret, self.mock_assignments)
3601 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3602 class AssignLicenseTestCase(TestCase):
3603     def setUp(self):
3604         self.mock_ent_id = MagicMock()
3605         self.mock_si = MagicMock()
3606         type(self.mock_si.content.about).instanceUuid = PropertyMock(
3607             return_value=self.mock_ent_id
3608         )
3609         self.mock_lic_key = MagicMock()
3610         self.mock_moid = MagicMock()
3611         self.prop_mock_moid = PropertyMock(return_value=self.mock_moid)
3612         self.mock_entity_ref = MagicMock()
3613         type(self.mock_entity_ref)._moId = self.prop_mock_moid
3614         self.mock_license = MagicMock()
3615         self.mock_update_assigned_license = MagicMock(return_value=self.mock_license)
3616         self.mock_lic_assign_mgr = MagicMock(
3617             UpdateAssignedLicense=self.mock_update_assigned_license
3618         )
3619         patches = (
3620             (
3621                 "salt.utils.vmware.get_license_assignment_manager",
3622                 MagicMock(return_value=self.mock_lic_assign_mgr),
3623             ),
3624         )
3625         for mod, mock in patches:
3626             patcher = patch(mod, mock)
3627             patcher.start()
3628             self.addCleanup(patcher.stop)
3629     def test_no_license_assignment_manager_passed_in(self):
3630         mock_get_license_assign_manager = MagicMock()
3631         with patch(
3632             "salt.utils.vmware.get_license_assignment_manager",
3633             mock_get_license_assign_manager,
3634         ):
3635             salt.utils.vmware.assign_license(
3636                 self.mock_si,
3637                 self.mock_lic_key,
3638                 "fake_license_name",
3639                 self.mock_entity_ref,
3640                 "fake_entity_name",
3641             )
3642         mock_get_license_assign_manager.assert_called_once_with(self.mock_si)
3643     def test_license_assignment_manager_passed_in(self):
3644         mock_get_license_assign_manager = MagicMock()
3645         with patch(
3646             "salt.utils.vmware.get_license_assignment_manager",
3647             mock_get_license_assign_manager,
3648         ):
3649             salt.utils.vmware.assign_license(
3650                 self.mock_si,
3651                 self.mock_lic_key,
3652                 "fake_license_name",
3653                 self.mock_entity_ref,
3654                 "fake_entity_name",
3655                 license_assignment_manager=self.mock_lic_assign_mgr,
3656             )
3657         self.assertEqual(mock_get_license_assign_manager.call_count, 0)
3658         self.assertEqual(self.mock_update_assigned_license.call_count, 1)
3659     def test_entity_name(self):
3660         mock_trace = MagicMock()
3661         with patch("salt._logging.impl.SaltLoggingClass.trace", mock_trace):
3662             salt.utils.vmware.assign_license(
3663                 self.mock_si,
3664                 self.mock_lic_key,
3665                 "fake_license_name",
3666                 self.mock_entity_ref,
3667                 "fake_entity_name",
3668             )
3669         mock_trace.assert_called_once_with(
3670             "Assigning license to '%s'", "fake_entity_name"
3671         )
3672     def test_instance_uuid(self):
3673         mock_instance_uuid_prop = PropertyMock()
3674         type(self.mock_si.content.about).instanceUuid = mock_instance_uuid_prop
3675         self.mock_lic_assign_mgr.UpdateAssignedLicense = MagicMock(
3676             return_value=[MagicMock(entityDisplayName="fake_vcenter")]
3677         )
3678         salt.utils.vmware.assign_license(
3679             self.mock_si,
3680             self.mock_lic_key,
3681             "fake_license_name",
3682             entity_name="fake_entity_name",
3683         )
3684         self.assertEqual(mock_instance_uuid_prop.call_count, 1)
3685     def test_instance_uuid_raises_no_permission(self):
3686         exc = vim.fault.NoPermission()
3687         exc.privilegeId = "Fake privilege"
3688         type(self.mock_si.content.about).instanceUuid = PropertyMock(side_effect=exc)
3689         with self.assertRaises(VMwareApiError) as excinfo:
3690             salt.utils.vmware.assign_license(
3691                 self.mock_si,
3692                 self.mock_lic_key,
3693                 "fake_license_name",
3694                 entity_name="fake_entity_name",
3695             )
3696         self.assertEqual(
3697             excinfo.exception.strerror,
3698             "Not enough permissions. Required privilege: Fake privilege",
3699         )
3700     def test_instance_uuid_raises_vim_fault(self):
3701         exc = vim.fault.VimFault()
3702         exc.msg = "VimFault msg"
3703         type(self.mock_si.content.about).instanceUuid = PropertyMock(side_effect=exc)
3704         with self.assertRaises(VMwareApiError) as excinfo:
3705             salt.utils.vmware.assign_license(
3706                 self.mock_si,
3707                 self.mock_lic_key,
3708                 "fake_license_name",
3709                 entity_name="fake_entity_name",
3710             )
3711         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3712     def test_instance_uuid_raises_runtime_fault(self):
3713         exc = vmodl.RuntimeFault()
3714         exc.msg = "RuntimeFault msg"
3715         type(self.mock_si.content.about).instanceUuid = PropertyMock(side_effect=exc)
3716         with self.assertRaises(VMwareRuntimeError) as excinfo:
3717             salt.utils.vmware.assign_license(
3718                 self.mock_si,
3719                 self.mock_lic_key,
3720                 "fake_license_name",
3721                 entity_name="fake_entity_name",
3722             )
3723         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3724     def test_update_assigned_licenses_vcenter(self):
3725         salt.utils.vmware.assign_license(
3726             self.mock_si,
3727             self.mock_lic_key,
3728             "fake_license_name",
3729             entity_name="fake_entity_name",
3730         )
3731         self.mock_update_assigned_license.assert_called_once_with(
3732             self.mock_ent_id, self.mock_lic_key, "fake_license_name"
3733         )
3734     def test_update_assigned_licenses_call_with_entity(self):
3735         salt.utils.vmware.assign_license(
3736             self.mock_si,
3737             self.mock_lic_key,
3738             "fake_license_name",
3739             self.mock_entity_ref,
3740             "fake_entity_name",
3741         )
3742         self.mock_update_assigned_license.assert_called_once_with(
3743             self.mock_moid, self.mock_lic_key, "fake_license_name"
3744         )
3745     def test_update_assigned_licenses_raises_no_permission(self):
3746         exc = vim.fault.NoPermission()
3747         exc.privilegeId = "Fake privilege"
3748         self.mock_lic_assign_mgr.UpdateAssignedLicense = MagicMock(side_effect=exc)
3749         with self.assertRaises(VMwareApiError) as excinfo:
3750             salt.utils.vmware.assign_license(
3751                 self.mock_si,
3752                 self.mock_lic_key,
3753                 "fake_license_name",
3754                 self.mock_entity_ref,
3755                 "fake_entity_name",
3756             )
3757         self.assertEqual(
3758             excinfo.exception.strerror,
3759             "Not enough permissions. Required privilege: Fake privilege",
3760         )
3761     def test_update_assigned_licenses_raises_vim_fault(self):
3762         exc = vim.fault.VimFault()
3763         exc.msg = "VimFault msg"
3764         self.mock_lic_assign_mgr.UpdateAssignedLicense = MagicMock(side_effect=exc)
3765         with self.assertRaises(VMwareApiError) as excinfo:
3766             salt.utils.vmware.assign_license(
3767                 self.mock_si,
3768                 self.mock_lic_key,
3769                 "fake_license_name",
3770                 self.mock_entity_ref,
3771                 "fake_entity_name",
3772             )
3773         self.assertEqual(excinfo.exception.strerror, "VimFault msg")
3774     def test_update_assigned_licenses_raises_runtime_fault(self):
3775         exc = vmodl.RuntimeFault()
3776         exc.msg = "RuntimeFault msg"
3777         self.mock_lic_assign_mgr.UpdateAssignedLicense = MagicMock(side_effect=exc)
3778         with self.assertRaises(VMwareRuntimeError) as excinfo:
3779             salt.utils.vmware.assign_license(
3780                 self.mock_si,
3781                 self.mock_lic_key,
3782                 "fake_license_name",
3783                 self.mock_entity_ref,
3784                 "fake_entity_name",
3785             )
3786         self.assertEqual(excinfo.exception.strerror, "RuntimeFault msg")
3787     def test_valid_assignments(self):
3788         ret = salt.utils.vmware.assign_license(
3789             self.mock_si,
3790             self.mock_lic_key,
3791             "fake_license_name",
3792             self.mock_entity_ref,
3793             "fake_entity_name",
3794         )
3795         self.assertEqual(ret, self.mock_license)
3796 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3797 class GetStorageSystemTestCase(TestCase):
3798     def setUp(self):
3799         self.mock_si = MagicMock(content=MagicMock())
3800         self.mock_host_ref = MagicMock()
3801         self.mock_get_managed_object_name = MagicMock(return_value="fake_host")
3802         self.mock_traversal_spec = MagicMock()
3803         self.mock_obj = MagicMock()
3804         self.mock_get_mors = MagicMock(return_value=[{"object": self.mock_obj}])
3805         patches = (
3806             (
3807                 "salt.utils.vmware.get_managed_object_name",
3808                 self.mock_get_managed_object_name,
3809             ),
3810             ("salt.utils.vmware.get_mors_with_properties", self.mock_get_mors),
3811             (
3812                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
3813                 MagicMock(return_value=self.mock_traversal_spec),
3814             ),
3815         )
3816         for mod, mock in patches:
3817             patcher = patch(mod, mock)
3818             patcher.start()
3819             self.addCleanup(patcher.stop)
3820     def tearDown(self):
3821         for attr in (
3822             "mock_si",
3823             "mock_host_ref",
3824             "mock_get_managed_object_name",
3825             "mock_traversal_spec",
3826             "mock_obj",
3827         ):
3828             delattr(self, attr)
3829     def test_no_hostname_argument(self):
3830         salt.utils.vmware.get_storage_system(self.mock_si, self.mock_host_ref)
3831         self.mock_get_managed_object_name.assert_called_once_with(self.mock_host_ref)
3832     def test_hostname_argument(self):
3833         salt.utils.vmware.get_storage_system(
3834             self.mock_si, self.mock_host_ref, hostname="fake_host"
3835         )
3836         self.assertEqual(self.mock_get_managed_object_name.call_count, 0)
3837     def test_traversal_spec(self):
3838         mock_traversal_spec = MagicMock(return_value=[{"object": self.mock_obj}])
3839         with patch(
3840             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
3841             mock_traversal_spec,
3842         ):
3843             salt.utils.vmware.get_storage_system(self.mock_si, self.mock_host_ref)
3844         mock_traversal_spec.assert_called_once_with(
3845             path="configManager.storageSystem", type=vim.HostSystem, skip=False
3846         )
3847     def test_get_mors_with_properties(self):
3848         salt.utils.vmware.get_storage_system(self.mock_si, self.mock_host_ref)
3849         self.mock_get_mors.assert_called_once_with(
3850             self.mock_si,
3851             vim.HostStorageSystem,
3852             property_list=["systemFile"],
3853             container_ref=self.mock_host_ref,
3854             traversal_spec=self.mock_traversal_spec,
3855         )
3856     def test_empty_mors_result(self):
3857         with patch(
3858             "salt.utils.vmware.get_mors_with_properties", MagicMock(return_value=[])
3859         ):
3860             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
3861                 salt.utils.vmware.get_storage_system(self.mock_si, self.mock_host_ref)
3862         self.assertEqual(
3863             excinfo.exception.strerror,
3864             "Host's 'fake_host' storage system was not retrieved",
3865         )
3866     def test_valid_mors_result(self):
3867         res = salt.utils.vmware.get_storage_system(self.mock_si, self.mock_host_ref)
3868         self.assertEqual(res, self.mock_obj)
3869 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
3870 class GetDatastoresTestCase(TestCase):
3871     def setUp(self):
3872         self.mock_si = MagicMock()
3873         self.mock_reference = MagicMock(spec=vim.HostSystem)
3874         self.mock_mount_infos = [
3875             MagicMock(
3876                 volume=MagicMock(
3877                     spec=vim.HostVmfsVolume, extent=[MagicMock(diskName="fake_disk2")]
3878                 )
3879             ),
3880             MagicMock(
3881                 volume=MagicMock(
3882                     spec=vim.HostVmfsVolume, extent=[MagicMock(diskName="fake_disk3")]
3883                 )
3884             ),
3885         ]
3886         self.mock_mount_infos[0].volume.name = "fake_ds2"
3887         self.mock_mount_infos[1].volume.name = "fake_ds3"
3888         self.mock_entries = [
3889             {"name": "fake_ds1", "object": MagicMock()},
3890             {"name": "fake_ds2", "object": MagicMock()},
3891             {"name": "fake_ds3", "object": MagicMock()},
3892         ]
3893         self.mock_storage_system = MagicMock()
3894         self.mock_get_storage_system = MagicMock(return_value=self.mock_storage_system)
3895         self.mock_get_managed_object_name = MagicMock(return_value="fake_host")
3896         self.mock_traversal_spec = MagicMock()
3897         patches = (
3898             (
3899                 "salt.utils.vmware.get_managed_object_name",
3900                 self.mock_get_managed_object_name,
3901             ),
3902             ("salt.utils.vmware.get_storage_system", self.mock_get_storage_system),
3903             (
3904                 "salt.utils.vmware.get_properties_of_managed_object",
3905                 MagicMock(
3906                     return_value={
3907                         "fileSystemVolumeInfo.mountInfo": self.mock_mount_infos
3908                     }
3909                 ),
3910             ),
3911             (
3912                 "salt.utils.vmware.get_mors_with_properties",
3913                 MagicMock(return_value=self.mock_entries),
3914             ),
3915             (
3916                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
3917                 MagicMock(return_value=self.mock_traversal_spec),
3918             ),
3919         )
3920         for mod, mock in patches:
3921             patcher = patch(mod, mock)
3922             patcher.start()
3923             self.addCleanup(patcher.stop)
3924     def tearDown(self):
3925         for attr in (
3926             "mock_si",
3927             "mock_reference",
3928             "mock_storage_system",
3929             "mock_get_storage_system",
3930             "mock_mount_infos",
3931             "mock_entries",
3932             "mock_get_managed_object_name",
3933             "mock_traversal_spec",
3934         ):
3935             delattr(self, attr)
3936     def test_get_reference_name_call(self):
3937         salt.utils.vmware.get_datastores(self.mock_si, self.mock_reference)
3938         self.mock_get_managed_object_name.assert_called_once_with(self.mock_reference)
3939     def test_get_no_datastores(self):
3940         res = salt.utils.vmware.get_datastores(self.mock_si, self.mock_reference)
3941         self.assertEqual(res, [])
3942     def test_get_storage_system_call(self):
3943         salt.utils.vmware.get_datastores(
3944             self.mock_si, self.mock_reference, backing_disk_ids=["fake_disk1"]
3945         )
3946         self.mock_get_storage_system.assert_called_once_with(
3947             self.mock_si, self.mock_reference, "fake_host"
3948         )
3949     def test_get_mount_info_call(self):
3950         mock_get_properties_of_managed_object = MagicMock()
3951         with patch(
3952             "salt.utils.vmware.get_properties_of_managed_object",
3953             mock_get_properties_of_managed_object,
3954         ):
3955             salt.utils.vmware.get_datastores(
3956                 self.mock_si, self.mock_reference, backing_disk_ids=["fake_disk1"]
3957             )
3958         mock_get_properties_of_managed_object.assert_called_once_with(
3959             self.mock_storage_system, ["fileSystemVolumeInfo.mountInfo"]
3960         )
3961     def test_backing_disks_no_mount_info(self):
3962         with patch(
3963             "salt.utils.vmware.get_properties_of_managed_object",
3964             MagicMock(return_value={}),
3965         ):
3966             res = salt.utils.vmware.get_datastores(
3967                 self.mock_si, self.mock_reference, backing_disk_ids=["fake_disk_id"]
3968             )
3969         self.assertEqual(res, [])
3970     def test_host_traversal_spec(self):
3971         mock_traversal_spec_init = MagicMock()
3972         with patch(
3973             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
3974             mock_traversal_spec_init,
3975         ):
3976             salt.utils.vmware.get_datastores(
3977                 self.mock_si, self.mock_reference, get_all_datastores=True
3978             )
3979         mock_traversal_spec_init.assert_called_once_with(
3980             name="host_datastore_traversal",
3981             path="datastore",
3982             skip=False,
3983             type=vim.HostSystem,
3984         )
3985     def test_cluster_traversal_spec(self):
3986         mock_traversal_spec_init = MagicMock()
3987         mock_reference = MagicMock(spec=vim.ClusterComputeResource)
3988         with patch(
3989             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
3990             mock_traversal_spec_init,
3991         ):
3992             salt.utils.vmware.get_datastores(
3993                 self.mock_si, mock_reference, get_all_datastores=True
3994             )
3995         mock_traversal_spec_init.assert_called_once_with(
3996             name="cluster_datastore_traversal",
3997             path="datastore",
3998             skip=False,
3999             type=vim.ClusterComputeResource,
4000         )
4001     def test_datacenter_traversal_spec(self):
4002         mock_traversal_spec_init = MagicMock()
4003         mock_reference = MagicMock(spec=vim.Datacenter)
4004         with patch(
4005             "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
4006             mock_traversal_spec_init,
4007         ):
4008             salt.utils.vmware.get_datastores(
4009                 self.mock_si, mock_reference, get_all_datastores=True
4010             )
4011         mock_traversal_spec_init.assert_called_once_with(
4012             name="datacenter_datastore_traversal",
4013             path="datastore",
4014             skip=False,
4015             type=vim.Datacenter,
4016         )
4017     def test_root_folder_traversal_spec(self):
4018         mock_traversal_spec_init = MagicMock(return_value="traversal")
4019         mock_reference = MagicMock(spec=vim.Folder)
4020         with patch(
4021             "salt.utils.vmware.get_managed_object_name",
4022             MagicMock(side_effect=["fake_host", "Datacenters"]),
4023         ):
4024             with patch(
4025                 "salt.utils.vmware.vmodl.query.PropertyCollector.TraversalSpec",
4026                 mock_traversal_spec_init,
4027             ):
4028                 salt.utils.vmware.get_datastores(
4029                     self.mock_si, mock_reference, get_all_datastores=True
4030                 )
4031         mock_traversal_spec_init.assert_has_calls(
4032             [
4033                 call(path="datastore", skip=False, type=vim.Datacenter),
4034                 call(
4035                     path="childEntity",
4036                     selectSet=["traversal"],
4037                     skip=False,
4038                     type=vim.Folder,
4039                 ),
4040             ]
4041         )
4042     def test_unsupported_reference_type(self):
4043         class FakeClass:
4044             pass
4045         mock_reference = MagicMock(spec=FakeClass)
4046         with self.assertRaises(ArgumentValueError) as excinfo:
4047             salt.utils.vmware.get_datastores(
4048                 self.mock_si, mock_reference, get_all_datastores=True
4049             )
4050         self.assertEqual(
4051             excinfo.exception.strerror, "Unsupported reference type 'FakeClass'"
4052         )
4053     def test_get_mors_with_properties(self):
4054         mock_get_mors_with_properties = MagicMock()
4055         with patch(
4056             "salt.utils.vmware.get_mors_with_properties", mock_get_mors_with_properties
4057         ):
4058             salt.utils.vmware.get_datastores(
4059                 self.mock_si, self.mock_reference, get_all_datastores=True
4060             )
4061         mock_get_mors_with_properties.assert_called_once_with(
4062             self.mock_si,
4063             object_type=vim.Datastore,
4064             property_list=["name"],
4065             container_ref=self.mock_reference,
4066             traversal_spec=self.mock_traversal_spec,
4067         )
4068     def test_get_all_datastores(self):
4069         res = salt.utils.vmware.get_datastores(
4070             self.mock_si, self.mock_reference, get_all_datastores=True
4071         )
4072         self.assertEqual(
4073             res,
4074             [
4075                 self.mock_entries[0]["object"],
4076                 self.mock_entries[1]["object"],
4077                 self.mock_entries[2]["object"],
4078             ],
4079         )
4080     def test_get_datastores_filtered_by_name(self):
4081         res = salt.utils.vmware.get_datastores(
4082             self.mock_si, self.mock_reference, datastore_names=["fake_ds1", "fake_ds2"]
4083         )
4084         self.assertEqual(
4085             res, [self.mock_entries[0]["object"], self.mock_entries[1]["object"]]
4086         )
4087     def test_get_datastores_filtered_by_backing_disk(self):
4088         res = salt.utils.vmware.get_datastores(
4089             self.mock_si,
4090             self.mock_reference,
4091             backing_disk_ids=["fake_disk2", "fake_disk3"],
4092         )
4093         self.assertEqual(
4094             res, [self.mock_entries[1]["object"], self.mock_entries[2]["object"]]
4095         )
4096     def test_get_datastores_filtered_by_both_name_and_backing_disk(self):
4097         res = salt.utils.vmware.get_datastores(
4098             self.mock_si,
4099             self.mock_reference,
4100             datastore_names=["fake_ds1"],
4101             backing_disk_ids=["fake_disk3"],
4102         )
4103         self.assertEqual(
4104             res, [self.mock_entries[0]["object"], self.mock_entries[2]["object"]]
4105         )
4106 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
4107 class RenameDatastoreTestCase(TestCase):
4108     def setUp(self):
4109         self.mock_ds_ref = MagicMock()
4110         self.mock_get_managed_object_name = MagicMock(return_value="fake_ds")
4111         patches = (
4112             (
4113                 "salt.utils.vmware.get_managed_object_name",
4114                 self.mock_get_managed_object_name,
4115             ),
4116         )
4117         for mod, mock in patches:
4118             patcher = patch(mod, mock)
4119             patcher.start()
4120             self.addCleanup(patcher.stop)
4121     def tearDown(self):
4122         for attr in ("mock_ds_ref", "mock_get_managed_object_name"):
4123             delattr(self, attr)
4124     def test_datastore_name_call(self):
4125         salt.utils.vmware.rename_datastore(self.mock_ds_ref, "fake_new_name")
4126         self.mock_get_managed_object_name.assert_called_once_with(self.mock_ds_ref)
4127     def test_rename_datastore_raise_no_permission(self):
4128         exc = vim.fault.NoPermission()
4129         exc.privilegeId = "Fake privilege"
4130         type(self.mock_ds_ref).RenameDatastore = MagicMock(side_effect=exc)
4131         with self.assertRaises(VMwareApiError) as excinfo:
4132             salt.utils.vmware.rename_datastore(self.mock_ds_ref, "fake_new_name")
4133         self.assertEqual(
4134             excinfo.exception.strerror,
4135             "Not enough permissions. Required privilege: Fake privilege",
4136         )
4137     def test_rename_datastore_raise_vim_fault(self):
4138         exc = vim.VimFault()
4139         exc.msg = "vim_fault"
4140         type(self.mock_ds_ref).RenameDatastore = MagicMock(side_effect=exc)
4141         with self.assertRaises(VMwareApiError) as excinfo:
4142             salt.utils.vmware.rename_datastore(self.mock_ds_ref, "fake_new_name")
4143         self.assertEqual(excinfo.exception.strerror, "vim_fault")
4144     def test_rename_datastore_raise_runtime_fault(self):
4145         exc = vmodl.RuntimeFault()
4146         exc.msg = "runtime_fault"
4147         type(self.mock_ds_ref).RenameDatastore = MagicMock(side_effect=exc)
4148         with self.assertRaises(VMwareRuntimeError) as excinfo:
4149             salt.utils.vmware.rename_datastore(self.mock_ds_ref, "fake_new_name")
4150         self.assertEqual(excinfo.exception.strerror, "runtime_fault")
4151     def test_rename_datastore(self):
4152         salt.utils.vmware.rename_datastore(self.mock_ds_ref, "fake_new_name")
4153         self.mock_ds_ref.RenameDatastore.assert_called_once_with("fake_new_name")
4154 class ConvertToKbTestCase(TestCase):
4155     def setUp(self):
4156         pass
4157     def test_gb_conversion_call(self):
4158         self.assertEqual(
4159             salt.utils.vmware.convert_to_kb("Gb", 10),
4160             {"size": int(10485760), "unit": "KB"},
4161         )
4162     def test_mb_conversion_call(self):
4163         self.assertEqual(
4164             salt.utils.vmware.convert_to_kb("Mb", 10),
4165             {"size": int(10240), "unit": "KB"},
4166         )
4167     def test_kb_conversion_call(self):
4168         self.assertEqual(
4169             salt.utils.vmware.convert_to_kb("Kb", 10), {"size": int(10), "unit": "KB"}
4170         )
4171     def test_conversion_bad_input_argument_fault(self):
4172         self.assertRaises(
4173             ArgumentValueError, salt.utils.vmware.convert_to_kb, "test", 10
4174         )
4175 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
4176 @patch("salt.utils.vmware.get_managed_object_name", MagicMock())
4177 @patch("salt.utils.vmware.wait_for_task", MagicMock())
4178 class CreateVirtualMachineTestCase(TestCase):
4179     def setUp(self):
4180         self.vm_name = "fake_vm"
4181         self.mock_task = MagicMock()
4182         self.mock_config_spec = MagicMock()
4183         self.mock_resourcepool_object = MagicMock()
4184         self.mock_host_object = MagicMock()
4185         self.mock_vm_create_task = MagicMock(return_value=self.mock_task)
4186         self.mock_folder_object = MagicMock(CreateVM_Task=self.mock_vm_create_task)
4187     def test_create_vm_pool_task_call(self):
4188         salt.utils.vmware.create_vm(
4189             self.vm_name,
4190             self.mock_config_spec,
4191             self.mock_folder_object,
4192             self.mock_resourcepool_object,
4193         )
4194         self.mock_vm_create_task.assert_called_once()
4195     def test_create_vm_host_task_call(self):
4196         salt.utils.vmware.create_vm(
4197             self.vm_name,
4198             self.mock_config_spec,
4199             self.mock_folder_object,
4200             self.mock_resourcepool_object,
4201             host_object=self.mock_host_object,
4202         )
4203         self.mock_vm_create_task.assert_called_once()
4204     def test_create_vm_raise_no_permission(self):
4205         exception = vim.fault.NoPermission()
4206         exception.msg = "vim.fault.NoPermission msg"
4207         self.mock_folder_object.CreateVM_Task = MagicMock(side_effect=exception)
4208         with self.assertRaises(VMwareApiError) as exc:
4209             salt.utils.vmware.create_vm(
4210                 self.vm_name,
4211                 self.mock_config_spec,
4212                 self.mock_folder_object,
4213                 self.mock_resourcepool_object,
4214             )
4215         self.assertEqual(
4216             exc.exception.strerror, "Not enough permissions. Required privilege: "
4217         )
4218     def test_create_vm_raise_vim_fault(self):
4219         exception = vim.fault.VimFault()
4220         exception.msg = "vim.fault.VimFault msg"
4221         self.mock_folder_object.CreateVM_Task = MagicMock(side_effect=exception)
4222         with self.assertRaises(VMwareApiError) as exc:
4223             salt.utils.vmware.create_vm(
4224                 self.vm_name,
4225                 self.mock_config_spec,
4226                 self.mock_folder_object,
4227                 self.mock_resourcepool_object,
4228             )
4229         self.assertEqual(exc.exception.strerror, "vim.fault.VimFault msg")
4230     def test_create_vm_raise_runtime_fault(self):
4231         exception = vmodl.RuntimeFault()
4232         exception.msg = "vmodl.RuntimeFault msg"
4233         self.mock_folder_object.CreateVM_Task = MagicMock(side_effect=exception)
4234         with self.assertRaises(VMwareRuntimeError) as exc:
4235             salt.utils.vmware.create_vm(
4236                 self.vm_name,
4237                 self.mock_config_spec,
4238                 self.mock_folder_object,
4239                 self.mock_resourcepool_object,
4240             )
4241         self.assertEqual(exc.exception.strerror, "vmodl.RuntimeFault msg")
4242     def test_create_vm_wait_for_task(self):
4243         mock_wait_for_task = MagicMock()
4244         with patch("salt.utils.vmware.wait_for_task", mock_wait_for_task):
4245             salt.utils.vmware.create_vm(
4246                 self.vm_name,
4247                 self.mock_config_spec,
4248                 self.mock_folder_object,
4249                 self.mock_resourcepool_object,
4250             )
4251         mock_wait_for_task.assert_called_once_with(
4252             self.mock_task, self.vm_name, "CreateVM Task", 10, "info"
4253         )
4254 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
4255 @patch("salt.utils.vmware.get_managed_object_name", MagicMock())
4256 @patch("salt.utils.vmware.wait_for_task", MagicMock())
4257 class RegisterVirtualMachineTestCase(TestCase):
4258     def setUp(self):
4259         self.vm_name = "fake_vm"
4260         self.mock_task = MagicMock()
4261         self.mock_vmx_path = MagicMock()
4262         self.mock_resourcepool_object = MagicMock()
4263         self.mock_host_object = MagicMock()
4264         self.mock_vm_register_task = MagicMock(return_value=self.mock_task)
4265         self.vm_folder_object = MagicMock(RegisterVM_Task=self.mock_vm_register_task)
4266         self.datacenter = MagicMock(vmFolder=self.vm_folder_object)
4267     def test_register_vm_pool_task_call(self):
4268         salt.utils.vmware.register_vm(
4269             self.datacenter,
4270             self.vm_name,
4271             self.mock_vmx_path,
4272             self.mock_resourcepool_object,
4273         )
4274         self.mock_vm_register_task.assert_called_once()
4275     def test_register_vm_host_task_call(self):
4276         salt.utils.vmware.register_vm(
4277             self.datacenter,
4278             self.vm_name,
4279             self.mock_vmx_path,
4280             self.mock_resourcepool_object,
4281             host_object=self.mock_host_object,
4282         )
4283         self.mock_vm_register_task.assert_called_once()
4284     def test_register_vm_raise_no_permission(self):
4285         exception = vim.fault.NoPermission()
4286         self.vm_folder_object.RegisterVM_Task = MagicMock(side_effect=exception)
4287         with self.assertRaises(VMwareApiError) as exc:
4288             salt.utils.vmware.register_vm(
4289                 self.datacenter,
4290                 self.vm_name,
4291                 self.mock_vmx_path,
4292                 self.mock_resourcepool_object,
4293             )
4294         self.assertEqual(
4295             exc.exception.strerror, "Not enough permissions. Required privilege: "
4296         )
4297     def test_register_vm_raise_vim_fault(self):
4298         exception = vim.fault.VimFault()
4299         exception.msg = "vim.fault.VimFault msg"
4300         self.vm_folder_object.RegisterVM_Task = MagicMock(side_effect=exception)
4301         with self.assertRaises(VMwareApiError) as exc:
4302             salt.utils.vmware.register_vm(
4303                 self.datacenter,
4304                 self.vm_name,
4305                 self.mock_vmx_path,
4306                 self.mock_resourcepool_object,
4307             )
4308         self.assertEqual(exc.exception.strerror, "vim.fault.VimFault msg")
4309     def test_register_vm_raise_runtime_fault(self):
4310         exception = vmodl.RuntimeFault()
4311         exception.msg = "vmodl.RuntimeFault msg"
4312         self.vm_folder_object.RegisterVM_Task = MagicMock(side_effect=exception)
4313         with self.assertRaises(VMwareRuntimeError) as exc:
4314             salt.utils.vmware.register_vm(
4315                 self.datacenter,
4316                 self.vm_name,
4317                 self.mock_vmx_path,
4318                 self.mock_resourcepool_object,
4319             )
4320         self.assertEqual(exc.exception.strerror, "vmodl.RuntimeFault msg")
4321     def test_register_vm_wait_for_task(self):
4322         mock_wait_for_task = MagicMock()
4323         with patch("salt.utils.vmware.wait_for_task", mock_wait_for_task):
4324             salt.utils.vmware.register_vm(
4325                 self.datacenter,
4326                 self.vm_name,
4327                 self.mock_vmx_path,
4328                 self.mock_resourcepool_object,
4329             )
4330         mock_wait_for_task.assert_called_once_with(
4331             self.mock_task, self.vm_name, "RegisterVM Task"
4332         )
4333 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
4334 @patch("salt.utils.vmware.get_managed_object_name", MagicMock())
4335 @patch("salt.utils.vmware.wait_for_task", MagicMock())
4336 class UpdateVirtualMachineTestCase(TestCase):
4337     def setUp(self):
4338         self.mock_task = MagicMock()
4339         self.mock_config_spec = MagicMock()
4340         self.mock_vm_update_task = MagicMock(return_value=self.mock_task)
4341         self.mock_vm_ref = MagicMock(ReconfigVM_Task=self.mock_vm_update_task)
4342     def test_update_vm_task_call(self):
4343         salt.utils.vmware.update_vm(self.mock_vm_ref, self.mock_config_spec)
4344         self.mock_vm_update_task.assert_called_once()
4345     def test_update_vm_raise_vim_fault(self):
4346         exception = vim.fault.VimFault()
4347         exception.msg = "vim.fault.VimFault"
4348         self.mock_vm_ref.ReconfigVM_Task = MagicMock(side_effect=exception)
4349         with self.assertRaises(VMwareApiError) as exc:
4350             salt.utils.vmware.update_vm(self.mock_vm_ref, self.mock_config_spec)
4351         self.assertEqual(exc.exception.strerror, "vim.fault.VimFault")
4352     def test_update_vm_raise_runtime_fault(self):
4353         exception = vmodl.RuntimeFault()
4354         exception.msg = "vmodl.RuntimeFault"
4355         self.mock_vm_ref.ReconfigVM_Task = MagicMock(side_effect=exception)
4356         with self.assertRaises(VMwareRuntimeError) as exc:
4357             salt.utils.vmware.update_vm(self.mock_vm_ref, self.mock_config_spec)
4358         self.assertEqual(exc.exception.strerror, "vmodl.RuntimeFault")
4359     def test_update_vm_wait_for_task(self):
4360         mock_wait_for_task = MagicMock()
4361         with patch(
4362             "salt.utils.vmware.get_managed_object_name", MagicMock(return_value="my_vm")
4363         ):
4364             with patch("salt.utils.vmware.wait_for_task", mock_wait_for_task):
4365                 salt.utils.vmware.update_vm(self.mock_vm_ref, self.mock_config_spec)
4366         mock_wait_for_task.assert_called_once_with(
4367             self.mock_task, "my_vm", "ReconfigureVM Task"
4368         )
4369 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
4370 @patch("salt.utils.vmware.get_managed_object_name", MagicMock())
4371 @patch("salt.utils.vmware.wait_for_task", MagicMock())
4372 class DeleteVirtualMachineTestCase(TestCase):
4373     def setUp(self):
4374         self.mock_task = MagicMock()
4375         self.mock_vm_destroy_task = MagicMock(return_value=self.mock_task)
4376         self.mock_vm_ref = MagicMock(Destroy_Task=self.mock_vm_destroy_task)
4377     def test_destroy_vm_task_call(self):
4378         salt.utils.vmware.delete_vm(self.mock_vm_ref)
4379         self.mock_vm_destroy_task.assert_called_once()
4380     def test_destroy_vm_raise_vim_fault(self):
4381         exception = vim.fault.VimFault()
4382         exception.msg = "vim.fault.VimFault"
4383         self.mock_vm_ref.Destroy_Task = MagicMock(side_effect=exception)
4384         with self.assertRaises(VMwareApiError) as exc:
4385             salt.utils.vmware.delete_vm(self.mock_vm_ref)
4386         self.assertEqual(exc.exception.strerror, "vim.fault.VimFault")
4387     def test_destroy_vm_raise_runtime_fault(self):
4388         exception = vmodl.RuntimeFault()
4389         exception.msg = "vmodl.RuntimeFault"
4390         self.mock_vm_ref.Destroy_Task = MagicMock(side_effect=exception)
4391         with self.assertRaises(VMwareRuntimeError) as exc:
4392             salt.utils.vmware.delete_vm(self.mock_vm_ref)
4393         self.assertEqual(exc.exception.strerror, "vmodl.RuntimeFault")
4394     def test_destroy_vm_wait_for_task(self):
4395         mock_wait_for_task = MagicMock()
4396         with patch(
4397             "salt.utils.vmware.get_managed_object_name", MagicMock(return_value="my_vm")
4398         ):
4399             with patch("salt.utils.vmware.wait_for_task", mock_wait_for_task):
4400                 salt.utils.vmware.delete_vm(self.mock_vm_ref)
4401         mock_wait_for_task.assert_called_once_with(
4402             self.mock_task, "my_vm", "Destroy Task"
4403         )
4404 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
4405 @patch("salt.utils.vmware.get_managed_object_name", MagicMock())
4406 class UnregisterVirtualMachineTestCase(TestCase):
4407     def setUp(self):
4408         self.mock_vm_unregister = MagicMock()
4409         self.mock_vm_ref = MagicMock(UnregisterVM=self.mock_vm_unregister)
4410     def test_unregister_vm_task_call(self):
4411         salt.utils.vmware.unregister_vm(self.mock_vm_ref)
4412         self.mock_vm_unregister.assert_called_once()
4413     def test_unregister_vm_raise_vim_fault(self):
4414         exception = vim.fault.VimFault()
4415         exception.msg = "vim.fault.VimFault"
4416         self.mock_vm_ref.UnregisterVM = MagicMock(side_effect=exception)
4417         with self.assertRaises(VMwareApiError) as exc:
4418             salt.utils.vmware.unregister_vm(self.mock_vm_ref)
4419         self.assertEqual(exc.exception.strerror, "vim.fault.VimFault")
4420     def test_unregister_vm_raise_runtime_fault(self):
4421         exception = vmodl.RuntimeFault()
4422         exception.msg = "vmodl.RuntimeFault"
4423         self.mock_vm_ref.UnregisterVM = MagicMock(side_effect=exception)
4424         with self.assertRaises(VMwareRuntimeError) as exc:
4425             salt.utils.vmware.unregister_vm(self.mock_vm_ref)
4426         self.assertEqual(exc.exception.strerror, "vmodl.RuntimeFault")
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
