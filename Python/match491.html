<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_composition.py &amp; _testing.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_composition.py &amp; _testing.py
      </h3>
<h1 align="center">
        4.0%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_composition.py (2.3006744%)<th>_testing.py (17.52266%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(1062-1069)<td><a href="#" name="0">(123-139)</a><td align="center"><font color="#ff0000">19</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(320-326)<td><a href="#" name="1">(31-38)</a><td align="center"><font color="#bb0000">14</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(705-707)<td><a href="#" name="2">(243-246)</a><td align="center"><font color="#ae0000">13</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(234-235)<td><a href="#" name="3">(41-46)</a><td align="center"><font color="#a10000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_composition.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import functools
2 from unittest import TestCase, main
3 import numpy as np
4 import numpy.testing as npt
5 import pandas.testing as pdt
6 from numpy.random import normal
7 import pandas as pd
8 import scipy
9 import copy
10 from skbio.util import assert_data_frame_almost_equal
11 from skbio.stats.composition import (closure, multiplicative_replacement,
12                                      perturb, perturb_inv, power, inner,
13                                      clr, clr_inv, ilr, ilr_inv, alr, alr_inv,
14                                      sbp_basis, _gram_schmidt_basis,
15                                      centralize, _holm_bonferroni, ancom)
16 class CompositionTests(TestCase):
17     def setUp(self):
18         self.cdata1 = np.array([[2, 2, 6],
19                                 [4, 4, 2]])
20         self.cdata2 = np.array([2, 2, 6])
21         self.cdata3 = np.array([[1, 2, 3, 0, 5],
22                                 [1, 0, 0, 4, 5],
23                                 [1, 2, 3, 4, 5]])
24         self.cdata4 = np.array([1, 2, 3, 0, 5])
25         self.cdata5 = [[2, 2, 6], [4, 4, 2]]
26         self.cdata6 = [[1, 2, 3, 0, 5],
27                        [1, 0, 0, 4, 5],
28                        [1, 2, 3, 4, 5]]
29         self.cdata7 = [np.exp(1), 1, 1]
30         self.cdata8 = [np.exp(1), 1, 1, 1]
31         self.ortho1 = [[0.44858053, 0.10905743, 0.22118102, 0.22118102],
32                        [0.3379924, 0.3379924, 0.0993132, 0.22470201],
33                        [0.3016453, 0.3016453, 0.3016453, 0.09506409]]
34         self.rdata1 = [[0.70710678, -0.70710678, 0., 0.],
35                        [0.40824829, 0.40824829, -0.81649658, 0.],
36                        [0.28867513, 0.28867513, 0.28867513, -0.8660254]]
37         self.bad1 = np.array([1, 2, -1])
38         self.bad2 = np.array([[[1, 2, 3, 0, 5]]])
39     def test_closure(self):
40         npt.assert_allclose(closure(self.cdata1),
41                             np.array([[.2, .2, .6],
42                                       [.4, .4, .2]]))
43         npt.assert_allclose(closure(self.cdata2),
44                             np.array([.2, .2, .6]))
45         npt.assert_allclose(closure(self.cdata5),
46                             np.array([[.2, .2, .6],
47                                       [.4, .4, .2]]))
48         with self.assertRaises(ValueError):
49             closure(self.bad1)
50         with self.assertRaises(ValueError):
51             closure(self.bad2)
52         closure(self.cdata2)
53         npt.assert_allclose(self.cdata2, np.array([2, 2, 6]))
54     def test_closure_warning(self):
55         with self.assertRaises(ValueError):
56             closure([0., 0., 0.])
57         with self.assertRaises(ValueError):
58             closure([[0., 0., 0.],
59                      [0., 5., 5.]])
60     def test_perturb(self):
61         pmat = perturb(closure(self.cdata1),
62                        closure(np.array([1, 1, 1])))
63         npt.assert_allclose(pmat,
64                             np.array([[.2, .2, .6],
65                                       [.4, .4, .2]]))
66         pmat = perturb(closure(self.cdata1),
67                        closure(np.array([10, 10, 20])))
68         npt.assert_allclose(pmat,
69                             np.array([[.125, .125, .75],
70                                       [1./3, 1./3, 1./3]]))
71         pmat = perturb(closure(self.cdata1),
72                        closure(np.array([10, 10, 20])))
73         npt.assert_allclose(pmat,
74                             np.array([[.125, .125, .75],
75                                       [1./3, 1./3, 1./3]]))
76         pmat = perturb(closure(self.cdata2),
77                        closure([1, 2, 1]))
78         npt.assert_allclose(pmat, np.array([1./6, 2./6, 3./6]))
79         pmat = perturb(closure(self.cdata5),
80                        closure(np.array([1, 1, 1])))
81         npt.assert_allclose(pmat,
82                             np.array([[.2, .2, .6],
83                                       [.4, .4, .2]]))
84         with self.assertRaises(ValueError):
85             perturb(closure(self.cdata5), self.bad1)
86         perturb(self.cdata2, [1, 2, 3])
87         npt.assert_allclose(self.cdata2, np.array([2, 2, 6]))
88     def test_power(self):
89         pmat = power(closure(self.cdata1), 2)
90         npt.assert_allclose(pmat,
91                             np.array([[.04/.44, .04/.44, .36/.44],
92                                       [.16/.36, .16/.36, .04/.36]]))
93         pmat = power(closure(self.cdata2), 2)
94         npt.assert_allclose(pmat, np.array([.04, .04, .36])/.44)
95         pmat = power(closure(self.cdata5), 2)
96         npt.assert_allclose(pmat,
97                             np.array([[.04/.44, .04/.44, .36/.44],
98                                       [.16/.36, .16/.36, .04/.36]]))
99         with self.assertRaises(ValueError):
100             power(self.bad1, 2)
101         power(self.cdata2, 4)
102         npt.assert_allclose(self.cdata2, np.array([2, 2, 6]))
103     def test_perturb_inv(self):
104         pmat = perturb_inv(closure(self.cdata1),
105                            closure([.1, .1, .1]))
106         imat = perturb(closure(self.cdata1),
107                        closure([10, 10, 10]))
108         npt.assert_allclose(pmat, imat)
109         pmat = perturb_inv(closure(self.cdata1),
110                            closure([1, 1, 1]))
111         npt.assert_allclose(pmat,
112                             closure([[.2, .2, .6],
113                                      [.4, .4, .2]]))
114         pmat = perturb_inv(closure(self.cdata5),
115                            closure([.1, .1, .1]))
116         imat = perturb(closure(self.cdata1), closure([10, 10, 10]))
117         npt.assert_allclose(pmat, imat)
118         with self.assertRaises(ValueError):
119             perturb_inv(closure(self.cdata1), self.bad1)
120         perturb_inv(self.cdata2, [1, 2, 3])
121         npt.assert_allclose(self.cdata2, np.array([2, 2, 6]))
122     def test_inner(self):
123         a = inner(self.cdata5, self.cdata5)
124         npt.assert_allclose(a, np.array([[0.80463264, -0.50766667],
125                                          [-0.50766667, 0.32030201]]))
126         b = inner(self.cdata7, self.cdata7)
127         npt.assert_allclose(b, 0.66666666666666663)
128         npt.assert_allclose(inner(self.ortho1, self.ortho1), np.identity(3),
129                             rtol=1e-04, atol=1e-06)
130         with self.assertRaises(ValueError):
131             inner(self.cdata1, self.cdata8)
132         inner(self.cdata1, self.cdata1)
133         npt.assert_allclose(self.cdata1,
134                             np.array([[2, 2, 6],
135                                       [4, 4, 2]]))
136     def test_multiplicative_replacement(self):
137         amat = multiplicative_replacement(closure(self.cdata3))
138         npt.assert_allclose(amat,
139                             np.array([[0.087273, 0.174545, 0.261818,
140                                        0.04, 0.436364],
141                                       [0.092, 0.04, 0.04, 0.368, 0.46],
142                                       [0.066667, 0.133333, 0.2,
143                                        0.266667, 0.333333]]),
144                             rtol=1e-5, atol=1e-5)
145         amat = multiplicative_replacement(closure(self.cdata4))
146         npt.assert_allclose(amat,
147                             np.array([0.087273, 0.174545, 0.261818,
148                                       0.04, 0.436364]),
149                             rtol=1e-5, atol=1e-5)
150         amat = multiplicative_replacement(closure(self.cdata6))
151         npt.assert_allclose(amat,
152                             np.array([[0.087273, 0.174545, 0.261818,
153                                        0.04, 0.436364],
154                                       [0.092, 0.04, 0.04, 0.368, 0.46],
155                                       [0.066667, 0.133333, 0.2,
156                                        0.266667, 0.333333]]),
157                             rtol=1e-5, atol=1e-5)
158         with self.assertRaises(ValueError):
159             multiplicative_replacement(self.bad1)
160         with self.assertRaises(ValueError):
161             multiplicative_replacement(self.bad2)
162         multiplicative_replacement(self.cdata4)
163         npt.assert_allclose(self.cdata4, np.array([1, 2, 3, 0, 5]))
164     def multiplicative_replacement_warning(self):
165         with self.assertRaises(ValueError):
166             multiplicative_replacement([0, 1, 2], delta=1)
167     def test_clr(self):
168         cmat = clr(closure(self.cdata1))
169         A = np.array([.2, .2, .6])
170         npt.assert_allclose(cmat,
171                             [np<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.log(A / np.exp(np.log(A).mean())),
172                              np.log(B / np.exp(</b></font>np.log(B).mean()))])
173         cmat = clr(closure(self.cdata2))
174         A = np.array([.2, .2, .6])
175         npt.assert_allclose(cmat,
176                             np.log(A / np.exp(np.log(A).mean())))
177         cmat = clr(closure(self.cdata5))
178         A = np.array([.2, .2, .6])
179         B = np.array([.4, .4, .2])
180         npt.assert_allclose(cmat,
181                             [np.log(A / np.exp(np.log(A).mean())),
182                              np.log(B / np.exp(np.log(B).mean()))])
183         with self.assertRaises(ValueError):
184             clr(self.bad1)
185         with self.assertRaises(ValueError):
186             clr(self.bad2)
187         clr(self.cdata2)
188         npt.assert_allclose(self.cdata2, np.array([2, 2, 6]))
189     def test_clr_inv(self):
190         npt.assert_allclose(clr_inv(self.rdata1), self.ortho1)
191         npt.assert_allclose(clr(clr_inv(self.rdata1)), self.rdata1,
192                             rtol=1e-4, atol=1e-5)
193         clr_inv(self.rdata1)
194         npt.assert_allclose(self.rdata1,
195                             np.array([[0.70710678, -0.70710678, 0., 0.],
196                                       [0.40824829, 0.40824829,
197                                        -0.81649658, 0.],
198                                       [0.28867513, 0.28867513,
199                                        0.28867513, -0.8660254]]))
200     def test_centralize(self):
201         cmat = centralize(closure(self.cdata1))
202         npt.assert_allclose(cmat,
203                             np.array([[0.22474487, 0.22474487, 0.55051026],
204                                       [0.41523958, 0.41523958, 0.16952085]]))
205         cmat = centralize(closure(self.cdata5))
206         npt.assert_allclose(cmat,
207                             np.array([[0.22474487, 0.22474487, 0.55051026],
208                                       [0.41523958, 0.41523958, 0.16952085]]))
209         with self.assertRaises(ValueError):
210             centralize(self.bad1)
211         with self.assertRaises(ValueError):
212             centralize(self.bad2)
213         centralize(self.cdata1)
214         npt.assert_allclose(self.cdata1,
215                             np.array([[2, 2, 6],
216                                       [4, 4, 2]]))
217     def test_ilr(self):
218         mat = closure(self.cdata7)
219         npt.assert_array_almost_equal(ilr(mat),
220                                       np.array([0.70710678, 0.40824829]))
221         npt.assert_allclose(ilr(self.ortho1), np.identity(3),
222                             rtol=1e-04, atol=1e-06)
223         with self.assertRaises(ValueError):
224             ilr(self.cdata1, basis=self.cdata1)
225         ilr(self.cdata1)
226         npt.assert_allclose(self.cdata1,
227                             np.array([[2, 2, 6],
228                                       [4, 4, 2]]))
229     def test_ilr_basis(self):
230         table = np.array([[1., 10.],
231                           [1.14141414, 9.90909091],
232                           [1.28282828, 9.81818182],
233                           [1.42424242, 9.72727273],
234                           [1.56565657, 9.63636364]])
235         basis = np.array([[0.80442968, 0.19557032]])
236         exp = np.array([np.log(1/10)*np.sqrt(1/2),
237                         np.log(1.14141414 / 9.90909091)*np.sqrt(1/2),
238                         np.log(1.28282828 / 9.81818182)*np<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.sqrt(1/2),
239                         np.log(1.42424242 / 9.72727273)*np.sqrt(1/2),
240                         np.log(1.56565657 / 9.63636364)*np.sqrt(1/2)])
241         npt.assert_allclose(res, exp)
242     def</b></font> test_ilr_basis_one_dimension_error(self):
243         table = np.array([[1., 10.],
244                           [1.14141414, 9.90909091],
245                           [1.28282828, 9.81818182],
246                           [1.42424242, 9.72727273],
247                           [1.56565657, 9.63636364]])
248         basis = np.array([0.80442968, 0.19557032])
249         with self.assertRaises(ValueError):
250             ilr(table, basis=basis)
251     def test_ilr_inv(self):
252         mat = closure(self.cdata7)
253         npt.assert_array_almost_equal(ilr_inv(ilr(mat)), mat)
254         npt.assert_allclose(ilr_inv(np.identity(3)), self.ortho1,
255                             rtol=1e-04, atol=1e-06)
256         with self.assertRaises(ValueError):
257             ilr_inv(self.cdata1, basis=self.cdata1)
258         ilr_inv(self.cdata1)
259         npt.assert_allclose(self.cdata1,
260                             np.array([[2, 2, 6],
261                                       [4, 4, 2]]))
262     def test_ilr_basis_isomorphism(self):
263         basis = np.array([[0.80442968, 0.19557032]])
264         table = np.array([[np.log(1/10)*np.sqrt(1/2),
265                            np.log(1.14141414 / 9.90909091)*np.sqrt(1/2),
266                            np.log(1.28282828 / 9.81818182)*np.sqrt(1/2),
267                            np.log(1.42424242 / 9.72727273)*np.sqrt(1/2),
268                            np.log(1.56565657 / 9.63636364)*np.sqrt(1/2)]]).T
269         res = ilr(ilr_inv(table, basis=basis), basis=basis)
270         npt.assert_allclose(res, table.squeeze())
271         table = np.array([[1., 10.],
272                           [1.14141414, 9.90909091],
273                           [1.28282828, 9.81818182],
274                           [1.42424242, 9.72727273],
275                           [1.56565657, 9.63636364]])
276         res = ilr_inv(np.atleast_2d(ilr(table, basis=basis)).T, basis=basis)
277         npt.assert_allclose(res, closure(table.squeeze()))
278     def test_ilr_inv_basis(self):
279         exp = closure(np.array([[1., 10.],
280                                 [1.14141414, 9.90909091],
281                                 [1.28282828, 9.81818182],
282                                 [1.42424242, 9.72727273],
283                                 [1.56565657, 9.63636364]]))
284         basis = np.array([[0.80442968, 0.19557032]])
285         table = np.array([[np.log(1/10)*np.sqrt(1/2),
286                            np.log(1.14141414 / 9.90909091)*np.sqrt(1/2),
287                            np.log(1.28282828 / 9.81818182)*np.sqrt(1/2),
288                            np.log(1.42424242 / 9.72727273)*np.sqrt(1/2),
289                            np.log(1.56565657 / 9.63636364)*np.sqrt(1/2)]]).T
290         res = ilr_inv(table, basis=basis)
291         npt.assert_allclose(res, exp)
292     def test_ilr_inv_basis_one_dimension_error(self):
293         basis = clr(np.array([[0.80442968, 0.19557032]]))
294         table = np.array([[np.log(1/10)*np.sqrt(1/2),
295                            np.log(1.14141414 / 9.90909091)*np.sqrt(1/2),
296                            np.log(1.28282828 / 9.81818182)*np.sqrt(1/2),
297                            np.log(1.42424242 / 9.72727273)*np.sqrt(1/2),
298                            np.log(1.56565657 / 9.63636364)*np.sqrt(1/2)]]).T
299         with self.assertRaises(ValueError):
300             ilr_inv(table, basis=basis)
301     def test_alr(self):
302         comp1 = closure(self.cdata1)
303         alr2d_byhand = np.array([np.log(comp1[:, 0]/comp1[:, 1]),
304                                  np.log(comp1[:, 2]/comp1[:, 1])]).T
305         alr2d_method = alr(comp1, denominator_idx=1)
306         npt.assert_allclose(alr2d_byhand, alr2d_method)
307         comp2 = closure(self.cdata2)
308         alr1d_byhand = np.array([np.log(comp2[0]/comp2[1]),
309                                  np.log(comp2[2]/comp2[1])]).T
310         alr1d_method = alr(comp2, denominator_idx=1)
311         npt.assert_allclose(alr1d_byhand, alr1d_method)
312         with self.assertRaises(ValueError):
313             alr(self.bad1)
314         with self.assertRaises(ValueError):
315             alr(self.bad2)
316         alr(self.cdata2)
317         npt.assert_allclose(self.cdata2, np.array([2, 2, 6]))
318     def test_alr_inv(self):
319         comp1 = closure(self.cdata1)
320         alr2d_byhand = np.array([np.log(comp1[:, 0]/comp1[:, 1]),
321                                  np.log(comp1[:, 2]/comp1[:, 1])]).T
322         alr2d_method = alr(comp1, denominator_idx=1)
323         B = 1/(1 + np.exp(alr2d_byhand[:, 0]) + np.exp(alr2d_byhand[:, 1]))
324         A = B * np.exp(alr2d_byhand[:, 0])
325         C = B * np.exp(alr2d_byhand[:, 1])
326         alrinv2d_byhand = np.column_stack((A, B, C))
327         alrinv2d_method = alr_inv(alr2d_method, denominator_idx=1)
328         npt.assert_allclose(alrinv2d_byhand, alrinv2d_method)
329         comp2 = closure(self.cdata2)
330         alr1d_byhand = np.array([np.log(comp2[0]/comp2[1]),
331                                  np.log(comp2[2]/comp2[1])]).T
332         alr1d_method = alr(comp2, denominator_idx=1)
333         B = 1/(1 + np.exp(alr1d_byhand[0]) + np.exp(alr1d_byhand[1]))
334         A = B * np.exp(alr1d_byhand[0])
335         C = B * np.exp(alr1d_byhand[1])
336         alrinv1d_byhand = np.column_stack((A, B, C))[0, :]
337         alrinv1d_method = alr_inv(alr1d_method, denominator_idx=1)
338         npt.assert_allclose(alrinv1d_byhand, alrinv1d_method)
339         alr_inv(self.rdata1)
340         npt.assert_allclose(self.rdata1,
341                             np.array([[0.70710678, -0.70710678, 0., 0.],
342                                       [0.40824829, 0.40824829,
343                                        -0.81649658, 0.],
344                                       [0.28867513, 0.28867513,
345                                        0.28867513, -0.8660254]]))
346         with self.assertRaises(ValueError):
347             alr_inv(self.bad2)
348     def test_sbp_basis_gram_schmidt(self):
349         gsbasis = clr_inv(_gram_schmidt_basis(5))
350         sbp = np.array([[1, -1, 0, 0, 0],
351                         [1, 1, -1, 0, 0],
352                         [1, 1, 1, -1, 0],
353                         [1, 1, 1, 1, -1]])
354         sbpbasis = sbp_basis(sbp)
355         npt.assert_allclose(gsbasis, sbpbasis)
356     def test_sbp_basis_elementwise(self):
357         sbp = np.array([[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -1],
358                         [1, 1, 1, 1, 1, 1, 1, -1, -1, -1, -1, 0],
359                         [1, 1, 1, 1, 1, 1, -1, 0, 0, 0, 0, 0],
360                         [1, 1, -1, -1, -1, 1, 0, 0, 0, 0, 0, 0],
361                         [1, -1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0],
362                         [1, 0, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0],
363                         [0, 0, 1, -1, -1, 0, 0, 0, 0, 0, 0, 0],
364                         [0, 0, 0, 1, -1, 0, 0, 0, 0, 0, 0, 0],
365                         [0, 0, 0, 0, 0, 0, 0, 1, -1, -1, 1, 0],
366                         [0, 0, 0, 0, 0, 0, 0, 1, 0, 0, -1, 0],
367                         [0, 0, 0, 0, 0, 0, 0, 0, 1, -1, 0, 0]])
368         sbpbasis = sbp_basis(sbp)
369         r = np.apply_along_axis(func1d=lambda x: np.sum(x &gt; 0),
370                                 axis=1, arr=sbp)
371         s = np.apply_along_axis(func1d=lambda x: np.sum(x &lt; 0),
372                                 axis=1, arr=sbp)
373         psi = np.zeros(sbp.shape)
374         for i in range(0, sbp.shape[0]):
375             for j in range(0, sbp.shape[1]):
376                 if sbp[i, j] == 1:
377                     psi[i, j] = np.sqrt(s[i]/(r[i]*(r[i]+s[i])))
378                 elif sbp[i, j] == -1:
379                     psi[i, j] = -np.sqrt(r[i]/(s[i]*(r[i]+s[i])))
380         basis_byhand = clr_inv(psi)
381         npt.assert_allclose(basis_byhand, sbpbasis)
382 class AncomTests(TestCase):
383     def setUp(self):
384         self.table1 = pd.DataFrame([
385             [10, 10, 10, 20, 20, 20],
386             [11, 12, 11, 21, 21, 21],
387             [10, 11, 10, 10, 11, 10],
388             [10, 11, 10, 10, 10, 9],
389             [10, 11, 10, 10, 10, 10],
390             [10, 11, 10, 10, 10, 11],
391             [10, 13, 10, 10, 10, 12]]).T
392         self.cats1 = pd.Series([0, 0, 0, 1, 1, 1])
393         D, L = 40, 80
394         np.random.seed(0)
395         self.table2 = np.vstack((np.concatenate((normal(10, 1, D),
396                                                  normal(200, 1, D))),
397                                  np.concatenate((normal(20, 1, D),
398                                                  normal(100000, 1, D))),
399                                  normal(10, 1, L),
400                                  normal(10, 1, L),
401                                  np.concatenate((normal(20, 1, D),
402                                                  normal(100000, 1, D))),
403                                  normal(10, 1, L),
404                                  normal(10, 1, L),
405                                  normal(10, 1, L),
406                                  normal(10, 1, L)))
407         self.table2 = np.absolute(self.table2)
408         self.table2 = pd.DataFrame(self.table2.astype(int).T)
409         self.cats2 = pd.Series([0]*D + [1]*D)
410         self.table3 = pd.DataFrame([
411             [10, 10.5, 10, 10, 10.5, 10.3],
412             [11, 11.5, 11, 11, 11.5, 11.3],
413             [10, 10.5, 10, 10, 10.5, 10.2],
414             [10, 10.5, 10, 10, 10.5, 10.3],
415             [10, 10.5, 10, 10, 10.5, 10.1],
416             [10, 10.5, 10, 10, 10.5, 10.6],
417             [10, 10.5, 10, 10, 10.5, 10.4]]).T
418         self.cats3 = pd.Series([0, 0, 0, 1, 1, 1])
419         D, L = 40, 120
420         np.random.seed(0)
421         self.table4 = np.vstack((np.concatenate((normal(10, 1, D),
422                                                  normal(200, 1, D),
423                                                  normal(400, 1, D))),
424                                  np.concatenate((normal(20, 1, D),
425                                                  normal(100000, 1, D),
426                                                  normal(2000, 1, D))),
427                                  normal(10, 1, L),
428                                  normal(10, 1, L),
429                                  np.concatenate((normal(20, 1, D),
430                                                  normal(100000, 1, D),
431                                                  normal(2000, 1, D))),
432                                  normal(10, 1, L),
433                                  normal(10, 1, L),
434                                  normal(10, 1, L),
435                                  normal(10, 1, L)))
436         self.table4 = np.absolute(self.table4)
437         self.table4 = pd.DataFrame(self.table4.astype(int).T)
438         self.cats4 = pd.Series([0]*D + [1]*D + [2]*D)
439         self.table5 = pd.DataFrame([
440             [11, 12, 21, 11, 21, 21],
441             [10, 11, 10, 10, 11, 10],
442             [10, 11, 10, 10, 10, 9],
443             [10, 11, 10, 10, 10, 10],
444             [10, 11, 10, 10, 10, 11],
445             [10, 10, 20, 9,  20, 20],
446             [10, 13, 10, 10, 10, 12]]).T
447         self.cats5 = pd.Series([0, 0, 1, 0, 1, 1])
448         self.table6 = pd.DataFrame([
449             [11, 12, 9, 11, 21, 21],
450             [10, 11, 10, 10, 11, 10],
451             [10, 11, 10, 10, 10, 9],
452             [10, 11, 10, 10, 10, 10],
453             [10, 11, 10, 10, 10, 11],
454             [10, 10, 10, 9,  20, 20],
455             [10, 13, 10, 10, 10, 12]]).T
456         self.cats6 = pd.Series([0, 0, 0, 0, 1, 1])
457         self.table7 = pd.DataFrame([
458             [11, 12, 9, 11, 21, 21],
459             [10, 11, 10, 10, 11, 10],
460             [10, 11, 10, 10, 10, 9],
461             [10, 11, 10, 10, 10, 10],
462             [10, 11, 10, 10, 10, 11],
463             [10, 10, 10, 9,  20, 20],
464             [10, 13, 10, 10, 10, 12]]).T
465         self.cats7 = pd.Series(['a', 'a', 'a', 'a', 'b', 'b'])
466         self.table8 = pd.DataFrame([
467             [10, 10, 10, 20, 20, 20],
468             [11, 12, 11, 21, 21, 21],
469             [10, 11, 10, 10, 11, 10],
470             [10, 11, 10, 10, 10, 9],
471             [10, 11, 10, 10, 10, 10],
472             [10, 11, 10, 10, 10, 11],
473             [10, 13, 10, 10, 10, 12]]).T
474         self.table8.index = ['a', 'b', 'c',
475                              'd', 'e', 'f']
476         self.cats8 = pd.Series([0, 0, 1, 0, 1, 1],
477                                index=['a', 'b', 'd',
478                                       'c', 'e', 'f'])
479         D, L = 40, 120
480         np.random.seed(0)
481         self.table9 = np.vstack((np.concatenate((normal(10, 1, D),
482                                                  normal(200, 1, D),
483                                                  normal(400, 1, D))),
484                                  np.concatenate((normal(200000, 1, D),
485                                                  normal(10, 1, D),
486                                                  normal(2000, 1, D))),
487                                  normal(10, 10, L),
488                                  normal(10, 10, L),
489                                  np.concatenate((normal(2000, 1, D),
490                                                  normal(100000, 1, D),
491                                                  normal(2000, 1, D))),
492                                  normal(10000, 1000, L),
493                                  normal(10, 10, L),
494                                  normal(10, 10, L),
495                                  normal(10, 10, L),
496                                  normal(10000, 1000, L),
497                                  normal(10, 10, L),
498                                  normal(10, 10, L),
499                                  normal(10, 10, L),
500                                  np.concatenate((normal(2000, 1, D),
501                                                  normal(100000, 1, D),
502                                                  normal(2000, 1, D))),
503                                  normal(10000, 1000, L),
504                                  normal(10, 10, L),
505                                  normal(10, 10, L),
506                                  normal(10, 10, L)))
507         self.table9 = np.absolute(self.table9)+1
508         self.table9 = pd.DataFrame(self.table9.astype(int).T)
509         self.cats9 = pd.Series([0]*D + [1]*D + [2]*D)
510         D, L = 40, 80
511         np.random.seed(0)
512         self.table10 = np.vstack((np.concatenate((normal(10, 1, D),
513                                                   normal(200, 1, D))),
514                                   np.concatenate((normal(10, 1, D),
515                                                   normal(200, 1, D))),
516                                   np.concatenate((normal(20, 10, D),
517                                                   normal(100, 10, D))),
518                                   normal(10, 1, L),
519                                   np.concatenate((normal(200, 100, D),
520                                                   normal(100000, 100, D))),
521                                   np.concatenate((normal(200000, 100, D),
522                                                   normal(300, 100, D))),
523                                   np.concatenate((normal(200000, 100, D),
524                                                   normal(300, 100, D))),
525                                   np.concatenate((normal(20, 20, D),
526                                                   normal(40, 10, D))),
527                                   np.concatenate((normal(20, 20, D),
528                                                   normal(40, 10, D))),
529                                   np.concatenate((normal(20, 20, D),
530                                                   normal(40, 10, D))),
531                                   normal(100, 10, L),
532                                   normal(100, 10, L),
533                                   normal(1000, 10, L),
534                                   normal(1000, 10, L),
535                                   normal(10, 10, L),
536                                   normal(10, 10, L),
537                                   normal(10, 10, L),
538                                   normal(10, 10, L)))
539         self.table10 = np.absolute(self.table10) + 1
540         self.table10 = pd.DataFrame(self.table10.astype(int).T)
541         self.cats10 = pd.Series([0]*D + [1]*D)
542         self.bad1 = pd.DataFrame(np.array([
543             [10, 10, 10, 20, 20, 0],
544             [11, 11, 11, 21, 21, 21],
545             [10, 10, 10, 10, 10, 10],
546             [10, 10, 10, 10, 10, 10],
547             [10, 10, 10, 10, 10, 10],
548             [10, 10, 10, 10, 10, 10],
549             [10, 10, 10, 10, 10, 10]]).T)
550         self.bad2 = pd.DataFrame(np.array([
551             [10, 10, 10, 20, 20, 1],
552             [11, 11, 11, 21, 21, 21],
553             [10, 10, 10, 10, 10, 10],
554             [10, 10, 10, 10, 10, 10],
555             [10, 10, 10, 10, 10, 10],
556             [10, 10, 10, 10, 10, -1],
557             [10, 10, 10, 10, 10, 10]]).T)
558         self.bad3 = pd.DataFrame(np.array([
559             [10, 10, 10, 20, 20, 1],
560             [11, 11, 11, 21, 21, 21],
561             [10, 10, 10, 10, 10, 10],
562             [10, 10, 10, 10, 10, 10],
563             [10, 10, 10, 10, 10, 10],
564             [10, 10, 10, 10, 10, 10]]).T)
565         self.badcats1 = pd.Series([0, 0, 0, 1, np.nan, 1])
566         self.badcats2 <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= pd.Series([0, 0, 0, 0, 0, 0])
567         self.badcats3 = pd.Series([0, 0, 1, 1])
568         self.badcats4 = pd.Series(</b></font>range(len(self.table1)))
569         self.badcats5 = pd.Series([1]*len(self.table1))
570     def test_ancom_basic_counts(self):
571         test_table = pd.DataFrame(self.table1)
572         original_table = copy.deepcopy(test_table)
573         test_cats = pd.Series(self.cats1)
574         original_cats = copy.deepcopy(test_cats)
575         result = ancom(test_table,
576                        test_cats,
577                        multiple_comparisons_correction=None)
578         assert_data_frame_almost_equal(original_table, test_table)
579         pdt.assert_series_equal(original_cats, test_cats)
580         exp = pd.DataFrame(
581             {'W': np.array([5, 5, 2, 2, 2, 2, 2]),
582              'Reject null hypothesis': np.array([True, True, False, False,
583                                                  False, False, False],
584                                                 dtype=bool)})
585         assert_data_frame_almost_equal(result[0], exp)
586     def test_ancom_percentiles(self):
587         table = pd.DataFrame([[12, 11],
588                               [9, 11],
589                               [1, 11],
590                               [22, 100],
591                               [20, 53],
592                               [23, 1]],
593                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
594                              columns=['b1', 'b2'])
595         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
596                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
597         percentiles = [0.0, 25.0, 50.0, 75.0, 100.0]
598         groups = ['a', 'b']
599         tuples = [(p, g) for g in groups for p in percentiles]
600         exp_mi = pd.MultiIndex.from_tuples(tuples,
601                                            names=['Percentile', 'Group'])
602         exp_data = np.array(
603             [[1.0, 11.0], [5.0, 11.0], [9.0, 11.0], [10.5, 11.0], [12.0, 11.0],
604              [20.0, 1.0], [21.0, 27.0], [22.0, 53.0], [22.5, 76.5],
605              [23.0, 100.0]])
606         exp = pd.DataFrame(exp_data.T, columns=exp_mi, index=['b1', 'b2'])
607         result = ancom(table, grouping)[1]
608         assert_data_frame_almost_equal(result, exp)
609     def test_ancom_percentiles_alt_categories(self):
610         table = pd.DataFrame([[12],
611                               [9],
612                               [1],
613                               [22],
614                               [20],
615                               [23]],
616                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
617                              columns=['b1'])
618         grouping = pd.Series(['a', 'a', 'c', 'b', 'b', 'c'],
619                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
620         percentiles = [0.0, 25.0, 50.0, 75.0, 100.0]
621         groups = ['a', 'b', 'c']
622         tuples = [(p, g) for g in groups for p in percentiles]
623         exp_mi = pd.MultiIndex.from_tuples(tuples,
624                                            names=['Percentile', 'Group'])
625         exp_data = np.array([[9.0], [9.75], [10.5], [11.25], [12.0],  # a
626                              [20.0], [20.5], [21.0], [21.5], [22.0],  # b
627                              [1.0], [6.5], [12.0], [17.5], [23.0]])   # c
628         exp = pd.DataFrame(exp_data.T, columns=exp_mi, index=['b1'])
629         result = ancom(table, grouping, percentiles=percentiles)[1]
630         assert_data_frame_almost_equal(result, exp)
631     def test_ancom_alt_percentiles(self):
632         table = pd.DataFrame([[12],
633                               [9],
634                               [1],
635                               [22],
636                               [20],
637                               [23]],
638                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
639                              columns=['b1'])
640         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
641                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
642         percentiles = [42.0, 50.0]
643         groups = ['a', 'b']
644         tuples = [(p, g) for g in groups for p in percentiles]
645         exp_mi = pd.MultiIndex.from_tuples(tuples,
646                                            names=['Percentile', 'Group'])
647         exp_data = np.array([[7.71999999], [9.0],  # a
648                              [21.68], [22.0]])     # b
649         exp = pd.DataFrame(exp_data.T, columns=exp_mi, index=['b1'])
650         result = ancom(table, grouping, percentiles=percentiles)[1]
651         assert_data_frame_almost_equal(result, exp)
652     def test_ancom_percentiles_swapped(self):
653         table = pd.DataFrame([[12],
654                               [9],
655                               [1],
656                               [22],
657                               [20],
658                               [23]],
659                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
660                              columns=['b1'])
661         grouping = pd.Series(['a', 'a', 'b', 'a', 'b', 'b'],
662                              index=['s1', 's2', 's4', 's3', 's5', 's6'])
663         percentiles = [42.0, 50.0]
664         groups = ['a', 'b']
665         tuples = [(p, g) for g in groups for p in percentiles]
666         exp_mi = pd.MultiIndex.from_tuples(tuples,
667                                            names=['Percentile', 'Group'])
668         exp_data = np.array([[7.71999999], [9.0],  # a
669                              [21.68], [22.0]])     # b
670         exp = pd.DataFrame(exp_data.T, columns=exp_mi, index=['b1'])
671         result = ancom(table, grouping, percentiles=percentiles)[1]
672         assert_data_frame_almost_equal(result, exp)
673     def test_ancom_percentile_order_unimportant(self):
674         table = pd.DataFrame([[12],
675                               [9],
676                               [1],
677                               [22],
678                               [20],
679                               [23]],
680                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
681                              columns=['b1'])
682         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
683                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
684         result1 = ancom(table, grouping, percentiles=[50.0, 42.0])[1]
685         result2 = ancom(table, grouping, percentiles=[42.0, 50.0])[1]
686         assert_data_frame_almost_equal(
687             result1.sort_index(axis=1), result2.sort_index(axis=1))
688     def test_ancom_percentiles_iterator(self):
689         table = pd.DataFrame([[12],
690                               [9],
691                               [1],
692                               [22],
693                               [20],
694                               [23]],
695                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
696                              columns=['b1'])
697         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
698                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
699         percentiles = [42.0, 50.0]
700         groups = ['a', 'b']
701         tuples = [(p, g) for g in groups for p in percentiles]
702         exp_mi = pd.MultiIndex.from_tuples(tuples,
703                                            names=['Percentile', 'Group'])
704         exp_data = np.array([[7.71999999], [9.0],  # a
705                              [21.68], [22.0]])     # b
706         exp = pd.DataFrame(exp_data.T, columns=exp_mi, index=['b1'])
707         result = ancom(table, grouping, percentiles=iter(percentiles))[1]
708         assert_data_frame_almost_equal(result, exp)
709     def test_ancom_no_percentiles(self):
710         table = pd.DataFrame([[12],
711                               [9],
712                               [1],
713                               [22],
714                               [20],
715                               [23]],
716                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
717                              columns=['b1'])
718         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
719                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
720         result = ancom(table, grouping, percentiles=[])[1]
721         assert_data_frame_almost_equal(result, pd.DataFrame())
722     def test_ancom_percentile_out_of_range(self):
723         table = pd.DataFrame([[12],
724                               [9],
725                               [1],
726                               [22],
727                               [20],
728                               [23]],
729                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
730                              columns=['b1'])
731         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
732                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
733         with self.assertRaises(ValueError):
734             ancom(table, grouping, percentiles=[-1.0])
735         with self.assertRaises(ValueError):
736             ancom(table, grouping, percentiles=[100.1])
737         with self.assertRaises(ValueError):
738             ancom(table, grouping, percentiles=[10.0, 3.0, 101.0, 100])
739     def test_ancom_duplicate_percentiles(self):
740         table = pd.DataFrame([[12],
741                               [9],
742                               [1],
743                               [22],
744                               [20],
745                               [23]],
746                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
747                              columns=['b1'])
748         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
749                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
750         with self.assertRaises(ValueError):
751             ancom(table, grouping, percentiles=[10.0, 10.0])
752     def test_ancom_basic_proportions(self):
753         test_table = pd.DataFrame(closure(self.table1))
754         original_table = copy.deepcopy(test_table)
755         test_cats = pd.Series(self.cats1)
756         original_cats = copy.deepcopy(test_cats)
757         result = ancom(test_table,
758                        test_cats,
759                        multiple_comparisons_correction=None)
760         assert_data_frame_almost_equal(original_table, test_table)
761         pdt.assert_series_equal(original_cats, test_cats)
762         exp = pd.DataFrame(
763             {'W': np.array([5, 5, 2, 2, 2, 2, 2]),
764              'Reject null hypothesis': np.array([True, True, False, False,
765                                                  False, False, False],
766                                                 dtype=bool)})
767         assert_data_frame_almost_equal(result[0], exp)
768     def test_ancom_multiple_groups(self):
769         test_table = pd.DataFrame(self.table4)
770         original_table = copy.deepcopy(test_table)
771         test_cats = pd.Series(self.cats4)
772         original_cats = copy.deepcopy(test_cats)
773         result = ancom(test_table, test_cats)
774         assert_data_frame_almost_equal(original_table, test_table)
775         pdt.assert_series_equal(original_cats, test_cats)
776         exp = pd.DataFrame(
777             {'W': np.array([8, 7, 3, 3, 7, 3, 3, 3, 3]),
778              'Reject null hypothesis': np.array([True, True, False, False,
779                                                  True, False, False, False,
780                                                  False], dtype=bool)})
781         assert_data_frame_almost_equal(result[0], exp)
782     def test_ancom_noncontiguous(self):
783         result = ancom(self.table5,
784                        self.cats5,
785                        multiple_comparisons_correction=None)
786         exp = pd.DataFrame(
787             {'W': np.array([6, 2, 2, 2, 2, 6, 2]),
788              'Reject null hypothesis': np.array([True, False, False, False,
789                                                  False, True, False],
790                                                 dtype=bool)})
791         assert_data_frame_almost_equal(result[0], exp)
792     def test_ancom_unbalanced(self):
793         result = ancom(self.table6,
794                        self.cats6,
795                        multiple_comparisons_correction=None)
796         exp = pd.DataFrame(
797             {'W': np.array([5, 3, 3, 2, 2, 5, 2]),
798              'Reject null hypothesis': np.array([True, False, False, False,
799                                                  False, True, False],
800                                                 dtype=bool)})
801         assert_data_frame_almost_equal(result[0], exp)
802     def test_ancom_letter_categories(self):
803         result = ancom(self.table7,
804                        self.cats7,
805                        multiple_comparisons_correction=None)
806         exp = pd.DataFrame(
807             {'W': np.array([5, 3, 3, 2, 2, 5, 2]),
808              'Reject null hypothesis': np.array([True, False, False, False,
809                                                  False, True, False],
810                                                 dtype=bool)})
811         assert_data_frame_almost_equal(result[0], exp)
812     def test_ancom_multiple_comparisons(self):
813         significance_test = functools.partial(scipy.stats.mannwhitneyu,
814                                               alternative='two-sided')
815         result = ancom(self.table1,
816                        self.cats1,
817                        multiple_comparisons_correction='holm-bonferroni',
818                        significance_test=significance_test)
819         exp = pd.DataFrame(
820             {'W': np.array([0]*7),
821              'Reject null hypothesis': np.array([False]*7, dtype=bool)})
822         assert_data_frame_almost_equal(result[0], exp)
823     def test_ancom_alternative_test(self):
824         result = ancom(self.table1,
825                        self.cats1,
826                        multiple_comparisons_correction=None,
827                        significance_test=scipy.stats.ttest_ind)
828         exp = pd.DataFrame(
829             {'W': np.array([5, 5, 2, 2, 2, 2, 2]),
830              'Reject null hypothesis': np.array([True,  True, False, False,
831                                                  False, False, False],
832                                                 dtype=bool)})
833         assert_data_frame_almost_equal(result[0], exp)
834     def test_ancom_normal_data(self):
835         result = ancom(self.table2,
836                        self.cats2,
837                        multiple_comparisons_correction=None,
838                        significance_test=scipy.stats.ttest_ind)
839         exp = pd.DataFrame(
840             {'W': np.array([8, 8, 3, 3, 8, 3, 3, 3, 3]),
841              'Reject null hypothesis': np.array([True, True, False, False,
842                                                  True, False, False,
843                                                  False, False],
844                                                 dtype=bool)})
845         assert_data_frame_almost_equal(result[0], exp)
846     def test_ancom_basic_counts_swapped(self):
847         result = ancom(self.table8, self.cats8)
848         exp = pd.DataFrame(
849             {'W': np.array([5, 5, 2, 2, 2, 2, 2]),
850              'Reject null hypothesis': np.array([True, True, False, False,
851                                                  False, False, False],
852                                                 dtype=bool)})
853         assert_data_frame_almost_equal(result[0], exp)
854     def test_ancom_no_signal(self):
855         result = ancom(self.table3,
856                        self.cats3,
857                        multiple_comparisons_correction=None)
858         exp = pd.DataFrame(
859             {'W': np.array([0]*7),
860              'Reject null hypothesis': np.array([False]*7, dtype=bool)})
861         assert_data_frame_almost_equal(result[0], exp)
862     def test_ancom_tau(self):
863         exp1 = pd.DataFrame(
864             {'W': np.array([8, 7, 3, 3, 7, 3, 3, 3, 3]),
865              'Reject null hypothesis': np.array([True, False, False, False,
866                                                  False, False, False, False,
867                                                  False], dtype=bool)})
868         exp2 = pd.DataFrame(
869             {'W': np.array([17, 17, 5, 6, 16, 5, 7, 5,
870                             4, 5, 8, 4, 5, 16, 5, 11, 4, 6]),
871              'Reject null hypothesis': np.array([True, True, False, False,
872                                                  True, False, False, False,
873                                                  False, False, False, False,
874                                                  False, True, False, False,
875                                                  False, False],  dtype=bool)})
876         exp3 = pd.DataFrame(
877             {'W': np.array([16, 16, 17, 10, 17, 16, 16,
878                             15, 15, 15, 13, 10, 10, 10,
879                             9, 9, 9, 9]),
880              'Reject null hypothesis': np.array([True, True, True, False,
881                                                  True, True, True, False,
882                                                  False, False, False, False,
883                                                  False, False], dtype<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=bool)})
884         result1 = ancom(self.table4, self.cats4,
885                         multiple_comparisons_correction=None, tau=0.25)
886         result2 = ancom(self.table9, self.cats9,
887                         multiple_comparisons_correction=None, tau=0.02)
888         result3 = ancom(self.table10, self.cats10,
889                         multiple_comparisons_correction=None, tau=</b></font>0.02)
890         assert_data_frame_almost_equal(result1[0], exp1)
891         assert_data_frame_almost_equal(result2[0], exp2)
892         assert_data_frame_almost_equal(result3[0], exp3)
893     def test_ancom_theta(self):
894         result = ancom(self.table1, self.cats1, theta=0.3)
895         exp = pd.DataFrame(
896             {'W': np.array([5, 5, 2, 2, 2, 2, 2]),
897              'Reject null hypothesis': np.array([True, True, False, False,
898                                                  False, False, False],
899                                                 dtype=bool)})
900         assert_data_frame_almost_equal(result[0], exp)
901     def test_ancom_alpha(self):
902         result = ancom(self.table1, self.cats1,
903                        multiple_comparisons_correction=None, alpha=0.5)
904         exp = pd.DataFrame(
905             {'W': np.array([6, 6, 4, 5, 5, 4, 2]),
906              'Reject null hypothesis': np.array([True, True, False, True,
907                                                  True, False, False],
908                                                 dtype=bool)})
909         assert_data_frame_almost_equal(result[0], exp)
910     def test_ancom_fail_type(self):
911         with self.assertRaises(TypeError):
912             ancom(self.table1.values, self.cats1)
913         with self.assertRaises(TypeError):
914             ancom(self.table1, self.cats1.values)
915     def test_ancom_fail_zeros(self):
916         with self.assertRaises(ValueError):
917             ancom(self.bad1, self.cats2, multiple_comparisons_correction=None)
918     def test_ancom_fail_negative(self):
919         with self.assertRaises(ValueError):
920             ancom(self.bad2, self.cats2, multiple_comparisons_correction=None)
921     def test_ancom_fail_not_implemented_multiple_comparisons_correction(self):
922         with self.assertRaises(ValueError):
923             ancom(self.table2, self.cats2,
924                   multiple_comparisons_correction='fdr')
925     def test_ancom_fail_missing(self):
926         with self.assertRaises(ValueError):
927             ancom(self.bad3, self.cats1)
928         with self.assertRaises(ValueError):
929             ancom(self.table1, self.badcats1)
930     def test_ancom_fail_groups(self):
931         with self.assertRaises(ValueError):
932             ancom(self.table1, self.badcats2)
933     def test_ancom_fail_size_mismatch(self):
934         with self.assertRaises(ValueError):
935             ancom(self.table1, self.badcats3)
936     def test_ancom_fail_group_unique(self):
937         with self.assertRaises(ValueError):
938             ancom(self.table1, self.badcats4)
939     def test_ancom_fail_1_group(self):
940         with self.assertRaises(ValueError):
941             ancom(self.table1, self.badcats5)
942     def test_ancom_fail_tau(self):
943         with self.assertRaises(ValueError):
944             ancom(self.table1, self.cats1, tau=-1)
945         with self.assertRaises(ValueError):
946             ancom(self.table1, self.cats1, tau=1.1)
947     def test_ancom_fail_theta(self):
948         with self.assertRaises(ValueError):
949             ancom(self.table1, self.cats1, theta=-1)
950         with self.assertRaises(ValueError):
951             ancom(self.table1, self.cats1, theta=1.1)
952     def test_ancom_fail_alpha(self):
953         with self.assertRaises(ValueError):
954             ancom(self.table1, self.cats1, alpha=-1)
955         with self.assertRaises(ValueError):
956             ancom(self.table1, self.cats1, alpha=1.1)
957     def test_ancom_fail_multiple_groups(self):
958         with self.assertRaises(TypeError):
959             ancom(self.table4, self.cats4,
960                   significance_test=scipy.stats.ttest_ind)
961     def test_holm_bonferroni(self):
962         p = [0.005, 0.011, 0.02, 0.04, 0.13]
963         corrected_p = p * np.arange(1, 6)[::-1]
964         guessed_p = _holm_bonferroni(p)
965         for a, b in zip(corrected_p, guessed_p):
966             self.assertAlmostEqual(a, b)
967 if __name__ == "__main__":
968     main()
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>_testing.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import inspect
2 import os
3 import sys
4 import numpy as np
5 import numpy.testing as npt
6 import pandas.testing as pdt
7 from scipy.spatial.distance import pdist
8 from ._decorator import experimental
9 class ReallyEqualMixin:
10         self<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertEqual(a, b)
11         self.assertEqual(b, a)
12         self.assertTrue(a == b)
13         self.assertTrue(b == a)
14         self.assertFalse(a != b)
15         self.assertFalse(b != a)
16         self<font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertNotEqual(a, b)
17         self.assertNotEqual(b, a)
18         self.assertFalse(a == b)
19         self.assertFalse(b == a)
20         self.assertTrue(a != b)
21         self.assertTrue(</b></font>b != a)
22 @experimental(as_of="0.4.0")
23 def get_data_path(fn, subfolder='data'):
24     callers_filename = inspect.getouterframes(inspect.currentframe())[1][1]
25     path = os.path.dirname(os.path.abspath(callers_filename))
26     data_path = os.path.join(path, subfolder, fn)
27     return data_path
28 @experimental(as_of="0.4.0")
29 def assert_ordination_results_equal(left, right, ignore_method_names=False,
30                                     ignore_axis_labels=False,
31                                     ignore_directionality=False,
32                                     decimal=7):
33     npt.assert_equal(type(left) is type(right), True)
34     if not ignore_method_names:
35         npt.assert_equal(left.short_method_name, right.short_method_name)
36         npt.assert_equal(left.long_method_name, right.long_method_name)
37     _assert_frame_dists_equal(left.samples, right.samples,
38                               ignore_columns=ignore_axis_labels,
39                               ignore_directionality<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=ignore_directionality,
40                               decimal=decimal)
41     _assert_frame_dists_equal(left.features, right.features,
42                               ignore_columns=ignore_axis_labels,
43                               ignore_directionality=ignore_directionality,
44                               decimal=decimal)
45     _assert_frame_dists_equal(left.biplot_scores, right.biplot_scores,
46                               ignore_columns=ignore_axis_labels,
47                               ignore_directionality=ignore_directionality,
48                               decimal=decimal)
49     _assert_frame_dists_equal(left.sample_constraints,
50                               right.sample_constraints,
51                               ignore_columns=ignore_axis_labels,
52                               ignore_directionality=</b></font>ignore_directionality,
53                               decimal=decimal)
54     _assert_series_equal(left.eigvals, right.eigvals, ignore_axis_labels,
55                          decimal=decimal)
56     _assert_series_equal(left.proportion_explained, right.proportion_explained,
57                          ignore_axis_labels,
58                          decimal=decimal)
59 def _assert_series_equal(left_s, right_s, ignore_index=False, decimal=7):
60     if left_s is None or right_s is None:
61         assert left_s is None and right_s is None
62     else:
63         npt.assert_almost_equal(left_s.values, right_s.values,
64                                 decimal=decimal)
65         if not ignore_index:
66             pdt.assert_index_equal(left_s.index, right_s.index)
67 def _assert_frame_dists_equal(left_df, right_df, ignore_index=False,
68                               ignore_columns=False,
69                               ignore_directionality=False, decimal=7):
70     if left_df is None or right_df is None:
71         assert left_df is None and right_df is None
72     else:
73         left_values = left_df.values
74         right_values = right_df.values
75         left_dists = pdist(left_values)
76         right_dists = pdist(right_values)
77         npt.assert_almost_equal(left_dists, right_dists, decimal=decimal)
78         if not ignore_index:
79             pdt.assert_index_equal(left_df.index, right_df.index)
80         if not ignore_columns:
81             pdt.assert_index_equal(left_df.columns, right_df.columns)
82 def _assert_frame_equal(left_df, right_df, ignore_index=False,
83                         ignore_columns=False, ignore_directionality=False,
84                         decimal=7):
85     if left_df is None or right_df is None:
86         assert left_df is None and right_df is None
87     else:
88         left_values = left_df.values
89         right_values = right_df.values
90         if ignore_directionality:
91             left_values, right_values = _normalize_signs(left_values,
92                                                          right_values)
93         npt.assert_almost_equal(left_values, right_values, decimal=decimal)
94         if not ignore_index:
95             pdt.assert_index_equal(left_df.index, right_df.index)
96         if not ignore_columns:
97             pdt.assert_index_equal(left_df.columns, right_df.columns)
98 def _normalize_signs(arr1, arr2):
99     arr1 = np.asarray(arr1, dtype=np.float64)
100     arr2 = np.asarray(arr2, dtype=np.float64)
101     if arr1.shape != arr2.shape:
102         raise ValueError(
103             "Arrays must have the same shape ({0} vs {1}).".format(arr1.shape,
104                                                                    arr2.shape)
105         )
106     max_idx = np.abs(arr1).argmax(axis=0)
107     max_arr1 <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= arr1[max_idx, range(arr1.shape[1])]
108     max_arr2 = arr2[max_idx, range(arr2.shape[1])]
109     sign_arr1 = np.sign(</b></font>max_arr1)
110     sign_arr2 = np.sign(max_arr2)
111     wrn = np.seterr(invalid='ignore', divide='ignore')
112     differences = sign_arr1 / sign_arr2
113     np.seterr(**wrn)
114     special_cases = (~np.isfinite(differences)) | (differences == 0)
115     differences[special_cases] = 1
116     return arr1 * differences, arr2
117 @experimental(as_of="0.4.0")
118 def assert_data_frame_almost_equal(left, right, rtol=1e-5):
119     pdt.assert_frame_equal(left, right,
120                            check_dtype=True,
121                            check_index_type=True,
122                            check_column_type=True,
123                            check_frame_type=True,
124                            check_names=True,
125                            by_blocks=False,
126                            check_exact=False,
127                            rtol=rtol)
128     assert_index_equal(left.index, right.index)
129 def assert_series_almost_equal(left, right):
130     pdt.assert_series_equal(left, right,
131                             check_dtype=True,
132                             check_index_type=True,
133                             check_series_type=True,
134                             check_names=True,
135                             check_exact=False,
136                             check_datetimelike_compat=False,
137                             obj='Series')
138     assert_index_equal(left.index, right.index)
139 def assert_index_equal(a, b):
140     pdt.assert_index_equal(a, b,
141                            exact=True,
142                            check_names=True,
143                            check_exact=True)
144 def pytestrunner():
145     try:
146         import numpy
147         try:
148             numpy.set_printoptions(legacy="1.13")
149         except TypeError:
150             pass
151     except ImportError:
152         numpy = None
153     try:
154         import pandas
155         pandas.options.display.max_columns = None
156     except ImportError:
157         pandas = None
158     import pytest
159     args = ['--pyargs', 'skbio', '--doctest-modules', '--doctest-glob',
160             '*.pyx', '-o', '"doctest_optionflags=NORMALIZE_WHITESPACE'
161             ' IGNORE_EXCEPTION_DETAIL"'] + sys.argv[1:]
162     errno = pytest.main(args=args)
163     sys.exit(errno)
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
