<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_composition.py &amp; _testing.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_composition.py &amp; _testing.py
      </h3>
<h1 align="center">
        4.0%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_composition.py (2.3006744%)<th>_testing.py (17.52266%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(1062-1069)<td><a href="#" name="0">(123-139)</a><td align="center"><font color="#ff0000">19</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(320-326)<td><a href="#" name="1">(31-38)</a><td align="center"><font color="#bb0000">14</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(705-707)<td><a href="#" name="2">(243-246)</a><td align="center"><font color="#ae0000">13</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(234-235)<td><a href="#" name="3">(41-46)</a><td align="center"><font color="#a10000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_composition.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import functools
2 from unittest import TestCase, main
3 import numpy as np
4 import numpy.testing as npt
5 import pandas.testing as pdt
6 from numpy.random import normal
7 import pandas as pd
8 import scipy
9 import copy
10 from skbio.util import assert_data_frame_almost_equal
11 from skbio.stats.composition import (closure, multiplicative_replacement,
12                                      perturb, perturb_inv, power, inner,
13                                      clr, clr_inv, ilr, ilr_inv, alr, alr_inv,
14                                      sbp_basis, _gram_schmidt_basis,
15                                      centralize, _holm_bonferroni, ancom)
16 class CompositionTests(TestCase):
17     def setUp(self):
18         self.cdata1 = np.array([[2, 2, 6],
19                                 [4, 4, 2]])
20         self.cdata2 = np.array([2, 2, 6])
21         self.cdata3 = np.array([[1, 2, 3, 0, 5],
22                                 [1, 0, 0, 4, 5],
23                                 [1, 2, 3, 4, 5]])
24         self.cdata4 = np.array([1, 2, 3, 0, 5])
25         self.cdata5 = [[2, 2, 6], [4, 4, 2]]
26         self.cdata6 = [[1, 2, 3, 0, 5],
27                        [1, 0, 0, 4, 5],
28                        [1, 2, 3, 4, 5]]
29         self.cdata7 = [np.exp(1), 1, 1]
30         self.cdata8 = [np.exp(1), 1, 1, 1]
31         self.ortho1 = [[0.44858053, 0.10905743, 0.22118102, 0.22118102],
32                        [0.3379924, 0.3379924, 0.0993132, 0.22470201],
33                        [0.3016453, 0.3016453, 0.3016453, 0.09506409]]
34         self.rdata1 = [[0.70710678, -0.70710678, 0., 0.],
35                        [0.40824829, 0.40824829, -0.81649658, 0.],
36                        [0.28867513, 0.28867513, 0.28867513, -0.8660254]]
37         self.bad1 = np.array([1, 2, -1])
38         self.bad2 = np.array([[[1, 2, 3, 0, 5]]])
39     def test_closure(self):
40         npt.assert_allclose(closure(self.cdata1),
41                             np.array([[.2, .2, .6],
42                                       [.4, .4, .2]]))
43         npt.assert_allclose(closure(self.cdata2),
44                             np.array([.2, .2, .6]))
45         npt.assert_allclose(closure(self.cdata5),
46                             np.array([[.2, .2, .6],
47                                       [.4, .4, .2]]))
48         with self.assertRaises(ValueError):
49             closure(self.bad1)
50         with self.assertRaises(ValueError):
51             closure(self.bad2)
52         closure(self.cdata2)
53         npt.assert_allclose(self.cdata2, np.array([2, 2, 6]))
54     def test_closure_warning(self):
55         with self.assertRaises(ValueError):
56             closure([0., 0., 0.])
57         with self.assertRaises(ValueError):
58             closure([[0., 0., 0.],
59                      [0., 5., 5.]])
60     def test_perturb(self):
61         pmat = perturb(closure(self.cdata1),
62                        closure(np.array([1, 1, 1])))
63         npt.assert_allclose(pmat,
64                             np.array([[.2, .2, .6],
65                                       [.4, .4, .2]]))
66         pmat = perturb(closure(self.cdata1),
67                        closure(np.array([10, 10, 20])))
68         npt.assert_allclose(pmat,
69                             np.array([[.125, .125, .75],
70                                       [1./3, 1./3, 1./3]]))
71         pmat = perturb(closure(self.cdata1),
72                        closure(np.array([10, 10, 20])))
73         npt.assert_allclose(pmat,
74                             np.array([[.125, .125, .75],
75                                       [1./3, 1./3, 1./3]]))
76         pmat = perturb(closure(self.cdata2),
77                        closure([1, 2, 1]))
78         npt.assert_allclose(pmat, np.array([1./6, 2./6, 3./6]))
79         pmat = perturb(closure(self.cdata5),
80                        closure(np.array([1, 1, 1])))
81         npt.assert_allclose(pmat,
82                             np.array([[.2, .2, .6],
83                                       [.4, .4, .2]]))
84         with self.assertRaises(ValueError):
85             perturb(closure(self.cdata5), self.bad1)
86         perturb(self.cdata2, [1, 2, 3])
87         npt.assert_allclose(self.cdata2, np.array([2, 2, 6]))
88     def test_power(self):
89         pmat = power(closure(self.cdata1), 2)
90         npt.assert_allclose(pmat,
91                             np.array([[.04/.44, .04/.44, .36/.44],
92                                       [.16/.36, .16/.36, .04/.36]]))
93         pmat = power(closure(self.cdata2), 2)
94         npt.assert_allclose(pmat, np.array([.04, .04, .36])/.44)
95         pmat = power(closure(self.cdata5), 2)
96         npt.assert_allclose(pmat,
97                             np.array([[.04/.44, .04/.44, .36/.44],
98                                       [.16/.36, .16/.36, .04/.36]]))
99         with self.assertRaises(ValueError):
100             power(self.bad1, 2)
101         power(self.cdata2, 4)
102         npt.assert_allclose(self.cdata2, np.array([2, 2, 6]))
103     def test_perturb_inv(self):
104         pmat = perturb_inv(closure(self.cdata1),
105                            closure([.1, .1, .1]))
106         imat = perturb(closure(self.cdata1),
107                        closure([10, 10, 10]))
108         npt.assert_allclose(pmat, imat)
109         pmat = perturb_inv(closure(self.cdata1),
110                            closure([1, 1, 1]))
111         npt.assert_allclose(pmat,
112                             closure([[.2, .2, .6],
113                                      [.4, .4, .2]]))
114         pmat = perturb_inv(closure(self.cdata5),
115                            closure([.1, .1, .1]))
116         imat = perturb(closure(self.cdata1), closure([10, 10, 10]))
117         npt.assert_allclose(pmat, imat)
118         with self.assertRaises(ValueError):
119             perturb_inv(closure(self.cdata1), self.bad1)
120         perturb_inv(self.cdata2, [1, 2, 3])
121         npt.assert_allclose(self.cdata2, np.array([2, 2, 6]))
122     def test_inner(self):
123         a = inner(self.cdata5, self.cdata5)
124         npt.assert_allclose(a, np.array([[0.80463264, -0.50766667],
125                                          [-0.50766667, 0.32030201]]))
126         b = inner(self.cdata7, self.cdata7)
127         npt.assert_allclose(b, 0.66666666666666663)
128         npt.assert_allclose(inner(self.ortho1, self.ortho1), np.identity(3),
129                             rtol=1e-04, atol=1e-06)
130         with self.assertRaises(ValueError):
131             inner(self.cdata1, self.cdata8)
132         inner(self.cdata1, self.cdata1)
133         npt.assert_allclose(self.cdata1,
134                             np.array([[2, 2, 6],
135                                       [4, 4, 2]]))
136     def test_multiplicative_replacement(self):
137         amat = multiplicative_replacement(closure(self.cdata3))
138         npt.assert_allclose(amat,
139                             np.array([[0.087273, 0.174545, 0.261818,
140                                        0.04, 0.436364],
141                                       [0.092, 0.04, 0.04, 0.368, 0.46],
142                                       [0.066667, 0.133333, 0.2,
143                                        0.266667, 0.333333]]),
144                             rtol=1e-5, atol=1e-5)
145         amat = multiplicative_replacement(closure(self.cdata4))
146         npt.assert_allclose(amat,
147                             np.array([0.087273, 0.174545, 0.261818,
148                                       0.04, 0.436364]),
149                             rtol=1e-5, atol=1e-5)
150         amat = multiplicative_replacement(closure(self.cdata6))
151         npt.assert_allclose(amat,
152                             np.array([[0.087273, 0.174545, 0.261818,
153                                        0.04, 0.436364],
154                                       [0.092, 0.04, 0.04, 0.368, 0.46],
155                                       [0.066667, 0.133333, 0.2,
156                                        0.266667, 0.333333]]),
157                             rtol=1e-5, atol=1e-5)
158         with self.assertRaises(ValueError):
159             multiplicative_replacement(self.bad1)
160         with self.assertRaises(ValueError):
161             multiplicative_replacement(self.bad2)
162         multiplicative_replacement(self.cdata4)
163         npt.assert_allclose(self.cdata4, np.array([1, 2, 3, 0, 5]))
164     def multiplicative_replacement_warning(self):
165         with self.assertRaises(ValueError):
166             multiplicative_replacement([0, 1, 2], delta=1)
167     def test_clr(self):
168         cmat = clr(closure(self.cdata1))
169         A = np.array([.2, .2, .6])
170 <a name="3"></a>        B = np.array([.4, .4, .2])
171         npt.assert_allclose(cmat,
172                             [np<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.log(A / np.exp(np.log(A).mean())),
173                              np.log(B / np.exp(</b></font>np.log(B).mean()))])
174         cmat = clr(closure(self.cdata2))
175         A = np.array([.2, .2, .6])
176         npt.assert_allclose(cmat,
177                             np.log(A / np.exp(np.log(A).mean())))
178         cmat = clr(closure(self.cdata5))
179         A = np.array([.2, .2, .6])
180         B = np.array([.4, .4, .2])
181         npt.assert_allclose(cmat,
182                             [np.log(A / np.exp(np.log(A).mean())),
183                              np.log(B / np.exp(np.log(B).mean()))])
184         with self.assertRaises(ValueError):
185             clr(self.bad1)
186         with self.assertRaises(ValueError):
187             clr(self.bad2)
188         clr(self.cdata2)
189         npt.assert_allclose(self.cdata2, np.array([2, 2, 6]))
190     def test_clr_inv(self):
191         npt.assert_allclose(clr_inv(self.rdata1), self.ortho1)
192         npt.assert_allclose(clr(clr_inv(self.rdata1)), self.rdata1,
193                             rtol=1e-4, atol=1e-5)
194         clr_inv(self.rdata1)
195         npt.assert_allclose(self.rdata1,
196                             np.array([[0.70710678, -0.70710678, 0., 0.],
197                                       [0.40824829, 0.40824829,
198                                        -0.81649658, 0.],
199                                       [0.28867513, 0.28867513,
200                                        0.28867513, -0.8660254]]))
201     def test_centralize(self):
202         cmat = centralize(closure(self.cdata1))
203         npt.assert_allclose(cmat,
204                             np.array([[0.22474487, 0.22474487, 0.55051026],
205                                       [0.41523958, 0.41523958, 0.16952085]]))
206         cmat = centralize(closure(self.cdata5))
207         npt.assert_allclose(cmat,
208                             np.array([[0.22474487, 0.22474487, 0.55051026],
209                                       [0.41523958, 0.41523958, 0.16952085]]))
210         with self.assertRaises(ValueError):
211             centralize(self.bad1)
212         with self.assertRaises(ValueError):
213             centralize(self.bad2)
214         centralize(self.cdata1)
215         npt.assert_allclose(self.cdata1,
216                             np.array([[2, 2, 6],
217                                       [4, 4, 2]]))
218     def test_ilr(self):
219         mat = closure(self.cdata7)
220         npt.assert_array_almost_equal(ilr(mat),
221                                       np.array([0.70710678, 0.40824829]))
222         npt.assert_allclose(ilr(self.ortho1), np.identity(3),
223                             rtol=1e-04, atol=1e-06)
224         with self.assertRaises(ValueError):
225             ilr(self.cdata1, basis=self.cdata1)
226         ilr(self.cdata1)
227         npt.assert_allclose(self.cdata1,
228                             np.array([[2, 2, 6],
229                                       [4, 4, 2]]))
230     def test_ilr_basis(self):
231         table = np.array([[1., 10.],
232                           [1.14141414, 9.90909091],
233                           [1.28282828, 9.81818182],
234                           [1.42424242, 9.72727273],
235                           [1.56565657, 9.63636364]])
236         basis = np.array([[0.80442968, 0.19557032]])
237 <a name="1"></a>        res = ilr(table, basis=basis)
238         exp = np.array([np.log(1/10)*np.sqrt(1/2),
239                         np.log(1.14141414 / 9.90909091)*np.sqrt(1/2),
240                         np.log(1.28282828 / 9.81818182)*np<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.sqrt(1/2),
241                         np.log(1.42424242 / 9.72727273)*np.sqrt(1/2),
242                         np.log(1.56565657 / 9.63636364)*np.sqrt(1/2)])
243         npt.assert_allclose(res, exp)
244     def</b></font> test_ilr_basis_one_dimension_error(self):
245         table = np.array([[1., 10.],
246                           [1.14141414, 9.90909091],
247                           [1.28282828, 9.81818182],
248                           [1.42424242, 9.72727273],
249                           [1.56565657, 9.63636364]])
250         basis = np.array([0.80442968, 0.19557032])
251         with self.assertRaises(ValueError):
252             ilr(table, basis=basis)
253     def test_ilr_inv(self):
254         mat = closure(self.cdata7)
255         npt.assert_array_almost_equal(ilr_inv(ilr(mat)), mat)
256         npt.assert_allclose(ilr_inv(np.identity(3)), self.ortho1,
257                             rtol=1e-04, atol=1e-06)
258         with self.assertRaises(ValueError):
259             ilr_inv(self.cdata1, basis=self.cdata1)
260         ilr_inv(self.cdata1)
261         npt.assert_allclose(self.cdata1,
262                             np.array([[2, 2, 6],
263                                       [4, 4, 2]]))
264     def test_ilr_basis_isomorphism(self):
265         basis = np.array([[0.80442968, 0.19557032]])
266         table = np.array([[np.log(1/10)*np.sqrt(1/2),
267                            np.log(1.14141414 / 9.90909091)*np.sqrt(1/2),
268                            np.log(1.28282828 / 9.81818182)*np.sqrt(1/2),
269                            np.log(1.42424242 / 9.72727273)*np.sqrt(1/2),
270                            np.log(1.56565657 / 9.63636364)*np.sqrt(1/2)]]).T
271         res = ilr(ilr_inv(table, basis=basis), basis=basis)
272         npt.assert_allclose(res, table.squeeze())
273         table = np.array([[1., 10.],
274                           [1.14141414, 9.90909091],
275                           [1.28282828, 9.81818182],
276                           [1.42424242, 9.72727273],
277                           [1.56565657, 9.63636364]])
278         res = ilr_inv(np.atleast_2d(ilr(table, basis=basis)).T, basis=basis)
279         npt.assert_allclose(res, closure(table.squeeze()))
280     def test_ilr_inv_basis(self):
281         exp = closure(np.array([[1., 10.],
282                                 [1.14141414, 9.90909091],
283                                 [1.28282828, 9.81818182],
284                                 [1.42424242, 9.72727273],
285                                 [1.56565657, 9.63636364]]))
286         basis = np.array([[0.80442968, 0.19557032]])
287         table = np.array([[np.log(1/10)*np.sqrt(1/2),
288                            np.log(1.14141414 / 9.90909091)*np.sqrt(1/2),
289                            np.log(1.28282828 / 9.81818182)*np.sqrt(1/2),
290                            np.log(1.42424242 / 9.72727273)*np.sqrt(1/2),
291                            np.log(1.56565657 / 9.63636364)*np.sqrt(1/2)]]).T
292         res = ilr_inv(table, basis=basis)
293         npt.assert_allclose(res, exp)
294     def test_ilr_inv_basis_one_dimension_error(self):
295         basis = clr(np.array([[0.80442968, 0.19557032]]))
296         table = np.array([[np.log(1/10)*np.sqrt(1/2),
297                            np.log(1.14141414 / 9.90909091)*np.sqrt(1/2),
298                            np.log(1.28282828 / 9.81818182)*np.sqrt(1/2),
299                            np.log(1.42424242 / 9.72727273)*np.sqrt(1/2),
300                            np.log(1.56565657 / 9.63636364)*np.sqrt(1/2)]]).T
301         with self.assertRaises(ValueError):
302             ilr_inv(table, basis=basis)
303     def test_alr(self):
304         comp1 = closure(self.cdata1)
305         alr2d_byhand = np.array([np.log(comp1[:, 0]/comp1[:, 1]),
306                                  np.log(comp1[:, 2]/comp1[:, 1])]).T
307         alr2d_method = alr(comp1, denominator_idx=1)
308         npt.assert_allclose(alr2d_byhand, alr2d_method)
309         comp2 = closure(self.cdata2)
310         alr1d_byhand = np.array([np.log(comp2[0]/comp2[1]),
311                                  np.log(comp2[2]/comp2[1])]).T
312         alr1d_method = alr(comp2, denominator_idx=1)
313         npt.assert_allclose(alr1d_byhand, alr1d_method)
314         with self.assertRaises(ValueError):
315             alr(self.bad1)
316         with self.assertRaises(ValueError):
317             alr(self.bad2)
318         alr(self.cdata2)
319         npt.assert_allclose(self.cdata2, np.array([2, 2, 6]))
320     def test_alr_inv(self):
321         comp1 = closure(self.cdata1)
322         alr2d_byhand = np.array([np.log(comp1[:, 0]/comp1[:, 1]),
323                                  np.log(comp1[:, 2]/comp1[:, 1])]).T
324         alr2d_method = alr(comp1, denominator_idx=1)
325         B = 1/(1 + np.exp(alr2d_byhand[:, 0]) + np.exp(alr2d_byhand[:, 1]))
326         A = B * np.exp(alr2d_byhand[:, 0])
327         C = B * np.exp(alr2d_byhand[:, 1])
328         alrinv2d_byhand = np.column_stack((A, B, C))
329         alrinv2d_method = alr_inv(alr2d_method, denominator_idx=1)
330         npt.assert_allclose(alrinv2d_byhand, alrinv2d_method)
331         comp2 = closure(self.cdata2)
332         alr1d_byhand = np.array([np.log(comp2[0]/comp2[1]),
333                                  np.log(comp2[2]/comp2[1])]).T
334         alr1d_method = alr(comp2, denominator_idx=1)
335         B = 1/(1 + np.exp(alr1d_byhand[0]) + np.exp(alr1d_byhand[1]))
336         A = B * np.exp(alr1d_byhand[0])
337         C = B * np.exp(alr1d_byhand[1])
338         alrinv1d_byhand = np.column_stack((A, B, C))[0, :]
339         alrinv1d_method = alr_inv(alr1d_method, denominator_idx=1)
340         npt.assert_allclose(alrinv1d_byhand, alrinv1d_method)
341         alr_inv(self.rdata1)
342         npt.assert_allclose(self.rdata1,
343                             np.array([[0.70710678, -0.70710678, 0., 0.],
344                                       [0.40824829, 0.40824829,
345                                        -0.81649658, 0.],
346                                       [0.28867513, 0.28867513,
347                                        0.28867513, -0.8660254]]))
348         with self.assertRaises(ValueError):
349             alr_inv(self.bad2)
350     def test_sbp_basis_gram_schmidt(self):
351         gsbasis = clr_inv(_gram_schmidt_basis(5))
352         sbp = np.array([[1, -1, 0, 0, 0],
353                         [1, 1, -1, 0, 0],
354                         [1, 1, 1, -1, 0],
355                         [1, 1, 1, 1, -1]])
356         sbpbasis = sbp_basis(sbp)
357         npt.assert_allclose(gsbasis, sbpbasis)
358     def test_sbp_basis_elementwise(self):
359         sbp = np.array([[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -1],
360                         [1, 1, 1, 1, 1, 1, 1, -1, -1, -1, -1, 0],
361                         [1, 1, 1, 1, 1, 1, -1, 0, 0, 0, 0, 0],
362                         [1, 1, -1, -1, -1, 1, 0, 0, 0, 0, 0, 0],
363                         [1, -1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0],
364                         [1, 0, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0],
365                         [0, 0, 1, -1, -1, 0, 0, 0, 0, 0, 0, 0],
366                         [0, 0, 0, 1, -1, 0, 0, 0, 0, 0, 0, 0],
367                         [0, 0, 0, 0, 0, 0, 0, 1, -1, -1, 1, 0],
368                         [0, 0, 0, 0, 0, 0, 0, 1, 0, 0, -1, 0],
369                         [0, 0, 0, 0, 0, 0, 0, 0, 1, -1, 0, 0]])
370         sbpbasis = sbp_basis(sbp)
371         r = np.apply_along_axis(func1d=lambda x: np.sum(x &gt; 0),
372                                 axis=1, arr=sbp)
373         s = np.apply_along_axis(func1d=lambda x: np.sum(x &lt; 0),
374                                 axis=1, arr=sbp)
375         psi = np.zeros(sbp.shape)
376         for i in range(0, sbp.shape[0]):
377             for j in range(0, sbp.shape[1]):
378                 if sbp[i, j] == 1:
379                     psi[i, j] = np.sqrt(s[i]/(r[i]*(r[i]+s[i])))
380                 elif sbp[i, j] == -1:
381                     psi[i, j] = -np.sqrt(r[i]/(s[i]*(r[i]+s[i])))
382         basis_byhand = clr_inv(psi)
383         npt.assert_allclose(basis_byhand, sbpbasis)
384 class AncomTests(TestCase):
385     def setUp(self):
386         self.table1 = pd.DataFrame([
387             [10, 10, 10, 20, 20, 20],
388             [11, 12, 11, 21, 21, 21],
389             [10, 11, 10, 10, 11, 10],
390             [10, 11, 10, 10, 10, 9],
391             [10, 11, 10, 10, 10, 10],
392             [10, 11, 10, 10, 10, 11],
393             [10, 13, 10, 10, 10, 12]]).T
394         self.cats1 = pd.Series([0, 0, 0, 1, 1, 1])
395         D, L = 40, 80
396         np.random.seed(0)
397         self.table2 = np.vstack((np.concatenate((normal(10, 1, D),
398                                                  normal(200, 1, D))),
399                                  np.concatenate((normal(20, 1, D),
400                                                  normal(100000, 1, D))),
401                                  normal(10, 1, L),
402                                  normal(10, 1, L),
403                                  np.concatenate((normal(20, 1, D),
404                                                  normal(100000, 1, D))),
405                                  normal(10, 1, L),
406                                  normal(10, 1, L),
407                                  normal(10, 1, L),
408                                  normal(10, 1, L)))
409         self.table2 = np.absolute(self.table2)
410         self.table2 = pd.DataFrame(self.table2.astype(int).T)
411         self.cats2 = pd.Series([0]*D + [1]*D)
412         self.table3 = pd.DataFrame([
413             [10, 10.5, 10, 10, 10.5, 10.3],
414             [11, 11.5, 11, 11, 11.5, 11.3],
415             [10, 10.5, 10, 10, 10.5, 10.2],
416             [10, 10.5, 10, 10, 10.5, 10.3],
417             [10, 10.5, 10, 10, 10.5, 10.1],
418             [10, 10.5, 10, 10, 10.5, 10.6],
419             [10, 10.5, 10, 10, 10.5, 10.4]]).T
420         self.cats3 = pd.Series([0, 0, 0, 1, 1, 1])
421         D, L = 40, 120
422         np.random.seed(0)
423         self.table4 = np.vstack((np.concatenate((normal(10, 1, D),
424                                                  normal(200, 1, D),
425                                                  normal(400, 1, D))),
426                                  np.concatenate((normal(20, 1, D),
427                                                  normal(100000, 1, D),
428                                                  normal(2000, 1, D))),
429                                  normal(10, 1, L),
430                                  normal(10, 1, L),
431                                  np.concatenate((normal(20, 1, D),
432                                                  normal(100000, 1, D),
433                                                  normal(2000, 1, D))),
434                                  normal(10, 1, L),
435                                  normal(10, 1, L),
436                                  normal(10, 1, L),
437                                  normal(10, 1, L)))
438         self.table4 = np.absolute(self.table4)
439         self.table4 = pd.DataFrame(self.table4.astype(int).T)
440         self.cats4 = pd.Series([0]*D + [1]*D + [2]*D)
441         self.table5 = pd.DataFrame([
442             [11, 12, 21, 11, 21, 21],
443             [10, 11, 10, 10, 11, 10],
444             [10, 11, 10, 10, 10, 9],
445             [10, 11, 10, 10, 10, 10],
446             [10, 11, 10, 10, 10, 11],
447             [10, 10, 20, 9,  20, 20],
448             [10, 13, 10, 10, 10, 12]]).T
449         self.cats5 = pd.Series([0, 0, 1, 0, 1, 1])
450         self.table6 = pd.DataFrame([
451             [11, 12, 9, 11, 21, 21],
452             [10, 11, 10, 10, 11, 10],
453             [10, 11, 10, 10, 10, 9],
454             [10, 11, 10, 10, 10, 10],
455             [10, 11, 10, 10, 10, 11],
456             [10, 10, 10, 9,  20, 20],
457             [10, 13, 10, 10, 10, 12]]).T
458         self.cats6 = pd.Series([0, 0, 0, 0, 1, 1])
459         self.table7 = pd.DataFrame([
460             [11, 12, 9, 11, 21, 21],
461             [10, 11, 10, 10, 11, 10],
462             [10, 11, 10, 10, 10, 9],
463             [10, 11, 10, 10, 10, 10],
464             [10, 11, 10, 10, 10, 11],
465             [10, 10, 10, 9,  20, 20],
466             [10, 13, 10, 10, 10, 12]]).T
467         self.cats7 = pd.Series(['a', 'a', 'a', 'a', 'b', 'b'])
468         self.table8 = pd.DataFrame([
469             [10, 10, 10, 20, 20, 20],
470             [11, 12, 11, 21, 21, 21],
471             [10, 11, 10, 10, 11, 10],
472             [10, 11, 10, 10, 10, 9],
473             [10, 11, 10, 10, 10, 10],
474             [10, 11, 10, 10, 10, 11],
475             [10, 13, 10, 10, 10, 12]]).T
476         self.table8.index = ['a', 'b', 'c',
477                              'd', 'e', 'f']
478         self.cats8 = pd.Series([0, 0, 1, 0, 1, 1],
479                                index=['a', 'b', 'd',
480                                       'c', 'e', 'f'])
481         D, L = 40, 120
482         np.random.seed(0)
483         self.table9 = np.vstack((np.concatenate((normal(10, 1, D),
484                                                  normal(200, 1, D),
485                                                  normal(400, 1, D))),
486                                  np.concatenate((normal(200000, 1, D),
487                                                  normal(10, 1, D),
488                                                  normal(2000, 1, D))),
489                                  normal(10, 10, L),
490                                  normal(10, 10, L),
491                                  np.concatenate((normal(2000, 1, D),
492                                                  normal(100000, 1, D),
493                                                  normal(2000, 1, D))),
494                                  normal(10000, 1000, L),
495                                  normal(10, 10, L),
496                                  normal(10, 10, L),
497                                  normal(10, 10, L),
498                                  normal(10000, 1000, L),
499                                  normal(10, 10, L),
500                                  normal(10, 10, L),
501                                  normal(10, 10, L),
502                                  np.concatenate((normal(2000, 1, D),
503                                                  normal(100000, 1, D),
504                                                  normal(2000, 1, D))),
505                                  normal(10000, 1000, L),
506                                  normal(10, 10, L),
507                                  normal(10, 10, L),
508                                  normal(10, 10, L)))
509         self.table9 = np.absolute(self.table9)+1
510         self.table9 = pd.DataFrame(self.table9.astype(int).T)
511         self.cats9 = pd.Series([0]*D + [1]*D + [2]*D)
512         D, L = 40, 80
513         np.random.seed(0)
514         self.table10 = np.vstack((np.concatenate((normal(10, 1, D),
515                                                   normal(200, 1, D))),
516                                   np.concatenate((normal(10, 1, D),
517                                                   normal(200, 1, D))),
518                                   np.concatenate((normal(20, 10, D),
519                                                   normal(100, 10, D))),
520                                   normal(10, 1, L),
521                                   np.concatenate((normal(200, 100, D),
522                                                   normal(100000, 100, D))),
523                                   np.concatenate((normal(200000, 100, D),
524                                                   normal(300, 100, D))),
525                                   np.concatenate((normal(200000, 100, D),
526                                                   normal(300, 100, D))),
527                                   np.concatenate((normal(20, 20, D),
528                                                   normal(40, 10, D))),
529                                   np.concatenate((normal(20, 20, D),
530                                                   normal(40, 10, D))),
531                                   np.concatenate((normal(20, 20, D),
532                                                   normal(40, 10, D))),
533                                   normal(100, 10, L),
534                                   normal(100, 10, L),
535                                   normal(1000, 10, L),
536                                   normal(1000, 10, L),
537                                   normal(10, 10, L),
538                                   normal(10, 10, L),
539                                   normal(10, 10, L),
540                                   normal(10, 10, L)))
541         self.table10 = np.absolute(self.table10) + 1
542         self.table10 = pd.DataFrame(self.table10.astype(int).T)
543         self.cats10 = pd.Series([0]*D + [1]*D)
544         self.bad1 = pd.DataFrame(np.array([
545             [10, 10, 10, 20, 20, 0],
546             [11, 11, 11, 21, 21, 21],
547             [10, 10, 10, 10, 10, 10],
548             [10, 10, 10, 10, 10, 10],
549             [10, 10, 10, 10, 10, 10],
550             [10, 10, 10, 10, 10, 10],
551             [10, 10, 10, 10, 10, 10]]).T)
552         self.bad2 = pd.DataFrame(np.array([
553             [10, 10, 10, 20, 20, 1],
554             [11, 11, 11, 21, 21, 21],
555             [10, 10, 10, 10, 10, 10],
556             [10, 10, 10, 10, 10, 10],
557             [10, 10, 10, 10, 10, 10],
558             [10, 10, 10, 10, 10, -1],
559             [10, 10, 10, 10, 10, 10]]).T)
560         self.bad3 = pd.DataFrame(np.array([
561             [10, 10, 10, 20, 20, 1],
562             [11, 11, 11, 21, 21, 21],
563             [10, 10, 10, 10, 10, 10],
564             [10, 10, 10, 10, 10, 10],
565             [10, 10, 10, 10, 10, 10],
566 <a name="2"></a>            [10, 10, 10, 10, 10, np.nan],
567             [10, 10, 10, 10, 10, 10]]).T)
568         self.badcats1 = pd.Series([0, 0, 0, 1, np.nan, 1])
569         self.badcats2 <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= pd.Series([0, 0, 0, 0, 0, 0])
570         self.badcats3 = pd.Series([0, 0, 1, 1])
571         self.badcats4 = pd.Series(</b></font>range(len(self.table1)))
572         self.badcats5 = pd.Series([1]*len(self.table1))
573     def test_ancom_basic_counts(self):
574         test_table = pd.DataFrame(self.table1)
575         original_table = copy.deepcopy(test_table)
576         test_cats = pd.Series(self.cats1)
577         original_cats = copy.deepcopy(test_cats)
578         result = ancom(test_table,
579                        test_cats,
580                        multiple_comparisons_correction=None)
581         assert_data_frame_almost_equal(original_table, test_table)
582         pdt.assert_series_equal(original_cats, test_cats)
583         exp = pd.DataFrame(
584             {'W': np.array([5, 5, 2, 2, 2, 2, 2]),
585              'Reject null hypothesis': np.array([True, True, False, False,
586                                                  False, False, False],
587                                                 dtype=bool)})
588         assert_data_frame_almost_equal(result[0], exp)
589     def test_ancom_percentiles(self):
590         table = pd.DataFrame([[12, 11],
591                               [9, 11],
592                               [1, 11],
593                               [22, 100],
594                               [20, 53],
595                               [23, 1]],
596                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
597                              columns=['b1', 'b2'])
598         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
599                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
600         percentiles = [0.0, 25.0, 50.0, 75.0, 100.0]
601         groups = ['a', 'b']
602         tuples = [(p, g) for g in groups for p in percentiles]
603         exp_mi = pd.MultiIndex.from_tuples(tuples,
604                                            names=['Percentile', 'Group'])
605         exp_data = np.array(
606             [[1.0, 11.0], [5.0, 11.0], [9.0, 11.0], [10.5, 11.0], [12.0, 11.0],
607              [20.0, 1.0], [21.0, 27.0], [22.0, 53.0], [22.5, 76.5],
608              [23.0, 100.0]])
609         exp = pd.DataFrame(exp_data.T, columns=exp_mi, index=['b1', 'b2'])
610         result = ancom(table, grouping)[1]
611         assert_data_frame_almost_equal(result, exp)
612     def test_ancom_percentiles_alt_categories(self):
613         table = pd.DataFrame([[12],
614                               [9],
615                               [1],
616                               [22],
617                               [20],
618                               [23]],
619                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
620                              columns=['b1'])
621         grouping = pd.Series(['a', 'a', 'c', 'b', 'b', 'c'],
622                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
623         percentiles = [0.0, 25.0, 50.0, 75.0, 100.0]
624         groups = ['a', 'b', 'c']
625         tuples = [(p, g) for g in groups for p in percentiles]
626         exp_mi = pd.MultiIndex.from_tuples(tuples,
627                                            names=['Percentile', 'Group'])
628         exp_data = np.array([[9.0], [9.75], [10.5], [11.25], [12.0],  # a
629                              [20.0], [20.5], [21.0], [21.5], [22.0],  # b
630                              [1.0], [6.5], [12.0], [17.5], [23.0]])   # c
631         exp = pd.DataFrame(exp_data.T, columns=exp_mi, index=['b1'])
632         result = ancom(table, grouping, percentiles=percentiles)[1]
633         assert_data_frame_almost_equal(result, exp)
634     def test_ancom_alt_percentiles(self):
635         table = pd.DataFrame([[12],
636                               [9],
637                               [1],
638                               [22],
639                               [20],
640                               [23]],
641                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
642                              columns=['b1'])
643         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
644                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
645         percentiles = [42.0, 50.0]
646         groups = ['a', 'b']
647         tuples = [(p, g) for g in groups for p in percentiles]
648         exp_mi = pd.MultiIndex.from_tuples(tuples,
649                                            names=['Percentile', 'Group'])
650         exp_data = np.array([[7.71999999], [9.0],  # a
651                              [21.68], [22.0]])     # b
652         exp = pd.DataFrame(exp_data.T, columns=exp_mi, index=['b1'])
653         result = ancom(table, grouping, percentiles=percentiles)[1]
654         assert_data_frame_almost_equal(result, exp)
655     def test_ancom_percentiles_swapped(self):
656         table = pd.DataFrame([[12],
657                               [9],
658                               [1],
659                               [22],
660                               [20],
661                               [23]],
662                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
663                              columns=['b1'])
664         grouping = pd.Series(['a', 'a', 'b', 'a', 'b', 'b'],
665                              index=['s1', 's2', 's4', 's3', 's5', 's6'])
666         percentiles = [42.0, 50.0]
667         groups = ['a', 'b']
668         tuples = [(p, g) for g in groups for p in percentiles]
669         exp_mi = pd.MultiIndex.from_tuples(tuples,
670                                            names=['Percentile', 'Group'])
671         exp_data = np.array([[7.71999999], [9.0],  # a
672                              [21.68], [22.0]])     # b
673         exp = pd.DataFrame(exp_data.T, columns=exp_mi, index=['b1'])
674         result = ancom(table, grouping, percentiles=percentiles)[1]
675         assert_data_frame_almost_equal(result, exp)
676     def test_ancom_percentile_order_unimportant(self):
677         table = pd.DataFrame([[12],
678                               [9],
679                               [1],
680                               [22],
681                               [20],
682                               [23]],
683                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
684                              columns=['b1'])
685         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
686                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
687         result1 = ancom(table, grouping, percentiles=[50.0, 42.0])[1]
688         result2 = ancom(table, grouping, percentiles=[42.0, 50.0])[1]
689         assert_data_frame_almost_equal(
690             result1.sort_index(axis=1), result2.sort_index(axis=1))
691     def test_ancom_percentiles_iterator(self):
692         table = pd.DataFrame([[12],
693                               [9],
694                               [1],
695                               [22],
696                               [20],
697                               [23]],
698                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
699                              columns=['b1'])
700         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
701                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
702         percentiles = [42.0, 50.0]
703         groups = ['a', 'b']
704         tuples = [(p, g) for g in groups for p in percentiles]
705         exp_mi = pd.MultiIndex.from_tuples(tuples,
706                                            names=['Percentile', 'Group'])
707         exp_data = np.array([[7.71999999], [9.0],  # a
708                              [21.68], [22.0]])     # b
709         exp = pd.DataFrame(exp_data.T, columns=exp_mi, index=['b1'])
710         result = ancom(table, grouping, percentiles=iter(percentiles))[1]
711         assert_data_frame_almost_equal(result, exp)
712     def test_ancom_no_percentiles(self):
713         table = pd.DataFrame([[12],
714                               [9],
715                               [1],
716                               [22],
717                               [20],
718                               [23]],
719                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
720                              columns=['b1'])
721         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
722                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
723         result = ancom(table, grouping, percentiles=[])[1]
724         assert_data_frame_almost_equal(result, pd.DataFrame())
725     def test_ancom_percentile_out_of_range(self):
726         table = pd.DataFrame([[12],
727                               [9],
728                               [1],
729                               [22],
730                               [20],
731                               [23]],
732                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
733                              columns=['b1'])
734         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
735                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
736         with self.assertRaises(ValueError):
737             ancom(table, grouping, percentiles=[-1.0])
738         with self.assertRaises(ValueError):
739             ancom(table, grouping, percentiles=[100.1])
740         with self.assertRaises(ValueError):
741             ancom(table, grouping, percentiles=[10.0, 3.0, 101.0, 100])
742     def test_ancom_duplicate_percentiles(self):
743         table = pd.DataFrame([[12],
744                               [9],
745                               [1],
746                               [22],
747                               [20],
748                               [23]],
749                              index=['s1', 's2', 's3', 's4', 's5', 's6'],
750                              columns=['b1'])
751         grouping = pd.Series(['a', 'a', 'a', 'b', 'b', 'b'],
752                              index=['s1', 's2', 's3', 's4', 's5', 's6'])
753         with self.assertRaises(ValueError):
754             ancom(table, grouping, percentiles=[10.0, 10.0])
755     def test_ancom_basic_proportions(self):
756         test_table = pd.DataFrame(closure(self.table1))
757         original_table = copy.deepcopy(test_table)
758         test_cats = pd.Series(self.cats1)
759         original_cats = copy.deepcopy(test_cats)
760         result = ancom(test_table,
761                        test_cats,
762                        multiple_comparisons_correction=None)
763         assert_data_frame_almost_equal(original_table, test_table)
764         pdt.assert_series_equal(original_cats, test_cats)
765         exp = pd.DataFrame(
766             {'W': np.array([5, 5, 2, 2, 2, 2, 2]),
767              'Reject null hypothesis': np.array([True, True, False, False,
768                                                  False, False, False],
769                                                 dtype=bool)})
770         assert_data_frame_almost_equal(result[0], exp)
771     def test_ancom_multiple_groups(self):
772         test_table = pd.DataFrame(self.table4)
773         original_table = copy.deepcopy(test_table)
774         test_cats = pd.Series(self.cats4)
775         original_cats = copy.deepcopy(test_cats)
776         result = ancom(test_table, test_cats)
777         assert_data_frame_almost_equal(original_table, test_table)
778         pdt.assert_series_equal(original_cats, test_cats)
779         exp = pd.DataFrame(
780             {'W': np.array([8, 7, 3, 3, 7, 3, 3, 3, 3]),
781              'Reject null hypothesis': np.array([True, True, False, False,
782                                                  True, False, False, False,
783                                                  False], dtype=bool)})
784         assert_data_frame_almost_equal(result[0], exp)
785     def test_ancom_noncontiguous(self):
786         result = ancom(self.table5,
787                        self.cats5,
788                        multiple_comparisons_correction=None)
789         exp = pd.DataFrame(
790             {'W': np.array([6, 2, 2, 2, 2, 6, 2]),
791              'Reject null hypothesis': np.array([True, False, False, False,
792                                                  False, True, False],
793                                                 dtype=bool)})
794         assert_data_frame_almost_equal(result[0], exp)
795     def test_ancom_unbalanced(self):
796         result = ancom(self.table6,
797                        self.cats6,
798                        multiple_comparisons_correction=None)
799         exp = pd.DataFrame(
800             {'W': np.array([5, 3, 3, 2, 2, 5, 2]),
801              'Reject null hypothesis': np.array([True, False, False, False,
802                                                  False, True, False],
803                                                 dtype=bool)})
804         assert_data_frame_almost_equal(result[0], exp)
805     def test_ancom_letter_categories(self):
806         result = ancom(self.table7,
807                        self.cats7,
808                        multiple_comparisons_correction=None)
809         exp = pd.DataFrame(
810             {'W': np.array([5, 3, 3, 2, 2, 5, 2]),
811              'Reject null hypothesis': np.array([True, False, False, False,
812                                                  False, True, False],
813                                                 dtype=bool)})
814         assert_data_frame_almost_equal(result[0], exp)
815     def test_ancom_multiple_comparisons(self):
816         significance_test = functools.partial(scipy.stats.mannwhitneyu,
817                                               alternative='two-sided')
818         result = ancom(self.table1,
819                        self.cats1,
820                        multiple_comparisons_correction='holm-bonferroni',
821                        significance_test=significance_test)
822         exp = pd.DataFrame(
823             {'W': np.array([0]*7),
824              'Reject null hypothesis': np.array([False]*7, dtype=bool)})
825         assert_data_frame_almost_equal(result[0], exp)
826     def test_ancom_alternative_test(self):
827         result = ancom(self.table1,
828                        self.cats1,
829                        multiple_comparisons_correction=None,
830                        significance_test=scipy.stats.ttest_ind)
831         exp = pd.DataFrame(
832             {'W': np.array([5, 5, 2, 2, 2, 2, 2]),
833              'Reject null hypothesis': np.array([True,  True, False, False,
834                                                  False, False, False],
835                                                 dtype=bool)})
836         assert_data_frame_almost_equal(result[0], exp)
837     def test_ancom_normal_data(self):
838         result = ancom(self.table2,
839                        self.cats2,
840                        multiple_comparisons_correction=None,
841                        significance_test=scipy.stats.ttest_ind)
842         exp = pd.DataFrame(
843             {'W': np.array([8, 8, 3, 3, 8, 3, 3, 3, 3]),
844              'Reject null hypothesis': np.array([True, True, False, False,
845                                                  True, False, False,
846                                                  False, False],
847                                                 dtype=bool)})
848         assert_data_frame_almost_equal(result[0], exp)
849     def test_ancom_basic_counts_swapped(self):
850         result = ancom(self.table8, self.cats8)
851         exp = pd.DataFrame(
852             {'W': np.array([5, 5, 2, 2, 2, 2, 2]),
853              'Reject null hypothesis': np.array([True, True, False, False,
854                                                  False, False, False],
855                                                 dtype=bool)})
856         assert_data_frame_almost_equal(result[0], exp)
857     def test_ancom_no_signal(self):
858         result = ancom(self.table3,
859                        self.cats3,
860                        multiple_comparisons_correction=None)
861         exp = pd.DataFrame(
862             {'W': np.array([0]*7),
863              'Reject null hypothesis': np.array([False]*7, dtype=bool)})
864         assert_data_frame_almost_equal(result[0], exp)
865     def test_ancom_tau(self):
866         exp1 = pd.DataFrame(
867             {'W': np.array([8, 7, 3, 3, 7, 3, 3, 3, 3]),
868              'Reject null hypothesis': np.array([True, False, False, False,
869                                                  False, False, False, False,
870                                                  False], dtype=bool)})
871         exp2 = pd.DataFrame(
872             {'W': np.array([17, 17, 5, 6, 16, 5, 7, 5,
873                             4, 5, 8, 4, 5, 16, 5, 11, 4, 6]),
874              'Reject null hypothesis': np.array([True, True, False, False,
875                                                  True, False, False, False,
876                                                  False, False, False, False,
877                                                  False, True, False, False,
878                                                  False, False],  dtype=bool)})
879         exp3 = pd.DataFrame(
880             {'W': np.array([16, 16, 17, 10, 17, 16, 16,
881                             15, 15, 15, 13, 10, 10, 10,
882                             9, 9, 9, 9]),
883              'Reject null hypothesis': np.array([True, True, True, False,
884 <a name="0"></a>                                                 True, True, True, True,
885                                                  True, True, True, False,
886                                                  False, False, False, False,
887                                                  False, False], dtype<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=bool)})
888         result1 = ancom(self.table4, self.cats4,
889                         multiple_comparisons_correction=None, tau=0.25)
890         result2 = ancom(self.table9, self.cats9,
891                         multiple_comparisons_correction=None, tau=0.02)
892         result3 = ancom(self.table10, self.cats10,
893                         multiple_comparisons_correction=None, tau=</b></font>0.02)
894         assert_data_frame_almost_equal(result1[0], exp1)
895         assert_data_frame_almost_equal(result2[0], exp2)
896         assert_data_frame_almost_equal(result3[0], exp3)
897     def test_ancom_theta(self):
898         result = ancom(self.table1, self.cats1, theta=0.3)
899         exp = pd.DataFrame(
900             {'W': np.array([5, 5, 2, 2, 2, 2, 2]),
901              'Reject null hypothesis': np.array([True, True, False, False,
902                                                  False, False, False],
903                                                 dtype=bool)})
904         assert_data_frame_almost_equal(result[0], exp)
905     def test_ancom_alpha(self):
906         result = ancom(self.table1, self.cats1,
907                        multiple_comparisons_correction=None, alpha=0.5)
908         exp = pd.DataFrame(
909             {'W': np.array([6, 6, 4, 5, 5, 4, 2]),
910              'Reject null hypothesis': np.array([True, True, False, True,
911                                                  True, False, False],
912                                                 dtype=bool)})
913         assert_data_frame_almost_equal(result[0], exp)
914     def test_ancom_fail_type(self):
915         with self.assertRaises(TypeError):
916             ancom(self.table1.values, self.cats1)
917         with self.assertRaises(TypeError):
918             ancom(self.table1, self.cats1.values)
919     def test_ancom_fail_zeros(self):
920         with self.assertRaises(ValueError):
921             ancom(self.bad1, self.cats2, multiple_comparisons_correction=None)
922     def test_ancom_fail_negative(self):
923         with self.assertRaises(ValueError):
924             ancom(self.bad2, self.cats2, multiple_comparisons_correction=None)
925     def test_ancom_fail_not_implemented_multiple_comparisons_correction(self):
926         with self.assertRaises(ValueError):
927             ancom(self.table2, self.cats2,
928                   multiple_comparisons_correction='fdr')
929     def test_ancom_fail_missing(self):
930         with self.assertRaises(ValueError):
931             ancom(self.bad3, self.cats1)
932         with self.assertRaises(ValueError):
933             ancom(self.table1, self.badcats1)
934     def test_ancom_fail_groups(self):
935         with self.assertRaises(ValueError):
936             ancom(self.table1, self.badcats2)
937     def test_ancom_fail_size_mismatch(self):
938         with self.assertRaises(ValueError):
939             ancom(self.table1, self.badcats3)
940     def test_ancom_fail_group_unique(self):
941         with self.assertRaises(ValueError):
942             ancom(self.table1, self.badcats4)
943     def test_ancom_fail_1_group(self):
944         with self.assertRaises(ValueError):
945             ancom(self.table1, self.badcats5)
946     def test_ancom_fail_tau(self):
947         with self.assertRaises(ValueError):
948             ancom(self.table1, self.cats1, tau=-1)
949         with self.assertRaises(ValueError):
950             ancom(self.table1, self.cats1, tau=1.1)
951     def test_ancom_fail_theta(self):
952         with self.assertRaises(ValueError):
953             ancom(self.table1, self.cats1, theta=-1)
954         with self.assertRaises(ValueError):
955             ancom(self.table1, self.cats1, theta=1.1)
956     def test_ancom_fail_alpha(self):
957         with self.assertRaises(ValueError):
958             ancom(self.table1, self.cats1, alpha=-1)
959         with self.assertRaises(ValueError):
960             ancom(self.table1, self.cats1, alpha=1.1)
961     def test_ancom_fail_multiple_groups(self):
962         with self.assertRaises(TypeError):
963             ancom(self.table4, self.cats4,
964                   significance_test=scipy.stats.ttest_ind)
965     def test_holm_bonferroni(self):
966         p = [0.005, 0.011, 0.02, 0.04, 0.13]
967         corrected_p = p * np.arange(1, 6)[::-1]
968         guessed_p = _holm_bonferroni(p)
969         for a, b in zip(corrected_p, guessed_p):
970             self.assertAlmostEqual(a, b)
971 if __name__ == "__main__":
972     main()
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>_testing.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import inspect
2 import os
3 import sys
4 import numpy as np
5 import numpy.testing as npt
6 import pandas.testing as pdt
7 from scipy.spatial.distance import pdist
8 from ._decorator import experimental
9 class ReallyEqualMixin:
10 <a name="1"></a>    def assertReallyEqual(self, a, b):
11         self<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertEqual(a, b)
12         self.assertEqual(b, a)
13         self.assertTrue(a == b)
14         self.assertTrue(b == a)
15         self.assertFalse(a != b)
16         self.assertFalse(b != a)
17 <a name="3"></a>    def</b></font> assertReallyNotEqual(self, a, b):
18         self<font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertNotEqual(a, b)
19         self.assertNotEqual(b, a)
20         self.assertFalse(a == b)
21         self.assertFalse(b == a)
22         self.assertTrue(a != b)
23         self.assertTrue(</b></font>b != a)
24 @experimental(as_of="0.4.0")
25 def get_data_path(fn, subfolder='data'):
26     callers_filename = inspect.getouterframes(inspect.currentframe())[1][1]
27     path = os.path.dirname(os.path.abspath(callers_filename))
28     data_path = os.path.join(path, subfolder, fn)
29     return data_path
30 @experimental(as_of="0.4.0")
31 def assert_ordination_results_equal(left, right, ignore_method_names=False,
32                                     ignore_axis_labels=False,
33                                     ignore_directionality=False,
34                                     decimal=7):
35     npt.assert_equal(type(left) is type(right), True)
36     if not ignore_method_names:
37         npt.assert_equal(left.short_method_name, right.short_method_name)
38         npt.assert_equal(left.long_method_name, right.long_method_name)
39 <a name="0"></a>
40     _assert_frame_dists_equal(left.samples, right.samples,
41                               ignore_columns=ignore_axis_labels,
42                               ignore_directionality<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=ignore_directionality,
43                               decimal=decimal)
44     _assert_frame_dists_equal(left.features, right.features,
45                               ignore_columns=ignore_axis_labels,
46                               ignore_directionality=ignore_directionality,
47                               decimal=decimal)
48     _assert_frame_dists_equal(left.biplot_scores, right.biplot_scores,
49                               ignore_columns=ignore_axis_labels,
50                               ignore_directionality=ignore_directionality,
51                               decimal=decimal)
52     _assert_frame_dists_equal(left.sample_constraints,
53                               right.sample_constraints,
54                               ignore_columns=ignore_axis_labels,
55                               ignore_directionality=</b></font>ignore_directionality,
56                               decimal=decimal)
57     _assert_series_equal(left.eigvals, right.eigvals, ignore_axis_labels,
58                          decimal=decimal)
59     _assert_series_equal(left.proportion_explained, right.proportion_explained,
60                          ignore_axis_labels,
61                          decimal=decimal)
62 def _assert_series_equal(left_s, right_s, ignore_index=False, decimal=7):
63     if left_s is None or right_s is None:
64         assert left_s is None and right_s is None
65     else:
66         npt.assert_almost_equal(left_s.values, right_s.values,
67                                 decimal=decimal)
68         if not ignore_index:
69             pdt.assert_index_equal(left_s.index, right_s.index)
70 def _assert_frame_dists_equal(left_df, right_df, ignore_index=False,
71                               ignore_columns=False,
72                               ignore_directionality=False, decimal=7):
73     if left_df is None or right_df is None:
74         assert left_df is None and right_df is None
75     else:
76         left_values = left_df.values
77         right_values = right_df.values
78         left_dists = pdist(left_values)
79         right_dists = pdist(right_values)
80         npt.assert_almost_equal(left_dists, right_dists, decimal=decimal)
81         if not ignore_index:
82             pdt.assert_index_equal(left_df.index, right_df.index)
83         if not ignore_columns:
84             pdt.assert_index_equal(left_df.columns, right_df.columns)
85 def _assert_frame_equal(left_df, right_df, ignore_index=False,
86                         ignore_columns=False, ignore_directionality=False,
87                         decimal=7):
88     if left_df is None or right_df is None:
89         assert left_df is None and right_df is None
90     else:
91         left_values = left_df.values
92         right_values = right_df.values
93         if ignore_directionality:
94             left_values, right_values = _normalize_signs(left_values,
95                                                          right_values)
96         npt.assert_almost_equal(left_values, right_values, decimal=decimal)
97         if not ignore_index:
98             pdt.assert_index_equal(left_df.index, right_df.index)
99         if not ignore_columns:
100             pdt.assert_index_equal(left_df.columns, right_df.columns)
101 def _normalize_signs(arr1, arr2):
102     arr1 = np.asarray(arr1, dtype=np.float64)
103     arr2 = np.asarray(arr2, dtype=np.float64)
104     if arr1.shape != arr2.shape:
105         raise ValueError(
106             "Arrays must have the same shape ({0} vs {1}).".format(arr1.shape,
107                                                                    arr2.shape)
108         )
109     max_idx = np.abs(arr1).argmax(axis=0)
110     max_arr1 <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= arr1[max_idx, range(arr1.shape[1])]
111     max_arr2 = arr2[max_idx, range(arr2.shape[1])]
112     sign_arr1 = np.sign(</b></font>max_arr1)
113     sign_arr2 = np.sign(max_arr2)
114     wrn = np.seterr(invalid='ignore', divide='ignore')
115     differences = sign_arr1 / sign_arr2
116     np.seterr(**wrn)
117     special_cases = (~np.isfinite(differences)) | (differences == 0)
118     differences[special_cases] = 1
119     return arr1 * differences, arr2
120 @experimental(as_of="0.4.0")
121 def assert_data_frame_almost_equal(left, right, rtol=1e-5):
122     pdt.assert_frame_equal(left, right,
123                            check_dtype=True,
124                            check_index_type=True,
125                            check_column_type=True,
126                            check_frame_type=True,
127                            check_names=True,
128                            by_blocks=False,
129                            check_exact=False,
130                            rtol=rtol)
131     assert_index_equal(left.index, right.index)
132 def assert_series_almost_equal(left, right):
133     pdt.assert_series_equal(left, right,
134                             check_dtype=True,
135                             check_index_type=True,
136                             check_series_type=True,
137                             check_names=True,
138                             check_exact=False,
139                             check_datetimelike_compat=False,
140                             obj='Series')
141     assert_index_equal(left.index, right.index)
142 def assert_index_equal(a, b):
143     pdt.assert_index_equal(a, b,
144                            exact=True,
145                            check_names=True,
146                            check_exact=True)
147 def pytestrunner():
148     try:
149         import numpy
150         try:
151             numpy.set_printoptions(legacy="1.13")
152         except TypeError:
153             pass
154     except ImportError:
155         numpy = None
156     try:
157         import pandas
158         pandas.options.display.max_columns = None
159     except ImportError:
160         pandas = None
161     import pytest
162     args = ['--pyargs', 'skbio', '--doctest-modules', '--doctest-glob',
163             '*.pyx', '-o', '"doctest_optionflags=NORMALIZE_WHITESPACE'
164             ' IGNORE_EXCEPTION_DETAIL"'] + sys.argv[1:]
165     errno = pytest.main(args=args)
166     sys.exit(errno)
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
