<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_site.py & test_kernelpkg.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_site.py & test_kernelpkg.py
      </h3>
      <h1 align="center">
        5.4%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_site.py (10.23622%)<TH>test_kernelpkg.py (3.7037036%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match54561-0.html#0',2,'match54561-1.html#0',3)" NAME="0">(19-23)<TD><A HREF="javascript:ZweiFrames('match54561-0.html#0',2,'match54561-1.html#0',3)" NAME="0">(53-55)</A><TD ALIGN=center><FONT COLOR="#ff0000">13</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_site.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
import pytest
import salt.states.apache_site as apache_site
from tests.support.mock import MagicMock, patch


@pytest.fixture
def configure_loader_modules():
    return {apache_site: {}}


def test_enabled():
    &quot;&quot;&quot;
    Test to ensure an Apache site is enabled.
    &quot;&quot;&quot;
    name = &quot;saltstack.com&quot;
<A NAME="0"></A>
    ret = {&quot;name&quot;: name, &quot;result&quot;: True, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}

    mock <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match54561-1.html#0',3,'match54561-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= MagicMock(side_effect=[True, False, False])
    mock_str = MagicMock(return_value={&quot;Status&quot;: [&quot;enabled&quot;]})
    with patch.dict(
        apache_site.__salt__,
        {&quot;apache.check_site_enabled&quot;</B></FONT>: mock, &quot;apache.a2ensite&quot;: mock_str},
    ):
        comt = &quot;{} already enabled.&quot;.format(name)
        ret.update({&quot;comment&quot;: comt})
        assert apache_site.enabled(name) == ret

        comt = &quot;Apache site {} is set to be enabled.&quot;.format(name)
        ret.update(
            {&quot;comment&quot;: comt, &quot;result&quot;: None, &quot;changes&quot;: {&quot;new&quot;: name, &quot;old&quot;: None}}
        )
        with patch.dict(apache_site.__opts__, {&quot;test&quot;: True}):
            assert apache_site.enabled(name) == ret

        comt = &quot;Failed to enable {} Apache site&quot;.format(name)
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False, &quot;changes&quot;: {}})
        with patch.dict(apache_site.__opts__, {&quot;test&quot;: False}):
            assert apache_site.enabled(name) == ret


def test_disabled():
    &quot;&quot;&quot;
    Test to ensure an Apache site is disabled.
    &quot;&quot;&quot;
    name = &quot;saltstack.com&quot;

    ret = {&quot;name&quot;: name, &quot;result&quot;: None, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}

    mock = MagicMock(side_effect=[True, True, False])
    mock_str = MagicMock(return_value={&quot;Status&quot;: [&quot;disabled&quot;]})
    with patch.dict(
        apache_site.__salt__,
        {&quot;apache.check_site_enabled&quot;: mock, &quot;apache.a2dissite&quot;: mock_str},
    ):
        comt = &quot;Apache site {} is set to be disabled.&quot;.format(name)
        ret.update({&quot;comment&quot;: comt, &quot;changes&quot;: {&quot;new&quot;: None, &quot;old&quot;: name}})
        with patch.dict(apache_site.__opts__, {&quot;test&quot;: True}):
            assert apache_site.disabled(name) == ret

        comt = &quot;Failed to disable {} Apache site&quot;.format(name)
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False, &quot;changes&quot;: {}})
        with patch.dict(apache_site.__opts__, {&quot;test&quot;: False}):
            assert apache_site.disabled(name) == ret

        comt = &quot;{} already disabled.&quot;.format(name)
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: True})
        assert apache_site.disabled(name) == ret
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_kernelpkg.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :synopsis: Unit Tests for 'module.aptkernelpkg'
    :platform: Linux
    :maturity: develop
    versionadded:: 2018.3.0
&quot;&quot;&quot;
# pylint: disable=invalid-name,no-member


try:
    # Import Salt Testing Libs
    from tests.support.mixins import LoaderModuleMockMixin
    from tests.support.unit import skipIf, TestCase
    from tests.support.mock import MagicMock, patch

    # Import Salt Libs
    import salt.states.kernelpkg as kernelpkg

    HAS_MODULES = True
except ImportError:
    HAS_MODULES = False

KERNEL_LIST = [&quot;4.4.0-70-generic&quot;, &quot;4.4.0-71-generic&quot;, &quot;4.5.1-14-generic&quot;]
STATE_NAME = &quot;kernelpkg-test&quot;


@skipIf(not HAS_MODULES, &quot;Salt modules could not be loaded&quot;)
class KernelPkgTestCase(TestCase, LoaderModuleMockMixin):
    &quot;&quot;&quot;
    Test cases for salt.states.aptpkg
    &quot;&quot;&quot;

    def setup_loader_modules(self):
        return {
            kernelpkg: {
                &quot;__salt__&quot;: {
                    &quot;system.reboot&quot;: MagicMock(return_value=None),
                    &quot;kernelpkg.upgrade&quot;: MagicMock(
                        return_value={
                            &quot;upgrades&quot;: {&quot;kernel&quot;: {&quot;old&quot;: &quot;1.0.0&quot;, &quot;new&quot;: &quot;2.0.0&quot;}}
                        }
                    ),
                    &quot;kernelpkg.active&quot;: MagicMock(return_value=0),
                    &quot;kernelpkg.latest_installed&quot;: MagicMock(return_value=0),
                }
            }
        }

    def test_latest_installed_with_changes(self):
<A NAME="0"></A>        &quot;&quot;&quot;
        Test - latest_installed when an upgrade is available
        &quot;&quot;&quot;
        installed <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match54561-0.html#0',2,'match54561-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= MagicMock(return_value=KERNEL_LIST[:-1])
        upgrade = MagicMock(return_value=KERNEL_LIST[-1])
        with patch.dict(kernelpkg.__salt__, {&quot;kernelpkg.list_installed&quot;</B></FONT>: installed}):
            with patch.dict(
                kernelpkg.__salt__, {&quot;kernelpkg.latest_available&quot;: upgrade}
            ):
                with patch.dict(kernelpkg.__opts__, {&quot;test&quot;: False}):
                    kernelpkg.__salt__[&quot;kernelpkg.upgrade&quot;].reset_mock()
                    ret = kernelpkg.latest_installed(name=STATE_NAME)
                    self.assertEqual(ret[&quot;name&quot;], STATE_NAME)
                    self.assertTrue(ret[&quot;result&quot;])
                    self.assertIsInstance(ret[&quot;changes&quot;], dict)
                    self.assertIsInstance(ret[&quot;comment&quot;], str)
                    kernelpkg.__salt__[&quot;kernelpkg.upgrade&quot;].assert_called_once()

                with patch.dict(kernelpkg.__opts__, {&quot;test&quot;: True}):
                    kernelpkg.__salt__[&quot;kernelpkg.upgrade&quot;].reset_mock()
                    ret = kernelpkg.latest_installed(name=STATE_NAME)
                    self.assertEqual(ret[&quot;name&quot;], STATE_NAME)
                    self.assertIsNone(ret[&quot;result&quot;])
                    self.assertDictEqual(ret[&quot;changes&quot;], {})
                    self.assertIsInstance(ret[&quot;comment&quot;], str)
                    kernelpkg.__salt__[&quot;kernelpkg.upgrade&quot;].assert_not_called()

    def test_latest_installed_at_latest(self):
        &quot;&quot;&quot;
        Test - latest_installed when no upgrade is available
        &quot;&quot;&quot;
        installed = MagicMock(return_value=KERNEL_LIST)
        upgrade = MagicMock(return_value=KERNEL_LIST[-1])
        with patch.dict(kernelpkg.__salt__, {&quot;kernelpkg.list_installed&quot;: installed}):
            with patch.dict(
                kernelpkg.__salt__, {&quot;kernelpkg.latest_available&quot;: upgrade}
            ):
                with patch.dict(kernelpkg.__opts__, {&quot;test&quot;: False}):
                    ret = kernelpkg.latest_installed(name=STATE_NAME)
                    self.assertEqual(ret[&quot;name&quot;], STATE_NAME)
                    self.assertTrue(ret[&quot;result&quot;])
                    self.assertDictEqual(ret[&quot;changes&quot;], {})
                    self.assertIsInstance(ret[&quot;comment&quot;], str)
                    kernelpkg.__salt__[&quot;kernelpkg.upgrade&quot;].assert_not_called()

                with patch.dict(kernelpkg.__opts__, {&quot;test&quot;: True}):
                    ret = kernelpkg.latest_installed(name=STATE_NAME)
                    self.assertEqual(ret[&quot;name&quot;], STATE_NAME)
                    self.assertTrue(ret[&quot;result&quot;])
                    self.assertDictEqual(ret[&quot;changes&quot;], {})
                    self.assertIsInstance(ret[&quot;comment&quot;], str)
                    kernelpkg.__salt__[&quot;kernelpkg.upgrade&quot;].assert_not_called()

    def test_latest_active_with_changes(self):
        &quot;&quot;&quot;
        Test - latest_active when a new kernel is available
        &quot;&quot;&quot;
        reboot = MagicMock(return_value=True)
        latest = MagicMock(return_value=1)
        with patch.dict(
            kernelpkg.__salt__,
            {&quot;kernelpkg.needs_reboot&quot;: reboot, &quot;kernelpkg.latest_installed&quot;: latest},
        ), patch.dict(kernelpkg.__opts__, {&quot;test&quot;: False}):
            kernelpkg.__salt__[&quot;system.reboot&quot;].reset_mock()
            ret = kernelpkg.latest_active(name=STATE_NAME)
            self.assertEqual(ret[&quot;name&quot;], STATE_NAME)
            self.assertTrue(ret[&quot;result&quot;])
            self.assertIsInstance(ret[&quot;changes&quot;], dict)
            self.assertIsInstance(ret[&quot;comment&quot;], str)
            kernelpkg.__salt__[&quot;system.reboot&quot;].assert_called_once()

            with patch.dict(kernelpkg.__opts__, {&quot;test&quot;: True}):
                kernelpkg.__salt__[&quot;system.reboot&quot;].reset_mock()
                ret = kernelpkg.latest_active(name=STATE_NAME)
                self.assertEqual(ret[&quot;name&quot;], STATE_NAME)
                self.assertIsNone(ret[&quot;result&quot;])
                self.assertDictEqual(ret[&quot;changes&quot;], {&quot;kernel&quot;: {&quot;new&quot;: 1, &quot;old&quot;: 0}})
                self.assertIsInstance(ret[&quot;comment&quot;], str)
                kernelpkg.__salt__[&quot;system.reboot&quot;].assert_not_called()

    def test_latest_active_at_latest(self):
        &quot;&quot;&quot;
        Test - latest_active when the newest kernel is already active
        &quot;&quot;&quot;
        reboot = MagicMock(return_value=False)
        with patch.dict(kernelpkg.__salt__, {&quot;kernelpkg.needs_reboot&quot;: reboot}):
            with patch.dict(kernelpkg.__opts__, {&quot;test&quot;: False}):
                kernelpkg.__salt__[&quot;system.reboot&quot;].reset_mock()
                ret = kernelpkg.latest_active(name=STATE_NAME)
                self.assertEqual(ret[&quot;name&quot;], STATE_NAME)
                self.assertTrue(ret[&quot;result&quot;])
                self.assertDictEqual(ret[&quot;changes&quot;], {})
                self.assertIsInstance(ret[&quot;comment&quot;], str)
                kernelpkg.__salt__[&quot;system.reboot&quot;].assert_not_called()

            with patch.dict(kernelpkg.__opts__, {&quot;test&quot;: True}):
                kernelpkg.__salt__[&quot;system.reboot&quot;].reset_mock()
                ret = kernelpkg.latest_active(name=STATE_NAME)
                self.assertEqual(ret[&quot;name&quot;], STATE_NAME)
                self.assertTrue(ret[&quot;result&quot;])
                self.assertDictEqual(ret[&quot;changes&quot;], {})
                self.assertIsInstance(ret[&quot;comment&quot;], str)
                kernelpkg.__salt__[&quot;system.reboot&quot;].assert_not_called()

    def test_latest_wait(self):
        &quot;&quot;&quot;
        Test - latest_wait static results
        &quot;&quot;&quot;
        ret = kernelpkg.latest_wait(name=STATE_NAME)
        self.assertEqual(ret[&quot;name&quot;], STATE_NAME)
        self.assertTrue(ret[&quot;result&quot;])
        self.assertDictEqual(ret[&quot;changes&quot;], {})
        self.assertIsInstance(ret[&quot;comment&quot;], str)
</PRE>
</div>
  </div>
</body>
</html>
