<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_disk_1.py &amp; test_mysql.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_disk_1.py &amp; test_mysql.py
      </h3>
<h1 align="center">
        7.1%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_disk_1.py (27.737226%)<th>test_mysql.py (4.112554%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(52-58)<td><a href="#" name="0">(352-364)</a><td align="center"><font color="#ff0000">14</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(78-83)<td><a href="#" name="1">(410-421)</a><td align="center"><font color="#da0000">12</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(62-67)<td><a href="#" name="2">(378-389)</a><td align="center"><font color="#da0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_disk_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import os
2 import shutil
3 import pytest
4 import salt.utils.platform
5 from tests.support.case import ModuleCase
6 from tests.support.unit import skipIf
7 @pytest.mark.windows_whitelisted
8 @skipIf(salt.utils.platform.is_darwin(), "No mtab on Darwin")
9 @skipIf(salt.utils.platform.is_freebsd(), "No mtab on FreeBSD")
10 @skipIf(salt.utils.platform.is_windows(), "No mtab on Windows")
11 @pytest.mark.destructive_test
12 class DiskModuleVirtualizationTest(ModuleCase):
13     def setUp(self):
14         if os.path.isfile("/etc/mtab"):
15             shutil.move("/etc/mtab", "/tmp/mtab")
16     def test_no_mtab(self):
17         ret = self.run_function("disk.usage")
18         self.assertDictEqual(ret, {})
19     def tearDown(self):
20         if os.path.isfile("/tmp/mtab"):
21             shutil.move("/tmp/mtab", "/etc/mtab")
22 @pytest.mark.windows_whitelisted
23 class DiskModuleTest(ModuleCase):
24     @pytest.mark.slow_test
25     def test_usage(self):
26         ret = self.run_function("disk.usage")
27         self.assertTrue(isinstance(ret, dict))
28             return
29         if salt.utils.platform.is_darwin():
30             for key, val in ret<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.items():
31                 self.assertTrue("filesystem" in val)
32                 self.assertTrue("512-blocks" in val)
33                 self.assertTrue("used" in val)
34                 self.assertTrue("available" in val)
35                 self.assertTrue("capacity" in val)
36                 self.assertTrue(</b></font>"iused" in val)
37                 self.assertTrue("%iused" in val)
38         else:
39             for key, val in ret<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.items():
40                 self.assertTrue("filesystem" in val)
41                 self.assertTrue("1K-blocks" in val)
42                 self.assertTrue("used" in val)
43                 self.assertTrue("available" in val)
44                 self.assertTrue(</b></font>"capacity" in val)
45     @skipIf(salt.utils.platform.is_windows(), "inode info not available on Windows")
46     def test_inodeusage(self):
47         ret = self.run_function("disk.inodeusage")
48         if not isinstance(ret, dict):
49             return
50         for key, val in ret<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.items():
51             self.assertTrue("inodes" in val)
52             self.assertTrue("used" in val)
53             self.assertTrue("free" in val)
54             self.assertTrue("use" in val)
55             self.assertTrue(</b></font>"filesystem" in val)
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_mysql.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import pytest
3 import salt.modules.mysql as mysql
4 from tests.support.mock import MagicMock, call, mock_open, patch
5 try:
6     import pymysql
7     HAS_PYMYSQL = True
8 except ImportError:
9     HAS_PYMYSQL = False
10 log = logging.getLogger(__name__)
11 __all_privileges__ = [
12     "ALTER",
13     "ALTER ROUTINE",
14     "BACKUP_ADMIN",
15     "BINLOG_ADMIN",
16     "CONNECTION_ADMIN",
17     "CREATE",
18     "CREATE ROLE",
19     "CREATE ROUTINE",
20     "CREATE TABLESPACE",
21     "CREATE TEMPORARY TABLES",
22     "CREATE USER",
23     "CREATE VIEW",
24     "DELETE",
25     "DROP",
26     "DROP ROLE",
27     "ENCRYPTION_KEY_ADMIN",
28     "EVENT",
29     "EXECUTE",
30     "FILE",
31     "GROUP_REPLICATION_ADMIN",
32     "INDEX",
33     "INSERT",
34     "LOCK TABLES",
35     "PERSIST_RO_VARIABLES_ADMIN",
36     "PROCESS",
37     "REFERENCES",
38     "RELOAD",
39     "REPLICATION CLIENT",
40     "REPLICATION SLAVE",
41     "REPLICATION_SLAVE_ADMIN",
42     "RESOURCE_GROUP_ADMIN",
43     "RESOURCE_GROUP_USER",
44     "ROLE_ADMIN",
45     "SELECT",
46     "SET_USER_ID",
47     "SHOW DATABASES",
48     "SHOW VIEW",
49     "SHUTDOWN",
50     "SUPER",
51     "SYSTEM_VARIABLES_ADMIN",
52     "TRIGGER",
53     "UPDATE",
54     "XA_RECOVER_ADMIN",
55 ]
56 pytestmark = [
57     pytest.mark.slow_test,
58     pytest.mark.skipif(
59         mysql.MySQLdb is None, reason="No python mysql client installed."
60     ),
61 ]
62 class MockMySQLConnect:
63     def __init__(self, *args, **kwargs):
64         self.args = args
65         self.kwargs = kwargs
66     def autocommit(self, *args, **kwards):
67         return True
68 @pytest.fixture
69 def configure_loader_modules():
70     return {mysql: {}}
71 def test_user_exists():
72     with patch.object(mysql, "version", return_value="8.0.10"):
73         _test_call(
74             mysql.user_exists,
75             {
76                 "sql": (
77                     "SELECT User,Host FROM mysql.user WHERE "
78                     "User = %(user)s AND Host = %(host)s AND "
79                     "Password = PASSWORD(%(password)s)"
80                 ),
81                 "sql_args": {
82                     "host": "localhost",
83                     "password": "BLUECOW",
84                     "user": "mytestuser",
85                 },
86             },
87             user="mytestuser",
88             host="localhost",
89             password="BLUECOW",
90         )
91     with patch.object(mysql, "version", return_value="10.1.38-MariaDB"):
92         _test_call(
93             mysql.user_exists,
94             {
95                 "sql": (
96                     "SELECT User,Host FROM mysql.user WHERE "
97                     "User = %(user)s AND Host = %(host)s AND "
98                     "Password = PASSWORD(%(password)s)"
99                 ),
100                 "sql_args": {
101                     "host": "localhost",
102                     "password": "BLUECOW",
103                     "user": "mytestuser",
104                 },
105             },
106             user="mytestuser",
107             host="localhost",
108             password="BLUECOW",
109         )
110     with patch.object(mysql, "version", return_value="8.0.11"):
111         _test_call(
112             mysql.user_exists,
113             {
114                 "sql": (
115                     "SELECT User,Host FROM mysql.user WHERE "
116                     "User = %(user)s AND Host = %(host)s"
117                 ),
118                 "sql_args": {"host": "localhost", "user": "mytestuser"},
119             },
120             user="mytestuser",
121             host="localhost",
122             password="BLUECOW",
123         )
124     with patch.object(mysql, "version", return_value="8.0.11"):
125         with patch.object(
126             mysql,
127             "__get_auth_plugin",
128             MagicMock(return_value="mysql_native_password"),
129         ):
130             _test_call(
131                 mysql.user_exists,
132                 {
133                     "sql": (
134                         "SELECT User,Host FROM mysql.user WHERE "
135                         "User = %(user)s AND Host = %(host)s AND "
136                         "Password = %(password)s"
137                     ),
138                     "sql_args": {
139                         "host": "%",
140                         "password": "*1A01CF8FBE6425398935FB90359AD8B817399102",
141                         "user": "mytestuser",
142                     },
143                 },
144                 user="mytestuser",
145                 host="%",
146                 password="BLUECOW",
147             )
148     with patch.object(mysql, "version", return_value="10.2.21-MariaDB"):
149         _test_call(
150             mysql.user_exists,
151             {
152                 "sql": (
153                     "SELECT User,Host FROM mysql.user WHERE "
154                     "User = %(user)s AND Host = %(host)s AND "
155                     "Password = PASSWORD(%(password)s)"
156                 ),
157                 "sql_args": {
158                     "host": "localhost",
159                     "password": "BLUECOW",
160                     "user": "mytestuser",
161                 },
162             },
163             user="mytestuser",
164             host="localhost",
165             password="BLUECOW",
166         )
167     with patch.object(
168         mysql, "version", side_effect=["", "10.2.21-MariaDB", "10.2.21-MariaDB"]
169     ):
170         _test_call(
171             mysql.user_exists,
172             {
173                 "sql": (
174                     "SELECT User,Host FROM mysql.user WHERE "
175                     "User = %(user)s AND Host = %(host)s AND "
176                     "Password = PASSWORD(%(password)s)"
177                 ),
178                 "sql_args": {
179                     "host": "localhost",
180                     "password": "new_pass",
181                     "user": "root",
182                 },
183             },
184             user="root",
185             host="localhost",
186             password="new_pass",
187             connection_user="root",
188             connection_pass="old_pass",
189         )
190     with patch.object(mysql, "version", return_value="8.0.10"):
191         with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
192             with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
193                 ret = mysql.user_create("testuser")
194                 assert not ret
195     with patch.object(mysql, "version", return_value="8.0.11"):
196         with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
197             with patch.object(mysql, "verify_login", MagicMock(return_value=True)):
198                 with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
199                     ret = mysql.user_create("testuser")
200                     assert not False
201 def test_user_create():
202     with patch.object(mysql, "version", return_value="8.0.10"):
203         with patch.object(
204             mysql,
205             "__get_auth_plugin",
206             MagicMock(return_value="mysql_native_password"),
207         ):
208             _test_call(
209                 mysql.user_create,
210                 {
211                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED BY %(password)s",
212                     "sql_args": {
213                         "password": "BLUECOW",
214                         "user": "testuser",
215                         "host": "localhost",
216                     },
217                 },
218                 "testuser",
219                 password="BLUECOW",
220             )
221     with patch.object(mysql, "version", return_value="8.0.11"):
222         with patch.object(
223             mysql,
224             "__get_auth_plugin",
225             MagicMock(return_value="mysql_native_password"),
226         ):
227             _test_call(
228                 mysql.user_create,
229                 {
230                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED WITH %(auth_plugin)s BY %(password)s",
231                     "sql_args": {
232                         "password": "BLUECOW",
233                         "auth_plugin": "mysql_native_password",
234                         "user": "testuser",
235                         "host": "localhost",
236                     },
237                 },
238                 "testuser",
239                 password="BLUECOW",
240             )
241     with patch.object(mysql, "version", return_value="8.0.10"):
242         with patch.object(mysql, "plugin_status", MagicMock(return_value="ACTIVE")):
243             _test_call(
244                 mysql.user_create,
245                 {
246                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED WITH auth_socket",
247                     "sql_args": {"user": "testuser", "host": "localhost"},
248                 },
249                 "testuser",
250                 allow_passwordless=True,
251                 unix_socket=True,
252             )
253     with patch.object(mysql, "version", return_value="10.2.21-MariaDB"):
254         with patch.object(mysql, "plugin_status", MagicMock(return_value="ACTIVE")):
255             _test_call(
256                 mysql.user_create,
257                 {
258                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED VIA unix_socket",
259                     "sql_args": {"user": "testuser", "host": "localhost"},
260                 },
261                 "testuser",
262                 allow_passwordless=True,
263                 unix_socket=True,
264             )
265     with patch.object(mysql, "version", side_effect=["", "8.0.10", "8.0.10"]):
266         with patch.object(
267             mysql, "user_exists", MagicMock(return_value=False)
268         ), patch.object(
269             mysql,
270             "__get_auth_plugin",
271             MagicMock(return_value="mysql_native_password"),
272         ):
273             _test_call(
274                 mysql.user_create,
275                 {
276                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED BY %(password)s",
277                     "sql_args": {
278                         "password": "new_pass",
279                         "user": "root",
280                         "host": "localhost",
281                     },
282                 },
283                 "root",
284                 password="new_pass",
285                 connection_user="root",
286                 connection_pass="old_pass",
287             )
288 def test_user_chpass():
289     connect_mock = MagicMock()
290     with patch.object(mysql, "_connect", connect_mock):
291         with patch.object(mysql, "version", return_value="8.0.10"):
292             with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
293                     mysql.user_chpass("testuser", password="BLUECOW")
294                     calls = (
295                         <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>call()
296                         .cursor()
297                         .execute(
298                             "UPDATE mysql.user SET Password=PASSWORD(%(password)s) WHERE User=%(user)s AND Host = %(host)s;",
299                             {
300                                 "password": "BLUECOW",
301                                 "user": "testuser",
302                                 "host": "localhost",
303                             },
304                         ),
305                         call().cursor().execute("FLUSH PRIVILEGES;"),
306                     )
307                     connect_mock.assert_has_calls(</b></font>calls, any_order=True)
308     connect_mock = MagicMock()
309     with patch.object(mysql, "_connect", connect_mock):
310         with patch.object(mysql, "version", return_value="8.0.11"):
311             with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
312                 with patch.object(
313                     mysql,
314                     "__get_auth_plugin",
315                     MagicMock(return_value="mysql_native_password"),
316                 ):
317                         mysql.user_chpass("testuser", password="BLUECOW")
318                         calls = (
319                             <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>call()
320                             .cursor()
321                             .execute(
322                                 "ALTER USER %(user)s@%(host)s IDENTIFIED WITH %(auth_plugin)s BY %(password)s;",
323                                 {
324                                     "password": "BLUECOW",
325                                     "user": "testuser",
326                                     "host": "localhost",
327                                     "auth_plugin": "mysql_native_password",
328                                 },
329                             ),
330                             call().cursor().execute(</b></font>"FLUSH PRIVILEGES;"),
331                         )
332                         connect_mock.assert_has_calls(calls, any_order=True)
333     connect_mock = MagicMock()
334     with patch.object(mysql, "_connect", connect_mock):
335         with patch.object(mysql, "version", side_effect=["", "8.0.11", "8.0.11"]):
336             with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
337                 with patch.object(
338                     mysql,
339                     "__get_auth_plugin",
340                     MagicMock(return_value="mysql_native_password"),
341                 ):
342                     with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
343                         mysql.user_chpass(
344                             "root",
345                             password="new_pass",
346                             connection_user="root",
347                         )
348                         calls = (
349                             <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>call()
350                             .cursor()
351                             .execute(
352                                 "ALTER USER %(user)s@%(host)s IDENTIFIED WITH %(auth_plugin)s BY %(password)s;",
353                                 {
354                                     "password": "new_pass",
355                                     "user": "root",
356                                     "host": "localhost",
357                                     "auth_plugin": "mysql_native_password",
358                                 },
359                             ),
360                             call().cursor().execute(</b></font>"FLUSH PRIVILEGES;"),
361                         )
362                         connect_mock.assert_has_calls(calls, any_order=True)
363 def test_user_remove():
364     with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
365         _test_call(
366             mysql.user_remove,
367             {
368                 "sql": "DROP USER %(user)s@%(host)s",
369                 "sql_args": {"user": "testuser", "host": "localhost"},
370             },
371             "testuser",
372         )
373 def test_db_check():
374     _test_call(
375         mysql.db_check,
376         "CHECK TABLE `test``'\" db`.`my``'\" table`",
377         "test`'\" db",
378         "my`'\" table",
379     )
380 def test_db_repair():
381     _test_call(
382         mysql.db_repair,
383         "REPAIR TABLE `test``'\" db`.`my``'\" table`",
384         "test`'\" db",
385         "my`'\" table",
386     )
387 def test_db_optimize():
388     _test_call(
389         mysql.db_optimize,
390         "OPTIMIZE TABLE `test``'\" db`.`my``'\" table`",
391         "test`'\" db",
392         "my`'\" table",
393     )
394 def test_db_remove():
395     with patch.object(mysql, "db_exists", MagicMock(return_value=True)):
396         _test_call(mysql.db_remove, "DROP DATABASE `test``'\" db`;", "test`'\" db")
397 def test_db_tables():
398     with patch.object(mysql, "db_exists", MagicMock(return_value=True)):
399         _test_call(mysql.db_tables, "SHOW TABLES IN `test``'\" db`", "test`'\" db")
400 def test_db_exists():
401     _test_call(
402         mysql.db_exists,
403         {
404             "sql": "SHOW DATABASES LIKE %(dbname)s;",
405             "sql_args": {"dbname": r"""test%_`" db"""},
406         },
407         'test%_`" db',
408     )
409 def test_db_create():
410     _test_call(
411         mysql.db_create,
412         "CREATE DATABASE IF NOT EXISTS `test``'\" db`;",
413         "test`'\" db",
414     )
415 def test_alter_db():
416     mock_get_db = {
417         "character_set": "utf8",
418         "collate": "utf8_unicode_ci",
419         "name": "my_test",
420     }
421     mock = MagicMock(return_value=mock_get_db)
422     with patch.object(mysql, "db_get", return_value=mock) as mock_db_get:
423         _test_call(
424             mysql.alter_db,
425             "ALTER DATABASE `my_test` CHARACTER SET utf8 COLLATE utf8_unicode_ci;",
426             "my_test",
427             "utf8",
428             "utf8_unicode_ci",
429         )
430 def test_user_list():
431     _test_call(mysql.user_list, "SELECT User,Host FROM mysql.user")
432 def test_user_info():
433     _test_call(
434         mysql.user_info,
435         {
436             "sql": "SELECT * FROM mysql.user WHERE User = %(user)s AND Host = %(host)s",
437             "sql_args": {"host": "localhost", "user": "mytestuser"},
438         },
439         "mytestuser",
440     )
441 def test_user_grants():
442     with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
443         _test_call(
444             mysql.user_grants,
445             {
446                 "sql": "SHOW GRANTS FOR %(user)s@%(host)s",
447                 "sql_args": {"host": "localhost", "user": "testuser"},
448             },
449             "testuser",
450         )
451 def test_grant_exists_true():
452     mock_grants = [
453         "GRANT USAGE ON *.* TO 'testuser'@'%'",
454         "GRANT SELECT, INSERT, UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'",
455         "GRANT SELECT(column1,column2) ON `testdb`.`testtableone` TO 'testuser'@'%'",
456         "GRANT SELECT(column1,column2), INSERT(column1,column2) ON `testdb`.`testtableone` TO 'testuser'@'%'",
457         "GRANT SELECT(column1,column2), UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'",
458         "GRANT SELECT ON `testdb`.`testtabletwo` TO 'testuser'@'%'",
459         "GRANT SELECT ON `testdb`.`testtablethree` TO 'testuser'@'%'",
460     ]
461     with patch.object(mysql, "version", return_value="5.6.41"):
462         mock = MagicMock(return_value=mock_grants)
463         with patch.object(
464             mysql, "user_grants", return_value=mock_grants
465         ) as mock_user_grants:
466             ret = mysql.grant_exists(
467                 "SELECT, INSERT, UPDATE", "testdb.testtableone", "testuser", "%"
468             )
469             assert ret
470 def test_grant_exists_false():
471     mock_grants = [
472         "GRANT USAGE ON *.* TO 'testuser'@'%'",
473         "GRANT SELECT, INSERT, UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'",
474         "GRANT SELECT(column1,column2) ON `testdb`.`testtableone` TO 'testuser'@'%'",
475         "GRANT SELECT(column1,column2), UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'",
476         "GRANT SELECT ON `testdb`.`testtablethree` TO 'testuser'@'%'",
477     ]
478     with patch.object(mysql, "version", return_value="5.6.41"):
479         mock = MagicMock(return_value=mock_grants)
480         with patch.object(
481             mysql, "user_grants", return_value=mock_grants
482         ) as mock_user_grants:
483             ret = mysql.grant_exists("SELECT", "testdb.testtabletwo", "testuser", "%")
484             assert not ret
485 def test_grant_exists_all():
486     mock_grants = ["GRANT ALL PRIVILEGES ON testdb.testtableone TO `testuser`@`%`"]
487     with patch.object(mysql, "version", return_value="8.0.10"):
488         mock = MagicMock(return_value=mock_grants)
489         with patch.object(
490             mysql, "user_grants", return_value=mock_grants
491         ) as mock_user_grants:
492             ret = mysql.grant_exists("ALL", "testdb.testtableone", "testuser", "%")
493             assert ret
494     with patch.object(mysql, "version", return_value="8.0.10"):
495         mock = MagicMock(return_value=mock_grants)
496         with patch.object(
497             mysql, "user_grants", return_value=mock_grants
498         ) as mock_user_grants:
499             ret = mysql.grant_exists(
500                 "all privileges", "testdb.testtableone", "testuser", "%"
501             )
502             assert ret
503     mock_grants = ["GRANT ALL PRIVILEGES ON testdb.testtableone TO `testuser`@`%`"]
504     with patch.object(mysql, "version", return_value="5.6.41"):
505         mock = MagicMock(return_value=mock_grants)
506         with patch.object(
507             mysql, "user_grants", return_value=mock_grants
508         ) as mock_user_grants:
509             ret = mysql.grant_exists(
510                 "ALL PRIVILEGES", "testdb.testtableone", "testuser", "%"
511             )
512             assert ret
513     mock_grants = [
514         "GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE, CREATE ROLE, DROP ROLE ON *.* TO `testuser`@`%`",
515         "GRANT BACKUP_ADMIN,BINLOG_ADMIN,CONNECTION_ADMIN,ENCRYPTION_KEY_ADMIN,GROUP_REPLICATION_ADMIN,PERSIST_RO_VARIABLES_ADMIN,REPLICATION_SLAVE_ADMIN,RESOURCE_GROUP_ADMIN,RESOURCE_GROUP_USER,ROLE_ADMIN,SET_USER_ID,SYSTEM_VARIABLES_ADMIN,XA_RECOVER_ADMIN ON *.* TO `testuser`@`%`",
516     ]
517     with patch.object(mysql, "version", return_value="8.0.10"):
518         mock = MagicMock(return_value=mock_grants)
519         with patch.object(
520             mysql, "user_grants", return_value=mock_grants
521         ) as mock_user_grants:
522             ret = mysql.grant_exists("ALL", "*.*", "testuser", "%")
523             assert ret
524     with patch.object(mysql, "version", return_value="8.0.10"):
525         mock = MagicMock(return_value=mock_grants)
526         with patch.object(
527             mysql, "user_grants", return_value=mock_grants
528         ) as mock_user_grants:
529             ret = mysql.grant_exists("all privileges", "*.*", "testuser", "%")
530             assert ret
531 @pytest.mark.skipif(True, reason="TODO: Mock up user_grants()")
532 def test_grant_add():
533     _test_call(
534         mysql.grant_add,
535         "",
536         "SELECT,INSERT,UPDATE",
537         "database.*",
538         "frank",
539         "localhost",
540     )
541 @pytest.mark.skipif(True, reason="TODO: Mock up user_grants()")
542 def test_grant_revoke():
543     _test_call(
544         mysql.grant_revoke,
545         "",
546         "SELECT,INSERT,UPDATE",
547         "database.*",
548         "frank",
549         "localhost",
550     )
551 def test_processlist():
552     _test_call(mysql.processlist, "SHOW FULL PROCESSLIST")
553 def test_get_master_status():
554     _test_call(mysql.get_master_status, "SHOW MASTER STATUS")
555 def test_get_slave_status():
556     _test_call(mysql.get_slave_status, "SHOW SLAVE STATUS")
557 def test_get_slave_status_bad_server():
558     connect_mock = MagicMock(return_value=None)
559     with patch.object(mysql, "_connect", connect_mock):
560         with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
561             rslt = mysql.get_slave_status()
562             connect_mock.assert_has_calls([call()])
563             assert rslt == []
564 @pytest.mark.skipif(
565     True, reason="MySQL module claims this function is not ready for production"
566 )
567 def test_free_slave():
568     pass
569 def test_query():
570     _test_call(mysql.query, "SELECT * FROM testdb", "testdb", "SELECT * FROM testdb")
571 @pytest.mark.skipif(not HAS_PYMYSQL, reason="Could not import pymysql")
572 def test_query_error():
573     connect_mock = MagicMock()
574     with patch.object(mysql, "_connect", connect_mock):
575         with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
576             side_effect = mysql.OperationalError(9999, "Something Went Wrong")
577             with patch.object(mysql, "_execute", MagicMock(side_effect=side_effect)):
578                 mysql.query("testdb", "SELECT * FROM testdb")
579         assert "mysql.error" in mysql.__context__
580         expected = "MySQL Error 9999: Something Went Wrong"
581         assert mysql.__context__["mysql.error"] == expected
582 def test_plugin_add():
583     with patch.object(mysql, "plugin_status", MagicMock(return_value="")):
584         _test_call(
585             mysql.plugin_add,
586             'INSTALL PLUGIN auth_socket SONAME "auth_socket.so"',
587             "auth_socket",
588         )
589 def test_plugin_remove():
590     with patch.object(mysql, "plugin_status", MagicMock(return_value="ACTIVE")):
591         _test_call(
592             mysql.plugin_remove,
593             "UNINSTALL PLUGIN auth_socket",
594             "auth_socket",
595         )
596 def test_plugin_status():
597     _test_call(
598         mysql.plugin_status,
599         {
600             "sql": "SELECT PLUGIN_STATUS FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = %(name)s",
601             "sql_args": {"name": "auth_socket"},
602         },
603         "auth_socket",
604     )
605 def test_sanitize_comment():
606     input_data = """/*
607     multiline
608     comment
609     */
610     CREATE TABLE test_update (a VARCHAR(25)); # end of line comment
611     insert into test_update values ("some #hash value");            -- ending comment
612     insert into test_update values ("crazy -- not comment"); -- another ending comment
613     -- another comment type
614     output = mysql._sanitize_comments(input_data)
615     assert output == expected_response
616     input_data = """-- --------------------------------------------------------
617                     -- SQL Commands to set up the pmadb as described in the documentation.
618                     --
619                     -- This file is meant for use with MySQL 5 and above!
620                     --
621                     -- This script expects the user pma to already be existing. If we would put a
622                     -- line here to create them too many users might just use this script and end
623                     -- up with having the same password for the controluser.
624                     --
625                     -- This user "pma" must be defined in config.inc.php (controluser/controlpass)
626                     --
627                     -- Please don't forget to set up the tablenames in config.inc.php
628                     --
629                     -- --------------------------------------------------------
630                     --
631                     CREATE DATABASE IF NOT EXISTS `phpmyadmin`
632                       DEFAULT CHARACTER SET utf8 COLLATE utf8_bin;
633                     USE phpmyadmin;
634     Test file_query
635     side_effect = [
636         {"query time": {"human": "0.4ms", "raw": "0.00038"}, "rows affected": 0},
637         {"query time": {"human": "8.9ms", "raw": "0.00893"}, "rows affected": 0},
638     ]
639     expected = {
640         "query time": {"human": "8.9ms", "raw": "0.00893"},
641         "rows affected": 0,
642     }
643     with patch("os.path.exists", MagicMock(return_value=True)):
644         with patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
645             with patch.object(mysql, "query", side_effect=side_effect):
646                 ret = mysql.file_query("database", "filename")
647                 assert ret, expected
648 @pytest.mark.skipif(not HAS_PYMYSQL, reason="Could not import pymysql")
649 def test__connect_pymysql_exception():
650     with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
651         with patch(
652             "MySQLdb.connect",
653             side_effect=pymysql.err.InternalError(
654                 1698, "Access denied for user 'root'@'localhost'"
655             ),
656         ):
657             ret = mysql._connect()
658             assert "mysql.error" in mysql.__context__
659             assert (
660                 mysql.__context__["mysql.error"]
661                 == "MySQL Error 1698: Access denied for user 'root'@'localhost'"
662             )
663 def test__connect_mysqldb_exception():
664     with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
665         with patch(
666             "MySQLdb.connect",
667             side_effect=mysql.OperationalError(
668                 1698, "Access denied for user 'root'@'localhost'"
669             ),
670         ):
671             ret = mysql._connect()
672             assert "mysql.error" in mysql.__context__
673             assert (
674                 mysql.__context__["mysql.error"]
675                 == "MySQL Error 1698: Access denied for user 'root'@'localhost'"
676             )
677 def test__connect_mysqldb():
678     mysqldb_connect_mock = MagicMock(autospec=True, return_value=MockMySQLConnect())
679     with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
680         with patch("MySQLdb.connect", mysqldb_connect_mock):
681             mysql._connect()
682             assert "mysql.error" not in mysql.__context__
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
