<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_disk_1.py &amp; test_mysql.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_disk_1.py &amp; test_mysql.py
      </h3>
<h1 align="center">
        7.1%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_disk_1.py (27.737226%)<th>test_mysql.py (4.112554%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(52-58)<td><a href="#" name="0">(352-364)</a><td align="center"><font color="#ff0000">14</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(78-83)<td><a href="#" name="1">(410-421)</a><td align="center"><font color="#da0000">12</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(62-67)<td><a href="#" name="2">(378-389)</a><td align="center"><font color="#da0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_disk_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import os
2 import shutil
3 import pytest
4 import salt.utils.platform
5 from tests.support.case import ModuleCase
6 from tests.support.unit import skipIf
7 @pytest.mark.windows_whitelisted
8 @skipIf(salt.utils.platform.is_darwin(), "No mtab on Darwin")
9 @skipIf(salt.utils.platform.is_freebsd(), "No mtab on FreeBSD")
10 @skipIf(salt.utils.platform.is_windows(), "No mtab on Windows")
11 @pytest.mark.destructive_test
12 class DiskModuleVirtualizationTest(ModuleCase):
13     def setUp(self):
14         if os.path.isfile("/etc/mtab"):
15             shutil.move("/etc/mtab", "/tmp/mtab")
16     def test_no_mtab(self):
17         ret = self.run_function("disk.usage")
18         self.assertDictEqual(ret, {})
19     def tearDown(self):
20         if os.path.isfile("/tmp/mtab"):
21             shutil.move("/tmp/mtab", "/etc/mtab")
22 @pytest.mark.windows_whitelisted
23 class DiskModuleTest(ModuleCase):
24     @pytest.mark.slow_test
25     def test_usage(self):
26         ret = self.run_function("disk.usage")
27         self.assertTrue(isinstance(ret, dict))
28 <a name="0"></a>        if not isinstance(ret, dict):
29             return
30         if salt.utils.platform.is_darwin():
31             for key, val in ret<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.items():
32                 self.assertTrue("filesystem" in val)
33                 self.assertTrue("512-blocks" in val)
34                 self.assertTrue("used" in val)
35                 self.assertTrue("available" in val)
36                 self.assertTrue("capacity" in val)
37                 self.assertTrue(</b></font>"iused" in val)
38 <a name="2"></a>                self.assertTrue("ifree" in val)
39                 self.assertTrue("%iused" in val)
40         else:
41             for key, val in ret<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.items():
42                 self.assertTrue("filesystem" in val)
43                 self.assertTrue("1K-blocks" in val)
44                 self.assertTrue("used" in val)
45                 self.assertTrue("available" in val)
46                 self.assertTrue(</b></font>"capacity" in val)
47     @skipIf(salt.utils.platform.is_windows(), "inode info not available on Windows")
48     def test_inodeusage(self):
49         ret = self.run_function("disk.inodeusage")
50 <a name="1"></a>        self.assertTrue(isinstance(ret, dict))
51         if not isinstance(ret, dict):
52             return
53         for key, val in ret<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.items():
54             self.assertTrue("inodes" in val)
55             self.assertTrue("used" in val)
56             self.assertTrue("free" in val)
57             self.assertTrue("use" in val)
58             self.assertTrue(</b></font>"filesystem" in val)
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_mysql.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import pytest
3 import salt.modules.mysql as mysql
4 from tests.support.mock import MagicMock, call, mock_open, patch
5 try:
6     import pymysql
7     HAS_PYMYSQL = True
8 except ImportError:
9     HAS_PYMYSQL = False
10 log = logging.getLogger(__name__)
11 __all_privileges__ = [
12     "ALTER",
13     "ALTER ROUTINE",
14     "BACKUP_ADMIN",
15     "BINLOG_ADMIN",
16     "CONNECTION_ADMIN",
17     "CREATE",
18     "CREATE ROLE",
19     "CREATE ROUTINE",
20     "CREATE TABLESPACE",
21     "CREATE TEMPORARY TABLES",
22     "CREATE USER",
23     "CREATE VIEW",
24     "DELETE",
25     "DROP",
26     "DROP ROLE",
27     "ENCRYPTION_KEY_ADMIN",
28     "EVENT",
29     "EXECUTE",
30     "FILE",
31     "GROUP_REPLICATION_ADMIN",
32     "INDEX",
33     "INSERT",
34     "LOCK TABLES",
35     "PERSIST_RO_VARIABLES_ADMIN",
36     "PROCESS",
37     "REFERENCES",
38     "RELOAD",
39     "REPLICATION CLIENT",
40     "REPLICATION SLAVE",
41     "REPLICATION_SLAVE_ADMIN",
42     "RESOURCE_GROUP_ADMIN",
43     "RESOURCE_GROUP_USER",
44     "ROLE_ADMIN",
45     "SELECT",
46     "SET_USER_ID",
47     "SHOW DATABASES",
48     "SHOW VIEW",
49     "SHUTDOWN",
50     "SUPER",
51     "SYSTEM_VARIABLES_ADMIN",
52     "TRIGGER",
53     "UPDATE",
54     "XA_RECOVER_ADMIN",
55 ]
56 pytestmark = [
57     pytest.mark.slow_test,
58     pytest.mark.skipif(
59         mysql.MySQLdb is None, reason="No python mysql client installed."
60     ),
61 ]
62 class MockMySQLConnect:
63     def __init__(self, *args, **kwargs):
64         self.args = args
65         self.kwargs = kwargs
66     def autocommit(self, *args, **kwards):
67         return True
68 @pytest.fixture
69 def configure_loader_modules():
70     return {mysql: {}}
71 def test_user_exists():
72     with patch.object(mysql, "version", return_value="8.0.10"):
73         _test_call(
74             mysql.user_exists,
75             {
76                 "sql": (
77                     "SELECT User,Host FROM mysql.user WHERE "
78                     "User = %(user)s AND Host = %(host)s AND "
79                     "Password = PASSWORD(%(password)s)"
80                 ),
81                 "sql_args": {
82                     "host": "localhost",
83                     "password": "BLUECOW",
84                     "user": "mytestuser",
85                 },
86             },
87             user="mytestuser",
88             host="localhost",
89             password="BLUECOW",
90         )
91     with patch.object(mysql, "version", return_value="10.1.38-MariaDB"):
92         _test_call(
93             mysql.user_exists,
94             {
95                 "sql": (
96                     "SELECT User,Host FROM mysql.user WHERE "
97                     "User = %(user)s AND Host = %(host)s AND "
98                     "Password = PASSWORD(%(password)s)"
99                 ),
100                 "sql_args": {
101                     "host": "localhost",
102                     "password": "BLUECOW",
103                     "user": "mytestuser",
104                 },
105             },
106             user="mytestuser",
107             host="localhost",
108             password="BLUECOW",
109         )
110     with patch.object(mysql, "version", return_value="8.0.11"):
111         _test_call(
112             mysql.user_exists,
113             {
114                 "sql": (
115                     "SELECT User,Host FROM mysql.user WHERE "
116                     "User = %(user)s AND Host = %(host)s"
117                 ),
118                 "sql_args": {"host": "localhost", "user": "mytestuser"},
119             },
120             user="mytestuser",
121             host="localhost",
122             password="BLUECOW",
123         )
124     with patch.object(mysql, "version", return_value="8.0.11"):
125         with patch.object(
126             mysql,
127             "__get_auth_plugin",
128             MagicMock(return_value="mysql_native_password"),
129         ):
130             _test_call(
131                 mysql.user_exists,
132                 {
133                     "sql": (
134                         "SELECT User,Host FROM mysql.user WHERE "
135                         "User = %(user)s AND Host = %(host)s AND "
136                         "Password = %(password)s"
137                     ),
138                     "sql_args": {
139                         "host": "%",
140                         "password": "*1A01CF8FBE6425398935FB90359AD8B817399102",
141                         "user": "mytestuser",
142                     },
143                 },
144                 user="mytestuser",
145                 host="%",
146                 password="BLUECOW",
147             )
148     with patch.object(mysql, "version", return_value="10.2.21-MariaDB"):
149         _test_call(
150             mysql.user_exists,
151             {
152                 "sql": (
153                     "SELECT User,Host FROM mysql.user WHERE "
154                     "User = %(user)s AND Host = %(host)s AND "
155                     "Password = PASSWORD(%(password)s)"
156                 ),
157                 "sql_args": {
158                     "host": "localhost",
159                     "password": "BLUECOW",
160                     "user": "mytestuser",
161                 },
162             },
163             user="mytestuser",
164             host="localhost",
165             password="BLUECOW",
166         )
167     with patch.object(
168         mysql, "version", side_effect=["", "10.2.21-MariaDB", "10.2.21-MariaDB"]
169     ):
170         _test_call(
171             mysql.user_exists,
172             {
173                 "sql": (
174                     "SELECT User,Host FROM mysql.user WHERE "
175                     "User = %(user)s AND Host = %(host)s AND "
176                     "Password = PASSWORD(%(password)s)"
177                 ),
178                 "sql_args": {
179                     "host": "localhost",
180                     "password": "new_pass",
181                     "user": "root",
182                 },
183             },
184             user="root",
185             host="localhost",
186             password="new_pass",
187             connection_user="root",
188             connection_pass="old_pass",
189         )
190     with patch.object(mysql, "version", return_value="8.0.10"):
191         with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
192             with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
193                 ret = mysql.user_create("testuser")
194                 assert not ret
195     with patch.object(mysql, "version", return_value="8.0.11"):
196         with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
197             with patch.object(mysql, "verify_login", MagicMock(return_value=True)):
198                 with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
199                     ret = mysql.user_create("testuser")
200                     assert not False
201 def test_user_create():
202     with patch.object(mysql, "version", return_value="8.0.10"):
203         with patch.object(
204             mysql,
205             "__get_auth_plugin",
206             MagicMock(return_value="mysql_native_password"),
207         ):
208             _test_call(
209                 mysql.user_create,
210                 {
211                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED BY %(password)s",
212                     "sql_args": {
213                         "password": "BLUECOW",
214                         "user": "testuser",
215                         "host": "localhost",
216                     },
217                 },
218                 "testuser",
219                 password="BLUECOW",
220             )
221     with patch.object(mysql, "version", return_value="8.0.11"):
222         with patch.object(
223             mysql,
224             "__get_auth_plugin",
225             MagicMock(return_value="mysql_native_password"),
226         ):
227             _test_call(
228                 mysql.user_create,
229                 {
230                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED WITH %(auth_plugin)s BY %(password)s",
231                     "sql_args": {
232                         "password": "BLUECOW",
233                         "auth_plugin": "mysql_native_password",
234                         "user": "testuser",
235                         "host": "localhost",
236                     },
237                 },
238                 "testuser",
239                 password="BLUECOW",
240             )
241     with patch.object(mysql, "version", return_value="8.0.10"):
242         with patch.object(mysql, "plugin_status", MagicMock(return_value="ACTIVE")):
243             _test_call(
244                 mysql.user_create,
245                 {
246                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED WITH auth_socket",
247                     "sql_args": {"user": "testuser", "host": "localhost"},
248                 },
249                 "testuser",
250                 allow_passwordless=True,
251                 unix_socket=True,
252             )
253     with patch.object(mysql, "version", return_value="10.2.21-MariaDB"):
254         with patch.object(mysql, "plugin_status", MagicMock(return_value="ACTIVE")):
255             _test_call(
256                 mysql.user_create,
257                 {
258                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED VIA unix_socket",
259                     "sql_args": {"user": "testuser", "host": "localhost"},
260                 },
261                 "testuser",
262                 allow_passwordless=True,
263                 unix_socket=True,
264             )
265     with patch.object(mysql, "version", side_effect=["", "8.0.10", "8.0.10"]):
266         with patch.object(
267             mysql, "user_exists", MagicMock(return_value=False)
268         ), patch.object(
269             mysql,
270             "__get_auth_plugin",
271             MagicMock(return_value="mysql_native_password"),
272         ):
273             _test_call(
274                 mysql.user_create,
275                 {
276                     "sql": "CREATE USER %(user)s@%(host)s IDENTIFIED BY %(password)s",
277                     "sql_args": {
278                         "password": "new_pass",
279                         "user": "root",
280                         "host": "localhost",
281                     },
282                 },
283                 "root",
284                 password="new_pass",
285                 connection_user="root",
286                 connection_pass="old_pass",
287             )
288 def test_user_chpass():
289     connect_mock = MagicMock()
290     with patch.object(mysql, "_connect", connect_mock):
291         with patch.object(mysql, "version", return_value="8.0.10"):
292             with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
293 <a name="0"></a>                with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
294                     mysql.user_chpass("testuser", password="BLUECOW")
295                     calls = (
296                         <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>call()
297                         .cursor()
298                         .execute(
299                             "UPDATE mysql.user SET Password=PASSWORD(%(password)s) WHERE User=%(user)s AND Host = %(host)s;",
300                             {
301                                 "password": "BLUECOW",
302                                 "user": "testuser",
303                                 "host": "localhost",
304                             },
305                         ),
306                         call().cursor().execute("FLUSH PRIVILEGES;"),
307                     )
308                     connect_mock.assert_has_calls(</b></font>calls, any_order=True)
309     connect_mock = MagicMock()
310     with patch.object(mysql, "_connect", connect_mock):
311         with patch.object(mysql, "version", return_value="8.0.11"):
312             with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
313                 with patch.object(
314                     mysql,
315                     "__get_auth_plugin",
316                     MagicMock(return_value="mysql_native_password"),
317                 ):
318 <a name="2"></a>                    with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
319                         mysql.user_chpass("testuser", password="BLUECOW")
320                         calls = (
321                             <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>call()
322                             .cursor()
323                             .execute(
324                                 "ALTER USER %(user)s@%(host)s IDENTIFIED WITH %(auth_plugin)s BY %(password)s;",
325                                 {
326                                     "password": "BLUECOW",
327                                     "user": "testuser",
328                                     "host": "localhost",
329                                     "auth_plugin": "mysql_native_password",
330                                 },
331                             ),
332                             call().cursor().execute(</b></font>"FLUSH PRIVILEGES;"),
333                         )
334                         connect_mock.assert_has_calls(calls, any_order=True)
335     connect_mock = MagicMock()
336     with patch.object(mysql, "_connect", connect_mock):
337         with patch.object(mysql, "version", side_effect=["", "8.0.11", "8.0.11"]):
338             with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
339                 with patch.object(
340                     mysql,
341                     "__get_auth_plugin",
342                     MagicMock(return_value="mysql_native_password"),
343                 ):
344                     with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
345                         mysql.user_chpass(
346                             "root",
347                             password="new_pass",
348                             connection_user="root",
349 <a name="1"></a>                            connection_pass="old_pass",
350                         )
351                         calls = (
352                             <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>call()
353                             .cursor()
354                             .execute(
355                                 "ALTER USER %(user)s@%(host)s IDENTIFIED WITH %(auth_plugin)s BY %(password)s;",
356                                 {
357                                     "password": "new_pass",
358                                     "user": "root",
359                                     "host": "localhost",
360                                     "auth_plugin": "mysql_native_password",
361                                 },
362                             ),
363                             call().cursor().execute(</b></font>"FLUSH PRIVILEGES;"),
364                         )
365                         connect_mock.assert_has_calls(calls, any_order=True)
366 def test_user_remove():
367     with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
368         _test_call(
369             mysql.user_remove,
370             {
371                 "sql": "DROP USER %(user)s@%(host)s",
372                 "sql_args": {"user": "testuser", "host": "localhost"},
373             },
374             "testuser",
375         )
376 def test_db_check():
377     _test_call(
378         mysql.db_check,
379         "CHECK TABLE `test``'\" db`.`my``'\" table`",
380         "test`'\" db",
381         "my`'\" table",
382     )
383 def test_db_repair():
384     _test_call(
385         mysql.db_repair,
386         "REPAIR TABLE `test``'\" db`.`my``'\" table`",
387         "test`'\" db",
388         "my`'\" table",
389     )
390 def test_db_optimize():
391     _test_call(
392         mysql.db_optimize,
393         "OPTIMIZE TABLE `test``'\" db`.`my``'\" table`",
394         "test`'\" db",
395         "my`'\" table",
396     )
397 def test_db_remove():
398     with patch.object(mysql, "db_exists", MagicMock(return_value=True)):
399         _test_call(mysql.db_remove, "DROP DATABASE `test``'\" db`;", "test`'\" db")
400 def test_db_tables():
401     with patch.object(mysql, "db_exists", MagicMock(return_value=True)):
402         _test_call(mysql.db_tables, "SHOW TABLES IN `test``'\" db`", "test`'\" db")
403 def test_db_exists():
404     _test_call(
405         mysql.db_exists,
406         {
407             "sql": "SHOW DATABASES LIKE %(dbname)s;",
408             "sql_args": {"dbname": r"""test%_`" db"""},
409         },
410         'test%_`" db',
411     )
412 def test_db_create():
413     _test_call(
414         mysql.db_create,
415         "CREATE DATABASE IF NOT EXISTS `test``'\" db`;",
416         "test`'\" db",
417     )
418 def test_alter_db():
419     mock_get_db = {
420         "character_set": "utf8",
421         "collate": "utf8_unicode_ci",
422         "name": "my_test",
423     }
424     mock = MagicMock(return_value=mock_get_db)
425     with patch.object(mysql, "db_get", return_value=mock) as mock_db_get:
426         _test_call(
427             mysql.alter_db,
428             "ALTER DATABASE `my_test` CHARACTER SET utf8 COLLATE utf8_unicode_ci;",
429             "my_test",
430             "utf8",
431             "utf8_unicode_ci",
432         )
433 def test_user_list():
434     _test_call(mysql.user_list, "SELECT User,Host FROM mysql.user")
435 def test_user_info():
436     _test_call(
437         mysql.user_info,
438         {
439             "sql": "SELECT * FROM mysql.user WHERE User = %(user)s AND Host = %(host)s",
440             "sql_args": {"host": "localhost", "user": "mytestuser"},
441         },
442         "mytestuser",
443     )
444 def test_user_grants():
445     with patch.object(mysql, "user_exists", MagicMock(return_value=True)):
446         _test_call(
447             mysql.user_grants,
448             {
449                 "sql": "SHOW GRANTS FOR %(user)s@%(host)s",
450                 "sql_args": {"host": "localhost", "user": "testuser"},
451             },
452             "testuser",
453         )
454 def test_grant_exists_true():
455     mock_grants = [
456         "GRANT USAGE ON *.* TO 'testuser'@'%'",
457         "GRANT SELECT, INSERT, UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'",
458         "GRANT SELECT(column1,column2) ON `testdb`.`testtableone` TO 'testuser'@'%'",
459         "GRANT SELECT(column1,column2), INSERT(column1,column2) ON `testdb`.`testtableone` TO 'testuser'@'%'",
460         "GRANT SELECT(column1,column2), UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'",
461         "GRANT SELECT ON `testdb`.`testtabletwo` TO 'testuser'@'%'",
462         "GRANT SELECT ON `testdb`.`testtablethree` TO 'testuser'@'%'",
463     ]
464     with patch.object(mysql, "version", return_value="5.6.41"):
465         mock = MagicMock(return_value=mock_grants)
466         with patch.object(
467             mysql, "user_grants", return_value=mock_grants
468         ) as mock_user_grants:
469             ret = mysql.grant_exists(
470                 "SELECT, INSERT, UPDATE", "testdb.testtableone", "testuser", "%"
471             )
472             assert ret
473 def test_grant_exists_false():
474     mock_grants = [
475         "GRANT USAGE ON *.* TO 'testuser'@'%'",
476         "GRANT SELECT, INSERT, UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'",
477         "GRANT SELECT(column1,column2) ON `testdb`.`testtableone` TO 'testuser'@'%'",
478         "GRANT SELECT(column1,column2), UPDATE ON `testdb`.`testtableone` TO 'testuser'@'%'",
479         "GRANT SELECT ON `testdb`.`testtablethree` TO 'testuser'@'%'",
480     ]
481     with patch.object(mysql, "version", return_value="5.6.41"):
482         mock = MagicMock(return_value=mock_grants)
483         with patch.object(
484             mysql, "user_grants", return_value=mock_grants
485         ) as mock_user_grants:
486             ret = mysql.grant_exists("SELECT", "testdb.testtabletwo", "testuser", "%")
487             assert not ret
488 def test_grant_exists_all():
489     mock_grants = ["GRANT ALL PRIVILEGES ON testdb.testtableone TO `testuser`@`%`"]
490     with patch.object(mysql, "version", return_value="8.0.10"):
491         mock = MagicMock(return_value=mock_grants)
492         with patch.object(
493             mysql, "user_grants", return_value=mock_grants
494         ) as mock_user_grants:
495             ret = mysql.grant_exists("ALL", "testdb.testtableone", "testuser", "%")
496             assert ret
497     with patch.object(mysql, "version", return_value="8.0.10"):
498         mock = MagicMock(return_value=mock_grants)
499         with patch.object(
500             mysql, "user_grants", return_value=mock_grants
501         ) as mock_user_grants:
502             ret = mysql.grant_exists(
503                 "all privileges", "testdb.testtableone", "testuser", "%"
504             )
505             assert ret
506     mock_grants = ["GRANT ALL PRIVILEGES ON testdb.testtableone TO `testuser`@`%`"]
507     with patch.object(mysql, "version", return_value="5.6.41"):
508         mock = MagicMock(return_value=mock_grants)
509         with patch.object(
510             mysql, "user_grants", return_value=mock_grants
511         ) as mock_user_grants:
512             ret = mysql.grant_exists(
513                 "ALL PRIVILEGES", "testdb.testtableone", "testuser", "%"
514             )
515             assert ret
516     mock_grants = [
517         "GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE, CREATE ROLE, DROP ROLE ON *.* TO `testuser`@`%`",
518         "GRANT BACKUP_ADMIN,BINLOG_ADMIN,CONNECTION_ADMIN,ENCRYPTION_KEY_ADMIN,GROUP_REPLICATION_ADMIN,PERSIST_RO_VARIABLES_ADMIN,REPLICATION_SLAVE_ADMIN,RESOURCE_GROUP_ADMIN,RESOURCE_GROUP_USER,ROLE_ADMIN,SET_USER_ID,SYSTEM_VARIABLES_ADMIN,XA_RECOVER_ADMIN ON *.* TO `testuser`@`%`",
519     ]
520     with patch.object(mysql, "version", return_value="8.0.10"):
521         mock = MagicMock(return_value=mock_grants)
522         with patch.object(
523             mysql, "user_grants", return_value=mock_grants
524         ) as mock_user_grants:
525             ret = mysql.grant_exists("ALL", "*.*", "testuser", "%")
526             assert ret
527     with patch.object(mysql, "version", return_value="8.0.10"):
528         mock = MagicMock(return_value=mock_grants)
529         with patch.object(
530             mysql, "user_grants", return_value=mock_grants
531         ) as mock_user_grants:
532             ret = mysql.grant_exists("all privileges", "*.*", "testuser", "%")
533             assert ret
534 @pytest.mark.skipif(True, reason="TODO: Mock up user_grants()")
535 def test_grant_add():
536     _test_call(
537         mysql.grant_add,
538         "",
539         "SELECT,INSERT,UPDATE",
540         "database.*",
541         "frank",
542         "localhost",
543     )
544 @pytest.mark.skipif(True, reason="TODO: Mock up user_grants()")
545 def test_grant_revoke():
546     _test_call(
547         mysql.grant_revoke,
548         "",
549         "SELECT,INSERT,UPDATE",
550         "database.*",
551         "frank",
552         "localhost",
553     )
554 def test_processlist():
555     _test_call(mysql.processlist, "SHOW FULL PROCESSLIST")
556 def test_get_master_status():
557     _test_call(mysql.get_master_status, "SHOW MASTER STATUS")
558 def test_get_slave_status():
559     _test_call(mysql.get_slave_status, "SHOW SLAVE STATUS")
560 def test_get_slave_status_bad_server():
561     connect_mock = MagicMock(return_value=None)
562     with patch.object(mysql, "_connect", connect_mock):
563         with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
564             rslt = mysql.get_slave_status()
565             connect_mock.assert_has_calls([call()])
566             assert rslt == []
567 @pytest.mark.skipif(
568     True, reason="MySQL module claims this function is not ready for production"
569 )
570 def test_free_slave():
571     pass
572 def test_query():
573     _test_call(mysql.query, "SELECT * FROM testdb", "testdb", "SELECT * FROM testdb")
574 @pytest.mark.skipif(not HAS_PYMYSQL, reason="Could not import pymysql")
575 def test_query_error():
576     connect_mock = MagicMock()
577     with patch.object(mysql, "_connect", connect_mock):
578         with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
579             side_effect = mysql.OperationalError(9999, "Something Went Wrong")
580             with patch.object(mysql, "_execute", MagicMock(side_effect=side_effect)):
581                 mysql.query("testdb", "SELECT * FROM testdb")
582         assert "mysql.error" in mysql.__context__
583         expected = "MySQL Error 9999: Something Went Wrong"
584         assert mysql.__context__["mysql.error"] == expected
585 def test_plugin_add():
586     with patch.object(mysql, "plugin_status", MagicMock(return_value="")):
587         _test_call(
588             mysql.plugin_add,
589             'INSTALL PLUGIN auth_socket SONAME "auth_socket.so"',
590             "auth_socket",
591         )
592 def test_plugin_remove():
593     with patch.object(mysql, "plugin_status", MagicMock(return_value="ACTIVE")):
594         _test_call(
595             mysql.plugin_remove,
596             "UNINSTALL PLUGIN auth_socket",
597             "auth_socket",
598         )
599 def test_plugin_status():
600     _test_call(
601         mysql.plugin_status,
602         {
603             "sql": "SELECT PLUGIN_STATUS FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = %(name)s",
604             "sql_args": {"name": "auth_socket"},
605         },
606         "auth_socket",
607     )
608 def test_sanitize_comment():
609     input_data = """/*
610     multiline
611     comment
612     */
613     CREATE TABLE test_update (a VARCHAR(25)); # end of line comment
614     insert into test_update values ("some #hash value");            -- ending comment
615     insert into test_update values ("crazy -- not comment"); -- another ending comment
616     -- another comment type
617     output = mysql._sanitize_comments(input_data)
618     assert output == expected_response
619     input_data = """-- --------------------------------------------------------
620                     -- SQL Commands to set up the pmadb as described in the documentation.
621                     --
622                     -- This file is meant for use with MySQL 5 and above!
623                     --
624                     -- This script expects the user pma to already be existing. If we would put a
625                     -- line here to create them too many users might just use this script and end
626                     -- up with having the same password for the controluser.
627                     --
628                     -- This user "pma" must be defined in config.inc.php (controluser/controlpass)
629                     --
630                     -- Please don't forget to set up the tablenames in config.inc.php
631                     --
632                     -- --------------------------------------------------------
633                     --
634                     CREATE DATABASE IF NOT EXISTS `phpmyadmin`
635                       DEFAULT CHARACTER SET utf8 COLLATE utf8_bin;
636                     USE phpmyadmin;
637     Test file_query
638     side_effect = [
639         {"query time": {"human": "0.4ms", "raw": "0.00038"}, "rows affected": 0},
640         {"query time": {"human": "8.9ms", "raw": "0.00893"}, "rows affected": 0},
641     ]
642     expected = {
643         "query time": {"human": "8.9ms", "raw": "0.00893"},
644         "rows affected": 0,
645     }
646     with patch("os.path.exists", MagicMock(return_value=True)):
647         with patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
648             with patch.object(mysql, "query", side_effect=side_effect):
649                 ret = mysql.file_query("database", "filename")
650                 assert ret, expected
651 @pytest.mark.skipif(not HAS_PYMYSQL, reason="Could not import pymysql")
652 def test__connect_pymysql_exception():
653     with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
654         with patch(
655             "MySQLdb.connect",
656             side_effect=pymysql.err.InternalError(
657                 1698, "Access denied for user 'root'@'localhost'"
658             ),
659         ):
660             ret = mysql._connect()
661             assert "mysql.error" in mysql.__context__
662             assert (
663                 mysql.__context__["mysql.error"]
664                 == "MySQL Error 1698: Access denied for user 'root'@'localhost'"
665             )
666 def test__connect_mysqldb_exception():
667     with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
668         with patch(
669             "MySQLdb.connect",
670             side_effect=mysql.OperationalError(
671                 1698, "Access denied for user 'root'@'localhost'"
672             ),
673         ):
674             ret = mysql._connect()
675             assert "mysql.error" in mysql.__context__
676             assert (
677                 mysql.__context__["mysql.error"]
678                 == "MySQL Error 1698: Access denied for user 'root'@'localhost'"
679             )
680 def test__connect_mysqldb():
681     mysqldb_connect_mock = MagicMock(autospec=True, return_value=MockMySQLConnect())
682     with patch.dict(mysql.__salt__, {"config.option": MagicMock()}):
683         with patch("MySQLdb.connect", mysqldb_connect_mock):
684             mysql._connect()
685             assert "mysql.error" not in mysql.__context__
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
