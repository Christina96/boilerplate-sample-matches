<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_sql_base.py & test_policy.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_sql_base.py & test_policy.py
      </h3>
      <h1 align="center">
        16.6%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_sql_base.py (19.67213%)<TH>test_policy.py (14.457831%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match8625-0.html#0',2,'match8625-1.html#0',3)" NAME="0">(31-34)<TD><A HREF="javascript:ZweiFrames('match8625-0.html#0',2,'match8625-1.html#0',3)" NAME="0">(26-41)</A><TD ALIGN=center><FONT COLOR="#ff0000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_sql_base.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
import pytest
import salt.pillar.sql_base as sql_base
from tests.support.mock import MagicMock


class FakeExtPillar(sql_base.SqlBaseExtPillar):
    &quot;&quot;&quot;
    Mock SqlBaseExtPillar implementation for testing purpose
    &quot;&quot;&quot;

    @classmethod
    def _db_name(cls):
        return &quot;fake&quot;

    def _get_cursor(self):
        return MagicMock()


@pytest.mark.parametrize(&quot;as_list&quot;, [True, False])
def test_process_results_as_json(as_list):
    &quot;&quot;&quot;
    Validates merging of dict values returned from JSON datatype.
    &quot;&quot;&quot;
    return_data = FakeExtPillar()
    return_data.as_list = as_list
    return_data.as_json = True
    return_data.with_lists = None
<A NAME="0"></A>    return_data.enter_root(None)
    return_data.process_fields([&quot;json_data&quot;], 0)
    test_dicts = [
        <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match8625-1.html#0',3,'match8625-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>({&quot;a&quot;: [1]},),
        ({&quot;b&quot;: [2, 3]},),
        ({&quot;a&quot;: [4]},),
        ({&quot;c&quot;: {&quot;d&quot;: [4</B></FONT>, 5], &quot;e&quot;: 6}},),
        ({&quot;f&quot;: [{&quot;g&quot;: 7, &quot;h&quot;: &quot;test&quot;}], &quot;c&quot;: {&quot;g&quot;: 8}},),
    ]
    return_data.process_results(test_dicts)
    assert return_data.result == {
        &quot;a&quot;: [1, 4] if as_list else [4],
        &quot;b&quot;: [2, 3],
        &quot;c&quot;: {&quot;d&quot;: [4, 5], &quot;e&quot;: 6, &quot;g&quot;: 8},
        &quot;f&quot;: [{&quot;g&quot;: 7, &quot;h&quot;: &quot;test&quot;}],
    }
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_policy.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
Integration tests for the rabbitmq_policy states
&quot;&quot;&quot;

import logging

import pytest
import salt.modules.rabbitmq as rabbitmq
import salt.states.rabbitmq_policy as rabbitmq_policy
from tests.support.mock import MagicMock, patch

log = logging.getLogger(__name__)

pytestmark = [
    pytest.mark.slow_test,
    pytest.mark.skip_on_freebsd(reason=&quot;No Docker on FreeBSD available&quot;),
    pytest.mark.skip_if_binaries_missing(
        &quot;docker&quot;, &quot;dockerd&quot;, reason=&quot;Docker not installed&quot;
    ),
]


<A NAME="0"></A>@pytest.fixture
def configure_loader_modules(docker_cmd_run_all_wrapper):
    return {
        <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match8625-0.html#0',2,'match8625-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>rabbitmq_policy: {
            &quot;__salt__&quot;: {
                &quot;rabbitmq.set_policy&quot;: rabbitmq.set_policy,
                &quot;rabbitmq.delete_policy&quot;: rabbitmq.delete_policy,
                &quot;rabbitmq.policy_exists&quot;: rabbitmq.policy_exists,
                &quot;rabbitmq.list_policies&quot;: rabbitmq.list_policies,
            },
            &quot;__opts__&quot;: {&quot;test&quot;: False},
            &quot;_utils__&quot;: {},
        },
        rabbitmq: {
            &quot;__salt__&quot;: {
                &quot;rabbitmq.list_policies&quot;: rabbitmq.list_policies,
                &quot;cmd.run_all&quot;: docker_cmd_run_all_wrapper,
            },
            &quot;__grains__&quot;: {&quot;os_family&quot;</B></FONT>: &quot;Linux&quot;},
            &quot;__opts__&quot;: {},
            &quot;_utils__&quot;: {},
        },
    }


@pytest.mark.slow_test
def test_present_absent(rabbitmq_container):
    &quot;&quot;&quot;
    Test rabbitmq_policy.present and rabbitmq_policy.absent
    &quot;&quot;&quot;

    with patch.dict(rabbitmq.__salt__, {&quot;pkg.version&quot;: MagicMock(return_value=&quot;3.8&quot;)}):
        # Clear the policy
        ret = rabbitmq_policy.present(
            name=&quot;HA&quot;, pattern=&quot;.*&quot;, definition={&quot;ha-mode&quot;: &quot;all&quot;}
        )
        expected = {
            &quot;name&quot;: &quot;HA&quot;,
            &quot;result&quot;: True,
            &quot;comment&quot;: (
                'Setting policy &quot;HA&quot; for pattern &quot;.*&quot; to &quot;{&quot;ha-mode&quot;: &quot;all&quot;}&quot; with'
                ' priority &quot;0&quot; for vhost &quot;/&quot; ...\n'
            ),
            &quot;changes&quot;: {&quot;old&quot;: {}, &quot;new&quot;: &quot;HA&quot;},
        }
        assert ret == expected

        # Delete the policy
        ret = rabbitmq_policy.absent(&quot;HA&quot;)
        expected = {
            &quot;name&quot;: &quot;HA&quot;,
            &quot;result&quot;: True,
            &quot;comment&quot;: &quot;Deleted&quot;,
            &quot;changes&quot;: {&quot;new&quot;: &quot;&quot;, &quot;old&quot;: &quot;HA&quot;},
        }

        assert ret == expected


def test_absent(rabbitmq_container):
    &quot;&quot;&quot;
    Test rabbitmq_policy.absent
    &quot;&quot;&quot;

    with patch.dict(rabbitmq.__salt__, {&quot;pkg.version&quot;: MagicMock(return_value=&quot;3.8&quot;)}):
        # Delete the policy
        ret = rabbitmq_policy.absent(&quot;HA&quot;)
        expected = {
            &quot;name&quot;: &quot;HA&quot;,
            &quot;result&quot;: True,
            &quot;comment&quot;: &quot;Policy '/ HA' is not present.&quot;,
            &quot;changes&quot;: {},
        }

        assert ret == expected
</PRE>
</div>
  </div>
</body>
</html>
