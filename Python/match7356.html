<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_composer_1.py & test_mount.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_composer_1.py & test_mount.py
      </h3>
      <h1 align="center">
        18.1%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_composer_1.py (52.33918%)<TH>test_mount.py (10.961421%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match7356-0.html#0',2,'match7356-1.html#0',3)" NAME="0">(178-183)<TD><A HREF="javascript:ZweiFrames('match7356-0.html#0',2,'match7356-1.html#0',3)" NAME="0">(313-318)</A><TD ALIGN=center><FONT COLOR="#ff0000">17</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match7356-0.html#1',2,'match7356-1.html#1',3)" NAME="1">(43-49)<TD><A HREF="javascript:ZweiFrames('match7356-0.html#1',2,'match7356-1.html#1',3)" NAME="1">(269-274)</A><TD ALIGN=center><FONT COLOR="#ff0000">17</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match7356-0.html#2',2,'match7356-1.html#2',3)" NAME="2">(128-131)<TD><A HREF="javascript:ZweiFrames('match7356-0.html#2',2,'match7356-1.html#2',3)" NAME="2">(584-587)</A><TD ALIGN=center><FONT COLOR="#e10000">15</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match7356-0.html#3',2,'match7356-1.html#3',3)" NAME="3">(105-108)<TD><A HREF="javascript:ZweiFrames('match7356-0.html#3',2,'match7356-1.html#3',3)" NAME="3">(574-577)</A><TD ALIGN=center><FONT COLOR="#e10000">15</FONT>
<TR><TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match7356-0.html#4',2,'match7356-1.html#4',3)" NAME="4">(96-99)<TD><A HREF="javascript:ZweiFrames('match7356-0.html#4',2,'match7356-1.html#4',3)" NAME="4">(562-565)</A><TD ALIGN=center><FONT COLOR="#e10000">15</FONT>
<TR><TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT><TD><A HREF="javascript:ZweiFrames('match7356-0.html#5',2,'match7356-1.html#5',3)" NAME="5">(166-174)<TD><A HREF="javascript:ZweiFrames('match7356-0.html#5',2,'match7356-1.html#5',3)" NAME="5">(254-264)</A><TD ALIGN=center><FONT COLOR="#d20000">14</FONT>
<TR><TD BGCOLOR="#8c8774"><FONT COLOR="#8c8774">-</FONT><TD><A HREF="javascript:ZweiFrames('match7356-0.html#6',2,'match7356-1.html#6',3)" NAME="6">(74-84)<TD><A HREF="javascript:ZweiFrames('match7356-0.html#6',2,'match7356-1.html#6',3)" NAME="6">(850-859)</A><TD ALIGN=center><FONT COLOR="#c30000">13</FONT>
<TR><TD BGCOLOR="#38a4a5"><FONT COLOR="#38a4a5">-</FONT><TD><A HREF="javascript:ZweiFrames('match7356-0.html#7',2,'match7356-1.html#7',3)" NAME="7">(71-74)<TD><A HREF="javascript:ZweiFrames('match7356-0.html#7',2,'match7356-1.html#7',3)" NAME="7">(147-151)</A><TD ALIGN=center><FONT COLOR="#c30000">13</FONT>
<TR><TD BGCOLOR="#c58917"><FONT COLOR="#c58917">-</FONT><TD><A HREF="javascript:ZweiFrames('match7356-0.html#8',2,'match7356-1.html#8',3)" NAME="8">(191-193)<TD><A HREF="javascript:ZweiFrames('match7356-0.html#8',2,'match7356-1.html#8',3)" NAME="8">(205-208)</A><TD ALIGN=center><FONT COLOR="#b40000">12</FONT>
<TR><TD BGCOLOR="#83a33a"><FONT COLOR="#83a33a">-</FONT><TD><A HREF="javascript:ZweiFrames('match7356-0.html#9',2,'match7356-1.html#9',3)" NAME="9">(159-162)<TD><A HREF="javascript:ZweiFrames('match7356-0.html#9',2,'match7356-1.html#9',3)" NAME="9">(549-552)</A><TD ALIGN=center><FONT COLOR="#b40000">12</FONT>
<TR><TD BGCOLOR="#ad5910"><FONT COLOR="#ad5910">-</FONT><TD><A HREF="javascript:ZweiFrames('match7356-0.html#10',2,'match7356-1.html#10',3)" NAME="10">(154-156)<TD><A HREF="javascript:ZweiFrames('match7356-0.html#10',2,'match7356-1.html#10',3)" NAME="10">(178-181)</A><TD ALIGN=center><FONT COLOR="#b40000">12</FONT>
<TR><TD BGCOLOR="#b041ff"><FONT COLOR="#b041ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match7356-0.html#11',2,'match7356-1.html#11',3)" NAME="11">(149-152)<TD><A HREF="javascript:ZweiFrames('match7356-0.html#11',2,'match7356-1.html#11',3)" NAME="11">(542-545)</A><TD ALIGN=center><FONT COLOR="#b40000">12</FONT>
<TR><TD BGCOLOR="#571b7e"><FONT COLOR="#571b7e">-</FONT><TD><A HREF="javascript:ZweiFrames('match7356-0.html#12',2,'match7356-1.html#12',3)" NAME="12">(87-90)<TD><A HREF="javascript:ZweiFrames('match7356-0.html#12',2,'match7356-1.html#12',3)" NAME="12">(535-538)</A><TD ALIGN=center><FONT COLOR="#b40000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_composer_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Rupesh Tare &lt;rupesht@saltstack.com&gt;
&quot;&quot;&quot;


import salt.modules.composer as composer
from salt.exceptions import (
    CommandExecutionError,
    CommandNotFoundError,
    SaltInvocationError,
)
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import MagicMock, patch
from tests.support.unit import TestCase


class ComposerTestCase(TestCase, LoaderModuleMockMixin):
    &quot;&quot;&quot;
    Test cases for salt.modules.composer
    &quot;&quot;&quot;

    def setup_loader_modules(self):
        return {composer: {}}

    def test_install(self):
        &quot;&quot;&quot;
        Test for Install composer dependencies for a directory.
        &quot;&quot;&quot;

        # Test _valid_composer=False throws exception
        mock = MagicMock(return_value=False)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
            self.assertRaises(CommandNotFoundError, composer.install, &quot;d&quot;)

        # Test no directory specified throws exception
        mock = MagicMock(return_value=True)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
            self.assertRaises(SaltInvocationError, composer.install, None)

<A NAME="1"></A>        # Test `composer install` exit status != 0 throws exception
        mock = MagicMock(return_value=True)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
            mock = MagicMock(return_value={<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match7356-1.html#1',3,'match7356-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>&quot;retcode&quot;: 1, &quot;stderr&quot;: &quot;A&quot;})
            with patch.dict(composer.__salt__, {&quot;cmd.run_all&quot;: mock}):
                self.assertRaises(CommandExecutionError, composer.install, &quot;d&quot;)

        # Test success with quiet=True returns True
        mock = MagicMock(return_value=True)
        with patch.object(</B></FONT>composer, &quot;_valid_composer&quot;, mock):
            mock = MagicMock(return_value={&quot;retcode&quot;: 0, &quot;stderr&quot;: &quot;A&quot;})
            with patch.dict(composer.__salt__, {&quot;cmd.run_all&quot;: mock}):
                self.assertTrue(
                    composer.install(
                        &quot;dir&quot;,
                        None,
                        None,
                        None,
                        None,
                        None,
                        None,
                        None,
                        None,
                        None,
                        True,
                    )
                )

<A NAME="7"></A>        # Test success with quiet=False returns object
        mock = MagicMock(return_value=True)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
<A NAME="6"></A>            rval = {<FONT color="#38a4a5"><A HREF="javascript:ZweiFrames('match7356-1.html#7',3,'match7356-top.html#7',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>&quot;retcode&quot;: 0, &quot;stderr&quot;: &quot;A&quot;, &quot;stdout&quot;: &quot;B&quot;}
            mock = MagicMock(return_value=rval)
            with patch.dict(composer.__salt__, {&quot;cmd.run_all&quot;: mock}):
                self.assertEqual(composer.install(</B></FONT><FONT color="#8c8774"><A HREF="javascript:ZweiFrames('match7356-1.html#6',3,'match7356-top.html#6',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>&quot;dir&quot;), rval)

    def test_update(self):
        &quot;&quot;&quot;
        Test for Update composer dependencies for a directory.
        &quot;&quot;&quot;

        # Test _valid_composer=False throws exception
        mock = MagicMock(return_value=False)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
<A NAME="12"></A>            self.assertRaises(CommandNotFoundError, composer.</B></FONT>update, &quot;d&quot;)

        # Test no directory specified throws exception
        mock <FONT color="#571b7e"><A HREF="javascript:ZweiFrames('match7356-1.html#12',3,'match7356-top.html#12',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= MagicMock(return_value=True)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
            mock = MagicMock(return_value=True)
            with patch.object(</B></FONT>composer, &quot;did_composer_install&quot;, mock):
                self.assertRaises(SaltInvocationError, composer.update, None)

<A NAME="4"></A>        # Test update with error exit status throws exception
        mock = MagicMock(return_value=True)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
            mock <FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match7356-1.html#4',3,'match7356-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= MagicMock(return_value=True)
            with patch.object(composer, &quot;did_composer_install&quot;, mock):
                mock = MagicMock(return_value={&quot;retcode&quot;: 1, &quot;stderr&quot;: &quot;A&quot;})
                with patch.dict(composer.__salt__, {&quot;cmd.run_all&quot;</B></FONT>: mock}):
                    self.assertRaises(CommandExecutionError, composer.update, &quot;d&quot;)

<A NAME="3"></A>        # Test update with existing vendor directory and quiet=True
        mock = MagicMock(return_value=True)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
            mock <FONT color="#53858b"><A HREF="javascript:ZweiFrames('match7356-1.html#3',3,'match7356-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= MagicMock(return_value=True)
            with patch.object(composer, &quot;did_composer_install&quot;, mock):
                mock = MagicMock(return_value={&quot;retcode&quot;: 0, &quot;stderr&quot;: &quot;A&quot;})
                with patch.dict(composer.__salt__, {&quot;cmd.run_all&quot;</B></FONT>: mock}):
                    self.assertTrue(
                        composer.update(
                            &quot;dir&quot;,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            True,
                        )
                    )

<A NAME="2"></A>        # Test update with no vendor directory and quiet=True
        mock = MagicMock(return_value=True)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
            mock <FONT color="#980517"><A HREF="javascript:ZweiFrames('match7356-1.html#2',3,'match7356-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= MagicMock(return_value=False)
            with patch.object(composer, &quot;did_composer_install&quot;, mock):
                mock = MagicMock(return_value={&quot;retcode&quot;: 0, &quot;stderr&quot;: &quot;A&quot;})
                with patch.dict(composer.__salt__, {&quot;cmd.run_all&quot;</B></FONT>: mock}):
                    self.assertTrue(
                        composer.update(
                            &quot;dir&quot;,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            True,
                        )
<A NAME="11"></A>                    )

        # Test update with existing vendor directory
        mock <FONT color="#b041ff"><A HREF="javascript:ZweiFrames('match7356-1.html#11',3,'match7356-top.html#11',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= MagicMock(return_value=True)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
<A NAME="10"></A>            mock = MagicMock(return_value=True)
            with patch.object(</B></FONT>composer, &quot;did_composer_install&quot;, mock):
                rval = {&quot;retcode&quot;: 0, &quot;stderr&quot;: &quot;A&quot;, &quot;stdout&quot;: &quot;B&quot;}
                mock <FONT color="#ad5910"><A HREF="javascript:ZweiFrames('match7356-1.html#10',3,'match7356-top.html#10',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= MagicMock(return_value=rval)
                with patch.dict(composer.__salt__, {&quot;cmd.run_all&quot;: mock}):
<A NAME="9"></A>                    self.assertEqual(composer.update(</B></FONT>&quot;dir&quot;), rval)

        # Test update with no vendor directory
        mock <FONT color="#83a33a"><A HREF="javascript:ZweiFrames('match7356-1.html#9',3,'match7356-top.html#9',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= MagicMock(return_value=True)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
            mock = MagicMock(return_value=False)
            with patch.object(</B></FONT>composer, &quot;did_composer_install&quot;, mock):
<A NAME="5"></A>                rval = {&quot;retcode&quot;: 0, &quot;stderr&quot;: &quot;A&quot;, &quot;stdout&quot;: &quot;B&quot;}
                mock = MagicMock(return_value=rval)
                with patch.dict(composer.__salt__, {&quot;cmd.run_all&quot;: mock}):
                    self.assertEqual(composer<FONT color="#151b8d"><A HREF="javascript:ZweiFrames('match7356-1.html#5',3,'match7356-top.html#5',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.update(&quot;dir&quot;), rval)

    def test_selfupdate(self):
        &quot;&quot;&quot;
        Test for Composer selfupdate
        &quot;&quot;&quot;
        mock = MagicMock(return_value=False)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
            self.</B></FONT>assertRaises(CommandNotFoundError, composer.selfupdate)
<A NAME="0"></A>
        mock = MagicMock(return_value=True)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
            mock = MagicMock(return_value={<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match7356-1.html#0',3,'match7356-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>&quot;retcode&quot;: 1, &quot;stderr&quot;: &quot;A&quot;})
            with patch.dict(composer.__salt__, {&quot;cmd.run_all&quot;: mock}):
                self.assertRaises(CommandExecutionError, composer.selfupdate)

        mock = MagicMock(return_value=True)
        with patch.object(</B></FONT>composer, &quot;_valid_composer&quot;, mock):
            mock = MagicMock(return_value={&quot;retcode&quot;: 0, &quot;stderr&quot;: &quot;A&quot;})
            with patch.dict(composer.__salt__, {&quot;cmd.run_all&quot;: mock}):
                self.assertTrue(composer.selfupdate(quiet=True))

<A NAME="8"></A>        mock = MagicMock(return_value=True)
        with patch.object(composer, &quot;_valid_composer&quot;, mock):
            rval = {&quot;retcode&quot;: 0, &quot;stderr&quot;: &quot;A&quot;, &quot;stdout&quot;: &quot;B&quot;}
            mock <FONT color="#c58917"><A HREF="javascript:ZweiFrames('match7356-1.html#8',3,'match7356-top.html#8',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= MagicMock(return_value=rval)
            with patch.dict(composer.__salt__, {&quot;cmd.run_all&quot;: mock}):
                self.assertEqual(composer.selfupdate(</B></FONT>), rval)
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_mount.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Rupesh Tare &lt;rupesht@saltstack.com&gt;
&quot;&quot;&quot;

import logging
import os
import shutil
import sys
import textwrap

import pytest
import salt.modules.mount as mount
import salt.utils.files
import salt.utils.path
from salt.exceptions import CommandExecutionError
from tests.support.mock import MagicMock, mock_open, patch

log = logging.getLogger(__name__)


@pytest.fixture
def mock_shell_file():
    return &quot;A B C D F G\n&quot;


@pytest.fixture
def config_initial_file():
    inital_fsystem = [
        &quot;/:\n&quot;,
        &quot;\tdev\t\t= /dev/hd4\n&quot;,
        &quot;\tvfs\t\t= jfs2\n&quot;,
        &quot;\tlog\t\t= /dev/hd8\n&quot;,
        &quot;\tmount \t\t= automatic\n&quot;,
        &quot;\tcheck\t\t= false\n&quot;,
        &quot;\ttype\t\t= bootfs\n&quot;,
        &quot;\tvol\t\t= root\n&quot;,
        &quot;\tfree\t\t= true\n&quot;,
        &quot;\n&quot;,
        &quot;/home:\n&quot;,
        &quot;\tdev\t\t= /dev/hd1\n&quot;,
        &quot;\tvfs\t\t= jfs2\n&quot;,
        &quot;\tlog\t\t= /dev/hd8\n&quot;,
        &quot;\tmount\t\t= true\n&quot;,
        &quot;\tcheck\t\t= true\n&quot;,
        &quot;\tvol\t\t= /home\n&quot;,
        &quot;\tfree\t\t= false\n&quot;,
        &quot;\n&quot;,
    ]
    return inital_fsystem


@pytest.fixture
def configure_loader_modules():
    return {mount: {}}


@pytest.fixture
def tmp_sub_dir(tmp_path):
    directory = tmp_path / &quot;filesystems-dir&quot;
    directory.mkdir()

    yield directory

    shutil.rmtree(str(directory))


@pytest.fixture
def config_file(tmp_sub_dir, config_initial_file):
    filename = str(tmp_sub_dir / &quot;filesystems&quot;)

    with salt.utils.files.fopen(filename, &quot;wb&quot;) as fp:
        fp.writelines(salt.utils.data.encode(config_initial_file))

    yield filename

    os.remove(filename)


def test_active():
    &quot;&quot;&quot;
    List the active mounts.
    &quot;&quot;&quot;
    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;FreeBSD&quot;, &quot;kernel&quot;: &quot;FreeBSD&quot;}):
        # uid=user1 tests the improbable case where a OS returns a name
        # instead of a numeric id, for #25293
        mock = MagicMock(return_value=&quot;A B C D,E,F,uid=user1,gid=grp1&quot;)
        mock_user = MagicMock(return_value={&quot;uid&quot;: &quot;100&quot;})
        mock_group = MagicMock(return_value={&quot;gid&quot;: &quot;100&quot;})
        with patch.dict(
            mount.__salt__,
            {
                &quot;cmd.run_stdout&quot;: mock,
                &quot;user.info&quot;: mock_user,
                &quot;group.info&quot;: mock_group,
            },
        ):
            assert mount.active() == {
                &quot;B&quot;: {
                    &quot;device&quot;: &quot;A&quot;,
                    &quot;opts&quot;: [&quot;D&quot;, &quot;E&quot;, &quot;F&quot;, &quot;uid=100&quot;, &quot;gid=100&quot;],
                    &quot;fstype&quot;: &quot;C&quot;,
                }
            }

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;Solaris&quot;, &quot;kernel&quot;: &quot;SunOS&quot;}):
        mock = MagicMock(return_value=&quot;A * B * C D/E/F&quot;)
        with patch.dict(mount.__salt__, {&quot;cmd.run_stdout&quot;: mock}):
            assert mount.active() == {
                &quot;B&quot;: {&quot;device&quot;: &quot;A&quot;, &quot;opts&quot;: [&quot;D&quot;, &quot;E&quot;, &quot;F&quot;], &quot;fstype&quot;: &quot;C&quot;}
            }

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;AIX&quot;, &quot;kernel&quot;: &quot;AIX&quot;}):
        mock = MagicMock(return_value=&quot;A * B * C D/E/F&quot;)
        with patch.dict(mount.__salt__, {&quot;cmd.run_stdout&quot;: mock}):
            assert mount.active() == {&quot;B&quot;: {&quot;node&quot;: &quot;A&quot;, &quot;device&quot;: &quot;*&quot;, &quot;fstype&quot;: &quot;*&quot;}}

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;OpenBSD&quot;, &quot;kernel&quot;: &quot;OpenBSD&quot;}):
        mock = MagicMock(return_value={})
        with patch.object(mount, &quot;_active_mounts_openbsd&quot;, mock):
            assert mount.active() == {}

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;MacOS&quot;, &quot;kernel&quot;: &quot;Darwin&quot;}):
        mock = MagicMock(return_value={})
        with patch.object(mount, &quot;_active_mounts_darwin&quot;, mock):
            assert mount.active() == {}

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;MacOS&quot;, &quot;kernel&quot;: &quot;Darwin&quot;}):
        mock = MagicMock(return_value={})
        with patch.object(mount, &quot;_active_mountinfo&quot;, mock):
            with patch.object(mount, &quot;_active_mounts_darwin&quot;, mock):
                assert mount.active(extended=True) == {}

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;AIX&quot;, &quot;kernel&quot;: &quot;AIX&quot;}):
        mock = MagicMock(return_value={})
        with patch.object(mount, &quot;_active_mounts_aix&quot;, mock):
            assert mount.active() == {}


def test_fstab():
    &quot;&quot;&quot;
    List the content of the fstab
    &quot;&quot;&quot;
    mock = MagicMock(return_value=False)
<A NAME="7"></A>    with patch.object(os.path, &quot;isfile&quot;, mock):
        assert mount.fstab() == {}

    file_data = &quot;\n&quot;.join([<FONT color="#38a4a5"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7356-0.html#7',2,'match7356-top.html#7',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>&quot;#&quot;, &quot;A B C D,E,F G H&quot;])
    mock = MagicMock(return_value=True)
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;&quot;}), patch.object(
        os.path, &quot;isfile&quot;, mock
    ), patch(</B></FONT>&quot;salt.utils.files.fopen&quot;, mock_open(read_data=file_data)):
        fstab = mount.fstab()
        assert fstab == {
            &quot;B&quot;: {
                &quot;device&quot;: &quot;A&quot;,
                &quot;dump&quot;: &quot;G&quot;,
                &quot;fstype&quot;: &quot;C&quot;,
                &quot;opts&quot;: [&quot;D&quot;, &quot;E&quot;, &quot;F&quot;],
                &quot;pass&quot;: &quot;H&quot;,
            }
        }, fstab


def test_vfstab():
    &quot;&quot;&quot;
    List the content of the vfstab
    &quot;&quot;&quot;
    mock = MagicMock(return_value=False)
    with patch.object(os.path, &quot;isfile&quot;, mock):
        assert mount.vfstab() == {}

    file_data = textwrap.dedent(
        &quot;&quot;&quot;\
        #
<A NAME="10"></A>        swap        -   /tmp                tmpfs    -   yes    size=2048m
        &quot;&quot;&quot;
    )
    mock <FONT color="#ad5910"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7356-0.html#10',2,'match7356-top.html#10',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= MagicMock(return_value=True)
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;SunOS&quot;}), patch.object(
        os.path, &quot;isfile&quot;, mock
    ), patch(</B></FONT>&quot;salt.utils.files.fopen&quot;, mock_open(read_data=file_data)):
        vfstab = mount.vfstab()
        assert vfstab == {
            &quot;/tmp&quot;: {
                &quot;device&quot;: &quot;swap&quot;,
                &quot;device_fsck&quot;: &quot;-&quot;,
                &quot;fstype&quot;: &quot;tmpfs&quot;,
                &quot;mount_at_boot&quot;: &quot;yes&quot;,
                &quot;opts&quot;: [&quot;size=2048m&quot;],
                &quot;pass_fsck&quot;: &quot;-&quot;,
            }
        }, vfstab


def test_filesystems():
    &quot;&quot;&quot;
    List the content of the filesystems
    &quot;&quot;&quot;
    file_data = textwrap.dedent(
        &quot;&quot;&quot;\
        #
<A NAME="8"></A>
        &quot;&quot;&quot;
    )
    mock <FONT color="#c58917"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7356-0.html#8',2,'match7356-top.html#8',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= MagicMock(return_value=True)
    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;AIX&quot;, &quot;kernel&quot;: &quot;AIX&quot;}), patch.object(
        os.path, &quot;isfile&quot;, mock
    ), patch(</B></FONT>&quot;salt.utils.files.fopen&quot;, mock_open(read_data=file_data)):
        assert mount.filesystems() == {}

    file_data = textwrap.dedent(
        &quot;&quot;&quot;\
        #
        /home:
                dev             = /dev/hd1
                vfs             = jfs2
                log             = /dev/hd8
                mount           = true
                check           = true
                vol             = /home
                free            = false
                quota           = no

        &quot;&quot;&quot;
    )
    mock = MagicMock(return_value=True)
    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;AIX&quot;, &quot;kernel&quot;: &quot;AIX&quot;}), patch.object(
        os.path, &quot;isfile&quot;, mock
    ), patch(&quot;salt.utils.files.fopen&quot;, mock_open(read_data=file_data)):
        fsyst = mount.filesystems()
        test_fsyst = {
            &quot;/home&quot;: {
                &quot;dev&quot;: &quot;/dev/hd1&quot;,
                &quot;vfs&quot;: &quot;jfs2&quot;,
                &quot;log&quot;: &quot;/dev/hd8&quot;,
                &quot;mount&quot;: &quot;true&quot;,
                &quot;check&quot;: &quot;true&quot;,
                &quot;vol&quot;: &quot;/home&quot;,
                &quot;free&quot;: &quot;false&quot;,
                &quot;quota&quot;: &quot;no&quot;,
            }
        }
        assert test_fsyst == fsyst


def test_rm_fstab():
    &quot;&quot;&quot;
    Remove the mount point from the fstab
    &quot;&quot;&quot;
    mock_fstab = MagicMock(return_value={})
<A NAME="5"></A>    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;&quot;}):
        with patch.object(mount, &quot;fstab&quot;, mock_fstab):
            with patch(&quot;salt.utils.files.fopen&quot;, mock_open()):
                assert mount<FONT color="#151b8d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7356-0.html#5',2,'match7356-top.html#5',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.rm_fstab(&quot;name&quot;, &quot;device&quot;)


def test_set_fstab(mock_shell_file):
    &quot;&quot;&quot;
    Tests to verify that this mount is represented in the fstab,
    change the mount to match the data passed, or add the mount
    if it is not present.
    &quot;&quot;&quot;
    mock = MagicMock(return_value=False)
    with patch.object(os.</B></FONT>path, &quot;isfile&quot;, mock):
        pytest.raises(CommandExecutionError, mount.set_fstab, &quot;A&quot;, &quot;B&quot;, &quot;C&quot;)
<A NAME="1"></A>
    mock = MagicMock(return_value=True)
    mock_read = MagicMock(side_effect=OSError)
    with patch.object(os<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7356-0.html#1',2,'match7356-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.path, &quot;isfile&quot;, mock):
        with patch.object(salt.utils.files, &quot;fopen&quot;, mock_read):
            pytest.raises(CommandExecutionError, mount.set_fstab, &quot;A&quot;, &quot;B&quot;, &quot;C&quot;)

    mock = MagicMock(return_value=True)
    with patch.object(</B></FONT>os.path, &quot;isfile&quot;, mock):
        with patch(&quot;salt.utils.files.fopen&quot;, mock_open(read_data=mock_shell_file)):
            assert mount.set_fstab(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;) == &quot;new&quot;

    mock = MagicMock(return_value=True)
    with patch.object(os.path, &quot;isfile&quot;, mock):
        with patch(&quot;salt.utils.files.fopen&quot;, mock_open(read_data=mock_shell_file)):
            assert mount.set_fstab(&quot;B&quot;, &quot;A&quot;, &quot;C&quot;, &quot;D&quot;, &quot;F&quot;, &quot;G&quot;) == &quot;present&quot;

    mock = MagicMock(return_value=True)
    with patch.object(os.path, &quot;isfile&quot;, mock):
        with patch(&quot;salt.utils.files.fopen&quot;, mock_open(read_data=mock_shell_file)):
            assert mount.set_fstab(&quot;B&quot;, &quot;A&quot;, &quot;C&quot;, not_change=True) == &quot;present&quot;


def test_rm_automaster():
    &quot;&quot;&quot;
    Remove the mount point from the auto_master
    &quot;&quot;&quot;
    mock = MagicMock(return_value={})
    with patch.object(mount, &quot;automaster&quot;, mock):
        assert mount.rm_automaster(&quot;name&quot;, &quot;device&quot;)

    mock = MagicMock(return_value={&quot;name&quot;: &quot;name&quot;})
    with patch.object(mount, &quot;fstab&quot;, mock):
        assert mount.rm_automaster(&quot;name&quot;, &quot;device&quot;)


def test_set_automaster(mock_shell_file):
    &quot;&quot;&quot;
    Verify that this mount is represented in the auto_salt, change the mount
    to match the data passed, or add the mount if it is not present.
    &quot;&quot;&quot;
    mock = MagicMock(return_value=True)
    with patch.object(os.path, &quot;isfile&quot;, mock):
        pytest.raises(CommandExecutionError, mount.set_automaster, &quot;A&quot;, &quot;B&quot;, &quot;C&quot;)
<A NAME="0"></A>
    mock = MagicMock(return_value=True)
    mock_read = MagicMock(side_effect=OSError)
    with patch.object(os<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7356-0.html#0',2,'match7356-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.path, &quot;isfile&quot;, mock):
        with patch.object(salt.utils.files, &quot;fopen&quot;, mock_read):
            pytest.raises(CommandExecutionError, mount.set_automaster, &quot;A&quot;, &quot;B&quot;, &quot;C&quot;)

    mock = MagicMock(return_value=True)
    with patch.object(</B></FONT>os.path, &quot;isfile&quot;, mock):
        with patch(&quot;salt.utils.files.fopen&quot;, mock_open(read_data=mock_shell_file)):
            assert mount.set_automaster(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;) == &quot;new&quot;

    mock = MagicMock(return_value=True)
    with patch.object(os.path, &quot;isfile&quot;, mock):
        with patch(
            &quot;salt.utils.files.fopen&quot;, mock_open(read_data=&quot;/..A -fstype=C,D C:B&quot;)
        ):
            assert mount.set_automaster(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;) == &quot;present&quot;

    mock = MagicMock(return_value=True)
    with patch.object(os.path, &quot;isfile&quot;, mock):
        with patch(
            &quot;salt.utils.files.fopen&quot;, mock_open(read_data=&quot;/..A -fstype=XX C:B&quot;)
        ):
            assert (
                mount.set_automaster(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, not_change=True) == &quot;present&quot;
            )


def test_automaster():
    &quot;&quot;&quot;
    Test the list the contents of the fstab
    &quot;&quot;&quot;
    assert mount.automaster() == {}


def test_rm_filesystems():
    &quot;&quot;&quot;
    Remove the mount point from the filesystems
    &quot;&quot;&quot;
    file_data = textwrap.dedent(
        &quot;&quot;&quot;\
        #

        &quot;&quot;&quot;
    )
    mock = MagicMock(return_value=True)
    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;AIX&quot;, &quot;kernel&quot;: &quot;AIX&quot;}), patch.object(
        os.path, &quot;isfile&quot;, mock
    ), patch(&quot;salt.utils.files.fopen&quot;, mock_open(read_data=file_data)):
        assert not mount.rm_filesystems(&quot;name&quot;, &quot;device&quot;)

    file_data = textwrap.dedent(
        &quot;&quot;&quot;\
        #
        /name:
                dev             = device
                vol             = /name

        &quot;&quot;&quot;
    )

    mock = MagicMock(return_value=True)
    mock_fsyst = MagicMock(return_value=True)
    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;AIX&quot;, &quot;kernel&quot;: &quot;AIX&quot;}), patch.object(
        os.path, &quot;isfile&quot;, mock
    ), patch(&quot;salt.utils.files.fopen&quot;, mock_open(read_data=file_data)):
        assert mount.rm_filesystems(&quot;/name&quot;, &quot;device&quot;)


def test_set_filesystems():
    &quot;&quot;&quot;
    Tests to verify that this mount is represented in the filesystems,
    change the mount to match the data passed, or add the mount
    if it is not present.
    &quot;&quot;&quot;
    mock = MagicMock(return_value=False)
    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;AIX&quot;, &quot;kernel&quot;: &quot;AIX&quot;}):
        with patch.object(os.path, &quot;isfile&quot;, mock):
            pytest.raises(CommandExecutionError, mount.set_filesystems, &quot;A&quot;, &quot;B&quot;, &quot;C&quot;)

        mock_read = MagicMock(side_effect=OSError)
        with patch.object(os.path, &quot;isfile&quot;, mock):
            with patch.object(salt.utils.files, &quot;fopen&quot;, mock_read):
                pytest.raises(
                    CommandExecutionError, mount.set_filesystems, &quot;A&quot;, &quot;B&quot;, &quot;C&quot;
                )


@pytest.mark.skipif(
    sys.version_info[0] == 3 and sys.version_info[1] &lt;= 5,
    reason=&quot;run on Python 3.6 or greater where OrderedDict is default&quot;,
)
@pytest.mark.skip_on_windows(
    reason=&quot;Not supported on Windows, does not handle tabs well&quot;
)
def test_set_filesystems_with_data(tmp_sub_dir, config_file):
    &quot;&quot;&quot;
    Tests to verify set_filesystems reads and adjusts file /etc/filesystems correctly
    &quot;&quot;&quot;
    # Note AIX uses tabs in filesystems files, hence disable warings and errors for tabs and spaces
    # pylint: disable=W8191
    # pylint: disable=E8101
    config_filepath = str(tmp_sub_dir / &quot;filesystems&quot;)
    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;AIX&quot;, &quot;kernel&quot;: &quot;AIX&quot;}):
        mount.set_filesystems(
            &quot;/test_mount&quot;, &quot;/dev/hd3&quot;, &quot;jsf2&quot;, &quot;-&quot;, &quot;true&quot;, config_filepath
        )
        with salt.utils.files.fopen(config_filepath, &quot;r&quot;) as fp:
            fsys_content = fp.read()

        test_fsyst = &quot;&quot;&quot;/:
	dev		= /dev/hd4
	vfs		= jfs2
	log		= /dev/hd8
	mount		= automatic
	check		= false
	type		= bootfs
	vol		= root
	free		= true

/home:
	dev		= /dev/hd1
	vfs		= jfs2
	log		= /dev/hd8
	mount		= true
	check		= true
	vol		= /home
	free		= false

/test_mount:
	dev		= /dev/hd3
	vfstype		= jsf2
	opts		= -
	mount		= true

&quot;&quot;&quot;
    assert test_fsyst == fsys_content


def test_mount():
    &quot;&quot;&quot;
    Mount a device
    &quot;&quot;&quot;
    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;MacOS&quot;}):
        mock = MagicMock(return_value=True)
        with patch.object(os.path, &quot;exists&quot;, mock):
            mock = MagicMock(return_value=None)
            with patch.dict(mount.__salt__, {&quot;file.mkdir&quot;: None}):
                mock = MagicMock(return_value={&quot;retcode&quot;: True, &quot;stderr&quot;: True})
                with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
                    assert mount.mount(&quot;name&quot;, &quot;device&quot;)
                    mock.assert_called_with(
                        &quot;mount  device name &quot;, python_shell=False, runas=None
                    )

                with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
                    assert mount.mount(&quot;name&quot;, &quot;device&quot;, fstype=&quot;fstype&quot;)
                    mock.assert_called_with(
                        &quot;mount  -t fstype device name &quot;,
                        python_shell=False,
                        runas=None,
                    )

                mock = MagicMock(return_value={&quot;retcode&quot;: False, &quot;stderr&quot;: False})
                with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
                    assert mount.mount(&quot;name&quot;, &quot;device&quot;)

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;AIX&quot;}):
        mock = MagicMock(return_value=True)
        with patch.object(os.path, &quot;exists&quot;, mock):
            mock = MagicMock(return_value=None)
            with patch.dict(mount.__salt__, {&quot;file.mkdir&quot;: None}):
                mock = MagicMock(return_value={&quot;retcode&quot;: True, &quot;stderr&quot;: True})
                with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
                    assert mount.mount(&quot;name&quot;, &quot;device&quot;)
                    mock.assert_called_with(
                        &quot;mount  device name &quot;, python_shell=False, runas=None
                    )

                with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
                    assert mount.mount(&quot;name&quot;, &quot;device&quot;, fstype=&quot;fstype&quot;)
                    mock.assert_called_with(
                        &quot;mount  -v fstype device name &quot;,
                        python_shell=False,
                        runas=None,
                    )

                mock = MagicMock(return_value={&quot;retcode&quot;: False, &quot;stderr&quot;: False})
                with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
                    assert mount.mount(&quot;name&quot;, &quot;device&quot;)

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;Linux&quot;}):
        mock = MagicMock(return_value=True)
        with patch.object(os.path, &quot;exists&quot;, mock):
            mock = MagicMock(return_value=None)
            with patch.dict(mount.__salt__, {&quot;file.mkdir&quot;: None}):
                mock = MagicMock(return_value={&quot;retcode&quot;: True, &quot;stderr&quot;: True})
                with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
                    assert mount.mount(&quot;name&quot;, &quot;device&quot;)
                    mock.assert_called_with(
                        &quot;mount -o defaults device name &quot;,
                        python_shell=False,
                        runas=None,
                    )

                with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
                    assert mount.mount(&quot;name&quot;, &quot;device&quot;, fstype=&quot;fstype&quot;)
                    mock.assert_called_with(
                        &quot;mount -o defaults -t fstype device name &quot;,
                        python_shell=False,
                        runas=None,
                    )

                mock = MagicMock(return_value={&quot;retcode&quot;: False, &quot;stderr&quot;: False})
                with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
                    assert mount.mount(&quot;name&quot;, &quot;device&quot;)


def test_remount_non_mounted():
    &quot;&quot;&quot;
    Attempt to remount a device, if the device is not already mounted, mount
<A NAME="12"></A>    is called
    &quot;&quot;&quot;
    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;MacOS&quot;}):
        mock <FONT color="#571b7e"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7356-0.html#12',2,'match7356-top.html#12',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= MagicMock(return_value=[])
        with patch.object(mount, &quot;active&quot;, mock):
            mock = MagicMock(return_value=True)
            with patch.object(</B></FONT>mount, &quot;mount&quot;, mock):
<A NAME="11"></A>                assert mount.remount(&quot;name&quot;, &quot;device&quot;)

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;AIX&quot;}):
        mock <FONT color="#b041ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7356-0.html#11',2,'match7356-top.html#11',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= MagicMock(return_value=[])
        with patch.object(mount, &quot;active&quot;, mock):
            mock = MagicMock(return_value=True)
            with patch.object(</B></FONT>mount, &quot;mount&quot;, mock):
<A NAME="9"></A>                assert mount.remount(&quot;name&quot;, &quot;device&quot;)

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;Linux&quot;}):
        mock <FONT color="#83a33a"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7356-0.html#9',2,'match7356-top.html#9',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= MagicMock(return_value=[])
        with patch.object(mount, &quot;active&quot;, mock):
            mock = MagicMock(return_value=True)
            with patch.object(</B></FONT>mount, &quot;mount&quot;, mock):
                assert mount.remount(&quot;name&quot;, &quot;device&quot;)


def test_remount_already_mounted_no_fstype():
    &quot;&quot;&quot;
    Attempt to remount a device already mounted that do not provides
<A NAME="4"></A>    fstype
    &quot;&quot;&quot;
    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;MacOS&quot;}):
        mock <FONT color="#6cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7356-0.html#4',2,'match7356-top.html#4',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= MagicMock(return_value=[&quot;name&quot;])
        with patch.object(mount, &quot;active&quot;, mock):
            mock = MagicMock(return_value={&quot;retcode&quot;: 0})
            with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;</B></FONT>: mock}):
                assert mount.remount(&quot;name&quot;, &quot;device&quot;)
                mock.assert_called_with(
                    &quot;mount -u -o noowners device name &quot;,
                    python_shell=False,
                    runas=None,
<A NAME="3"></A>                )

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;AIX&quot;}):
        mock <FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7356-0.html#3',2,'match7356-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= MagicMock(return_value=[&quot;name&quot;])
        with patch.object(mount, &quot;active&quot;, mock):
            mock = MagicMock(return_value={&quot;retcode&quot;: 0})
            with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;</B></FONT>: mock}):
                assert mount.remount(&quot;name&quot;, &quot;device&quot;)
                mock.assert_called_with(
                    &quot;mount -o remount device name &quot;, python_shell=False, runas=None
<A NAME="2"></A>                )

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;Linux&quot;}):
        mock <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7356-0.html#2',2,'match7356-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= MagicMock(return_value=[&quot;name&quot;])
        with patch.object(mount, &quot;active&quot;, mock):
            mock = MagicMock(return_value={&quot;retcode&quot;: 0})
            with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;</B></FONT>: mock}):
                assert mount.remount(&quot;name&quot;, &quot;device&quot;)
                mock.assert_called_with(
                    &quot;mount -o defaults,remount device name &quot;,
                    python_shell=False,
                    runas=None,
                )


def test_remount_already_mounted_with_fstype():
    &quot;&quot;&quot;
    Attempt to remount a device already mounted that do not provides
    fstype
    &quot;&quot;&quot;
    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;MacOS&quot;}):
        mock = MagicMock(return_value=[&quot;name&quot;])
        with patch.object(mount, &quot;active&quot;, mock):
            mock = MagicMock(return_value={&quot;retcode&quot;: 0})
            with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
                assert mount.remount(&quot;name&quot;, &quot;device&quot;, fstype=&quot;type&quot;)
                mock.assert_called_with(
                    &quot;mount -u -o noowners -t type device name &quot;,
                    python_shell=False,
                    runas=None,
                )

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;AIX&quot;}):
        mock = MagicMock(return_value=[&quot;name&quot;])
        with patch.object(mount, &quot;active&quot;, mock):
            mock = MagicMock(return_value={&quot;retcode&quot;: 0})
            with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
                assert mount.remount(&quot;name&quot;, &quot;device&quot;, fstype=&quot;type&quot;)
                mock.assert_called_with(
                    &quot;mount -o remount -v type device name &quot;,
                    python_shell=False,
                    runas=None,
                )

    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;Linux&quot;}):
        mock = MagicMock(return_value=[&quot;name&quot;])
        with patch.object(mount, &quot;active&quot;, mock):
            mock = MagicMock(return_value={&quot;retcode&quot;: 0})
            with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
                assert mount.remount(&quot;name&quot;, &quot;device&quot;, fstype=&quot;type&quot;)
                mock.assert_called_with(
                    &quot;mount -o defaults,remount -t type device name &quot;,
                    python_shell=False,
                    runas=None,
                )


def test_umount():
    &quot;&quot;&quot;
    Attempt to unmount a device by specifying the directory it is
    mounted on
    &quot;&quot;&quot;
    mock = MagicMock(return_value={})
    with patch.object(mount, &quot;active&quot;, mock):
        assert mount.umount(&quot;name&quot;) == &quot;name does not have anything mounted&quot;

    mock = MagicMock(return_value={&quot;name&quot;: &quot;name&quot;})
    with patch.object(mount, &quot;active&quot;, mock):
        mock = MagicMock(return_value={&quot;retcode&quot;: True, &quot;stderr&quot;: True})
        with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
            assert mount.umount(&quot;name&quot;)

        mock = MagicMock(return_value={&quot;retcode&quot;: False})
        with patch.dict(mount.__salt__, {&quot;cmd.run_all&quot;: mock}):
            assert mount.umount(&quot;name&quot;)

    # Test unmounting with guestfs util
    mock = MagicMock()
    with patch.dict(mount.__salt__, {&quot;guestfs.umount&quot;: mock}):
        mount.umount(&quot;/mountpoint&quot;, device=&quot;/path/to/my.qcow&quot;, util=&quot;guestfs&quot;)
        mock.assert_called_once_with(&quot;/mountpoint&quot;, disk=&quot;/path/to/my.qcow&quot;)


def test_is_fuse_exec():
    &quot;&quot;&quot;
    Returns true if the command passed is a fuse mountable application
    &quot;&quot;&quot;
    with patch.object(salt.utils.path, &quot;which&quot;, return_value=None):
        assert not mount.is_fuse_exec(&quot;cmd&quot;)

    def _ldd_side_effect(cmd, *args, **kwargs):
        &quot;&quot;&quot;
        Neither of these are full ldd output, but what is_fuse_exec is
        looking for is 'libfuse' in the ldd output, so these examples
        should be sufficient enough to test both the True and False cases.
        &quot;&quot;&quot;
        return {
            &quot;ldd cmd1&quot;: textwrap.dedent(
                &quot;&quot;&quot;\
                linux-vdso.so.1 (0x00007ffeaf5fb000)
                libfuse3.so.3 =&gt; /usr/lib/libfuse3.so.3 (0x00007f91e66ac000)
                &quot;&quot;&quot;
            ),
            &quot;ldd cmd2&quot;: textwrap.dedent(
                &quot;&quot;&quot;\
                linux-vdso.so.1 (0x00007ffeaf5fb000)
                &quot;&quot;&quot;
            ),
        }[cmd]

    which_mock = MagicMock(side_effect=lambda x: x)
    ldd_mock = MagicMock(side_effect=_ldd_side_effect)
    with patch.object(salt.utils.path, &quot;which&quot;, which_mock):
        with patch.dict(mount.__salt__, {&quot;cmd.run&quot;: _ldd_side_effect}):
            assert mount.is_fuse_exec(&quot;cmd1&quot;)
            assert not mount.is_fuse_exec(&quot;cmd2&quot;)


def test_swaps():
    &quot;&quot;&quot;
    Return a dict containing information on active swap
    &quot;&quot;&quot;
    file_data = textwrap.dedent(
        &quot;&quot;&quot;\
        Filename Type Size Used Priority
        /dev/sda1 partition 31249404 4100 -1
        &quot;&quot;&quot;
    )
    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;&quot;, &quot;kernel&quot;: &quot;&quot;}):
        with patch(&quot;salt.utils.files.fopen&quot;, mock_open(read_data=file_data)):
            swaps = mount.swaps()
            assert swaps == {
                &quot;/dev/sda1&quot;: {
                    &quot;priority&quot;: &quot;-1&quot;,
                    &quot;size&quot;: &quot;31249404&quot;,
                    &quot;type&quot;: &quot;partition&quot;,
                    &quot;used&quot;: &quot;4100&quot;,
                }
            }, swaps

    file_data = textwrap.dedent(
        &quot;&quot;&quot;\
        Device Size Used Unknown Unknown Priority
        /dev/sda1 31249404 4100 unknown unknown -1
        &quot;&quot;&quot;
    )
    mock = MagicMock(return_value=file_data)
    with patch.dict(
        mount.__grains__, {&quot;os&quot;: &quot;OpenBSD&quot;, &quot;kernel&quot;: &quot;OpenBSD&quot;}
    ), patch.dict(mount.__salt__, {&quot;cmd.run_stdout&quot;: mock}):
        swaps = mount.swaps()
        assert swaps == {
            &quot;/dev/sda1&quot;: {
                &quot;priority&quot;: &quot;-1&quot;,
                &quot;size&quot;: &quot;31249404&quot;,
                &quot;type&quot;: &quot;partition&quot;,
                &quot;used&quot;: &quot;4100&quot;,
            }
        }, swaps

    file_data = textwrap.dedent(
        &quot;&quot;&quot;\
        device              maj,min        total       free
        /dev/hd6              10,  2     11776MB     11765MB
        &quot;&quot;&quot;
    )
    mock = MagicMock(return_value=file_data)
    with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;AIX&quot;, &quot;kernel&quot;: &quot;AIX&quot;}), patch.dict(
        mount.__salt__, {&quot;cmd.run_stdout&quot;: mock}
    ):
        swaps = mount.swaps()
        assert swaps == {
            &quot;/dev/hd6&quot;: {
                &quot;priority&quot;: &quot;-&quot;,
                &quot;size&quot;: 12058624,
                &quot;type&quot;: &quot;device&quot;,
                &quot;used&quot;: 11264,
            }
        }, swaps


def test_swapon():
    &quot;&quot;&quot;
    Activate a swap disk
    &quot;&quot;&quot;
    mock = MagicMock(return_value={&quot;name&quot;: &quot;name&quot;})
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;&quot;}):
        with patch.object(mount, &quot;swaps&quot;, mock):
            assert mount.swapon(&quot;name&quot;) == {&quot;stats&quot;: &quot;name&quot;, &quot;new&quot;: False}

    mock = MagicMock(return_value={})
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;&quot;}):
        with patch.object(mount, &quot;swaps&quot;, mock):
            mock = MagicMock(return_value=None)
            with patch.dict(mount.__salt__, {&quot;cmd.run&quot;: mock}):
                assert mount.swapon(&quot;name&quot;, False) == {}

    mock = MagicMock(side_effect=[{}, {&quot;name&quot;: &quot;name&quot;}])
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;&quot;}):
        with patch.object(mount, &quot;swaps&quot;, mock):
            mock = MagicMock(return_value=None)
            with patch.dict(mount.__salt__, {&quot;cmd.run&quot;: mock}):
                assert mount.swapon(&quot;name&quot;) == {&quot;stats&quot;: &quot;name&quot;, &quot;new&quot;: True}
    ## effects of AIX
    mock = MagicMock(return_value={&quot;name&quot;: &quot;name&quot;})
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;AIX&quot;}):
        with patch.object(mount, &quot;swaps&quot;, mock):
            assert mount.swapon(&quot;name&quot;) == {&quot;stats&quot;: &quot;name&quot;, &quot;new&quot;: False}

    mock = MagicMock(return_value={})
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;AIX&quot;}):
        with patch.object(mount, &quot;swaps&quot;, mock):
            mock = MagicMock(return_value=None)
            with patch.dict(mount.__salt__, {&quot;cmd.run&quot;: mock}):
                assert mount.swapon(&quot;name&quot;, False) == {}

    mock = MagicMock(side_effect=[{}, {&quot;name&quot;: &quot;name&quot;}])
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;AIX&quot;}):
        with patch.object(mount, &quot;swaps&quot;, mock):
            mock = MagicMock(return_value=None)
            with patch.dict(mount.__salt__, {&quot;cmd.run&quot;: mock}):
                assert mount.swapon(&quot;name&quot;) == {&quot;stats&quot;: &quot;name&quot;, &quot;new&quot;: True}


def test_swapoff():
    &quot;&quot;&quot;
    Deactivate a named swap mount
    &quot;&quot;&quot;
    mock = MagicMock(return_value={})
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;&quot;}):
        with patch.object(mount, &quot;swaps&quot;, mock):
            assert mount.swapoff(&quot;name&quot;) is None

    mock = MagicMock(return_value={&quot;name&quot;: &quot;name&quot;})
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;&quot;}):
        with patch.object(mount, &quot;swaps&quot;, mock):
            with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;test&quot;}):
                mock = MagicMock(return_value=None)
                with patch.dict(mount.__salt__, {&quot;cmd.run&quot;: mock}):
                    assert not mount.swapoff(&quot;name&quot;)

    mock = MagicMock(side_effect=[{&quot;name&quot;: &quot;name&quot;}, {}])
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;&quot;}):
        with patch.object(mount, &quot;swaps&quot;, mock):
            with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;test&quot;}):
                mock = MagicMock(return_value=None)
                with patch.dict(mount.__salt__, {&quot;cmd.run&quot;: mock}):
                    assert mount.swapoff(&quot;name&quot;)

    # check on AIX
    mock = MagicMock(return_value={})
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;AIX&quot;}):
        with patch.object(mount, &quot;swaps&quot;, mock):
            assert mount.swapoff(&quot;name&quot;) is None

    mock = MagicMock(return_value={&quot;name&quot;: &quot;name&quot;})
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;AIX&quot;}):
        with patch.object(mount, &quot;swaps&quot;, mock):
            with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;test&quot;}):
                mock = MagicMock(return_value=None)
                with patch.dict(mount.__salt__, {&quot;cmd.run&quot;: mock}):
                    assert not mount.swapoff(&quot;name&quot;)

    mock = MagicMock(side_effect=[{&quot;name&quot;: &quot;name&quot;}, {}])
    with patch.dict(mount.__grains__, {&quot;kernel&quot;: &quot;AIX&quot;}):
        with patch.object(mount, &quot;swaps&quot;, mock):
<A NAME="6"></A>            with patch.dict(mount.__grains__, {&quot;os&quot;: &quot;test&quot;}):
                mock = MagicMock(return_value=None)
                with patch.dict(mount.__salt__, {&quot;cmd.run&quot;: mock}):
                    assert mount.swapoff(&quot;n<FONT color="#8c8774"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7356-0.html#6',2,'match7356-top.html#6',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>ame&quot;)


def test_is_mounted():
    &quot;&quot;&quot;
    Provide information if the path is mounted
    &quot;&quot;&quot;
    mock = MagicMock(return_value={})
    with patch.object(mount, &quot;active&quot;, mock), patch.dict(
        mount.</B></FONT>__grains__, {&quot;kernel&quot;: &quot;&quot;}
    ):
        assert not mount.is_mounted(&quot;name&quot;)

    mock = MagicMock(return_value={&quot;name&quot;: &quot;name&quot;})
    with patch.object(mount, &quot;active&quot;, mock), patch.dict(
        mount.__grains__, {&quot;kernel&quot;: &quot;&quot;}
    ):
        assert mount.is_mounted(&quot;name&quot;)
</PRE>
</div>
  </div>
</body>
</html>
