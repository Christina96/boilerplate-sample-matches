
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 7.191780821917808%, Tokens: 10</h2>
        <div class="column">
            <h3>Ultroid-MDEwOlJlcG9zaXRvcnkzNDEwMzg2MDI=-flat-admins_6.py</h3>
            <pre><code>1  import asyncio
2  import time
3  import uuid
4  from telethon import Button
5  from telethon.errors.rpcerrorlist import UserNotParticipantError
6  from telethon.tl import functions, types
7  try:
8      from .. import _ult_cache
9      from .._misc import SUDO_M
10  except ImportError:
11      _ult_cache = {}
12      SUDO_M = None
13  def ban_time(time_str):
14      if not any(time_str.endswith(unit) for unit in ("s", "m", "h", "d")):
15          time_str += "s"
16      unit = time_str[-1]
17      time_int = time_str[:-1]
18      if not time_int.isdigit():
19          raise Exception("Invalid time amount specified.")
20      to_return = ""
21      if unit == "s":
22          to_return = int(time.time() + int(time_int))
23      elif unit == "m":
24          to_return = int(time.time() + int(time_int) * 60)
25      elif unit == "h":
26          to_return = int(time.time() + int(time_int) * 60 * 60)
27      elif unit == "d":
28          to_return = int(time.time() + int(time_int) * 24 * 60 * 60)
29      return to_return
30  async def _callback_check(event):
<span onclick='openModal()' class='match'>31      id_ = str(uuid.uuid1()).split("-")[0]
32      time.time()
33      msg = await event.reply(
</span>34          "Click Below Button to prove self as Admin!",
35          buttons=Button.inline("Click Me", f"cc_{id_}"),
36      )
37      if not _ult_cache.get("admin_callback"):
38          _ult_cache.update({"admin_callback": {id_: None}})
39      else:
40          _ult_cache["admin_callback"].update({id_: None})
41      while not _ult_cache["admin_callback"].get(id_):
42          await asyncio.sleep(1)
43      key = _ult_cache.get("admin_callback", {}).get(id_)
44      del _ult_cache["admin_callback"][id_]
45      return key
46  async def get_update_linked_chat(event):
47      if _ult_cache.get("LINKED_CHATS") and _ult_cache["LINKED_CHATS"].get(event.chat_id):
48          _ignore = _ult_cache["LINKED_CHATS"][event.chat_id]["linked_chat"]
49      else:
50          channel = await event.client(
51              functions.channels.GetFullChannelRequest(event.chat_id)
52          )
53          _ignore = channel.full_chat.linked_chat_id
54          if _ult_cache.get("LINKED_CHATS"):
55              _ult_cache["LINKED_CHATS"].update({event.chat_id: {"linked_chat": _ignore}})
56          else:
57              _ult_cache.update(
58                  {"LINKED_CHATS": {event.chat_id: {"linked_chat": _ignore}}}
59              )
60      return _ignore
61  async def admin_check(event, require=None, silent: bool = False):
62      if SUDO_M and event.sender_id in SUDO_M.owner_and_sudos():
63          return True
64      callback = None
65      if (
66          isinstance(event.sender, (types.Chat, types.Channel))
67          and event.sender_id == event.chat_id
68      ):
69          if not require:
70              return True
71          callback = True
72      if isinstance(event.sender, types.Channel):
73          _ignore = await get_update_linked_chat(event)
74          if _ignore and event.sender.id == _ignore:
75              return False
76          callback = True
77      if callback:
78          if silent:
79              return
80          get_ = await _callback_check(event)
81          if not get_:
82              return
83          user, perms = get_
84          event._sender_id = user.id
85          event._sender = user
86      else:
87          user = event.sender
88          try:
89              perms = await event.client.get_permissions(event.chat_id, user.id)
90          except UserNotParticipantError:
91              if not silent:
92                  await event.reply("You need to join this chat First!")
93              return False
94      if not perms.is_admin:
95          if not silent:
96              await event.eor("Only Admins can use this command!", time=8)
97          return
98      if require and not getattr(perms, require, False):
99          if not silent:
100              await event.eor(f"You are missing the right of `{require}`", time=8)
101          return False
102      return True
103  def lock_unlock(query, lock=True):
104      rights = types.ChatBannedRights(None)
105      _do = lock
106      if query == "msgs":
107          for i in ["send_messages", "invite_users", "pin_messages" "change_info"]:
108              setattr(rights, i, _do)
109      elif query == "media":
110          setattr(rights, "send_media", _do)
111      elif query == "sticker":
112          setattr(rights, "send_stickers", _do)
113      elif query == "gif":
114          setattr(rights, "send_gifs", _do)
115      elif query == "games":
116          setattr(rights, "send_games", _do)
117      elif query == "inline":
118          setattr(rights, "send_inline", _do)
119      elif query == "polls":
120          setattr(rights, "send_polls", _do)
121      elif query == "invites":
122          setattr(rights, "invite_users", _do)
123      elif query == "pin":
124          setattr(rights, "pin_messages", _do)
125      elif query == "changeinfo":
126          setattr(rights, "change_info", _do)
127      else:
128          return None
129      return rights
</code></pre>
        </div>
        <div class="column">
            <h3>esptool-MDEwOlJlcG9zaXRvcnkyMzczNjkxNA==-flat-test_espsecure_hsm.py</h3>
            <pre><code>1  import configparser
2  import os
3  import os.path
4  import sys
5  import tempfile
6  from collections import namedtuple
7  from conftest import need_to_install_package_err
8  try:
9      import espsecure
10      import pkcs11
11  except ImportError:
12      need_to_install_package_err()
13  TEST_DIR = os.path.abspath(os.path.dirname(__file__))
14  TOKEN_PIN = "1234"
15  TOKEN_PIN_SO = "123456"
16  class EspSecureHSMTestCase:
17      @classmethod
18      def setup_class(self):
19          self.cleanup_files = []  # keep a list of files _open()ed by each test case
20      @classmethod
21      def teardown_class(self):
22          for f in self.cleanup_files:
23              f.close()
24      def _open(self, image_file):
25          f = open(os.path.join(TEST_DIR, "secure_images", image_file), "rb")
26          self.cleanup_files.append(f)
27          return f
28      def get_pkcs11lib(self):
29          if sys.maxsize > 2**32:
30              WINDOWS_SOFTHSM = "c:/SoftHSM2/lib/softhsm2-x64.dll"
31          else:
32              WINDOWS_SOFTHSM = "c:/SoftHSM2/lib/softhsm2.dll"
33          LIBS = [
34              "/usr/local/lib/softhsm/libsofthsm2.so",  # macOS or local build
35              "/usr/lib/softhsm/libsofthsm2.so",  # Debian
36              "/usr/lib/x86_64-linux-gnu/softhsm/libsofthsm2.so",  # Ubuntu 16.04
37              WINDOWS_SOFTHSM,  # Windows
38          ]
39          for lib in LIBS:
40              if os.path.isfile(lib):
41                  print("Using lib:", lib)
42                  return lib
43          return None
44      def softhsm_setup_token(self, filename, token_label):
45          self.pkcs11_lib = self.get_pkcs11lib()
46          if self.pkcs11_lib is None:
47              print("PKCS11 lib does not exist")
48              sys.exit(-1)
49          lib = pkcs11.lib(self.pkcs11_lib)
50          token = lib.get_token(token_label=token_label)
51          slot = token.slot.slot_id
52          session = token.open(rw=True, user_pin=TOKEN_PIN)
53          keyID = (0x0,)
54          label = "Private Key for Digital Signature"
55          label_pubkey = "Public Key for Digital Signature"
56          pubTemplate = [
57              (pkcs11.Attribute.CLASS, pkcs11.constants.ObjectClass.PUBLIC_KEY),
58              (pkcs11.Attribute.TOKEN, True),
59              (pkcs11.Attribute.PRIVATE, False),
60              (pkcs11.Attribute.MODULUS_BITS, 0x0C00),
61              (pkcs11.Attribute.PUBLIC_EXPONENT, (0x01, 0x00, 0x01)),
62              (pkcs11.Attribute.ENCRYPT, True),
63              (pkcs11.Attribute.VERIFY, True),
64              (pkcs11.Attribute.VERIFY_RECOVER, True),
65              (pkcs11.Attribute.WRAP, True),
66              (pkcs11.Attribute.LABEL, label_pubkey),
67              (pkcs11.Attribute.ID, keyID),
68          ]
69          privTemplate = [
70              (pkcs11.Attribute.CLASS, pkcs11.constants.ObjectClass.PRIVATE_KEY),
71              (pkcs11.Attribute.TOKEN, True),
72              (pkcs11.Attribute.PRIVATE, True),
73              (pkcs11.Attribute.DECRYPT, True),
74              (pkcs11.Attribute.SIGN, True),
75              (pkcs11.Attribute.SENSITIVE, True),
76              (pkcs11.Attribute.SIGN_RECOVER, True),
77              (pkcs11.Attribute.LABEL, label),
78              (pkcs11.Attribute.UNWRAP, True),
79              (pkcs11.Attribute.ID, keyID),
80          ]
81          session.generate_keypair(
82              pkcs11.KeyType.RSA,
83              3072,
84              private_template=privTemplate,
85              public_template=pubTemplate,
86          )
87          configfile = os.path.join(TEST_DIR, "secure_images", filename)
88          config = configparser.ConfigParser()
89          section = "hsm_config"
90          config.add_section(section)
91          config.set(section, "pkcs11_lib", self.pkcs11_lib)
92          config.set(section, "credentials", TOKEN_PIN)
93          config.set(section, "slot", str(slot))
94          config.set(section, "label", label)
95          config.set(section, "label_pubkey", label_pubkey)
96          with open(configfile, "w") as c:
97              config.write(c)
98          session.close()
99  class TestSigning(EspSecureHSMTestCase):
100      VerifyArgs = namedtuple(
101          "verify_signature_args", ["version", "hsm", "hsm_config", "keyfile", "datafile"]
102      )
103      SignArgs = namedtuple(
104          "sign_data_args",
105          [
106              "version",
107              "keyfile",
108              "output",
109              "append_signatures",
110              "hsm",
111              "hsm_config",
112              "pub_key",
113              "signature",
114              "datafile",
115          ],
116      )
117      def test_sign_v2_hsm(self):
118          self.softhsm_setup_token("softhsm_v2.ini", "softhsm-test-token")
119          with tempfile.NamedTemporaryFile() as output_file:
120              args = self.SignArgs(
121                  "2",
122                  None,
123                  output_file.name,
124                  False,
125                  True,
126                  os.path.join(TEST_DIR, "secure_images", "softhsm_v2.ini"),
127                  None,
128                  None,
129                  self._open("bootloader_unsigned_v2.bin"),
130              )
131              espsecure.sign_data(args)
132              args = self.VerifyArgs(
133                  "2",
134                  True,
135                  os.path.join(TEST_DIR, "secure_images", "softhsm_v2.ini"),
136                  None,
137                  output_file,
138              )
139              espsecure.verify_signature(args)
140      def test_sign_v2_hsm_append_signatures_multiple_steps(self):
141          self.softhsm_setup_token("softhsm_v2_1.ini", "softhsm-test-token-1")
142          with tempfile.NamedTemporaryFile() as output_file1:
143              args = self.SignArgs(
144                  "2",
145                  None,
146                  output_file1.name,
147                  True,
148                  True,
149                  os.path.join(TEST_DIR, "secure_images", "softhsm_v2_1.ini"),
150                  None,
151                  None,
152                  self._open("bootloader_unsigned_v2.bin"),
153              )
154              espsecure.sign_data(args)
155              self.softhsm_setup_token("softhsm_v2_2.ini", "softhsm-test-token-2")
156              with tempfile.NamedTemporaryFile() as output_file2:
157                  args = self.SignArgs(
158                      "2",
159                      None,
160                      output_file2.name,
161                      True,
162                      True,
163                      os.path.join(TEST_DIR, "secure_images", "softhsm_v2_2.ini"),
164                      None,
165                      None,
166                      self._open(output_file1.name),
167                  )
168                  espsecure.sign_data(args)
169                  self.softhsm_setup_token("softhsm_v2_3.ini", "softhsm-test-token-3")
170                  with tempfile.NamedTemporaryFile() as output_file3:
171                      args = self.SignArgs(
172                          "2",
173                          None,
174                          output_file3.name,
175                          True,
176                          True,
<span onclick='openModal()' class='match'>177                          os.path.join(TEST_DIR, "secure_images", "softhsm_v2_3.ini"),
178                          None,
179                          None,
180                          self._open(output_file2.name),
181                      )
182                      espsecure.sign_data(args)
183                      args = self.VerifyArgs(
</span>184                          "2",
185                          True,
186                          os.path.join(TEST_DIR, "secure_images", "softhsm_v2_1.ini"),
187                          None,
188                          output_file3,
189                      )
190                      espsecure.verify_signature(args)
191                      output_file3.seek(0)
192                      args = self.VerifyArgs(
193                          "2",
194                          True,
195                          os.path.join(TEST_DIR, "secure_images", "softhsm_v2_2.ini"),
196                          None,
197                          output_file3,
198                      )
199                      espsecure.verify_signature(args)
200                      output_file3.seek(0)
201                      args = self.VerifyArgs(
202                          "2",
203                          True,
204                          os.path.join(TEST_DIR, "secure_images", "softhsm_v2_3.ini"),
205                          None,
206                          output_file3,
207                      )
208                      espsecure.verify_signature(args)
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Ultroid-MDEwOlJlcG9zaXRvcnkzNDEwMzg2MDI=-flat-admins_6.py</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from esptool-MDEwOlJlcG9zaXRvcnkyMzczNjkxNA==-flat-test_espsecure_hsm.py</div>
                </div>
                <div class="column column_space"><pre><code>31      id_ = str(uuid.uuid1()).split("-")[0]
32      time.time()
33      msg = await event.reply(
</pre></code></div>
                <div class="column column_space"><pre><code>177                          os.path.join(TEST_DIR, "secure_images", "softhsm_v2_3.ini"),
178                          None,
179                          None,
180                          self._open(output_file2.name),
181                      )
182                      espsecure.sign_data(args)
183                      args = self.VerifyArgs(
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    