<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_boto_elb.py & test_cloud_2.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_boto_elb.py & test_cloud_2.py
      </h3>
      <h1 align="center">
        17.6%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_boto_elb.py (31.538462%)<TH>test_cloud_2.py (12.293853%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match7702-0.html#0',2,'match7702-1.html#0',3)" NAME="0">(168-175)<TD><A HREF="javascript:ZweiFrames('match7702-0.html#0',2,'match7702-1.html#0',3)" NAME="0">(48-55)</A><TD ALIGN=center><FONT COLOR="#ff0000">24</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match7702-0.html#1',2,'match7702-1.html#1',3)" NAME="1">(152-155)<TD><A HREF="javascript:ZweiFrames('match7702-0.html#1',2,'match7702-1.html#1',3)" NAME="1">(103-106)</A><TD ALIGN=center><FONT COLOR="#9f0000">15</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match7702-0.html#2',2,'match7702-1.html#2',3)" NAME="2">(115-127)<TD><A HREF="javascript:ZweiFrames('match7702-0.html#2',2,'match7702-1.html#2',3)" NAME="2">(289-295)</A><TD ALIGN=center><FONT COLOR="#9f0000">15</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match7702-0.html#3',2,'match7702-1.html#3',3)" NAME="3">(83-88)<TD><A HREF="javascript:ZweiFrames('match7702-0.html#3',2,'match7702-1.html#3',3)" NAME="3">(182-187)</A><TD ALIGN=center><FONT COLOR="#9f0000">15</FONT>
<TR><TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match7702-0.html#4',2,'match7702-1.html#4',3)" NAME="4">(5-22)<TD><A HREF="javascript:ZweiFrames('match7702-0.html#4',2,'match7702-1.html#4',3)" NAME="4">(5-21)</A><TD ALIGN=center><FONT COLOR="#8a0000">13</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_boto_elb.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
<A NAME="4"></A>    :codeauthor: Jayesh Kariya &lt;jayeshk@saltstack.com&gt;
&quot;&quot;&quot;

<FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match7702-1.html#4',3,'match7702-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>import copy

import pytest
import salt.states.boto_elb as boto_elb
from tests.support.mock import MagicMock, patch


@pytest.fixture
def configure_loader_modules():
    return {boto_elb: {}}


def test_present():
    &quot;&quot;&quot;
    Test to ensure the IAM role exists.
    &quot;&quot;&quot;
    name = &quot;myelb&quot;
    listeners =</B></FONT> [
        {
            &quot;elb_port&quot;: &quot;ELBPORT&quot;,
            &quot;instance_port&quot;: &quot;PORT&quot;,
            &quot;elb_protocol&quot;: &quot;HTTPS&quot;,
            &quot;certificate&quot;: &quot;A&quot;,
        }
    ]
    alarms = {&quot;MyAlarm&quot;: {&quot;name&quot;: name, &quot;attributes&quot;: {&quot;description&quot;: &quot;A&quot;}}}
    attrs = {
        &quot;alarm_actions&quot;: [&quot;arn:aws:sns:us-east-1:12345:myalarm&quot;],
        &quot;insufficient_data_actions&quot;: [],
        &quot;ok_actions&quot;: [&quot;arn:aws:sns:us-east-1:12345:myalarm&quot;],
    }
    health_check = {&quot;target:&quot;: &quot;HTTP:80/&quot;}
    avail_zones = [&quot;us-east-1a&quot;, &quot;us-east-1c&quot;, &quot;us-east-1d&quot;]
    cnames = [{&quot;name&quot;: &quot;www.test.com&quot;, &quot;zone&quot;: &quot;test.com&quot;, &quot;ttl&quot;: 60}]

    ret = {&quot;name&quot;: name, &quot;result&quot;: True, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}
    ret1 = copy.deepcopy(ret)

    mock = MagicMock(return_value={})
    mock_false_bool = MagicMock(return_value=False)
    mock_true_bool = MagicMock(return_value=True)
    mock_attributes = MagicMock(return_value=attrs)
    mock_health_check = MagicMock(return_value=health_check)

    with patch.dict(
        boto_elb.__salt__,
        {
            &quot;config.option&quot;: mock,
            &quot;boto_elb.exists&quot;: mock_false_bool,
            &quot;boto_elb.create&quot;: mock_false_bool,
            &quot;pillar.get&quot;: MagicMock(return_value={}),
        },
    ):
        with patch.dict(boto_elb.__opts__, {&quot;test&quot;: False}):
            ret = boto_elb.present(name, listeners, availability_zones=avail_zones)
            assert boto_elb.__salt__[&quot;boto_elb.exists&quot;].called
            assert boto_elb.__salt__[&quot;boto_elb.create&quot;].called
            assert &quot;Failed to create myelb ELB.&quot; in ret[&quot;comment&quot;]
            assert not ret[&quot;result&quot;]

    def mock_config_option(*args, **kwargs):
        if args[0] == &quot;boto_elb_policies&quot;:
            return []
        return {}

    mock = MagicMock(return_value={})
    with patch.dict(
        boto_elb.__salt__,
        {
            &quot;config.option&quot;: MagicMock(side_effect=mock_config_option),
            &quot;boto_elb.exists&quot;: mock_false_bool,
            &quot;boto_elb.create&quot;: mock_true_bool,
            &quot;boto_elb.get_attributes&quot;: mock_attributes,
            &quot;boto_elb.get_health_check&quot;: mock_health_check,
            &quot;boto_elb.get_elb_config&quot;: MagicMock(side_effect=[mock, MagicMock()]),
<A NAME="3"></A>            &quot;pillar.get&quot;: MagicMock(return_value={}),
        },
    ):
        <FONT color="#53858b"><A HREF="javascript:ZweiFrames('match7702-1.html#3',3,'match7702-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>with patch.dict(boto_elb.__opts__, {&quot;test&quot;: False}):
            with patch.dict(
                boto_elb.__states__,
                {&quot;boto_cloudwatch_alarm.present&quot;: MagicMock(return_value=ret1)},
            ):
                ret = boto_elb.present(</B></FONT>
                    name,
                    listeners,
                    availability_zones=avail_zones,
                    health_check=health_check,
                    alarms=alarms,
                )
                assert boto_elb.__salt__[&quot;boto_elb.exists&quot;].called
                assert boto_elb.__salt__[&quot;boto_elb.create&quot;].called
                assert boto_elb.__states__[&quot;boto_cloudwatch_alarm.present&quot;].called
                assert not boto_elb.__salt__[&quot;boto_elb.get_attributes&quot;].called
                assert boto_elb.__salt__[&quot;boto_elb.get_health_check&quot;].called
                assert &quot;ELB myelb created.&quot; in ret[&quot;comment&quot;]
                assert ret[&quot;result&quot;]

    mock = MagicMock(return_value={})
    mock_elb = MagicMock(
        return_value={
            &quot;dns_name&quot;: &quot;myelb.amazon.com&quot;,
            &quot;policies&quot;: [],
            &quot;listeners&quot;: [],
            &quot;backends&quot;: [],
        }
    )
<A NAME="2"></A>    with patch.dict(
        boto_elb.__salt__,
        {
            <FONT color="#980517"><A HREF="javascript:ZweiFrames('match7702-1.html#2',3,'match7702-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>&quot;config.option&quot;: MagicMock(side_effect=mock_config_option),
            &quot;boto_elb.exists&quot;: mock_false_bool,
            &quot;boto_elb.create&quot;: mock_true_bool,
            &quot;boto_elb.get_attributes&quot;: mock_attributes,
            &quot;boto_elb.get_health_check&quot;: mock_health_check,
            &quot;boto_elb.get_elb_config&quot;: mock_elb,
            &quot;pillar.get&quot;: MagicMock(return_value={}),
        },
    ):
        with patch.dict(boto_elb.__opts__, {&quot;test&quot;: False}):
            with patch.dict(
                boto_elb.__states__,
                {&quot;boto_route53.present&quot;</B></FONT>: MagicMock(return_value=ret1)},
            ):
                ret = boto_elb.present(
                    name,
                    listeners,
                    availability_zones=avail_zones,
                    health_check=health_check,
                    cnames=cnames,
                )
                mock_changes = {&quot;new&quot;: {&quot;elb&quot;: &quot;myelb&quot;}, &quot;old&quot;: {&quot;elb&quot;: None}}
                assert boto_elb.__states__[&quot;boto_route53.present&quot;].called
                assert mock_changes == ret[&quot;changes&quot;]
                assert ret[&quot;result&quot;]


def test_register_instances():
    &quot;&quot;&quot;
    Test to add instance/s to load balancer
    &quot;&quot;&quot;
    name = &quot;myelb&quot;
    instances = [&quot;instance-id1&quot;, &quot;instance-id2&quot;]

<A NAME="1"></A>    ret = {&quot;name&quot;: name, &quot;result&quot;: False, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}

    mock_bool = MagicMock(return_value=False)
    <FONT color="#f63526"><A HREF="javascript:ZweiFrames('match7702-1.html#1',3,'match7702-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>with patch.dict(boto_elb.__salt__, {&quot;boto_elb.exists&quot;: mock_bool}):
        comt = &quot;Could not find lb {}&quot;.format(name)
        ret.update({&quot;comment&quot;: comt})
        assert boto_elb.register_instances(</B></FONT>name, instances) == ret


def test_absent():
    &quot;&quot;&quot;
    Test to ensure the IAM role is deleted.
    &quot;&quot;&quot;
    name = &quot;new_table&quot;

    ret = {&quot;name&quot;: name, &quot;result&quot;: True, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}
<A NAME="0"></A>
    mock = MagicMock(side_effect=[False, True])
    with patch.dict(boto_elb.__salt__, {&quot;boto_elb.exists&quot;: mock}):
        comt <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match7702-1.html#0',3,'match7702-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= &quot;{} ELB does not exist.&quot;.format(name)
        ret.update({&quot;comment&quot;: comt})
        assert boto_elb.absent(name) == ret

        with patch.dict(boto_elb.__opts__, {&quot;test&quot;: True}):
            comt = &quot;ELB {} is set to be removed.&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
            assert boto_elb.absent(</B></FONT>name) == ret
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_cloud_2.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
<A NAME="4"></A>    :codeauthor: Jayesh Kariya &lt;jayeshk@saltstack.com&gt;
&quot;&quot;&quot;

<FONT color="#6cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7702-0.html#4',2,'match7702-top.html#4',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>import pytest
import salt.states.cloud as cloud
import salt.utils.cloud
from tests.support.mock import MagicMock, patch


@pytest.fixture
def configure_loader_modules():
    return {cloud: {}}


def test_present():
    &quot;&quot;&quot;
    Test to spin up a single instance on a cloud provider, using salt-cloud.
    &quot;&quot;&quot;
    name = &quot;mycloud&quot;
    cloud_provider =</B></FONT> &quot;my_cloud_provider&quot;

    ret = {&quot;name&quot;: name, &quot;result&quot;: True, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}

    mock = MagicMock(side_effect=[True, False])
    mock_bool = MagicMock(side_effect=[True, False, False])
    mock_dict = MagicMock(return_value={&quot;cloud&quot;: &quot;saltcloud&quot;})
    with patch.dict(
        cloud.__salt__,
        {
            &quot;cmd.retcode&quot;: mock,
            &quot;cloud.has_instance&quot;: mock_bool,
            &quot;cloud.create&quot;: mock_dict,
        },
    ):
        comt = &quot;onlyif condition is false&quot;
        ret.update({&quot;comment&quot;: comt})
        assert cloud.present(name, cloud_provider, onlyif=False) == ret

        assert cloud.present(name, cloud_provider, onlyif=&quot;&quot;) == ret

        comt = &quot;unless condition is true&quot;
        ret.update({&quot;comment&quot;: comt})
        assert cloud.present(name, cloud_provider, unless=True) == ret
<A NAME="0"></A>
        assert cloud.present(name, cloud_provider, unless=&quot;&quot;) == ret

        comt <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7702-0.html#0',2,'match7702-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= &quot;Already present instance {}&quot;.format(name)
        ret.update({&quot;comment&quot;: comt})
        assert cloud.present(name, cloud_provider) == ret

        with patch.dict(cloud.__opts__, {&quot;test&quot;: True}):
            comt = &quot;Instance {} needs to be created&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
            assert cloud.present(</B></FONT>name, cloud_provider) == ret

        with patch.dict(cloud.__opts__, {&quot;test&quot;: False}):
            comt = (
                &quot;Created instance mycloud using provider &quot;
                &quot;my_cloud_provider and the following options: {}&quot;
            )
            ret.update(
                {&quot;comment&quot;: comt, &quot;result&quot;: True, &quot;changes&quot;: {&quot;cloud&quot;: &quot;saltcloud&quot;}}
            )
            assert cloud.present(name, cloud_provider) == ret


def test_absent():
    &quot;&quot;&quot;
    Test to ensure that no instances with the specified names exist.
    &quot;&quot;&quot;
    name = &quot;mycloud&quot;

    ret = {&quot;name&quot;: name, &quot;result&quot;: True, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}

    mock = MagicMock(side_effect=[True, False])
    mock_bool = MagicMock(side_effect=[False, True, True])
    mock_dict = MagicMock(return_value={&quot;cloud&quot;: &quot;saltcloud&quot;})
    with patch.dict(
        cloud.__salt__,
        {
            &quot;cmd.retcode&quot;: mock,
            &quot;cloud.has_instance&quot;: mock_bool,
            &quot;cloud.destroy&quot;: mock_dict,
        },
    ):
        comt = &quot;onlyif condition is false&quot;
        ret.update({&quot;comment&quot;: comt})
        assert cloud.absent(name, onlyif=False) == ret

        assert cloud.absent(name, onlyif=&quot;&quot;) == ret

        comt = &quot;unless condition is true&quot;
        ret.update({&quot;comment&quot;: comt})
        assert cloud.absent(name, unless=True) == ret

        assert cloud.absent(name, unless=&quot;&quot;) == ret

        comt = &quot;Already absent instance {}&quot;.format(name)
<A NAME="1"></A>        ret.update({&quot;comment&quot;: comt})
        assert cloud.absent(name) == ret

        <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7702-0.html#1',2,'match7702-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>with patch.dict(cloud.__opts__, {&quot;test&quot;: True}):
            comt = &quot;Instance {} needs to be destroyed&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
            assert cloud.absent(</B></FONT>name) == ret

        with patch.dict(cloud.__opts__, {&quot;test&quot;: False}):
            comt = (&quot;Destroyed instance {}&quot;).format(name)
            ret.update(
                {&quot;comment&quot;: comt, &quot;result&quot;: True, &quot;changes&quot;: {&quot;cloud&quot;: &quot;saltcloud&quot;}}
            )
            assert cloud.absent(name) == ret


def test_profile():
    &quot;&quot;&quot;
    Test to create a single instance on a cloud provider,
    using a salt-cloud profile.
    &quot;&quot;&quot;
    name = &quot;mycloud&quot;
    profile = &quot;myprofile&quot;

    ret = {&quot;name&quot;: name, &quot;result&quot;: True, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}

    mock = MagicMock(side_effect=[True, False])
    mock_dict = MagicMock(
        side_effect=[
            {&quot;cloud&quot;: &quot;saltcloud&quot;},
            {&quot;Not Actioned&quot;: True},
            {&quot;Not Actioned&quot;: True},
            {&quot;Not Found&quot;: True, &quot;Not Actioned/Not Running&quot;: True},
        ]
    )
    mock_d = MagicMock(return_value={})
    with patch.dict(
        cloud.__salt__,
        {&quot;cmd.retcode&quot;: mock, &quot;cloud.profile&quot;: mock_d, &quot;cloud.action&quot;: mock_dict},
    ):
        comt = &quot;onlyif condition is false&quot;
        ret.update({&quot;comment&quot;: comt})
        assert cloud.profile(name, profile, onlyif=False) == ret

        assert cloud.profile(name, profile, onlyif=&quot;&quot;) == ret

        comt = &quot;unless condition is true&quot;
        ret.update({&quot;comment&quot;: comt})
        assert cloud.profile(name, profile, unless=True) == ret

        assert cloud.profile(name, profile, unless=&quot;&quot;) == ret

        comt = &quot;Already present instance {}&quot;.format(name)
        ret.update({&quot;comment&quot;: comt})
        assert cloud.profile(name, profile) == ret

        with patch.dict(cloud.__opts__, {&quot;test&quot;: True}):
            comt = &quot;Instance {} needs to be created&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
            assert cloud.profile(name, profile) == ret

        with patch.dict(cloud.__opts__, {&quot;test&quot;: False}):
            comt = &quot;Failed to create instance {} using profile {}&quot;.format(name, profile)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False})
            assert cloud.profile(name, profile) == ret

        with patch.dict(cloud.__opts__, {&quot;test&quot;: False}):
            comt = &quot;Failed to create instance {} using profile {}&quot;.format(name, profile)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False})
            assert cloud.profile(name, profile) == ret


def test_volume_present():
    &quot;&quot;&quot;
    Test to check that a block volume exists.
    &quot;&quot;&quot;
    name = &quot;mycloud&quot;

    ret = {&quot;name&quot;: name, &quot;result&quot;: False, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}
<A NAME="3"></A>
    mock = MagicMock(return_value=name)
    mock_lst = MagicMock(side_effect=[[name], [], []])
    <FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7702-0.html#3',2,'match7702-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>with patch.dict(
        cloud.__salt__, {&quot;cloud.volume_list&quot;: mock_lst, &quot;cloud.volume_create&quot;: mock}
    ):
        with patch.object(salt.utils.cloud, &quot;check_name&quot;, MagicMock(return_value=True)):
            comt = &quot;Invalid characters in name.&quot;
            ret.update(</B></FONT>{&quot;comment&quot;: comt})
            assert cloud.volume_present(name) == ret

        comt = &quot;Volume exists: {}&quot;.format(name)
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: True})
        assert cloud.volume_present(name) == ret

        with patch.dict(cloud.__opts__, {&quot;test&quot;: True}):
            comt = &quot;Volume {} will be created.&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
            assert cloud.volume_present(name) == ret

        with patch.dict(cloud.__opts__, {&quot;test&quot;: False}):
            comt = &quot;Volume {} was created&quot;.format(name)
            ret.update(
                {
                    &quot;comment&quot;: comt,
                    &quot;result&quot;: True,
                    &quot;changes&quot;: {&quot;old&quot;: None, &quot;new&quot;: name},
                }
            )
            assert cloud.volume_present(name) == ret


def test_volume_absent():
    &quot;&quot;&quot;
    Test to check that a block volume exists.
    &quot;&quot;&quot;
    name = &quot;mycloud&quot;

    ret = {&quot;name&quot;: name, &quot;result&quot;: False, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}

    mock = MagicMock(return_value=False)
    mock_lst = MagicMock(side_effect=[[], [name], [name]])
    with patch.dict(
        cloud.__salt__, {&quot;cloud.volume_list&quot;: mock_lst, &quot;cloud.volume_delete&quot;: mock}
    ):
        with patch.object(salt.utils.cloud, &quot;check_name&quot;, MagicMock(return_value=True)):
            comt = &quot;Invalid characters in name.&quot;
            ret.update({&quot;comment&quot;: comt})
            assert cloud.volume_absent(name) == ret

        comt = &quot;Volume is absent.&quot;
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: True})
        assert cloud.volume_absent(name) == ret

        with patch.dict(cloud.__opts__, {&quot;test&quot;: True}):
            comt = &quot;Volume {} will be deleted.&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
            assert cloud.volume_absent(name) == ret

        with patch.dict(cloud.__opts__, {&quot;test&quot;: False}):
            comt = &quot;Volume {} failed to delete.&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False})
            assert cloud.volume_absent(name) == ret


def test_volume_attached():
    &quot;&quot;&quot;
    Test to check if a block volume is attached.
    &quot;&quot;&quot;
    name = &quot;mycloud&quot;
    server_name = &quot;mycloud_server&quot;
    disk_name = &quot;trogdor&quot;

    ret = {&quot;name&quot;: name, &quot;result&quot;: False, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}

    mock = MagicMock(return_value=False)
    mock_dict = MagicMock(
        side_effect=[
            {name: {&quot;name&quot;: disk_name, &quot;attachments&quot;: True}},
            {},
            {name: {&quot;name&quot;: disk_name, &quot;attachments&quot;: False}},
            {name: {&quot;name&quot;: disk_name, &quot;attachments&quot;: False}},
            {name: {&quot;name&quot;: disk_name, &quot;attachments&quot;: False}},
        ]
    )
    with patch.dict(
        cloud.__salt__, {&quot;cloud.volume_list&quot;: mock_dict, &quot;cloud.action&quot;: mock}
    ):
        with patch.object(
            salt.utils.cloud,
            &quot;check_name&quot;,
            MagicMock(side_effect=[True, False, True]),
        ):
            comt = &quot;Invalid characters in name.&quot;
            ret.update({&quot;comment&quot;: comt})
            assert cloud.volume_attached(name, server_name) == ret

            ret.update({&quot;name&quot;: server_name})
            assert cloud.volume_attached(name, server_name) == ret

        comt = &quot;Volume {} is already attached: True&quot;.format(disk_name)
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: True})
        assert cloud.volume_attached(name, server_name) == ret

        comt = &quot;Volume {} does not exist&quot;.format(name)
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False})
        assert cloud.volume_attached(name, server_name) == ret
<A NAME="2"></A>
        comt = &quot;Server {} does not exist&quot;.format(server_name)
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: False})
        assert cloud<FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match7702-0.html#2',2,'match7702-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.volume_attached(name, server_name) == ret

        mock = MagicMock(return_value=True)
        with patch.dict(
            cloud.__salt__, {&quot;cloud.action&quot;: mock, &quot;cloud.volume_attach&quot;: mock}
        ):
            with patch.dict(cloud.__opts__, {&quot;test&quot;</B></FONT>: True}):
                comt = &quot;Volume {} will be will be attached.&quot;.format(name)
                ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
                assert cloud.volume_attached(name, server_name) == ret

            with patch.dict(cloud.__opts__, {&quot;test&quot;: False}):
                comt = &quot;Volume {} was created&quot;.format(name)
                ret.update(
                    {
                        &quot;comment&quot;: comt,
                        &quot;result&quot;: True,
                        &quot;changes&quot;: {
                            &quot;new&quot;: True,
                            &quot;old&quot;: {&quot;name&quot;: disk_name, &quot;attachments&quot;: False},
                        },
                    }
                )
                assert cloud.volume_attached(name, server_name) == ret


def test_volume_detached():
    &quot;&quot;&quot;
    Test to check if a block volume is detached.
    &quot;&quot;&quot;
    name = &quot;mycloud&quot;
    server_name = &quot;mycloud_server&quot;
    disk_name = &quot;trogdor&quot;

    ret = {&quot;name&quot;: name, &quot;result&quot;: False, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}

    mock = MagicMock(return_value=False)
    mock_dict = MagicMock(
        side_effect=[
            {name: {&quot;name&quot;: disk_name, &quot;attachments&quot;: False}},
            {},
            {name: {&quot;name&quot;: disk_name, &quot;attachments&quot;: True}},
            {name: {&quot;name&quot;: disk_name, &quot;attachments&quot;: True}},
            {name: {&quot;name&quot;: disk_name, &quot;attachments&quot;: True}},
        ]
    )
    with patch.dict(
        cloud.__salt__, {&quot;cloud.volume_list&quot;: mock_dict, &quot;cloud.action&quot;: mock}
    ):
        with patch.object(
            salt.utils.cloud,
            &quot;check_name&quot;,
            MagicMock(side_effect=[True, False, True]),
        ):
            comt = &quot;Invalid characters in name.&quot;
            ret.update({&quot;comment&quot;: comt})
            assert cloud.volume_detached(name, server_name) == ret

            ret.update({&quot;name&quot;: server_name})
            assert cloud.volume_detached(name, server_name) == ret

        comt = &quot;Volume {} is not currently attached to anything.&quot;.format(disk_name)
        ret.update({&quot;comment&quot;: comt, &quot;result&quot;: True})
        assert cloud.volume_detached(name, server_name) == ret

        comt = &quot;Volume {} does not exist&quot;.format(name)
        ret.update({&quot;comment&quot;: comt})
        assert cloud.volume_detached(name, server_name) == ret

        comt = &quot;Server {} does not exist&quot;.format(server_name)
        ret.update({&quot;comment&quot;: comt})
        assert cloud.volume_detached(name, server_name) == ret

        mock = MagicMock(return_value=True)
        with patch.dict(
            cloud.__salt__, {&quot;cloud.action&quot;: mock, &quot;cloud.volume_detach&quot;: mock}
        ):
            with patch.dict(cloud.__opts__, {&quot;test&quot;: True}):
                comt = &quot;Volume {} will be will be detached.&quot;.format(name)
                ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
                assert cloud.volume_detached(name, server_name) == ret

            with patch.dict(cloud.__opts__, {&quot;test&quot;: False}):
                comt = &quot;Volume {} was created&quot;.format(name)
                ret.update(
                    {
                        &quot;comment&quot;: comt,
                        &quot;result&quot;: True,
                        &quot;changes&quot;: {
                            &quot;new&quot;: True,
                            &quot;old&quot;: {&quot;name&quot;: disk_name, &quot;attachments&quot;: True},
                        },
                    }
                )
                assert cloud.volume_detached(name, server_name) == ret
</PRE>
</div>
  </div>
</body>
</html>
