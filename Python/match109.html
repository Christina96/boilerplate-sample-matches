<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for nexus_1.py & artifactory_1.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for nexus_1.py & artifactory_1.py
      </h3>
      <h1 align="center">
        76.8%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>nexus_1.py (79.228485%)<TH>artifactory_1.py (74.68532%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#0',2,'match109-1.html#0',3)" NAME="0">(659-704)<TD><A HREF="javascript:ZweiFrames('match109-0.html#0',2,'match109-1.html#0',3)" NAME="0">(702-746)</A><TD ALIGN=center><FONT COLOR="#ff0000">83</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#1',2,'match109-1.html#1',3)" NAME="1">(705-758)<TD><A HREF="javascript:ZweiFrames('match109-0.html#1',2,'match109-1.html#1',3)" NAME="1">(750-803)</A><TD ALIGN=center><FONT COLOR="#d70000">70</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#2',2,'match109-1.html#2',3)" NAME="2">(597-638)<TD><A HREF="javascript:ZweiFrames('match109-0.html#2',2,'match109-1.html#2',3)" NAME="2">(589-630)</A><TD ALIGN=center><FONT COLOR="#cd0000">67</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#3',2,'match109-1.html#3',3)" NAME="3">(381-414)<TD><A HREF="javascript:ZweiFrames('match109-0.html#3',2,'match109-1.html#3',3)" NAME="3">(323-364)</A><TD ALIGN=center><FONT COLOR="#6e0000">36</FONT>
<TR><TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#4',2,'match109-1.html#4',3)" NAME="4">(535-555)<TD><A HREF="javascript:ZweiFrames('match109-0.html#4',2,'match109-1.html#4',3)" NAME="4">(512-537)</A><TD ALIGN=center><FONT COLOR="#590000">29</FONT>
<TR><TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#5',2,'match109-1.html#5',3)" NAME="5">(108-178)<TD><A HREF="javascript:ZweiFrames('match109-0.html#5',2,'match109-1.html#5',3)" NAME="5">(175-241)</A><TD ALIGN=center><FONT COLOR="#590000">29</FONT>
<TR><TD BGCOLOR="#8c8774"><FONT COLOR="#8c8774">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#6',2,'match109-1.html#6',3)" NAME="6">(493-518)<TD><A HREF="javascript:ZweiFrames('match109-0.html#6',2,'match109-1.html#6',3)" NAME="6">(462-487)</A><TD ALIGN=center><FONT COLOR="#4f0000">26</FONT>
<TR><TD BGCOLOR="#38a4a5"><FONT COLOR="#38a4a5">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#7',2,'match109-1.html#7',3)" NAME="7">(415-441)<TD><A HREF="javascript:ZweiFrames('match109-0.html#7',2,'match109-1.html#7',3)" NAME="7">(366-394)</A><TD ALIGN=center><FONT COLOR="#460000">23</FONT>
<TR><TD BGCOLOR="#c58917"><FONT COLOR="#c58917">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#8',2,'match109-1.html#8',3)" NAME="8">(465-484)<TD><A HREF="javascript:ZweiFrames('match109-0.html#8',2,'match109-1.html#8',3)" NAME="8">(430-449)</A><TD ALIGN=center><FONT COLOR="#430000">22</FONT>
<TR><TD BGCOLOR="#83a33a"><FONT COLOR="#83a33a">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#9',2,'match109-1.html#9',3)" NAME="9">(556-566)<TD><A HREF="javascript:ZweiFrames('match109-0.html#9',2,'match109-1.html#9',3)" NAME="9">(541-551)</A><TD ALIGN=center><FONT COLOR="#400000">21</FONT>
<TR><TD BGCOLOR="#ad5910"><FONT COLOR="#ad5910">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#10',2,'match109-1.html#10',3)" NAME="10">(180-205)<TD><A HREF="javascript:ZweiFrames('match109-0.html#10',2,'match109-1.html#10',3)" NAME="10">(95-120)</A><TD ALIGN=center><FONT COLOR="#3d0000">20</FONT>
<TR><TD BGCOLOR="#b041ff"><FONT COLOR="#b041ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#11',2,'match109-1.html#11',3)" NAME="11">(443-465)<TD><A HREF="javascript:ZweiFrames('match109-0.html#11',2,'match109-1.html#11',3)" NAME="11">(399-422)</A><TD ALIGN=center><FONT COLOR="#370000">18</FONT>
<TR><TD BGCOLOR="#571b7e"><FONT COLOR="#571b7e">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#12',2,'match109-1.html#12',3)" NAME="12">(308-318)<TD><A HREF="javascript:ZweiFrames('match109-0.html#12',2,'match109-1.html#12',3)" NAME="12">(241-252)</A><TD ALIGN=center><FONT COLOR="#340000">17</FONT>
<TR><TD BGCOLOR="#3b9c9c"><FONT COLOR="#3b9c9c">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#13',2,'match109-1.html#13',3)" NAME="13">(96-106)<TD><A HREF="javascript:ZweiFrames('match109-0.html#13',2,'match109-1.html#13',3)" NAME="13">(82-92)</A><TD ALIGN=center><FONT COLOR="#340000">17</FONT>
<TR><TD BGCOLOR="#842dce"><FONT COLOR="#842dce">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#14',2,'match109-1.html#14',3)" NAME="14">(644-658)<TD><A HREF="javascript:ZweiFrames('match109-0.html#14',2,'match109-1.html#14',3)" NAME="14">(686-700)</A><TD ALIGN=center><FONT COLOR="#310000">16</FONT>
<TR><TD BGCOLOR="#f52887"><FONT COLOR="#f52887">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#15',2,'match109-1.html#15',3)" NAME="15">(579-596)<TD><A HREF="javascript:ZweiFrames('match109-0.html#15',2,'match109-1.html#15',3)" NAME="15">(564-584)</A><TD ALIGN=center><FONT COLOR="#310000">16</FONT>
<TR><TD BGCOLOR="#2981b2"><FONT COLOR="#2981b2">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#16',2,'match109-1.html#16',3)" NAME="16">(521-534)<TD><A HREF="javascript:ZweiFrames('match109-0.html#16',2,'match109-1.html#16',3)" NAME="16">(491-507)</A><TD ALIGN=center><FONT COLOR="#240000">12</FONT>
<TR><TD BGCOLOR="#3090c7"><FONT COLOR="#3090c7">-</FONT><TD><A HREF="javascript:ZweiFrames('match109-0.html#17',2,'match109-1.html#17',3)" NAME="17">(319-338)<TD><A HREF="javascript:ZweiFrames('match109-0.html#17',2,'match109-1.html#17',3)" NAME="17">(252-278)</A><TD ALIGN=center><FONT COLOR="#240000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>nexus_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
Module for fetching artifacts from Nexus 3.x

.. versionadded:: 2018.3.0
&quot;&quot;&quot;

import base64
import http.client
import logging
import os
import urllib.request
from urllib.error import HTTPError, URLError

import salt.utils.files
import salt.utils.stringutils
from salt.exceptions import CommandExecutionError

try:
    import xml.etree.ElementTree as ET

    HAS_ELEMENT_TREE = True
except ImportError:
    HAS_ELEMENT_TREE = False

log = logging.getLogger(__name__)

__virtualname__ = &quot;nexus&quot;


def __virtual__():
    &quot;&quot;&quot;
    Only load if elementtree xml library is available.
    &quot;&quot;&quot;
    if not HAS_ELEMENT_TREE:
        return (
            False,
            &quot;Cannot load {} module: ElementTree library unavailable&quot;.format(
                __virtualname__
            ),
        )
    else:
        return True


def get_latest_snapshot(
    nexus_url,
    repository,
    group_id,
    artifact_id,
    packaging,
    target_dir=&quot;/tmp&quot;,
    target_file=None,
    classifier=None,
    username=None,
    password=None,
):
    &quot;&quot;&quot;
    Gets latest snapshot of the given artifact

    nexus_url
        URL of nexus instance
    repository
        Snapshot repository in nexus to retrieve artifact from, for example: libs-snapshots
    group_id
        Group Id of the artifact
    artifact_id
        Artifact Id of the artifact
    packaging
        Packaging type (jar,war,ear,etc)
    target_dir
        Target directory to download artifact to (default: /tmp)
    target_file
        Target file to download artifact to (by default it is target_dir/artifact_id-snapshot_version.packaging)
    classifier
        Artifact classifier name (ex: sources,javadoc,etc). Optional parameter.
    username
        nexus username. Optional parameter.
    password
        nexus password. Optional parameter.
    &quot;&quot;&quot;
    log.debug(
        &quot;======================== MODULE FUNCTION: nexus.get_latest_snapshot,&quot;
        &quot; nexus_url=%s, repository=%s, group_id=%s, artifact_id=%s, packaging=%s,&quot;
        &quot; target_dir=%s, classifier=%s)&quot;,
        nexus_url,
        repository,
        group_id,
        artifact_id,
        packaging,
        target_dir,
        classifier,
    )
<A NAME="13"></A>
    headers = {}
    if username and password:
        headers[&quot;Authorization&quot;] = &quot;Basic {}&quot;<FONT color="#3b9c9c"><A HREF="javascript:ZweiFrames('match109-1.html#13',3,'match109-top.html#13',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.format(
            base64.encodestring(&quot;{}:{}&quot;.format(username, password)).replace(&quot;\n&quot;, &quot;&quot;)
        )
    artifact_metadata = _get_artifact_metadata(
        nexus_url=nexus_url,
        repository=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        headers=headers,
<A NAME="5"></A>    )
    version =</B></FONT> artifact_metadata[&quot;latest_version&quot;]
    snapshot_url, file_name = _get_snapshot_url(
        nexus_url<FONT color="#151b8d"><A HREF="javascript:ZweiFrames('match109-1.html#5',3,'match109-top.html#5',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>=nexus_url,
        repository=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        version=version,
        packaging=packaging,
        classifier=classifier,
        headers=headers,
    )
    target_file = __resolve_target_file(file_name, target_dir, target_file)

    return __save_artifact(snapshot_url, target_file, headers)


def get_snapshot(
    nexus_url,
    repository,
    group_id,
    artifact_id,
    packaging,
    version,
    snapshot_version=None,
    target_dir=&quot;/tmp&quot;,
    target_file=None,
    classifier=None,
    username=None,
    password=None,
):
    &quot;&quot;&quot;
    Gets snapshot of the desired version of the artifact

    nexus_url
        URL of nexus instance
    repository
        Snapshot repository in nexus to retrieve artifact from, for example: libs-snapshots
    group_id
        Group Id of the artifact
    artifact_id
        Artifact Id of the artifact
    packaging
        Packaging type (jar,war,ear,etc)
    version
        Version of the artifact
    target_dir
        Target directory to download artifact to (default: /tmp)
    target_file
        Target file to download artifact to (by default it is target_dir/artifact_id-snapshot_version.packaging)
    classifier
        Artifact classifier name (ex: sources,javadoc,etc). Optional parameter.
    username
        nexus username. Optional parameter.
    password
        nexus password. Optional parameter.
    &quot;&quot;&quot;
    log.debug(
        &quot;======================== MODULE FUNCTION: nexus.get_snapshot(nexus_url=%s,&quot;
        &quot; repository=%s, group_id=%s, artifact_id=%s, packaging=%s, version=%s,&quot;
        &quot; target_dir=%s, classifier=%s)&quot;,
        nexus_url,
        repository,
        group_id,
        artifact_id,
        packaging,
        version,
        target_dir,
        classifier,
    )
    headers = {}
    if username and password:
<A NAME="10"></A>        headers[&quot;Authorization&quot;] = &quot;Basic {}&quot;.format(
            base64.</B></FONT>encodestring(&quot;{}:{}&quot;.format(username, password)).replace(&quot;\n&quot;, &quot;&quot;)
        )
    snapshot_url, file_name <FONT color="#ad5910"><A HREF="javascript:ZweiFrames('match109-1.html#10',3,'match109-top.html#10',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= _get_snapshot_url(
        nexus_url=nexus_url,
        repository=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        version=version,
        packaging=packaging,
        snapshot_version=snapshot_version,
        classifier=classifier,
        headers=headers,
    )
    target_file = __resolve_target_file(file_name, target_dir, target_file)

    return __save_artifact(snapshot_url, target_file, headers)


def get_snapshot_version_string(
    nexus_url,
    repository,
    group_id,
    artifact_id,
    packaging,
    version,
    classifier=None,
    username=None,
    password=</B></FONT>None,
):
    &quot;&quot;&quot;
    Gets the specific version string of a snapshot of the desired version of the artifact

    nexus_url
        URL of nexus instance
    repository
        Snapshot repository in nexus to retrieve artifact from, for example: libs-snapshots
    group_id
        Group Id of the artifact
    artifact_id
        Artifact Id of the artifact
    packaging
        Packaging type (jar,war,ear,etc)
    version
        Version of the artifact
    classifier
        Artifact classifier name (ex: sources,javadoc,etc). Optional parameter.
    username
        nexus username. Optional parameter.
    password
        nexus password. Optional parameter.
    &quot;&quot;&quot;
    log.debug(
        &quot;======================== MODULE FUNCTION:&quot;
        &quot; nexus.get_snapshot_version_string(nexus_url=%s, repository=%s, group_id=%s,&quot;
        &quot; artifact_id=%s, packaging=%s, version=%s, classifier=%s)&quot;,
        nexus_url,
        repository,
        group_id,
        artifact_id,
        packaging,
        version,
        classifier,
    )
    headers = {}
    if username and password:
        headers[&quot;Authorization&quot;] = &quot;Basic {}&quot;.format(
            base64.encodestring(&quot;{}:{}&quot;.format(username, password)).replace(&quot;\n&quot;, &quot;&quot;)
        )
    return _get_snapshot_url(
        nexus_url=nexus_url,
        repository=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        version=version,
        packaging=packaging,
        classifier=classifier,
        just_get_version_string=True,
    )


def get_latest_release(
    nexus_url,
    repository,
    group_id,
    artifact_id,
    packaging,
    target_dir=&quot;/tmp&quot;,
    target_file=None,
    classifier=None,
    username=None,
    password=None,
):
    &quot;&quot;&quot;
    Gets the latest release of the artifact

    nexus_url
        URL of nexus instance
    repository
        Release repository in nexus to retrieve artifact from, for example: libs-releases
    group_id
        Group Id of the artifact
    artifact_id
        Artifact Id of the artifact
    packaging
        Packaging type (jar,war,ear,etc)
    target_dir
        Target directory to download artifact to (default: /tmp)
    target_file
        Target file to download artifact to (by default it is target_dir/artifact_id-version.packaging)
    classifier
        Artifact classifier name (ex: sources,javadoc,etc). Optional parameter.
    username
        nexus username. Optional parameter.
    password
        nexus password. Optional parameter.
    &quot;&quot;&quot;
    log.debug(
        &quot;======================== MODULE FUNCTION:&quot;
        &quot; nexus.get_latest_release(nexus_url=%s, repository=%s, group_id=%s,&quot;
        &quot; artifact_id=%s, packaging=%s, target_dir=%s, classifier=%s)&quot;,
        nexus_url,
        repository,
        group_id,
        artifact_id,
        packaging,
        target_dir,
        classifier,
<A NAME="12"></A>    )
    headers = {}
    if username and password:
        headers[&quot;Authorization&quot;] = &quot;Basic {}&quot;<FONT color="#571b7e"><A HREF="javascript:ZweiFrames('match109-1.html#12',3,'match109-top.html#12',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.format(
            base64.encodestring(&quot;{}:{}&quot;.format(username, password)).replace(&quot;\n&quot;, &quot;&quot;)
        )
    artifact_metadata = _get_artifact_metadata(
        nexus_url=nexus_url,
        repository=repository,
        group_id=group_id,
        artifact_id=artifact_id,
<A NAME="17"></A>        headers=headers,
    )
    version =</B></FONT> artifact_metadata[&quot;latest_version&quot;]
    release_url, file_name = _get_release_url<FONT color="#3090c7"><A HREF="javascript:ZweiFrames('match109-1.html#17',3,'match109-top.html#17',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>(
        repository, group_id, artifact_id, packaging, version, nexus_url, classifier
    )
    target_file = __resolve_target_file(file_name, target_dir, target_file)

    return __save_artifact(release_url, target_file, headers)


def get_release(
    nexus_url,
    repository,
    group_id,
    artifact_id,
    packaging,
    version,
    target_dir=&quot;/tmp&quot;,
    target_file=None,
    classifier=None,
    username=None,
    password=</B></FONT>None,
):
    &quot;&quot;&quot;
    Gets the specified release of the artifact

    nexus_url
        URL of nexus instance
    repository
        Release repository in nexus to retrieve artifact from, for example: libs-releases
    group_id
        Group Id of the artifact
    artifact_id
        Artifact Id of the artifact
    packaging
        Packaging type (jar,war,ear,etc)
    version
        Version of the artifact
    target_dir
        Target directory to download artifact to (default: /tmp)
    target_file
        Target file to download artifact to (by default it is target_dir/artifact_id-version.packaging)
    classifier
        Artifact classifier name (ex: sources,javadoc,etc). Optional parameter.
    username
        nexus username. Optional parameter.
    password
        nexus password. Optional parameter.
    &quot;&quot;&quot;
    log.debug(
        &quot;======================== MODULE FUNCTION: nexus.get_release(nexus_url=%s,&quot;
        &quot; repository=%s, group_id=%s, artifact_id=%s, packaging=%s, version=%s,&quot;
        &quot; target_dir=%s, classifier=%s)&quot;,
        nexus_url,
        repository,
        group_id,
        artifact_id,
        packaging,
        version,
        target_dir,
        classifier,
<A NAME="3"></A>    )
    headers = {}
    if username and password:
        headers[&quot;Authorization&quot;] = &quot;Basic {}&quot;<FONT color="#53858b"><A HREF="javascript:ZweiFrames('match109-1.html#3',3,'match109-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.format(
            base64.encodestring(&quot;{}:{}&quot;.format(username, password)).replace(&quot;\n&quot;, &quot;&quot;)
        )
    release_url, file_name = _get_release_url(
        repository, group_id, artifact_id, packaging, version, nexus_url, classifier
    )
    target_file = __resolve_target_file(file_name, target_dir, target_file)

    return __save_artifact(release_url, target_file, headers)


def __resolve_target_file(file_name, target_dir, target_file=None):
    if target_file is None:
        target_file = os.path.join(target_dir, file_name)
    return target_file


def _get_snapshot_url(
    nexus_url,
    repository,
    group_id,
    artifact_id,
    version,
    packaging,
    snapshot_version=None,
    classifier=None,
    headers=None,
    just_get_version_string=None,
):
    if headers is None:
        headers = {}
<A NAME="7"></A>    has_classifier = classifier is not None and classifier != &quot;&quot;

    if</B></FONT> snapshot_version is None:
        snapshot_version_metadata <FONT color="#38a4a5"><A HREF="javascript:ZweiFrames('match109-1.html#7',3,'match109-top.html#7',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= _get_snapshot_version_metadata(
            nexus_url=nexus_url,
            repository=repository,
            group_id=group_id,
            artifact_id=artifact_id,
            version=version,
            headers=headers,
        )

        if packaging not in snapshot_version_metadata[&quot;snapshot_versions&quot;]:
            error_message = &quot;&quot;&quot;Cannot find requested packaging '{packaging}' in the snapshot version metadata.
                      nexus_url: {nexus_url}
                      repository: {repository}
                      group_id: {group_id}
                      artifact_id: {artifact_id}
                      packaging: {packaging}
                      classifier: {classifier}
                      version: {version}&quot;&quot;&quot;.format(
                nexus_url=nexus_url,
                repository=repository,
                group_id=group_id,
                artifact_id=artifact_id,
                packaging=packaging,
                classifier=classifier,
                version=version,
<A NAME="11"></A>            )
            raise nexusError(</B></FONT>error_message)

        <FONT color="#b041ff"><A HREF="javascript:ZweiFrames('match109-1.html#11',3,'match109-top.html#11',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>if (
            has_classifier
            and classifier not in snapshot_version_metadata[&quot;snapshot_versions&quot;]
        ):
            error_message = &quot;&quot;&quot;Cannot find requested classifier '{classifier}' in the snapshot version metadata.
                      nexus_url: {nexus_url}
                      repository: {repository}
                      group_id: {group_id}
                      artifact_id: {artifact_id}
                      packaging: {packaging}
                      classifier: {classifier}
                      version: {version}&quot;&quot;&quot;.format(
                nexus_url=nexus_url,
                repository=repository,
                group_id=group_id,
                artifact_id=artifact_id,
                packaging=packaging,
                classifier=classifier,
                version=version,
<A NAME="8"></A>            )
            raise nexusError(error_message)

        snapshot_version = snapshot_version_metadata[&quot;snapshot_versions&quot;][</B></FONT><FONT color="#c58917"><A HREF="javascript:ZweiFrames('match109-1.html#8',3,'match109-top.html#8',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>packaging]

    group_url = __get_group_id_subpath(group_id)

    file_name = &quot;{artifact_id}-{snapshot_version}{classifier}.{packaging}&quot;.format(
        artifact_id=artifact_id,
        snapshot_version=snapshot_version,
        packaging=packaging,
        classifier=__get_classifier_url(classifier),
    )

    snapshot_url = &quot;{nexus_url}/{repository}/{group_url}/{artifact_id}/{version}/{file_name}&quot;.format(
        nexus_url=nexus_url,
        repository=repository,
        group_url=group_url,
        artifact_id=artifact_id,
        version=version,
        file_name=file_name,
    )
    log.debug(</B></FONT>&quot;snapshot_url=%s&quot;, snapshot_url)

    if just_get_version_string:
        return snapshot_version
    else:
        return snapshot_url, file_name
<A NAME="6"></A>

def _get_release_url(
    repository, group_id, artifact_id, packaging, version, nexus_url, classifier<FONT color="#8c8774"><A HREF="javascript:ZweiFrames('match109-1.html#6',3,'match109-top.html#6',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>=None
):
    group_url = __get_group_id_subpath(group_id)

    # for released versions the suffix for the file is same as version
    file_name = &quot;{artifact_id}-{version}{classifier}.{packaging}&quot;.format(
        artifact_id=artifact_id,
        version=version,
        packaging=packaging,
        classifier=__get_classifier_url(classifier),
    )

    release_url = &quot;{nexus_url}/{repository}/{group_url}/{artifact_id}/{version}/{file_name}&quot;.format(
        nexus_url=nexus_url,
        repository=repository,
        group_url=group_url,
        artifact_id=artifact_id,
        version=version,
        file_name=file_name,
    )
    log.debug(&quot;release_url=%s&quot;, release_url)
    return release_url, file_name


def _get_artifact_metadata_url(nexus_url, repository, group_id, artifact_id):
<A NAME="16"></A>    group_url =</B></FONT> __get_group_id_subpath(group_id)
    # for released versions the suffix for the file is same as version
    artifact_metadata_url = (
        &quot;{nexus_url}/{repository}/{group_url}/{artifact_id}/maven-metadata.xml&quot;<FONT color="#2981b2"><A HREF="javascript:ZweiFrames('match109-1.html#16',3,'match109-top.html#16',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.format(
            nexus_url=nexus_url,
            repository=repository,
            group_url=group_url,
            artifact_id=artifact_id,
        )
    )
    log.debug(&quot;artifact_metadata_url=%s&quot;, artifact_metadata_url)
    return artifact_metadata_url


<A NAME="4"></A>def _get_artifact_metadata_xml(nexus_url, repository, group_id, artifact_id, headers):

    artifact_metadata_url =</B></FONT> _get_artifact_metadata_url(
        nexus_url<FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match109-1.html#4',3,'match109-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>=nexus_url,
        repository=repository,
        group_id=group_id,
        artifact_id=artifact_id,
    )

    try:
        request = urllib.request.Request(artifact_metadata_url, None, headers)
        artifact_metadata_xml = urllib.request.urlopen(request).read()
    except (HTTPError, URLError) as err:
        message = &quot;Could not fetch data from url: {}. ERROR: {}&quot;.format(
            artifact_metadata_url, err
        )
        raise CommandExecutionError(message)

    log.debug(&quot;artifact_metadata_xml=%s&quot;, artifact_metadata_xml)
    return artifact_metadata_xml

<A NAME="9"></A>
def _get_artifact_metadata(nexus_url, repository, group_id, artifact_id, headers):
    metadata_xml =</B></FONT> _get_artifact_metadata_xml(
        nexus_url<FONT color="#83a33a"><A HREF="javascript:ZweiFrames('match109-1.html#9',3,'match109-top.html#9',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>=nexus_url,
        repository=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        headers=headers,
    )
    root = ET.fromstring(metadata_xml)

    assert group_id == root.find(&quot;groupId&quot;).text
    assert artifact_id == root.find(&quot;artifactId&quot;).text
    versions = root.find(&quot;versioning&quot;).find(</B></FONT>&quot;versions&quot;)
    versionList = []
    for version in versions.iter(&quot;version&quot;):
        versionList.append(version.text)
    latest_version = max(versionList)
    log.debug(&quot;latest version=%s&quot;, latest_version)
    return {&quot;latest_version&quot;: latest_version}


# functions for handling snapshots
<A NAME="15"></A>def _get_snapshot_version_metadata_url(
    nexus_url, repository, group_id, artifact_id, version
):
    group_url <FONT color="#f52887"><A HREF="javascript:ZweiFrames('match109-1.html#15',3,'match109-top.html#15',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= __get_group_id_subpath(group_id)
    # for released versions the suffix for the file is same as version
    snapshot_version_metadata_url = &quot;{nexus_url}/{repository}/{group_url}/{artifact_id}/{version}/maven-metadata.xml&quot;.format(
        nexus_url=nexus_url,
        repository=repository,
        group_url=group_url,
        artifact_id=artifact_id,
        version=version,
    )
    log.debug(&quot;snapshot_version_metadata_url=%s&quot;, snapshot_version_metadata_url)
    return snapshot_version_metadata_url


def _get_snapshot_version_metadata_xml(
    nexus_url, repository, group_id, artifact_id, version, headers
<A NAME="2"></A>):

    snapshot_version_metadata_url =</B></FONT> _get_snapshot_version_metadata_url(
        nexus_url<FONT color="#980517"><A HREF="javascript:ZweiFrames('match109-1.html#2',3,'match109-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>=nexus_url,
        repository=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        version=version,
    )

    try:
        request = urllib.request.Request(snapshot_version_metadata_url, None, headers)
        snapshot_version_metadata_xml = urllib.request.urlopen(request).read()
    except (HTTPError, URLError) as err:
        message = &quot;Could not fetch data from url: {}. ERROR: {}&quot;.format(
            snapshot_version_metadata_url, err
        )
        raise CommandExecutionError(message)

    log.debug(&quot;snapshot_version_metadata_xml=%s&quot;, snapshot_version_metadata_xml)
    return snapshot_version_metadata_xml


def _get_snapshot_version_metadata(
    nexus_url, repository, group_id, artifact_id, version, headers
):
    metadata_xml = _get_snapshot_version_metadata_xml(
        nexus_url=nexus_url,
        repository=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        version=version,
        headers=headers,
    )
    metadata = ET.fromstring(metadata_xml)

    assert group_id == metadata.find(&quot;groupId&quot;).text
    assert artifact_id == metadata.find(&quot;artifactId&quot;).text
    assert version == metadata.find(&quot;version&quot;).text

    snapshot_versions = metadata.find(&quot;versioning&quot;).find(&quot;snapshotVersions&quot;)
    extension_version_dict = {}
    for snapshot_version in snapshot_versions:
        extension = snapshot_version.find(&quot;extension&quot;).text
        value = snapshot_version.find(&quot;value&quot;).</B></FONT>text
        extension_version_dict[extension] = value
        if snapshot_version.find(&quot;classifier&quot;) is not None:
<A NAME="14"></A>            classifier = snapshot_version.find(&quot;classifier&quot;).text
            extension_version_dict[classifier] = value

    return {&quot;<FONT color="#842dce"><A HREF="javascript:ZweiFrames('match109-1.html#14',3,'match109-top.html#14',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>snapshot_versions&quot;: extension_version_dict}


def __save_artifact(artifact_url, target_file, headers):
    log.debug(&quot;__save_artifact(%s, %s)&quot;, artifact_url, target_file)
    result = {&quot;status&quot;: False, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}

    if os.path.isfile(target_file):
        log.debug(&quot;File %s already exists, checking checksum...&quot;, target_file)
        checksum_url = artifact_url + &quot;.sha1&quot;

        checksum_success, artifact_sum, checksum_comment = __download(
<A NAME="0"></A>            checksum_url, headers
        )
        if</B></FONT> checksum_success:
            log<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match109-1.html#0',3,'match109-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.debug(&quot;Downloaded SHA1 SUM: %s&quot;, artifact_sum)
            file_sum = __salt__[&quot;file.get_hash&quot;](path=target_file, form=&quot;sha1&quot;)
            log.debug(&quot;Target file (%s) SHA1 SUM: %s&quot;, target_file, file_sum)

            if artifact_sum == file_sum:
                result[&quot;status&quot;] = True
                result[&quot;target_file&quot;] = target_file
                result[&quot;comment&quot;] = (
                    &quot;File {} already exists, checksum matches with nexus.\n&quot;
                    &quot;Checksum URL: {}&quot;.format(target_file, checksum_url)
                )
                return result
            else:
                result[&quot;comment&quot;] = (
                    &quot;File {} already exists, checksum does not match with nexus!\n&quot;
                    &quot;Checksum URL: {}&quot;.format(target_file, checksum_url)
                )

        else:
            result[&quot;status&quot;] = False
            result[&quot;comment&quot;] = checksum_comment
            return result

    log.debug(&quot;Downloading: %s -&gt; %s&quot;, artifact_url, target_file)

    try:
        request = urllib.request.Request(artifact_url, None, headers)
        f = urllib.request.urlopen(request)
        with salt.utils.files.fopen(target_file, &quot;wb&quot;) as local_file:
            local_file.write(salt.utils.stringutils.to_bytes(f.read()))
        result[&quot;status&quot;] = True
        result[&quot;comment&quot;] = __append_comment(
            &quot;Artifact downloaded from URL: {}&quot;.format(artifact_url),
            result[&quot;comment&quot;],
        )
        result[&quot;changes&quot;][&quot;downloaded_file&quot;] = target_file
        result[&quot;target_file&quot;] = target_file
    except (HTTPError, URLError) as e:
        result[&quot;status&quot;] = False
        result[&quot;comment&quot;] = __get_error_comment(e, artifact_url)

    return result

<A NAME="1"></A>
def __get_group_id_subpath(group_id):
    group_url =</B></FONT> group_id.replace(&quot;.&quot;, &quot;/&quot;)
    <FONT color="#f63526"><A HREF="javascript:ZweiFrames('match109-1.html#1',3,'match109-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>return group_url


def __get_classifier_url(classifier):
    has_classifier = classifier is not None and classifier != &quot;&quot;
    return &quot;-&quot; + classifier if has_classifier else &quot;&quot;


def __download(request_url, headers):
    log.debug(&quot;Downloading content from %s&quot;, request_url)

    success = False
    content = None
    comment = None
    try:
        request = urllib.request.Request(request_url, None, headers)
        url = urllib.request.urlopen(request)
        content = url.read()
        success = True
    except HTTPError as e:
        comment = __get_error_comment(e, request_url)

    return success, content, comment


def __get_error_comment(http_error, request_url):
    if http_error.code == http.client.NOT_FOUND:
        comment = &quot;HTTP Error 404. Request URL: &quot; + request_url
    elif http_error.code == http.client.CONFLICT:
        comment = (
            &quot;HTTP Error 409: Conflict. Requested URL: {}. \nThis error may be caused by&quot;
            &quot; reading snapshot artifact from non-snapshot repository.&quot;.format(
                request_url
            )
        )
    else:
        comment = &quot;HTTP Error {err_code}. Request URL: {url}&quot;.format(
            err_code=http_error.code, url=request_url
        )

    return comment


def __append_comment(new_comment, current_comment=&quot;&quot;):
    return current_comment + &quot;\n&quot; + new_comment


class nexusError(Exception):
    def __init__(self, value):
        super().__init__()
        self.value = value

    def __str__(self):
        return repr(self.v</B></FONT>alue)
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>artifactory_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
Module for fetching artifacts from Artifactory
&quot;&quot;&quot;

import http.client
import logging
import os
import urllib.request
import xml.etree.ElementTree as ET
from urllib.error import HTTPError, URLError

import salt.utils.files
import salt.utils.hashutils
import salt.utils.stringutils
from salt.exceptions import CommandExecutionError

log = logging.getLogger(__name__)

__virtualname__ = &quot;artifactory&quot;


def __virtual__():
    &quot;&quot;&quot;
    Only load if elementtree xml library is available.
    &quot;&quot;&quot;
    return True


def get_latest_snapshot(
    artifactory_url,
    repository,
    group_id,
    artifact_id,
    packaging,
    target_dir=&quot;/tmp&quot;,
    target_file=None,
    classifier=None,
    username=None,
    password=None,
    use_literal_group_id=False,
):
    &quot;&quot;&quot;
    Gets latest snapshot of the given artifact

    artifactory_url
        URL of artifactory instance
    repository
        Snapshot repository in artifactory to retrieve artifact from, for example: libs-snapshots
    group_id
        Group Id of the artifact
    artifact_id
        Artifact Id of the artifact
    packaging
        Packaging type (jar,war,ear,etc)
    target_dir
        Target directory to download artifact to (default: /tmp)
    target_file
        Target file to download artifact to (by default it is target_dir/artifact_id-snapshot_version.packaging)
    classifier
        Artifact classifier name (ex: sources,javadoc,etc). Optional parameter.
    username
        Artifactory username. Optional parameter.
    password
        Artifactory password. Optional parameter.
    &quot;&quot;&quot;
    log.debug(
        &quot;======================== MODULE FUNCTION: artifactory.get_latest_snapshot,&quot;
        &quot; artifactory_url=%s, repository=%s, group_id=%s, artifact_id=%s, packaging=%s,&quot;
        &quot; target_dir=%s, classifier=%s)&quot;,
        artifactory_url,
        repository,
        group_id,
        artifact_id,
        packaging,
        target_dir,
        classifier,
    )

<A NAME="13"></A>    headers = {}
    if username and password:
        headers[&quot;Authorization&quot;] = &quot;Basic {}&quot;.format(
            salt.utils.hashutils<FONT color="#3b9c9c"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#13',2,'match109-top.html#13',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.base64_encodestring(
                &quot;{}:{}&quot;.format(username.replace(&quot;\n&quot;, &quot;&quot;), password.replace(&quot;\n&quot;, &quot;&quot;))
            )
        )
    artifact_metadata = _get_artifact_metadata(
        artifactory_url=artifactory_url,
        repository=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        headers=headers,
<A NAME="10"></A>        use_literal_group_id=</B></FONT>use_literal_group_id,
    )
    version = artifact_metadata[&quot;latest_version&quot;]
    snapshot_url, file_name <FONT color="#ad5910"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#10',2,'match109-top.html#10',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= _get_snapshot_url(
        artifactory_url=artifactory_url,
        repository=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        version=version,
        packaging=packaging,
        classifier=classifier,
        headers=headers,
        use_literal_group_id=use_literal_group_id,
    )
    target_file = __resolve_target_file(file_name, target_dir, target_file)

    return __save_artifact(snapshot_url, target_file, headers)


def get_snapshot(
    artifactory_url,
    repository,
    group_id,
    artifact_id,
    packaging,
    version,
    snapshot_version=None,
    target_dir=&quot;/tmp&quot;,
    target_file=</B></FONT>None,
    classifier=None,
    username=None,
    password=None,
    use_literal_group_id=False,
):
    &quot;&quot;&quot;
    Gets snapshot of the desired version of the artifact

    artifactory_url
        URL of artifactory instance
    repository
        Snapshot repository in artifactory to retrieve artifact from, for example: libs-snapshots
    group_id
        Group Id of the artifact
    artifact_id
        Artifact Id of the artifact
    packaging
        Packaging type (jar,war,ear,etc)
    version
        Version of the artifact
    target_dir
        Target directory to download artifact to (default: /tmp)
    target_file
        Target file to download artifact to (by default it is target_dir/artifact_id-snapshot_version.packaging)
    classifier
        Artifact classifier name (ex: sources,javadoc,etc). Optional parameter.
    username
        Artifactory username. Optional parameter.
    password
        Artifactory password. Optional parameter.
    &quot;&quot;&quot;
    log.debug(
        &quot;======================== MODULE FUNCTION:&quot;
        &quot; artifactory.get_snapshot(artifactory_url=%s, repository=%s, group_id=%s,&quot;
        &quot; artifact_id=%s, packaging=%s, version=%s, target_dir=%s, classifier=%s)&quot;,
        artifactory_url,
        repository,
        group_id,
        artifact_id,
        packaging,
        version,
        target_dir,
        classifier,
    )
    headers = {}
    if username and password:
        headers[&quot;Authorization&quot;] = &quot;Basic {}&quot;.format(
            salt.utils.hashutils.base64_encodestring(
                &quot;{}:{}&quot;.format(username.replace(&quot;\n&quot;, &quot;&quot;), password.replace(&quot;\n&quot;, &quot;&quot;))
            )
        )
<A NAME="5"></A>    snapshot_url, file_name = _get_snapshot_url(
        artifactory_url=artifactory_url,
        repository=repository,
        group_id<FONT color="#151b8d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#5',2,'match109-top.html#5',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>=group_id,
        artifact_id=artifact_id,
        version=version,
        packaging=packaging,
        snapshot_version=snapshot_version,
        classifier=classifier,
        headers=headers,
        use_literal_group_id=use_literal_group_id,
    )
    target_file = __resolve_target_file(file_name, target_dir, target_file)

    return __save_artifact(snapshot_url, target_file, headers)


def get_latest_release(
    artifactory_url,
    repository,
    group_id,
    artifact_id,
    packaging,
    target_dir=&quot;/tmp&quot;,
    target_file=None,
    classifier=None,
    username=None,
    password=None,
    use_literal_group_id=False,
):
    &quot;&quot;&quot;
    Gets the latest release of the artifact

    artifactory_url
        URL of artifactory instance
    repository
        Release repository in artifactory to retrieve artifact from, for example: libs-releases
    group_id
        Group Id of the artifact
    artifact_id
        Artifact Id of the artifact
    packaging
        Packaging type (jar,war,ear,etc)
    target_dir
        Target directory to download artifact to (default: /tmp)
    target_file
        Target file to download artifact to (by default it is target_dir/artifact_id-version.packaging)
    classifier
        Artifact classifier name (ex: sources,javadoc,etc). Optional parameter.
    username
        Artifactory username. Optional parameter.
    password
        Artifactory password. Optional parameter.
    &quot;&quot;&quot;
    log.debug(
        &quot;======================== MODULE FUNCTION:&quot;
        &quot; artifactory.get_latest_release(artifactory_url=%s, repository=%s,&quot;
        &quot; group_id=%s, artifact_id=%s, packaging=%s, target_dir=%s, classifier=%s)&quot;,
        artifactory_url,
        repository,
        group_id,
        artifact_id,
        packaging,
        target_dir,
        classifier,
    )
<A NAME="12"></A>    headers = {}
    if username and password:
        headers[&quot;Authorization&quot;] = &quot;Basic {}&quot;.format(
            salt.</B></FONT>utils.hashutils<FONT color="#571b7e"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#12',2,'match109-top.html#12',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.base64_encodestring(
                &quot;{}:{}&quot;.format(username.replace(&quot;\n&quot;, &quot;&quot;), password.replace(&quot;\n&quot;, &quot;&quot;))
            )
        )
    version = __find_latest_version(
        artifactory_url=artifactory_url,
        repository=repository,
        group_id=group_id,
<A NAME="17"></A>        artifact_id=artifact_id,
        headers=headers,
    )
    release_url, file_name =</B></FONT> _get_release_url<FONT color="#3090c7"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#17',2,'match109-top.html#17',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>(
        repository,
        group_id,
        artifact_id,
        packaging,
        version,
        artifactory_url,
        classifier,
        use_literal_group_id,
    )
    target_file = __resolve_target_file(file_name, target_dir, target_file)

    return __save_artifact(release_url, target_file, headers)


def get_release(
    artifactory_url,
    repository,
    group_id,
    artifact_id,
    packaging,
    version,
    target_dir=&quot;/tmp&quot;,
    target_file=None,
    classifier=None,
    username=None,
    password=</B></FONT>None,
    use_literal_group_id=False,
):
    &quot;&quot;&quot;
    Gets the specified release of the artifact

    artifactory_url
        URL of artifactory instance
    repository
        Release repository in artifactory to retrieve artifact from, for example: libs-releases
    group_id
        Group Id of the artifact
    artifact_id
        Artifact Id of the artifact
    packaging
        Packaging type (jar,war,ear,etc)
    version
        Version of the artifact
    target_dir
        Target directory to download artifact to (default: /tmp)
    target_file
        Target file to download artifact to (by default it is target_dir/artifact_id-version.packaging)
    classifier
        Artifact classifier name (ex: sources,javadoc,etc). Optional parameter.
    username
        Artifactory username. Optional parameter.
    password
        Artifactory password. Optional parameter.
    &quot;&quot;&quot;
    log.debug(
        &quot;======================== MODULE FUNCTION:&quot;
        &quot; artifactory.get_release(artifactory_url=%s, repository=%s, group_id=%s,&quot;
        &quot; artifact_id=%s, packaging=%s, version=%s, target_dir=%s, classifier=%s)&quot;,
        artifactory_url,
        repository,
        group_id,
        artifact_id,
        packaging,
        version,
        target_dir,
        classifier,
    )
<A NAME="3"></A>    headers = {}
    if username and password:
        headers[&quot;Authorization&quot;] = &quot;Basic {}&quot;.format(
            salt.utils.hashutils<FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#3',2,'match109-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.base64_encodestring(
                &quot;{}:{}&quot;.format(username.replace(&quot;\n&quot;, &quot;&quot;), password.replace(&quot;\n&quot;, &quot;&quot;))
            )
        )
    release_url, file_name = _get_release_url(
        repository,
        group_id,
        artifact_id,
        packaging,
        version,
        artifactory_url,
        classifier,
        use_literal_group_id,
    )
    target_file = __resolve_target_file(file_name, target_dir, target_file)

    return __save_artifact(release_url, target_file, headers)


def __resolve_target_file(file_name, target_dir, target_file=None):
    if target_file is None:
        target_file = os.path.join(target_dir, file_name)
    return target_file


def _get_snapshot_url(
    artifactory_url,
    repository,
    group_id,
    artifact_id,
    version,
    packaging,
    snapshot_version=None,
    classifier=None,
    headers=None,
    use_literal_group_id=False,
):
    if headers is None:
        headers = {}
    has_classifier = classifier is not None and classifier != &quot;&quot;
<A NAME="7"></A>
    if</B></FONT> snapshot_version is None:
        try:
            snapshot_version_metadata <FONT color="#38a4a5"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#7',2,'match109-top.html#7',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= _get_snapshot_version_metadata(
                artifactory_url=artifactory_url,
                repository=repository,
                group_id=group_id,
                artifact_id=artifact_id,
                version=version,
                headers=headers,
            )
            if (
                not has_classifier
                and packaging not in snapshot_version_metadata[&quot;snapshot_versions&quot;]
            ):
                error_message = &quot;&quot;&quot;Cannot find requested packaging '{packaging}' in the snapshot version metadata.
                          artifactory_url: {artifactory_url}
                          repository: {repository}
                          group_id: {group_id}
                          artifact_id: {artifact_id}
                          packaging: {packaging}
                          classifier: {classifier}
                          version: {version}&quot;&quot;&quot;.format(
                    artifactory_url=artifactory_url,
                    repository=repository,
                    group_id=group_id,
                    artifact_id=artifact_id,
                    packaging=packaging,
                    classifier=classifier,
                    version=version,
                )
                raise ArtifactoryError(</B></FONT>error_message)

<A NAME="11"></A>            packaging_with_classifier = (
                packaging if not has_classifier else packaging + &quot;:&quot; + classifier
            )
            <FONT color="#b041ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#11',2,'match109-top.html#11',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>if (
                has_classifier
                and packaging_with_classifier
                not in snapshot_version_metadata[&quot;snapshot_versions&quot;]
            ):
                error_message = &quot;&quot;&quot;Cannot find requested classifier '{classifier}' in the snapshot version metadata.
                          artifactory_url: {artifactory_url}
                          repository: {repository}
                          group_id: {group_id}
                          artifact_id: {artifact_id}
                          packaging: {packaging}
                          classifier: {classifier}
                          version: {version}&quot;&quot;&quot;.format(
                    artifactory_url=artifactory_url,
                    repository=repository,
                    group_id=group_id,
                    artifact_id=artifact_id,
                    packaging=packaging,
                    classifier=classifier,
                    version=version,
                )
                raise ArtifactoryError(error_message)

            snapshot_version = snapshot_version_metadata[&quot;snapshot_versions&quot;][</B></FONT>
                packaging_with_classifier
            ]
        except CommandExecutionError as err:
            log.error(
<A NAME="8"></A>                &quot;Could not fetch maven-metadata.xml. Assuming snapshot_version=%s.&quot;,
                version,
            )
            snapshot_version =<FONT color="#c58917"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#8',2,'match109-top.html#8',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B> version

    group_url = __get_group_id_subpath(group_id, use_literal_group_id)

    file_name = &quot;{artifact_id}-{snapshot_version}{classifier}.{packaging}&quot;.format(
        artifact_id=artifact_id,
        snapshot_version=snapshot_version,
        packaging=packaging,
        classifier=__get_classifier_url(classifier),
    )

    snapshot_url = &quot;{artifactory_url}/{repository}/{group_url}/{artifact_id}/{version}/{file_name}&quot;.format(
        artifactory_url=artifactory_url,
        repository=repository,
        group_url=group_url,
        artifact_id=artifact_id,
        version=version,
        file_name=file_name,
    )
    log.debug(</B></FONT>&quot;snapshot_url=%s&quot;, snapshot_url)

    return snapshot_url, file_name


def _get_release_url(
    repository,
    group_id,
    artifact_id,
    packaging,
<A NAME="6"></A>    version,
    artifactory_url,
    classifier=None,
    use_literal_group_id<FONT color="#8c8774"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#6',2,'match109-top.html#6',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>=False,
):
    group_url = __get_group_id_subpath(group_id, use_literal_group_id)

    # for released versions the suffix for the file is same as version
    file_name = &quot;{artifact_id}-{version}{classifier}.{packaging}&quot;.format(
        artifact_id=artifact_id,
        version=version,
        packaging=packaging,
        classifier=__get_classifier_url(classifier),
    )

    release_url = &quot;{artifactory_url}/{repository}/{group_url}/{artifact_id}/{version}/{file_name}&quot;.format(
        artifactory_url=artifactory_url,
        repository=repository,
        group_url=group_url,
        artifact_id=artifact_id,
        version=version,
        file_name=file_name,
    )
    log.debug(&quot;release_url=%s&quot;, release_url)
    return release_url, file_name


def _get_artifact_metadata_url(
    artifactory_url, repository, group_id, artifact_id, use_literal_group_id=</B></FONT>False
<A NAME="16"></A>):
    group_url = __get_group_id_subpath(group_id, use_literal_group_id)
    # for released versions the suffix for the file is same as version
    artifact_metadata_url = &quot;{artifactory_url}/{repository}/{group_url}/{artifact_id}/maven-metadata.xml&quot;<FONT color="#2981b2"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#16',2,'match109-top.html#16',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.format(
        artifactory_url=artifactory_url,
        repository=repository,
        group_url=group_url,
        artifact_id=artifact_id,
    )
    log.debug(&quot;artifact_metadata_url=%s&quot;, artifact_metadata_url)
    return artifact_metadata_url


def _get_artifact_metadata_xml(
    artifactory_url,
    repository,
    group_id,
    artifact_id,
    headers,
    use_literal_group_id=</B></FONT>False,
):
<A NAME="4"></A>
    artifact_metadata_url = _get_artifact_metadata_url(
        artifactory_url=artifactory_url,
        repository<FONT color="#6cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#4',2,'match109-top.html#4',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        use_literal_group_id=use_literal_group_id,
    )

    try:
        request = urllib.request.Request(artifact_metadata_url, None, headers)
        artifact_metadata_xml = urllib.request.urlopen(request).read()
    except (HTTPError, URLError) as err:
        message = &quot;Could not fetch data from url: {}. ERROR: {}&quot;.format(
            artifact_metadata_url, err
        )
        raise CommandExecutionError(message)

    log.debug(&quot;artifact_metadata_xml=%s&quot;, artifact_metadata_xml)
    return artifact_metadata_xml


def _get_artifact_metadata(
    artifactory_url,
    repository,
    group_id,
    artifact_id,
    headers,
    use_literal_group_id=</B></FONT>False,
<A NAME="9"></A>):
    metadata_xml = _get_artifact_metadata_xml(
        artifactory_url=artifactory_url,
        repository<FONT color="#83a33a"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#9',2,'match109-top.html#9',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        headers=headers,
        use_literal_group_id=use_literal_group_id,
    )
    root = ET.fromstring(metadata_xml)

    assert group_id == root.find(&quot;groupId&quot;).text
    assert artifact_id == root.find(&quot;artifactId&quot;).text
    latest_version = root.find(&quot;versioning&quot;).find(</B></FONT>&quot;latest&quot;).text
    return {&quot;latest_version&quot;: latest_version}


# functions for handling snapshots
def _get_snapshot_version_metadata_url(
    artifactory_url,
    repository,
    group_id,
    artifact_id,
<A NAME="15"></A>    version,
    use_literal_group_id=False,
):
    group_url <FONT color="#f52887"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#15',2,'match109-top.html#15',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= __get_group_id_subpath(group_id, use_literal_group_id)
    # for released versions the suffix for the file is same as version
    snapshot_version_metadata_url = &quot;{artifactory_url}/{repository}/{group_url}/{artifact_id}/{version}/maven-metadata.xml&quot;.format(
        artifactory_url=artifactory_url,
        repository=repository,
        group_url=group_url,
        artifact_id=artifact_id,
        version=version,
    )
    log.debug(&quot;snapshot_version_metadata_url=%s&quot;, snapshot_version_metadata_url)
    return snapshot_version_metadata_url


def _get_snapshot_version_metadata_xml(
    artifactory_url,
    repository,
    group_id,
    artifact_id,
    version,
    headers,
    use_literal_group_id=</B></FONT>False,
):
<A NAME="2"></A>
    snapshot_version_metadata_url = _get_snapshot_version_metadata_url(
        artifactory_url=artifactory_url,
        repository<FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#2',2,'match109-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        version=version,
        use_literal_group_id=use_literal_group_id,
    )

    try:
        request = urllib.request.Request(snapshot_version_metadata_url, None, headers)
        snapshot_version_metadata_xml = urllib.request.urlopen(request).read()
    except (HTTPError, URLError) as err:
        message = &quot;Could not fetch data from url: {}. ERROR: {}&quot;.format(
            snapshot_version_metadata_url, err
        )
        raise CommandExecutionError(message)

    log.debug(&quot;snapshot_version_metadata_xml=%s&quot;, snapshot_version_metadata_xml)
    return snapshot_version_metadata_xml


def _get_snapshot_version_metadata(
    artifactory_url, repository, group_id, artifact_id, version, headers
):
    metadata_xml = _get_snapshot_version_metadata_xml(
        artifactory_url=artifactory_url,
        repository=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        version=version,
        headers=headers,
    )
    metadata = ET.fromstring(metadata_xml)

    assert group_id == metadata.find(&quot;groupId&quot;).text
    assert artifact_id == metadata.find(&quot;artifactId&quot;).text
    assert version == metadata.find(&quot;version&quot;).text

    snapshot_versions = metadata.find(&quot;versioning&quot;).find(&quot;snapshotVersions&quot;)
    extension_version_dict = {}
    for snapshot_version in snapshot_versions:
        extension = snapshot_version.find(&quot;extension&quot;).text
        value = snapshot_version.find(&quot;value&quot;).</B></FONT>text
        if snapshot_version.find(&quot;classifier&quot;) is not None:
            classifier = snapshot_version.find(&quot;classifier&quot;).text
            extension_version_dict[extension + &quot;:&quot; + classifier] = value
        else:
            extension_version_dict[extension] = value

    return {&quot;snapshot_versions&quot;: extension_version_dict}


def __get_latest_version_url(
    artifactory_url, repository, group_id, artifact_id, use_literal_group_id=False
):
    group_url = __get_group_id_subpath(group_id, use_literal_group_id)
    # for released versions the suffix for the file is same as version
    latest_version_url = &quot;{artifactory_url}/api/search/latestVersion?g={group_url}&amp;a={artifact_id}&amp;repos={repository}&quot;.format(
        artifactory_url=artifactory_url,
        repository=repository,
        group_url=group_url,
        artifact_id=artifact_id,
    )
    log.debug(&quot;latest_version_url=%s&quot;, latest_version_url)
    return latest_version_url


def __find_latest_version(
    artifactory_url,
    repository,
    group_id,
    artifact_id,
    headers,
    use_literal_group_id=False,
):

    latest_version_url = __get_latest_version_url(
        artifactory_url=artifactory_url,
        repository=repository,
        group_id=group_id,
        artifact_id=artifact_id,
        use_literal_group_id=use_literal_group_id,
    )

    try:
        request = urllib.request.Request(latest_version_url, None, headers)
        version = urllib.request.urlopen(request).read()
    except (HTTPError, URLError) as err:
        message = &quot;Could not fetch data from url: {}. ERROR: {}&quot;.format(
            latest_version_url, err
        )
        raise CommandExecutionError(message)

    log.debug(&quot;Response of: %s&quot;, version)

<A NAME="14"></A>    if version is None or version == &quot;&quot;:
        raise ArtifactoryError(&quot;Unable to find release version&quot;)

    r<FONT color="#842dce"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#14',2,'match109-top.html#14',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>eturn version


def __save_artifact(artifact_url, target_file, headers):
    log.debug(&quot;__save_artifact(%s, %s)&quot;, artifact_url, target_file)
    result = {&quot;status&quot;: False, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}

    if os.path.isfile(target_file):
        log.debug(&quot;File %s already exists, checking checksum...&quot;, target_file)
        checksum_url = artifact_url + &quot;.sha1&quot;

        checksum_success, artifact_sum, checksum_comment = __download(
            checksum_url, headers
<A NAME="0"></A>        )
        if</B></FONT> checksum_success:
            artifact_sum = salt.utils.stringutils.to_unicode(artifact_sum)
            log<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#0',2,'match109-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.debug(&quot;Downloaded SHA1 SUM: %s&quot;, artifact_sum)
            file_sum = __salt__[&quot;file.get_hash&quot;](path=target_file, form=&quot;sha1&quot;)
            log.debug(&quot;Target file (%s) SHA1 SUM: %s&quot;, target_file, file_sum)

            if artifact_sum == file_sum:
                result[&quot;status&quot;] = True
                result[&quot;target_file&quot;] = target_file
                result[&quot;comment&quot;] = (
                    &quot;File {} already exists, checksum matches with Artifactory.\n&quot;
                    &quot;Checksum URL: {}&quot;.format(target_file, checksum_url)
                )
                return result
            else:
                result[&quot;comment&quot;] = (
                    &quot;File {} already exists, checksum does not match with&quot;
                    &quot; Artifactory!\nChecksum URL: {}&quot;.format(target_file, checksum_url)
                )

        else:
            result[&quot;status&quot;] = False
            result[&quot;comment&quot;] = checksum_comment
            return result

    log.debug(&quot;Downloading: %s -&gt; %s&quot;, artifact_url, target_file)

    try:
        request = urllib.request.Request(artifact_url, None, headers)
        f = urllib.request.urlopen(request)
        with salt.utils.files.fopen(target_file, &quot;wb&quot;) as local_file:
            local_file.write(salt.utils.stringutils.to_bytes(f.read()))
        result[&quot;status&quot;] = True
        result[&quot;comment&quot;] = __append_comment(
            &quot;Artifact downloaded from URL: {}&quot;.format(artifact_url),
            result[&quot;comment&quot;],
        )
        result[&quot;changes&quot;][&quot;downloaded_file&quot;] = target_file
        result[&quot;target_file&quot;] = target_file
    except (HTTPError, URLError) as e:
        result[&quot;status&quot;] = False
        result[&quot;comment&quot;] = __get_error_comment(e, artifact_url)

    return result


def __get_group_id_subpath(group_id, use_literal_group_id=</B></FONT>False):
<A NAME="1"></A>    if not use_literal_group_id:
        group_url = group_id.replace(&quot;.&quot;, &quot;/&quot;)
        return group_url
    <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match109-0.html#1',2,'match109-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>return group_id


def __get_classifier_url(classifier):
    has_classifier = classifier is not None and classifier != &quot;&quot;
    return &quot;-&quot; + classifier if has_classifier else &quot;&quot;


def __download(request_url, headers):
    log.debug(&quot;Downloading content from %s&quot;, request_url)

    success = False
    content = None
    comment = None
    try:
        request = urllib.request.Request(request_url, None, headers)
        url = urllib.request.urlopen(request)
        content = url.read()
        success = True
    except HTTPError as e:
        comment = __get_error_comment(e, request_url)

    return success, content, comment


def __get_error_comment(http_error, request_url):
    if http_error.code == http.client.NOT_FOUND:
        comment = &quot;HTTP Error 404. Request URL: &quot; + request_url
    elif http_error.code == http.client.CONFLICT:
        comment = (
            &quot;HTTP Error 409: Conflict. Requested URL: {}. \nThis error may be caused by&quot;
            &quot; reading snapshot artifact from non-snapshot repository.&quot;.format(
                request_url
            )
        )
    else:
        comment = &quot;HTTP Error {err_code}. Request URL: {url}&quot;.format(
            err_code=http_error.code, url=request_url
        )

    return comment


def __append_comment(new_comment, current_comment=&quot;&quot;):
    return current_comment + &quot;\n&quot; + new_comment


class ArtifactoryError(Exception):
    def __init__(self, value):
        super().__init__()
        self.value = value

    def __str__(self):
        return repr(self.v</B></FONT>alue)
</PRE>
</div>
  </div>
</body>
</html>
