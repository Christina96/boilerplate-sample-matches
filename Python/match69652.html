<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_service_3.py &amp; test_mount.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_service_3.py &amp; test_mount.py
      </h3>
<h1 align="center">
        4.5%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_service_3.py (6.56682%)<th>test_mount.py (3.4905083%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(421-432)<td><a href="#" name="0">(785-788)</a><td align="center"><font color="#ff0000">15</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(398-409)<td><a href="#" name="1">(766-769)</a><td align="center"><font color="#ff0000">15</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(548-557)<td><a href="#" name="2">(105-109)</a><td align="center"><font color="#ee0000">14</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(186-191)<td><a href="#" name="3">(693-695)</a><td align="center"><font color="#dd0000">13</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_service_3.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import pytest
3 import salt.modules.beacons as beaconmod
4 import salt.states.beacon as beaconstate
5 import salt.states.service as service
6 import salt.utils.platform
7 from salt.utils.event import SaltEvent
8 from tests.support.mock import MagicMock, patch
9 log = logging.getLogger(__name__)
10 def func(name):
11     return name
12 @pytest.fixture
13 def configure_loader_modules():
14     return {
15         service: {
16             "__env__": "base",
17             "__salt__": {},
18             "__opts__": {"test": False, "cachedir": ""},
19             "__instance_id__": "",
20             "__low__": {},
21             "__utils__": {},
22             "__context__": {},
23         },
24         beaconstate: {"__salt__": {}, "__opts__": {}},
25         beaconmod: {"__salt__": {}, "__opts__": {}},
26     }
27 def test_get_systemd_only():
28     def test_func(cats, dogs, no_block):
29         pass
30     with patch.object(service._get_systemd_only, "HAS_SYSTEMD", True, create=True):
31         ret, warnings = service._get_systemd_only(
32             test_func, {"cats": 1, "no_block": 2, "unmask": 3}
33         )
34         assert len(warnings) == 0
35         assert ret == {"no_block": 2}
36         ret, warnings = service._get_systemd_only(test_func, {"cats": 1, "unmask": 3})
37         assert len(warnings) == 0
38         assert ret == {}
39 def test_get_systemd_only_platform():
40     def test_func(cats, dogs, no_block):
41         pass
42     with patch.object(service._get_systemd_only, "HAS_SYSTEMD", False, create=True):
43         ret, warnings = service._get_systemd_only(
44             test_func, {"cats": 1, "no_block": 2, "unmask": 3}
45         )
46         assert warnings == ["The 'no_block' argument is not supported by this platform"]
47         assert ret == {}
48         ret, warnings = service._get_systemd_only(test_func, {"cats": 1, "unmask": 3})
49         assert len(warnings) == 0
50         assert ret == {}
51 def test_get_systemd_only_no_mock():
52     def test_func(cats, dogs, no_block):
53         pass
54     ret, warnings = service._get_systemd_only(
55         test_func, {"cats": 1, "no_block": 2, "unmask": 3}
56     )
57     assert isinstance(ret, dict)
58     assert isinstance(warnings, list)
59 def test_running():
60     ret = [
61         {"comment": "", "changes": {}, "name": "salt", "result": True},
62         {
63             "changes": {},
64             "comment": "The service salt is already running",
65             "name": "salt",
66             "result": True,
67         },
68         {
69             "changes": "saltstack",
70             "comment": "The service salt is already running",
71             "name": "salt",
72             "result": True,
73         },
74         {
75             "changes": {},
76             "comment": "Service salt is set to start",
77             "name": "salt",
78             "result": None,
79         },
80         {
81             "changes": "saltstack",
82             "comment": "Started service salt",
83             "name": "salt",
84             "result": True,
85         },
86         {
87             "changes": {},
88             "comment": "The service salt is already running",
89             "name": "salt",
90             "result": True,
91         },
92         {
93             "changes": "saltstack",
94             "comment": "Service salt failed to start",
95             "name": "salt",
96             "result": False,
97         },
98         {
99             "changes": "saltstack",
100             "comment": (
101                 "Started service salt\nService masking not available on this minion"
102             ),
103             "name": "salt",
104             "result": True,
105         },
106         {
107             "changes": "saltstack",
108             "comment": (
109                 "Started service salt\nService masking not available on this minion"
110             ),
111             "name": "salt",
112             "result": True,
113         },
114         {
115             "changes": {},
116             "comment": (
117                 "The service salt is disabled but enable is not True. Set enable to"
118                 " True to successfully start the service."
119             ),
120             "name": "salt",
121             "result": False,
122         },
123         {
124             "changes": {},
125             "comment": "The service salt is set to restart",
126             "name": "salt",
127             "result": None,
128         },
129     ]
130     tmock = MagicMock(return_value=True)
131     fmock = MagicMock(return_value=False)
132     vmock = MagicMock(return_value="salt")
133     with patch.object(service, "_enabled_used_error", vmock):
134         assert service.running("salt", enabled=1) == "salt"
135     with patch.object(service, "_available", fmock):
136     with patch.object(service, "_available", tmock):
137         <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>with patch.dict(service.__opts__, {"test": False}):
138             with patch.dict(
139                 service.__salt__,
140                 {"service.enabled": tmock, "service.status": tmock},
141             ):
142                 assert service.running(</b></font>"salt") == ret[1]
143             mock = MagicMock(return_value={"changes": "saltstack"})
144             with patch.dict(
145                 service.__salt__,
146                 {
147                     "service.enabled": MagicMock(side_effect=[False, True]),
148                     "service.status": tmock,
149                 },
150             ):
151                 with patch.object(service, "_enable", mock):
152                     assert service.running("salt", True) == ret[2]
153             with patch.dict(
154                 service.__salt__,
155                 {
156                     "service.enabled": MagicMock(side_effect=[True, False]),
157                     "service.status": tmock,
158                 },
159             ):
160                 with patch.object(service, "_disable", mock):
161                     assert service.running("salt", False) == ret[2]
162             with patch.dict(
163                 service.__salt__,
164                 {
165                     "service.status": MagicMock(side_effect=[False, True]),
166                     "service.enabled": MagicMock(side_effect=[False, True]),
167                     "service.start": MagicMock(return_value="stack"),
168                 },
169             ):
170                 with patch.object(
171                     service,
172                     "_enable",
173                     MagicMock(return_value={"changes": "saltstack"}),
174                 ):
175                     assert service.running("salt", True) == ret[4]
176             with patch.dict(
177                 service.__salt__,
178                 {
179                     "service.status": MagicMock(side_effect=[False, True]),
180                     "service.enabled": MagicMock(side_effect=[False, True]),
181                     "service.unmask": MagicMock(side_effect=[False, True]),
182                     "service.start": MagicMock(return_value="stack"),
183                 },
184             ):
185                 with patch.object(
186                     service,
187                     "_enable",
188                     MagicMock(return_value={"changes": "saltstack"}),
189                 ):
190                     assert service.running("salt", True, unmask=True) == ret[7]
191         with patch.dict(service.__opts__, {"test": True}):
192             with patch.dict(service.__salt__, {"service.status": tmock}):
193                 assert service.running("salt") == ret[5]
194             with patch.dict(service.__salt__, {"service.status": fmock}):
195                 assert service.running("salt") == ret[3]
196         with patch.dict(service.__opts__, {"test": False}):
197             with patch.dict(
198                 service.__salt__,
199                 {
200                     "service.status": MagicMock(side_effect=[False, False]),
201                     "service.enabled": MagicMock(side_effect=[True, True]),
202                     "service.start": MagicMock(return_value="stack"),
203                 },
204             ):
205                 with patch.object(
206                     service,
207                     "_enable",
208                     MagicMock(return_value={"changes": "saltstack"}),
209                 ):
210                     assert service.running("salt", True) == ret[6]
211             with patch.object(salt.utils.platform, "is_windows", tmock):
212                 with patch.dict(
213                     service.__salt__,
214                     {
215                         "service.status": fmock,
216                         "service.enabled": fmock,
217                         "service.start": tmock,
218                     },
219                 ):
220                     assert service.running("salt", None) == ret[9]
221                     assert service.__context__ == {"service.state": "running"}
222             with patch.object(salt.utils.platform, "is_darwin", tmock):
223                 with patch.dict(
224                     service.__salt__,
225                     {
226                         "service.status": fmock,
227                         "service.enabled": fmock,
228                         "service.start": tmock,
229                     },
230                 ):
231                     assert service.running("salt", None) == ret[9]
232                     assert service.__context__ == {"service.state": "running"}
233                 with patch.dict(
234                     service.__salt__,
235                     {
236                         "service.status": MagicMock(side_effect=[False, "loaded"]),
237                         "service.enabled": MagicMock(side_effect=[False, True]),
238                         "service.start": tmock,
239                     },
240                 ):
241                     with patch.object(
242                         service,
243                         "_enable",
244                         MagicMock(return_value={"changes": "saltstack"}),
245                     ):
246                         assert service.running("salt", True) == ret[4]
247                         assert service.__context__ == {"service.state": "running"}
248                 with patch.dict(
249                     service.__salt__,
250                     {
251                         "service.status": fmock,
252                         "service.enabled": fmock,
253                         "service.start": fmock,
254                     },
255                 ):
256                     with patch.object(
257                         service,
258                         "_enable",
259                         MagicMock(
260                             return_value={"changes": "saltstack", "result": False}
261                         ),
262                     ):
263                         assert service.running("salt", True) == ret[6]
264                         assert service.__context__ == {"service.state": "running"}
265 def test_running_in_offline_mode():
266     name = "thisisnotarealservice"
267     with patch.object(service, "_offline", MagicMock(return_value=True)):
268         ret = service.running(name=name)
269         assert ret == {
270             "changes": {},
271             "comment": "Running in OFFLINE mode. Nothing to do",
272             "result": True,
273             "name": name,
274         }
275 def test_dead():
276     ret = [
277         {"changes": {}, "comment": "", "name": "salt", "result": True},
278         {
279             "changes": "saltstack",
280             "comment": "The service salt is already dead",
281             "name": "salt",
282             "result": True,
283         },
284         {
285             "changes": {},
286             "comment": "Service salt is set to be killed",
287             "name": "salt",
288             "result": None,
289         },
290         {
291             "changes": "saltstack",
292             "comment": "Service salt was killed",
293             "name": "salt",
294             "result": True,
295         },
296         {
297             "changes": {},
298             "comment": "Service salt failed to die",
299             "name": "salt",
300             "result": False,
301         },
302         {
303             "changes": "saltstack",
304             "comment": "The service salt is already dead",
305             "name": "salt",
306             "result": True,
307         },
308     ]
309     info_mock = MagicMock(return_value={"StartType": ""})
310     mock = MagicMock(return_value="salt")
311     with patch.object(service, "_enabled_used_error", mock):
312         assert service.dead("salt", enabled=1) == "salt"
313     tmock = MagicMock(return_value=True)
314     fmock = MagicMock(return_value=False)
315     with patch.object(service, "_available", fmock):
316         assert service.dead("salt") == ret[0]
317     with patch.object(service, "_available", tmock):
318         mock = MagicMock(return_value={"changes": "saltstack"})
319         with patch.dict(service.__opts__, {<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"test": True}):
320             with patch.dict(
321                 service.__salt__,
322                 {
323                     "service.enabled": fmock,
324                     "service.stop": tmock,
325                     "service.status": fmock,
326                     "service.info": info_mock,
327                 },
328             ):
329                 with patch.object(service, "_enable", mock):
330                     assert service.dead("salt", True) == ret[5</b></font>]
331             with patch.dict(
332                 service.__salt__,
333                 {
334                     "service.enabled": tmock,
335                     "service.status": tmock,
336                     "service.info": info_mock,
337                 },
338                 assert service.dead("salt") == ret[2]
339         with patch.dict(service.__opts__, {<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"test": False}):
340             with patch.dict(
341                 service.__salt__,
342                 {
343                     "service.enabled": fmock,
344                     "service.stop": tmock,
345                     "service.status": fmock,
346                     "service.info": info_mock,
347                 },
348             ):
349                 with patch.object(service, "_enable", mock):
350                     assert service.dead("salt", True) == ret[1</b></font>]
351             with patch.dict(
352                 service.__salt__,
353                 {
354                     "service.enabled": MagicMock(side_effect=[True, True, False]),
355                     "service.status": MagicMock(side_effect=[True, False, False]),
356                     "service.stop": MagicMock(return_value="stack"),
357                     "service.info": info_mock,
358                 },
359             ):
360                 with patch.object(
361                     service,
362                     "_enable",
363                     MagicMock(return_value={"changes": "saltstack"}),
364                 ):
365                     assert service.dead("salt", True) == ret[3]
366             with patch.dict(
367                 service.__salt__,
368                 {
369                     "service.enabled": MagicMock(side_effect=[False, False, False]),
370                     "service.status": MagicMock(side_effect=[True, True, True]),
371                     "service.stop": MagicMock(return_value="stack"),
372                     "service.info": info_mock,
373                 },
374             ):
375                 with patch.object(service, "_disable", MagicMock(return_value={})):
376                     assert service.dead("salt", False) == ret[4]
377         assert service.__context__ == {"service.state": "dead"}
378 def test_dead_with_missing_service():
379     name = "thisisnotarealservice"
380     with patch.dict(
381         service.__salt__, {"service.available": MagicMock(return_value=False)}
382     ):
383         ret = service.dead(name=name)
384         assert ret == {
385             "changes": {},
386             "comment": "The named service {} is not available".format(name),
387             "result": True,
388             "name": name,
389         }
390 def test_dead_in_offline_mode():
391     name = "thisisnotarealservice"
392     with patch.object(service, "_offline", MagicMock(return_value=True)):
393         ret = service.dead(name=name)
394         assert ret == {
395             "changes": {},
396             "comment": "Running in OFFLINE mode. Nothing to do",
397             "result": True,
398             "name": name,
399         }
400 def test_enabled():
401     ret = {"changes": "saltstack", "comment": "", "name": "salt", "result": True}
402     mock = MagicMock(return_value={"changes": "saltstack"})
403     with patch.object(service, "_enable", mock):
404         assert service.enabled("salt") == ret
405         assert service.__context__ == {"service.state": "enabled"}
406 def test_disabled():
407     ret = {"changes": "saltstack", "comment": "", "name": "salt", "result": True}
408     mock = MagicMock(return_value={"changes": "saltstack"})
409     with patch.object(service, "_disable", mock):
410         assert service.disabled("salt") == ret
411         assert service.__context__ == {"service.state": "disabled"}
412 def test_mod_watch():
413     ret = [
414         {
415             "changes": {},
416             "comment": "Service is already stopped",
417             "name": "salt",
418             "result": True,
419         },
420         {
421             "changes": {},
422             "comment": "Unable to trigger watch for service.stack",
423             "name": "salt",
424             "result": False,
425         },
426         {
427             "changes": {},
428             "comment": "Service is set to be started",
429             "name": "salt",
430         },
431         {
432             <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"changes": {"salt": "salt"},
433             "comment": "Service started",
434             "name": "salt",
435             "result": "salt",
436         },
437     ]
438     mock = MagicMock(return_value=False)
439     with patch.dict(service.__salt__, {"service.status": mock}):
440         assert service.mod_watch("salt", "dead") == ret[</b></font>0]
441         with patch.dict(service.__salt__, {"service.start": func}):
442             with patch.dict(service.__opts__, {"test": True}):
443                 assert service.mod_watch("salt", "running") == ret[2]
444             with patch.dict(service.__opts__, {"test": False}):
445                 assert service.mod_watch("salt", "running") == ret[3]
446         assert service.mod_watch("salt", "stack") == ret[1]
447 def test_mod_beacon(tmp_path):
448     name = "sshd"
449     with patch.dict(service.__salt__, {"beacons.list": MagicMock(return_value={})}):
450         with patch.dict(service.__states__, {"beacon.present": beaconstate.present}):
451             ret = service.mod_beacon(name, sfun="copy")
452             expected = {
453                 "name": name,
454                 "changes": {},
455                 "result": False,
456                 "comment": "service.copy does not work with the beacon state function",
457             }
458             assert ret == expected
459     event_returns = [
460         {
461             "complete": True,
462             "tag": "/salt/minion/minion_beacons_list_complete",
463             "beacons": {},
464         },
465         {
466             "complete": True,
467             "tag": "/salt/minion/minion_beacons_list_complete",
468             "beacons": {},
469         },
470         {
471             "complete": True,
472             "tag": "/salt/minion/minion_beacons_list_available_complete",
473             "beacons": ["service"],
474         },
475         {
476             "valid": True,
477             "tag": "/salt/minion/minion_beacon_validation_complete",
478             "vcomment": "Valid beacon configuration",
479         },
480         {
481             "complete": True,
482             "tag": "/salt/minion/minion_beacon_add_complete",
483             "beacons": {
484                 "beacon_service_sshd": [
485                     {
486                         "services": {
487                             "sshd": {
488                                 "onchangeonly": True,
489                                 "delay": 0,
490                                 "uncleanshutdown": None,
491                                 "emitatstartup": False,
492                             },
493                         }
494                     },
495                     {"interval": 60},
496                     {"beacon_module": "service"},
497                 ]
498             },
499         },
500     ]
501     mock = MagicMock(return_value=True)
502     beacon_state_mocks = {
503         "beacons.list": beaconmod.list_,
504         "beacons.add": beaconmod.add,
505         "beacons.list_available": beaconmod.list_available,
506         "event.fire": mock,
507     }
508     beacon_mod_mocks = {"event.fire": mock}
509     sock_dir = str(tmp_path / "test-socks")
510     with patch.dict(service.__states__, {"beacon.present": beaconstate.present}):
511         with patch.dict(beaconstate.__salt__, beacon_state_mocks):
512             with patch.dict(beaconmod.__salt__, beacon_mod_mocks):
513                 with patch.dict(
514                     beaconmod.__opts__, {"beacons": {}, "sock_dir": sock_dir}
515                 ):
516                     with patch.object(
517                         SaltEvent, "get_event", side_effect=event_returns
518                     ):
519                         ret = service.mod_beacon(name, sfun="running", beacon="True")
520                         expected = {
521                             "name": "beacon_service_sshd",
522                             "changes": {},
523                             "result": True,
524                             "comment": "Adding beacon_service_sshd to beacons",
525                         }
526                         assert ret == expected
527 @pytest.mark.skip_on_darwin(reason="service.running is currently failing on OSX")
528 @pytest.mark.destructive_test
529 @pytest.mark.slow_test
530 def test_running_with_reload():
531     opts = salt.config.DEFAULT_MINION_OPTS.copy()
532     opts["grains"] = salt.loader.grains(opts)
533     utils = salt.loader.utils(opts)
534     modules = salt.loader.minion_mods(opts, utils=utils)
535     service_name = "cron"
536     cmd_name = "crontab"
537     os_family = opts["grains"]["os_family"]
538     os_release = opts["grains"]["osrelease"]
539     if os_family == "RedHat":
540         service_name = "crond"
541     elif os_family == "Arch":
542         service_name = "sshd"
543         cmd_name = "systemctl"
544     elif os_family == "MacOS":
545         service_name = "org.ntp.ntpd"
546         if int(os_release.split(".")[1]) &gt;= 13:
547             service_name = "com.openssh.sshd"
548     elif os_family == "Windows":
549         service_name = "Spooler"
550     if os_family != "Windows" and salt.utils.path.which(cmd_name) is None:
551         pytest.skip("{} is not installed".format(cmd_name))
552     pre_srv_enabled = (
553         True if service_name in modules["service.get_enabled"]() else False
554     )
555     post_srv_disable = False
556     if not pre_srv_enabled:
557         modules["service.enable"](service_name)
558         post_srv_disable = True
559     try:
560         with patch.dict(service.__grains__, opts["grains"]), patch.dict(
561             service.__opts__, opts
562         ), patch.dict(service.__salt__, modules), patch.dict(
563             service.__utils__, utils
564         ), patch.dict(
565             service.__opts__, {"test": False}
566         ), patch(
567             "salt.utils.systemd.offline", MagicMock(return_value=False)
568         ):
569             service.dead(service_name, enable=False)
570             result = service.running(name=service_name, enable=True, reload=False)
571         if salt.utils.platform.is_windows():
572             comment = "Started service {}".format(service_name)
573         else:
574             comment = "Service {} has been enabled, and is running".format(service_name)
575         expected = {
576             "changes": {service_name: True},
577             "comment": comment,
578             "name": service_name,
579             "result": True,
580         }
581         assert result == expected
582     finally:
583         if post_srv_disable:
584             modules["service.disable"](service_name)
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_mount.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import os
3 import shutil
4 import sys
5 import textwrap
6 import pytest
7 import salt.modules.mount as mount
8 import salt.utils.files
9 import salt.utils.path
10 from salt.exceptions import CommandExecutionError
11 from tests.support.mock import MagicMock, mock_open, patch
12 log = logging.getLogger(__name__)
13 @pytest.fixture
14 def mock_shell_file():
15     return "A B C D F G\n"
16 @pytest.fixture
17 def config_initial_file():
18     inital_fsystem = [
19         "/:\n",
20         "\tdev\t\t= /dev/hd4\n",
21         "\tvfs\t\t= jfs2\n",
22         "\tlog\t\t= /dev/hd8\n",
23         "\tmount \t\t= automatic\n",
24         "\tcheck\t\t= false\n",
25         "\ttype\t\t= bootfs\n",
26         "\tvol\t\t= root\n",
27         "\tfree\t\t= true\n",
28         "\n",
29         "/home:\n",
30         "\tdev\t\t= /dev/hd1\n",
31         "\tvfs\t\t= jfs2\n",
32         "\tlog\t\t= /dev/hd8\n",
33         "\tmount\t\t= true\n",
34         "\tcheck\t\t= true\n",
35         "\tvol\t\t= /home\n",
36         "\tfree\t\t= false\n",
37         "\n",
38     ]
39     return inital_fsystem
40 @pytest.fixture
41 def configure_loader_modules():
42     return {mount: {}}
43 @pytest.fixture
44 def tmp_sub_dir(tmp_path):
45     directory = tmp_path / "filesystems-dir"
46     directory.mkdir()
47     yield directory
48     shutil.rmtree(str(directory))
49 @pytest.fixture
50 def config_file(tmp_sub_dir, config_initial_file):
51     filename = str(tmp_sub_dir / "filesystems")
52     with salt.utils.files.fopen(filename, "wb") as fp:
53         fp.writelines(salt.utils.data.encode(config_initial_file))
54     yield filename
55     os.remove(filename)
56 def test_active():
57     with patch.dict(mount.__grains__, {"os": "FreeBSD", "kernel": "FreeBSD"}):
58         mock = MagicMock(return_value="A B C D,E,F,uid=user1,gid=grp1")
59         mock_user = MagicMock(return_value={"uid": "100"})
60         mock_group = MagicMock(return_value={"gid": "100"})
61         with patch.dict(
62             mount.__salt__,
63             {
64                 "cmd.run_stdout": mock,
65                 "user.info": mock_user,
66                 "group.info": mock_group,
67             },
68         ):
69             assert mount.active() == {
70                 "B": {
71                     "device": "A",
72                     "opts": ["D", "E", "F", "uid=100", "gid=100"],
73                     "fstype": "C",
74             }
75     with patch.dict(mount<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.__grains__, {"os": "Solaris", "kernel": "SunOS"}):
76         mock = MagicMock(return_value="A * B * C D/E/F")
77         with patch.dict(mount.__salt__, {"cmd.run_stdout": mock}):
78             assert mount.active() == {
79                 "B"</b></font>: {"device": "A", "opts": ["D", "E", "F"], "fstype": "C"}
80             }
81     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}):
82         mock = MagicMock(return_value="A * B * C D/E/F")
83         with patch.dict(mount.__salt__, {"cmd.run_stdout": mock}):
84             assert mount.active() == {"B": {"node": "A", "device": "*", "fstype": "*"}}
85     with patch.dict(mount.__grains__, {"os": "OpenBSD", "kernel": "OpenBSD"}):
86         mock = MagicMock(return_value={})
87         with patch.object(mount, "_active_mounts_openbsd", mock):
88             assert mount.active() == {}
89     with patch.dict(mount.__grains__, {"os": "MacOS", "kernel": "Darwin"}):
90         mock = MagicMock(return_value={})
91         with patch.object(mount, "_active_mounts_darwin", mock):
92             assert mount.active() == {}
93     with patch.dict(mount.__grains__, {"os": "MacOS", "kernel": "Darwin"}):
94         mock = MagicMock(return_value={})
95         with patch.object(mount, "_active_mountinfo", mock):
96             with patch.object(mount, "_active_mounts_darwin", mock):
97                 assert mount.active(extended=True) == {}
98     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}):
99         mock = MagicMock(return_value={})
100         with patch.object(mount, "_active_mounts_aix", mock):
101             assert mount.active() == {}
102 def test_fstab():
103     mock = MagicMock(return_value=False)
104     with patch.object(os.path, "isfile", mock):
105         assert mount.fstab() == {}
106     file_data = "\n".join(["#", "A B C D,E,F G H"])
107     mock = MagicMock(return_value=True)
108     with patch.dict(mount.__grains__, {"kernel": ""}), patch.object(
109         os.path, "isfile", mock
110     ), patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
111         fstab = mount.fstab()
112         assert fstab == {
113             "B": {
114                 "device": "A",
115                 "dump": "G",
116                 "fstype": "C",
117                 "opts": ["D", "E", "F"],
118                 "pass": "H",
119             }
120         }, fstab
121 def test_vfstab():
122     mock = MagicMock(return_value=False)
123     with patch.object(os.path, "isfile", mock):
124         assert mount.vfstab() == {}
125     file_data = textwrap.dedent(
126     )
127     mock = MagicMock(return_value=True)
128     with patch.dict(mount.__grains__, {"kernel": "SunOS"}), patch.object(
129         os.path, "isfile", mock
130     ), patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
131         vfstab = mount.vfstab()
132         assert vfstab == {
133             "/tmp": {
134                 "device": "swap",
135                 "device_fsck": "-",
136                 "fstype": "tmpfs",
137                 "mount_at_boot": "yes",
138                 "opts": ["size=2048m"],
139                 "pass_fsck": "-",
140             }
141         }, vfstab
142 def test_filesystems():
143     file_data = textwrap.dedent(
144     )
145     mock = MagicMock(return_value=True)
146     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}), patch.object(
147         os.path, "isfile", mock
148     ), patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
149         assert mount.filesystems() == {}
150     file_data = textwrap.dedent(
151     )
152     mock = MagicMock(return_value=True)
153     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}), patch.object(
154         os.path, "isfile", mock
155     ), patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
156         fsyst = mount.filesystems()
157         test_fsyst = {
158             "/home": {
159                 "dev": "/dev/hd1",
160                 "vfs": "jfs2",
161                 "log": "/dev/hd8",
162                 "mount": "true",
163                 "check": "true",
164                 "vol": "/home",
165                 "free": "false",
166                 "quota": "no",
167             }
168         }
169         assert test_fsyst == fsyst
170 def test_rm_fstab():
171     mock_fstab = MagicMock(return_value={})
172     with patch.dict(mount.__grains__, {"kernel": ""}):
173         with patch.object(mount, "fstab", mock_fstab):
174             with patch("salt.utils.files.fopen", mock_open()):
175                 assert mount.rm_fstab("name", "device")
176 def test_set_fstab(mock_shell_file):
177     mock = MagicMock(return_value=False)
178     with patch.object(os.path, "isfile", mock):
179         pytest.raises(CommandExecutionError, mount.set_fstab, "A", "B", "C")
180     mock = MagicMock(return_value=True)
181     mock_read = MagicMock(side_effect=OSError)
182     with patch.object(os.path, "isfile", mock):
183         with patch.object(salt.utils.files, "fopen", mock_read):
184             pytest.raises(CommandExecutionError, mount.set_fstab, "A", "B", "C")
185     mock = MagicMock(return_value=True)
186     with patch.object(os.path, "isfile", mock):
187         with patch("salt.utils.files.fopen", mock_open(read_data=mock_shell_file)):
188             assert mount.set_fstab("A", "B", "C") == "new"
189     mock = MagicMock(return_value=True)
190     with patch.object(os.path, "isfile", mock):
191         with patch("salt.utils.files.fopen", mock_open(read_data=mock_shell_file)):
192             assert mount.set_fstab("B", "A", "C", "D", "F", "G") == "present"
193     mock = MagicMock(return_value=True)
194     with patch.object(os.path, "isfile", mock):
195         with patch("salt.utils.files.fopen", mock_open(read_data=mock_shell_file)):
196             assert mount.set_fstab("B", "A", "C", not_change=True) == "present"
197 def test_rm_automaster():
198     mock = MagicMock(return_value={})
199     with patch.object(mount, "automaster", mock):
200         assert mount.rm_automaster("name", "device")
201     mock = MagicMock(return_value={"name": "name"})
202     with patch.object(mount, "fstab", mock):
203         assert mount.rm_automaster("name", "device")
204 def test_set_automaster(mock_shell_file):
205     mock = MagicMock(return_value=True)
206     with patch.object(os.path, "isfile", mock):
207         pytest.raises(CommandExecutionError, mount.set_automaster, "A", "B", "C")
208     mock = MagicMock(return_value=True)
209     mock_read = MagicMock(side_effect=OSError)
210     with patch.object(os.path, "isfile", mock):
211         with patch.object(salt.utils.files, "fopen", mock_read):
212             pytest.raises(CommandExecutionError, mount.set_automaster, "A", "B", "C")
213     mock = MagicMock(return_value=True)
214     with patch.object(os.path, "isfile", mock):
215         with patch("salt.utils.files.fopen", mock_open(read_data=mock_shell_file)):
216             assert mount.set_automaster("A", "B", "C") == "new"
217     mock = MagicMock(return_value=True)
218     with patch.object(os.path, "isfile", mock):
219         with patch(
220             "salt.utils.files.fopen", mock_open(read_data="/..A -fstype=C,D C:B")
221         ):
222             assert mount.set_automaster("A", "B", "C", "D") == "present"
223     mock = MagicMock(return_value=True)
224     with patch.object(os.path, "isfile", mock):
225         with patch(
226             "salt.utils.files.fopen", mock_open(read_data="/..A -fstype=XX C:B")
227         ):
228             assert (
229                 mount.set_automaster("A", "B", "C", "D", not_change=True) == "present"
230             )
231 def test_automaster():
232     assert mount.automaster() == {}
233 def test_rm_filesystems():
234     file_data = textwrap.dedent(
235     )
236     mock = MagicMock(return_value=True)
237     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}), patch.object(
238         os.path, "isfile", mock
239     ), patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
240         assert not mount.rm_filesystems("name", "device")
241     file_data = textwrap.dedent(
242     )
243     mock = MagicMock(return_value=True)
244     mock_fsyst = MagicMock(return_value=True)
245     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}), patch.object(
246         os.path, "isfile", mock
247     ), patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
248         assert mount.rm_filesystems("/name", "device")
249 def test_set_filesystems():
250     mock = MagicMock(return_value=False)
251     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}):
252         with patch.object(os.path, "isfile", mock):
253             pytest.raises(CommandExecutionError, mount.set_filesystems, "A", "B", "C")
254         mock_read = MagicMock(side_effect=OSError)
255         with patch.object(os.path, "isfile", mock):
256             with patch.object(salt.utils.files, "fopen", mock_read):
257                 pytest.raises(
258                     CommandExecutionError, mount.set_filesystems, "A", "B", "C"
259                 )
260 @pytest.mark.skipif(
261     sys.version_info[0] == 3 and sys.version_info[1] &lt;= 5,
262     reason="run on Python 3.6 or greater where OrderedDict is default",
263 )
264 @pytest.mark.skip_on_windows(
265     reason="Not supported on Windows, does not handle tabs well"
266 )
267 def test_set_filesystems_with_data(tmp_sub_dir, config_file):
268     config_filepath = str(tmp_sub_dir / "filesystems")
269     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}):
270         mount.set_filesystems(
271             "/test_mount", "/dev/hd3", "jsf2", "-", "true", config_filepath
272         )
273         with salt.utils.files.fopen(config_filepath, "r") as fp:
274             fsys_content = fp.read()
275         test_fsyst = """/:
276 	dev		= /dev/hd4
277 	vfs		= jfs2
278 	log		= /dev/hd8
279 	mount		= automatic
280 	check		= false
281 	type		= bootfs
282 	vol		= root
283 	free		= true
284 /home:
285 	dev		= /dev/hd1
286 	vfs		= jfs2
287 	log		= /dev/hd8
288 	mount		= true
289 	check		= true
290 	vol		= /home
291 	free		= false
292 /test_mount:
293 	dev		= /dev/hd3
294 	vfstype		= jsf2
295 	opts		= -
296 	mount		= true
297     Mount a device
298     Attempt to remount a device, if the device is not already mounted, mount
299     is called
300     Attempt to remount a device already mounted that do not provides
301     fstype
302     Attempt to remount a device already mounted that do not provides
303     fstype
304     Attempt to unmount a device by specifying the directory it is
305     mounted on
306     Returns true if the command passed is a fuse mountable application
307         Neither of these are full ldd output, but what is_fuse_exec is
308         looking for is 'libfuse' in the ldd output, so these examples
309         should be sufficient enough to test both the True and False cases.
310                 linux-vdso.so.1 (0x00007ffeaf5fb000)
311                 libfuse3.so.3 =&gt; /usr/lib/libfuse3.so.3 (0x00007f91e66ac000)
312                 """
313             ),
314             "ldd cmd2": textwrap.dedent(
315             ),
316         }[cmd]
317     which_mock = MagicMock(side_effect=lambda x: x)
318     ldd_mock = MagicMock(side_effect=_ldd_side_effect)
319     <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>with patch.object(salt.utils.path, "which", which_mock):
320         with patch.dict(mount.__salt__, {"cmd.run": _ldd_side_effect}):
321             assert mount.is_fuse_exec(</b></font>"cmd1")
322             assert not mount.is_fuse_exec("cmd2")
323 def test_swaps():
324     file_data = textwrap.dedent(
325     )
326     with patch.dict(mount.__grains__, {"os": "", "kernel": ""}):
327         with patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
328             swaps = mount.swaps()
329             assert swaps == {
330                 "/dev/sda1": {
331                     "priority": "-1",
332                     "size": "31249404",
333                     "type": "partition",
334                     "used": "4100",
335                 }
336             }, swaps
337     file_data = textwrap.dedent(
338     )
339     mock = MagicMock(return_value=file_data)
340     with patch.dict(
341         mount.__grains__, {"os": "OpenBSD", "kernel": "OpenBSD"}
342     ), patch.dict(mount.__salt__, {"cmd.run_stdout": mock}):
343         swaps = mount.swaps()
344         assert swaps == {
345             "/dev/sda1": {
346                 "priority": "-1",
347                 "size": "31249404",
348                 "type": "partition",
349                 "used": "4100",
350             }
351         }, swaps
352     file_data = textwrap.dedent(
353     )
354     mock = MagicMock(return_value=file_data)
355     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}), patch.dict(
356         mount.__salt__, {"cmd.run_stdout": mock}
357     ):
358         swaps = mount.swaps()
359         assert swaps == {
360             "/dev/hd6": {
361                 "priority": "-",
362                 "size": 12058624,
363                 "type": "device",
364                 "used": 11264,
365             }
366         }, swaps
367 def test_swapon():
368     Activate a swap disk
369     """
370     mock = MagicMock(return_value={<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>"name": "name"})
371     with patch.dict(mount.__grains__, {"kernel": ""}):
372         with patch.object(mount, "swaps", mock):
373             assert mount.swapon("name") == {"s</b></font>tats": "name", "new": False}
374     mock = MagicMock(return_value={})
375     with patch.dict(mount.__grains__, {"kernel": ""}):
376         with patch.object(mount, "swaps", mock):
377             mock = MagicMock(return_value=None)
378             with patch.dict(mount.__salt__, {"cmd.run": mock}):
379                 assert mount.swapon("name", False) == {}
380     mock = MagicMock(side_effect=[{}, {"name": "name"}])
381     with patch.dict(mount.__grains__, {"kernel": ""}):
382         with patch.object(mount, "swaps", mock):
383             mock = MagicMock(return_value=None)
384                 assert mount.swapon("name") == {"stats": "name", "new": True}
385     mock = MagicMock(return_value={<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>"name": "name"})
386     with patch.dict(mount.__grains__, {"kernel": "AIX"}):
387         with patch.object(mount, "swaps", mock):
388             assert mount.swapon("name") == {"s</b></font>tats": "name", "new": False}
389     mock = MagicMock(return_value={})
390     with patch.dict(mount.__grains__, {"kernel": "AIX"}):
391         with patch.object(mount, "swaps", mock):
392             mock = MagicMock(return_value=None)
393             with patch.dict(mount.__salt__, {"cmd.run": mock}):
394                 assert mount.swapon("name", False) == {}
395     mock = MagicMock(side_effect=[{}, {"name": "name"}])
396     with patch.dict(mount.__grains__, {"kernel": "AIX"}):
397         with patch.object(mount, "swaps", mock):
398             mock = MagicMock(return_value=None)
399             with patch.dict(mount.__salt__, {"cmd.run": mock}):
400                 assert mount.swapon("name") == {"stats": "name", "new": True}
401 def test_swapoff():
402     """
403     Deactivate a named swap mount
404     """
405     mock = MagicMock(return_value={})
406     with patch.dict(mount.__grains__, {"kernel": ""}):
407         with patch.object(mount, "swaps", mock):
408             assert mount.swapoff("name") is None
409     mock = MagicMock(return_value={"name": "name"})
410     with patch.dict(mount.__grains__, {"kernel": ""}):
411         with patch.object(mount, "swaps", mock):
412             with patch.dict(mount.__grains__, {"os": "test"}):
413                 mock = MagicMock(return_value=None)
414                 with patch.dict(mount.__salt__, {"cmd.run": mock}):
415                     assert not mount.swapoff("name")
416     mock = MagicMock(side_effect=[{"name": "name"}, {}])
417     with patch.dict(mount.__grains__, {"kernel": ""}):
418         with patch.object(mount, "swaps", mock):
419             with patch.dict(mount.__grains__, {"os": "test"}):
420                 mock = MagicMock(return_value=None)
421                 with patch.dict(mount.__salt__, {"cmd.run": mock}):
422                     assert mount.swapoff("name")
423     mock = MagicMock(return_value={})
424     with patch.dict(mount.__grains__, {"kernel": "AIX"}):
425         with patch.object(mount, "swaps", mock):
426             assert mount.swapoff("name") is None
427     mock = MagicMock(return_value={"name": "name"})
428     with patch.dict(mount.__grains__, {"kernel": "AIX"}):
429         with patch.object(mount, "swaps", mock):
430             with patch.dict(mount.__grains__, {"os": "test"}):
431                 mock = MagicMock(return_value=None)
432                 with patch.dict(mount.__salt__, {"cmd.run": mock}):
433                     assert not mount.swapoff("name")
434     mock = MagicMock(side_effect=[{"name": "name"}, {}])
435     with patch.dict(mount.__grains__, {"kernel": "AIX"}):
436         with patch.object(mount, "swaps", mock):
437             with patch.dict(mount.__grains__, {"os": "test"}):
438                 mock = MagicMock(return_value=None)
439                 with patch.dict(mount.__salt__, {"cmd.run": mock}):
440                     assert mount.swapoff("name")
441 def test_is_mounted():
442     """
443     Provide information if the path is mounted
444     """
445     mock = MagicMock(return_value={})
446     with patch.object(mount, "active", mock), patch.dict(
447         mount.__grains__, {"kernel": ""}
448     ):
449         assert not mount.is_mounted("name")
450     mock = MagicMock(return_value={"name": "name"})
451     with patch.object(mount, "active", mock), patch.dict(
452         mount.__grains__, {"kernel": ""}
453     ):
454         assert mount.is_mounted("name")
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
