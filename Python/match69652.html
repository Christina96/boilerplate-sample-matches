<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_service_3.py &amp; test_mount.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_service_3.py &amp; test_mount.py
      </h3>
<h1 align="center">
        4.5%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_service_3.py (6.56682%)<th>test_mount.py (3.4905083%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(421-432)<td><a href="#" name="0">(785-788)</a><td align="center"><font color="#ff0000">15</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(398-409)<td><a href="#" name="1">(766-769)</a><td align="center"><font color="#ff0000">15</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(548-557)<td><a href="#" name="2">(105-109)</a><td align="center"><font color="#ee0000">14</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(186-191)<td><a href="#" name="3">(693-695)</a><td align="center"><font color="#dd0000">13</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_service_3.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import pytest
3 import salt.modules.beacons as beaconmod
4 import salt.states.beacon as beaconstate
5 import salt.states.service as service
6 import salt.utils.platform
7 from salt.utils.event import SaltEvent
8 from tests.support.mock import MagicMock, patch
9 log = logging.getLogger(__name__)
10 def func(name):
11     return name
12 @pytest.fixture
13 def configure_loader_modules():
14     return {
15         service: {
16             "__env__": "base",
17             "__salt__": {},
18             "__opts__": {"test": False, "cachedir": ""},
19             "__instance_id__": "",
20             "__low__": {},
21             "__utils__": {},
22             "__context__": {},
23         },
24         beaconstate: {"__salt__": {}, "__opts__": {}},
25         beaconmod: {"__salt__": {}, "__opts__": {}},
26     }
27 def test_get_systemd_only():
28     def test_func(cats, dogs, no_block):
29         pass
30     with patch.object(service._get_systemd_only, "HAS_SYSTEMD", True, create=True):
31         ret, warnings = service._get_systemd_only(
32             test_func, {"cats": 1, "no_block": 2, "unmask": 3}
33         )
34         assert len(warnings) == 0
35         assert ret == {"no_block": 2}
36         ret, warnings = service._get_systemd_only(test_func, {"cats": 1, "unmask": 3})
37         assert len(warnings) == 0
38         assert ret == {}
39 def test_get_systemd_only_platform():
40     def test_func(cats, dogs, no_block):
41         pass
42     with patch.object(service._get_systemd_only, "HAS_SYSTEMD", False, create=True):
43         ret, warnings = service._get_systemd_only(
44             test_func, {"cats": 1, "no_block": 2, "unmask": 3}
45         )
46         assert warnings == ["The 'no_block' argument is not supported by this platform"]
47         assert ret == {}
48         ret, warnings = service._get_systemd_only(test_func, {"cats": 1, "unmask": 3})
49         assert len(warnings) == 0
50         assert ret == {}
51 def test_get_systemd_only_no_mock():
52     def test_func(cats, dogs, no_block):
53         pass
54     ret, warnings = service._get_systemd_only(
55         test_func, {"cats": 1, "no_block": 2, "unmask": 3}
56     )
57     assert isinstance(ret, dict)
58     assert isinstance(warnings, list)
59 def test_running():
60     ret = [
61         {"comment": "", "changes": {}, "name": "salt", "result": True},
62         {
63             "changes": {},
64             "comment": "The service salt is already running",
65             "name": "salt",
66             "result": True,
67         },
68         {
69             "changes": "saltstack",
70             "comment": "The service salt is already running",
71             "name": "salt",
72             "result": True,
73         },
74         {
75             "changes": {},
76             "comment": "Service salt is set to start",
77             "name": "salt",
78             "result": None,
79         },
80         {
81             "changes": "saltstack",
82             "comment": "Started service salt",
83             "name": "salt",
84             "result": True,
85         },
86         {
87             "changes": {},
88             "comment": "The service salt is already running",
89             "name": "salt",
90             "result": True,
91         },
92         {
93             "changes": "saltstack",
94             "comment": "Service salt failed to start",
95             "name": "salt",
96             "result": False,
97         },
98         {
99             "changes": "saltstack",
100             "comment": (
101                 "Started service salt\nService masking not available on this minion"
102             ),
103             "name": "salt",
104             "result": True,
105         },
106         {
107             "changes": "saltstack",
108             "comment": (
109                 "Started service salt\nService masking not available on this minion"
110             ),
111             "name": "salt",
112             "result": True,
113         },
114         {
115             "changes": {},
116             "comment": (
117                 "The service salt is disabled but enable is not True. Set enable to"
118                 " True to successfully start the service."
119             ),
120             "name": "salt",
121             "result": False,
122         },
123         {
124             "changes": {},
125             "comment": "The service salt is set to restart",
126             "name": "salt",
127             "result": None,
128         },
129     ]
130     tmock = MagicMock(return_value=True)
131     fmock = MagicMock(return_value=False)
132     vmock = MagicMock(return_value="salt")
133     with patch.object(service, "_enabled_used_error", vmock):
134         assert service.running("salt", enabled=1) == "salt"
135     with patch.object(service, "_available", fmock):
136 <a name="3"></a>        assert service.running("salt") == ret[0]
137     with patch.object(service, "_available", tmock):
138         <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>with patch.dict(service.__opts__, {"test": False}):
139             with patch.dict(
140                 service.__salt__,
141                 {"service.enabled": tmock, "service.status": tmock},
142             ):
143                 assert service.running(</b></font>"salt") == ret[1]
144             mock = MagicMock(return_value={"changes": "saltstack"})
145             with patch.dict(
146                 service.__salt__,
147                 {
148                     "service.enabled": MagicMock(side_effect=[False, True]),
149                     "service.status": tmock,
150                 },
151             ):
152                 with patch.object(service, "_enable", mock):
153                     assert service.running("salt", True) == ret[2]
154             with patch.dict(
155                 service.__salt__,
156                 {
157                     "service.enabled": MagicMock(side_effect=[True, False]),
158                     "service.status": tmock,
159                 },
160             ):
161                 with patch.object(service, "_disable", mock):
162                     assert service.running("salt", False) == ret[2]
163             with patch.dict(
164                 service.__salt__,
165                 {
166                     "service.status": MagicMock(side_effect=[False, True]),
167                     "service.enabled": MagicMock(side_effect=[False, True]),
168                     "service.start": MagicMock(return_value="stack"),
169                 },
170             ):
171                 with patch.object(
172                     service,
173                     "_enable",
174                     MagicMock(return_value={"changes": "saltstack"}),
175                 ):
176                     assert service.running("salt", True) == ret[4]
177             with patch.dict(
178                 service.__salt__,
179                 {
180                     "service.status": MagicMock(side_effect=[False, True]),
181                     "service.enabled": MagicMock(side_effect=[False, True]),
182                     "service.unmask": MagicMock(side_effect=[False, True]),
183                     "service.start": MagicMock(return_value="stack"),
184                 },
185             ):
186                 with patch.object(
187                     service,
188                     "_enable",
189                     MagicMock(return_value={"changes": "saltstack"}),
190                 ):
191                     assert service.running("salt", True, unmask=True) == ret[7]
192         with patch.dict(service.__opts__, {"test": True}):
193             with patch.dict(service.__salt__, {"service.status": tmock}):
194                 assert service.running("salt") == ret[5]
195             with patch.dict(service.__salt__, {"service.status": fmock}):
196                 assert service.running("salt") == ret[3]
197         with patch.dict(service.__opts__, {"test": False}):
198             with patch.dict(
199                 service.__salt__,
200                 {
201                     "service.status": MagicMock(side_effect=[False, False]),
202                     "service.enabled": MagicMock(side_effect=[True, True]),
203                     "service.start": MagicMock(return_value="stack"),
204                 },
205             ):
206                 with patch.object(
207                     service,
208                     "_enable",
209                     MagicMock(return_value={"changes": "saltstack"}),
210                 ):
211                     assert service.running("salt", True) == ret[6]
212             with patch.object(salt.utils.platform, "is_windows", tmock):
213                 with patch.dict(
214                     service.__salt__,
215                     {
216                         "service.status": fmock,
217                         "service.enabled": fmock,
218                         "service.start": tmock,
219                     },
220                 ):
221                     assert service.running("salt", None) == ret[9]
222                     assert service.__context__ == {"service.state": "running"}
223             with patch.object(salt.utils.platform, "is_darwin", tmock):
224                 with patch.dict(
225                     service.__salt__,
226                     {
227                         "service.status": fmock,
228                         "service.enabled": fmock,
229                         "service.start": tmock,
230                     },
231                 ):
232                     assert service.running("salt", None) == ret[9]
233                     assert service.__context__ == {"service.state": "running"}
234                 with patch.dict(
235                     service.__salt__,
236                     {
237                         "service.status": MagicMock(side_effect=[False, "loaded"]),
238                         "service.enabled": MagicMock(side_effect=[False, True]),
239                         "service.start": tmock,
240                     },
241                 ):
242                     with patch.object(
243                         service,
244                         "_enable",
245                         MagicMock(return_value={"changes": "saltstack"}),
246                     ):
247                         assert service.running("salt", True) == ret[4]
248                         assert service.__context__ == {"service.state": "running"}
249                 with patch.dict(
250                     service.__salt__,
251                     {
252                         "service.status": fmock,
253                         "service.enabled": fmock,
254                         "service.start": fmock,
255                     },
256                 ):
257                     with patch.object(
258                         service,
259                         "_enable",
260                         MagicMock(
261                             return_value={"changes": "saltstack", "result": False}
262                         ),
263                     ):
264                         assert service.running("salt", True) == ret[6]
265                         assert service.__context__ == {"service.state": "running"}
266 def test_running_in_offline_mode():
267     name = "thisisnotarealservice"
268     with patch.object(service, "_offline", MagicMock(return_value=True)):
269         ret = service.running(name=name)
270         assert ret == {
271             "changes": {},
272             "comment": "Running in OFFLINE mode. Nothing to do",
273             "result": True,
274             "name": name,
275         }
276 def test_dead():
277     ret = [
278         {"changes": {}, "comment": "", "name": "salt", "result": True},
279         {
280             "changes": "saltstack",
281             "comment": "The service salt is already dead",
282             "name": "salt",
283             "result": True,
284         },
285         {
286             "changes": {},
287             "comment": "Service salt is set to be killed",
288             "name": "salt",
289             "result": None,
290         },
291         {
292             "changes": "saltstack",
293             "comment": "Service salt was killed",
294             "name": "salt",
295             "result": True,
296         },
297         {
298             "changes": {},
299             "comment": "Service salt failed to die",
300             "name": "salt",
301             "result": False,
302         },
303         {
304             "changes": "saltstack",
305             "comment": "The service salt is already dead",
306             "name": "salt",
307             "result": True,
308         },
309     ]
310     info_mock = MagicMock(return_value={"StartType": ""})
311     mock = MagicMock(return_value="salt")
312     with patch.object(service, "_enabled_used_error", mock):
313         assert service.dead("salt", enabled=1) == "salt"
314     tmock = MagicMock(return_value=True)
315     fmock = MagicMock(return_value=False)
316     with patch.object(service, "_available", fmock):
317         assert service.dead("salt") == ret[0]
318 <a name="1"></a>
319     with patch.object(service, "_available", tmock):
320         mock = MagicMock(return_value={"changes": "saltstack"})
321         with patch.dict(service.__opts__, {<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"test": True}):
322             with patch.dict(
323                 service.__salt__,
324                 {
325                     "service.enabled": fmock,
326                     "service.stop": tmock,
327                     "service.status": fmock,
328                     "service.info": info_mock,
329                 },
330             ):
331                 with patch.object(service, "_enable", mock):
332                     assert service.dead("salt", True) == ret[5</b></font>]
333             with patch.dict(
334                 service.__salt__,
335                 {
336                     "service.enabled": tmock,
337                     "service.status": tmock,
338                     "service.info": info_mock,
339                 },
340 <a name="0"></a>            ):
341                 assert service.dead("salt") == ret[2]
342         with patch.dict(service.__opts__, {<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"test": False}):
343             with patch.dict(
344                 service.__salt__,
345                 {
346                     "service.enabled": fmock,
347                     "service.stop": tmock,
348                     "service.status": fmock,
349                     "service.info": info_mock,
350                 },
351             ):
352                 with patch.object(service, "_enable", mock):
353                     assert service.dead("salt", True) == ret[1</b></font>]
354             with patch.dict(
355                 service.__salt__,
356                 {
357                     "service.enabled": MagicMock(side_effect=[True, True, False]),
358                     "service.status": MagicMock(side_effect=[True, False, False]),
359                     "service.stop": MagicMock(return_value="stack"),
360                     "service.info": info_mock,
361                 },
362             ):
363                 with patch.object(
364                     service,
365                     "_enable",
366                     MagicMock(return_value={"changes": "saltstack"}),
367                 ):
368                     assert service.dead("salt", True) == ret[3]
369             with patch.dict(
370                 service.__salt__,
371                 {
372                     "service.enabled": MagicMock(side_effect=[False, False, False]),
373                     "service.status": MagicMock(side_effect=[True, True, True]),
374                     "service.stop": MagicMock(return_value="stack"),
375                     "service.info": info_mock,
376                 },
377             ):
378                 with patch.object(service, "_disable", MagicMock(return_value={})):
379                     assert service.dead("salt", False) == ret[4]
380         assert service.__context__ == {"service.state": "dead"}
381 def test_dead_with_missing_service():
382     name = "thisisnotarealservice"
383     with patch.dict(
384         service.__salt__, {"service.available": MagicMock(return_value=False)}
385     ):
386         ret = service.dead(name=name)
387         assert ret == {
388             "changes": {},
389             "comment": "The named service {} is not available".format(name),
390             "result": True,
391             "name": name,
392         }
393 def test_dead_in_offline_mode():
394     name = "thisisnotarealservice"
395     with patch.object(service, "_offline", MagicMock(return_value=True)):
396         ret = service.dead(name=name)
397         assert ret == {
398             "changes": {},
399             "comment": "Running in OFFLINE mode. Nothing to do",
400             "result": True,
401             "name": name,
402         }
403 def test_enabled():
404     ret = {"changes": "saltstack", "comment": "", "name": "salt", "result": True}
405     mock = MagicMock(return_value={"changes": "saltstack"})
406     with patch.object(service, "_enable", mock):
407         assert service.enabled("salt") == ret
408         assert service.__context__ == {"service.state": "enabled"}
409 def test_disabled():
410     ret = {"changes": "saltstack", "comment": "", "name": "salt", "result": True}
411     mock = MagicMock(return_value={"changes": "saltstack"})
412     with patch.object(service, "_disable", mock):
413         assert service.disabled("salt") == ret
414         assert service.__context__ == {"service.state": "disabled"}
415 def test_mod_watch():
416     ret = [
417         {
418             "changes": {},
419             "comment": "Service is already stopped",
420             "name": "salt",
421             "result": True,
422         },
423         {
424             "changes": {},
425             "comment": "Unable to trigger watch for service.stack",
426             "name": "salt",
427             "result": False,
428         },
429         {
430             "changes": {},
431             "comment": "Service is set to be started",
432             "name": "salt",
433 <a name="2"></a>            "result": None,
434         },
435         {
436             <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"changes": {"salt": "salt"},
437             "comment": "Service started",
438             "name": "salt",
439             "result": "salt",
440         },
441     ]
442     mock = MagicMock(return_value=False)
443     with patch.dict(service.__salt__, {"service.status": mock}):
444         assert service.mod_watch("salt", "dead") == ret[</b></font>0]
445         with patch.dict(service.__salt__, {"service.start": func}):
446             with patch.dict(service.__opts__, {"test": True}):
447                 assert service.mod_watch("salt", "running") == ret[2]
448             with patch.dict(service.__opts__, {"test": False}):
449                 assert service.mod_watch("salt", "running") == ret[3]
450         assert service.mod_watch("salt", "stack") == ret[1]
451 def test_mod_beacon(tmp_path):
452     name = "sshd"
453     with patch.dict(service.__salt__, {"beacons.list": MagicMock(return_value={})}):
454         with patch.dict(service.__states__, {"beacon.present": beaconstate.present}):
455             ret = service.mod_beacon(name, sfun="copy")
456             expected = {
457                 "name": name,
458                 "changes": {},
459                 "result": False,
460                 "comment": "service.copy does not work with the beacon state function",
461             }
462             assert ret == expected
463     event_returns = [
464         {
465             "complete": True,
466             "tag": "/salt/minion/minion_beacons_list_complete",
467             "beacons": {},
468         },
469         {
470             "complete": True,
471             "tag": "/salt/minion/minion_beacons_list_complete",
472             "beacons": {},
473         },
474         {
475             "complete": True,
476             "tag": "/salt/minion/minion_beacons_list_available_complete",
477             "beacons": ["service"],
478         },
479         {
480             "valid": True,
481             "tag": "/salt/minion/minion_beacon_validation_complete",
482             "vcomment": "Valid beacon configuration",
483         },
484         {
485             "complete": True,
486             "tag": "/salt/minion/minion_beacon_add_complete",
487             "beacons": {
488                 "beacon_service_sshd": [
489                     {
490                         "services": {
491                             "sshd": {
492                                 "onchangeonly": True,
493                                 "delay": 0,
494                                 "uncleanshutdown": None,
495                                 "emitatstartup": False,
496                             },
497                         }
498                     },
499                     {"interval": 60},
500                     {"beacon_module": "service"},
501                 ]
502             },
503         },
504     ]
505     mock = MagicMock(return_value=True)
506     beacon_state_mocks = {
507         "beacons.list": beaconmod.list_,
508         "beacons.add": beaconmod.add,
509         "beacons.list_available": beaconmod.list_available,
510         "event.fire": mock,
511     }
512     beacon_mod_mocks = {"event.fire": mock}
513     sock_dir = str(tmp_path / "test-socks")
514     with patch.dict(service.__states__, {"beacon.present": beaconstate.present}):
515         with patch.dict(beaconstate.__salt__, beacon_state_mocks):
516             with patch.dict(beaconmod.__salt__, beacon_mod_mocks):
517                 with patch.dict(
518                     beaconmod.__opts__, {"beacons": {}, "sock_dir": sock_dir}
519                 ):
520                     with patch.object(
521                         SaltEvent, "get_event", side_effect=event_returns
522                     ):
523                         ret = service.mod_beacon(name, sfun="running", beacon="True")
524                         expected = {
525                             "name": "beacon_service_sshd",
526                             "changes": {},
527                             "result": True,
528                             "comment": "Adding beacon_service_sshd to beacons",
529                         }
530                         assert ret == expected
531 @pytest.mark.skip_on_darwin(reason="service.running is currently failing on OSX")
532 @pytest.mark.destructive_test
533 @pytest.mark.slow_test
534 def test_running_with_reload():
535     opts = salt.config.DEFAULT_MINION_OPTS.copy()
536     opts["grains"] = salt.loader.grains(opts)
537     utils = salt.loader.utils(opts)
538     modules = salt.loader.minion_mods(opts, utils=utils)
539     service_name = "cron"
540     cmd_name = "crontab"
541     os_family = opts["grains"]["os_family"]
542     os_release = opts["grains"]["osrelease"]
543     if os_family == "RedHat":
544         service_name = "crond"
545     elif os_family == "Arch":
546         service_name = "sshd"
547         cmd_name = "systemctl"
548     elif os_family == "MacOS":
549         service_name = "org.ntp.ntpd"
550         if int(os_release.split(".")[1]) &gt;= 13:
551             service_name = "com.openssh.sshd"
552     elif os_family == "Windows":
553         service_name = "Spooler"
554     if os_family != "Windows" and salt.utils.path.which(cmd_name) is None:
555         pytest.skip("{} is not installed".format(cmd_name))
556     pre_srv_enabled = (
557         True if service_name in modules["service.get_enabled"]() else False
558     )
559     post_srv_disable = False
560     if not pre_srv_enabled:
561         modules["service.enable"](service_name)
562         post_srv_disable = True
563     try:
564         with patch.dict(service.__grains__, opts["grains"]), patch.dict(
565             service.__opts__, opts
566         ), patch.dict(service.__salt__, modules), patch.dict(
567             service.__utils__, utils
568         ), patch.dict(
569             service.__opts__, {"test": False}
570         ), patch(
571             "salt.utils.systemd.offline", MagicMock(return_value=False)
572         ):
573             service.dead(service_name, enable=False)
574             result = service.running(name=service_name, enable=True, reload=False)
575         if salt.utils.platform.is_windows():
576             comment = "Started service {}".format(service_name)
577         else:
578             comment = "Service {} has been enabled, and is running".format(service_name)
579         expected = {
580             "changes": {service_name: True},
581             "comment": comment,
582             "name": service_name,
583             "result": True,
584         }
585         assert result == expected
586     finally:
587         if post_srv_disable:
588             modules["service.disable"](service_name)
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_mount.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import os
3 import shutil
4 import sys
5 import textwrap
6 import pytest
7 import salt.modules.mount as mount
8 import salt.utils.files
9 import salt.utils.path
10 from salt.exceptions import CommandExecutionError
11 from tests.support.mock import MagicMock, mock_open, patch
12 log = logging.getLogger(__name__)
13 @pytest.fixture
14 def mock_shell_file():
15     return "A B C D F G\n"
16 @pytest.fixture
17 def config_initial_file():
18     inital_fsystem = [
19         "/:\n",
20         "\tdev\t\t= /dev/hd4\n",
21         "\tvfs\t\t= jfs2\n",
22         "\tlog\t\t= /dev/hd8\n",
23         "\tmount \t\t= automatic\n",
24         "\tcheck\t\t= false\n",
25         "\ttype\t\t= bootfs\n",
26         "\tvol\t\t= root\n",
27         "\tfree\t\t= true\n",
28         "\n",
29         "/home:\n",
30         "\tdev\t\t= /dev/hd1\n",
31         "\tvfs\t\t= jfs2\n",
32         "\tlog\t\t= /dev/hd8\n",
33         "\tmount\t\t= true\n",
34         "\tcheck\t\t= true\n",
35         "\tvol\t\t= /home\n",
36         "\tfree\t\t= false\n",
37         "\n",
38     ]
39     return inital_fsystem
40 @pytest.fixture
41 def configure_loader_modules():
42     return {mount: {}}
43 @pytest.fixture
44 def tmp_sub_dir(tmp_path):
45     directory = tmp_path / "filesystems-dir"
46     directory.mkdir()
47     yield directory
48     shutil.rmtree(str(directory))
49 @pytest.fixture
50 def config_file(tmp_sub_dir, config_initial_file):
51     filename = str(tmp_sub_dir / "filesystems")
52     with salt.utils.files.fopen(filename, "wb") as fp:
53         fp.writelines(salt.utils.data.encode(config_initial_file))
54     yield filename
55     os.remove(filename)
56 def test_active():
57     with patch.dict(mount.__grains__, {"os": "FreeBSD", "kernel": "FreeBSD"}):
58         mock = MagicMock(return_value="A B C D,E,F,uid=user1,gid=grp1")
59         mock_user = MagicMock(return_value={"uid": "100"})
60         mock_group = MagicMock(return_value={"gid": "100"})
61         with patch.dict(
62             mount.__salt__,
63             {
64                 "cmd.run_stdout": mock,
65                 "user.info": mock_user,
66                 "group.info": mock_group,
67             },
68         ):
69             assert mount.active() == {
70                 "B": {
71                     "device": "A",
72                     "opts": ["D", "E", "F", "uid=100", "gid=100"],
73                     "fstype": "C",
74 <a name="2"></a>                }
75             }
76     with patch.dict(mount<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.__grains__, {"os": "Solaris", "kernel": "SunOS"}):
77         mock = MagicMock(return_value="A * B * C D/E/F")
78         with patch.dict(mount.__salt__, {"cmd.run_stdout": mock}):
79             assert mount.active() == {
80                 "B"</b></font>: {"device": "A", "opts": ["D", "E", "F"], "fstype": "C"}
81             }
82     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}):
83         mock = MagicMock(return_value="A * B * C D/E/F")
84         with patch.dict(mount.__salt__, {"cmd.run_stdout": mock}):
85             assert mount.active() == {"B": {"node": "A", "device": "*", "fstype": "*"}}
86     with patch.dict(mount.__grains__, {"os": "OpenBSD", "kernel": "OpenBSD"}):
87         mock = MagicMock(return_value={})
88         with patch.object(mount, "_active_mounts_openbsd", mock):
89             assert mount.active() == {}
90     with patch.dict(mount.__grains__, {"os": "MacOS", "kernel": "Darwin"}):
91         mock = MagicMock(return_value={})
92         with patch.object(mount, "_active_mounts_darwin", mock):
93             assert mount.active() == {}
94     with patch.dict(mount.__grains__, {"os": "MacOS", "kernel": "Darwin"}):
95         mock = MagicMock(return_value={})
96         with patch.object(mount, "_active_mountinfo", mock):
97             with patch.object(mount, "_active_mounts_darwin", mock):
98                 assert mount.active(extended=True) == {}
99     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}):
100         mock = MagicMock(return_value={})
101         with patch.object(mount, "_active_mounts_aix", mock):
102             assert mount.active() == {}
103 def test_fstab():
104     mock = MagicMock(return_value=False)
105     with patch.object(os.path, "isfile", mock):
106         assert mount.fstab() == {}
107     file_data = "\n".join(["#", "A B C D,E,F G H"])
108     mock = MagicMock(return_value=True)
109     with patch.dict(mount.__grains__, {"kernel": ""}), patch.object(
110         os.path, "isfile", mock
111     ), patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
112         fstab = mount.fstab()
113         assert fstab == {
114             "B": {
115                 "device": "A",
116                 "dump": "G",
117                 "fstype": "C",
118                 "opts": ["D", "E", "F"],
119                 "pass": "H",
120             }
121         }, fstab
122 def test_vfstab():
123     mock = MagicMock(return_value=False)
124     with patch.object(os.path, "isfile", mock):
125         assert mount.vfstab() == {}
126     file_data = textwrap.dedent(
127     )
128     mock = MagicMock(return_value=True)
129     with patch.dict(mount.__grains__, {"kernel": "SunOS"}), patch.object(
130         os.path, "isfile", mock
131     ), patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
132         vfstab = mount.vfstab()
133         assert vfstab == {
134             "/tmp": {
135                 "device": "swap",
136                 "device_fsck": "-",
137                 "fstype": "tmpfs",
138                 "mount_at_boot": "yes",
139                 "opts": ["size=2048m"],
140                 "pass_fsck": "-",
141             }
142         }, vfstab
143 def test_filesystems():
144     file_data = textwrap.dedent(
145     )
146     mock = MagicMock(return_value=True)
147     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}), patch.object(
148         os.path, "isfile", mock
149     ), patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
150         assert mount.filesystems() == {}
151     file_data = textwrap.dedent(
152     )
153     mock = MagicMock(return_value=True)
154     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}), patch.object(
155         os.path, "isfile", mock
156     ), patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
157         fsyst = mount.filesystems()
158         test_fsyst = {
159             "/home": {
160                 "dev": "/dev/hd1",
161                 "vfs": "jfs2",
162                 "log": "/dev/hd8",
163                 "mount": "true",
164                 "check": "true",
165                 "vol": "/home",
166                 "free": "false",
167                 "quota": "no",
168             }
169         }
170         assert test_fsyst == fsyst
171 def test_rm_fstab():
172     mock_fstab = MagicMock(return_value={})
173     with patch.dict(mount.__grains__, {"kernel": ""}):
174         with patch.object(mount, "fstab", mock_fstab):
175             with patch("salt.utils.files.fopen", mock_open()):
176                 assert mount.rm_fstab("name", "device")
177 def test_set_fstab(mock_shell_file):
178     mock = MagicMock(return_value=False)
179     with patch.object(os.path, "isfile", mock):
180         pytest.raises(CommandExecutionError, mount.set_fstab, "A", "B", "C")
181     mock = MagicMock(return_value=True)
182     mock_read = MagicMock(side_effect=OSError)
183     with patch.object(os.path, "isfile", mock):
184         with patch.object(salt.utils.files, "fopen", mock_read):
185             pytest.raises(CommandExecutionError, mount.set_fstab, "A", "B", "C")
186     mock = MagicMock(return_value=True)
187     with patch.object(os.path, "isfile", mock):
188         with patch("salt.utils.files.fopen", mock_open(read_data=mock_shell_file)):
189             assert mount.set_fstab("A", "B", "C") == "new"
190     mock = MagicMock(return_value=True)
191     with patch.object(os.path, "isfile", mock):
192         with patch("salt.utils.files.fopen", mock_open(read_data=mock_shell_file)):
193             assert mount.set_fstab("B", "A", "C", "D", "F", "G") == "present"
194     mock = MagicMock(return_value=True)
195     with patch.object(os.path, "isfile", mock):
196         with patch("salt.utils.files.fopen", mock_open(read_data=mock_shell_file)):
197             assert mount.set_fstab("B", "A", "C", not_change=True) == "present"
198 def test_rm_automaster():
199     mock = MagicMock(return_value={})
200     with patch.object(mount, "automaster", mock):
201         assert mount.rm_automaster("name", "device")
202     mock = MagicMock(return_value={"name": "name"})
203     with patch.object(mount, "fstab", mock):
204         assert mount.rm_automaster("name", "device")
205 def test_set_automaster(mock_shell_file):
206     mock = MagicMock(return_value=True)
207     with patch.object(os.path, "isfile", mock):
208         pytest.raises(CommandExecutionError, mount.set_automaster, "A", "B", "C")
209     mock = MagicMock(return_value=True)
210     mock_read = MagicMock(side_effect=OSError)
211     with patch.object(os.path, "isfile", mock):
212         with patch.object(salt.utils.files, "fopen", mock_read):
213             pytest.raises(CommandExecutionError, mount.set_automaster, "A", "B", "C")
214     mock = MagicMock(return_value=True)
215     with patch.object(os.path, "isfile", mock):
216         with patch("salt.utils.files.fopen", mock_open(read_data=mock_shell_file)):
217             assert mount.set_automaster("A", "B", "C") == "new"
218     mock = MagicMock(return_value=True)
219     with patch.object(os.path, "isfile", mock):
220         with patch(
221             "salt.utils.files.fopen", mock_open(read_data="/..A -fstype=C,D C:B")
222         ):
223             assert mount.set_automaster("A", "B", "C", "D") == "present"
224     mock = MagicMock(return_value=True)
225     with patch.object(os.path, "isfile", mock):
226         with patch(
227             "salt.utils.files.fopen", mock_open(read_data="/..A -fstype=XX C:B")
228         ):
229             assert (
230                 mount.set_automaster("A", "B", "C", "D", not_change=True) == "present"
231             )
232 def test_automaster():
233     assert mount.automaster() == {}
234 def test_rm_filesystems():
235     file_data = textwrap.dedent(
236     )
237     mock = MagicMock(return_value=True)
238     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}), patch.object(
239         os.path, "isfile", mock
240     ), patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
241         assert not mount.rm_filesystems("name", "device")
242     file_data = textwrap.dedent(
243     )
244     mock = MagicMock(return_value=True)
245     mock_fsyst = MagicMock(return_value=True)
246     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}), patch.object(
247         os.path, "isfile", mock
248     ), patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
249         assert mount.rm_filesystems("/name", "device")
250 def test_set_filesystems():
251     mock = MagicMock(return_value=False)
252     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}):
253         with patch.object(os.path, "isfile", mock):
254             pytest.raises(CommandExecutionError, mount.set_filesystems, "A", "B", "C")
255         mock_read = MagicMock(side_effect=OSError)
256         with patch.object(os.path, "isfile", mock):
257             with patch.object(salt.utils.files, "fopen", mock_read):
258                 pytest.raises(
259                     CommandExecutionError, mount.set_filesystems, "A", "B", "C"
260                 )
261 @pytest.mark.skipif(
262     sys.version_info[0] == 3 and sys.version_info[1] &lt;= 5,
263     reason="run on Python 3.6 or greater where OrderedDict is default",
264 )
265 @pytest.mark.skip_on_windows(
266     reason="Not supported on Windows, does not handle tabs well"
267 )
268 def test_set_filesystems_with_data(tmp_sub_dir, config_file):
269     config_filepath = str(tmp_sub_dir / "filesystems")
270     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}):
271         mount.set_filesystems(
272             "/test_mount", "/dev/hd3", "jsf2", "-", "true", config_filepath
273         )
274         with salt.utils.files.fopen(config_filepath, "r") as fp:
275             fsys_content = fp.read()
276         test_fsyst = """/:
277 	dev		= /dev/hd4
278 	vfs		= jfs2
279 	log		= /dev/hd8
280 	mount		= automatic
281 	check		= false
282 	type		= bootfs
283 	vol		= root
284 	free		= true
285 /home:
286 	dev		= /dev/hd1
287 	vfs		= jfs2
288 	log		= /dev/hd8
289 	mount		= true
290 	check		= true
291 	vol		= /home
292 	free		= false
293 /test_mount:
294 	dev		= /dev/hd3
295 	vfstype		= jsf2
296 	opts		= -
297 	mount		= true
298     Mount a device
299     Attempt to remount a device, if the device is not already mounted, mount
300     is called
301     Attempt to remount a device already mounted that do not provides
302     fstype
303     Attempt to remount a device already mounted that do not provides
304     fstype
305     Attempt to unmount a device by specifying the directory it is
306     mounted on
307     Returns true if the command passed is a fuse mountable application
308         Neither of these are full ldd output, but what is_fuse_exec is
309         looking for is 'libfuse' in the ldd output, so these examples
310         should be sufficient enough to test both the True and False cases.
311                 linux-vdso.so.1 (0x00007ffeaf5fb000)
312                 libfuse3.so.3 =&gt; /usr/lib/libfuse3.so.3 (0x00007f91e66ac000)
313                 """
314             ),
315             "ldd cmd2": textwrap.dedent(
316             ),
317         }[cmd]
318 <a name="3"></a>
319     which_mock = MagicMock(side_effect=lambda x: x)
320     ldd_mock = MagicMock(side_effect=_ldd_side_effect)
321     <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>with patch.object(salt.utils.path, "which", which_mock):
322         with patch.dict(mount.__salt__, {"cmd.run": _ldd_side_effect}):
323             assert mount.is_fuse_exec(</b></font>"cmd1")
324             assert not mount.is_fuse_exec("cmd2")
325 def test_swaps():
326     file_data = textwrap.dedent(
327     )
328     with patch.dict(mount.__grains__, {"os": "", "kernel": ""}):
329         with patch("salt.utils.files.fopen", mock_open(read_data=file_data)):
330             swaps = mount.swaps()
331             assert swaps == {
332                 "/dev/sda1": {
333                     "priority": "-1",
334                     "size": "31249404",
335                     "type": "partition",
336                     "used": "4100",
337                 }
338             }, swaps
339     file_data = textwrap.dedent(
340     )
341     mock = MagicMock(return_value=file_data)
342     with patch.dict(
343         mount.__grains__, {"os": "OpenBSD", "kernel": "OpenBSD"}
344     ), patch.dict(mount.__salt__, {"cmd.run_stdout": mock}):
345         swaps = mount.swaps()
346         assert swaps == {
347             "/dev/sda1": {
348                 "priority": "-1",
349                 "size": "31249404",
350                 "type": "partition",
351                 "used": "4100",
352             }
353         }, swaps
354     file_data = textwrap.dedent(
355     )
356     mock = MagicMock(return_value=file_data)
357     with patch.dict(mount.__grains__, {"os": "AIX", "kernel": "AIX"}), patch.dict(
358         mount.__salt__, {"cmd.run_stdout": mock}
359     ):
360         swaps = mount.swaps()
361         assert swaps == {
362             "/dev/hd6": {
363                 "priority": "-",
364                 "size": 12058624,
365                 "type": "device",
366                 "used": 11264,
367             }
368         }, swaps
369 def test_swapon():
370 <a name="1"></a>    """
371     Activate a swap disk
372     mock = MagicMock(return_value={<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>"name": "name"})
373     with patch.dict(mount.__grains__, {"kernel": ""}):
374         with patch.object(mount, "swaps", mock):
375             assert mount.swapon("name") == {"s</b></font>tats": "name", "new": False}
376     mock = MagicMock(return_value={})
377     with patch.dict(mount.__grains__, {"kernel": ""}):
378         with patch.object(mount, "swaps", mock):
379             mock = MagicMock(return_value=None)
380             with patch.dict(mount.__salt__, {"cmd.run": mock}):
381                 assert mount.swapon("name", False) == {}
382     mock = MagicMock(side_effect=[{}, {"name": "name"}])
383     with patch.dict(mount.__grains__, {"kernel": ""}):
384         with patch.object(mount, "swaps", mock):
385             mock = MagicMock(return_value=None)
386 <a name="0"></a>            with patch.dict(mount.__salt__, {"cmd.run": mock}):
387                 assert mount.swapon("name") == {"stats": "name", "new": True}
388     mock = MagicMock(return_value={<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>"name": "name"})
389     with patch.dict(mount.__grains__, {"kernel": "AIX"}):
390         with patch.object(mount, "swaps", mock):
391             assert mount.swapon("name") == {"s</b></font>tats": "name", "new": False}
392     mock = MagicMock(return_value={})
393     with patch.dict(mount.__grains__, {"kernel": "AIX"}):
394         with patch.object(mount, "swaps", mock):
395             mock = MagicMock(return_value=None)
396             with patch.dict(mount.__salt__, {"cmd.run": mock}):
397                 assert mount.swapon("name", False) == {}
398     mock = MagicMock(side_effect=[{}, {"name": "name"}])
399     with patch.dict(mount.__grains__, {"kernel": "AIX"}):
400         with patch.object(mount, "swaps", mock):
401             mock = MagicMock(return_value=None)
402             with patch.dict(mount.__salt__, {"cmd.run": mock}):
403                 assert mount.swapon("name") == {"stats": "name", "new": True}
404 def test_swapoff():
405     mock = MagicMock(return_value={})
406     with patch.dict(mount.__grains__, {"kernel": ""}):
407         with patch.object(mount, "swaps", mock):
408             assert mount.swapoff("name") is None
409     mock = MagicMock(return_value={"name": "name"})
410     with patch.dict(mount.__grains__, {"kernel": ""}):
411         with patch.object(mount, "swaps", mock):
412             with patch.dict(mount.__grains__, {"os": "test"}):
413                 mock = MagicMock(return_value=None)
414                 with patch.dict(mount.__salt__, {"cmd.run": mock}):
415                     assert not mount.swapoff("name")
416     mock = MagicMock(side_effect=[{"name": "name"}, {}])
417     with patch.dict(mount.__grains__, {"kernel": ""}):
418         with patch.object(mount, "swaps", mock):
419             with patch.dict(mount.__grains__, {"os": "test"}):
420                 mock = MagicMock(return_value=None)
421                 with patch.dict(mount.__salt__, {"cmd.run": mock}):
422                     assert mount.swapoff("name")
423     mock = MagicMock(return_value={})
424     with patch.dict(mount.__grains__, {"kernel": "AIX"}):
425         with patch.object(mount, "swaps", mock):
426             assert mount.swapoff("name") is None
427     mock = MagicMock(return_value={"name": "name"})
428     with patch.dict(mount.__grains__, {"kernel": "AIX"}):
429         with patch.object(mount, "swaps", mock):
430             with patch.dict(mount.__grains__, {"os": "test"}):
431                 mock = MagicMock(return_value=None)
432                 with patch.dict(mount.__salt__, {"cmd.run": mock}):
433                     assert not mount.swapoff("name")
434     mock = MagicMock(side_effect=[{"name": "name"}, {}])
435     with patch.dict(mount.__grains__, {"kernel": "AIX"}):
436         with patch.object(mount, "swaps", mock):
437             with patch.dict(mount.__grains__, {"os": "test"}):
438                 mock = MagicMock(return_value=None)
439                 with patch.dict(mount.__salt__, {"cmd.run": mock}):
440                     assert mount.swapoff("name")
441 def test_is_mounted():
442     mock = MagicMock(return_value={})
443     with patch.object(mount, "active", mock), patch.dict(
444         mount.__grains__, {"kernel": ""}
445     ):
446         assert not mount.is_mounted("name")
447     mock = MagicMock(return_value={"name": "name"})
448     with patch.object(mount, "active", mock), patch.dict(
449         mount.__grains__, {"kernel": ""}
450     ):
451         assert mount.is_mounted("name")
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
