<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html><head><title>Matches for test_hosts.py &amp; test_restartcheck_1.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_hosts.py &amp; test_restartcheck_1.py
      </h3>
<h1 align="center">
        7.7%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_hosts.py (8.791209%)<th>test_restartcheck_1.py (6.8965516%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(287-294)<td><a href="#" name="0">(29-38)</a><td align="center"><font color="#ff0000">14</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(123-125)<td><a href="#" name="1">(54-61)</a><td align="center"><font color="#ec0000">13</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(7-26)<td><a href="#" name="2">(5-23)</a><td align="center"><font color="#ec0000">13</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_hosts.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
"""
    :codeauthor: Jayesh Kariya &lt;jayeshk@saltstack.com&gt;
"""
<a name="2"></a>
import io

<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import salt.modules.hosts as hosts
import salt.utils.data
import salt.utils.platform
import salt.utils.stringutils
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import MagicMock, mock_open, patch
from tests.support.unit import TestCase


class HostsTestCase(TestCase, LoaderModuleMockMixin):
    """
    TestCase for salt.modules.hosts
    """

    def setup_loader_modules(self):
        return {hosts: {}}

    # 'list_hosts' function tests: 1

    def</b></font> test_list_hosts(self):
        """
        Tests return the hosts found in the hosts file
        """
        with patch(
            "salt.modules.hosts._list_hosts",
            MagicMock(return_value={"10.10.10.10": {"aliases": ["Salt1", "Salt2"]}}),
        ):
            self.assertDictEqual(
                {"10.10.10.10": {"aliases": ["Salt1", "Salt2"]}}, hosts.list_hosts()
            )

    # 'get_ip' function tests: 3

    def test_get_ip(self):
        """
        Tests return ip associated with the named host
        """
        with patch(
            "salt.modules.hosts._list_hosts",
            MagicMock(return_value={"10.10.10.10": {"aliases": ["Salt1", "Salt2"]}}),
        ):
            self.assertEqual("10.10.10.10", hosts.get_ip("Salt1"))

            self.assertEqual("", hosts.get_ip("Salt3"))

    def test_get_ip_none(self):
        """
        Tests return ip associated with the named host
        """
        with patch("salt.modules.hosts._list_hosts", MagicMock(return_value="")):
            self.assertEqual("", hosts.get_ip("Salt1"))

    # 'get_alias' function tests: 2

    def test_get_alias(self):
        """
        Tests return the list of aliases associated with an ip
        """
        with patch(
            "salt.modules.hosts._list_hosts",
            MagicMock(return_value={"10.10.10.10": {"aliases": ["Salt1", "Salt2"]}}),
        ):
            self.assertListEqual(["Salt1", "Salt2"], hosts.get_alias("10.10.10.10"))

    def test_get_alias_none(self):
        """
        Tests return the list of aliases associated with an ip
        """
        with patch(
            "salt.modules.hosts._list_hosts",
            MagicMock(return_value={"10.10.10.10": {"aliases": ["Salt1", "Salt2"]}}),
        ):
            self.assertListEqual([], hosts.get_alias("10.10.10.11"))

    # 'has_pair' function tests: 1

    def test_has_pair(self):
        """
        Tests return True / False if the alias is set
        """
        with patch(
            "salt.modules.hosts._list_hosts",
            MagicMock(return_value={"10.10.10.10": {"aliases": ["Salt1", "Salt2"]}}),
        ):
            self.assertTrue(hosts.has_pair("10.10.10.10", "Salt1"))

            self.assertFalse(hosts.has_pair("10.10.10.10", "Salt3"))

    # 'set_host' function tests: 3

    def test_set_host(self):
        """
        Tests true if the alias is set
        """
        hosts_file = "/etc/hosts"
        if salt.utils.platform.is_windows():
            hosts_file = r"C:\Windows\System32\Drivers\etc\hosts"

        with patch(
            "salt.modules.hosts.__get_hosts_filename",
            MagicMock(return_value=hosts_file),
        ), patch("os.path.isfile", MagicMock(return_value=False)), patch.dict(
            hosts.__salt__, {"config.option": MagicMock(return_value=None)}
        ):
            self.assertFalse(hosts.set_host("10.10.10.10", "Salt1"))

    def test_set_host_true(self):
        """
        Tests true if the alias is set
        """
        with patch(
            "salt.modules.hosts.__get_hosts_filename",
            MagicMock(return_value="/etc/hosts"),
<a name="1"></a>        ), patch("os.path.isfile", MagicMock(return_value=True)), patch(
            "salt.utils.files.fopen", mock_open(b"")
        ):
            mock_opt <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= MagicMock(return_value=None)
            with patch.dict(hosts.__salt__, {"config.option": mock_opt}):
                self.assertTrue(hosts.set_host(</b></font>"10.10.10.10", "Salt1"))

    def test_set_host_true_remove(self):
        """
        Test if an empty hosts value removes existing entries
        """
        with patch(
            "salt.modules.hosts.__get_hosts_filename",
            MagicMock(return_value="/etc/hosts"),
        ), patch("os.path.isfile", MagicMock(return_value=True)):
            data = [
                "\n".join(
                    (
                        "1.1.1.1 foo.foofoo foo",
                        "2.2.2.2 bar.barbar bar",
                        "3.3.3.3 asdf.asdfadsf asdf",
                        "1.1.1.1 foofoo.foofoo foofoo",
                    )
                )
            ]

            class TmpStringIO(io.StringIO):
                def __init__(self, fn, mode="r"):
                    self.mode = mode
                    initial_value = data[0]
                    if "w" in self.mode:
                        initial_value = ""
                    super().__init__(initial_value)

                def __enter__(self):
                    return self

                def __exit__(self, exc_type, exc_value, traceback):
                    self.close()

                def close(self):
                    # Don't save unless there's something there. In Windows
                    # the class gets initialized the first time with mode = w
                    # which sets the initial value to ''. When the class closes
                    # it clears out data and causes the test to fail.
                    # I don't know why it get's initialized with a mode of 'w'
                    # For the purposes of this test data shouldn't be empty
                    # This is a problem with this class and not with the hosts
                    # module
                    if self.getvalue():
                        data[0] = self.getvalue()
                    io.StringIO.close(self)

                def read(self, *args):
                    ret = super().read(*args)
                    if "b" in self.mode:
                        return salt.utils.stringutils.to_bytes(ret)
                    else:
                        return ret

                def write(self, s, *args):
                    if "b" in self.mode:
                        if not isinstance(s, bytes):
                            # Make this act like a binary filehandle
                            raise TypeError(
                                "a bytes-like object is required, not 'str'"
                            )
                        # The StringIO wants a str type, it won't take
                        # bytes. Convert before writing to it.
                        return super().write(salt.utils.stringutils.to_str(s), *args)
                    else:
                        if not isinstance(s, str):
                            # Make this act like a non-binary filehandle
                            raise TypeError("write() argument must be str, not bytes")
                    return super().write(s, *args)

                def readlines(self):
                    ret = super().readlines()
                    if "b" in self.mode:
                        return salt.utils.data.encode(ret)
                    else:
                        return ret

                def writelines(self, lines):
                    for line in lines:
                        self.write(line)

            expected = (
                "\n".join(
                    (
                        "2.2.2.2 bar.barbar bar",
                        "3.3.3.3 asdf.asdfadsf asdf",
                    )
                )
                + "\n"
            )

            with patch("salt.utils.files.fopen", TmpStringIO):
                mock_opt = MagicMock(return_value=None)
                with patch.dict(hosts.__salt__, {"config.option": mock_opt}):
                    self.assertTrue(hosts.set_host("1.1.1.1", " "))

            self.assertEqual(data[0], expected)

    # 'rm_host' function tests: 2

    def test_rm_host(self):
        """
        Tests if specified host entry gets removed from the hosts file
        """
        hosts_content = (
            b"# one line comment\n10.10.10.10    Salt1\n9.9.9.9    Salt2   # comment\n"
        )
        with patch("salt.utils.files.fopen", mock_open(hosts_content)), patch(
            "salt.modules.hosts.__get_hosts_filename",
            MagicMock(return_value="/etc/hosts"),
        ), patch("salt.modules.hosts.has_pair", MagicMock(return_value=True)), patch(
            "os.path.isfile", MagicMock(return_value=True)
        ):
            mock_opt = MagicMock(return_value=None)
            with patch.dict(hosts.__salt__, {"config.option": mock_opt}):
                self.assertTrue(hosts.rm_host("10.10.10.10", "Salt1"))

    def test_rm_host_false(self):
        """
        Tests if specified host entry gets removed from the hosts file
        """
        with patch("salt.modules.hosts.has_pair", MagicMock(return_value=False)):
            self.assertTrue(hosts.rm_host("10.10.10.10", "Salt1"))

    # 'add_host' function tests: 3

    def test_add_host(self):
        """
        Tests if specified host entry gets added from the hosts file
        """
        hosts_file = "/etc/hosts"
        if salt.utils.platform.is_windows():
            hosts_file = r"C:\Windows\System32\Drivers\etc\hosts"

        with patch("salt.utils.files.fopen", mock_open()), patch(
            "salt.modules.hosts.__get_hosts_filename",
            MagicMock(return_value=hosts_file),
        ):
            mock_opt = MagicMock(return_value=None)
            with patch.dict(hosts.__salt__, {"config.option": mock_opt}):
                self.assertTrue(hosts.add_host("10.10.10.10", "Salt1"))

    def test_add_host_no_file(self):
        """
        Tests if specified host entry gets added from the hosts file
        """
        with patch("salt.utils.files.fopen", mock_open()), patch(
            "os.path.isfile", MagicMock(return_value=False)
        ):
            mock_opt = MagicMock(return_value=None)
            with patch.dict(hosts.__salt__, {"config.option": mock_opt}):
                self.assertFalse(hosts.add_host("10.10.10.10", "Salt1"))

    def test_add_host_create_entry(self):
        """
        Tests if specified host entry gets added from the hosts file
        """
        with patch("salt.utils.files.fopen", mock_open()), patch(
<a name="0"></a>            "os.path.isfile", MagicMock(return_value=True)
        ):
            mock_opt = MagicMock(return_value=None)
            <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>with patch.dict(hosts.__salt__, {"config.option": mock_opt}):
                self.assertTrue(hosts.add_host("10.10.10.10", "Salt1"))

    def test_set_comment(self):
        """
        Tests return True / False when setting a comment
        """
        hosts_file =</b></font> "/etc/hosts"
        if salt.utils.platform.is_windows():
            hosts_file = r"C:\Windows\System32\Drivers\etc\hosts"

        with patch("salt.utils.files.fopen", mock_open()), patch(
            "salt.modules.hosts.__get_hosts_filename",
            MagicMock(return_value=hosts_file),
        ):
            mock_opt = MagicMock(return_value=None)
            with patch.dict(hosts.__salt__, {"config.option": mock_opt}):
                with patch(
                    "salt.modules.hosts._list_hosts",
                    MagicMock(
                        return_value={"10.10.10.10": {"aliases": ["Salt1", "Salt2"]}}
                    ),
                ):
                    self.assertTrue(hosts.set_comment("10.10.10.10", "A comment"))

                    self.assertFalse(hosts.set_comment("10.10.10.11", "A comment"))
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_restartcheck_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
"""
<a name="2"></a>    :codeauthor: :email:`David Homolka &lt;david.homolka@ultimum.io&gt;`
"""

<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import os

import salt.modules.restartcheck as restartcheck
import salt.utils.path
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import ANY, MagicMock, patch
from tests.support.runtests import RUNTIME_VARS
from tests.support.unit import TestCase


class RestartcheckTestCase(TestCase, LoaderModuleMockMixin):
    """
    Test cases for salt.modules.restartcheck
    """

    def setup_loader_modules(self):
        return {restartcheck: {}}

    def</b></font> test_kernel_versions_debian(self):
        """
        Test kernel version debian
<a name="0"></a>        """
        mock = MagicMock(return_value="  Installed: 4.9.82-1+deb9u3")
        with patch.dict(restartcheck.__grains__, {"os": "Debian"}):
            <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>with patch.dict(restartcheck.__salt__, {"cmd.run": mock}):
                self.assertListEqual(
                    restartcheck._kernel_versions_debian(), ["4.9.82-1+deb9u3"]
                )

    def test_kernel_versions_ubuntu(self):
        """
        Test kernel version ubuntu
        """
        mock =</b></font> MagicMock(return_value="  Installed: 4.10.0-42.46")
        with patch.dict(restartcheck.__grains__, {"os": "Ubuntu"}):
            with patch.dict(restartcheck.__salt__, {"cmd.run": mock}):
                self.assertListEqual(
                    restartcheck._kernel_versions_debian(),
                    [
                        "4.10.0-42.46",
                        "4.10.0-42-generic #46",
                        "4.10.0-42-lowlatency #46",
                    ],
                )

    def test_kernel_versions_redhat(self):
<a name="1"></a>        """
        Test if it return a data structure of the current, in-memory rules
        """
        mock <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= MagicMock(
            return_value=(
                "kernel-3.10.0-862.el7.x86_64                  Thu Apr 5 00:40:00 2018"
            )
        )
        with patch.dict(restartcheck.__salt__, {"cmd.run": mock}):
            self.assertListEqual(
                restartcheck._kernel_versions_redhat(</b></font>), ["3.10.0-862.el7.x86_64"]
            )

    def test_valid_deleted_file_deleted(self):
        """
        Test (deleted) file
        """
        self.assertTrue(restartcheck._valid_deleted_file("/usr/lib/test (deleted)"))

    def test_valid_deleted_file_psth_inode(self):
        """
        Test (path inode=1) file
        """
        self.assertTrue(
            restartcheck._valid_deleted_file("/usr/lib/test (path inode=1)")
        )

    def test_valid_deleted_file_var_log(self):
        """
        Test /var/log/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/var/log/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/var/log/test (deleted)"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/log/test (path inode=1)")
        )

    def test_valid_deleted_file_var_local_log(self):
        """
        Test /var/local/log/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/var/local/log/test"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/local/log/test (deleted)")
        )
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/local/log/test (path inode=1)")
        )

    def test_valid_deleted_file_var_run(self):
        """
        Test /var/run/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/var/run/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/var/run/test (deleted)"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/run/test (path inode=1)")
        )

    def test_valid_deleted_file_var_local_run(self):
        """
        Test /var/local/run/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/var/local/run/test"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/local/run/test (deleted)")
        )
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/local/run/test (path inode=1)")
        )

    def test_valid_deleted_file_tmp(self):
        """
        Test /tmp/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/tmp/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/tmp/test (deleted)"))
        self.assertFalse(restartcheck._valid_deleted_file("/tmp/test (path inode=1)"))

    def test_valid_deleted_file_dev_shm(self):
        """
        Test /dev/shm/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/dev/shm/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/dev/shm/test (deleted)"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/dev/shm/test (path inode=1)")
        )

    def test_valid_deleted_file_run(self):
        """
        Test /run/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/run/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/run/test (deleted)"))
        self.assertFalse(restartcheck._valid_deleted_file("/run/test (path inode=1)"))

    def test_valid_deleted_file_drm(self):
        """
        Test /drm/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/drm/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/drm/test (deleted)"))
        self.assertFalse(restartcheck._valid_deleted_file("/drm/test (path inode=1)"))

    def test_valid_deleted_file_var_tmp(self):
        """
        Test /var/tmp/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/var/tmp/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/var/tmp/test (deleted)"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/tmp/test (path inode=1)")
        )

    def test_valid_deleted_file_var_local_tmp(self):
        """
        Test /var/local/tmp/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/var/local/tmp/test"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/local/tmp/test (deleted)")
        )
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/local/tmp/test (path inode=1)")
        )

    def test_valid_deleted_file_dev_zero(self):
        """
        Test /dev/zero/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/dev/zero/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/dev/zero/test (deleted)"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/dev/zero/test (path inode=1)")
        )

    def test_valid_deleted_file_dev_pts(self):
        """
        Test /dev/pts/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/dev/pts/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/dev/pts/test (deleted)"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/dev/pts/test (path inode=1)")
        )

    def test_valid_deleted_file_usr_lib_locale(self):
        """
        Test /usr/lib/locale/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/usr/lib/locale/test"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/usr/lib/locale/test (deleted)")
        )
        self.assertFalse(
            restartcheck._valid_deleted_file("/usr/lib/locale/test (path inode=1)")
        )

    def test_valid_deleted_file_home(self):
        """
        Test /home/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/home/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/home/test (deleted)"))
        self.assertFalse(restartcheck._valid_deleted_file("/home/test (path inode=1)"))

    def test_valid_deleted_file_icon_theme_cache(self):
        """
        Test /test.icon-theme.cache
        """
        self.assertFalse(restartcheck._valid_deleted_file("/dev/test.icon-theme.cache"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/dev/test.icon-theme.cache (deleted)")
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(
                "/dev/test.icon-theme.cache (path inode=1)"
            )
        )

    def test_valid_deleted_file_var_cache_fontconfig(self):
        """
        Test /var/cache/fontconfig/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/var/cache/fontconfig/test"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/cache/fontconfig/test (deleted)")
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(
                "/var/cache/fontconfig/test (path inode=1)"
            )
        )

    def test_valid_deleted_file_var_lib_nagios3_spool(self):
        """
        Test /var/lib/nagios3/spool/
        """
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/lib/nagios3/spool/test")
        )
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/lib/nagios3/spool/test (deleted)")
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(
                "/var/lib/nagios3/spool/test (path inode=1)"
            )
        )

    def test_valid_deleted_file_var_lib_nagios3_spool_checkresults(self):
        """
        Test /var/lib/nagios3/spool/checkresults/
        """
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/lib/nagios3/spool/checkresults/test")
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(
                "/var/lib/nagios3/spool/checkresults/test (deleted)"
            )
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(
                "/var/lib/nagios3/spool/checkresults/test (path inode=1)"
            )
        )

    def test_valid_deleted_file_var_lib_postgresql(self):
        """
        Test /var/lib/postgresql/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/var/lib/postgresql/test"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/lib/postgresql/test (deleted)")
        )
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/lib/postgresql/test (path inode=1)")
        )

    def test_valid_deleted_file_var_lib_vdr(self):
        """
        Test /var/lib/vdr/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/var/lib/vdr/test"))
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/lib/vdr/test (deleted)")
        )
        self.assertFalse(
            restartcheck._valid_deleted_file("/var/lib/vdr/test (path inode=1)")
        )

    def test_valid_deleted_file_aio(self):
        """
        Test /[aio]/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/opt/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/opt/test (deleted)"))
        self.assertFalse(restartcheck._valid_deleted_file("/opt/test (path inode=1)"))
        self.assertFalse(restartcheck._valid_deleted_file("/apt/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/apt/test (deleted)"))
        self.assertFalse(restartcheck._valid_deleted_file("/apt/test (path inode=1)"))
        self.assertFalse(restartcheck._valid_deleted_file("/ipt/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/ipt/test (deleted)"))
        self.assertFalse(restartcheck._valid_deleted_file("/ipt/test (path inode=1)"))
        self.assertFalse(restartcheck._valid_deleted_file("/aio/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/aio/test (deleted)"))
        self.assertFalse(restartcheck._valid_deleted_file("/aio/test (path inode=1)"))

    def test_valid_deleted_file_sysv(self):
        """
        Test /SYSV/
        """
        self.assertFalse(restartcheck._valid_deleted_file("/SYSV/test"))
        self.assertFalse(restartcheck._valid_deleted_file("/SYSV/test (deleted)"))
        self.assertFalse(restartcheck._valid_deleted_file("/SYSV/test (path inode=1)"))

    def test_valid_command(self):
        """
        test for CVE-2020-28243
        """
        create_file = os.path.join(RUNTIME_VARS.TMP, "created_file")

        patch_kernel = patch(
            "salt.modules.restartcheck._kernel_versions_redhat",
            return_value=["3.10.0-1127.el7.x86_64"],
        )
        services = {
            "NetworkManager": {"ExecMainPID": 123},
            "auditd": {"ExecMainPID": 456},
            "crond": {"ExecMainPID": 789},
        }

        patch_salt = patch.dict(
            restartcheck.__salt__,
            {
                "cmd.run": MagicMock(
                    return_value="Linux localhost.localdomain 3.10.0-1127.el7.x86_64"
                ),
                "service.get_running": MagicMock(return_value=list(services.keys())),
                "service.show": MagicMock(side_effect=list(services.values())),
                "pkg.owner": MagicMock(return_value=""),
                "service.available": MagicMock(return_value=True),
            },
        )

        patch_deleted = patch(
            "salt.modules.restartcheck._deleted_files",
            MagicMock(
                return_value=[
                    (";touch {};".format(create_file), 123, "/root/ (deleted)")
                ]
            ),
        )

        patch_readlink = patch(
            "os.readlink", return_value="/root/;touch {};".format(create_file)
        )

        check_error = True
        if salt.utils.path.which("repoquery"):
            check_error = False

        patch_grains = patch.dict(restartcheck.__grains__, {"os_family": "RedHat"})
        with patch_kernel, patch_salt, patch_deleted, patch_readlink, patch_grains:
            if check_error:
                with self.assertRaises(FileNotFoundError):
                    restartcheck.restartcheck()
            else:
                ret = restartcheck.restartcheck()
                self.assertIn(
                    "Found 1 processes using old versions of upgraded files", ret
                )
            self.assertFalse(os.path.exists(create_file))

    def test_valid_command_b(self):
        """
        test for CVE-2020-28243
        """
        create_file = os.path.join(RUNTIME_VARS.TMP, "created_file")

        patch_kernel = patch(
            "salt.modules.restartcheck._kernel_versions_redhat",
            return_value=["3.10.0-1127.el7.x86_64"],
        )
        services = {
            "NetworkManager": {"ExecMainPID": 123},
            "auditd": {"ExecMainPID": 456},
            "crond": {"ExecMainPID": 789},
        }

        patch_salt = patch.dict(
            restartcheck.__salt__,
            {
                "cmd.run": MagicMock(
                    return_value="Linux localhost.localdomain 3.10.0-1127.el7.x86_64"
                ),
                "service.get_running": MagicMock(return_value=list(services.keys())),
                "service.show": MagicMock(side_effect=list(services.values())),
                "pkg.owner": MagicMock(return_value=""),
                "service.available": MagicMock(return_value=True),
            },
        )

        patch_deleted = patch(
            "salt.modules.restartcheck._deleted_files",
            MagicMock(return_value=[("--admindir tmp dpkg", 123, "/root/ (deleted)")]),
        )

        patch_readlink = patch("os.readlink", return_value="--admindir tmp dpkg")

        popen_mock = MagicMock()
        popen_mock.return_value.stdout.readline.side_effect = ["/usr/bin\n", ""]
        patch_popen = patch("subprocess.Popen", popen_mock)

        patch_grains = patch.dict(restartcheck.__grains__, {"os_family": "RedHat"})
        with patch_kernel, patch_salt, patch_deleted, patch_readlink, patch_grains, patch_popen:
            ret = restartcheck.restartcheck()
            self.assertIn("Found 1 processes using old versions of upgraded files", ret)
            popen_mock.assert_called_with(
                ["repoquery", "-l", "--admindir tmp dpkg"], stdout=ANY
            )
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
