<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_hosts.py & test_restartcheck_1.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_hosts.py & test_restartcheck_1.py
      </h3>
      <h1 align="center">
        7.7%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_hosts.py (8.791209%)<TH>test_restartcheck_1.py (6.8965516%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match31829-0.html#0',2,'match31829-1.html#0',3)" NAME="0">(287-294)<TD><A HREF="javascript:ZweiFrames('match31829-0.html#0',2,'match31829-1.html#0',3)" NAME="0">(29-38)</A><TD ALIGN=center><FONT COLOR="#ff0000">14</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match31829-0.html#1',2,'match31829-1.html#1',3)" NAME="1">(123-125)<TD><A HREF="javascript:ZweiFrames('match31829-0.html#1',2,'match31829-1.html#1',3)" NAME="1">(54-61)</A><TD ALIGN=center><FONT COLOR="#ec0000">13</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match31829-0.html#2',2,'match31829-1.html#2',3)" NAME="2">(7-26)<TD><A HREF="javascript:ZweiFrames('match31829-0.html#2',2,'match31829-1.html#2',3)" NAME="2">(5-23)</A><TD ALIGN=center><FONT COLOR="#ec0000">13</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_hosts.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Jayesh Kariya &lt;jayeshk@saltstack.com&gt;
&quot;&quot;&quot;
<A NAME="2"></A>
import io

<FONT color="#980517"><A HREF="javascript:ZweiFrames('match31829-1.html#2',3,'match31829-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>import salt.modules.hosts as hosts
import salt.utils.data
import salt.utils.platform
import salt.utils.stringutils
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import MagicMock, mock_open, patch
from tests.support.unit import TestCase


class HostsTestCase(TestCase, LoaderModuleMockMixin):
    &quot;&quot;&quot;
    TestCase for salt.modules.hosts
    &quot;&quot;&quot;

    def setup_loader_modules(self):
        return {hosts: {}}

    # 'list_hosts' function tests: 1

    def</B></FONT> test_list_hosts(self):
        &quot;&quot;&quot;
        Tests return the hosts found in the hosts file
        &quot;&quot;&quot;
        with patch(
            &quot;salt.modules.hosts._list_hosts&quot;,
            MagicMock(return_value={&quot;10.10.10.10&quot;: {&quot;aliases&quot;: [&quot;Salt1&quot;, &quot;Salt2&quot;]}}),
        ):
            self.assertDictEqual(
                {&quot;10.10.10.10&quot;: {&quot;aliases&quot;: [&quot;Salt1&quot;, &quot;Salt2&quot;]}}, hosts.list_hosts()
            )

    # 'get_ip' function tests: 3

    def test_get_ip(self):
        &quot;&quot;&quot;
        Tests return ip associated with the named host
        &quot;&quot;&quot;
        with patch(
            &quot;salt.modules.hosts._list_hosts&quot;,
            MagicMock(return_value={&quot;10.10.10.10&quot;: {&quot;aliases&quot;: [&quot;Salt1&quot;, &quot;Salt2&quot;]}}),
        ):
            self.assertEqual(&quot;10.10.10.10&quot;, hosts.get_ip(&quot;Salt1&quot;))

            self.assertEqual(&quot;&quot;, hosts.get_ip(&quot;Salt3&quot;))

    def test_get_ip_none(self):
        &quot;&quot;&quot;
        Tests return ip associated with the named host
        &quot;&quot;&quot;
        with patch(&quot;salt.modules.hosts._list_hosts&quot;, MagicMock(return_value=&quot;&quot;)):
            self.assertEqual(&quot;&quot;, hosts.get_ip(&quot;Salt1&quot;))

    # 'get_alias' function tests: 2

    def test_get_alias(self):
        &quot;&quot;&quot;
        Tests return the list of aliases associated with an ip
        &quot;&quot;&quot;
        with patch(
            &quot;salt.modules.hosts._list_hosts&quot;,
            MagicMock(return_value={&quot;10.10.10.10&quot;: {&quot;aliases&quot;: [&quot;Salt1&quot;, &quot;Salt2&quot;]}}),
        ):
            self.assertListEqual([&quot;Salt1&quot;, &quot;Salt2&quot;], hosts.get_alias(&quot;10.10.10.10&quot;))

    def test_get_alias_none(self):
        &quot;&quot;&quot;
        Tests return the list of aliases associated with an ip
        &quot;&quot;&quot;
        with patch(
            &quot;salt.modules.hosts._list_hosts&quot;,
            MagicMock(return_value={&quot;10.10.10.10&quot;: {&quot;aliases&quot;: [&quot;Salt1&quot;, &quot;Salt2&quot;]}}),
        ):
            self.assertListEqual([], hosts.get_alias(&quot;10.10.10.11&quot;))

    # 'has_pair' function tests: 1

    def test_has_pair(self):
        &quot;&quot;&quot;
        Tests return True / False if the alias is set
        &quot;&quot;&quot;
        with patch(
            &quot;salt.modules.hosts._list_hosts&quot;,
            MagicMock(return_value={&quot;10.10.10.10&quot;: {&quot;aliases&quot;: [&quot;Salt1&quot;, &quot;Salt2&quot;]}}),
        ):
            self.assertTrue(hosts.has_pair(&quot;10.10.10.10&quot;, &quot;Salt1&quot;))

            self.assertFalse(hosts.has_pair(&quot;10.10.10.10&quot;, &quot;Salt3&quot;))

    # 'set_host' function tests: 3

    def test_set_host(self):
        &quot;&quot;&quot;
        Tests true if the alias is set
        &quot;&quot;&quot;
        hosts_file = &quot;/etc/hosts&quot;
        if salt.utils.platform.is_windows():
            hosts_file = r&quot;C:\Windows\System32\Drivers\etc\hosts&quot;

        with patch(
            &quot;salt.modules.hosts.__get_hosts_filename&quot;,
            MagicMock(return_value=hosts_file),
        ), patch(&quot;os.path.isfile&quot;, MagicMock(return_value=False)), patch.dict(
            hosts.__salt__, {&quot;config.option&quot;: MagicMock(return_value=None)}
        ):
            self.assertFalse(hosts.set_host(&quot;10.10.10.10&quot;, &quot;Salt1&quot;))

    def test_set_host_true(self):
        &quot;&quot;&quot;
        Tests true if the alias is set
        &quot;&quot;&quot;
        with patch(
            &quot;salt.modules.hosts.__get_hosts_filename&quot;,
            MagicMock(return_value=&quot;/etc/hosts&quot;),
<A NAME="1"></A>        ), patch(&quot;os.path.isfile&quot;, MagicMock(return_value=True)), patch(
            &quot;salt.utils.files.fopen&quot;, mock_open(b&quot;&quot;)
        ):
            mock_opt <FONT color="#f63526"><A HREF="javascript:ZweiFrames('match31829-1.html#1',3,'match31829-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= MagicMock(return_value=None)
            with patch.dict(hosts.__salt__, {&quot;config.option&quot;: mock_opt}):
                self.assertTrue(hosts.set_host(</B></FONT>&quot;10.10.10.10&quot;, &quot;Salt1&quot;))

    def test_set_host_true_remove(self):
        &quot;&quot;&quot;
        Test if an empty hosts value removes existing entries
        &quot;&quot;&quot;
        with patch(
            &quot;salt.modules.hosts.__get_hosts_filename&quot;,
            MagicMock(return_value=&quot;/etc/hosts&quot;),
        ), patch(&quot;os.path.isfile&quot;, MagicMock(return_value=True)):
            data = [
                &quot;\n&quot;.join(
                    (
                        &quot;1.1.1.1 foo.foofoo foo&quot;,
                        &quot;2.2.2.2 bar.barbar bar&quot;,
                        &quot;3.3.3.3 asdf.asdfadsf asdf&quot;,
                        &quot;1.1.1.1 foofoo.foofoo foofoo&quot;,
                    )
                )
            ]

            class TmpStringIO(io.StringIO):
                def __init__(self, fn, mode=&quot;r&quot;):
                    self.mode = mode
                    initial_value = data[0]
                    if &quot;w&quot; in self.mode:
                        initial_value = &quot;&quot;
                    super().__init__(initial_value)

                def __enter__(self):
                    return self

                def __exit__(self, exc_type, exc_value, traceback):
                    self.close()

                def close(self):
                    # Don't save unless there's something there. In Windows
                    # the class gets initialized the first time with mode = w
                    # which sets the initial value to ''. When the class closes
                    # it clears out data and causes the test to fail.
                    # I don't know why it get's initialized with a mode of 'w'
                    # For the purposes of this test data shouldn't be empty
                    # This is a problem with this class and not with the hosts
                    # module
                    if self.getvalue():
                        data[0] = self.getvalue()
                    io.StringIO.close(self)

                def read(self, *args):
                    ret = super().read(*args)
                    if &quot;b&quot; in self.mode:
                        return salt.utils.stringutils.to_bytes(ret)
                    else:
                        return ret

                def write(self, s, *args):
                    if &quot;b&quot; in self.mode:
                        if not isinstance(s, bytes):
                            # Make this act like a binary filehandle
                            raise TypeError(
                                &quot;a bytes-like object is required, not 'str'&quot;
                            )
                        # The StringIO wants a str type, it won't take
                        # bytes. Convert before writing to it.
                        return super().write(salt.utils.stringutils.to_str(s), *args)
                    else:
                        if not isinstance(s, str):
                            # Make this act like a non-binary filehandle
                            raise TypeError(&quot;write() argument must be str, not bytes&quot;)
                    return super().write(s, *args)

                def readlines(self):
                    ret = super().readlines()
                    if &quot;b&quot; in self.mode:
                        return salt.utils.data.encode(ret)
                    else:
                        return ret

                def writelines(self, lines):
                    for line in lines:
                        self.write(line)

            expected = (
                &quot;\n&quot;.join(
                    (
                        &quot;2.2.2.2 bar.barbar bar&quot;,
                        &quot;3.3.3.3 asdf.asdfadsf asdf&quot;,
                    )
                )
                + &quot;\n&quot;
            )

            with patch(&quot;salt.utils.files.fopen&quot;, TmpStringIO):
                mock_opt = MagicMock(return_value=None)
                with patch.dict(hosts.__salt__, {&quot;config.option&quot;: mock_opt}):
                    self.assertTrue(hosts.set_host(&quot;1.1.1.1&quot;, &quot; &quot;))

            self.assertEqual(data[0], expected)

    # 'rm_host' function tests: 2

    def test_rm_host(self):
        &quot;&quot;&quot;
        Tests if specified host entry gets removed from the hosts file
        &quot;&quot;&quot;
        hosts_content = (
            b&quot;# one line comment\n10.10.10.10    Salt1\n9.9.9.9    Salt2   # comment\n&quot;
        )
        with patch(&quot;salt.utils.files.fopen&quot;, mock_open(hosts_content)), patch(
            &quot;salt.modules.hosts.__get_hosts_filename&quot;,
            MagicMock(return_value=&quot;/etc/hosts&quot;),
        ), patch(&quot;salt.modules.hosts.has_pair&quot;, MagicMock(return_value=True)), patch(
            &quot;os.path.isfile&quot;, MagicMock(return_value=True)
        ):
            mock_opt = MagicMock(return_value=None)
            with patch.dict(hosts.__salt__, {&quot;config.option&quot;: mock_opt}):
                self.assertTrue(hosts.rm_host(&quot;10.10.10.10&quot;, &quot;Salt1&quot;))

    def test_rm_host_false(self):
        &quot;&quot;&quot;
        Tests if specified host entry gets removed from the hosts file
        &quot;&quot;&quot;
        with patch(&quot;salt.modules.hosts.has_pair&quot;, MagicMock(return_value=False)):
            self.assertTrue(hosts.rm_host(&quot;10.10.10.10&quot;, &quot;Salt1&quot;))

    # 'add_host' function tests: 3

    def test_add_host(self):
        &quot;&quot;&quot;
        Tests if specified host entry gets added from the hosts file
        &quot;&quot;&quot;
        hosts_file = &quot;/etc/hosts&quot;
        if salt.utils.platform.is_windows():
            hosts_file = r&quot;C:\Windows\System32\Drivers\etc\hosts&quot;

        with patch(&quot;salt.utils.files.fopen&quot;, mock_open()), patch(
            &quot;salt.modules.hosts.__get_hosts_filename&quot;,
            MagicMock(return_value=hosts_file),
        ):
            mock_opt = MagicMock(return_value=None)
            with patch.dict(hosts.__salt__, {&quot;config.option&quot;: mock_opt}):
                self.assertTrue(hosts.add_host(&quot;10.10.10.10&quot;, &quot;Salt1&quot;))

    def test_add_host_no_file(self):
        &quot;&quot;&quot;
        Tests if specified host entry gets added from the hosts file
        &quot;&quot;&quot;
        with patch(&quot;salt.utils.files.fopen&quot;, mock_open()), patch(
            &quot;os.path.isfile&quot;, MagicMock(return_value=False)
        ):
            mock_opt = MagicMock(return_value=None)
            with patch.dict(hosts.__salt__, {&quot;config.option&quot;: mock_opt}):
                self.assertFalse(hosts.add_host(&quot;10.10.10.10&quot;, &quot;Salt1&quot;))

    def test_add_host_create_entry(self):
        &quot;&quot;&quot;
        Tests if specified host entry gets added from the hosts file
        &quot;&quot;&quot;
        with patch(&quot;salt.utils.files.fopen&quot;, mock_open()), patch(
<A NAME="0"></A>            &quot;os.path.isfile&quot;, MagicMock(return_value=True)
        ):
            mock_opt = MagicMock(return_value=None)
            <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match31829-1.html#0',3,'match31829-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>with patch.dict(hosts.__salt__, {&quot;config.option&quot;: mock_opt}):
                self.assertTrue(hosts.add_host(&quot;10.10.10.10&quot;, &quot;Salt1&quot;))

    def test_set_comment(self):
        &quot;&quot;&quot;
        Tests return True / False when setting a comment
        &quot;&quot;&quot;
        hosts_file =</B></FONT> &quot;/etc/hosts&quot;
        if salt.utils.platform.is_windows():
            hosts_file = r&quot;C:\Windows\System32\Drivers\etc\hosts&quot;

        with patch(&quot;salt.utils.files.fopen&quot;, mock_open()), patch(
            &quot;salt.modules.hosts.__get_hosts_filename&quot;,
            MagicMock(return_value=hosts_file),
        ):
            mock_opt = MagicMock(return_value=None)
            with patch.dict(hosts.__salt__, {&quot;config.option&quot;: mock_opt}):
                with patch(
                    &quot;salt.modules.hosts._list_hosts&quot;,
                    MagicMock(
                        return_value={&quot;10.10.10.10&quot;: {&quot;aliases&quot;: [&quot;Salt1&quot;, &quot;Salt2&quot;]}}
                    ),
                ):
                    self.assertTrue(hosts.set_comment(&quot;10.10.10.10&quot;, &quot;A comment&quot;))

                    self.assertFalse(hosts.set_comment(&quot;10.10.10.11&quot;, &quot;A comment&quot;))
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_restartcheck_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
<A NAME="2"></A>    :codeauthor: :email:`David Homolka &lt;david.homolka@ultimum.io&gt;`
&quot;&quot;&quot;

<FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match31829-0.html#2',2,'match31829-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>import os

import salt.modules.restartcheck as restartcheck
import salt.utils.path
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import ANY, MagicMock, patch
from tests.support.runtests import RUNTIME_VARS
from tests.support.unit import TestCase


class RestartcheckTestCase(TestCase, LoaderModuleMockMixin):
    &quot;&quot;&quot;
    Test cases for salt.modules.restartcheck
    &quot;&quot;&quot;

    def setup_loader_modules(self):
        return {restartcheck: {}}

    def</B></FONT> test_kernel_versions_debian(self):
        &quot;&quot;&quot;
        Test kernel version debian
<A NAME="0"></A>        &quot;&quot;&quot;
        mock = MagicMock(return_value=&quot;  Installed: 4.9.82-1+deb9u3&quot;)
        with patch.dict(restartcheck.__grains__, {&quot;os&quot;: &quot;Debian&quot;}):
            <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match31829-0.html#0',2,'match31829-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>with patch.dict(restartcheck.__salt__, {&quot;cmd.run&quot;: mock}):
                self.assertListEqual(
                    restartcheck._kernel_versions_debian(), [&quot;4.9.82-1+deb9u3&quot;]
                )

    def test_kernel_versions_ubuntu(self):
        &quot;&quot;&quot;
        Test kernel version ubuntu
        &quot;&quot;&quot;
        mock =</B></FONT> MagicMock(return_value=&quot;  Installed: 4.10.0-42.46&quot;)
        with patch.dict(restartcheck.__grains__, {&quot;os&quot;: &quot;Ubuntu&quot;}):
            with patch.dict(restartcheck.__salt__, {&quot;cmd.run&quot;: mock}):
                self.assertListEqual(
                    restartcheck._kernel_versions_debian(),
                    [
                        &quot;4.10.0-42.46&quot;,
                        &quot;4.10.0-42-generic #46&quot;,
                        &quot;4.10.0-42-lowlatency #46&quot;,
                    ],
                )

    def test_kernel_versions_redhat(self):
<A NAME="1"></A>        &quot;&quot;&quot;
        Test if it return a data structure of the current, in-memory rules
        &quot;&quot;&quot;
        mock <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match31829-0.html#1',2,'match31829-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= MagicMock(
            return_value=(
                &quot;kernel-3.10.0-862.el7.x86_64                  Thu Apr 5 00:40:00 2018&quot;
            )
        )
        with patch.dict(restartcheck.__salt__, {&quot;cmd.run&quot;: mock}):
            self.assertListEqual(
                restartcheck._kernel_versions_redhat(</B></FONT>), [&quot;3.10.0-862.el7.x86_64&quot;]
            )

    def test_valid_deleted_file_deleted(self):
        &quot;&quot;&quot;
        Test (deleted) file
        &quot;&quot;&quot;
        self.assertTrue(restartcheck._valid_deleted_file(&quot;/usr/lib/test (deleted)&quot;))

    def test_valid_deleted_file_psth_inode(self):
        &quot;&quot;&quot;
        Test (path inode=1) file
        &quot;&quot;&quot;
        self.assertTrue(
            restartcheck._valid_deleted_file(&quot;/usr/lib/test (path inode=1)&quot;)
        )

    def test_valid_deleted_file_var_log(self):
        &quot;&quot;&quot;
        Test /var/log/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/var/log/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/var/log/test (deleted)&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/log/test (path inode=1)&quot;)
        )

    def test_valid_deleted_file_var_local_log(self):
        &quot;&quot;&quot;
        Test /var/local/log/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/var/local/log/test&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/local/log/test (deleted)&quot;)
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/local/log/test (path inode=1)&quot;)
        )

    def test_valid_deleted_file_var_run(self):
        &quot;&quot;&quot;
        Test /var/run/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/var/run/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/var/run/test (deleted)&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/run/test (path inode=1)&quot;)
        )

    def test_valid_deleted_file_var_local_run(self):
        &quot;&quot;&quot;
        Test /var/local/run/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/var/local/run/test&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/local/run/test (deleted)&quot;)
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/local/run/test (path inode=1)&quot;)
        )

    def test_valid_deleted_file_tmp(self):
        &quot;&quot;&quot;
        Test /tmp/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/tmp/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/tmp/test (deleted)&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/tmp/test (path inode=1)&quot;))

    def test_valid_deleted_file_dev_shm(self):
        &quot;&quot;&quot;
        Test /dev/shm/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/dev/shm/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/dev/shm/test (deleted)&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/dev/shm/test (path inode=1)&quot;)
        )

    def test_valid_deleted_file_run(self):
        &quot;&quot;&quot;
        Test /run/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/run/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/run/test (deleted)&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/run/test (path inode=1)&quot;))

    def test_valid_deleted_file_drm(self):
        &quot;&quot;&quot;
        Test /drm/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/drm/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/drm/test (deleted)&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/drm/test (path inode=1)&quot;))

    def test_valid_deleted_file_var_tmp(self):
        &quot;&quot;&quot;
        Test /var/tmp/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/var/tmp/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/var/tmp/test (deleted)&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/tmp/test (path inode=1)&quot;)
        )

    def test_valid_deleted_file_var_local_tmp(self):
        &quot;&quot;&quot;
        Test /var/local/tmp/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/var/local/tmp/test&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/local/tmp/test (deleted)&quot;)
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/local/tmp/test (path inode=1)&quot;)
        )

    def test_valid_deleted_file_dev_zero(self):
        &quot;&quot;&quot;
        Test /dev/zero/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/dev/zero/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/dev/zero/test (deleted)&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/dev/zero/test (path inode=1)&quot;)
        )

    def test_valid_deleted_file_dev_pts(self):
        &quot;&quot;&quot;
        Test /dev/pts/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/dev/pts/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/dev/pts/test (deleted)&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/dev/pts/test (path inode=1)&quot;)
        )

    def test_valid_deleted_file_usr_lib_locale(self):
        &quot;&quot;&quot;
        Test /usr/lib/locale/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/usr/lib/locale/test&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/usr/lib/locale/test (deleted)&quot;)
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/usr/lib/locale/test (path inode=1)&quot;)
        )

    def test_valid_deleted_file_home(self):
        &quot;&quot;&quot;
        Test /home/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/home/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/home/test (deleted)&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/home/test (path inode=1)&quot;))

    def test_valid_deleted_file_icon_theme_cache(self):
        &quot;&quot;&quot;
        Test /test.icon-theme.cache
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/dev/test.icon-theme.cache&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/dev/test.icon-theme.cache (deleted)&quot;)
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(
                &quot;/dev/test.icon-theme.cache (path inode=1)&quot;
            )
        )

    def test_valid_deleted_file_var_cache_fontconfig(self):
        &quot;&quot;&quot;
        Test /var/cache/fontconfig/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/var/cache/fontconfig/test&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/cache/fontconfig/test (deleted)&quot;)
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(
                &quot;/var/cache/fontconfig/test (path inode=1)&quot;
            )
        )

    def test_valid_deleted_file_var_lib_nagios3_spool(self):
        &quot;&quot;&quot;
        Test /var/lib/nagios3/spool/
        &quot;&quot;&quot;
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/lib/nagios3/spool/test&quot;)
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/lib/nagios3/spool/test (deleted)&quot;)
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(
                &quot;/var/lib/nagios3/spool/test (path inode=1)&quot;
            )
        )

    def test_valid_deleted_file_var_lib_nagios3_spool_checkresults(self):
        &quot;&quot;&quot;
        Test /var/lib/nagios3/spool/checkresults/
        &quot;&quot;&quot;
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/lib/nagios3/spool/checkresults/test&quot;)
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(
                &quot;/var/lib/nagios3/spool/checkresults/test (deleted)&quot;
            )
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(
                &quot;/var/lib/nagios3/spool/checkresults/test (path inode=1)&quot;
            )
        )

    def test_valid_deleted_file_var_lib_postgresql(self):
        &quot;&quot;&quot;
        Test /var/lib/postgresql/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/var/lib/postgresql/test&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/lib/postgresql/test (deleted)&quot;)
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/lib/postgresql/test (path inode=1)&quot;)
        )

    def test_valid_deleted_file_var_lib_vdr(self):
        &quot;&quot;&quot;
        Test /var/lib/vdr/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/var/lib/vdr/test&quot;))
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/lib/vdr/test (deleted)&quot;)
        )
        self.assertFalse(
            restartcheck._valid_deleted_file(&quot;/var/lib/vdr/test (path inode=1)&quot;)
        )

    def test_valid_deleted_file_aio(self):
        &quot;&quot;&quot;
        Test /[aio]/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/opt/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/opt/test (deleted)&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/opt/test (path inode=1)&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/apt/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/apt/test (deleted)&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/apt/test (path inode=1)&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/ipt/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/ipt/test (deleted)&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/ipt/test (path inode=1)&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/aio/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/aio/test (deleted)&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/aio/test (path inode=1)&quot;))

    def test_valid_deleted_file_sysv(self):
        &quot;&quot;&quot;
        Test /SYSV/
        &quot;&quot;&quot;
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/SYSV/test&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/SYSV/test (deleted)&quot;))
        self.assertFalse(restartcheck._valid_deleted_file(&quot;/SYSV/test (path inode=1)&quot;))

    def test_valid_command(self):
        &quot;&quot;&quot;
        test for CVE-2020-28243
        &quot;&quot;&quot;
        create_file = os.path.join(RUNTIME_VARS.TMP, &quot;created_file&quot;)

        patch_kernel = patch(
            &quot;salt.modules.restartcheck._kernel_versions_redhat&quot;,
            return_value=[&quot;3.10.0-1127.el7.x86_64&quot;],
        )
        services = {
            &quot;NetworkManager&quot;: {&quot;ExecMainPID&quot;: 123},
            &quot;auditd&quot;: {&quot;ExecMainPID&quot;: 456},
            &quot;crond&quot;: {&quot;ExecMainPID&quot;: 789},
        }

        patch_salt = patch.dict(
            restartcheck.__salt__,
            {
                &quot;cmd.run&quot;: MagicMock(
                    return_value=&quot;Linux localhost.localdomain 3.10.0-1127.el7.x86_64&quot;
                ),
                &quot;service.get_running&quot;: MagicMock(return_value=list(services.keys())),
                &quot;service.show&quot;: MagicMock(side_effect=list(services.values())),
                &quot;pkg.owner&quot;: MagicMock(return_value=&quot;&quot;),
                &quot;service.available&quot;: MagicMock(return_value=True),
            },
        )

        patch_deleted = patch(
            &quot;salt.modules.restartcheck._deleted_files&quot;,
            MagicMock(
                return_value=[
                    (&quot;;touch {};&quot;.format(create_file), 123, &quot;/root/ (deleted)&quot;)
                ]
            ),
        )

        patch_readlink = patch(
            &quot;os.readlink&quot;, return_value=&quot;/root/;touch {};&quot;.format(create_file)
        )

        check_error = True
        if salt.utils.path.which(&quot;repoquery&quot;):
            check_error = False

        patch_grains = patch.dict(restartcheck.__grains__, {&quot;os_family&quot;: &quot;RedHat&quot;})
        with patch_kernel, patch_salt, patch_deleted, patch_readlink, patch_grains:
            if check_error:
                with self.assertRaises(FileNotFoundError):
                    restartcheck.restartcheck()
            else:
                ret = restartcheck.restartcheck()
                self.assertIn(
                    &quot;Found 1 processes using old versions of upgraded files&quot;, ret
                )
            self.assertFalse(os.path.exists(create_file))

    def test_valid_command_b(self):
        &quot;&quot;&quot;
        test for CVE-2020-28243
        &quot;&quot;&quot;
        create_file = os.path.join(RUNTIME_VARS.TMP, &quot;created_file&quot;)

        patch_kernel = patch(
            &quot;salt.modules.restartcheck._kernel_versions_redhat&quot;,
            return_value=[&quot;3.10.0-1127.el7.x86_64&quot;],
        )
        services = {
            &quot;NetworkManager&quot;: {&quot;ExecMainPID&quot;: 123},
            &quot;auditd&quot;: {&quot;ExecMainPID&quot;: 456},
            &quot;crond&quot;: {&quot;ExecMainPID&quot;: 789},
        }

        patch_salt = patch.dict(
            restartcheck.__salt__,
            {
                &quot;cmd.run&quot;: MagicMock(
                    return_value=&quot;Linux localhost.localdomain 3.10.0-1127.el7.x86_64&quot;
                ),
                &quot;service.get_running&quot;: MagicMock(return_value=list(services.keys())),
                &quot;service.show&quot;: MagicMock(side_effect=list(services.values())),
                &quot;pkg.owner&quot;: MagicMock(return_value=&quot;&quot;),
                &quot;service.available&quot;: MagicMock(return_value=True),
            },
        )

        patch_deleted = patch(
            &quot;salt.modules.restartcheck._deleted_files&quot;,
            MagicMock(return_value=[(&quot;--admindir tmp dpkg&quot;, 123, &quot;/root/ (deleted)&quot;)]),
        )

        patch_readlink = patch(&quot;os.readlink&quot;, return_value=&quot;--admindir tmp dpkg&quot;)

        popen_mock = MagicMock()
        popen_mock.return_value.stdout.readline.side_effect = [&quot;/usr/bin\n&quot;, &quot;&quot;]
        patch_popen = patch(&quot;subprocess.Popen&quot;, popen_mock)

        patch_grains = patch.dict(restartcheck.__grains__, {&quot;os_family&quot;: &quot;RedHat&quot;})
        with patch_kernel, patch_salt, patch_deleted, patch_readlink, patch_grains, patch_popen:
            ret = restartcheck.restartcheck()
            self.assertIn(&quot;Found 1 processes using old versions of upgraded files&quot;, ret)
            popen_mock.assert_called_with(
                [&quot;repoquery&quot;, &quot;-l&quot;, &quot;--admindir tmp dpkg&quot;], stdout=ANY
            )
</PRE>
</div>
  </div>
</body>
</html>
