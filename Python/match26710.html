<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for rdp_1.py & rabbitmq_policy.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for rdp_1.py & rabbitmq_policy.py
      </h3>
      <h1 align="center">
        8.6%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>rdp_1.py (8.5561495%)<TH>rabbitmq_policy.py (8.695652%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match26710-0.html#0',2,'match26710-1.html#0',3)" NAME="0">(19-36)<TD><A HREF="javascript:ZweiFrames('match26710-0.html#0',2,'match26710-1.html#0',3)" NAME="0">(25-38)</A><TD ALIGN=center><FONT COLOR="#ff0000">16</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>rdp_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
Manage RDP Service on Windows servers
&quot;&quot;&quot;

import logging
import re

import salt.utils.platform
from salt.utils.decorators import depends

try:
    from pywintypes import error as PyWinError
    import win32ts

    _HAS_WIN32TS_DEPENDENCIES = True
<A NAME="0"></A>except ImportError:
    _HAS_WIN32TS_DEPENDENCIES = False

_LOG <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match26710-1.html#0',3,'match26710-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= logging.getLogger(__name__)


def __virtual__():
    &quot;&quot;&quot;
    Only works on Windows systems
    &quot;&quot;&quot;
    if salt.utils.platform.is_windows():
        return &quot;rdp&quot;
    return (False, &quot;Module only works on Windows.&quot;)


def _parse_return_code_powershell(string):
    &quot;&quot;&quot;
    return from the input string the return code of the powershell command
    &quot;&quot;&quot;

    regex =</B></FONT> re.search(r&quot;ReturnValue\s*: (\d*)&quot;, string)
    if not regex:
        return (False, &quot;Could not parse PowerShell return code.&quot;)
    else:
        return int(regex.group(1))


def _psrdp(cmd):
    &quot;&quot;&quot;
    Create a Win32_TerminalServiceSetting WMI Object as $RDP and execute the
    command cmd returns the STDOUT of the command
    &quot;&quot;&quot;
    rdp = (
        &quot;$RDP = Get-WmiObject -Class Win32_TerminalServiceSetting &quot;
        &quot;-Namespace root\\CIMV2\\TerminalServices -Computer . &quot;
        &quot;-Authentication 6 -ErrorAction Stop&quot;
    )
    return __salt__[&quot;cmd.run&quot;](
        &quot;{} ; {}&quot;.format(rdp, cmd), shell=&quot;powershell&quot;, python_shell=True
    )


def enable():
    &quot;&quot;&quot;
    Enable RDP the service on the server

    CLI Example:

    .. code-block:: bash

        salt '*' rdp.enable
    &quot;&quot;&quot;

    return _parse_return_code_powershell(_psrdp(&quot;$RDP.SetAllowTsConnections(1,1)&quot;)) == 0


def disable():
    &quot;&quot;&quot;
    Disable RDP the service on the server

    CLI Example:

    .. code-block:: bash

        salt '*' rdp.disable
    &quot;&quot;&quot;

    return _parse_return_code_powershell(_psrdp(&quot;$RDP.SetAllowTsConnections(0,1)&quot;)) == 0


def status():
    &quot;&quot;&quot;
    Show if rdp is enabled on the server

    CLI Example:

    .. code-block:: bash

        salt '*' rdp.status
    &quot;&quot;&quot;

    out = int(_psrdp(&quot;echo $RDP.AllowTSConnections&quot;).strip())
    return out != 0


@depends(_HAS_WIN32TS_DEPENDENCIES)
def list_sessions(logged_in_users_only=False):
    &quot;&quot;&quot;
    List information about the sessions.

    .. versionadded:: 2016.11.0

    :param logged_in_users_only: If True, only return sessions with users logged in.
    :return: A list containing dictionaries of session information.

    CLI Example:

    .. code-block:: bash

        salt '*' rdp.list_sessions
    &quot;&quot;&quot;
    ret = list()
    server = win32ts.WTS_CURRENT_SERVER_HANDLE
    protocols = {
        win32ts.WTS_PROTOCOL_TYPE_CONSOLE: &quot;console&quot;,
        win32ts.WTS_PROTOCOL_TYPE_ICA: &quot;citrix&quot;,
        win32ts.WTS_PROTOCOL_TYPE_RDP: &quot;rdp&quot;,
    }
    statuses = {
        win32ts.WTSActive: &quot;active&quot;,
        win32ts.WTSConnected: &quot;connected&quot;,
        win32ts.WTSConnectQuery: &quot;connect_query&quot;,
        win32ts.WTSShadow: &quot;shadow&quot;,
        win32ts.WTSDisconnected: &quot;disconnected&quot;,
        win32ts.WTSIdle: &quot;idle&quot;,
        win32ts.WTSListen: &quot;listen&quot;,
        win32ts.WTSReset: &quot;reset&quot;,
        win32ts.WTSDown: &quot;down&quot;,
        win32ts.WTSInit: &quot;init&quot;,
    }

    for session in win32ts.WTSEnumerateSessions(server):
        user = (
            win32ts.WTSQuerySessionInformation(
                server, session[&quot;SessionId&quot;], win32ts.WTSUserName
            )
            or None
        )
        protocol_id = win32ts.WTSQuerySessionInformation(
            server, session[&quot;SessionId&quot;], win32ts.WTSClientProtocolType
        )
        status_id = win32ts.WTSQuerySessionInformation(
            server, session[&quot;SessionId&quot;], win32ts.WTSConnectState
        )
        protocol = protocols.get(protocol_id, &quot;unknown&quot;)
        connection_status = statuses.get(status_id, &quot;unknown&quot;)
        station = session[&quot;WinStationName&quot;] or &quot;Disconnected&quot;
        connection_info = {
            &quot;connection_status&quot;: connection_status,
            &quot;protocol&quot;: protocol,
            &quot;session_id&quot;: session[&quot;SessionId&quot;],
            &quot;station&quot;: station,
            &quot;user&quot;: user,
        }
        if logged_in_users_only:
            if user:
                ret.append(connection_info)
        else:
            ret.append(connection_info)

    if not ret:
        _LOG.warning(&quot;No sessions found.&quot;)
    return sorted(ret, key=lambda k: k[&quot;session_id&quot;])


@depends(_HAS_WIN32TS_DEPENDENCIES)
def get_session(session_id):
    &quot;&quot;&quot;
    Get information about a session.

    .. versionadded:: 2016.11.0

    :param session_id: The numeric Id of the session.
    :return: A dictionary of session information.

    CLI Example:

    .. code-block:: bash

        salt '*' rdp.get_session session_id

        salt '*' rdp.get_session 99
    &quot;&quot;&quot;
    ret = dict()
    sessions = list_sessions()
    session = [item for item in sessions if item[&quot;session_id&quot;] == session_id]

    if session:
        ret = session[0]

    if not ret:
        _LOG.warning(&quot;No session found for id: %s&quot;, session_id)
    return ret


@depends(_HAS_WIN32TS_DEPENDENCIES)
def disconnect_session(session_id):
    &quot;&quot;&quot;
    Disconnect a session.

    .. versionadded:: 2016.11.0

    :param session_id: The numeric Id of the session.
    :return: A boolean representing whether the disconnect succeeded.

    CLI Example:

    .. code-block:: bash

        salt '*' rdp.disconnect_session session_id

        salt '*' rdp.disconnect_session 99
    &quot;&quot;&quot;
    try:
        win32ts.WTSDisconnectSession(
            win32ts.WTS_CURRENT_SERVER_HANDLE, session_id, True
        )
    except PyWinError as error:
        _LOG.error(&quot;Error calling WTSDisconnectSession: %s&quot;, error)
        return False
    return True


@depends(_HAS_WIN32TS_DEPENDENCIES)
def logoff_session(session_id):
    &quot;&quot;&quot;
    Initiate the logoff of a session.

    .. versionadded:: 2016.11.0

    :param session_id: The numeric Id of the session.
    :return: A boolean representing whether the logoff succeeded.

    CLI Example:

    .. code-block:: bash

        salt '*' rdp.logoff_session session_id

        salt '*' rdp.logoff_session 99
    &quot;&quot;&quot;
    try:
        win32ts.WTSLogoffSession(win32ts.WTS_CURRENT_SERVER_HANDLE, session_id, True)
    except PyWinError as error:
        _LOG.error(&quot;Error calling WTSLogoffSession: %s&quot;, error)
        return False
    return True
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>rabbitmq_policy.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
Manage RabbitMQ Policies
========================

:maintainer:    Benn Eichhorn &lt;benn@getlocalmeasure.com&gt;
:maturity:      new
:platform:      all

Example:

.. code-block:: yaml

    rabbit_policy:
      rabbitmq_policy.present:
        - name: HA
        - pattern: '.*'
        - definition: '{&quot;ha-mode&quot;: &quot;all&quot;}'
&quot;&quot;&quot;

import json
import logging
<A NAME="0"></A>
import salt.utils.path

log <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match26710-0.html#0',2,'match26710-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= logging.getLogger(__name__)


def __virtual__():
    &quot;&quot;&quot;
    Only load if RabbitMQ is installed.
    &quot;&quot;&quot;
    if salt.utils.path.which(&quot;rabbitmqctl&quot;):
        return True
    return (False, &quot;Command not found: rabbitmqctl&quot;)


def present(
    name, pattern, definition, priority=</B></FONT>0, vhost=&quot;/&quot;, runas=None, apply_to=None
):
    &quot;&quot;&quot;
    Ensure the RabbitMQ policy exists.

    Reference: http://www.rabbitmq.com/ha.html

    name
        Policy name
    pattern
        A regex of queues to apply the policy to
    definition
        A json dict describing the policy
    priority
        Priority (defaults to 0)
    vhost
        Virtual host to apply to (defaults to '/')
    runas
        Name of the user to run the command as
    apply_to
        Apply policy to 'queues', 'exchanges' or 'all' (default to 'all')
    &quot;&quot;&quot;
    ret = {&quot;name&quot;: name, &quot;result&quot;: True, &quot;comment&quot;: &quot;&quot;, &quot;changes&quot;: {}}
    result = {}

    policies = __salt__[&quot;rabbitmq.list_policies&quot;](vhost=vhost, runas=runas)
    policy = policies.get(vhost, {}).get(name)
    updates = []
    if policy:
        if policy.get(&quot;pattern&quot;) != pattern:
            updates.append(&quot;Pattern&quot;)
        current_definition = policy.get(&quot;definition&quot;)
        current_definition = (
            json.loads(current_definition) if current_definition else &quot;&quot;
        )
        new_definition = json.loads(definition) if definition else &quot;&quot;
        if current_definition != new_definition:
            updates.append(&quot;Definition&quot;)
        if apply_to and (policy.get(&quot;apply-to&quot;) != apply_to):
            updates.append(&quot;Applyto&quot;)
        if int(policy.get(&quot;priority&quot;)) != priority:
            updates.append(&quot;Priority&quot;)

    if policy and not updates:
        ret[&quot;comment&quot;] = &quot;Policy {} {} is already present&quot;.format(vhost, name)
        return ret

    if not policy:
        ret[&quot;changes&quot;].update({&quot;old&quot;: {}, &quot;new&quot;: name})
        if __opts__[&quot;test&quot;]:
            ret[&quot;comment&quot;] = &quot;Policy {} {} is set to be created&quot;.format(vhost, name)
        else:
            log.debug(&quot;Policy doesn't exist - Creating&quot;)
            result = __salt__[&quot;rabbitmq.set_policy&quot;](
                vhost,
                name,
                pattern,
                definition,
                priority=priority,
                runas=runas,
                apply_to=apply_to,
            )
    elif updates:
        ret[&quot;changes&quot;].update({&quot;old&quot;: policy, &quot;new&quot;: updates})
        if __opts__[&quot;test&quot;]:
            ret[&quot;comment&quot;] = &quot;Policy {} {} is set to be updated&quot;.format(vhost, name)
        else:
            log.debug(&quot;Policy exists but needs updating&quot;)
            result = __salt__[&quot;rabbitmq.set_policy&quot;](
                vhost,
                name,
                pattern,
                definition,
                priority=priority,
                runas=runas,
                apply_to=apply_to,
            )

    if &quot;Error&quot; in result:
        ret[&quot;result&quot;] = False
        ret[&quot;comment&quot;] = result[&quot;Error&quot;]
    elif ret[&quot;changes&quot;] == {}:
        ret[&quot;comment&quot;] = &quot;'{}' is already in the desired state.&quot;.format(name)
    elif __opts__[&quot;test&quot;]:
        ret[&quot;result&quot;] = None
    elif &quot;Set&quot; in result:
        ret[&quot;comment&quot;] = result[&quot;Set&quot;]

    return ret


def absent(name, vhost=&quot;/&quot;, runas=None):
    &quot;&quot;&quot;
    Ensure the named policy is absent

    Reference: http://www.rabbitmq.com/ha.html

    name
        The name of the policy to remove
    runas
        Name of the user to run the command as
    &quot;&quot;&quot;
    ret = {&quot;name&quot;: name, &quot;result&quot;: True, &quot;comment&quot;: &quot;&quot;, &quot;changes&quot;: {}}

    policy_exists = __salt__[&quot;rabbitmq.policy_exists&quot;](vhost, name, runas=runas)

    if not policy_exists:
        ret[&quot;comment&quot;] = &quot;Policy '{} {}' is not present.&quot;.format(vhost, name)
        return ret

    if not __opts__[&quot;test&quot;]:
        result = __salt__[&quot;rabbitmq.delete_policy&quot;](vhost, name, runas=runas)
        if &quot;Error&quot; in result:
            ret[&quot;result&quot;] = False
            ret[&quot;comment&quot;] = result[&quot;Error&quot;]
            return ret
        elif &quot;Deleted&quot; in result:
            ret[&quot;comment&quot;] = &quot;Deleted&quot;

    # If we've reached this far before returning, we have changes.
    ret[&quot;changes&quot;] = {&quot;new&quot;: &quot;&quot;, &quot;old&quot;: name}

    if __opts__[&quot;test&quot;]:
        ret[&quot;result&quot;] = None
        ret[&quot;comment&quot;] = &quot;Policy '{} {}' will be removed.&quot;.format(vhost, name)

    return ret
</PRE>
</div>
  </div>
</body>
</html>
