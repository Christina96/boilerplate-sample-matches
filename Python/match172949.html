<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for cmdmod.py &amp; network_4.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for cmdmod.py &amp; network_4.py
      </h3>
<h1 align="center">
        2.0%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>cmdmod.py (2.0475562%)<th>network_4.py (1.9564531%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(19-49)<td><a href="#" name="0">(7-32)</a><td align="center"><font color="#ff0000">24</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(4391-4395)<td><a href="#" name="1">(819-823)</a><td align="center"><font color="#8a0000">13</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(4039-4043)<td><a href="#" name="2">(799-804)</a><td align="center"><font color="#8a0000">13</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(2838-2841)<td><a href="#" name="3">(974-977)</a><td align="center"><font color="#7f0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>cmdmod.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import base64
2 import fnmatch
3 import functools
4 import glob
5 import logging
6 import os
7 import re
8 import shutil
9 import sys
10 import tempfile
11 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import time
12 import traceback
13 import salt.grains.extra
14 import salt.utils.args
15 import salt.utils.data
16 import salt.utils.files
17 import salt.utils.json
18 import salt.utils.path
19 import salt.utils.platform
20 import salt.utils.powershell
21 import salt.utils.stringutils
22 import salt.utils.templates
23 import salt.utils.timed_subprocess
24 import salt.utils.url
25 import salt.utils.user
26 import salt.utils.versions
27 import salt.utils.vt
28 import salt.utils.win_chcp
29 import salt.utils.win_dacl
30 import salt.utils.win_reg
31 from salt.exceptions import (
32     CommandExecutionError,
33     SaltInvocationError,
34     TimedProcTimeoutError,
35 )
36 from salt.log import LOG_LEVELS
37 try:
38     import</b></font> grp
39     import pwd
40 except ImportError:
41     pass
42 if salt.utils.platform.is_windows():
43     from salt.utils.win_functions import escape_argument as _cmd_quote
44     from salt.utils.win_runas import runas as win_runas
45     HAS_WIN_RUNAS = True
46 else:
47     import shlex
48     _cmd_quote = shlex.quote
49     HAS_WIN_RUNAS = False
50 __proxyenabled__ = ["*"]
51 __virtualname__ = "cmd"
52 log = logging.getLogger(__name__)
53 DEFAULT_SHELL = salt.grains.extra.shell()["shell"]
54 def __virtual__():
55     return __virtualname__
56 def _log_cmd(cmd):
57     if isinstance(cmd, (tuple, list)):
58         return cmd[0].strip()
59     else:
60         return str(cmd).split()[0].strip()
61 def _check_cb(cb_):
62     if cb_ is not None:
63         if hasattr(cb_, "__call__"):
64             return cb_
65         else:
66             log.error("log_callback is not callable, ignoring")
67     return lambda x: x
68 def _python_shell_default(python_shell, __pub_jid):
69     try:
70         if __pub_jid and python_shell is None:
71             return True
72         elif __opts__.get("cmd_safe", True) is False and python_shell is None:
73             return True
74     except NameError:
75         pass
76     return python_shell
77 def _chroot_pids(chroot):
78     pids = []
79     for root in glob.glob("/proc/[0-9]*/root"):
80         try:
81             link = os.path.realpath(root)
82             if link.startswith(chroot):
83                 pids.append(int(os.path.basename(os.path.dirname(root))))
84         except OSError:
85             pass
86     return pids
87 def _render_cmd(cmd, cwd, template, saltenv=None, pillarenv=None, pillar_override=None):
88     if saltenv is None:
89         try:
90             saltenv = __opts__.get("saltenv", "base")
91         except NameError:
92             saltenv = "base"
93     if not template:
94         return (cmd, cwd)
95     if template not in salt.utils.templates.TEMPLATE_REGISTRY:
96         raise CommandExecutionError(
97             "Attempted to render file paths with unavailable engine {}".format(template)
98         )
99     kwargs = {}
100     kwargs["salt"] = __salt__
101     if pillarenv is not None or pillar_override is not None:
102         pillarenv = pillarenv or __opts__["pillarenv"]
103         kwargs["pillar"] = _gather_pillar(pillarenv, pillar_override)
104     else:
105         kwargs["pillar"] = __pillar__
106     kwargs["grains"] = __grains__
107     kwargs["opts"] = __opts__
108     kwargs["saltenv"] = saltenv
109     def _render(contents):
110         tmp_path_fn = salt.utils.files.mkstemp()
111         with salt.utils.files.fopen(tmp_path_fn, "w+") as fp_:
112             fp_.write(salt.utils.stringutils.to_str(contents))
113         data = salt.utils.templates.TEMPLATE_REGISTRY[template](
114             tmp_path_fn, to_str=True, **kwargs
115         )
116         salt.utils.files.safe_rm(tmp_path_fn)
117         if not data["result"]:
118             raise CommandExecutionError(
119                 "Failed to execute cmd with error: {}".format(data["data"])
120             )
121         else:
122             return data["data"]
123     cmd = _render(cmd)
124     cwd = _render(cwd)
125     return (cmd, cwd)
126 def _check_loglevel(level="info"):
127     try:
128         level = level.lower()
129         if level == "quiet":
130             return None
131         else:
132             return LOG_LEVELS[level]
133     except (AttributeError, KeyError):
134         log.error(
135             "Invalid output_loglevel '%s'. Valid levels are: %s. Falling "
136             "back to 'info'.",
137             level,
138             ", ".join(sorted(LOG_LEVELS, reverse=True)),
139         )
140         return LOG_LEVELS["info"]
141 def _parse_env(env):
142     if not env:
143         env = {}
144     if isinstance(env, list):
145         env = salt.utils.data.repack_dictlist(env)
146     if not isinstance(env, dict):
147         env = {}
148     return env
149 def _gather_pillar(pillarenv, pillar_override):
150     pillar = salt.pillar.get_pillar(
151         __opts__,
152         __grains__,
153         __opts__["id"],
154         __opts__["saltenv"],
155         pillar_override=pillar_override,
156         pillarenv=pillarenv,
157     )
158     ret = pillar.compile_pillar()
159     if pillar_override and isinstance(pillar_override, dict):
160         ret.update(pillar_override)
161     return ret
162 def _check_avail(cmd):
163     if isinstance(cmd, list):
164         cmd = " ".join([str(x) if not isinstance(x, str) else x for x in cmd])
165     bret = True
166     wret = False
167     if __salt__["config.get"]("cmd_blacklist_glob"):
168         blist = __salt__["config.get"]("cmd_blacklist_glob", [])
169         for comp in blist:
170             if fnmatch.fnmatch(cmd, comp):
171                 bret = False
172     if __salt__["config.get"]("cmd_whitelist_glob", []):
173         blist = __salt__["config.get"]("cmd_whitelist_glob", [])
174         for comp in blist:
175             if fnmatch.fnmatch(cmd, comp):
176                 wret = True
177                 break
178     else:
179         wret = True
180     return bret and wret
181 def _run(
182     cmd,
183     cwd=None,
184     stdin=None,
185     stdout=subprocess.PIPE,
186     stderr=subprocess.PIPE,
187     output_encoding=None,
188     output_loglevel="debug",
189     log_callback=None,
190     runas=None,
191     group=None,
192     shell=DEFAULT_SHELL,
193     python_shell=False,
194     env=None,
195     clean_env=False,
196     prepend_path=None,
197     rstrip=True,
198     template=None,
199     umask=None,
200     timeout=None,
201     with_communicate=True,
202     reset_system_locale=True,
203     ignore_retcode=False,
204     saltenv=None,
205     pillarenv=None,
206     pillar_override=None,
207     use_vt=False,
208     password=None,
209     bg=False,
210     encoded_cmd=False,
211     success_retcodes=None,
212     success_stdout=None,
213     success_stderr=None,
214     windows_codepage=65001,
215     **kwargs
216 ):
217     if "pillar" in kwargs and not pillar_override:
218         pillar_override = kwargs["pillar"]
219     if output_loglevel != "quiet" and _is_valid_shell(shell) is False:
220         log.warning(
221             "Attempt to run a shell command with what may be an invalid shell! "
222             "Check to ensure that the shell &lt;%s&gt; is valid for this user.",
223             shell,
224         )
225     output_loglevel = _check_loglevel(output_loglevel)
226     log_callback = _check_cb(log_callback)
227     use_sudo = False
228     if runas is None and "__context__" in globals():
229         runas = __context__.get("runas")
230     if password is None and "__context__" in globals():
231         password = __context__.get("runas_password")
232     if not cwd:
233         cwd = os.path.expanduser("~{}".format("" if not runas else runas))
234         if not os.access(cwd, os.R_OK):
235             cwd = "/"
236             if salt.utils.platform.is_windows():
237                 cwd = os.path.abspath(os.sep)
238     else:
239         cwd = str(cwd)
240     if bg:
241         ignore_retcode = True
242         use_vt = False
243     change_windows_codepage = False
244     if not salt.utils.platform.is_windows():
245         if not os.path.isfile(shell) or not os.access(shell, os.X_OK):
246             msg = "The shell {} is not available".format(shell)
247             raise CommandExecutionError(msg)
248     elif use_vt:  # Memozation so not much overhead
249         raise CommandExecutionError("VT not available on windows")
250     else:
251         if windows_codepage:
252             if not isinstance(windows_codepage, int):
253                 windows_codepage = int(windows_codepage)
254             previous_windows_codepage = salt.utils.win_chcp.get_codepage_id()
255             if windows_codepage != previous_windows_codepage:
256                 change_windows_codepage = True
257     if any(word in shell.lower().strip() for word in ["powershell", "pwsh"]):
258         if isinstance(cmd, str):
259             cmd = cmd.strip()
260         elif isinstance(cmd, list):
261             cmd = " ".join(cmd).strip()
262         cmd = cmd.replace('"', '\\"')
263         stack = traceback.extract_stack(limit=2)
264         if stack[-2][2] == "script":
265             cmd = '"{}" -NonInteractive -NoProfile -ExecutionPolicy Bypass -Command {}'.format(
266                 shell, cmd
267             )
268         elif encoded_cmd:
269             cmd = '"{}" -NonInteractive -NoProfile -EncodedCommand {}'.format(
270                 shell, cmd
271             )
272         else:
273             cmd = '"{}" -NonInteractive -NoProfile -Command "{}"'.format(shell, cmd)
274     (cmd, cwd) = _render_cmd(cmd, cwd, template, saltenv, pillarenv, pillar_override)
275     ret = {}
276     if "__pub_jid" in kwargs:
277         if not _check_avail(cmd):
278             raise CommandExecutionError(
279                 'The shell command "{}" is not permitted'.format(cmd)
280             )
281     env = _parse_env(env)
282     for bad_env_key in (x for x, y in env.items() if y is None):
283         log.error(
284             "Environment variable '%s' passed without a value. "
285             "Setting value to an empty string",
286             bad_env_key,
287         )
288         env[bad_env_key] = ""
289     if output_loglevel is not None:
290         msg = "Executing command {}{}{} {}{}in directory '{}'{}".format(
291             "'" if not isinstance(cmd, list) else "",
292             _log_cmd(cmd),
293             "'" if not isinstance(cmd, list) else "",
294             "as user '{}' ".format(runas) if runas else "",
295             "in group '{}' ".format(group) if group else "",
296             cwd,
297             ". Executing command in the background, no output will be logged."
298             if bg
299             else "",
300         )
301         log.info(log_callback(msg))
302     if runas and salt.utils.platform.is_windows():
303         if not HAS_WIN_RUNAS:
304             msg = "missing salt/utils/win_runas.py"
305             raise CommandExecutionError(msg)
306         if isinstance(cmd, (list, tuple)):
307             cmd = " ".join(cmd)
308         return win_runas(cmd, runas, password, cwd)
309     if runas and salt.utils.platform.is_darwin():
310         if isinstance(cmd, (list, tuple)):
311             cmd = " ".join(map(_cmd_quote, cmd))
312         cmd = "cd -- {dir} &amp;&amp; {{ {cmd}\n }}".format(dir=_cmd_quote(cwd), cmd=cmd)
313         try:
314             user_shell = __salt__["user.info"](runas)["shell"]
315             if re.search("bash$", user_shell):
316                 cmd = "{shell} -l -c {cmd}".format(
317                     shell=user_shell, cmd=_cmd_quote(cmd)
318                 )
319         except KeyError:
320             pass
321         cmd = "su -l {} -c {}".format(_cmd_quote(runas), _cmd_quote(cmd))
322         runas = None
323     if runas:
324         try:
325             pwd.getpwnam(runas)
326         except KeyError:
327             raise CommandExecutionError("User '{}' is not available".format(runas))
328     if group:
329         if salt.utils.platform.is_windows():
330             msg = "group is not currently available on Windows"
331             raise SaltInvocationError(msg)
332         if not which_bin(["sudo"]):
333             msg = "group argument requires sudo but not found"
334             raise CommandExecutionError(msg)
335         try:
336             grp.getgrnam(group)
337         except KeyError:
338             raise CommandExecutionError("Group '{}' is not available".format(runas))
339         else:
340             use_sudo = True
341     if runas or group:
342         try:
343             import uuid
344             marker = "&lt;&lt;&lt;" + str(uuid.uuid4()) + "&gt;&gt;&gt;"
345             marker_b = marker.encode(__salt_system_encoding__)
346             py_code = (
347                 "import sys, os, itertools; sys.stdout.write('{0}'); "
348                 "sys.stdout.write('\\0'.join(itertools.chain(*os.environ.items()))); "
349                 "sys.stdout.write('{0}');".format(marker)
350             )
351             if use_sudo:
352                 env_cmd = ["sudo"]
353                 if runas:
354                     env_cmd.extend(["-u", runas])
355                 if group:
356                     env_cmd.extend(["-g", group])
357                 if shell != DEFAULT_SHELL:
358                     env_cmd.extend(["-s", "--", shell, "-c"])
359                 else:
360                     env_cmd.extend(["-i", "--"])
361                 env_cmd.extend([sys.executable])
362             elif __grains__["os"] in ["FreeBSD"]:
363                 env_cmd = (
364                     "su",
365                     "-",
366                     runas,
367                     "-c",
368                     "{} -c {}".format(shell, sys.executable),
369                 )
370             elif __grains__["os_family"] in ["Solaris"]:
371                 env_cmd = ("su", "-", runas, "-c", sys.executable)
372             elif __grains__["os_family"] in ["AIX"]:
373                 env_cmd = ("su", "-", runas, "-c", sys.executable)
374             else:
375                 env_cmd = ("su", "-s", shell, "-", runas, "-c", sys.executable)
376             msg = "env command: {}".format(env_cmd)
377             log.debug(log_callback(msg))
378             env_bytes, env_encoded_err = subprocess.Popen(
379                 env_cmd,
380                 stderr=subprocess.PIPE,
381                 stdout=subprocess.PIPE,
382                 stdin=subprocess.PIPE,
383             ).communicate(salt.utils.stringutils.to_bytes(py_code))
384             marker_count = env_bytes.count(marker_b)
385             if marker_count == 0:
386                 log.error(
387                     "Environment could not be retrieved for user '%s': "
388                     "stderr=%r stdout=%r",
389                     runas,
390                     env_encoded_err,
391                     env_bytes,
392                 )
393                 env_bytes = b""
394             elif marker_count != 2:
395                 raise CommandExecutionError(
396                     "Environment could not be retrieved for user '{}'",
397                     info={"stderr": repr(env_encoded_err), "stdout": repr(env_bytes)},
398                 )
399             else:
400                 env_bytes = env_bytes.split(marker_b)[1]
401             env_runas = dict(list(zip(*[iter(env_bytes.split(b"\0"))] * 2)))
402             env_runas = {
403                 salt.utils.stringutils.to_str(k): salt.utils.stringutils.to_str(v)
404                 for k, v in env_runas.items()
405             }
406             env_runas.update(env)
407             if env_runas.get("USER") != runas:
408                 env_runas["USER"] = runas
409             runas_home = os.path.expanduser("~{}".format(runas))
410             if env_runas.get("HOME") != runas_home:
411                 env_runas["HOME"] = runas_home
412             env = env_runas
413         except ValueError as exc:
414             log.exception("Error raised retrieving environment for user %s", runas)
415             raise CommandExecutionError(
416                 "Environment could not be retrieved for user '{}': {}".format(
417                     runas, exc
418                 )
419             )
420     if reset_system_locale is True:
421         if not salt.utils.platform.is_windows():
422             env.setdefault("LC_CTYPE", "C")
423             env.setdefault("LC_NUMERIC", "C")
424             env.setdefault("LC_TIME", "C")
425             env.setdefault("LC_COLLATE", "C")
426             env.setdefault("LC_MONETARY", "C")
427             env.setdefault("LC_MESSAGES", "C")
428             env.setdefault("LC_PAPER", "C")
429             env.setdefault("LC_NAME", "C")
430             env.setdefault("LC_ADDRESS", "C")
431             env.setdefault("LC_TELEPHONE", "C")
432             env.setdefault("LC_MEASUREMENT", "C")
433             env.setdefault("LC_IDENTIFICATION", "C")
434             env.setdefault("LANGUAGE", "C")
435     if clean_env:
436         run_env = env
437     else:
438         if salt.utils.platform.is_windows():
439             import nt
440             run_env = nt.environ.copy()
441         else:
442             run_env = os.environ.copy()
443         run_env.update(env)
444     if prepend_path:
445         run_env["PATH"] = ":".join((prepend_path, run_env["PATH"]))
446     if "NOTIFY_SOCKET" not in env:
447         run_env.pop("NOTIFY_SOCKET", None)
448     if python_shell is None:
449         python_shell = False
450     new_kwargs = {
451         "cwd": cwd,
452         "shell": python_shell,
453         "env": run_env,
454         "stdin": str(stdin) if stdin is not None else stdin,
455         "stdout": stdout,
456         "stderr": stderr,
457         "with_communicate": with_communicate,
458         "timeout": timeout,
459         "bg": bg,
460     }
461     if "stdin_raw_newlines" in kwargs:
462         new_kwargs["stdin_raw_newlines"] = kwargs["stdin_raw_newlines"]
463     if umask is not None:
464         _umask = str(umask).lstrip("0")
465         if _umask == "":
466             msg = "Zero umask is not allowed."
467             raise CommandExecutionError(msg)
468         try:
469             _umask = int(_umask, 8)
470         except ValueError:
471             raise CommandExecutionError("Invalid umask: '{}'".format(umask))
472     else:
473         _umask = None
474     if runas or group or umask:
475         new_kwargs["preexec_fn"] = functools.partial(
476             salt.utils.user.chugid_and_umask, runas, _umask, group
477         )
478     if not salt.utils.platform.is_windows():
479         if new_kwargs["shell"] is True:
480             new_kwargs["executable"] = shell
481         if salt.utils.platform.is_freebsd() and sys.version_info &lt; (3, 9):
482             new_kwargs["close_fds"] = False
483         else:
484             new_kwargs["close_fds"] = True
485     if not os.path.isabs(cwd) or not os.path.isdir(cwd):
486         raise CommandExecutionError(
487             "Specified cwd '{}' either not absolute or does not exist".format(cwd)
488         )
489     if (
490         python_shell is not True
491         and not salt.utils.platform.is_windows()
492         and not isinstance(cmd, list)
493     ):
494         cmd = salt.utils.args.shlex_split(cmd)
495     if success_retcodes is None:
496         success_retcodes = [0]
497     else:
498         try:
499             success_retcodes = [
500                 int(i) for i in salt.utils.args.split_input(success_retcodes)
501             ]
502         except ValueError:
503             raise SaltInvocationError("success_retcodes must be a list of integers")
504     if success_stdout is None:
505         success_stdout = []
506     else:
507         success_stdout = salt.utils.args.split_input(success_stdout)
508     if success_stderr is None:
509         success_stderr = []
510     else:
511         success_stderr = salt.utils.args.split_input(success_stderr)
512     if not use_vt:
513         try:
514             if change_windows_codepage:
515                 salt.utils.win_chcp.set_codepage_id(windows_codepage)
516             try:
517                 proc = salt.utils.timed_subprocess.TimedProc(cmd, **new_kwargs)
518             except OSError as exc:
519                 msg = "Unable to run command '{}' with the context '{}', reason: {}".format(
520                     cmd if output_loglevel is not None else "REDACTED",
521                     new_kwargs,
522                     exc,
523                 )
524                 raise CommandExecutionError(msg)
525             try:
526                 proc.run()
527             except TimedProcTimeoutError as exc:
528                 ret["stdout"] = str(exc)
529                 ret["stderr"] = ""
530                 ret["retcode"] = None
531                 ret["pid"] = proc.process.pid
532                 ret["retcode"] = 1
533                 return ret
534         finally:
535             if change_windows_codepage:
536                 salt.utils.win_chcp.set_codepage_id(previous_windows_codepage)
537         if output_loglevel != "quiet" and output_encoding is not None:
538             log.debug(
539                 "Decoding output from command %s using %s encoding",
540                 cmd,
541                 output_encoding,
542             )
543         try:
544             out = salt.utils.stringutils.to_unicode(
545                 proc.stdout, encoding=output_encoding
546             )
547         except TypeError:
548             out = ""
549         except UnicodeDecodeError:
550             out = salt.utils.stringutils.to_unicode(
551                 proc.stdout, encoding=output_encoding, errors="replace"
552             )
553             if output_loglevel != "quiet":
554                 log.error(
555                     "Failed to decode stdout from command %s, non-decodable "
556                     "characters have been replaced",
557                     _log_cmd(cmd),
558                 )
559         try:
560             err = salt.utils.stringutils.to_unicode(
561                 proc.stderr, encoding=output_encoding
562             )
563         except TypeError:
564             err = ""
565         except UnicodeDecodeError:
566             err = salt.utils.stringutils.to_unicode(
567                 proc.stderr, encoding=output_encoding, errors="replace"
568             )
569             if output_loglevel != "quiet":
570                 log.error(
571                     "Failed to decode stderr from command %s, non-decodable "
572                     "characters have been replaced",
573                     _log_cmd(cmd),
574                 )
575         if rstrip:
576             if out is not None:
577                 out = out.rstrip()
578             if err is not None:
579                 err = err.rstrip()
580         ret["pid"] = proc.process.pid
581         ret["retcode"] = proc.process.returncode
582         if ret["retcode"] in success_retcodes:
583             ret["retcode"] = 0
584         ret["stdout"] = out
585         ret["stderr"] = err
586         if any(
587             [stdo in ret["stdout"] for stdo in success_stdout]
588             + [stde in ret["stderr"] for stde in success_stderr]
589         ):
590             ret["retcode"] = 0
591     else:
592         formatted_timeout = ""
593         if timeout:
594             formatted_timeout = " (timeout: {}s)".format(timeout)
595         if output_loglevel is not None:
596             msg = "Running {} in VT{}".format(cmd, formatted_timeout)
597             log.debug(log_callback(msg))
598         stdout, stderr = "", ""
599         now = time.time()
600         if timeout:
601             will_timeout = now + timeout
602         else:
603             will_timeout = -1
604         try:
605             proc = salt.utils.vt.Terminal(
606                 cmd,
607                 shell=True,
608                 log_stdout=True,
609                 log_stderr=True,
610                 cwd=cwd,
611                 preexec_fn=new_kwargs.get("preexec_fn", None),
612                 env=run_env,
613                 log_stdin_level=output_loglevel,
614                 log_stdout_level=output_loglevel,
615                 log_stderr_level=output_loglevel,
616                 stream_stdout=True,
617                 stream_stderr=True,
618             )
619             ret["pid"] = proc.pid
620             while proc.has_unread_data:
621                 try:
622                     try:
623                         time.sleep(0.5)
624                         try:
625                             cstdout, cstderr = proc.recv()
626                         except OSError:
627                             cstdout, cstderr = "", ""
628                         if cstdout:
629                             stdout += cstdout
630                         else:
631                             stdout = ""
632                         if cstderr:
633                             stderr += cstderr
634                         else:
635                             stderr = ""
636                         if timeout and (time.time() &gt; will_timeout):
637                             ret["stderr"] = "SALT: Timeout after {}s\n{}".format(
638                                 timeout, stderr
639                             )
640                             ret["retcode"] = None
641                             break
642                     except KeyboardInterrupt:
643                         ret["stderr"] = "SALT: User break\n{}".format(stderr)
644                         ret["retcode"] = 1
645                         break
646                 except salt.utils.vt.TerminalException as exc:
647                     log.error("VT: %s", exc, exc_info_on_loglevel=logging.DEBUG)
648                     ret = {"retcode": 1, "pid": "2"}
649                     break
650                 ret["stdout"] = stdout
651                 if not proc.isalive():
652                     ret["stderr"] = stderr
653                     ret["retcode"] = proc.exitstatus
654                     if ret["retcode"] in success_retcodes:
655                         ret["retcode"] = 0
656                     if any(
657                         [stdo in ret["stdout"] for stdo in success_stdout]
658                         + [stde in ret["stderr"] for stde in success_stderr]
659                     ):
660                         ret["retcode"] = 0
661                 ret["pid"] = proc.pid
662         finally:
663             proc.close(terminate=True, kill=True)
664     try:
665         if ignore_retcode:
666             __context__["retcode"] = 0
667         else:
668             __context__["retcode"] = ret["retcode"]
669     except NameError:
670         pass
671     if output_loglevel is not None:
672         if not ignore_retcode and ret["retcode"] != 0:
673             if output_loglevel &lt; LOG_LEVELS["error"]:
674                 output_loglevel = LOG_LEVELS["error"]
675             msg = "Command '{}' failed with return code: {}".format(
676                 _log_cmd(cmd), ret["retcode"]
677             )
678             log.error(log_callback(msg))
679         if ret["stdout"]:
680             log.log(output_loglevel, "stdout: %s", log_callback(ret["stdout"]))
681         if ret["stderr"]:
682             log.log(output_loglevel, "stderr: %s", log_callback(ret["stderr"]))
683         if ret["retcode"]:
684             log.log(output_loglevel, "retcode: %s", ret["retcode"])
685     return ret
686 def _run_quiet(
687     cmd,
688     cwd=None,
689     stdin=None,
690     output_encoding=None,
691     runas=None,
692     shell=DEFAULT_SHELL,
693     python_shell=False,
694     env=None,
695     template=None,
696     umask=None,
697     timeout=None,
698     reset_system_locale=True,
699     saltenv=None,
700     pillarenv=None,
701     pillar_override=None,
702     success_retcodes=None,
703     success_stdout=None,
704     success_stderr=None,
705 ):
706     return _run(
707         cmd,
708         runas=runas,
709         cwd=cwd,
710         stdin=stdin,
711         stderr=subprocess.STDOUT,
712         output_encoding=output_encoding,
713         output_loglevel="quiet",
714         log_callback=None,
715         shell=shell,
716         python_shell=python_shell,
717         env=env,
718         template=template,
719         umask=umask,
720         timeout=timeout,
721         reset_system_locale=reset_system_locale,
722         saltenv=saltenv,
723         pillarenv=pillarenv,
724         pillar_override=pillar_override,
725         success_retcodes=success_retcodes,
726         success_stdout=success_stdout,
727         success_stderr=success_stderr,
728     )["stdout"]
729 def _run_all_quiet(
730     cmd,
731     cwd=None,
732     stdin=None,
733     runas=None,
734     shell=DEFAULT_SHELL,
735     python_shell=False,
736     env=None,
737     template=None,
738     umask=None,
739     timeout=None,
740     reset_system_locale=True,
741     saltenv=None,
742     pillarenv=None,
743     pillar_override=None,
744     output_encoding=None,
745     success_retcodes=None,
746     success_stdout=None,
747     success_stderr=None,
748 ):
749     return _run(
750         cmd,
751         runas=runas,
752         cwd=cwd,
753         stdin=stdin,
754         shell=shell,
755         python_shell=python_shell,
756         env=env,
757         output_encoding=output_encoding,
758         output_loglevel="quiet",
759         log_callback=None,
760         template=template,
761         umask=umask,
762         timeout=timeout,
763         reset_system_locale=reset_system_locale,
764         saltenv=saltenv,
765         pillarenv=pillarenv,
766         pillar_override=pillar_override,
767         success_retcodes=success_retcodes,
768         success_stdout=success_stdout,
769         success_stderr=success_stderr,
770     )
771 def run(
772     cmd,
773     cwd=None,
774     stdin=None,
775     runas=None,
776     group=None,
777     shell=DEFAULT_SHELL,
778     python_shell=None,
779     env=None,
780     clean_env=False,
781     template=None,
782     rstrip=True,
783     umask=None,
784     output_encoding=None,
785     output_loglevel="debug",
786     log_callback=None,
787     hide_output=False,
788     timeout=None,
789     reset_system_locale=True,
790     ignore_retcode=False,
791     saltenv=None,
792     use_vt=False,
793     bg=False,
794     password=None,
795     encoded_cmd=False,
796     raise_err=False,
797     prepend_path=None,
798     success_retcodes=None,
799     success_stdout=None,
800     success_stderr=None,
801     **kwargs
802 ):
803     r"""
804     Execute the passed command and return the output as a string
805     :param str cmd: The command to run. ex: ``ls -lart /home``
806     :param str cwd: The directory from which to execute the command. Defaults
807         to the home directory of the user specified by ``runas`` (or the user
808         under which Salt is running if ``runas`` is not specified).
809     :param str stdin: A string of standard input can be specified for the
810         command to be run using the ``stdin`` parameter. This can be useful in
811         cases where sensitive information must be read from standard input.
812     :param str runas: Specify an alternate user to run the command. The default
813         behavior is to run as the user under which Salt is running.
814         .. warning::
815             For versions 2018.3.3 and above on macosx while using runas,
816             on linux while using run, to pass special characters to the
817             command you need to escape the characters on the shell.
818             Example:
819             .. code-block:: bash
820                 cmd.run 'echo '\''h=\"baz\"'\''' runas=macuser
821     :param str group: Group to run command as. Not currently supported
822         on Windows.
823     :param str password: Windows only. Required when specifying ``runas``. This
824         parameter will be ignored on non-Windows platforms.
825         .. versionadded:: 2016.3.0
826     :param str shell: Specify an alternate shell. Defaults to the system's
827         default shell.
828     :param bool python_shell: If ``False``, let python handle the positional
829         arguments. Set to ``True`` to use shell features, such as pipes or
830         redirection.
831     :param bool bg: If ``True``, run command in background and do not await or
832         deliver its results
833         .. versionadded:: 2016.3.0
834     :param dict env: Environment variables to be set prior to execution.
835         .. note::
836             When passing environment variables on the CLI, they should be
837             passed as the string representation of a dictionary.
838             .. code-block:: bash
839                 salt myminion cmd.run 'some command' env='{"FOO": "bar"}'
840         .. note::
841             When using environment variables on Window's, case-sensitivity
842             matters, i.e. Window's uses `Path` as opposed to `PATH` for other
843             systems.
844     :param bool clean_env: Attempt to clean out all other shell environment
845         variables and set only those provided in the 'env' argument to this
846         function.
847     :param str prepend_path: $PATH segment to prepend (trailing ':' not
848         necessary) to $PATH
849         .. versionadded:: 2018.3.0
850     :param str template: If this setting is applied then the named templating
851         engine will be used to render the downloaded file. Currently jinja,
852         mako, and wempy are supported.
853     :param bool rstrip: Strip all whitespace off the end of output before it is
854         returned.
855     :param str umask: The umask (in octal) to use when running the command.
856     :param str output_encoding: Control the encoding used to decode the
857         command's output.
858         .. note::
859             This should not need to be used in most cases. By default, Salt
860             will try to use the encoding detected from the system locale, and
861             will fall back to UTF-8 if this fails. This should only need to be
862             used in cases where the output of the command is encoded in
863             something other than the system locale or UTF-8.
864             To see the encoding Salt has detected from the system locale, check
865             the `locale` line in the output of :py:func:`test.versions_report
866             &lt;salt.modules.test.versions_report&gt;`.
867         .. versionadded:: 2018.3.0
868     :param str output_loglevel: Control the loglevel at which the output from
869         the command is logged to the minion log.
870         .. note::
871             The command being run will still be logged at the ``debug``
872             loglevel regardless, unless ``quiet`` is used for this value.
873     :param bool ignore_retcode: If the exit code of the command is nonzero,
874         this is treated as an error condition, and the output from the command
875         will be logged to the minion log. However, there are some cases where
876         programs use the return code for signaling and a nonzero exit code
877         doesn't necessarily mean failure. Pass this argument as ``True`` to
878         skip logging the output if the command has a nonzero exit code.
879     :param bool hide_output: If ``True``, suppress stdout and stderr in the
880         return data.
881         .. note::
882             This is separate from ``output_loglevel``, which only handles how
883             Salt logs to the minion log.
884         .. versionadded:: 2018.3.0
885     :param int timeout: A timeout in seconds for the executed process to return.
886     :param bool use_vt: Use VT utils (saltstack) to stream the command output
887         more interactively to the console and the logs. This is experimental.
888     :param bool encoded_cmd: Specify if the supplied command is encoded.
889         Only applies to shell 'powershell' and 'pwsh'.
890         .. versionadded:: 2018.3.0
891         Older versions of powershell seem to return raw xml data in the return.
892         To avoid raw xml data in the return, prepend your command with the
893         following before encoding:
894         `$ProgressPreference='SilentlyContinue'; &lt;your command&gt;`
895         The following powershell code block will encode the `Write-Output`
896         command so that it will not have the raw xml data in the return:
897         .. code-block:: powershell
898             $Command = '$ProgressPreference="SilentlyContinue"; Write-Output "hello"'
899             $Encoded = [convert]::ToBase64String([System.Text.encoding]::Unicode.GetBytes($command))
900             Write-Output $Encoded
901     :param bool raise_err: If ``True`` and the command has a nonzero exit code,
902         a CommandExecutionError exception will be raised.
903     .. warning::
904         This function does not process commands through a shell
905         unless the python_shell flag is set to True. This means that any
906         shell-specific functionality such as 'echo' or the use of pipes,
907         redirection or &amp;&amp;, should either be migrated to cmd.shell or
908         have the python_shell=True flag set here.
909         The use of python_shell=True means that the shell will accept _any_ input
910         including potentially malicious commands such as 'good_command;rm -rf /'.
911         Be absolutely certain that you have sanitized your input prior to using
912         python_shell=True
913     :param list success_retcodes: This parameter will allow a list of
914         non-zero return codes that should be considered a success.  If the
915         return code returned from the run matches any in the provided list,
916         the return code will be overridden with zero.
917       .. versionadded:: 2019.2.0
918     :param list success_stdout: This parameter will allow a list of
919         strings that when found in standard out should be considered a success.
920         If stdout returned from the run matches any in the provided list,
921         the return code will be overridden with zero.
922       .. versionadded:: 3004
923     :param list success_stderr: This parameter will allow a list of
924         strings that when found in standard error should be considered a success.
925         If stderr returned from the run matches any in the provided list,
926         the return code will be overridden with zero.
927       .. versionadded:: 3004
928     :param bool stdin_raw_newlines: False
929         If ``True``, Salt will not automatically convert the characters ``\\n``
930         present in the ``stdin`` value to newlines.
931       .. versionadded:: 2019.2.0
932     :param int windows_codepage: 65001
933         Only applies to Windows: the minion uses `C:\Windows\System32\chcp.com` to
934         verify or set the code page before the command `cmd` is executed.
935         Code page 65001 corresponds with UTF-8 and allows international localization of Windows.
936       .. versionadded:: 3002
937     CLI Example:
938     .. code-block:: bash
939         salt '*' cmd.run "ls -l | awk '/foo/{print \\$2}'"
940     The template arg can be set to 'jinja' or another supported template
941     engine to render the command arguments before execution.
942     For example:
943     .. code-block:: bash
944         salt '*' cmd.run template=jinja "ls -l /tmp/{{grains.id}} | awk '/foo/{print \\$2}'"
945     Specify an alternate shell with the shell parameter:
946     .. code-block:: bash
947         salt '*' cmd.run "Get-ChildItem C:\\ " shell='powershell'
948     A string of standard input can be specified for the command to be run using
949     the ``stdin`` parameter. This can be useful in cases where sensitive
950     information must be read from standard input.
951     .. code-block:: bash
952         salt '*' cmd.run "grep f" stdin='one\\ntwo\\nthree\\nfour\\nfive\\n'
953     If an equal sign (``=``) appears in an argument to a Salt command it is
954     interpreted as a keyword argument in the format ``key=val``. That
955     processing can be bypassed in order to pass an equal sign through to the
956     remote shell command by manually specifying the kwarg:
957     .. code-block:: bash
958         salt '*' cmd.run cmd='sed -e s/=/:/g'
959     Execute the passed command and return the output as a string.
960     .. versionadded:: 2015.5.0
961     :param str cmd: The command to run. ex: ``ls -lart /home``
962     :param str cwd: The directory from which to execute the command. Defaults
963         to the home directory of the user specified by ``runas`` (or the user
964         under which Salt is running if ``runas`` is not specified).
965     :param str stdin: A string of standard input can be specified for the
966         command to be run using the ``stdin`` parameter. This can be useful in
967         cases where sensitive information must be read from standard input.
968     :param str runas: Specify an alternate user to run the command. The default
969         behavior is to run as the user under which Salt is running. If running
970         on a Windows minion you must also use the ``password`` argument, and
971         the target user account must be in the Administrators group.
972         .. warning::
973             For versions 2018.3.3 and above on macosx while using runas,
974             to pass special characters to the command you need to escape
975             the characters on the shell.
976             Example:
977             .. code-block:: bash
978                 cmd.shell 'echo '\\''h=\\"baz\\"'\\''' runas=macuser
979     :param str group: Group to run command as. Not currently supported
980       on Windows.
981     :param str password: Windows only. Required when specifying ``runas``. This
982         parameter will be ignored on non-Windows platforms.
983         .. versionadded:: 2016.3.0
984     :param int shell: Shell to execute under. Defaults to the system default
985         shell.
986     :param bool bg: If True, run command in background and do not await or
987         deliver its results
988     :param dict env: Environment variables to be set prior to execution.
989         .. note::
990             When passing environment variables on the CLI, they should be
991             passed as the string representation of a dictionary.
992             .. code-block:: bash
993                 salt myminion cmd.shell 'some command' env='{"FOO": "bar"}'
994         .. note::
995             When using environment variables on Window's, case-sensitivity
996             matters, i.e. Window's uses `Path` as opposed to `PATH` for other
997             systems.
998     :param bool clean_env: Attempt to clean out all other shell environment
999         variables and set only those provided in the 'env' argument to this
1000         function.
1001     :param str prepend_path: $PATH segment to prepend (trailing ':' not necessary)
1002         to $PATH
1003         .. versionadded:: 2018.3.0
1004     :param str template: If this setting is applied then the named templating
1005         engine will be used to render the downloaded file. Currently jinja,
1006         mako, and wempy are supported.
1007     :param bool rstrip: Strip all whitespace off the end of output before it is
1008         returned.
1009     :param str umask: The umask (in octal) to use when running the command.
1010     :param str output_encoding: Control the encoding used to decode the
1011         command's output.
1012         .. note::
1013             This should not need to be used in most cases. By default, Salt
1014             will try to use the encoding detected from the system locale, and
1015             will fall back to UTF-8 if this fails. This should only need to be
1016             used in cases where the output of the command is encoded in
1017             something other than the system locale or UTF-8.
1018             To see the encoding Salt has detected from the system locale, check
1019             the `locale` line in the output of :py:func:`test.versions_report
1020             &lt;salt.modules.test.versions_report&gt;`.
1021         .. versionadded:: 2018.3.0
1022     :param str output_loglevel: Control the loglevel at which the output from
1023         the command is logged to the minion log.
1024         .. note::
1025             The command being run will still be logged at the ``debug``
1026             loglevel regardless, unless ``quiet`` is used for this value.
1027     :param bool ignore_retcode: If the exit code of the command is nonzero,
1028         this is treated as an error condition, and the output from the command
1029         will be logged to the minion log. However, there are some cases where
1030         programs use the return code for signaling and a nonzero exit code
1031         doesn't necessarily mean failure. Pass this argument as ``True`` to
1032         skip logging the output if the command has a nonzero exit code.
1033     :param bool hide_output: If ``True``, suppress stdout and stderr in the
1034         return data.
1035         .. note::
1036             This is separate from ``output_loglevel``, which only handles how
1037             Salt logs to the minion log.
1038         .. versionadded:: 2018.3.0
1039     :param int timeout: A timeout in seconds for the executed process to
1040         return.
1041     :param bool use_vt: Use VT utils (saltstack) to stream the command output
1042         more interactively to the console and the logs. This is experimental.
1043     .. warning::
1044         This passes the cmd argument directly to the shell without any further
1045         processing! Be absolutely sure that you have properly sanitized the
1046         command passed to this function and do not use untrusted inputs.
1047     :param list success_retcodes: This parameter will allow a list of
1048         non-zero return codes that should be considered a success.  If the
1049         return code returned from the run matches any in the provided list,
1050         the return code will be overridden with zero.
1051       .. versionadded:: 2019.2.0
1052     :param list success_stdout: This parameter will allow a list of
1053         strings that when found in standard out should be considered a success.
1054         If stdout returned from the run matches any in the provided list,
1055         the return code will be overridden with zero.
1056       .. versionadded:: 3004
1057     :param list success_stderr: This parameter will allow a list of
1058         strings that when found in standard error should be considered a success.
1059         If stderr returned from the run matches any in the provided list,
1060         the return code will be overridden with zero.
1061       .. versionadded:: 3004
1062     :param bool stdin_raw_newlines: False
1063         If ``True``, Salt will not automatically convert the characters ``\\n``
1064         present in the ``stdin`` value to newlines.
1065       .. versionadded:: 2019.2.0
1066     CLI Example:
1067     .. code-block:: bash
1068         salt '*' cmd.shell "ls -l | awk '/foo/{print \\$2}'"
1069     The template arg can be set to 'jinja' or another supported template
1070     engine to render the command arguments before execution.
1071     For example:
1072     .. code-block:: bash
1073         salt '*' cmd.shell template=jinja "ls -l /tmp/{{grains.id}} | awk '/foo/{print \\$2}'"
1074     Specify an alternate shell with the shell parameter:
1075     .. code-block:: bash
1076         salt '*' cmd.shell "Get-ChildItem C:\\ " shell='powershell'
1077     A string of standard input can be specified for the command to be run using
1078     the ``stdin`` parameter. This can be useful in cases where sensitive
1079     information must be read from standard input.
1080     .. code-block:: bash
1081         salt '*' cmd.shell "grep f" stdin='one\\ntwo\\nthree\\nfour\\nfive\\n'
1082     If an equal sign (``=``) appears in an argument to a Salt command it is
1083     interpreted as a keyword argument in the format ``key=val``. That
1084     processing can be bypassed in order to pass an equal sign through to the
1085     remote shell command by manually specifying the kwarg:
1086     .. code-block:: bash
1087         salt '*' cmd.shell cmd='sed -e s/=/:/g'
1088     Execute a command, and only return the standard out
1089     :param str cmd: The command to run. ex: ``ls -lart /home``
1090     :param str cwd: The directory from which to execute the command. Defaults
1091         to the home directory of the user specified by ``runas`` (or the user
1092         under which Salt is running if ``runas`` is not specified).
1093     :param str stdin: A string of standard input can be specified for the
1094         command to be run using the ``stdin`` parameter. This can be useful in
1095         cases where sensitive information must be read from standard input.
1096     :param str runas: Specify an alternate user to run the command. The default
1097         behavior is to run as the user under which Salt is running. If running
1098         on a Windows minion you must also use the ``password`` argument, and
1099         the target user account must be in the Administrators group.
1100         .. warning::
1101             For versions 2018.3.3 and above on macosx while using runas,
1102             to pass special characters to the command you need to escape
1103             the characters on the shell.
1104             Example:
1105             .. code-block:: bash
1106                 cmd.run_stdout 'echo '\\''h=\\"baz\\"'\\''' runas=macuser
1107     :param str password: Windows only. Required when specifying ``runas``. This
1108         parameter will be ignored on non-Windows platforms.
1109         .. versionadded:: 2016.3.0
1110     :param str group: Group to run command as. Not currently supported
1111       on Windows.
1112     :param str shell: Specify an alternate shell. Defaults to the system's
1113         default shell.
1114     :param bool python_shell: If False, let python handle the positional
1115         arguments. Set to True to use shell features, such as pipes or
1116         redirection.
1117     :param dict env: Environment variables to be set prior to execution.
1118         .. note::
1119             When passing environment variables on the CLI, they should be
1120             passed as the string representation of a dictionary.
1121             .. code-block:: bash
1122                 salt myminion cmd.run_stdout 'some command' env='{"FOO": "bar"}'
1123         .. note::
1124             When using environment variables on Window's, case-sensitivity
1125             matters, i.e. Window's uses `Path` as opposed to `PATH` for other
1126             systems.
1127     :param bool clean_env: Attempt to clean out all other shell environment
1128         variables and set only those provided in the 'env' argument to this
1129         function.
1130     :param str prepend_path: $PATH segment to prepend (trailing ':' not necessary)
1131         to $PATH
1132         .. versionadded:: 2018.3.0
1133     :param str template: If this setting is applied then the named templating
1134         engine will be used to render the downloaded file. Currently jinja,
1135         mako, and wempy are supported.
1136     :param bool rstrip: Strip all whitespace off the end of output before it is
1137         returned.
1138     :param str umask: The umask (in octal) to use when running the command.
1139     :param str output_encoding: Control the encoding used to decode the
1140         command's output.
1141         .. note::
1142             This should not need to be used in most cases. By default, Salt
1143             will try to use the encoding detected from the system locale, and
1144             will fall back to UTF-8 if this fails. This should only need to be
1145             used in cases where the output of the command is encoded in
1146             something other than the system locale or UTF-8.
1147             To see the encoding Salt has detected from the system locale, check
1148             the `locale` line in the output of :py:func:`test.versions_report
1149             &lt;salt.modules.test.versions_report&gt;`.
1150         .. versionadded:: 2018.3.0
1151     :param str output_loglevel: Control the loglevel at which the output from
1152         the command is logged to the minion log.
1153         .. note::
1154             The command being run will still be logged at the ``debug``
1155             loglevel regardless, unless ``quiet`` is used for this value.
1156     :param bool ignore_retcode: If the exit code of the command is nonzero,
1157         this is treated as an error condition, and the output from the command
1158         will be logged to the minion log. However, there are some cases where
1159         programs use the return code for signaling and a nonzero exit code
1160         doesn't necessarily mean failure. Pass this argument as ``True`` to
1161         skip logging the output if the command has a nonzero exit code.
1162     :param bool hide_output: If ``True``, suppress stdout and stderr in the
1163         return data.
1164         .. note::
1165             This is separate from ``output_loglevel``, which only handles how
1166             Salt logs to the minion log.
1167         .. versionadded:: 2018.3.0
1168     :param int timeout: A timeout in seconds for the executed process to
1169         return.
1170     :param bool use_vt: Use VT utils (saltstack) to stream the command output
1171         more interactively to the console and the logs. This is experimental.
1172     :param list success_retcodes: This parameter will allow a list of
1173         non-zero return codes that should be considered a success.  If the
1174         return code returned from the run matches any in the provided list,
1175         the return code will be overridden with zero.
1176       .. versionadded:: 2019.2.0
1177     :param list success_stdout: This parameter will allow a list of
1178         strings that when found in standard out should be considered a success.
1179         If stdout returned from the run matches any in the provided list,
1180         the return code will be overridden with zero.
1181       .. versionadded:: 3004
1182     :param list success_stderr: This parameter will allow a list of
1183         strings that when found in standard error should be considered a success.
1184         If stderr returned from the run matches any in the provided list,
1185         the return code will be overridden with zero.
1186       .. versionadded:: 3004
1187     :param bool stdin_raw_newlines: False
1188         If ``True``, Salt will not automatically convert the characters ``\\n``
1189         present in the ``stdin`` value to newlines.
1190       .. versionadded:: 2019.2.0
1191     CLI Example:
1192     .. code-block:: bash
1193         salt '*' cmd.run_stdout "ls -l | awk '/foo/{print \\$2}'"
1194     The template arg can be set to 'jinja' or another supported template
1195     engine to render the command arguments before execution.
1196     For example:
1197     .. code-block:: bash
1198         salt '*' cmd.run_stdout template=jinja "ls -l /tmp/{{grains.id}} | awk '/foo/{print \\$2}'"
1199     A string of standard input can be specified for the command to be run using
1200     the ``stdin`` parameter. This can be useful in cases where sensitive
1201     information must be read from standard input.
1202     .. code-block:: bash
1203         salt '*' cmd.run_stdout "grep f" stdin='one\\ntwo\\nthree\\nfour\\nfive\\n'
1204     Execute a command and only return the standard error
1205     :param str cmd: The command to run. ex: ``ls -lart /home``
1206     :param str cwd: The directory from which to execute the command. Defaults
1207         to the home directory of the user specified by ``runas`` (or the user
1208         under which Salt is running if ``runas`` is not specified).
1209     :param str stdin: A string of standard input can be specified for the
1210         command to be run using the ``stdin`` parameter. This can be useful in
1211         cases where sensitive information must be read from standard input.
1212     :param str runas: Specify an alternate user to run the command. The default
1213         behavior is to run as the user under which Salt is running. If running
1214         on a Windows minion you must also use the ``password`` argument, and
1215         the target user account must be in the Administrators group.
1216         .. warning::
1217             For versions 2018.3.3 and above on macosx while using runas,
1218             to pass special characters to the command you need to escape
1219             the characters on the shell.
1220             Example:
1221             .. code-block:: bash
1222                 cmd.run_stderr 'echo '\\''h=\\"baz\\"'\\''' runas=macuser
1223     :param str password: Windows only. Required when specifying ``runas``. This
1224         parameter will be ignored on non-Windows platforms.
1225         .. versionadded:: 2016.3.0
1226     :param str group: Group to run command as. Not currently supported
1227       on Windows.
1228     :param str shell: Specify an alternate shell. Defaults to the system's
1229         default shell.
1230     :param bool python_shell: If False, let python handle the positional
1231         arguments. Set to True to use shell features, such as pipes or
1232         redirection.
1233     :param dict env: Environment variables to be set prior to execution.
1234         .. note::
1235             When passing environment variables on the CLI, they should be
1236             passed as the string representation of a dictionary.
1237             .. code-block:: bash
1238                 salt myminion cmd.run_stderr 'some command' env='{"FOO": "bar"}'
1239         .. note::
1240             When using environment variables on Window's, case-sensitivity
1241             matters, i.e. Window's uses `Path` as opposed to `PATH` for other
1242             systems.
1243     :param bool clean_env: Attempt to clean out all other shell environment
1244         variables and set only those provided in the 'env' argument to this
1245         function.
1246     :param str prepend_path: $PATH segment to prepend (trailing ':' not
1247         necessary) to $PATH
1248         .. versionadded:: 2018.3.0
1249     :param str template: If this setting is applied then the named templating
1250         engine will be used to render the downloaded file. Currently jinja,
1251         mako, and wempy are supported.
1252     :param bool rstrip: Strip all whitespace off the end of output before it is
1253         returned.
1254     :param str umask: The umask (in octal) to use when running the command.
1255     :param str output_encoding: Control the encoding used to decode the
1256         command's output.
1257         .. note::
1258             This should not need to be used in most cases. By default, Salt
1259             will try to use the encoding detected from the system locale, and
1260             will fall back to UTF-8 if this fails. This should only need to be
1261             used in cases where the output of the command is encoded in
1262             something other than the system locale or UTF-8.
1263             To see the encoding Salt has detected from the system locale, check
1264             the `locale` line in the output of :py:func:`test.versions_report
1265             &lt;salt.modules.test.versions_report&gt;`.
1266         .. versionadded:: 2018.3.0
1267     :param str output_loglevel: Control the loglevel at which the output from
1268         the command is logged to the minion log.
1269         .. note::
1270             The command being run will still be logged at the ``debug``
1271             loglevel regardless, unless ``quiet`` is used for this value.
1272     :param bool ignore_retcode: If the exit code of the command is nonzero,
1273         this is treated as an error condition, and the output from the command
1274         will be logged to the minion log. However, there are some cases where
1275         programs use the return code for signaling and a nonzero exit code
1276         doesn't necessarily mean failure. Pass this argument as ``True`` to
1277         skip logging the output if the command has a nonzero exit code.
1278     :param bool hide_output: If ``True``, suppress stdout and stderr in the
1279         return data.
1280         .. note::
1281             This is separate from ``output_loglevel``, which only handles how
1282             Salt logs to the minion log.
1283         .. versionadded:: 2018.3.0
1284     :param int timeout: A timeout in seconds for the executed process to
1285         return.
1286     :param bool use_vt: Use VT utils (saltstack) to stream the command output
1287         more interactively to the console and the logs. This is experimental.
1288     :param list success_retcodes: This parameter will allow a list of
1289         non-zero return codes that should be considered a success.  If the
1290         return code returned from the run matches any in the provided list,
1291         the return code will be overridden with zero.
1292       .. versionadded:: 2019.2.0
1293     :param list success_stdout: This parameter will allow a list of
1294         strings that when found in standard out should be considered a success.
1295         If stdout returned from the run matches any in the provided list,
1296         the return code will be overridden with zero.
1297       .. versionadded:: 3004
1298     :param list success_stderr: This parameter will allow a list of
1299         strings that when found in standard error should be considered a success.
1300         If stderr returned from the run matches any in the provided list,
1301         the return code will be overridden with zero.
1302       .. versionadded:: 3004
1303     :param bool stdin_raw_newlines: False
1304         If ``True``, Salt will not automatically convert the characters ``\\n``
1305         present in the ``stdin`` value to newlines.
1306       .. versionadded:: 2019.2.0
1307     CLI Example:
1308     .. code-block:: bash
1309         salt '*' cmd.run_stderr "ls -l | awk '/foo/{print \\$2}'"
1310     The template arg can be set to 'jinja' or another supported template
1311     engine to render the command arguments before execution.
1312     For example:
1313     .. code-block:: bash
1314         salt '*' cmd.run_stderr template=jinja "ls -l /tmp/{{grains.id}} | awk '/foo/{print \\$2}'"
1315     A string of standard input can be specified for the command to be run using
1316     the ``stdin`` parameter. This can be useful in cases where sensitive
1317     information must be read from standard input.
1318     .. code-block:: bash
1319         salt '*' cmd.run_stderr "grep f" stdin='one\\ntwo\\nthree\\nfour\\nfive\\n'
1320     Execute the passed command and return a dict of return data
1321     :param str cmd: The command to run. ex: ``ls -lart /home``
1322     :param str cwd: The directory from which to execute the command. Defaults
1323         to the home directory of the user specified by ``runas`` (or the user
1324         under which Salt is running if ``runas`` is not specified).
1325     :param str stdin: A string of standard input can be specified for the
1326         command to be run using the ``stdin`` parameter. This can be useful in
1327         cases where sensitive information must be read from standard input.
1328     :param str runas: Specify an alternate user to run the command. The default
1329         behavior is to run as the user under which Salt is running. If running
1330         on a Windows minion you must also use the ``password`` argument, and
1331         the target user account must be in the Administrators group.
1332         .. warning::
1333             For versions 2018.3.3 and above on macosx while using runas,
1334             to pass special characters to the command you need to escape
1335             the characters on the shell.
1336             Example:
1337             .. code-block:: bash
1338                 cmd.run_all 'echo '\\''h=\\"baz\\"'\\''' runas=macuser
1339     :param str password: Windows only. Required when specifying ``runas``. This
1340         parameter will be ignored on non-Windows platforms.
1341         .. versionadded:: 2016.3.0
1342     :param str group: Group to run command as. Not currently supported
1343       on Windows.
1344     :param str shell: Specify an alternate shell. Defaults to the system's
1345         default shell.
1346     :param bool python_shell: If False, let python handle the positional
1347         arguments. Set to True to use shell features, such as pipes or
1348         redirection.
1349     :param dict env: Environment variables to be set prior to execution.
1350         .. note::
1351             When passing environment variables on the CLI, they should be
1352             passed as the string representation of a dictionary.
1353             .. code-block:: bash
1354                 salt myminion cmd.run_all 'some command' env='{"FOO": "bar"}'
1355         .. note::
1356             When using environment variables on Window's, case-sensitivity
1357             matters, i.e. Window's uses `Path` as opposed to `PATH` for other
1358             systems.
1359     :param bool clean_env: Attempt to clean out all other shell environment
1360         variables and set only those provided in the 'env' argument to this
1361         function.
1362     :param str prepend_path: $PATH segment to prepend (trailing ':' not
1363         necessary) to $PATH
1364         .. versionadded:: 2018.3.0
1365     :param str template: If this setting is applied then the named templating
1366         engine will be used to render the downloaded file. Currently jinja,
1367         mako, and wempy are supported.
1368     :param bool rstrip: Strip all whitespace off the end of output before it is
1369         returned.
1370     :param str umask: The umask (in octal) to use when running the command.
1371     :param str output_encoding: Control the encoding used to decode the
1372         command's output.
1373         .. note::
1374             This should not need to be used in most cases. By default, Salt
1375             will try to use the encoding detected from the system locale, and
1376             will fall back to UTF-8 if this fails. This should only need to be
1377             used in cases where the output of the command is encoded in
1378             something other than the system locale or UTF-8.
1379             To see the encoding Salt has detected from the system locale, check
1380             the `locale` line in the output of :py:func:`test.versions_report
1381             &lt;salt.modules.test.versions_report&gt;`.
1382         .. versionadded:: 2018.3.0
1383     :param str output_loglevel: Control the loglevel at which the output from
1384         the command is logged to the minion log.
1385         .. note::
1386             The command being run will still be logged at the ``debug``
1387             loglevel regardless, unless ``quiet`` is used for this value.
1388     :param bool ignore_retcode: If the exit code of the command is nonzero,
1389         this is treated as an error condition, and the output from the command
1390         will be logged to the minion log. However, there are some cases where
1391         programs use the return code for signaling and a nonzero exit code
1392         doesn't necessarily mean failure. Pass this argument as ``True`` to
1393         skip logging the output if the command has a nonzero exit code.
1394     :param bool hide_output: If ``True``, suppress stdout and stderr in the
1395         return data.
1396         .. note::
1397             This is separate from ``output_loglevel``, which only handles how
1398             Salt logs to the minion log.
1399         .. versionadded:: 2018.3.0
1400     :param int timeout: A timeout in seconds for the executed process to
1401         return.
1402     :param bool use_vt: Use VT utils (saltstack) to stream the command output
1403         more interactively to the console and the logs. This is experimental.
1404     :param bool encoded_cmd: Specify if the supplied command is encoded.
1405         Only applies to shell 'powershell' and 'pwsh'.
1406         .. versionadded:: 2018.3.0
1407         Older versions of powershell seem to return raw xml data in the return.
1408         To avoid raw xml data in the return, prepend your command with the
1409         following before encoding:
1410         `$ProgressPreference='SilentlyContinue'; &lt;your command&gt;`
1411         The following powershell code block will encode the `Write-Output`
1412         command so that it will not have the raw xml data in the return:
1413         .. code-block:: powershell
1414             $Command = '$ProgressPreference="SilentlyContinue"; Write-Output "hello"'
1415             $Encoded = [convert]::ToBase64String([System.Text.encoding]::Unicode.GetBytes($command))
1416             Write-Output $Encoded
1417     :param bool redirect_stderr: If set to ``True``, then stderr will be
1418         redirected to stdout. This is helpful for cases where obtaining both
1419         the retcode and output is desired, but it is not desired to have the
1420         output separated into both stdout and stderr.
1421         .. versionadded:: 2015.8.2
1422     :param str password: Windows only. Required when specifying ``runas``. This
1423         parameter will be ignored on non-Windows platforms.
1424           .. versionadded:: 2016.3.0
1425     :param bool bg: If ``True``, run command in background and do not await or
1426         deliver its results
1427         .. versionadded:: 2016.3.6
1428     :param list success_retcodes: This parameter will allow a list of
1429         non-zero return codes that should be considered a success.  If the
1430         return code returned from the run matches any in the provided list,
1431         the return code will be overridden with zero.
1432       .. versionadded:: 2019.2.0
1433     :param list success_stdout: This parameter will allow a list of
1434         strings that when found in standard out should be considered a success.
1435         If stdout returned from the run matches any in the provided list,
1436         the return code will be overridden with zero.
1437       .. versionadded:: 3004
1438     :param list success_stderr: This parameter will allow a list of
1439         strings that when found in standard error should be considered a success.
1440         If stderr returned from the run matches any in the provided list,
1441         the return code will be overridden with zero.
1442       .. versionadded:: 3004
1443     :param bool stdin_raw_newlines: False
1444         If ``True``, Salt will not automatically convert the characters ``\\n``
1445         present in the ``stdin`` value to newlines.
1446       .. versionadded:: 2019.2.0
1447     CLI Example:
1448     .. code-block:: bash
1449         salt '*' cmd.run_all "ls -l | awk '/foo/{print \\$2}'"
1450     The template arg can be set to 'jinja' or another supported template
1451     engine to render the command arguments before execution.
1452     For example:
1453     .. code-block:: bash
1454         salt '*' cmd.run_all template=jinja "ls -l /tmp/{{grains.id}} | awk '/foo/{print \\$2}'"
1455     A string of standard input can be specified for the command to be run using
1456     the ``stdin`` parameter. This can be useful in cases where sensitive
1457     information must be read from standard input.
1458     .. code-block:: bash
1459         salt '*' cmd.run_all "grep f" stdin='one\\ntwo\\nthree\\nfour\\nfive\\n'
1460     Execute a shell command and return the command's return code.
1461     :param str cmd: The command to run. ex: ``ls -lart /home``
1462     :param str cwd: The directory from which to execute the command. Defaults
1463         to the home directory of the user specified by ``runas`` (or the user
1464         under which Salt is running if ``runas`` is not specified).
1465     :param str stdin: A string of standard input can be specified for the
1466         command to be run using the ``stdin`` parameter. This can be useful in
1467         cases where sensitive information must be read from standard input.
1468     :param str runas: Specify an alternate user to run the command. The default
1469         behavior is to run as the user under which Salt is running. If running
1470         on a Windows minion you must also use the ``password`` argument, and
1471         the target user account must be in the Administrators group.
1472         .. warning::
1473             For versions 2018.3.3 and above on macosx while using runas,
1474             to pass special characters to the command you need to escape
1475             the characters on the shell.
1476             Example:
1477             .. code-block:: bash
1478                 cmd.retcode 'echo '\\''h=\\"baz\\"'\\''' runas=macuser
1479     :param str password: Windows only. Required when specifying ``runas``. This
1480         parameter will be ignored on non-Windows platforms.
1481         .. versionadded:: 2016.3.0
1482     :param str group: Group to run command as. Not currently supported
1483       on Windows.
1484     :param str shell: Specify an alternate shell. Defaults to the system's
1485         default shell.
1486     :param bool python_shell: If False, let python handle the positional
1487         arguments. Set to True to use shell features, such as pipes or
1488         redirection.
1489     :param dict env: Environment variables to be set prior to execution.
1490         .. note::
1491             When passing environment variables on the CLI, they should be
1492             passed as the string representation of a dictionary.
1493             .. code-block:: bash
1494                 salt myminion cmd.retcode 'some command' env='{"FOO": "bar"}'
1495         .. note::
1496             When using environment variables on Window's, case-sensitivity
1497             matters, i.e. Window's uses `Path` as opposed to `PATH` for other
1498             systems.
1499     :param bool clean_env: Attempt to clean out all other shell environment
1500         variables and set only those provided in the 'env' argument to this
1501         function.
1502     :param str template: If this setting is applied then the named templating
1503         engine will be used to render the downloaded file. Currently jinja,
1504         mako, and wempy are supported.
1505     :param bool rstrip: Strip all whitespace off the end of output before it is
1506         returned.
1507     :param str umask: The umask (in octal) to use when running the command.
1508     :param str output_encoding: Control the encoding used to decode the
1509         command's output.
1510         .. note::
1511             This should not need to be used in most cases. By default, Salt
1512             will try to use the encoding detected from the system locale, and
1513             will fall back to UTF-8 if this fails. This should only need to be
1514             used in cases where the output of the command is encoded in
1515             something other than the system locale or UTF-8.
1516             To see the encoding Salt has detected from the system locale, check
1517             the `locale` line in the output of :py:func:`test.versions_report
1518             &lt;salt.modules.test.versions_report&gt;`.
1519         .. versionadded:: 2018.3.0
1520     :param str output_loglevel: Control the loglevel at which the output from
1521         the command is logged to the minion log.
1522         .. note::
1523             The command being run will still be logged at the ``debug``
1524             loglevel regardless, unless ``quiet`` is used for this value.
1525     :param bool ignore_retcode: If the exit code of the command is nonzero,
1526         this is treated as an error condition, and the output from the command
1527         will be logged to the minion log. However, there are some cases where
1528         programs use the return code for signaling and a nonzero exit code
1529         doesn't necessarily mean failure. Pass this argument as ``True`` to
1530         skip logging the output if the command has a nonzero exit code.
1531     :param int timeout: A timeout in seconds for the executed process to return.
1532     :param bool use_vt: Use VT utils (saltstack) to stream the command output
1533       more interactively to the console and the logs. This is experimental.
1534     :rtype: int
1535     :rtype: None
1536     :returns: Return Code as an int or None if there was an exception.
1537     :param list success_retcodes: This parameter will allow a list of
1538         non-zero return codes that should be considered a success.  If the
1539         return code returned from the run matches any in the provided list,
1540         the return code will be overridden with zero.
1541       .. versionadded:: 2019.2.0
1542     :param list success_stdout: This parameter will allow a list of
1543         strings that when found in standard out should be considered a success.
1544         If stdout returned from the run matches any in the provided list,
1545         the return code will be overridden with zero.
1546       .. versionadded:: 3004
1547     :param list success_stderr: This parameter will allow a list of
1548         strings that when found in standard error should be considered a success.
1549         If stderr returned from the run matches any in the provided list,
1550         the return code will be overridden with zero.
1551       .. versionadded:: 3004
1552     :param bool stdin_raw_newlines: False
1553         If ``True``, Salt will not automatically convert the characters ``\\n``
1554         present in the ``stdin`` value to newlines.
1555       .. versionadded:: 2019.2.0
1556     CLI Example:
1557     .. code-block:: bash
1558         salt '*' cmd.retcode "file /bin/bash"
1559     The template arg can be set to 'jinja' or another supported template
1560     engine to render the command arguments before execution.
1561     For example:
1562     .. code-block:: bash
1563         salt '*' cmd.retcode template=jinja "file {{grains.pythonpath[0]}}/python"
1564     A string of standard input can be specified for the command to be run using
1565     the ``stdin`` parameter. This can be useful in cases where sensitive
1566     information must be read from standard input.
1567     .. code-block:: bash
1568         salt '*' cmd.retcode "grep f" stdin='one\\ntwo\\nthree\\nfour\\nfive\\n'
1569     Helper for running commands quietly for minion startup. Returns same as
1570     the retcode() function.
1571     Download a script from a remote location and execute the script locally.
1572     The script can be located on the salt master file server or on an HTTP/FTP
1573     server.
1574     The script will be executed directly, so it can be written in any available
1575     programming language.
1576     :param str source: The location of the script to download. If the file is
1577         located on the master in the directory named spam, and is called eggs,
1578         the source string is salt://spam/eggs
1579     :param str args: String of command line args to pass to the script. Only
1580         used if no args are specified as part of the `name` argument. To pass a
1581         string containing spaces in YAML, you will need to doubly-quote it:
1582         .. code-block:: bash
1583             salt myminion cmd.script salt://foo.sh "arg1 'arg two' arg3"
1584     :param str cwd: The directory from which to execute the command. Defaults
1585         to the directory returned from Python's tempfile.mkstemp.
1586     :param str stdin: A string of standard input can be specified for the
1587         command to be run using the ``stdin`` parameter. This can be useful in
1588         cases where sensitive information must be read from standard input.
1589     :param str runas: Specify an alternate user to run the command. The default
1590         behavior is to run as the user under which Salt is running. If running
1591         on a Windows minion you must also use the ``password`` argument, and
1592         the target user account must be in the Administrators group.
1593         .. note::
1594             For Window's users, specifically Server users, it may be necessary
1595             to specify your runas user using the User Logon Name instead of the
1596             legacy logon name. Traditionally, logons would be in the following
1597             format.
1598                 ``Domain/user``
1599             In the event this causes issues when executing scripts, use the UPN
1600             format which looks like the following.
1601                 ``user@domain.local``
1602             More information &lt;https://github.com/saltstack/salt/issues/55080&gt;
1603     :param str password: Windows only. Required when specifying ``runas``. This
1604         parameter will be ignored on non-Windows platforms.
1605         .. versionadded:: 2016.3.0
1606     :param str group: Group to run script as. Not currently supported
1607       on Windows.
1608     :param str shell: Specify an alternate shell. Defaults to the system's
1609         default shell.
1610     :param bool python_shell: If False, let python handle the positional
1611         arguments. Set to True to use shell features, such as pipes or
1612         redirection.
1613     :param bool bg: If True, run script in background and do not await or
1614         deliver its results
1615     :param dict env: Environment variables to be set prior to execution.
1616         .. note::
1617             When passing environment variables on the CLI, they should be
1618             passed as the string representation of a dictionary.
1619             .. code-block:: bash
1620                 salt myminion cmd.script 'some command' env='{"FOO": "bar"}'
1621         .. note::
1622             When using environment variables on Window's, case-sensitivity
1623             matters, i.e. Window's uses `Path` as opposed to `PATH` for other
1624             systems.
1625     :param str template: If this setting is applied then the named templating
1626         engine will be used to render the downloaded file. Currently jinja,
1627         mako, and wempy are supported.
1628     :param str umask: The umask (in octal) to use when running the command.
1629     :param str output_encoding: Control the encoding used to decode the
1630         command's output.
1631         .. note::
1632             This should not need to be used in most cases. By default, Salt
1633             will try to use the encoding detected from the system locale, and
1634             will fall back to UTF-8 if this fails. This should only need to be
1635             used in cases where the output of the command is encoded in
1636             something other than the system locale or UTF-8.
1637             To see the encoding Salt has detected from the system locale, check
1638             the `locale` line in the output of :py:func:`test.versions_report
1639             &lt;salt.modules.test.versions_report&gt;`.
1640         .. versionadded:: 2018.3.0
1641     :param str output_loglevel: Control the loglevel at which the output from
1642         the command is logged to the minion log.
1643         .. note::
1644             The command being run will still be logged at the ``debug``
1645             loglevel regardless, unless ``quiet`` is used for this value.
1646     :param bool ignore_retcode: If the exit code of the command is nonzero,
1647         this is treated as an error condition, and the output from the command
1648         will be logged to the minion log. However, there are some cases where
1649         programs use the return code for signaling and a nonzero exit code
1650         doesn't necessarily mean failure. Pass this argument as ``True`` to
1651         skip logging the output if the command has a nonzero exit code.
1652     :param bool hide_output: If ``True``, suppress stdout and stderr in the
1653         return data.
1654         .. note::
1655             This is separate from ``output_loglevel``, which only handles how
1656             Salt logs to the minion log.
1657         .. versionadded:: 2018.3.0
1658     :param int timeout: If the command has not terminated after timeout
1659         seconds, send the subprocess sigterm, and if sigterm is ignored, follow
1660         up with sigkill
1661     :param bool use_vt: Use VT utils (saltstack) to stream the command output
1662         more interactively to the console and the logs. This is experimental.
1663     :param list success_retcodes: This parameter will allow a list of
1664         non-zero return codes that should be considered a success.  If the
1665         return code returned from the run matches any in the provided list,
1666         the return code will be overridden with zero.
1667       .. versionadded:: 2019.2.0
1668     :param list success_stdout: This parameter will allow a list of
1669         strings that when found in standard out should be considered a success.
1670         If stdout returned from the run matches any in the provided list,
1671         the return code will be overridden with zero.
1672       .. versionadded:: 3004
1673     :param list success_stderr: This parameter will allow a list of
1674         strings that when found in standard error should be considered a success.
1675         If stderr returned from the run matches any in the provided list,
1676         the return code will be overridden with zero.
1677       .. versionadded:: 3004
1678     :param bool stdin_raw_newlines: False
1679         If ``True``, Salt will not automatically convert the characters ``\\n``
1680         present in the ``stdin`` value to newlines.
1681       .. versionadded:: 2019.2.0
1682     CLI Example:
1683     .. code-block:: bash
1684         salt '*' cmd.script salt://scripts/runme.sh
1685         salt '*' cmd.script salt://scripts/runme.sh 'arg1 arg2 "arg 3"'
1686         salt '*' cmd.script salt://scripts/windows_task.ps1 args=' -Input c:\\tmp\\infile.txt' shell='powershell'
1687     .. code-block:: bash
1688         salt '*' cmd.script salt://scripts/runme.sh stdin='one\\ntwo\\nthree\\nfour\\nfive\\n'
1689     """
1690             pillarenv = kwargs.get("pillarenv", __opts__<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.get("pillarenv"))
1691             kwargs["pillar"] = _gather_pillar(pillarenv, kwargs.get("pillar"))
1692         fn_ = __salt__["cp.get_template"](source, path, template, saltenv, **kwargs)
1693         if</b></font> not fn_:
1694             _cleanup_tempfile(path)
1695             if win_cwd:
1696                 _cleanup_tempfile(cwd)
1697             return {
1698                 "pid": 0,
1699                 "retcode": 1,
1700                 "stdout": "",
1701                 "stderr": "",
1702                 "cache_error": True,
1703             }
1704     else:
1705         fn_ = __salt__["cp.cache_file"](source, saltenv)
1706         if not fn_:
1707             _cleanup_tempfile(path)
1708             if win_cwd:
1709                 _cleanup_tempfile(cwd)
1710             return {
1711                 "pid": 0,
1712                 "retcode": 1,
1713                 "stdout": "",
1714                 "stderr": "",
1715                 "cache_error": True,
1716             }
1717         shutil.copyfile(fn_, path)
1718     if not salt.utils.platform.is_windows():
1719         os.chmod(path, 320)
1720         os.chown(path, __salt__["file.user_to_uid"](runas), -1)
1721     if salt.utils.platform.is_windows() and shell.lower() != "powershell":
1722         cmd_path = _cmd_quote(path, escape=False)
1723     else:
1724         cmd_path = _cmd_quote(path)
1725     ret = _run(
1726         cmd_path + " " + str(args) if args else cmd_path,
1727         cwd=cwd,
1728         stdin=stdin,
1729         output_encoding=output_encoding,
1730         output_loglevel=output_loglevel,
1731         log_callback=log_callback,
1732         runas=runas,
1733         group=group,
1734         shell=shell,
1735         python_shell=python_shell,
1736         env=env,
1737         umask=umask,
1738         timeout=timeout,
1739         reset_system_locale=reset_system_locale,
1740         saltenv=saltenv,
1741         use_vt=use_vt,
1742         bg=bg,
1743         password=password,
1744         success_retcodes=success_retcodes,
1745         success_stdout=success_stdout,
1746         success_stderr=success_stderr,
1747         **kwargs
1748     )
1749     _cleanup_tempfile(path)
1750     if win_cwd:
1751         _cleanup_tempfile(cwd)
1752     if hide_output:
1753         ret["stdout"] = ret["stderr"] = ""
1754     return ret
1755 def script_retcode(
1756     source,
1757     args=None,
1758     cwd=None,
1759     stdin=None,
1760     runas=None,
1761     group=None,
1762     shell=DEFAULT_SHELL,
1763     python_shell=None,
1764     env=None,
1765     template="jinja",
1766     umask=None,
1767     timeout=None,
1768     reset_system_locale=True,
1769     saltenv=None,
1770     output_encoding=None,
1771     output_loglevel="debug",
1772     log_callback=None,
1773     use_vt=False,
1774     password=None,
1775     success_retcodes=None,
1776     success_stdout=None,
1777     success_stderr=None,
1778     **kwargs
1779 ):
1780     """
1781     Download a script from a remote location and execute the script locally.
1782     The script can be located on the salt master file server or on an HTTP/FTP
1783     server.
1784     The script will be executed directly, so it can be written in any available
1785     programming language.
1786     The script can also be formatted as a template, the default is jinja.
1787     Only evaluate the script return code and do not block for terminal output
1788     :param str source: The location of the script to download. If the file is
1789         located on the master in the directory named spam, and is called eggs,
1790         the source string is salt://spam/eggs
1791     :param str args: String of command line args to pass to the script. Only
1792         used if no args are specified as part of the `name` argument. To pass a
1793         string containing spaces in YAML, you will need to doubly-quote it:
1794         "arg1 'arg two' arg3"
1795     :param str cwd: The directory from which to execute the command. Defaults
1796         to the home directory of the user specified by ``runas`` (or the user
1797         under which Salt is running if ``runas`` is not specified).
1798     :param str stdin: A string of standard input can be specified for the
1799         command to be run using the ``stdin`` parameter. This can be useful in
1800         cases where sensitive information must be read from standard input.
1801     :param str runas: Specify an alternate user to run the command. The default
1802         behavior is to run as the user under which Salt is running. If running
1803         on a Windows minion you must also use the ``password`` argument, and
1804         the target user account must be in the Administrators group.
1805     :param str password: Windows only. Required when specifying ``runas``. This
1806         parameter will be ignored on non-Windows platforms.
1807         .. versionadded:: 2016.3.0
1808     :param str group: Group to run script as. Not currently supported
1809       on Windows.
1810     :param str shell: Specify an alternate shell. Defaults to the system's
1811         default shell.
1812     :param bool python_shell: If False, let python handle the positional
1813         arguments. Set to True to use shell features, such as pipes or
1814         redirection.
1815     :param dict env: Environment variables to be set prior to execution.
1816         .. note::
1817             When passing environment variables on the CLI, they should be
1818             passed as the string representation of a dictionary.
1819             .. code-block:: bash
1820                 salt myminion cmd.script_retcode 'some command' env='{"FOO": "bar"}'
1821         .. note::
1822             When using environment variables on Window's, case-sensitivity
1823             matters, i.e. Window's uses `Path` as opposed to `PATH` for other
1824             systems.
1825     :param str template: If this setting is applied then the named templating
1826         engine will be used to render the downloaded file. Currently jinja,
1827         mako, and wempy are supported.
1828     :param str umask: The umask (in octal) to use when running the command.
1829     :param str output_encoding: Control the encoding used to decode the
1830         command's output.
1831         .. note::
1832             This should not need to be used in most cases. By default, Salt
1833             will try to use the encoding detected from the system locale, and
1834             will fall back to UTF-8 if this fails. This should only need to be
1835             used in cases where the output of the command is encoded in
1836             something other than the system locale or UTF-8.
1837             To see the encoding Salt has detected from the system locale, check
1838             the `locale` line in the output of :py:func:`test.versions_report
1839             &lt;salt.modules.test.versions_report&gt;`.
1840         .. versionadded:: 2018.3.0
1841     :param str output_loglevel: Control the loglevel at which the output from
1842         the command is logged to the minion log.
1843         .. note::
1844             The command being run will still be logged at the ``debug``
1845             loglevel regardless, unless ``quiet`` is used for this value.
1846     :param bool ignore_retcode: If the exit code of the command is nonzero,
1847         this is treated as an error condition, and the output from the command
1848         will be logged to the minion log. However, there are some cases where
1849         programs use the return code for signaling and a nonzero exit code
1850         doesn't necessarily mean failure. Pass this argument as ``True`` to
1851         skip logging the output if the command has a nonzero exit code.
1852     :param int timeout: If the command has not terminated after timeout
1853         seconds, send the subprocess sigterm, and if sigterm is ignored, follow
1854         up with sigkill
1855     :param bool use_vt: Use VT utils (saltstack) to stream the command output
1856         more interactively to the console and the logs. This is experimental.
1857     :param list success_retcodes: This parameter will allow a list of
1858         non-zero return codes that should be considered a success.  If the
1859         return code returned from the run matches any in the provided list,
1860         the return code will be overridden with zero.
1861       .. versionadded:: 2019.2.0
1862     :param list success_stdout: This parameter will allow a list of
1863         strings that when found in standard out should be considered a success.
1864         If stdout returned from the run matches any in the provided list,
1865         the return code will be overridden with zero.
1866       .. versionadded:: 3004
1867     :param list success_stderr: This parameter will allow a list of
1868         strings that when found in standard error should be considered a success.
1869         If stderr returned from the run matches any in the provided list,
1870         the return code will be overridden with zero.
1871       .. versionadded:: 3004
1872     :param bool stdin_raw_newlines: False
1873         If ``True``, Salt will not automatically convert the characters ``\\n``
1874         present in the ``stdin`` value to newlines.
1875       .. versionadded:: 2019.2.0
1876     CLI Example:
1877     .. code-block:: bash
1878         salt '*' cmd.script_retcode salt://scripts/runme.sh
1879         salt '*' cmd.script_retcode salt://scripts/runme.sh 'arg1 arg2 "arg 3"'
1880         salt '*' cmd.script_retcode salt://scripts/windows_task.ps1 args=' -Input c:\\tmp\\infile.txt' shell='powershell'
1881     A string of standard input can be specified for the command to be run using
1882     the ``stdin`` parameter. This can be useful in cases where sensitive
1883     information must be read from standard input.
1884     .. code-block:: bash
1885         salt '*' cmd.script_retcode salt://scripts/runme.sh stdin='one\\ntwo\\nthree\\nfour\\nfive\\n'
1886     """
1887     if "__env__" in kwargs:
1888         kwargs.pop("__env__")
1889     return script(
1890         source=source,
1891         args=args,
1892         cwd=cwd,
1893         stdin=stdin,
1894         runas=runas,
1895         group=group,
1896         shell=shell,
1897         python_shell=python_shell,
1898         env=env,
1899         template=template,
1900         umask=umask,
1901         timeout=timeout,
1902         reset_system_locale=reset_system_locale,
1903         saltenv=saltenv,
1904         output_encoding=output_encoding,
1905         output_loglevel=output_loglevel,
1906         log_callback=log_callback,
1907         use_vt=use_vt,
1908         password=password,
1909         success_retcodes=success_retcodes,
1910         success_stdout=success_stdout,
1911         success_stderr=success_stderr,
1912         **kwargs
1913     )["retcode"]
1914 def which(cmd):
1915     """
1916     Returns the path of an executable available on the minion, None otherwise
1917     CLI Example:
1918     .. code-block:: bash
1919         salt '*' cmd.which cat
1920     """
1921     return salt.utils.path.which(cmd)
1922 def which_bin(cmds):
1923     """
1924     Returns the first command found in a list of commands
1925     CLI Example:
1926     .. code-block:: bash
1927         salt '*' cmd.which_bin '[pip2, pip, pip-python]'
1928     """
1929     return salt.utils.path.which_bin(cmds)
1930 def has_exec(cmd):
1931     """
1932     Returns true if the executable is available on the minion, false otherwise
1933     CLI Example:
1934     .. code-block:: bash
1935         salt '*' cmd.has_exec cat
1936     """
1937     return which(cmd) is not None
1938 def exec_code(lang, code, cwd=None, args=None, **kwargs):
1939     """
1940     Pass in two strings, the first naming the executable language, aka -
1941     python2, python3, ruby, perl, lua, etc. the second string containing
1942     the code you wish to execute. The stdout will be returned.
1943     All parameters from :mod:`cmd.run_all &lt;salt.modules.cmdmod.run_all&gt;` except python_shell can be used.
1944     CLI Example:
1945     .. code-block:: bash
1946         salt '*' cmd.exec_code ruby 'puts "cheese"'
1947         salt '*' cmd.exec_code ruby 'puts "cheese"' args='["arg1", "arg2"]' env='{"FOO": "bar"}'
1948     """
1949     return exec_code_all(lang, code, cwd, args, **kwargs)["stdout"]
1950 def exec_code_all(lang, code, cwd=None, args=None, **kwargs):
1951     """
1952     Pass in two strings, the first naming the executable language, aka -
1953     python2, python3, ruby, perl, lua, etc. the second string containing
1954     the code you wish to execute. All cmd artifacts (stdout, stderr, retcode, pid)
1955     will be returned.
1956     All parameters from :mod:`cmd.run_all &lt;salt.modules.cmdmod.run_all&gt;` except python_shell can be used.
1957     CLI Example:
1958     .. code-block:: bash
1959         salt '*' cmd.exec_code_all ruby 'puts "cheese"'
1960         salt '*' cmd.exec_code_all ruby 'puts "cheese"' args='["arg1", "arg2"]' env='{"FOO": "bar"}'
1961     """
1962     powershell = lang.lower().startswith("powershell")
1963     if powershell:
1964         codefile = salt.utils.files.mkstemp(suffix=".ps1")
1965     else:
1966         codefile = salt.utils.files.mkstemp()
1967     with salt.utils.files.fopen(codefile, "w+t", binary=False) as fp_:
1968         fp_.write(salt.utils.stringutils.to_str(code))
1969     if powershell:
1970         cmd = [lang, "-File", codefile]
1971     else:
1972         cmd = [lang, codefile]
1973     if isinstance(args, str):
1974         cmd.append(args)
1975     elif isinstance(args, list):
1976         cmd += args
1977     def _cleanup_tempfile(path):
1978         try:
1979             __salt__["file.remove"](path)
1980         except (SaltInvocationError, CommandExecutionError) as exc:
1981             log.error(
1982                 "cmd.exec_code_all: Unable to clean tempfile '%s': %s",
1983                 path,
1984                 exc,
1985                 exc_info_on_loglevel=logging.DEBUG,
1986             )
1987     runas = kwargs.get("runas")
1988     if runas is not None:
1989         if not salt.utils.platform.is_windows():
1990             os.chown(codefile, __salt__["file.user_to_uid"](runas), -1)
1991     ret = run_all(cmd, cwd=cwd, python_shell=False, **kwargs)
1992     _cleanup_tempfile(codefile)
1993     return ret
1994 def tty(device, echo=""):
1995     """
1996     Echo a string to a specific tty
1997     CLI Example:
1998     .. code-block:: bash
1999         salt '*' cmd.tty tty0 'This is a test'
2000         salt '*' cmd.tty pts3 'This is a test'
2001     """
2002     if device.startswith("tty"):
2003         teletype = "/dev/{}".format(device)
2004     elif device.startswith("pts"):
2005         teletype = "/dev/{}".format(device.replace("pts", "pts/"))
2006     else:
2007         return {"Error": "The specified device is not a valid TTY"}
2008     try:
2009         with salt.utils.files.fopen(teletype, "wb") as tty_device:
2010             tty_device.write(salt.utils.stringutils.to_bytes(echo))
2011         return {"Success": "Message was successfully echoed to {}".format(teletype)}
2012     except OSError:
2013         return {"Error": "Echoing to {} returned error".format(teletype)}
2014 def run_chroot(
2015     root,
2016     cmd,
2017     cwd=None,
2018     stdin=None,
2019     runas=None,
2020     group=None,
2021     shell=DEFAULT_SHELL,
2022     python_shell=True,
2023     binds=None,
2024     env=None,
2025     clean_env=False,
2026     template=None,
2027     rstrip=True,
2028     umask=None,
2029     output_encoding=None,
2030     output_loglevel="quiet",
2031     log_callback=None,
2032     hide_output=False,
2033     timeout=None,
2034     reset_system_locale=True,
2035     ignore_retcode=False,
2036     saltenv=None,
2037     use_vt=False,
2038     bg=False,
2039     success_retcodes=None,
2040     success_stdout=None,
2041     success_stderr=None,
2042     **kwargs
2043 ):
2044     """
2045     .. versionadded:: 2014.7.0
2046     This function runs :mod:`cmd.run_all &lt;salt.modules.cmdmod.run_all&gt;` wrapped
2047     within a chroot, with dev and proc mounted in the chroot
2048     :param str root: Path to the root of the jail to use.
2049     :param str stdin: A string of standard input can be specified for
2050         the command to be run using the ``stdin`` parameter. This can
2051         be useful in cases where sensitive information must be read
2052         from standard input.:
2053     :param str runas: User to run script as.
2054     :param str group: Group to run script as.
2055     :param str shell: Shell to execute under. Defaults to the system
2056         default shell.
2057     :param str cmd: The command to run. ex: ``ls -lart /home``
2058     :param str cwd: The directory from which to execute the command. Defaults
2059         to the home directory of the user specified by ``runas`` (or the user
2060         under which Salt is running if ``runas`` is not specified).
2061     :parar str stdin: A string of standard input can be specified for the
2062         command to be run using the ``stdin`` parameter. This can be useful in
2063         cases where sensitive information must be read from standard input.
2064     :param str runas: Specify an alternate user to run the command. The default
2065         behavior is to run as the user under which Salt is running. If running
2066         on a Windows minion you must also use the ``password`` argument, and
2067         the target user account must be in the Administrators group.
2068     :param str shell: Specify an alternate shell. Defaults to the system's
2069         default shell.
2070     :param bool python_shell: If False, let python handle the positional
2071         arguments. Set to True to use shell features, such as pipes or
2072         redirection.
2073     :param list binds: List of directories that will be exported inside
2074         the chroot with the bind option.
2075         .. versionadded:: 3000
2076     :param dict env: Environment variables to be set prior to execution.
2077         .. note::
2078             When passing environment variables on the CLI, they should be
2079             passed as the string representation of a dictionary.
2080             .. code-block:: bash
2081                 salt myminion cmd.run_chroot 'some command' env='{"FOO": "bar"}'
2082         .. note::
2083             When using environment variables on Window's, case-sensitivity
2084             matters, i.e. Window's uses `Path` as opposed to `PATH` for other
2085             systems.
2086     :param dict clean_env: Attempt to clean out all other shell environment
2087         variables and set only those provided in the 'env' argument to this
2088         function.
2089     :param str template: If this setting is applied then the named templating
2090         engine will be used to render the downloaded file. Currently jinja,
2091         mako, and wempy are supported.
2092     :param bool rstrip: Strip all whitespace off the end of output
2093         before it is returned.
2094     :param str umask: The umask (in octal) to use when running the
2095          command.
2096     :param str output_encoding: Control the encoding used to decode the
2097         command's output.
2098         .. note::
2099             This should not need to be used in most cases. By default, Salt
2100             will try to use the encoding detected from the system locale, and
2101             will fall back to UTF-8 if this fails. This should only need to be
2102             used in cases where the output of the command is encoded in
2103             something other than the system locale or UTF-8.
2104             To see the encoding Salt has detected from the system locale, check
2105             the `locale` line in the output of :py:func:`test.versions_report
2106             &lt;salt.modules.test.versions_report&gt;`.
2107         .. versionadded:: 2018.3.0
2108     :param str output_loglevel: Control the loglevel at which the output from
2109         the command is logged to the minion log.
2110         .. note::
2111             The command being run will still be logged at the ``debug``
2112             loglevel regardless, unless ``quiet`` is used for this value.
2113     :param bool ignore_retcode: If the exit code of the command is nonzero,
2114         this is treated as an error condition, and the output from the command
2115         will be logged to the minion log. However, there are some cases where
2116         programs use the return code for signaling and a nonzero exit code
2117         doesn't necessarily mean failure. Pass this argument as ``True`` to
2118         skip logging the output if the command has a nonzero exit code.
2119     :param bool hide_output: If ``True``, suppress stdout and stderr in the
2120         return data.
2121         .. note::
2122             This is separate from ``output_loglevel``, which only handles how
2123             Salt logs to the minion log.
2124         .. versionadded:: 2018.3.0
2125     :param int timeout:
2126         A timeout in seconds for the executed process to return.
2127     :param bool use_vt:
2128         Use VT utils (saltstack) to stream the command output more
2129         interactively to the console and the logs. This is experimental.
2130     :param success_retcodes: This parameter will allow a list of
2131         non-zero return codes that should be considered a success.  If the
2132         return code returned from the run matches any in the provided list,
2133         the return code will be overridden with zero.
2134       .. versionadded:: 2019.2.0
2135     :param list success_stdout: This parameter will allow a list of
2136         strings that when found in standard out should be considered a success.
2137         If stdout returned from the run matches any in the provided list,
2138         the return code will be overridden with zero.
2139       .. versionadded:: 3004
2140     :param list success_stderr: This parameter will allow a list of
2141         strings that when found in standard error should be considered a success.
2142         If stderr returned from the run matches any in the provided list,
2143         the return code will be overridden with zero.
2144       .. versionadded:: 3004
2145     CLI Example:
2146     .. code-block:: bash
2147         salt '*' cmd.run_chroot /var/lib/lxc/container_name/rootfs 'sh /tmp/bootstrap.sh'
2148     """
2149     __salt__["mount.mount"](os.path.join(root, "dev"), "devtmpfs", fstype="devtmpfs")
2150     __salt__["mount.mount"](os.path.join(root, "proc"), "proc", fstype="proc")
2151     __salt__["mount.mount"](os.path.join(root, "sys"), "sysfs", fstype="sysfs")
2152     binds = binds if binds else []
2153     for bind_exported in binds:
2154         bind_exported_to = os.path.relpath(bind_exported, os.path.sep)
2155         bind_exported_to = os.path.join(root, bind_exported_to)
2156         __salt__["mount.mount"](bind_exported_to, bind_exported, opts="default,bind")
2157     sh_ = "/bin/sh"
2158     if os.path.isfile(os.path.join(root, "bin/bash")):
2159         sh_ = "/bin/bash"
2160     if isinstance(cmd, (list, tuple)):
2161         cmd = " ".join([str(i) for i in cmd])
2162     if runas:
2163         userspec = "--userspec {}:{}".format(runas, group if group else "")
2164     else:
2165         userspec = ""
2166     cmd = "chroot {} {} {} -c {}".format(userspec, root, sh_, _cmd_quote(cmd))
2167     run_func = __context__.pop("cmd.run_chroot.func", run_all)
2168     ret = run_func(
2169         cmd,
2170         cwd=cwd,
2171         stdin=stdin,
2172         shell=shell,
2173         python_shell=python_shell,
2174         env=env,
2175         clean_env=clean_env,
2176         template=template,
2177         rstrip=rstrip,
2178         umask=umask,
2179         output_encoding=output_encoding,
2180         output_loglevel=output_loglevel,
2181         log_callback=log_callback,
2182         timeout=timeout,
2183         reset_system_locale=reset_system_locale,
2184         ignore_retcode=ignore_retcode,
2185         saltenv=saltenv,
2186         pillarenv=kwargs.get("pillarenv"),
2187         pillar=kwargs.get("pillar"),
2188         use_vt=use_vt,
2189         success_retcodes=success_retcodes,
2190         success_stdout=success_stdout,
2191         success_stderr=success_stderr,
2192         bg=bg,
2193     )
2194     for i in range(6):
2195         pids = _chroot_pids(root)
2196         if not pids:
2197             break
2198         for pid in pids:
2199             sig = 15 if i &lt; 3 else 9
2200             os.kill(pid, sig)
2201     if _chroot_pids(root):
2202         log.error(
2203             "Processes running in chroot could not be killed, "
2204             "filesystem will remain mounted"
2205         )
2206     for bind_exported in binds:
2207         bind_exported_to = os.path.relpath(bind_exported, os.path.sep)
2208         bind_exported_to = os.path.join(root, bind_exported_to)
2209         __salt__["mount.umount"](bind_exported_to)
2210     __salt__["mount.umount"](os.path.join(root, "sys"))
2211     __salt__["mount.umount"](os.path.join(root, "proc"))
2212     __salt__["mount.umount"](os.path.join(root, "dev"))
2213     if hide_output:
2214         ret["stdout"] = ret["stderr"] = ""
2215     return ret
2216 def _is_valid_shell(shell):
2217     """
2218     Attempts to search for valid shells on a system and
2219     see if a given shell is in the list
2220     """
2221     if salt.utils.platform.is_windows():
2222         return True  # Don't even try this for Windows
2223     shells = "/etc/shells"
2224     available_shells = []
2225     if os.path.exists(shells):
2226         try:
2227             with salt.utils.files.fopen(shells, "r") as shell_fp:
2228                 lines = [
2229                     salt.utils.stringutils.to_unicode(x)
2230                     for x in shell_fp.read().splitlines()
2231                 ]
2232             for line in lines:
2233                 if line.startswith("#"):
2234                     continue
2235                 else:
2236                     available_shells.append(line)
2237         except OSError:
2238             return True
2239     else:
2240         return None
2241     if shell in available_shells:
2242         return True
2243     else:
2244         return False
2245 def shells():
2246     """
2247     Lists the valid shells on this system via the /etc/shells file
2248     .. versionadded:: 2015.5.0
2249     CLI Example:
2250     .. code-block:: bash
2251         salt '*' cmd.shells
2252     """
2253     shells_fn = "/etc/shells"
2254     ret = []
2255     if os.path.exists(shells_fn):
2256         try:
2257             with salt.utils.files.fopen(shells_fn, "r") as shell_fp:
2258                 lines = [
2259                     salt.utils.stringutils.to_unicode(x)
2260                     for x in shell_fp.read().splitlines()
2261                 ]
2262             for line in lines:
2263                 line = line.strip()
2264                 if line.startswith("#"):
2265                     continue
2266                 elif not line:
2267                     continue
2268                 else:
2269                     ret.append(line)
2270         except OSError:
2271             log.error("File '%s' was not found", shells_fn)
2272     return ret
2273 def shell_info(shell, list_modules=False):
2274     """
2275     .. versionadded:: 2016.11.0
2276     Provides information about a shell or script languages which often use
2277     ``#!``. The values returned are dependent on the shell or scripting
2278     languages all return the ``installed``, ``path``, ``version``,
2279     ``version_raw``
2280     Args:
2281         shell (str): Name of the shell. Support shells/script languages include
2282         bash, cmd, perl, php, powershell, python, ruby and zsh
2283         list_modules (bool): True to list modules available to the shell.
2284         Currently only lists powershell modules.
2285     Returns:
2286         dict: A dictionary of information about the shell
2287     .. code-block:: python
2288         {'version': '&lt;2 or 3 numeric components dot-separated&gt;',
2289          'version_raw': '&lt;full version string&gt;',
2290          'path': '&lt;full path to binary&gt;',
2291          'installed': &lt;True, False or None&gt;,
2292          '&lt;attribute&gt;': '&lt;attribute value&gt;'}
2293     .. note::
2294         - ``installed`` is always returned, if ``None`` or ``False`` also
2295           returns error and may also return ``stdout`` for diagnostics.
2296         - ``version`` is for use in determine if a shell/script language has a
2297           particular feature set, not for package management.
2298         - The shell must be within the executable search path.
2299     CLI Example:
2300     .. code-block:: bash
2301         salt '*' cmd.shell_info bash
2302         salt '*' cmd.shell_info powershell
2303     :codeauthor: Damon Atkins &lt;https://github.com/damon-atkins&gt;
2304     """
2305     regex_shells = {
2306         "bash": [r"version (\d\S*)", "bash", "--version"],
2307         "bash-test-error": [
2308             r"versioZ ([-\w.]+)",
2309             "bash",
2310             "--version",
2311         ],  # used to test an error result
2312         "bash-test-env": [
2313             r"(HOME=.*)",
2314             "bash",
2315             "-c",
2316             "declare",
2317         ],  # used to test an error result
2318         "zsh": [r"^zsh (\d\S*)", "zsh", "--version"],
2319         "tcsh": [r"^tcsh (\d\S*)", "tcsh", "--version"],
2320         "cmd": [r"Version ([\d.]+)", "cmd.exe", "/C", "ver"],
2321         "powershell": [
2322             r"PSVersion\s+(\d\S*)",
2323             "powershell",
2324             "-NonInteractive",
2325             "$PSVersionTable",
2326         ],
2327         "perl": [r"^(\d\S*)", "perl", "-e", 'printf "%vd\n", $^V;'],
2328         "python": [r"^Python (\d\S*)", "python", "-V"],
2329         "ruby": [r"^ruby (\d\S*)", "ruby", "-v"],
2330         "php": [r"^PHP (\d\S*)", "php", "-v"],
2331     }
2332     ret = {"installed": False}
2333     if salt.utils.platform.is_windows() and shell == "powershell":
2334         pw_keys = salt.utils.win_reg.list_keys(
2335             hive="HKEY_LOCAL_MACHINE", key="Software\\Microsoft\\PowerShell"
2336         )
2337         pw_keys.sort(key=int)
2338         if not pw_keys:
2339             return {
2340                 "error": (
2341                     "Unable to locate 'powershell' Reason: Cannot be found in registry."
2342                 ),
2343                 "installed": False,
2344             }
2345         for reg_ver in pw_keys:
2346             install_data = salt.utils.win_reg.read_value(
2347                 hive="HKEY_LOCAL_MACHINE",
2348                 key="Software\\Microsoft\\PowerShell\\{}".format(reg_ver),
2349                 vname="Install",
2350             )
2351             if (
2352                 install_data.get("vtype") == "REG_DWORD"
2353                 and install_data.get("vdata") == 1
2354             ):
2355                 details = salt.utils.win_reg.list_values(
2356                     hive="HKEY_LOCAL_MACHINE",
2357                     key="Software\\Microsoft\\PowerShell\\{}\\PowerShellEngine".format(
2358                         reg_ver
2359                     ),
2360                 )
2361                 ret = {}
2362                 ret["installed"] = None
2363                 ret["path"] = which("powershell.exe")
2364                 for attribute in details:
2365                     if attribute["vname"].lower() == "(default)":
2366                         continue
2367                     elif attribute["vname"].lower() == "powershellversion":
2368                         ret["psversion"] = attribute["vdata"]
2369                         ret["version_raw"] = attribute["vdata"]
2370                     elif attribute["vname"].lower() == "runtimeversion":
2371                         ret["crlversion"] = attribute["vdata"]
2372                         if ret["crlversion"][0].lower() == "v":
2373                             ret["crlversion"] = ret["crlversion"][1::]
2374                     elif attribute["vname"].lower() == "pscompatibleversion":
2375                         ret["pscompatibleversions"] = (
2376                             attribute["vdata"].replace(" ", "").split(",")
2377                         )
2378                     else:
2379                         ret[attribute["vname"].lower()] = attribute["vdata"]
2380     else:
2381         if shell not in regex_shells:
2382             return {
2383                 "error": (
2384                     "Salt does not know how to get the version number for {}".format(
2385                         shell
2386                     )
2387                 ),
2388                 "installed": None,
2389             }
2390         shell_data = regex_shells[shell]
2391         pattern = shell_data.pop(0)
2392         if salt.utils.platform.is_windows():
2393             import nt
2394             newenv = nt.environ
2395         else:
2396             newenv = os.environ
2397         if ("HOME" not in newenv) and (not salt.utils.platform.is_windows()):
2398             newenv["HOME"] = os.path.expanduser("~")
2399             log.debug("HOME environment set to %s", newenv["HOME"])
2400         try:
2401             proc = salt.utils.timed_subprocess.TimedProc(
2402                 shell_data,
2403                 stdin=None,
2404                 stdout=subprocess.PIPE,
2405                 stderr=subprocess.STDOUT,
2406                 timeout=10,
2407                 env=newenv,
2408             )
2409         except OSError as exc:
2410             return {
2411                 "error": "Unable to run command '{}' Reason: {}".format(
2412                     " ".join(shell_data), exc
2413                 ),
2414                 "installed": False,
2415             }
2416         try:
2417             proc.run()
2418         except TimedProcTimeoutError as exc:
2419             return {
2420                 "error": "Unable to run command '{}' Reason: Timed out.".format(
2421                     " ".join(shell_data)
2422                 ),
2423                 "installed": False,
2424             }
2425         ret["path"] = which(shell_data[0])
2426         pattern_result = re.search(pattern, proc.stdout, flags=re.IGNORECASE)
2427         if pattern_result:
2428             ret["version_raw"] = pattern_result.group(1)
2429     if "version_raw" in ret:
2430         version_results = re.match(r"(\d[\d.]*)", ret["version_raw"])
2431         if version_results:
2432             ret["installed"] = True
2433             ver_list = version_results.group(1).split(".")[:3]
2434             if len(ver_list) == 1:
2435                 ver_list.append("0")
2436             ret["version"] = ".".join(ver_list[:3])
2437     else:
2438         ret["installed"] = None  # Have an unexpected result
2439     if shell == "powershell" and ret["installed"] and list_modules:
2440         ret["modules"] = salt.utils.powershell.get_modules()
2441     if "version" not in ret:
2442         ret["error"] = (
2443             "The version regex pattern for shell {}, could not "
2444             "find the version string".format(shell)
2445         )
2446         ret["stdout"] = proc.stdout  # include stdout so they can see the issue
2447         log.error(ret["error"])
2448     return ret
2449 def powershell(
2450     cmd,
2451     cwd=None,
2452     stdin=None,
2453     runas=None,
2454     shell="powershell",
2455     env=None,
2456     clean_env=False,
2457     template=None,
2458     rstrip=True,
2459     umask=None,
2460     output_encoding=None,
2461     output_loglevel="debug",
2462     hide_output=False,
2463     timeout=None,
2464     reset_system_locale=True,
2465     ignore_retcode=False,
2466     saltenv=None,
2467     use_vt=False,
2468     password=None,
2469     depth=None,
2470     encode_cmd=False,
2471     success_retcodes=None,
2472     success_stdout=None,
2473     success_stderr=None,
2474     **kwargs
2475 ):
2476     """
2477     Execute the passed PowerShell command and return the output as a dictionary.
2478     Other ``cmd.*`` functions (besides ``cmd.powershell_all``)
2479     return the raw text output of the command. This
2480     function appends ``| ConvertTo-JSON`` to the command and then parses the
2481     JSON into a Python dictionary. If you want the raw textual result of your
2482     PowerShell command you should use ``cmd.run`` with the ``shell=powershell``
2483     option.
2484     For example:
2485     .. code-block:: bash
2486         salt '*' cmd.run '$PSVersionTable.CLRVersion' shell=powershell
2487         salt '*' cmd.run 'Get-NetTCPConnection' shell=powershell
2488     .. versionadded:: 2016.3.0
2489     .. warning::
2490         This passes the cmd argument directly to PowerShell
2491         without any further processing! Be absolutely sure that you
2492         have properly sanitized the command passed to this function
2493         and do not use untrusted inputs.
2494     In addition to the normal ``cmd.run`` parameters, this command offers the
2495     ``depth`` parameter to change the Windows default depth for the
2496     ``ConvertTo-JSON`` powershell command. The Windows default is 2. If you need
2497     more depth, set that here.
2498     .. note::
2499         For some commands, setting the depth to a value greater than 4 greatly
2500         increases the time it takes for the command to return and in many cases
2501         returns useless data.
2502     :param str cmd: The powershell command to run.
2503     :param str cwd: The directory from which to execute the command. Defaults
2504         to the home directory of the user specified by ``runas`` (or the user
2505         under which Salt is running if ``runas`` is not specified).
2506     :param str stdin: A string of standard input can be specified for the
2507       command to be run using the ``stdin`` parameter. This can be useful in cases
2508       where sensitive information must be read from standard input.
2509     :param str runas: Specify an alternate user to run the command. The default
2510         behavior is to run as the user under which Salt is running. If running
2511         on a Windows minion you must also use the ``password`` argument, and
2512         the target user account must be in the Administrators group.
2513     :param str password: Windows only. Required when specifying ``runas``. This
2514       parameter will be ignored on non-Windows platforms.
2515       .. versionadded:: 2016.3.0
2516     :param str shell: Specify an alternate shell. Defaults to "powershell". Can
2517         also use "pwsh" for powershell core if present on the system
2518     :param bool python_shell: If False, let python handle the positional
2519       arguments. Set to True to use shell features, such as pipes or
2520       redirection.
2521     :param dict env: Environment variables to be set prior to execution.
2522         .. note::
2523             When passing environment variables on the CLI, they should be
2524             passed as the string representation of a dictionary.
2525             .. code-block:: bash
2526                 salt myminion cmd.powershell 'some command' env='{"FOO": "bar"}'
2527         .. note::
2528             When using environment variables on Window's, case-sensitivity
2529             matters, i.e. Window's uses `Path` as opposed to `PATH` for other
2530             systems.
2531     :param bool clean_env: Attempt to clean out all other shell environment
2532         variables and set only those provided in the 'env' argument to this
2533         function.
2534     :param str template: If this setting is applied then the named templating
2535         engine will be used to render the downloaded file. Currently jinja,
2536         mako, and wempy are supported.
2537     :param bool rstrip: Strip all whitespace off the end of output before it is
2538         returned.
2539     :param str umask: The umask (in octal) to use when running the command.
2540     :param str output_encoding: Control the encoding used to decode the
2541         command's output.
2542         .. note::
2543             This should not need to be used in most cases. By default, Salt
2544             will try to use the encoding detected from the system locale, and
2545             will fall back to UTF-8 if this fails. This should only need to be
2546             used in cases where the output of the command is encoded in
2547             something other than the system locale or UTF-8.
2548             To see the encoding Salt has detected from the system locale, check
2549             the `locale` line in the output of :py:func:`test.versions_report
2550             &lt;salt.modules.test.versions_report&gt;`.
2551         .. versionadded:: 2018.3.0
2552     :param str output_loglevel: Control the loglevel at which the output from
2553         the command is logged to the minion log.
2554         .. note::
2555             The command being run will still be logged at the ``debug``
2556             loglevel regardless, unless ``quiet`` is used for this value.
2557     :param bool ignore_retcode: If the exit code of the command is nonzero,
2558         this is treated as an error condition, and the output from the command
2559         will be logged to the minion log. However, there are some cases where
2560         programs use the return code for signaling and a nonzero exit code
2561         doesn't necessarily mean failure. Pass this argument as ``True`` to
2562         skip logging the output if the command has a nonzero exit code.
2563     :param bool hide_output: If ``True``, suppress stdout and stderr in the
2564         return data.
2565         .. note::
2566             This is separate from ``output_loglevel``, which only handles how
2567             Salt logs to the minion log.
2568         .. versionadded:: 2018.3.0
2569     :param int timeout: A timeout in seconds for the executed process to return.
2570     :param bool use_vt: Use VT utils (saltstack) to stream the command output
2571         more interactively to the console and the logs. This is experimental.
2572     :param bool reset_system_locale: Resets the system locale
2573     :param str saltenv: The salt environment to use. Default is 'base'
2574     :param int depth: The number of levels of contained objects to be included.
2575         Default is 2. Values greater than 4 seem to greatly increase the time
2576         it takes for the command to complete for some commands. eg: ``dir``
2577         .. versionadded:: 2016.3.4
2578     :param bool encode_cmd: Encode the command before executing. Use in cases
2579         where characters may be dropped or incorrectly converted when executed.
2580         Default is False.
2581     :param list success_retcodes: This parameter will allow a list of
2582         non-zero return codes that should be considered a success.  If the
2583         return code returned from the run matches any in the provided list,
2584         the return code will be overridden with zero.
2585       .. versionadded:: 2019.2.0
2586     :param list success_stdout: This parameter will allow a list of
2587         strings that when found in standard out should be considered a success.
2588         If stdout returned from the run matches any in the provided list,
2589         the return code will be overridden with zero.
2590       .. versionadded:: 3004
2591     :param list success_stderr: This parameter will allow a list of
2592         strings that when found in standard error should be considered a success.
2593         If stderr returned from the run matches any in the provided list,
2594         the return code will be overridden with zero.
2595       .. versionadded:: 3004
2596     :param bool stdin_raw_newlines: False
2597         If ``True``, Salt will not automatically convert the characters ``\\n``
2598         present in the ``stdin`` value to newlines.
2599       .. versionadded:: 2019.2.0
2600     :returns:
2601         :dict: A dictionary of data returned by the powershell command.
2602     CLI Example:
2603     .. code-block:: powershell
2604         salt '*' cmd.powershell "$PSVersionTable.CLRVersion"
2605     """
2606     if shell not in ["powershell", "pwsh"]:
2607         raise CommandExecutionError(
2608             "Must specify a valid powershell binary. Must be 'powershell' or 'pwsh'"
2609         )
2610     if "python_shell" in kwargs:
2611         python_shell = kwargs.pop("python_shell")
2612     else:
2613         python_shell = True
2614     psversion = shell_info("powershell")["psversion"]
2615     if salt.utils.versions.version_cmp(psversion, "2.0") == 1:
2616         cmd += " | ConvertTo-JSON"
2617         if depth is not None:
2618             cmd += " -Depth {}".format(depth)
2619     cmd = "try {" + cmd + '} catch { "{}" }'
2620         log<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.debug("Encoding PowerShell command '%s'", cmd)
2621         cmd = "$ProgressPreference='SilentlyContinue'; {}".format(cmd)
2622         cmd_utf16 = cmd.encode("utf-16-le")
2623         cmd = base64.standard_b64encode(cmd_utf16)
2624         cmd = salt.</b></font>utils.stringutils.to_str(cmd)
2625         encoded_cmd = True
2626     else:
2627         encoded_cmd = False
2628     response = run(
2629         cmd,
2630         cwd=cwd,
2631         stdin=stdin,
2632         runas=runas,
2633         shell=shell,
2634         env=env,
2635         clean_env=clean_env,
2636         template=template,
2637         rstrip=rstrip,
2638         umask=umask,
2639         output_encoding=output_encoding,
2640         output_loglevel=output_loglevel,
2641         hide_output=hide_output,
2642         timeout=timeout,
2643         reset_system_locale=reset_system_locale,
2644         ignore_retcode=ignore_retcode,
2645         saltenv=saltenv,
2646         use_vt=use_vt,
2647         python_shell=python_shell,
2648         password=password,
2649         encoded_cmd=encoded_cmd,
2650         success_retcodes=success_retcodes,
2651         success_stdout=success_stdout,
2652         success_stderr=success_stderr,
2653         **kwargs
2654     )
2655     if response == "":
2656         response = "{}"
2657     try:
2658         return salt.utils.json.loads(response)
2659     except Exception:  # pylint: disable=broad-except
2660         log.error("Error converting PowerShell JSON return", exc_info=True)
2661         return {}
2662 def powershell_all(
2663     cmd,
2664     cwd=None,
2665     stdin=None,
2666     runas=None,
2667     shell="powershell",
2668     env=None,
2669     clean_env=False,
2670     template=None,
2671     rstrip=True,
2672     umask=None,
2673     output_encoding=None,
2674     output_loglevel="debug",
2675     quiet=False,
2676     timeout=None,
2677     reset_system_locale=True,
2678     ignore_retcode=False,
2679     saltenv=None,
2680     use_vt=False,
2681     password=None,
2682     depth=None,
2683     encode_cmd=False,
2684     force_list=False,
2685     success_retcodes=None,
2686     success_stdout=None,
2687     success_stderr=None,
2688     **kwargs
2689 ):
2690     """
2691     Execute the passed PowerShell command and return a dictionary with a result
2692     field representing the output of the command, as well as other fields
2693     showing us what the PowerShell invocation wrote to ``stderr``, the process
2694     id, and the exit code of the invocation.
2695     This function appends ``| ConvertTo-JSON`` to the command before actually
2696     invoking powershell.
2697     An unquoted empty string is not valid JSON, but it's very normal for the
2698     Powershell output to be exactly that. Therefore, we do not attempt to parse
2699     empty Powershell output (which would result in an exception). Instead we
2700     treat this as a special case and one of two things will happen:
2701     - If the value of the ``force_list`` parameter is ``True``, then the
2702       ``result`` field of the return dictionary will be an empty list.
2703     - If the value of the ``force_list`` parameter is ``False``, then the
2704       return dictionary **will not have a result key added to it**. We aren't
2705       setting ``result`` to ``None`` in this case, because ``None`` is the
2706       Python representation of "null" in JSON. (We likewise can't use ``False``
2707       for the equivalent reason.)
2708     If Powershell's output is not an empty string and Python cannot parse its
2709     content, then a ``CommandExecutionError`` exception will be raised.
2710     If Powershell's output is not an empty string, Python is able to parse its
2711     content, and the type of the resulting Python object is other than ``list``
2712     then one of two things will happen:
2713     - If the value of the ``force_list`` parameter is ``True``, then the
2714       ``result`` field will be a singleton list with the Python object as its
2715       sole member.
2716     - If the value of the ``force_list`` parameter is ``False``, then the value
2717       of ``result`` will be the unmodified Python object.
2718     If Powershell's output is not an empty string, Python is able to parse its
2719     content, and the type of the resulting Python object is ``list``, then the
2720     value of ``result`` will be the unmodified Python object. The
2721     ``force_list`` parameter has no effect in this case.
2722     .. note::
2723          An example of why the ``force_list`` parameter is useful is as
2724          follows: The Powershell command ``dir x | Convert-ToJson`` results in
2725          - no output when x is an empty directory.
2726          - a dictionary object when x contains just one item.
2727          - a list of dictionary objects when x contains multiple items.
2728          By setting ``force_list`` to ``True`` we will always end up with a
2729          list of dictionary items, representing files, no matter how many files
2730          x contains.  Conversely, if ``force_list`` is ``False``, we will end
2731          up with no ``result`` key in our return dictionary when x is an empty
2732          directory, and a dictionary object when x contains just one file.
2733     If you want a similar function but with a raw textual result instead of a
2734     Python dictionary, you should use ``cmd.run_all`` in combination with
2735     ``shell=powershell``.
2736     The remaining fields in the return dictionary are described in more detail
2737     in the ``Returns`` section.
2738     Example:
2739     .. code-block:: bash
2740         salt '*' cmd.run_all '$PSVersionTable.CLRVersion' shell=powershell
2741         salt '*' cmd.run_all 'Get-NetTCPConnection' shell=powershell
2742     .. versionadded:: 2018.3.0
2743     .. warning::
2744         This passes the cmd argument directly to PowerShell without any further
2745         processing! Be absolutely sure that you have properly sanitized the
2746         command passed to this function and do not use untrusted inputs.
2747     In addition to the normal ``cmd.run`` parameters, this command offers the
2748     ``depth`` parameter to change the Windows default depth for the
2749     ``ConvertTo-JSON`` powershell command. The Windows default is 2. If you need
2750     more depth, set that here.
2751     .. note::
2752         For some commands, setting the depth to a value greater than 4 greatly
2753         increases the time it takes for the command to return and in many cases
2754         returns useless data.
2755     :param str cmd: The powershell command to run.
2756     :param str cwd: The directory from which to execute the command. Defaults
2757         to the home directory of the user specified by ``runas`` (or the user
2758         under which Salt is running if ``runas`` is not specified).
2759     :param str stdin: A string of standard input can be specified for the
2760         command to be run using the ``stdin`` parameter. This can be useful in
2761         cases where sensitive information must be read from standard input.
2762     :param str runas: Specify an alternate user to run the command. The default
2763         behavior is to run as the user under which Salt is running. If running
2764         on a Windows minion you must also use the ``password`` argument, and
2765         the target user account must be in the Administrators group.
2766     :param str password: Windows only. Required when specifying ``runas``. This
2767         parameter will be ignored on non-Windows platforms.
2768     :param str shell: Specify an alternate shell. Defaults to "powershell". Can
2769         also use "pwsh" for powershell core if present on the system
2770     :param bool python_shell: If False, let python handle the positional
2771         arguments. Set to True to use shell features, such as pipes or
2772         redirection.
2773     :param dict env: Environment variables to be set prior to execution.
2774         .. note::
2775             When passing environment variables on the CLI, they should be
2776             passed as the string representation of a dictionary.
2777             .. code-block:: bash
2778                 salt myminion cmd.powershell_all 'some command' env='{"FOO": "bar"}'
2779         .. note::
2780             When using environment variables on Window's, case-sensitivity
2781             matters, i.e. Window's uses `Path` as opposed to `PATH` for other
2782             systems.
2783     :param bool clean_env: Attempt to clean out all other shell environment
2784         variables and set only those provided in the 'env' argument to this
2785         function.
2786     :param str template: If this setting is applied then the named templating
2787         engine will be used to render the downloaded file. Currently jinja,
2788         mako, and wempy are supported.
2789     :param bool rstrip: Strip all whitespace off the end of output before it is
2790         returned.
2791     :param str umask: The umask (in octal) to use when running the command.
2792     :param str output_encoding: Control the encoding used to decode the
2793         command's output.
2794         .. note::
2795             This should not need to be used in most cases. By default, Salt
2796             will try to use the encoding detected from the system locale, and
2797             will fall back to UTF-8 if this fails. This should only need to be
2798             used in cases where the output of the command is encoded in
2799             something other than the system locale or UTF-8.
2800             To see the encoding Salt has detected from the system locale, check
2801             the `locale` line in the output of :py:func:`test.versions_report
2802             &lt;salt.modules.test.versions_report&gt;`.
2803         .. versionadded:: 2018.3.0
2804     :param str output_loglevel: Control the loglevel at which the output from
2805         the command is logged to the minion log.
2806         .. note::
2807             The command being run will still be logged at the ``debug``
2808             loglevel regardless, unless ``quiet`` is used for this value.
2809     :param bool ignore_retcode: If the exit code of the command is nonzero,
2810         this is treated as an error condition, and the output from the command
2811         will be logged to the minion log. However, there are some cases where
2812         programs use the return code for signaling and a nonzero exit code
2813         doesn't necessarily mean failure. Pass this argument as ``True`` to
2814         skip logging the output if the command has a nonzero exit code.
2815     :param int timeout: A timeout in seconds for the executed process to
2816         return.
2817     :param bool use_vt: Use VT utils (saltstack) to stream the command output
2818         more interactively to the console and the logs. This is experimental.
2819     :param bool reset_system_locale: Resets the system locale
2820     :param bool ignore_retcode: If the exit code of the command is nonzero,
2821         this is treated as an error condition, and the output from the command
2822         will be logged to the minion log. However, there are some cases where
2823         programs use the return code for signaling and a nonzero exit code
2824         doesn't necessarily mean failure. Pass this argument as ``True`` to
2825         skip logging the output if the command has a nonzero exit code.
2826     :param str saltenv: The salt environment to use. Default is 'base'
2827     :param int depth: The number of levels of contained objects to be included.
2828         Default is 2. Values greater than 4 seem to greatly increase the time
2829         it takes for the command to complete for some commands. eg: ``dir``
2830     :param bool encode_cmd: Encode the command before executing. Use in cases
2831         where characters may be dropped or incorrectly converted when executed.
2832         Default is False.
2833     :param bool force_list: The purpose of this parameter is described in the
2834         preamble of this function's documentation. Default value is False.
2835     :param list success_retcodes: This parameter will allow a list of
2836         non-zero return codes that should be considered a success.  If the
2837         return code returned from the run matches any in the provided list,
2838         the return code will be overridden with zero.
2839       .. versionadded:: 2019.2.0
2840     :param list success_stdout: This parameter will allow a list of
2841         strings that when found in standard out should be considered a success.
2842         If stdout returned from the run matches any in the provided list,
2843         the return code will be overridden with zero.
2844       .. versionadded:: 3004
2845     :param list success_stderr: This parameter will allow a list of
2846         strings that when found in standard error should be considered a success.
2847         If stderr returned from the run matches any in the provided list,
2848         the return code will be overridden with zero.
2849       .. versionadded:: 3004
2850     :param bool stdin_raw_newlines: False
2851         If ``True``, Salt will not automatically convert the characters ``\\n``
2852         present in the ``stdin`` value to newlines.
2853       .. versionadded:: 2019.2.0
2854     :return: A dictionary with the following entries:
2855         result
2856             For a complete description of this field, please refer to this
2857             function's preamble. **This key will not be added to the dictionary
2858             when force_list is False and Powershell's output is the empty
2859             string.**
2860         stderr
2861             What the PowerShell invocation wrote to ``stderr``.
2862         pid
2863             The process id of the PowerShell invocation
2864         retcode
2865             This is the exit code of the invocation of PowerShell.
2866             If the final execution status (in PowerShell) of our command
2867             (with ``| ConvertTo-JSON`` appended) is ``False`` this should be non-0.
2868             Likewise if PowerShell exited with ``$LASTEXITCODE`` set to some
2869             non-0 value, then ``retcode`` will end up with this value.
2870     :rtype: dict
2871     CLI Example:
2872     .. code-block:: bash
2873         salt '*' cmd.powershell_all "$PSVersionTable.CLRVersion"
2874     CLI Example:
2875     .. code-block:: bash
2876         salt '*' cmd.powershell_all "dir mydirectory" force_list=True
2877     """
2878     if shell not in ["powershell", "pwsh"]:
2879         raise CommandExecutionError(
2880             "Must specify a valid powershell binary. Must be 'powershell' or 'pwsh'"
2881         )
2882     if "python_shell" in kwargs:
2883         python_shell = kwargs.pop("python_shell")
2884     else:
2885         python_shell = True
2886     cmd += " | ConvertTo-JSON"
2887     if depth is not None:
2888         cmd += " -Depth {}".format(depth)
2889         log<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.debug("Encoding PowerShell command '%s'", cmd)
2890         cmd = "$ProgressPreference='SilentlyContinue'; {}".format(cmd)
2891         cmd_utf16 = cmd.encode("utf-16-le")
2892         cmd = base64.standard_b64encode(cmd_utf16)
2893         cmd = salt.</b></font>utils.stringutils.to_str(cmd)
2894         encoded_cmd = True
2895     else:
2896         encoded_cmd = False
2897     response = run_all(
2898         cmd,
2899         cwd=cwd,
2900         stdin=stdin,
2901         runas=runas,
2902         shell=shell,
2903         env=env,
2904         clean_env=clean_env,
2905         template=template,
2906         rstrip=rstrip,
2907         umask=umask,
2908         output_encoding=output_encoding,
2909         output_loglevel=output_loglevel,
2910         quiet=quiet,
2911         timeout=timeout,
2912         reset_system_locale=reset_system_locale,
2913         ignore_retcode=ignore_retcode,
2914         saltenv=saltenv,
2915         use_vt=use_vt,
2916         python_shell=python_shell,
2917         password=password,
2918         encoded_cmd=encoded_cmd,
2919         success_retcodes=success_retcodes,
2920         success_stdout=success_stdout,
2921         success_stderr=success_stderr,
2922         **kwargs
2923     )
2924     stdoutput = response["stdout"]
2925     if not stdoutput:
2926         response.pop("stdout")
2927         if force_list:
2928             response["result"] = []
2929         return response
2930     try:
2931         result = salt.utils.json.loads(stdoutput)
2932     except Exception:  # pylint: disable=broad-except
2933         err_msg = "cmd.powershell_all " + "cannot parse the Powershell output."
2934         response["cmd"] = cmd
2935         raise CommandExecutionError(message=err_msg, info=response)
2936     response.pop("stdout")
2937     if type(result) is not list:
2938         if force_list:
2939             response["result"] = [result]
2940         else:
2941             response["result"] = result
2942     else:
2943         response["result"] = result
2944     return response
2945 def run_bg(
2946     cmd,
2947     cwd=None,
2948     runas=None,
2949     group=None,
2950     shell=DEFAULT_SHELL,
2951     python_shell=None,
2952     env=None,
2953     clean_env=False,
2954     template=None,
2955     umask=None,
2956     timeout=None,
2957     output_encoding=None,
2958     output_loglevel="debug",
2959     log_callback=None,
2960     reset_system_locale=True,
2961     ignore_retcode=False,
2962     saltenv=None,
2963     password=None,
2964     prepend_path=None,
2965     success_retcodes=None,
2966     success_stdout=None,
2967     success_stderr=None,
2968     **kwargs
2969 ):
2970     r"""
2971     .. versionadded:: 2016.3.0
2972     Execute the passed command in the background and return its PID
2973     .. note::
2974         If the init system is systemd and the backgrounded task should run even
2975         if the salt-minion process is restarted, prepend ``systemd-run
2976         --scope`` to the command. This will reparent the process in its own
2977         scope separate from salt-minion, and will not be affected by restarting
2978         the minion service.
2979     :param str cmd: The command to run. ex: ``ls -lart /home``
2980     :param str cwd: The directory from which to execute the command. Defaults
2981         to the home directory of the user specified by ``runas`` (or the user
2982         under which Salt is running if ``runas`` is not specified).
2983     :param str group: Group to run command as. Not currently supported
2984       on Windows.
2985     :param str shell: Shell to execute under. Defaults to the system default
2986       shell.
2987     :param str output_encoding: Control the encoding used to decode the
2988         command's output.
2989         .. note::
2990             This should not need to be used in most cases. By default, Salt
2991             will try to use the encoding detected from the system locale, and
2992             will fall back to UTF-8 if this fails. This should only need to be
2993             used in cases where the output of the command is encoded in
2994             something other than the system locale or UTF-8.
2995             To see the encoding Salt has detected from the system locale, check
2996             the `locale` line in the output of :py:func:`test.versions_report
2997             &lt;salt.modules.test.versions_report&gt;`.
2998         .. versionadded:: 2018.3.0
2999     :param str output_loglevel: Control the loglevel at which the output from
3000         the command is logged to the minion log.
3001         .. note::
3002             The command being run will still be logged at the ``debug``
3003             loglevel regardless, unless ``quiet`` is used for this value.
3004     :param bool ignore_retcode: If the exit code of the command is nonzero,
3005         this is treated as an error condition, and the output from the command
3006         will be logged to the minion log. However, there are some cases where
3007         programs use the return code for signaling and a nonzero exit code
3008         doesn't necessarily mean failure. Pass this argument as ``True`` to
3009         skip logging the output if the command has a nonzero exit code.
3010     :param str runas: Specify an alternate user to run the command. The default
3011         behavior is to run as the user under which Salt is running. If running
3012         on a Windows minion you must also use the ``password`` argument, and
3013         the target user account must be in the Administrators group.
3014         .. warning::
3015             For versions 2018.3.3 and above on macosx while using runas,
3016             to pass special characters to the command you need to escape
3017             the characters on the shell.
3018             Example:
3019             .. code-block:: bash
3020                 cmd.run_bg 'echo '\''h=\"baz\"'\''' runas=macuser
3021     :param str password: Windows only. Required when specifying ``runas``. This
3022         parameter will be ignored on non-Windows platforms.
3023         .. versionadded:: 2016.3.0
3024     :param str shell: Specify an alternate shell. Defaults to the system's
3025         default shell.
3026     :param bool python_shell: If False, let python handle the positional
3027         arguments. Set to True to use shell features, such as pipes or
3028         redirection.
3029     :param dict env: Environment variables to be set prior to execution.
3030         .. note::
3031             When passing environment variables on the CLI, they should be
3032             passed as the string representation of a dictionary.
3033             .. code-block:: bash
3034                 salt myminion cmd.run_bg 'some command' env='{"FOO": "bar"}'
3035         .. note::
3036             When using environment variables on Window's, case-sensitivity
3037             matters, i.e. Window's uses `Path` as opposed to `PATH` for other
3038             systems.
3039     :param bool clean_env: Attempt to clean out all other shell environment
3040         variables and set only those provided in the 'env' argument to this
3041         function.
3042     :param str prepend_path: $PATH segment to prepend (trailing ':' not
3043         necessary) to $PATH
3044         .. versionadded:: 2018.3.0
3045     :param str template: If this setting is applied then the named templating
3046         engine will be used to render the downloaded file. Currently jinja,
3047         mako, and wempy are supported.
3048     :param str umask: The umask (in octal) to use when running the command.
3049     :param int timeout: A timeout in seconds for the executed process to return.
3050     .. warning::
3051         This function does not process commands through a shell unless the
3052         ``python_shell`` argument is set to ``True``. This means that any
3053         shell-specific functionality such as 'echo' or the use of pipes,
3054         redirection or &amp;&amp;, should either be migrated to cmd.shell or have the
3055         python_shell=True flag set here.
3056         The use of ``python_shell=True`` means that the shell will accept _any_
3057         input including potentially malicious commands such as 'good_command;rm
3058         -rf /'.  Be absolutely certain that you have sanitized your input prior
3059         to using ``python_shell=True``.
3060     :param list success_retcodes: This parameter will allow a list of
3061         non-zero return codes that should be considered a success.  If the
3062         return code returned from the run matches any in the provided list,
3063         the return code will be overridden with zero.
3064       .. versionadded:: 2019.2.0
3065     :param list success_stdout: This parameter will allow a list of
3066         strings that when found in standard out should be considered a success.
3067         If stdout returned from the run matches any in the provided list,
3068         the return code will be overridden with zero.
3069       .. versionadded:: 3004
3070     :param list success_stderr: This parameter will allow a list of
3071         strings that when found in standard error should be considered a success.
3072         If stderr returned from the run matches any in the provided list,
3073         the return code will be overridden with zero.
3074       .. versionadded:: 3004
3075     :param bool stdin_raw_newlines: False
3076         If ``True``, Salt will not automatically convert the characters ``\\n``
3077         present in the ``stdin`` value to newlines.
3078       .. versionadded:: 2019.2.0
3079     CLI Example:
3080     .. code-block:: bash
3081         salt '*' cmd.run_bg "fstrim-all"
3082     The template arg can be set to 'jinja' or another supported template
3083     engine to render the command arguments before execution.
3084     For example:
3085     .. code-block:: bash
3086         salt '*' cmd.run_bg template=jinja "ls -l /tmp/{{grains.id}} | awk '/foo/{print \\$2}'"
3087     Specify an alternate shell with the shell parameter:
3088     .. code-block:: bash
3089         salt '*' cmd.run_bg "Get-ChildItem C:\\ " shell='powershell'
3090     If an equal sign (``=``) appears in an argument to a Salt command it is
3091     interpreted as a keyword argument in the format ``key=val``. That
3092     processing can be bypassed in order to pass an equal sign through to the
3093     remote shell command by manually specifying the kwarg:
3094     .. code-block:: bash
3095         salt '*' cmd.run_bg cmd='ls -lR / | sed -e s/=/:/g &gt; /tmp/dontwait'
3096     """
3097     python_shell = _python_shell_default(python_shell, kwargs.get("__pub_jid", ""))
3098     res = _run(
3099         cmd,
3100         stdin=None,
3101         stderr=None,
3102         stdout=None,
3103         output_encoding=output_encoding,
3104         output_loglevel=output_loglevel,
3105         use_vt=None,
3106         bg=True,
3107         with_communicate=False,
3108         rstrip=False,
3109         runas=runas,
3110         group=group,
3111         shell=shell,
3112         python_shell=python_shell,
3113         cwd=cwd,
3114         env=env,
3115         clean_env=clean_env,
3116         prepend_path=prepend_path,
3117         template=template,
3118         umask=umask,
3119         log_callback=log_callback,
3120         timeout=timeout,
3121         reset_system_locale=reset_system_locale,
3122         saltenv=saltenv,
3123         password=password,
3124         success_retcodes=success_retcodes,
3125         success_stdout=success_stdout,
3126         success_stderr=success_stderr,
3127         **kwargs
3128     )
3129     return {"pid": res["pid"]}
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>network_4.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 """
2 Define some generic socket functions for network modules
3 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import fnmatch
4 import itertools
5 import logging
6 import os
7 import platform
8 import random
9 import re
10 import socket
11 import subprocess
12 import types
13 from collections.abc import Mapping, Sequence
14 from string import ascii_letters, digits
15 import salt.utils.args
16 import salt.utils.files
17 import salt.utils.path
18 import salt.utils.platform
19 import salt.utils.stringutils
20 import salt.utils.zeromq
21 from salt._compat import ipaddress
22 from salt.exceptions import SaltClientError, SaltSystemExit
23 from salt.utils.decorators.jinja import jinja_filter
24 from salt.utils.versions import LooseVersion
25 try:
26     import</b></font> salt.utils.win_network
27     WIN_NETWORK_LOADED = True
28 except ImportError:
29     WIN_NETWORK_LOADED = False
30 log = logging.getLogger(__name__)
31 try:
32     import ctypes
33     import ctypes.util
34     LIBC = ctypes.cdll.LoadLibrary(ctypes.util.find_library("c"))
35     RES_INIT = LIBC.__res_init
36 except (ImportError, OSError, AttributeError, TypeError):
37     pass
38 class Interfaces:
39     __slots__ = ("interfaces",)
40     def __init__(self, interfaces=None):
41         if interfaces is None:
42             interfaces = {}
43         self.interfaces = interfaces
44     def __call__(self, *args, **kwargs):
45         if not self.interfaces:
46             self.interfaces = interfaces()
47         return self.interfaces
48     def clear(self):
49         self.interfaces = {}
50 _get_interfaces = Interfaces()
51 _clear_interfaces = _get_interfaces.clear
52 def sanitize_host(host):
53     """
54     Sanitize host string.
55     https://tools.ietf.org/html/rfc1123#section-2.1
56     """
57     RFC952_characters = ascii_letters + digits + ".-_"
58     return "".join([c for c in host[0:255] if c in RFC952_characters])
59 def isportopen(host, port):
60     """
61     Return status of a port
62     """
63     if not 1 &lt;= int(port) &lt;= 65535:
64         return False
65     sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
66     out = sock.connect_ex((sanitize_host(host), int(port)))
67     return out
68 def host_to_ips(host):
69     """
70     Returns a list of IP addresses of a given hostname or None if not found.
71     """
72     ips = []
73     try:
74         for family, socktype, proto, canonname, sockaddr in socket.getaddrinfo(
75             host, 0, socket.AF_UNSPEC, socket.SOCK_STREAM
76         ):
77             if family == socket.AF_INET:
78                 ip, port = sockaddr
79             elif family == socket.AF_INET6:
80                 ip, port, flow_info, scope_id = sockaddr
81             ips.append(ip)
82         if not ips:
83             ips = None
84     except Exception:  # pylint: disable=broad-except
85         ips = None
86     return ips
87 def _generate_minion_id():
88     """
89     Get list of possible host names and convention names.
90     :return:
91     """
92     class DistinctList(list):
93         """
94         List, which allows one to append only distinct objects.
95         Needs to work on Python 2.6, because of collections.OrderedDict only since 2.7 version.
96         Override 'filter()' for custom filtering.
97         """
98         localhost_matchers = [
99             r"localhost.*",
100             r"ip6-.*",
101             r"127[.]\d",
102             r"0\.0\.0\.0",
103             r"::1.*",
104             r"ipv6-.*",
105             r"fe00::.*",
106             r"fe02::.*",
107             r"1.0.0.*.ip6.arpa",
108         ]
109         def append(self, p_object):
110             if p_object and p_object not in self and not self.filter(p_object):
111                 super().append(p_object)
112             return self
113         def extend(self, iterable):
114             for obj in iterable:
115                 self.append(obj)
116             return self
117         def filter(self, element):
118             "Returns True if element needs to be filtered"
119             for rgx in self.localhost_matchers:
120                 if re.match(rgx, element):
121                     return True
122         def first(self):
123             return self and self[0] or None
124     hostname = socket.gethostname()
125     hosts = (
126         DistinctList()
127         .append(
128             salt.utils.stringutils.to_unicode(
129                 socket.getfqdn(salt.utils.stringutils.to_bytes(hostname))
130             )
131         )
132         .append(platform.node())
133         .append(hostname)
134     )
135     if not hosts:
136         try:
137             for a_nfo in socket.getaddrinfo(
138                 hosts.first() or "localhost",
139                 None,
140                 socket.AF_INET,
141                 socket.SOCK_RAW,
142                 socket.IPPROTO_IP,
143                 socket.AI_CANONNAME,
144             ):
145                 if len(a_nfo) &gt; 3:
146                     hosts.append(a_nfo[3])
147         except socket.gaierror:
148             log.warning(
149                 "Cannot resolve address %s info via socket: %s",
150                 hosts.first() or "localhost (N/A)",
151                 socket.gaierror,
152             )
153     for f_name in (
154         "/etc/hostname",
155         "/etc/nodename",
156         "/etc/hosts",
157         r"{win}\system32\drivers\etc\hosts".format(win=os.getenv("WINDIR")),
158     ):
159         try:
160             with salt.utils.files.fopen(f_name) as f_hdl:
161                 for line in f_hdl:
162                     line = salt.utils.stringutils.to_unicode(line)
163                     hst = line.strip().split("#")[0].strip().split()
164                     if hst:
165                         if hst[0][:4] in ("127.", "::1") or len(hst) == 1:
166                             hosts.extend(hst)
167         except OSError:
168             pass
169     return hosts.extend(
170         [addr for addr in ip_addrs() if not ipaddress.ip_address(addr).is_loopback]
171     )
172 def generate_minion_id():
173     """
174     Return only first element of the hostname from all possible list.
175     :return:
176     """
177     try:
178         ret = salt.utils.stringutils.to_unicode(_generate_minion_id().first())
179     except TypeError:
180         ret = None
181     return ret or "localhost"
182 def get_socket(addr, type=socket.SOCK_STREAM, proto=0):
183     """
184     Return a socket object for the addr
185     IP-version agnostic
186     """
187     version = ipaddress.ip_address(addr).version
188     if version == 4:
189         family = socket.AF_INET
190     elif version == 6:
191         family = socket.AF_INET6
192     return socket.socket(family, type, proto)
193 def get_fqhostname():
194     """
195     Returns the fully qualified hostname
196     """
197     l = [socket.getfqdn()]
198     try:
199         addrinfo = socket.getaddrinfo(
200             socket.gethostname(),
201             0,
202             socket.AF_UNSPEC,
203             socket.SOCK_STREAM,
204             socket.SOL_TCP,
205             socket.AI_CANONNAME,
206         )
207         for info in addrinfo:
208             if len(info) &gt;= 4 and info[3]:
209                 l = [info[3]]
210     except socket.gaierror:
211         pass
212     return l and l[0] or None
213 def ip_to_host(ip):
214     """
215     Returns the hostname of a given IP
216     """
217     try:
218         hostname, aliaslist, ipaddrlist = socket.gethostbyaddr(ip)
219     except Exception as exc:  # pylint: disable=broad-except
220         log.debug("salt.utils.network.ip_to_host(%r) failed: %s", ip, exc)
221         hostname = None
222     return hostname
223 def is_reachable_host(entity_name):
224     """
225     Returns a bool telling if the entity name is a reachable host (IPv4/IPv6/FQDN/etc).
226     :param hostname:
227     :return:
228     """
229     try:
230         assert type(socket.getaddrinfo(entity_name, 0, 0, 0, 0)) == list
231         ret = True
232     except socket.gaierror:
233         ret = False
234     return ret
235 def is_ip(ip_addr):
236     """
237     Returns a bool telling if the passed IP is a valid IPv4 or IPv6 address.
238     """
239     return is_ipv4(ip_addr) or is_ipv6(ip_addr)
240 def is_ipv4(ip_addr):
241     """
242     Returns a bool telling if the value passed to it was a valid IPv4 address
243     """
244     try:
245         return ipaddress.ip_address(ip_addr).version == 4
246     except ValueError:
247         return False
248 def is_ipv6(ip_addr):
249     """
250     Returns a bool telling if the value passed to it was a valid IPv6 address
251     """
252     try:
253         return ipaddress.ip_address(ip_addr).version == 6
254     except ValueError:
255         return False
256 def is_subnet(cidr):
257     """
258     Returns a bool telling if the passed string is an IPv4 or IPv6 subnet
259     """
260     return is_ipv4_subnet(cidr) or is_ipv6_subnet(cidr)
261 def is_ipv4_subnet(cidr):
262     """
263     Returns a bool telling if the passed string is an IPv4 subnet
264     """
265     try:
266         return "/" in cidr and bool(ipaddress.IPv4Network(cidr))
267     except Exception:  # pylint: disable=broad-except
268         return False
269 def is_ipv6_subnet(cidr):
270     """
271     Returns a bool telling if the passed string is an IPv6 subnet
272     """
273     try:
274         return "/" in cidr and bool(ipaddress.IPv6Network(cidr))
275     except Exception:  # pylint: disable=broad-except
276         return False
277 @jinja_filter("is_ip")
278 def is_ip_filter(ip_addr, options=None):
279     """
280     Returns a bool telling if the passed IP is a valid IPv4 or IPv6 address.
281     """
282     return is_ipv4_filter(ip_addr, options=options) or is_ipv6_filter(
283         ip_addr, options=options
284     )
285 def _ip_options_global(ip_obj, version):
286     return not ip_obj.is_private
287 def _ip_options_multicast(ip_obj, version):
288     return ip_obj.is_multicast
289 def _ip_options_loopback(ip_obj, version):
290     return ip_obj.is_loopback
291 def _ip_options_link_local(ip_obj, version):
292     return ip_obj.is_link_local
293 def _ip_options_private(ip_obj, version):
294     return ip_obj.is_private
295 def _ip_options_reserved(ip_obj, version):
296     return ip_obj.is_reserved
297 def _ip_options_site_local(ip_obj, version):
298     if version == 6:
299         return ip_obj.is_site_local
300     return False
301 def _ip_options_unspecified(ip_obj, version):
302     return ip_obj.is_unspecified
303 def _ip_options(ip_obj, version, options=None):
304     options_fun_map = {
305         "global": _ip_options_global,
306         "link-local": _ip_options_link_local,
307         "linklocal": _ip_options_link_local,
308         "ll": _ip_options_link_local,
309         "link_local": _ip_options_link_local,
310         "loopback": _ip_options_loopback,
311         "lo": _ip_options_loopback,
312         "multicast": _ip_options_multicast,
313         "private": _ip_options_private,
314         "public": _ip_options_global,
315         "reserved": _ip_options_reserved,
316         "site-local": _ip_options_site_local,
317         "sl": _ip_options_site_local,
318         "site_local": _ip_options_site_local,
319         "unspecified": _ip_options_unspecified,
320     }
321     if not options:
322         return str(ip_obj)  # IP version already checked
323     options_list = [option.strip() for option in options.split(",")]
324     for option, fun in options_fun_map.items():
325         if option in options_list:
326             fun_res = fun(ip_obj, version)
327             if not fun_res:
328                 return None
329     return str(ip_obj)
330 def _is_ipv(ip_addr, version, options=None):
331     if not version:
332         version = 4
333     if version not in (4, 6):
334         return None
335     try:
336         ip_obj = ipaddress.ip_address(ip_addr)
337     except ValueError:
338         try:
339             ip_obj = ipaddress.ip_interface(ip_addr)
340         except ValueError:
341             return None
342     if not ip_obj.version == version:
343         return None
344     return _ip_options(ip_obj, version, options=options)
345 @jinja_filter("is_ipv4")
346 def is_ipv4_filter(ip_addr, options=None):
347     """
348     Returns a bool telling if the value passed to it was a valid IPv4 address.
349     ip
350         The IP address.
351     net: False
352         Consider IP addresses followed by netmask.
353     options
354         CSV of options regarding the nature of the IP address. E.g.: loopback, multicast, private etc.
355     """
356     _is_ipv4 = _is_ipv(ip_addr, 4, options=options)
357     return isinstance(_is_ipv4, str)
358 @jinja_filter("is_ipv6")
359 def is_ipv6_filter(ip_addr, options=None):
360     """
361     Returns a bool telling if the value passed to it was a valid IPv6 address.
362     ip
363         The IP address.
364     net: False
365         Consider IP addresses followed by netmask.
366     options
367         CSV of options regarding the nature of the IP address. E.g.: loopback, multicast, private etc.
368     """
369     _is_ipv6 = _is_ipv(ip_addr, 6, options=options)
370     return isinstance(_is_ipv6, str)
371 def _ipv_filter(value, version, options=None):
372     if version not in (4, 6):
373         return
374     if isinstance(value, (str, bytes)):
375         return _is_ipv(
376             value, version, options=options
377         )  # calls is_ipv4 or is_ipv6 for `value`
378     elif isinstance(value, (list, tuple, types.GeneratorType)):
379         return [
380             _is_ipv(addr, version, options=options)
381             for addr in value
382             if _is_ipv(addr, version, options=options) is not None
383         ]
384     return None
385 @jinja_filter("ipv4")
386 def ipv4(value, options=None):
387     """
388     Filters a list and returns IPv4 values only.
389     """
390     return _ipv_filter(value, 4, options=options)
391 @jinja_filter("ipv6")
392 def ipv6(value, options=None):
393     """
394     Filters a list and returns IPv6 values only.
395     """
396     return _ipv_filter(value, 6, options=options)
397 @jinja_filter("ipaddr")
398 def ipaddr(value, options=None):
399     """
400     Filters and returns only valid IP objects.
401     """
402     ipv4_obj = ipv4(value, options=options)
403     ipv6_obj = ipv6(value, options=options)
404     if ipv4_obj is None or ipv6_obj is None:
405         return ipv4_obj or ipv6_obj  # one of them
406     else:
407         return ipv4_obj + ipv6_obj  # extend lists
408 def _filter_ipaddr(value, options, version=None):
409     ipaddr_filter_out = None
410     if version:
411         if version == 4:
412             ipaddr_filter_out = ipv4(value, options)
413         elif version == 6:
414             ipaddr_filter_out = ipv6(value, options)
415     else:
416         ipaddr_filter_out = ipaddr(value, options)
417     if not ipaddr_filter_out:
418         return
419     if not isinstance(ipaddr_filter_out, (list, tuple, types.GeneratorType)):
420         ipaddr_filter_out = [ipaddr_filter_out]
421     return ipaddr_filter_out
422 @jinja_filter("ip_host")
423 def ip_host(value, options=None, version=None):
424     """
425     Returns the interfaces IP address, e.g.: 192.168.0.1/28.
426     """
427     ipaddr_filter_out = _filter_ipaddr(value, options=options, version=version)
428     if not ipaddr_filter_out:
429         return
430     if not isinstance(value, (list, tuple, types.GeneratorType)):
431         return str(ipaddress.ip_interface(ipaddr_filter_out[0]))
432     return [str(ipaddress.ip_interface(ip_a)) for ip_a in ipaddr_filter_out]
433 def _network_hosts(ip_addr_entry):
434     return [
435         str(host) for host in ipaddress.ip_network(ip_addr_entry, strict=False).hosts()
436     ]
437 @jinja_filter("network_hosts")
438 def network_hosts(value, options=None, version=None):
439     """
440     Return the list of hosts within a network.
441     .. note::
442         When running this command with a large IPv6 network, the command will
443         take a long time to gather all of the hosts.
444     """
445     ipaddr_filter_out = _filter_ipaddr(value, options=options, version=version)
446     if not ipaddr_filter_out:
447         return
448     if not isinstance(value, (list, tuple, types.GeneratorType)):
449         return _network_hosts(ipaddr_filter_out[0])
450     return [_network_hosts(ip_a) for ip_a in ipaddr_filter_out]
451 def _network_size(ip_addr_entry):
452     return ipaddress.ip_network(ip_addr_entry, strict=False).num_addresses
453 @jinja_filter("network_size")
454 def network_size(value, options=None, version=None):
455     """
456     Get the size of a network.
457     """
458     ipaddr_filter_out = _filter_ipaddr(value, options=options, version=version)
459     if not ipaddr_filter_out:
460         return
461     if not isinstance(value, (list, tuple, types.GeneratorType)):
462         return _network_size(ipaddr_filter_out[0])
463     return [_network_size(ip_a) for ip_a in ipaddr_filter_out]
464 def natural_ipv4_netmask(ip_addr, fmt="prefixlen"):
465     """
466     Returns the "natural" mask of an IPv4 address
467     """
468     bits = _ipv4_to_bits(ip_addr)
469     if bits.startswith("11"):
470         mask = "24"
471     elif bits.startswith("1"):
472         mask = "16"
473     else:
474         mask = "8"
475     if fmt == "netmask":
476         return cidr_to_ipv4_netmask(mask)
477     else:
478         return "/" + mask
479 def rpad_ipv4_network(ip_addr):
480     """
481     Returns an IP network address padded with zeros.
482     Ex: '192.168.3' -&gt; '192.168.3.0'
483         '10.209' -&gt; '10.209.0.0'
484     """
485     return ".".join(itertools.islice(itertools.chain(ip_addr.split("."), "0000"), 0, 4))
486 def cidr_to_ipv4_netmask(cidr_bits):
487     """
488     Returns an IPv4 netmask
489     """
490     try:
491         cidr_bits = int(cidr_bits)
492         if not 1 &lt;= cidr_bits &lt;= 32:
493             return ""
494     except ValueError:
495         return ""
496     netmask = ""
497     for idx in range(4):
498         if idx:
499             netmask += "."
500         if cidr_bits &gt;= 8:
501             netmask += "255"
502             cidr_bits -= 8
503         else:
504             netmask += "{:d}".format(256 - (2 ** (8 - cidr_bits)))
505             cidr_bits = 0
506     return netmask
507 def _number_of_set_bits_to_ipv4_netmask(set_bits):
508     """
509     Returns an IPv4 netmask from the integer representation of that mask.
510     Ex. 0xffffff00 -&gt; '255.255.255.0'
511     """
512     return cidr_to_ipv4_netmask(_number_of_set_bits(set_bits))
513 def _number_of_set_bits(x):
514     """
515     Returns the number of bits that are set in a 32bit int
516     """
517     x -= (x &gt;&gt; 1) &amp; 0x55555555
518     x = ((x &gt;&gt; 2) &amp; 0x33333333) + (x &amp; 0x33333333)
519     x = ((x &gt;&gt; 4) + x) &amp; 0x0F0F0F0F
520     x += x &gt;&gt; 8
521     x += x &gt;&gt; 16
522     return x &amp; 0x0000003F
523 def _interfaces_ip(out):
524     """
525     Uses ip to return a dictionary of interfaces with various information about
526     each (up/down state, ip address, netmask, and hwaddr)
527     """
528     ret = dict()
529     def parse_network(value, cols):
530         """
531         Return a tuple of ip, netmask, broadcast
532         based on the current set of cols
533         """
534         brd = None
535         scope = None
536         if "/" in value:  # we have a CIDR in this address
537             ip, cidr = value.split("/")
538         else:
539             ip = value
540             cidr = 32
541         if type_ == "inet":
542             mask = cidr_to_ipv4_netmask(int(cidr))
543             if "brd" in cols:
544                 brd = cols[cols.index("brd") + 1]
545         elif type_ == "inet6":
546             mask = cidr
547             if "scope" in cols:
548                 scope = cols[cols.index("scope") + 1]
549         return (ip, mask, brd, scope)
550     groups = re.compile("\r?\n\\d").split(out)
551     for group in groups:
552         iface = None
553         data = dict()
554         for line in group.splitlines():
555             if " " not in line:
556                 continue
557             match = re.match(r"^\d*:\s+([\w.\-]+)(?:@)?([\w.\-]+)?:\s+&lt;(.+)&gt;", line)
558             if match:
559                 iface, parent, attrs = match.groups()
560                 if "UP" in attrs.split(","):
561                     data["up"] = True
562                 else:
563                     data["up"] = False
564                 if parent:
565                     data["parent"] = parent
566                 continue
567             cols = line.split()
568             if len(cols) &gt;= 2:
569                 type_, value = tuple(cols[0:2])
570                 iflabel = cols[-1:][0]
571                 if type_ in ("inet", "inet6"):
572                     ipaddr, netmask, broadcast, scope = parse_network(value, cols)
573                     addr_obj = dict()
574                     if "secondary" not in cols:
575                         if type_ == "inet":
576                             if "inet" not in data:
577                                 data["inet"] = list()
578                             addr_obj["address"] = ipaddr
579                             addr_obj["netmask"] = netmask
580                             addr_obj["broadcast"] = broadcast
581                             addr_obj["label"] = iflabel
582                             data["inet"].append(addr_obj)
583                         elif type_ == "inet6":
584                             if "inet6" not in data:
585                                 data["inet6"] = list()
586                             addr_obj["address"] = ipaddr
587                             addr_obj["prefixlen"] = netmask
588                             addr_obj["scope"] = scope
589                             data["inet6"].append(addr_obj)
590                     else:
591                         if type_ == "inet":
592                             if "secondary" not in data:
593                                 data["secondary"] = list()
594                             addr_obj["type"] = type_
595                             addr_obj["address"] = ipaddr
596                             addr_obj["netmask"] = netmask
597                             addr_obj["broadcast"] = broadcast
598                             addr_obj["label"] = iflabel
599                             data["secondary"].append(addr_obj)
600                         elif type_ == "inet6":
601                             if "secondary" not in data:
602                                 data["secondary"] = list()
603                             addr_obj["type"] = type_
604                             addr_obj["address"] = ipaddr
605                             addr_obj["prefixlen"] = netmask
606                             addr_obj["scope"] = scope
607                             data["secondary"].append(addr_obj)
608                 elif type_.startswith("link"):
609                     data["hwaddr"] = value
610         if iface:
611             ret[iface] = data
612             del iface, data
613     return ret
614 def _interfaces_ifconfig(out):
615     """
616     Uses ifconfig to return a dictionary of interfaces with various information
617     about each (up/down state, ip address, netmask, and hwaddr)
618     """
619     ret = dict()
620     piface = re.compile(r"^([^\s:]+)")
621     pmac = re.compile(".*?(?:HWaddr|ether|address:|lladdr) ([0-9a-fA-F:]+)")
622     if salt.utils.platform<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.is_sunos():
623         pip = re.compile(r".*?(?:inet\s+)([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)(.*)")
624         pip6 = re.compile(".*?(?:inet6 )([0-9a-fA-F:]+)")
625         pmask6 = re.compile(r".*?(?:inet6 [0-9a-fA-F:]+/(\d+)).*")
626     else:
627         pip = re.</b></font>compile(r".*?(?:inet addr:|inet [^\d]*)(.*?)\s")
628         pip6 = re.compile(".*?(?:inet6 addr: (.*?)/|inet6 )([0-9a-fA-F:]+)")
629         pmask6 = re.compile(
630             r".*?(?:inet6 addr: [0-9a-fA-F:]+/(\d+)|prefixlen (\d+))(?:"
631             r" Scope:([a-zA-Z]+)| scopeid (0x[0-9a-fA-F]))?"
632         )
633     pmask = re.compile(r".*?(?:Mask:|netmask )(?:((?:0x)?[0-9a-fA-F]{8})|([\d\.]+))")
634     pupdown = re.compile("UP")
635     pbcast = re.compile(r".*?(?:Bcast:|broadcast )([\d\.]+)")
636     groups = re.compile("\r?\n(?=\\S)").split(out)
637     for group in groups:
638         iface = ""
639         updown = False
640         for line in group<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.splitlines():
641             miface = piface.match(line)
642             mmac = pmac.match(line)
643             mip = pip.match(line)
644             mip6 = pip6.</b></font>match(line)
645             mupdown = pupdown.search(line)
646             if miface:
647                 iface = miface.group(1)
648             if mmac:
649                 data["hwaddr"] = mmac.group(1)
650                 if salt.utils.platform.is_sunos():
651                     expand_mac = []
652                     for chunk in data["hwaddr"].split(":"):
653                         expand_mac.append(
654                             "0{}".format(chunk)
655                             if len(chunk) &lt; 2
656                             else "{}".format(chunk)
657                         )
658                     data["hwaddr"] = ":".join(expand_mac)
659             if mip:
660                 if "inet" not in data:
661                     data["inet"] = list()
662                 addr_obj = dict()
663                 addr_obj["address"] = mip.group(1)
664                 mmask = pmask.match(line)
665                 if mmask:
666                     if mmask.group(1):
667                         mmask = _number_of_set_bits_to_ipv4_netmask(
668                             int(mmask.group(1), 16)
669                         )
670                     else:
671                         mmask = mmask.group(2)
672                     addr_obj["netmask"] = mmask
673                 mbcast = pbcast.match(line)
674                 if mbcast:
675                     addr_obj["broadcast"] = mbcast.group(1)
676                 data["inet"].append(addr_obj)
677             if mupdown:
678                 updown = True
679             if mip6:
680                 if "inet6" not in data:
681                     data["inet6"] = list()
682                 addr_obj = dict()
683                 addr_obj["address"] = mip6.group(1) or mip6.group(2)
684                 mmask6 = pmask6.match(line)
685                 if mmask6:
686                     addr_obj["prefixlen"] = mmask6.group(1) or mmask6.group(2)
687                     if not salt.utils.platform.is_sunos():
688                         ipv6scope = mmask6.group(3) or mmask6.group(4)
689                         addr_obj["scope"] = (
690                             ipv6scope.lower() if ipv6scope is not None else ipv6scope
691                         )
692                 if (
693                     not salt.utils.platform.is_sunos()
694                     or addr_obj["address"] != "::"
695                     and addr_obj["prefixlen"] != 0
696                 ):
697                     data["inet6"].append(addr_obj)
698         data["up"] = updown
699         if iface in ret:
700             ret[iface] = dict(list(data.items()) + list(ret[iface].items()))
701             if "inet" in data:
702                 ret[iface]["inet"].extend(
703                     x for x in data["inet"] if x not in ret[iface]["inet"]
704                 )
705             if "inet6" in data:
706                 ret[iface]["inet6"].extend(
707                     x for x in data["inet6"] if x not in ret[iface]["inet6"]
708                 )
709         else:
710             ret[iface] = data
711         del data
712     return ret
713 def linux_interfaces():
714     """
715     Obtain interface information for *NIX/BSD variants
716     """
717     ifaces = dict()
718     ip_path = salt.utils.path.which("ip")
719     ifconfig_path = None if ip_path else salt.utils.path.which("ifconfig")
720     if ip_path:
721         cmd1 = subprocess.Popen(
722             [ip_path, "link", "show"],
723             close_fds=True,
724             stdout=subprocess.PIPE,
725             stderr=subprocess.STDOUT,
726         ).communicate()[0]
727         cmd2 = subprocess.Popen(
728             [ip_path, "addr", "show"],
729             close_fds=True,
730             stdout=subprocess.PIPE,
731             stderr=subprocess.STDOUT,
732         ).communicate()[0]
733         ifaces = _interfaces_ip(
734             "{}\n{}".format(
735                 salt.utils.stringutils.to_str(cmd1), salt.utils.stringutils.to_str(cmd2)
736             )
737         )
738     elif ifconfig_path:
739         cmd = subprocess.Popen(
740             [ifconfig_path, "-a"],
741             stdout=subprocess.PIPE,
742             stderr=subprocess.STDOUT,
743         ).communicate()[0]
744         ifaces = _interfaces_ifconfig(salt.utils.stringutils.to_str(cmd))
745     return ifaces
746 def _netbsd_interfaces_ifconfig(out):
747     """
748     Uses ifconfig to return a dictionary of interfaces with various information
749     about each (up/down state, ip address, netmask, and hwaddr)
750     """
751     ret = dict()
752     piface = re.compile(r"^([^\s:]+)")
753     pmac = re.compile(".*?address: ([0-9a-f:]+)")
754     pip = re.compile(r".*?inet [^\d]*(.*?)/([\d]*)\s")
755     pip6 = re.compile(r".*?inet6 ([0-9a-f:]+)%([a-zA-Z0-9]*)/([\d]*)\s")
756     pupdown = re.compile("UP")
757     pbcast = re.compile(r".*?broadcast ([\d\.]+)")
758     groups = re.compile("\r?\n(?=\\S)").split(out)
759     for group in groups:
760         data = dict()
761         iface = ""
762         updown = False
763         for line in group.splitlines():
764             miface = piface.match(line)
765             mmac = pmac.match(line)
766             mip = pip.match(line)
767             mip6 = pip6.match(line)
768             mupdown = pupdown.search(line)
769             if miface:
770                 iface = miface.group(1)
771             if mmac:
772                 data["hwaddr"] = mmac.group(1)
773             if mip:
774                 if "inet" not in data:
775                     data["inet"] = list()
776                 addr_obj["address"] = mip.group(1)
777                 mmask = mip.group(2)
778                 if mip<font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.group(2):
779                     addr_obj["netmask"] = cidr_to_ipv4_netmask(mip.group(2))
780                 mbcast = pbcast.match(line)
781                 if</b></font> mbcast:
782                     addr_obj["broadcast"] = mbcast.group(1)
783                 data["inet"].append(addr_obj)
784             if mupdown:
785                 updown = True
786             if mip6:
787                 if "inet6" not in data:
788                     data["inet6"] = list()
789                 addr_obj = dict()
790                 addr_obj["address"] = mip6.group(1)
791                 mmask6 = mip6.group(3)
792                 addr_obj["scope"] = mip6.group(2)
793                 addr_obj["prefixlen"] = mip6.group(3)
794                 data["inet6"].append(addr_obj)
795         data["up"] = updown
796         ret[iface] = data
797         del data
798     return ret
799 def _junos_interfaces_ifconfig(out):
800     """
801     Uses ifconfig to return a dictionary of interfaces with various information
802     about each (up/down state, ip address, netmask, and hwaddr)
803     """
804     ret = dict()
805     piface = re.compile(r"^([^\s:]+)")
806     pmac = re.compile("curr media .*? ([0-9a-f:]+)")
807     pip = re.compile(
808         r".*?inet\s*(primary)*\s+mtu"
809         r" (\d+)\s+local=[^\d]*(.*?)\s+dest=[^\d]*(.*?)\/([\d]*)\s+bcast=((?:[0-9]{1,3}\.){3}[0-9]{1,3})"
810     )
811     pip6 = re.compile(
812         r".*?inet6 mtu [^\d]+\s+local=([0-9a-f:]+)%([a-zA-Z0-9]*)/([\d]*)\s"
813     )
814     pupdown = re.compile("UP")
815     pbcast = re.compile(r".*?broadcast ([\d\.]+)")
816     groups = re.compile("\r?\n(?=\\S)").split(out)
817     for group in groups:
818         data = dict()
819         iface = ""
820         updown = False
821         primary = False
822         for line in group.splitlines():
823             miface = piface.match(line)
824             mmac = pmac.match(line)
825             mip = pip.match(line)
826             mip6 = pip6.match(line)
827             mupdown = pupdown.search(line)
828             if miface:
829                 iface = miface.group(1)
830             if mmac:
831                 data["hwaddr"] = mmac.group(1)
832             if mip:
833                 if "primary" in data:
834                     primary = True
835                 if "inet" not in data:
836                     data["inet"] = list()
837                 if mip.group(2):
838                     data["mtu"] = int(mip.group(2))
839                 addr_obj = dict()
840                 addr_obj["address"] = mip.group(3)
841                 mmask = mip.group(5)
842                 if mip.group(5):
843                     addr_obj["netmask"] = cidr_to_ipv4_netmask(mip.group(5))
844                 mbcast = pbcast.match(line)
845                 if mbcast:
846                     addr_obj["broadcast"] = mbcast.group(1)
847                 data["inet"].append(addr_obj)
848             if mupdown:
849                 updown = True
850             if mip6:
851                 if "inet6" not in data:
852                     data["inet6"] = list()
853                 addr_obj = dict()
854                 addr_obj["address"] = mip6.group(1)
855                 mmask6 = mip6.group(3)
856                 addr_obj["scope"] = mip6.group(2)
857                 addr_obj["prefixlen"] = mip6.group(3)
858                 data["inet6"].append(addr_obj)
859         data["up"] = updown
860         ret[iface] = data
861         del data
862     return ret
863 def junos_interfaces():
864     """
865     Obtain interface information for Junos; ifconfig
866     output diverged from other BSD variants (Netmask is now part of the
867     address)
868     """
869     ifconfig_path = salt.utils.path.which("ifconfig")
870     cmd = subprocess.Popen(
871         [ifconfig_path, "-a"],
872         stdout=subprocess.PIPE,
873         stderr=subprocess.STDOUT,
874     ).communicate()[0]
875     return _junos_interfaces_ifconfig(salt.utils.stringutils.to_str(cmd))
876 def netbsd_interfaces():
877     """
878     Obtain interface information for NetBSD &gt;= 8 where the ifconfig
879     output diverged from other BSD variants (Netmask is now part of the
880     address)
881     """
882     if LooseVersion(os.uname()[2]) &lt; LooseVersion("8.0"):
883         return linux_interfaces()
884     ifconfig_path = salt.utils.path.which("ifconfig")
885     cmd = subprocess.Popen(
886         [ifconfig_path, "-a"],
887         stdout=subprocess.PIPE,
888         stderr=subprocess.STDOUT,
889     ).communicate()[0]
890     return _netbsd_interfaces_ifconfig(salt.utils.stringutils.to_str(cmd))
891 def _interfaces_ipconfig(out):
892     """
893     Returns a dictionary of interfaces with various information about each
894     (up/down state, ip address, netmask, and hwaddr)
895     NOTE: This is not used by any function and may be able to be removed in the
896     future.
897     """
898     ifaces = dict()
899     iface = None
900     addr = None
901     adapter_iface_regex = re.compile(r"adapter (\S.+):$")
902     for line in out.splitlines():
903         if not line:
904             continue
905         if line.startswith("Ethernet"):
906             iface = ifaces[adapter_iface_regex.search(line).group(1)]
907             iface["up"] = True
908             addr = {}
909             continue
910         if iface:
911             key, val = line.split(",", 1)
912             key = key.strip(" .")
913             val = val.strip()
914             if addr and key == "Subnet Mask":
915                 addr["netmask"] = val
916             elif key in ("IP Address", "IPv4 Address"):
917                 if "inet" not in iface:
918                     iface["inet"] = list()
919                 addr = {
920                     "address": val.rstrip("(Preferred)"),
921                     "netmask": None,
922                     "broadcast": None,
923                 }  # TODO find the broadcast
924                 iface["inet"].append(addr)
925             elif "IPv6 Address" in key:
926                 if "inet6" not in iface:
927                     iface["inet"] = list()
928                 addr = {"address": val.rstrip("(Preferred)"), "prefixlen": None}
929                 iface["inet6"].append(addr)
930             elif key == "Physical Address":
931                 iface["hwaddr"] = val
932             elif key == "Media State":
933                 iface["up"] = val != "Media disconnected"
934 def win_interfaces():
935     """
936     Obtain interface information for Windows systems
937     """
938     if WIN_NETWORK_LOADED is False:
939         import salt.utils.win_network as _
940     return salt.utils.win_network.get_interface_info()
941 def interfaces():
942     """
943     Return a dictionary of information about all the interfaces on the minion
944     """
945     if salt.utils.platform.is_windows():
946         return win_interfaces()
947     elif salt.utils.platform.is_junos():
948         return junos_interfaces()
949     elif salt.utils.platform.is_netbsd():
950         return netbsd_interfaces()
951     else:
952         return linux_interfaces()
953 def get_net_start(ipaddr, netmask):
954     """
955     Return the address of the network
956     """
957     net = ipaddress.ip_network("{}/{}".format(ipaddr, netmask), strict=False)
958     return str(net.network_address)
959 def get_net_size(mask):
960     """
961     Turns an IPv4 netmask into its corresponding prefix length
962     (255.255.255.0 -&gt; 24 as in 192.168.1.10/24).
963     """
964     binary_str = ""
965     for octet in mask.split("."):
966         binary_str += bin(int(octet))[2:].zfill(8)
967     return len(binary_str.rstrip("0"))
968 def calc_net(ipaddr, netmask=None):
969     """
970     Takes IP (CIDR notation supported) and optionally netmask
971     and returns the network in CIDR-notation.
972     (The IP can be any IP inside the subnet)
973     """
974     if netmask is not None:
975         ipaddr = "{}/{}".format(ipaddr, netmask)
976     return str(ipaddress.ip_network(ipaddr, strict=False))
977 def _ipv4_to_bits(ipaddr):
978     """
979     Accepts an IPv4 dotted quad and returns a string representing its binary
980     counterpart
981     """
982     return "".join([bin(int(x))[2:].rjust(8, "0") for x in ipaddr.split(".")])
983 def _get_iface_info(iface):
984     """
985     If `iface` is available, return interface info and no error, otherwise
986     return no info and log and return an error
987     """
988     iface_info = interfaces()
989     if iface in iface_info.keys():
990         return iface_info, False
991     else:
992         error_msg = 'Interface "{}" not in available interfaces: "{}"'.format(
993             iface, '", "'.join(iface_info.keys())
994         )
995         log.error(error_msg)
996         return None, error_msg
997 def _hw_addr_aix(iface):
998     """
999     Return the hardware address (a.k.a. MAC address) for a given interface on AIX
1000     MAC address not available in through interfaces
1001     """
1002     cmd = subprocess.Popen(
1003         ["grep", "Hardware Address"],
1004         stdin=subprocess.Popen(
1005             ["entstat", "-d", iface],
1006             stdout=subprocess.PIPE,
1007             stderr=subprocess.STDOUT,
1008         ).stdout,
1009         stdout=subprocess.PIPE,
1010         stderr=subprocess.STDOUT,
1011     ).communicate()[0]
1012     if cmd:
1013         comps = cmd.split(" ")
1014         if len(comps) == 3:
1015             mac_addr = comps[2].strip("'").strip()
1016             return mac_addr
1017     error_msg = 'Interface "{}" either not available or does not contain a hardware address'.format(
1018         iface
1019     )
1020     log.error(error_msg)
1021     return error_msg
1022 def hw_addr(iface):
1023     """
1024     Return the hardware address (a.k.a. MAC address) for a given interface
1025     .. versionchanged:: 2016.11.4
1026         Added support for AIX
1027     """
1028     if salt.utils.platform.is_aix():
1029         return _hw_addr_aix
1030     iface_info, error = _get_iface_info(iface)
1031     if error is False:
1032         return iface_info.get(iface, {}).get("hwaddr", "")
1033     else:
1034         return error
1035 def interface(iface):
1036     """
1037     Return the details of `iface` or an error if it does not exist
1038     """
1039     iface_info, error = _get_iface_info(iface)
1040     if error is False:
1041         return iface_info.get(iface, {}).get("inet", "")
1042     else:
1043         return error
1044 def interface_ip(iface):
1045     """
1046     Return `iface` IPv4 addr or an error if `iface` does not exist
1047     """
1048     iface_info, error = _get_iface_info(iface)
1049     if error is False:
1050         inet = iface_info.get(iface, {}).get("inet", None)
1051         return inet[0].get("address", "") if inet else ""
1052     else:
1053         return error
1054 def _subnets(proto="inet", interfaces_=None):
1055     """
1056     Returns a list of subnets to which the host belongs
1057     """
1058     if interfaces_ is None:
1059         ifaces = interfaces()
1060     elif isinstance(interfaces_, list):
1061         ifaces = {}
1062         for key, value in interfaces().items():
1063             if key in interfaces_:
1064                 ifaces[key] = value
1065     else:
1066         ifaces = {interfaces_: interfaces().get(interfaces_, {})}
1067     ret = set()
1068     if proto == "inet":
1069         subnet = "netmask"
1070         dflt_cidr = 32
1071     elif proto == "inet6":
1072         subnet = "prefixlen"
1073         dflt_cidr = 128
1074     else:
1075         log.error("Invalid proto %s calling subnets()", proto)
1076         return
1077     for ip_info in ifaces.values():
1078         addrs = ip_info.get(proto, [])
1079         addrs.extend(
1080             [addr for addr in ip_info.get("secondary", []) if addr.get("type") == proto]
1081         )
1082         for intf in addrs:
1083             if subnet in intf:
1084                 intf = ipaddress.ip_interface(
1085                     "{}/{}".format(intf["address"], intf[subnet])
1086                 )
1087             else:
1088                 intf = ipaddress.ip_interface(
1089                     "{}/{}".format(intf["address"], dflt_cidr)
1090                 )
1091             if not intf.is_loopback:
1092                 ret.add(intf.network)
1093     return [str(net) for net in sorted(ret)]
1094 def subnets(interfaces=None):
1095     """
1096     Returns a list of IPv4 subnets to which the host belongs
1097     """
1098     return _subnets("inet", interfaces_=interfaces)
1099 def subnets6():
1100     """
1101     Returns a list of IPv6 subnets to which the host belongs
1102     """
1103     return _subnets("inet6")
1104 def in_subnet(cidr, addr=None):
1105     """
1106     Returns True if host or (any of) addrs is within specified subnet, otherwise False
1107     """
1108     try:
1109         cidr = ipaddress.ip_network(cidr)
1110     except ValueError:
1111         log.error("Invalid CIDR '%s'", cidr)
1112         return False
1113     if addr is None:
1114         addr = ip_addrs()
1115         addr.extend(ip_addrs6())
1116     elif not isinstance(addr, (list, tuple)):
1117         addr = (addr,)
1118     return any(ipaddress.ip_address(item) in cidr for item in addr)
1119 def _get_ips(ifaces, proto="inet"):
1120     """
1121     Accepts a dict of interface data and returns a list of dictionaries
1122     """
1123     ret = []
1124     for ip_info in ifaces.values():
1125         ret.extend(ip_info.get(proto, []))
1126         ret.extend(
1127             [addr for addr in ip_info.get("secondary", []) if addr.get("type") == proto]
1128         )
1129     return ret
1130 def _filter_interfaces(interface=None, interface_data=None):
1131     """
1132     Gather interface data if not passed in, and optionally filter by the
1133     specified interface name.
1134     """
1135     ifaces = interface_data if isinstance(interface_data, dict) else interfaces()
1136     if interface is None:
1137         ret = ifaces
1138     else:
1139         interface = salt.utils.args.split_input(interface)
1140         ret = {
1141             k: v
1142             for k, v in ifaces.items()
1143             if any(fnmatch.fnmatch(k, pat) for pat in interface)
1144         }
1145     return ret
1146 def _ip_addrs(
1147     interface=None, include_loopback=False, interface_data=None, proto="inet"
1148 ):
1149     """
1150     Return the full list of IP adresses matching the criteria
1151     proto = inet|inet6
1152     """
1153     addrs = _get_ips(_filter_interfaces(interface, interface_data), proto=proto)
1154     ret = set()
1155     for addr in addrs:
1156         addr = ipaddress.ip_address(addr.get("address"))
1157         if not addr.is_loopback or include_loopback:
1158             ret.add(addr)
1159     return [str(addr) for addr in sorted(ret)]
1160 def ip_addrs(interface=None, include_loopback=False, interface_data=None):
1161     """
1162     Returns a list of IPv4 addresses assigned to the host. 127.0.0.1 is
1163     ignored, unless 'include_loopback=True' is indicated. If 'interface' is
1164     provided, then only IP addresses from that interface will be returned.
1165     """
1166     return _ip_addrs(interface, include_loopback, interface_data, "inet")
1167 def ip_addrs6(interface=None, include_loopback=False, interface_data=None):
1168     """
1169     Returns a list of IPv6 addresses assigned to the host. ::1 is ignored,
1170     unless 'include_loopback=True' is indicated. If 'interface' is provided,
1171     then only IP addresses from that interface will be returned.
1172     """
1173     return _ip_addrs(interface, include_loopback, interface_data, "inet6")
1174 def _ip_networks(
1175     interface=None,
1176     include_loopback=False,
1177     verbose=False,
1178     interface_data=None,
1179     proto="inet",
1180 ):
1181     """
1182     Returns a list of networks to which the minion belongs. The results can be
1183     restricted to a single interface using the ``interface`` argument.
1184     """
1185     addrs = _get_ips(_filter_interfaces(interface, interface_data), proto=proto)
1186     ret = set()
1187     for addr in addrs:
1188         _ip = addr.get("address")
1189         _net = addr.get("netmask" if proto == "inet" else "prefixlen")
1190         if _ip and _net:
1191             try:
1192                 ip_net = ipaddress.ip_network("{}/{}".format(_ip, _net), strict=False)
1193             except Exception:  # pylint: disable=broad-except
1194                 continue
1195             if not ip_net.is_loopback or include_loopback:
1196                 ret.add(ip_net)
1197     if not verbose:
1198         return [str(addr) for addr in sorted(ret)]
1199     verbose_ret = {
1200         str(x): {
1201             "address": str(x.network_address),
1202             "netmask": str(x.netmask),
1203             "num_addresses": x.num_addresses,
1204             "prefixlen": x.prefixlen,
1205         }
1206         for x in ret
1207     }
1208     return verbose_ret
1209 def ip_networks(
1210     interface=None, include_loopback=False, verbose=False, interface_data=None
1211 ):
1212     """
1213     Returns the IPv4 networks to which the minion belongs. Networks will be
1214     returned as a list of network/prefixlen. To get more information about a
1215     each network, use verbose=True and a dictionary with more information will
1216     be returned.
1217     """
1218     return _ip_networks(
1219         interface=interface,
1220         include_loopback=include_loopback,
1221         verbose=verbose,
1222         interface_data=interface_data,
1223         proto="inet",
1224     )
1225 def ip_networks6(
1226     interface=None, include_loopback=False, verbose=False, interface_data=None
1227 ):
1228     """
1229     Returns the IPv6 networks to which the minion belongs. Networks will be
1230     returned as a list of network/prefixlen. To get more information about a
1231     each network, use verbose=True and a dictionary with more information will
1232     be returned.
1233     """
1234     return _ip_networks(
1235         interface=interface,
1236         include_loopback=include_loopback,
1237         verbose=verbose,
1238         interface_data=interface_data,
1239         proto="inet6",
1240     )
1241 def hex2ip(hex_ip, invert=False):
1242     """
1243     Convert a hex string to an ip, if a failure occurs the original hex is
1244     returned. If 'invert=True' assume that ip from /proc/net/&lt;proto&gt;
1245     """
1246     if len(hex_ip) == 32:  # ipv6
1247         ip_addr = []
1248         for i in range(0, 32, 8):
1249             ip_part = hex_ip[i : i + 8]
1250             ip_part = [ip_part[x : x + 2] for x in range(0, 8, 2)]
1251             if invert:
1252                 ip_addr.append("{0[3]}{0[2]}:{0[1]}{0[0]}".format(ip_part))
1253             else:
1254                 ip_addr.append("{0[0]}{0[1]}:{0[2]}{0[3]}".format(ip_part))
1255         try:
1256             address = ipaddress.IPv6Address(":".join(ip_addr))
1257             if address.ipv4_mapped:
1258                 return str(address.ipv4_mapped)
1259             else:
1260                 return address.compressed
1261         except ipaddress.AddressValueError as ex:
1262             log.error("hex2ip - ipv6 address error: %s", ex)
1263             return hex_ip
1264     try:
1265         hip = int(hex_ip, 16)
1266     except ValueError:
1267         return hex_ip
1268     if invert:
1269         return "{3}.{2}.{1}.{0}".format(
1270             hip &gt;&gt; 24 &amp; 255, hip &gt;&gt; 16 &amp; 255, hip &gt;&gt; 8 &amp; 255, hip &amp; 255
1271         )
1272     return "{}.{}.{}.{}".format(
1273         hip &gt;&gt; 24 &amp; 255, hip &gt;&gt; 16 &amp; 255, hip &gt;&gt; 8 &amp; 255, hip &amp; 255
1274     )
1275 def mac2eui64(mac, prefix=None):
1276     """
1277     Convert a MAC address to a EUI64 identifier
1278     or, with prefix provided, a full IPv6 address
1279     """
1280     eui64 = re.sub(r"[.:-]", "", mac).lower()
1281     eui64 = eui64[0:6] + "fffe" + eui64[6:]
1282     eui64 = hex(int(eui64[0:2], 16) | 2)[2:].zfill(2) + eui64[2:]
1283     if prefix is None:
1284         return ":".join(re.findall(r".{4}", eui64))
1285     else:
1286         try:
1287             net = ipaddress.ip_network(prefix, strict=False)
1288             euil = int("0x{}".format(eui64), 16)
1289             return "{}/{}".format(net[euil], net.prefixlen)
1290         except Exception:  # pylint: disable=broad-except
1291             return
1292 def active_tcp():
1293     """
1294     Return a dict describing all active tcp connections as quickly as possible
1295     """
1296     ret = {}
1297     for statf in ["/proc/net/tcp", "/proc/net/tcp6"]:
1298         if not os.path.isfile(statf):
1299             continue
1300         with salt.utils.files.fopen(statf, "rb") as fp_:
1301             for line in fp_:
1302                 line = salt.utils.stringutils.to_unicode(line)
1303                 if line.strip().startswith("sl"):
1304                     continue
1305                 iret = _parse_tcp_line(line)
1306                 slot = next(iter(iret))
1307                 if iret[slot]["state"] == 1:  # 1 is ESTABLISHED
1308                     del iret[slot]["state"]
1309                     ret[len(ret)] = iret[slot]
1310     return ret
1311 def local_port_tcp(port):
1312     """
1313     Return a set of remote ip addrs attached to the specified local port
1314     """
1315     ret = _remotes_on(port, "local_port")
1316     return ret
1317 def remote_port_tcp(port):
1318     """
1319     Return a set of ip addrs the current host is connected to on given port
1320     """
1321     ret = _remotes_on(port, "remote_port")
1322     return ret
1323 def _remotes_on(port, which_end):
1324     """
1325     Return a set of ip addrs active tcp connections
1326     """
1327     port = int(port)
1328     ret = _netlink_tool_remote_on(port, which_end)
1329     if ret is not None:
1330         return ret
1331     ret = set()
1332     proc_available = False
1333     for statf in ["/proc/net/tcp", "/proc/net/tcp6"]:
1334         if not os.path.isfile(statf):
1335             continue
1336         proc_available = True
1337         with salt.utils.files.fopen(statf, "r") as fp_:
1338             for line in fp_:
1339                 line = salt.utils.stringutils.to_unicode(line)
1340                 if line.strip().startswith("sl"):
1341                     continue
1342                 iret = _parse_tcp_line(line)
1343                 slot = next(iter(iret))
1344                 if (
1345                     iret[slot][which_end] == port and iret[slot]["state"] == 1
1346                 ):  # 1 is ESTABLISHED
1347                     ret.add(iret[slot]["remote_addr"])
1348     if not proc_available:  # Fallback to use OS specific tools
1349         if salt.utils.platform.is_sunos():
1350             return _sunos_remotes_on(port, which_end)
1351         if salt.utils.platform.is_freebsd():
1352             return _freebsd_remotes_on(port, which_end)
1353         if salt.utils.platform.is_netbsd():
1354             return _netbsd_remotes_on(port, which_end)
1355         if salt.utils.platform.is_openbsd():
1356             return _openbsd_remotes_on(port, which_end)
1357         if salt.utils.platform.is_windows():
1358             return _windows_remotes_on(port, which_end)
1359         if salt.utils.platform.is_aix():
1360             return _aix_remotes_on(port, which_end)
1361         return _linux_remotes_on(port, which_end)
1362     return ret
1363 def _parse_tcp_line(line):
1364     """
1365     Parse a single line from the contents of /proc/net/tcp or /proc/net/tcp6
1366     """
1367     ret = {}
1368     comps = line.strip().split()
1369     slot = comps[0].rstrip(":")
1370     ret[slot] = {}
1371     l_addr, l_port = comps[1].split(":")
1372     r_addr, r_port = comps[2].split(":")
1373     ret[slot]["local_addr"] = hex2ip(l_addr, True)
1374     ret[slot]["local_port"] = int(l_port, 16)
1375     ret[slot]["remote_addr"] = hex2ip(r_addr, True)
1376     ret[slot]["remote_port"] = int(r_port, 16)
1377     ret[slot]["state"] = int(comps[3], 16)
1378     return ret
1379 def _netlink_tool_remote_on(port, which_end):
1380     """
1381     Returns set of IPv4/IPv6 host addresses of remote established connections
1382     on local or remote tcp port.
1383     Parses output of shell 'ss' to get connections
1384     [root@salt-master ~]# ss -ant
1385     State      Recv-Q Send-Q               Local Address:Port                 Peer Address:Port
1386     LISTEN     0      511                              *:80                              *:*
1387     LISTEN     0      128                              *:22                              *:*
1388     ESTAB      0      0                      127.0.0.1:56726                  127.0.0.1:4505
1389     ESTAB      0      0             [::ffff:127.0.0.1]:41323         [::ffff:127.0.0.1]:4505
1390     """
1391     remotes = set()
1392     valid = False
1393     tcp_end = "dst" if which_end == "remote_port" else "src"
1394     try:
1395         data = subprocess.check_output(
1396             ["ss", "-ant", tcp_end, ":{}".format(port)]
1397         )  # pylint: disable=minimum-python-version
1398     except subprocess.CalledProcessError:
1399         log.error("Failed ss")
1400         raise
1401     except OSError:  # not command "No such file or directory"
1402         return None
1403     lines = salt.utils.stringutils.to_str(data).split("\n")
1404     for line in lines:
1405         if "Address:Port" in line:  # ss tools may not be valid
1406             valid = True
1407             continue
1408         elif "ESTAB" not in line:
1409             continue
1410         chunks = line.split()
1411         remote_host, remote_port = chunks[4].rsplit(":", 1)
1412         remotes.add(remote_host.strip("[]"))
1413     if valid is False:
1414         remotes = None
1415     return remotes
1416 def _sunos_remotes_on(port, which_end):
1417     """
1418     SunOS specific helper function.
1419     Returns set of ipv4 host addresses of remote established connections
1420     on local or remote tcp port.
1421     Parses output of shell 'netstat' to get connections
1422     [root@salt-master ~]# netstat -f inet -n
1423     TCP: IPv4
1424        Local Address        Remote Address    Swind Send-Q Rwind Recv-Q    State
1425        -------------------- -------------------- ----- ------ ----- ------ -----------
1426        10.0.0.101.4505      10.0.0.1.45329       1064800      0 1055864      0 ESTABLISHED
1427        10.0.0.101.4505      10.0.0.100.50798     1064800      0 1055864      0 ESTABLISHED
1428     """
1429     remotes = set()
1430     try:
1431         data = subprocess.check_output(
1432             ["netstat", "-f", "inet", "-n"]
1433         )  # pylint: disable=minimum-python-version
1434     except subprocess.CalledProcessError:
1435         log.error("Failed netstat")
1436         raise
1437     lines = salt.utils.stringutils.to_str(data).split("\n")
1438     for line in lines:
1439         if "ESTABLISHED" not in line:
1440             continue
1441         chunks = line.split()
1442         local_host, local_port = chunks[0].rsplit(".", 1)
1443         remote_host, remote_port = chunks[1].rsplit(".", 1)
1444         if which_end == "remote_port" and int(remote_port) != port:
1445             continue
1446         if which_end == "local_port" and int(local_port) != port:
1447             continue
1448         remotes.add(remote_host)
1449     return remotes
1450 def _freebsd_remotes_on(port, which_end):
1451     """
1452     Returns set of ipv4 host addresses of remote established connections
1453     on local tcp port port.
1454     Parses output of shell 'sockstat' (FreeBSD)
1455     to get connections
1456     $ sudo sockstat -4
1457     USER    COMMAND     PID     FD  PROTO  LOCAL ADDRESS    FOREIGN ADDRESS
1458     root    python2.7   1456    29  tcp4   *:4505           *:*
1459     root    python2.7   1445    17  tcp4   *:4506           *:*
1460     root    python2.7   1294    14  tcp4   127.0.0.1:11813  127.0.0.1:4505
1461     root    python2.7   1294    41  tcp4   127.0.0.1:61115  127.0.0.1:4506
1462     $ sudo sockstat -4 -c -p 4506
1463     USER    COMMAND     PID     FD  PROTO  LOCAL ADDRESS    FOREIGN ADDRESS
1464     root    python2.7   1294    41  tcp4   127.0.0.1:61115  127.0.0.1:4506
1465     """
1466     port = int(port)
1467     remotes = set()
1468     try:
1469         cmd = salt.utils.args.shlex_split("sockstat -4 -c -p {}".format(port))
1470         data = subprocess.check_output(cmd)  # pylint: disable=minimum-python-version
1471     except subprocess.CalledProcessError as ex:
1472         log.error('Failed "sockstat" with returncode = %s', ex.returncode)
1473         raise
1474     lines = salt.utils.stringutils.to_str(data).split("\n")
1475     for line in lines:
1476         chunks = line.split()
1477         if not chunks:
1478             continue
1479         if "COMMAND" in chunks[1]:
1480             continue  # ignore header
1481         if len(chunks) &lt; 2:
1482             continue
1483         local = chunks[-2]
1484         remote = chunks[-1]
1485         lhost, lport = local.split(":")
1486         rhost, rport = remote.split(":")
1487         if which_end == "local" and int(lport) != port:  # ignore if local port not port
1488             continue
1489         if (
1490             which_end == "remote" and int(rport) != port
1491         ):  # ignore if remote port not port
1492             continue
1493         remotes.add(rhost)
1494     return remotes
1495 def _netbsd_remotes_on(port, which_end):
1496     """
1497     Returns set of ipv4 host addresses of remote established connections
1498     on local tcp port port.
1499     Parses output of shell 'sockstat' (NetBSD)
1500     to get connections
1501     $ sudo sockstat -4 -n
1502     USER    COMMAND     PID     FD  PROTO  LOCAL ADDRESS    FOREIGN ADDRESS
1503     root    python2.7   1456    29  tcp    *.4505           *.*
1504     root    python2.7   1445    17  tcp    *.4506           *.*
1505     root    python2.7   1294    14  tcp    127.0.0.1.11813  127.0.0.1.4505
1506     root    python2.7   1294    41  tcp    127.0.0.1.61115  127.0.0.1.4506
1507     $ sudo sockstat -4 -c -n -p 4506
1508     USER    COMMAND     PID     FD  PROTO  LOCAL ADDRESS    FOREIGN ADDRESS
1509     root    python2.7   1294    41  tcp    127.0.0.1.61115  127.0.0.1.4506
1510     """
1511     port = int(port)
1512     remotes = set()
1513     try:
1514         cmd = salt.utils.args.shlex_split("sockstat -4 -c -n -p {}".format(port))
1515         data = subprocess.check_output(cmd)  # pylint: disable=minimum-python-version
1516     except subprocess.CalledProcessError as ex:
1517         log.error('Failed "sockstat" with returncode = %s', ex.returncode)
1518         raise
1519     lines = salt.utils.stringutils.to_str(data).split("\n")
1520     for line in lines:
1521         chunks = line.split()
1522         if not chunks:
1523             continue
1524         if "COMMAND" in chunks[1]:
1525             continue  # ignore header
1526         if len(chunks) &lt; 2:
1527             continue
1528         local = chunks[5].split(".")
1529         lport = local.pop()
1530         lhost = ".".join(local)
1531         remote = chunks[6].split(".")
1532         rport = remote.pop()
1533         rhost = ".".join(remote)
1534         if which_end == "local" and int(lport) != port:  # ignore if local port not port
1535             continue
1536         if (
1537             which_end == "remote" and int(rport) != port
1538         ):  # ignore if remote port not port
1539             continue
1540         remotes.add(rhost)
1541     return remotes
1542 def _openbsd_remotes_on(port, which_end):
1543     """
1544     OpenBSD specific helper function.
1545     Returns set of ipv4 host addresses of remote established connections
1546     on local or remote tcp port.
1547     Parses output of shell 'netstat' to get connections
1548     $ netstat -nf inet
1549     Active Internet connections
1550     Proto   Recv-Q Send-Q  Local Address          Foreign Address        (state)
1551     tcp          0      0  10.0.0.101.4505        10.0.0.1.45329         ESTABLISHED
1552     tcp          0      0  10.0.0.101.4505        10.0.0.100.50798       ESTABLISHED
1553     """
1554     remotes = set()
1555     try:
1556         data = subprocess.check_output(
1557             ["netstat", "-nf", "inet"]
1558         )  # pylint: disable=minimum-python-version
1559     except subprocess.CalledProcessError:
1560         log.error("Failed netstat")
1561         raise
1562     lines = data.split("\n")
1563     for line in lines:
1564         if "ESTABLISHED" not in line:
1565             continue
1566         chunks = line.split()
1567         local_host, local_port = chunks[3].rsplit(".", 1)
1568         remote_host, remote_port = chunks[4].rsplit(".", 1)
1569         if which_end == "remote_port" and int(remote_port) != port:
1570             continue
1571         if which_end == "local_port" and int(local_port) != port:
1572             continue
1573         remotes.add(remote_host)
1574     return remotes
1575 def _windows_remotes_on(port, which_end):
1576     r"""
1577     Windows specific helper function.
1578     Returns set of ipv4 host addresses of remote established connections
1579     on local or remote tcp port.
1580     Parses output of shell 'netstat' to get connections
1581     C:\&gt;netstat -n
1582     Active Connections
1583        Proto  Local Address          Foreign Address        State
1584        TCP    10.2.33.17:3007        130.164.12.233:10123   ESTABLISHED
1585        TCP    10.2.33.17:3389        130.164.30.5:10378     ESTABLISHED
1586     """
1587     remotes = set()
1588     try:
1589         data = subprocess.check_output(
1590             ["netstat", "-n"]
1591         )  # pylint: disable=minimum-python-version
1592     except subprocess.CalledProcessError:
1593         log.error("Failed netstat")
1594         raise
1595     lines = salt.utils.stringutils.to_str(data).split("\n")
1596     for line in lines:
1597         if "ESTABLISHED" not in line:
1598             continue
1599         chunks = line.split()
1600         local_host, local_port = chunks[1].rsplit(":", 1)
1601         remote_host, remote_port = chunks[2].rsplit(":", 1)
1602         if which_end == "remote_port" and int(remote_port) != port:
1603             continue
1604         if which_end == "local_port" and int(local_port) != port:
1605             continue
1606         remotes.add(remote_host)
1607     return remotes
1608 def _linux_remotes_on(port, which_end):
1609     """
1610     Linux specific helper function.
1611     Returns set of ip host addresses of remote established connections
1612     on local tcp port port.
1613     Parses output of shell 'lsof'
1614     to get connections
1615     $ sudo lsof -iTCP:4505 -n
1616     COMMAND   PID USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME
1617     Python   9971 root   35u  IPv4 0x18a8464a29ca329d      0t0  TCP *:4505 (LISTEN)
1618     Python   9971 root   37u  IPv4 0x18a8464a29b2b29d      0t0  TCP 127.0.0.1:4505-&gt;127.0.0.1:55703 (ESTABLISHED)
1619     Python  10152 root   22u  IPv4 0x18a8464a29c8cab5      0t0  TCP 127.0.0.1:55703-&gt;127.0.0.1:4505 (ESTABLISHED)
1620     Python  10153 root   22u  IPv4 0x18a8464a29c8cab5      0t0  TCP [fe80::249a]:4505-&gt;[fe80::150]:59367 (ESTABLISHED)
1621     """
1622     remotes = set()
1623     try:
1624         data = subprocess.check_output(
1625             [
1626                 "lsof",
1627                 "-iTCP:{:d}".format(port),
1628                 "-n",
1629                 "-P",
1630             ]  # pylint: disable=minimum-python-version
1631         )
1632     except subprocess.CalledProcessError as ex:
1633         if ex.returncode == 1:
1634             log.warning('"lsof" returncode = 1, likely no active TCP sessions.')
1635             return remotes
1636         log.error('Failed "lsof" with returncode = %s', ex.returncode)
1637         raise
1638     lines = salt.utils.stringutils.to_str(data).split("\n")
1639     for line in lines:
1640         chunks = line.split()
1641         if not chunks:
1642             continue
1643         if "COMMAND" in chunks[0]:
1644             continue  # ignore header
1645         if "ESTABLISHED" not in chunks[-1]:
1646             continue  # ignore if not ESTABLISHED
1647         local, remote = chunks[8].split("-&gt;")
1648         _, lport = local.rsplit(":", 1)
1649         rhost, rport = remote.rsplit(":", 1)
1650         if which_end == "remote_port" and int(rport) != port:
1651             continue
1652         if which_end == "local_port" and int(lport) != port:
1653             continue
1654         remotes.add(rhost.strip("[]"))
1655     return remotes
1656 def _aix_remotes_on(port, which_end):
1657     """
1658     AIX specific helper function.
1659     Returns set of ipv4 host addresses of remote established connections
1660     on local or remote tcp port.
1661     Parses output of shell 'netstat' to get connections
1662     root@la68pp002_pub:/opt/salt/lib/python2.7/site-packages/salt/modules# netstat -f inet -n
1663     Active Internet connections
1664     Proto Recv-Q Send-Q  Local Address          Foreign Address        (state)
1665     tcp4       0      0  172.29.149.95.50093    209.41.78.13.4505      ESTABLISHED
1666     tcp4       0      0  127.0.0.1.9514         *.*                    LISTEN
1667     tcp4       0      0  127.0.0.1.9515         *.*                    LISTEN
1668     tcp4       0      0  127.0.0.1.199          127.0.0.1.32779        ESTABLISHED
1669     tcp4       0      0  127.0.0.1.32779        127.0.0.1.199          ESTABLISHED
1670     tcp4       0     40  172.29.149.95.22       172.29.96.83.41022     ESTABLISHED
1671     tcp4       0      0  172.29.149.95.22       172.29.96.83.41032     ESTABLISHED
1672     tcp4       0      0  127.0.0.1.32771        127.0.0.1.32775        ESTABLISHED
1673     tcp        0      0  127.0.0.1.32775        127.0.0.1.32771        ESTABLISHED
1674     tcp4       0      0  127.0.0.1.32771        127.0.0.1.32776        ESTABLISHED
1675     tcp        0      0  127.0.0.1.32776        127.0.0.1.32771        ESTABLISHED
1676     tcp4       0      0  127.0.0.1.32771        127.0.0.1.32777        ESTABLISHED
1677     tcp        0      0  127.0.0.1.32777        127.0.0.1.32771        ESTABLISHED
1678     tcp4       0      0  127.0.0.1.32771        127.0.0.1.32778        ESTABLISHED
1679     tcp        0      0  127.0.0.1.32778        127.0.0.1.32771        ESTABLISHED
1680     """
1681     remotes = set()
1682     try:
1683         data = subprocess.check_output(
1684             ["netstat", "-f", "inet", "-n"]
1685         )  # pylint: disable=minimum-python-version
1686     except subprocess.CalledProcessError:
1687         log.error("Failed netstat")
1688         raise
1689     lines = salt.utils.stringutils.to_str(data).split("\n")
1690     for line in lines:
1691         if "ESTABLISHED" not in line:
1692             continue
1693         chunks = line.split()
1694         local_host, local_port = chunks[3].rsplit(".", 1)
1695         remote_host, remote_port = chunks[4].rsplit(".", 1)
1696         if which_end == "remote_port" and int(remote_port) != port:
1697             continue
1698         if which_end == "local_port" and int(local_port) != port:
1699             continue
1700         remotes.add(remote_host)
1701     return remotes
1702 @jinja_filter("gen_mac")
1703 def gen_mac(prefix="AC:DE:48"):
1704     """
1705     Generates a MAC address with the defined OUI prefix.
1706     Common prefixes:
1707      - ``00:16:3E`` -- Xen
1708      - ``00:18:51`` -- OpenVZ
1709      - ``00:50:56`` -- VMware (manually generated)
1710      - ``52:54:00`` -- QEMU/KVM
1711      - ``AC:DE:48`` -- PRIVATE
1712     References:
1713      - http://standards.ieee.org/develop/regauth/oui/oui.txt
1714      - https://www.wireshark.org/tools/oui-lookup.html
1715      - https://en.wikipedia.org/wiki/MAC_address
1716     """
1717     return "{}:{:02X}:{:02X}:{:02X}".format(
1718         prefix,
1719         random.randint(0, 0xFF),
1720         random.randint(0, 0xFF),
1721         random.randint(0, 0xFF),
1722     )
1723 @jinja_filter("mac_str_to_bytes")
1724 def mac_str_to_bytes(mac_str):
1725     """
1726     Convert a MAC address string into bytes. Works with or without separators:
1727     b1 = mac_str_to_bytes('08:00:27:13:69:77')
1728     b2 = mac_str_to_bytes('080027136977')
1729     assert b1 == b2
1730     assert isinstance(b1, bytes)
1731     """
1732     if len(mac_str) == 12:
1733         pass
1734     elif len(mac_str) == 17:
1735         sep = mac_str[2]
1736         mac_str = mac_str.replace(sep, "")
1737     else:
1738         raise ValueError("Invalid MAC address")
1739     chars = (int(mac_str[s : s + 2], 16) for s in range(0, 12, 2))
1740     return bytes(chars)
1741 def refresh_dns():
1742     """
1743     issue #21397: force glibc to re-read resolv.conf
1744     """
1745     try:
1746         RES_INIT()
1747     except NameError:
1748         pass
1749 @jinja_filter("dns_check")
1750 def dns_check(addr, port, safe=False, ipv6=None):
1751     """
1752     Return an ip address resolved by dns in a format usable in URLs (ipv6 in brackets).
1753     Obeys system preference for IPv4/6 address resolution - this can be overridden by
1754     the ipv6 flag. Tries to connect to the address before considering it useful. If no
1755     address can be reached, the first one resolved is used as a fallback.
1756     Does not exit on failure, raises an exception.
1757     """
1758     ip_addrs = []
1759     family = (
1760         socket.AF_INET6
1761         if ipv6
1762         else socket.AF_INET
1763         if ipv6 is False
1764         else socket.AF_UNSPEC
1765     )
1766     socket_error = False
1767     try:
1768         refresh_dns()
1769         addrinfo = socket.getaddrinfo(addr, port, family, socket.SOCK_STREAM)
1770         ip_addrs = _test_addrs(addrinfo, port)
1771     except TypeError:
1772         raise SaltSystemExit(
1773             code=42,
1774             msg=(
1775                 "Attempt to resolve address '{}' failed. Invalid or unresolveable"
1776                 " address".format(addr)
1777             ),
1778         )
1779     except OSError:
1780         socket_error = True
1781     if socket_error and ipv6:
1782         try:
1783             refresh_dns()
1784             addrinfo = socket.getaddrinfo(
1785                 addr, port, socket.AF_INET, socket.SOCK_STREAM
1786             )
1787             ip_addrs = _test_addrs(addrinfo, port)
1788         except TypeError:
1789             raise SaltSystemExit(
1790                 code=42,
1791                 msg=(
1792                     "Attempt to resolve address '{}' failed. Invalid or unresolveable"
1793                     " address".format(addr)
1794                 ),
1795             )
1796         except OSError:
1797             error = True
1798     if not ip_addrs:
1799         err = "DNS lookup or connection check of '{}' failed.".format(addr)
1800         if safe:
1801             if salt.log.is_console_configured():
1802                 log.error(err)
1803             raise SaltClientError()
1804         raise SaltSystemExit(code=42, msg=err)
1805     return salt.utils.zeromq.ip_bracket(ip_addrs[0])
1806 def _test_addrs(addrinfo, port):
1807     """
1808     Attempt to connect to all addresses, return one if it succeeds.
1809     Otherwise, return all addrs.
1810     """
1811     ip_addrs = []
1812     for a in addrinfo:
1813         ip_family = a[0]
1814         ip_addr = a[4][0]
1815         if ip_addr in ip_addrs:
1816             continue
1817         ip_addrs.append(ip_addr)
1818         try:
1819             s = socket.socket(ip_family, socket.SOCK_STREAM)
1820             s.settimeout(2)
1821             s.connect((ip_addr, port))
1822             s.close()
1823             ip_addrs = [ip_addr]
1824             break
1825         except OSError:
1826             pass
1827     return ip_addrs
1828 def parse_host_port(host_port):
1829     """
1830     Takes a string argument specifying host or host:port.
1831     Returns a (hostname, port) or (ip_address, port) tuple. If no port is given,
1832     the second (port) element of the returned tuple will be None.
1833     host:port argument, for example, is accepted in the forms of:
1834       - hostname
1835       - hostname:1234
1836       - hostname.domain.tld
1837       - hostname.domain.tld:5678
1838       - [1234::5]:5678
1839       - 1234::5
1840       - 10.11.12.13:4567
1841       - 10.11.12.13
1842     """
1843     host, port = None, None  # default
1844     _s_ = host_port[:]
1845     if _s_[0] == "[":
1846         if "]" in host_port:
1847             host, _s_ = _s_.lstrip("[").rsplit("]", 1)
1848             host = ipaddress.IPv6Address(host).compressed
1849             if _s_[0] == ":":
1850                 port = int(_s_.lstrip(":"))
1851             else:
1852                 if len(_s_) &gt; 1:
1853                     raise ValueError(
1854                         'found ambiguous "{}" port in "{}"'.format(_s_, host_port)
1855                     )
1856     else:
1857         if _s_.count(":") == 1:
1858             host, _hostport_separator_, port = _s_.partition(":")
1859             try:
1860                 port = int(port)
1861             except ValueError as _e_:
1862                 errmsg = 'host_port "{}" port value "{}" is not an integer.'.format(
1863                     host_port, port
1864                 )
1865                 log.error(errmsg)
1866                 raise ValueError(errmsg)
1867         else:
1868             host = _s_
1869     try:
1870         if not isinstance(host, ipaddress._BaseAddress):
1871             host_ip = ipaddress.ip_address(host).compressed
1872             host = host_ip
1873     except ValueError:
1874         log.debug('"%s" Not an IP address? Assuming it is a hostname.', host)
1875         if host != sanitize_host(host):
1876             log.error('bad hostname: "%s"', host)
1877             raise ValueError('bad hostname: "{}"'.format(host))
1878     return host, port
1879 @jinja_filter("filter_by_networks")
1880 def filter_by_networks(values, networks):
1881     """
1882     Returns the list of IPs filtered by the network list.
1883     If the network list is an empty sequence, no IPs are returned.
1884     If the network list is None, all IPs are returned.
1885     {% set networks = ['192.168.0.0/24', 'fe80::/64'] %}
1886     {{ grains['ip_interfaces'] | filter_by_networks(networks) }}
1887     {{ grains['ipv6'] | filter_by_networks(networks) }}
1888     {{ grains['ipv4'] | filter_by_networks(networks) }}
1889     """
1890     _filter = lambda ips, networks: [
1891         ip for ip in ips for net in networks if ipaddress.ip_address(ip) in net
1892     ]
1893     if networks is not None:
1894         networks = [ipaddress.ip_network(network) for network in networks]
1895         if isinstance(values, Mapping):
1896             return {
1897                 interface: _filter(values[interface], networks) for interface in values
1898             }
1899         elif isinstance(values, Sequence):
1900             return _filter(values, networks)
1901         else:
1902             raise ValueError("Do not know how to filter a {}".format(type(values)))
1903     else:
1904         return values
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
