<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_win_lgpo_auditpol.py &amp; test_aptpkg_1.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_win_lgpo_auditpol.py &amp; test_aptpkg_1.py
      </h3>
<h1 align="center">
        1.8%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_win_lgpo_auditpol.py (8.484848%)<th>test_aptpkg_1.py (1.0424423%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(46-49)<td><a href="#" name="0">(267-270)</a><td align="center"><font color="#ff0000">14</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_win_lgpo_auditpol.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import random
2 import pytest
3 import salt.modules.cmdmod
4 import salt.utils.platform
5 import salt.utils.win_lgpo_auditpol as win_lgpo_auditpol
6 from tests.support.mixins import LoaderModuleMockMixin
7 from tests.support.mock import MagicMock, patch
8 from tests.support.unit import TestCase, skipIf
9 settings = ["No Auditing", "Success", "Failure", "Success and Failure"]
10 @skipIf(not salt.utils.platform.is_windows(), "System is not Windows")
11 class WinLgpoAuditpolTestCase(TestCase, LoaderModuleMockMixin):
12     def setup_loader_modules(self):
13         return {
14             win_lgpo_auditpol: {
15                 "__context__": {},
16                 "__salt__": {"cmd.run_all": salt.modules.cmdmod.run_all},
17             }
18         }
19     def test_get_settings(self):
20         names = win_lgpo_auditpol._get_valid_names()
21         ret = win_lgpo_auditpol.get_settings(category="All")
22         for name in names:
23             self.assertIn(name, [k.lower() for k in ret])
24     def test_get_settings_invalid_category(self):
25         self.assertRaises(
26             KeyError, win_lgpo_auditpol.get_settings, category="Fake Category"
27         )
28     @pytest.mark.slow_test
29     def test_get_setting(self):
30         names = win_lgpo_auditpol._get_valid_names()
31         for name in names:
32             ret = win_lgpo_auditpol.get_setting(name)
33             self.assertIn(ret, settings)
34     def test_get_setting_invalid_name(self):
35 <a name="0"></a>        self.assertRaises(KeyError, win_lgpo_auditpol.get_setting, name="Fake Name")
36     def test_set_setting(self):
37         names <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= ["Credential Validation", "IPsec Driver", "File System", "SAM"]
38         mock_set = MagicMock(return_value={"retcode": 0, "stdout": "Success"})
39         with patch.object(salt.modules.cmdmod, "run_all", mock_set):
40             with patch.object(</b></font>
41                 win_lgpo_auditpol,
42                 "_get_valid_names",
43                 return_value=[k.lower() for k in names],
44             ):
45                 for name in names:
46                     value = random.choice(settings)
47                     win_lgpo_auditpol.set_setting(name=name, value=value)
48                     switches = win_lgpo_auditpol.settings[value]
49                     cmd = 'auditpol /set /subcategory:"{}" {}'.format(name, switches)
50                     mock_set.assert_called_once_with(cmd=cmd, python_shell=True)
51                     mock_set.reset_mock()
52     def test_set_setting_invalid_setting(self):
53         names = ["Credential Validation", "IPsec Driver", "File System"]
54         with patch.object(
55             win_lgpo_auditpol,
56             "_get_valid_names",
57             return_value=[k.lower() for k in names],
58         ):
59             self.assertRaises(
60                 KeyError,
61                 win_lgpo_auditpol.set_setting,
62                 name="Fake Name",
63                 value="No Auditing",
64             )
65     def test_set_setting_invalid_value(self):
66         names = ["Credential Validation", "IPsec Driver", "File System"]
67         with patch.object(
68             win_lgpo_auditpol,
69             "_get_valid_names",
70             return_value=[k.lower() for k in names],
71         ):
72             self.assertRaises(
73                 KeyError,
74                 win_lgpo_auditpol.set_setting,
75                 name="Credential Validation",
76                 value="Fake Value",
77             )
78     def test_get_auditpol_dump(self):
79         names = win_lgpo_auditpol._get_valid_names()
80         dump = win_lgpo_auditpol.get_auditpol_dump()
81         for name in names:
82             found = False
83             for line in dump:
84                 if name.lower() in line.lower():
85                     found = True
86                     break
87             self.assertTrue(found)
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_aptpkg_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import copy
2 import logging
3 import os
4 import pathlib
5 import textwrap
6 import pytest
7 import salt.modules.aptpkg as aptpkg
8 import salt.modules.pkg_resource as pkg_resource
9 from salt.exceptions import (
10     CommandExecutionError,
11     CommandNotFoundError,
12     SaltInvocationError,
13 )
14 from tests.support.mock import MagicMock, Mock, call, mock_open, patch
15 try:
16     from aptsources import sourceslist  # pylint: disable=unused-import
17     HAS_APTSOURCES = True
18 except ImportError:
19     HAS_APTSOURCES = False
20 log = logging.getLogger(__name__)
21 @pytest.fixture(scope="module")
22 def repo_keys_var():
23     return {
24         "46181433FBB75451": {
25             "algorithm": 17,
26             "bits": 1024,
27             "capability": "scSC",
28             "date_creation": 1104433784,
29             "date_expiration": None,
30             "fingerprint": "C5986B4F1257FFA86632CBA746181433FBB75451",
31             "keyid": "46181433FBB75451",
32             "uid": "Ubuntu CD Image Automatic Signing Key &lt;cdimage@ubuntu.com&gt;",
33             "uid_hash": "B4D41942D4B35FF44182C7F9D00C99AF27B93AD0",
34             "validity": "-",
35         }
36     }
37 @pytest.fixture(scope="module")
38 def packages_var():
39     return {"wget": "1.15-1ubuntu1.14.04.2"}
40 @pytest.fixture(scope="module")
41 def lowpkg_files_var():
42     return {
43         "errors": {},
44         "packages": {
45             "wget": [
46                 "/.",
47                 "/etc",
48                 "/etc/wgetrc",
49                 "/usr",
50                 "/usr/bin",
51                 "/usr/bin/wget",
52                 "/usr/share",
53                 "/usr/share/info",
54                 "/usr/share/info/wget.info.gz",
55                 "/usr/share/doc",
56                 "/usr/share/doc/wget",
57                 "/usr/share/doc/wget/MAILING-LIST",
58                 "/usr/share/doc/wget/NEWS.gz",
59                 "/usr/share/doc/wget/AUTHORS",
60                 "/usr/share/doc/wget/copyright",
61                 "/usr/share/doc/wget/changelog.Debian.gz",
62                 "/usr/share/doc/wget/README",
63                 "/usr/share/man",
64                 "/usr/share/man/man1",
65                 "/usr/share/man/man1/wget.1.gz",
66             ]
67         },
68     }
69 @pytest.fixture(scope="module")
70 def lowpkg_info_var():
71     return {
72         "wget": {
73             "architecture": "amd64",
74             "description": "retrieves files from the web",
75             "homepage": "http://www.gnu.org/software/wget/",
76             "install_date": "2016-08-30T22:20:15Z",
77             "maintainer": "Ubuntu Developers &lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;",
78             "name": "wget",
79             "section": "web",
80             "source": "wget",
81             "version": "1.15-1ubuntu1.14.04.2",
82             "status": "ii",
83         },
84         "apache2": {
85             "architecture": "amd64",
86             "description": """Apache HTTP Server
87      The Apache HTTP Server Project's goal is to build a secure, efficient and
88      extensible HTTP server as standards-compliant open source software. The
89      result has long been the number one web server on the Internet.
90      .
91      Installing this package results in a full installation, including the
92      configuration files, init scripts and support scripts.""",
93             "homepage": "http://httpd.apache.org/",
94             "install_date": "2016-08-30T22:20:15Z",
95             "maintainer": "Ubuntu Developers &lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;",
96             "name": "apache2",
97             "section": "httpd",
98             "source": "apache2",
99             "version": "2.4.18-2ubuntu3.9",
100             "status": "rc",
101         },
102     }
103 @pytest.fixture(scope="module")
104 def apt_q_update_var():
105     return """
106     Get:1 http://security.ubuntu.com trusty-security InRelease [65 kB]
107     Get:2 http://security.ubuntu.com trusty-security/main Sources [120 kB]
108     Get:3 http://security.ubuntu.com trusty-security/main amd64 Packages [548 kB]
109     Get:4 http://security.ubuntu.com trusty-security/main i386 Packages [507 kB]
110     Hit http://security.ubuntu.com trusty-security/main Translation-en
111     Fetched 1240 kB in 10s (124 kB/s)
112     Reading package lists...
113 @pytest.fixture(scope="module")
114 def autoremove_var():
115     return """
116     Reading package lists... Done
117     Building dependency tree
118     Reading state information... Done
119     0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
120 @pytest.fixture(scope="module")
121 def uninstall_var():
122     return {"tmux": {"new": "", "old": "1.8-5"}}
123 @pytest.fixture(scope="module")
124 def install_var():
125     return {"tmux": {"new": "1.8-5", "old": ""}}
126 def _get_uri(repo):
127     splits = repo.split()
128     for val in splits:
129         if any(val.startswith(x) for x in ("http://", "https://", "ftp://")):
130             return val
131 class MockSourceEntry:
132     def __init__(self, uri, source_type, line, invalid, dist="", file=None):
133         self.uri = uri
134         self.type = source_type
135         self.line = line
136         self.invalid = invalid
137         self.file = file
138         self.disabled = False
139         self.dist = dist
140         self.comps = []
141         self.architectures = []
142     def mysplit(self, line):
143         return line.split()
144 class MockSourceList:
145     def __init__(self):
146         self.list = []
147     def __iter__(self):
148         yield from self.list
149     def save(self):
150         pass
151 @pytest.fixture
152 def configure_loader_modules():
153     return {aptpkg: {"__grains__": {}}}
154 def test_version(lowpkg_info_var):
155     version = lowpkg_info_var["wget"]["version"]
156     mock = MagicMock(return_value=version)
157     with patch.dict(aptpkg.__salt__, {"pkg_resource.version": mock}):
158         assert aptpkg.version(*["wget"]) == version
159 def test_upgrade_available():
160     with patch("salt.modules.aptpkg.latest_version", MagicMock(return_value="")):
161         assert aptpkg.upgrade_available("wget") is False
162 def test_add_repo_key(repo_keys_var):
163     with patch(
164         "salt.modules.aptpkg.get_repo_keys", MagicMock(return_value=repo_keys_var)
165     ):
166         mock = MagicMock(return_value={"retcode": 0, "stdout": "OK"})
167         with patch.dict(aptpkg.__salt__, {"cmd.run_all": mock}):
168             assert (
169                 aptpkg.add_repo_key(keyserver="keyserver.ubuntu.com", keyid="FBB75451")
170                 is True
171             )
172 def test_add_repo_key_failed(repo_keys_var):
173 <a name="0"></a>    with patch(
174         "salt.modules.aptpkg.get_repo_keys", MagicMock(return_value=repo_keys_var)
175     ):
176         kwargs <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= {"keyserver": "keyserver.ubuntu.com"}
177         mock = MagicMock(return_value={"retcode": 0, "stdout": "OK"})
178         with patch.dict(aptpkg.__salt__, {"cmd.run_all": mock}):
179             with pytest.raises(</b></font>SaltInvocationError):
180                 aptpkg.add_repo_key(**kwargs)
181 def test_get_repo_keys(repo_keys_var):
182     APT_KEY_LIST = r"""
183     pub:-:1024:17:46181433FBB75451:1104433784:::-:::scSC:
184     fpr:::::::::C5986B4F1257FFA86632CBA746181433FBB75451:
185     uid:-::::1104433784::B4D41942D4B35FF44182C7F9D00C99AF27B93AD0::Ubuntu CD Image Automatic Signing Key &lt;cdimage@ubuntu.com&gt;:
186     """
187     mock = MagicMock(return_value={"retcode": 0, "stdout": APT_KEY_LIST})
188     with patch.dict(aptpkg.__salt__, {"cmd.run_all": mock}):
189         assert aptpkg.get_repo_keys() == repo_keys_var
190 def test_file_dict(lowpkg_files_var):
191     mock = MagicMock(return_value=lowpkg_files_var)
192     with patch.dict(aptpkg.__salt__, {"lowpkg.file_dict": mock}):
193         assert aptpkg.file_dict("wget") == lowpkg_files_var
194 def test_file_list(lowpkg_files_var):
195     files = {
196         "errors": lowpkg_files_var["errors"],
197         "files": lowpkg_files_var["packages"]["wget"],
198     }
199     mock = MagicMock(return_value=files)
200     with patch.dict(aptpkg.__salt__, {"lowpkg.file_list": mock}):
201         assert aptpkg.file_list("wget") == files
202 def test_get_selections():
203     selections = {"install": ["wget"]}
204     mock = MagicMock(return_value="wget\t\t\t\t\t\tinstall")
205     with patch.dict(aptpkg.__salt__, {"cmd.run_stdout": mock}):
206         assert aptpkg.get_selections("wget") == selections
207 def test_info_installed(lowpkg_info_var):
208     names = {"group": "section", "packager": "maintainer", "url": "homepage"}
209     installed = copy.deepcopy({"wget": lowpkg_info_var["wget"]})
210     for name in names:
211         if installed["wget"].get(names[name], False):
212             installed["wget"][name] = installed["wget"].pop(names[name])
213     mock = MagicMock(return_value=lowpkg_info_var)
214     with patch.dict(aptpkg.__salt__, {"lowpkg.info": mock}):
215         del installed["wget"]["status"]
216         assert aptpkg.info_installed("wget") == installed
217         assert len(aptpkg.info_installed()) == 1
218 def test_owner():
219     paths = ["/usr/bin/wget"]
220     mock = MagicMock(return_value="wget: /usr/bin/wget")
221     with patch.dict(aptpkg.__salt__, {"cmd.run_stdout": mock}):
222         assert aptpkg.owner(*paths) == "wget"
223 def test_refresh_db(apt_q_update_var):
224     refresh_db = {
225         "http://security.ubuntu.com trusty-security InRelease": True,
226         "http://security.ubuntu.com trusty-security/main Sources": True,
227         "http://security.ubuntu.com trusty-security/main Translation-en": None,
228         "http://security.ubuntu.com trusty-security/main amd64 Packages": True,
229         "http://security.ubuntu.com trusty-security/main i386 Packages": True,
230     }
231     mock = MagicMock(return_value={"retcode": 0, "stdout": apt_q_update_var})
232     with patch("salt.utils.pkg.clear_rtag", MagicMock()):
233         with patch.dict(
234             aptpkg.__salt__,
235             {"cmd.run_all": mock, "config.get": MagicMock(return_value=False)},
236         ):
237             assert aptpkg.refresh_db() == refresh_db
238 def test_refresh_db_failed(apt_q_update_error_var):
239     kwargs = {"failhard": True}
240     mock = MagicMock(return_value={"retcode": 0, "stdout": apt_q_update_error_var})
241     with patch("salt.utils.pkg.clear_rtag", MagicMock()):
242         with patch.dict(
243             aptpkg.__salt__,
244             {"cmd.run_all": mock, "config.get": MagicMock(return_value=False)},
245         ):
246             with pytest.raises(CommandExecutionError):
247                 aptpkg.refresh_db(**kwargs)
248 def test_autoremove(packages_var, autoremove_var):
249     with patch("salt.modules.aptpkg.list_pkgs", MagicMock(return_value=packages_var)):
250         patch_kwargs = {
251             "__salt__": {
252                 "config.get": MagicMock(return_value=True),
253                 "cmd.run_all": MagicMock(
254                     return_value=MagicMock(return_value=autoremove_var)
255                 ),
256             }
257         }
258         with patch.multiple(aptpkg, **patch_kwargs):
259             assert aptpkg.autoremove() == {}
260             assert aptpkg.autoremove(purge=True) == {}
261             assert aptpkg.autoremove(list_only=True) == []
262             assert aptpkg.autoremove(list_only=True, purge=True) == []
263 def test_install(install_var):
264     with patch("salt.modules.aptpkg.install", MagicMock(return_value=install_var)):
265         assert aptpkg.install(name="tmux") == install_var
266         kwargs = {"force_conf_new": True}
267         assert aptpkg.install(name="tmux", **kwargs) == install_var
268 def test_remove(uninstall_var):
269     with patch("salt.modules.aptpkg._uninstall", MagicMock(return_value=uninstall_var)):
270         assert aptpkg.remove(name="tmux") == uninstall_var
271 def test_purge(uninstall_var):
272     with patch("salt.modules.aptpkg._uninstall", MagicMock(return_value=uninstall_var)):
273         assert aptpkg.purge(name="tmux") == uninstall_var
274 def test_upgrade(uninstall_var, upgrade_var):
275     with patch("salt.utils.pkg.clear_rtag", MagicMock()):
276         with patch(
277             "salt.modules.aptpkg.list_pkgs", MagicMock(return_value=uninstall_var)
278         ):
279             mock_cmd = MagicMock(return_value={"retcode": 0, "stdout": upgrade_var})
280             patch_kwargs = {
281                 "__salt__": {
282                     "config.get": MagicMock(return_value=True),
283                     "cmd.run_all": mock_cmd,
284                 }
285             }
286             with patch.multiple(aptpkg, **patch_kwargs):
287                 assert aptpkg.upgrade() == dict()
288                 kwargs = {"force_conf_new": True}
289                 assert aptpkg.upgrade(**kwargs) == dict()
290 def test_upgrade_downloadonly(uninstall_var, upgrade_var):
291     with patch("salt.utils.pkg.clear_rtag", MagicMock()):
292         with patch(
293             "salt.modules.aptpkg.list_pkgs", MagicMock(return_value=uninstall_var)
294         ):
295             mock_cmd = MagicMock(return_value={"retcode": 0, "stdout": upgrade_var})
296             patch_kwargs = {
297                 "__salt__": {
298                     "config.get": MagicMock(return_value=True),
299                     "cmd.run_all": mock_cmd,
300                 },
301             }
302             with patch.multiple(aptpkg, **patch_kwargs):
303                 aptpkg.upgrade()
304                 args_matching = [
305                     True
306                     for args in patch_kwargs["__salt__"]["cmd.run_all"].call_args[0]
307                     if "--download-only" in args
308                 ]
309                 assert any(args_matching) is False
310                 aptpkg.upgrade(downloadonly=True)
311                 args_matching = [
312                     True
313                     for args in patch_kwargs["__salt__"]["cmd.run_all"].call_args[0]
314                     if "--download-only" in args
315                 ]
316                 assert any(args_matching) is True
317                 aptpkg.upgrade(download_only=True)
318                 args_matching = [
319                     True
320                     for args in patch_kwargs["__salt__"]["cmd.run_all"].call_args[0]
321                     if "--download-only" in args
322                 ]
323                 assert any(args_matching) is True
324 def test_upgrade_allow_downgrades(uninstall_var, upgrade_var):
325     with patch("salt.utils.pkg.clear_rtag", MagicMock()):
326         with patch(
327             "salt.modules.aptpkg.list_pkgs", MagicMock(return_value=uninstall_var)
328         ):
329             mock_cmd = MagicMock(return_value={"retcode": 0, "stdout": upgrade_var})
330             patch_kwargs = {
331                 "__salt__": {
332                     "config.get": MagicMock(return_value=True),
333                     "cmd.run_all": mock_cmd,
334                 },
335             }
336             with patch.multiple(aptpkg, **patch_kwargs):
337                 aptpkg.upgrade()
338                 args_matching = [
339                     True
340                     for args in patch_kwargs["__salt__"]["cmd.run_all"].call_args[0]
341                     if "--allow-downgrades" in args
342                 ]
343                 assert any(args_matching) is False
344                 aptpkg.upgrade(allow_downgrades=True)
345                 args_matching = [
346                     True
347                     for args in patch_kwargs["__salt__"]["cmd.run_all"].call_args[0]
348                     if "--allow-downgrades" in args
349                 ]
350                 assert any(args_matching) is True
351 def test_show():
352     show_mock_success = MagicMock(
353         return_value={
354             "retcode": 0,
355             "pid": 12345,
356             "stderr": "",
357             "stdout": textwrap.dedent(
358             ),
359         }
360     )
361     show_mock_failure = MagicMock(
362         return_value={
363             "retcode": 1,
364             "pid": 12345,
365             "stderr": textwrap.dedent(
366             ),
367             "stdout": "",
368         }
369     )
370     refresh_mock = Mock()
371     expected = {
372         "foo1.0": {
373             "1.0.5-3ubuntu4": {
374                 "Architecture": "amd64",
375                 "Description": "A silly package (1.0 release cycle)",
376                 "Provides": "foo",
377                 "Suggests": "foo-doc",
378             },
379             "1.0.4-2ubuntu1": {
380                 "Architecture": "amd64",
381                 "Description": "A silly package (1.0 release cycle)",
382                 "Provides": "foo",
383                 "Suggests": "foo-doc",
384             },
385         },
386         "foo-doc": {
387             "1.0.5-3ubuntu4": {
388                 "Architecture": "all",
389                 "Description": (
390                     "Silly documentation for a silly package (1.0 release cycle)"
391                 ),
392             },
393             "1.0.4-2ubuntu1": {
394                 "Architecture": "all",
395                 "Description": (
396                     "Silly documentation for a silly package (1.0 release cycle)"
397                 ),
398             },
399         },
400     }
401     filtered = copy.deepcopy(expected)
402     for k1 in filtered:
403         for k2 in filtered[k1]:
404             for k3 in list(filtered[k1][k2]):
405                 if k3 not in ("Description", "Provides"):
406                     filtered[k1][k2].pop(k3)
407     with patch.dict(aptpkg.__salt__, {"cmd.run_all": show_mock_success}), patch.object(
408         aptpkg, "refresh_db", refresh_mock
409     ):
410         assert aptpkg.show("foo*") == expected
411         refresh_mock.assert_not_called()
412         refresh_mock.reset_mock()
413         assert aptpkg.show("foo*", refresh=True) == expected
414         refresh_mock.assert_called_once()
415         refresh_mock.reset_mock()
416         assert aptpkg.show("foo*", filter="description,provides") == filtered
417         refresh_mock.assert_not_called()
418         refresh_mock.reset_mock()
419     with patch.dict(aptpkg.__salt__, {"cmd.run_all": show_mock_failure}), patch.object(
420         aptpkg, "refresh_db", refresh_mock
421     ):
422         assert aptpkg.show("foo*") == {}
423         refresh_mock.assert_not_called()
424         refresh_mock.reset_mock()
425         assert aptpkg.show("foo*", refresh=True) == {}
426         refresh_mock.assert_called_once()
427         refresh_mock.reset_mock()
428 @pytest.mark.skipif(
429     not (pathlib.Path("/etc") / "apt" / "sources.list").is_file(),
430     reason="Requires sources.list file",
431 )
432 def test_mod_repo_enabled():
433     with patch.dict(
434         aptpkg.__salt__,
435         {"config.option": MagicMock(), "no_proxy": MagicMock(return_value=False)},
436     ):
437         with patch("salt.modules.aptpkg.refresh_db", MagicMock(return_value={})):
438             with patch(
439                 "salt.utils.data.is_true", MagicMock(return_value=True)
440             ) as data_is_true:
441                 with patch("salt.modules.aptpkg.SourcesList", MagicMock(), create=True):
442                     with patch(
443                         "salt.modules.aptpkg.SourceEntry", MagicMock(), create=True
444                     ):
445                         repo = aptpkg.mod_repo("foo", enabled=False)
446                         data_is_true.assert_called_with(False)
447                         data_is_true.reset_mock()
448                         repo = aptpkg.mod_repo("foo", disabled=True)
449                         data_is_true.assert_called_with(True)
450                         data_is_true.reset_mock()
451                         repo = aptpkg.mod_repo("foo", enabled=True)
452                         data_is_true.assert_called_with(True)
453                         data_is_true.reset_mock()
454                         repo = aptpkg.mod_repo("foo", disabled=False)
455                         data_is_true.assert_called_with(False)
456 def test_mod_repo_match():
457     source_type = "deb"
458     source_uri = "http://cdn-aws.deb.debian.org/debian/"
459     source_line = "deb http://cdn-aws.deb.debian.org/debian/ stretch main\n"
460     mock_source = MockSourceEntry(
461         source_uri, source_type, source_line, False, "stretch"
462     )
463     mock_source_list = MockSourceList()
464     mock_source_list.list = [mock_source]
465     with patch.dict(
466         aptpkg.__salt__,
467         {"config.option": MagicMock(), "no_proxy": MagicMock(return_value=False)},
468     ):
469         with patch("salt.modules.aptpkg.refresh_db", MagicMock(return_value={})):
470             with patch("salt.utils.data.is_true", MagicMock(return_value=True)):
471                 with patch("salt.modules.aptpkg.SourceEntry", MagicMock(), create=True):
472                     with patch(
473                         "salt.modules.aptpkg.SourcesList",
474                         MagicMock(return_value=mock_source_list),
475                         create=True,
476                     ):
477                         with patch(
478                             "salt.modules.aptpkg._split_repo_str",
479                             MagicMock(
480                                 return_value=(
481                                     "deb",
482                                     [],
483                                     "http://cdn-aws.deb.debian.org/debian/",
484                                     "stretch",
485                                     ["main"],
486                                 )
487                             ),
488                         ):
489                             source_line_no_slash = (
490                                 "deb http://cdn-aws.deb.debian.org/debian"
491                                 " stretch main"
492                             )
493                             repo = aptpkg.mod_repo(source_line_no_slash, enabled=False)
494                             assert repo[source_line_no_slash]["uri"] == source_uri
495 @patch("salt.utils.path.os_walk", MagicMock(return_value=[("test", "test", "test")]))
496 @patch("os.path.getsize", MagicMock(return_value=123456))
497 @patch("os.path.getctime", MagicMock(return_value=1234567890.123456))
498 @patch(
499     "fnmatch.filter",
500     MagicMock(return_value=["/var/cache/apt/archive/test_package.rpm"]),
501 )
502 def test_list_downloaded():
503     DOWNLOADED_RET = {
504         "test-package": {
505             "1.0": {
506                 "path": "/var/cache/apt/archive/test_package.rpm",
507                 "size": 123456,
508                 "creation_date_time_t": 1234567890,
509                 "creation_date_time": "2009-02-13T23:31:30",
510             }
511         }
512     }
513     with patch.dict(
514         aptpkg.__salt__,
515         {
516             "lowpkg.bin_pkg_info": MagicMock(
517                 return_value={"name": "test-package", "version": "1.0"}
518             )
519         },
520     ):
521         list_downloaded = aptpkg.list_downloaded()
522         assert len(list_downloaded) == 1
523         assert list_downloaded == DOWNLOADED_RET
524 def test__skip_source():
525     source_type = "deb"
526     source_uri = "http://cdn-aws.deb.debian.org/debian"
527     source_line = "deb http://cdn-aws.deb.debian.org/debian stretch main\n"
528     mock_source = MockSourceEntry(source_uri, source_type, source_line, False)
529     ret = aptpkg._skip_source(mock_source)
530     assert ret is False
531     source_type = "ded"
532     source_uri = "http://cdn-aws.deb.debian.org/debian"
533     source_line = "deb http://cdn-aws.deb.debian.org/debian stretch main\n"
534     mock_source = MockSourceEntry(source_uri, source_type, source_line, True)
535     ret = aptpkg._skip_source(mock_source)
536     assert ret is True
537     source_type = "deb"
538     source_uri = "http://cdn-aws.deb.debian.org/debian"
539     source_line = "deb [http://cdn-aws.deb.debian.org/debian] stretch main\n"
540     mock_source = MockSourceEntry(source_uri, source_type, source_line, True)
541     ret = aptpkg._skip_source(mock_source)
542     assert ret is False
543 def test_normalize_name():
544     with patch.dict(aptpkg.__grains__, {"osarch": "amd64"}):
545         result = aptpkg.normalize_name("foo")
546         assert result == "foo", result
547         result = aptpkg.normalize_name("foo:amd64")
548         assert result == "foo", result
549         result = aptpkg.normalize_name("foo:any")
550         assert result == "foo", result
551         result = aptpkg.normalize_name("foo:all")
552         assert result == "foo", result
553         result = aptpkg.normalize_name("foo:i386")
554         assert result == "foo:i386", result
555 def test_list_repos():
556     source_type = "deb"
557     source_uri = "http://cdn-aws.deb.debian.org/debian/"
558     source_line = "deb http://cdn-aws.deb.debian.org/debian/ stretch main\n"
559     mock_source = MockSourceEntry(source_uri, source_type, source_line, False)
560     mock_source_list = MockSourceList()
561     mock_source_list.list = [mock_source]
562     with patch("salt.modules.aptpkg.SourcesList", MagicMock(), create=True):
563         with patch("salt.modules.aptpkg.SourceEntry", MagicMock(), create=True):
564             with patch(
565                 "salt.modules.aptpkg.SourcesList",
566                 MagicMock(return_value=mock_source_list),
567                 create=True,
568             ):
569                 repos = aptpkg.list_repos()
570                 assert source_uri in repos
571                 assert isinstance(repos[source_uri], list)
572                 assert len(repos[source_uri]) == 1
573                 assert "line" in repos[source_uri][0]
574                 _uri = _get_uri(repos[source_uri][0]["line"])
575                 assert _uri[-1] == "/"
576                 assert "uri" in repos[source_uri][0]
577                 assert repos[source_uri][0]["uri"][-1] == "/"
578 @pytest.mark.skipif(
579     HAS_APTSOURCES is False, reason="The 'aptsources' library is missing."
580 )
581 def test_expand_repo_def():
582     source_type = "deb"
583     source_uri = "http://cdn-aws.deb.debian.org/debian/"
584     source_line = "deb http://cdn-aws.deb.debian.org/debian/ stretch main\n"
585     source_file = "/etc/apt/sources.list"
586     repo = "deb http://cdn-aws.deb.debian.org/debian/ stretch main\n"
587     sanitized = aptpkg.expand_repo_def(repo=repo, file=source_file)
588     assert isinstance(sanitized, dict)
589     assert "uri" in sanitized
590     assert sanitized["uri"][-1] == "/"
591     repo = "deb http://cdn-aws.deb.debian.org/debian/ stretch main\n"
592     sanitized = aptpkg.expand_repo_def(
593         repo=repo, file=source_file, architectures="amd64"
594     )
595     assert isinstance(sanitized, dict)
596     assert "line" in sanitized
597     assert (
598         sanitized["line"]
599         == "deb [arch=amd64] http://cdn-aws.deb.debian.org/debian/ stretch main"
600     )
601 def test_list_pkgs():
602     def _add_data(data, key, value):
603         data.setdefault(key, []).append(value)
604     apt_out = [
605         "install ok installed accountsservice 0.6.55-0ubuntu12~20.04.1 amd64",
606         "install ok installed acpid 1:2.0.32-1ubuntu1 amd64",
607         "install ok installed adduser 3.118ubuntu2 all",
608         "install ok installed alsa-topology-conf 1.2.2-1 all",
609         "install ok installed alsa-ucm-conf 1.2.2-1ubuntu0.4 all",
610         "install ok installed apparmor 2.13.3-7ubuntu5.1 amd64",
611         "install ok installed apport 2.20.11-0ubuntu27.9 all",
612         "install ok installed apport-symptoms 0.23 all",
613         "install ok installed apt 2.0.2ubuntu0.1 amd64",
614         "install ok installed apt-utils 2.0.2ubuntu0.1 amd64",
615         "install ok installed at 3.1.23-1ubuntu1 amd64",
616     ]
617     with patch.dict(aptpkg.__grains__, {"osarch": "x86_64"}), patch.dict(
618         aptpkg.__salt__,
619         {"cmd.run_stdout": MagicMock(return_value=os.linesep.join(apt_out))},
620     ), patch.dict(aptpkg.__salt__, {"pkg_resource.add_pkg": _add_data}), patch.dict(
621         aptpkg.__salt__,
622         {"pkg_resource.format_pkg_list": pkg_resource.format_pkg_list},
623     ), patch.dict(
624         aptpkg.__salt__, {"pkg_resource.sort_pkglist": pkg_resource.sort_pkglist}
625     ):
626         pkgs = aptpkg.list_pkgs(versions_as_list=True)
627         for pkg_name, pkg_version in {
628             "accountsservice": "0.6.55-0ubuntu12~20.04.1",
629             "acpid": "1:2.0.32-1ubuntu1",
630             "adduser": "3.118ubuntu2",
631             "alsa-topology-conf": "1.2.2-1",
632             "alsa-ucm-conf": "1.2.2-1ubuntu0.4",
633             "apparmor": "2.13.3-7ubuntu5.1",
634             "apport": "2.20.11-0ubuntu27.9",
635             "apport-symptoms": "0.23",
636             "apt": "2.0.2ubuntu0.1",
637             "apt-utils": "2.0.2ubuntu0.1",
638             "at": "3.1.23-1ubuntu1",
639         }.items():
640             assert pkgs[pkg_name] == [pkg_version]
641 def test_list_pkgs_no_context():
642     def _add_data(data, key, value):
643         data.setdefault(key, []).append(value)
644     apt_out = [
645         "install ok installed accountsservice 0.6.55-0ubuntu12~20.04.1 amd64",
646         "install ok installed acpid 1:2.0.32-1ubuntu1 amd64",
647         "install ok installed adduser 3.118ubuntu2 all",
648         "install ok installed alsa-topology-conf 1.2.2-1 all",
649         "install ok installed alsa-ucm-conf 1.2.2-1ubuntu0.4 all",
650         "install ok installed apparmor 2.13.3-7ubuntu5.1 amd64",
651         "install ok installed apport 2.20.11-0ubuntu27.9 all",
652         "install ok installed apport-symptoms 0.23 all",
653         "install ok installed apt 2.0.2ubuntu0.1 amd64",
654         "install ok installed apt-utils 2.0.2ubuntu0.1 amd64",
655         "install ok installed at 3.1.23-1ubuntu1 amd64",
656     ]
657     with patch.dict(aptpkg.__grains__, {"osarch": "x86_64"}), patch.dict(
658         aptpkg.__salt__,
659         {"cmd.run_stdout": MagicMock(return_value=os.linesep.join(apt_out))},
660     ), patch.dict(aptpkg.__salt__, {"pkg_resource.add_pkg": _add_data}), patch.dict(
661         aptpkg.__salt__,
662         {"pkg_resource.format_pkg_list": pkg_resource.format_pkg_list},
663     ), patch.dict(
664         aptpkg.__salt__, {"pkg_resource.sort_pkglist": pkg_resource.sort_pkglist}
665     ), patch.object(
666         aptpkg, "_list_pkgs_from_context"
667     ) as list_pkgs_context_mock:
668         pkgs = aptpkg.list_pkgs(versions_as_list=True, use_context=False)
669         list_pkgs_context_mock.assert_not_called()
670         list_pkgs_context_mock.reset_mock()
671         pkgs = aptpkg.list_pkgs(versions_as_list=True, use_context=False)
672         list_pkgs_context_mock.assert_not_called()
673         list_pkgs_context_mock.reset_mock()
674 def test_call_apt_default():
675     with patch.dict(
676         aptpkg.__salt__,
677         {"cmd.run_all": MagicMock(), "config.get": MagicMock(return_value=False)},
678     ):
679         aptpkg._call_apt(["apt-get", "install", "emacs"])  # pylint: disable=W0106
680         aptpkg.__salt__["cmd.run_all"].assert_called_once_with(
681             ["apt-get", "install", "emacs"],
682             env={},
683             output_loglevel="trace",
684             python_shell=False,
685         )
686 @patch("salt.utils.systemd.has_scope", MagicMock(return_value=True))
687 def test_call_apt_in_scope():
688     with patch.dict(
689         aptpkg.__salt__,
690         {"cmd.run_all": MagicMock(), "config.get": MagicMock(return_value=True)},
691     ):
692         aptpkg._call_apt(["apt-get", "purge", "vim"])  # pylint: disable=W0106
693         aptpkg.__salt__["cmd.run_all"].assert_called_once_with(
694             [
695                 "systemd-run",
696                 "--scope",
697                 "--description",
698                 '"salt.modules.aptpkg"',
699                 "apt-get",
700                 "purge",
701                 "vim",
702             ],
703             env={},
704             output_loglevel="trace",
705             python_shell=False,
706         )
707 def test_call_apt_with_kwargs():
708     with patch.dict(
709         aptpkg.__salt__,
710         {"cmd.run_all": MagicMock(), "config.get": MagicMock(return_value=False)},
711     ):
712         aptpkg._call_apt(
713             ["dpkg", "-l", "python"],
714             python_shell=True,
715             output_loglevel="quiet",
716             ignore_retcode=False,
717             username="Darth Vader",
718         )  # pylint: disable=W0106
719         aptpkg.__salt__["cmd.run_all"].assert_called_once_with(
720             ["dpkg", "-l", "python"],
721             env={},
722             ignore_retcode=False,
723             output_loglevel="quiet",
724             python_shell=True,
725             username="Darth Vader",
726         )
727 def test_call_apt_dpkg_lock():
728     cmd_side_effect = [
729         {"stderr": "Could not get lock"},
730         {"stderr": "Could not get lock"},
731         {"stderr": "Could not get lock"},
732         {"stderr": "Could not get lock"},
733         {"stderr": "", "stdout": ""},
734     ]
735     cmd_mock = MagicMock(side_effect=cmd_side_effect)
736     cmd_call = (
737         call(
738             ["dpkg", "-l", "python"],
739             env={},
740             ignore_retcode=False,
741             output_loglevel="quiet",
742             python_shell=True,
743             username="Darth Vader",
744         ),
745     )
746     expected_calls = [cmd_call * 5]
747     with patch.dict(
748         aptpkg.__salt__,
749         {"cmd.run_all": cmd_mock, "config.get": MagicMock(return_value=False)},
750     ):
751         with patch("salt.modules.aptpkg.time.sleep", MagicMock()) as sleep_mock:
752             aptpkg._call_apt(
753                 ["dpkg", "-l", "python"],
754                 python_shell=True,
755                 output_loglevel="quiet",
756                 ignore_retcode=False,
757                 username="Darth Vader",
758             )  # pylint: disable=W0106
759             assert sleep_mock.call_count &gt;= 4
760             assert cmd_mock.call_count == 5
761             cmd_mock.has_calls(expected_calls)
762 def test_services_need_restart_checkrestart_missing():
763     with patch("salt.utils.path.which_bin", Mock(return_value=None)):
764         with pytest.raises(CommandNotFoundError):
765             aptpkg.services_need_restart()
766 @patch("salt.utils.path.which_bin", Mock(return_value="/usr/sbin/checkrestart"))
767 def test_services_need_restart():
768     cr_output = """
769 PROCESSES: 24
770 PROGRAMS: 17
771 PACKAGES: 8
772 SERVICE:rsyslog,385,/usr/sbin/rsyslogd
773 SERVICE:cups-daemon,390,/usr/sbin/cupsd
774     Test SourcesList when repo has multiple comps
775     Test SourcesList when architectures is in repo
776     """
777     with patch("salt.utils.files.fopen", mock_open(read_data=repo_line)):
778         with patch("pathlib.Path.is_file", side_effect=[True, False]):
779             sources = aptpkg.SourcesList()
780             for source in sources:
781                 assert source.type == "deb"
782                 assert source.uri == "http://archive.ubuntu.com/ubuntu/"
783                 assert source.comps == ["main", "restricted"]
784                 assert source.dist == "focal-updates"
785                 if "," in repo_line:
786                     assert source.architectures == ["amd64", "armel"]
787                 else:
788                     assert source.architectures == ["amd64"]
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
