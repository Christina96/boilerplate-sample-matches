<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for saltclass_2.py &amp; test_zfs_1.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for saltclass_2.py &amp; test_zfs_1.py
      </h3>
<h1 align="center">
        1.0%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>saltclass_2.py (2.1164021%)<th>test_zfs_1.py (0.72859746%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(422-426)<td><a href="#" name="0">(28-31)</a><td align="center"><font color="#ff0000">12</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>saltclass_2.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import glob
2 import logging
3 import os
4 import re
5 import salt.utils.path
6 import salt.utils.yaml
7 from jinja2 import Environment, FileSystemLoader
8 log = logging.getLogger(__name__)
9 def render_jinja(_file, salt_data):
10     j_env = Environment(loader=FileSystemLoader(os.path.dirname(_file)))
11     j_env.globals.update(
12         {
13             "__opts__": salt_data["__opts__"],
14             "__salt__": salt_data["__salt__"],
15             "__grains__": salt_data["__grains__"],
16             "__pillar__": salt_data["__pillar__"],
17             "minion_id": salt_data["minion_id"],
18         }
19     )
20     j_render = j_env.get_template(os.path.basename(_file)).render()
21     return j_render
22 def render_yaml(_file, salt_data):
23     return salt.utils.yaml.safe_load(render_jinja(_file, salt_data))
24 def get_class(_class, salt_data):
25     l_files = []
26     saltclass_path = salt_data["path"]
27     straight, sub_init, sub_straight = get_class_paths(_class, saltclass_path)
28     for root, dirs, files in salt.utils.path.os_walk(
29         os.path.join(saltclass_path, "classes"), followlinks=True
30     ):
31         for l_file in files:
32             l_files.append(os.path.join(root, l_file))
33     if straight in l_files:
34         return render_yaml(straight, salt_data)
35     if sub_straight in l_files:
36         return render_yaml(sub_straight, salt_data)
37     if sub_init in l_files:
38         return render_yaml(sub_init, salt_data)
39     log.warning("%s: Class definition not found", _class)
40     return {}
41 def get_class_paths(_class, saltclass_path):
42     straight = os.path.join(saltclass_path, "classes", "{}.yml".format(_class))
43     sub_straight = os.path.join(
44         saltclass_path, "classes", "{}.yml".format(_class.replace(".", os.sep))
45     )
46     sub_init = os.path.join(
47         saltclass_path, "classes", _class.replace(".", os.sep), "init.yml"
48     )
49     return straight, sub_init, sub_straight
50 def get_class_from_file(_file, saltclass_path):
51     _file = _file[len(os.path.join(saltclass_path, "classes")) + len(os.sep) :]
52     _file = _file[:-4]
53     _file = _file.replace(os.sep, ".")
54     if _file.endswith(".init"):
55         _file = _file[:-5]
56     return _file
57 def get_env_from_dict(exp_dict_list):
58     environment = ""
59     for s_class in exp_dict_list:
60         if "environment" in s_class:
61             environment = s_class["environment"]
62     return environment
63 def dict_merge(a, b, path=None):
64     if path is None:
65         path = []
66     for key in b:
67         if key in a:
68             if isinstance(a[key], list) and isinstance(b[key], list):
69                 if b[key][0] == "^":
70                     b[key].pop(0)
71                     a[key] = b[key]
72                 else:
73                     a[key].extend(b[key])
74             elif isinstance(a[key], dict) and isinstance(b[key], dict):
75                 dict_merge(a[key], b[key], path + [str(key)])
76             elif a[key] == b[key]:
77                 pass
78             else:
79                 a[key] = b[key]
80         else:
81             a[key] = b[key]
82     return a
83 def dict_search_and_replace(d, old, new, expanded):
84     for (k, v) in d.items():
85         if isinstance(v, dict):
86             dict_search_and_replace(d[k], old, new, expanded)
87         if isinstance(v, list):
88             x = 0
89             for i in v:
90                 if isinstance(i, dict):
91                     dict_search_and_replace(v[x], old, new, expanded)
92                 if isinstance(i, str):
93                     if i == old:
94                         v[x] = new
95                 x = x + 1
96         if v == old:
97             d[k] = new
98     return d
99 def find_value_to_expand(x, v):
100     a = x
101     for i in v[2:-1].split(":"):
102         if a is None:
103             return v
104         if i in a:
105             a = a.get(i)
106         else:
107             return v
108     return a
109 def find_and_process_re(_str, v, k, b, expanded):
110     vre = re.finditer(r"(^|.)\$\{.*?\}", _str)
111     if vre:
112         for re_v in vre:
113             re_str = str(re_v.group())
114             if re_str.startswith("\\"):
115                 v_new = _str.replace(re_str, re_str.lstrip("\\"))
116                 b = dict_search_and_replace(b, _str, v_new, expanded)
117                 expanded.append(k)
118             elif not re_str.startswith("$"):
119                 v_expanded = find_value_to_expand(b, re_str[1:])
120                 v_new = _str.replace(re_str[1:], v_expanded)
121                 b = dict_search_and_replace(b, _str, v_new, expanded)
122                 _str = v_new
123                 expanded.append(k)
124             else:
125                 v_expanded = find_value_to_expand(b, re_str)
126                 if isinstance(v, str):
127                     v_new = v.replace(re_str, v_expanded)
128                 else:
129                     v_new = _str.replace(re_str, v_expanded)
130                 b = dict_search_and_replace(b, _str, v_new, expanded)
131                 _str = v_new
132                 v = v_new
133                 expanded.append(k)
134     return b
135 def expand_variables(a, b, expanded, path=None):
136     if path is None:
137         b = a.copy()
138         path = []
139     for (k, v) in a.items():
140         if isinstance(v, dict):
141             expand_variables(v, b, expanded, path + [str(k)])
142         else:
143             if isinstance(v, list):
144                 for i in v:
145                     if isinstance(i, dict):
146                         expand_variables(i, b, expanded, path + [str(k)])
147                     if isinstance(i, str):
148                         b = find_and_process_re(i, v, k, b, expanded)
149             if isinstance(v, str):
150                 b = find_and_process_re(v, v, k, b, expanded)
151     return b
152 def match_class_glob(_class, saltclass_path):
153     straight, sub_init, sub_straight = get_class_paths(_class, saltclass_path)
154     classes = []
155     matches = []
156     matches.extend(glob.glob(straight))
157     matches.extend(glob.glob(sub_straight))
158     matches.extend(glob.glob(sub_init))
159     if not matches:
160         log.warning("%s: Class globbing did not yield any results", _class)
161     for match in matches:
162         classes.append(get_class_from_file(match, saltclass_path))
163     return classes
164 def expand_classes_glob(classes, salt_data):
165     all_classes = []
166     expanded_classes = []
167     saltclass_path = salt_data["path"]
168     for _class in classes:
169         all_classes.extend(match_class_glob(_class, saltclass_path))
170     for _class in all_classes:
171         if _class not in expanded_classes:
172             expanded_classes.append(_class)
173     return expanded_classes
174 def expand_classes_in_order(
175     minion_dict, salt_data, seen_classes, expanded_classes, classes_to_expand
176 ):
177     if not classes_to_expand and "classes" in minion_dict:
178         classes_to_expand = minion_dict["classes"]
179     classes_to_expand = expand_classes_glob(classes_to_expand, salt_data)
180     for klass in classes_to_expand:
181         if klass not in seen_classes:
182             seen_classes.append(klass)
183             expanded_classes[klass] = get_class(klass, salt_data)
184             if expanded_classes[klass] is None:
185                 expanded_classes[klass] = {}
186             new_pillars = expanded_classes[klass].get("pillars", {})
187             if new_pillars:
188                 dict_merge(salt_data["__pillar__"], new_pillars)
189             if expanded_classes[klass].get("classes"):
190                 l_id = classes_to_expand.index(klass)
191                 classes_to_expand[l_id:l_id] = expanded_classes[klass]["classes"]
192                 expand_classes_in_order(
193                     minion_dict,
194                     salt_data,
195                     seen_classes,
196                     expanded_classes,
197                     classes_to_expand,
198                 )
199             else:
200                 expand_classes_in_order(
201                     minion_dict,
202                     salt_data,
203                     seen_classes,
204                     expanded_classes,
205                     classes_to_expand,
206                 )
207     tmp = []
208     for t_element in classes_to_expand:
209         if t_element not in tmp:
210             tmp.append(t_element)
211     classes_to_expand = tmp
212     ord_expanded_classes = []
213     ord_expanded_states = []
214     for ord_klass in classes_to_expand:
215         ord_expanded_classes.append(expanded_classes[ord_klass])
216         if (
217             "states" in expanded_classes[ord_klass]
218             and expanded_classes[ord_klass]["states"] is None
219         ):
220             expanded_classes[ord_klass]["states"] = {}
221         if "states" in expanded_classes[ord_klass]:
222             ord_expanded_states.extend(expanded_classes[ord_klass]["states"])
223     if "states" in minion_dict and minion_dict["states"] is None:
224         minion_dict["states"] = []
225     if "states" in minion_dict:
226         ord_expanded_states.extend(minion_dict["states"])
227     ord_expanded_classes.append(minion_dict)
228     return ord_expanded_classes, classes_to_expand, ord_expanded_states
229 def expanded_dict_from_minion(minion_id, salt_data):
230     _file = ""
231     saltclass_path = salt_data["path"]
232     for root, dirs, files in salt.utils.path.os_walk(
233         os.path.join(saltclass_path, "nodes"), followlinks=True
234     ):
235         for minion_file in files:
236             if minion_file == "{}.yml".format(minion_id):
237                 _file = os.path.join(root, minion_file)
238     node_dict = {}
239     if _file:
240         node_dict[minion_id] = render_yaml(_file, salt_data)
241     else:
242         log.warning("%s: Node definition not found", minion_id)
243         node_dict[minion_id] = {}
244     dict_merge(salt_data["__pillar__"], node_dict[minion_id].get("pillars", {}))
245     expanded_classes, classes_list, states_list = expand_classes_in_order(
246         node_dict[minion_id], salt_data, [], {}, []
247     )
248     pillars_dict = {}
249     for exp_dict in expanded_classes:
250         if "pillars" in exp_dict:
251             dict_merge(pillars_dict, exp_dict)
252     return expanded_classes, pillars_dict, classes_list, states_list
253 def get_pillars(minion_id, salt_data):
254     (
255         expanded_classes,
256         pillars_dict,
257         classes_list,
258         states_list,
259     ) = expanded_dict_from_minion(minion_id, salt_data)
260     environment = get_env_from_dict(expanded_classes)
261     if "pillars" in pillars_dict:
262         pillars_dict_expanded = expand_variables(pillars_dict["pillars"], {}, [])
263     else:
264         pillars_dict_expanded = expand_variables({}, {}, [])
265     pillars_dict = {}
266     pillars_dict<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["__saltclass__"] = {}
267     pillars_dict["__saltclass__"]["states"] = states_list
268     pillars_dict["__saltclass__"]["classes"] = classes_list
269     pillars_dict["__saltclass__"]["environment"] = environment
270     pillars_dict[</b></font>"__saltclass__"]["nodename"] = minion_id
271     pillars_dict.update(pillars_dict_expanded)
272     return pillars_dict
273 def get_tops(minion_id, salt_data):
274     (
275         expanded_classes,
276         pillars_dict,
277         classes_list,
278         states_list,
279     ) = expanded_dict_from_minion(minion_id, salt_data)
280     environment = get_env_from_dict(expanded_classes)
281     tops_dict = {}
282     tops_dict[environment] = states_list
283     return tops_dict
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_zfs_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import salt.utils.zfs as zfs
2 from salt.utils.odict import OrderedDict
3 from tests.support.mock import MagicMock, patch
4 from tests.support.unit import TestCase
5 from tests.support.zfs import ZFSMockData
6 class ZfsUtilsTestCase(TestCase):
7         mock_data = ZFSMockData()
8         self<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.pmap_zfs = mock_data.pmap_zfs
9         self.pmap_zpool = mock_data.pmap_zpool
10         self.pmap_exec_zfs = mock_data.pmap_exec_zfs
11         self.pmap_exec_zpool = mock_data.</b></font>pmap_exec_zpool
12         for name in ("pmap_zfs", "pmap_zpool", "pmap_exec_zfs", "pmap_exec_zpool"):
13             self.addCleanup(delattr, self, name)
14     def test_is_supported(self):
15         for value in [False, True]:
16             with patch("salt.utils.path.which", MagicMock(return_value=value)):
17                 with patch(
18                     "salt.utils.platform.is_linux", MagicMock(return_value=value)
19                 ):
20                     self.assertEqual(value, zfs.is_supported())
21     def test_property_data_zpool(self):
22         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
23             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
24                 with patch.object(
25                     zfs, "_exec", MagicMock(return_value=self.pmap_exec_zpool)
26                 ):
27                     self.assertEqual(zfs.property_data_zpool(), self.pmap_zpool)
28     def test_property_data_zfs(self):
29         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
30             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
31                 with patch.object(
32                     zfs, "_exec", MagicMock(return_value=self.pmap_exec_zfs)
33                 ):
34                     self.assertEqual(zfs.property_data_zfs(), self.pmap_zfs)
35     def test_from_bool_on(self):
36         self.assertTrue(zfs.from_bool("on"))
37         self.assertTrue(zfs.from_bool(zfs.from_bool("on")))
38     def test_from_bool_off(self):
39         self.assertFalse(zfs.from_bool("off"))
40         self.assertFalse(zfs.from_bool(zfs.from_bool("off")))
41     def test_from_bool_none(self):
42         self.assertEqual(zfs.from_bool("none"), None)
43         self.assertEqual(zfs.from_bool(zfs.from_bool("none")), None)
44     def test_from_bool_passthrough(self):
45         self.assertEqual(zfs.from_bool("passthrough"), "passthrough")
46         self.assertEqual(zfs.from_bool(zfs.from_bool("passthrough")), "passthrough")
47     def test_from_bool_alt_yes(self):
48         self.assertTrue(zfs.from_bool_alt("yes"))
49         self.assertTrue(zfs.from_bool_alt(zfs.from_bool_alt("yes")))
50     def test_from_bool_alt_no(self):
51         self.assertFalse(zfs.from_bool_alt("no"))
52         self.assertFalse(zfs.from_bool_alt(zfs.from_bool_alt("no")))
53     def test_from_bool_alt_none(self):
54         self.assertEqual(zfs.from_bool_alt("none"), None)
55         self.assertEqual(zfs.from_bool_alt(zfs.from_bool_alt("none")), None)
56     def test_from_bool_alt_passthrough(self):
57         self.assertEqual(zfs.from_bool_alt("passthrough"), "passthrough")
58         self.assertEqual(
59             zfs.from_bool_alt(zfs.from_bool_alt("passthrough")), "passthrough"
60         )
61     def test_to_bool_true(self):
62         self.assertEqual(zfs.to_bool(True), "on")
63         self.assertEqual(zfs.to_bool(zfs.to_bool(True)), "on")
64     def test_to_bool_false(self):
65         self.assertEqual(zfs.to_bool(False), "off")
66         self.assertEqual(zfs.to_bool(zfs.to_bool(False)), "off")
67     def test_to_bool_none(self):
68         self.assertEqual(zfs.to_bool(None), "none")
69         self.assertEqual(zfs.to_bool(zfs.to_bool(None)), "none")
70     def test_to_bool_passthrough(self):
71         self.assertEqual(zfs.to_bool("passthrough"), "passthrough")
72         self.assertEqual(zfs.to_bool(zfs.to_bool("passthrough")), "passthrough")
73     def test_to_bool_alt_true(self):
74         self.assertEqual(zfs.to_bool_alt(True), "yes")
75         self.assertEqual(zfs.to_bool_alt(zfs.to_bool_alt(True)), "yes")
76     def test_to_bool_alt_false(self):
77         self.assertEqual(zfs.to_bool_alt(False), "no")
78         self.assertEqual(zfs.to_bool_alt(zfs.to_bool_alt(False)), "no")
79     def test_to_bool_alt_none(self):
80         self.assertEqual(zfs.to_bool_alt(None), "none")
81         self.assertEqual(zfs.to_bool_alt(zfs.to_bool_alt(None)), "none")
82     def test_to_bool_alt_passthrough(self):
83         self.assertEqual(zfs.to_bool_alt("passthrough"), "passthrough")
84         self.assertEqual(zfs.to_bool_alt(zfs.to_bool_alt("passthrough")), "passthrough")
85     def test_from_numeric_str(self):
86         self.assertEqual(zfs.from_numeric("42"), 42)
87         self.assertEqual(zfs.from_numeric(zfs.from_numeric("42")), 42)
88     def test_from_numeric_int(self):
89         self.assertEqual(zfs.from_numeric(42), 42)
90         self.assertEqual(zfs.from_numeric(zfs.from_numeric(42)), 42)
91     def test_from_numeric_none(self):
92         self.assertEqual(zfs.from_numeric("none"), None)
93         self.assertEqual(zfs.from_numeric(zfs.from_numeric("none")), None)
94     def test_from_numeric_passthrough(self):
95         self.assertEqual(zfs.from_numeric("passthrough"), "passthrough")
96         self.assertEqual(
97             zfs.from_numeric(zfs.from_numeric("passthrough")), "passthrough"
98         )
99     def test_to_numeric_str(self):
100         self.assertEqual(zfs.to_numeric("42"), 42)
101         self.assertEqual(zfs.to_numeric(zfs.to_numeric("42")), 42)
102     def test_to_numeric_int(self):
103         self.assertEqual(zfs.to_numeric(42), 42)
104         self.assertEqual(zfs.to_numeric(zfs.to_numeric(42)), 42)
105     def test_to_numeric_none(self):
106         self.assertEqual(zfs.to_numeric(None), "none")
107         self.assertEqual(zfs.to_numeric(zfs.to_numeric(None)), "none")
108     def test_to_numeric_passthrough(self):
109         self.assertEqual(zfs.to_numeric("passthrough"), "passthrough")
110         self.assertEqual(zfs.to_numeric(zfs.to_numeric("passthrough")), "passthrough")
111     def test_from_size_absolute(self):
112         self.assertEqual(zfs.from_size("5G"), 5368709120)
113         self.assertEqual(zfs.from_size(zfs.from_size("5G")), 5368709120)
114     def test_from_size_decimal(self):
115         self.assertEqual(zfs.from_size("4.20M"), 4404019)
116         self.assertEqual(zfs.from_size(zfs.from_size("4.20M")), 4404019)
117     def test_from_size_none(self):
118         self.assertEqual(zfs.from_size("none"), None)
119         self.assertEqual(zfs.from_size(zfs.from_size("none")), None)
120     def test_from_size_passthrough(self):
121         self.assertEqual(zfs.from_size("passthrough"), "passthrough")
122         self.assertEqual(zfs.from_size(zfs.from_size("passthrough")), "passthrough")
123     def test_to_size_str_absolute(self):
124         self.assertEqual(zfs.to_size("5368709120"), "5G")
125         self.assertEqual(zfs.to_size(zfs.to_size("5368709120")), "5G")
126     def test_to_size_str_decimal(self):
127         self.assertEqual(zfs.to_size("4404019"), "4.20M")
128         self.assertEqual(zfs.to_size(zfs.to_size("4404019")), "4.20M")
129     def test_to_size_int_absolute(self):
130         self.assertEqual(zfs.to_size(5368709120), "5G")
131         self.assertEqual(zfs.to_size(zfs.to_size(5368709120)), "5G")
132     def test_to_size_int_decimal(self):
133         self.assertEqual(zfs.to_size(4404019), "4.20M")
134         self.assertEqual(zfs.to_size(zfs.to_size(4404019)), "4.20M")
135     def test_to_size_none(self):
136         self.assertEqual(zfs.to_size(None), "none")
137         self.assertEqual(zfs.to_size(zfs.to_size(None)), "none")
138     def test_to_size_passthrough(self):
139         self.assertEqual(zfs.to_size("passthrough"), "passthrough")
140         self.assertEqual(zfs.to_size(zfs.to_size("passthrough")), "passthrough")
141     def test_from_str_space(self):
142         self.assertEqual(zfs.from_str('"my pool/my dataset"'), "my pool/my dataset")
143         self.assertEqual(
144             zfs.from_str(zfs.from_str('"my pool/my dataset"')), "my pool/my dataset"
145         )
146     def test_from_str_squote_space(self):
147         self.assertEqual(
148             zfs.from_str("my pool/jorge's dataset"), "my pool/jorge's dataset"
149         )
150         self.assertEqual(
151             zfs.from_str(zfs.from_str("my pool/jorge's dataset")),
152             "my pool/jorge's dataset",
153         )
154     def test_from_str_dquote_space(self):
155         self.assertEqual(
156             zfs.from_str('my pool/the "good" stuff'), 'my pool/the "good" stuff'
157         )
158         self.assertEqual(
159             zfs.from_str(zfs.from_str('my pool/the "good" stuff')),
160             'my pool/the "good" stuff',
161         )
162     def test_from_str_none(self):
163         self.assertEqual(zfs.from_str("none"), None)
164         self.assertEqual(zfs.from_str(zfs.from_str("none")), None)
165     def test_from_str_passthrough(self):
166         self.assertEqual(zfs.from_str("passthrough"), "passthrough")
167         self.assertEqual(zfs.from_str(zfs.from_str("passthrough")), "passthrough")
168     def test_to_str_space(self):
169         self.assertEqual(zfs.to_str("my pool/my dataset"), '"my pool/my dataset"')
170         self.assertEqual(
171             zfs.to_str(zfs.to_str("my pool/my dataset")), '"my pool/my dataset"'
172         )
173     def test_to_str_squote_space(self):
174         self.assertEqual(
175             zfs.to_str("my pool/jorge's dataset"), '"my pool/jorge\'s dataset"'
176         )
177         self.assertEqual(
178             zfs.to_str(zfs.to_str("my pool/jorge's dataset")),
179             '"my pool/jorge\'s dataset"',
180         )
181     def test_to_str_none(self):
182         self.assertEqual(zfs.to_str(None), "none")
183         self.assertEqual(zfs.to_str(zfs.to_str(None)), "none")
184     def test_to_str_passthrough(self):
185         self.assertEqual(zfs.to_str("passthrough"), "passthrough")
186         self.assertEqual(zfs.to_str(zfs.to_str("passthrough")), "passthrough")
187     def test_is_snapshot_snapshot(self):
188         self.assertTrue(zfs.is_snapshot("zpool_name/dataset@backup"))
189     def test_is_snapshot_bookmark(self):
190         self.assertFalse(zfs.is_snapshot("zpool_name/dataset#backup"))
191     def test_is_snapshot_filesystem(self):
192         self.assertFalse(zfs.is_snapshot("zpool_name/dataset"))
193     def test_is_bookmark_snapshot(self):
194         self.assertFalse(zfs.is_bookmark("zpool_name/dataset@backup"))
195     def test_is_bookmark_bookmark(self):
196         self.assertTrue(zfs.is_bookmark("zpool_name/dataset#backup"))
197     def test_is_bookmark_filesystem(self):
198         self.assertFalse(zfs.is_bookmark("zpool_name/dataset"))
199     def test_is_dataset_snapshot(self):
200         self.assertFalse(zfs.is_dataset("zpool_name/dataset@backup"))
201     def test_is_dataset_bookmark(self):
202         self.assertFalse(zfs.is_dataset("zpool_name/dataset#backup"))
203     def test_is_dataset_filesystem(self):
204         self.assertTrue(zfs.is_dataset("zpool_name/dataset"))
205     def test_zfs_command_simple(self):
206         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
207             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
208                 with patch.object(
209                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
210                 ):
211                     with patch.object(
212                         zfs,
213                         "property_data_zpool",
214                         MagicMock(return_value=self.pmap_zpool),
215                     ):
216                         self.assertEqual(zfs.zfs_command("list"), "/sbin/zfs list")
217     def test_zfs_command_none_target(self):
218         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
219             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
220                 with patch.object(
221                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
222                 ):
223                     with patch.object(
224                         zfs,
225                         "property_data_zpool",
226                         MagicMock(return_value=self.pmap_zpool),
227                     ):
228                         self.assertEqual(
229                             zfs.zfs_command("list", target=[None, "mypool", None]),
230                             "/sbin/zfs list mypool",
231                         )
232     def test_zfs_command_flag(self):
233         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
234             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
235                 with patch.object(
236                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
237                 ):
238                     with patch.object(
239                         zfs,
240                         "property_data_zpool",
241                         MagicMock(return_value=self.pmap_zpool),
242                     ):
243                         my_flags = [
244                             "-r",  # recursive
245                         ]
246                         self.assertEqual(
247                             zfs.zfs_command("list", flags=my_flags), "/sbin/zfs list -r"
248                         )
249     def test_zfs_command_opt(self):
250         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
251             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
252                 with patch.object(
253                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
254                 ):
255                     with patch.object(
256                         zfs,
257                         "property_data_zpool",
258                         MagicMock(return_value=self.pmap_zpool),
259                     ):
260                         my_opts = {
261                             "-t": "snap",  # only list snapshots
262                         }
263                         self.assertEqual(
264                             zfs.zfs_command("list", opts=my_opts),
265                             "/sbin/zfs list -t snap",
266                         )
267     def test_zfs_command_flag_opt(self):
268         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
269             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
270                 with patch.object(
271                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
272                 ):
273                     with patch.object(
274                         zfs,
275                         "property_data_zpool",
276                         MagicMock(return_value=self.pmap_zpool),
277                     ):
278                         my_flags = [
279                             "-r",  # recursive
280                         ]
281                         my_opts = {
282                             "-t": "snap",  # only list snapshots
283                         }
284                         self.assertEqual(
285                             zfs.zfs_command("list", flags=my_flags, opts=my_opts),
286                             "/sbin/zfs list -r -t snap",
287                         )
288     def test_zfs_command_target(self):
289         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
290             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
291                 with patch.object(
292                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
293                 ):
294                     with patch.object(
295                         zfs,
296                         "property_data_zpool",
297                         MagicMock(return_value=self.pmap_zpool),
298                     ):
299                         my_flags = [
300                             "-r",  # recursive
301                         ]
302                         my_opts = {
303                             "-t": "snap",  # only list snapshots
304                         }
305                         self.assertEqual(
306                             zfs.zfs_command(
307                                 "list", flags=my_flags, opts=my_opts, target="mypool"
308                             ),
309                             "/sbin/zfs list -r -t snap mypool",
310                         )
311     def test_zfs_command_target_with_space(self):
312         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
313             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
314                 with patch.object(
315                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
316                 ):
317                     with patch.object(
318                         zfs,
319                         "property_data_zpool",
320                         MagicMock(return_value=self.pmap_zpool),
321                     ):
322                         my_flags = [
323                             "-r",  # recursive
324                         ]
325                         my_opts = {
326                             "-t": "snap",  # only list snapshots
327                         }
328                         self.assertEqual(
329                             zfs.zfs_command(
330                                 "list", flags=my_flags, opts=my_opts, target="my pool"
331                             ),
332                             '/sbin/zfs list -r -t snap "my pool"',
333                         )
334     def test_zfs_command_property(self):
335         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
336             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
337                 with patch.object(
338                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
339                 ):
340                     with patch.object(
341                         zfs,
342                         "property_data_zpool",
343                         MagicMock(return_value=self.pmap_zpool),
344                     ):
345                         self.assertEqual(
346                             zfs.zfs_command(
347                                 "get", property_name="quota", target="mypool"
348                             ),
349                             "/sbin/zfs get quota mypool",
350                         )
351     def test_zfs_command_property_value(self):
352         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
353             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
354                 with patch.object(
355                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
356                 ):
357                     with patch.object(
358                         zfs,
359                         "property_data_zpool",
360                         MagicMock(return_value=self.pmap_zpool),
361                     ):
362                         my_flags = [
363                             "-r",  # recursive
364                         ]
365                         self.assertEqual(
366                             zfs.zfs_command(
367                                 "set",
368                                 flags=my_flags,
369                                 property_name="quota",
370                                 property_value="5G",
371                                 target="mypool",
372                             ),
373                             "/sbin/zfs set -r quota=5368709120 mypool",
374                         )
375     def test_zfs_command_multi_property_value(self):
376         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
377             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
378                 with patch.object(
379                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
380                 ):
381                     with patch.object(
382                         zfs,
383                         "property_data_zpool",
384                         MagicMock(return_value=self.pmap_zpool),
385                     ):
386                         property_name = ["quota", "readonly"]
387                         property_value = ["5G", "no"]
388                         self.assertEqual(
389                             zfs.zfs_command(
390                                 "set",
391                                 property_name=property_name,
392                                 property_value=property_value,
393                                 target="mypool",
394                             ),
395                             "/sbin/zfs set quota=5368709120 readonly=off mypool",
396                         )
397     def test_zfs_command_fs_props(self):
398         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
399             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
400                 with patch.object(
401                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
402                 ):
403                     with patch.object(
404                         zfs,
405                         "property_data_zpool",
406                         MagicMock(return_value=self.pmap_zpool),
407                     ):
408                         my_flags = [
409                             "-p",  # create parent
410                         ]
411                         my_props = {
412                             "quota": "1G",
413                             "compression": "lz4",
414                         }
415                         self.assertEqual(
416                             zfs.zfs_command(
417                                 "create",
418                                 flags=my_flags,
419                                 filesystem_properties=my_props,
420                                 target="mypool/dataset",
421                             ),
422                             "/sbin/zfs create -p -o compression=lz4 -o quota=1073741824"
423                             " mypool/dataset",
424                         )
425     def test_zfs_command_fs_props_with_space(self):
426         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
427             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
428                 with patch.object(
429                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
430                 ):
431                     with patch.object(
432                         zfs,
433                         "property_data_zpool",
434                         MagicMock(return_value=self.pmap_zpool),
435                     ):
436                         my_props = {
437                             "quota": "4.2M",
438                             "compression": "lz4",
439                         }
440                         self.assertEqual(
441                             zfs.zfs_command(
442                                 "create",
443                                 filesystem_properties=my_props,
444                                 target="my pool/jorge's dataset",
445                             ),
446                             '/sbin/zfs create -o compression=lz4 -o quota=4404019 "my'
447                             " pool/jorge's dataset\"",
448                         )
449     def test_zpool_command_simple(self):
450         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
451             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
452                 with patch.object(
453                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
454                 ):
455                     with patch.object(
456                         zfs,
457                         "property_data_zpool",
458                         MagicMock(return_value=self.pmap_zpool),
459                     ):
460                         self.assertEqual(zfs.zpool_command("list"), "/sbin/zpool list")
461     def test_zpool_command_opt(self):
462         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
463             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
464                 with patch.object(
465                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
466                 ):
467                     with patch.object(
468                         zfs,
469                         "property_data_zpool",
470                         MagicMock(return_value=self.pmap_zpool),
471                     ):
472                         my_opts = {
473                             "-o": "name,size",  # show only name and size
474                         }
475                         self.assertEqual(
476                             zfs.zpool_command("list", opts=my_opts),
477                             "/sbin/zpool list -o name,size",
478                         )
479     def test_zpool_command_opt_list(self):
480         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
481             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
482                 with patch.object(
483                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
484                 ):
485                     with patch.object(
486                         zfs,
487                         "property_data_zpool",
488                         MagicMock(return_value=self.pmap_zpool),
489                     ):
490                         my_opts = {
491                             "-d": ["/tmp", "/zvol"],
492                         }
493                         self.assertEqual(
494                             zfs.zpool_command("import", opts=my_opts, target="mypool"),
495                             "/sbin/zpool import -d /tmp -d /zvol mypool",
496                         )
497     def test_zpool_command_flag_opt(self):
498         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
499             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
500                 with patch.object(
501                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
502                 ):
503                     with patch.object(
504                         zfs,
505                         "property_data_zpool",
506                         MagicMock(return_value=self.pmap_zpool),
507                     ):
508                         my_opts = {
509                             "-o": "name,size",  # show only name and size
510                         }
511                         self.assertEqual(
512                             zfs.zpool_command("list", opts=my_opts),
513                             "/sbin/zpool list -o name,size",
514                         )
515     def test_zpool_command_target(self):
516         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
517             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
518                 with patch.object(
519                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
520                 ):
521                     with patch.object(
522                         zfs,
523                         "property_data_zpool",
524                         MagicMock(return_value=self.pmap_zpool),
525                     ):
526                         my_opts = {
527                             "-o": "name,size",  # show only name and size
528                         }
529                         self.assertEqual(
530                             zfs.zpool_command("list", opts=my_opts, target="mypool"),
531                             "/sbin/zpool list -o name,size mypool",
532                         )
533     def test_zpool_command_target_with_space(self):
534         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
535             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
536                 with patch.object(
537                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
538                 ):
539                     with patch.object(
540                         zfs,
541                         "property_data_zpool",
542                         MagicMock(return_value=self.pmap_zpool),
543                     ):
544                         fs_props = {
545                             "quota": "100G",
546                         }
547                         pool_props = {
548                             "comment": "jorge's comment has a space",
549                         }
550                         self.assertEqual(
551                             zfs.zpool_command(
552                                 "create",
553                                 pool_properties=pool_props,
554                                 filesystem_properties=fs_props,
555                                 target="my pool",
556                             ),
557                             "/sbin/zpool create -O quota=107374182400 -o"
558                             ' comment="jorge\'s comment has a space" "my pool"',
559                         )
560     def test_zpool_command_property(self):
561         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
562             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
563                 with patch.object(
564                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
565                 ):
566                     with patch.object(
567                         zfs,
568                         "property_data_zpool",
569                         MagicMock(return_value=self.pmap_zpool),
570                     ):
571                         self.assertEqual(
572                             zfs.zpool_command(
573                                 "get", property_name="comment", target="mypool"
574                             ),
575                             "/sbin/zpool get comment mypool",
576                         )
577     def test_zpool_command_property_value(self):
578         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
579             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
580                 with patch.object(
581                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
582                 ):
583                     with patch.object(
584                         zfs,
585                         "property_data_zpool",
586                         MagicMock(return_value=self.pmap_zpool),
587                     ):
588                         my_flags = [
589                             "-v",  # verbose
590                         ]
591                         self.assertEqual(
592                             zfs.zpool_command(
593                                 "iostat", flags=my_flags, target=["mypool", 60, 1]
594                             ),
595                             "/sbin/zpool iostat -v mypool 60 1",
596                         )
597     def test_parse_command_result_success(self):
598         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
599             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
600                 with patch.object(
601                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
602                 ):
603                     with patch.object(
604                         zfs,
605                         "property_data_zpool",
606                         MagicMock(return_value=self.pmap_zpool),
607                     ):
608                         res = {}
609                         res["retcode"] = 0
610                         res["stderr"] = ""
611                         res["stdout"] = ""
612                         self.assertEqual(
613                             zfs.parse_command_result(res, "tested"),
614                             OrderedDict([("tested", True)]),
615                         )
616     def test_parse_command_result_success_nolabel(self):
617         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
618             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
619                 with patch.object(
620                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
621                 ):
622                     with patch.object(
623                         zfs,
624                         "property_data_zpool",
625                         MagicMock(return_value=self.pmap_zpool),
626                     ):
627                         res = {}
628                         res["retcode"] = 0
629                         res["stderr"] = ""
630                         res["stdout"] = ""
631                         self.assertEqual(
632                             zfs.parse_command_result(res),
633                             OrderedDict(),
634                         )
635     def test_parse_command_result_fail(self):
636         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
637             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
638                 with patch.object(
639                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
640                 ):
641                     with patch.object(
642                         zfs,
643                         "property_data_zpool",
644                         MagicMock(return_value=self.pmap_zpool),
645                     ):
646                         res = {}
647                         res["retcode"] = 1
648                         res["stderr"] = ""
649                         res["stdout"] = ""
650                         self.assertEqual(
651                             zfs.parse_command_result(res, "tested"),
652                             OrderedDict([("tested", False)]),
653                         )
654     def test_parse_command_result_nolabel(self):
655         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
656             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
657                 with patch.object(
658                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
659                 ):
660                     with patch.object(
661                         zfs,
662                         "property_data_zpool",
663                         MagicMock(return_value=self.pmap_zpool),
664                     ):
665                         res = {}
666                         res["retcode"] = 1
667                         res["stderr"] = ""
668                         res["stdout"] = ""
669                         self.assertEqual(
670                             zfs.parse_command_result(res),
671                             OrderedDict(),
672                         )
673     def test_parse_command_result_fail_message(self):
674         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
675             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
676                 with patch.object(
677                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
678                 ):
679                     with patch.object(
680                         zfs,
681                         "property_data_zpool",
682                         MagicMock(return_value=self.pmap_zpool),
683                     ):
684                         res = {}
685                         res["retcode"] = 1
686                         res["stderr"] = "\n".join(
687                             ["ice is not hot", "usage:", "this should not be printed"]
688                         )
689                         res["stdout"] = ""
690                         self.assertEqual(
691                             zfs.parse_command_result(res, "tested"),
692                             OrderedDict(
693                                 [("tested", False), ("error", "ice is not hot")]
694                             ),
695                         )
696     def test_parse_command_result_fail_message_nolabel(self):
697         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
698             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
699                 with patch.object(
700                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
701                 ):
702                     with patch.object(
703                         zfs,
704                         "property_data_zpool",
705                         MagicMock(return_value=self.pmap_zpool),
706                     ):
707                         res = {}
708                         res["retcode"] = 1
709                         res["stderr"] = "\n".join(
710                             ["ice is not hot", "usage:", "this should not be printed"]
711                         )
712                         res["stdout"] = ""
713                         self.assertEqual(
714                             zfs.parse_command_result(res),
715                             OrderedDict([("error", "ice is not hot")]),
716                         )
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
