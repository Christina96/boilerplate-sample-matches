<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for saltclass_2.py &amp; test_zfs_1.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for saltclass_2.py &amp; test_zfs_1.py
      </h3>
<h1 align="center">
        1.0%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>saltclass_2.py (2.1164021%)<th>test_zfs_1.py (0.72859746%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(422-426)<td><a href="#" name="0">(28-31)</a><td align="center"><font color="#ff0000">12</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>saltclass_2.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import glob
2 import logging
3 import os
4 import re
5 import salt.utils.path
6 import salt.utils.yaml
7 from jinja2 import Environment, FileSystemLoader
8 log = logging.getLogger(__name__)
9 def render_jinja(_file, salt_data):
10     j_env = Environment(loader=FileSystemLoader(os.path.dirname(_file)))
11     j_env.globals.update(
12         {
13             "__opts__": salt_data["__opts__"],
14             "__salt__": salt_data["__salt__"],
15             "__grains__": salt_data["__grains__"],
16             "__pillar__": salt_data["__pillar__"],
17             "minion_id": salt_data["minion_id"],
18         }
19     )
20     j_render = j_env.get_template(os.path.basename(_file)).render()
21     return j_render
22 def render_yaml(_file, salt_data):
23     return salt.utils.yaml.safe_load(render_jinja(_file, salt_data))
24 def get_class(_class, salt_data):
25     l_files = []
26     saltclass_path = salt_data["path"]
27     straight, sub_init, sub_straight = get_class_paths(_class, saltclass_path)
28     for root, dirs, files in salt.utils.path.os_walk(
29         os.path.join(saltclass_path, "classes"), followlinks=True
30     ):
31         for l_file in files:
32             l_files.append(os.path.join(root, l_file))
33     if straight in l_files:
34         return render_yaml(straight, salt_data)
35     if sub_straight in l_files:
36         return render_yaml(sub_straight, salt_data)
37     if sub_init in l_files:
38         return render_yaml(sub_init, salt_data)
39     log.warning("%s: Class definition not found", _class)
40     return {}
41 def get_class_paths(_class, saltclass_path):
42     straight = os.path.join(saltclass_path, "classes", "{}.yml".format(_class))
43     sub_straight = os.path.join(
44         saltclass_path, "classes", "{}.yml".format(_class.replace(".", os.sep))
45     )
46     sub_init = os.path.join(
47         saltclass_path, "classes", _class.replace(".", os.sep), "init.yml"
48     )
49     return straight, sub_init, sub_straight
50 def get_class_from_file(_file, saltclass_path):
51     _file = _file[len(os.path.join(saltclass_path, "classes")) + len(os.sep) :]
52     _file = _file[:-4]
53     _file = _file.replace(os.sep, ".")
54     if _file.endswith(".init"):
55         _file = _file[:-5]
56     return _file
57 def get_env_from_dict(exp_dict_list):
58     environment = ""
59     for s_class in exp_dict_list:
60         if "environment" in s_class:
61             environment = s_class["environment"]
62     return environment
63 def dict_merge(a, b, path=None):
64     if path is None:
65         path = []
66     for key in b:
67         if key in a:
68             if isinstance(a[key], list) and isinstance(b[key], list):
69                 if b[key][0] == "^":
70                     b[key].pop(0)
71                     a[key] = b[key]
72                 else:
73                     a[key].extend(b[key])
74             elif isinstance(a[key], dict) and isinstance(b[key], dict):
75                 dict_merge(a[key], b[key], path + [str(key)])
76             elif a[key] == b[key]:
77                 pass
78             else:
79                 a[key] = b[key]
80         else:
81             a[key] = b[key]
82     return a
83 def dict_search_and_replace(d, old, new, expanded):
84     for (k, v) in d.items():
85         if isinstance(v, dict):
86             dict_search_and_replace(d[k], old, new, expanded)
87         if isinstance(v, list):
88             x = 0
89             for i in v:
90                 if isinstance(i, dict):
91                     dict_search_and_replace(v[x], old, new, expanded)
92                 if isinstance(i, str):
93                     if i == old:
94                         v[x] = new
95                 x = x + 1
96         if v == old:
97             d[k] = new
98     return d
99 def find_value_to_expand(x, v):
100     a = x
101     for i in v[2:-1].split(":"):
102         if a is None:
103             return v
104         if i in a:
105             a = a.get(i)
106         else:
107             return v
108     return a
109 def find_and_process_re(_str, v, k, b, expanded):
110     vre = re.finditer(r"(^|.)\$\{.*?\}", _str)
111     if vre:
112         for re_v in vre:
113             re_str = str(re_v.group())
114             if re_str.startswith("\\"):
115                 v_new = _str.replace(re_str, re_str.lstrip("\\"))
116                 b = dict_search_and_replace(b, _str, v_new, expanded)
117                 expanded.append(k)
118             elif not re_str.startswith("$"):
119                 v_expanded = find_value_to_expand(b, re_str[1:])
120                 v_new = _str.replace(re_str[1:], v_expanded)
121                 b = dict_search_and_replace(b, _str, v_new, expanded)
122                 _str = v_new
123                 expanded.append(k)
124             else:
125                 v_expanded = find_value_to_expand(b, re_str)
126                 if isinstance(v, str):
127                     v_new = v.replace(re_str, v_expanded)
128                 else:
129                     v_new = _str.replace(re_str, v_expanded)
130                 b = dict_search_and_replace(b, _str, v_new, expanded)
131                 _str = v_new
132                 v = v_new
133                 expanded.append(k)
134     return b
135 def expand_variables(a, b, expanded, path=None):
136     if path is None:
137         b = a.copy()
138         path = []
139     for (k, v) in a.items():
140         if isinstance(v, dict):
141             expand_variables(v, b, expanded, path + [str(k)])
142         else:
143             if isinstance(v, list):
144                 for i in v:
145                     if isinstance(i, dict):
146                         expand_variables(i, b, expanded, path + [str(k)])
147                     if isinstance(i, str):
148                         b = find_and_process_re(i, v, k, b, expanded)
149             if isinstance(v, str):
150                 b = find_and_process_re(v, v, k, b, expanded)
151     return b
152 def match_class_glob(_class, saltclass_path):
153     straight, sub_init, sub_straight = get_class_paths(_class, saltclass_path)
154     classes = []
155     matches = []
156     matches.extend(glob.glob(straight))
157     matches.extend(glob.glob(sub_straight))
158     matches.extend(glob.glob(sub_init))
159     if not matches:
160         log.warning("%s: Class globbing did not yield any results", _class)
161     for match in matches:
162         classes.append(get_class_from_file(match, saltclass_path))
163     return classes
164 def expand_classes_glob(classes, salt_data):
165     all_classes = []
166     expanded_classes = []
167     saltclass_path = salt_data["path"]
168     for _class in classes:
169         all_classes.extend(match_class_glob(_class, saltclass_path))
170     for _class in all_classes:
171         if _class not in expanded_classes:
172             expanded_classes.append(_class)
173     return expanded_classes
174 def expand_classes_in_order(
175     minion_dict, salt_data, seen_classes, expanded_classes, classes_to_expand
176 ):
177     if not classes_to_expand and "classes" in minion_dict:
178         classes_to_expand = minion_dict["classes"]
179     classes_to_expand = expand_classes_glob(classes_to_expand, salt_data)
180     for klass in classes_to_expand:
181         if klass not in seen_classes:
182             seen_classes.append(klass)
183             expanded_classes[klass] = get_class(klass, salt_data)
184             if expanded_classes[klass] is None:
185                 expanded_classes[klass] = {}
186             new_pillars = expanded_classes[klass].get("pillars", {})
187             if new_pillars:
188                 dict_merge(salt_data["__pillar__"], new_pillars)
189             if expanded_classes[klass].get("classes"):
190                 l_id = classes_to_expand.index(klass)
191                 classes_to_expand[l_id:l_id] = expanded_classes[klass]["classes"]
192                 expand_classes_in_order(
193                     minion_dict,
194                     salt_data,
195                     seen_classes,
196                     expanded_classes,
197                     classes_to_expand,
198                 )
199             else:
200                 expand_classes_in_order(
201                     minion_dict,
202                     salt_data,
203                     seen_classes,
204                     expanded_classes,
205                     classes_to_expand,
206                 )
207     tmp = []
208     for t_element in classes_to_expand:
209         if t_element not in tmp:
210             tmp.append(t_element)
211     classes_to_expand = tmp
212     ord_expanded_classes = []
213     ord_expanded_states = []
214     for ord_klass in classes_to_expand:
215         ord_expanded_classes.append(expanded_classes[ord_klass])
216         if (
217             "states" in expanded_classes[ord_klass]
218             and expanded_classes[ord_klass]["states"] is None
219         ):
220             expanded_classes[ord_klass]["states"] = {}
221         if "states" in expanded_classes[ord_klass]:
222             ord_expanded_states.extend(expanded_classes[ord_klass]["states"])
223     if "states" in minion_dict and minion_dict["states"] is None:
224         minion_dict["states"] = []
225     if "states" in minion_dict:
226         ord_expanded_states.extend(minion_dict["states"])
227     ord_expanded_classes.append(minion_dict)
228     return ord_expanded_classes, classes_to_expand, ord_expanded_states
229 def expanded_dict_from_minion(minion_id, salt_data):
230     _file = ""
231     saltclass_path = salt_data["path"]
232     for root, dirs, files in salt.utils.path.os_walk(
233         os.path.join(saltclass_path, "nodes"), followlinks=True
234     ):
235         for minion_file in files:
236             if minion_file == "{}.yml".format(minion_id):
237                 _file = os.path.join(root, minion_file)
238     node_dict = {}
239     if _file:
240         node_dict[minion_id] = render_yaml(_file, salt_data)
241     else:
242         log.warning("%s: Node definition not found", minion_id)
243         node_dict[minion_id] = {}
244     dict_merge(salt_data["__pillar__"], node_dict[minion_id].get("pillars", {}))
245     expanded_classes, classes_list, states_list = expand_classes_in_order(
246         node_dict[minion_id], salt_data, [], {}, []
247     )
248     pillars_dict = {}
249     for exp_dict in expanded_classes:
250         if "pillars" in exp_dict:
251             dict_merge(pillars_dict, exp_dict)
252     return expanded_classes, pillars_dict, classes_list, states_list
253 def get_pillars(minion_id, salt_data):
254     (
255         expanded_classes,
256         pillars_dict,
257         classes_list,
258         states_list,
259     ) = expanded_dict_from_minion(minion_id, salt_data)
260     environment = get_env_from_dict(expanded_classes)
261     if "pillars" in pillars_dict:
262         pillars_dict_expanded = expand_variables(pillars_dict["pillars"], {}, [])
263     else:
264         pillars_dict_expanded = expand_variables({}, {}, [])
265 <a name="0"></a>
266     pillars_dict = {}
267     pillars_dict<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["__saltclass__"] = {}
268     pillars_dict["__saltclass__"]["states"] = states_list
269     pillars_dict["__saltclass__"]["classes"] = classes_list
270     pillars_dict["__saltclass__"]["environment"] = environment
271     pillars_dict[</b></font>"__saltclass__"]["nodename"] = minion_id
272     pillars_dict.update(pillars_dict_expanded)
273     return pillars_dict
274 def get_tops(minion_id, salt_data):
275     (
276         expanded_classes,
277         pillars_dict,
278         classes_list,
279         states_list,
280     ) = expanded_dict_from_minion(minion_id, salt_data)
281     environment = get_env_from_dict(expanded_classes)
282     tops_dict = {}
283     tops_dict[environment] = states_list
284     return tops_dict
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_zfs_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import salt.utils.zfs as zfs
2 from salt.utils.odict import OrderedDict
3 from tests.support.mock import MagicMock, patch
4 from tests.support.unit import TestCase
5 from tests.support.zfs import ZFSMockData
6 class ZfsUtilsTestCase(TestCase):
7 <a name="0"></a>    def setUp(self):
8         mock_data = ZFSMockData()
9         self<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.pmap_zfs = mock_data.pmap_zfs
10         self.pmap_zpool = mock_data.pmap_zpool
11         self.pmap_exec_zfs = mock_data.pmap_exec_zfs
12         self.pmap_exec_zpool = mock_data.</b></font>pmap_exec_zpool
13         for name in ("pmap_zfs", "pmap_zpool", "pmap_exec_zfs", "pmap_exec_zpool"):
14             self.addCleanup(delattr, self, name)
15     def test_is_supported(self):
16         for value in [False, True]:
17             with patch("salt.utils.path.which", MagicMock(return_value=value)):
18                 with patch(
19                     "salt.utils.platform.is_linux", MagicMock(return_value=value)
20                 ):
21                     self.assertEqual(value, zfs.is_supported())
22     def test_property_data_zpool(self):
23         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
24             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
25                 with patch.object(
26                     zfs, "_exec", MagicMock(return_value=self.pmap_exec_zpool)
27                 ):
28                     self.assertEqual(zfs.property_data_zpool(), self.pmap_zpool)
29     def test_property_data_zfs(self):
30         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
31             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
32                 with patch.object(
33                     zfs, "_exec", MagicMock(return_value=self.pmap_exec_zfs)
34                 ):
35                     self.assertEqual(zfs.property_data_zfs(), self.pmap_zfs)
36     def test_from_bool_on(self):
37         self.assertTrue(zfs.from_bool("on"))
38         self.assertTrue(zfs.from_bool(zfs.from_bool("on")))
39     def test_from_bool_off(self):
40         self.assertFalse(zfs.from_bool("off"))
41         self.assertFalse(zfs.from_bool(zfs.from_bool("off")))
42     def test_from_bool_none(self):
43         self.assertEqual(zfs.from_bool("none"), None)
44         self.assertEqual(zfs.from_bool(zfs.from_bool("none")), None)
45     def test_from_bool_passthrough(self):
46         self.assertEqual(zfs.from_bool("passthrough"), "passthrough")
47         self.assertEqual(zfs.from_bool(zfs.from_bool("passthrough")), "passthrough")
48     def test_from_bool_alt_yes(self):
49         self.assertTrue(zfs.from_bool_alt("yes"))
50         self.assertTrue(zfs.from_bool_alt(zfs.from_bool_alt("yes")))
51     def test_from_bool_alt_no(self):
52         self.assertFalse(zfs.from_bool_alt("no"))
53         self.assertFalse(zfs.from_bool_alt(zfs.from_bool_alt("no")))
54     def test_from_bool_alt_none(self):
55         self.assertEqual(zfs.from_bool_alt("none"), None)
56         self.assertEqual(zfs.from_bool_alt(zfs.from_bool_alt("none")), None)
57     def test_from_bool_alt_passthrough(self):
58         self.assertEqual(zfs.from_bool_alt("passthrough"), "passthrough")
59         self.assertEqual(
60             zfs.from_bool_alt(zfs.from_bool_alt("passthrough")), "passthrough"
61         )
62     def test_to_bool_true(self):
63         self.assertEqual(zfs.to_bool(True), "on")
64         self.assertEqual(zfs.to_bool(zfs.to_bool(True)), "on")
65     def test_to_bool_false(self):
66         self.assertEqual(zfs.to_bool(False), "off")
67         self.assertEqual(zfs.to_bool(zfs.to_bool(False)), "off")
68     def test_to_bool_none(self):
69         self.assertEqual(zfs.to_bool(None), "none")
70         self.assertEqual(zfs.to_bool(zfs.to_bool(None)), "none")
71     def test_to_bool_passthrough(self):
72         self.assertEqual(zfs.to_bool("passthrough"), "passthrough")
73         self.assertEqual(zfs.to_bool(zfs.to_bool("passthrough")), "passthrough")
74     def test_to_bool_alt_true(self):
75         self.assertEqual(zfs.to_bool_alt(True), "yes")
76         self.assertEqual(zfs.to_bool_alt(zfs.to_bool_alt(True)), "yes")
77     def test_to_bool_alt_false(self):
78         self.assertEqual(zfs.to_bool_alt(False), "no")
79         self.assertEqual(zfs.to_bool_alt(zfs.to_bool_alt(False)), "no")
80     def test_to_bool_alt_none(self):
81         self.assertEqual(zfs.to_bool_alt(None), "none")
82         self.assertEqual(zfs.to_bool_alt(zfs.to_bool_alt(None)), "none")
83     def test_to_bool_alt_passthrough(self):
84         self.assertEqual(zfs.to_bool_alt("passthrough"), "passthrough")
85         self.assertEqual(zfs.to_bool_alt(zfs.to_bool_alt("passthrough")), "passthrough")
86     def test_from_numeric_str(self):
87         self.assertEqual(zfs.from_numeric("42"), 42)
88         self.assertEqual(zfs.from_numeric(zfs.from_numeric("42")), 42)
89     def test_from_numeric_int(self):
90         self.assertEqual(zfs.from_numeric(42), 42)
91         self.assertEqual(zfs.from_numeric(zfs.from_numeric(42)), 42)
92     def test_from_numeric_none(self):
93         self.assertEqual(zfs.from_numeric("none"), None)
94         self.assertEqual(zfs.from_numeric(zfs.from_numeric("none")), None)
95     def test_from_numeric_passthrough(self):
96         self.assertEqual(zfs.from_numeric("passthrough"), "passthrough")
97         self.assertEqual(
98             zfs.from_numeric(zfs.from_numeric("passthrough")), "passthrough"
99         )
100     def test_to_numeric_str(self):
101         self.assertEqual(zfs.to_numeric("42"), 42)
102         self.assertEqual(zfs.to_numeric(zfs.to_numeric("42")), 42)
103     def test_to_numeric_int(self):
104         self.assertEqual(zfs.to_numeric(42), 42)
105         self.assertEqual(zfs.to_numeric(zfs.to_numeric(42)), 42)
106     def test_to_numeric_none(self):
107         self.assertEqual(zfs.to_numeric(None), "none")
108         self.assertEqual(zfs.to_numeric(zfs.to_numeric(None)), "none")
109     def test_to_numeric_passthrough(self):
110         self.assertEqual(zfs.to_numeric("passthrough"), "passthrough")
111         self.assertEqual(zfs.to_numeric(zfs.to_numeric("passthrough")), "passthrough")
112     def test_from_size_absolute(self):
113         self.assertEqual(zfs.from_size("5G"), 5368709120)
114         self.assertEqual(zfs.from_size(zfs.from_size("5G")), 5368709120)
115     def test_from_size_decimal(self):
116         self.assertEqual(zfs.from_size("4.20M"), 4404019)
117         self.assertEqual(zfs.from_size(zfs.from_size("4.20M")), 4404019)
118     def test_from_size_none(self):
119         self.assertEqual(zfs.from_size("none"), None)
120         self.assertEqual(zfs.from_size(zfs.from_size("none")), None)
121     def test_from_size_passthrough(self):
122         self.assertEqual(zfs.from_size("passthrough"), "passthrough")
123         self.assertEqual(zfs.from_size(zfs.from_size("passthrough")), "passthrough")
124     def test_to_size_str_absolute(self):
125         self.assertEqual(zfs.to_size("5368709120"), "5G")
126         self.assertEqual(zfs.to_size(zfs.to_size("5368709120")), "5G")
127     def test_to_size_str_decimal(self):
128         self.assertEqual(zfs.to_size("4404019"), "4.20M")
129         self.assertEqual(zfs.to_size(zfs.to_size("4404019")), "4.20M")
130     def test_to_size_int_absolute(self):
131         self.assertEqual(zfs.to_size(5368709120), "5G")
132         self.assertEqual(zfs.to_size(zfs.to_size(5368709120)), "5G")
133     def test_to_size_int_decimal(self):
134         self.assertEqual(zfs.to_size(4404019), "4.20M")
135         self.assertEqual(zfs.to_size(zfs.to_size(4404019)), "4.20M")
136     def test_to_size_none(self):
137         self.assertEqual(zfs.to_size(None), "none")
138         self.assertEqual(zfs.to_size(zfs.to_size(None)), "none")
139     def test_to_size_passthrough(self):
140         self.assertEqual(zfs.to_size("passthrough"), "passthrough")
141         self.assertEqual(zfs.to_size(zfs.to_size("passthrough")), "passthrough")
142     def test_from_str_space(self):
143         self.assertEqual(zfs.from_str('"my pool/my dataset"'), "my pool/my dataset")
144         self.assertEqual(
145             zfs.from_str(zfs.from_str('"my pool/my dataset"')), "my pool/my dataset"
146         )
147     def test_from_str_squote_space(self):
148         self.assertEqual(
149             zfs.from_str("my pool/jorge's dataset"), "my pool/jorge's dataset"
150         )
151         self.assertEqual(
152             zfs.from_str(zfs.from_str("my pool/jorge's dataset")),
153             "my pool/jorge's dataset",
154         )
155     def test_from_str_dquote_space(self):
156         self.assertEqual(
157             zfs.from_str('my pool/the "good" stuff'), 'my pool/the "good" stuff'
158         )
159         self.assertEqual(
160             zfs.from_str(zfs.from_str('my pool/the "good" stuff')),
161             'my pool/the "good" stuff',
162         )
163     def test_from_str_none(self):
164         self.assertEqual(zfs.from_str("none"), None)
165         self.assertEqual(zfs.from_str(zfs.from_str("none")), None)
166     def test_from_str_passthrough(self):
167         self.assertEqual(zfs.from_str("passthrough"), "passthrough")
168         self.assertEqual(zfs.from_str(zfs.from_str("passthrough")), "passthrough")
169     def test_to_str_space(self):
170         self.assertEqual(zfs.to_str("my pool/my dataset"), '"my pool/my dataset"')
171         self.assertEqual(
172             zfs.to_str(zfs.to_str("my pool/my dataset")), '"my pool/my dataset"'
173         )
174     def test_to_str_squote_space(self):
175         self.assertEqual(
176             zfs.to_str("my pool/jorge's dataset"), '"my pool/jorge\'s dataset"'
177         )
178         self.assertEqual(
179             zfs.to_str(zfs.to_str("my pool/jorge's dataset")),
180             '"my pool/jorge\'s dataset"',
181         )
182     def test_to_str_none(self):
183         self.assertEqual(zfs.to_str(None), "none")
184         self.assertEqual(zfs.to_str(zfs.to_str(None)), "none")
185     def test_to_str_passthrough(self):
186         self.assertEqual(zfs.to_str("passthrough"), "passthrough")
187         self.assertEqual(zfs.to_str(zfs.to_str("passthrough")), "passthrough")
188     def test_is_snapshot_snapshot(self):
189         self.assertTrue(zfs.is_snapshot("zpool_name/dataset@backup"))
190     def test_is_snapshot_bookmark(self):
191         self.assertFalse(zfs.is_snapshot("zpool_name/dataset#backup"))
192     def test_is_snapshot_filesystem(self):
193         self.assertFalse(zfs.is_snapshot("zpool_name/dataset"))
194     def test_is_bookmark_snapshot(self):
195         self.assertFalse(zfs.is_bookmark("zpool_name/dataset@backup"))
196     def test_is_bookmark_bookmark(self):
197         self.assertTrue(zfs.is_bookmark("zpool_name/dataset#backup"))
198     def test_is_bookmark_filesystem(self):
199         self.assertFalse(zfs.is_bookmark("zpool_name/dataset"))
200     def test_is_dataset_snapshot(self):
201         self.assertFalse(zfs.is_dataset("zpool_name/dataset@backup"))
202     def test_is_dataset_bookmark(self):
203         self.assertFalse(zfs.is_dataset("zpool_name/dataset#backup"))
204     def test_is_dataset_filesystem(self):
205         self.assertTrue(zfs.is_dataset("zpool_name/dataset"))
206     def test_zfs_command_simple(self):
207         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
208             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
209                 with patch.object(
210                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
211                 ):
212                     with patch.object(
213                         zfs,
214                         "property_data_zpool",
215                         MagicMock(return_value=self.pmap_zpool),
216                     ):
217                         self.assertEqual(zfs.zfs_command("list"), "/sbin/zfs list")
218     def test_zfs_command_none_target(self):
219         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
220             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
221                 with patch.object(
222                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
223                 ):
224                     with patch.object(
225                         zfs,
226                         "property_data_zpool",
227                         MagicMock(return_value=self.pmap_zpool),
228                     ):
229                         self.assertEqual(
230                             zfs.zfs_command("list", target=[None, "mypool", None]),
231                             "/sbin/zfs list mypool",
232                         )
233     def test_zfs_command_flag(self):
234         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
235             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
236                 with patch.object(
237                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
238                 ):
239                     with patch.object(
240                         zfs,
241                         "property_data_zpool",
242                         MagicMock(return_value=self.pmap_zpool),
243                     ):
244                         my_flags = [
245                             "-r",  # recursive
246                         ]
247                         self.assertEqual(
248                             zfs.zfs_command("list", flags=my_flags), "/sbin/zfs list -r"
249                         )
250     def test_zfs_command_opt(self):
251         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
252             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
253                 with patch.object(
254                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
255                 ):
256                     with patch.object(
257                         zfs,
258                         "property_data_zpool",
259                         MagicMock(return_value=self.pmap_zpool),
260                     ):
261                         my_opts = {
262                             "-t": "snap",  # only list snapshots
263                         }
264                         self.assertEqual(
265                             zfs.zfs_command("list", opts=my_opts),
266                             "/sbin/zfs list -t snap",
267                         )
268     def test_zfs_command_flag_opt(self):
269         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
270             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
271                 with patch.object(
272                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
273                 ):
274                     with patch.object(
275                         zfs,
276                         "property_data_zpool",
277                         MagicMock(return_value=self.pmap_zpool),
278                     ):
279                         my_flags = [
280                             "-r",  # recursive
281                         ]
282                         my_opts = {
283                             "-t": "snap",  # only list snapshots
284                         }
285                         self.assertEqual(
286                             zfs.zfs_command("list", flags=my_flags, opts=my_opts),
287                             "/sbin/zfs list -r -t snap",
288                         )
289     def test_zfs_command_target(self):
290         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
291             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
292                 with patch.object(
293                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
294                 ):
295                     with patch.object(
296                         zfs,
297                         "property_data_zpool",
298                         MagicMock(return_value=self.pmap_zpool),
299                     ):
300                         my_flags = [
301                             "-r",  # recursive
302                         ]
303                         my_opts = {
304                             "-t": "snap",  # only list snapshots
305                         }
306                         self.assertEqual(
307                             zfs.zfs_command(
308                                 "list", flags=my_flags, opts=my_opts, target="mypool"
309                             ),
310                             "/sbin/zfs list -r -t snap mypool",
311                         )
312     def test_zfs_command_target_with_space(self):
313         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
314             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
315                 with patch.object(
316                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
317                 ):
318                     with patch.object(
319                         zfs,
320                         "property_data_zpool",
321                         MagicMock(return_value=self.pmap_zpool),
322                     ):
323                         my_flags = [
324                             "-r",  # recursive
325                         ]
326                         my_opts = {
327                             "-t": "snap",  # only list snapshots
328                         }
329                         self.assertEqual(
330                             zfs.zfs_command(
331                                 "list", flags=my_flags, opts=my_opts, target="my pool"
332                             ),
333                             '/sbin/zfs list -r -t snap "my pool"',
334                         )
335     def test_zfs_command_property(self):
336         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
337             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
338                 with patch.object(
339                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
340                 ):
341                     with patch.object(
342                         zfs,
343                         "property_data_zpool",
344                         MagicMock(return_value=self.pmap_zpool),
345                     ):
346                         self.assertEqual(
347                             zfs.zfs_command(
348                                 "get", property_name="quota", target="mypool"
349                             ),
350                             "/sbin/zfs get quota mypool",
351                         )
352     def test_zfs_command_property_value(self):
353         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
354             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
355                 with patch.object(
356                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
357                 ):
358                     with patch.object(
359                         zfs,
360                         "property_data_zpool",
361                         MagicMock(return_value=self.pmap_zpool),
362                     ):
363                         my_flags = [
364                             "-r",  # recursive
365                         ]
366                         self.assertEqual(
367                             zfs.zfs_command(
368                                 "set",
369                                 flags=my_flags,
370                                 property_name="quota",
371                                 property_value="5G",
372                                 target="mypool",
373                             ),
374                             "/sbin/zfs set -r quota=5368709120 mypool",
375                         )
376     def test_zfs_command_multi_property_value(self):
377         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
378             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
379                 with patch.object(
380                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
381                 ):
382                     with patch.object(
383                         zfs,
384                         "property_data_zpool",
385                         MagicMock(return_value=self.pmap_zpool),
386                     ):
387                         property_name = ["quota", "readonly"]
388                         property_value = ["5G", "no"]
389                         self.assertEqual(
390                             zfs.zfs_command(
391                                 "set",
392                                 property_name=property_name,
393                                 property_value=property_value,
394                                 target="mypool",
395                             ),
396                             "/sbin/zfs set quota=5368709120 readonly=off mypool",
397                         )
398     def test_zfs_command_fs_props(self):
399         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
400             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
401                 with patch.object(
402                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
403                 ):
404                     with patch.object(
405                         zfs,
406                         "property_data_zpool",
407                         MagicMock(return_value=self.pmap_zpool),
408                     ):
409                         my_flags = [
410                             "-p",  # create parent
411                         ]
412                         my_props = {
413                             "quota": "1G",
414                             "compression": "lz4",
415                         }
416                         self.assertEqual(
417                             zfs.zfs_command(
418                                 "create",
419                                 flags=my_flags,
420                                 filesystem_properties=my_props,
421                                 target="mypool/dataset",
422                             ),
423                             "/sbin/zfs create -p -o compression=lz4 -o quota=1073741824"
424                             " mypool/dataset",
425                         )
426     def test_zfs_command_fs_props_with_space(self):
427         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
428             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
429                 with patch.object(
430                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
431                 ):
432                     with patch.object(
433                         zfs,
434                         "property_data_zpool",
435                         MagicMock(return_value=self.pmap_zpool),
436                     ):
437                         my_props = {
438                             "quota": "4.2M",
439                             "compression": "lz4",
440                         }
441                         self.assertEqual(
442                             zfs.zfs_command(
443                                 "create",
444                                 filesystem_properties=my_props,
445                                 target="my pool/jorge's dataset",
446                             ),
447                             '/sbin/zfs create -o compression=lz4 -o quota=4404019 "my'
448                             " pool/jorge's dataset\"",
449                         )
450     def test_zpool_command_simple(self):
451         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
452             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
453                 with patch.object(
454                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
455                 ):
456                     with patch.object(
457                         zfs,
458                         "property_data_zpool",
459                         MagicMock(return_value=self.pmap_zpool),
460                     ):
461                         self.assertEqual(zfs.zpool_command("list"), "/sbin/zpool list")
462     def test_zpool_command_opt(self):
463         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
464             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
465                 with patch.object(
466                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
467                 ):
468                     with patch.object(
469                         zfs,
470                         "property_data_zpool",
471                         MagicMock(return_value=self.pmap_zpool),
472                     ):
473                         my_opts = {
474                             "-o": "name,size",  # show only name and size
475                         }
476                         self.assertEqual(
477                             zfs.zpool_command("list", opts=my_opts),
478                             "/sbin/zpool list -o name,size",
479                         )
480     def test_zpool_command_opt_list(self):
481         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
482             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
483                 with patch.object(
484                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
485                 ):
486                     with patch.object(
487                         zfs,
488                         "property_data_zpool",
489                         MagicMock(return_value=self.pmap_zpool),
490                     ):
491                         my_opts = {
492                             "-d": ["/tmp", "/zvol"],
493                         }
494                         self.assertEqual(
495                             zfs.zpool_command("import", opts=my_opts, target="mypool"),
496                             "/sbin/zpool import -d /tmp -d /zvol mypool",
497                         )
498     def test_zpool_command_flag_opt(self):
499         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
500             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
501                 with patch.object(
502                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
503                 ):
504                     with patch.object(
505                         zfs,
506                         "property_data_zpool",
507                         MagicMock(return_value=self.pmap_zpool),
508                     ):
509                         my_opts = {
510                             "-o": "name,size",  # show only name and size
511                         }
512                         self.assertEqual(
513                             zfs.zpool_command("list", opts=my_opts),
514                             "/sbin/zpool list -o name,size",
515                         )
516     def test_zpool_command_target(self):
517         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
518             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
519                 with patch.object(
520                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
521                 ):
522                     with patch.object(
523                         zfs,
524                         "property_data_zpool",
525                         MagicMock(return_value=self.pmap_zpool),
526                     ):
527                         my_opts = {
528                             "-o": "name,size",  # show only name and size
529                         }
530                         self.assertEqual(
531                             zfs.zpool_command("list", opts=my_opts, target="mypool"),
532                             "/sbin/zpool list -o name,size mypool",
533                         )
534     def test_zpool_command_target_with_space(self):
535         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
536             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
537                 with patch.object(
538                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
539                 ):
540                     with patch.object(
541                         zfs,
542                         "property_data_zpool",
543                         MagicMock(return_value=self.pmap_zpool),
544                     ):
545                         fs_props = {
546                             "quota": "100G",
547                         }
548                         pool_props = {
549                             "comment": "jorge's comment has a space",
550                         }
551                         self.assertEqual(
552                             zfs.zpool_command(
553                                 "create",
554                                 pool_properties=pool_props,
555                                 filesystem_properties=fs_props,
556                                 target="my pool",
557                             ),
558                             "/sbin/zpool create -O quota=107374182400 -o"
559                             ' comment="jorge\'s comment has a space" "my pool"',
560                         )
561     def test_zpool_command_property(self):
562         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
563             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
564                 with patch.object(
565                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
566                 ):
567                     with patch.object(
568                         zfs,
569                         "property_data_zpool",
570                         MagicMock(return_value=self.pmap_zpool),
571                     ):
572                         self.assertEqual(
573                             zfs.zpool_command(
574                                 "get", property_name="comment", target="mypool"
575                             ),
576                             "/sbin/zpool get comment mypool",
577                         )
578     def test_zpool_command_property_value(self):
579         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
580             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
581                 with patch.object(
582                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
583                 ):
584                     with patch.object(
585                         zfs,
586                         "property_data_zpool",
587                         MagicMock(return_value=self.pmap_zpool),
588                     ):
589                         my_flags = [
590                             "-v",  # verbose
591                         ]
592                         self.assertEqual(
593                             zfs.zpool_command(
594                                 "iostat", flags=my_flags, target=["mypool", 60, 1]
595                             ),
596                             "/sbin/zpool iostat -v mypool 60 1",
597                         )
598     def test_parse_command_result_success(self):
599         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
600             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
601                 with patch.object(
602                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
603                 ):
604                     with patch.object(
605                         zfs,
606                         "property_data_zpool",
607                         MagicMock(return_value=self.pmap_zpool),
608                     ):
609                         res = {}
610                         res["retcode"] = 0
611                         res["stderr"] = ""
612                         res["stdout"] = ""
613                         self.assertEqual(
614                             zfs.parse_command_result(res, "tested"),
615                             OrderedDict([("tested", True)]),
616                         )
617     def test_parse_command_result_success_nolabel(self):
618         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
619             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
620                 with patch.object(
621                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
622                 ):
623                     with patch.object(
624                         zfs,
625                         "property_data_zpool",
626                         MagicMock(return_value=self.pmap_zpool),
627                     ):
628                         res = {}
629                         res["retcode"] = 0
630                         res["stderr"] = ""
631                         res["stdout"] = ""
632                         self.assertEqual(
633                             zfs.parse_command_result(res),
634                             OrderedDict(),
635                         )
636     def test_parse_command_result_fail(self):
637         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
638             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
639                 with patch.object(
640                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
641                 ):
642                     with patch.object(
643                         zfs,
644                         "property_data_zpool",
645                         MagicMock(return_value=self.pmap_zpool),
646                     ):
647                         res = {}
648                         res["retcode"] = 1
649                         res["stderr"] = ""
650                         res["stdout"] = ""
651                         self.assertEqual(
652                             zfs.parse_command_result(res, "tested"),
653                             OrderedDict([("tested", False)]),
654                         )
655     def test_parse_command_result_nolabel(self):
656         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
657             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
658                 with patch.object(
659                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
660                 ):
661                     with patch.object(
662                         zfs,
663                         "property_data_zpool",
664                         MagicMock(return_value=self.pmap_zpool),
665                     ):
666                         res = {}
667                         res["retcode"] = 1
668                         res["stderr"] = ""
669                         res["stdout"] = ""
670                         self.assertEqual(
671                             zfs.parse_command_result(res),
672                             OrderedDict(),
673                         )
674     def test_parse_command_result_fail_message(self):
675         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
676             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
677                 with patch.object(
678                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
679                 ):
680                     with patch.object(
681                         zfs,
682                         "property_data_zpool",
683                         MagicMock(return_value=self.pmap_zpool),
684                     ):
685                         res = {}
686                         res["retcode"] = 1
687                         res["stderr"] = "\n".join(
688                             ["ice is not hot", "usage:", "this should not be printed"]
689                         )
690                         res["stdout"] = ""
691                         self.assertEqual(
692                             zfs.parse_command_result(res, "tested"),
693                             OrderedDict(
694                                 [("tested", False), ("error", "ice is not hot")]
695                             ),
696                         )
697     def test_parse_command_result_fail_message_nolabel(self):
698         with patch.object(zfs, "_zfs_cmd", MagicMock(return_value="/sbin/zfs")):
699             with patch.object(zfs, "_zpool_cmd", MagicMock(return_value="/sbin/zpool")):
700                 with patch.object(
701                     zfs, "property_data_zfs", MagicMock(return_value=self.pmap_zfs)
702                 ):
703                     with patch.object(
704                         zfs,
705                         "property_data_zpool",
706                         MagicMock(return_value=self.pmap_zpool),
707                     ):
708                         res = {}
709                         res["retcode"] = 1
710                         res["stderr"] = "\n".join(
711                             ["ice is not hot", "usage:", "this should not be printed"]
712                         )
713                         res["stdout"] = ""
714                         self.assertEqual(
715                             zfs.parse_command_result(res),
716                             OrderedDict([("error", "ice is not hot")]),
717                         )
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
