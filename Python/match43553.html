<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_zpool.py &amp; test_snapper.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_zpool.py &amp; test_snapper.py
      </h3>
<h1 align="center">
        6.3%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_zpool.py (7.4394464%)<th>test_snapper.py (5.5198975%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(360-382)<td><a href="#" name="0">(90-176)</a><td align="center"><font color="#ff0000">24</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(464-486)<td><a href="#" name="1">(21-85)</a><td align="center"><font color="#c90000">19</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_zpool.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import pytest
2 import salt.config
3 import salt.loader
4 import salt.states.zpool as zpool
5 import salt.utils.zfs
6 from salt.utils.odict import OrderedDict
7 from tests.support.mock import MagicMock, patch
8 from tests.support.zfs import ZFSMockData
9 @pytest.fixture
10 def utils_patch():
11     return ZFSMockData().get_patched_utils()
12 @pytest.fixture
13 def configure_loader_modules():
14     opts = salt.config.DEFAULT_MINION_OPTS.copy()
15     utils = salt.loader.utils(opts, whitelist=["zfs"])
16     zpool_obj = {
17         zpool: {
18             "__opts__": opts,
19             "__grains__": {"kernel": "SunOS"},
20             "__utils__": utils,
21         }
22     }
23     return zpool_obj
24 def test_absent_without_pool(utils_patch):
25     ret = {
26         "name": "myzpool",
27         "result": True,
28         "comment": "storage pool myzpool is absent",
29         "changes": {},
30     }
31     mock_exists = MagicMock(return_value=False)
32     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
33         zpool.__utils__, utils_patch
34     ):
35         assert zpool.absent("myzpool") == ret
36 def test_absent_destroy_pool(utils_patch):
37     ret = {
38         "name": "myzpool",
39         "result": True,
40         "comment": "storage pool myzpool was destroyed",
41         "changes": {"myzpool": "destroyed"},
42     }
43     mock_exists = MagicMock(return_value=True)
44     mock_destroy = MagicMock(return_value=OrderedDict([("destroyed", True)]))
45     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
46         zpool.__salt__, {"zpool.destroy": mock_destroy}
47     ), patch.dict(zpool.__utils__, utils_patch):
48         assert zpool.absent("myzpool") == ret
49 def test_absent_exporty_pool(utils_patch):
50     ret = {
51         "name": "myzpool",
52         "result": True,
53         "comment": "storage pool myzpool was exported",
54         "changes": {"myzpool": "exported"},
55     }
56     mock_exists = MagicMock(return_value=True)
57     mock_destroy = MagicMock(return_value=OrderedDict([("exported", True)]))
58     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
59         zpool.__salt__, {"zpool.export": mock_destroy}
60     ), patch.dict(zpool.__utils__, utils_patch):
61         assert zpool.absent("myzpool", export=True) == ret
62 def test_absent_busy(utils_patch):
63     ret = {
64         "name": "myzpool",
65         "result": False,
66         "comment": "\n".join(
67             [
68                 "cannot unmount '/myzpool': Device busy",
69                 "cannot export 'myzpool': pool is busy",
70             ]
71         ),
72         "changes": {},
73     }
74     mock_exists = MagicMock(return_value=True)
75     mock_destroy = MagicMock(
76         return_value=OrderedDict(
77             [
78                 ("exported", False),
79                 (
80                     "error",
81                     "\n".join(
82                         [
83                             "cannot unmount '/myzpool': Device busy",
84                             "cannot export 'myzpool': pool is busy",
85                         ]
86                     ),
87                 ),
88             ]
89         )
90     )
91     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
92         zpool.__salt__, {"zpool.export": mock_destroy}
93     ), patch.dict(zpool.__utils__, utils_patch):
94         assert zpool.absent("myzpool", export=True) == ret
95 def test_present_import_success(utils_patch):
96     ret = {
97         "name": "myzpool",
98         "result": True,
99         "comment": "storage pool myzpool was imported",
100         "changes": {"myzpool": "imported"},
101     }
102     config = {
103         "import": True,
104     }
105     mock_exists = MagicMock(return_value=False)
106     mock_import = MagicMock(return_value=OrderedDict([("imported", True)]))
107     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
108         zpool.__salt__, {"zpool.import": mock_import}
109     ), patch.dict(zpool.__utils__, utils_patch):
110         assert zpool.present("myzpool", config=config) == ret
111 def test_present_import_fail(utils_patch):
112     ret = {
113         "name": "myzpool",
114         "result": False,
115         "comment": (
116             "storage pool myzpool was not imported, no (valid) layout specified for"
117             " creation"
118         ),
119         "changes": {},
120     }
121     config = {
122         "import": True,
123     }
124     mock_exists = MagicMock(return_value=False)
125     mock_import = MagicMock(return_value=OrderedDict([("imported", False)]))
126     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
127         zpool.__salt__, {"zpool.import": mock_import}
128     ), patch.dict(zpool.__utils__, utils_patch):
129         assert zpool.present("myzpool", config=config) == ret
130 def test_present_create_success(utils_patch):
131     ret = {
132         "name": "myzpool",
133         "result": True,
134         "comment": "storage pool myzpool was created",
135         "changes": {"myzpool": "created"},
136     }
137     config = {
138         "import": False,
139     }
140     layout = [
141         OrderedDict([("mirror", ["disk0", "disk1"])]),
142         OrderedDict([("mirror", ["disk2", "disk3"])]),
143     ]
144     properties = {
145         "autoexpand": True,
146     }
147     filesystem_properties = {
148         "quota": "5G",
149     }
150     mock_exists = MagicMock(return_value=False)
151     mock_create = MagicMock(
152         return_value=OrderedDict(
153             [
154                 ("created", True),
155                 (
156                     "vdevs",
157                     OrderedDict(
158                         [
159                             ("mirror-0", ["/dev/dsk/disk0", "/dev/dsk/disk1"]),
160                             ("mirror-1", ["/dev/dsk/disk2", "/dev/dsk/disk3"]),
161                         ]
162                     ),
163                 ),
164             ]
165         )
166     )
167     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
168         zpool.__salt__, {"zpool.create": mock_create}
169     ), patch.dict(zpool.__utils__, utils_patch):
170         assert (
171             zpool.present(
172                 "myzpool",
173                 config=config,
174                 layout=layout,
175                 properties=properties,
176                 filesystem_properties=filesystem_properties,
177             )
178             == ret
179         )
180 def test_present_create_fail(utils_patch):
181     ret = {
182         "name": "myzpool",
183         "result": False,
184         "comment": (
185             "storage pool myzpool was not imported, no (valid) layout specified for"
186             " creation"
187         ),
188         "changes": {},
189     }
190     config = {
191         "import": False,
192     }
193     mock_exists = MagicMock(return_value=False)
194     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
195         zpool.__utils__, utils_patch
196     ):
197         assert zpool.present("myzpool", config=config) == ret
198 def test_present_create_passthrough_fail(utils_patch):
199     ret = {
200         "name": "myzpool",
201         "result": False,
202         "comment": "\n".join(
203             [
204                 "invalid vdev specification",
205                 "use 'force=True' to override the following errors:",
206                 "/data/salt/vdisk0 is part of exported pool 'zsalt'",
207                 "/data/salt/vdisk1 is part of exported pool 'zsalt'",
208             ]
209         ),
210         "changes": {},
211     }
212     config = {
213         "force": False,
214         "import": False,
215     }
216     layout = [
217         OrderedDict([("mirror", ["disk0", "disk1"])]),
218         OrderedDict([("mirror", ["disk2", "disk3"])]),
219     ]
220     properties = {
221         "autoexpand": True,
222     }
223     filesystem_properties = {
224         "quota": "5G",
225     }
226     mock_exists = MagicMock(return_value=False)
227     mock_create = MagicMock(
228         return_value=OrderedDict(
229             [
230                 ("created", False),
231                 (
232                     "error",
233                     "\n".join(
234                         [
235                             "invalid vdev specification",
236                             "use 'force=True' to override the following errors:",
237                             "/data/salt/vdisk0 is part of exported pool 'zsalt'",
238                             "/data/salt/vdisk1 is part of exported pool 'zsalt'",
239                         ]
240                     ),
241                 ),
242             ]
243         )
244     )
245     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
246         zpool.__salt__, {"zpool.create": mock_create}
247     ), patch.dict(zpool.__utils__, utils_patch):
248         assert (
249             zpool.present(
250                 "myzpool",
251                 config=config,
252                 layout=layout,
253                 properties=properties,
254                 filesystem_properties=filesystem_properties,
255             )
256             == ret
257         )
258 def test_present_update_success(utils_patch):
259     ret = {
260         "name": "myzpool",
261         "result": True,
262         "comment": "properties updated",
263         "changes": {"myzpool": {"autoexpand": False}},
264     }
265     config = {
266         "import": False,
267     }
268     layout = [
269         OrderedDict([("mirror", ["disk0", "disk1"])]),
270         OrderedDict([("mirror", ["disk2", "disk3"])]),
271     ]
272     properties = {
273         "autoexpand": False,
274     }
275     mock_exists = MagicMock(return_value=True)
276         return_value=OrderedDict(
277             [
278                 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>("comment", "salt managed pool"),
279                 ("freeing", 0),
280                 ("listsnapshots", False),
281                 ("leaked", 0),
282                 ("feature@obsolete_counts", "enabled"),
283                 ("feature@sha512", "enabled"),
284                 ("delegation", True),
285                 ("dedupditto", "0"),
286                 ("dedupratio", "1.00x"),
287                 ("autoexpand", True),
288                 ("feature@bookmarks", "enabled"),
289                 ("allocated", 115712),
290                 ("guid", 1591906802560842214),
291                 ("feature@large_blocks", "enabled"),
292                 ("size", 2113929216),
293                 ("feature@enabled_txg", "active"),
294                 ("feature@hole_birth", "active"),
295                 ("capacity", 0),
296                 ("feature@multi_vdev_crash_dump", "enabled"),
297                 ("feature@extensible_dataset", "enabled"),
298                 ("cachefile", "-"),
299                 ("bootfs", "-"),
300                 ("autoreplace"</b></font>, True),
301                 ("readonly", False),
302                 ("version", "-"),
303                 ("health", "ONLINE"),
304                 ("expandsize", "-"),
305                 ("feature@embedded_data", "active"),
306                 ("feature@lz4_compress", "active"),
307                 ("feature@async_destroy", "enabled"),
308                 ("feature@skein", "enabled"),
309                 ("feature@empty_bpobj", "enabled"),
310                 ("feature@spacemap_histogram", "active"),
311                 ("bootsize", "-"),
312                 ("free", 2113813504),
313                 ("feature@device_removal", "enabled"),
314                 ("failmode", "wait"),
315                 ("feature@filesystem_limits", "enabled"),
316                 ("feature@edonr", "enabled"),
317                 ("altroot", "-"),
318                 ("fragmentation", "0%"),
319             ]
320         )
321     )
322     mock_set = MagicMock(return_value=OrderedDict([("set", True)]))
323     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
324         zpool.__salt__, {"zpool.get": mock_get}
325     ), patch.dict(zpool.__salt__, {"zpool.set": mock_set}), patch.dict(
326         zpool.__utils__, utils_patch
327     ):
328         assert (
329             zpool.present(
330                 "myzpool",
331                 config=config,
332                 layout=layout,
333                 properties=properties,
334             )
335             == ret
336         )
337 def test_present_update_nochange_success(utils_patch):
338     config = {
339         "import": False,
340     }
341     layout = [
342         OrderedDict([("mirror", ["disk0", "disk1"])]),
343         OrderedDict([("mirror", ["disk2", "disk3"])]),
344     ]
345     properties = {
346         "autoexpand": True,
347     }
348     mock_exists = MagicMock(return_value=True)
349     mock_get = MagicMock(
350         return_value=OrderedDict(
351             [
352                 ("comment", "salt managed pool"),
353                 ("freeing", 0),
354                 ("listsnapshots", False),
355                 ("leaked", 0),
356                 ("feature@obsolete_counts", "enabled"),
357                 ("feature@sha512", "enabled"),
358                 ("delegation", True),
359                 ("dedupditto", "0"),
360                 ("dedupratio", "1.00x"),
361                 ("autoexpand", True),
362                 ("feature@bookmarks", "enabled"),
363                 ("allocated", 115712),
364                 ("guid", 1591906802560842214),
365                 ("feature@large_blocks", "enabled"),
366                 ("size", 2113929216),
367                 ("feature@enabled_txg", "active"),
368                 ("feature@hole_birth", "active"),
369                 ("capacity", 0),
370                 ("feature@multi_vdev_crash_dump", "enabled"),
371                 ("feature@extensible_dataset", "enabled"),
372                 ("cachefile", "-"),
373                 ("autoreplace", True),
374                 ("readonly", False),
375                 (<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"version", "-"),
376                 ("health", "ONLINE"),
377                 ("expandsize", "-"),
378                 ("feature@embedded_data", "active"),
379                 ("feature@lz4_compress", "active"),
380                 ("feature@async_destroy", "enabled"),
381                 ("feature@skein", "enabled"),
382                 ("feature@empty_bpobj", "enabled"),
383                 ("feature@spacemap_histogram", "active"),
384                 ("bootsize", "-"),
385                 ("free", 2113813504),
386                 ("feature@device_removal", "enabled"),
387                 ("failmode", "wait"),
388                 ("feature@filesystem_limits", "enabled"),
389                 ("feature@edonr", "enabled"),
390                 ("altroot", "-"),
391                 ("fragmentation", "0%"),
392             ]
393         )
394     )
395     ret = {
396         "name"</b></font>: "myzpool",
397         "result": True,
398         "comment": "no update needed",
399         "changes": {},
400     }
401     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}):
402         with patch.dict(zpool.__salt__, {"zpool.get": mock_get}):
403             with patch.dict(zpool.__utils__, utils_patch):
404                 assert (
405                     zpool.present(
406                         "myzpool",
407                         config=config,
408                         layout=layout,
409                         properties=properties,
410                     )
411                     == ret
412                 )
413     ret = {
414         "name": "myzpool",
415         "result": True,
416         "comment": "storage pool myzpool is uptodate",
417         "changes": {},
418     }
419     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}):
420         with patch.dict(zpool.__salt__, {"zpool.get": mock_get}):
421             with patch.dict(zpool.__utils__, utils_patch):
422                 with patch.dict(zpool.__opts__, {"test": True}):
423                     assert (
424                         zpool.present(
425                             "myzpool",
426                             config=config,
427                             layout=layout,
428                             properties=properties,
429                         )
430                         == ret
431                     )
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_snapper.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import sys
2 import salt.modules.snapper as snapper
3 import salt.utils.files
4 import salt.utils.platform
5 from salt.exceptions import CommandExecutionError
6 from tests.support.helpers import with_tempfile
7 from tests.support.mixins import LoaderModuleMockMixin
8 from tests.support.mock import MagicMock, mock_open, patch
9 DBUS_RET = {
10     <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>"ListSnapshots": [
11         [
12             42,
13             1,
14             0,
15             1457006571,
16             0,
17             "Some description",
18             "",
19             {"userdata1": "userval1", "salt_jid": "20160607130930720112"},
20         ],
21         [
22             43,
23             2,
24             42,
25             1457006572,
26             0,
27             "Blah Blah",
28             "",
29             {"userdata2": "userval2", "salt_jid": "20160607130930720112"},
30         ],
31     ],
32     "ListConfigs": [
33         [
34             "root",
35             "/",
36             {
37                 "SUBVOLUME": "/",
38                 "NUMBER_MIN_AGE": "1800",
39                 "TIMELINE_LIMIT_YEARLY": "4-10",
40                 "NUMBER_LIMIT_IMPORTANT": "10",
41                 "FSTYPE": "btrfs",
42                 "TIMELINE_LIMIT_MONTHLY": "4-10",
43                 "ALLOW_GROUPS": "",
44                 "EMPTY_PRE_POST_MIN_AGE": "1800",
45                 "EMPTY_PRE_POST_CLEANUP": "yes",
46                 "BACKGROUND_COMPARISON": "yes",
47                 "TIMELINE_LIMIT_HOURLY": "4-10",
48                 "ALLOW_USERS": "",
49                 "TIMELINE_LIMIT_WEEKLY": "0",
50                 "TIMELINE_CREATE": "no",
51                 "NUMBER_CLEANUP": "yes",
52                 "TIMELINE_CLEANUP": "yes",
53                 "SPACE_LIMIT": "0.5",
54                 "NUMBER_LIMIT": "10",
55                 "TIMELINE_MIN_AGE": "1800",
56                 "TIMELINE_LIMIT_DAILY": "4-10",
57                 "SYNC_ACL": "no",
58                 "QGROUP": "1/0",
59             },
60         ]
61     ],
62     "GetFiles": [
63         ["/root/.viminfo", 8],
64         ["/tmp/foo", 52],
65         ["/tmp/foo2", 1],
66         ["/tmp/foo3", 2],
67         ["/var/log/snapper.log", 8],
68         ["/var/cache/salt/minion/extmods/modules/snapper.py", 8],
69         ["/var/cache/salt/minion/extmods/modules/snapper.pyc", 8],
70     ],
71 }
72 FILE_CONTENT = {
73     "/tmp/foo"</b></font>: {"pre": "dummy text", "post": "another foobar"},
74     "/tmp/foo2": {"post": "another foobar"},
75 MODULE_RET = {
76     <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>"SNAPSHOTS": [
77         {
78             "userdata": {"userdata1": "userval1", "salt_jid": "20160607130930720112"},
79             "description": "Some description",
80             "timestamp": 1457006571,
81             "cleanup": "",
82             "user": "root",
83             "type": "pre",
84             "id": 42,
85         },
86         {
87             "pre": 42,
88             "userdata": {"userdata2": "userval2", "salt_jid": "20160607130930720112"},
89             "description": "Blah Blah",
90             "timestamp": 1457006572,
91             "cleanup": "",
92             "user": "root",
93             "type": "post",
94             "id": 43,
95         },
96     ],
97     "LISTCONFIGS": {
98         "root": {
99             "SUBVOLUME": "/",
100             "NUMBER_MIN_AGE": "1800",
101             "TIMELINE_LIMIT_YEARLY": "4-10",
102             "NUMBER_LIMIT_IMPORTANT": "10",
103             "FSTYPE": "btrfs",
104             "TIMELINE_LIMIT_MONTHLY": "4-10",
105             "ALLOW_GROUPS": "",
106             "EMPTY_PRE_POST_MIN_AGE": "1800",
107             "EMPTY_PRE_POST_CLEANUP": "yes",
108             "BACKGROUND_COMPARISON": "yes",
109             "TIMELINE_LIMIT_HOURLY": "4-10",
110             "ALLOW_USERS": "",
111             "TIMELINE_LIMIT_WEEKLY": "0",
112             "TIMELINE_CREATE": "no",
113             "NUMBER_CLEANUP": "yes",
114             "TIMELINE_CLEANUP": "yes",
115             "SPACE_LIMIT": "0.5",
116             "NUMBER_LIMIT": "10",
117             "TIMELINE_MIN_AGE": "1800",
118             "TIMELINE_LIMIT_DAILY": "4-10",
119             "SYNC_ACL": "no",
120             "QGROUP": "1/0",
121         }
122     },
123     "GETFILES": {
124         "/root/.viminfo": {"status": ["modified"]},
125         "/tmp/foo": {"status": ["type changed", "permission changed", "owner changed"]},
126         "/tmp/foo2": {"status": ["created"]},
127         "/tmp/foo3": {"status": ["deleted"]},
128         "/var/log/snapper.log": {"status": ["modified"]},
129         "/var/cache/salt/minion/extmods/modules/snapper.py": {"status": ["modified"]},
130         "/var/cache/salt/minion/extmods/modules/snapper.pyc": {"status": ["modified"]},
131     },
132     "DIFF": {
133         "/tmp/foo": {
134             "comment": "text file changed",
135             "diff": (
136                 "--- /.snapshots/55/snapshot/tmp/foo\n"
137                 "+++ /tmp/foo\n"
138                 "@@ -1 +1 @@\n"
139                 "-dummy text"
140                 "+another foobar"
141             ),
142         },
143         "/tmp/foo2": {
144             "comment": "text file created",
145             "diff": (
146                 "--- /.snapshots/55/snapshot/tmp/foo2\n"
147                 "+++ /tmp/foo2\n"
148                 "@@ -0,0 +1 @@\n"
149                 "+another foobar"
150             ),
151         },
152         "/tmp/foo26": {
153             "comment": "text file created",
154             "diff": (
155                 "--- /.snapshots/55/snapshot/tmp/foo2 \n"
156                 "+++ /tmp/foo2 \n"
157                 "@@ -1,0 +1,1 @@\n"
158                 "+another foobar"
159             ),
160         },
161         "/tmp/foo3": {
162             "comment"</b></font>: "binary file changed",
163             "old_sha256_digest": (
164                 "e61f8b762d83f3b4aeb3689564b0ffbe54fa731a69a1e208dc9440ce0f69d19b"
165             ),
166             "new_sha256_digest": (
167                 "f18f971f1517449208a66589085ddd3723f7f6cefb56c141e3d97ae49e1d87fa"
168             ),
169         },
170     },
171 }
172 @skipIf(sys.platform.startswith("win"), "Snapper not available on Windows")
173 class SnapperTestCase(TestCase, LoaderModuleMockMixin):
174     def setup_loader_modules(self):
175         class DBusException(BaseException):
176             get_dbus_name = "foo"
177         dbus_mock = MagicMock()
178         dbus_mock.configure_mock(DBusException=DBusException)
179         return {snapper: {"dbus": dbus_mock, "snapper": MagicMock()}}
180     def test__snapshot_to_data(self):
181         data = snapper._snapshot_to_data(
182             DBUS_RET["ListSnapshots"][0]
183         )  # pylint: disable=protected-access
184         self.assertEqual(data["id"], 42)
185         self.assertNotIn("pre", data)
186         self.assertEqual(data["type"], "pre")
187         self.assertEqual(data["user"], "root")
188         self.assertEqual(data["timestamp"], 1457006571)
189         self.assertEqual(data["description"], "Some description")
190         self.assertEqual(data["cleanup"], "")
191         self.assertEqual(data["userdata"]["userdata1"], "userval1")
192     def test_list_snapshots(self):
193         with patch(
194             "salt.modules.snapper.snapper.ListSnapshots",
195             MagicMock(return_value=DBUS_RET["ListSnapshots"]),
196         ):
197             self.assertEqual(snapper.list_snapshots(), MODULE_RET["SNAPSHOTS"])
198     def test_get_snapshot(self):
199         with patch(
200             "salt.modules.snapper.snapper.GetSnapshot",
201             MagicMock(return_value=DBUS_RET["ListSnapshots"][0]),
202         ):
203             self.assertEqual(snapper.get_snapshot(), MODULE_RET["SNAPSHOTS"][0])
204             self.assertEqual(
205                 snapper.get_snapshot(number=42), MODULE_RET["SNAPSHOTS"][0]
206             )
207             self.assertNotEqual(
208                 snapper.get_snapshot(number=42), MODULE_RET["SNAPSHOTS"][1]
209             )
210     def test_list_configs(self):
211         with patch(
212             "salt.modules.snapper.snapper.ListConfigs",
213             MagicMock(return_value=DBUS_RET["ListConfigs"]),
214         ):
215             self.assertEqual(snapper.list_configs(), MODULE_RET["LISTCONFIGS"])
216     def test_get_config(self):
217         with patch(
218             "salt.modules.snapper.snapper.GetConfig",
219             MagicMock(return_value=DBUS_RET["ListConfigs"][0]),
220         ):
221             self.assertEqual(snapper.get_config(), DBUS_RET["ListConfigs"][0])
222     def test_set_config(self):
223         with patch("salt.modules.snapper.snapper.SetConfig", MagicMock()):
224             opts = {"sync_acl": True, "dummy": False, "foobar": 1234}
225             self.assertEqual(snapper.set_config(opts), True)
226     def test_status_to_string(self):
227         self.assertEqual(snapper.status_to_string(1), ["created"])
228         self.assertEqual(snapper.status_to_string(2), ["deleted"])
229         self.assertEqual(snapper.status_to_string(4), ["type changed"])
230         self.assertEqual(snapper.status_to_string(8), ["modified"])
231         self.assertEqual(snapper.status_to_string(16), ["permission changed"])
232         self.assertListEqual(
233             snapper.status_to_string(24), ["modified", "permission changed"]
234         )
235         self.assertEqual(snapper.status_to_string(32), ["owner changed"])
236         self.assertEqual(snapper.status_to_string(64), ["group changed"])
237         self.assertListEqual(
238             snapper.status_to_string(97), ["created", "owner changed", "group changed"]
239         )
240         self.assertEqual(snapper.status_to_string(128), ["extended attributes changed"])
241         self.assertEqual(snapper.status_to_string(256), ["ACL info changed"])
242     def test_create_config(self):
243         with patch("salt.modules.snapper.snapper.CreateConfig", MagicMock()), patch(
244             "salt.modules.snapper.snapper.GetConfig",
245             MagicMock(return_value=DBUS_RET["ListConfigs"][0]),
246         ):
247             opts = {
248                 "name": "testconfig",
249                 "subvolume": "/foo/bar/",
250                 "fstype": "btrfs",
251                 "template": "mytemplate",
252                 "extra_opts": {"NUMBER_CLEANUP": False},
253             }
254             with patch(
255                 "salt.modules.snapper.set_config", MagicMock()
256             ) as set_config_mock:
257                 self.assertEqual(
258                     snapper.create_config(**opts), DBUS_RET["ListConfigs"][0]
259                 )
260                 set_config_mock.assert_called_with("testconfig", **opts["extra_opts"])
261             with patch(
262                 "salt.modules.snapper.set_config", MagicMock()
263             ) as set_config_mock:
264                 del opts["extra_opts"]
265                 self.assertEqual(
266                     snapper.create_config(**opts), DBUS_RET["ListConfigs"][0]
267                 )
268                 assert not set_config_mock.called
269                 self.assertRaises(CommandExecutionError, snapper.create_config)
270     def test_create_snapshot(self):
271         with patch(
272             "salt.modules.snapper.snapper.CreateSingleSnapshot",
273             MagicMock(return_value=1234),
274         ), patch(
275             "salt.modules.snapper.snapper.CreatePreSnapshot",
276             MagicMock(return_value=1234),
277         ), patch(
278             "salt.modules.snapper.snapper.CreatePostSnapshot",
279             MagicMock(return_value=1234),
280         ):
281             for snapshot_type in ["pre", "post", "single"]:
282                 opts = {
283                     "__pub_jid": 20160607130930720112,
284                     "type": snapshot_type,
285                     "description": "Test description",
286                     "cleanup_algorithm": "number",
287                     "pre_number": 23,
288                 }
289                 self.assertEqual(snapper.create_snapshot(**opts), 1234)
290     def test_delete_snapshot_id_success(self):
291         with patch("salt.modules.snapper.snapper.DeleteSnapshots", MagicMock()), patch(
292             "salt.modules.snapper.snapper.ListSnapshots",
293             MagicMock(return_value=DBUS_RET["ListSnapshots"]),
294         ):
295             self.assertEqual(
296                 snapper.delete_snapshot(snapshots_ids=43),
297                 {"root": {"ids": [43], "status": "deleted"}},
298             )
299             self.assertEqual(
300                 snapper.delete_snapshot(snapshots_ids=[42, 43]),
301                 {"root": {"ids": [42, 43], "status": "deleted"}},
302             )
303     def test_delete_snapshot_id_fail(self):
304         with patch("salt.modules.snapper.snapper.DeleteSnapshots", MagicMock()), patch(
305             "salt.modules.snapper.snapper.ListSnapshots",
306             MagicMock(return_value=DBUS_RET["ListSnapshots"]),
307         ):
308             self.assertRaises(CommandExecutionError, snapper.delete_snapshot)
309             self.assertRaises(
310                 CommandExecutionError, snapper.delete_snapshot, snapshots_ids=1
311             )
312             self.assertRaises(
313                 CommandExecutionError, snapper.delete_snapshot, snapshots_ids=[1, 2]
314             )
315     def test_modify_snapshot(self):
316         with patch("salt.modules.snapper.snapper.SetSnapshot", MagicMock()):
317             _ret = {
318                 "userdata": {"userdata2": "uservalue2"},
319                 "description": "UPDATED DESCRIPTION",
320                 "timestamp": 1457006571,
321                 "cleanup": "number",
322                 "user": "root",
323                 "type": "pre",
324                 "id": 42,
325             }
326             _opts = {
327                 "config": "root",
328                 "snapshot_id": 42,
329                 "cleanup": "number",
330                 "description": "UPDATED DESCRIPTION",
331                 "userdata": {"userdata2": "uservalue2"},
332             }
333             with patch(
334                 "salt.modules.snapper.get_snapshot",
335                 MagicMock(side_effect=[DBUS_RET["ListSnapshots"][0], _ret]),
336             ):
337                 self.assertDictEqual(snapper.modify_snapshot(**_opts), _ret)
338     def test__get_num_interval(self):
339         with patch(
340             "salt.modules.snapper._get_last_snapshot",
341             MagicMock(return_value={"id": 42}),
342         ):
343             self.assertEqual(
344                 snapper._get_num_interval(config=None, num_pre=None, num_post=None),
345                 (42, 0),
346             )  # pylint: disable=protected-access
347             self.assertEqual(
348                 snapper._get_num_interval(config=None, num_pre=None, num_post=50),
349                 (42, 50),
350             )  # pylint: disable=protected-access
351             self.assertEqual(
352                 snapper._get_num_interval(config=None, num_pre=42, num_post=50),
353                 (42, 50),
354             )  # pylint: disable=protected-access
355     def test_run(self):
356         patch_dict = {
357             "snapper.create_snapshot": MagicMock(return_value=43),
358             "test.ping": MagicMock(return_value=True),
359         }
360         with patch.dict(snapper.__salt__, patch_dict):
361             self.assertEqual(snapper.run("test.ping"), True)
362             self.assertRaises(CommandExecutionError, snapper.run, "unknown.func")
363     def test_status(self):
364         with patch(
365             "salt.modules.snapper._get_num_interval", MagicMock(return_value=(42, 43))
366         ), patch("salt.modules.snapper.snapper.GetComparison", MagicMock()), patch(
367             "salt.modules.snapper.snapper.GetFiles",
368             MagicMock(return_value=DBUS_RET["GetFiles"]),
369         ), patch(
370             "salt.modules.snapper.snapper.ListConfigs",
371             MagicMock(return_value=DBUS_RET["ListConfigs"]),
372         ):
373             self.assertCountEqual(snapper.status(), MODULE_RET["GETFILES"])
374             self.assertCountEqual(
375                 snapper.status(num_pre="42", num_post=43), MODULE_RET["GETFILES"]
376             )
377             self.assertCountEqual(snapper.status(num_pre=42), MODULE_RET["GETFILES"])
378             self.assertCountEqual(snapper.status(num_post=43), MODULE_RET["GETFILES"])
379     def test_changed_files(self):
380         with patch(
381             "salt.modules.snapper.status",
382             MagicMock(return_value=MODULE_RET["GETFILES"]),
383         ):
384             self.assertEqual(snapper.changed_files(), MODULE_RET["GETFILES"].keys())
385     def test_undo(self):
386         with patch(
387             "salt.modules.snapper._get_num_interval", MagicMock(return_value=(42, 43))
388         ), patch(
389             "salt.modules.snapper.status",
390             MagicMock(return_value=MODULE_RET["GETFILES"]),
391         ):
392             cmd_ret = "create:0 modify:1 delete:0"
393             with patch.dict(
394                 snapper.__salt__, {"cmd.run": MagicMock(return_value=cmd_ret)}
395             ):
396                 module_ret = {"create": "0", "delete": "0", "modify": "1"}
397                 self.assertEqual(snapper.undo(files=["/tmp/foo"]), module_ret)
398             cmd_ret = "create:1 modify:1 delete:0"
399             with patch.dict(
400                 snapper.__salt__, {"cmd.run": MagicMock(return_value=cmd_ret)}
401             ):
402                 module_ret = {"create": "1", "delete": "0", "modify": "1"}
403                 self.assertEqual(
404                     snapper.undo(files=["/tmp/foo", "/tmp/foo2"]), module_ret
405                 )
406             cmd_ret = "create:1 modify:1 delete:1"
407             with patch.dict(
408                 snapper.__salt__, {"cmd.run": MagicMock(return_value=cmd_ret)}
409             ):
410                 module_ret = {"create": "1", "delete": "1", "modify": "1"}
411                 self.assertEqual(
412                     snapper.undo(files=["/tmp/foo", "/tmp/foo2", "/tmp/foo3"]),
413                     module_ret,
414                 )
415     def test__get_jid_snapshots(self):
416         with patch(
417             "salt.modules.snapper.list_snapshots",
418             MagicMock(return_value=MODULE_RET["SNAPSHOTS"]),
419         ):
420             self.assertEqual(
421                 snapper._get_jid_snapshots(
422                     "20160607130930720112"
423                 ),  # pylint: disable=protected-access
424                 (MODULE_RET["SNAPSHOTS"][0]["id"], MODULE_RET["SNAPSHOTS"][1]["id"]),
425             )
426     def test_undo_jid(self):
427         with patch(
428             "salt.modules.snapper._get_jid_snapshots", MagicMock(return_value=(42, 43))
429         ), patch(
430             "salt.modules.snapper.undo",
431             MagicMock(return_value="create:1 modify:1 delete:1"),
432         ):
433             self.assertEqual(
434                 snapper.undo_jid(20160607130930720112), "create:1 modify:1 delete:1"
435             )
436     def test_diff_text_file(self):
437         with patch(
438             "salt.modules.snapper._get_num_interval", MagicMock(return_value=(42, 43))
439         ), patch(
440             "salt.modules.snapper.snapper.MountSnapshot",
441             MagicMock(side_effect=["/.snapshots/55/snapshot", ""]),
442         ), patch(
443             "salt.modules.snapper.snapper.UmountSnapshot", MagicMock(return_value="")
444         ), patch(
445             "os.path.isdir", MagicMock(return_value=False)
446         ), patch(
447             "salt.modules.snapper.changed_files", MagicMock(return_value=["/tmp/foo2"])
448         ), patch(
449             "salt.modules.snapper._is_text_file", MagicMock(return_value=True)
450         ), patch(
451             "os.path.isfile", MagicMock(side_effect=[False, True])
452         ), patch(
453             "salt.utils.files.fopen",
454             mock_open(read_data=FILE_CONTENT["/tmp/foo2"]["post"]),
455         ), patch(
456             "salt.modules.snapper.snapper.ListConfigs",
457             MagicMock(return_value=DBUS_RET["ListConfigs"]),
458         ):
459             if sys.version_info &lt; (2, 7):
460                 self.assertEqual(
461                     snapper.diff(), {"/tmp/foo2": MODULE_RET["DIFF"]["/tmp/foo26"]}
462                 )
463             else:
464                 self.assertEqual(
465                     snapper.diff(), {"/tmp/foo2": MODULE_RET["DIFF"]["/tmp/foo2"]}
466                 )
467     @skipIf(sys.version_info &lt; (2, 7), "Python 2.7 required to compare diff properly")
468     def test_diff_text_files(self):
469         with patch(
470             "salt.modules.snapper._get_num_interval", MagicMock(return_value=(55, 0))
471         ), patch(
472             "salt.modules.snapper.snapper.MountSnapshot",
473             MagicMock(
474                 side_effect=[
475                     "/.snapshots/55/snapshot",
476                     "",
477                     "/.snapshots/55/snapshot",
478                     "",
479                 ]
480             ),
481         ), patch(
482             "salt.modules.snapper.snapper.UmountSnapshot", MagicMock(return_value="")
483         ), patch(
484             "salt.modules.snapper.changed_files",
485             MagicMock(return_value=["/tmp/foo", "/tmp/foo2"]),
486         ), patch(
487             "salt.modules.snapper._is_text_file", MagicMock(return_value=True)
488         ), patch(
489             "os.path.isfile", MagicMock(side_effect=[True, True, False, True])
490         ), patch(
491             "os.path.isdir", MagicMock(return_value=False)
492         ), patch(
493             "salt.modules.snapper.snapper.ListConfigs",
494             MagicMock(return_value=DBUS_RET["ListConfigs"]),
495         ):
496             contents = {
497                 "*/tmp/foo": [
498                     FILE_CONTENT["/tmp/foo"]["pre"],
499                     FILE_CONTENT["/tmp/foo"]["post"],
500                 ],
501                 "*/tmp/foo2": FILE_CONTENT["/tmp/foo2"]["post"],
502             }
503             with patch("salt.utils.files.fopen", mock_open(read_data=contents)):
504                 module_ret = {
505                     "/tmp/foo": MODULE_RET["DIFF"]["/tmp/foo"],
506                     "/tmp/foo2": MODULE_RET["DIFF"]["/tmp/foo2"],
507                 }
508                 self.assertEqual(snapper.diff(), module_ret)
509     def test_diff_binary_files(self):
510         with patch(
511             "salt.modules.snapper._get_num_interval", MagicMock(return_value=(55, 0))
512         ), patch(
513             "salt.modules.snapper.snapper.MountSnapshot",
514             MagicMock(
515                 side_effect=[
516                     "/.snapshots/55/snapshot",
517                     "",
518                     "/.snapshots/55/snapshot",
519                     "",
520                 ]
521             ),
522         ), patch(
523             "salt.modules.snapper.snapper.UmountSnapshot", MagicMock(return_value="")
524         ), patch(
525             "salt.modules.snapper.changed_files", MagicMock(return_value=["/tmp/foo3"])
526         ), patch(
527             "salt.modules.snapper._is_text_file", MagicMock(return_value=False)
528         ), patch(
529             "os.path.isfile", MagicMock(side_effect=[True, True])
530         ), patch(
531             "os.path.isdir", MagicMock(return_value=False)
532         ), patch(
533             "salt.modules.snapper.snapper.ListConfigs",
534             MagicMock(return_value=DBUS_RET["ListConfigs"]),
535         ), patch.dict(
536             snapper.__salt__,
537             {
538                 "hashutil.sha256_digest": MagicMock(
539                     side_effect=[
540                         "e61f8b762d83f3b4aeb3689564b0ffbe54fa731a69a1e208dc9440ce0f69d19b",
541                         "f18f971f1517449208a66589085ddd3723f7f6cefb56c141e3d97ae49e1d87fa",
542                     ]
543                 )
544             },
545         ):
546             with patch("salt.utils.files.fopen", mock_open(read_data="dummy binary")):
547                 module_ret = {
548                     "/tmp/foo3": MODULE_RET["DIFF"]["/tmp/foo3"],
549                 }
550                 self.assertEqual(snapper.diff(), module_ret)
551     @skipIf(salt.utils.platform.is_linux() is False, "This is a linux only test")
552     @with_tempfile()
553     def test__is_text_file(self, tempfile):
554         with salt.utils.files.fopen(tempfile, "w") as wfh:
555             wfh.write(
556                 "Once upon a time there was an old Sow with three little Pigs, and "
557                 "as she had not enough to keep them, she sent them out to seek their "
558                 "fortune.\n"
559             )
560         assert snapper._is_text_file(tempfile) is True
561         with salt.utils.files.fopen(tempfile, "wb") as wfh:
562             wfh.write(
563                 b"C\x07\xd6\x13\xe5_\x99D\xeb\xd7v\xc1\x96p\x84\xd2{a\x03++\r\xcd/"
564                 b"\xdb\x98\xda\xf7H\xf8\xfb-\x95\xa9}|^\t\xddx\x1c\x18s\x1bZ\x86\x8a(S\xe4"
565             )
566         assert snapper._is_text_file(tempfile) is False
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
