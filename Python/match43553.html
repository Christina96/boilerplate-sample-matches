<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_zpool.py & test_snapper.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_zpool.py & test_snapper.py
      </h3>
      <h1 align="center">
        6.3%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_zpool.py (7.4394464%)<TH>test_snapper.py (5.5198975%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match43553-0.html#0',2,'match43553-1.html#0',3)" NAME="0">(360-382)<TD><A HREF="javascript:ZweiFrames('match43553-0.html#0',2,'match43553-1.html#0',3)" NAME="0">(90-176)</A><TD ALIGN=center><FONT COLOR="#ff0000">24</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match43553-0.html#1',2,'match43553-1.html#1',3)" NAME="1">(464-486)<TD><A HREF="javascript:ZweiFrames('match43553-0.html#1',2,'match43553-1.html#1',3)" NAME="1">(21-85)</A><TD ALIGN=center><FONT COLOR="#c90000">19</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_zpool.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
Tests for salt.states.zpool

:codeauthor:    Jorge Schrauwen &lt;sjorge@blackdot.be&gt;
:maintainer:    Jorge Schrauwen &lt;sjorge@blackdot.be&gt;
:maturity:      new
:depends:       salt.utils.zfs, salt.modules.zpool
:platform:      illumos,freebsd,linux
&quot;&quot;&quot;

import pytest
import salt.config
import salt.loader
import salt.states.zpool as zpool
import salt.utils.zfs
from salt.utils.odict import OrderedDict
from tests.support.mock import MagicMock, patch
from tests.support.zfs import ZFSMockData


@pytest.fixture
def utils_patch():
    return ZFSMockData().get_patched_utils()


@pytest.fixture
def configure_loader_modules():
    opts = salt.config.DEFAULT_MINION_OPTS.copy()
    utils = salt.loader.utils(opts, whitelist=[&quot;zfs&quot;])
    zpool_obj = {
        zpool: {
            &quot;__opts__&quot;: opts,
            &quot;__grains__&quot;: {&quot;kernel&quot;: &quot;SunOS&quot;},
            &quot;__utils__&quot;: utils,
        }
    }

    return zpool_obj


def test_absent_without_pool(utils_patch):
    &quot;&quot;&quot;
    Test zpool absent without a pool
    &quot;&quot;&quot;
    ret = {
        &quot;name&quot;: &quot;myzpool&quot;,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;storage pool myzpool is absent&quot;,
        &quot;changes&quot;: {},
    }

    mock_exists = MagicMock(return_value=False)
    with patch.dict(zpool.__salt__, {&quot;zpool.exists&quot;: mock_exists}), patch.dict(
        zpool.__utils__, utils_patch
    ):
        assert zpool.absent(&quot;myzpool&quot;) == ret


def test_absent_destroy_pool(utils_patch):
    &quot;&quot;&quot;
    Test zpool absent destroying pool
    &quot;&quot;&quot;
    ret = {
        &quot;name&quot;: &quot;myzpool&quot;,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;storage pool myzpool was destroyed&quot;,
        &quot;changes&quot;: {&quot;myzpool&quot;: &quot;destroyed&quot;},
    }

    mock_exists = MagicMock(return_value=True)
    mock_destroy = MagicMock(return_value=OrderedDict([(&quot;destroyed&quot;, True)]))
    with patch.dict(zpool.__salt__, {&quot;zpool.exists&quot;: mock_exists}), patch.dict(
        zpool.__salt__, {&quot;zpool.destroy&quot;: mock_destroy}
    ), patch.dict(zpool.__utils__, utils_patch):
        assert zpool.absent(&quot;myzpool&quot;) == ret


def test_absent_exporty_pool(utils_patch):
    &quot;&quot;&quot;
    Test zpool absent exporting pool
    &quot;&quot;&quot;
    ret = {
        &quot;name&quot;: &quot;myzpool&quot;,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;storage pool myzpool was exported&quot;,
        &quot;changes&quot;: {&quot;myzpool&quot;: &quot;exported&quot;},
    }

    mock_exists = MagicMock(return_value=True)
    mock_destroy = MagicMock(return_value=OrderedDict([(&quot;exported&quot;, True)]))
    with patch.dict(zpool.__salt__, {&quot;zpool.exists&quot;: mock_exists}), patch.dict(
        zpool.__salt__, {&quot;zpool.export&quot;: mock_destroy}
    ), patch.dict(zpool.__utils__, utils_patch):
        assert zpool.absent(&quot;myzpool&quot;, export=True) == ret


def test_absent_busy(utils_patch):
    &quot;&quot;&quot;
    Test zpool absent on a busy pool
    &quot;&quot;&quot;
    ret = {
        &quot;name&quot;: &quot;myzpool&quot;,
        &quot;result&quot;: False,
        &quot;comment&quot;: &quot;\n&quot;.join(
            [
                &quot;cannot unmount '/myzpool': Device busy&quot;,
                &quot;cannot export 'myzpool': pool is busy&quot;,
            ]
        ),
        &quot;changes&quot;: {},
    }

    mock_exists = MagicMock(return_value=True)
    mock_destroy = MagicMock(
        return_value=OrderedDict(
            [
                (&quot;exported&quot;, False),
                (
                    &quot;error&quot;,
                    &quot;\n&quot;.join(
                        [
                            &quot;cannot unmount '/myzpool': Device busy&quot;,
                            &quot;cannot export 'myzpool': pool is busy&quot;,
                        ]
                    ),
                ),
            ]
        )
    )
    with patch.dict(zpool.__salt__, {&quot;zpool.exists&quot;: mock_exists}), patch.dict(
        zpool.__salt__, {&quot;zpool.export&quot;: mock_destroy}
    ), patch.dict(zpool.__utils__, utils_patch):
        assert zpool.absent(&quot;myzpool&quot;, export=True) == ret


def test_present_import_success(utils_patch):
    &quot;&quot;&quot;
    Test zpool present with import allowed and unimported pool
    &quot;&quot;&quot;
    ret = {
        &quot;name&quot;: &quot;myzpool&quot;,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;storage pool myzpool was imported&quot;,
        &quot;changes&quot;: {&quot;myzpool&quot;: &quot;imported&quot;},
    }

    config = {
        &quot;import&quot;: True,
    }

    mock_exists = MagicMock(return_value=False)
    mock_import = MagicMock(return_value=OrderedDict([(&quot;imported&quot;, True)]))
    with patch.dict(zpool.__salt__, {&quot;zpool.exists&quot;: mock_exists}), patch.dict(
        zpool.__salt__, {&quot;zpool.import&quot;: mock_import}
    ), patch.dict(zpool.__utils__, utils_patch):
        assert zpool.present(&quot;myzpool&quot;, config=config) == ret


def test_present_import_fail(utils_patch):
    &quot;&quot;&quot;
    Test zpool present with import allowed and no unimported pool or layout
    &quot;&quot;&quot;
    ret = {
        &quot;name&quot;: &quot;myzpool&quot;,
        &quot;result&quot;: False,
        &quot;comment&quot;: (
            &quot;storage pool myzpool was not imported, no (valid) layout specified for&quot;
            &quot; creation&quot;
        ),
        &quot;changes&quot;: {},
    }

    config = {
        &quot;import&quot;: True,
    }

    mock_exists = MagicMock(return_value=False)
    mock_import = MagicMock(return_value=OrderedDict([(&quot;imported&quot;, False)]))
    with patch.dict(zpool.__salt__, {&quot;zpool.exists&quot;: mock_exists}), patch.dict(
        zpool.__salt__, {&quot;zpool.import&quot;: mock_import}
    ), patch.dict(zpool.__utils__, utils_patch):
        assert zpool.present(&quot;myzpool&quot;, config=config) == ret


def test_present_create_success(utils_patch):
    &quot;&quot;&quot;
    Test zpool present with non existing pool
    &quot;&quot;&quot;
    ret = {
        &quot;name&quot;: &quot;myzpool&quot;,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;storage pool myzpool was created&quot;,
        &quot;changes&quot;: {&quot;myzpool&quot;: &quot;created&quot;},
    }

    config = {
        &quot;import&quot;: False,
    }
    layout = [
        OrderedDict([(&quot;mirror&quot;, [&quot;disk0&quot;, &quot;disk1&quot;])]),
        OrderedDict([(&quot;mirror&quot;, [&quot;disk2&quot;, &quot;disk3&quot;])]),
    ]
    properties = {
        &quot;autoexpand&quot;: True,
    }
    filesystem_properties = {
        &quot;quota&quot;: &quot;5G&quot;,
    }

    mock_exists = MagicMock(return_value=False)
    mock_create = MagicMock(
        return_value=OrderedDict(
            [
                (&quot;created&quot;, True),
                (
                    &quot;vdevs&quot;,
                    OrderedDict(
                        [
                            (&quot;mirror-0&quot;, [&quot;/dev/dsk/disk0&quot;, &quot;/dev/dsk/disk1&quot;]),
                            (&quot;mirror-1&quot;, [&quot;/dev/dsk/disk2&quot;, &quot;/dev/dsk/disk3&quot;]),
                        ]
                    ),
                ),
            ]
        )
    )
    with patch.dict(zpool.__salt__, {&quot;zpool.exists&quot;: mock_exists}), patch.dict(
        zpool.__salt__, {&quot;zpool.create&quot;: mock_create}
    ), patch.dict(zpool.__utils__, utils_patch):
        assert (
            zpool.present(
                &quot;myzpool&quot;,
                config=config,
                layout=layout,
                properties=properties,
                filesystem_properties=filesystem_properties,
            )
            == ret
        )


def test_present_create_fail(utils_patch):
    &quot;&quot;&quot;
    Test zpool present with non existing pool (without a layout)
    &quot;&quot;&quot;
    ret = {
        &quot;name&quot;: &quot;myzpool&quot;,
        &quot;result&quot;: False,
        &quot;comment&quot;: (
            &quot;storage pool myzpool was not imported, no (valid) layout specified for&quot;
            &quot; creation&quot;
        ),
        &quot;changes&quot;: {},
    }

    config = {
        &quot;import&quot;: False,
    }

    mock_exists = MagicMock(return_value=False)
    with patch.dict(zpool.__salt__, {&quot;zpool.exists&quot;: mock_exists}), patch.dict(
        zpool.__utils__, utils_patch
    ):
        assert zpool.present(&quot;myzpool&quot;, config=config) == ret


def test_present_create_passthrough_fail(utils_patch):
    &quot;&quot;&quot;
    Test zpool present with non existing pool (without a layout)
    &quot;&quot;&quot;
    ret = {
        &quot;name&quot;: &quot;myzpool&quot;,
        &quot;result&quot;: False,
        &quot;comment&quot;: &quot;\n&quot;.join(
            [
                &quot;invalid vdev specification&quot;,
                &quot;use 'force=True' to override the following errors:&quot;,
                &quot;/data/salt/vdisk0 is part of exported pool 'zsalt'&quot;,
                &quot;/data/salt/vdisk1 is part of exported pool 'zsalt'&quot;,
            ]
        ),
        &quot;changes&quot;: {},
    }

    config = {
        &quot;force&quot;: False,
        &quot;import&quot;: False,
    }
    layout = [
        OrderedDict([(&quot;mirror&quot;, [&quot;disk0&quot;, &quot;disk1&quot;])]),
        OrderedDict([(&quot;mirror&quot;, [&quot;disk2&quot;, &quot;disk3&quot;])]),
    ]
    properties = {
        &quot;autoexpand&quot;: True,
    }
    filesystem_properties = {
        &quot;quota&quot;: &quot;5G&quot;,
    }

    mock_exists = MagicMock(return_value=False)
    mock_create = MagicMock(
        return_value=OrderedDict(
            [
                (&quot;created&quot;, False),
                (
                    &quot;error&quot;,
                    &quot;\n&quot;.join(
                        [
                            &quot;invalid vdev specification&quot;,
                            &quot;use 'force=True' to override the following errors:&quot;,
                            &quot;/data/salt/vdisk0 is part of exported pool 'zsalt'&quot;,
                            &quot;/data/salt/vdisk1 is part of exported pool 'zsalt'&quot;,
                        ]
                    ),
                ),
            ]
        )
    )
    with patch.dict(zpool.__salt__, {&quot;zpool.exists&quot;: mock_exists}), patch.dict(
        zpool.__salt__, {&quot;zpool.create&quot;: mock_create}
    ), patch.dict(zpool.__utils__, utils_patch):
        assert (
            zpool.present(
                &quot;myzpool&quot;,
                config=config,
                layout=layout,
                properties=properties,
                filesystem_properties=filesystem_properties,
            )
            == ret
        )


def test_present_update_success(utils_patch):
    &quot;&quot;&quot;
    Test zpool present with an existing pool that needs an update
    &quot;&quot;&quot;
    ret = {
        &quot;name&quot;: &quot;myzpool&quot;,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;properties updated&quot;,
        &quot;changes&quot;: {&quot;myzpool&quot;: {&quot;autoexpand&quot;: False}},
    }

    config = {
        &quot;import&quot;: False,
    }
    layout = [
        OrderedDict([(&quot;mirror&quot;, [&quot;disk0&quot;, &quot;disk1&quot;])]),
        OrderedDict([(&quot;mirror&quot;, [&quot;disk2&quot;, &quot;disk3&quot;])]),
    ]
    properties = {
        &quot;autoexpand&quot;: False,
    }

    mock_exists = MagicMock(return_value=True)
<A NAME="0"></A>    mock_get = MagicMock(
        return_value=OrderedDict(
            [
                <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match43553-1.html#0',3,'match43553-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>(&quot;comment&quot;, &quot;salt managed pool&quot;),
                (&quot;freeing&quot;, 0),
                (&quot;listsnapshots&quot;, False),
                (&quot;leaked&quot;, 0),
                (&quot;feature@obsolete_counts&quot;, &quot;enabled&quot;),
                (&quot;feature@sha512&quot;, &quot;enabled&quot;),
                (&quot;delegation&quot;, True),
                (&quot;dedupditto&quot;, &quot;0&quot;),
                (&quot;dedupratio&quot;, &quot;1.00x&quot;),
                (&quot;autoexpand&quot;, True),
                (&quot;feature@bookmarks&quot;, &quot;enabled&quot;),
                (&quot;allocated&quot;, 115712),
                (&quot;guid&quot;, 1591906802560842214),
                (&quot;feature@large_blocks&quot;, &quot;enabled&quot;),
                (&quot;size&quot;, 2113929216),
                (&quot;feature@enabled_txg&quot;, &quot;active&quot;),
                (&quot;feature@hole_birth&quot;, &quot;active&quot;),
                (&quot;capacity&quot;, 0),
                (&quot;feature@multi_vdev_crash_dump&quot;, &quot;enabled&quot;),
                (&quot;feature@extensible_dataset&quot;, &quot;enabled&quot;),
                (&quot;cachefile&quot;, &quot;-&quot;),
                (&quot;bootfs&quot;, &quot;-&quot;),
                (&quot;autoreplace&quot;</B></FONT>, True),
                (&quot;readonly&quot;, False),
                (&quot;version&quot;, &quot;-&quot;),
                (&quot;health&quot;, &quot;ONLINE&quot;),
                (&quot;expandsize&quot;, &quot;-&quot;),
                (&quot;feature@embedded_data&quot;, &quot;active&quot;),
                (&quot;feature@lz4_compress&quot;, &quot;active&quot;),
                (&quot;feature@async_destroy&quot;, &quot;enabled&quot;),
                (&quot;feature@skein&quot;, &quot;enabled&quot;),
                (&quot;feature@empty_bpobj&quot;, &quot;enabled&quot;),
                (&quot;feature@spacemap_histogram&quot;, &quot;active&quot;),
                (&quot;bootsize&quot;, &quot;-&quot;),
                (&quot;free&quot;, 2113813504),
                (&quot;feature@device_removal&quot;, &quot;enabled&quot;),
                (&quot;failmode&quot;, &quot;wait&quot;),
                (&quot;feature@filesystem_limits&quot;, &quot;enabled&quot;),
                (&quot;feature@edonr&quot;, &quot;enabled&quot;),
                (&quot;altroot&quot;, &quot;-&quot;),
                (&quot;fragmentation&quot;, &quot;0%&quot;),
            ]
        )
    )
    mock_set = MagicMock(return_value=OrderedDict([(&quot;set&quot;, True)]))
    with patch.dict(zpool.__salt__, {&quot;zpool.exists&quot;: mock_exists}), patch.dict(
        zpool.__salt__, {&quot;zpool.get&quot;: mock_get}
    ), patch.dict(zpool.__salt__, {&quot;zpool.set&quot;: mock_set}), patch.dict(
        zpool.__utils__, utils_patch
    ):
        assert (
            zpool.present(
                &quot;myzpool&quot;,
                config=config,
                layout=layout,
                properties=properties,
            )
            == ret
        )


def test_present_update_nochange_success(utils_patch):
    &quot;&quot;&quot;
    Test zpool present with non existing pool
    &quot;&quot;&quot;
    config = {
        &quot;import&quot;: False,
    }
    layout = [
        OrderedDict([(&quot;mirror&quot;, [&quot;disk0&quot;, &quot;disk1&quot;])]),
        OrderedDict([(&quot;mirror&quot;, [&quot;disk2&quot;, &quot;disk3&quot;])]),
    ]
    properties = {
        &quot;autoexpand&quot;: True,
    }

    mock_exists = MagicMock(return_value=True)
    mock_get = MagicMock(
        return_value=OrderedDict(
            [
                (&quot;comment&quot;, &quot;salt managed pool&quot;),
                (&quot;freeing&quot;, 0),
                (&quot;listsnapshots&quot;, False),
                (&quot;leaked&quot;, 0),
                (&quot;feature@obsolete_counts&quot;, &quot;enabled&quot;),
                (&quot;feature@sha512&quot;, &quot;enabled&quot;),
                (&quot;delegation&quot;, True),
                (&quot;dedupditto&quot;, &quot;0&quot;),
                (&quot;dedupratio&quot;, &quot;1.00x&quot;),
                (&quot;autoexpand&quot;, True),
                (&quot;feature@bookmarks&quot;, &quot;enabled&quot;),
                (&quot;allocated&quot;, 115712),
                (&quot;guid&quot;, 1591906802560842214),
                (&quot;feature@large_blocks&quot;, &quot;enabled&quot;),
                (&quot;size&quot;, 2113929216),
                (&quot;feature@enabled_txg&quot;, &quot;active&quot;),
                (&quot;feature@hole_birth&quot;, &quot;active&quot;),
                (&quot;capacity&quot;, 0),
                (&quot;feature@multi_vdev_crash_dump&quot;, &quot;enabled&quot;),
                (&quot;feature@extensible_dataset&quot;, &quot;enabled&quot;),
                (&quot;cachefile&quot;, &quot;-&quot;),
<A NAME="1"></A>                (&quot;bootfs&quot;, &quot;-&quot;),
                (&quot;autoreplace&quot;, True),
                (&quot;readonly&quot;, False),
                (<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match43553-1.html#1',3,'match43553-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>&quot;version&quot;, &quot;-&quot;),
                (&quot;health&quot;, &quot;ONLINE&quot;),
                (&quot;expandsize&quot;, &quot;-&quot;),
                (&quot;feature@embedded_data&quot;, &quot;active&quot;),
                (&quot;feature@lz4_compress&quot;, &quot;active&quot;),
                (&quot;feature@async_destroy&quot;, &quot;enabled&quot;),
                (&quot;feature@skein&quot;, &quot;enabled&quot;),
                (&quot;feature@empty_bpobj&quot;, &quot;enabled&quot;),
                (&quot;feature@spacemap_histogram&quot;, &quot;active&quot;),
                (&quot;bootsize&quot;, &quot;-&quot;),
                (&quot;free&quot;, 2113813504),
                (&quot;feature@device_removal&quot;, &quot;enabled&quot;),
                (&quot;failmode&quot;, &quot;wait&quot;),
                (&quot;feature@filesystem_limits&quot;, &quot;enabled&quot;),
                (&quot;feature@edonr&quot;, &quot;enabled&quot;),
                (&quot;altroot&quot;, &quot;-&quot;),
                (&quot;fragmentation&quot;, &quot;0%&quot;),
            ]
        )
    )

    ret = {
        &quot;name&quot;</B></FONT>: &quot;myzpool&quot;,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;no update needed&quot;,
        &quot;changes&quot;: {},
    }

    with patch.dict(zpool.__salt__, {&quot;zpool.exists&quot;: mock_exists}):
        with patch.dict(zpool.__salt__, {&quot;zpool.get&quot;: mock_get}):
            with patch.dict(zpool.__utils__, utils_patch):
                assert (
                    zpool.present(
                        &quot;myzpool&quot;,
                        config=config,
                        layout=layout,
                        properties=properties,
                    )
                    == ret
                )

    # Run state with test=true
    ret = {
        &quot;name&quot;: &quot;myzpool&quot;,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;storage pool myzpool is uptodate&quot;,
        &quot;changes&quot;: {},
    }

    with patch.dict(zpool.__salt__, {&quot;zpool.exists&quot;: mock_exists}):
        with patch.dict(zpool.__salt__, {&quot;zpool.get&quot;: mock_get}):
            with patch.dict(zpool.__utils__, utils_patch):
                with patch.dict(zpool.__opts__, {&quot;test&quot;: True}):
                    assert (
                        zpool.present(
                            &quot;myzpool&quot;,
                            config=config,
                            layout=layout,
                            properties=properties,
                        )
                        == ret
                    )
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_snapper.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
Unit tests for the Snapper module

:codeauthor:    Duncan Mac-Vicar P. &lt;dmacvicar@suse.de&gt;
:codeauthor:    Pablo Suárez Hernández &lt;psuarezhernandez@suse.de&gt;
&quot;&quot;&quot;


import sys

import salt.modules.snapper as snapper
import salt.utils.files
import salt.utils.platform
from salt.exceptions import CommandExecutionError
from tests.support.helpers import with_tempfile
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import MagicMock, mock_open, patch
<A NAME="1"></A>from tests.support.unit import TestCase, skipIf

DBUS_RET = {
    <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match43553-0.html#1',2,'match43553-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>&quot;ListSnapshots&quot;: [
        [
            42,
            1,
            0,
            1457006571,
            0,
            &quot;Some description&quot;,
            &quot;&quot;,
            {&quot;userdata1&quot;: &quot;userval1&quot;, &quot;salt_jid&quot;: &quot;20160607130930720112&quot;},
        ],
        [
            43,
            2,
            42,
            1457006572,
            0,
            &quot;Blah Blah&quot;,
            &quot;&quot;,
            {&quot;userdata2&quot;: &quot;userval2&quot;, &quot;salt_jid&quot;: &quot;20160607130930720112&quot;},
        ],
    ],
    &quot;ListConfigs&quot;: [
        [
            &quot;root&quot;,
            &quot;/&quot;,
            {
                &quot;SUBVOLUME&quot;: &quot;/&quot;,
                &quot;NUMBER_MIN_AGE&quot;: &quot;1800&quot;,
                &quot;TIMELINE_LIMIT_YEARLY&quot;: &quot;4-10&quot;,
                &quot;NUMBER_LIMIT_IMPORTANT&quot;: &quot;10&quot;,
                &quot;FSTYPE&quot;: &quot;btrfs&quot;,
                &quot;TIMELINE_LIMIT_MONTHLY&quot;: &quot;4-10&quot;,
                &quot;ALLOW_GROUPS&quot;: &quot;&quot;,
                &quot;EMPTY_PRE_POST_MIN_AGE&quot;: &quot;1800&quot;,
                &quot;EMPTY_PRE_POST_CLEANUP&quot;: &quot;yes&quot;,
                &quot;BACKGROUND_COMPARISON&quot;: &quot;yes&quot;,
                &quot;TIMELINE_LIMIT_HOURLY&quot;: &quot;4-10&quot;,
                &quot;ALLOW_USERS&quot;: &quot;&quot;,
                &quot;TIMELINE_LIMIT_WEEKLY&quot;: &quot;0&quot;,
                &quot;TIMELINE_CREATE&quot;: &quot;no&quot;,
                &quot;NUMBER_CLEANUP&quot;: &quot;yes&quot;,
                &quot;TIMELINE_CLEANUP&quot;: &quot;yes&quot;,
                &quot;SPACE_LIMIT&quot;: &quot;0.5&quot;,
                &quot;NUMBER_LIMIT&quot;: &quot;10&quot;,
                &quot;TIMELINE_MIN_AGE&quot;: &quot;1800&quot;,
                &quot;TIMELINE_LIMIT_DAILY&quot;: &quot;4-10&quot;,
                &quot;SYNC_ACL&quot;: &quot;no&quot;,
                &quot;QGROUP&quot;: &quot;1/0&quot;,
            },
        ]
    ],
    &quot;GetFiles&quot;: [
        [&quot;/root/.viminfo&quot;, 8],
        [&quot;/tmp/foo&quot;, 52],
        [&quot;/tmp/foo2&quot;, 1],
        [&quot;/tmp/foo3&quot;, 2],
        [&quot;/var/log/snapper.log&quot;, 8],
        [&quot;/var/cache/salt/minion/extmods/modules/snapper.py&quot;, 8],
        [&quot;/var/cache/salt/minion/extmods/modules/snapper.pyc&quot;, 8],
    ],
}

FILE_CONTENT = {
    &quot;/tmp/foo&quot;</B></FONT>: {&quot;pre&quot;: &quot;dummy text&quot;, &quot;post&quot;: &quot;another foobar&quot;},
    &quot;/tmp/foo2&quot;: {&quot;post&quot;: &quot;another foobar&quot;},
<A NAME="0"></A>}

MODULE_RET = {
    <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match43553-0.html#0',2,'match43553-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>&quot;SNAPSHOTS&quot;: [
        {
            &quot;userdata&quot;: {&quot;userdata1&quot;: &quot;userval1&quot;, &quot;salt_jid&quot;: &quot;20160607130930720112&quot;},
            &quot;description&quot;: &quot;Some description&quot;,
            &quot;timestamp&quot;: 1457006571,
            &quot;cleanup&quot;: &quot;&quot;,
            &quot;user&quot;: &quot;root&quot;,
            &quot;type&quot;: &quot;pre&quot;,
            &quot;id&quot;: 42,
        },
        {
            &quot;pre&quot;: 42,
            &quot;userdata&quot;: {&quot;userdata2&quot;: &quot;userval2&quot;, &quot;salt_jid&quot;: &quot;20160607130930720112&quot;},
            &quot;description&quot;: &quot;Blah Blah&quot;,
            &quot;timestamp&quot;: 1457006572,
            &quot;cleanup&quot;: &quot;&quot;,
            &quot;user&quot;: &quot;root&quot;,
            &quot;type&quot;: &quot;post&quot;,
            &quot;id&quot;: 43,
        },
    ],
    &quot;LISTCONFIGS&quot;: {
        &quot;root&quot;: {
            &quot;SUBVOLUME&quot;: &quot;/&quot;,
            &quot;NUMBER_MIN_AGE&quot;: &quot;1800&quot;,
            &quot;TIMELINE_LIMIT_YEARLY&quot;: &quot;4-10&quot;,
            &quot;NUMBER_LIMIT_IMPORTANT&quot;: &quot;10&quot;,
            &quot;FSTYPE&quot;: &quot;btrfs&quot;,
            &quot;TIMELINE_LIMIT_MONTHLY&quot;: &quot;4-10&quot;,
            &quot;ALLOW_GROUPS&quot;: &quot;&quot;,
            &quot;EMPTY_PRE_POST_MIN_AGE&quot;: &quot;1800&quot;,
            &quot;EMPTY_PRE_POST_CLEANUP&quot;: &quot;yes&quot;,
            &quot;BACKGROUND_COMPARISON&quot;: &quot;yes&quot;,
            &quot;TIMELINE_LIMIT_HOURLY&quot;: &quot;4-10&quot;,
            &quot;ALLOW_USERS&quot;: &quot;&quot;,
            &quot;TIMELINE_LIMIT_WEEKLY&quot;: &quot;0&quot;,
            &quot;TIMELINE_CREATE&quot;: &quot;no&quot;,
            &quot;NUMBER_CLEANUP&quot;: &quot;yes&quot;,
            &quot;TIMELINE_CLEANUP&quot;: &quot;yes&quot;,
            &quot;SPACE_LIMIT&quot;: &quot;0.5&quot;,
            &quot;NUMBER_LIMIT&quot;: &quot;10&quot;,
            &quot;TIMELINE_MIN_AGE&quot;: &quot;1800&quot;,
            &quot;TIMELINE_LIMIT_DAILY&quot;: &quot;4-10&quot;,
            &quot;SYNC_ACL&quot;: &quot;no&quot;,
            &quot;QGROUP&quot;: &quot;1/0&quot;,
        }
    },
    &quot;GETFILES&quot;: {
        &quot;/root/.viminfo&quot;: {&quot;status&quot;: [&quot;modified&quot;]},
        &quot;/tmp/foo&quot;: {&quot;status&quot;: [&quot;type changed&quot;, &quot;permission changed&quot;, &quot;owner changed&quot;]},
        &quot;/tmp/foo2&quot;: {&quot;status&quot;: [&quot;created&quot;]},
        &quot;/tmp/foo3&quot;: {&quot;status&quot;: [&quot;deleted&quot;]},
        &quot;/var/log/snapper.log&quot;: {&quot;status&quot;: [&quot;modified&quot;]},
        &quot;/var/cache/salt/minion/extmods/modules/snapper.py&quot;: {&quot;status&quot;: [&quot;modified&quot;]},
        &quot;/var/cache/salt/minion/extmods/modules/snapper.pyc&quot;: {&quot;status&quot;: [&quot;modified&quot;]},
    },
    &quot;DIFF&quot;: {
        &quot;/tmp/foo&quot;: {
            &quot;comment&quot;: &quot;text file changed&quot;,
            &quot;diff&quot;: (
                &quot;--- /.snapshots/55/snapshot/tmp/foo\n&quot;
                &quot;+++ /tmp/foo\n&quot;
                &quot;@@ -1 +1 @@\n&quot;
                &quot;-dummy text&quot;
                &quot;+another foobar&quot;
            ),
        },
        &quot;/tmp/foo2&quot;: {
            &quot;comment&quot;: &quot;text file created&quot;,
            &quot;diff&quot;: (
                &quot;--- /.snapshots/55/snapshot/tmp/foo2\n&quot;
                &quot;+++ /tmp/foo2\n&quot;
                &quot;@@ -0,0 +1 @@\n&quot;
                &quot;+another foobar&quot;
            ),
        },
        &quot;/tmp/foo26&quot;: {
            &quot;comment&quot;: &quot;text file created&quot;,
            &quot;diff&quot;: (
                &quot;--- /.snapshots/55/snapshot/tmp/foo2 \n&quot;
                &quot;+++ /tmp/foo2 \n&quot;
                &quot;@@ -1,0 +1,1 @@\n&quot;
                &quot;+another foobar&quot;
            ),
        },
        &quot;/tmp/foo3&quot;: {
            &quot;comment&quot;</B></FONT>: &quot;binary file changed&quot;,
            &quot;old_sha256_digest&quot;: (
                &quot;e61f8b762d83f3b4aeb3689564b0ffbe54fa731a69a1e208dc9440ce0f69d19b&quot;
            ),
            &quot;new_sha256_digest&quot;: (
                &quot;f18f971f1517449208a66589085ddd3723f7f6cefb56c141e3d97ae49e1d87fa&quot;
            ),
        },
    },
}


@skipIf(sys.platform.startswith(&quot;win&quot;), &quot;Snapper not available on Windows&quot;)
class SnapperTestCase(TestCase, LoaderModuleMockMixin):
    def setup_loader_modules(self):
        class DBusException(BaseException):
            get_dbus_name = &quot;foo&quot;

        dbus_mock = MagicMock()
        dbus_mock.configure_mock(DBusException=DBusException)
        return {snapper: {&quot;dbus&quot;: dbus_mock, &quot;snapper&quot;: MagicMock()}}

    def test__snapshot_to_data(self):
        data = snapper._snapshot_to_data(
            DBUS_RET[&quot;ListSnapshots&quot;][0]
        )  # pylint: disable=protected-access
        self.assertEqual(data[&quot;id&quot;], 42)
        self.assertNotIn(&quot;pre&quot;, data)
        self.assertEqual(data[&quot;type&quot;], &quot;pre&quot;)
        self.assertEqual(data[&quot;user&quot;], &quot;root&quot;)
        self.assertEqual(data[&quot;timestamp&quot;], 1457006571)
        self.assertEqual(data[&quot;description&quot;], &quot;Some description&quot;)
        self.assertEqual(data[&quot;cleanup&quot;], &quot;&quot;)
        self.assertEqual(data[&quot;userdata&quot;][&quot;userdata1&quot;], &quot;userval1&quot;)

    def test_list_snapshots(self):
        with patch(
            &quot;salt.modules.snapper.snapper.ListSnapshots&quot;,
            MagicMock(return_value=DBUS_RET[&quot;ListSnapshots&quot;]),
        ):
            self.assertEqual(snapper.list_snapshots(), MODULE_RET[&quot;SNAPSHOTS&quot;])

    def test_get_snapshot(self):
        with patch(
            &quot;salt.modules.snapper.snapper.GetSnapshot&quot;,
            MagicMock(return_value=DBUS_RET[&quot;ListSnapshots&quot;][0]),
        ):
            self.assertEqual(snapper.get_snapshot(), MODULE_RET[&quot;SNAPSHOTS&quot;][0])
            self.assertEqual(
                snapper.get_snapshot(number=42), MODULE_RET[&quot;SNAPSHOTS&quot;][0]
            )
            self.assertNotEqual(
                snapper.get_snapshot(number=42), MODULE_RET[&quot;SNAPSHOTS&quot;][1]
            )

    def test_list_configs(self):
        with patch(
            &quot;salt.modules.snapper.snapper.ListConfigs&quot;,
            MagicMock(return_value=DBUS_RET[&quot;ListConfigs&quot;]),
        ):
            self.assertEqual(snapper.list_configs(), MODULE_RET[&quot;LISTCONFIGS&quot;])

    def test_get_config(self):
        with patch(
            &quot;salt.modules.snapper.snapper.GetConfig&quot;,
            MagicMock(return_value=DBUS_RET[&quot;ListConfigs&quot;][0]),
        ):
            self.assertEqual(snapper.get_config(), DBUS_RET[&quot;ListConfigs&quot;][0])

    def test_set_config(self):
        with patch(&quot;salt.modules.snapper.snapper.SetConfig&quot;, MagicMock()):
            opts = {&quot;sync_acl&quot;: True, &quot;dummy&quot;: False, &quot;foobar&quot;: 1234}
            self.assertEqual(snapper.set_config(opts), True)

    def test_status_to_string(self):
        self.assertEqual(snapper.status_to_string(1), [&quot;created&quot;])
        self.assertEqual(snapper.status_to_string(2), [&quot;deleted&quot;])
        self.assertEqual(snapper.status_to_string(4), [&quot;type changed&quot;])
        self.assertEqual(snapper.status_to_string(8), [&quot;modified&quot;])
        self.assertEqual(snapper.status_to_string(16), [&quot;permission changed&quot;])
        self.assertListEqual(
            snapper.status_to_string(24), [&quot;modified&quot;, &quot;permission changed&quot;]
        )
        self.assertEqual(snapper.status_to_string(32), [&quot;owner changed&quot;])
        self.assertEqual(snapper.status_to_string(64), [&quot;group changed&quot;])
        self.assertListEqual(
            snapper.status_to_string(97), [&quot;created&quot;, &quot;owner changed&quot;, &quot;group changed&quot;]
        )
        self.assertEqual(snapper.status_to_string(128), [&quot;extended attributes changed&quot;])
        self.assertEqual(snapper.status_to_string(256), [&quot;ACL info changed&quot;])

    def test_create_config(self):
        with patch(&quot;salt.modules.snapper.snapper.CreateConfig&quot;, MagicMock()), patch(
            &quot;salt.modules.snapper.snapper.GetConfig&quot;,
            MagicMock(return_value=DBUS_RET[&quot;ListConfigs&quot;][0]),
        ):
            opts = {
                &quot;name&quot;: &quot;testconfig&quot;,
                &quot;subvolume&quot;: &quot;/foo/bar/&quot;,
                &quot;fstype&quot;: &quot;btrfs&quot;,
                &quot;template&quot;: &quot;mytemplate&quot;,
                &quot;extra_opts&quot;: {&quot;NUMBER_CLEANUP&quot;: False},
            }
            with patch(
                &quot;salt.modules.snapper.set_config&quot;, MagicMock()
            ) as set_config_mock:
                self.assertEqual(
                    snapper.create_config(**opts), DBUS_RET[&quot;ListConfigs&quot;][0]
                )
                set_config_mock.assert_called_with(&quot;testconfig&quot;, **opts[&quot;extra_opts&quot;])

            with patch(
                &quot;salt.modules.snapper.set_config&quot;, MagicMock()
            ) as set_config_mock:
                del opts[&quot;extra_opts&quot;]
                self.assertEqual(
                    snapper.create_config(**opts), DBUS_RET[&quot;ListConfigs&quot;][0]
                )
                assert not set_config_mock.called
                self.assertRaises(CommandExecutionError, snapper.create_config)

    def test_create_snapshot(self):
        with patch(
            &quot;salt.modules.snapper.snapper.CreateSingleSnapshot&quot;,
            MagicMock(return_value=1234),
        ), patch(
            &quot;salt.modules.snapper.snapper.CreatePreSnapshot&quot;,
            MagicMock(return_value=1234),
        ), patch(
            &quot;salt.modules.snapper.snapper.CreatePostSnapshot&quot;,
            MagicMock(return_value=1234),
        ):
            for snapshot_type in [&quot;pre&quot;, &quot;post&quot;, &quot;single&quot;]:
                opts = {
                    &quot;__pub_jid&quot;: 20160607130930720112,
                    &quot;type&quot;: snapshot_type,
                    &quot;description&quot;: &quot;Test description&quot;,
                    &quot;cleanup_algorithm&quot;: &quot;number&quot;,
                    &quot;pre_number&quot;: 23,
                }
                self.assertEqual(snapper.create_snapshot(**opts), 1234)

    def test_delete_snapshot_id_success(self):
        with patch(&quot;salt.modules.snapper.snapper.DeleteSnapshots&quot;, MagicMock()), patch(
            &quot;salt.modules.snapper.snapper.ListSnapshots&quot;,
            MagicMock(return_value=DBUS_RET[&quot;ListSnapshots&quot;]),
        ):
            self.assertEqual(
                snapper.delete_snapshot(snapshots_ids=43),
                {&quot;root&quot;: {&quot;ids&quot;: [43], &quot;status&quot;: &quot;deleted&quot;}},
            )
            self.assertEqual(
                snapper.delete_snapshot(snapshots_ids=[42, 43]),
                {&quot;root&quot;: {&quot;ids&quot;: [42, 43], &quot;status&quot;: &quot;deleted&quot;}},
            )

    def test_delete_snapshot_id_fail(self):
        with patch(&quot;salt.modules.snapper.snapper.DeleteSnapshots&quot;, MagicMock()), patch(
            &quot;salt.modules.snapper.snapper.ListSnapshots&quot;,
            MagicMock(return_value=DBUS_RET[&quot;ListSnapshots&quot;]),
        ):
            self.assertRaises(CommandExecutionError, snapper.delete_snapshot)
            self.assertRaises(
                CommandExecutionError, snapper.delete_snapshot, snapshots_ids=1
            )
            self.assertRaises(
                CommandExecutionError, snapper.delete_snapshot, snapshots_ids=[1, 2]
            )

    def test_modify_snapshot(self):
        with patch(&quot;salt.modules.snapper.snapper.SetSnapshot&quot;, MagicMock()):
            _ret = {
                &quot;userdata&quot;: {&quot;userdata2&quot;: &quot;uservalue2&quot;},
                &quot;description&quot;: &quot;UPDATED DESCRIPTION&quot;,
                &quot;timestamp&quot;: 1457006571,
                &quot;cleanup&quot;: &quot;number&quot;,
                &quot;user&quot;: &quot;root&quot;,
                &quot;type&quot;: &quot;pre&quot;,
                &quot;id&quot;: 42,
            }
            _opts = {
                &quot;config&quot;: &quot;root&quot;,
                &quot;snapshot_id&quot;: 42,
                &quot;cleanup&quot;: &quot;number&quot;,
                &quot;description&quot;: &quot;UPDATED DESCRIPTION&quot;,
                &quot;userdata&quot;: {&quot;userdata2&quot;: &quot;uservalue2&quot;},
            }
            with patch(
                &quot;salt.modules.snapper.get_snapshot&quot;,
                MagicMock(side_effect=[DBUS_RET[&quot;ListSnapshots&quot;][0], _ret]),
            ):
                self.assertDictEqual(snapper.modify_snapshot(**_opts), _ret)

    def test__get_num_interval(self):
        with patch(
            &quot;salt.modules.snapper._get_last_snapshot&quot;,
            MagicMock(return_value={&quot;id&quot;: 42}),
        ):
            self.assertEqual(
                snapper._get_num_interval(config=None, num_pre=None, num_post=None),
                (42, 0),
            )  # pylint: disable=protected-access
            self.assertEqual(
                snapper._get_num_interval(config=None, num_pre=None, num_post=50),
                (42, 50),
            )  # pylint: disable=protected-access
            self.assertEqual(
                snapper._get_num_interval(config=None, num_pre=42, num_post=50),
                (42, 50),
            )  # pylint: disable=protected-access

    def test_run(self):
        patch_dict = {
            &quot;snapper.create_snapshot&quot;: MagicMock(return_value=43),
            &quot;test.ping&quot;: MagicMock(return_value=True),
        }
        with patch.dict(snapper.__salt__, patch_dict):
            self.assertEqual(snapper.run(&quot;test.ping&quot;), True)
            self.assertRaises(CommandExecutionError, snapper.run, &quot;unknown.func&quot;)

    def test_status(self):
        with patch(
            &quot;salt.modules.snapper._get_num_interval&quot;, MagicMock(return_value=(42, 43))
        ), patch(&quot;salt.modules.snapper.snapper.GetComparison&quot;, MagicMock()), patch(
            &quot;salt.modules.snapper.snapper.GetFiles&quot;,
            MagicMock(return_value=DBUS_RET[&quot;GetFiles&quot;]),
        ), patch(
            &quot;salt.modules.snapper.snapper.ListConfigs&quot;,
            MagicMock(return_value=DBUS_RET[&quot;ListConfigs&quot;]),
        ):
            self.assertCountEqual(snapper.status(), MODULE_RET[&quot;GETFILES&quot;])
            self.assertCountEqual(
                snapper.status(num_pre=&quot;42&quot;, num_post=43), MODULE_RET[&quot;GETFILES&quot;]
            )
            self.assertCountEqual(snapper.status(num_pre=42), MODULE_RET[&quot;GETFILES&quot;])
            self.assertCountEqual(snapper.status(num_post=43), MODULE_RET[&quot;GETFILES&quot;])

    def test_changed_files(self):
        with patch(
            &quot;salt.modules.snapper.status&quot;,
            MagicMock(return_value=MODULE_RET[&quot;GETFILES&quot;]),
        ):
            self.assertEqual(snapper.changed_files(), MODULE_RET[&quot;GETFILES&quot;].keys())

    def test_undo(self):
        with patch(
            &quot;salt.modules.snapper._get_num_interval&quot;, MagicMock(return_value=(42, 43))
        ), patch(
            &quot;salt.modules.snapper.status&quot;,
            MagicMock(return_value=MODULE_RET[&quot;GETFILES&quot;]),
        ):
            cmd_ret = &quot;create:0 modify:1 delete:0&quot;
            with patch.dict(
                snapper.__salt__, {&quot;cmd.run&quot;: MagicMock(return_value=cmd_ret)}
            ):
                module_ret = {&quot;create&quot;: &quot;0&quot;, &quot;delete&quot;: &quot;0&quot;, &quot;modify&quot;: &quot;1&quot;}
                self.assertEqual(snapper.undo(files=[&quot;/tmp/foo&quot;]), module_ret)

            cmd_ret = &quot;create:1 modify:1 delete:0&quot;
            with patch.dict(
                snapper.__salt__, {&quot;cmd.run&quot;: MagicMock(return_value=cmd_ret)}
            ):
                module_ret = {&quot;create&quot;: &quot;1&quot;, &quot;delete&quot;: &quot;0&quot;, &quot;modify&quot;: &quot;1&quot;}
                self.assertEqual(
                    snapper.undo(files=[&quot;/tmp/foo&quot;, &quot;/tmp/foo2&quot;]), module_ret
                )

            cmd_ret = &quot;create:1 modify:1 delete:1&quot;
            with patch.dict(
                snapper.__salt__, {&quot;cmd.run&quot;: MagicMock(return_value=cmd_ret)}
            ):
                module_ret = {&quot;create&quot;: &quot;1&quot;, &quot;delete&quot;: &quot;1&quot;, &quot;modify&quot;: &quot;1&quot;}
                self.assertEqual(
                    snapper.undo(files=[&quot;/tmp/foo&quot;, &quot;/tmp/foo2&quot;, &quot;/tmp/foo3&quot;]),
                    module_ret,
                )

    def test__get_jid_snapshots(self):
        with patch(
            &quot;salt.modules.snapper.list_snapshots&quot;,
            MagicMock(return_value=MODULE_RET[&quot;SNAPSHOTS&quot;]),
        ):
            self.assertEqual(
                snapper._get_jid_snapshots(
                    &quot;20160607130930720112&quot;
                ),  # pylint: disable=protected-access
                (MODULE_RET[&quot;SNAPSHOTS&quot;][0][&quot;id&quot;], MODULE_RET[&quot;SNAPSHOTS&quot;][1][&quot;id&quot;]),
            )

    def test_undo_jid(self):
        with patch(
            &quot;salt.modules.snapper._get_jid_snapshots&quot;, MagicMock(return_value=(42, 43))
        ), patch(
            &quot;salt.modules.snapper.undo&quot;,
            MagicMock(return_value=&quot;create:1 modify:1 delete:1&quot;),
        ):
            self.assertEqual(
                snapper.undo_jid(20160607130930720112), &quot;create:1 modify:1 delete:1&quot;
            )

    def test_diff_text_file(self):
        with patch(
            &quot;salt.modules.snapper._get_num_interval&quot;, MagicMock(return_value=(42, 43))
        ), patch(
            &quot;salt.modules.snapper.snapper.MountSnapshot&quot;,
            MagicMock(side_effect=[&quot;/.snapshots/55/snapshot&quot;, &quot;&quot;]),
        ), patch(
            &quot;salt.modules.snapper.snapper.UmountSnapshot&quot;, MagicMock(return_value=&quot;&quot;)
        ), patch(
            &quot;os.path.isdir&quot;, MagicMock(return_value=False)
        ), patch(
            &quot;salt.modules.snapper.changed_files&quot;, MagicMock(return_value=[&quot;/tmp/foo2&quot;])
        ), patch(
            &quot;salt.modules.snapper._is_text_file&quot;, MagicMock(return_value=True)
        ), patch(
            &quot;os.path.isfile&quot;, MagicMock(side_effect=[False, True])
        ), patch(
            &quot;salt.utils.files.fopen&quot;,
            mock_open(read_data=FILE_CONTENT[&quot;/tmp/foo2&quot;][&quot;post&quot;]),
        ), patch(
            &quot;salt.modules.snapper.snapper.ListConfigs&quot;,
            MagicMock(return_value=DBUS_RET[&quot;ListConfigs&quot;]),
        ):
            if sys.version_info &lt; (2, 7):
                self.assertEqual(
                    snapper.diff(), {&quot;/tmp/foo2&quot;: MODULE_RET[&quot;DIFF&quot;][&quot;/tmp/foo26&quot;]}
                )
            else:
                self.assertEqual(
                    snapper.diff(), {&quot;/tmp/foo2&quot;: MODULE_RET[&quot;DIFF&quot;][&quot;/tmp/foo2&quot;]}
                )

    @skipIf(sys.version_info &lt; (2, 7), &quot;Python 2.7 required to compare diff properly&quot;)
    def test_diff_text_files(self):
        with patch(
            &quot;salt.modules.snapper._get_num_interval&quot;, MagicMock(return_value=(55, 0))
        ), patch(
            &quot;salt.modules.snapper.snapper.MountSnapshot&quot;,
            MagicMock(
                side_effect=[
                    &quot;/.snapshots/55/snapshot&quot;,
                    &quot;&quot;,
                    &quot;/.snapshots/55/snapshot&quot;,
                    &quot;&quot;,
                ]
            ),
        ), patch(
            &quot;salt.modules.snapper.snapper.UmountSnapshot&quot;, MagicMock(return_value=&quot;&quot;)
        ), patch(
            &quot;salt.modules.snapper.changed_files&quot;,
            MagicMock(return_value=[&quot;/tmp/foo&quot;, &quot;/tmp/foo2&quot;]),
        ), patch(
            &quot;salt.modules.snapper._is_text_file&quot;, MagicMock(return_value=True)
        ), patch(
            &quot;os.path.isfile&quot;, MagicMock(side_effect=[True, True, False, True])
        ), patch(
            &quot;os.path.isdir&quot;, MagicMock(return_value=False)
        ), patch(
            &quot;salt.modules.snapper.snapper.ListConfigs&quot;,
            MagicMock(return_value=DBUS_RET[&quot;ListConfigs&quot;]),
        ):
            contents = {
                &quot;*/tmp/foo&quot;: [
                    FILE_CONTENT[&quot;/tmp/foo&quot;][&quot;pre&quot;],
                    FILE_CONTENT[&quot;/tmp/foo&quot;][&quot;post&quot;],
                ],
                &quot;*/tmp/foo2&quot;: FILE_CONTENT[&quot;/tmp/foo2&quot;][&quot;post&quot;],
            }
            with patch(&quot;salt.utils.files.fopen&quot;, mock_open(read_data=contents)):
                module_ret = {
                    &quot;/tmp/foo&quot;: MODULE_RET[&quot;DIFF&quot;][&quot;/tmp/foo&quot;],
                    &quot;/tmp/foo2&quot;: MODULE_RET[&quot;DIFF&quot;][&quot;/tmp/foo2&quot;],
                }
                self.assertEqual(snapper.diff(), module_ret)

    def test_diff_binary_files(self):
        with patch(
            &quot;salt.modules.snapper._get_num_interval&quot;, MagicMock(return_value=(55, 0))
        ), patch(
            &quot;salt.modules.snapper.snapper.MountSnapshot&quot;,
            MagicMock(
                side_effect=[
                    &quot;/.snapshots/55/snapshot&quot;,
                    &quot;&quot;,
                    &quot;/.snapshots/55/snapshot&quot;,
                    &quot;&quot;,
                ]
            ),
        ), patch(
            &quot;salt.modules.snapper.snapper.UmountSnapshot&quot;, MagicMock(return_value=&quot;&quot;)
        ), patch(
            &quot;salt.modules.snapper.changed_files&quot;, MagicMock(return_value=[&quot;/tmp/foo3&quot;])
        ), patch(
            &quot;salt.modules.snapper._is_text_file&quot;, MagicMock(return_value=False)
        ), patch(
            &quot;os.path.isfile&quot;, MagicMock(side_effect=[True, True])
        ), patch(
            &quot;os.path.isdir&quot;, MagicMock(return_value=False)
        ), patch(
            &quot;salt.modules.snapper.snapper.ListConfigs&quot;,
            MagicMock(return_value=DBUS_RET[&quot;ListConfigs&quot;]),
        ), patch.dict(
            snapper.__salt__,
            {
                &quot;hashutil.sha256_digest&quot;: MagicMock(
                    side_effect=[
                        &quot;e61f8b762d83f3b4aeb3689564b0ffbe54fa731a69a1e208dc9440ce0f69d19b&quot;,
                        &quot;f18f971f1517449208a66589085ddd3723f7f6cefb56c141e3d97ae49e1d87fa&quot;,
                    ]
                )
            },
        ):
            with patch(&quot;salt.utils.files.fopen&quot;, mock_open(read_data=&quot;dummy binary&quot;)):
                module_ret = {
                    &quot;/tmp/foo3&quot;: MODULE_RET[&quot;DIFF&quot;][&quot;/tmp/foo3&quot;],
                }
                self.assertEqual(snapper.diff(), module_ret)

    @skipIf(salt.utils.platform.is_linux() is False, &quot;This is a linux only test&quot;)
    @with_tempfile()
    def test__is_text_file(self, tempfile):
        with salt.utils.files.fopen(tempfile, &quot;w&quot;) as wfh:
            wfh.write(
                &quot;Once upon a time there was an old Sow with three little Pigs, and &quot;
                &quot;as she had not enough to keep them, she sent them out to seek their &quot;
                &quot;fortune.\n&quot;
            )
        assert snapper._is_text_file(tempfile) is True

        with salt.utils.files.fopen(tempfile, &quot;wb&quot;) as wfh:
            wfh.write(
                b&quot;C\x07\xd6\x13\xe5_\x99D\xeb\xd7v\xc1\x96p\x84\xd2{a\x03++\r\xcd/&quot;
                b&quot;\xdb\x98\xda\xf7H\xf8\xfb-\x95\xa9}|^\t\xddx\x1c\x18s\x1bZ\x86\x8a(S\xe4&quot;
            )
        assert snapper._is_text_file(tempfile) is False
</PRE>
</div>
  </div>
</body>
</html>
