<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_zpool.py &amp; test_snapper.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_zpool.py &amp; test_snapper.py
      </h3>
<h1 align="center">
        6.3%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_zpool.py (7.4394464%)<th>test_snapper.py (5.5198975%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(360-382)<td><a href="#" name="0">(90-176)</a><td align="center"><font color="#ff0000">24</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(464-486)<td><a href="#" name="1">(21-85)</a><td align="center"><font color="#c90000">19</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_zpool.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import pytest
2 import salt.config
3 import salt.loader
4 import salt.states.zpool as zpool
5 import salt.utils.zfs
6 from salt.utils.odict import OrderedDict
7 from tests.support.mock import MagicMock, patch
8 from tests.support.zfs import ZFSMockData
9 @pytest.fixture
10 def utils_patch():
11     return ZFSMockData().get_patched_utils()
12 @pytest.fixture
13 def configure_loader_modules():
14     opts = salt.config.DEFAULT_MINION_OPTS.copy()
15     utils = salt.loader.utils(opts, whitelist=["zfs"])
16     zpool_obj = {
17         zpool: {
18             "__opts__": opts,
19             "__grains__": {"kernel": "SunOS"},
20             "__utils__": utils,
21         }
22     }
23     return zpool_obj
24 def test_absent_without_pool(utils_patch):
25     ret = {
26         "name": "myzpool",
27         "result": True,
28         "comment": "storage pool myzpool is absent",
29         "changes": {},
30     }
31     mock_exists = MagicMock(return_value=False)
32     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
33         zpool.__utils__, utils_patch
34     ):
35         assert zpool.absent("myzpool") == ret
36 def test_absent_destroy_pool(utils_patch):
37     ret = {
38         "name": "myzpool",
39         "result": True,
40         "comment": "storage pool myzpool was destroyed",
41         "changes": {"myzpool": "destroyed"},
42     }
43     mock_exists = MagicMock(return_value=True)
44     mock_destroy = MagicMock(return_value=OrderedDict([("destroyed", True)]))
45     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
46         zpool.__salt__, {"zpool.destroy": mock_destroy}
47     ), patch.dict(zpool.__utils__, utils_patch):
48         assert zpool.absent("myzpool") == ret
49 def test_absent_exporty_pool(utils_patch):
50     ret = {
51         "name": "myzpool",
52         "result": True,
53         "comment": "storage pool myzpool was exported",
54         "changes": {"myzpool": "exported"},
55     }
56     mock_exists = MagicMock(return_value=True)
57     mock_destroy = MagicMock(return_value=OrderedDict([("exported", True)]))
58     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
59         zpool.__salt__, {"zpool.export": mock_destroy}
60     ), patch.dict(zpool.__utils__, utils_patch):
61         assert zpool.absent("myzpool", export=True) == ret
62 def test_absent_busy(utils_patch):
63     ret = {
64         "name": "myzpool",
65         "result": False,
66         "comment": "\n".join(
67             [
68                 "cannot unmount '/myzpool': Device busy",
69                 "cannot export 'myzpool': pool is busy",
70             ]
71         ),
72         "changes": {},
73     }
74     mock_exists = MagicMock(return_value=True)
75     mock_destroy = MagicMock(
76         return_value=OrderedDict(
77             [
78                 ("exported", False),
79                 (
80                     "error",
81                     "\n".join(
82                         [
83                             "cannot unmount '/myzpool': Device busy",
84                             "cannot export 'myzpool': pool is busy",
85                         ]
86                     ),
87                 ),
88             ]
89         )
90     )
91     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
92         zpool.__salt__, {"zpool.export": mock_destroy}
93     ), patch.dict(zpool.__utils__, utils_patch):
94         assert zpool.absent("myzpool", export=True) == ret
95 def test_present_import_success(utils_patch):
96     ret = {
97         "name": "myzpool",
98         "result": True,
99         "comment": "storage pool myzpool was imported",
100         "changes": {"myzpool": "imported"},
101     }
102     config = {
103         "import": True,
104     }
105     mock_exists = MagicMock(return_value=False)
106     mock_import = MagicMock(return_value=OrderedDict([("imported", True)]))
107     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
108         zpool.__salt__, {"zpool.import": mock_import}
109     ), patch.dict(zpool.__utils__, utils_patch):
110         assert zpool.present("myzpool", config=config) == ret
111 def test_present_import_fail(utils_patch):
112     ret = {
113         "name": "myzpool",
114         "result": False,
115         "comment": (
116             "storage pool myzpool was not imported, no (valid) layout specified for"
117             " creation"
118         ),
119         "changes": {},
120     }
121     config = {
122         "import": True,
123     }
124     mock_exists = MagicMock(return_value=False)
125     mock_import = MagicMock(return_value=OrderedDict([("imported", False)]))
126     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
127         zpool.__salt__, {"zpool.import": mock_import}
128     ), patch.dict(zpool.__utils__, utils_patch):
129         assert zpool.present("myzpool", config=config) == ret
130 def test_present_create_success(utils_patch):
131     ret = {
132         "name": "myzpool",
133         "result": True,
134         "comment": "storage pool myzpool was created",
135         "changes": {"myzpool": "created"},
136     }
137     config = {
138         "import": False,
139     }
140     layout = [
141         OrderedDict([("mirror", ["disk0", "disk1"])]),
142         OrderedDict([("mirror", ["disk2", "disk3"])]),
143     ]
144     properties = {
145         "autoexpand": True,
146     }
147     filesystem_properties = {
148         "quota": "5G",
149     }
150     mock_exists = MagicMock(return_value=False)
151     mock_create = MagicMock(
152         return_value=OrderedDict(
153             [
154                 ("created", True),
155                 (
156                     "vdevs",
157                     OrderedDict(
158                         [
159                             ("mirror-0", ["/dev/dsk/disk0", "/dev/dsk/disk1"]),
160                             ("mirror-1", ["/dev/dsk/disk2", "/dev/dsk/disk3"]),
161                         ]
162                     ),
163                 ),
164             ]
165         )
166     )
167     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
168         zpool.__salt__, {"zpool.create": mock_create}
169     ), patch.dict(zpool.__utils__, utils_patch):
170         assert (
171             zpool.present(
172                 "myzpool",
173                 config=config,
174                 layout=layout,
175                 properties=properties,
176                 filesystem_properties=filesystem_properties,
177             )
178             == ret
179         )
180 def test_present_create_fail(utils_patch):
181     ret = {
182         "name": "myzpool",
183         "result": False,
184         "comment": (
185             "storage pool myzpool was not imported, no (valid) layout specified for"
186             " creation"
187         ),
188         "changes": {},
189     }
190     config = {
191         "import": False,
192     }
193     mock_exists = MagicMock(return_value=False)
194     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
195         zpool.__utils__, utils_patch
196     ):
197         assert zpool.present("myzpool", config=config) == ret
198 def test_present_create_passthrough_fail(utils_patch):
199     ret = {
200         "name": "myzpool",
201         "result": False,
202         "comment": "\n".join(
203             [
204                 "invalid vdev specification",
205                 "use 'force=True' to override the following errors:",
206                 "/data/salt/vdisk0 is part of exported pool 'zsalt'",
207                 "/data/salt/vdisk1 is part of exported pool 'zsalt'",
208             ]
209         ),
210         "changes": {},
211     }
212     config = {
213         "force": False,
214         "import": False,
215     }
216     layout = [
217         OrderedDict([("mirror", ["disk0", "disk1"])]),
218         OrderedDict([("mirror", ["disk2", "disk3"])]),
219     ]
220     properties = {
221         "autoexpand": True,
222     }
223     filesystem_properties = {
224         "quota": "5G",
225     }
226     mock_exists = MagicMock(return_value=False)
227     mock_create = MagicMock(
228         return_value=OrderedDict(
229             [
230                 ("created", False),
231                 (
232                     "error",
233                     "\n".join(
234                         [
235                             "invalid vdev specification",
236                             "use 'force=True' to override the following errors:",
237                             "/data/salt/vdisk0 is part of exported pool 'zsalt'",
238                             "/data/salt/vdisk1 is part of exported pool 'zsalt'",
239                         ]
240                     ),
241                 ),
242             ]
243         )
244     )
245     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
246         zpool.__salt__, {"zpool.create": mock_create}
247     ), patch.dict(zpool.__utils__, utils_patch):
248         assert (
249             zpool.present(
250                 "myzpool",
251                 config=config,
252                 layout=layout,
253                 properties=properties,
254                 filesystem_properties=filesystem_properties,
255             )
256             == ret
257         )
258 def test_present_update_success(utils_patch):
259     ret = {
260         "name": "myzpool",
261         "result": True,
262         "comment": "properties updated",
263         "changes": {"myzpool": {"autoexpand": False}},
264     }
265     config = {
266         "import": False,
267     }
268     layout = [
269         OrderedDict([("mirror", ["disk0", "disk1"])]),
270         OrderedDict([("mirror", ["disk2", "disk3"])]),
271     ]
272     properties = {
273         "autoexpand": False,
274     }
275     mock_exists = MagicMock(return_value=True)
276 <a name="0"></a>    mock_get = MagicMock(
277         return_value=OrderedDict(
278             [
279                 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>("comment", "salt managed pool"),
280                 ("freeing", 0),
281                 ("listsnapshots", False),
282                 ("leaked", 0),
283                 ("feature@obsolete_counts", "enabled"),
284                 ("feature@sha512", "enabled"),
285                 ("delegation", True),
286                 ("dedupditto", "0"),
287                 ("dedupratio", "1.00x"),
288                 ("autoexpand", True),
289                 ("feature@bookmarks", "enabled"),
290                 ("allocated", 115712),
291                 ("guid", 1591906802560842214),
292                 ("feature@large_blocks", "enabled"),
293                 ("size", 2113929216),
294                 ("feature@enabled_txg", "active"),
295                 ("feature@hole_birth", "active"),
296                 ("capacity", 0),
297                 ("feature@multi_vdev_crash_dump", "enabled"),
298                 ("feature@extensible_dataset", "enabled"),
299                 ("cachefile", "-"),
300                 ("bootfs", "-"),
301                 ("autoreplace"</b></font>, True),
302                 ("readonly", False),
303                 ("version", "-"),
304                 ("health", "ONLINE"),
305                 ("expandsize", "-"),
306                 ("feature@embedded_data", "active"),
307                 ("feature@lz4_compress", "active"),
308                 ("feature@async_destroy", "enabled"),
309                 ("feature@skein", "enabled"),
310                 ("feature@empty_bpobj", "enabled"),
311                 ("feature@spacemap_histogram", "active"),
312                 ("bootsize", "-"),
313                 ("free", 2113813504),
314                 ("feature@device_removal", "enabled"),
315                 ("failmode", "wait"),
316                 ("feature@filesystem_limits", "enabled"),
317                 ("feature@edonr", "enabled"),
318                 ("altroot", "-"),
319                 ("fragmentation", "0%"),
320             ]
321         )
322     )
323     mock_set = MagicMock(return_value=OrderedDict([("set", True)]))
324     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}), patch.dict(
325         zpool.__salt__, {"zpool.get": mock_get}
326     ), patch.dict(zpool.__salt__, {"zpool.set": mock_set}), patch.dict(
327         zpool.__utils__, utils_patch
328     ):
329         assert (
330             zpool.present(
331                 "myzpool",
332                 config=config,
333                 layout=layout,
334                 properties=properties,
335             )
336             == ret
337         )
338 def test_present_update_nochange_success(utils_patch):
339     config = {
340         "import": False,
341     }
342     layout = [
343         OrderedDict([("mirror", ["disk0", "disk1"])]),
344         OrderedDict([("mirror", ["disk2", "disk3"])]),
345     ]
346     properties = {
347         "autoexpand": True,
348     }
349     mock_exists = MagicMock(return_value=True)
350     mock_get = MagicMock(
351         return_value=OrderedDict(
352             [
353                 ("comment", "salt managed pool"),
354                 ("freeing", 0),
355                 ("listsnapshots", False),
356                 ("leaked", 0),
357                 ("feature@obsolete_counts", "enabled"),
358                 ("feature@sha512", "enabled"),
359                 ("delegation", True),
360                 ("dedupditto", "0"),
361                 ("dedupratio", "1.00x"),
362                 ("autoexpand", True),
363                 ("feature@bookmarks", "enabled"),
364                 ("allocated", 115712),
365                 ("guid", 1591906802560842214),
366                 ("feature@large_blocks", "enabled"),
367                 ("size", 2113929216),
368                 ("feature@enabled_txg", "active"),
369                 ("feature@hole_birth", "active"),
370                 ("capacity", 0),
371                 ("feature@multi_vdev_crash_dump", "enabled"),
372                 ("feature@extensible_dataset", "enabled"),
373                 ("cachefile", "-"),
374 <a name="1"></a>                ("bootfs", "-"),
375                 ("autoreplace", True),
376                 ("readonly", False),
377                 (<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"version", "-"),
378                 ("health", "ONLINE"),
379                 ("expandsize", "-"),
380                 ("feature@embedded_data", "active"),
381                 ("feature@lz4_compress", "active"),
382                 ("feature@async_destroy", "enabled"),
383                 ("feature@skein", "enabled"),
384                 ("feature@empty_bpobj", "enabled"),
385                 ("feature@spacemap_histogram", "active"),
386                 ("bootsize", "-"),
387                 ("free", 2113813504),
388                 ("feature@device_removal", "enabled"),
389                 ("failmode", "wait"),
390                 ("feature@filesystem_limits", "enabled"),
391                 ("feature@edonr", "enabled"),
392                 ("altroot", "-"),
393                 ("fragmentation", "0%"),
394             ]
395         )
396     )
397     ret = {
398         "name"</b></font>: "myzpool",
399         "result": True,
400         "comment": "no update needed",
401         "changes": {},
402     }
403     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}):
404         with patch.dict(zpool.__salt__, {"zpool.get": mock_get}):
405             with patch.dict(zpool.__utils__, utils_patch):
406                 assert (
407                     zpool.present(
408                         "myzpool",
409                         config=config,
410                         layout=layout,
411                         properties=properties,
412                     )
413                     == ret
414                 )
415     ret = {
416         "name": "myzpool",
417         "result": True,
418         "comment": "storage pool myzpool is uptodate",
419         "changes": {},
420     }
421     with patch.dict(zpool.__salt__, {"zpool.exists": mock_exists}):
422         with patch.dict(zpool.__salt__, {"zpool.get": mock_get}):
423             with patch.dict(zpool.__utils__, utils_patch):
424                 with patch.dict(zpool.__opts__, {"test": True}):
425                     assert (
426                         zpool.present(
427                             "myzpool",
428                             config=config,
429                             layout=layout,
430                             properties=properties,
431                         )
432                         == ret
433                     )
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_snapper.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import sys
2 import salt.modules.snapper as snapper
3 import salt.utils.files
4 import salt.utils.platform
5 from salt.exceptions import CommandExecutionError
6 from tests.support.helpers import with_tempfile
7 from tests.support.mixins import LoaderModuleMockMixin
8 from tests.support.mock import MagicMock, mock_open, patch
9 <a name="1"></a>from tests.support.unit import TestCase, skipIf
10 DBUS_RET = {
11     <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>"ListSnapshots": [
12         [
13             42,
14             1,
15             0,
16             1457006571,
17             0,
18             "Some description",
19             "",
20             {"userdata1": "userval1", "salt_jid": "20160607130930720112"},
21         ],
22         [
23             43,
24             2,
25             42,
26             1457006572,
27             0,
28             "Blah Blah",
29             "",
30             {"userdata2": "userval2", "salt_jid": "20160607130930720112"},
31         ],
32     ],
33     "ListConfigs": [
34         [
35             "root",
36             "/",
37             {
38                 "SUBVOLUME": "/",
39                 "NUMBER_MIN_AGE": "1800",
40                 "TIMELINE_LIMIT_YEARLY": "4-10",
41                 "NUMBER_LIMIT_IMPORTANT": "10",
42                 "FSTYPE": "btrfs",
43                 "TIMELINE_LIMIT_MONTHLY": "4-10",
44                 "ALLOW_GROUPS": "",
45                 "EMPTY_PRE_POST_MIN_AGE": "1800",
46                 "EMPTY_PRE_POST_CLEANUP": "yes",
47                 "BACKGROUND_COMPARISON": "yes",
48                 "TIMELINE_LIMIT_HOURLY": "4-10",
49                 "ALLOW_USERS": "",
50                 "TIMELINE_LIMIT_WEEKLY": "0",
51                 "TIMELINE_CREATE": "no",
52                 "NUMBER_CLEANUP": "yes",
53                 "TIMELINE_CLEANUP": "yes",
54                 "SPACE_LIMIT": "0.5",
55                 "NUMBER_LIMIT": "10",
56                 "TIMELINE_MIN_AGE": "1800",
57                 "TIMELINE_LIMIT_DAILY": "4-10",
58                 "SYNC_ACL": "no",
59                 "QGROUP": "1/0",
60             },
61         ]
62     ],
63     "GetFiles": [
64         ["/root/.viminfo", 8],
65         ["/tmp/foo", 52],
66         ["/tmp/foo2", 1],
67         ["/tmp/foo3", 2],
68         ["/var/log/snapper.log", 8],
69         ["/var/cache/salt/minion/extmods/modules/snapper.py", 8],
70         ["/var/cache/salt/minion/extmods/modules/snapper.pyc", 8],
71     ],
72 }
73 FILE_CONTENT = {
74     "/tmp/foo"</b></font>: {"pre": "dummy text", "post": "another foobar"},
75     "/tmp/foo2": {"post": "another foobar"},
76 <a name="0"></a>}
77 MODULE_RET = {
78     <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>"SNAPSHOTS": [
79         {
80             "userdata": {"userdata1": "userval1", "salt_jid": "20160607130930720112"},
81             "description": "Some description",
82             "timestamp": 1457006571,
83             "cleanup": "",
84             "user": "root",
85             "type": "pre",
86             "id": 42,
87         },
88         {
89             "pre": 42,
90             "userdata": {"userdata2": "userval2", "salt_jid": "20160607130930720112"},
91             "description": "Blah Blah",
92             "timestamp": 1457006572,
93             "cleanup": "",
94             "user": "root",
95             "type": "post",
96             "id": 43,
97         },
98     ],
99     "LISTCONFIGS": {
100         "root": {
101             "SUBVOLUME": "/",
102             "NUMBER_MIN_AGE": "1800",
103             "TIMELINE_LIMIT_YEARLY": "4-10",
104             "NUMBER_LIMIT_IMPORTANT": "10",
105             "FSTYPE": "btrfs",
106             "TIMELINE_LIMIT_MONTHLY": "4-10",
107             "ALLOW_GROUPS": "",
108             "EMPTY_PRE_POST_MIN_AGE": "1800",
109             "EMPTY_PRE_POST_CLEANUP": "yes",
110             "BACKGROUND_COMPARISON": "yes",
111             "TIMELINE_LIMIT_HOURLY": "4-10",
112             "ALLOW_USERS": "",
113             "TIMELINE_LIMIT_WEEKLY": "0",
114             "TIMELINE_CREATE": "no",
115             "NUMBER_CLEANUP": "yes",
116             "TIMELINE_CLEANUP": "yes",
117             "SPACE_LIMIT": "0.5",
118             "NUMBER_LIMIT": "10",
119             "TIMELINE_MIN_AGE": "1800",
120             "TIMELINE_LIMIT_DAILY": "4-10",
121             "SYNC_ACL": "no",
122             "QGROUP": "1/0",
123         }
124     },
125     "GETFILES": {
126         "/root/.viminfo": {"status": ["modified"]},
127         "/tmp/foo": {"status": ["type changed", "permission changed", "owner changed"]},
128         "/tmp/foo2": {"status": ["created"]},
129         "/tmp/foo3": {"status": ["deleted"]},
130         "/var/log/snapper.log": {"status": ["modified"]},
131         "/var/cache/salt/minion/extmods/modules/snapper.py": {"status": ["modified"]},
132         "/var/cache/salt/minion/extmods/modules/snapper.pyc": {"status": ["modified"]},
133     },
134     "DIFF": {
135         "/tmp/foo": {
136             "comment": "text file changed",
137             "diff": (
138                 "--- /.snapshots/55/snapshot/tmp/foo\n"
139                 "+++ /tmp/foo\n"
140                 "@@ -1 +1 @@\n"
141                 "-dummy text"
142                 "+another foobar"
143             ),
144         },
145         "/tmp/foo2": {
146             "comment": "text file created",
147             "diff": (
148                 "--- /.snapshots/55/snapshot/tmp/foo2\n"
149                 "+++ /tmp/foo2\n"
150                 "@@ -0,0 +1 @@\n"
151                 "+another foobar"
152             ),
153         },
154         "/tmp/foo26": {
155             "comment": "text file created",
156             "diff": (
157                 "--- /.snapshots/55/snapshot/tmp/foo2 \n"
158                 "+++ /tmp/foo2 \n"
159                 "@@ -1,0 +1,1 @@\n"
160                 "+another foobar"
161             ),
162         },
163         "/tmp/foo3": {
164             "comment"</b></font>: "binary file changed",
165             "old_sha256_digest": (
166                 "e61f8b762d83f3b4aeb3689564b0ffbe54fa731a69a1e208dc9440ce0f69d19b"
167             ),
168             "new_sha256_digest": (
169                 "f18f971f1517449208a66589085ddd3723f7f6cefb56c141e3d97ae49e1d87fa"
170             ),
171         },
172     },
173 }
174 @skipIf(sys.platform.startswith("win"), "Snapper not available on Windows")
175 class SnapperTestCase(TestCase, LoaderModuleMockMixin):
176     def setup_loader_modules(self):
177         class DBusException(BaseException):
178             get_dbus_name = "foo"
179         dbus_mock = MagicMock()
180         dbus_mock.configure_mock(DBusException=DBusException)
181         return {snapper: {"dbus": dbus_mock, "snapper": MagicMock()}}
182     def test__snapshot_to_data(self):
183         data = snapper._snapshot_to_data(
184             DBUS_RET["ListSnapshots"][0]
185         )  # pylint: disable=protected-access
186         self.assertEqual(data["id"], 42)
187         self.assertNotIn("pre", data)
188         self.assertEqual(data["type"], "pre")
189         self.assertEqual(data["user"], "root")
190         self.assertEqual(data["timestamp"], 1457006571)
191         self.assertEqual(data["description"], "Some description")
192         self.assertEqual(data["cleanup"], "")
193         self.assertEqual(data["userdata"]["userdata1"], "userval1")
194     def test_list_snapshots(self):
195         with patch(
196             "salt.modules.snapper.snapper.ListSnapshots",
197             MagicMock(return_value=DBUS_RET["ListSnapshots"]),
198         ):
199             self.assertEqual(snapper.list_snapshots(), MODULE_RET["SNAPSHOTS"])
200     def test_get_snapshot(self):
201         with patch(
202             "salt.modules.snapper.snapper.GetSnapshot",
203             MagicMock(return_value=DBUS_RET["ListSnapshots"][0]),
204         ):
205             self.assertEqual(snapper.get_snapshot(), MODULE_RET["SNAPSHOTS"][0])
206             self.assertEqual(
207                 snapper.get_snapshot(number=42), MODULE_RET["SNAPSHOTS"][0]
208             )
209             self.assertNotEqual(
210                 snapper.get_snapshot(number=42), MODULE_RET["SNAPSHOTS"][1]
211             )
212     def test_list_configs(self):
213         with patch(
214             "salt.modules.snapper.snapper.ListConfigs",
215             MagicMock(return_value=DBUS_RET["ListConfigs"]),
216         ):
217             self.assertEqual(snapper.list_configs(), MODULE_RET["LISTCONFIGS"])
218     def test_get_config(self):
219         with patch(
220             "salt.modules.snapper.snapper.GetConfig",
221             MagicMock(return_value=DBUS_RET["ListConfigs"][0]),
222         ):
223             self.assertEqual(snapper.get_config(), DBUS_RET["ListConfigs"][0])
224     def test_set_config(self):
225         with patch("salt.modules.snapper.snapper.SetConfig", MagicMock()):
226             opts = {"sync_acl": True, "dummy": False, "foobar": 1234}
227             self.assertEqual(snapper.set_config(opts), True)
228     def test_status_to_string(self):
229         self.assertEqual(snapper.status_to_string(1), ["created"])
230         self.assertEqual(snapper.status_to_string(2), ["deleted"])
231         self.assertEqual(snapper.status_to_string(4), ["type changed"])
232         self.assertEqual(snapper.status_to_string(8), ["modified"])
233         self.assertEqual(snapper.status_to_string(16), ["permission changed"])
234         self.assertListEqual(
235             snapper.status_to_string(24), ["modified", "permission changed"]
236         )
237         self.assertEqual(snapper.status_to_string(32), ["owner changed"])
238         self.assertEqual(snapper.status_to_string(64), ["group changed"])
239         self.assertListEqual(
240             snapper.status_to_string(97), ["created", "owner changed", "group changed"]
241         )
242         self.assertEqual(snapper.status_to_string(128), ["extended attributes changed"])
243         self.assertEqual(snapper.status_to_string(256), ["ACL info changed"])
244     def test_create_config(self):
245         with patch("salt.modules.snapper.snapper.CreateConfig", MagicMock()), patch(
246             "salt.modules.snapper.snapper.GetConfig",
247             MagicMock(return_value=DBUS_RET["ListConfigs"][0]),
248         ):
249             opts = {
250                 "name": "testconfig",
251                 "subvolume": "/foo/bar/",
252                 "fstype": "btrfs",
253                 "template": "mytemplate",
254                 "extra_opts": {"NUMBER_CLEANUP": False},
255             }
256             with patch(
257                 "salt.modules.snapper.set_config", MagicMock()
258             ) as set_config_mock:
259                 self.assertEqual(
260                     snapper.create_config(**opts), DBUS_RET["ListConfigs"][0]
261                 )
262                 set_config_mock.assert_called_with("testconfig", **opts["extra_opts"])
263             with patch(
264                 "salt.modules.snapper.set_config", MagicMock()
265             ) as set_config_mock:
266                 del opts["extra_opts"]
267                 self.assertEqual(
268                     snapper.create_config(**opts), DBUS_RET["ListConfigs"][0]
269                 )
270                 assert not set_config_mock.called
271                 self.assertRaises(CommandExecutionError, snapper.create_config)
272     def test_create_snapshot(self):
273         with patch(
274             "salt.modules.snapper.snapper.CreateSingleSnapshot",
275             MagicMock(return_value=1234),
276         ), patch(
277             "salt.modules.snapper.snapper.CreatePreSnapshot",
278             MagicMock(return_value=1234),
279         ), patch(
280             "salt.modules.snapper.snapper.CreatePostSnapshot",
281             MagicMock(return_value=1234),
282         ):
283             for snapshot_type in ["pre", "post", "single"]:
284                 opts = {
285                     "__pub_jid": 20160607130930720112,
286                     "type": snapshot_type,
287                     "description": "Test description",
288                     "cleanup_algorithm": "number",
289                     "pre_number": 23,
290                 }
291                 self.assertEqual(snapper.create_snapshot(**opts), 1234)
292     def test_delete_snapshot_id_success(self):
293         with patch("salt.modules.snapper.snapper.DeleteSnapshots", MagicMock()), patch(
294             "salt.modules.snapper.snapper.ListSnapshots",
295             MagicMock(return_value=DBUS_RET["ListSnapshots"]),
296         ):
297             self.assertEqual(
298                 snapper.delete_snapshot(snapshots_ids=43),
299                 {"root": {"ids": [43], "status": "deleted"}},
300             )
301             self.assertEqual(
302                 snapper.delete_snapshot(snapshots_ids=[42, 43]),
303                 {"root": {"ids": [42, 43], "status": "deleted"}},
304             )
305     def test_delete_snapshot_id_fail(self):
306         with patch("salt.modules.snapper.snapper.DeleteSnapshots", MagicMock()), patch(
307             "salt.modules.snapper.snapper.ListSnapshots",
308             MagicMock(return_value=DBUS_RET["ListSnapshots"]),
309         ):
310             self.assertRaises(CommandExecutionError, snapper.delete_snapshot)
311             self.assertRaises(
312                 CommandExecutionError, snapper.delete_snapshot, snapshots_ids=1
313             )
314             self.assertRaises(
315                 CommandExecutionError, snapper.delete_snapshot, snapshots_ids=[1, 2]
316             )
317     def test_modify_snapshot(self):
318         with patch("salt.modules.snapper.snapper.SetSnapshot", MagicMock()):
319             _ret = {
320                 "userdata": {"userdata2": "uservalue2"},
321                 "description": "UPDATED DESCRIPTION",
322                 "timestamp": 1457006571,
323                 "cleanup": "number",
324                 "user": "root",
325                 "type": "pre",
326                 "id": 42,
327             }
328             _opts = {
329                 "config": "root",
330                 "snapshot_id": 42,
331                 "cleanup": "number",
332                 "description": "UPDATED DESCRIPTION",
333                 "userdata": {"userdata2": "uservalue2"},
334             }
335             with patch(
336                 "salt.modules.snapper.get_snapshot",
337                 MagicMock(side_effect=[DBUS_RET["ListSnapshots"][0], _ret]),
338             ):
339                 self.assertDictEqual(snapper.modify_snapshot(**_opts), _ret)
340     def test__get_num_interval(self):
341         with patch(
342             "salt.modules.snapper._get_last_snapshot",
343             MagicMock(return_value={"id": 42}),
344         ):
345             self.assertEqual(
346                 snapper._get_num_interval(config=None, num_pre=None, num_post=None),
347                 (42, 0),
348             )  # pylint: disable=protected-access
349             self.assertEqual(
350                 snapper._get_num_interval(config=None, num_pre=None, num_post=50),
351                 (42, 50),
352             )  # pylint: disable=protected-access
353             self.assertEqual(
354                 snapper._get_num_interval(config=None, num_pre=42, num_post=50),
355                 (42, 50),
356             )  # pylint: disable=protected-access
357     def test_run(self):
358         patch_dict = {
359             "snapper.create_snapshot": MagicMock(return_value=43),
360             "test.ping": MagicMock(return_value=True),
361         }
362         with patch.dict(snapper.__salt__, patch_dict):
363             self.assertEqual(snapper.run("test.ping"), True)
364             self.assertRaises(CommandExecutionError, snapper.run, "unknown.func")
365     def test_status(self):
366         with patch(
367             "salt.modules.snapper._get_num_interval", MagicMock(return_value=(42, 43))
368         ), patch("salt.modules.snapper.snapper.GetComparison", MagicMock()), patch(
369             "salt.modules.snapper.snapper.GetFiles",
370             MagicMock(return_value=DBUS_RET["GetFiles"]),
371         ), patch(
372             "salt.modules.snapper.snapper.ListConfigs",
373             MagicMock(return_value=DBUS_RET["ListConfigs"]),
374         ):
375             self.assertCountEqual(snapper.status(), MODULE_RET["GETFILES"])
376             self.assertCountEqual(
377                 snapper.status(num_pre="42", num_post=43), MODULE_RET["GETFILES"]
378             )
379             self.assertCountEqual(snapper.status(num_pre=42), MODULE_RET["GETFILES"])
380             self.assertCountEqual(snapper.status(num_post=43), MODULE_RET["GETFILES"])
381     def test_changed_files(self):
382         with patch(
383             "salt.modules.snapper.status",
384             MagicMock(return_value=MODULE_RET["GETFILES"]),
385         ):
386             self.assertEqual(snapper.changed_files(), MODULE_RET["GETFILES"].keys())
387     def test_undo(self):
388         with patch(
389             "salt.modules.snapper._get_num_interval", MagicMock(return_value=(42, 43))
390         ), patch(
391             "salt.modules.snapper.status",
392             MagicMock(return_value=MODULE_RET["GETFILES"]),
393         ):
394             cmd_ret = "create:0 modify:1 delete:0"
395             with patch.dict(
396                 snapper.__salt__, {"cmd.run": MagicMock(return_value=cmd_ret)}
397             ):
398                 module_ret = {"create": "0", "delete": "0", "modify": "1"}
399                 self.assertEqual(snapper.undo(files=["/tmp/foo"]), module_ret)
400             cmd_ret = "create:1 modify:1 delete:0"
401             with patch.dict(
402                 snapper.__salt__, {"cmd.run": MagicMock(return_value=cmd_ret)}
403             ):
404                 module_ret = {"create": "1", "delete": "0", "modify": "1"}
405                 self.assertEqual(
406                     snapper.undo(files=["/tmp/foo", "/tmp/foo2"]), module_ret
407                 )
408             cmd_ret = "create:1 modify:1 delete:1"
409             with patch.dict(
410                 snapper.__salt__, {"cmd.run": MagicMock(return_value=cmd_ret)}
411             ):
412                 module_ret = {"create": "1", "delete": "1", "modify": "1"}
413                 self.assertEqual(
414                     snapper.undo(files=["/tmp/foo", "/tmp/foo2", "/tmp/foo3"]),
415                     module_ret,
416                 )
417     def test__get_jid_snapshots(self):
418         with patch(
419             "salt.modules.snapper.list_snapshots",
420             MagicMock(return_value=MODULE_RET["SNAPSHOTS"]),
421         ):
422             self.assertEqual(
423                 snapper._get_jid_snapshots(
424                     "20160607130930720112"
425                 ),  # pylint: disable=protected-access
426                 (MODULE_RET["SNAPSHOTS"][0]["id"], MODULE_RET["SNAPSHOTS"][1]["id"]),
427             )
428     def test_undo_jid(self):
429         with patch(
430             "salt.modules.snapper._get_jid_snapshots", MagicMock(return_value=(42, 43))
431         ), patch(
432             "salt.modules.snapper.undo",
433             MagicMock(return_value="create:1 modify:1 delete:1"),
434         ):
435             self.assertEqual(
436                 snapper.undo_jid(20160607130930720112), "create:1 modify:1 delete:1"
437             )
438     def test_diff_text_file(self):
439         with patch(
440             "salt.modules.snapper._get_num_interval", MagicMock(return_value=(42, 43))
441         ), patch(
442             "salt.modules.snapper.snapper.MountSnapshot",
443             MagicMock(side_effect=["/.snapshots/55/snapshot", ""]),
444         ), patch(
445             "salt.modules.snapper.snapper.UmountSnapshot", MagicMock(return_value="")
446         ), patch(
447             "os.path.isdir", MagicMock(return_value=False)
448         ), patch(
449             "salt.modules.snapper.changed_files", MagicMock(return_value=["/tmp/foo2"])
450         ), patch(
451             "salt.modules.snapper._is_text_file", MagicMock(return_value=True)
452         ), patch(
453             "os.path.isfile", MagicMock(side_effect=[False, True])
454         ), patch(
455             "salt.utils.files.fopen",
456             mock_open(read_data=FILE_CONTENT["/tmp/foo2"]["post"]),
457         ), patch(
458             "salt.modules.snapper.snapper.ListConfigs",
459             MagicMock(return_value=DBUS_RET["ListConfigs"]),
460         ):
461             if sys.version_info &lt; (2, 7):
462                 self.assertEqual(
463                     snapper.diff(), {"/tmp/foo2": MODULE_RET["DIFF"]["/tmp/foo26"]}
464                 )
465             else:
466                 self.assertEqual(
467                     snapper.diff(), {"/tmp/foo2": MODULE_RET["DIFF"]["/tmp/foo2"]}
468                 )
469     @skipIf(sys.version_info &lt; (2, 7), "Python 2.7 required to compare diff properly")
470     def test_diff_text_files(self):
471         with patch(
472             "salt.modules.snapper._get_num_interval", MagicMock(return_value=(55, 0))
473         ), patch(
474             "salt.modules.snapper.snapper.MountSnapshot",
475             MagicMock(
476                 side_effect=[
477                     "/.snapshots/55/snapshot",
478                     "",
479                     "/.snapshots/55/snapshot",
480                     "",
481                 ]
482             ),
483         ), patch(
484             "salt.modules.snapper.snapper.UmountSnapshot", MagicMock(return_value="")
485         ), patch(
486             "salt.modules.snapper.changed_files",
487             MagicMock(return_value=["/tmp/foo", "/tmp/foo2"]),
488         ), patch(
489             "salt.modules.snapper._is_text_file", MagicMock(return_value=True)
490         ), patch(
491             "os.path.isfile", MagicMock(side_effect=[True, True, False, True])
492         ), patch(
493             "os.path.isdir", MagicMock(return_value=False)
494         ), patch(
495             "salt.modules.snapper.snapper.ListConfigs",
496             MagicMock(return_value=DBUS_RET["ListConfigs"]),
497         ):
498             contents = {
499                 "*/tmp/foo": [
500                     FILE_CONTENT["/tmp/foo"]["pre"],
501                     FILE_CONTENT["/tmp/foo"]["post"],
502                 ],
503                 "*/tmp/foo2": FILE_CONTENT["/tmp/foo2"]["post"],
504             }
505             with patch("salt.utils.files.fopen", mock_open(read_data=contents)):
506                 module_ret = {
507                     "/tmp/foo": MODULE_RET["DIFF"]["/tmp/foo"],
508                     "/tmp/foo2": MODULE_RET["DIFF"]["/tmp/foo2"],
509                 }
510                 self.assertEqual(snapper.diff(), module_ret)
511     def test_diff_binary_files(self):
512         with patch(
513             "salt.modules.snapper._get_num_interval", MagicMock(return_value=(55, 0))
514         ), patch(
515             "salt.modules.snapper.snapper.MountSnapshot",
516             MagicMock(
517                 side_effect=[
518                     "/.snapshots/55/snapshot",
519                     "",
520                     "/.snapshots/55/snapshot",
521                     "",
522                 ]
523             ),
524         ), patch(
525             "salt.modules.snapper.snapper.UmountSnapshot", MagicMock(return_value="")
526         ), patch(
527             "salt.modules.snapper.changed_files", MagicMock(return_value=["/tmp/foo3"])
528         ), patch(
529             "salt.modules.snapper._is_text_file", MagicMock(return_value=False)
530         ), patch(
531             "os.path.isfile", MagicMock(side_effect=[True, True])
532         ), patch(
533             "os.path.isdir", MagicMock(return_value=False)
534         ), patch(
535             "salt.modules.snapper.snapper.ListConfigs",
536             MagicMock(return_value=DBUS_RET["ListConfigs"]),
537         ), patch.dict(
538             snapper.__salt__,
539             {
540                 "hashutil.sha256_digest": MagicMock(
541                     side_effect=[
542                         "e61f8b762d83f3b4aeb3689564b0ffbe54fa731a69a1e208dc9440ce0f69d19b",
543                         "f18f971f1517449208a66589085ddd3723f7f6cefb56c141e3d97ae49e1d87fa",
544                     ]
545                 )
546             },
547         ):
548             with patch("salt.utils.files.fopen", mock_open(read_data="dummy binary")):
549                 module_ret = {
550                     "/tmp/foo3": MODULE_RET["DIFF"]["/tmp/foo3"],
551                 }
552                 self.assertEqual(snapper.diff(), module_ret)
553     @skipIf(salt.utils.platform.is_linux() is False, "This is a linux only test")
554     @with_tempfile()
555     def test__is_text_file(self, tempfile):
556         with salt.utils.files.fopen(tempfile, "w") as wfh:
557             wfh.write(
558                 "Once upon a time there was an old Sow with three little Pigs, and "
559                 "as she had not enough to keep them, she sent them out to seek their "
560                 "fortune.\n"
561             )
562         assert snapper._is_text_file(tempfile) is True
563         with salt.utils.files.fopen(tempfile, "wb") as wfh:
564             wfh.write(
565                 b"C\x07\xd6\x13\xe5_\x99D\xeb\xd7v\xc1\x96p\x84\xd2{a\x03++\r\xcd/"
566                 b"\xdb\x98\xda\xf7H\xf8\xfb-\x95\xa9}|^\t\xddx\x1c\x18s\x1bZ\x86\x8a(S\xe4"
567             )
568         assert snapper._is_text_file(tempfile) is False
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
