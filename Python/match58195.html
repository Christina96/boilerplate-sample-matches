<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_boto_route53.py & test_elasticsearch.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_boto_route53.py & test_elasticsearch.py
      </h3>
      <h1 align="center">
        5.2%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_boto_route53.py (21.367521%)<TH>test_elasticsearch.py (2.9620852%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match58195-0.html#0',2,'match58195-1.html#0',3)" NAME="0">(61-65)<TD><A HREF="javascript:ZweiFrames('match58195-0.html#0',2,'match58195-1.html#0',3)" NAME="0">(61-72)</A><TD ALIGN=center><FONT COLOR="#ff0000">13</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match58195-0.html#1',2,'match58195-1.html#1',3)" NAME="1">(45-55)<TD><A HREF="javascript:ZweiFrames('match58195-0.html#1',2,'match58195-1.html#1',3)" NAME="1">(151-162)</A><TD ALIGN=center><FONT COLOR="#eb0000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_boto_route53.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Jayesh Kariya &lt;jayeshk@saltstack.com&gt;
&quot;&quot;&quot;
import pytest
import salt.states.boto_route53 as boto_route53
from tests.support.mock import MagicMock, patch


@pytest.fixture
def configure_loader_modules():
    return {boto_route53: {}}


def test_present():
    &quot;&quot;&quot;
    Test to ensure the Route53 record is present.
    &quot;&quot;&quot;
    name = &quot;test.example.com.&quot;
    value = &quot;1.1.1.1&quot;
    zone = &quot;example.com.&quot;
    record_type = &quot;A&quot;

    ret = {&quot;name&quot;: name, &quot;result&quot;: False, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}

    mock = MagicMock(side_effect=[{}, {}, {&quot;value&quot;: &quot;&quot;}, False])
    mock_bool = MagicMock(return_value=False)
    with patch.dict(
        boto_route53.__salt__,
        {&quot;boto_route53.get_record&quot;: mock, &quot;boto_route53.add_record&quot;: mock_bool},
    ):
        with patch.dict(boto_route53.__opts__, {&quot;test&quot;: False}):
            comt = &quot;Failed to add {} Route53 record.&quot;.format(name)
            ret.update({&quot;comment&quot;: comt})
            assert boto_route53.present(name, value, zone, record_type) == ret

        with patch.dict(boto_route53.__opts__, {&quot;test&quot;: True}):
            comt = &quot;Route53 record {} set to be added.&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
            assert boto_route53.present(name, value, zone, record_type) == ret

            comt = &quot;Route53 record {} set to be updated.&quot;.format(name)
<A NAME="1"></A>            ret.update({&quot;comment&quot;: comt})
            assert boto_route53.present(name, value, zone, record_type) == ret

        ret<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match58195-1.html#1',3,'match58195-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: True})
        assert boto_route53.present(name, value, zone, record_type) == ret


def test_absent():
    &quot;&quot;&quot;
    Test to ensure the Route53 record is deleted.
    &quot;&quot;&quot;
    name = &quot;test.example.com.&quot;
    zone = &quot;example.com.&quot;
    record_type =</B></FONT> &quot;A&quot;

    ret = {&quot;name&quot;: name, &quot;result&quot;: True, &quot;changes&quot;: {}, &quot;comment&quot;: &quot;&quot;}
<A NAME="0"></A>
    mock = MagicMock(side_effect=[False, True])
    with patch.dict(boto_route53.__salt__, {&quot;boto_route53.get_record&quot;: mock}):
        comt = &quot;{} does not exist.&quot;<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match58195-1.html#0',3,'match58195-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.format(name)
        ret.update({&quot;comment&quot;: comt})
        assert boto_route53.absent(name, zone, record_type) == ret

        with patch.dict(boto_route53.__opts__, {&quot;test&quot;</B></FONT>: True}):
            comt = &quot;Route53 record {} set to be deleted.&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
            assert boto_route53.absent(name, zone, record_type) == ret
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_elasticsearch.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Lukas Raska &lt;lukas@raska.me&gt;
&quot;&quot;&quot;
import pytest
import salt.utils.dictdiffer as dictdiffer
from salt.exceptions import CommandExecutionError
from salt.states import elasticsearch
from tests.support.mock import MagicMock, patch


@pytest.fixture
def configure_loader_modules():
    return {
        elasticsearch: {
            &quot;__opts__&quot;: {&quot;test&quot;: False},
            &quot;__utils__&quot;: {&quot;dictdiffer.deep_diff&quot;: dictdiffer.deep_diff},
        }
    }


def test_index_absent():
    &quot;&quot;&quot;
    Test to manage a elasticsearch index.
    &quot;&quot;&quot;
    name = &quot;foo&quot;

    ret = {
        &quot;name&quot;: name,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;Index foo is already absent&quot;,
        &quot;changes&quot;: {},
    }

    mock_get = MagicMock(
        side_effect=[
            None,
            {name: {&quot;test&quot;: &quot;key&quot;}},
            {name: {}},
            {name: {&quot;test&quot;: &quot;key&quot;}},
            CommandExecutionError,
            {name: {&quot;test&quot;: &quot;key&quot;}},
        ]
    )
    mock_delete = MagicMock(side_effect=[True, False, CommandExecutionError])

    with patch.dict(
        elasticsearch.__salt__,
        {
            &quot;elasticsearch.index_get&quot;: mock_get,
            &quot;elasticsearch.index_delete&quot;: mock_delete,
        },
    ):
        assert elasticsearch.index_absent(name) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Successfully removed index foo&quot;,
<A NAME="0"></A>                &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}},
            }
        )
        assert elasticsearch<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match58195-0.html#0',2,'match58195-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.index_absent(name) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Failed to remove index foo for unknown reasons&quot;,
                &quot;result&quot;: False,
                &quot;changes&quot;: {},
            }
        )
        assert elasticsearch.index_absent(name) == ret

        with patch.dict(elasticsearch.__opts__, {&quot;test&quot;</B></FONT>: True}):
            ret.update(
                {
                    &quot;comment&quot;: &quot;Index foo will be removed&quot;,
                    &quot;result&quot;: None,
                    &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}},
                }
            )
            assert elasticsearch.index_absent(name) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.index_absent(name) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.index_absent(name) == ret


def test_index_present():
    &quot;&quot;&quot;
    Test to manage a elasticsearch index.
    &quot;&quot;&quot;
    name = &quot;foo&quot;

    ret = {
        &quot;name&quot;: name,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;Index foo is already present&quot;,
        &quot;changes&quot;: {},
    }

    mock_exists = MagicMock(
        side_effect=[True, False, False, False, CommandExecutionError, False, False]
    )
    mock_get = MagicMock(side_effect=[{name: {&quot;test&quot;: &quot;key&quot;}}, CommandExecutionError])
    mock_create = MagicMock(side_effect=[True, False, CommandExecutionError, True])

    with patch.dict(
        elasticsearch.__salt__,
        {
            &quot;elasticsearch.index_get&quot;: mock_get,
            &quot;elasticsearch.index_exists&quot;: mock_exists,
            &quot;elasticsearch.index_create&quot;: mock_create,
        },
    ):
        assert elasticsearch.index_present(name) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Successfully created index foo&quot;,
                &quot;changes&quot;: {&quot;new&quot;: {&quot;test&quot;: &quot;key&quot;}},
            }
        )
        assert elasticsearch.index_present(name) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Cannot create index foo, False&quot;,
                &quot;result&quot;: False,
                &quot;changes&quot;: {},
            }
        )
        assert elasticsearch.index_present(name) == ret

        with patch.dict(elasticsearch.__opts__, {&quot;test&quot;: True}):
            ret.update(
                {
                    &quot;comment&quot;: &quot;Index foo does not exist and will be created&quot;,
                    &quot;result&quot;: None,
                    &quot;changes&quot;: {&quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
                }
            )
            assert elasticsearch.index_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.index_absent(name) == ret

<A NAME="1"></A>        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.index_absent(name) == ret

        ret<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match58195-0.html#1',2,'match58195-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.index_absent(name) == ret


def test_alias_absent():
    &quot;&quot;&quot;
    Test to manage a elasticsearch alias.
    &quot;&quot;&quot;
    name = &quot;foo&quot;
    index = &quot;bar&quot;

    alias =</B></FONT> {index: {&quot;aliases&quot;: {name: {&quot;test&quot;: &quot;key&quot;}}}}

    ret = {
        &quot;name&quot;: name,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;Alias foo for index bar is already absent&quot;,
        &quot;changes&quot;: {},
    }

    mock_get = MagicMock(
        side_effect=[
            None,
            {&quot;foo2&quot;: {}},
            alias,
            alias,
            alias,
            CommandExecutionError,
            alias,
        ]
    )
    mock_delete = MagicMock(side_effect=[True, False, CommandExecutionError])

    with patch.dict(
        elasticsearch.__salt__,
        {
            &quot;elasticsearch.alias_get&quot;: mock_get,
            &quot;elasticsearch.alias_delete&quot;: mock_delete,
        },
    ):
        assert elasticsearch.alias_absent(name, index) == ret
        assert elasticsearch.alias_absent(name, index) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Successfully removed alias foo for index bar&quot;,
                &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}},
            }
        )
        assert elasticsearch.alias_absent(name, index) == ret

        ret.update(
            {
                &quot;comment&quot;: (
                    &quot;Failed to remove alias foo for index bar for unknown reasons&quot;
                ),
                &quot;result&quot;: False,
                &quot;changes&quot;: {},
            }
        )
        assert elasticsearch.alias_absent(name, index) == ret

        with patch.dict(elasticsearch.__opts__, {&quot;test&quot;: True}):
            ret.update(
                {
                    &quot;comment&quot;: &quot;Alias foo for index bar will be removed&quot;,
                    &quot;result&quot;: None,
                    &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}},
                }
            )
            assert elasticsearch.alias_absent(name, index) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.alias_absent(name, index) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.alias_absent(name, index) == ret


def test_alias_present():
    &quot;&quot;&quot;
    Test to manage a elasticsearch alias.
    &quot;&quot;&quot;
    name = &quot;foo&quot;
    index = &quot;bar&quot;

    alias = {index: {&quot;aliases&quot;: {name: {&quot;test&quot;: &quot;key&quot;}}}}

    ret = {
        &quot;name&quot;: name,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;Alias foo for index bar is already present&quot;,
        &quot;changes&quot;: {},
    }

    mock_get = MagicMock(
        side_effect=[
            alias,
            alias,
            None,
            None,
            None,
            alias,
            CommandExecutionError,
            None,
        ]
    )
    mock_create = MagicMock(side_effect=[True, True, False, CommandExecutionError])

    with patch.dict(
        elasticsearch.__salt__,
        {
            &quot;elasticsearch.alias_get&quot;: mock_get,
            &quot;elasticsearch.alias_create&quot;: mock_create,
        },
    ):
        assert elasticsearch.alias_present(name, index, {&quot;test&quot;: &quot;key&quot;}) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Successfully replaced alias foo for index bar&quot;,
                &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}, &quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
            }
        )
        assert elasticsearch.alias_present(name, index, {&quot;test2&quot;: &quot;key&quot;}) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Successfully created alias foo for index bar&quot;,
                &quot;changes&quot;: {&quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
            }
        )
        assert elasticsearch.alias_present(name, index, {&quot;test2&quot;: &quot;key&quot;}) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Cannot create alias foo for index bar, False&quot;,
                &quot;result&quot;: False,
            }
        )
        assert elasticsearch.alias_present(name, index, {&quot;test2&quot;: &quot;key&quot;}) == ret

        with patch.dict(elasticsearch.__opts__, {&quot;test&quot;: True}):
            ret.update(
                {
                    &quot;comment&quot;: (
                        &quot;Alias foo for index bar does not exist and will be created&quot;
                    ),
                    &quot;result&quot;: None,
                    &quot;changes&quot;: {&quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
                }
            )
            assert elasticsearch.alias_present(name, index, {&quot;test2&quot;: &quot;key&quot;}) == ret

            ret.update(
                {
                    &quot;comment&quot;: (
                        &quot;Alias foo for index bar exists with wrong configuration and&quot;
                        &quot; will be overridden&quot;
                    ),
                    &quot;result&quot;: None,
                    &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}, &quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
                }
            )
            assert elasticsearch.alias_present(name, index, {&quot;test2&quot;: &quot;key&quot;}) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.alias_present(name, index) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.alias_present(name, index) == ret


def test_index_template_absent():
    &quot;&quot;&quot;
    Test to manage a elasticsearch index template.
    &quot;&quot;&quot;
    name = &quot;foo&quot;

    index_template = {name: {&quot;test&quot;: &quot;key&quot;}}

    ret = {
        &quot;name&quot;: name,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;Index template foo is already absent&quot;,
        &quot;changes&quot;: {},
    }

    mock_get = MagicMock(
        side_effect=[
            None,
            {&quot;bar&quot;: {}},
            index_template,
            index_template,
            index_template,
            CommandExecutionError,
            index_template,
        ]
    )
    mock_delete = MagicMock(side_effect=[True, False, CommandExecutionError])

    with patch.dict(
        elasticsearch.__salt__,
        {
            &quot;elasticsearch.index_template_get&quot;: mock_get,
            &quot;elasticsearch.index_template_delete&quot;: mock_delete,
        },
    ):
        assert elasticsearch.index_template_absent(name) == ret
        assert elasticsearch.index_template_absent(name) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Successfully removed index template foo&quot;,
                &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}},
            }
        )
        assert elasticsearch.index_template_absent(name) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Failed to remove index template foo for unknown reasons&quot;,
                &quot;result&quot;: False,
                &quot;changes&quot;: {},
            }
        )
        assert elasticsearch.index_template_absent(name) == ret

        with patch.dict(elasticsearch.__opts__, {&quot;test&quot;: True}):
            ret.update(
                {
                    &quot;comment&quot;: &quot;Index template foo will be removed&quot;,
                    &quot;result&quot;: None,
                    &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}},
                }
            )
            assert elasticsearch.index_template_absent(name) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.index_template_absent(name) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.index_template_absent(name) == ret


def test_index_template_present():
    &quot;&quot;&quot;
    Test to manage a elasticsearch index template.
    &quot;&quot;&quot;
    name = &quot;foo&quot;

    index_template = {name: {&quot;test&quot;: &quot;key&quot;}}

    ret = {
        &quot;name&quot;: name,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;Index template foo is already present&quot;,
        &quot;changes&quot;: {},
    }

    mock_exists = MagicMock(
        side_effect=[True, False, False, False, CommandExecutionError, False, False]
    )
    mock_create = MagicMock(side_effect=[True, False, CommandExecutionError, True])
    mock_get = MagicMock(side_effect=[index_template, CommandExecutionError])

    with patch.dict(
        elasticsearch.__salt__,
        {
            &quot;elasticsearch.index_template_get&quot;: mock_get,
            &quot;elasticsearch.index_template_create&quot;: mock_create,
            &quot;elasticsearch.index_template_exists&quot;: mock_exists,
        },
    ):
        assert elasticsearch.index_template_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Successfully created index template foo&quot;,
                &quot;changes&quot;: {&quot;new&quot;: {&quot;test&quot;: &quot;key&quot;}},
            }
        )
        assert elasticsearch.index_template_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Cannot create index template foo, False&quot;,
                &quot;result&quot;: False,
                &quot;changes&quot;: {},
            }
        )
        assert elasticsearch.index_template_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

        with patch.dict(elasticsearch.__opts__, {&quot;test&quot;: True}):
            ret.update(
                {
                    &quot;comment&quot;: &quot;Index template foo does not exist and will be created&quot;,
                    &quot;result&quot;: None,
                    &quot;changes&quot;: {&quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
                }
            )
            assert elasticsearch.index_template_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.index_template_present(name, {}) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.index_template_present(name, {}) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.index_template_present(name, {}) == ret


def test_index_template_present_check_definition():
    &quot;&quot;&quot;
    Test to manage a elasticsearch index template.
    with check_definition set
    &quot;&quot;&quot;
    name = &quot;foo&quot;

    index_template = {
        name: {&quot;test2&quot;: &quot;key&quot;, &quot;aliases&quot;: {}, &quot;mappings&quot;: {}, &quot;settings&quot;: {}}
    }

    expected = {
        &quot;name&quot;: name,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;Index template foo is already present and up to date&quot;,
        &quot;changes&quot;: {},
    }

    mock_exists = MagicMock(side_effect=[True])
    mock_create = MagicMock(side_effect=[True])
    mock_get = MagicMock(side_effect=[index_template])

    with patch.dict(
        elasticsearch.__salt__,
        {
            &quot;elasticsearch.index_template_get&quot;: mock_get,
            &quot;elasticsearch.index_template_create&quot;: mock_create,
            &quot;elasticsearch.index_template_exists&quot;: mock_exists,
        },
    ):

        ret = elasticsearch.index_template_present(
            name, {&quot;test2&quot;: &quot;key&quot;, &quot;aliases&quot;: {}}, check_definition=True
        )
        assert expected == ret


def test_index_template_present_check_definition_alias_not_empty():
    &quot;&quot;&quot;
    Test to manage a elasticsearch index template.
    with check_definition set and alias is not empty
    &quot;&quot;&quot;
    name = &quot;foo&quot;

    index_template = {
        name: {&quot;test2&quot;: &quot;key&quot;, &quot;aliases&quot;: {}, &quot;mappings&quot;: {}, &quot;settings&quot;: {}}
    }

    expected = {
        &quot;name&quot;: name,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;Successfully updated index template foo&quot;,
        &quot;changes&quot;: {&quot;new&quot;: {&quot;aliases&quot;: {&quot;alias1&quot;: {}}}, &quot;old&quot;: {&quot;aliases&quot;: {}}},
    }

    mock_exists = MagicMock(side_effect=[True])
    mock_create = MagicMock(side_effect=[True])
    mock_get = MagicMock(side_effect=[index_template])

    with patch.dict(
        elasticsearch.__salt__,
        {
            &quot;elasticsearch.index_template_get&quot;: mock_get,
            &quot;elasticsearch.index_template_create&quot;: mock_create,
            &quot;elasticsearch.index_template_exists&quot;: mock_exists,
        },
    ):

        ret = elasticsearch.index_template_present(
            name, {&quot;test2&quot;: &quot;key&quot;, &quot;aliases&quot;: {&quot;alias1&quot;: {}}}, check_definition=True
        )
        assert expected == ret


def test_pipeline_absent():
    &quot;&quot;&quot;
    Test to manage a elasticsearch pipeline.
    &quot;&quot;&quot;
    name = &quot;foo&quot;

    pipeline = {name: {&quot;test&quot;: &quot;key&quot;}}

    ret = {
        &quot;name&quot;: name,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;Pipeline foo is already absent&quot;,
        &quot;changes&quot;: {},
    }

    mock_get = MagicMock(
        side_effect=[
            None,
            {&quot;foo2&quot;: {}},
            pipeline,
            pipeline,
            pipeline,
            CommandExecutionError,
            pipeline,
        ]
    )
    mock_delete = MagicMock(side_effect=[True, False, CommandExecutionError])

    with patch.dict(
        elasticsearch.__salt__,
        {
            &quot;elasticsearch.pipeline_get&quot;: mock_get,
            &quot;elasticsearch.pipeline_delete&quot;: mock_delete,
        },
    ):
        assert elasticsearch.pipeline_absent(name) == ret
        assert elasticsearch.pipeline_absent(name) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Successfully removed pipeline foo&quot;,
                &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}},
            }
        )
        assert elasticsearch.pipeline_absent(name) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Failed to remove pipeline foo for unknown reasons&quot;,
                &quot;result&quot;: False,
                &quot;changes&quot;: {},
            }
        )
        assert elasticsearch.pipeline_absent(name) == ret

        with patch.dict(elasticsearch.__opts__, {&quot;test&quot;: True}):
            ret.update(
                {
                    &quot;comment&quot;: &quot;Pipeline foo will be removed&quot;,
                    &quot;result&quot;: None,
                    &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}},
                }
            )
            assert elasticsearch.pipeline_absent(name) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.pipeline_absent(name) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.pipeline_absent(name) == ret


def test_pipeline_present():
    &quot;&quot;&quot;
    Test to manage a elasticsearch pipeline.
    &quot;&quot;&quot;
    name = &quot;foo&quot;

    pipeline = {name: {&quot;test&quot;: &quot;key&quot;}}

    ret = {
        &quot;name&quot;: name,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;Pipeline foo is already present&quot;,
        &quot;changes&quot;: {},
    }

    mock_get = MagicMock(
        side_effect=[
            pipeline,
            pipeline,
            None,
            None,
            None,
            pipeline,
            CommandExecutionError,
            None,
        ]
    )
    mock_create = MagicMock(side_effect=[True, True, False, CommandExecutionError])

    with patch.dict(
        elasticsearch.__salt__,
        {
            &quot;elasticsearch.pipeline_get&quot;: mock_get,
            &quot;elasticsearch.pipeline_create&quot;: mock_create,
        },
    ):
        assert elasticsearch.pipeline_present(name, {&quot;test&quot;: &quot;key&quot;}) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Successfully replaced pipeline foo&quot;,
                &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}, &quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
            }
        )
        assert elasticsearch.pipeline_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Successfully created pipeline foo&quot;,
                &quot;changes&quot;: {&quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
            }
        )
        assert elasticsearch.pipeline_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

        ret.update({&quot;comment&quot;: &quot;Cannot create pipeline foo, False&quot;, &quot;result&quot;: False})
        assert elasticsearch.pipeline_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

        with patch.dict(elasticsearch.__opts__, {&quot;test&quot;: True}):
            ret.update(
                {
                    &quot;comment&quot;: &quot;Pipeline foo does not exist and will be created&quot;,
                    &quot;result&quot;: None,
                    &quot;changes&quot;: {&quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
                }
            )
            assert elasticsearch.pipeline_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

            ret.update(
                {
                    &quot;comment&quot;: (
                        &quot;Pipeline foo exists with wrong configuration and will be&quot;
                        &quot; overridden&quot;
                    ),
                    &quot;result&quot;: None,
                    &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}, &quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
                }
            )
            assert elasticsearch.pipeline_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.pipeline_present(name, {}) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.pipeline_present(name, {}) == ret


def test_search_template_absent():
    &quot;&quot;&quot;
    Test to manage a elasticsearch search template.
    &quot;&quot;&quot;
    name = &quot;foo&quot;

    template = {&quot;template&quot;: '{&quot;test&quot;: &quot;key&quot;}'}

    ret = {
        &quot;name&quot;: name,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;Search template foo is already absent&quot;,
        &quot;changes&quot;: {},
    }

    mock_get = MagicMock(
        side_effect=[
            None,
            template,
            template,
            template,
            CommandExecutionError,
            template,
        ]
    )
    mock_delete = MagicMock(side_effect=[True, False, CommandExecutionError])

    with patch.dict(
        elasticsearch.__salt__,
        {
            &quot;elasticsearch.search_template_get&quot;: mock_get,
            &quot;elasticsearch.search_template_delete&quot;: mock_delete,
        },
    ):
        assert elasticsearch.search_template_absent(name) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Successfully removed search template foo&quot;,
                &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}},
            }
        )
        assert elasticsearch.search_template_absent(name) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Failed to remove search template foo for unknown reasons&quot;,
                &quot;result&quot;: False,
                &quot;changes&quot;: {},
            }
        )
        assert elasticsearch.search_template_absent(name) == ret

        with patch.dict(elasticsearch.__opts__, {&quot;test&quot;: True}):
            ret.update(
                {
                    &quot;comment&quot;: &quot;Search template foo will be removed&quot;,
                    &quot;result&quot;: None,
                    &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}},
                }
            )
            assert elasticsearch.search_template_absent(name) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.search_template_absent(name) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.search_template_absent(name) == ret


def test_search_template_present():
    &quot;&quot;&quot;
    Test to manage a elasticsearch search template.
    &quot;&quot;&quot;
    name = &quot;foo&quot;

    template = {&quot;template&quot;: '{&quot;test&quot;: &quot;key&quot;}'}

    ret = {
        &quot;name&quot;: name,
        &quot;result&quot;: True,
        &quot;comment&quot;: &quot;Search template foo is already present&quot;,
        &quot;changes&quot;: {},
    }

    mock_get = MagicMock(
        side_effect=[
            template,
            template,
            None,
            None,
            None,
            template,
            CommandExecutionError,
            None,
        ]
    )
    mock_create = MagicMock(side_effect=[True, True, False, CommandExecutionError])

    with patch.dict(
        elasticsearch.__salt__,
        {
            &quot;elasticsearch.search_template_get&quot;: mock_get,
            &quot;elasticsearch.search_template_create&quot;: mock_create,
        },
    ):
        assert elasticsearch.search_template_present(name, {&quot;test&quot;: &quot;key&quot;}) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Successfully replaced search template foo&quot;,
                &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}, &quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
            }
        )
        assert elasticsearch.search_template_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

        ret.update(
            {
                &quot;comment&quot;: &quot;Successfully created search template foo&quot;,
                &quot;changes&quot;: {&quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
            }
        )
        assert elasticsearch.search_template_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

        ret.update(
            {&quot;comment&quot;: &quot;Cannot create search template foo, False&quot;, &quot;result&quot;: False}
        )
        assert elasticsearch.search_template_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

        with patch.dict(elasticsearch.__opts__, {&quot;test&quot;: True}):
            ret.update(
                {
                    &quot;comment&quot;: &quot;Search template foo does not exist and will be created&quot;,
                    &quot;result&quot;: None,
                    &quot;changes&quot;: {&quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
                }
            )
            assert elasticsearch.search_template_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

            ret.update(
                {
                    &quot;comment&quot;: (
                        &quot;Search template foo exists with wrong configuration and will&quot;
                        &quot; be overridden&quot;
                    ),
                    &quot;result&quot;: None,
                    &quot;changes&quot;: {&quot;old&quot;: {&quot;test&quot;: &quot;key&quot;}, &quot;new&quot;: {&quot;test2&quot;: &quot;key&quot;}},
                }
            )
            assert elasticsearch.search_template_present(name, {&quot;test2&quot;: &quot;key&quot;}) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.search_template_present(name, {}) == ret

        ret.update({&quot;comment&quot;: &quot;&quot;, &quot;result&quot;: False, &quot;changes&quot;: {}})
        assert elasticsearch.search_template_present(name, {}) == ret
</PRE>
</div>
  </div>
</body>
</html>
