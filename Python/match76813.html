<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_bower_1.py &amp; joyent.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_bower_1.py &amp; joyent.py
      </h3>
<h1 align="center">
        4.2%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_bower_1.py (25.925926%)<th>joyent.py (2.3045268%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(66-72)<td><a href="#" name="0">(359-363)</a><td align="center"><font color="#ff0000">15</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(22-28)<td><a href="#" name="1">(1168-1172)</a><td align="center"><font color="#dd0000">13</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_bower_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import pytest
2 import salt.utils.json
3 import salt.utils.path
4 from tests.support.case import ModuleCase
5 from tests.support.mixins import SaltReturnAssertsMixin
6 from tests.support.unit import skipIf
7 @skipIf(salt.utils.path.which("bower") is None, "bower not installed")
8 class BowerStateTest(ModuleCase, SaltReturnAssertsMixin):
9     @pytest.mark.destructive_test
10     @pytest.mark.slow_test
11     def test_bower_installed_removed(self):
12         ret = self.run_state("file.directory", name="/salt_test_bower_1", makedirs<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=True)
13         self.assertSaltTrueReturn(ret)
14         ret = self.run_state(
15             "bower.installed", name="underscore", dir="/salt_test_bower_1"
16         )
17         self.assertSaltTrueReturn(ret)
18         ret = self.run_state(</b></font>
19             "bower.removed", name="underscore", dir="/salt_test_bower_1"
20         )
21         self.assertSaltTrueReturn(ret)
22         ret = self.run_state("file.absent", name="/salt_test_bower_1")
23         self.assertSaltTrueReturn(ret)
24     @pytest.mark.destructive_test
25     @pytest.mark.slow_test
26     def test_bower_installed_pkgs(self):
27         ret = self.run_state("file.directory", name="/salt_test_bower_2", makedirs=True)
28         self.assertSaltTrueReturn(ret)
29         ret = self.run_state(
30             "bower.installed",
31             name="test",
32             dir="/salt_test_bower_2",
33             pkgs=["numeral", "underscore"],
34         )
35         self.assertSaltTrueReturn(ret)
36         ret = self.run_state("file.absent", name="/salt_test_bower_2")
37         self.assertSaltTrueReturn(ret)
38     @pytest.mark.destructive_test
39     @pytest.mark.slow_test
40     def test_bower_installed_from_file(self):
41         ret = self.run_state("file.directory", name="/salt_test_bower_3", makedirs=True)
42         self.assertSaltTrueReturn(ret)
43         bower_json = salt.utils.json.dumps(
44             {
45                 "name": "salt_test_bower_3",
46                 "dependencies": {"numeral": "~1.5.3", "underscore": "~1.7.0"},
47         )
48         ret = self.run_state(
49             "file.managed", name="/salt_test_bower_3/bower.json", contents<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=bower_json
50         )
51         self.assertSaltTrueReturn(ret)
52         ret = self.run_state("bower.bootstrap", name="/salt_test_bower_3")
53         self.assertSaltTrueReturn(ret)
54         ret = self.run_state("file.absent", name="/salt_test_bower_3")
55         self.assertSaltTrueReturn(</b></font>ret)
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>joyent.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import base64
2 import datetime
3 import http.client
4 import inspect
5 import logging
6 import os
7 import pprint
8 import salt.config as config
9 import salt.utils.cloud
10 import salt.utils.files
11 import salt.utils.http
12 import salt.utils.json
13 import salt.utils.yaml
14 from salt.exceptions import (
15     SaltCloudExecutionFailure,
16     SaltCloudExecutionTimeout,
17     SaltCloudNotFound,
18     SaltCloudSystemExit,
19 )
20 try:
21     from M2Crypto import EVP
22     HAS_REQUIRED_CRYPTO = True
23     HAS_M2 = True
24 except ImportError:
25     HAS_M2 = False
26     try:
27         from Cryptodome.Hash import SHA256
28         from Cryptodome.Signature import PKCS1_v1_5
29         HAS_REQUIRED_CRYPTO = True
30     except ImportError:
31         try:
32             from Crypto.Hash import SHA256  # nosec
33             from Crypto.Signature import PKCS1_v1_5  # nosec
34             HAS_REQUIRED_CRYPTO = True
35         except ImportError:
36             HAS_REQUIRED_CRYPTO = False
37 log = logging.getLogger(__name__)
38 __virtualname__ = "joyent"
39 JOYENT_API_HOST_SUFFIX = ".api.joyentcloud.com"
40 JOYENT_API_VERSION = "~7.2"
41 JOYENT_LOCATIONS = {
42     "us-east-1": "North Virginia, USA",
43     "us-west-1": "Bay Area, California, USA",
44     "us-sw-1": "Las Vegas, Nevada, USA",
45     "eu-ams-1": "Amsterdam, Netherlands",
46 }
47 DEFAULT_LOCATION = "us-east-1"
48 POLL_ALL_LOCATIONS = True
49 VALID_RESPONSE_CODES = [
50     http.client.OK,
51     http.client.ACCEPTED,
52     http.client.CREATED,
53     http.client.NO_CONTENT,
54 ]
55 def __virtual__():
56     if HAS_REQUIRED_CRYPTO is False:
57         return False, "Either PyCrypto or Cryptodome needs to be installed."
58     if get_configured_provider() is False:
59         return False
60     return __virtualname__
61 def _get_active_provider_name():
62     try:
63         return __active_provider_name__.value()
64     except AttributeError:
65         return __active_provider_name__
66 def get_configured_provider():
67     return config.is_provider_configured(
68         __opts__, _get_active_provider_name() or __virtualname__, ("user", "password")
69     )
70 def get_image(vm_):
71     images = avail_images()
72     vm_image = config.get_cloud_config_value("image", vm_, __opts__)
73     if vm_image and str(vm_image) in images:
74         images[vm_image]["name"] = images[vm_image]["id"]
75         return images[vm_image]
76     raise SaltCloudNotFound(
77         "The specified image, '{}', could not be found.".format(vm_image)
78     )
79 def get_size(vm_):
80     sizes = avail_sizes()
81     vm_size = config.get_cloud_config_value("size", vm_, __opts__)
82     if not vm_size:
83         raise SaltCloudNotFound("No size specified for this VM.")
84     if vm_size and str(vm_size) in sizes:
85         return sizes[vm_size]
86     raise SaltCloudNotFound(
87         "The specified size, '{}', could not be found.".format(vm_size)
88     )
89 def query_instance(vm_=None, call=None):
90     if isinstance(vm_, str) and call == "action":
91         vm_ = {"name": vm_, "provider": "joyent"}
92     if call == "function":
93         raise SaltCloudSystemExit(
94             "The query_instance action must be called with -a or --action."
95         )
96     __utils__["cloud.fire_event"](
97         "event",
98         "querying instance",
99         "salt/cloud/{}/querying".format(vm_["name"]),
100         sock_dir=__opts__["sock_dir"],
101         transport=__opts__["transport"],
102     )
103     def _query_ip_address():
104         data = show_instance(vm_["name"], call="action")
105         if not data:
106             log.error("There was an error while querying Joyent. Empty response")
107             return False
108         if isinstance(data, dict) and "error" in data:
109             log.warning("There was an error in the query %s", data.get("error"))
110             return False
111         log.debug("Returned query data: %s", data)
112         if "primaryIp" in data[1]:
113             if data[1]["state"] == "running":
114                 return data[1]["primaryIp"]
115         return None
116     try:
117         data = salt.utils.cloud.wait_for_ip(
118             _query_ip_address,
119             timeout=config.get_cloud_config_value(
120                 "wait_for_ip_timeout", vm_, __opts__, default=10 * 60
121             ),
122             interval=config.get_cloud_config_value(
123                 "wait_for_ip_interval", vm_, __opts__, default=10
124             ),
125             interval_multiplier=config.get_cloud_config_value(
126                 "wait_for_ip_interval_multiplier", vm_, __opts__, default=1
127             ),
128         )
129     except (SaltCloudExecutionTimeout, SaltCloudExecutionFailure) as exc:
130         try:
131             pass
132         except SaltCloudSystemExit:
133             pass
134         finally:
135             raise SaltCloudSystemExit(str(exc))
136     return data
137 def create(vm_):
138     try:
139         if (
140             vm_["profile"]
141             and config.is_profile_configured(
142                 __opts__,
143                 _get_active_provider_name() or "joyent",
144                 vm_["profile"],
145                 vm_=vm_,
146             )
147             is False
148         ):
149             return False
150     except AttributeError:
151         pass
152     key_filename = config.get_cloud_config_value(
153         "private_key", vm_, __opts__, search_global=False, default=None
154     )
155     __utils__["cloud.fire_event"](
156         "event",
157         "starting create",
158         "salt/cloud/{}/creating".format(vm_["name"]),
159         args=__utils__["cloud.filter_event"](
160             "creating", vm_, ["name", "profile", "provider", "driver"]
161         ),
162         sock_dir=__opts__["sock_dir"],
163         transport=__opts__["transport"],
164     )
165     log.info(
166         "Creating Cloud VM %s in %s", vm_["name"], vm_.get("location", DEFAULT_LOCATION)
167     )
168     salt.utils.cloud.check_name(vm_["name"], "a-zA-Z0-9-.")
169     kwargs = {
170         "name": vm_["name"],
171         "image": get_image(vm_),
172         "size": get_size(vm_),
173         "location": vm_.get("location", DEFAULT_LOCATION),
174     }
175     if "networks" in vm_:
176         kwargs["networks"] = vm_.get("networks")
177     __utils__["cloud.fire_event"](
178         "event",
179         "requesting instance",
180         "salt/cloud/{}/requesting".format(vm_["name"]),
181         args={
182             "kwargs": __utils__["cloud.filter_event"](
183                 "requesting", kwargs, list(kwargs)
184             ),
185         },
186         sock_dir=__opts__["sock_dir"],
187         transport=__opts__["transport"],
188     )
189     data = create_node(**kwargs)
190     if data == {}:
191         log.error("Error creating %s on JOYENT", vm_["name"])
192         return False
193     query_instance(vm_)
194     data = show_instance(vm_["name"], call="action")
195     vm_["key_filename"] = key_filename
196     vm_["ssh_host"] = data[1]["primaryIp"]
197     __utils__["cloud.bootstrap"](vm_, __opts__)
198     __utils__["cloud.fire_event"](
199         "event",
200         "created instance",
201         "salt/cloud/{}/created".format(vm_["name"]),
202         args=__utils__["cloud.filter_event"](
203             "created", vm_, ["name", "profile", "provider", "driver"]
204         ),
205         sock_dir=__opts__["sock_dir"],
206         transport=__opts__["transport"],
207     )
208     return data[1]
209 def create_node(**kwargs):
210     name = kwargs["name"]
211     image = kwargs["image"]
212     location = kwargs["location"]
213     networks <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= kwargs.get("networks")
214     tag = kwargs.get("tag")
215     locality = kwargs.get("locality")
216     metadata = kwargs.get("metadata")
217     firewall_enabled = kwargs.get(</b></font>"firewall_enabled")
218     create_data = {
219         "name": name,
220         "package": size["name"],
221         "image": image["name"],
222     }
223     if networks is not None:
224         create_data["networks"] = networks
225     if locality is not None:
226         create_data["locality"] = locality
227     if metadata is not None:
228         for key, value in metadata.items():
229             create_data["metadata.{}".format(key)] = value
230     if tag is not None:
231         for key, value in tag.items():
232             create_data["tag.{}".format(key)] = value
233     if firewall_enabled is not None:
234         create_data["firewall_enabled"] = firewall_enabled
235     data = salt.utils.json.dumps(create_data)
236     ret = query(command="my/machines", data=data, method="POST", location=location)
237     if ret[0] in VALID_RESPONSE_CODES:
238         return ret[1]
239     else:
240         log.error("Failed to create node %s: %s", name, ret[1])
241     return {}
242 def destroy(name, call=None):
243     if call == "function":
244         raise SaltCloudSystemExit(
245             "The destroy action must be called with -d, --destroy, -a or --action."
246         )
247     __utils__["cloud.fire_event"](
248         "event",
249         "destroying instance",
250         "salt/cloud/{}/destroying".format(name),
251         args={"name": name},
252         sock_dir=__opts__["sock_dir"],
253         transport=__opts__["transport"],
254     )
255     node = get_node(name)
256     ret = query(
257         command="my/machines/{}".format(node["id"]),
258         location=node["location"],
259         method="DELETE",
260     )
261     __utils__["cloud.fire_event"](
262         "event",
263         "destroyed instance",
264         "salt/cloud/{}/destroyed".format(name),
265         args={"name": name},
266         sock_dir=__opts__["sock_dir"],
267         transport=__opts__["transport"],
268     )
269     if __opts__.get("update_cachedir", False) is True:
270         __utils__["cloud.delete_minion_cachedir"](
271             name, _get_active_provider_name().split(":")[0], __opts__
272         )
273     return ret[0] in VALID_RESPONSE_CODES
274 def reboot(name, call=None):
275     node = get_node(name)
276     ret = take_action(
277         name=name,
278         call=call,
279         method="POST",
280         command="my/machines/{}".format(node["id"]),
281         location=node["location"],
282         data={"action": "reboot"},
283     )
284     return ret[0] in VALID_RESPONSE_CODES
285 def stop(name, call=None):
286     node = get_node(name)
287     ret = take_action(
288         name=name,
289         call=call,
290         method="POST",
291         command="my/machines/{}".format(node["id"]),
292         location=node["location"],
293         data={"action": "stop"},
294     )
295     return ret[0] in VALID_RESPONSE_CODES
296 def start(name, call=None):
297     node = get_node(name)
298     ret = take_action(
299         name=name,
300         call=call,
301         method="POST",
302         command="my/machines/{}".format(node["id"]),
303         location=node["location"],
304         data={"action": "start"},
305     )
306     return ret[0] in VALID_RESPONSE_CODES
307 def take_action(
308     name=None,
309     call=None,
310     command=None,
311     data=None,
312     method="GET",
313     location=DEFAULT_LOCATION,
314 ):
315     caller = inspect.stack()[1][3]
316     if call != "action":
317         raise SaltCloudSystemExit("This action must be called with -a or --action.")
318     if data:
319         data = salt.utils.json.dumps(data)
320     ret = []
321     try:
322         ret = query(command=command, data=data, method=method, location=location)
323         log.info("Success %s for node %s", caller, name)
324     except Exception as exc:  # pylint: disable=broad-except
325         if "InvalidState" in str(exc):
326             ret = [200, {}]
327         else:
328             log.error(
329                 "Failed to invoke %s node %s: %s",
330                 caller,
331                 name,
332                 exc,
333                 exc_info_on_loglevel=logging.DEBUG,
334             )
335             ret = [100, {}]
336     return ret
337 def ssh_interface(vm_):
338     return config.get_cloud_config_value(
339         "ssh_interface", vm_, __opts__, default="public_ips", search_global=False
340     )
341 def get_location(vm_=None):
342     return __opts__.get(
343         "location",
344         config.get_cloud_config_value(
345             "location",
346             vm_ or get_configured_provider(),
347             __opts__,
348             default=DEFAULT_LOCATION,
349             search_global=False,
350         ),
351     )
352 def avail_locations(call=None):
353     if call == "action":
354         raise SaltCloudSystemExit(
355             "The avail_locations function must be called with "
356             "-f or --function, or with the --list-locations option"
357         )
358     ret = {}
359     for key in JOYENT_LOCATIONS:
360         ret[key] = {"name": key, "region": JOYENT_LOCATIONS[key]}
361     return ret
362 def has_method(obj, method_name):
363     if method_name in dir(obj):
364         return True
365     log.error("Method '%s' not yet supported!", method_name)
366     return False
367 def key_list(items=None):
368     if items is None:
369         items = []
370     ret = {}
371     if items and isinstance(items, list):
372         for item in items:
373             if "name" in item:
374                 if "id" not in item:
375                     item["id"] = item["name"]
376                 ret[item["name"]] = item
377     return ret
378 def get_node(name):
379     nodes = list_nodes()
380     if name in nodes:
381         return nodes[name]
382     return None
383 def show_instance(name, call=None):
384     node = get_node(name)
385     ret = query(
386         command="my/machines/{}".format(node["id"]),
387         location=node["location"],
388         method="GET",
389     )
390     return ret
391 def _old_libcloud_node_state(id_):
392     states_int = {
393         0: "RUNNING",
394         1: "REBOOTING",
395         2: "TERMINATED",
396         3: "PENDING",
397         4: "UNKNOWN",
398         5: "STOPPED",
399         6: "SUSPENDED",
400         7: "ERROR",
401         8: "PAUSED",
402     }
403     states_str = {
404         "running": "RUNNING",
405         "rebooting": "REBOOTING",
406         "starting": "STARTING",
407         "terminated": "TERMINATED",
408         "pending": "PENDING",
409         "unknown": "UNKNOWN",
410         "stopping": "STOPPING",
411         "stopped": "STOPPED",
412         "suspended": "SUSPENDED",
413         "error": "ERROR",
414         "paused": "PAUSED",
415         "reconfiguring": "RECONFIGURING",
416     }
417     return states_str[id_] if isinstance(id_, str) else states_int[id_]
418 def joyent_node_state(id_):
419     states = {
420         "running": 0,
421         "stopped": 2,
422         "stopping": 2,
423         "provisioning": 3,
424         "deleted": 2,
425         "unknown": 4,
426     }
427     if id_ not in states:
428         id_ = "unknown"
429     return _old_libcloud_node_state(states[id_])
430 def reformat_node(item=None, full=False):
431     desired_keys = [
432         "id",
433         "name",
434         "state",
435         "public_ips",
436         "private_ips",
437         "size",
438         "image",
439         "location",
440     ]
441     item["private_ips"] = []
442     item["public_ips"] = []
443     if "ips" in item:
444         for ip in item["ips"]:
445             if salt.utils.cloud.is_public_ip(ip):
446                 item["public_ips"].append(ip)
447             else:
448                 item["private_ips"].append(ip)
449     for key in desired_keys:
450         if key not in item:
451             item[key] = None
452     to_del = []
453     if not full:
454         for key in item.keys():  # iterate over a copy of the keys
455             if key not in desired_keys:
456                 to_del.append(key)
457     for key in to_del:
458         del item[key]
459     if "state" in item:
460         item["state"] = joyent_node_state(item["state"])
461     return item
462 def list_nodes(full=False, call=None):
463     if call == "action":
464         raise SaltCloudSystemExit(
465             "The list_nodes function must be called with -f or --function."
466         )
467     ret = {}
468     if POLL_ALL_LOCATIONS:
469         for location in JOYENT_LOCATIONS:
470             result = query(command="my/machines", location=location, method="GET")
471             if result[0] in VALID_RESPONSE_CODES:
472                 nodes = result[1]
473                 for node in nodes:
474                     if "name" in node:
475                         node["location"] = location
476                         ret[node["name"]] = reformat_node(item=node, full=full)
477             else:
478                 log.error("Invalid response when listing Joyent nodes: %s", result[1])
479     else:
480         location = get_location()
481         result = query(command="my/machines", location=location, method="GET")
482         nodes = result[1]
483         for node in nodes:
484             if "name" in node:
485                 node["location"] = location
486                 ret[node["name"]] = reformat_node(item=node, full=full)
487     return ret
488 def list_nodes_full(call=None):
489     if call == "action":
490         raise SaltCloudSystemExit(
491             "The list_nodes_full function must be called with -f or --function."
492         )
493     return list_nodes(full=True)
494 def list_nodes_select(call=None):
495     return salt.utils.cloud.list_nodes_select(
496         list_nodes_full("function"),
497         __opts__["query.selection"],
498         call,
499     )
500 def _get_proto():
501     use_ssl = config.get_cloud_config_value(
502         "use_ssl",
503         get_configured_provider(),
504         __opts__,
505         search_global=False,
506         default=True,
507     )
508     if use_ssl is True:
509         return "https"
510     return "http"
511 def avail_images(call=None):
512     if call == "action":
513         raise SaltCloudSystemExit(
514             "The avail_images function must be called with "
515             "-f or --function, or with the --list-images option"
516         )
517     user = config.get_cloud_config_value(
518         "user", get_configured_provider(), __opts__, search_global=False
519     )
520     img_url = config.get_cloud_config_value(
521         "image_url",
522         get_configured_provider(),
523         __opts__,
524         search_global=False,
525         default="{}{}/{}/images".format(DEFAULT_LOCATION, JOYENT_API_HOST_SUFFIX, user),
526     )
527     if not img_url.startswith("http://") and not img_url.startswith("https://"):
528         img_url = "{}://{}".format(_get_proto(), img_url)
529     rcode, data = query(command="my/images", method="GET")
530     log.debug(data)
531     ret = {}
532     for image in data:
533         ret[image["name"]] = image
534     return ret
535 def avail_sizes(call=None):
536     if call == "action":
537         raise SaltCloudSystemExit(
538             "The avail_sizes function must be called with "
539             "-f or --function, or with the --list-sizes option"
540         )
541     rcode, items = query(command="my/packages")
542     if rcode not in VALID_RESPONSE_CODES:
543         return {}
544     return key_list(items=items)
545 def list_keys(kwargs=None, call=None):
546     if call != "function":
547         log.error("The list_keys function must be called with -f or --function.")
548         return False
549     if not kwargs:
550         kwargs = {}
551     ret = {}
552     rcode, data = query(command="my/keys", method="GET")
553     for pair in data:
554         ret[pair["name"]] = pair["key"]
555     return {"keys": ret}
556 def show_key(kwargs=None, call=None):
557     if call != "function":
558         log.error("The list_keys function must be called with -f or --function.")
559         return False
560     if not kwargs:
561         kwargs = {}
562     if "keyname" not in kwargs:
563         log.error("A keyname is required.")
564         return False
565     rcode, data = query(
566         command="my/keys/{}".format(kwargs["keyname"]),
567         method="GET",
568     )
569     return {"keys": {data["name"]: data["key"]}}
570 def import_key(kwargs=None, call=None):
571     if call != "function":
572         log.error("The import_key function must be called with -f or --function.")
573         return False
574     if not kwargs:
575         kwargs = {}
576     if "keyname" not in kwargs:
577         log.error("A keyname is required.")
578         return False
579     if "keyfile" not in kwargs:
580         log.error("The location of the SSH keyfile is required.")
581         return False
582     if not os.path.isfile(kwargs["keyfile"]):
583         log.error("The specified keyfile (%s) does not exist.", kwargs["keyfile"])
584         return False
585     with salt.utils.files.fopen(kwargs["keyfile"], "r") as fp_:
586         kwargs["key"] = salt.utils.stringutils.to_unicode(fp_.read())
587     send_data = {"name": kwargs["keyname"], "key": kwargs["key"]}
588     kwargs["data"] = salt.utils.json.dumps(send_data)
589     rcode, data = query(
590         command="my/keys",
591         method="POST",
592         data=kwargs["data"],
593     )
594     log.debug(pprint.pformat(data))
595     return {"keys": {data["name"]: data["key"]}}
596 def delete_key(kwargs=None, call=None):
597     if call != "function":
598         log.error("The delete_keys function must be called with -f or --function.")
599         return False
600     if not kwargs:
601         kwargs = {}
602     if "keyname" not in kwargs:
603         log.error("A keyname is required.")
604         return False
605     rcode, data = query(
606         command="my/keys/{}".format(kwargs["keyname"]),
607         method="DELETE",
608     )
609     return data
610 def get_location_path(
611     location=DEFAULT_LOCATION, api_host_suffix=JOYENT_API_HOST_SUFFIX
612 ):
613     return "{}://{}{}".format(_get_proto(), location, api_host_suffix)
614 def query(action=None, command=None, args=None, method="GET", location=None, data=None):
615     user = config.get_cloud_config_value(
616         "user", get_configured_provider(), __opts__, search_global=False
617     )
618     if not user:
619         log.error(
620             "username is required for Joyent API requests. Please set one in your"
621             " provider configuration"
622         )
623     password = config.get_cloud_config_value(
624         "password", get_configured_provider(), __opts__, search_global=False
625     )
626     verify_ssl = config.get_cloud_config_value(
627         "verify_ssl",
628         get_configured_provider(),
629         __opts__,
630         search_global=False,
631         default=True,
632     )
633     ssh_keyfile = config.get_cloud_config_value(
634         "private_key",
635         get_configured_provider(),
636         __opts__,
637         search_global=False,
638         default=True,
639     )
640     if not ssh_keyfile:
641         log.error(
642             "ssh_keyfile is required for Joyent API requests.  Please set one in your"
643             " provider configuration"
644         )
645     ssh_keyname = config.get_cloud_config_value(
646         "keyname",
647         get_configured_provider(),
648         __opts__,
649         search_global=False,
650         default=True,
651     )
652     if not ssh_keyname:
653         log.error(
654             "ssh_keyname is required for Joyent API requests.  Please set one in your"
655             " provider configuration"
656         )
657     if not location:
658         location = get_location()
659     api_host_suffix = config.get_cloud_config_value(
660         "api_host_suffix",
661         get_configured_provider(),
662         __opts__,
663         search_global=False,
664         default=JOYENT_API_HOST_SUFFIX,
665     )
666     path = get_location_path(location=location, api_host_suffix=api_host_suffix)
667     if action:
668         path += action
669     if command:
670         path += "/{}".format(command)
671     log.debug("User: '%s' on PATH: %s", user, path)
672     if (not user) or (not ssh_keyfile) or (not ssh_keyname) or (not location):
673         return None
674     timenow = datetime.datetime.utcnow()
675     timestamp = timenow.strftime("%a, %d %b %Y %H:%M:%S %Z").strip()
676     rsa_key = salt.crypt.get_rsa_key(ssh_keyfile, None)
677         md = EVP.MessageDigest("sha256")
678         md.update(timestamp.encode(__salt_system_encoding__))
679         digest <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= md.final()
680         signed = rsa_key.sign(digest, algo="sha256")
681     else:
682         rsa_ = PKCS1_v1_5.new(rsa_key)
683         hash_ = SHA256.new(</b></font>)
684         hash_.update(timestamp.encode(__salt_system_encoding__))
685         signed = rsa_.sign(hash_)
686     signed = base64.b64encode(signed)
687     user_arr = user.split("/")
688     if len(user_arr) == 1:
689         keyid = "/{}/keys/{}".format(user_arr[0], ssh_keyname)
690     elif len(user_arr) == 2:
691         keyid = "/{}/users/{}/keys/{}".format(user_arr[0], user_arr[1], ssh_keyname)
692     else:
693         log.error("Malformed user string")
694     headers = {
695         "Content-Type": "application/json",
696         "Accept": "application/json",
697         "X-Api-Version": JOYENT_API_VERSION,
698         "Date": timestamp,
699         "Authorization": 'Signature keyId="{}",algorithm="rsa-sha256" {}'.format(
700             keyid, signed.decode(__salt_system_encoding__)
701         ),
702     }
703     if not isinstance(args, dict):
704         args = {}
705     if not data:
706         data = salt.utils.json.dumps({})
707     return_content = None
708     result = salt.utils.http.query(
709         path,
710         method,
711         params=args,
712         header_dict=headers,
713         data=data,
714         decode=False,
715         text=True,
716         status=True,
717         headers=True,
718         verify_ssl=verify_ssl,
719         opts=__opts__,
720     )
721     log.debug("Joyent Response Status Code: %s", result["status"])
722     if "headers" not in result:
723         return [result["status"], result["error"]]
724     if "Content-Length" in result["headers"]:
725         content = result["text"]
726         return_content = salt.utils.yaml.safe_load(content)
727     return [result["status"], return_content]
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
