<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_bower_1.py &amp; joyent.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_bower_1.py &amp; joyent.py
      </h3>
<h1 align="center">
        4.2%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_bower_1.py (25.925926%)<th>joyent.py (2.3045268%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(66-72)<td><a href="#" name="0">(359-363)</a><td align="center"><font color="#ff0000">15</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(22-28)<td><a href="#" name="1">(1168-1172)</a><td align="center"><font color="#dd0000">13</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_bower_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import pytest
2 import salt.utils.json
3 import salt.utils.path
4 from tests.support.case import ModuleCase
5 from tests.support.mixins import SaltReturnAssertsMixin
6 from tests.support.unit import skipIf
7 @skipIf(salt.utils.path.which("bower") is None, "bower not installed")
8 class BowerStateTest(ModuleCase, SaltReturnAssertsMixin):
9     @pytest.mark.destructive_test
10     @pytest.mark.slow_test
11     def test_bower_installed_removed(self):
12         ret = self.run_state("file.directory", name="/salt_test_bower_1", makedirs<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=True)
13         self.assertSaltTrueReturn(ret)
14         ret = self.run_state(
15             "bower.installed", name="underscore", dir="/salt_test_bower_1"
16         )
17         self.assertSaltTrueReturn(ret)
18         ret = self.run_state(</b></font>
19             "bower.removed", name="underscore", dir="/salt_test_bower_1"
20         )
21         self.assertSaltTrueReturn(ret)
22         ret = self.run_state("file.absent", name="/salt_test_bower_1")
23         self.assertSaltTrueReturn(ret)
24     @pytest.mark.destructive_test
25     @pytest.mark.slow_test
26     def test_bower_installed_pkgs(self):
27         ret = self.run_state("file.directory", name="/salt_test_bower_2", makedirs=True)
28         self.assertSaltTrueReturn(ret)
29         ret = self.run_state(
30             "bower.installed",
31             name="test",
32             dir="/salt_test_bower_2",
33             pkgs=["numeral", "underscore"],
34         )
35         self.assertSaltTrueReturn(ret)
36         ret = self.run_state("file.absent", name="/salt_test_bower_2")
37         self.assertSaltTrueReturn(ret)
38     @pytest.mark.destructive_test
39     @pytest.mark.slow_test
40     def test_bower_installed_from_file(self):
41         ret = self.run_state("file.directory", name="/salt_test_bower_3", makedirs=True)
42         self.assertSaltTrueReturn(ret)
43         bower_json = salt.utils.json.dumps(
44             {
45                 "name": "salt_test_bower_3",
46                 "dependencies": {"numeral": "~1.5.3", "underscore": "~1.7.0"},
47 <a name="0"></a>            }
48         )
49         ret = self.run_state(
50             "file.managed", name="/salt_test_bower_3/bower.json", contents<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=bower_json
51         )
52         self.assertSaltTrueReturn(ret)
53         ret = self.run_state("bower.bootstrap", name="/salt_test_bower_3")
54         self.assertSaltTrueReturn(ret)
55         ret = self.run_state("file.absent", name="/salt_test_bower_3")
56         self.assertSaltTrueReturn(</b></font>ret)
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>joyent.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import base64
2 import datetime
3 import http.client
4 import inspect
5 import logging
6 import os
7 import pprint
8 import salt.config as config
9 import salt.utils.cloud
10 import salt.utils.files
11 import salt.utils.http
12 import salt.utils.json
13 import salt.utils.yaml
14 from salt.exceptions import (
15     SaltCloudExecutionFailure,
16     SaltCloudExecutionTimeout,
17     SaltCloudNotFound,
18     SaltCloudSystemExit,
19 )
20 try:
21     from M2Crypto import EVP
22     HAS_REQUIRED_CRYPTO = True
23     HAS_M2 = True
24 except ImportError:
25     HAS_M2 = False
26     try:
27         from Cryptodome.Hash import SHA256
28         from Cryptodome.Signature import PKCS1_v1_5
29         HAS_REQUIRED_CRYPTO = True
30     except ImportError:
31         try:
32             from Crypto.Hash import SHA256  # nosec
33             from Crypto.Signature import PKCS1_v1_5  # nosec
34             HAS_REQUIRED_CRYPTO = True
35         except ImportError:
36             HAS_REQUIRED_CRYPTO = False
37 log = logging.getLogger(__name__)
38 __virtualname__ = "joyent"
39 JOYENT_API_HOST_SUFFIX = ".api.joyentcloud.com"
40 JOYENT_API_VERSION = "~7.2"
41 JOYENT_LOCATIONS = {
42     "us-east-1": "North Virginia, USA",
43     "us-west-1": "Bay Area, California, USA",
44     "us-sw-1": "Las Vegas, Nevada, USA",
45     "eu-ams-1": "Amsterdam, Netherlands",
46 }
47 DEFAULT_LOCATION = "us-east-1"
48 POLL_ALL_LOCATIONS = True
49 VALID_RESPONSE_CODES = [
50     http.client.OK,
51     http.client.ACCEPTED,
52     http.client.CREATED,
53     http.client.NO_CONTENT,
54 ]
55 def __virtual__():
56     if HAS_REQUIRED_CRYPTO is False:
57         return False, "Either PyCrypto or Cryptodome needs to be installed."
58     if get_configured_provider() is False:
59         return False
60     return __virtualname__
61 def _get_active_provider_name():
62     try:
63         return __active_provider_name__.value()
64     except AttributeError:
65         return __active_provider_name__
66 def get_configured_provider():
67     return config.is_provider_configured(
68         __opts__, _get_active_provider_name() or __virtualname__, ("user", "password")
69     )
70 def get_image(vm_):
71     images = avail_images()
72     vm_image = config.get_cloud_config_value("image", vm_, __opts__)
73     if vm_image and str(vm_image) in images:
74         images[vm_image]["name"] = images[vm_image]["id"]
75         return images[vm_image]
76     raise SaltCloudNotFound(
77         "The specified image, '{}', could not be found.".format(vm_image)
78     )
79 def get_size(vm_):
80     sizes = avail_sizes()
81     vm_size = config.get_cloud_config_value("size", vm_, __opts__)
82     if not vm_size:
83         raise SaltCloudNotFound("No size specified for this VM.")
84     if vm_size and str(vm_size) in sizes:
85         return sizes[vm_size]
86     raise SaltCloudNotFound(
87         "The specified size, '{}', could not be found.".format(vm_size)
88     )
89 def query_instance(vm_=None, call=None):
90     if isinstance(vm_, str) and call == "action":
91         vm_ = {"name": vm_, "provider": "joyent"}
92     if call == "function":
93         raise SaltCloudSystemExit(
94             "The query_instance action must be called with -a or --action."
95         )
96     __utils__["cloud.fire_event"](
97         "event",
98         "querying instance",
99         "salt/cloud/{}/querying".format(vm_["name"]),
100         sock_dir=__opts__["sock_dir"],
101         transport=__opts__["transport"],
102     )
103     def _query_ip_address():
104         data = show_instance(vm_["name"], call="action")
105         if not data:
106             log.error("There was an error while querying Joyent. Empty response")
107             return False
108         if isinstance(data, dict) and "error" in data:
109             log.warning("There was an error in the query %s", data.get("error"))
110             return False
111         log.debug("Returned query data: %s", data)
112         if "primaryIp" in data[1]:
113             if data[1]["state"] == "running":
114                 return data[1]["primaryIp"]
115         return None
116     try:
117         data = salt.utils.cloud.wait_for_ip(
118             _query_ip_address,
119             timeout=config.get_cloud_config_value(
120                 "wait_for_ip_timeout", vm_, __opts__, default=10 * 60
121             ),
122             interval=config.get_cloud_config_value(
123                 "wait_for_ip_interval", vm_, __opts__, default=10
124             ),
125             interval_multiplier=config.get_cloud_config_value(
126                 "wait_for_ip_interval_multiplier", vm_, __opts__, default=1
127             ),
128         )
129     except (SaltCloudExecutionTimeout, SaltCloudExecutionFailure) as exc:
130         try:
131             pass
132         except SaltCloudSystemExit:
133             pass
134         finally:
135             raise SaltCloudSystemExit(str(exc))
136     return data
137 def create(vm_):
138     try:
139         if (
140             vm_["profile"]
141             and config.is_profile_configured(
142                 __opts__,
143                 _get_active_provider_name() or "joyent",
144                 vm_["profile"],
145                 vm_=vm_,
146             )
147             is False
148         ):
149             return False
150     except AttributeError:
151         pass
152     key_filename = config.get_cloud_config_value(
153         "private_key", vm_, __opts__, search_global=False, default=None
154     )
155     __utils__["cloud.fire_event"](
156         "event",
157         "starting create",
158         "salt/cloud/{}/creating".format(vm_["name"]),
159         args=__utils__["cloud.filter_event"](
160             "creating", vm_, ["name", "profile", "provider", "driver"]
161         ),
162         sock_dir=__opts__["sock_dir"],
163         transport=__opts__["transport"],
164     )
165     log.info(
166         "Creating Cloud VM %s in %s", vm_["name"], vm_.get("location", DEFAULT_LOCATION)
167     )
168     salt.utils.cloud.check_name(vm_["name"], "a-zA-Z0-9-.")
169     kwargs = {
170         "name": vm_["name"],
171         "image": get_image(vm_),
172         "size": get_size(vm_),
173         "location": vm_.get("location", DEFAULT_LOCATION),
174     }
175     if "networks" in vm_:
176         kwargs["networks"] = vm_.get("networks")
177     __utils__["cloud.fire_event"](
178         "event",
179         "requesting instance",
180         "salt/cloud/{}/requesting".format(vm_["name"]),
181         args={
182             "kwargs": __utils__["cloud.filter_event"](
183                 "requesting", kwargs, list(kwargs)
184             ),
185         },
186         sock_dir=__opts__["sock_dir"],
187         transport=__opts__["transport"],
188     )
189     data = create_node(**kwargs)
190     if data == {}:
191         log.error("Error creating %s on JOYENT", vm_["name"])
192         return False
193     query_instance(vm_)
194     data = show_instance(vm_["name"], call="action")
195     vm_["key_filename"] = key_filename
196     vm_["ssh_host"] = data[1]["primaryIp"]
197     __utils__["cloud.bootstrap"](vm_, __opts__)
198     __utils__["cloud.fire_event"](
199         "event",
200         "created instance",
201         "salt/cloud/{}/created".format(vm_["name"]),
202         args=__utils__["cloud.filter_event"](
203             "created", vm_, ["name", "profile", "provider", "driver"]
204         ),
205         sock_dir=__opts__["sock_dir"],
206         transport=__opts__["transport"],
207     )
208     return data[1]
209 def create_node(**kwargs):
210     name = kwargs["name"]
211 <a name="0"></a>    size = kwargs["size"]
212     image = kwargs["image"]
213     location = kwargs["location"]
214     networks <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= kwargs.get("networks")
215     tag = kwargs.get("tag")
216     locality = kwargs.get("locality")
217     metadata = kwargs.get("metadata")
218     firewall_enabled = kwargs.get(</b></font>"firewall_enabled")
219     create_data = {
220         "name": name,
221         "package": size["name"],
222         "image": image["name"],
223     }
224     if networks is not None:
225         create_data["networks"] = networks
226     if locality is not None:
227         create_data["locality"] = locality
228     if metadata is not None:
229         for key, value in metadata.items():
230             create_data["metadata.{}".format(key)] = value
231     if tag is not None:
232         for key, value in tag.items():
233             create_data["tag.{}".format(key)] = value
234     if firewall_enabled is not None:
235         create_data["firewall_enabled"] = firewall_enabled
236     data = salt.utils.json.dumps(create_data)
237     ret = query(command="my/machines", data=data, method="POST", location=location)
238     if ret[0] in VALID_RESPONSE_CODES:
239         return ret[1]
240     else:
241         log.error("Failed to create node %s: %s", name, ret[1])
242     return {}
243 def destroy(name, call=None):
244     if call == "function":
245         raise SaltCloudSystemExit(
246             "The destroy action must be called with -d, --destroy, -a or --action."
247         )
248     __utils__["cloud.fire_event"](
249         "event",
250         "destroying instance",
251         "salt/cloud/{}/destroying".format(name),
252         args={"name": name},
253         sock_dir=__opts__["sock_dir"],
254         transport=__opts__["transport"],
255     )
256     node = get_node(name)
257     ret = query(
258         command="my/machines/{}".format(node["id"]),
259         location=node["location"],
260         method="DELETE",
261     )
262     __utils__["cloud.fire_event"](
263         "event",
264         "destroyed instance",
265         "salt/cloud/{}/destroyed".format(name),
266         args={"name": name},
267         sock_dir=__opts__["sock_dir"],
268         transport=__opts__["transport"],
269     )
270     if __opts__.get("update_cachedir", False) is True:
271         __utils__["cloud.delete_minion_cachedir"](
272             name, _get_active_provider_name().split(":")[0], __opts__
273         )
274     return ret[0] in VALID_RESPONSE_CODES
275 def reboot(name, call=None):
276     node = get_node(name)
277     ret = take_action(
278         name=name,
279         call=call,
280         method="POST",
281         command="my/machines/{}".format(node["id"]),
282         location=node["location"],
283         data={"action": "reboot"},
284     )
285     return ret[0] in VALID_RESPONSE_CODES
286 def stop(name, call=None):
287     node = get_node(name)
288     ret = take_action(
289         name=name,
290         call=call,
291         method="POST",
292         command="my/machines/{}".format(node["id"]),
293         location=node["location"],
294         data={"action": "stop"},
295     )
296     return ret[0] in VALID_RESPONSE_CODES
297 def start(name, call=None):
298     node = get_node(name)
299     ret = take_action(
300         name=name,
301         call=call,
302         method="POST",
303         command="my/machines/{}".format(node["id"]),
304         location=node["location"],
305         data={"action": "start"},
306     )
307     return ret[0] in VALID_RESPONSE_CODES
308 def take_action(
309     name=None,
310     call=None,
311     command=None,
312     data=None,
313     method="GET",
314     location=DEFAULT_LOCATION,
315 ):
316     caller = inspect.stack()[1][3]
317     if call != "action":
318         raise SaltCloudSystemExit("This action must be called with -a or --action.")
319     if data:
320         data = salt.utils.json.dumps(data)
321     ret = []
322     try:
323         ret = query(command=command, data=data, method=method, location=location)
324         log.info("Success %s for node %s", caller, name)
325     except Exception as exc:  # pylint: disable=broad-except
326         if "InvalidState" in str(exc):
327             ret = [200, {}]
328         else:
329             log.error(
330                 "Failed to invoke %s node %s: %s",
331                 caller,
332                 name,
333                 exc,
334                 exc_info_on_loglevel=logging.DEBUG,
335             )
336             ret = [100, {}]
337     return ret
338 def ssh_interface(vm_):
339     return config.get_cloud_config_value(
340         "ssh_interface", vm_, __opts__, default="public_ips", search_global=False
341     )
342 def get_location(vm_=None):
343     return __opts__.get(
344         "location",
345         config.get_cloud_config_value(
346             "location",
347             vm_ or get_configured_provider(),
348             __opts__,
349             default=DEFAULT_LOCATION,
350             search_global=False,
351         ),
352     )
353 def avail_locations(call=None):
354     if call == "action":
355         raise SaltCloudSystemExit(
356             "The avail_locations function must be called with "
357             "-f or --function, or with the --list-locations option"
358         )
359     ret = {}
360     for key in JOYENT_LOCATIONS:
361         ret[key] = {"name": key, "region": JOYENT_LOCATIONS[key]}
362     return ret
363 def has_method(obj, method_name):
364     if method_name in dir(obj):
365         return True
366     log.error("Method '%s' not yet supported!", method_name)
367     return False
368 def key_list(items=None):
369     if items is None:
370         items = []
371     ret = {}
372     if items and isinstance(items, list):
373         for item in items:
374             if "name" in item:
375                 if "id" not in item:
376                     item["id"] = item["name"]
377                 ret[item["name"]] = item
378     return ret
379 def get_node(name):
380     nodes = list_nodes()
381     if name in nodes:
382         return nodes[name]
383     return None
384 def show_instance(name, call=None):
385     node = get_node(name)
386     ret = query(
387         command="my/machines/{}".format(node["id"]),
388         location=node["location"],
389         method="GET",
390     )
391     return ret
392 def _old_libcloud_node_state(id_):
393     states_int = {
394         0: "RUNNING",
395         1: "REBOOTING",
396         2: "TERMINATED",
397         3: "PENDING",
398         4: "UNKNOWN",
399         5: "STOPPED",
400         6: "SUSPENDED",
401         7: "ERROR",
402         8: "PAUSED",
403     }
404     states_str = {
405         "running": "RUNNING",
406         "rebooting": "REBOOTING",
407         "starting": "STARTING",
408         "terminated": "TERMINATED",
409         "pending": "PENDING",
410         "unknown": "UNKNOWN",
411         "stopping": "STOPPING",
412         "stopped": "STOPPED",
413         "suspended": "SUSPENDED",
414         "error": "ERROR",
415         "paused": "PAUSED",
416         "reconfiguring": "RECONFIGURING",
417     }
418     return states_str[id_] if isinstance(id_, str) else states_int[id_]
419 def joyent_node_state(id_):
420     states = {
421         "running": 0,
422         "stopped": 2,
423         "stopping": 2,
424         "provisioning": 3,
425         "deleted": 2,
426         "unknown": 4,
427     }
428     if id_ not in states:
429         id_ = "unknown"
430     return _old_libcloud_node_state(states[id_])
431 def reformat_node(item=None, full=False):
432     desired_keys = [
433         "id",
434         "name",
435         "state",
436         "public_ips",
437         "private_ips",
438         "size",
439         "image",
440         "location",
441     ]
442     item["private_ips"] = []
443     item["public_ips"] = []
444     if "ips" in item:
445         for ip in item["ips"]:
446             if salt.utils.cloud.is_public_ip(ip):
447                 item["public_ips"].append(ip)
448             else:
449                 item["private_ips"].append(ip)
450     for key in desired_keys:
451         if key not in item:
452             item[key] = None
453     to_del = []
454     if not full:
455         for key in item.keys():  # iterate over a copy of the keys
456             if key not in desired_keys:
457                 to_del.append(key)
458     for key in to_del:
459         del item[key]
460     if "state" in item:
461         item["state"] = joyent_node_state(item["state"])
462     return item
463 def list_nodes(full=False, call=None):
464     if call == "action":
465         raise SaltCloudSystemExit(
466             "The list_nodes function must be called with -f or --function."
467         )
468     ret = {}
469     if POLL_ALL_LOCATIONS:
470         for location in JOYENT_LOCATIONS:
471             result = query(command="my/machines", location=location, method="GET")
472             if result[0] in VALID_RESPONSE_CODES:
473                 nodes = result[1]
474                 for node in nodes:
475                     if "name" in node:
476                         node["location"] = location
477                         ret[node["name"]] = reformat_node(item=node, full=full)
478             else:
479                 log.error("Invalid response when listing Joyent nodes: %s", result[1])
480     else:
481         location = get_location()
482         result = query(command="my/machines", location=location, method="GET")
483         nodes = result[1]
484         for node in nodes:
485             if "name" in node:
486                 node["location"] = location
487                 ret[node["name"]] = reformat_node(item=node, full=full)
488     return ret
489 def list_nodes_full(call=None):
490     if call == "action":
491         raise SaltCloudSystemExit(
492             "The list_nodes_full function must be called with -f or --function."
493         )
494     return list_nodes(full=True)
495 def list_nodes_select(call=None):
496     return salt.utils.cloud.list_nodes_select(
497         list_nodes_full("function"),
498         __opts__["query.selection"],
499         call,
500     )
501 def _get_proto():
502     use_ssl = config.get_cloud_config_value(
503         "use_ssl",
504         get_configured_provider(),
505         __opts__,
506         search_global=False,
507         default=True,
508     )
509     if use_ssl is True:
510         return "https"
511     return "http"
512 def avail_images(call=None):
513     if call == "action":
514         raise SaltCloudSystemExit(
515             "The avail_images function must be called with "
516             "-f or --function, or with the --list-images option"
517         )
518     user = config.get_cloud_config_value(
519         "user", get_configured_provider(), __opts__, search_global=False
520     )
521     img_url = config.get_cloud_config_value(
522         "image_url",
523         get_configured_provider(),
524         __opts__,
525         search_global=False,
526         default="{}{}/{}/images".format(DEFAULT_LOCATION, JOYENT_API_HOST_SUFFIX, user),
527     )
528     if not img_url.startswith("http://") and not img_url.startswith("https://"):
529         img_url = "{}://{}".format(_get_proto(), img_url)
530     rcode, data = query(command="my/images", method="GET")
531     log.debug(data)
532     ret = {}
533     for image in data:
534         ret[image["name"]] = image
535     return ret
536 def avail_sizes(call=None):
537     if call == "action":
538         raise SaltCloudSystemExit(
539             "The avail_sizes function must be called with "
540             "-f or --function, or with the --list-sizes option"
541         )
542     rcode, items = query(command="my/packages")
543     if rcode not in VALID_RESPONSE_CODES:
544         return {}
545     return key_list(items=items)
546 def list_keys(kwargs=None, call=None):
547     if call != "function":
548         log.error("The list_keys function must be called with -f or --function.")
549         return False
550     if not kwargs:
551         kwargs = {}
552     ret = {}
553     rcode, data = query(command="my/keys", method="GET")
554     for pair in data:
555         ret[pair["name"]] = pair["key"]
556     return {"keys": ret}
557 def show_key(kwargs=None, call=None):
558     if call != "function":
559         log.error("The list_keys function must be called with -f or --function.")
560         return False
561     if not kwargs:
562         kwargs = {}
563     if "keyname" not in kwargs:
564         log.error("A keyname is required.")
565         return False
566     rcode, data = query(
567         command="my/keys/{}".format(kwargs["keyname"]),
568         method="GET",
569     )
570     return {"keys": {data["name"]: data["key"]}}
571 def import_key(kwargs=None, call=None):
572     if call != "function":
573         log.error("The import_key function must be called with -f or --function.")
574         return False
575     if not kwargs:
576         kwargs = {}
577     if "keyname" not in kwargs:
578         log.error("A keyname is required.")
579         return False
580     if "keyfile" not in kwargs:
581         log.error("The location of the SSH keyfile is required.")
582         return False
583     if not os.path.isfile(kwargs["keyfile"]):
584         log.error("The specified keyfile (%s) does not exist.", kwargs["keyfile"])
585         return False
586     with salt.utils.files.fopen(kwargs["keyfile"], "r") as fp_:
587         kwargs["key"] = salt.utils.stringutils.to_unicode(fp_.read())
588     send_data = {"name": kwargs["keyname"], "key": kwargs["key"]}
589     kwargs["data"] = salt.utils.json.dumps(send_data)
590     rcode, data = query(
591         command="my/keys",
592         method="POST",
593         data=kwargs["data"],
594     )
595     log.debug(pprint.pformat(data))
596     return {"keys": {data["name"]: data["key"]}}
597 def delete_key(kwargs=None, call=None):
598     if call != "function":
599         log.error("The delete_keys function must be called with -f or --function.")
600         return False
601     if not kwargs:
602         kwargs = {}
603     if "keyname" not in kwargs:
604         log.error("A keyname is required.")
605         return False
606     rcode, data = query(
607         command="my/keys/{}".format(kwargs["keyname"]),
608         method="DELETE",
609     )
610     return data
611 def get_location_path(
612     location=DEFAULT_LOCATION, api_host_suffix=JOYENT_API_HOST_SUFFIX
613 ):
614     return "{}://{}{}".format(_get_proto(), location, api_host_suffix)
615 def query(action=None, command=None, args=None, method="GET", location=None, data=None):
616     user = config.get_cloud_config_value(
617         "user", get_configured_provider(), __opts__, search_global=False
618     )
619     if not user:
620         log.error(
621             "username is required for Joyent API requests. Please set one in your"
622             " provider configuration"
623         )
624     password = config.get_cloud_config_value(
625         "password", get_configured_provider(), __opts__, search_global=False
626     )
627     verify_ssl = config.get_cloud_config_value(
628         "verify_ssl",
629         get_configured_provider(),
630         __opts__,
631         search_global=False,
632         default=True,
633     )
634     ssh_keyfile = config.get_cloud_config_value(
635         "private_key",
636         get_configured_provider(),
637         __opts__,
638         search_global=False,
639         default=True,
640     )
641     if not ssh_keyfile:
642         log.error(
643             "ssh_keyfile is required for Joyent API requests.  Please set one in your"
644             " provider configuration"
645         )
646     ssh_keyname = config.get_cloud_config_value(
647         "keyname",
648         get_configured_provider(),
649         __opts__,
650         search_global=False,
651         default=True,
652     )
653     if not ssh_keyname:
654         log.error(
655             "ssh_keyname is required for Joyent API requests.  Please set one in your"
656             " provider configuration"
657         )
658     if not location:
659         location = get_location()
660     api_host_suffix = config.get_cloud_config_value(
661         "api_host_suffix",
662         get_configured_provider(),
663         __opts__,
664         search_global=False,
665         default=JOYENT_API_HOST_SUFFIX,
666     )
667     path = get_location_path(location=location, api_host_suffix=api_host_suffix)
668     if action:
669         path += action
670     if command:
671         path += "/{}".format(command)
672     log.debug("User: '%s' on PATH: %s", user, path)
673     if (not user) or (not ssh_keyfile) or (not ssh_keyname) or (not location):
674         return None
675     timenow = datetime.datetime.utcnow()
676     timestamp = timenow.strftime("%a, %d %b %Y %H:%M:%S %Z").strip()
677     rsa_key = salt.crypt.get_rsa_key(ssh_keyfile, None)
678 <a name="1"></a>    if HAS_M2:
679         md = EVP.MessageDigest("sha256")
680         md.update(timestamp.encode(__salt_system_encoding__))
681         digest <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= md.final()
682         signed = rsa_key.sign(digest, algo="sha256")
683     else:
684         rsa_ = PKCS1_v1_5.new(rsa_key)
685         hash_ = SHA256.new(</b></font>)
686         hash_.update(timestamp.encode(__salt_system_encoding__))
687         signed = rsa_.sign(hash_)
688     signed = base64.b64encode(signed)
689     user_arr = user.split("/")
690     if len(user_arr) == 1:
691         keyid = "/{}/keys/{}".format(user_arr[0], ssh_keyname)
692     elif len(user_arr) == 2:
693         keyid = "/{}/users/{}/keys/{}".format(user_arr[0], user_arr[1], ssh_keyname)
694     else:
695         log.error("Malformed user string")
696     headers = {
697         "Content-Type": "application/json",
698         "Accept": "application/json",
699         "X-Api-Version": JOYENT_API_VERSION,
700         "Date": timestamp,
701         "Authorization": 'Signature keyId="{}",algorithm="rsa-sha256" {}'.format(
702             keyid, signed.decode(__salt_system_encoding__)
703         ),
704     }
705     if not isinstance(args, dict):
706         args = {}
707     if not data:
708         data = salt.utils.json.dumps({})
709     return_content = None
710     result = salt.utils.http.query(
711         path,
712         method,
713         params=args,
714         header_dict=headers,
715         data=data,
716         decode=False,
717         text=True,
718         status=True,
719         headers=True,
720         verify_ssl=verify_ssl,
721         opts=__opts__,
722     )
723     log.debug("Joyent Response Status Code: %s", result["status"])
724     if "headers" not in result:
725         return [result["status"], result["error"]]
726     if "Content-Length" in result["headers"]:
727         content = result["text"]
728         return_content = salt.utils.yaml.safe_load(content)
729     return [result["status"], return_content]
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
