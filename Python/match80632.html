<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_aptpkg_1.py &amp; test_thin_1.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_aptpkg_1.py &amp; test_thin_1.py
      </h3>
<h1 align="center">
        4.0%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_aptpkg_1.py (5.063291%)<th>test_thin_1.py (3.4102306%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(196-206)<td><a href="#" name="0">(95-105)</a><td align="center"><font color="#ff0000">20</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(984-987)<td><a href="#" name="1">(1202-1206)</a><td align="center"><font color="#990000">12</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(933-936)<td><a href="#" name="2">(67-70)</a><td align="center"><font color="#990000">12</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(751-772)<td><a href="#" name="3">(153-162)</a><td align="center"><font color="#990000">12</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(9-26)<td><a href="#" name="4">(16-28)</a><td align="center"><font color="#990000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_aptpkg_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import copy
2 import logging
3 import os
4 import pathlib
5 import textwrap
6 import pytest
7 import salt.modules.aptpkg as aptpkg
8 import salt.modules.pkg_resource as pkg_resource
9 from salt.exceptions import (
10     CommandExecutionError,
11     CommandNotFoundError,
12     SaltInvocationError,
13 )
14 from tests.support.mock import MagicMock, Mock, call, mock_open, patch
15 try:
16     from</b></font> aptsources import sourceslist  # pylint: disable=unused-import
17     HAS_APTSOURCES = True
18 except ImportError:
19     HAS_APTSOURCES = False
20 log = logging.getLogger(__name__)
21 @pytest.fixture(scope="module")
22 def repo_keys_var():
23     return {
24         "46181433FBB75451": {
25             "algorithm": 17,
26             "bits": 1024,
27             "capability": "scSC",
28             "date_creation": 1104433784,
29             "date_expiration": None,
30             "fingerprint": "C5986B4F1257FFA86632CBA746181433FBB75451",
31             "keyid": "46181433FBB75451",
32             "uid": "Ubuntu CD Image Automatic Signing Key &lt;cdimage@ubuntu.com&gt;",
33             "uid_hash": "B4D41942D4B35FF44182C7F9D00C99AF27B93AD0",
34             "validity": "-",
35         }
36     }
37 @pytest.fixture(scope="module")
38 def packages_var():
39     return {"wget": "1.15-1ubuntu1.14.04.2"}
40 @pytest.fixture(scope="module")
41 def lowpkg_files_var():
42     return {
43         "errors": {},
44         "packages": {
45             "wget": [
46                 "/.",
47                 "/etc",
48                 "/etc/wgetrc",
49                 "/usr",
50                 "/usr/bin",
51                 "/usr/bin/wget",
52                 "/usr/share",
53                 "/usr/share/info",
54                 "/usr/share/info/wget.info.gz",
55                 "/usr/share/doc",
56                 "/usr/share/doc/wget",
57                 "/usr/share/doc/wget/MAILING-LIST",
58                 "/usr/share/doc/wget/NEWS.gz",
59                 "/usr/share/doc/wget/AUTHORS",
60                 "/usr/share/doc/wget/copyright",
61                 "/usr/share/doc/wget/changelog.Debian.gz",
62                 "/usr/share/doc/wget/README",
63                 "/usr/share/man",
64                 "/usr/share/man/man1",
65                 "/usr/share/man/man1/wget.1.gz",
66             ]
67         },
68     }
69 @pytest.fixture(scope="module")
70 def lowpkg_info_var():
71     return {
72         "wget": {
73             "architecture": "amd64",
74             "description": "retrieves files from the web",
75             "homepage": "http://www.gnu.org/software/wget/",
76             "install_date": "2016-08-30T22:20:15Z",
77             "maintainer": "Ubuntu Developers &lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;",
78             "name": "wget",
79             "section": "web",
80             "source": "wget",
81             "version": "1.15-1ubuntu1.14.04.2",
82             "status": "ii",
83         },
84         "apache2": {
85             "architecture": "amd64",
86             "description": """Apache HTTP Server
87      The Apache HTTP Server Project's goal is to build a secure, efficient and
88      extensible HTTP server as standards-compliant open source software. The
89      result has long been the number one web server on the Internet.
90      .
91      Installing this package results in a full installation, including the
92      configuration files, init scripts and support scripts.""",
93             "homepage": "http://httpd.apache.org/",
94             "install_date": "2016-08-30T22:20:15Z",
95             "maintainer": "Ubuntu Developers &lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;",
96             "name": "apache2",
97             "section": "httpd",
98             "source": "apache2",
99             "version": "2.4.18-2ubuntu3.9",
100             "status": "rc",
101         },
102     }
103 @pytest.fixture(scope="module")
104 def apt_q_update_var():
105     return """
106     Get:1 http://security.ubuntu.com trusty-security InRelease [65 kB]
107     Get:2 http://security.ubuntu.com trusty-security/main Sources [120 kB]
108     Get:3 http://security.ubuntu.com trusty-security/main amd64 Packages [548 kB]
109     Get:4 http://security.ubuntu.com trusty-security/main i386 Packages [507 kB]
110     Hit http://security.ubuntu.com trusty-security/main Translation-en
111     Fetched 1240 kB in 10s (124 kB/s)
112     Reading package lists...
113 @pytest.fixture(scope="module")
114 def autoremove_var():
115     return """
116     Reading package lists... Done
117     Building dependency tree
118     Reading state information... Done
119     0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
120 @pytest.fixture(scope="module")
121 def uninstall_var():
122     return {"tmux": {"new": "", "old": "1.8-5"}}
123 @pytest.fixture(scope="module")
124 def install_var():
125     return {"tmux": {"new": "1.8-5", "old": ""}}
126 def _get_uri(repo):
127     splits = repo.split()
128     for val in splits:
129         if any(val.startswith(x) for x in ("http://", "https://", "ftp://")):
130             return val
131 <a name="0"></a>
132 class MockSourceEntry:
133     def __init__(self, uri, source_type, line, invalid, dist="", file=None):
134         self<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.uri = uri
135         self.type = source_type
136         self.line = line
137         self.invalid = invalid
138         self.file = file
139         self.disabled = False
140         self.dist = dist
141         self.comps = []
142         self.architectures = []
143     def</b></font> mysplit(self, line):
144         return line.split()
145 class MockSourceList:
146     def __init__(self):
147         self.list = []
148     def __iter__(self):
149         yield from self.list
150     def save(self):
151         pass
152 @pytest.fixture
153 def configure_loader_modules():
154     return {aptpkg: {"__grains__": {}}}
155 def test_version(lowpkg_info_var):
156     version = lowpkg_info_var["wget"]["version"]
157     mock = MagicMock(return_value=version)
158     with patch.dict(aptpkg.__salt__, {"pkg_resource.version": mock}):
159         assert aptpkg.version(*["wget"]) == version
160 def test_upgrade_available():
161     with patch("salt.modules.aptpkg.latest_version", MagicMock(return_value="")):
162         assert aptpkg.upgrade_available("wget") is False
163 def test_add_repo_key(repo_keys_var):
164     with patch(
165         "salt.modules.aptpkg.get_repo_keys", MagicMock(return_value=repo_keys_var)
166     ):
167         mock = MagicMock(return_value={"retcode": 0, "stdout": "OK"})
168         with patch.dict(aptpkg.__salt__, {"cmd.run_all": mock}):
169             assert (
170                 aptpkg.add_repo_key(keyserver="keyserver.ubuntu.com", keyid="FBB75451")
171                 is True
172             )
173 def test_add_repo_key_failed(repo_keys_var):
174     with patch(
175         "salt.modules.aptpkg.get_repo_keys", MagicMock(return_value=repo_keys_var)
176     ):
177         kwargs = {"keyserver": "keyserver.ubuntu.com"}
178         mock = MagicMock(return_value={"retcode": 0, "stdout": "OK"})
179         with patch.dict(aptpkg.__salt__, {"cmd.run_all": mock}):
180             with pytest.raises(SaltInvocationError):
181                 aptpkg.add_repo_key(**kwargs)
182 def test_get_repo_keys(repo_keys_var):
183     APT_KEY_LIST = r"""
184     pub:-:1024:17:46181433FBB75451:1104433784:::-:::scSC:
185     fpr:::::::::C5986B4F1257FFA86632CBA746181433FBB75451:
186     uid:-::::1104433784::B4D41942D4B35FF44182C7F9D00C99AF27B93AD0::Ubuntu CD Image Automatic Signing Key &lt;cdimage@ubuntu.com&gt;:
187     """
188     mock = MagicMock(return_value={"retcode": 0, "stdout": APT_KEY_LIST})
189     with patch.dict(aptpkg.__salt__, {"cmd.run_all": mock}):
190         assert aptpkg.get_repo_keys() == repo_keys_var
191 def test_file_dict(lowpkg_files_var):
192     mock = MagicMock(return_value=lowpkg_files_var)
193     with patch.dict(aptpkg.__salt__, {"lowpkg.file_dict": mock}):
194         assert aptpkg.file_dict("wget") == lowpkg_files_var
195 def test_file_list(lowpkg_files_var):
196     files = {
197         "errors": lowpkg_files_var["errors"],
198         "files": lowpkg_files_var["packages"]["wget"],
199     }
200     mock = MagicMock(return_value=files)
201     with patch.dict(aptpkg.__salt__, {"lowpkg.file_list": mock}):
202         assert aptpkg.file_list("wget") == files
203 def test_get_selections():
204     selections = {"install": ["wget"]}
205     mock = MagicMock(return_value="wget\t\t\t\t\t\tinstall")
206     with patch.dict(aptpkg.__salt__, {"cmd.run_stdout": mock}):
207         assert aptpkg.get_selections("wget") == selections
208 def test_info_installed(lowpkg_info_var):
209     names = {"group": "section", "packager": "maintainer", "url": "homepage"}
210     installed = copy.deepcopy({"wget": lowpkg_info_var["wget"]})
211     for name in names:
212         if installed["wget"].get(names[name], False):
213             installed["wget"][name] = installed["wget"].pop(names[name])
214     mock = MagicMock(return_value=lowpkg_info_var)
215     with patch.dict(aptpkg.__salt__, {"lowpkg.info": mock}):
216         del installed["wget"]["status"]
217         assert aptpkg.info_installed("wget") == installed
218         assert len(aptpkg.info_installed()) == 1
219 def test_owner():
220     paths = ["/usr/bin/wget"]
221     mock = MagicMock(return_value="wget: /usr/bin/wget")
222     with patch.dict(aptpkg.__salt__, {"cmd.run_stdout": mock}):
223         assert aptpkg.owner(*paths) == "wget"
224 def test_refresh_db(apt_q_update_var):
225     refresh_db = {
226         "http://security.ubuntu.com trusty-security InRelease": True,
227         "http://security.ubuntu.com trusty-security/main Sources": True,
228         "http://security.ubuntu.com trusty-security/main Translation-en": None,
229         "http://security.ubuntu.com trusty-security/main amd64 Packages": True,
230         "http://security.ubuntu.com trusty-security/main i386 Packages": True,
231     }
232     mock = MagicMock(return_value={"retcode": 0, "stdout": apt_q_update_var})
233     with patch("salt.utils.pkg.clear_rtag", MagicMock()):
234         with patch.dict(
235             aptpkg.__salt__,
236             {"cmd.run_all": mock, "config.get": MagicMock(return_value=False)},
237         ):
238             assert aptpkg.refresh_db() == refresh_db
239 def test_refresh_db_failed(apt_q_update_error_var):
240     kwargs = {"failhard": True}
241     mock = MagicMock(return_value={"retcode": 0, "stdout": apt_q_update_error_var})
242     with patch("salt.utils.pkg.clear_rtag", MagicMock()):
243         with patch.dict(
244             aptpkg.__salt__,
245             {"cmd.run_all": mock, "config.get": MagicMock(return_value=False)},
246         ):
247             with pytest.raises(CommandExecutionError):
248                 aptpkg.refresh_db(**kwargs)
249 def test_autoremove(packages_var, autoremove_var):
250     with patch("salt.modules.aptpkg.list_pkgs", MagicMock(return_value=packages_var)):
251         patch_kwargs = {
252             "__salt__": {
253                 "config.get": MagicMock(return_value=True),
254                 "cmd.run_all": MagicMock(
255                     return_value=MagicMock(return_value=autoremove_var)
256                 ),
257             }
258         }
259         with patch.multiple(aptpkg, **patch_kwargs):
260             assert aptpkg.autoremove() == {}
261             assert aptpkg.autoremove(purge=True) == {}
262             assert aptpkg.autoremove(list_only=True) == []
263             assert aptpkg.autoremove(list_only=True, purge=True) == []
264 def test_install(install_var):
265     with patch("salt.modules.aptpkg.install", MagicMock(return_value=install_var)):
266         assert aptpkg.install(name="tmux") == install_var
267         kwargs = {"force_conf_new": True}
268         assert aptpkg.install(name="tmux", **kwargs) == install_var
269 def test_remove(uninstall_var):
270     with patch("salt.modules.aptpkg._uninstall", MagicMock(return_value=uninstall_var)):
271         assert aptpkg.remove(name="tmux") == uninstall_var
272 def test_purge(uninstall_var):
273     with patch("salt.modules.aptpkg._uninstall", MagicMock(return_value=uninstall_var)):
274         assert aptpkg.purge(name="tmux") == uninstall_var
275 def test_upgrade(uninstall_var, upgrade_var):
276     with patch("salt.utils.pkg.clear_rtag", MagicMock()):
277         with patch(
278             "salt.modules.aptpkg.list_pkgs", MagicMock(return_value=uninstall_var)
279         ):
280             mock_cmd = MagicMock(return_value={"retcode": 0, "stdout": upgrade_var})
281             patch_kwargs = {
282                 "__salt__": {
283                     "config.get": MagicMock(return_value=True),
284                     "cmd.run_all": mock_cmd,
285                 }
286             }
287             with patch.multiple(aptpkg, **patch_kwargs):
288                 assert aptpkg.upgrade() == dict()
289                 kwargs = {"force_conf_new": True}
290                 assert aptpkg.upgrade(**kwargs) == dict()
291 def test_upgrade_downloadonly(uninstall_var, upgrade_var):
292     with patch("salt.utils.pkg.clear_rtag", MagicMock()):
293         with patch(
294             "salt.modules.aptpkg.list_pkgs", MagicMock(return_value=uninstall_var)
295         ):
296             mock_cmd = MagicMock(return_value={"retcode": 0, "stdout": upgrade_var})
297             patch_kwargs = {
298                 "__salt__": {
299                     "config.get": MagicMock(return_value=True),
300                     "cmd.run_all": mock_cmd,
301                 },
302             }
303             with patch.multiple(aptpkg, **patch_kwargs):
304                 aptpkg.upgrade()
305                 args_matching = [
306                     True
307                     for args in patch_kwargs["__salt__"]["cmd.run_all"].call_args[0]
308                     if "--download-only" in args
309                 ]
310                 assert any(args_matching) is False
311                 aptpkg.upgrade(downloadonly=True)
312                 args_matching = [
313                     True
314                     for args in patch_kwargs["__salt__"]["cmd.run_all"].call_args[0]
315                     if "--download-only" in args
316                 ]
317                 assert any(args_matching) is True
318                 aptpkg.upgrade(download_only=True)
319                 args_matching = [
320                     True
321                     for args in patch_kwargs["__salt__"]["cmd.run_all"].call_args[0]
322                     if "--download-only" in args
323                 ]
324                 assert any(args_matching) is True
325 def test_upgrade_allow_downgrades(uninstall_var, upgrade_var):
326     with patch("salt.utils.pkg.clear_rtag", MagicMock()):
327         with patch(
328             "salt.modules.aptpkg.list_pkgs", MagicMock(return_value=uninstall_var)
329         ):
330             mock_cmd = MagicMock(return_value={"retcode": 0, "stdout": upgrade_var})
331             patch_kwargs = {
332                 "__salt__": {
333                     "config.get": MagicMock(return_value=True),
334                     "cmd.run_all": mock_cmd,
335                 },
336             }
337             with patch.multiple(aptpkg, **patch_kwargs):
338                 aptpkg.upgrade()
339                 args_matching = [
340                     True
341                     for args in patch_kwargs["__salt__"]["cmd.run_all"].call_args[0]
342                     if "--allow-downgrades" in args
343                 ]
344                 assert any(args_matching) is False
345                 aptpkg.upgrade(allow_downgrades=True)
346                 args_matching = [
347                     True
348                     for args in patch_kwargs["__salt__"]["cmd.run_all"].call_args[0]
349                     if "--allow-downgrades" in args
350                 ]
351                 assert any(args_matching) is True
352 def test_show():
353     show_mock_success = MagicMock(
354         return_value={
355             "retcode": 0,
356             "pid": 12345,
357             "stderr": "",
358             "stdout": textwrap.dedent(
359             ),
360         }
361     )
362     show_mock_failure = MagicMock(
363         return_value={
364             "retcode": 1,
365             "pid": 12345,
366             "stderr": textwrap.dedent(
367             ),
368             "stdout": "",
369         }
370     )
371     refresh_mock = Mock()
372     expected = {
373         "foo1.0": {
374             "1.0.5-3ubuntu4": {
375                 "Architecture": "amd64",
376                 "Description": "A silly package (1.0 release cycle)",
377                 "Provides": "foo",
378                 "Suggests": "foo-doc",
379             },
380             "1.0.4-2ubuntu1": {
381                 "Architecture": "amd64",
382                 "Description": "A silly package (1.0 release cycle)",
383                 "Provides": "foo",
384                 "Suggests": "foo-doc",
385             },
386         },
387         "foo-doc": {
388             "1.0.5-3ubuntu4": {
389                 "Architecture": "all",
390                 "Description": (
391                     "Silly documentation for a silly package (1.0 release cycle)"
392                 ),
393             },
394             "1.0.4-2ubuntu1": {
395                 "Architecture": "all",
396                 "Description": (
397                     "Silly documentation for a silly package (1.0 release cycle)"
398                 ),
399             },
400         },
401     }
402     filtered = copy.deepcopy(expected)
403     for k1 in filtered:
404         for k2 in filtered[k1]:
405             for k3 in list(filtered[k1][k2]):
406                 if k3 not in ("Description", "Provides"):
407                     filtered[k1][k2].pop(k3)
408     with patch.dict(aptpkg.__salt__, {"cmd.run_all": show_mock_success}), patch.object(
409         aptpkg, "refresh_db", refresh_mock
410     ):
411         assert aptpkg.show("foo*") == expected
412         refresh_mock.assert_not_called()
413         refresh_mock.reset_mock()
414         assert aptpkg.show("foo*", refresh=True) == expected
415         refresh_mock.assert_called_once()
416         refresh_mock.reset_mock()
417         assert aptpkg.show("foo*", filter="description,provides") == filtered
418         refresh_mock.assert_not_called()
419         refresh_mock.reset_mock()
420     with patch.dict(aptpkg.__salt__, {"cmd.run_all": show_mock_failure}), patch.object(
421         aptpkg, "refresh_db", refresh_mock
422     ):
423         assert aptpkg.show("foo*") == {}
424         refresh_mock.assert_not_called()
425         refresh_mock.reset_mock()
426         assert aptpkg.show("foo*", refresh=True) == {}
427         refresh_mock.assert_called_once()
428         refresh_mock.reset_mock()
429 @pytest.mark.skipif(
430     not (pathlib.Path("/etc") / "apt" / "sources.list").is_file(),
431     reason="Requires sources.list file",
432 )
433 def test_mod_repo_enabled():
434     with patch.dict(
435         aptpkg.__salt__,
436         {"config.option": MagicMock(), "no_proxy": MagicMock(return_value=False)},
437     ):
438         with patch("salt.modules.aptpkg.refresh_db", MagicMock(return_value={})):
439             with patch(
440                 "salt.utils.data.is_true", MagicMock(return_value=True)
441             ) as data_is_true:
442                 with patch("salt.modules.aptpkg.SourcesList", MagicMock(), create=True):
443                     with patch(
444                         "salt.modules.aptpkg.SourceEntry", MagicMock(), create=True
445                     ):
446                         repo = aptpkg.mod_repo("foo", enabled=False)
447                         data_is_true.assert_called_with(False)
448                         data_is_true.reset_mock()
449                         repo = aptpkg.mod_repo("foo", disabled=True)
450                         data_is_true.assert_called_with(True)
451                         data_is_true.reset_mock()
452                         repo = aptpkg.mod_repo("foo", enabled=True)
453                         data_is_true.assert_called_with(True)
454                         data_is_true.reset_mock()
455                         repo = aptpkg.mod_repo("foo", disabled=False)
456                         data_is_true.assert_called_with(False)
457 def test_mod_repo_match():
458     source_type = "deb"
459     source_uri = "http://cdn-aws.deb.debian.org/debian/"
460     source_line = "deb http://cdn-aws.deb.debian.org/debian/ stretch main\n"
461     mock_source = MockSourceEntry(
462         source_uri, source_type, source_line, False, "stretch"
463     )
464     mock_source_list = MockSourceList()
465     mock_source_list.list = [mock_source]
466     with patch.dict(
467         aptpkg.__salt__,
468         {"config.option": MagicMock(), "no_proxy": MagicMock(return_value=False)},
469     ):
470         with patch("salt.modules.aptpkg.refresh_db", MagicMock(return_value={})):
471             with patch("salt.utils.data.is_true", MagicMock(return_value=True)):
472                 with patch("salt.modules.aptpkg.SourceEntry", MagicMock(), create=True):
473                     with patch(
474                         "salt.modules.aptpkg.SourcesList",
475                         MagicMock(return_value=mock_source_list),
476                         create=True,
477                     ):
478                         with patch(
479                             "salt.modules.aptpkg._split_repo_str",
480                             MagicMock(
481                                 return_value=(
482                                     "deb",
483                                     [],
484                                     "http://cdn-aws.deb.debian.org/debian/",
485                                     "stretch",
486                                     ["main"],
487                                 )
488                             ),
489                         ):
490                             source_line_no_slash = (
491                                 "deb http://cdn-aws.deb.debian.org/debian"
492                                 " stretch main"
493                             )
494                             repo = aptpkg.mod_repo(source_line_no_slash, enabled=False)
495                             assert repo[source_line_no_slash]["uri"] == source_uri
496 @patch("salt.utils.path.os_walk", MagicMock(return_value=[("test", "test", "test")]))
497 @patch("os.path.getsize", MagicMock(return_value=123456))
498 <a name="3"></a>@patch("os.path.getctime", MagicMock(return_value=1234567890.123456))
499 @patch(
500     "fnmatch.filter",
501     MagicMock<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>(return_value=["/var/cache/apt/archive/test_package.rpm"]),
502 )
503 def test_list_downloaded():
504     DOWNLOADED_RET = {
505         "test-package": {
506             "1.0": {
507                 "path": "/var/cache/apt/archive/test_package.rpm",
508                 "size": 123456,
509                 "creation_date_time_t": 1234567890,
510                 "creation_date_time": "2009-02-13T23:31:30",
511             }
512         }
513     }
514     with patch.dict(
515         aptpkg.__salt__,
516         {
517             "lowpkg.bin_pkg_info"</b></font>: MagicMock(
518                 return_value={"name": "test-package", "version": "1.0"}
519             )
520         },
521     ):
522         list_downloaded = aptpkg.list_downloaded()
523         assert len(list_downloaded) == 1
524         assert list_downloaded == DOWNLOADED_RET
525 def test__skip_source():
526     source_type = "deb"
527     source_uri = "http://cdn-aws.deb.debian.org/debian"
528     source_line = "deb http://cdn-aws.deb.debian.org/debian stretch main\n"
529     mock_source = MockSourceEntry(source_uri, source_type, source_line, False)
530     ret = aptpkg._skip_source(mock_source)
531     assert ret is False
532     source_type = "ded"
533     source_uri = "http://cdn-aws.deb.debian.org/debian"
534     source_line = "deb http://cdn-aws.deb.debian.org/debian stretch main\n"
535     mock_source = MockSourceEntry(source_uri, source_type, source_line, True)
536     ret = aptpkg._skip_source(mock_source)
537     assert ret is True
538     source_type = "deb"
539     source_uri = "http://cdn-aws.deb.debian.org/debian"
540     source_line = "deb [http://cdn-aws.deb.debian.org/debian] stretch main\n"
541     mock_source = MockSourceEntry(source_uri, source_type, source_line, True)
542     ret = aptpkg._skip_source(mock_source)
543     assert ret is False
544 def test_normalize_name():
545     with patch.dict(aptpkg.__grains__, {"osarch": "amd64"}):
546         result = aptpkg.normalize_name("foo")
547         assert result == "foo", result
548         result = aptpkg.normalize_name("foo:amd64")
549         assert result == "foo", result
550         result = aptpkg.normalize_name("foo:any")
551         assert result == "foo", result
552         result = aptpkg.normalize_name("foo:all")
553         assert result == "foo", result
554         result = aptpkg.normalize_name("foo:i386")
555         assert result == "foo:i386", result
556 def test_list_repos():
557     source_type = "deb"
558     source_uri = "http://cdn-aws.deb.debian.org/debian/"
559     source_line = "deb http://cdn-aws.deb.debian.org/debian/ stretch main\n"
560     mock_source = MockSourceEntry(source_uri, source_type, source_line, False)
561     mock_source_list = MockSourceList()
562     mock_source_list.list = [mock_source]
563     with patch("salt.modules.aptpkg.SourcesList", MagicMock(), create=True):
564         with patch("salt.modules.aptpkg.SourceEntry", MagicMock(), create=True):
565             with patch(
566                 "salt.modules.aptpkg.SourcesList",
567                 MagicMock(return_value=mock_source_list),
568                 create=True,
569             ):
570                 repos = aptpkg.list_repos()
571                 assert source_uri in repos
572                 assert isinstance(repos[source_uri], list)
573                 assert len(repos[source_uri]) == 1
574                 assert "line" in repos[source_uri][0]
575                 _uri = _get_uri(repos[source_uri][0]["line"])
576                 assert _uri[-1] == "/"
577                 assert "uri" in repos[source_uri][0]
578                 assert repos[source_uri][0]["uri"][-1] == "/"
579 @pytest.mark.skipif(
580     HAS_APTSOURCES is False, reason="The 'aptsources' library is missing."
581 )
582 def test_expand_repo_def():
583     source_type = "deb"
584     source_uri = "http://cdn-aws.deb.debian.org/debian/"
585     source_line = "deb http://cdn-aws.deb.debian.org/debian/ stretch main\n"
586     source_file = "/etc/apt/sources.list"
587     repo = "deb http://cdn-aws.deb.debian.org/debian/ stretch main\n"
588     sanitized = aptpkg.expand_repo_def(repo=repo, file=source_file)
589     assert isinstance(sanitized, dict)
590     assert "uri" in sanitized
591     assert sanitized["uri"][-1] == "/"
592     repo = "deb http://cdn-aws.deb.debian.org/debian/ stretch main\n"
593     sanitized = aptpkg.expand_repo_def(
594         repo=repo, file=source_file, architectures="amd64"
595     )
596     assert isinstance(sanitized, dict)
597     assert "line" in sanitized
598     assert (
599         sanitized["line"]
600         == "deb [arch=amd64] http://cdn-aws.deb.debian.org/debian/ stretch main"
601     )
602 def test_list_pkgs():
603     def _add_data(data, key, value):
604         data.setdefault(key, []).append(value)
605     apt_out = [
606         "install ok installed accountsservice 0.6.55-0ubuntu12~20.04.1 amd64",
607         "install ok installed acpid 1:2.0.32-1ubuntu1 amd64",
608         "install ok installed adduser 3.118ubuntu2 all",
609         "install ok installed alsa-topology-conf 1.2.2-1 all",
610         "install ok installed alsa-ucm-conf 1.2.2-1ubuntu0.4 all",
611         "install ok installed apparmor 2.13.3-7ubuntu5.1 amd64",
612         "install ok installed apport 2.20.11-0ubuntu27.9 all",
613         "install ok installed apport-symptoms 0.23 all",
614         "install ok installed apt 2.0.2ubuntu0.1 amd64",
615 <a name="2"></a>        "install ok installed apt-utils 2.0.2ubuntu0.1 amd64",
616         "install ok installed at 3.1.23-1ubuntu1 amd64",
617     ]
618     with patch.dict(aptpkg<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.__grains__, {"osarch": "x86_64"}), patch.dict(
619         aptpkg.__salt__,
620         {"cmd.run_stdout": MagicMock(return_value=os.linesep.join(apt_out))},
621     ), patch.</b></font>dict(aptpkg.__salt__, {"pkg_resource.add_pkg": _add_data}), patch.dict(
622         aptpkg.__salt__,
623         {"pkg_resource.format_pkg_list": pkg_resource.format_pkg_list},
624     ), patch.dict(
625         aptpkg.__salt__, {"pkg_resource.sort_pkglist": pkg_resource.sort_pkglist}
626     ):
627         pkgs = aptpkg.list_pkgs(versions_as_list=True)
628         for pkg_name, pkg_version in {
629             "accountsservice": "0.6.55-0ubuntu12~20.04.1",
630             "acpid": "1:2.0.32-1ubuntu1",
631             "adduser": "3.118ubuntu2",
632             "alsa-topology-conf": "1.2.2-1",
633             "alsa-ucm-conf": "1.2.2-1ubuntu0.4",
634             "apparmor": "2.13.3-7ubuntu5.1",
635             "apport": "2.20.11-0ubuntu27.9",
636             "apport-symptoms": "0.23",
637             "apt": "2.0.2ubuntu0.1",
638             "apt-utils": "2.0.2ubuntu0.1",
639             "at": "3.1.23-1ubuntu1",
640         }.items():
641             assert pkgs[pkg_name] == [pkg_version]
642 def test_list_pkgs_no_context():
643     def _add_data(data, key, value):
644         data.setdefault(key, []).append(value)
645     apt_out = [
646         "install ok installed accountsservice 0.6.55-0ubuntu12~20.04.1 amd64",
647         "install ok installed acpid 1:2.0.32-1ubuntu1 amd64",
648         "install ok installed adduser 3.118ubuntu2 all",
649         "install ok installed alsa-topology-conf 1.2.2-1 all",
650         "install ok installed alsa-ucm-conf 1.2.2-1ubuntu0.4 all",
651         "install ok installed apparmor 2.13.3-7ubuntu5.1 amd64",
652         "install ok installed apport 2.20.11-0ubuntu27.9 all",
653         "install ok installed apport-symptoms 0.23 all",
654         "install ok installed apt 2.0.2ubuntu0.1 amd64",
655         "install ok installed apt-utils 2.0.2ubuntu0.1 amd64",
656         "install ok installed at 3.1.23-1ubuntu1 amd64",
657 <a name="1"></a>    ]
658     with patch.dict(aptpkg.__grains__, {"osarch": "x86_64"}), patch.dict(
659         aptpkg.__salt__,
660         {"cmd.run_stdout": MagicMock(return_value<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=os.linesep.join(apt_out))},
661     ), patch.dict(aptpkg.__salt__, {"pkg_resource.add_pkg": _add_data}), patch.dict(
662         aptpkg.__salt__,
663         {"pkg_resource.format_pkg_list"</b></font>: pkg_resource.format_pkg_list},
664     ), patch.dict(
665         aptpkg.__salt__, {"pkg_resource.sort_pkglist": pkg_resource.sort_pkglist}
666     ), patch.object(
667         aptpkg, "_list_pkgs_from_context"
668     ) as list_pkgs_context_mock:
669         pkgs = aptpkg.list_pkgs(versions_as_list=True, use_context=False)
670         list_pkgs_context_mock.assert_not_called()
671         list_pkgs_context_mock.reset_mock()
672         pkgs = aptpkg.list_pkgs(versions_as_list=True, use_context=False)
673         list_pkgs_context_mock.assert_not_called()
674         list_pkgs_context_mock.reset_mock()
675 def test_call_apt_default():
676     with patch.dict(
677         aptpkg.__salt__,
678         {"cmd.run_all": MagicMock(), "config.get": MagicMock(return_value=False)},
679     ):
680         aptpkg._call_apt(["apt-get", "install", "emacs"])  # pylint: disable=W0106
681         aptpkg.__salt__["cmd.run_all"].assert_called_once_with(
682             ["apt-get", "install", "emacs"],
683             env={},
684             output_loglevel="trace",
685             python_shell=False,
686         )
687 @patch("salt.utils.systemd.has_scope", MagicMock(return_value=True))
688 def test_call_apt_in_scope():
689     with patch.dict(
690         aptpkg.__salt__,
691         {"cmd.run_all": MagicMock(), "config.get": MagicMock(return_value=True)},
692     ):
693         aptpkg._call_apt(["apt-get", "purge", "vim"])  # pylint: disable=W0106
694         aptpkg.__salt__["cmd.run_all"].assert_called_once_with(
695             [
696                 "systemd-run",
697                 "--scope",
698                 "--description",
699                 '"salt.modules.aptpkg"',
700                 "apt-get",
701                 "purge",
702                 "vim",
703             ],
704             env={},
705             output_loglevel="trace",
706             python_shell=False,
707         )
708 def test_call_apt_with_kwargs():
709     with patch.dict(
710         aptpkg.__salt__,
711         {"cmd.run_all": MagicMock(), "config.get": MagicMock(return_value=False)},
712     ):
713         aptpkg._call_apt(
714             ["dpkg", "-l", "python"],
715             python_shell=True,
716             output_loglevel="quiet",
717             ignore_retcode=False,
718             username="Darth Vader",
719         )  # pylint: disable=W0106
720         aptpkg.__salt__["cmd.run_all"].assert_called_once_with(
721             ["dpkg", "-l", "python"],
722             env={},
723             ignore_retcode=False,
724             output_loglevel="quiet",
725             python_shell=True,
726             username="Darth Vader",
727         )
728 def test_call_apt_dpkg_lock():
729     cmd_side_effect = [
730         {"stderr": "Could not get lock"},
731         {"stderr": "Could not get lock"},
732         {"stderr": "Could not get lock"},
733         {"stderr": "Could not get lock"},
734         {"stderr": "", "stdout": ""},
735     ]
736     cmd_mock = MagicMock(side_effect=cmd_side_effect)
737     cmd_call = (
738         call(
739             ["dpkg", "-l", "python"],
740             env={},
741             ignore_retcode=False,
742             output_loglevel="quiet",
743             python_shell=True,
744             username="Darth Vader",
745         ),
746     )
747     expected_calls = [cmd_call * 5]
748     with patch.dict(
749         aptpkg.__salt__,
750         {"cmd.run_all": cmd_mock, "config.get": MagicMock(return_value=False)},
751     ):
752         with patch("salt.modules.aptpkg.time.sleep", MagicMock()) as sleep_mock:
753             aptpkg._call_apt(
754                 ["dpkg", "-l", "python"],
755                 python_shell=True,
756                 output_loglevel="quiet",
757                 ignore_retcode=False,
758                 username="Darth Vader",
759             )  # pylint: disable=W0106
760             assert sleep_mock.call_count &gt;= 4
761             assert cmd_mock.call_count == 5
762             cmd_mock.has_calls(expected_calls)
763 def test_services_need_restart_checkrestart_missing():
764     with patch("salt.utils.path.which_bin", Mock(return_value=None)):
765         with pytest.raises(CommandNotFoundError):
766             aptpkg.services_need_restart()
767 @patch("salt.utils.path.which_bin", Mock(return_value="/usr/sbin/checkrestart"))
768 def test_services_need_restart():
769     cr_output = """
770 PROCESSES: 24
771 PROGRAMS: 17
772 PACKAGES: 8
773 SERVICE:rsyslog,385,/usr/sbin/rsyslogd
774 SERVICE:cups-daemon,390,/usr/sbin/cupsd
775     Test SourcesList when repo has multiple comps
776     Test SourcesList when architectures is in repo
777     :codeauthor: :email:`Bo Maryniuk &lt;bo@suse.de&gt;`
778 """
779 import copy
780 import os
781 import pathlib
782 import shutil
783 import sys
784 import tarfile
785 import tempfile
786 <a name="4"></a>import jinja2
787 import pytest
788 import salt.exceptions
789 <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import salt.utils.hashutils
790 import salt.utils.json
791 import salt.utils.platform
792 import salt.utils.stringutils
793 from salt.utils import thin
794 from salt.utils.stringutils import to_bytes as bts
795 from tests.support.helpers import TstSuiteLoggingHandler, VirtualEnv
796 from tests.support.mock import MagicMock, patch
797 from tests.support.runtests import RUNTIME_VARS
798 from tests.support.unit import TestCase, skipIf
799 try:
800     import</b></font> pytest
801 except ImportError:
802     pytest = None
803 def patch_if(condition, *args, **kwargs):
804     if condition:
805         return patch(*args, **kwargs)
806     def inner(func):
807         return func
808     return inner
809 @skipIf(pytest is None, "PyTest is missing")
810 class SSHThinTestCase(TestCase):
811     def setUp(self):
812         self.jinja_fp = os.path.dirname(jinja2.__file__)
813         self.ext_conf = {
814             "test": {
815                 "py-version": [2, 7],
816                 "path": RUNTIME_VARS.SALT_CODE_DIR,
817                 "dependencies": {"jinja2": self.jinja_fp},
818             }
819         }
820         self.tops = copy.deepcopy(self.ext_conf)
821         self.tops["test"]["dependencies"] = [self.jinja_fp]
822 <a name="2"></a>        self.tar = self._tarfile(None).open()
823         self.digest = salt.utils.hashutils.DigestCollector()
824         self.exp_files = [
825             <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>os.path.join("salt", "payload.py"),
826             os.path.join("jinja2", "__init__.py"),
827         ]
828         lib_root = os.path.join(RUNTIME_VARS.</b></font>TMP, "fake-libs")
829         self.fake_libs = {
830             "distro": os.path.join(lib_root, "distro"),
831             "jinja2": os.path.join(lib_root, "jinja2"),
832             "yaml": os.path.join(lib_root, "yaml"),
833             "tornado": os.path.join(lib_root, "tornado"),
834             "msgpack": os.path.join(lib_root, "msgpack"),
835         }
836         code_dir = pathlib.Path(RUNTIME_VARS.CODE_DIR).resolve()
837         self.exp_ret = {
838             "distro": str(code_dir / "distro.py"),
839             "jinja2": str(code_dir / "jinja2"),
840             "yaml": str(code_dir / "yaml"),
841             "tornado": str(code_dir / "tornado"),
842             "msgpack": str(code_dir / "msgpack"),
843             "certifi": str(code_dir / "certifi"),
844             "singledispatch": str(code_dir / "singledispatch.py"),
845         }
846         self.exc_libs = ["jinja2", "yaml"]
847     def tearDown(self):
848 <a name="0"></a>        for lib, fp in self.fake_libs.items():
849             if os.path.exists(fp):
850                 shutil.rmtree(fp)
851         self<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.exc_libs = None
852         self.jinja_fp = None
853         self.ext_conf = None
854         self.tops = None
855         self.tar = None
856         self.digest = None
857         self.exp_files = None
858         self.fake_libs = None
859         self.exp_ret = None
860     def</b></font> _popen(self, return_value=None, side_effect=None, returncode=0):
861         proc = MagicMock()
862         proc.communicate = MagicMock(return_value=return_value, side_effect=side_effect)
863         proc.returncode = returncode
864         popen = MagicMock(return_value=proc)
865         return popen
866     def _version_info(self, major=None, minor=None):
867         class VersionInfo(tuple):
868             pass
869         vi = VersionInfo([major, minor])
870         vi.major = major or sys.version_info.major
871         vi.minor = minor or sys.version_info.minor
872         return vi
873     def _tarfile(self, getinfo=False):
874         spec = ["add", "close"]
875         if getinfo:
876             spec.append("getinfo")
877         tf = MagicMock()
878         tf.open = MagicMock(return_value=MagicMock(spec=spec))
879 <a name="3"></a>        return tf
880     @patch("salt.utils.thin.log", MagicMock())
881     @patch("salt.utils.thin.os.path.isfile", MagicMock<font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>(return_value=False))
882     def test_get_ext_tops_cfg_missing_dependencies(self):
883         cfg = {"namespace": {"py-version": [0, 0], "path": "/foo", "dependencies": []}}
884         with pytest.raises(salt.exceptions.</b></font>SaltSystemExit) as err:
885             thin.get_ext_tops(cfg)
886         self.assertIn("Missing dependencies", str(err.value))
887         self.assertTrue(thin.log.error.called)
888         self.assertIn("Missing dependencies", thin.log.error.call_args[0][0])
889         self.assertIn("jinja2, yaml, tornado, msgpack", thin.log.error.call_args[0][0])
890     @patch("salt.exceptions.SaltSystemExit", Exception)
891     @patch("salt.utils.thin.log", MagicMock())
892     @patch("salt.utils.thin.os.path.isfile", MagicMock(return_value=False))
893     def test_get_ext_tops_cfg_missing_interpreter(self):
894         cfg = {"namespace": {"path": "/foo", "dependencies": []}}
895         with pytest.raises(salt.exceptions.SaltSystemExit) as err:
896             thin.get_ext_tops(cfg)
897         self.assertIn("missing specific locked Python version", str(err.value))
898     @patch("salt.exceptions.SaltSystemExit", Exception)
899     @patch("salt.utils.thin.log", MagicMock())
900     @patch("salt.utils.thin.os.path.isfile", MagicMock(return_value=False))
901     def test_get_ext_tops_cfg_wrong_interpreter(self):
902         cfg = {"namespace": {"path": "/foo", "py-version": 2, "dependencies": []}}
903         with pytest.raises(salt.exceptions.SaltSystemExit) as err:
904             thin.get_ext_tops(cfg)
905         self.assertIn(
906             "specific locked Python version should be a list of major/minor version",
907             str(err.value),
908         )
909     @patch("salt.exceptions.SaltSystemExit", Exception)
910     @patch("salt.utils.thin.log", MagicMock())
911     @patch("salt.utils.thin.os.path.isfile", MagicMock(return_value=False))
912     def test_get_ext_tops_cfg_interpreter(self):
913         cfg = {
914             "namespace": {
915                 "path": "/foo",
916                 "py-version": [2, 6],
917                 "dependencies": {
918                     "jinja2": "",
919                     "yaml": "",
920                     "tornado": "",
921                     "msgpack": "",
922                 },
923             }
924         }
925         with pytest.raises(salt.exceptions.SaltSystemExit):
926             thin.get_ext_tops(cfg)
927         assert len(thin.log.warning.mock_calls) == 4
928         assert sorted(x[1][1] for x in thin.log.warning.mock_calls) == [
929             "jinja2",
930             "msgpack",
931             "tornado",
932             "yaml",
933         ]
934         assert (
935             "Module test has missing configuration"
936             == thin.log.warning.mock_calls[0][1][0] % "test"
937         )
938     @patch("salt.utils.thin.log", MagicMock())
939     @patch("salt.utils.thin.os.path.isfile", MagicMock(return_value=False))
940     def test_get_ext_tops_dependency_config_check(self):
941         cfg = {
942             "namespace": {
943                 "path": "/foo",
944                 "py-version": [2, 6],
945                 "dependencies": {
946                     "jinja2": "/jinja/foo.py",
947                     "yaml": "/yaml/",
948                     "tornado": "/tornado/wrong.rb",
949                     "msgpack": "msgpack.sh",
950                 },
951             }
952         }
953         with pytest.raises(salt.exceptions.SaltSystemExit) as err:
954             thin.get_ext_tops(cfg)
955         self.assertIn(
956             "Missing dependencies for the alternative version in the "
957             "external configuration",
958             str(err.value),
959         )
960         messages = {}
961         for cl in thin.log.warning.mock_calls:
962             messages[cl[1][1]] = cl[1][0] % (cl[1][1], cl[1][2])
963         for mod in ["tornado", "yaml", "msgpack"]:
964             self.assertIn("not a Python importable module", messages[mod])
965         self.assertIn(
966             "configured with not a file or does not exist", messages["jinja2"]
967         )
968     @patch("salt.exceptions.SaltSystemExit", Exception)
969     @patch("salt.utils.thin.log", MagicMock())
970     @patch("salt.utils.thin.os.path.isfile", MagicMock(return_value=True))
971     def test_get_ext_tops_config_pass(self):
972         cfg = {
973             "namespace": {
974                 "path": "/foo",
975                 "py-version": [2, 6],
976                 "dependencies": {
977                     "jinja2": "/jinja/foo.py",
978                     "yaml": "/yaml/",
979                     "tornado": "/tornado/tornado.py",
980                     "msgpack": "msgpack.py",
981                     "distro": "distro.py",
982                 },
983             }
984         }
985         out = thin.get_ext_tops(cfg)
986         assert out["namespace"]["py-version"] == cfg["namespace"]["py-version"]
987         assert out["namespace"]["path"] == cfg["namespace"]["path"]
988         assert sorted(out["namespace"]["dependencies"]) == sorted(
989             [
990                 "/tornado/tornado.py",
991                 "/jinja/foo.py",
992                 "/yaml/",
993                 "msgpack.py",
994                 "distro.py",
995             ]
996         )
997     @patch("salt.utils.thin.sys.argv", [None, '{"foo": "bar"}'])
998     @patch("salt.utils.thin.get_tops", lambda **kw: kw)
999     def test_gte(self):
1000         assert salt.utils.json.loads(thin.gte()).get("foo") == "bar"
1001     def test_add_dep_path(self):
1002         container = []
1003         for pth in ["/foo/bar.py", "/something/else/__init__.py"]:
1004             thin._add_dependency(container, type("obj", (), {"__file__": pth})())
1005         assert "__init__" not in container[1]
1006         assert container == ["/foo/bar.py", "/something/else"]
1007     def test_thin_path(self):
1008         path = os.sep + os.path.join("path", "to")
1009         expected = os.path.join(path, "thin", "thin.tgz")
1010         self.assertEqual(thin.thin_path(path), expected)
1011     def test_get_salt_call_script(self):
1012         out = thin._get_salt_call("foo", "bar", py26=[2, 6], py27=[2, 7], py34=[3, 4])
1013         for line in salt.utils.stringutils.to_str(out).split(os.linesep):
1014             if line.startswith("namespaces = {"):
1015                 data = salt.utils.json.loads(line.replace("namespaces = ", "").strip())
1016                 assert data.get("py26") == [2, 6]
1017                 assert data.get("py27") == [2, 7]
1018                 assert data.get("py34") == [3, 4]
1019             if line.startswith("syspaths = "):
1020                 data = salt.utils.json.loads(line.replace("syspaths = ", ""))
1021                 assert data == ["foo", "bar"]
1022     def test_get_ext_namespaces_empty(self):
1023         for obj in [None, {}, []]:
1024             assert thin._get_ext_namespaces(obj) == {}
1025     def test_get_ext_namespaces(self):
1026         cfg = {"ns": {"py-version": [2, 7]}}
1027         assert thin._get_ext_namespaces(cfg).get("ns") == (
1028             2,
1029             7,
1030         )
1031         assert isinstance(thin._get_ext_namespaces(cfg).get("ns"), tuple)
1032     def test_get_ext_namespaces_failure(self):
1033         with pytest.raises(salt.exceptions.SaltSystemExit):
1034             thin._get_ext_namespaces({"ns": {}})
1035     @patch(
1036         "salt.utils.thin.distro",
1037         type("distro", (), {"__file__": "/site-packages/distro"}),
1038     )
1039     @patch(
1040         "salt.utils.thin.salt",
1041         type("salt", (), {"__file__": "/site-packages/salt"}),
1042     )
1043     @patch(
1044         "salt.utils.thin.jinja2",
1045         type("jinja2", (), {"__file__": "/site-packages/jinja2"}),
1046     )
1047     @patch(
1048         "salt.utils.thin.yaml",
1049         type("yaml", (), {"__file__": "/site-packages/yaml"}),
1050     )
1051     @patch(
1052         "salt.utils.thin.tornado",
1053         type("tornado", (), {"__file__": "/site-packages/tornado"}),
1054     )
1055     @patch(
1056         "salt.utils.thin.msgpack",
1057         type("msgpack", (), {"__file__": "/site-packages/msgpack"}),
1058     )
1059     @patch(
1060         "salt.utils.thin.certifi",
1061         type("certifi", (), {"__file__": "/site-packages/certifi"}),
1062     )
1063     @patch(
1064         "salt.utils.thin.singledispatch",
1065         type("singledispatch", (), {"__file__": "/site-packages/sdp"}),
1066     )
1067     @patch(
1068         "salt.utils.thin.singledispatch_helpers",
1069         type("singledispatch_helpers", (), {"__file__": "/site-packages/sdp_hlp"}),
1070     )
1071     @patch(
1072         "salt.utils.thin.ssl_match_hostname",
1073         type("ssl_match_hostname", (), {"__file__": "/site-packages/ssl_mh"}),
1074     )
1075     @patch(
1076         "salt.utils.thin.markupsafe",
1077         type("markupsafe", (), {"__file__": "/site-packages/markupsafe"}),
1078     )
1079     @patch(
1080         "salt.utils.thin.backports_abc",
1081         type("backports_abc", (), {"__file__": "/site-packages/backports_abc"}),
1082     )
1083     @patch(
1084         "salt.utils.thin.concurrent",
1085         type("concurrent", (), {"__file__": "/site-packages/concurrent"}),
1086     )
1087     @patch(
1088         "salt.utils.thin.py_contextvars",
1089         type("contextvars", (), {"__file__": "/site-packages/contextvars"}),
1090     )
1091     @patch_if(
1092         salt.utils.thin.has_immutables,
1093         "salt.utils.thin.immutables",
1094         type("immutables", (), {"__file__": "/site-packages/immutables"}),
1095     )
1096     @patch("salt.utils.thin.log", MagicMock())
1097     def test_get_tops(self):
1098         base_tops = [
1099             "distro",
1100             "salt",
1101             "jinja2",
1102             "yaml",
1103             "tornado",
1104             "msgpack",
1105             "certifi",
1106             "sdp",
1107             "sdp_hlp",
1108             "ssl_mh",
1109             "markupsafe",
1110             "backports_abc",
1111             "concurrent",
1112             "contextvars",
1113         ]
1114         if salt.utils.thin.has_immutables:
1115             base_tops.extend(["immutables"])
1116         tops = []
1117         for top in thin.get_tops(extra_mods="foo,bar"):
1118             if top.find("/") != -1:
1119                 spl = "/"
1120             else:
1121                 spl = os.sep
1122             tops.append(top.rsplit(spl, 1)[-1])
1123         assert len(tops) == len(base_tops)
1124         assert sorted(tops) == sorted(base_tops), sorted(tops)
1125     @patch(
1126         "salt.utils.thin.distro",
1127         type("distro", (), {"__file__": "/site-packages/distro"}),
1128     )
1129     @patch(
1130         "salt.utils.thin.salt",
1131         type("salt", (), {"__file__": "/site-packages/salt"}),
1132     )
1133     @patch(
1134         "salt.utils.thin.jinja2",
1135         type("jinja2", (), {"__file__": "/site-packages/jinja2"}),
1136     )
1137     @patch(
1138         "salt.utils.thin.yaml",
1139         type("yaml", (), {"__file__": "/site-packages/yaml"}),
1140     )
1141     @patch(
1142         "salt.utils.thin.tornado",
1143         type("tornado", (), {"__file__": "/site-packages/tornado"}),
1144     )
1145     @patch(
1146         "salt.utils.thin.msgpack",
1147         type("msgpack", (), {"__file__": "/site-packages/msgpack"}),
1148     )
1149     @patch(
1150         "salt.utils.thin.certifi",
1151         type("certifi", (), {"__file__": "/site-packages/certifi"}),
1152     )
1153     @patch(
1154         "salt.utils.thin.singledispatch",
1155         type("singledispatch", (), {"__file__": "/site-packages/sdp"}),
1156     )
1157     @patch(
1158         "salt.utils.thin.singledispatch_helpers",
1159         type("singledispatch_helpers", (), {"__file__": "/site-packages/sdp_hlp"}),
1160     )
1161     @patch(
1162         "salt.utils.thin.ssl_match_hostname",
1163         type("ssl_match_hostname", (), {"__file__": "/site-packages/ssl_mh"}),
1164     )
1165     @patch(
1166         "salt.utils.thin.markupsafe",
1167         type("markupsafe", (), {"__file__": "/site-packages/markupsafe"}),
1168     )
1169     @patch(
1170         "salt.utils.thin.backports_abc",
1171         type("backports_abc", (), {"__file__": "/site-packages/backports_abc"}),
1172     )
1173     @patch(
1174         "salt.utils.thin.concurrent",
1175         type("concurrent", (), {"__file__": "/site-packages/concurrent"}),
1176     )
1177     @patch(
1178         "salt.utils.thin.py_contextvars",
1179         type("contextvars", (), {"__file__": "/site-packages/contextvars"}),
1180     )
1181     @patch_if(
1182         salt.utils.thin.has_immutables,
1183         "salt.utils.thin.immutables",
1184         type("immutables", (), {"__file__": "/site-packages/immutables"}),
1185     )
1186     @patch("salt.utils.thin.log", MagicMock())
1187     def test_get_tops_extra_mods(self):
1188         base_tops = [
1189             "distro",
1190             "salt",
1191             "jinja2",
1192             "yaml",
1193             "tornado",
1194             "msgpack",
1195             "certifi",
1196             "sdp",
1197             "sdp_hlp",
1198             "ssl_mh",
1199             "concurrent",
1200             "markupsafe",
1201             "backports_abc",
1202             "contextvars",
1203             "foo",
1204             "bar.py",
1205         ]
1206         if salt.utils.thin.has_immutables:
1207             base_tops.extend(["immutables"])
1208         libs = salt.utils.thin.find_site_modules("contextvars")
1209         foo = {"__file__": os.sep + os.path.join("custom", "foo", "__init__.py")}
1210         bar = {"__file__": os.sep + os.path.join("custom", "bar")}
1211         with patch("salt.utils.thin.find_site_modules", MagicMock(side_effect=[libs])):
1212             with patch(
1213                 "builtins.__import__",
1214                 MagicMock(side_effect=[type("foo", (), foo), type("bar", (), bar)]),
1215             ):
1216                 tops = []
1217                 for top in thin.get_tops(extra_mods="foo,bar"):
1218                     if top.find("/") != -1:
1219                         spl = "/"
1220                     else:
1221                         spl = os.sep
1222                     tops.append(top.rsplit(spl, 1)[-1])
1223         self.assertEqual(len(tops), len(base_tops))
1224         self.assertListEqual(sorted(tops), sorted(base_tops))
1225     @patch(
1226         "salt.utils.thin.distro",
1227         type("distro", (), {"__file__": "/site-packages/distro"}),
1228     )
1229     @patch(
1230         "salt.utils.thin.salt",
1231         type("salt", (), {"__file__": "/site-packages/salt"}),
1232     )
1233     @patch(
1234         "salt.utils.thin.jinja2",
1235         type("jinja2", (), {"__file__": "/site-packages/jinja2"}),
1236     )
1237     @patch(
1238         "salt.utils.thin.yaml",
1239         type("yaml", (), {"__file__": "/site-packages/yaml"}),
1240     )
1241     @patch(
1242         "salt.utils.thin.tornado",
1243         type("tornado", (), {"__file__": "/site-packages/tornado"}),
1244     )
1245     @patch(
1246         "salt.utils.thin.msgpack",
1247         type("msgpack", (), {"__file__": "/site-packages/msgpack"}),
1248     )
1249     @patch(
1250         "salt.utils.thin.certifi",
1251         type("certifi", (), {"__file__": "/site-packages/certifi"}),
1252     )
1253     @patch(
1254         "salt.utils.thin.singledispatch",
1255         type("singledispatch", (), {"__file__": "/site-packages/sdp"}),
1256     )
1257     @patch(
1258         "salt.utils.thin.singledispatch_helpers",
1259         type("singledispatch_helpers", (), {"__file__": "/site-packages/sdp_hlp"}),
1260     )
1261     @patch(
1262         "salt.utils.thin.ssl_match_hostname",
1263         type("ssl_match_hostname", (), {"__file__": "/site-packages/ssl_mh"}),
1264     )
1265     @patch(
1266         "salt.utils.thin.markupsafe",
1267         type("markupsafe", (), {"__file__": "/site-packages/markupsafe"}),
1268     )
1269     @patch(
1270         "salt.utils.thin.backports_abc",
1271         type("backports_abc", (), {"__file__": "/site-packages/backports_abc"}),
1272     )
1273     @patch(
1274         "salt.utils.thin.concurrent",
1275         type("concurrent", (), {"__file__": "/site-packages/concurrent"}),
1276     )
1277     @patch(
1278         "salt.utils.thin.py_contextvars",
1279         type("contextvars", (), {"__file__": "/site-packages/contextvars"}),
1280     )
1281     @patch_if(
1282         salt.utils.thin.has_immutables,
1283         "salt.utils.thin.immutables",
1284         type("immutables", (), {"__file__": "/site-packages/immutables"}),
1285     )
1286     @patch("salt.utils.thin.log", MagicMock())
1287     def test_get_tops_so_mods(self):
1288         base_tops = [
1289             "distro",
1290             "salt",
1291             "jinja2",
1292             "yaml",
1293             "tornado",
1294             "msgpack",
1295             "certifi",
1296             "sdp",
1297             "sdp_hlp",
1298             "ssl_mh",
1299             "concurrent",
1300             "markupsafe",
1301             "backports_abc",
1302             "contextvars",
1303             "foo.so",
1304             "bar.so",
1305         ]
1306         if salt.utils.thin.has_immutables:
1307             base_tops.extend(["immutables"])
1308         libs = salt.utils.thin.find_site_modules("contextvars")
1309         with patch("salt.utils.thin.find_site_modules", MagicMock(side_effect=[libs])):
1310             with patch(
1311                 "builtins.__import__",
1312                 MagicMock(
1313                     side_effect=[
1314                         type("salt", (), {"__file__": "/custom/foo.so"}),
1315                         type("salt", (), {"__file__": "/custom/bar.so"}),
1316                     ]
1317                 ),
1318             ):
1319                 tops = []
1320                 for top in thin.get_tops(so_mods="foo,bar"):
1321                     if top.find("/") != -1:
1322                         spl = "/"
1323                     else:
1324                         spl = os.sep
1325                     tops.append(top.rsplit(spl, 1)[-1])
1326         assert len(tops) == len(base_tops)
1327         assert sorted(tops) == sorted(base_tops)
1328     @patch("salt.utils.thin.gen_thin", MagicMock(return_value="/path/to/thin/thin.tgz"))
1329     @patch("salt.utils.hashutils.get_hash", MagicMock(return_value=12345))
1330     def test_thin_sum(self):
1331         assert thin.thin_sum("/cachedir", form="sha256")[1] == 12345
1332         thin.salt.utils.hashutils.get_hash.assert_called()
1333         assert thin.salt.utils.hashutils.get_hash.call_count == 1
1334         path, form = thin.salt.utils.hashutils.get_hash.call_args[0]
1335         assert path == "/path/to/thin/thin.tgz"
1336         assert form == "sha256"
1337     @patch("salt.utils.thin.gen_min", MagicMock(return_value="/path/to/thin/min.tgz"))
1338     @patch("salt.utils.hashutils.get_hash", MagicMock(return_value=12345))
1339     def test_min_sum(self):
1340         assert thin.min_sum("/cachedir", form="sha256") == 12345
1341         thin.salt.utils.hashutils.get_hash.assert_called()
1342         assert thin.salt.utils.hashutils.get_hash.call_count == 1
1343         path, form = thin.salt.utils.hashutils.get_hash.call_args[0]
1344         assert path == "/path/to/thin/min.tgz"
1345         assert form == "sha256"
1346     @patch("salt.utils.thin.sys.version_info", (2, 5))
1347     @patch("salt.exceptions.SaltSystemExit", Exception)
1348     def test_gen_thin_fails_ancient_python_version(self):
1349         with pytest.raises(salt.exceptions.SaltSystemExit) as err:
1350             thin.sys.exc_clear = lambda: None
1351             thin.gen_thin("")
1352         self.assertIn(
1353             'The minimum required python version to run salt-ssh is "3"',
1354             str(err.value),
1355         )
1356     @patch("salt.exceptions.SaltSystemExit", Exception)
1357     @patch("salt.utils.thin.log", MagicMock())
1358     @patch("salt.utils.thin.os.makedirs", MagicMock())
1359     @patch("salt.utils.files.fopen", MagicMock())
1360     @patch("salt.utils.thin._get_salt_call", MagicMock())
1361     @patch("salt.utils.thin._get_ext_namespaces", MagicMock())
1362     @patch("salt.utils.thin.get_tops", MagicMock(return_value=["/foo3", "/bar3"]))
1363     @patch("salt.utils.thin.get_ext_tops", MagicMock(return_value={}))
1364     @patch("salt.utils.thin.os.path.isfile", MagicMock())
1365     @patch("salt.utils.thin.os.path.isdir", MagicMock(return_value=True))
1366     @patch("salt.utils.thin.log", MagicMock())
1367     @patch("salt.utils.thin.os.remove", MagicMock())
1368     @patch("salt.utils.thin.os.path.exists", MagicMock())
1369     @patch("salt.utils.path.os_walk", MagicMock(return_value=[]))
1370     @patch(
1371         "salt.utils.thin.subprocess.Popen",
1372         _popen(
1373             None,
1374             side_effect=[(bts("2.7"), bts("")), (bts('["/foo27", "/bar27"]'), bts(""))],
1375         ),
1376     )
1377     @patch("salt.utils.thin.tarfile", MagicMock())
1378     @patch("salt.utils.thin.zipfile", MagicMock())
1379     @patch("salt.utils.thin.os.getcwd", MagicMock())
1380     @patch("salt.utils.thin.os.access", MagicMock(return_value=True))
1381     @patch("salt.utils.thin.os.chdir", MagicMock())
1382     @patch("salt.utils.thin.os.close", MagicMock())
1383     @patch("salt.utils.thin.tempfile.mkdtemp", MagicMock())
1384     @patch(
1385         "salt.utils.thin.tempfile.mkstemp", MagicMock(return_value=(3, ".temporary"))
1386     )
1387     @patch("salt.utils.thin.shutil", MagicMock())
1388     @patch("salt.utils.thin.sys.version_info", _version_info(None, 3, 6))
1389     @patch("salt.utils.path.which", MagicMock(return_value="/usr/bin/python"))
1390     def test_gen_thin_compression_fallback_py3(self):
1391         thin.gen_thin("", compress="arj")
1392         thin.log.warning.assert_called()
1393         pt, msg = thin.log.warning.mock_calls[0][1]
1394         assert (
1395             pt % msg
1396             == 'Unknown compression type: "arj". Falling back to "gzip" compression.'
1397         )
1398         thin.zipfile.ZipFile.assert_not_called()
1399         thin.tarfile.open.assert_called()
1400     @patch("salt.exceptions.SaltSystemExit", Exception)
1401     @patch("salt.utils.thin.log", MagicMock())
1402     @patch("salt.utils.thin.os.makedirs", MagicMock())
1403     @patch("salt.utils.files.fopen", MagicMock())
1404     @patch("salt.utils.thin._get_salt_call", MagicMock())
1405     @patch("salt.utils.thin._get_ext_namespaces", MagicMock())
1406     @patch("salt.utils.thin.get_tops", MagicMock(return_value=["/foo3", "/bar3"]))
1407     @patch("salt.utils.thin.get_ext_tops", MagicMock(return_value={}))
1408     @patch("salt.utils.thin.os.path.isfile", MagicMock())
1409     @patch("salt.utils.thin.os.path.isdir", MagicMock(return_value=False))
1410     @patch("salt.utils.thin.log", MagicMock())
1411     @patch("salt.utils.thin.os.remove", MagicMock())
1412     @patch("salt.utils.thin.os.path.exists", MagicMock())
1413     @patch("salt.utils.path.os_walk", MagicMock(return_value=[]))
1414     @patch(
1415         "salt.utils.thin.subprocess.Popen",
1416         _popen(
1417             None,
1418             side_effect=[(bts("2.7"), bts("")), (bts('["/foo27", "/bar27"]'), bts(""))],
1419         ),
1420     )
1421     @patch("salt.utils.thin.tarfile", MagicMock())
1422     @patch("salt.utils.thin.zipfile", MagicMock())
1423     @patch("salt.utils.thin.os.getcwd", MagicMock())
1424     @patch("salt.utils.thin.os.access", MagicMock(return_value=True))
1425     @patch("salt.utils.thin.os.chdir", MagicMock())
1426     @patch("salt.utils.thin.os.close", MagicMock())
1427     @patch("salt.utils.thin.tempfile.mkdtemp", MagicMock(return_value=""))
1428     @patch(
1429         "salt.utils.thin.tempfile.mkstemp", MagicMock(return_value=(3, ".temporary"))
1430     )
1431     @patch("salt.utils.thin.shutil", MagicMock())
1432     @patch("salt.utils.thin.sys.version_info", _version_info(None, 3, 6))
1433     @patch("salt.utils.path.which", MagicMock(return_value="/usr/bin/python"))
1434     def test_gen_thin_control_files_written_py3(self):
1435         thin.gen_thin("")
1436         arc_name, arc_mode = thin.tarfile.method_calls[0][1]
1437         self.assertEqual(arc_name, ".temporary")
1438         self.assertEqual(arc_mode, "w:gz")
1439         for idx, fname in enumerate(
1440             ["version", ".thin-gen-py-version", "salt-call", "supported-versions"]
1441         ):
1442             name = thin.tarfile.open().method_calls[idx + 2][1][0]
1443             self.assertEqual(name, fname)
1444         thin.tarfile.open().close.assert_called()
1445     @patch("salt.exceptions.SaltSystemExit", Exception)
1446     @patch("salt.utils.thin.log", MagicMock())
1447     @patch("salt.utils.thin.os.makedirs", MagicMock())
1448     @patch("salt.utils.files.fopen", MagicMock())
1449     @patch("salt.utils.thin._get_salt_call", MagicMock())
1450     @patch("salt.utils.thin._get_ext_namespaces", MagicMock())
1451     @patch("salt.utils.thin.get_tops", MagicMock(return_value=["/salt", "/bar3"]))
1452     @patch("salt.utils.thin.get_ext_tops", MagicMock(return_value={}))
1453     @patch("salt.utils.thin.os.path.isfile", MagicMock())
1454     @patch("salt.utils.thin.os.path.isdir", MagicMock(return_value=True))
1455     @patch("salt.utils.thin.log", MagicMock())
1456     @patch("salt.utils.thin.os.remove", MagicMock())
1457     @patch("salt.utils.thin.os.path.exists", MagicMock())
1458     @patch(
1459         "salt.utils.path.os_walk",
1460         MagicMock(
1461             return_value=(
1462                 ("root", [], ["r1", "r2", "r3"]),
1463                 ("root2", [], ["r4", "r5", "r6"]),
1464             )
1465         ),
1466     )
1467     @patch("salt.utils.thin.tarfile", _tarfile(None))
1468     @patch("salt.utils.thin.zipfile", MagicMock())
1469     @patch(
1470         "salt.utils.thin.os.getcwd",
1471         MagicMock(return_value=os.path.join(RUNTIME_VARS.TMP, "fake-cwd")),
1472     )
1473     @patch("salt.utils.thin.os.chdir", MagicMock())
1474     @patch("salt.utils.thin.os.close", MagicMock())
1475     @patch("salt.utils.thin.tempfile.mkdtemp", MagicMock(return_value=""))
1476     @patch(
1477         "salt.utils.thin.tempfile.mkstemp", MagicMock(return_value=(3, ".temporary"))
1478     )
1479     @patch("salt.utils.thin.shutil", MagicMock())
1480     @patch("salt.utils.thin.sys.version_info", _version_info(None, 3, 6))
1481     @patch("salt.utils.hashutils.DigestCollector", MagicMock())
1482     @patch("salt.utils.path.which", MagicMock(return_value="/usr/bin/python"))
1483     def test_gen_thin_main_content_files_written_py3(self):
1484         thin.gen_thin("")
1485         files = []
1486         for py in ("py3", "pyall"):
1487             for i in range(1, 4):
1488                 files.append(os.path.join(py, "root", "r{}".format(i)))
1489             for i in range(4, 7):
1490                 files.append(os.path.join(py, "root2", "r{}".format(i)))
1491         for cl in thin.tarfile.open().method_calls[:-6]:
1492             arcname = cl[2].get("arcname")
1493             self.assertIn(arcname, files)
1494             files.pop(files.index(arcname))
1495         self.assertFalse(files)
1496     @patch("salt.exceptions.SaltSystemExit", Exception)
1497     @patch("salt.utils.thin.log", MagicMock())
1498     @patch("salt.utils.thin.os.makedirs", MagicMock())
1499     @patch("salt.utils.files.fopen", MagicMock())
1500     @patch("salt.utils.thin._get_salt_call", MagicMock())
1501     @patch("salt.utils.thin._get_ext_namespaces", MagicMock())
1502     @patch("salt.utils.thin.get_tops", MagicMock(return_value=[]))
1503     @patch(
1504         "salt.utils.thin.get_ext_tops",
1505         MagicMock(
1506             return_value={
1507                 "namespace": {
1508                     "py-version": [3, 0],
1509                     "path": "/opt/2015.8/salt",
1510                     "dependencies": ["/opt/certifi", "/opt/whatever"],
1511                 }
1512             }
1513         ),
1514     )
1515     @patch("salt.utils.thin.os.path.isfile", MagicMock())
1516     @patch("salt.utils.thin.os.path.isdir", MagicMock(return_value=True))
1517     @patch("salt.utils.thin.log", MagicMock())
1518     @patch("salt.utils.thin.os.remove", MagicMock())
1519     @patch("salt.utils.thin.os.path.exists", MagicMock())
1520     @patch(
1521         "salt.utils.path.os_walk",
1522         MagicMock(
1523             return_value=(
1524                 ("root", [], ["r1", "r2", "r3"]),
1525                 ("root2", [], ["r4", "r5", "r6"]),
1526             )
1527         ),
1528     )
1529     @patch("salt.utils.thin.tarfile", _tarfile(None))
1530     @patch("salt.utils.thin.zipfile", MagicMock())
1531     @patch(
1532         "salt.utils.thin.os.getcwd",
1533         MagicMock(return_value=os.path.join(RUNTIME_VARS.TMP, "fake-cwd")),
1534     )
1535     @patch("salt.utils.thin.os.chdir", MagicMock())
1536     @patch("salt.utils.thin.os.close", MagicMock())
1537     @patch("salt.utils.thin.tempfile.mkdtemp", MagicMock(return_value=""))
1538     @patch(
1539         "salt.utils.thin.tempfile.mkstemp", MagicMock(return_value=(3, ".temporary"))
1540     )
1541     @patch("salt.utils.thin.shutil", MagicMock())
1542     @patch("salt.utils.thin.sys.version_info", _version_info(None, 3, 6))
1543     @patch("salt.utils.hashutils.DigestCollector", MagicMock())
1544     @patch("salt.utils.path.which", MagicMock(return_value="/usr/bin/python"))
1545     def test_gen_thin_ext_alternative_content_files_written_py3(self):
1546         ext_conf = {
1547             "namespace": {
1548                 "py-version": [3, 0],
1549                 "path": "/opt/2015.8/salt",
1550                 "dependencies": {
1551                     "certifi": "/opt/certifi",
1552                     "whatever": "/opt/whatever",
1553                 },
1554             }
1555         }
1556         thin.gen_thin("", extended_cfg=ext_conf)
1557         files = []
1558         for py in ("pyall", "pyall", "py3"):
1559             for i in range(1, 4):
1560                 files.append(os.path.join("namespace", py, "root", "r{}".format(i)))
1561             for i in range(4, 7):
1562                 files.append(os.path.join("namespace", py, "root2", "r{}".format(i)))
1563         for idx, cl in enumerate(thin.tarfile.open().method_calls[:-6]):
1564             arcname = cl[2].get("arcname")
1565             self.assertIn(arcname, files)
1566             files.pop(files.index(arcname))
1567         self.assertFalse(files)
1568     def test_get_supported_py_config_typecheck(self):
1569         tops = {}
1570         ext_cfg = {}
1571         out = thin._get_supported_py_config(tops=tops, extended_cfg=ext_cfg)
1572         assert type(salt.utils.stringutils.to_bytes("")) == type(out)
1573     def test_get_supported_py_config_base_tops(self):
1574         tops = {"3": ["/groundkeepers", "/stole"], "2": ["/the-root", "/password"]}
1575         ext_cfg = {}
1576         out = (
1577             salt.utils.stringutils.to_str(
1578                 thin._get_supported_py_config(tops=tops, extended_cfg=ext_cfg)
1579             )
1580             .strip()
1581             .split(os.linesep)
1582         )
1583         self.assertEqual(len(out), 2)
1584         for t_line in ["py3:3:0", "py2:2:7"]:
1585             self.assertIn(t_line, out)
1586     def test_get_supported_py_config_ext_tops(self):
1587         tops = {}
1588         ext_cfg = {
1589             "solar-interference": {"py-version": [2, 6]},
1590             "second-system-effect": {"py-version": [2, 7]},
1591         }
1592         out = (
1593             salt.utils.stringutils.to_str(
1594                 thin._get_supported_py_config(tops=tops, extended_cfg=ext_cfg)
1595             )
1596             .strip()
1597             .split(os.linesep)
1598         )
1599         for t_line in ["second-system-effect:2:7", "solar-interference:2:6"]:
1600             self.assertIn(t_line, out)
1601     @patch("salt.exceptions.SaltSystemExit", Exception)
1602     @patch("salt.utils.thin.log", MagicMock())
1603     @patch("salt.utils.thin.os.makedirs", MagicMock())
1604     @patch("salt.utils.files.fopen", MagicMock())
1605     @patch("salt.utils.thin._get_salt_call", MagicMock())
1606     @patch("salt.utils.thin._get_ext_namespaces", MagicMock())
1607     @patch("salt.utils.thin.get_tops", MagicMock(return_value=["/foo3", "/bar3"]))
1608     @patch("salt.utils.thin.get_ext_tops", MagicMock(return_value={}))
1609     @patch("salt.utils.thin.os.path.isfile", MagicMock())
1610     @patch("salt.utils.thin.os.path.isdir", MagicMock(return_value=False))
1611     @patch("salt.utils.thin.log", MagicMock())
1612     @patch("salt.utils.thin.os.remove", MagicMock())
1613     @patch("salt.utils.thin.os.path.exists", MagicMock())
1614     @patch("salt.utils.path.os_walk", MagicMock(return_value=[]))
1615     @patch(
1616         "salt.utils.thin.subprocess.Popen",
1617         _popen(
1618             None,
1619             side_effect=[(bts("2.7"), bts("")), (bts('["/foo27", "/bar27"]'), bts(""))],
1620         ),
1621     )
1622     @patch("salt.utils.thin.tarfile", MagicMock())
1623     @patch("salt.utils.thin.zipfile", MagicMock())
1624     @patch("salt.utils.thin.os.getcwd", MagicMock())
1625     @patch("salt.utils.thin.os.access", MagicMock(return_value=False))
1626     @patch("salt.utils.thin.os.chdir", MagicMock())
1627     @patch("salt.utils.thin.os.close", MagicMock())
1628     @patch("salt.utils.thin.tempfile.mkdtemp", MagicMock(return_value=""))
1629     @patch(
1630         "salt.utils.thin.tempfile.mkstemp", MagicMock(return_value=(3, ".temporary"))
1631     )
1632     @patch("salt.utils.thin.shutil", MagicMock())
1633     @patch("salt.utils.thin.sys.version_info", _version_info(None, 3, 6))
1634     def test_gen_thin_control_files_written_access_denied_cwd(self):
1635         thin.gen_thin("")
1636         arc_name, arc_mode = thin.tarfile.method_calls[0][1]
1637         self.assertEqual(arc_name, ".temporary")
1638         self.assertEqual(arc_mode, "w:gz")
1639         for idx, fname in enumerate(
1640             ["version", ".thin-gen-py-version", "salt-call", "supported-versions"]
1641         ):
1642             name = thin.tarfile.open().method_calls[idx + 2][1][0]
1643             self.assertEqual(name, fname)
1644         thin.tarfile.open().close.assert_called()
1645     def test_get_tops_python(self):
1646         patch_proc = patch(
1647             "salt.utils.thin.subprocess.Popen",
1648             self._popen(
1649                 None,
1650                 side_effect=[
1651                     (bts("jinja2/__init__.py"), bts("")),
1652                     (bts("yaml/__init__.py"), bts("")),
1653                     (bts("tornado/__init__.py"), bts("")),
1654                     (bts("msgpack/__init__.py"), bts("")),
1655                     (bts("certifi/__init__.py"), bts("")),
1656                     (bts("singledispatch.py"), bts("")),
1657                     (bts(""), bts("")),
1658                     (bts(""), bts("")),
1659                     (bts(""), bts("")),
1660                     (bts(""), bts("")),
1661                     (bts(""), bts("")),
1662                     (bts("distro.py"), bts("")),
1663                 ],
1664             ),
1665         )
1666         patch_os = patch("os.path.exists", return_value=True)
1667         patch_which = patch("salt.utils.path.which", return_value=True)
1668         with patch_proc, patch_os, patch_which:
1669             with TstSuiteLoggingHandler() as log_handler:
1670                 exp_ret = copy.deepcopy(self.exp_ret)
1671                 ret = thin.get_tops_python("python3.7", ext_py_ver=[3, 7])
1672                 if salt.utils.platform.is_windows():
1673                     for key, value in ret.items():
1674                         ret[key] = str(pathlib.Path(value).resolve(strict=False))
1675                     for key, value in exp_ret.items():
1676                         exp_ret[key] = str(pathlib.Path(value).resolve(strict=False))
1677                 assert ret == exp_ret
1678                 assert (
1679                     "ERROR:Could not auto detect file location for module concurrent"
1680                     " for python version python3.7" in log_handler.messages
1681                 )
1682     def test_get_tops_python_exclude(self):
1683         patch_proc = patch(
1684             "salt.utils.thin.subprocess.Popen",
1685             self._popen(
1686                 None,
1687                 side_effect=[
1688                     (bts("tornado/__init__.py"), bts("")),
1689                     (bts("msgpack/__init__.py"), bts("")),
1690                     (bts("certifi/__init__.py"), bts("")),
1691                     (bts("singledispatch.py"), bts("")),
1692                     (bts(""), bts("")),
1693                     (bts(""), bts("")),
1694                     (bts(""), bts("")),
1695                     (bts(""), bts("")),
1696                     (bts(""), bts("")),
1697                     (bts("distro.py"), bts("")),
1698                 ],
1699             ),
1700         )
1701         exp_ret = copy.deepcopy(self.exp_ret)
1702         for lib in self.exc_libs:
1703             exp_ret.pop(lib)
1704         patch_os = patch("os.path.exists", return_value=True)
1705         patch_which = patch("salt.utils.path.which", return_value=True)
1706         with patch_proc, patch_os, patch_which:
1707             ret = thin.get_tops_python(
1708                 "python3.7", exclude=self.exc_libs, ext_py_ver=[3, 7]
1709             )
1710             if salt.utils.platform.is_windows():
1711                 for key, value in ret.items():
1712                     ret[key] = str(pathlib.Path(value).resolve(strict=False))
1713                 for key, value in exp_ret.items():
1714                     exp_ret[key] = str(pathlib.Path(value).resolve(strict=False))
1715             assert ret == exp_ret
1716     def test_pack_alternatives_exclude(self):
1717         patch_proc = patch(
1718             "salt.utils.thin.subprocess.Popen",
1719             self._popen(
1720                 None,
1721                 side_effect=[
1722                     (bts(self.fake_libs["distro"]), bts("")),
1723                     (bts(self.fake_libs["yaml"]), bts("")),
1724                     (bts(self.fake_libs["tornado"]), bts("")),
1725                     (bts(self.fake_libs["msgpack"]), bts("")),
1726                     (bts(""), bts("")),
1727                     (bts(""), bts("")),
1728                     (bts(""), bts("")),
1729                     (bts(""), bts("")),
1730                     (bts(""), bts("")),
1731                     (bts(""), bts("")),
1732                     (bts(""), bts("")),
1733                 ],
1734             ),
1735         )
1736         patch_os = patch("os.path.exists", return_value=True)
1737         ext_conf = copy.deepcopy(self.ext_conf)
1738         ext_conf["test"]["auto_detect"] = True
1739         for lib in self.fake_libs.values():
1740             os.makedirs(lib)
1741 <a name="1"></a>            with salt.utils.files.fopen(os.path.join(lib, "__init__.py"), "w+") as fp_:
1742                 fp_.write("test")
1743         exp_files <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= self.exp_files.copy()
1744         exp_files.extend(
1745             [
1746                 os.path.join("yaml", "__init__.py"),
1747                 os.path.</b></font>join("tornado", "__init__.py"),
1748                 os.path.join("msgpack", "__init__.py"),
1749             ]
1750         )
1751         patch_which = patch("salt.utils.path.which", return_value=True)
1752         with patch_os, patch_proc, patch_which:
1753             thin._pack_alternative(ext_conf, self.digest, self.tar)
1754             calls = self.tar.mock_calls
1755             for _file in exp_files:
1756                 assert [x for x in calls if "{}".format(_file) in x[-2]]
1757     def test_pack_alternatives(self):
1758         with patch("salt.utils.thin.get_ext_tops", MagicMock(return_value=self.tops)):
1759             thin._pack_alternative(self.ext_conf, self.digest, self.tar)
1760             calls = self.tar.mock_calls
1761             for _file in self.exp_files:
1762                 assert [x for x in calls if "{}".format(_file) in x[-2]]
1763                 assert [
1764                     x
1765                     for x in calls
1766                     if os.path.join("test", "pyall", _file) in x[-1]["arcname"]
1767                 ]
1768     def test_pack_alternatives_not_normalized(self):
1769         tops = copy.deepcopy(self.tops)
1770         tops["test"]["dependencies"] = [self.jinja_fp + "/"]
1771         with patch("salt.utils.thin.get_ext_tops", MagicMock(return_value=tops)):
1772             thin._pack_alternative(self.ext_conf, self.digest, self.tar)
1773             calls = self.tar.mock_calls
1774             for _file in self.exp_files:
1775                 assert [x for x in calls if "{}".format(_file) in x[-2]]
1776                 assert [
1777                     x
1778                     for x in calls
1779                     if os.path.join("test", "pyall", _file) in x[-1]["arcname"]
1780                 ]
1781     def test_pack_alternatives_path_doesnot_exist(self):
1782         bad_path = os.path.join(tempfile.gettempdir(), "doesnotexisthere")
1783         tops = copy.deepcopy(self.tops)
1784         tops["test"]["dependencies"] = [bad_path]
1785         with patch("salt.utils.thin.get_ext_tops", MagicMock(return_value=tops)):
1786             with TstSuiteLoggingHandler() as log_handler:
1787                 thin._pack_alternative(self.ext_conf, self.digest, self.tar)
1788                 msg = "ERROR:File path {} does not exist. Unable to add to salt-ssh thin".format(
1789                     bad_path
1790                 )
1791                 assert msg in log_handler.messages
1792         calls = self.tar.mock_calls
1793         for _file in self.exp_files:
1794             arg = [x for x in calls if "{}".format(_file) in x[-2]]
1795             kwargs = [
1796                 x
1797                 for x in calls
1798                 if os.path.join("test", "pyall", _file) in x[-1]["arcname"]
1799             ]
1800             if "jinja2" in _file:
1801                 assert not arg
1802                 assert not kwargs
1803             else:
1804                 assert arg
1805                 assert kwargs
1806     def test_pack_alternatives_auto_detect(self):
1807         ext_conf = copy.deepcopy(self.ext_conf)
1808         ext_conf["test"]["auto_detect"] = True
1809         for lib in self.fake_libs.values():
1810             os.makedirs(lib)
1811             with salt.utils.files.fopen(os.path.join(lib, "__init__.py"), "w+") as fp_:
1812                 fp_.write("test")
1813         patch_tops_py = patch(
1814             "salt.utils.thin.get_tops_python", return_value=self.fake_libs
1815         )
1816         exp_files = self.exp_files.copy()
1817         exp_files.extend(
1818             [
1819                 os.path.join("yaml", "__init__.py"),
1820                 os.path.join("tornado", "__init__.py"),
1821                 os.path.join("msgpack", "__init__.py"),
1822             ]
1823         )
1824         with patch_tops_py:
1825             thin._pack_alternative(ext_conf, self.digest, self.tar)
1826             calls = self.tar.mock_calls
1827             for _file in exp_files:
1828                 assert [x for x in calls if "{}".format(_file) in x[-2]]
1829     def test_pack_alternatives_empty_dependencies(self):
1830         ext_conf = copy.deepcopy(self.ext_conf)
1831         ext_conf["test"]["auto_detect"] = True
1832         ext_conf["test"].pop("dependencies")
1833         for lib in self.fake_libs.values():
1834             os.makedirs(lib)
1835             with salt.utils.files.fopen(os.path.join(lib, "__init__.py"), "w+") as fp_:
1836                 fp_.write("test")
1837         patch_tops_py = patch(
1838             "salt.utils.thin.get_tops_python", return_value=self.fake_libs
1839         )
1840         exp_files = self.exp_files.copy()
1841         exp_files.extend(
1842             [
1843                 os.path.join("yaml", "__init__.py"),
1844                 os.path.join("tornado", "__init__.py"),
1845                 os.path.join("msgpack", "__init__.py"),
1846             ]
1847         )
1848         with patch_tops_py:
1849             thin._pack_alternative(ext_conf, self.digest, self.tar)
1850             calls = self.tar.mock_calls
1851             for _file in exp_files:
1852                 assert [x for x in calls if "{}".format(_file) in x[-2]]
1853     @pytest.mark.slow_test
1854     @skipIf(
1855         salt.utils.platform.is_windows(), "salt-ssh does not deploy to/from windows"
1856     )
1857     def test_thin_dir(self):
1858         with VirtualEnv() as venv:
1859             salt.utils.thin.gen_thin(str(venv.venv_dir))
1860             thin_dir = venv.venv_dir / "thin"
1861             thin_archive = thin_dir / "thin.tgz"
1862             tar = tarfile.open(str(thin_archive))
1863             tar.extractall(str(thin_dir))
1864             tar.close()
1865             ret = venv.run(
1866                 venv.venv_python,
1867                 str(thin_dir / "salt-call"),
1868                 "--version",
1869                 check=False,
1870             )
1871             assert ret.exitcode == 0, ret
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
