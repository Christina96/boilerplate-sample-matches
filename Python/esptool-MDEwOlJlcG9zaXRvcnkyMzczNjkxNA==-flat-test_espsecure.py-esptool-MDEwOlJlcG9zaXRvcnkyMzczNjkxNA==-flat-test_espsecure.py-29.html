
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 20, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>esptool-MDEwOlJlcG9zaXRvcnkyMzczNjkxNA==-flat-test_espsecure.py</h3>
            <pre><code>1  import binascii
2  import io
3  import os
4  import os.path
5  import subprocess
6  import sys
7  import tempfile
8  from collections import namedtuple
9  from conftest import need_to_install_package_err
10  import pytest
11  try:
12      import esptool
13      import espsecure
14  except ImportError:
15      need_to_install_package_err()
16  TEST_DIR = os.path.abspath(os.path.dirname(__file__))
17  @pytest.mark.host_test
18  class EspSecureTestCase:
19      def run_espsecure(self, args):
20          cmd = [sys.executable, &quot;-m&quot;, &quot;espsecure&quot;] + args.split(&quot; &quot;)
21          print(&quot;\nExecuting {}...&quot;.format(&quot; &quot;.join(cmd)))
22          try:
23              output = subprocess.check_output(
24                  [str(s) for s in cmd], cwd=TEST_DIR, stderr=subprocess.STDOUT
25              )
26              output = output.decode(&quot;utf-8&quot;)
27              print(output)
28              return output
29          except subprocess.CalledProcessError as e:
30              print(e.output.decode(&quot;utf-8&quot;))
31              raise e
32      @classmethod
33      def setup_class(self):
34          self.cleanup_files = []  # keep a list of files _open()ed by each test case
35      @classmethod
36      def teardown_class(self):
37          for f in self.cleanup_files:
38              f.close()
39      def _open(self, image_file):
40          f = open(os.path.join(TEST_DIR, &quot;secure_images&quot;, image_file), &quot;rb&quot;)
41          self.cleanup_files.append(f)
42          return f
43  class TestESP32SecureBootloader(EspSecureTestCase):
44      def test_digest_bootloader(self):
45          DBArgs = namedtuple(
46              &quot;digest_bootloader_args&quot;, [&quot;keyfile&quot;, &quot;output&quot;, &quot;iv&quot;, &quot;image&quot;]
47          )
48          try:
49              output_file = tempfile.NamedTemporaryFile(delete=False)
50              output_file.close()
51              args = DBArgs(
52                  self._open(&quot;256bit_key.bin&quot;),
53                  output_file.name,
54                  self._open(&quot;256bit_iv.bin&quot;),
55                  self._open(&quot;bootloader.bin&quot;),
56              )
57              espsecure.digest_secure_bootloader(args)
58              with open(output_file.name, &quot;rb&quot;) as of:
59                  with self._open(&quot;bootloader_digested.bin&quot;) as ef:
60                      assert ef.read() == of.read()
61          finally:
62              os.unlink(output_file.name)
63      def test_digest_rsa_public_key(self):
64          DigestRSAArgs = namedtuple(&quot;digest_rsa_public_key_args&quot;, [&quot;keyfile&quot;, &quot;output&quot;])
65          try:
66              output_file = tempfile.NamedTemporaryFile(delete=False)
67              output_file.close()
68              args = DigestRSAArgs(
69                  self._open(&quot;rsa_secure_boot_signing_key.pem&quot;), output_file.name
70              )
71              espsecure.digest_rsa_public_key(args)
72              with open(output_file.name, &quot;rb&quot;) as of:
73                  with self._open(&quot;rsa_public_key_digest.bin&quot;) as ef:
74                      assert ef.read() == of.read()
75          finally:
76              os.unlink(output_file.name)
77  class TestSigning(EspSecureTestCase):
78      VerifyArgs = namedtuple(
79          &quot;verify_signature_args&quot;, [&quot;version&quot;, &quot;hsm&quot;, &quot;hsm_config&quot;, &quot;keyfile&quot;, &quot;datafile&quot;]
80      )
81      SignArgs = namedtuple(
82          &quot;sign_data_args&quot;,
83          [
84              &quot;version&quot;,
85              &quot;keyfile&quot;,
86              &quot;output&quot;,
87              &quot;append_signatures&quot;,
88              &quot;hsm&quot;,
89              &quot;hsm_config&quot;,
90              &quot;pub_key&quot;,
91              &quot;signature&quot;,
92              &quot;datafile&quot;,
93          ],
94      )
95      ExtractKeyArgs = namedtuple(
96          &quot;extract_public_key_args&quot;, [&quot;version&quot;, &quot;keyfile&quot;, &quot;public_keyfile&quot;]
97      )
98      GenerateKeyArgs = namedtuple(&quot;generate_key_args&quot;, [&quot;version&quot;, &quot;scheme&quot;, &quot;keyfile&quot;])
99      def test_key_generation_v1(self):
100          with tempfile.TemporaryDirectory() as keydir:
101              keyfile_name = os.path.join(keydir, &quot;key.pem&quot;)
102              self.run_espsecure(f&quot;generate_signing_key --version 1 {keyfile_name}&quot;)
103      def test_key_generation_v2(self):
104          with tempfile.TemporaryDirectory() as keydir:
105              keyfile_name = os.path.join(keydir, &quot;key.pem&quot;)
106              self.run_espsecure(f&quot;generate_signing_key --version 2 {keyfile_name}&quot;)
107      def _test_sign_v1_data(self, key_name):
108          try:
109              output_file = tempfile.NamedTemporaryFile(delete=False)
110              output_file.close()
111              args = self.SignArgs(
112                  &quot;1&quot;,
113                  [self._open(key_name)],
114                  output_file.name,
115                  False,
116                  False,
117                  None,
118                  None,
119                  None,
120                  self._open(&quot;bootloader.bin&quot;),
121              )
122              espsecure.sign_data(args)
123              with open(output_file.name, &quot;rb&quot;) as of:
124                  with self._open(&quot;bootloader_signed.bin&quot;) as ef:
125                      assert ef.read() == of.read()
126          finally:
127              os.unlink(output_file.name)
128      def test_sign_v1_data(self):
129          self._test_sign_v1_data(&quot;ecdsa_secure_boot_signing_key.pem&quot;)
130      def test_sign_v1_data_pkcs8(self):
131          self._test_sign_v1_data(&quot;ecdsa_secure_boot_signing_key_pkcs8.pem&quot;)
132      def test_sign_v1_with_pre_calculated_signature(self):
133          signing_pubkey = &quot;ecdsa_secure_boot_signing_pubkey.pem&quot;
134          pre_calculated_signature = &quot;pre_calculated_bootloader_signature.bin&quot;
135          try:
136              output_file = tempfile.NamedTemporaryFile(delete=False)
137              args = self.SignArgs(
138                  &quot;1&quot;,
139                  None,
140                  output_file.name,
141                  False,
142                  False,
143                  None,
144                  [self._open(signing_pubkey)],
145                  [self._open(pre_calculated_signature)],
146                  self._open(&quot;bootloader.bin&quot;),
147              )
148              espsecure.sign_data(args)
149              args = self.VerifyArgs(
150                  &quot;1&quot;, False, None, self._open(signing_pubkey), output_file
151              )
152              espsecure.verify_signature(args)
153          finally:
154              output_file.close()
155              os.unlink(output_file.name)
156      def test_sign_v2_data(self):
157          signing_keys = [
158              &quot;rsa_secure_boot_signing_key.pem&quot;,
159              &quot;ecdsa192_secure_boot_signing_key.pem&quot;,
160              &quot;ecdsa_secure_boot_signing_key.pem&quot;,
161          ]
162          for key in signing_keys:
163              try:
164                  output_file = tempfile.NamedTemporaryFile(delete=False)
165                  args = self.SignArgs(
166                      &quot;2&quot;,
167                      [self._open(key)],
168                      output_file.name,
169                      False,
170                      False,
171                      None,
172                      None,
173                      None,
174                      self._open(&quot;bootloader_unsigned_v2.bin&quot;),
175                  )
176                  espsecure.sign_data(args)
177                  args = self.VerifyArgs(&quot;2&quot;, False, None, self._open(key), output_file)
178                  espsecure.verify_signature(args)
179              finally:
180                  output_file.close()
181                  os.unlink(output_file.name)
182      def test_sign_v2_multiple_keys(self):
183          try:
184              output_file = tempfile.NamedTemporaryFile(delete=False)
185              args = self.SignArgs(
186                  &quot;2&quot;,
187                  [
188                      self._open(&quot;rsa_secure_boot_signing_key.pem&quot;),
189                      self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;),
190                      self._open(&quot;rsa_secure_boot_signing_key3.pem&quot;),
191                  ],
192                  output_file.name,
193                  False,
194                  False,
195                  None,
196                  None,
197                  None,
198                  self._open(&quot;bootloader_unsigned_v2.bin&quot;),
199              )
200              espsecure.sign_data(args)
201              args = self.VerifyArgs(
202                  &quot;2&quot;,
203                  False,
204                  None,
205                  self._open(&quot;rsa_secure_boot_signing_key3.pem&quot;),
206                  output_file,
207              )
208              espsecure.verify_signature(args)
209              output_file.seek(0)
210              args = self.VerifyArgs(
211                  &quot;2&quot;,
212                  False,
213                  None,
214                  self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;),
215                  output_file,
216              )
217              espsecure.verify_signature(args)
218              output_file.seek(0)
219              args = self.VerifyArgs(
220                  &quot;2&quot;,
221                  False,
222                  None,
223                  self._open(&quot;rsa_secure_boot_signing_key.pem&quot;),
224                  output_file,
225              )
226              espsecure.verify_signature(args)
227          finally:
228              output_file.close()
229              os.unlink(output_file.name)
230      def test_sign_v2_append_signatures(self):
231          try:
232              output_file = tempfile.NamedTemporaryFile(delete=False)
233              args = self.SignArgs(
234                  &quot;2&quot;,
235                  [
236                      self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;),
237                      self._open(&quot;rsa_secure_boot_signing_key3.pem&quot;),
238                  ],
239                  output_file.name,
240                  True,
241                  False,
242                  None,
243                  None,
244                  None,
245                  self._open(&quot;bootloader_signed_v2.bin&quot;),
246              )
247              espsecure.sign_data(args)
248              args = self.VerifyArgs(
249                  &quot;2&quot;,
250                  False,
251                  None,
252                  self._open(&quot;rsa_secure_boot_signing_key.pem&quot;),
253                  output_file,
254              )
255              espsecure.verify_signature(args)
256              output_file.seek(0)
257              args = self.VerifyArgs(
258                  &quot;2&quot;,
259                  False,
260                  None,
261                  self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;),
262                  output_file,
263              )
264              espsecure.verify_signature(args)
265              output_file.seek(0)
266              args = self.VerifyArgs(
267                  &quot;2&quot;,
268                  False,
269                  None,
270                  self._open(&quot;rsa_secure_boot_signing_key3.pem&quot;),
271                  output_file,
272              )
273              espsecure.verify_signature(args)
274          finally:
275              output_file.close()
276              os.unlink(output_file.name)
277      def test_sign_v2_append_signatures_multiple_steps(self):
278          try:
279              output_file1 = tempfile.NamedTemporaryFile(delete=False)
280              output_file2 = tempfile.NamedTemporaryFile(delete=False)
281              args = self.SignArgs(
282                  &quot;2&quot;,
283                  [self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;)],
284                  output_file1.name,
285                  True,
286                  False,
287                  None,
288                  None,
289                  None,
290                  self._open(&quot;bootloader_signed_v2.bin&quot;),
291              )
292              espsecure.sign_data(args)
293              args = self.SignArgs(
294                  &quot;2&quot;,
295                  [self._open(&quot;rsa_secure_boot_signing_key3.pem&quot;)],
296                  output_file2.name,
297                  True,
298                  False,
299                  None,
300                  None,
301                  None,
302                  output_file1,
303              )
304              espsecure.sign_data(args)
305              args = self.VerifyArgs(
306                  &quot;2&quot;,
307                  False,
308                  None,
309                  self._open(&quot;rsa_secure_boot_signing_key.pem&quot;),
310                  output_file2,
311              )
312              espsecure.verify_signature(args)
313              output_file2.seek(0)
314              args = self.VerifyArgs(
315                  &quot;2&quot;,
316                  False,
317                  None,
318                  self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;),
319                  output_file2,
320              )
321              espsecure.verify_signature(args)
322              output_file2.seek(0)
323              args = self.VerifyArgs(
324                  &quot;2&quot;,
325                  False,
326                  None,
327                  self._open(&quot;rsa_secure_boot_signing_key3.pem&quot;),
328                  output_file2,
329              )
330              espsecure.verify_signature(args)
331          finally:
332              output_file1.close()
333              os.unlink(output_file1.name)
334              output_file2.close()
335              os.unlink(output_file2.name)
336      def test_sign_v2_with_pre_calculated_signature(self):
<span onclick='openModal()' class='match'>337          signing_keys = [
338              &quot;rsa_secure_boot_signing_pubkey.pem&quot;,
339              &quot;ecdsa192_secure_boot_signing_pubkey.pem&quot;,
340              &quot;ecdsa_secure_boot_signing_pubkey.pem&quot;,
341          ]
342          pre_calculated_signatures = [
343              &quot;pre_calculated_bootloader_signature_rsa.bin&quot;,
344              &quot;pre_calculated_bootloader_signature_ecdsa192.bin&quot;,
345              &quot;pre_calculated_bootloader_signature_ecdsa256.bin&quot;,
346          ]
347          for pub_key, signature in zip(signing_keys, pre_calculated_signatures):
</span>348              try:
349                  output_file = tempfile.NamedTemporaryFile(delete=False)
350                  args = self.SignArgs(
351                      &quot;2&quot;,
352                      None,
353                      output_file.name,
354                      False,
355                      False,
356                      None,
357                      [self._open(pub_key)],
358                      [self._open(signature)],
359                      self._open(&quot;bootloader_unsigned_v2.bin&quot;),
360                  )
361                  espsecure.sign_data(args)
362                  args = self.VerifyArgs(
363                      &quot;2&quot;, False, None, self._open(pub_key), output_file
364                  )
365                  espsecure.verify_signature(args)
366              finally:
367                  output_file.close()
368                  os.unlink(output_file.name)
369      def test_sign_v2_with_multiple_pre_calculated_signatures(self):
370          signing_pubkeys = [
371              &quot;rsa_secure_boot_signing_pubkey.pem&quot;,
372              &quot;rsa_secure_boot_signing_pubkey.pem&quot;,
373              &quot;rsa_secure_boot_signing_pubkey.pem&quot;,
374          ]
375          pre_calculated_signatures = [
376              &quot;pre_calculated_bootloader_signature_rsa.bin&quot;,
377              &quot;pre_calculated_bootloader_signature_rsa.bin&quot;,
378              &quot;pre_calculated_bootloader_signature_rsa.bin&quot;,
379          ]
380          try:
381              output_file = tempfile.NamedTemporaryFile(delete=False)
382              args = self.SignArgs(
383                  &quot;2&quot;,
384                  None,
385                  output_file.name,
386                  False,
387                  False,
388                  None,
389                  [self._open(pub_key) for pub_key in signing_pubkeys],
390                  [self._open(signature) for signature in pre_calculated_signatures],
391                  self._open(&quot;bootloader_unsigned_v2.bin&quot;),
392              )
393              espsecure.sign_data(args)
394              args = self.VerifyArgs(
395                  &quot;2&quot;, False, None, self._open(signing_pubkeys[0]), output_file
396              )
397              espsecure.verify_signature(args)
398          finally:
399              output_file.close()
400              os.unlink(output_file.name)
401      def test_verify_signature_signing_key(self):
402          args = self.VerifyArgs(
403              &quot;1&quot;,
404              False,
405              None,
406              self._open(&quot;ecdsa_secure_boot_signing_key.pem&quot;),
407              self._open(&quot;bootloader_signed.bin&quot;),
408          )
409          espsecure.verify_signature(args)
410          args = self.VerifyArgs(
411              &quot;2&quot;,
412              False,
413              None,
414              self._open(&quot;rsa_secure_boot_signing_key.pem&quot;),
415              self._open(&quot;bootloader_signed_v2.bin&quot;),
416          )
417          espsecure.verify_signature(args)
418          args = self.VerifyArgs(
419              &quot;2&quot;,
420              False,
421              None,
422              self._open(&quot;ecdsa_secure_boot_signing_key.pem&quot;),
423              self._open(&quot;bootloader_signed_v2_ecdsa256.bin&quot;),
424          )
425          espsecure.verify_signature(args)
426          args = self.VerifyArgs(
427              &quot;2&quot;,
428              False,
429              None,
430              self._open(&quot;ecdsa192_secure_boot_signing_key.pem&quot;),
431              self._open(&quot;bootloader_signed_v2_ecdsa192.bin&quot;),
432          )
433          espsecure.verify_signature(args)
434          args = self.VerifyArgs(
435              &quot;1&quot;,
436              False,
437              None,
438              self._open(&quot;ecdsa_secure_boot_signing_key2.pem&quot;),
439              self._open(&quot;bootloader_signed.bin&quot;),
440          )
441          with pytest.raises(esptool.FatalError) as cm:
442              espsecure.verify_signature(args)
443          assert &quot;Signature is not valid&quot; in str(cm.value)
444          args = self.VerifyArgs(
445              &quot;2&quot;,
446              False,
447              None,
448              self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;),
449              self._open(&quot;bootloader_signed_v2.bin&quot;),
450          )
451          with pytest.raises(esptool.FatalError) as cm:
452              espsecure.verify_signature(args)
453          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
454          args = self.VerifyArgs(
455              &quot;2&quot;,
456              False,
457              None,
458              self._open(&quot;ecdsa_secure_boot_signing_key.pem&quot;),
459              self._open(&quot;bootloader_signed.bin&quot;),
460          )
461          with pytest.raises(esptool.FatalError) as cm:
462              espsecure.verify_signature(args)
463          assert &quot;Invalid datafile&quot; in str(cm.value)
464          args = self.VerifyArgs(
465              &quot;2&quot;,
466              False,
467              None,
468              self._open(&quot;ecdsa_secure_boot_signing_key2.pem&quot;),
469              self._open(&quot;bootloader_signed_v2_ecdsa256.bin&quot;),
470          )
471          with pytest.raises(esptool.FatalError) as cm:
472              espsecure.verify_signature(args)
473          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
474          args = self.VerifyArgs(
475              &quot;2&quot;,
476              False,
477              None,
478              self._open(&quot;ecdsa192_secure_boot_signing_key2.pem&quot;),
479              self._open(&quot;bootloader_signed_v2_ecdsa192.bin&quot;),
480          )
481          with pytest.raises(esptool.FatalError) as cm:
482              espsecure.verify_signature(args)
483          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
484          args = self.VerifyArgs(
485              &quot;2&quot;,
486              False,
487              None,
488              self._open(&quot;rsa_secure_boot_signing_key4.pem&quot;),
489              self._open(&quot;bootloader_multi_signed_v2.bin&quot;),
490          )
491          with pytest.raises(esptool.FatalError) as cm:
492              espsecure.verify_signature(args)
493          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
494      def test_verify_signature_public_key(self):
495          args = self.VerifyArgs(
496              &quot;1&quot;,
497              False,
498              None,
499              self._open(&quot;ecdsa_secure_boot_signing_pubkey.pem&quot;),
500              self._open(&quot;bootloader_signed.bin&quot;),
501          )
502          espsecure.verify_signature(args)
503          args = self.VerifyArgs(
504              &quot;2&quot;,
505              False,
506              None,
507              self._open(&quot;rsa_secure_boot_signing_pubkey.pem&quot;),
508              self._open(&quot;bootloader_signed_v2.bin&quot;),
509          )
510          espsecure.verify_signature(args)
511          args = self.VerifyArgs(
512              &quot;2&quot;,
513              False,
514              None,
515              self._open(&quot;ecdsa_secure_boot_signing_pubkey.pem&quot;),
516              self._open(&quot;bootloader_signed_v2_ecdsa256.bin&quot;),
517          )
518          espsecure.verify_signature(args)
519          args = self.VerifyArgs(
520              &quot;2&quot;,
521              False,
522              None,
523              self._open(&quot;ecdsa192_secure_boot_signing_pubkey.pem&quot;),
524              self._open(&quot;bootloader_signed_v2_ecdsa192.bin&quot;),
525          )
526          espsecure.verify_signature(args)
527          args = self.VerifyArgs(
528              &quot;1&quot;,
529              False,
530              None,
531              self._open(&quot;ecdsa_secure_boot_signing_pubkey2.pem&quot;),
532              self._open(&quot;bootloader_signed.bin&quot;),
533          )
534          with pytest.raises(esptool.FatalError) as cm:
535              espsecure.verify_signature(args)
536          assert &quot;Signature is not valid&quot; in str(cm.value)
537          args = self.VerifyArgs(
538              &quot;2&quot;,
539              False,
540              None,
541              self._open(&quot;rsa_secure_boot_signing_pubkey2.pem&quot;),
542              self._open(&quot;bootloader_signed_v2.bin&quot;),
543          )
544          with pytest.raises(esptool.FatalError) as cm:
545              espsecure.verify_signature(args)
546          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
547          args = self.VerifyArgs(
548              &quot;2&quot;,
549              False,
550              None,
551              self._open(&quot;ecdsa_secure_boot_signing_pubkey2.pem&quot;),
552              self._open(&quot;bootloader_signed_v2_ecdsa256.bin&quot;),
553          )
554          with pytest.raises(esptool.FatalError) as cm:
555              espsecure.verify_signature(args)
556          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
557          args = self.VerifyArgs(
558              &quot;2&quot;,
559              False,
560              None,
561              self._open(&quot;ecdsa192_secure_boot_signing_pubkey2.pem&quot;),
562              self._open(&quot;bootloader_signed_v2_ecdsa192.bin&quot;),
563          )
564          with pytest.raises(esptool.FatalError) as cm:
565              espsecure.verify_signature(args)
566          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
567          args = self.VerifyArgs(
568              &quot;2&quot;,
569              False,
570              None,
571              self._open(&quot;rsa_secure_boot_signing_pubkey4.pem&quot;),
572              self._open(&quot;bootloader_multi_signed_v2.bin&quot;),
573          )
574          with pytest.raises(esptool.FatalError) as cm:
575              espsecure.verify_signature(args)
576          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
577      def test_extract_binary_public_key(self):
578          with tempfile.NamedTemporaryFile() as pub_keyfile, tempfile.NamedTemporaryFile() as pub_keyfile2:  # noqa E501
579              args = self.ExtractKeyArgs(
580                  &quot;1&quot;, self._open(&quot;ecdsa_secure_boot_signing_key.pem&quot;), pub_keyfile
581              )
582              espsecure.extract_public_key(args)
583              args = self.ExtractKeyArgs(
584                  &quot;1&quot;, self._open(&quot;ecdsa_secure_boot_signing_key2.pem&quot;), pub_keyfile2
585              )
586              espsecure.extract_public_key(args)
587              pub_keyfile.seek(0)
588              pub_keyfile2.seek(0)
589              args = self.VerifyArgs(
590                  &quot;1&quot;, False, None, pub_keyfile, self._open(&quot;bootloader_signed.bin&quot;)
591              )
592              espsecure.verify_signature(args)
593              args = self.VerifyArgs(
594                  &quot;1&quot;, False, None, pub_keyfile2, self._open(&quot;bootloader_signed.bin&quot;)
595              )
596              with pytest.raises(esptool.FatalError) as cm:
597                  espsecure.verify_signature(args)
598              assert &quot;Signature is not valid&quot; in str(cm.value)
599      def test_generate_and_extract_key_v2(self):
600          with tempfile.TemporaryDirectory() as keydir:
601              keyfile_name = os.path.join(keydir, &quot;key.pem&quot;)
602              for scheme in [&quot;rsa3072&quot;, &quot;ecdsa192&quot;, &quot;ecdsa256&quot;]:
603                  args = self.GenerateKeyArgs(&quot;2&quot;, scheme, keyfile_name)
604                  espsecure.generate_signing_key(args)
605                  with tempfile.NamedTemporaryFile() as pub_keyfile, open(
606                      keyfile_name, &quot;rb&quot;
607                  ) as keyfile:
608                      args = self.ExtractKeyArgs(&quot;2&quot;, keyfile, pub_keyfile)
609                      espsecure.extract_public_key(args)
610                  os.remove(keyfile_name)
611  class TestFlashEncryption(EspSecureTestCase):
612      EncryptArgs = namedtuple(
613          &quot;encrypt_flash_data_args&quot;,
614          [
615              &quot;keyfile&quot;,
616              &quot;output&quot;,
617              &quot;address&quot;,
618              &quot;flash_crypt_conf&quot;,
619              &quot;aes_xts&quot;,
620              &quot;plaintext_file&quot;,
621          ],
622      )
623      DecryptArgs = namedtuple(
624          &quot;decrypt_flash_data_args&quot;,
625          [
626              &quot;keyfile&quot;,
627              &quot;output&quot;,
628              &quot;address&quot;,
629              &quot;flash_crypt_conf&quot;,
630              &quot;aes_xts&quot;,
631              &quot;encrypted_file&quot;,
632          ],
633      )
634      def _test_encrypt_decrypt(
635          self,
636          input_plaintext,
637          expected_ciphertext,
638          key_path,
639          offset,
640          flash_crypt_conf=0xF,
641          aes_xts=None,
642      ):
643          original_plaintext = self._open(input_plaintext)
644          keyfile = self._open(key_path)
645          ciphertext = io.BytesIO()
646          args = self.EncryptArgs(
647              keyfile, ciphertext, offset, flash_crypt_conf, aes_xts, original_plaintext
648          )
649          espsecure.encrypt_flash_data(args)
650          original_plaintext.seek(0)
651          assert original_plaintext.read() != ciphertext.getvalue()
652          with self._open(expected_ciphertext) as f:
653              assert f.read() == ciphertext.getvalue()
654          ciphertext.seek(0)
655          keyfile.seek(0)
656          plaintext = io.BytesIO()
657          args = self.DecryptArgs(
658              keyfile, plaintext, offset, flash_crypt_conf, aes_xts, ciphertext
659          )
660          espsecure.decrypt_flash_data(args)
661          original_plaintext.seek(0)
662          assert original_plaintext.read() == plaintext.getvalue()
663  class TestESP32FlashEncryption(TestFlashEncryption):
664      def test_encrypt_decrypt_bootloader(self):
665          self._test_encrypt_decrypt(
666              &quot;bootloader.bin&quot;, &quot;bootloader-encrypted.bin&quot;, &quot;256bit_key.bin&quot;, 0x1000, 0xF
667          )
668      def test_encrypt_decrypt_app(self):
669          self._test_encrypt_decrypt(
670              &quot;hello-world-signed.bin&quot;,
671              &quot;hello-world-signed-encrypted.bin&quot;,
672              &quot;ef-flashencryption-key.bin&quot;,
673              0x20000,
674              0xF,
675          )
676      def test_encrypt_decrypt_non_default_conf(self):
677          for conf in [0x0, 0x3, 0x9, 0xC]:
678              self._test_encrypt_decrypt(
679                  &quot;bootloader.bin&quot;,
680                  f&quot;bootloader-encrypted-conf{conf:x}.bin&quot;,
681                  &quot;256bit_key.bin&quot;,
682                  0x1000,
683                  conf,
684              )
685  class TestAesXtsFlashEncryption(TestFlashEncryption):
686      def test_encrypt_decrypt_bootloader(self):
687          self._test_encrypt_decrypt(
688              &quot;bootloader.bin&quot;,
689              &quot;bootloader-encrypted-aes-xts.bin&quot;,
690              &quot;256bit_key.bin&quot;,
691              0x1000,
692              aes_xts=True,
693          )
694      def test_encrypt_decrypt_app(self):
695          self._test_encrypt_decrypt(
696              &quot;hello-world-signed.bin&quot;,
697              &quot;hello-world-signed-encrypted-aes-xts.bin&quot;,
698              &quot;ef-flashencryption-key.bin&quot;,
699              0x20000,
700              aes_xts=True,
701          )
702      def test_encrypt_decrypt_app_512_bit_key(self):
703          self._test_encrypt_decrypt(
704              &quot;hello-world-signed.bin&quot;,
705              &quot;hello-world-signed-encrypted-aes-xts-256.bin&quot;,
706              &quot;512bit_key.bin&quot;,
707              0x10000,
708              aes_xts=True,
709          )
710      def test_padding(self):
711          plaintext = binascii.unhexlify(
712              &quot;c33b7c49f12a969a9bb45af5f660b73f&quot;
713              &quot;3b372685012da570df1cf99d1a82eabb&quot;
714              &quot;fdf6aa16b9675bd8a2f95e871513e175&quot;
715              &quot;3bc89f57986ecfb2707a3d3b59a46968&quot;
716              &quot;5e6609d2e9c21d4b2310571175e6e3de&quot;
717              &quot;2656ee22243f557b925ef39ff782ab56&quot;
718              &quot;f821e6859ee852000daae7c03a7c77ce&quot;
719              &quot;58744f15fbdf0ad4ae6e964aedd6316a&quot;
720              &quot;cf0e36935eef895cd14a60fe682fb971&quot;
721              &quot;eb239eae38b770bdf969017c9decfd91&quot;
722              &quot;b7c60329fb0c896684f0e7415f99dec1&quot;
723              &quot;da0572fac360a3e6d7219973a7de07e5&quot;
724              &quot;33b5abfdf5917ed5bfe54d660a6f5047&quot;
725              &quot;32fdb8d07259bfcdc67da87293857c11&quot;
726              &quot;427b2bae5f00da4a4b2b00b588ff5109&quot;
727              &quot;4c41f07f02f680f8826841b43da3f25b&quot;
728          )
729          plaintext_file = io.BytesIO(plaintext)
730          ciphertext_full_block = io.BytesIO()
731          keyfile = self._open(&quot;256bit_key.bin&quot;)
732          address = 0x1000
733          encrypt_args_padded = self.EncryptArgs(
734              keyfile, ciphertext_full_block, address, None, &quot;aes_xts&quot;, plaintext_file
735          )
736          espsecure.encrypt_flash_data(encrypt_args_padded)
737          bytes_per_encrypt = [16, 32, 64, 128]
738          for b in bytes_per_encrypt:
739              ciphertext = io.BytesIO()
740              num_enc_calls = len(plaintext) // b
741              for i in range(0, num_enc_calls):
742                  keyfile.seek(0)
743                  offset = b * i
744                  plaintext_sub = io.BytesIO(plaintext[offset : offset + b])
745                  encrypt_args = self.EncryptArgs(
746                      keyfile,
747                      ciphertext,
748                      address + offset,
749                      None,
750                      &quot;aes_xts&quot;,
751                      plaintext_sub,
752                  )
753                  espsecure.encrypt_flash_data(encrypt_args)
754              assert ciphertext_full_block.getvalue() == ciphertext.getvalue()
755  class TestDigest(EspSecureTestCase):
756      def test_digest_private_key(self):
757          with tempfile.NamedTemporaryFile() as f:
758              outfile_name = f.name
759          self.run_espsecure(
760              &quot;digest_private_key &quot;
761              &quot;--keyfile secure_images/ecdsa_secure_boot_signing_key.pem &quot;
762              f&quot;{outfile_name}&quot;
763          )
764          with open(outfile_name, &quot;rb&quot;) as f:
765              assert f.read() == binascii.unhexlify(
766                  &quot;7b7b53708fc89d5e0b2df2571fb8f9d778f61a422ff1101a22159c4b34aad0aa&quot;
767              )
768      def test_digest_private_key_with_invalid_output(self, capsys):
769          fname = &quot;secure_images/ecdsa_secure_boot_signing_key.pem&quot;
770          with pytest.raises(subprocess.CalledProcessError):
771              self.run_espsecure(f&quot;digest_private_key --keyfile {fname} {fname}&quot;)
772          output = capsys.readouterr().out
773          assert &quot;should not be the same!&quot; in output
</code></pre>
        </div>
        <div class="column">
            <h3>esptool-MDEwOlJlcG9zaXRvcnkyMzczNjkxNA==-flat-test_espsecure.py</h3>
            <pre><code>1  import binascii
2  import io
3  import os
4  import os.path
5  import subprocess
6  import sys
7  import tempfile
8  from collections import namedtuple
9  from conftest import need_to_install_package_err
10  import pytest
11  try:
12      import esptool
13      import espsecure
14  except ImportError:
15      need_to_install_package_err()
16  TEST_DIR = os.path.abspath(os.path.dirname(__file__))
17  @pytest.mark.host_test
18  class EspSecureTestCase:
19      def run_espsecure(self, args):
20          cmd = [sys.executable, &quot;-m&quot;, &quot;espsecure&quot;] + args.split(&quot; &quot;)
21          print(&quot;\nExecuting {}...&quot;.format(&quot; &quot;.join(cmd)))
22          try:
23              output = subprocess.check_output(
24                  [str(s) for s in cmd], cwd=TEST_DIR, stderr=subprocess.STDOUT
25              )
26              output = output.decode(&quot;utf-8&quot;)
27              print(output)
28              return output
29          except subprocess.CalledProcessError as e:
30              print(e.output.decode(&quot;utf-8&quot;))
31              raise e
32      @classmethod
33      def setup_class(self):
34          self.cleanup_files = []  # keep a list of files _open()ed by each test case
35      @classmethod
36      def teardown_class(self):
37          for f in self.cleanup_files:
38              f.close()
39      def _open(self, image_file):
40          f = open(os.path.join(TEST_DIR, &quot;secure_images&quot;, image_file), &quot;rb&quot;)
41          self.cleanup_files.append(f)
42          return f
43  class TestESP32SecureBootloader(EspSecureTestCase):
44      def test_digest_bootloader(self):
45          DBArgs = namedtuple(
46              &quot;digest_bootloader_args&quot;, [&quot;keyfile&quot;, &quot;output&quot;, &quot;iv&quot;, &quot;image&quot;]
47          )
48          try:
49              output_file = tempfile.NamedTemporaryFile(delete=False)
50              output_file.close()
51              args = DBArgs(
52                  self._open(&quot;256bit_key.bin&quot;),
53                  output_file.name,
54                  self._open(&quot;256bit_iv.bin&quot;),
55                  self._open(&quot;bootloader.bin&quot;),
56              )
57              espsecure.digest_secure_bootloader(args)
58              with open(output_file.name, &quot;rb&quot;) as of:
59                  with self._open(&quot;bootloader_digested.bin&quot;) as ef:
60                      assert ef.read() == of.read()
61          finally:
62              os.unlink(output_file.name)
63      def test_digest_rsa_public_key(self):
64          DigestRSAArgs = namedtuple(&quot;digest_rsa_public_key_args&quot;, [&quot;keyfile&quot;, &quot;output&quot;])
65          try:
66              output_file = tempfile.NamedTemporaryFile(delete=False)
67              output_file.close()
68              args = DigestRSAArgs(
69                  self._open(&quot;rsa_secure_boot_signing_key.pem&quot;), output_file.name
70              )
71              espsecure.digest_rsa_public_key(args)
72              with open(output_file.name, &quot;rb&quot;) as of:
73                  with self._open(&quot;rsa_public_key_digest.bin&quot;) as ef:
74                      assert ef.read() == of.read()
75          finally:
76              os.unlink(output_file.name)
77  class TestSigning(EspSecureTestCase):
78      VerifyArgs = namedtuple(
79          &quot;verify_signature_args&quot;, [&quot;version&quot;, &quot;hsm&quot;, &quot;hsm_config&quot;, &quot;keyfile&quot;, &quot;datafile&quot;]
80      )
81      SignArgs = namedtuple(
82          &quot;sign_data_args&quot;,
83          [
84              &quot;version&quot;,
85              &quot;keyfile&quot;,
86              &quot;output&quot;,
87              &quot;append_signatures&quot;,
88              &quot;hsm&quot;,
89              &quot;hsm_config&quot;,
90              &quot;pub_key&quot;,
91              &quot;signature&quot;,
92              &quot;datafile&quot;,
93          ],
94      )
95      ExtractKeyArgs = namedtuple(
96          &quot;extract_public_key_args&quot;, [&quot;version&quot;, &quot;keyfile&quot;, &quot;public_keyfile&quot;]
97      )
98      GenerateKeyArgs = namedtuple(&quot;generate_key_args&quot;, [&quot;version&quot;, &quot;scheme&quot;, &quot;keyfile&quot;])
99      def test_key_generation_v1(self):
100          with tempfile.TemporaryDirectory() as keydir:
101              keyfile_name = os.path.join(keydir, &quot;key.pem&quot;)
102              self.run_espsecure(f&quot;generate_signing_key --version 1 {keyfile_name}&quot;)
103      def test_key_generation_v2(self):
104          with tempfile.TemporaryDirectory() as keydir:
105              keyfile_name = os.path.join(keydir, &quot;key.pem&quot;)
106              self.run_espsecure(f&quot;generate_signing_key --version 2 {keyfile_name}&quot;)
107      def _test_sign_v1_data(self, key_name):
108          try:
109              output_file = tempfile.NamedTemporaryFile(delete=False)
110              output_file.close()
111              args = self.SignArgs(
112                  &quot;1&quot;,
113                  [self._open(key_name)],
114                  output_file.name,
115                  False,
116                  False,
117                  None,
118                  None,
119                  None,
120                  self._open(&quot;bootloader.bin&quot;),
121              )
122              espsecure.sign_data(args)
123              with open(output_file.name, &quot;rb&quot;) as of:
124                  with self._open(&quot;bootloader_signed.bin&quot;) as ef:
125                      assert ef.read() == of.read()
126          finally:
127              os.unlink(output_file.name)
128      def test_sign_v1_data(self):
129          self._test_sign_v1_data(&quot;ecdsa_secure_boot_signing_key.pem&quot;)
130      def test_sign_v1_data_pkcs8(self):
131          self._test_sign_v1_data(&quot;ecdsa_secure_boot_signing_key_pkcs8.pem&quot;)
132      def test_sign_v1_with_pre_calculated_signature(self):
133          signing_pubkey = &quot;ecdsa_secure_boot_signing_pubkey.pem&quot;
134          pre_calculated_signature = &quot;pre_calculated_bootloader_signature.bin&quot;
135          try:
136              output_file = tempfile.NamedTemporaryFile(delete=False)
137              args = self.SignArgs(
138                  &quot;1&quot;,
139                  None,
140                  output_file.name,
141                  False,
142                  False,
143                  None,
144                  [self._open(signing_pubkey)],
145                  [self._open(pre_calculated_signature)],
146                  self._open(&quot;bootloader.bin&quot;),
147              )
148              espsecure.sign_data(args)
149              args = self.VerifyArgs(
150                  &quot;1&quot;, False, None, self._open(signing_pubkey), output_file
151              )
152              espsecure.verify_signature(args)
153          finally:
154              output_file.close()
155              os.unlink(output_file.name)
156      def test_sign_v2_data(self):
157          signing_keys = [
158              &quot;rsa_secure_boot_signing_key.pem&quot;,
159              &quot;ecdsa192_secure_boot_signing_key.pem&quot;,
160              &quot;ecdsa_secure_boot_signing_key.pem&quot;,
161          ]
162          for key in signing_keys:
163              try:
164                  output_file = tempfile.NamedTemporaryFile(delete=False)
165                  args = self.SignArgs(
166                      &quot;2&quot;,
167                      [self._open(key)],
168                      output_file.name,
169                      False,
170                      False,
171                      None,
172                      None,
173                      None,
174                      self._open(&quot;bootloader_unsigned_v2.bin&quot;),
175                  )
176                  espsecure.sign_data(args)
177                  args = self.VerifyArgs(&quot;2&quot;, False, None, self._open(key), output_file)
178                  espsecure.verify_signature(args)
179              finally:
180                  output_file.close()
181                  os.unlink(output_file.name)
182      def test_sign_v2_multiple_keys(self):
183          try:
184              output_file = tempfile.NamedTemporaryFile(delete=False)
185              args = self.SignArgs(
186                  &quot;2&quot;,
187                  [
188                      self._open(&quot;rsa_secure_boot_signing_key.pem&quot;),
189                      self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;),
190                      self._open(&quot;rsa_secure_boot_signing_key3.pem&quot;),
191                  ],
192                  output_file.name,
193                  False,
194                  False,
195                  None,
196                  None,
197                  None,
198                  self._open(&quot;bootloader_unsigned_v2.bin&quot;),
199              )
200              espsecure.sign_data(args)
201              args = self.VerifyArgs(
202                  &quot;2&quot;,
203                  False,
204                  None,
205                  self._open(&quot;rsa_secure_boot_signing_key3.pem&quot;),
206                  output_file,
207              )
208              espsecure.verify_signature(args)
209              output_file.seek(0)
210              args = self.VerifyArgs(
211                  &quot;2&quot;,
212                  False,
213                  None,
214                  self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;),
215                  output_file,
216              )
217              espsecure.verify_signature(args)
218              output_file.seek(0)
219              args = self.VerifyArgs(
220                  &quot;2&quot;,
221                  False,
222                  None,
223                  self._open(&quot;rsa_secure_boot_signing_key.pem&quot;),
224                  output_file,
225              )
226              espsecure.verify_signature(args)
227          finally:
228              output_file.close()
229              os.unlink(output_file.name)
230      def test_sign_v2_append_signatures(self):
231          try:
232              output_file = tempfile.NamedTemporaryFile(delete=False)
233              args = self.SignArgs(
234                  &quot;2&quot;,
235                  [
236                      self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;),
237                      self._open(&quot;rsa_secure_boot_signing_key3.pem&quot;),
238                  ],
239                  output_file.name,
240                  True,
241                  False,
242                  None,
243                  None,
244                  None,
245                  self._open(&quot;bootloader_signed_v2.bin&quot;),
246              )
247              espsecure.sign_data(args)
248              args = self.VerifyArgs(
249                  &quot;2&quot;,
250                  False,
251                  None,
252                  self._open(&quot;rsa_secure_boot_signing_key.pem&quot;),
253                  output_file,
254              )
255              espsecure.verify_signature(args)
256              output_file.seek(0)
257              args = self.VerifyArgs(
258                  &quot;2&quot;,
259                  False,
260                  None,
261                  self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;),
262                  output_file,
263              )
264              espsecure.verify_signature(args)
265              output_file.seek(0)
266              args = self.VerifyArgs(
267                  &quot;2&quot;,
268                  False,
269                  None,
270                  self._open(&quot;rsa_secure_boot_signing_key3.pem&quot;),
271                  output_file,
272              )
273              espsecure.verify_signature(args)
274          finally:
275              output_file.close()
276              os.unlink(output_file.name)
277      def test_sign_v2_append_signatures_multiple_steps(self):
278          try:
279              output_file1 = tempfile.NamedTemporaryFile(delete=False)
280              output_file2 = tempfile.NamedTemporaryFile(delete=False)
281              args = self.SignArgs(
282                  &quot;2&quot;,
283                  [self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;)],
284                  output_file1.name,
285                  True,
286                  False,
287                  None,
288                  None,
289                  None,
290                  self._open(&quot;bootloader_signed_v2.bin&quot;),
291              )
292              espsecure.sign_data(args)
293              args = self.SignArgs(
294                  &quot;2&quot;,
295                  [self._open(&quot;rsa_secure_boot_signing_key3.pem&quot;)],
296                  output_file2.name,
297                  True,
298                  False,
299                  None,
300                  None,
301                  None,
302                  output_file1,
303              )
304              espsecure.sign_data(args)
305              args = self.VerifyArgs(
306                  &quot;2&quot;,
307                  False,
308                  None,
309                  self._open(&quot;rsa_secure_boot_signing_key.pem&quot;),
310                  output_file2,
311              )
312              espsecure.verify_signature(args)
313              output_file2.seek(0)
314              args = self.VerifyArgs(
315                  &quot;2&quot;,
316                  False,
317                  None,
318                  self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;),
319                  output_file2,
320              )
321              espsecure.verify_signature(args)
322              output_file2.seek(0)
323              args = self.VerifyArgs(
324                  &quot;2&quot;,
325                  False,
326                  None,
327                  self._open(&quot;rsa_secure_boot_signing_key3.pem&quot;),
328                  output_file2,
329              )
330              espsecure.verify_signature(args)
331          finally:
332              output_file1.close()
333              os.unlink(output_file1.name)
334              output_file2.close()
335              os.unlink(output_file2.name)
336      def test_sign_v2_with_pre_calculated_signature(self):
337          signing_keys = [
338              &quot;rsa_secure_boot_signing_pubkey.pem&quot;,
339              &quot;ecdsa192_secure_boot_signing_pubkey.pem&quot;,
340              &quot;ecdsa_secure_boot_signing_pubkey.pem&quot;,
341          ]
342          pre_calculated_signatures = [
343              &quot;pre_calculated_bootloader_signature_rsa.bin&quot;,
344              &quot;pre_calculated_bootloader_signature_ecdsa192.bin&quot;,
345              &quot;pre_calculated_bootloader_signature_ecdsa256.bin&quot;,
346          ]
347          for pub_key, signature in zip(signing_keys, pre_calculated_signatures):
348              try:
349                  output_file = tempfile.NamedTemporaryFile(delete=False)
350                  args = self.SignArgs(
351                      &quot;2&quot;,
352                      None,
353                      output_file.name,
354                      False,
355                      False,
356                      None,
357                      [self._open(pub_key)],
358                      [self._open(signature)],
359                      self._open(&quot;bootloader_unsigned_v2.bin&quot;),
360                  )
361                  espsecure.sign_data(args)
362                  args = self.VerifyArgs(
363                      &quot;2&quot;, False, None, self._open(pub_key), output_file
364                  )
365                  espsecure.verify_signature(args)
366              finally:
367                  output_file.close()
368                  os.unlink(output_file.name)
369      def test_sign_v2_with_multiple_pre_calculated_signatures(self):
<span onclick='openModal()' class='match'>370          signing_pubkeys = [
371              &quot;rsa_secure_boot_signing_pubkey.pem&quot;,
372              &quot;rsa_secure_boot_signing_pubkey.pem&quot;,
373              &quot;rsa_secure_boot_signing_pubkey.pem&quot;,
374          ]
375          pre_calculated_signatures = [
376              &quot;pre_calculated_bootloader_signature_rsa.bin&quot;,
377              &quot;pre_calculated_bootloader_signature_rsa.bin&quot;,
378              &quot;pre_calculated_bootloader_signature_rsa.bin&quot;,
379          ]
380          try:
</span>381              output_file = tempfile.NamedTemporaryFile(delete=False)
382              args = self.SignArgs(
383                  &quot;2&quot;,
384                  None,
385                  output_file.name,
386                  False,
387                  False,
388                  None,
389                  [self._open(pub_key) for pub_key in signing_pubkeys],
390                  [self._open(signature) for signature in pre_calculated_signatures],
391                  self._open(&quot;bootloader_unsigned_v2.bin&quot;),
392              )
393              espsecure.sign_data(args)
394              args = self.VerifyArgs(
395                  &quot;2&quot;, False, None, self._open(signing_pubkeys[0]), output_file
396              )
397              espsecure.verify_signature(args)
398          finally:
399              output_file.close()
400              os.unlink(output_file.name)
401      def test_verify_signature_signing_key(self):
402          args = self.VerifyArgs(
403              &quot;1&quot;,
404              False,
405              None,
406              self._open(&quot;ecdsa_secure_boot_signing_key.pem&quot;),
407              self._open(&quot;bootloader_signed.bin&quot;),
408          )
409          espsecure.verify_signature(args)
410          args = self.VerifyArgs(
411              &quot;2&quot;,
412              False,
413              None,
414              self._open(&quot;rsa_secure_boot_signing_key.pem&quot;),
415              self._open(&quot;bootloader_signed_v2.bin&quot;),
416          )
417          espsecure.verify_signature(args)
418          args = self.VerifyArgs(
419              &quot;2&quot;,
420              False,
421              None,
422              self._open(&quot;ecdsa_secure_boot_signing_key.pem&quot;),
423              self._open(&quot;bootloader_signed_v2_ecdsa256.bin&quot;),
424          )
425          espsecure.verify_signature(args)
426          args = self.VerifyArgs(
427              &quot;2&quot;,
428              False,
429              None,
430              self._open(&quot;ecdsa192_secure_boot_signing_key.pem&quot;),
431              self._open(&quot;bootloader_signed_v2_ecdsa192.bin&quot;),
432          )
433          espsecure.verify_signature(args)
434          args = self.VerifyArgs(
435              &quot;1&quot;,
436              False,
437              None,
438              self._open(&quot;ecdsa_secure_boot_signing_key2.pem&quot;),
439              self._open(&quot;bootloader_signed.bin&quot;),
440          )
441          with pytest.raises(esptool.FatalError) as cm:
442              espsecure.verify_signature(args)
443          assert &quot;Signature is not valid&quot; in str(cm.value)
444          args = self.VerifyArgs(
445              &quot;2&quot;,
446              False,
447              None,
448              self._open(&quot;rsa_secure_boot_signing_key2.pem&quot;),
449              self._open(&quot;bootloader_signed_v2.bin&quot;),
450          )
451          with pytest.raises(esptool.FatalError) as cm:
452              espsecure.verify_signature(args)
453          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
454          args = self.VerifyArgs(
455              &quot;2&quot;,
456              False,
457              None,
458              self._open(&quot;ecdsa_secure_boot_signing_key.pem&quot;),
459              self._open(&quot;bootloader_signed.bin&quot;),
460          )
461          with pytest.raises(esptool.FatalError) as cm:
462              espsecure.verify_signature(args)
463          assert &quot;Invalid datafile&quot; in str(cm.value)
464          args = self.VerifyArgs(
465              &quot;2&quot;,
466              False,
467              None,
468              self._open(&quot;ecdsa_secure_boot_signing_key2.pem&quot;),
469              self._open(&quot;bootloader_signed_v2_ecdsa256.bin&quot;),
470          )
471          with pytest.raises(esptool.FatalError) as cm:
472              espsecure.verify_signature(args)
473          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
474          args = self.VerifyArgs(
475              &quot;2&quot;,
476              False,
477              None,
478              self._open(&quot;ecdsa192_secure_boot_signing_key2.pem&quot;),
479              self._open(&quot;bootloader_signed_v2_ecdsa192.bin&quot;),
480          )
481          with pytest.raises(esptool.FatalError) as cm:
482              espsecure.verify_signature(args)
483          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
484          args = self.VerifyArgs(
485              &quot;2&quot;,
486              False,
487              None,
488              self._open(&quot;rsa_secure_boot_signing_key4.pem&quot;),
489              self._open(&quot;bootloader_multi_signed_v2.bin&quot;),
490          )
491          with pytest.raises(esptool.FatalError) as cm:
492              espsecure.verify_signature(args)
493          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
494      def test_verify_signature_public_key(self):
495          args = self.VerifyArgs(
496              &quot;1&quot;,
497              False,
498              None,
499              self._open(&quot;ecdsa_secure_boot_signing_pubkey.pem&quot;),
500              self._open(&quot;bootloader_signed.bin&quot;),
501          )
502          espsecure.verify_signature(args)
503          args = self.VerifyArgs(
504              &quot;2&quot;,
505              False,
506              None,
507              self._open(&quot;rsa_secure_boot_signing_pubkey.pem&quot;),
508              self._open(&quot;bootloader_signed_v2.bin&quot;),
509          )
510          espsecure.verify_signature(args)
511          args = self.VerifyArgs(
512              &quot;2&quot;,
513              False,
514              None,
515              self._open(&quot;ecdsa_secure_boot_signing_pubkey.pem&quot;),
516              self._open(&quot;bootloader_signed_v2_ecdsa256.bin&quot;),
517          )
518          espsecure.verify_signature(args)
519          args = self.VerifyArgs(
520              &quot;2&quot;,
521              False,
522              None,
523              self._open(&quot;ecdsa192_secure_boot_signing_pubkey.pem&quot;),
524              self._open(&quot;bootloader_signed_v2_ecdsa192.bin&quot;),
525          )
526          espsecure.verify_signature(args)
527          args = self.VerifyArgs(
528              &quot;1&quot;,
529              False,
530              None,
531              self._open(&quot;ecdsa_secure_boot_signing_pubkey2.pem&quot;),
532              self._open(&quot;bootloader_signed.bin&quot;),
533          )
534          with pytest.raises(esptool.FatalError) as cm:
535              espsecure.verify_signature(args)
536          assert &quot;Signature is not valid&quot; in str(cm.value)
537          args = self.VerifyArgs(
538              &quot;2&quot;,
539              False,
540              None,
541              self._open(&quot;rsa_secure_boot_signing_pubkey2.pem&quot;),
542              self._open(&quot;bootloader_signed_v2.bin&quot;),
543          )
544          with pytest.raises(esptool.FatalError) as cm:
545              espsecure.verify_signature(args)
546          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
547          args = self.VerifyArgs(
548              &quot;2&quot;,
549              False,
550              None,
551              self._open(&quot;ecdsa_secure_boot_signing_pubkey2.pem&quot;),
552              self._open(&quot;bootloader_signed_v2_ecdsa256.bin&quot;),
553          )
554          with pytest.raises(esptool.FatalError) as cm:
555              espsecure.verify_signature(args)
556          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
557          args = self.VerifyArgs(
558              &quot;2&quot;,
559              False,
560              None,
561              self._open(&quot;ecdsa192_secure_boot_signing_pubkey2.pem&quot;),
562              self._open(&quot;bootloader_signed_v2_ecdsa192.bin&quot;),
563          )
564          with pytest.raises(esptool.FatalError) as cm:
565              espsecure.verify_signature(args)
566          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
567          args = self.VerifyArgs(
568              &quot;2&quot;,
569              False,
570              None,
571              self._open(&quot;rsa_secure_boot_signing_pubkey4.pem&quot;),
572              self._open(&quot;bootloader_multi_signed_v2.bin&quot;),
573          )
574          with pytest.raises(esptool.FatalError) as cm:
575              espsecure.verify_signature(args)
576          assert &quot;Signature could not be verified with the provided key.&quot; in str(cm.value)
577      def test_extract_binary_public_key(self):
578          with tempfile.NamedTemporaryFile() as pub_keyfile, tempfile.NamedTemporaryFile() as pub_keyfile2:  # noqa E501
579              args = self.ExtractKeyArgs(
580                  &quot;1&quot;, self._open(&quot;ecdsa_secure_boot_signing_key.pem&quot;), pub_keyfile
581              )
582              espsecure.extract_public_key(args)
583              args = self.ExtractKeyArgs(
584                  &quot;1&quot;, self._open(&quot;ecdsa_secure_boot_signing_key2.pem&quot;), pub_keyfile2
585              )
586              espsecure.extract_public_key(args)
587              pub_keyfile.seek(0)
588              pub_keyfile2.seek(0)
589              args = self.VerifyArgs(
590                  &quot;1&quot;, False, None, pub_keyfile, self._open(&quot;bootloader_signed.bin&quot;)
591              )
592              espsecure.verify_signature(args)
593              args = self.VerifyArgs(
594                  &quot;1&quot;, False, None, pub_keyfile2, self._open(&quot;bootloader_signed.bin&quot;)
595              )
596              with pytest.raises(esptool.FatalError) as cm:
597                  espsecure.verify_signature(args)
598              assert &quot;Signature is not valid&quot; in str(cm.value)
599      def test_generate_and_extract_key_v2(self):
600          with tempfile.TemporaryDirectory() as keydir:
601              keyfile_name = os.path.join(keydir, &quot;key.pem&quot;)
602              for scheme in [&quot;rsa3072&quot;, &quot;ecdsa192&quot;, &quot;ecdsa256&quot;]:
603                  args = self.GenerateKeyArgs(&quot;2&quot;, scheme, keyfile_name)
604                  espsecure.generate_signing_key(args)
605                  with tempfile.NamedTemporaryFile() as pub_keyfile, open(
606                      keyfile_name, &quot;rb&quot;
607                  ) as keyfile:
608                      args = self.ExtractKeyArgs(&quot;2&quot;, keyfile, pub_keyfile)
609                      espsecure.extract_public_key(args)
610                  os.remove(keyfile_name)
611  class TestFlashEncryption(EspSecureTestCase):
612      EncryptArgs = namedtuple(
613          &quot;encrypt_flash_data_args&quot;,
614          [
615              &quot;keyfile&quot;,
616              &quot;output&quot;,
617              &quot;address&quot;,
618              &quot;flash_crypt_conf&quot;,
619              &quot;aes_xts&quot;,
620              &quot;plaintext_file&quot;,
621          ],
622      )
623      DecryptArgs = namedtuple(
624          &quot;decrypt_flash_data_args&quot;,
625          [
626              &quot;keyfile&quot;,
627              &quot;output&quot;,
628              &quot;address&quot;,
629              &quot;flash_crypt_conf&quot;,
630              &quot;aes_xts&quot;,
631              &quot;encrypted_file&quot;,
632          ],
633      )
634      def _test_encrypt_decrypt(
635          self,
636          input_plaintext,
637          expected_ciphertext,
638          key_path,
639          offset,
640          flash_crypt_conf=0xF,
641          aes_xts=None,
642      ):
643          original_plaintext = self._open(input_plaintext)
644          keyfile = self._open(key_path)
645          ciphertext = io.BytesIO()
646          args = self.EncryptArgs(
647              keyfile, ciphertext, offset, flash_crypt_conf, aes_xts, original_plaintext
648          )
649          espsecure.encrypt_flash_data(args)
650          original_plaintext.seek(0)
651          assert original_plaintext.read() != ciphertext.getvalue()
652          with self._open(expected_ciphertext) as f:
653              assert f.read() == ciphertext.getvalue()
654          ciphertext.seek(0)
655          keyfile.seek(0)
656          plaintext = io.BytesIO()
657          args = self.DecryptArgs(
658              keyfile, plaintext, offset, flash_crypt_conf, aes_xts, ciphertext
659          )
660          espsecure.decrypt_flash_data(args)
661          original_plaintext.seek(0)
662          assert original_plaintext.read() == plaintext.getvalue()
663  class TestESP32FlashEncryption(TestFlashEncryption):
664      def test_encrypt_decrypt_bootloader(self):
665          self._test_encrypt_decrypt(
666              &quot;bootloader.bin&quot;, &quot;bootloader-encrypted.bin&quot;, &quot;256bit_key.bin&quot;, 0x1000, 0xF
667          )
668      def test_encrypt_decrypt_app(self):
669          self._test_encrypt_decrypt(
670              &quot;hello-world-signed.bin&quot;,
671              &quot;hello-world-signed-encrypted.bin&quot;,
672              &quot;ef-flashencryption-key.bin&quot;,
673              0x20000,
674              0xF,
675          )
676      def test_encrypt_decrypt_non_default_conf(self):
677          for conf in [0x0, 0x3, 0x9, 0xC]:
678              self._test_encrypt_decrypt(
679                  &quot;bootloader.bin&quot;,
680                  f&quot;bootloader-encrypted-conf{conf:x}.bin&quot;,
681                  &quot;256bit_key.bin&quot;,
682                  0x1000,
683                  conf,
684              )
685  class TestAesXtsFlashEncryption(TestFlashEncryption):
686      def test_encrypt_decrypt_bootloader(self):
687          self._test_encrypt_decrypt(
688              &quot;bootloader.bin&quot;,
689              &quot;bootloader-encrypted-aes-xts.bin&quot;,
690              &quot;256bit_key.bin&quot;,
691              0x1000,
692              aes_xts=True,
693          )
694      def test_encrypt_decrypt_app(self):
695          self._test_encrypt_decrypt(
696              &quot;hello-world-signed.bin&quot;,
697              &quot;hello-world-signed-encrypted-aes-xts.bin&quot;,
698              &quot;ef-flashencryption-key.bin&quot;,
699              0x20000,
700              aes_xts=True,
701          )
702      def test_encrypt_decrypt_app_512_bit_key(self):
703          self._test_encrypt_decrypt(
704              &quot;hello-world-signed.bin&quot;,
705              &quot;hello-world-signed-encrypted-aes-xts-256.bin&quot;,
706              &quot;512bit_key.bin&quot;,
707              0x10000,
708              aes_xts=True,
709          )
710      def test_padding(self):
711          plaintext = binascii.unhexlify(
712              &quot;c33b7c49f12a969a9bb45af5f660b73f&quot;
713              &quot;3b372685012da570df1cf99d1a82eabb&quot;
714              &quot;fdf6aa16b9675bd8a2f95e871513e175&quot;
715              &quot;3bc89f57986ecfb2707a3d3b59a46968&quot;
716              &quot;5e6609d2e9c21d4b2310571175e6e3de&quot;
717              &quot;2656ee22243f557b925ef39ff782ab56&quot;
718              &quot;f821e6859ee852000daae7c03a7c77ce&quot;
719              &quot;58744f15fbdf0ad4ae6e964aedd6316a&quot;
720              &quot;cf0e36935eef895cd14a60fe682fb971&quot;
721              &quot;eb239eae38b770bdf969017c9decfd91&quot;
722              &quot;b7c60329fb0c896684f0e7415f99dec1&quot;
723              &quot;da0572fac360a3e6d7219973a7de07e5&quot;
724              &quot;33b5abfdf5917ed5bfe54d660a6f5047&quot;
725              &quot;32fdb8d07259bfcdc67da87293857c11&quot;
726              &quot;427b2bae5f00da4a4b2b00b588ff5109&quot;
727              &quot;4c41f07f02f680f8826841b43da3f25b&quot;
728          )
729          plaintext_file = io.BytesIO(plaintext)
730          ciphertext_full_block = io.BytesIO()
731          keyfile = self._open(&quot;256bit_key.bin&quot;)
732          address = 0x1000
733          encrypt_args_padded = self.EncryptArgs(
734              keyfile, ciphertext_full_block, address, None, &quot;aes_xts&quot;, plaintext_file
735          )
736          espsecure.encrypt_flash_data(encrypt_args_padded)
737          bytes_per_encrypt = [16, 32, 64, 128]
738          for b in bytes_per_encrypt:
739              ciphertext = io.BytesIO()
740              num_enc_calls = len(plaintext) // b
741              for i in range(0, num_enc_calls):
742                  keyfile.seek(0)
743                  offset = b * i
744                  plaintext_sub = io.BytesIO(plaintext[offset : offset + b])
745                  encrypt_args = self.EncryptArgs(
746                      keyfile,
747                      ciphertext,
748                      address + offset,
749                      None,
750                      &quot;aes_xts&quot;,
751                      plaintext_sub,
752                  )
753                  espsecure.encrypt_flash_data(encrypt_args)
754              assert ciphertext_full_block.getvalue() == ciphertext.getvalue()
755  class TestDigest(EspSecureTestCase):
756      def test_digest_private_key(self):
757          with tempfile.NamedTemporaryFile() as f:
758              outfile_name = f.name
759          self.run_espsecure(
760              &quot;digest_private_key &quot;
761              &quot;--keyfile secure_images/ecdsa_secure_boot_signing_key.pem &quot;
762              f&quot;{outfile_name}&quot;
763          )
764          with open(outfile_name, &quot;rb&quot;) as f:
765              assert f.read() == binascii.unhexlify(
766                  &quot;7b7b53708fc89d5e0b2df2571fb8f9d778f61a422ff1101a22159c4b34aad0aa&quot;
767              )
768      def test_digest_private_key_with_invalid_output(self, capsys):
769          fname = &quot;secure_images/ecdsa_secure_boot_signing_key.pem&quot;
770          with pytest.raises(subprocess.CalledProcessError):
771              self.run_espsecure(f&quot;digest_private_key --keyfile {fname} {fname}&quot;)
772          output = capsys.readouterr().out
773          assert &quot;should not be the same!&quot; in output
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from esptool-MDEwOlJlcG9zaXRvcnkyMzczNjkxNA==-flat-test_espsecure.py</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from esptool-MDEwOlJlcG9zaXRvcnkyMzczNjkxNA==-flat-test_espsecure.py</div>
                </div>
                <div class="column column_space"><pre><code>337          signing_keys = [
338              &quot;rsa_secure_boot_signing_pubkey.pem&quot;,
339              &quot;ecdsa192_secure_boot_signing_pubkey.pem&quot;,
340              &quot;ecdsa_secure_boot_signing_pubkey.pem&quot;,
341          ]
342          pre_calculated_signatures = [
343              &quot;pre_calculated_bootloader_signature_rsa.bin&quot;,
344              &quot;pre_calculated_bootloader_signature_ecdsa192.bin&quot;,
345              &quot;pre_calculated_bootloader_signature_ecdsa256.bin&quot;,
346          ]
347          for pub_key, signature in zip(signing_keys, pre_calculated_signatures):
</pre></code></div>
                <div class="column column_space"><pre><code>370          signing_pubkeys = [
371              &quot;rsa_secure_boot_signing_pubkey.pem&quot;,
372              &quot;rsa_secure_boot_signing_pubkey.pem&quot;,
373              &quot;rsa_secure_boot_signing_pubkey.pem&quot;,
374          ]
375          pre_calculated_signatures = [
376              &quot;pre_calculated_bootloader_signature_rsa.bin&quot;,
377              &quot;pre_calculated_bootloader_signature_rsa.bin&quot;,
378              &quot;pre_calculated_bootloader_signature_rsa.bin&quot;,
379          ]
380          try:
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    