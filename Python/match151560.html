<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for cache_3.py &amp; test_find.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for cache_3.py &amp; test_find.py
      </h3>
<h1 align="center">
        2.3%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>cache_3.py (4.5028143%)<th>test_find.py (1.5665796%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(145-147)<td><a href="#" name="0">(412-416)</a><td align="center"><font color="#ff0000">12</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(75-88)<td><a href="#" name="1">(258-264)</a><td align="center"><font color="#ff0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>cache_3.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import functools
2 import logging
3 import os
4 import re
5 import time
6 import salt.config
7 import salt.payload
8 import salt.utils.atomicfile
9 import salt.utils.data
10 import salt.utils.dictupdate
11 import salt.utils.files
12 import salt.utils.msgpack
13 from salt.utils.zeromq import zmq
14 log = logging.getLogger(__name__)
15 class CacheFactory:
16     @classmethod
17     def factory(cls, backend, ttl, *args, **kwargs):
18         log.debug("Factory backend: %s", backend)
19         if backend == "memory":
20             return CacheDict(ttl, *args, **kwargs)
21         elif backend == "disk":
22             return CacheDisk(ttl, kwargs["minion_cache_path"], *args, **kwargs)
23         else:
24             log.error("CacheFactory received unrecognized cache type")
25 class CacheDict(dict):
26     def __init__(self, ttl, *args, **kwargs):
27         dict.__init__(self, *args, **kwargs)
28         self._ttl = ttl
29         self._key_cache_time = {}
30     def _enforce_ttl_key(self, key):
31         if key not in self._key_cache_time:
32             return
33         if time.time() - self._key_cache_time[key] &gt; self._ttl:
34             del self._key_cache_time[key]
35             dict.__delitem__(self, key)
36     def __getitem__(self, key):
37         self._enforce_ttl_key(key)
38         return dict.__getitem__(self, key)
39     def __setitem__(self, key, val):
40         self._key_cache_time[key] = time.time()
41         dict.__setitem__(self, key, val)
42     def __contains__(self, key):
43         self._enforce_ttl_key(key)
44         return dict<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.__contains__(self, key)
45 class CacheDisk(CacheDict):
46     def __init__(self, ttl, path, *args, **kwargs):
47         super().__init__(ttl, *args, **kwargs)
48         self._path = path
49         self.</b></font>_dict = {}
50         self._read()
51     def _enforce_ttl_key(self, key):
52         if key not in self._key_cache_time:
53             return
54         if time.time() - self._key_cache_time[key] &gt; self._ttl:
55             del self._key_cache_time[key]
56             self._dict.__delitem__(key)
57     def __contains__(self, key):
58         self._enforce_ttl_key(key)
59         return self._dict.__contains__(key)
60     def __getitem__(self, key):
61         self._enforce_ttl_key(key)
62         return self._dict.__getitem__(key)
63     def __setitem__(self, key, val):
64         self._key_cache_time[key] = time.time()
65         self._dict.__setitem__(key, val)
66         self._write()
67     def __delitem__(self, key):
68         del self._key_cache_time[key]
69         self._dict.__delitem__(key)
70         self._write()
71     def clear(self):
72         self._key_cache_time.clear()
73         self._dict.clear()
74         self._write()
75     def _read(self):
76         """
77         with salt<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.utils.files.fopen(self._path, "rb") as fp_:
78             cache = salt.utils.data.decode(
79                 salt.utils.</b></font>msgpack.load(fp_, encoding=__salt_system_encoding__)
80             )
81         if "CacheDisk_cachetime" in cache:  # new format
82             self._dict = cache["CacheDisk_data"]
83             self._key_cache_time = cache["CacheDisk_cachetime"]
84         else:  # old format
85             self._dict = cache
86             timestamp = os.path.getmtime(self._path)
87             for key in self._dict:
88                 self._key_cache_time[key] = timestamp
89         if log.isEnabledFor(logging.DEBUG):
90             log.debug("Disk cache retrieved: %s", cache)
91     def _write(self):
92         """
93         Write out to disk
94         """
95         if not salt.utils.msgpack.HAS_MSGPACK:
96             return
97         with salt.utils.atomicfile.atomic_open(self._path, "wb+") as fp_:
98             cache = {
99                 "CacheDisk_data": self._dict,
100                 "CacheDisk_cachetime": self._key_cache_time,
101             }
102             salt.utils.msgpack.dump(cache, fp_, use_bin_type=True)
103 class CacheCli:
104     """
105     Connection client for the ConCache. Should be used by all
106     components that need the list of currently connected minions
107     """
108     def __init__(self, opts):
109         """
110         Sets up the zmq-connection to the ConCache
111         """
112         self.opts = opts
113         self.cache_sock = os.path.join(self.opts["sock_dir"], "con_cache.ipc")
114         self.cache_upd_sock = os.path.join(self.opts["sock_dir"], "con_upd.ipc")
115         context = zmq.Context()
116         self.creq_out = context.socket(zmq.REQ)
117         self.creq_out.setsockopt(zmq.LINGER, 100)
118         self.creq_out.connect("ipc://" + self.cache_sock)
119         self.cupd_out = context.socket(zmq.PUB)
120         self.cupd_out.setsockopt(zmq.LINGER, 1)
121         self.cupd_out.connect("ipc://" + self.cache_upd_sock)
122     def put_cache(self, minions):
123         """
124         published the given minions to the ConCache
125         """
126         self.cupd_out.send(salt.payload.dumps(minions))
127     def get_cached(self):
128         """
129         queries the ConCache for a list of currently connected minions
130         """
131         msg = salt.payload.dumps("minions")
132         self.creq_out.send(msg)
133         min_list = salt.payload.loads(self.creq_out.recv())
134         return min_list
135 class CacheRegex:
136     """
137     Create a regular expression object cache for the most frequently
138     used patterns to minimize compilation of the same patterns over
139     and over again
140     """
141     def __init__(
142         self, prepend="", append="", size=1000, keep_fraction=0.8, max_age=3600
143     ):
144         self.prepend = prepend
145         self.append = append
146         self.size = size
147         self.clear_size = int(size - size * (keep_fraction))
148         if self.clear_size &gt;= size:
149             self.clear_size = int(size / 2) + 1
150             if self.clear_size &gt; size:
151                 self.clear_size = size
152         self.max_age = max_age
153         self.cache = {}
154         self.timestamp = time.time()
155     def clear(self):
156         """
157         Clear the cache
158         """
159         self.cache.clear()
160     def sweep(self):
161         """
162         Sweep the cache and remove the outdated or least frequently
163         used entries
164         """
165         if self.max_age &lt; time.time() - self.timestamp:
166             self.clear()
167             self.timestamp = time.time()
168         else:
169             paterns = list(self.cache.values())
170             paterns.sort()
171             for idx in range(self.clear_size):
172                 del self.cache[paterns[idx][2]]
173     def get(self, pattern):
174         """
175         Get a compiled regular expression object based on pattern and
176         cache it when it is not in the cache already
177         """
178         try:
179             self.cache[pattern][0] += 1
180             return self.cache[pattern][1]
181         except KeyError:
182             pass
183         if len(self.cache) &gt; self.size:
184             self.sweep()
185         regex = re.compile("{}{}{}".format(self.prepend, pattern, self.append))
186         self.cache[pattern] = [1, regex, pattern, time.time()]
187         return regex
188 class ContextCache:
189     def __init__(self, opts, name):
190         """
191         Create a context cache
192         """
193         self.opts = opts
194         self.cache_path = os.path.join(opts["cachedir"], "context", "{}.p".format(name))
195     def cache_context(self, context):
196         """
197         Cache the given context to disk
198         """
199         if not os.path.isdir(os.path.dirname(self.cache_path)):
200             os.mkdir(os.path.dirname(self.cache_path))
201         with salt.utils.files.fopen(self.cache_path, "w+b") as cache:
202             salt.payload.dump(context, cache)
203     def get_cache_context(self):
204         """
205         Retrieve a context cache from disk
206         """
207         with salt.utils.files.fopen(self.cache_path, "rb") as cache:
208             return salt.utils.data.decode(salt.payload.load(cache))
209 def context_cache(func):
210     """
211     A decorator to be used module functions which need to cache their
212     context.
213     To evaluate a __context__ and re-hydrate it if a given key
214     is empty or contains no items, pass a list of keys to evaulate.
215     """
216     @functools.wraps(func)
217     def context_cache_wrap(*args, **kwargs):
218         try:
219             func_context = func.__globals__["__context__"].value()
220         except AttributeError:
221             func_context = func.__globals__["__context__"]
222         try:
223             func_opts = func.__globals__["__opts__"].value()
224         except AttributeError:
225             func_opts = func.__globals__["__opts__"]
226         func_name = func.__globals__["__name__"]
227         context_cache = ContextCache(func_opts, func_name)
228         if not func_context and os.path.isfile(context_cache.cache_path):
229             salt.utils.dictupdate.update(
230                 func_context, context_cache.get_cache_context()
231             )
232         else:
233             context_cache.cache_context(func_context)
234         return func(*args, **kwargs)
235     return context_cache_wrap
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_find.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import os
2 import shutil
3 import stat
4 import sys
5 import tempfile
6 import salt.utils.files
7 import salt.utils.find
8 from tests.support.runtests import RUNTIME_VARS
9 from tests.support.unit import TestCase, skipIf
10 class TestFind(TestCase):
11     def test_parse_interval(self):
12         self.assertRaises(ValueError, salt.utils.find._parse_interval, "w")
13         self.assertRaises(ValueError, salt.utils.find._parse_interval, "1")
14         self.assertRaises(ValueError, salt.utils.find._parse_interval, "1s1w")
15         self.assertRaises(ValueError, salt.utils.find._parse_interval, "1s1s")
16         result, resolution, modifier = salt.utils.find._parse_interval("")
17         self.assertEqual(result, 0)
18         self.assertIs(resolution, None)
19         self.assertEqual(modifier, "")
20         result, resolution, modifier = salt.utils.find._parse_interval("1s")
21         self.assertEqual(result, 1.0)
22         self.assertEqual(resolution, 1)
23         self.assertEqual(modifier, "")
24         result, resolution, modifier = salt.utils.find._parse_interval("1m")
25         self.assertEqual(result, 60.0)
26         self.assertEqual(resolution, 60)
27         self.assertEqual(modifier, "")
28         result, resolution, modifier = salt.utils.find._parse_interval("1h")
29         self.assertEqual(result, 3600.0)
30         self.assertEqual(resolution, 3600)
31         self.assertEqual(modifier, "")
32         result, resolution, modifier = salt.utils.find._parse_interval("1d")
33         self.assertEqual(result, 86400.0)
34         self.assertEqual(resolution, 86400)
35         self.assertEqual(modifier, "")
36         result, resolution, modifier = salt.utils.find._parse_interval("1w")
37         self.assertEqual(result, 604800.0)
38         self.assertEqual(resolution, 604800)
39         self.assertEqual(modifier, "")
40         result, resolution, modifier = salt.utils.find._parse_interval("1w3d6h")
41         self.assertEqual(result, 885600.0)
42         self.assertEqual(resolution, 3600)
43         self.assertEqual(modifier, "")
44         result, resolution, modifier = salt.utils.find._parse_interval("1m1s")
45         self.assertEqual(result, 61.0)
46         self.assertEqual(resolution, 1)
47         self.assertEqual(modifier, "")
48         result, resolution, modifier = salt.utils.find._parse_interval("1m2s")
49         self.assertEqual(result, 62.0)
50         self.assertEqual(resolution, 1)
51         self.assertEqual(modifier, "")
52         result, resolution, modifier = salt.utils.find._parse_interval("+1d")
53         self.assertEqual(result, 86400.0)
54         self.assertEqual(resolution, 86400)
55         self.assertEqual(modifier, "+")
56         result, resolution, modifier = salt.utils.find._parse_interval("-1d")
57         self.assertEqual(result, 86400.0)
58         self.assertEqual(resolution, 86400)
59         self.assertEqual(modifier, "-")
60     def test_parse_size(self):
61         self.assertRaises(ValueError, salt.utils.find._parse_size, "")
62         self.assertRaises(ValueError, salt.utils.find._parse_size, "1s1s")
63         min_size, max_size = salt.utils.find._parse_size("1")
64         self.assertEqual(min_size, 1)
65         self.assertEqual(max_size, 1)
66         min_size, max_size = salt.utils.find._parse_size("1b")
67         self.assertEqual(min_size, 1)
68         self.assertEqual(max_size, 1)
69         min_size, max_size = salt.utils.find._parse_size("1k")
70         self.assertEqual(min_size, 1024)
71         self.assertEqual(max_size, 2047)
72         min_size, max_size = salt.utils.find._parse_size("1m")
73         self.assertEqual(min_size, 1048576)
74         self.assertEqual(max_size, 2097151)
75         min_size, max_size = salt.utils.find._parse_size("1g")
76         self.assertEqual(min_size, 1073741824)
77         self.assertEqual(max_size, 2147483647)
78         min_size, max_size = salt.utils.find._parse_size("1t")
79         self.assertEqual(min_size, 1099511627776)
80         self.assertEqual(max_size, 2199023255551)
81         min_size, max_size = salt.utils.find._parse_size("0m")
82         self.assertEqual(min_size, 0)
83         self.assertEqual(max_size, 1048575)
84         min_size, max_size = salt.utils.find._parse_size("-1m")
85         self.assertEqual(min_size, 0)
86         self.assertEqual(max_size, 1048576)
87         min_size, max_size = salt.utils.find._parse_size("+1m")
88         self.assertEqual(min_size, 1048576)
89         self.assertEqual(max_size, sys.maxsize)
90         min_size, max_size = salt.utils.find._parse_size("+1M")
91         self.assertEqual(min_size, 1048576)
92         self.assertEqual(max_size, sys.maxsize)
93     def test_option_requires(self):
94         option = salt.utils.find.Option()
95         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)
96     def test_name_option_match(self):
97         option = salt.utils.find.NameOption("name", "*.txt")
98         self.assertIs(option.match("", "", ""), None)
99         self.assertIs(option.match("", "hello.txt", "").group(), "hello.txt")
100         self.assertIs(option.match("", "HELLO.TXT", ""), None)
101     def test_iname_option_match(self):
102         option = salt.utils.find.InameOption("name", "*.txt")
103         self.assertIs(option.match("", "", ""), None)
104         self.assertIs(option.match("", "hello.txt", "").group(), "hello.txt")
105         self.assertIs(option.match("", "HELLO.TXT", "").group(), "HELLO.TXT")
106     def test_regex_option_match(self):
107         self.assertRaises(ValueError, salt.utils.find.RegexOption, "name", "(.*}")
108         option = salt.utils.find.RegexOption("name", r".*\.txt")
109         self.assertIs(option.match("", "", ""), None)
110         self.assertIs(option.match("", "hello.txt", "").group(), "hello.txt")
111         self.assertIs(option.match("", "HELLO.TXT", ""), None)
112     def test_iregex_option_match(self):
113         self.assertRaises(ValueError, salt.utils.find.IregexOption, "name", "(.*}")
114         option = salt.utils.find.IregexOption("name", r".*\.txt")
115         self.assertIs(option.match("", "", ""), None)
116         self.assertIs(option.match("", "hello.txt", "").group(), "hello.txt")
117         self.assertIs(option.match("", "HELLO.TXT", "").group(), "HELLO.TXT")
118     def test_type_option_requires(self):
119         self.assertRaises(ValueError, salt.utils.find.TypeOption, "type", "w")
120         option = salt.utils.find.TypeOption("type", "d")
121         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
122     def test_type_option_match(self):
123         option = salt.utils.find.TypeOption("type", "b")
124         self.assertEqual(option.match("", "", [stat.S_IFREG]), False)
125         option = salt.utils.find.TypeOption("type", "c")
126         self.assertEqual(option.match("", "", [stat.S_IFREG]), False)
127         option = salt.utils.find.TypeOption("type", "d")
128         self.assertEqual(option.match("", "", [stat.S_IFREG]), False)
129         option = salt.utils.find.TypeOption("type", "f")
130         self.assertEqual(option.match("", "", [stat.S_IFREG]), True)
131         option = salt.utils.find.TypeOption("type", "l")
132         self.assertEqual(option.match("", "", [stat.S_IFREG]), False)
133         option = salt.utils.find.TypeOption("type", "p")
134         self.assertEqual(option.match("", "", [stat.S_IFREG]), False)
135         option = salt.utils.find.TypeOption("type", "s")
136         self.assertEqual(option.match("", "", [stat.S_IFREG]), False)
137         option = salt.utils.find.TypeOption("type", "b")
138         self.assertEqual(option.match("", "", [stat.S_IFBLK]), True)
139         option = salt.utils.find.TypeOption("type", "c")
140         self.assertEqual(option.match("", "", [stat.S_IFCHR]), True)
141         option = salt.utils.find.TypeOption("type", "d")
142         self.assertEqual(option.match("", "", [stat.S_IFDIR]), True)
143         option = salt.utils.find.TypeOption("type", "l")
144         self.assertEqual(option.match("", "", [stat.S_IFLNK]), True)
145         option = salt.utils.find.TypeOption("type", "p")
146         self.assertEqual(option.match("", "", [stat.S_IFIFO]), True)
147         option = salt.utils.find.TypeOption("type", "s")
148         self.assertEqual(option.match("", "", [stat.S_IFSOCK]), True)
149     @skipIf(sys.platform.startswith("win"), "pwd not available on Windows")
150     def test_owner_option_requires(self):
151         self.assertRaises(ValueError, salt.utils.find.OwnerOption, "owner", "notexist")
152         option = salt.utils.find.OwnerOption("owner", "root")
153         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
154     @skipIf(sys.platform.startswith("win"), "pwd not available on Windows")
155     def test_owner_option_match(self):
156         option = salt.utils.find.OwnerOption("owner", "root")
157         self.assertEqual(option.match("", "", [0] * 5), True)
158         option = salt.utils.find.OwnerOption("owner", "500")
159         self.assertEqual(option.match("", "", [500] * 5), True)
160     @skipIf(sys.platform.startswith("win"), "grp not available on Windows")
161     def test_group_option_requires(self):
162         self.assertRaises(ValueError, salt.utils.find.GroupOption, "group", "notexist")
163         if sys.platform.startswith(("darwin", "freebsd", "openbsd")):
164             group_name = "wheel"
165         else:
166             group_name = "root"
167         option = salt.utils.find.GroupOption("group", group_name)
168         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
169     @skipIf(sys.platform.startswith("win"), "grp not available on Windows")
170     def test_group_option_match(self):
171         if sys.platform.startswith(("darwin", "freebsd", "openbsd")):
172             group_name = "wheel"
173         else:
174             group_name = "root"
175         option = salt.utils.find.GroupOption("group", group_name)
176         self.assertEqual(option.match("", "", [0] * 6), True)
177         option = salt.utils.find.GroupOption("group", "500")
178         self.assertEqual(option.match("", "", [500] * 6), True)
179     def test_size_option_requires(self):
180         self.assertRaises(ValueError, salt.utils.find.SizeOption, "size", "1s1s")
181         option = salt.utils.find.SizeOption("size", "+1G")
182         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
183     def test_size_option_match(self):
184         option = salt.utils.find.SizeOption("size", "+1k")
185         self.assertEqual(option.match("", "", [10000] * 7), True)
186         option = salt.utils.find.SizeOption("size", "+1G")
187         self.assertEqual(option.match("", "", [10000] * 7), False)
188     def test_mtime_option_requires(self):
189         self.assertRaises(ValueError, salt.utils.find.MtimeOption, "mtime", "4g")
190         option = salt.utils.find.MtimeOption("mtime", "1d")
191         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
192     def test_mtime_option_match(self):
193         option = salt.utils.find.MtimeOption("mtime", "-1w")
194         option = salt.utils.find.MtimeOption("mtime", "-1s")
195         self.assertEqual(option<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.match("", "", [10 ** 10] * 9), True)
196 class TestGrepOption(TestCase):
197     def setUp(self):
198         super().setUp()
199         self.tmpdir = tempfile.</b></font>mkdtemp(dir=RUNTIME_VARS.TMP)
200     def tearDown(self):
201         shutil.rmtree(self.tmpdir)
202         super().tearDown()
203     def test_grep_option_requires(self):
204         self.assertRaises(ValueError, salt.utils.find.GrepOption, "grep", "(foo)|(bar}")
205         option = salt.utils.find.GrepOption("grep", "(foo)|(bar)")
206         find = salt.utils.find
207         self.assertEqual(
208             option.requires(), (find._REQUIRES_CONTENTS | find._REQUIRES_STAT)
209         )
210     def test_grep_option_match_regular_file(self):
211         hello_file = os.path.join(self.tmpdir, "hello.txt")
212         with salt.utils.files.fopen(hello_file, "w") as fp_:
213             fp_.write(salt.utils.stringutils.to_str("foo"))
214         option = salt.utils.find.GrepOption("grep", "foo")
215         self.assertEqual(
216             option.match(self.tmpdir, "hello.txt", os.stat(hello_file)), hello_file
217         )
218         option = salt.utils.find.GrepOption("grep", "bar")
219         self.assertEqual(
220             option.match(self.tmpdir, "hello.txt", os.stat(hello_file)), None
221         )
222     @skipIf(sys.platform.startswith("win"), "No /dev/null on Windows")
223     def test_grep_option_match_dev_null(self):
224         option = salt.utils.find.GrepOption("grep", "foo")
225         self.assertEqual(option.match("dev", "null", os.stat("/dev/null")), None)
226 class TestPrintOption(TestCase):
227     def setUp(self):
228         super().setUp()
229         self.tmpdir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)
230     def tearDown(self):
231         shutil.rmtree(self.tmpdir)
232         super().tearDown()
233     def test_print_option_defaults(self):
234         option = salt.utils.find.PrintOption("print", "")
235         self.assertEqual(option.need_stat, False)
236         self.assertEqual(option.print_title, False)
237         self.assertEqual(option.fmt, ["path"])
238     def test_print_option_requires(self):
239         option = salt.utils.find.PrintOption("print", "")
240         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)
241         option = salt.utils.find.PrintOption("print", "name")
242         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)
243         option = salt.utils.find.PrintOption("print", "path")
244         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)
245         option = salt.utils.find.PrintOption("print", "name,path")
246         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)
247         option = salt.utils.find.PrintOption("print", "user")
248         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
249         option = salt.utils.find.PrintOption("print", "path user")
250         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
251     def test_print_option_execute(self):
252         hello_file = os.path.join(self.tmpdir, "hello.txt")
253         with salt.utils.files.fopen(hello_file, "w") as fp_:
254             fp_.write(salt.utils.stringutils.to_str("foo"))
255         option = salt.utils.find.PrintOption("print", "")
256         self.assertEqual(option.execute("", [0] * 9), "")
257         option = salt.utils.find.PrintOption("print", "path")
258         self.assertEqual(option.execute("test_name", [0] * 9), "test_name")
259         option = salt.utils.find.PrintOption("print", "name")
260         self.assertEqual(option.execute("test_name", [0] * 9), "test_name")
261         option = salt.utils.find.PrintOption("print", "size")
262         self.assertEqual(option.execute(hello_file, os.stat(hello_file)), 3)
263         option = salt.utils.find.PrintOption("print", "type")
264         self.assertEqual(option.execute(hello_file, os.stat(hello_file)), "f")
265         option = salt.utils.find.PrintOption("print", "mode")
266         self.assertEqual(option.execute(hello_file, range(10)), 0)
267         option = salt.utils.find.PrintOption("print", "mtime")
268         self.assertEqual(option.execute(hello_file, range(10)), 8)
269         option = salt.utils.find.PrintOption("print", "md5")
270         self.assertEqual(
271             option.execute(hello_file, os.stat(hello_file)),
272             "acbd18db4cc2f85cedef654fccc4a4d8",
273         )
274         option = salt.utils.find.PrintOption("print", "path name")
275         self.assertEqual(
276             option.execute("test_name", [0] * 9), ["test_name", "test_name"]
277         )
278         option = salt.utils.find.PrintOption("print", "size name")
279         self.assertEqual(option.execute("test_name", [0] * 9), [0, "test_name"])
280     @skipIf(sys.platform.startswith("win"), "pwd not available on Windows")
281     def test_print_user(self):
282         option = salt.utils.find.PrintOption("print", "user")
283         self.assertEqual(option.execute("", [0] * 10), "root")
284         option = salt.utils.find.PrintOption("print", "user")
285         self.assertEqual(option.execute("", [2 ** 31] * 10), 2 ** 31)
286     @skipIf(sys.platform.startswith("win"), "grp not available on Windows")
287     def test_print_group(self):
288         option = salt.utils.find.PrintOption("print", "group")
289         if sys.platform.startswith(("darwin", "freebsd", "openbsd")):
290             group_name = "wheel"
291         else:
292             group_name = "root"
293         self.assertEqual(option.execute("", [0] * 10), group_name)
294     @skipIf(sys.platform.startswith("win"), "no /dev/null on windows")
295     def test_print_md5(self):
296         option = salt.utils.find.PrintOption("print", "md5")
297         self.assertEqual(option.execute("/dev/null", os.stat("/dev/null")), "")
298 class TestFinder(TestCase):
299     def setUp(self):
300         super().setUp()
301         self.tmpdir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)
302     def tearDown(self):
303         shutil.rmtree(self.tmpdir)
304         super().tearDown()
305     def test_init(self):
306         finder = salt.utils.find.Finder({})
307         self.assertEqual(str(finder.actions[0]<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.__class__)[-13:-2], "PrintOption")
308         self.assertEqual(finder.criteria, [])
309         finder = salt.utils.find.Finder({"_": None})
310         self.</b></font>assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
311         self.assertEqual(finder.criteria, [])
312         self.assertRaises(ValueError, salt.utils.find.Finder, {"": None})
313         self.assertRaises(ValueError, salt.utils.find.Finder, {"name": None})
314         self.assertRaises(ValueError, salt.utils.find.Finder, {"nonexist": "somevalue"})
315         finder = salt.utils.find.Finder({"name": "test_name"})
316         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
317         self.assertEqual(str(finder.criteria[0].__class__)[-12:-2], "NameOption")
318         finder = salt.utils.find.Finder({"iname": "test_name"})
319         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
320         self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], "InameOption")
321         finder = salt.utils.find.Finder({"regex": r".*\.txt"})
322         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
323         self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], "RegexOption")
324         finder = salt.utils.find.Finder({"iregex": r".*\.txt"})
325         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
326         self.assertEqual(str(finder.criteria[0].__class__)[-14:-2], "IregexOption")
327         finder = salt.utils.find.Finder({"type": "d"})
328         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
329         self.assertEqual(str(finder.criteria[0].__class__)[-12:-2], "TypeOption")
330         finder = salt.utils.find.Finder({"owner": "root"})
331         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
332         self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], "OwnerOption")
333         if sys.platform.startswith(("darwin", "freebsd", "openbsd")):
334             group_name = "wheel"
335         else:
336             group_name = "root"
337         finder = salt.utils.find.Finder({"group": group_name})
338         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
339         self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], "GroupOption")
340         finder = salt.utils.find.Finder({"size": "+1G"})
341         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
342         self.assertEqual(str(finder.criteria[0].__class__)[-12:-2], "SizeOption")
343         finder = salt.utils.find.Finder({"mtime": "1d"})
344         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
345         self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], "MtimeOption")
346         finder = salt.utils.find.Finder({"grep": "foo"})
347         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
348         self.assertEqual(str(finder.criteria[0].__class__)[-12:-2], "GrepOption")
349         finder = salt.utils.find.Finder({"print": "name"})
350         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
351         self.assertEqual(finder.criteria, [])
352     def test_find(self):
353         hello_file = os.path.join(self.tmpdir, "hello.txt")
354         with salt.utils.files.fopen(hello_file, "w") as fp_:
355             fp_.write(salt.utils.stringutils.to_str("foo"))
356         finder = salt.utils.find.Finder({})
357         self.assertEqual(list(finder.find(self.tmpdir)), [self.tmpdir, hello_file])
358         finder = salt.utils.find.Finder({"mindepth": 1})
359         self.assertEqual(list(finder.find(self.tmpdir)), [hello_file])
360         finder = salt.utils.find.Finder({"maxdepth": 0})
361         self.assertEqual(list(finder.find(self.tmpdir)), [self.tmpdir])
362         finder = salt.utils.find.Finder({"name": "hello.txt"})
363         self.assertEqual(list(finder.find(self.tmpdir)), [hello_file])
364         finder = salt.utils.find.Finder({"type": "f", "print": "path"})
365         self.assertEqual(list(finder.find(self.tmpdir)), [hello_file])
366         finder = salt.utils.find.Finder({"size": "+1G", "print": "path"})
367         self.assertEqual(list(finder.find(self.tmpdir)), [])
368         finder = salt.utils.find.Finder({"name": "hello.txt", "print": "path name"})
369         self.assertEqual(list(finder.find(self.tmpdir)), [[hello_file, "hello.txt"]])
370         finder = salt.utils.find.Finder({"name": "test_name"})
371         self.assertEqual(list(finder.find("")), [])
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
