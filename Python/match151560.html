<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for cache_3.py &amp; test_find.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for cache_3.py &amp; test_find.py
      </h3>
<h1 align="center">
        2.3%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>cache_3.py (4.5028143%)<th>test_find.py (1.5665796%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(145-147)<td><a href="#" name="0">(412-416)</a><td align="center"><font color="#ff0000">12</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(75-88)<td><a href="#" name="1">(258-264)</a><td align="center"><font color="#ff0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>cache_3.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import functools
2 import logging
3 import os
4 import re
5 import time
6 import salt.config
7 import salt.payload
8 import salt.utils.atomicfile
9 import salt.utils.data
10 import salt.utils.dictupdate
11 import salt.utils.files
12 import salt.utils.msgpack
13 from salt.utils.zeromq import zmq
14 log = logging.getLogger(__name__)
15 class CacheFactory:
16     @classmethod
17     def factory(cls, backend, ttl, *args, **kwargs):
18         log.debug("Factory backend: %s", backend)
19         if backend == "memory":
20             return CacheDict(ttl, *args, **kwargs)
21         elif backend == "disk":
22             return CacheDisk(ttl, kwargs["minion_cache_path"], *args, **kwargs)
23         else:
24             log.error("CacheFactory received unrecognized cache type")
25 class CacheDict(dict):
26     def __init__(self, ttl, *args, **kwargs):
27         dict.__init__(self, *args, **kwargs)
28         self._ttl = ttl
29         self._key_cache_time = {}
30     def _enforce_ttl_key(self, key):
31         if key not in self._key_cache_time:
32             return
33         if time.time() - self._key_cache_time[key] &gt; self._ttl:
34             del self._key_cache_time[key]
35             dict.__delitem__(self, key)
36     def __getitem__(self, key):
37         self._enforce_ttl_key(key)
38         return dict.__getitem__(self, key)
39     def __setitem__(self, key, val):
40         self._key_cache_time[key] = time.time()
41         dict.__setitem__(self, key, val)
42 <a name="1"></a>
43     def __contains__(self, key):
44         self._enforce_ttl_key(key)
45         return dict<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.__contains__(self, key)
46 class CacheDisk(CacheDict):
47     def __init__(self, ttl, path, *args, **kwargs):
48         super().__init__(ttl, *args, **kwargs)
49         self._path = path
50         self.</b></font>_dict = {}
51         self._read()
52     def _enforce_ttl_key(self, key):
53         if key not in self._key_cache_time:
54             return
55         if time.time() - self._key_cache_time[key] &gt; self._ttl:
56             del self._key_cache_time[key]
57             self._dict.__delitem__(key)
58     def __contains__(self, key):
59         self._enforce_ttl_key(key)
60         return self._dict.__contains__(key)
61     def __getitem__(self, key):
62         self._enforce_ttl_key(key)
63         return self._dict.__getitem__(key)
64     def __setitem__(self, key, val):
65         self._key_cache_time[key] = time.time()
66         self._dict.__setitem__(key, val)
67         self._write()
68     def __delitem__(self, key):
69         del self._key_cache_time[key]
70         self._dict.__delitem__(key)
71         self._write()
72     def clear(self):
73         self._key_cache_time.clear()
74         self._dict.clear()
75         self._write()
76     def _read(self):
77         with salt<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.utils.files.fopen(self._path, "rb") as fp_:
78             cache = salt.utils.data.decode(
79                 salt.utils.</b></font>msgpack.load(fp_, encoding=__salt_system_encoding__)
80             )
81         if "CacheDisk_cachetime" in cache:  # new format
82             self._dict = cache["CacheDisk_data"]
83             self._key_cache_time = cache["CacheDisk_cachetime"]
84         else:  # old format
85             self._dict = cache
86             timestamp = os.path.getmtime(self._path)
87             for key in self._dict:
88                 self._key_cache_time[key] = timestamp
89         if log.isEnabledFor(logging.DEBUG):
90             log.debug("Disk cache retrieved: %s", cache)
91     def _write(self):
92         if not salt.utils.msgpack.HAS_MSGPACK:
93             return
94         with salt.utils.atomicfile.atomic_open(self._path, "wb+") as fp_:
95             cache = {
96                 "CacheDisk_data": self._dict,
97                 "CacheDisk_cachetime": self._key_cache_time,
98             }
99             salt.utils.msgpack.dump(cache, fp_, use_bin_type=True)
100 class CacheCli:
101     def __init__(self, opts):
102         self.opts = opts
103         self.cache_sock = os.path.join(self.opts["sock_dir"], "con_cache.ipc")
104         self.cache_upd_sock = os.path.join(self.opts["sock_dir"], "con_upd.ipc")
105         context = zmq.Context()
106         self.creq_out = context.socket(zmq.REQ)
107         self.creq_out.setsockopt(zmq.LINGER, 100)
108         self.creq_out.connect("ipc://" + self.cache_sock)
109         self.cupd_out = context.socket(zmq.PUB)
110         self.cupd_out.setsockopt(zmq.LINGER, 1)
111         self.cupd_out.connect("ipc://" + self.cache_upd_sock)
112     def put_cache(self, minions):
113         self.cupd_out.send(salt.payload.dumps(minions))
114     def get_cached(self):
115         msg = salt.payload.dumps("minions")
116         self.creq_out.send(msg)
117         min_list = salt.payload.loads(self.creq_out.recv())
118         return min_list
119 class CacheRegex:
120     def __init__(
121         self, prepend="", append="", size=1000, keep_fraction=0.8, max_age=3600
122     ):
123         self.prepend = prepend
124         self.append = append
125         self.size = size
126         self.clear_size = int(size - size * (keep_fraction))
127         if self.clear_size &gt;= size:
128             self.clear_size = int(size / 2) + 1
129             if self.clear_size &gt; size:
130                 self.clear_size = size
131         self.max_age = max_age
132         self.cache = {}
133         self.timestamp = time.time()
134     def clear(self):
135         self.cache.clear()
136     def sweep(self):
137         if self.max_age &lt; time.time() - self.timestamp:
138             self.clear()
139             self.timestamp = time.time()
140         else:
141             paterns = list(self.cache.values())
142             paterns.sort()
143             for idx in range(self.clear_size):
144                 del self.cache[paterns[idx][2]]
145     def get(self, pattern):
146         try:
147             self.cache[pattern][0] += 1
148             return self.cache[pattern][1]
149         except KeyError:
150             pass
151         if len(self.cache) &gt; self.size:
152             self.sweep()
153         regex = re.compile("{}{}{}".format(self.prepend, pattern, self.append))
154         self.cache[pattern] = [1, regex, pattern, time.time()]
155         return regex
156 class ContextCache:
157     def __init__(self, opts, name):
158         self.opts = opts
159         self.cache_path = os.path.join(opts["cachedir"], "context", "{}.p".format(name))
160     def cache_context(self, context):
161         if not os.path.isdir(os.path.dirname(self.cache_path)):
162             os.mkdir(os.path.dirname(self.cache_path))
163         with salt.utils.files.fopen(self.cache_path, "w+b") as cache:
164             salt.payload.dump(context, cache)
165     def get_cache_context(self):
166         with salt.utils.files.fopen(self.cache_path, "rb") as cache:
167             return salt.utils.data.decode(salt.payload.load(cache))
168 def context_cache(func):
169     @functools.wraps(func)
170     def context_cache_wrap(*args, **kwargs):
171         try:
172             func_context = func.__globals__["__context__"].value()
173         except AttributeError:
174             func_context = func.__globals__["__context__"]
175         try:
176             func_opts = func.__globals__["__opts__"].value()
177         except AttributeError:
178             func_opts = func.__globals__["__opts__"]
179         func_name = func.__globals__["__name__"]
180         context_cache = ContextCache(func_opts, func_name)
181         if not func_context and os.path.isfile(context_cache.cache_path):
182             salt.utils.dictupdate.update(
183                 func_context, context_cache.get_cache_context()
184             )
185         else:
186             context_cache.cache_context(func_context)
187         return func(*args, **kwargs)
188     return context_cache_wrap
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_find.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import os
2 import shutil
3 import stat
4 import sys
5 import tempfile
6 import salt.utils.files
7 import salt.utils.find
8 from tests.support.runtests import RUNTIME_VARS
9 from tests.support.unit import TestCase, skipIf
10 class TestFind(TestCase):
11     def test_parse_interval(self):
12         self.assertRaises(ValueError, salt.utils.find._parse_interval, "w")
13         self.assertRaises(ValueError, salt.utils.find._parse_interval, "1")
14         self.assertRaises(ValueError, salt.utils.find._parse_interval, "1s1w")
15         self.assertRaises(ValueError, salt.utils.find._parse_interval, "1s1s")
16         result, resolution, modifier = salt.utils.find._parse_interval("")
17         self.assertEqual(result, 0)
18         self.assertIs(resolution, None)
19         self.assertEqual(modifier, "")
20         result, resolution, modifier = salt.utils.find._parse_interval("1s")
21         self.assertEqual(result, 1.0)
22         self.assertEqual(resolution, 1)
23         self.assertEqual(modifier, "")
24         result, resolution, modifier = salt.utils.find._parse_interval("1m")
25         self.assertEqual(result, 60.0)
26         self.assertEqual(resolution, 60)
27         self.assertEqual(modifier, "")
28         result, resolution, modifier = salt.utils.find._parse_interval("1h")
29         self.assertEqual(result, 3600.0)
30         self.assertEqual(resolution, 3600)
31         self.assertEqual(modifier, "")
32         result, resolution, modifier = salt.utils.find._parse_interval("1d")
33         self.assertEqual(result, 86400.0)
34         self.assertEqual(resolution, 86400)
35         self.assertEqual(modifier, "")
36         result, resolution, modifier = salt.utils.find._parse_interval("1w")
37         self.assertEqual(result, 604800.0)
38         self.assertEqual(resolution, 604800)
39         self.assertEqual(modifier, "")
40         result, resolution, modifier = salt.utils.find._parse_interval("1w3d6h")
41         self.assertEqual(result, 885600.0)
42         self.assertEqual(resolution, 3600)
43         self.assertEqual(modifier, "")
44         result, resolution, modifier = salt.utils.find._parse_interval("1m1s")
45         self.assertEqual(result, 61.0)
46         self.assertEqual(resolution, 1)
47         self.assertEqual(modifier, "")
48         result, resolution, modifier = salt.utils.find._parse_interval("1m2s")
49         self.assertEqual(result, 62.0)
50         self.assertEqual(resolution, 1)
51         self.assertEqual(modifier, "")
52         result, resolution, modifier = salt.utils.find._parse_interval("+1d")
53         self.assertEqual(result, 86400.0)
54         self.assertEqual(resolution, 86400)
55         self.assertEqual(modifier, "+")
56         result, resolution, modifier = salt.utils.find._parse_interval("-1d")
57         self.assertEqual(result, 86400.0)
58         self.assertEqual(resolution, 86400)
59         self.assertEqual(modifier, "-")
60     def test_parse_size(self):
61         self.assertRaises(ValueError, salt.utils.find._parse_size, "")
62         self.assertRaises(ValueError, salt.utils.find._parse_size, "1s1s")
63         min_size, max_size = salt.utils.find._parse_size("1")
64         self.assertEqual(min_size, 1)
65         self.assertEqual(max_size, 1)
66         min_size, max_size = salt.utils.find._parse_size("1b")
67         self.assertEqual(min_size, 1)
68         self.assertEqual(max_size, 1)
69         min_size, max_size = salt.utils.find._parse_size("1k")
70         self.assertEqual(min_size, 1024)
71         self.assertEqual(max_size, 2047)
72         min_size, max_size = salt.utils.find._parse_size("1m")
73         self.assertEqual(min_size, 1048576)
74         self.assertEqual(max_size, 2097151)
75         min_size, max_size = salt.utils.find._parse_size("1g")
76         self.assertEqual(min_size, 1073741824)
77         self.assertEqual(max_size, 2147483647)
78         min_size, max_size = salt.utils.find._parse_size("1t")
79         self.assertEqual(min_size, 1099511627776)
80         self.assertEqual(max_size, 2199023255551)
81         min_size, max_size = salt.utils.find._parse_size("0m")
82         self.assertEqual(min_size, 0)
83         self.assertEqual(max_size, 1048575)
84         min_size, max_size = salt.utils.find._parse_size("-1m")
85         self.assertEqual(min_size, 0)
86         self.assertEqual(max_size, 1048576)
87         min_size, max_size = salt.utils.find._parse_size("+1m")
88         self.assertEqual(min_size, 1048576)
89         self.assertEqual(max_size, sys.maxsize)
90         min_size, max_size = salt.utils.find._parse_size("+1M")
91         self.assertEqual(min_size, 1048576)
92         self.assertEqual(max_size, sys.maxsize)
93     def test_option_requires(self):
94         option = salt.utils.find.Option()
95         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)
96     def test_name_option_match(self):
97         option = salt.utils.find.NameOption("name", "*.txt")
98         self.assertIs(option.match("", "", ""), None)
99         self.assertIs(option.match("", "hello.txt", "").group(), "hello.txt")
100         self.assertIs(option.match("", "HELLO.TXT", ""), None)
101     def test_iname_option_match(self):
102         option = salt.utils.find.InameOption("name", "*.txt")
103         self.assertIs(option.match("", "", ""), None)
104         self.assertIs(option.match("", "hello.txt", "").group(), "hello.txt")
105         self.assertIs(option.match("", "HELLO.TXT", "").group(), "HELLO.TXT")
106     def test_regex_option_match(self):
107         self.assertRaises(ValueError, salt.utils.find.RegexOption, "name", "(.*}")
108         option = salt.utils.find.RegexOption("name", r".*\.txt")
109         self.assertIs(option.match("", "", ""), None)
110         self.assertIs(option.match("", "hello.txt", "").group(), "hello.txt")
111         self.assertIs(option.match("", "HELLO.TXT", ""), None)
112     def test_iregex_option_match(self):
113         self.assertRaises(ValueError, salt.utils.find.IregexOption, "name", "(.*}")
114         option = salt.utils.find.IregexOption("name", r".*\.txt")
115         self.assertIs(option.match("", "", ""), None)
116         self.assertIs(option.match("", "hello.txt", "").group(), "hello.txt")
117         self.assertIs(option.match("", "HELLO.TXT", "").group(), "HELLO.TXT")
118     def test_type_option_requires(self):
119         self.assertRaises(ValueError, salt.utils.find.TypeOption, "type", "w")
120         option = salt.utils.find.TypeOption("type", "d")
121         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
122     def test_type_option_match(self):
123         option = salt.utils.find.TypeOption("type", "b")
124         self.assertEqual(option.match("", "", [stat.S_IFREG]), False)
125         option = salt.utils.find.TypeOption("type", "c")
126         self.assertEqual(option.match("", "", [stat.S_IFREG]), False)
127         option = salt.utils.find.TypeOption("type", "d")
128         self.assertEqual(option.match("", "", [stat.S_IFREG]), False)
129         option = salt.utils.find.TypeOption("type", "f")
130         self.assertEqual(option.match("", "", [stat.S_IFREG]), True)
131         option = salt.utils.find.TypeOption("type", "l")
132         self.assertEqual(option.match("", "", [stat.S_IFREG]), False)
133         option = salt.utils.find.TypeOption("type", "p")
134         self.assertEqual(option.match("", "", [stat.S_IFREG]), False)
135         option = salt.utils.find.TypeOption("type", "s")
136         self.assertEqual(option.match("", "", [stat.S_IFREG]), False)
137         option = salt.utils.find.TypeOption("type", "b")
138         self.assertEqual(option.match("", "", [stat.S_IFBLK]), True)
139         option = salt.utils.find.TypeOption("type", "c")
140         self.assertEqual(option.match("", "", [stat.S_IFCHR]), True)
141         option = salt.utils.find.TypeOption("type", "d")
142         self.assertEqual(option.match("", "", [stat.S_IFDIR]), True)
143         option = salt.utils.find.TypeOption("type", "l")
144         self.assertEqual(option.match("", "", [stat.S_IFLNK]), True)
145         option = salt.utils.find.TypeOption("type", "p")
146         self.assertEqual(option.match("", "", [stat.S_IFIFO]), True)
147         option = salt.utils.find.TypeOption("type", "s")
148         self.assertEqual(option.match("", "", [stat.S_IFSOCK]), True)
149     @skipIf(sys.platform.startswith("win"), "pwd not available on Windows")
150     def test_owner_option_requires(self):
151         self.assertRaises(ValueError, salt.utils.find.OwnerOption, "owner", "notexist")
152         option = salt.utils.find.OwnerOption("owner", "root")
153         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
154     @skipIf(sys.platform.startswith("win"), "pwd not available on Windows")
155     def test_owner_option_match(self):
156         option = salt.utils.find.OwnerOption("owner", "root")
157         self.assertEqual(option.match("", "", [0] * 5), True)
158         option = salt.utils.find.OwnerOption("owner", "500")
159         self.assertEqual(option.match("", "", [500] * 5), True)
160     @skipIf(sys.platform.startswith("win"), "grp not available on Windows")
161     def test_group_option_requires(self):
162         self.assertRaises(ValueError, salt.utils.find.GroupOption, "group", "notexist")
163         if sys.platform.startswith(("darwin", "freebsd", "openbsd")):
164             group_name = "wheel"
165         else:
166             group_name = "root"
167         option = salt.utils.find.GroupOption("group", group_name)
168         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
169     @skipIf(sys.platform.startswith("win"), "grp not available on Windows")
170     def test_group_option_match(self):
171         if sys.platform.startswith(("darwin", "freebsd", "openbsd")):
172             group_name = "wheel"
173         else:
174             group_name = "root"
175         option = salt.utils.find.GroupOption("group", group_name)
176         self.assertEqual(option.match("", "", [0] * 6), True)
177         option = salt.utils.find.GroupOption("group", "500")
178         self.assertEqual(option.match("", "", [500] * 6), True)
179     def test_size_option_requires(self):
180         self.assertRaises(ValueError, salt.utils.find.SizeOption, "size", "1s1s")
181         option = salt.utils.find.SizeOption("size", "+1G")
182         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
183     def test_size_option_match(self):
184         option = salt.utils.find.SizeOption("size", "+1k")
185         self.assertEqual(option.match("", "", [10000] * 7), True)
186         option = salt.utils.find.SizeOption("size", "+1G")
187         self.assertEqual(option.match("", "", [10000] * 7), False)
188     def test_mtime_option_requires(self):
189         self.assertRaises(ValueError, salt.utils.find.MtimeOption, "mtime", "4g")
190         option = salt.utils.find.MtimeOption("mtime", "1d")
191         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
192     def test_mtime_option_match(self):
193         option = salt.utils.find.MtimeOption("mtime", "-1w")
194 <a name="1"></a>        self.assertEqual(option.match("", "", [1] * 9), False)
195         option = salt.utils.find.MtimeOption("mtime", "-1s")
196         self.assertEqual(option<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.match("", "", [10 ** 10] * 9), True)
197 class TestGrepOption(TestCase):
198     def setUp(self):
199         super().setUp()
200         self.tmpdir = tempfile.</b></font>mkdtemp(dir=RUNTIME_VARS.TMP)
201     def tearDown(self):
202         shutil.rmtree(self.tmpdir)
203         super().tearDown()
204     def test_grep_option_requires(self):
205         self.assertRaises(ValueError, salt.utils.find.GrepOption, "grep", "(foo)|(bar}")
206         option = salt.utils.find.GrepOption("grep", "(foo)|(bar)")
207         find = salt.utils.find
208         self.assertEqual(
209             option.requires(), (find._REQUIRES_CONTENTS | find._REQUIRES_STAT)
210         )
211     def test_grep_option_match_regular_file(self):
212         hello_file = os.path.join(self.tmpdir, "hello.txt")
213         with salt.utils.files.fopen(hello_file, "w") as fp_:
214             fp_.write(salt.utils.stringutils.to_str("foo"))
215         option = salt.utils.find.GrepOption("grep", "foo")
216         self.assertEqual(
217             option.match(self.tmpdir, "hello.txt", os.stat(hello_file)), hello_file
218         )
219         option = salt.utils.find.GrepOption("grep", "bar")
220         self.assertEqual(
221             option.match(self.tmpdir, "hello.txt", os.stat(hello_file)), None
222         )
223     @skipIf(sys.platform.startswith("win"), "No /dev/null on Windows")
224     def test_grep_option_match_dev_null(self):
225         option = salt.utils.find.GrepOption("grep", "foo")
226         self.assertEqual(option.match("dev", "null", os.stat("/dev/null")), None)
227 class TestPrintOption(TestCase):
228     def setUp(self):
229         super().setUp()
230         self.tmpdir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)
231     def tearDown(self):
232         shutil.rmtree(self.tmpdir)
233         super().tearDown()
234     def test_print_option_defaults(self):
235         option = salt.utils.find.PrintOption("print", "")
236         self.assertEqual(option.need_stat, False)
237         self.assertEqual(option.print_title, False)
238         self.assertEqual(option.fmt, ["path"])
239     def test_print_option_requires(self):
240         option = salt.utils.find.PrintOption("print", "")
241         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)
242         option = salt.utils.find.PrintOption("print", "name")
243         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)
244         option = salt.utils.find.PrintOption("print", "path")
245         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)
246         option = salt.utils.find.PrintOption("print", "name,path")
247         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)
248         option = salt.utils.find.PrintOption("print", "user")
249         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
250         option = salt.utils.find.PrintOption("print", "path user")
251         self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)
252     def test_print_option_execute(self):
253         hello_file = os.path.join(self.tmpdir, "hello.txt")
254         with salt.utils.files.fopen(hello_file, "w") as fp_:
255             fp_.write(salt.utils.stringutils.to_str("foo"))
256         option = salt.utils.find.PrintOption("print", "")
257         self.assertEqual(option.execute("", [0] * 9), "")
258         option = salt.utils.find.PrintOption("print", "path")
259         self.assertEqual(option.execute("test_name", [0] * 9), "test_name")
260         option = salt.utils.find.PrintOption("print", "name")
261         self.assertEqual(option.execute("test_name", [0] * 9), "test_name")
262         option = salt.utils.find.PrintOption("print", "size")
263         self.assertEqual(option.execute(hello_file, os.stat(hello_file)), 3)
264         option = salt.utils.find.PrintOption("print", "type")
265         self.assertEqual(option.execute(hello_file, os.stat(hello_file)), "f")
266         option = salt.utils.find.PrintOption("print", "mode")
267         self.assertEqual(option.execute(hello_file, range(10)), 0)
268         option = salt.utils.find.PrintOption("print", "mtime")
269         self.assertEqual(option.execute(hello_file, range(10)), 8)
270         option = salt.utils.find.PrintOption("print", "md5")
271         self.assertEqual(
272             option.execute(hello_file, os.stat(hello_file)),
273             "acbd18db4cc2f85cedef654fccc4a4d8",
274         )
275         option = salt.utils.find.PrintOption("print", "path name")
276         self.assertEqual(
277             option.execute("test_name", [0] * 9), ["test_name", "test_name"]
278         )
279         option = salt.utils.find.PrintOption("print", "size name")
280         self.assertEqual(option.execute("test_name", [0] * 9), [0, "test_name"])
281     @skipIf(sys.platform.startswith("win"), "pwd not available on Windows")
282     def test_print_user(self):
283         option = salt.utils.find.PrintOption("print", "user")
284         self.assertEqual(option.execute("", [0] * 10), "root")
285         option = salt.utils.find.PrintOption("print", "user")
286         self.assertEqual(option.execute("", [2 ** 31] * 10), 2 ** 31)
287     @skipIf(sys.platform.startswith("win"), "grp not available on Windows")
288     def test_print_group(self):
289         option = salt.utils.find.PrintOption("print", "group")
290         if sys.platform.startswith(("darwin", "freebsd", "openbsd")):
291             group_name = "wheel"
292         else:
293             group_name = "root"
294         self.assertEqual(option.execute("", [0] * 10), group_name)
295     @skipIf(sys.platform.startswith("win"), "no /dev/null on windows")
296     def test_print_md5(self):
297         option = salt.utils.find.PrintOption("print", "md5")
298         self.assertEqual(option.execute("/dev/null", os.stat("/dev/null")), "")
299 class TestFinder(TestCase):
300     def setUp(self):
301         super().setUp()
302         self.tmpdir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)
303     def tearDown(self):
304         shutil.rmtree(self.tmpdir)
305         super().tearDown()
306 <a name="0"></a>    @skipIf(sys.platform.startswith("win"), "No /dev/null on Windows")
307     def test_init(self):
308         finder = salt.utils.find.Finder({})
309         self.assertEqual(str(finder.actions[0]<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.__class__)[-13:-2], "PrintOption")
310         self.assertEqual(finder.criteria, [])
311         finder = salt.utils.find.Finder({"_": None})
312         self.</b></font>assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
313         self.assertEqual(finder.criteria, [])
314         self.assertRaises(ValueError, salt.utils.find.Finder, {"": None})
315         self.assertRaises(ValueError, salt.utils.find.Finder, {"name": None})
316         self.assertRaises(ValueError, salt.utils.find.Finder, {"nonexist": "somevalue"})
317         finder = salt.utils.find.Finder({"name": "test_name"})
318         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
319         self.assertEqual(str(finder.criteria[0].__class__)[-12:-2], "NameOption")
320         finder = salt.utils.find.Finder({"iname": "test_name"})
321         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
322         self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], "InameOption")
323         finder = salt.utils.find.Finder({"regex": r".*\.txt"})
324         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
325         self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], "RegexOption")
326         finder = salt.utils.find.Finder({"iregex": r".*\.txt"})
327         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
328         self.assertEqual(str(finder.criteria[0].__class__)[-14:-2], "IregexOption")
329         finder = salt.utils.find.Finder({"type": "d"})
330         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
331         self.assertEqual(str(finder.criteria[0].__class__)[-12:-2], "TypeOption")
332         finder = salt.utils.find.Finder({"owner": "root"})
333         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
334         self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], "OwnerOption")
335         if sys.platform.startswith(("darwin", "freebsd", "openbsd")):
336             group_name = "wheel"
337         else:
338             group_name = "root"
339         finder = salt.utils.find.Finder({"group": group_name})
340         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
341         self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], "GroupOption")
342         finder = salt.utils.find.Finder({"size": "+1G"})
343         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
344         self.assertEqual(str(finder.criteria[0].__class__)[-12:-2], "SizeOption")
345         finder = salt.utils.find.Finder({"mtime": "1d"})
346         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
347         self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], "MtimeOption")
348         finder = salt.utils.find.Finder({"grep": "foo"})
349         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
350         self.assertEqual(str(finder.criteria[0].__class__)[-12:-2], "GrepOption")
351         finder = salt.utils.find.Finder({"print": "name"})
352         self.assertEqual(str(finder.actions[0].__class__)[-13:-2], "PrintOption")
353         self.assertEqual(finder.criteria, [])
354     def test_find(self):
355         hello_file = os.path.join(self.tmpdir, "hello.txt")
356         with salt.utils.files.fopen(hello_file, "w") as fp_:
357             fp_.write(salt.utils.stringutils.to_str("foo"))
358         finder = salt.utils.find.Finder({})
359         self.assertEqual(list(finder.find(self.tmpdir)), [self.tmpdir, hello_file])
360         finder = salt.utils.find.Finder({"mindepth": 1})
361         self.assertEqual(list(finder.find(self.tmpdir)), [hello_file])
362         finder = salt.utils.find.Finder({"maxdepth": 0})
363         self.assertEqual(list(finder.find(self.tmpdir)), [self.tmpdir])
364         finder = salt.utils.find.Finder({"name": "hello.txt"})
365         self.assertEqual(list(finder.find(self.tmpdir)), [hello_file])
366         finder = salt.utils.find.Finder({"type": "f", "print": "path"})
367         self.assertEqual(list(finder.find(self.tmpdir)), [hello_file])
368         finder = salt.utils.find.Finder({"size": "+1G", "print": "path"})
369         self.assertEqual(list(finder.find(self.tmpdir)), [])
370         finder = salt.utils.find.Finder({"name": "hello.txt", "print": "path name"})
371         self.assertEqual(list(finder.find(self.tmpdir)), [[hello_file, "hello.txt"]])
372         finder = salt.utils.find.Finder({"name": "test_name"})
373         self.assertEqual(list(finder.find("")), [])
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
