<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for cache_3.py & test_find.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for cache_3.py & test_find.py
      </h3>
      <h1 align="center">
        2.3%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>cache_3.py (4.5028143%)<TH>test_find.py (1.5665796%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match151560-0.html#0',2,'match151560-1.html#0',3)" NAME="0">(145-147)<TD><A HREF="javascript:ZweiFrames('match151560-0.html#0',2,'match151560-1.html#0',3)" NAME="0">(412-416)</A><TD ALIGN=center><FONT COLOR="#ff0000">12</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match151560-0.html#1',2,'match151560-1.html#1',3)" NAME="1">(75-88)<TD><A HREF="javascript:ZweiFrames('match151560-0.html#1',2,'match151560-1.html#1',3)" NAME="1">(258-264)</A><TD ALIGN=center><FONT COLOR="#ff0000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>cache_3.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
In-memory caching used by Salt
&quot;&quot;&quot;

import functools
import logging
import os
import re
import time

import salt.config
import salt.payload
import salt.utils.atomicfile
import salt.utils.data
import salt.utils.dictupdate
import salt.utils.files
import salt.utils.msgpack
from salt.utils.zeromq import zmq

log = logging.getLogger(__name__)


class CacheFactory:
    &quot;&quot;&quot;
    Cache which can use a number of backends
    &quot;&quot;&quot;

    @classmethod
    def factory(cls, backend, ttl, *args, **kwargs):
        log.debug(&quot;Factory backend: %s&quot;, backend)
        if backend == &quot;memory&quot;:
            return CacheDict(ttl, *args, **kwargs)
        elif backend == &quot;disk&quot;:
            return CacheDisk(ttl, kwargs[&quot;minion_cache_path&quot;], *args, **kwargs)
        else:
            log.error(&quot;CacheFactory received unrecognized cache type&quot;)


class CacheDict(dict):
    &quot;&quot;&quot;
    Subclass of dict that will lazily delete items past ttl
    &quot;&quot;&quot;

    def __init__(self, ttl, *args, **kwargs):
        dict.__init__(self, *args, **kwargs)
        self._ttl = ttl
        self._key_cache_time = {}

    def _enforce_ttl_key(self, key):
        &quot;&quot;&quot;
        Enforce the TTL to a specific key, delete if its past TTL
        &quot;&quot;&quot;
        if key not in self._key_cache_time:
            return
        if time.time() - self._key_cache_time[key] &gt; self._ttl:
            del self._key_cache_time[key]
            dict.__delitem__(self, key)

    def __getitem__(self, key):
        &quot;&quot;&quot;
        Check if the key is ttld out, then do the get
        &quot;&quot;&quot;
        self._enforce_ttl_key(key)
        return dict.__getitem__(self, key)

    def __setitem__(self, key, val):
        &quot;&quot;&quot;
        Make sure to update the key cache time
        &quot;&quot;&quot;
        self._key_cache_time[key] = time.time()
        dict.__setitem__(self, key, val)
<A NAME="1"></A>
    def __contains__(self, key):
        self._enforce_ttl_key(key)
        return dict<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match151560-1.html#1',3,'match151560-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.__contains__(self, key)


class CacheDisk(CacheDict):
    &quot;&quot;&quot;
    Class that represents itself as a dictionary to a consumer
    but uses a disk-based backend. Serialization and de-serialization
    is done with msgpack
    &quot;&quot;&quot;

    def __init__(self, ttl, path, *args, **kwargs):
        super().__init__(ttl, *args, **kwargs)
        self._path = path
        self.</B></FONT>_dict = {}
        self._read()

    def _enforce_ttl_key(self, key):
        &quot;&quot;&quot;
        Enforce the TTL to a specific key, delete if its past TTL
        &quot;&quot;&quot;
        if key not in self._key_cache_time:
            return
        if time.time() - self._key_cache_time[key] &gt; self._ttl:
            del self._key_cache_time[key]
            self._dict.__delitem__(key)

    def __contains__(self, key):
        self._enforce_ttl_key(key)
        return self._dict.__contains__(key)

    def __getitem__(self, key):
        &quot;&quot;&quot;
        Check if the key is ttld out, then do the get
        &quot;&quot;&quot;
        self._enforce_ttl_key(key)
        return self._dict.__getitem__(key)

    def __setitem__(self, key, val):
        &quot;&quot;&quot;
        Make sure to update the key cache time
        &quot;&quot;&quot;
        self._key_cache_time[key] = time.time()
        self._dict.__setitem__(key, val)
        # Do the same as the parent but also persist
        self._write()

    def __delitem__(self, key):
        &quot;&quot;&quot;
        Make sure to remove the key cache time
        &quot;&quot;&quot;
        del self._key_cache_time[key]
        self._dict.__delitem__(key)
        # Do the same as the parent but also persist
        self._write()

    def clear(self):
        &quot;&quot;&quot;
        Clear the cache
        &quot;&quot;&quot;
        self._key_cache_time.clear()
        self._dict.clear()
        # Do the same as the parent but also persist
        self._write()

    def _read(self):
        &quot;&quot;&quot;
        Read in from disk
<A NAME="0"></A>        &quot;&quot;&quot;
        if not salt.utils.msgpack.HAS_MSGPACK or not os.path.exists(self._path):
            return
        with salt<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match151560-1.html#0',3,'match151560-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.utils.files.fopen(self._path, &quot;rb&quot;) as fp_:
            cache = salt.utils.data.decode(
                salt.utils.</B></FONT>msgpack.load(fp_, encoding=__salt_system_encoding__)
            )
        if &quot;CacheDisk_cachetime&quot; in cache:  # new format
            self._dict = cache[&quot;CacheDisk_data&quot;]
            self._key_cache_time = cache[&quot;CacheDisk_cachetime&quot;]
        else:  # old format
            self._dict = cache
            timestamp = os.path.getmtime(self._path)
            for key in self._dict:
                self._key_cache_time[key] = timestamp
        if log.isEnabledFor(logging.DEBUG):
            log.debug(&quot;Disk cache retrieved: %s&quot;, cache)

    def _write(self):
        &quot;&quot;&quot;
        Write out to disk
        &quot;&quot;&quot;
        if not salt.utils.msgpack.HAS_MSGPACK:
            return
        # TODO Add check into preflight to ensure dir exists
        # TODO Dir hashing?
        with salt.utils.atomicfile.atomic_open(self._path, &quot;wb+&quot;) as fp_:
            cache = {
                &quot;CacheDisk_data&quot;: self._dict,
                &quot;CacheDisk_cachetime&quot;: self._key_cache_time,
            }
            salt.utils.msgpack.dump(cache, fp_, use_bin_type=True)


class CacheCli:
    &quot;&quot;&quot;
    Connection client for the ConCache. Should be used by all
    components that need the list of currently connected minions
    &quot;&quot;&quot;

    def __init__(self, opts):
        &quot;&quot;&quot;
        Sets up the zmq-connection to the ConCache
        &quot;&quot;&quot;
        self.opts = opts
        self.cache_sock = os.path.join(self.opts[&quot;sock_dir&quot;], &quot;con_cache.ipc&quot;)
        self.cache_upd_sock = os.path.join(self.opts[&quot;sock_dir&quot;], &quot;con_upd.ipc&quot;)

        context = zmq.Context()

        # the socket for talking to the cache
        self.creq_out = context.socket(zmq.REQ)
        self.creq_out.setsockopt(zmq.LINGER, 100)
        self.creq_out.connect(&quot;ipc://&quot; + self.cache_sock)

        # the socket for sending updates to the cache
        self.cupd_out = context.socket(zmq.PUB)
        self.cupd_out.setsockopt(zmq.LINGER, 1)
        self.cupd_out.connect(&quot;ipc://&quot; + self.cache_upd_sock)

    def put_cache(self, minions):
        &quot;&quot;&quot;
        published the given minions to the ConCache
        &quot;&quot;&quot;
        self.cupd_out.send(salt.payload.dumps(minions))

    def get_cached(self):
        &quot;&quot;&quot;
        queries the ConCache for a list of currently connected minions
        &quot;&quot;&quot;
        msg = salt.payload.dumps(&quot;minions&quot;)
        self.creq_out.send(msg)
        min_list = salt.payload.loads(self.creq_out.recv())
        return min_list


class CacheRegex:
    &quot;&quot;&quot;
    Create a regular expression object cache for the most frequently
    used patterns to minimize compilation of the same patterns over
    and over again
    &quot;&quot;&quot;

    def __init__(
        self, prepend=&quot;&quot;, append=&quot;&quot;, size=1000, keep_fraction=0.8, max_age=3600
    ):
        self.prepend = prepend
        self.append = append
        self.size = size
        self.clear_size = int(size - size * (keep_fraction))
        if self.clear_size &gt;= size:
            self.clear_size = int(size / 2) + 1
            if self.clear_size &gt; size:
                self.clear_size = size
        self.max_age = max_age
        self.cache = {}
        self.timestamp = time.time()

    def clear(self):
        &quot;&quot;&quot;
        Clear the cache
        &quot;&quot;&quot;
        self.cache.clear()

    def sweep(self):
        &quot;&quot;&quot;
        Sweep the cache and remove the outdated or least frequently
        used entries
        &quot;&quot;&quot;
        if self.max_age &lt; time.time() - self.timestamp:
            self.clear()
            self.timestamp = time.time()
        else:
            paterns = list(self.cache.values())
            paterns.sort()
            for idx in range(self.clear_size):
                del self.cache[paterns[idx][2]]

    def get(self, pattern):
        &quot;&quot;&quot;
        Get a compiled regular expression object based on pattern and
        cache it when it is not in the cache already
        &quot;&quot;&quot;
        try:
            self.cache[pattern][0] += 1
            return self.cache[pattern][1]
        except KeyError:
            pass
        if len(self.cache) &gt; self.size:
            self.sweep()
        regex = re.compile(&quot;{}{}{}&quot;.format(self.prepend, pattern, self.append))
        self.cache[pattern] = [1, regex, pattern, time.time()]
        return regex


class ContextCache:
    def __init__(self, opts, name):
        &quot;&quot;&quot;
        Create a context cache
        &quot;&quot;&quot;
        self.opts = opts
        self.cache_path = os.path.join(opts[&quot;cachedir&quot;], &quot;context&quot;, &quot;{}.p&quot;.format(name))

    def cache_context(self, context):
        &quot;&quot;&quot;
        Cache the given context to disk
        &quot;&quot;&quot;
        if not os.path.isdir(os.path.dirname(self.cache_path)):
            os.mkdir(os.path.dirname(self.cache_path))
        with salt.utils.files.fopen(self.cache_path, &quot;w+b&quot;) as cache:
            salt.payload.dump(context, cache)

    def get_cache_context(self):
        &quot;&quot;&quot;
        Retrieve a context cache from disk
        &quot;&quot;&quot;
        with salt.utils.files.fopen(self.cache_path, &quot;rb&quot;) as cache:
            return salt.utils.data.decode(salt.payload.load(cache))


def context_cache(func):
    &quot;&quot;&quot;
    A decorator to be used module functions which need to cache their
    context.

    To evaluate a __context__ and re-hydrate it if a given key
    is empty or contains no items, pass a list of keys to evaulate.
    &quot;&quot;&quot;

    @functools.wraps(func)
    def context_cache_wrap(*args, **kwargs):
        try:
            func_context = func.__globals__[&quot;__context__&quot;].value()
        except AttributeError:
            func_context = func.__globals__[&quot;__context__&quot;]
        try:
            func_opts = func.__globals__[&quot;__opts__&quot;].value()
        except AttributeError:
            func_opts = func.__globals__[&quot;__opts__&quot;]
        func_name = func.__globals__[&quot;__name__&quot;]

        context_cache = ContextCache(func_opts, func_name)
        if not func_context and os.path.isfile(context_cache.cache_path):
            salt.utils.dictupdate.update(
                func_context, context_cache.get_cache_context()
            )
        else:
            context_cache.cache_context(func_context)
        return func(*args, **kwargs)

    return context_cache_wrap
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_find.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
import os
import shutil
import stat
import sys
import tempfile

import salt.utils.files
import salt.utils.find
from tests.support.runtests import RUNTIME_VARS
from tests.support.unit import TestCase, skipIf


class TestFind(TestCase):
    def test_parse_interval(self):
        self.assertRaises(ValueError, salt.utils.find._parse_interval, &quot;w&quot;)
        self.assertRaises(ValueError, salt.utils.find._parse_interval, &quot;1&quot;)
        self.assertRaises(ValueError, salt.utils.find._parse_interval, &quot;1s1w&quot;)
        self.assertRaises(ValueError, salt.utils.find._parse_interval, &quot;1s1s&quot;)

        result, resolution, modifier = salt.utils.find._parse_interval(&quot;&quot;)
        self.assertEqual(result, 0)
        self.assertIs(resolution, None)
        self.assertEqual(modifier, &quot;&quot;)

        result, resolution, modifier = salt.utils.find._parse_interval(&quot;1s&quot;)
        self.assertEqual(result, 1.0)
        self.assertEqual(resolution, 1)
        self.assertEqual(modifier, &quot;&quot;)

        result, resolution, modifier = salt.utils.find._parse_interval(&quot;1m&quot;)
        self.assertEqual(result, 60.0)
        self.assertEqual(resolution, 60)
        self.assertEqual(modifier, &quot;&quot;)

        result, resolution, modifier = salt.utils.find._parse_interval(&quot;1h&quot;)
        self.assertEqual(result, 3600.0)
        self.assertEqual(resolution, 3600)
        self.assertEqual(modifier, &quot;&quot;)

        result, resolution, modifier = salt.utils.find._parse_interval(&quot;1d&quot;)
        self.assertEqual(result, 86400.0)
        self.assertEqual(resolution, 86400)
        self.assertEqual(modifier, &quot;&quot;)

        result, resolution, modifier = salt.utils.find._parse_interval(&quot;1w&quot;)
        self.assertEqual(result, 604800.0)
        self.assertEqual(resolution, 604800)
        self.assertEqual(modifier, &quot;&quot;)

        result, resolution, modifier = salt.utils.find._parse_interval(&quot;1w3d6h&quot;)
        self.assertEqual(result, 885600.0)
        self.assertEqual(resolution, 3600)
        self.assertEqual(modifier, &quot;&quot;)

        result, resolution, modifier = salt.utils.find._parse_interval(&quot;1m1s&quot;)
        self.assertEqual(result, 61.0)
        self.assertEqual(resolution, 1)
        self.assertEqual(modifier, &quot;&quot;)

        result, resolution, modifier = salt.utils.find._parse_interval(&quot;1m2s&quot;)
        self.assertEqual(result, 62.0)
        self.assertEqual(resolution, 1)
        self.assertEqual(modifier, &quot;&quot;)

        result, resolution, modifier = salt.utils.find._parse_interval(&quot;+1d&quot;)
        self.assertEqual(result, 86400.0)
        self.assertEqual(resolution, 86400)
        self.assertEqual(modifier, &quot;+&quot;)

        result, resolution, modifier = salt.utils.find._parse_interval(&quot;-1d&quot;)
        self.assertEqual(result, 86400.0)
        self.assertEqual(resolution, 86400)
        self.assertEqual(modifier, &quot;-&quot;)

    def test_parse_size(self):
        self.assertRaises(ValueError, salt.utils.find._parse_size, &quot;&quot;)
        self.assertRaises(ValueError, salt.utils.find._parse_size, &quot;1s1s&quot;)
        min_size, max_size = salt.utils.find._parse_size(&quot;1&quot;)
        self.assertEqual(min_size, 1)
        self.assertEqual(max_size, 1)

        min_size, max_size = salt.utils.find._parse_size(&quot;1b&quot;)
        self.assertEqual(min_size, 1)
        self.assertEqual(max_size, 1)

        min_size, max_size = salt.utils.find._parse_size(&quot;1k&quot;)
        self.assertEqual(min_size, 1024)
        self.assertEqual(max_size, 2047)

        min_size, max_size = salt.utils.find._parse_size(&quot;1m&quot;)
        self.assertEqual(min_size, 1048576)
        self.assertEqual(max_size, 2097151)

        min_size, max_size = salt.utils.find._parse_size(&quot;1g&quot;)
        self.assertEqual(min_size, 1073741824)
        self.assertEqual(max_size, 2147483647)

        min_size, max_size = salt.utils.find._parse_size(&quot;1t&quot;)
        self.assertEqual(min_size, 1099511627776)
        self.assertEqual(max_size, 2199023255551)

        min_size, max_size = salt.utils.find._parse_size(&quot;0m&quot;)
        self.assertEqual(min_size, 0)
        self.assertEqual(max_size, 1048575)

        min_size, max_size = salt.utils.find._parse_size(&quot;-1m&quot;)
        self.assertEqual(min_size, 0)
        self.assertEqual(max_size, 1048576)

        min_size, max_size = salt.utils.find._parse_size(&quot;+1m&quot;)
        self.assertEqual(min_size, 1048576)
        self.assertEqual(max_size, sys.maxsize)

        min_size, max_size = salt.utils.find._parse_size(&quot;+1M&quot;)
        self.assertEqual(min_size, 1048576)
        self.assertEqual(max_size, sys.maxsize)

    def test_option_requires(self):
        option = salt.utils.find.Option()
        self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)

    def test_name_option_match(self):
        option = salt.utils.find.NameOption(&quot;name&quot;, &quot;*.txt&quot;)
        self.assertIs(option.match(&quot;&quot;, &quot;&quot;, &quot;&quot;), None)
        self.assertIs(option.match(&quot;&quot;, &quot;hello.txt&quot;, &quot;&quot;).group(), &quot;hello.txt&quot;)
        self.assertIs(option.match(&quot;&quot;, &quot;HELLO.TXT&quot;, &quot;&quot;), None)

    def test_iname_option_match(self):
        option = salt.utils.find.InameOption(&quot;name&quot;, &quot;*.txt&quot;)
        self.assertIs(option.match(&quot;&quot;, &quot;&quot;, &quot;&quot;), None)
        self.assertIs(option.match(&quot;&quot;, &quot;hello.txt&quot;, &quot;&quot;).group(), &quot;hello.txt&quot;)
        self.assertIs(option.match(&quot;&quot;, &quot;HELLO.TXT&quot;, &quot;&quot;).group(), &quot;HELLO.TXT&quot;)

    def test_regex_option_match(self):
        self.assertRaises(ValueError, salt.utils.find.RegexOption, &quot;name&quot;, &quot;(.*}&quot;)

        option = salt.utils.find.RegexOption(&quot;name&quot;, r&quot;.*\.txt&quot;)
        self.assertIs(option.match(&quot;&quot;, &quot;&quot;, &quot;&quot;), None)
        self.assertIs(option.match(&quot;&quot;, &quot;hello.txt&quot;, &quot;&quot;).group(), &quot;hello.txt&quot;)
        self.assertIs(option.match(&quot;&quot;, &quot;HELLO.TXT&quot;, &quot;&quot;), None)

    def test_iregex_option_match(self):
        self.assertRaises(ValueError, salt.utils.find.IregexOption, &quot;name&quot;, &quot;(.*}&quot;)

        option = salt.utils.find.IregexOption(&quot;name&quot;, r&quot;.*\.txt&quot;)
        self.assertIs(option.match(&quot;&quot;, &quot;&quot;, &quot;&quot;), None)
        self.assertIs(option.match(&quot;&quot;, &quot;hello.txt&quot;, &quot;&quot;).group(), &quot;hello.txt&quot;)
        self.assertIs(option.match(&quot;&quot;, &quot;HELLO.TXT&quot;, &quot;&quot;).group(), &quot;HELLO.TXT&quot;)

    def test_type_option_requires(self):
        self.assertRaises(ValueError, salt.utils.find.TypeOption, &quot;type&quot;, &quot;w&quot;)

        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;d&quot;)
        self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)

    def test_type_option_match(self):
        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;b&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [stat.S_IFREG]), False)

        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;c&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [stat.S_IFREG]), False)

        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;d&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [stat.S_IFREG]), False)

        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;f&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [stat.S_IFREG]), True)

        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;l&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [stat.S_IFREG]), False)

        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;p&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [stat.S_IFREG]), False)

        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;s&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [stat.S_IFREG]), False)

        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;b&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [stat.S_IFBLK]), True)

        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;c&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [stat.S_IFCHR]), True)

        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;d&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [stat.S_IFDIR]), True)

        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;l&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [stat.S_IFLNK]), True)

        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;p&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [stat.S_IFIFO]), True)

        option = salt.utils.find.TypeOption(&quot;type&quot;, &quot;s&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [stat.S_IFSOCK]), True)

    @skipIf(sys.platform.startswith(&quot;win&quot;), &quot;pwd not available on Windows&quot;)
    def test_owner_option_requires(self):
        self.assertRaises(ValueError, salt.utils.find.OwnerOption, &quot;owner&quot;, &quot;notexist&quot;)

        option = salt.utils.find.OwnerOption(&quot;owner&quot;, &quot;root&quot;)
        self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)

    @skipIf(sys.platform.startswith(&quot;win&quot;), &quot;pwd not available on Windows&quot;)
    def test_owner_option_match(self):
        option = salt.utils.find.OwnerOption(&quot;owner&quot;, &quot;root&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [0] * 5), True)

        option = salt.utils.find.OwnerOption(&quot;owner&quot;, &quot;500&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [500] * 5), True)

    @skipIf(sys.platform.startswith(&quot;win&quot;), &quot;grp not available on Windows&quot;)
    def test_group_option_requires(self):
        self.assertRaises(ValueError, salt.utils.find.GroupOption, &quot;group&quot;, &quot;notexist&quot;)

        if sys.platform.startswith((&quot;darwin&quot;, &quot;freebsd&quot;, &quot;openbsd&quot;)):
            group_name = &quot;wheel&quot;
        else:
            group_name = &quot;root&quot;
        option = salt.utils.find.GroupOption(&quot;group&quot;, group_name)
        self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)

    @skipIf(sys.platform.startswith(&quot;win&quot;), &quot;grp not available on Windows&quot;)
    def test_group_option_match(self):
        if sys.platform.startswith((&quot;darwin&quot;, &quot;freebsd&quot;, &quot;openbsd&quot;)):
            group_name = &quot;wheel&quot;
        else:
            group_name = &quot;root&quot;
        option = salt.utils.find.GroupOption(&quot;group&quot;, group_name)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [0] * 6), True)

        option = salt.utils.find.GroupOption(&quot;group&quot;, &quot;500&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [500] * 6), True)

    def test_size_option_requires(self):
        self.assertRaises(ValueError, salt.utils.find.SizeOption, &quot;size&quot;, &quot;1s1s&quot;)

        option = salt.utils.find.SizeOption(&quot;size&quot;, &quot;+1G&quot;)
        self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)

    def test_size_option_match(self):
        option = salt.utils.find.SizeOption(&quot;size&quot;, &quot;+1k&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [10000] * 7), True)

        option = salt.utils.find.SizeOption(&quot;size&quot;, &quot;+1G&quot;)
        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [10000] * 7), False)

    def test_mtime_option_requires(self):
        self.assertRaises(ValueError, salt.utils.find.MtimeOption, &quot;mtime&quot;, &quot;4g&quot;)

        option = salt.utils.find.MtimeOption(&quot;mtime&quot;, &quot;1d&quot;)
        self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)

    def test_mtime_option_match(self):
        option = salt.utils.find.MtimeOption(&quot;mtime&quot;, &quot;-1w&quot;)
<A NAME="1"></A>        self.assertEqual(option.match(&quot;&quot;, &quot;&quot;, [1] * 9), False)

        option = salt.utils.find.MtimeOption(&quot;mtime&quot;, &quot;-1s&quot;)
        self.assertEqual(option<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match151560-0.html#1',2,'match151560-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.match(&quot;&quot;, &quot;&quot;, [10 ** 10] * 9), True)


class TestGrepOption(TestCase):
    def setUp(self):
        super().setUp()
        self.tmpdir = tempfile.</B></FONT>mkdtemp(dir=RUNTIME_VARS.TMP)

    def tearDown(self):
        shutil.rmtree(self.tmpdir)
        super().tearDown()

    def test_grep_option_requires(self):
        self.assertRaises(ValueError, salt.utils.find.GrepOption, &quot;grep&quot;, &quot;(foo)|(bar}&quot;)

        option = salt.utils.find.GrepOption(&quot;grep&quot;, &quot;(foo)|(bar)&quot;)
        find = salt.utils.find
        self.assertEqual(
            option.requires(), (find._REQUIRES_CONTENTS | find._REQUIRES_STAT)
        )

    def test_grep_option_match_regular_file(self):
        hello_file = os.path.join(self.tmpdir, &quot;hello.txt&quot;)
        with salt.utils.files.fopen(hello_file, &quot;w&quot;) as fp_:
            fp_.write(salt.utils.stringutils.to_str(&quot;foo&quot;))
        option = salt.utils.find.GrepOption(&quot;grep&quot;, &quot;foo&quot;)
        self.assertEqual(
            option.match(self.tmpdir, &quot;hello.txt&quot;, os.stat(hello_file)), hello_file
        )

        option = salt.utils.find.GrepOption(&quot;grep&quot;, &quot;bar&quot;)
        self.assertEqual(
            option.match(self.tmpdir, &quot;hello.txt&quot;, os.stat(hello_file)), None
        )

    @skipIf(sys.platform.startswith(&quot;win&quot;), &quot;No /dev/null on Windows&quot;)
    def test_grep_option_match_dev_null(self):
        option = salt.utils.find.GrepOption(&quot;grep&quot;, &quot;foo&quot;)
        self.assertEqual(option.match(&quot;dev&quot;, &quot;null&quot;, os.stat(&quot;/dev/null&quot;)), None)


class TestPrintOption(TestCase):
    def setUp(self):
        super().setUp()
        self.tmpdir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)

    def tearDown(self):
        shutil.rmtree(self.tmpdir)
        super().tearDown()

    def test_print_option_defaults(self):
        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;&quot;)
        self.assertEqual(option.need_stat, False)
        self.assertEqual(option.print_title, False)
        self.assertEqual(option.fmt, [&quot;path&quot;])

    def test_print_option_requires(self):
        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;&quot;)
        self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;name&quot;)
        self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;path&quot;)
        self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;name,path&quot;)
        self.assertEqual(option.requires(), salt.utils.find._REQUIRES_PATH)

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;user&quot;)
        self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;path user&quot;)
        self.assertEqual(option.requires(), salt.utils.find._REQUIRES_STAT)

    def test_print_option_execute(self):
        hello_file = os.path.join(self.tmpdir, &quot;hello.txt&quot;)
        with salt.utils.files.fopen(hello_file, &quot;w&quot;) as fp_:
            fp_.write(salt.utils.stringutils.to_str(&quot;foo&quot;))

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;&quot;)
        self.assertEqual(option.execute(&quot;&quot;, [0] * 9), &quot;&quot;)

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;path&quot;)
        self.assertEqual(option.execute(&quot;test_name&quot;, [0] * 9), &quot;test_name&quot;)

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;name&quot;)
        self.assertEqual(option.execute(&quot;test_name&quot;, [0] * 9), &quot;test_name&quot;)

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;size&quot;)
        self.assertEqual(option.execute(hello_file, os.stat(hello_file)), 3)

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;type&quot;)
        self.assertEqual(option.execute(hello_file, os.stat(hello_file)), &quot;f&quot;)

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;mode&quot;)
        self.assertEqual(option.execute(hello_file, range(10)), 0)

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;mtime&quot;)
        self.assertEqual(option.execute(hello_file, range(10)), 8)

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;md5&quot;)
        self.assertEqual(
            option.execute(hello_file, os.stat(hello_file)),
            &quot;acbd18db4cc2f85cedef654fccc4a4d8&quot;,
        )

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;path name&quot;)
        self.assertEqual(
            option.execute(&quot;test_name&quot;, [0] * 9), [&quot;test_name&quot;, &quot;test_name&quot;]
        )

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;size name&quot;)
        self.assertEqual(option.execute(&quot;test_name&quot;, [0] * 9), [0, &quot;test_name&quot;])

    @skipIf(sys.platform.startswith(&quot;win&quot;), &quot;pwd not available on Windows&quot;)
    def test_print_user(self):
        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;user&quot;)
        self.assertEqual(option.execute(&quot;&quot;, [0] * 10), &quot;root&quot;)

        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;user&quot;)
        self.assertEqual(option.execute(&quot;&quot;, [2 ** 31] * 10), 2 ** 31)

    @skipIf(sys.platform.startswith(&quot;win&quot;), &quot;grp not available on Windows&quot;)
    def test_print_group(self):
        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;group&quot;)
        if sys.platform.startswith((&quot;darwin&quot;, &quot;freebsd&quot;, &quot;openbsd&quot;)):
            group_name = &quot;wheel&quot;
        else:
            group_name = &quot;root&quot;
        self.assertEqual(option.execute(&quot;&quot;, [0] * 10), group_name)

        # This seems to be not working in Ubuntu 12.04 32 bit
        # option = salt.utils.find.PrintOption('print', 'group')
        # self.assertEqual(option.execute('', [2 ** 31] * 10), 2 ** 31)

    @skipIf(sys.platform.startswith(&quot;win&quot;), &quot;no /dev/null on windows&quot;)
    def test_print_md5(self):
        option = salt.utils.find.PrintOption(&quot;print&quot;, &quot;md5&quot;)
        self.assertEqual(option.execute(&quot;/dev/null&quot;, os.stat(&quot;/dev/null&quot;)), &quot;&quot;)


class TestFinder(TestCase):
    def setUp(self):
        super().setUp()
        self.tmpdir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)

    def tearDown(self):
        shutil.rmtree(self.tmpdir)
        super().tearDown()

<A NAME="0"></A>    @skipIf(sys.platform.startswith(&quot;win&quot;), &quot;No /dev/null on Windows&quot;)
    def test_init(self):
        finder = salt.utils.find.Finder({})
        self.assertEqual(str(finder.actions[0]<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match151560-0.html#0',2,'match151560-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.__class__)[-13:-2], &quot;PrintOption&quot;)
        self.assertEqual(finder.criteria, [])

        finder = salt.utils.find.Finder({&quot;_&quot;: None})
        self.</B></FONT>assertEqual(str(finder.actions[0].__class__)[-13:-2], &quot;PrintOption&quot;)
        self.assertEqual(finder.criteria, [])

        self.assertRaises(ValueError, salt.utils.find.Finder, {&quot;&quot;: None})
        self.assertRaises(ValueError, salt.utils.find.Finder, {&quot;name&quot;: None})
        self.assertRaises(ValueError, salt.utils.find.Finder, {&quot;nonexist&quot;: &quot;somevalue&quot;})

        finder = salt.utils.find.Finder({&quot;name&quot;: &quot;test_name&quot;})
        self.assertEqual(str(finder.actions[0].__class__)[-13:-2], &quot;PrintOption&quot;)
        self.assertEqual(str(finder.criteria[0].__class__)[-12:-2], &quot;NameOption&quot;)

        finder = salt.utils.find.Finder({&quot;iname&quot;: &quot;test_name&quot;})
        self.assertEqual(str(finder.actions[0].__class__)[-13:-2], &quot;PrintOption&quot;)
        self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], &quot;InameOption&quot;)

        finder = salt.utils.find.Finder({&quot;regex&quot;: r&quot;.*\.txt&quot;})
        self.assertEqual(str(finder.actions[0].__class__)[-13:-2], &quot;PrintOption&quot;)
        self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], &quot;RegexOption&quot;)

        finder = salt.utils.find.Finder({&quot;iregex&quot;: r&quot;.*\.txt&quot;})
        self.assertEqual(str(finder.actions[0].__class__)[-13:-2], &quot;PrintOption&quot;)
        self.assertEqual(str(finder.criteria[0].__class__)[-14:-2], &quot;IregexOption&quot;)

        finder = salt.utils.find.Finder({&quot;type&quot;: &quot;d&quot;})
        self.assertEqual(str(finder.actions[0].__class__)[-13:-2], &quot;PrintOption&quot;)
        self.assertEqual(str(finder.criteria[0].__class__)[-12:-2], &quot;TypeOption&quot;)

        finder = salt.utils.find.Finder({&quot;owner&quot;: &quot;root&quot;})
        self.assertEqual(str(finder.actions[0].__class__)[-13:-2], &quot;PrintOption&quot;)
        self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], &quot;OwnerOption&quot;)

        if sys.platform.startswith((&quot;darwin&quot;, &quot;freebsd&quot;, &quot;openbsd&quot;)):
            group_name = &quot;wheel&quot;
        else:
            group_name = &quot;root&quot;
        finder = salt.utils.find.Finder({&quot;group&quot;: group_name})
        self.assertEqual(str(finder.actions[0].__class__)[-13:-2], &quot;PrintOption&quot;)
        self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], &quot;GroupOption&quot;)

        finder = salt.utils.find.Finder({&quot;size&quot;: &quot;+1G&quot;})
        self.assertEqual(str(finder.actions[0].__class__)[-13:-2], &quot;PrintOption&quot;)
        self.assertEqual(str(finder.criteria[0].__class__)[-12:-2], &quot;SizeOption&quot;)

        finder = salt.utils.find.Finder({&quot;mtime&quot;: &quot;1d&quot;})
        self.assertEqual(str(finder.actions[0].__class__)[-13:-2], &quot;PrintOption&quot;)
        self.assertEqual(str(finder.criteria[0].__class__)[-13:-2], &quot;MtimeOption&quot;)

        finder = salt.utils.find.Finder({&quot;grep&quot;: &quot;foo&quot;})
        self.assertEqual(str(finder.actions[0].__class__)[-13:-2], &quot;PrintOption&quot;)
        self.assertEqual(str(finder.criteria[0].__class__)[-12:-2], &quot;GrepOption&quot;)

        finder = salt.utils.find.Finder({&quot;print&quot;: &quot;name&quot;})
        self.assertEqual(str(finder.actions[0].__class__)[-13:-2], &quot;PrintOption&quot;)
        self.assertEqual(finder.criteria, [])

    def test_find(self):
        hello_file = os.path.join(self.tmpdir, &quot;hello.txt&quot;)
        with salt.utils.files.fopen(hello_file, &quot;w&quot;) as fp_:
            fp_.write(salt.utils.stringutils.to_str(&quot;foo&quot;))

        finder = salt.utils.find.Finder({})
        self.assertEqual(list(finder.find(self.tmpdir)), [self.tmpdir, hello_file])

        finder = salt.utils.find.Finder({&quot;mindepth&quot;: 1})
        self.assertEqual(list(finder.find(self.tmpdir)), [hello_file])

        finder = salt.utils.find.Finder({&quot;maxdepth&quot;: 0})
        self.assertEqual(list(finder.find(self.tmpdir)), [self.tmpdir])

        finder = salt.utils.find.Finder({&quot;name&quot;: &quot;hello.txt&quot;})
        self.assertEqual(list(finder.find(self.tmpdir)), [hello_file])

        finder = salt.utils.find.Finder({&quot;type&quot;: &quot;f&quot;, &quot;print&quot;: &quot;path&quot;})
        self.assertEqual(list(finder.find(self.tmpdir)), [hello_file])

        finder = salt.utils.find.Finder({&quot;size&quot;: &quot;+1G&quot;, &quot;print&quot;: &quot;path&quot;})
        self.assertEqual(list(finder.find(self.tmpdir)), [])

        finder = salt.utils.find.Finder({&quot;name&quot;: &quot;hello.txt&quot;, &quot;print&quot;: &quot;path name&quot;})
        self.assertEqual(list(finder.find(self.tmpdir)), [[hello_file, &quot;hello.txt&quot;]])

        finder = salt.utils.find.Finder({&quot;name&quot;: &quot;test_name&quot;})
        self.assertEqual(list(finder.find(&quot;&quot;)), [])
</PRE>
</div>
  </div>
</body>
</html>
