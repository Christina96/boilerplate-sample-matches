<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for boto_vpc.py &amp; boto_iam.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for boto_vpc.py &amp; boto_iam.py
      </h3>
<h1 align="center">
        20.7%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>boto_vpc.py (24.013159%)<th>boto_iam.py (18.263044%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(296-305)<td><a href="#" name="0">(1885-1895)</a><td align="center"><font color="#ff0000">24</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(980-991)<td><a href="#" name="1">(2022-2029)</a><td align="center"><font color="#f40000">23</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(509-520)<td><a href="#" name="2">(1626-1636)</a><td align="center"><font color="#f40000">23</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(310-323)<td><a href="#" name="3">(1919-1953)</a><td align="center"><font color="#e90000">22</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(1632-1644)<td><a href="#" name="4">(1826-1838)</a><td align="center"><font color="#df0000">21</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(1504-1535)<td><a href="#" name="5">(878-887)</a><td align="center"><font color="#df0000">21</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(230-241)<td><a href="#" name="6">(1121-1131)</a><td align="center"><font color="#c90000">19</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(1125-1128)<td><a href="#" name="7">(1018-1021)</a><td align="center"><font color="#bf0000">18</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(1109-1112)<td><a href="#" name="8">(676-679)</a><td align="center"><font color="#bf0000">18</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(465-504)<td><a href="#" name="9">(1448-1454)</a><td align="center"><font color="#bf0000">18</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(1545-1552)<td><a href="#" name="10">(428-434)</a><td align="center"><font color="#b40000">17</font>
<tr onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b041ff"><font color="#b041ff">-</font><td><a href="#" name="11">(823-830)<td><a href="#" name="11">(846-852)</a><td align="center"><font color="#b40000">17</font>
<tr onclick='openModal("#571b7e")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#571b7e"><font color="#571b7e">-</font><td><a href="#" name="12">(532-602)<td><a href="#" name="12">(1482-1499)</a><td align="center"><font color="#b40000">17</font>
<tr onclick='openModal("#3b9c9c")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3b9c9c"><font color="#3b9c9c">-</font><td><a href="#" name="13">(431-440)<td><a href="#" name="13">(1971-1981)</a><td align="center"><font color="#b40000">17</font>
<tr onclick='openModal("#842dce")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#842dce"><font color="#842dce">-</font><td><a href="#" name="14">(160-180)<td><a href="#" name="14">(153-207)</a><td align="center"><font color="#b40000">17</font>
<tr onclick='openModal("#f52887")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f52887"><font color="#f52887">-</font><td><a href="#" name="15">(1834-1845)<td><a href="#" name="15">(261-272)</a><td align="center"><font color="#aa0000">16</font>
<tr onclick='openModal("#2981b2")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#2981b2"><font color="#2981b2">-</font><td><a href="#" name="16">(1093-1097)<td><a href="#" name="16">(334-338)</a><td align="center"><font color="#aa0000">16</font>
<tr onclick='openModal("#3090c7")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3090c7"><font color="#3090c7">-</font><td><a href="#" name="17">(1004-1080)<td><a href="#" name="17">(1040-1105)</a><td align="center"><font color="#9f0000">15</font>
<tr onclick='openModal("#800517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#800517"><font color="#800517">-</font><td><a href="#" name="18">(670-675)<td><a href="#" name="18">(555-562)</a><td align="center"><font color="#9f0000">15</font>
<tr onclick='openModal("#f62817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f62817"><font color="#f62817">-</font><td><a href="#" name="19">(261-288)<td><a href="#" name="19">(1406-1411)</a><td align="center"><font color="#9f0000">15</font>
<tr onclick='openModal("#4e9258")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4e9258"><font color="#4e9258">-</font><td><a href="#" name="20">(936-969)<td><a href="#" name="20">(841-844)</a><td align="center"><font color="#940000">14</font>
<tr onclick='openModal("#947010")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#947010"><font color="#947010">-</font><td><a href="#" name="21">(844-856)<td><a href="#" name="21">(1734-1779)</a><td align="center"><font color="#940000">14</font>
<tr onclick='openModal("#4cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4cc417"><font color="#4cc417">-</font><td><a href="#" name="22">(787-815)<td><a href="#" name="22">(1643-1691)</a><td align="center"><font color="#940000">14</font>
<tr onclick='openModal("#f660ab")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f660ab"><font color="#f660ab">-</font><td><a href="#" name="23">(1391-1405)<td><a href="#" name="23">(583-640)</a><td align="center"><font color="#8a0000">13</font>
<tr onclick='openModal("#79764d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#79764d"><font color="#79764d">-</font><td><a href="#" name="24">(1196-1204)<td><a href="#" name="24">(1992-2019)</a><td align="center"><font color="#8a0000">13</font>
<tr onclick='openModal("#5eac10")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#5eac10"><font color="#5eac10">-</font><td><a href="#" name="25">(1139-1150)<td><a href="#" name="25">(1857-1883)</a><td align="center"><font color="#8a0000">13</font>
<tr onclick='openModal("#68818b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#68818b"><font color="#68818b">-</font><td><a href="#" name="26">(906-910)<td><a href="#" name="26">(651-655)</a><td align="center"><font color="#8a0000">13</font>
<tr onclick='openModal("#e77471")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#e77471"><font color="#e77471">-</font><td><a href="#" name="27">(1719-1725)<td><a href="#" name="27">(1576-1581)</a><td align="center"><font color="#7f0000">12</font>
<tr onclick='openModal("#717d7d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#717d7d"><font color="#717d7d">-</font><td><a href="#" name="28">(890-900)<td><a href="#" name="28">(289-297)</a><td align="center"><font color="#7f0000">12</font>
<tr onclick='openModal("#af7a82")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#af7a82"><font color="#af7a82">-</font><td><a href="#" name="29">(739-743)<td><a href="#" name="29">(666-667)</a><td align="center"><font color="#7f0000">12</font>
<tr onclick='openModal("#ae694a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ae694a"><font color="#ae694a">-</font><td><a href="#" name="30">(629-640)<td><a href="#" name="30">(536-539)</a><td align="center"><font color="#7f0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>boto_vpc.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import salt.utils.dictupdate as dictupdate
3 __virtualname__ = "boto_vpc"
4 log = logging.getLogger(__name__)
5 def __virtual__():
6     <font color="#842dce"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>if "boto_vpc.exists" in __salt__:
7         return __virtualname__
8     else:
9         return (
10             False,
11             "The following libraries are required to run the boto_vpc state module: "
12             "boto &gt;= {} and boto3 &gt;= {}.".format(boto_version, boto3_version),
13         )
14 def present(
15     name,
16     cidr_block,
17     instance_tenancy=None,
18     dns_support=None,
19     dns_hostnames=None,
20     tags=None,
21     region=None,
22     key=None,
23     keyid=None,
24     profile=</b></font>None,
25 ):
26     ret = {"name": name, "result": True, "comment": "", "changes": {}}
27     r = __salt__["boto_vpc.exists"](
28         name=name, tags=tags, region=region, key=key, keyid=keyid, profile=profile
29     )
30     if "error" in r:
31         ret["result"] = False
32         ret["comment"] = "Failed to create VPC: {}.".format(r["error"]["message"])
33 <a name="6"></a>        return ret
34     if not r.get("exists"):
35         <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>if __opts__["test"]:
36             ret["comment"] = "VPC {} is set to be created.".format(name)
37             ret["result"] = None
38             return ret
39         r = __salt__["boto_vpc.create"](
40             cidr_block,
41             instance_tenancy=instance_tenancy,
42             vpc_name=name,
43             enable_dns_support=dns_support,
44             enable_dns_hostnames=dns_hostnames,
45             tags=tags,
46             region=</b></font>region,
47             key=key,
48             keyid=keyid,
49             profile=profile,
50         )
51         if not r.get("created"):
52             ret["result"] = False
53             ret["comment"] = "Error in creating VPC: {}.".format(r["error"]["message"])
54             return ret
55         _describe = __salt__["boto_vpc.describe"](
56             vpc_id=r["id"], region=region, key=key, keyid=keyid, profile=profile
57         )
58         ret["changes"]["old"] = {"vpc": None}
59         ret["changes"]["new"] = _describe
60         ret["comment"] = "VPC {} created.".format(name)
61         return ret
62     ret["comment"] = "VPC present."
63 <a name="19"></a>    return ret
64 def absent(name, tags=None, region<font color="#f62817"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=None, key=None, keyid=None, profile=None):
65     ret = {"name": name, "result": True, "comment": "", "changes": {}}
66     r = __salt__["boto_vpc.get_id"](
67         name=name, tags=tags, region=region, key=key, keyid=keyid, profile=</b></font>profile
68     )
69     if "error" in r:
70         ret["result"] = False
71         ret["comment"] = "Failed to delete VPC: {}.".format(r["error"]["message"])
72 <a name="0"></a>        return ret
73     _id = r.get("id")
74     <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>if not _id:
75         ret["comment"] = "{} VPC does not exist.".format(name)
76         return ret
77     if __opts__["test"]:
78         ret["comment"] = "VPC {} is set to be removed.".format(name)
79         ret["result"] = None
80         return ret
81     r = __salt__["boto_vpc.delete"](
82         vpc_name=name, tags=tags, region=region, key=</b></font>key, keyid=keyid, profile=profile
83     )
84 <a name="3"></a>    if not r["deleted"]:
85         ret["result"] = False
86         ret["comment"] = "Failed to delete VPC: {}.".format(r["error"]["message"])
87         <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>return ret
88     ret["changes"]["old"] = {"vpc": _id}
89     ret["changes"]["new"] = {"vpc": None}
90     ret["comment"] = "VPC {} deleted.".format(name)
91     return ret
92 def dhcp_options_present(
93     name,
94     dhcp_options_id=None,
95     vpc_name=None,
96     vpc_id=None,
97     domain_name=None,
98     domain_name_servers=</b></font>None,
99     ntp_servers=None,
100     netbios_name_servers=None,
101     netbios_node_type=None,
102     tags=None,
103     region=None,
104     key=None,
105     keyid=None,
106     profile=None,
107 ):
108     ret = {"name": name, "result": True, "comment": "", "changes": {}}
109     _new = {
110         "domain_name": domain_name,
111         "domain_name_servers": domain_name_servers,
112         "ntp_servers": ntp_servers,
113         "netbios_name_servers": netbios_name_servers,
114         "netbios_node_type": netbios_node_type,
115     }
116     r = __salt__["boto_vpc.dhcp_options_exists"](
117         dhcp_options_id=dhcp_options_id,
118         dhcp_options_name=name,
119         region=region,
120         key=key,
121         keyid=keyid,
122         profile=profile,
123     )
124     if "error" in r:
125         ret["result"] = False
126         ret["comment"] = "Failed to validate DHCP options: {}.".format(
127             r["error"]["message"]
128         )
129         return ret
130     if r.get("exists"):
131 <a name="13"></a>        ret["comment"] = "DHCP options already present."
132         return ret
133     else:
134         <font color="#3b9c9c"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>if __opts__["test"]:
135             ret["comment"] = "DHCP options {} are set to be created.".format(name)
136             ret["result"] = None
137             return ret
138         r = __salt__["boto_vpc.create_dhcp_options"](
139             domain_name=domain_name,
140             domain_name_servers=domain_name_servers,
141             ntp_servers=ntp_servers,
142             netbios_name_servers=</b></font>netbios_name_servers,
143             netbios_node_type=netbios_node_type,
144             dhcp_options_name=name,
145             tags=tags,
146             vpc_id=vpc_id,
147             vpc_name=vpc_name,
148             region=region,
149             key=key,
150             keyid=keyid,
151             profile=profile,
152         )
153         if not r.get("created"):
154             ret["result"] = False
155             ret["comment"] = "Failed to create DHCP options: {}".format(
156                 r["error"]["message"]
157             )
158             return ret
159         ret["changes"]["old"] = {"dhcp_options": None}
160         ret["changes"]["new"] = {"dhcp_options": _new}
161         ret["comment"] = "DHCP options {} created.".format(name)
162         return ret
163 <a name="9"></a>
164 def dhcp_options_absent(
165     name=None, dhcp_options_id=None, region<font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=None, key=None, keyid=None, profile=None
166 ):
167     ret = {"name": name, "result": True, "comment": "", "changes": {}}
168     r = __salt__["boto_vpc.get_resource_id"](
169         "dhcp_options", name=name, region=region, key=key, keyid=keyid, profile=profile
170     )
171     if "error" in r:
172         ret["result"] = False
173         ret[</b></font>"comment"] = "Failed to delete DHCP options: {}.".format(
174             r["error"]["message"]
175 <a name="2"></a>        )
176         return ret
177     _id <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= r.get("id")
178     if not _id:
179         ret["comment"] = "DHCP options {} do not exist.".format(name)
180         return ret
181     if __opts__["test"]:
182         ret["comment"] = "DHCP options {} are set to be deleted.".format(name)
183         ret["result"] = None
184         return ret
185     r = __salt__["boto_vpc.delete_dhcp_options"](</b></font>
186         dhcp_options_id=r["id"], region=region, key=key, keyid=keyid, profile=profile
187     )
188     if not r.get("deleted"):
189         ret["result"] = False
190         ret["comment"] = "Failed to delete DHCP options: {}".format(
191             r["error"]["message"]
192         )
193         return ret
194 <a name="12"></a>
195     ret["changes"]["old"] = {"dhcp_options": _id}
196     ret["changes"]["new"] = {"dhcp_options": None}
197     ret["comment"] = "DHCP options {} deleted."<font color="#571b7e"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.format(name)
198     return ret
199 def subnet_present(
200     name,
201     cidr_block,
202     vpc_name=None,
203     vpc_id=None,
204     availability_zone=None,
205     tags=None,
206     region=None,
207     key=None,
208     keyid=None,
209     profile=None,
210     route_table_id=None,
211     route_table_name=None,
212     auto_assign_public_ipv4=False,
213 ):
214     ret =</b></font> {"name": name, "result": True, "comment": "", "changes": {}}
215     r = __salt__["boto_vpc.subnet_exists"](
216         subnet_name=name,
217         tags=tags,
218         region=region,
219         key=key,
220         keyid=keyid,
221         profile=profile,
222     )
223     if "error" in r:
224         ret["result"] = False
225         ret["comment"] = "Failed to create subnet: {}.".format(r["error"]["message"])
226         return ret
227     route_table_desc = None
228     _describe = None
229     rtid = None
230     if route_table_id or route_table_name:
231         rt = None
232         route_table_found = False
233         if route_table_id:
234             rtid = route_table_id
235 <a name="30"></a>            rt = __salt__["boto_vpc.route_table_exists"](
236                 route_table_id=route_table_id,
237                 region=region,
238                 key<font color="#ae694a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=key,
239                 keyid=keyid,
240                 profile=profile,
241             )
242         elif route_table_name:
243             rtid = route_table_name
244             rt = __salt__["boto_vpc.route_table_exists"](
245                 route_table_name=route_table_name,
246                 region=region,
247                 key=key,
248                 keyid=keyid,
249                 profile=</b></font>profile,
250             )
251         if rt:
252             if "exists" in rt:
253                 if rt["exists"]:
254                     if route_table_id:
255                         route_table_found = True
256                         route_table_desc = __salt__["boto_vpc.describe_route_tables"](
257                             route_table_id=route_table_id,
258                             region=region,
259                             key=key,
260                             keyid=keyid,
261                             profile=profile,
262                         )
263                     elif route_table_name:
264                         route_table_found = True
265                         route_table_desc = __salt__["boto_vpc.describe_route_tables"](
266                             route_table_name=route_table_name,
267                             region=region,
268                             key=key,
269                             keyid=keyid,
270                             profile=profile,
271                         )
272         if not route_table_found:
273             ret["result"] = False
274             ret["comment"] = "The specified route table {} could not be found.".format(
275                 rtid
276 <a name="18"></a>            )
277             return ret
278     if not r<font color="#800517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.get("exists"):
279         if __opts__["test"]:
280             ret["comment"] = "Subnet {} is set to be created.".format(name)
281             ret["result"] = None
282             return ret
283         r = __salt__["boto_vpc.create_subnet"](</b></font>
284             subnet_name=name,
285             cidr_block=cidr_block,
286             availability_zone=availability_zone,
287             auto_assign_public_ipv4=auto_assign_public_ipv4,
288             vpc_name=vpc_name,
289             vpc_id=vpc_id,
290             tags=tags,
291             region=region,
292             key=key,
293             keyid=keyid,
294             profile=profile,
295         )
296         if not r.get("created"):
297             ret["result"] = False
298             ret["comment"] = "Failed to create subnet: {}".format(r["error"]["message"])
299             return ret
300         _describe = __salt__["boto_vpc.describe_subnet"](
301             subnet_id=r["id"], region=region, key=key, keyid=keyid, profile=profile
302         )
303         ret["changes"]["old"] = {"subnet": None}
304         ret["changes"]["new"] = _describe
305         ret["comment"] = "Subnet {} created.".format(name)
306     else:
307         ret["comment"] = "Subnet present."
308     if route_table_desc:
309         if not _describe:
310             _describe = __salt__["boto_vpc.describe_subnet"](
311                 subnet_name=name, region=region, key=key, keyid=keyid, profile=profile
312             )
313         if not _verify_subnet_association(route_table_desc, _describe["subnet"]["id"]):
314             if __opts__["test"]:
315                 msg = "Subnet is set to be associated with route table {}".format(rtid)
316                 ret["comment"] = " ".join([ret["comment"], msg])
317                 ret["result"] = None
318                 return ret
319             if "explicit_route_table_association_id" in _describe["subnet"]:
320                 log.debug("Need to disassociate from existing route table")
321                 drt_ret = __salt__["boto_vpc.disassociate_route_table"](
322                     _describe["subnet"]["explicit_route_table_association_id"],
323                     region=region,
324                     key=key,
325                     keyid=keyid,
326                     profile=profile,
327                 )
328                 if not drt_ret["disassociated"]:
329                     msg = "Unable to disassociate subnet {} with its current route table.".format(
330                         name
331                     )
332                     ret["comment"] = " ".join([ret["comment"], msg])
333                     ret["result"] = False
334                     return ret
335             if "old" not in ret["changes"]:
336                 ret["changes"]["old"] = _describe
337             art_ret = __salt__["boto_vpc.associate_route_table"](
338                 route_table_id=route_table_desc["id"],
339                 subnet_name=name,
340                 region=region,
341                 key=key,
342                 keyid=keyid,
343 <a name="29"></a>                profile=profile,
344             )
345             if "error" in art_ret:
346                 msg <font color="#af7a82"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= "Failed to associate subnet {} with route table {}: {}.".format(
347                     name, rtid, art_ret["error"]["message"]
348                 )
349                 ret["comment"] = " ".join([ret["comment"], msg])
350                 ret[</b></font>"result"] = False
351                 return ret
352             else:
353                 msg = "Subnet successfully associated with route table {}.".format(rtid)
354                 ret["comment"] = " ".join([ret["comment"], msg])
355                 if "new" not in ret["changes"]:
356                     ret["changes"]["new"] = __salt__["boto_vpc.describe_subnet"](
357                         subnet_name=name,
358                         region=region,
359                         key=key,
360                         keyid=keyid,
361                         profile=profile,
362                     )
363                 else:
364                     ret["changes"]["new"]["subnet"][
365                         "explicit_route_table_association_id"
366                     ] = art_ret["association_id"]
367         else:
368             ret["comment"] = " ".join(
369                 [
370                     ret["comment"],
371                     "Subnet is already associated with route table {}".format(rtid),
372                 ]
373             )
374     return ret
375 def _verify_subnet_association(route_table_desc, subnet_id):
376     if route_table_desc:
377         if "associations" in route_table_desc:
378 <a name="22"></a>            for association in route_table_desc["associations"]:
379                 if association["subnet_id"] == subnet_id:
380                     return True
381     <font color="#4cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>return False
382 def subnet_absent(
383     name=None, subnet_id=None, region=None, key=None, keyid=None, profile=None
384 ):
385     ret = {"name": name, "result": True, "comment": "", "changes": {}}
386     r = __salt__["boto_vpc.get_resource_id"](</b></font>
387         "subnet", name=name, region=region, key=key, keyid=keyid, profile=profile
388     )
389     if "error" in r:
390         ret["result"] = False
391 <a name="11"></a>        ret["comment"] = "Failed to delete subnet: {}.".format(r["error"]["message"])
392         return ret
393     _id <font color="#b041ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= r.get("id")
394     if not _id:
395         ret["comment"] = "{} subnet does not exist.".format(name)
396         return ret
397     if __opts__["test"]:
398         ret["comment"] = "Subnet {} ({}) is set to be removed.".format(name, r[</b></font>"id"])
399         ret["result"] = None
400         return ret
401     r = __salt__["boto_vpc.delete_subnet"](
402         subnet_name=name, region=region, key=key, keyid=keyid, profile=profile
403     )
404     if not r.get("deleted"):
405         ret["result"] = False
406         ret["comment"] = "Failed to delete subnet: {}".format(r["error"]["message"])
407         return ret
408 <a name="21"></a>
409     ret["changes"]["old"] = {"subnet": _id}
410     ret["changes"]["new"] = {"subnet": None}
411     ret<font color="#947010"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["comment"] = "Subnet {} deleted.".format(name)
412     return ret
413 def internet_gateway_present(
414     name,
415     vpc_name=None,
416     vpc_id=None,
417     tags=None,
418     region=None,
419     key=None,
420     keyid=None,
421     profile=</b></font>None,
422 ):
423 <a name="28"></a>
424     ret = {"name": name, "result": True, "comment": "", "changes": {}}
425     r <font color="#717d7d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= __salt__["boto_vpc.resource_exists"](
426         "internet_gateway",
427         name=name,
428         region=region,
429         key=key,
430         keyid=keyid,
431         profile=profile,
432     )
433     if "error" in r:
434         ret["result"] = False
435         ret[</b></font>"comment"] = "Failed to create internet gateway: {}.".format(
436             r["error"]["message"]
437         )
438 <a name="26"></a>        return ret
439     if not r.get("exists"):
440         <font color="#68818b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>if __opts__["test"]:
441             ret["comment"] = "Internet gateway {} is set to be created.".format(name)
442             ret["result"] = None
443             return ret
444         r = __salt__["boto_vpc.create_internet_gateway"](</b></font>
445             internet_gateway_name=name,
446             vpc_name=vpc_name,
447             vpc_id=vpc_id,
448             tags=tags,
449             region=region,
450             key=key,
451             keyid=keyid,
452             profile=profile,
453         )
454         if not r.get("created"):
455             ret["result"] = False
456             ret["comment"] = "Failed to create internet gateway: {}".format(
457                 r["error"]["message"]
458             )
459             return ret
460         ret["changes"]["old"] = {"internet_gateway": None}
461         ret["changes"]["new"] = {"internet_gateway": r["id"]}
462         ret["comment"] = "Internet gateway {} created.".format(name)
463         return ret
464     ret["comment"] = "Internet gateway {} present.".format(name)
465     return ret
466 <a name="20"></a>
467 def internet_gateway_absent(
468     name, detach=False, region<font color="#4e9258"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=None, key=None, keyid=None, profile=None
469 ):
470     ret = {"name": name, "result": True, "comment": "", "changes": {}}
471     r = __salt__["boto_vpc.get_resource_id"](
472         "internet_gateway",
473         name=name,
474         region=region,
475         key=key,
476         keyid=keyid,
477         profile=</b></font>profile,
478     )
479     if "error" in r:
480         ret["result"] = False
481         ret["comment"] = "Failed to delete internet gateway: {}.".format(
482             r["error"]["message"]
483         )
484         return ret
485 <a name="1"></a>
486     igw_id = r["id"]
487     if not igw_id:
488         ret<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["comment"] = "Internet gateway {} does not exist.".format(name)
489         return ret
490     if __opts__["test"]:
491         ret["comment"] = "Internet gateway {} is set to be removed.".format(name)
492         ret["result"] = None
493         return ret
494     r = __salt__["boto_vpc.delete_internet_gateway"](
495         internet_gateway_name=name,
496         detach=detach,
497         region=region,
498         key=</b></font>key,
499         keyid=keyid,
500         profile=profile,
501     )
502     if not r.get("deleted"):
503         ret["result"] = False
504         ret["comment"] = "Failed to delete internet gateway: {}.".format(
505             r["error"]["message"]
506         )
507         return ret
508 <a name="17"></a>    ret["changes"]["old"] = {"internet_gateway": igw_id}
509     ret["changes"]["new"] = {"internet_gateway": None}
510     ret["comment"] = "Internet gateway {} deleted.".format(name)
511     <font color="#3090c7"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>return ret
512 def route_table_present(
513     name,
514     vpc_name=None,
515     vpc_id=None,
516     routes=None,
517     subnet_ids=None,
518     subnet_names=None,
519     tags=None,
520     region=None,
521     key=None,
522     keyid=None,
523     profile=None,
524 ):
525     ret = {"name"</b></font>: name, "result": True, "comment": "", "changes": {}}
526     _ret = _route_table_present(
527         name=name,
528         vpc_name=vpc_name,
529         vpc_id=vpc_id,
530         tags=tags,
531         region=region,
532         key=key,
533         keyid=keyid,
534 <a name="16"></a>        profile=profile,
535     )
536     ret["changes"] = _ret["changes"]
537     ret<font color="#2981b2"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["comment"] = " ".join([ret["comment"], _ret["comment"]])
538     if not _ret["result"]:
539         ret["result"] = _ret["result"]
540         if ret["result"] is False:
541             r</b></font>eturn ret
542         if ret["result"] is None and __opts__["test"]:
543             return ret
544     _ret = _routes_present(
545         route_table_name=name,
546         routes=routes,
547         tags=tags,
548         region=region,
549         key=key,
550 <a name="8"></a>        keyid=keyid,
551         profile=profile,
552     )
553     ret<font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["changes"] = dictupdate.update(ret["changes"], _ret["changes"])
554     ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
555     if not _ret["result"]:
556         ret["result"] = _ret[</b></font>"result"]
557         if ret["result"] is False:
558             return ret
559     _ret = _subnets_present(
560         route_table_name=name,
561         subnet_ids=subnet_ids,
562         subnet_names=subnet_names,
563         tags=tags,
564         region=region,
565         key=key,
566 <a name="7"></a>        keyid=keyid,
567         profile=profile,
568     )
569     ret<font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["changes"] = dictupdate.update(ret["changes"], _ret["changes"])
570     ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
571     if not _ret["result"]:
572         ret["result"] = _ret[</b></font>"result"]
573         if ret["result"] is False:
574             return ret
575     return ret
576 def _route_table_present(
577     name,
578 <a name="25"></a>    vpc_name=None,
579     vpc_id=None,
580     tags=None,
581     region<font color="#5eac10"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=None,
582     key=None,
583     keyid=None,
584     profile=None,
585 ):
586     ret = {"name": name, "result": True, "comment": "", "changes": {}}
587     r = __salt__["boto_vpc.get_resource_id"](
588         resource="route_table",
589         name=name,
590         region=region,
591         key=</b></font>key,
592         keyid=keyid,
593         profile=profile,
594     )
595     if "error" in r:
596         ret["result"] = False
597         ret["comment"] = "Failed to create route table: {}.".format(
598             r["error"]["message"]
599         )
600         return ret
601     _id = r.get("id")
602     if not _id:
603         if __opts__["test"]:
604             msg = "Route table {} is set to be created.".format(name)
605             ret["comment"] = msg
606             ret["result"] = None
607             return ret
608         r = __salt__["boto_vpc.create_route_table"](
609             route_table_name=name,
610             vpc_name=vpc_name,
611             vpc_id=vpc_id,
612             tags=tags,
613             region=region,
614             key=key,
615             keyid=keyid,
616             profile=profile,
617         )
618         if not r.get("created"):
619             ret["result"] = False
620             ret["comment"] = "Failed to create route table: {}.".format(
621                 r["error"]["message"]
622             )
623             return ret
624         ret["changes"]["old"] = {"route_table": None}
625         ret["changes"]["new"] = {"route_table": r["id"]}
626         ret["comment"] = "Route table {} created.".format(name)
627         return ret
628     ret["comment"] = "Route table {} ({}) present.".format(name, _id)
629     return ret
630 <a name="24"></a>
631 def _routes_present(
632     route_table_name, routes, tags=None, region<font color="#79764d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=None, key=None, keyid=None, profile=None
633 ):
634     ret = {"name": route_table_name, "result": True, "comment": "", "changes": {}}
635     route_table = __salt__["boto_vpc.describe_route_tables"](
636         route_table_name=route_table_name,
637         tags=tags,
638         region=region,
639         key=</b></font>key,
640         keyid=keyid,
641         profile=profile,
642     )
643     if "error" in route_table:
644         msg = "Could not retrieve configuration for route table {}: {}`.".format(
645             route_table_name, route_table["error"]["message"]
646         )
647         ret["comment"] = msg
648         ret["result"] = False
649         return ret
650     route_table = route_table[0]
651     _routes = []
652     if routes:
653         route_keys = {
654             "gateway_id",
655             "instance_id",
656             "destination_cidr_block",
657             "interface_id",
658             "vpc_peering_connection_id",
659             "nat_gateway_id",
660         }
661         for i in routes:
662             _r = {}
663             for k, v in i.items():
664                 if k in route_keys:
665                     _r[k] = i[k]
666             if i.get("internet_gateway_name"):
667                 r = __salt__["boto_vpc.get_resource_id"](
668                     "internet_gateway",
669                     name=i["internet_gateway_name"],
670                     region=region,
671                     key=key,
672                     keyid=keyid,
673                     profile=profile,
674                 )
675                 if "error" in r:
676                     msg = "Error looking up id for internet gateway {}: {}".format(
677                         i.get("internet_gateway_name"), r["error"]["message"]
678                     )
679                     ret["comment"] = msg
680                     ret["result"] = False
681                     return ret
682                 if r["id"] is None:
683                     msg = "Internet gateway {} does not exist.".format(i)
684                     ret["comment"] = msg
685                     ret["result"] = False
686                     return ret
687                 _r["gateway_id"] = r["id"]
688             if i.get("vpc_peering_connection_name"):
689                 r = __salt__["boto_vpc.get_resource_id"](
690                     "vpc_peering_connection",
691                     name=i["vpc_peering_connection_name"],
692                     region=region,
693                     key=key,
694                     keyid=keyid,
695                     profile=profile,
696                 )
697                 if "error" in r:
698                     msg = (
699                         "Error looking up id for VPC peering connection {}: {}".format(
700                             i.get("vpc_peering_connection_name"), r["error"]["message"]
701                         )
702                     )
703                     ret["comment"] = msg
704                     ret["result"] = False
705                     return ret
706                 if r["id"] is None:
707                     msg = "VPC peering connection {} does not exist.".format(i)
708                     ret["comment"] = msg
709                     ret["result"] = False
710                     return ret
711                 _r["vpc_peering_connection_id"] = r["id"]
712             if i.get("instance_name"):
713                 running_states = (
714                     "pending",
715                     "rebooting",
716                     "running",
717                     "stopping",
718                     "stopped",
719                 )
720                 r = __salt__["boto_ec2.get_id"](
721                     name=i["instance_name"],
722                     region=region,
723                     key=key,
724                     keyid=keyid,
725                     profile=profile,
726                     in_states=running_states,
727                 )
728                 if r is None:
729                     msg = "Instance {} does not exist.".format(i["instance_name"])
730                     ret["comment"] = msg
731                     ret["result"] = False
732                     return ret
733                 _r["instance_id"] = r
734             if i.get("nat_gateway_subnet_name"):
735                 r = __salt__["boto_vpc.describe_nat_gateways"](
736                     subnet_name=i["nat_gateway_subnet_name"],
737                     region=region,
738                     key=key,
739                     keyid=keyid,
740                     profile=profile,
741                 )
742                 if not r:
743                     msg = "Nat gateway does not exist."
744                     ret["comment"] = msg
745                     ret["result"] = False
746                     return ret
747                 _r["nat_gateway_id"] = r[0]["NatGatewayId"]
748             _routes.append(_r)
749     to_delete = []
750     to_create = []
751     for route in _routes:
752         if route not in route_table["routes"]:
753             to_create.append(dict(route))
754     for route in route_table["routes"]:
755         if route not in _routes:
756             if route.get("gateway_id") != "local":
757                 to_delete.append(route)
758     if to_create or to_delete:
759         if __opts__["test"]:
760             msg = "Route table {} set to have routes modified.".format(route_table_name)
761             ret["comment"] = msg
762             ret["result"] = None
763             return ret
764         if to_delete:
765             for r in to_delete:
766                 res = __salt__["boto_vpc.delete_route"](
767                     route_table_id=route_table["id"],
768                     destination_cidr_block=r["destination_cidr_block"],
769                     region=region,
770                     key=key,
771                     keyid=keyid,
772                     profile=profile,
773                 )
774                 if not res["deleted"]:
775                     msg = "Failed to delete route {} from route table {}: {}.".format(
776                         r["destination_cidr_block"],
777                         route_table_name,
778                         res["error"]["message"],
779                     )
780                     ret["comment"] = msg
781                     ret["result"] = False
782                     return ret
783                 ret["comment"] = "Deleted route {} from route table {}.".format(
784                     r["destination_cidr_block"], route_table_name
785                 )
786         if to_create:
787             for r in to_create:
788                 res = __salt__["boto_vpc.create_route"](
789                     route_table_id=route_table["id"],
790                     region=region,
791                     key=key,
792                     keyid=keyid,
793                     profile=profile,
794                     **r
795                 )
796                 if not res["created"]:
797                     msg = "Failed to create route {} in route table {}: {}.".format(
798                         r["destination_cidr_block"],
799                         route_table_name,
800                         res["error"]["message"],
801                     )
802                     ret["comment"] = msg
803                     ret["result"] = False
804                     return ret
805                 ret["comment"] = "Created route {} in route table {}.".format(
806                     r["destination_cidr_block"], route_table_name
807                 )
808         ret["changes"]["old"] = {"routes": route_table["routes"]}
809         route = __salt__["boto_vpc.describe_route_tables"](
810             route_table_name=route_table_name,
811             tags=tags,
812             region=region,
813             key=key,
814             keyid=keyid,
815             profile=profile,
816         )
817         ret["changes"]["new"] = {"routes": route[0]["routes"]}
818     return ret
819 <a name="23"></a>
820 def _subnets_present(
821     route_table_name,
822     subnet_ids<font color="#f660ab"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=None,
823     subnet_names=None,
824     tags=None,
825     region=None,
826     key=None,
827     keyid=None,
828     profile=None,
829 ):
830     ret = {"name": route_table_name, "result": True, "comment": "", "changes": {}}
831     if not subnet_ids:
832         subnet_ids = []
833     if</b></font> subnet_names:
834         for i in subnet_names:
835             r = __salt__["boto_vpc.get_resource_id"](
836                 "subnet", name=i, region=region, key=key, keyid=keyid, profile=profile
837             )
838             if "error" in r:
839                 msg = "Error looking up subnet ids: {}".format(r["error"]["message"])
840                 ret["comment"] = msg
841                 ret["result"] = False
842                 return ret
843             if r["id"] is None:
844                 msg = "Subnet {} does not exist.".format(i)
845                 ret["comment"] = msg
846                 ret["result"] = False
847                 return ret
848             subnet_ids.append(r["id"])
849     route_table = __salt__["boto_vpc.describe_route_tables"](
850         route_table_name=route_table_name,
851         tags=tags,
852         region=region,
853         key=key,
854         keyid=keyid,
855         profile=profile,
856     )
857     if not route_table:
858         msg = "Could not retrieve configuration for route table {}.".format(
859             route_table_name
860         )
861         ret["comment"] = msg
862         ret["result"] = False
863         return ret
864     assoc_ids = [x["subnet_id"] for x in route_table["associations"]]
865     to_create = [x for x in subnet_ids if x not in assoc_ids]
866     to_delete = []
867     for x in route_table["associations"]:
868         if x["subnet_id"] not in subnet_ids and x["subnet_id"] is not None:
869             to_delete.append(x["id"])
870     if to_create or to_delete:
871         if __opts__["test"]:
872             msg = "Subnet associations for route table {} set to be modified.".format(
873                 route_table_name
874             )
875             ret["comment"] = msg
876             ret["result"] = None
877             return ret
878         if to_delete:
879             for r_asc in to_delete:
880                 r = __salt__["boto_vpc.disassociate_route_table"](
881                     r_asc, region, key, keyid, profile
882                 )
883                 if "error" in r:
884                     msg = "Failed to dissociate {} from route table {}: {}.".format(
885                         r_asc, route_table_name, r["error"]["message"]
886                     )
887                     ret["comment"] = msg
888                     ret["result"] = False
889                     return ret
890                 ret["comment"] = "Dissociated subnet {} from route table {}.".format(
891                     r_asc, route_table_name
892                 )
893         if to_create:
894             for sn in to_create:
895                 r = __salt__["boto_vpc.associate_route_table"](
896                     route_table_id=route_table["id"],
897                     subnet_id=sn,
898                     region=region,
899                     key=key,
900                     keyid=keyid,
901                     profile=profile,
902                 )
903                 if "error" in r:
904                     msg = (
905                         "Failed to associate subnet {} with route table {}: {}.".format(
906                             sn, route_table_name, r["error"]["message"]
907                         )
908                     )
909                     ret["comment"] = msg
910                     ret["result"] = False
911                     return ret
912                 ret["comment"] = "Associated subnet {} with route table {}.".format(
913                     sn, route_table_name
914                 )
915         ret["changes"]["old"] = {"subnets_associations": route_table["associations"]}
916         new_sub = __salt__["boto_vpc.describe_route_tables"](
917             route_table_name=route_table_name,
918             tags=tags,
919             region=region,
920             key=key,
921             keyid=keyid,
922 <a name="5"></a>            profile=profile,
923         )
924         ret["changes"]["new"] = {"subnets_associations": new_sub["associations"]}
925     <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>return ret
926 def route_table_absent(name, region=None, key=None, keyid=None, profile=None):
927     ret = {"name": name, "result": True, "comment": "", "changes": {}}
928     r = __salt__["boto_vpc.get_resource_id"](
929         "route_table", name=name, region=region, key=key, keyid=keyid, profile=profile
930     )
931     if "error" in r:
932         ret["result"] = False
933         ret[</b></font>"comment"] = r["error"]["message"]
934         return ret
935     rtbl_id = r["id"]
936     if not rtbl_id:
937         ret["comment"] = "Route table {} does not exist.".format(name)
938 <a name="10"></a>        return ret
939     if __opts__["test"]:
940         ret<font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["comment"] = "Route table {} is set to be removed.".format(name)
941         ret["result"] = None
942         return ret
943     r = __salt__["boto_vpc.delete_route_table"](
944         route_table_name=name, region=region, key=key, keyid=keyid, profile=profile
945     )
946     if</b></font> "error" in r:
947         ret["result"] = False
948         ret["comment"] = "Failed to delete route table: {}".format(
949             r["error"]["message"]
950         )
951         return ret
952     ret["changes"]["old"] = {"route_table": rtbl_id}
953     ret["changes"]["new"] = {"route_table": None}
954     ret["comment"] = "Route table {} deleted.".format(name)
955     return ret
956 def nat_gateway_present(
957     name,
958     subnet_name=None,
959     subnet_id=None,
960     region=None,
961     key=None,
962     keyid=None,
963     profile=None,
964     allocation_id=None,
965 ):
966     ret = {"name": name, "result": True, "comment": "", "changes": {}}
967     r = __salt__["boto_vpc.describe_nat_gateways"](
968         subnet_name=subnet_name,
969         subnet_id=subnet_id,
970         region=region,
971         key=key,
972         keyid=keyid,
973         profile=profile,
974     )
975     if not r:
976         if __opts__["test"]:
977             msg = "Nat gateway is set to be created."
978             ret["comment"] = msg
979 <a name="4"></a>            ret["result"] = None
980             return ret
981         r <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= __salt__["boto_vpc.create_nat_gateway"](
982             subnet_name=subnet_name,
983             subnet_id=subnet_id,
984             region=region,
985             key=key,
986             keyid=keyid,
987             profile=profile,
988             allocation_id=allocation_id,
989         )
990         if not r.get("created"):
991             ret["result"] = False
992             ret["comment"] = "Failed to create nat gateway: {}.".format(
993                 r["error"][</b></font>"message"]
994             )
995             return ret
996         ret["changes"]["old"] = {"nat_gateway": None}
997         ret["changes"]["new"] = {"nat_gateway": r["id"]}
998         ret["comment"] = "Nat gateway created."
999         return ret
1000     inst = r[0]
1001     _id = inst.get("NatGatewayId")
1002     ret["comment"] = "Nat gateway {} present.".format(_id)
1003     return ret
1004 def nat_gateway_absent(
1005     name=None,
1006     subnet_name=None,
1007     subnet_id=None,
1008     region=None,
1009     key=None,
1010     keyid=None,
1011     profile=None,
1012     wait_for_delete_retries=0,
1013 ):
1014     ret = {"name": name, "result": True, "comment": "", "changes": {}}
1015     r = __salt__["boto_vpc.describe_nat_gateways"](
1016         subnet_name=subnet_name,
1017         subnet_id=subnet_id,
1018         region=region,
1019         key=key,
1020         keyid=keyid,
1021 <a name="27"></a>        profile=profile,
1022     )
1023     if not r:
1024         ret<font color="#e77471"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["comment"] = "Nat gateway does not exist."
1025         return ret
1026     if __opts__["test"]:
1027         ret["comment"] = "Nat gateway is set to be removed."
1028         ret["result"] = None
1029         r</b></font>eturn ret
1030     for gw in r:
1031         rtbl_id = gw.get("NatGatewayId")
1032         r = __salt__["boto_vpc.delete_nat_gateway"](
1033             nat_gateway_id=rtbl_id,
1034             release_eips=True,
1035             region=region,
1036             key=key,
1037             keyid=keyid,
1038             profile=profile,
1039             wait_for_delete=True,
1040             wait_for_delete_retries=wait_for_delete_retries,
1041         )
1042         if "error" in r:
1043             ret["result"] = False
1044             ret["comment"] = "Failed to delete nat gateway: {}".format(
1045                 r["error"]["message"]
1046             )
1047             return ret
1048         ret["comment"] = ", ".join(
1049             (ret["comment"], "Nat gateway {} deleted.".format(rtbl_id))
1050         )
1051     ret["changes"]["old"] = {"nat_gateway": rtbl_id}
1052     ret["changes"]["new"] = {"nat_gateway": None}
1053     return ret
1054 def accept_vpc_peering_connection(
1055     name=None,
1056     conn_id=None,
1057     conn_name=None,
1058     region=None,
1059     key=None,
1060     keyid=None,
1061     profile=None,
1062 ):
1063     log.debug("Called state to accept VPC peering connection")
1064     pending = __salt__["boto_vpc.is_peering_connection_pending"](
1065         conn_id=conn_id,
1066         conn_name=conn_name,
1067         region=region,
1068         key=key,
1069         keyid=keyid,
1070         profile=profile,
1071     )
1072     ret = {
1073         "name": name,
1074         "result": True,
1075         "changes": {},
1076         "comment": "Boto VPC peering state",
1077     }
1078     if not pending:
1079         ret["result"] = True
1080         ret["changes"].update(
1081             {"old": "No pending VPC peering connection found. Nothing to be done."}
1082         )
1083         return ret
1084     if __opts__["test"]:
1085         ret["changes"].update(
1086             {"old": "Pending VPC peering connection found and can be accepted"}
1087         )
1088 <a name="15"></a>        return ret
1089     fun = "boto_vpc.accept_vpc_peering_connection"
1090     log.debug("Calling `%s()` to accept this VPC peering connection", fun)
1091     result <font color="#f52887"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= __salt__[fun](
1092         conn_id=conn_id,
1093         name=conn_name,
1094         region=region,
1095         key=key,
1096         keyid=keyid,
1097         profile=profile,
1098     )
1099     if "error" in result:
1100         ret["comment"] = "Failed to accept VPC peering: {}".format(result["error"])
1101         ret[</b></font>"result"] = False
1102         return ret
1103     ret["changes"].update({"old": "", "new": result["msg"]})
1104     return ret
1105 def request_vpc_peering_connection(
1106     name,
1107     requester_vpc_id=None,
1108     requester_vpc_name=None,
1109     peer_vpc_id=None,
1110     peer_vpc_name=None,
1111     conn_name=None,
1112     peer_owner_id=None,
1113     peer_region=None,
1114     region=None,
1115     key=None,
1116     keyid=None,
1117     profile=None,
1118 ):
1119     log.debug("Called state to request VPC peering connection")
1120     ret = {
1121         "name": name,
1122         "result": True,
1123         "changes": {},
1124         "comment": "Boto VPC peering state",
1125     }
1126     if conn_name:
1127         vpc_ids = __salt__["boto_vpc.describe_vpc_peering_connection"](
1128             conn_name, region=region, key=key, keyid=keyid, profile=profile
1129         ).get("VPC-Peerings", [])
1130     else:
1131         vpc_ids = []
1132     if vpc_ids:
1133         ret["comment"] = "VPC peering connection already exists, nothing to be done."
1134         return ret
1135     if __opts__["test"]:
1136         if not vpc_ids:
1137             ret["comment"] = "VPC peering connection will be created"
1138         return ret
1139     log.debug("Called module to create VPC peering connection")
1140     result = __salt__["boto_vpc.request_vpc_peering_connection"](
1141         requester_vpc_id,
1142         requester_vpc_name,
1143         peer_vpc_id,
1144         peer_vpc_name,
1145         name=conn_name,
1146         peer_owner_id=peer_owner_id,
1147         peer_region=peer_region,
1148         region=region,
1149         key=key,
1150         keyid=keyid,
1151         profile=profile,
1152     )
1153     if "error" in result:
1154         ret["comment"] = "Failed to request VPC peering: {}".format(result["error"])
1155         ret["result"] = False
1156         return ret
1157     ret["changes"].update({"old": "", "new": result["msg"]})
1158     return ret
1159 def vpc_peering_connection_present(
1160     name,
1161     requester_vpc_id=None,
1162     requester_vpc_name=None,
1163     peer_vpc_id=None,
1164     peer_vpc_name=None,
1165     conn_name=None,
1166     peer_owner_id=None,
1167     peer_region=None,
1168     region=None,
1169     key=None,
1170     keyid=None,
1171     profile=None,
1172 ):
1173     ret = {"name": name, "result": True, "comment": "", "changes": {}}
1174     if __salt__["boto_vpc.is_peering_connection_pending"](
1175         conn_name=conn_name, region=region, key=key, keyid=keyid, profile=profile
1176     ):
1177         if __salt__["boto_vpc.peering_connection_pending_from_vpc"](
1178             conn_name=conn_name,
1179             vpc_id=requester_vpc_id,
1180             vpc_name=requester_vpc_name,
1181             region=region,
1182             key=key,
1183             keyid=keyid,
1184             profile=profile,
1185         ):
1186             ret[
1187                 "comment"
1188             ] = "VPC peering {} already requested - pending acceptance by {}".format(
1189                 conn_name, peer_owner_id or peer_vpc_name or peer_vpc_id
1190             )
1191             log.info(ret["comment"])
1192             return ret
1193         return accept_vpc_peering_connection(
1194             name=name,
1195             conn_name=conn_name,
1196             region=region,
1197             key=key,
1198             keyid=keyid,
1199             profile=profile,
1200         )
1201     return request_vpc_peering_connection(
1202         name=name,
1203         requester_vpc_id=requester_vpc_id,
1204         requester_vpc_name=requester_vpc_name,
1205         peer_vpc_id=peer_vpc_id,
1206         peer_vpc_name=peer_vpc_name,
1207         conn_name=conn_name,
1208         peer_owner_id=peer_owner_id,
1209         peer_region=peer_region,
1210         region=region,
1211         key=key,
1212         keyid=keyid,
1213         profile=profile,
1214     )
1215 def vpc_peering_connection_absent(
1216     name, conn_id=None, conn_name=None, region=None, key=None, keyid=None, profile=None
1217 ):
1218     return delete_vpc_peering_connection(
1219         name, conn_id, conn_name, region, key, keyid, profile
1220     )
1221 def delete_vpc_peering_connection(
1222     name, conn_id=None, conn_name=None, region=None, key=None, keyid=None, profile=None
1223 ):
1224     log.debug("Called state to delete VPC peering connection")
1225     ret = {
1226         "name": name,
1227         "result": True,
1228         "changes": {},
1229         "comment": "Boto VPC peering state",
1230     }
1231     if conn_name:
1232         vpc_ids = __salt__["boto_vpc.describe_vpc_peering_connection"](
1233             conn_name, region=region, key=key, keyid=keyid, profile=profile
1234         ).get("VPC-Peerings", [])
1235     else:
1236         vpc_ids = [conn_id]
1237     if not vpc_ids:
1238         ret["comment"] = "No VPC connection found, nothing to be done."
1239         return ret
1240     if __opts__["test"]:
1241         if vpc_ids:
1242             ret["comment"] = "VPC peering connection would be deleted"
1243         return ret
1244     log.debug("Called module to delete VPC peering connection")
1245     result = __salt__["boto_vpc.delete_vpc_peering_connection"](
1246         conn_id=conn_id,
1247         conn_name=conn_name,
1248         region=region,
1249         key=key,
1250         keyid=keyid,
1251         profile=profile,
1252     )
1253     if "error" in result:
1254         ret["comment"] = "Failed to delete VPC peering: {}".format(result["error"])
1255         ret["result"] = False
1256         return ret
1257     ret["changes"].update({"old": "", "new": result["msg"]})
1258     return ret
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>boto_iam.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import os
3 import xml.etree.ElementTree as ET
4 import salt.utils.data
5 import salt.utils.dictupdate as dictupdate
6 import salt.utils.files
7 import salt.utils.json
8 import salt.utils.odict as odict
9 import salt.utils.stringutils
10 log = logging.getLogger(__name__)
11 __virtualname__ = "boto_iam"
12 def __virtual__():
13 <a name="14"></a>    """
14     Only load if elementtree xml library and boto are available.
15     <font color="#842dce"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>if "boto_iam.get_user" in __salt__:
16         return True
17     else:
18         return (
19             False,
20             "Cannot load {} state: boto_iam module unavailable".format(__virtualname__),
21         )
22 def user_absent(
23     name,
24     delete_keys=True,
25     delete_mfa_devices=True,
26     delete_profile=True,
27     region=None,
28     key=None,
29     keyid=None,
30     profile=None,
31 ):
32     ret =</b></font> {"name": name, "result": True, "comment": "", "changes": {}}
33     if not __salt__["boto_iam.get_user"](name, region, key, keyid, profile):
34         ret["result"] = True
35         ret["comment"] = "IAM User {} does not exist.".format(name)
36         return ret
37     if delete_keys:
38         keys = __salt__["boto_iam.get_all_access_keys"](
39             user_name=name, region=region, key=key, keyid=keyid, profile=profile
40         )
41         log.debug("Keys for user %s are %s.", name, keys)
42         if isinstance(keys, dict):
43             keys = keys["list_access_keys_response"]["list_access_keys_result"][
44                 "access_key_metadata"
45             ]
46             for k in keys:
47                 if __opts__["test"]:
48                     ret["comment"] = " ".join(
49                         [
50                             ret["comment"],
51                             "Key {} is set to be deleted.".format(k["access_key_id"]),
52                         ]
53                     )
54                     ret["result"] = None
55                 else:
56                     if _delete_key(
57                         ret, k["access_key_id"], name, region, key, keyid, profile
58                     ):
59                         ret["comment"] = " ".join(
60                             [
61                                 ret["comment"],
62                                 "Key {} has been deleted.".format(k["access_key_id"]),
63                             ]
64                         )
65                         ret["changes"][k["access_key_id"]] = "deleted"
66     if delete_mfa_devices:
67         devices = __salt__["boto_iam.get_all_mfa_devices"](
68             user_name=name, region=region, key=key, keyid=keyid, profile=profile
69         )
70         if devices:
71             for d in devices:
72                 serial = d["serial_number"]
73                 if __opts__["test"]:
74                     ret["comment"] = " ".join(
75                         [
76                             ret["comment"],
77                             "IAM user {} MFA device {} is set to be deactivated.".format(
78                                 name, serial
79                             ),
80                         ]
81 <a name="15"></a>                    )
82                     ret["result"] = None
83                 else:
84                     mfa_deactivated <font color="#f52887"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= __salt__["boto_iam.deactivate_mfa_device"](
85                         user_name=name,
86                         serial=serial,
87                         region=region,
88                         key=key,
89                         keyid=keyid,
90                         profile=profile,
91                     )
92                     if mfa_deactivated:
93                         ret["comment"] = " ".join(
94                             [
95                                 ret[</b></font>"comment"],
96                                 "IAM user {} MFA device {} is deactivated.".format(
97                                     name, serial
98                                 ),
99                             ]
100                         )
101                 if __opts__["test"]:
102                     ret["comment"] = " ".join(
103                         [
104                             ret["comment"],
105                             "Virtual MFA device {} is set to be deleted.".format(
106                                 serial
107                             ),
108                         ]
109 <a name="28"></a>                    )
110                     ret["result"] = None
111                 else:
112                     mfa_deleted <font color="#717d7d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= __salt__["boto_iam.delete_virtual_mfa_device"](
113                         serial=serial,
114                         region=region,
115                         key=key,
116                         keyid=keyid,
117                         profile=profile,
118                     )
119                     if mfa_deleted:
120                         ret["comment"] = " ".</b></font>join(
121                             [
122                                 ret["comment"],
123                                 "Virtual MFA device {} is deleted.".format(serial),
124                             ]
125                         )
126     if delete_profile:
127         if __opts__["test"]:
128             ret["comment"] = " ".join(
129                 [
130                     ret["comment"],
131                     "IAM user {} login profile is set to be deleted.".format(name),
132                 ]
133             )
134             ret["result"] = None
135         else:
136             profile_deleted = __salt__["boto_iam.delete_login_profile"](
137                 name, region, key, keyid, profile
138             )
139             if profile_deleted:
140                 ret["comment"] = " ".join(
141                     [
142                         ret["comment"],
143                         "IAM user {} login profile is deleted.".format(name),
144                     ]
145                 )
146     if __opts__["test"]:
147         ret["comment"] = " ".join(
148             [
149                 ret["comment"],
150                 "IAM user {} managed policies are set to be detached.".format(name),
151             ]
152         )
153 <a name="16"></a>        ret["result"] = None
154     else:
155         _ret = _user_policies_detached(name, region, key, keyid, profile)
156         ret<font color="#2981b2"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["comment"] = " ".join([ret["comment"], _ret["comment"]])
157         if not _ret["result"]:
158             ret["result"] = _ret["result"]
159             if ret["result"] is False:
160                 r</b></font>eturn ret
161     if __opts__["test"]:
162         ret["comment"] = " ".join(
163             [
164                 ret["comment"],
165                 "IAM user {} inline policies are set to be deleted.".format(name),
166             ]
167         )
168         ret["result"] = None
169     else:
170         _ret = _user_policies_deleted(name, region, key, keyid, profile)
171         ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
172         if not _ret["result"]:
173             ret["result"] = _ret["result"]
174             if ret["result"] is False:
175                 return ret
176     if __opts__["test"]:
177         ret["comment"] = " ".join(
178             [ret["comment"], "IAM user {} is set to be deleted.".format(name)]
179         )
180         ret["result"] = None
181         return ret
182     deleted = __salt__["boto_iam.delete_user"](name, region, key, keyid, profile)
183     if deleted is True:
184         ret["comment"] = " ".join(
185             [ret["comment"], "IAM user {} is deleted.".format(name)]
186         )
187         ret["result"] = True
188         ret["changes"]["deleted"] = name
189         return ret
190     ret["comment"] = "IAM user {} could not be deleted.\n {}".format(name, deleted)
191     ret["result"] = False
192     return ret
193 def keys_present(
194     name,
195     number,
196     save_dir,
197     region=None,
198     key=None,
199     keyid=None,
200     profile=None,
201     save_format="{2}\n{0}\n{3}\n{1}\n",
202 ):
203     ret = {"name": name, "result": True, "comment": "", "changes": {}}
204     if not __salt__["boto_iam.get_user"](name, region, key, keyid, profile):
205         ret["result"] = False
206         ret["comment"] = "IAM User {} does not exist.".format(name)
207         return ret
208     if not isinstance(number, int):
209         ret["comment"] = "The number of keys must be an integer."
210 <a name="10"></a>        ret["result"] = False
211         return ret
212     if not os.path.isdir(save_dir):
213         ret<font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["comment"] = "The directory {} does not exist.".format(save_dir)
214         ret["result"] = False
215         return ret
216     keys = __salt__["boto_iam.get_all_access_keys"](
217         user_name=name, region=region, key=key, keyid=keyid, profile=profile
218     )
219     if</b></font> isinstance(keys, str):
220         log.debug("keys are : false %s", keys)
221         error, message = _get_error(keys)
222         ret["comment"] = "Could not get keys.\n{}\n{}".format(error, message)
223         ret["result"] = False
224         return ret
225     keys = keys["list_access_keys_response"]["list_access_keys_result"][
226         "access_key_metadata"
227     ]
228     log.debug("Keys are : %s.", keys)
229     if len(keys) &gt;= number:
230         ret["comment"] = "The number of keys exist for user {}".format(name)
231         ret["result"] = True
232         return ret
233     if __opts__["test"]:
234         ret["comment"] = "Access key is set to be created for {}.".format(name)
235         ret["result"] = None
236         return ret
237     new_keys = {}
238     for i in range(number - len(keys)):
239         created = __salt__["boto_iam.create_access_key"](
240             name, region, key, keyid, profile
241         )
242         if isinstance(created, str):
243             error, message = _get_error(created)
244             ret["comment"] = "Could not create keys.\n{}\n{}".format(error, message)
245             ret["result"] = False
246             return ret
247         log.debug("Created is : %s", created)
248         response = "create_access_key_response"
249         result = "create_access_key_result"
250         new_keys[str(i)] = {}
251         new_keys[str(i)]["key_id"] = created[response][result]["access_key"][
252             "access_key_id"
253         ]
254         new_keys[str(i)]["secret_key"] = created[response][result]["access_key"][
255             "secret_access_key"
256         ]
257     try:
258         with salt.utils.files.fopen("{}/{}".format(save_dir, name), "a") as _wrf:
259             for key_num, key in new_keys.items():
260                 key_id = key["key_id"]
261                 secret_key = key["secret_key"]
262                 _wrf.write(
263                     salt.utils.stringutils.to_str(
264                         save_format.format(
265                             key_id,
266                             secret_key,
267                             "key_id-{}".format(key_num),
268                             "key-{}".format(key_num),
269                         )
270                     )
271                 )
272         ret["comment"] = "Keys have been written to file {}/{}.".format(save_dir, name)
273         ret["result"] = True
274         ret["changes"] = new_keys
275         return ret
276     except OSError:
277         ret["comment"] = "Could not write to file {}/{}.".format(save_dir, name)
278         ret["result"] = False
279         return ret
280 def keys_absent(
281     access_keys, user_name, region=None, key=None, keyid=None, profile=None
282 ):
283     ret = {"name": access_keys, "result": True, "comment": "", "changes": {}}
284     if not __salt__["boto_iam.get_user"](user_name, region, key, keyid, profile):
285         ret["result"] = False
286         ret["comment"] = "IAM User {} does not exist.".format(user_name)
287         return ret
288     for k in access_keys:
289         ret = _delete_key(ret, k, user_name, region, key, keyid, profile)
290     return ret
291 <a name="30"></a>
292 def _delete_key(
293     ret, access_key_id, user_name, region<font color="#ae694a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=None, key=None, keyid=None, profile=None
294 ):
295     keys = __salt__["boto_iam.get_all_access_keys"](
296         user_name=user_name, region=region, key=key, keyid=keyid, profile=</b></font>profile
297     )
298     log.debug("Keys for user %s are : %s.", keys, user_name)
299     if isinstance(keys, str):
300         log.debug("Keys %s are a string. Something went wrong.", keys)
301         ret["comment"] = " ".join(
302             [ret["comment"], "Key {} could not be deleted.".format(access_key_id)]
303         )
304         return ret
305     keys = keys["list_access_keys_response"]["list_access_keys_result"][
306         "access_key_metadata"
307     ]
308     for k in keys:
309 <a name="18"></a>        log.debug(
310             "Key is: %s and is compared with: %s", k["access_key_id"], access_key_id
311         )
312         if str(k<font color="#800517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["access_key_id"]) == str(access_key_id):
313             if __opts__["test"]:
314                 ret["comment"] = "Access key {} is set to be deleted.".format(
315                     access_key_id
316                 )
317                 ret["result"] = None
318                 return ret
319             deleted = __salt__["boto_iam.delete_access_key"](</b></font>
320                 access_key_id, user_name, region, key, keyid, profile
321             )
322             if deleted:
323                 ret["comment"] = " ".join(
324                     [ret["comment"], "Key {} has been deleted.".format(access_key_id)]
325                 )
326                 ret["changes"][access_key_id] = "deleted"
327                 return ret
328             ret["comment"] = " ".join(
329                 [ret["comment"], "Key {} could not be deleted.".format(access_key_id)]
330             )
331             return ret
332         ret["comment"] = " ".join([ret["comment"], "Key {} does not exist.".format(k)])
333         return ret
334 def user_present(
335 <a name="23"></a>    name,
336     policies=None,
337     policies_from_pillars=None,
338     managed_policies<font color="#f660ab"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=None,
339     password=None,
340     path=None,
341     region=None,
342     key=None,
343     keyid=None,
344     profile=None,
345 ):
346     ret = {"name": name, "result": True, "comment": "", "changes": {}}
347     if not policies:
348         policies = {}
349     if</b></font> not policies_from_pillars:
350         policies_from_pillars = []
351     if not managed_policies:
352         managed_policies = []
353     _policies = {}
354     for policy in policies_from_pillars:
355         _policy = __salt__["pillar.get"](policy)
356         _policies.update(_policy)
357 <a name="26"></a>    _policies.update(policies)
358     exists = __salt__["boto_iam.get_user"](name, region, key, keyid, profile)
359     if not exists:
360         <font color="#68818b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>if __opts__["test"]:
361             ret["comment"] = "IAM user {} is set to be created.".format(name)
362             ret["result"] = None
363             return ret
364         created = __salt__["boto_iam.create_user"](</b></font>
365             name, path, region, key, keyid, profile
366         )
367         if created:
368             ret["changes"]["user"] = created
369             ret["comment"] = " ".join(
370                 [ret["comment"], "User {} has been created.".format(name)]
371             )
372 <a name="29"></a>            if password:
373                 ret = _case_password(ret, name, password, region, key, keyid, profile)
374             _ret = _user_policies_present(name, _policies, region, key, keyid, profile)
375             ret["changes"] <font color="#af7a82"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= dictupdate.update(ret["changes"], _ret["changes"])
376             ret["comment"] = " ".join([ret["comment"], _ret[</b></font>"comment"]])
377     else:
378         ret["comment"] = " ".join([ret["comment"], "User {} is present.".format(name)])
379         if password:
380             ret = _case_password(ret, name, password, region, key, keyid, profile)
381         _ret = _user_policies_present(name, _policies, region, key, keyid, profile)
382 <a name="8"></a>        ret["changes"] = dictupdate.update(ret["changes"], _ret["changes"])
383         ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
384     _ret = _user_policies_attached(name, managed_policies, region, key, keyid, profile)
385     ret<font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["changes"] = dictupdate.update(ret["changes"], _ret["changes"])
386     ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
387     if not _ret["result"]:
388         ret["result"] = _ret[</b></font>"result"]
389         return ret
390     return ret
391 def _user_policies_present(
392     name, policies=None, region=None, key=None, keyid=None, profile=None
393 ):
394     ret = {"result": True, "comment": "", "changes": {}}
395     policies_to_create = {}
396     policies_to_delete = []
397     for policy_name, policy in policies.items():
398         if isinstance(policy, str):
399             dict_policy = salt.utils.json.loads(
400                 policy, object_pairs_hook=odict.OrderedDict
401             )
402         else:
403             dict_policy = policy
404         _policy = __salt__["boto_iam.get_user_policy"](
405             name, policy_name, region, key, keyid, profile
406         )
407         if _policy != dict_policy:
408             log.debug("Policy mismatch:\n%s\n%s", _policy, dict_policy)
409             policies_to_create[policy_name] = policy
410     _list = __salt__["boto_iam.get_all_user_policies"](
411         user_name=name, region=region, key=key, keyid=keyid, profile=profile
412     )
413     for policy_name in _list:
414         if policy_name not in policies:
415             policies_to_delete.append(policy_name)
416     if policies_to_create or policies_to_delete:
417         _to_modify = list(policies_to_delete)
418         _to_modify.extend(policies_to_create)
419         if __opts__["test"]:
420             ret["comment"] = "{} policies to be modified on user {}.".format(
421                 ", ".join(_to_modify), name
422             )
423             ret["result"] = None
424             return ret
425         ret["changes"]["old"] = {"policies": _list}
426         for policy_name, policy in policies_to_create.items():
427             policy_set = __salt__["boto_iam.put_user_policy"](
428                 name, policy_name, policy, region, key, keyid, profile
429             )
430             if not policy_set:
431                 _list = __salt__["boto_iam.get_all_user_policies"](
432                     user_name=name, region=region, key=key, keyid=keyid, profile=profile
433                 )
434                 ret["changes"]["new"] = {"policies": _list}
435                 ret["result"] = False
436                 ret["comment"] = "Failed to add policy {} for user {}".format(
437                     policy_name, name
438                 )
439                 return ret
440         for policy_name in policies_to_delete:
441             policy_unset = __salt__["boto_iam.delete_user_policy"](
442                 name, policy_name, region, key, keyid, profile
443             )
444             if not policy_unset:
445                 _list = __salt__["boto_iam.get_all_user_policies"](
446                     user_name=name, region=region, key=key, keyid=keyid, profile=profile
447                 )
448                 ret["changes"]["new"] = {"policies": _list}
449                 ret["result"] = False
450                 ret["comment"] = "Failed to add policy {} to user {}".format(
451                     policy_name, name
452                 )
453                 return ret
454         _list = __salt__["boto_iam.get_all_user_policies"](
455             user_name=name, region=region, key=key, keyid=keyid, profile=profile
456         )
457         ret["changes"]["new"] = {"policies": _list}
458         ret["comment"] = "{} policies modified on user {}.".format(
459             ", ".join(_list), name
460         )
461     return ret
462 def _user_policies_attached(
463     name, managed_policies=None, region=None, key=None, keyid=None, profile=None
464 ):
465     ret = {"result": True, "comment": "", "changes": {}}
466     policies_to_attach = []
467     policies_to_detach = []
468     for policy in managed_policies or []:
469         entities = __salt__["boto_iam.list_entities_for_policy"](
470             policy,
471             entity_filter="User",
472             region=region,
473             key=key,
474             keyid=keyid,
475             profile=profile,
476         )
477         found = False
478         for userdict in entities.get("policy_users", []):
479             if name == userdict.get("user_name"):
480                 found = True
481                 break
482         if not found:
483             policies_to_attach.append(policy)
484     _list = __salt__["boto_iam.list_attached_user_policies"](
485         name, region=region, key=key, keyid=keyid, profile=profile
486     )
487     oldpolicies = [x.get("policy_arn") for x in _list]
488     for policy_data in _list:
489         if (
490             policy_data.get("policy_name") not in managed_policies
491             and policy_data.get("policy_arn") not in managed_policies
492         ):
493             policies_to_detach.append(policy_data.get("policy_arn"))
494     if policies_to_attach or policies_to_detach:
495         _to_modify = list(policies_to_detach)
496         _to_modify.extend(policies_to_attach)
497         if __opts__["test"]:
498             ret["comment"] = "{} policies to be modified on user {}.".format(
499                 ", ".join(_to_modify), name
500             )
501             ret["result"] = None
502             return ret
503         ret["changes"]["old"] = {"managed_policies": oldpolicies}
504         for policy_name in policies_to_attach:
505             policy_set = __salt__["boto_iam.attach_user_policy"](
506                 policy_name, name, region=region, key=key, keyid=keyid, profile=profile
507             )
508             if not policy_set:
509                 _list = __salt__["boto_iam.list_attached_user_policies"](
510                     name, region=region, key=key, keyid=keyid, profile=profile
511                 )
512                 newpolicies = [x.get("policy_arn") for x in _list]
513                 ret["changes"]["new"] = {"managed_policies": newpolicies}
514                 ret["result"] = False
515                 ret["comment"] = "Failed to add policy {} to user {}".format(
516                     policy_name, name
517                 )
518                 return ret
519         for policy_name in policies_to_detach:
520             policy_unset = __salt__["boto_iam.detach_user_policy"](
521                 policy_name, name, region=region, key=key, keyid=keyid, profile=profile
522             )
523             if not policy_unset:
524                 _list = __salt__["boto_iam.list_attached_user_policies"](
525                     name, region=region, key=key, keyid=keyid, profile=profile
526                 )
527                 newpolicies = [x.get("policy_arn") for x in _list]
528                 ret["changes"]["new"] = {"managed_policies": newpolicies}
529                 ret["result"] = False
530                 ret["comment"] = "Failed to remove policy {} from user {}".format(
531                     policy_name, name
532                 )
533                 return ret
534         _list = __salt__["boto_iam.list_attached_user_policies"](
535             name, region=region, key=key, keyid=keyid, profile=profile
536         )
537         newpolicies = [x.get("policy_arn") for x in _list]
538         log.debug(newpolicies)
539         ret["changes"]["new"] = {"managed_policies": newpolicies}
540         ret["comment"] = "{} policies modified on user {}.".format(
541             ", ".join(newpolicies), name
542         )
543 <a name="20"></a>    return ret
544 def _user_policies_detached(name, region<font color="#4e9258"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=None, key=None, keyid=None, profile=None):
545     ret = {"result": True, "comment": "", "changes": {}}
546 <a name="11"></a>    _list = __salt__["boto_iam.list_attached_user_policies"](
547         user_name=name, region=region, key=key, keyid=keyid, profile=</b></font>profile
548     )
549     oldpolicies <font color="#b041ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= [x.get("policy_arn") for x in _list]
550     if not _list:
551         ret["comment"] = "No attached policies in user {}.".format(name)
552         return ret
553     if __opts__["test"]:
554         ret["comment"] = "{} policies to be detached from user {}.".format(
555             ", ".</b></font>join(oldpolicies), name
556         )
557         ret["result"] = None
558         return ret
559     ret["changes"]["old"] = {"managed_policies": oldpolicies}
560     for policy_arn in oldpolicies:
561         policy_unset = __salt__["boto_iam.detach_user_policy"](
562             policy_arn, name, region=region, key=key, keyid=keyid, profile=profile
563         )
564         if not policy_unset:
565             _list = __salt__["boto_iam.list_attached_user_policies"](
566                 name, region=region, key=key, keyid=keyid, profile=profile
567             )
568             newpolicies = [x.get("policy_arn") for x in _list]
569             ret["changes"]["new"] = {"managed_policies": newpolicies}
570             ret["result"] = False
571             ret["comment"] = "Failed to detach {} from user {}".format(policy_arn, name)
572             return ret
573     _list = __salt__["boto_iam.list_attached_user_policies"](
574         name, region=region, key=key, keyid=keyid, profile=profile
575     )
576     newpolicies = [x.get("policy_arn") for x in _list]
577     ret["changes"]["new"] = {"managed_policies": newpolicies}
578 <a name="5"></a>    ret["comment"] = "{} policies detached from user {}.".format(
579         ", ".join(oldpolicies), name
580     )
581     <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>return ret
582 def _user_policies_deleted(name, region=None, key=None, keyid=None, profile=None):
583     ret = {"result": True, "comment": "", "changes": {}}
584     oldpolicies = __salt__["boto_iam.get_all_user_policies"](
585         user_name=name, region=region, key=key, keyid=keyid, profile=profile
586     )
587     if not oldpolicies:
588         ret["comment"] = "No inline policies in user {}.".</b></font>format(name)
589         return ret
590     if __opts__["test"]:
591         ret["comment"] = "{} policies to be deleted from user {}.".format(
592             ", ".join(oldpolicies), name
593         )
594         ret["result"] = None
595         return ret
596     ret["changes"]["old"] = {"inline_policies": oldpolicies}
597     for policy_name in oldpolicies:
598         policy_deleted = __salt__["boto_iam.delete_user_policy"](
599             name, policy_name, region=region, key=key, keyid=keyid, profile=profile
600         )
601         if not policy_deleted:
602             newpolicies = __salt__["boto_iam.get_all_user_policies"](
603                 name, region=region, key=key, keyid=keyid, profile=profile
604             )
605             ret["changes"]["new"] = {"inline_policies": newpolicies}
606             ret["result"] = False
607             ret["comment"] = "Failed to detach {} from user {}".format(
608                 policy_name, name
609             )
610             return ret
611     newpolicies = __salt__["boto_iam.get_all_user_policies"](
612         name, region=region, key=key, keyid=keyid, profile=profile
613     )
614     ret["changes"]["new"] = {"inline_policies": newpolicies}
615     ret["comment"] = "{} policies deleted from user {}.".format(
616         ", ".join(oldpolicies), name
617     )
618     return ret
619 def _case_password(
620     ret, name, password, region=None, key=None, keyid=None, profile=None
621 ):
622     if __opts__["test"]:
623         ret["comment"] = "Login policy for {} is set to be changed.".format(name)
624         ret["result"] = None
625         return ret
626     login = __salt__["boto_iam.create_login_profile"](
627         name, password, region, key, keyid, profile
628     )
629     log.debug("Login is : %s.", login)
630     if login:
631         if "Conflict" in login:
632             ret["comment"] = " ".join(
633                 [ret["comment"], "Login profile for user {} exists.".format(name)]
634             )
635         else:
636             ret["comment"] = " ".join(
637                 [ret["comment"], "Password has been added to User {}.".format(name)]
638             )
639             ret["changes"]["password"] = "REDACTED"
640     else:
641         ret["result"] = False
642         ret["comment"] = " ".join(
643             [
644                 ret["comment"],
645                 "Password for user {} could not be set.\nPlease check your password"
646                 " policy.".format(name),
647             ]
648         )
649     return ret
650 def group_absent(name, region=None, key=None, keyid=None, profile=None):
651     ret = {"name": name, "result": True, "comment": "", "changes": {}}
652     if not __salt__["boto_iam.get_group"](name, region, key, keyid, profile):
653         ret["result"] = True
654         ret["comment"] = "IAM Group {} does not exist.".format(name)
655         return ret
656     if __opts__["test"]:
657         ret["comment"] = " ".join(
658             [
659                 ret["comment"],
660                 "IAM group {} managed policies are set to be detached.".format(name),
661             ]
662         )
663         ret["result"] = None
664     else:
665         _ret = _group_policies_detached(name, region, key, keyid, profile)
666         ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
667         if not _ret["result"]:
668             ret["result"] = _ret["result"]
669             if ret["result"] is False:
670                 return ret
671     if __opts__["test"]:
672         ret["comment"] = " ".join(
673             [
674                 ret["comment"],
675                 "IAM group {} inline policies are set to be deleted.".format(name),
676             ]
677         )
678         ret["result"] = None
679     else:
680         _ret = _group_policies_deleted(name, region, key, keyid, profile)
681         ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
682         if not _ret["result"]:
683             ret["result"] = _ret["result"]
684             if ret["result"] is False:
685                 return ret
686     ret["comment"] = " ".join(
687         [ret["comment"], "IAM group {} users are set to be removed.".format(name)]
688     )
689     existing_users = __salt__["boto_iam.get_group_members"](
690 <a name="7"></a>        group_name=name, region=region, key=key, keyid=keyid, profile=profile
691     )
692     _ret = _case_group(ret, [], name, existing_users, region, key, keyid, profile)
693     ret<font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["changes"] = dictupdate.update(ret["changes"], _ret["changes"])
694     ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
695     if not _ret["result"]:
696         ret["result"] = _ret[</b></font>"result"]
697         return ret
698     if __opts__["test"]:
699         ret["comment"] = " ".join(
700             [ret["comment"], "IAM group {} is set to be deleted.".format(name)]
701         )
702         ret["result"] = None
703         return ret
704     deleted = __salt__["boto_iam.delete_group"](name, region, key, keyid, profile)
705     if deleted is True:
706         ret["comment"] = " ".join(
707             [ret["comment"], "IAM group {} is deleted.".format(name)]
708         )
709         ret["result"] = True
710         ret["changes"]["deleted"] = name
711 <a name="17"></a>        return ret
712     ret["comment"] = "IAM group {} could not be deleted.\n {}".format(name, deleted)
713     ret["result"] = False
714     <font color="#3090c7"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>return ret
715 def group_present(
716     name,
717     policies=None,
718     policies_from_pillars=None,
719     managed_policies=None,
720     users=None,
721     path="/",
722     region=None,
723     key=None,
724     keyid=None,
725     profile=None,
726     delete_policies=True,
727 ):
728     ret = {"name"</b></font>: name, "result": True, "comment": "", "changes": {}}
729     if not policies:
730         policies = {}
731     if not policies_from_pillars:
732         policies_from_pillars = []
733     if not managed_policies:
734         managed_policies = []
735     _policies = {}
736     for policy in policies_from_pillars:
737         _policy = __salt__["pillar.get"](policy)
738         _policies.update(_policy)
739     _policies.update(policies)
740     exists = __salt__["boto_iam.get_group"](
741 <a name="6"></a>        group_name=name, region=region, key=key, keyid=keyid, profile=profile
742     )
743     if not exists:
744         <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>if __opts__["test"]:
745             ret["comment"] = "IAM group {} is set to be created.".format(name)
746             ret["result"] = None
747             return ret
748         created = __salt__["boto_iam.create_group"](
749             group_name=name,
750             path=path,
751             region=region,
752             key=key,
753             keyid=keyid,
754             profile=</b></font>profile,
755         )
756         if not created:
757             ret["comment"] = "Failed to create IAM group {}.".format(name)
758             ret["result"] = False
759             return ret
760         ret["changes"]["group"] = created
761         ret["comment"] = " ".join(
762             [ret["comment"], "Group {} has been created.".format(name)]
763         )
764     else:
765         ret["comment"] = " ".join([ret["comment"], "Group {} is present.".format(name)])
766     _ret = _group_policies_present(
767         name, _policies, region, key, keyid, profile, delete_policies
768     )
769     ret["changes"] = dictupdate.update(ret["changes"], _ret["changes"])
770     ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
771     if not _ret["result"]:
772         ret["result"] = _ret["result"]
773         return ret
774     _ret = _group_policies_attached(
775         name, managed_policies, region, key, keyid, profile, delete_policies
776     )
777     ret["changes"] = dictupdate.update(ret["changes"], _ret["changes"])
778     ret["comment"] = " ".join([ret["comment"], _ret["comment"]])
779     if not _ret["result"]:
780         ret["result"] = _ret["result"]
781         return ret
782     if users is not None:
783         log.debug("Users are : %s.", users)
784         existing_users = __salt__["boto_iam.get_group_members"](
785             group_name=name, region=region, key=key, keyid=keyid, profile=profile
786         )
787         ret = _case_group(ret, users, name, existing_users, region, key, keyid, profile)
788     return ret
789 def _case_group(ret, users, group_name, existing_users, region, key, keyid, profile):
790     _users = []
791     for user in existing_users:
792         _users.append(user["user_name"])
793     log.debug("upstream users are %s", _users)
794     for user in users:
795         log.debug("users are %s", user)
796         if user in _users:
797             log.debug("user exists")
798             ret["comment"] = " ".join(
799                 [
800                     ret["comment"],
801                     "User {} is already a member of group {}.".format(user, group_name),
802                 ]
803             )
804             continue
805         else:
806             log.debug("user is set to be added %s", user)
807             if __opts__["test"]:
808                 ret["comment"] = "User {} is set to be added to group {}.".format(
809                     user, group_name
810                 )
811                 ret["result"] = None
812             else:
813                 __salt__["boto_iam.add_user_to_group"](
814                     user, group_name, region, key, keyid, profile
815                 )
816                 ret["comment"] = " ".join(
817                     [
818                         ret["comment"],
819                         "User {} has been added to group {}.".format(user, group_name),
820                     ]
821                 )
822                 ret["changes"][user] = group_name
823     for user in _users:
824         if user not in users:
825             if __opts__["test"]:
826                 ret["comment"] = " ".join(
827                     [
828                         ret["comment"],
829                         "User {} is set to be removed from group {}.".format(
830                             user, group_name
831                         ),
832                     ]
833                 )
834                 ret["result"] = None
835             else:
836                 __salt__["boto_iam.remove_user_from_group"](
837                     group_name=group_name,
838                     user_name=user,
839                     region=region,
840                     key=key,
841                     keyid=keyid,
842                     profile=profile,
843                 )
844                 ret["comment"] = " ".join(
845                     [
846                         ret["comment"],
847                         "User {} has been removed from group {}.".format(
848                             user, group_name
849                         ),
850                     ]
851                 )
852                 ret["changes"][user] = "Removed from group {}.".format(group_name)
853     return ret
854 def _group_policies_present(
855     name,
856     policies=None,
857     region=None,
858     key=None,
859     keyid=None,
860     profile=None,
861     delete_policies=True,
862 ):
863     ret = {"result": True, "comment": "", "changes": {}}
864     policies_to_create = {}
865     policies_to_delete = []
866     for policy_name, policy in policies.items():
867         if isinstance(policy, str):
868             dict_policy = salt.utils.json.loads(
869                 policy, object_pairs_hook=odict.OrderedDict
870             )
871         else:
872             dict_policy = policy
873         _policy = __salt__["boto_iam.get_group_policy"](
874             name, policy_name, region, key, keyid, profile
875         )
876         if _policy != dict_policy:
877             log.debug("Policy mismatch:\n%s\n%s", _policy, dict_policy)
878             policies_to_create[policy_name] = policy
879     _list = __salt__["boto_iam.get_all_group_policies"](
880         name, region, key, keyid, profile
881     )
882     for policy_name in _list:
883         if delete_policies and policy_name not in policies:
884             policies_to_delete.append(policy_name)
885     if policies_to_create or policies_to_delete:
886         _to_modify = list(policies_to_delete)
887         _to_modify.extend(policies_to_create)
888         if __opts__["test"]:
889             ret["comment"] = "{} policies to be modified on group {}.".format(
890                 ", ".join(_to_modify), name
891             )
892             ret["result"] = None
893             return ret
894         ret["changes"]["old"] = {"policies": _list}
895         for policy_name, policy in policies_to_create.items():
896             policy_set = __salt__["boto_iam.put_group_policy"](
897                 name, policy_name, policy, region, key, keyid, profile
898             )
899             if not policy_set:
900                 _list = __salt__["boto_iam.get_all_group_policies"](
901                     name, region, key, keyid, profile
902                 )
903                 ret["changes"]["new"] = {"policies": _list}
904                 ret["result"] = False
905                 ret["comment"] = "Failed to add policy {} to group {}".format(
906                     policy_name, name
907                 )
908                 return ret
909         for policy_name in policies_to_delete:
910             policy_unset = __salt__["boto_iam.delete_group_policy"](
911                 name, policy_name, region, key, keyid, profile
912             )
913             if not policy_unset:
914                 _list = __salt__["boto_iam.get_all_group_policies"](
915                     name, region, key, keyid, profile
916                 )
917                 ret["changes"]["new"] = {"policies": _list}
918                 ret["result"] = False
919                 ret["comment"] = "Failed to add policy {} to group {}".format(
920                     policy_name, name
921                 )
922                 return ret
923         _list = __salt__["boto_iam.get_all_group_policies"](
924             name, region, key, keyid, profile
925         )
926         ret["changes"]["new"] = {"policies": _list}
927         ret["comment"] = "{} policies modified on group {}.".format(
928             ", ".join(_list), name
929         )
930     return ret
931 def _group_policies_attached(
932     name,
933     managed_policies=None,
934     region=None,
935     key=None,
936     keyid=None,
937     profile=None,
938     detach_policies=True,
939 ):
940     ret = {"result": True, "comment": "", "changes": {}}
941     policies_to_attach = []
942     policies_to_detach = []
943     for policy in managed_policies or []:
944         entities = __salt__["boto_iam.list_entities_for_policy"](
945             policy,
946             entity_filter="Group",
947             region=region,
948             key=key,
949             keyid=keyid,
950             profile=profile,
951         )
952         found = False
953         for groupdict in entities.get("policy_groups", []):
954             if name == groupdict.get("group_name"):
955                 found = True
956                 break
957         if not found:
958             policies_to_attach.append(policy)
959     _list = __salt__["boto_iam.list_attached_group_policies"](
960         name, region=region, key=key, keyid=keyid, profile=profile
961     )
962     oldpolicies = [x.get("policy_arn") for x in _list]
963     for policy_data in _list:
964         if (
965             detach_policies
966             and policy_data.get("policy_name") not in managed_policies
967             and policy_data.get("policy_arn") not in managed_policies
968         ):
969             policies_to_detach.append(policy_data.get("policy_arn"))
970     if policies_to_attach or policies_to_detach:
971         _to_modify = list(policies_to_detach)
972         _to_modify.extend(policies_to_attach)
973         if __opts__["test"]:
974             ret["comment"] = "{} policies to be modified on group {}.".format(
975                 ", ".join(_to_modify), name
976             )
977             ret["result"] = None
978             return ret
979         ret["changes"]["old"] = {"managed_policies": oldpolicies}
980         for policy_name in policies_to_attach:
981             policy_set = __salt__["boto_iam.attach_group_policy"](
982                 policy_name, name, region=region, key=key, keyid=keyid, profile=profile
983             )
984             if not policy_set:
985                 _list = __salt__["boto_iam.list_attached_group_policies"](
986                     name, region=region, key=key, keyid=keyid, profile=profile
987                 )
988                 newpolicies = [x.get("policy_arn") for x in _list]
989                 ret["changes"]["new"] = {"managed_policies": newpolicies}
990                 ret["result"] = False
991                 ret["comment"] = "Failed to add policy {} to group {}".format(
992                     policy_name, name
993                 )
994                 return ret
995         for policy_name in policies_to_detach:
996             policy_unset = __salt__["boto_iam.detach_group_policy"](
997                 policy_name, name, region=region, key=key, keyid=keyid, profile=profile
998             )
999             if not policy_unset:
1000                 _list = __salt__["boto_iam.list_attached_group_policies"](
1001                     name, region=region, key=key, keyid=keyid, profile=profile
1002                 )
1003                 newpolicies = [x.get("policy_arn") for x in _list]
1004                 ret["changes"]["new"] = {"managed_policies": newpolicies}
1005                 ret["result"] = False
1006                 ret["comment"] = "Failed to remove policy {} from group {}".format(
1007                     policy_name, name
1008                 )
1009                 return ret
1010         _list = __salt__["boto_iam.list_attached_group_policies"](
1011             name, region=region, key=key, keyid=keyid, profile=profile
1012         )
1013         newpolicies = [x.get("policy_arn") for x in _list]
1014         log.debug(newpolicies)
1015         ret["changes"]["new"] = {"managed_policies": newpolicies}
1016         ret["comment"] = "{} policies modified on group {}.".format(
1017             ", ".join(newpolicies), name
1018         )
1019 <a name="19"></a>    return ret
1020 def _group_policies_detached(name, region<font color="#f62817"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=None, key=None, keyid=None, profile=None):
1021     ret = {"result": True, "comment": "", "changes": {}}
1022     _list = __salt__["boto_iam.list_attached_group_policies"](
1023         group_name=name, region=region, key=key, keyid=keyid, profile=profile
1024     )
1025     oldpolicies =</b></font> [x.get("policy_arn") for x in _list]
1026     if not _list:
1027         ret["comment"] = "No attached policies in group {}.".format(name)
1028         return ret
1029     if __opts__["test"]:
1030         ret["comment"] = "{} policies to be detached from group {}.".format(
1031             ", ".join(oldpolicies), name
1032         )
1033         ret["result"] = None
1034         return ret
1035     ret["changes"]["old"] = {"managed_policies": oldpolicies}
1036     for policy_arn in oldpolicies:
1037         policy_unset = __salt__["boto_iam.detach_group_policy"](
1038             policy_arn, name, region=region, key=key, keyid=keyid, profile=profile
1039         )
1040         if not policy_unset:
1041             _list = __salt__["boto_iam.list_attached_group_policies"](
1042                 name, region=region, key=key, keyid=keyid, profile=profile
1043             )
1044             newpolicies = [x.get("policy_arn") for x in _list]
1045             ret["changes"]["new"] = {"managed_policies": newpolicies}
1046             ret["result"] = False
1047             ret["comment"] = "Failed to detach {} from group {}".format(
1048                 policy_arn, name
1049             )
1050             return ret
1051     _list = __salt__["boto_iam.list_attached_group_policies"](
1052         name, region=region, key=key, keyid=keyid, profile=profile
1053     )
1054     newpolicies = [x.get("policy_arn") for x in _list]
1055     ret["changes"]["new"] = {"managed_policies": newpolicies}
1056     ret["comment"] = "{} policies detached from group {}.".format(
1057         ", ".join(newpolicies), name
1058     )
1059 <a name="9"></a>    return ret
1060 def _group_policies_deleted(name, region<font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=None, key=None, keyid=None, profile=None):
1061     ret = {"result": True, "comment": "", "changes": {}}
1062     oldpolicies = __salt__["boto_iam.get_all_group_policies"](
1063         group_name=name, region=region, key=key, keyid=keyid, profile=profile
1064     )
1065     if not oldpolicies:
1066         ret["comment"] = "No inline policies in group {}.".</b></font>format(name)
1067         return ret
1068     if __opts__["test"]:
1069         ret["comment"] = "{} policies to be deleted from group {}.".format(
1070             ", ".join(oldpolicies), name
1071         )
1072         ret["result"] = None
1073         return ret
1074     ret["changes"]["old"] = {"inline_policies": oldpolicies}
1075     for policy_name in oldpolicies:
1076         policy_deleted = __salt__["boto_iam.delete_group_policy"](
1077             name, policy_name, region=region, key=key, keyid=keyid, profile=profile
1078         )
1079         if not policy_deleted:
1080             newpolicies = __salt__["boto_iam.get_all_group_policies"](
1081                 name, region=region, key=key, keyid=keyid, profile=profile
1082             )
1083             ret["changes"]["new"] = {"inline_policies": newpolicies}
1084             ret["result"] = False
1085             ret["comment"] = "Failed to detach {} from group {}".format(
1086                 policy_name, name
1087             )
1088             return ret
1089     newpolicies = __salt__["boto_iam.get_all_group_policies"](
1090         name, region=region, key=key, keyid=keyid, profile=profile
1091 <a name="12"></a>    )
1092     ret["changes"]["new"] = {"inline_policies": newpolicies}
1093     ret["comment"] = "{} policies deleted from group {}.".format(
1094         ", "<font color="#571b7e"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.join(oldpolicies), name
1095     )
1096     return ret
1097 def account_policy(
1098     name=None,
1099     allow_users_to_change_password=None,
1100     hard_expiry=None,
1101     max_password_age=None,
1102     minimum_password_length=None,
1103     password_reuse_prevention=None,
1104     require_lowercase_characters=None,
1105     require_numbers=None,
1106     require_symbols=None,
1107     require_uppercase_characters=None,
1108     region=None,
1109     key=</b></font>None,
1110     keyid=None,
1111     profile=None,
1112 ):
1113     config = locals()
1114     ret = {"name": "Account Policy", "result": True, "comment": "", "changes": {}}
1115     info = __salt__["boto_iam.get_account_policy"](region, key, keyid, profile)
1116     if not info:
1117         ret["comment"] = "Account policy is not Enabled."
1118         ret["result"] = False
1119         return ret
1120     for key, value in config.items():
1121         if key in ("region", "key", "keyid", "profile", "name"):
1122             continue
1123         if value is not None and str(info[key]) != str(value).lower():
1124             ret["comment"] = " ".join(
1125                 [
1126                     ret["comment"],
1127                     "Policy value {} has been set to {}.".format(value, info[key]),
1128                 ]
1129 <a name="27"></a>            )
1130             ret["changes"][key] = str(value).lower()
1131     if not ret["changes"]:
1132         ret<font color="#e77471"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["comment"] = "Account policy is not changed."
1133         return ret
1134     if __opts__["test"]:
1135         ret["comment"] = "Account policy is set to be changed."
1136         ret["result"] = None
1137         r</b></font>eturn ret
1138     if __salt__["boto_iam.update_account_password_policy"](
1139         allow_users_to_change_password,
1140         hard_expiry,
1141         max_password_age,
1142         minimum_password_length,
1143         password_reuse_prevention,
1144         require_lowercase_characters,
1145         require_numbers,
1146         require_symbols,
1147         require_uppercase_characters,
1148         region,
1149         key,
1150         keyid,
1151         profile,
1152     ):
1153         return ret
1154     ret["comment"] = "Account policy is not changed."
1155     ret["changes"] = {}
1156     ret["result"] = False
1157     return ret
1158 def server_cert_absent(name, region=None, key=None, keyid=None, profile=None):
1159     ret = {"name": name, "result": True, "comment": "", "changes": {}}
1160     exists <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= __salt__["boto_iam.get_server_certificate"](
1161         name, region, key, keyid, profile
1162     )
1163     if not exists:
1164         ret["comment"] = "Certificate {} does not exist.".format(name)
1165         return ret
1166     if __opts__["test"]:
1167         ret["comment"] = "Server certificate {} is set to be deleted.".format(name)
1168         ret["result"] = None
1169         return ret
1170     deleted = __salt__["boto_iam.delete_server_cert"](</b></font>name, region, key, keyid, profile)
1171     if not deleted:
1172         ret["result"] = False
1173         ret["comment"] = "Certificate {} failed to be deleted.".format(name)
1174 <a name="22"></a>        return ret
1175     ret["comment"] = "Certificate {} was deleted.".format(name)
1176     ret["changes"] = deleted
1177     <font color="#4cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>return ret
1178 def server_cert_present(
1179     name,
1180     public_key,
1181     private_key,
1182     cert_chain=None,
1183     path=None,
1184     region=None,
1185     key=None,
1186     keyid=None,
1187     profile=None,
1188 ):
1189     ret = {"name": name, "result": True, "comment": "", "changes": {}}
1190     exists = __salt__["boto_iam.get_server_certificate"](</b></font>
1191         name, region, key, keyid, profile
1192     )
1193     log.debug("Variables are : %s.", locals())
1194     if exists:
1195         ret["comment"] = "Certificate {} exists.".format(name)
1196         return ret
1197     if "salt://" in public_key:
1198         try:
1199             public_key = __salt__["cp.get_file_str"](public_key)
1200         except OSError as e:
1201             log.debug(e)
1202             ret["comment"] = "File {} not found.".format(public_key)
1203             ret["result"] = False
1204             return ret
1205     if "salt://" in private_key:
1206         try:
1207             private_key = __salt__["cp.get_file_str"](private_key)
1208         except OSError as e:
1209             log.debug(e)
1210             ret["comment"] = "File {} not found.".format(private_key)
1211             ret["result"] = False
1212             return ret
1213     if cert_chain is not None and "salt://" in cert_chain:
1214         try:
1215             cert_chain = __salt__["cp.get_file_str"](cert_chain)
1216         except OSError as e:
1217             log.debug(e)
1218             ret["comment"] = "File {} not found.".format(cert_chain)
1219             ret["result"] = False
1220             return ret
1221     if __opts__["test"]:
1222         ret["comment"] = "Server certificate {} is set to be created.".format(name)
1223         ret["result"] = None
1224         return ret
1225     created = __salt__["boto_iam.upload_server_cert"](
1226         name, public_key, private_key, cert_chain, path, region, key, keyid, profile
1227     )
1228     if created is not False:
1229         ret["comment"] = "Certificate {} was created.".format(name)
1230 <a name="21"></a>        ret["changes"] = created
1231         return ret
1232     ret["result"] = False
1233     ret<font color="#947010"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["comment"] = "Certificate {} failed to be created.".format(name)
1234     return ret
1235 def policy_present(
1236     name,
1237     policy_document,
1238     path=None,
1239     description=None,
1240     region=None,
1241     key=None,
1242     keyid=None,
1243     profile=None,
1244 ):
1245     ret =</b></font> {"name": name, "result": True, "comment": "", "changes": {}}
1246     policy = __salt__["boto_iam.get_policy"](name, region, key, keyid, profile)
1247     if not policy:
1248         if __opts__["test"]:
1249             ret["comment"] = "IAM policy {} is set to be created.".format(name)
1250             ret["result"] = None
1251             return ret
1252         created = __salt__["boto_iam.create_policy"](
1253             name, policy_document, path, description, region, key, keyid, profile
1254         )
1255         if created:
1256             ret["changes"]["policy"] = created
1257             ret["comment"] = " ".join(
1258                 [ret["comment"], "Policy {} has been created.".format(name)]
1259             )
1260         else:
1261             ret["result"] = False
1262             ret["comment"] = "Failed to update policy."
1263             ret["changes"] = {}
1264             return ret
1265     else:
1266         policy = policy.get("policy", {})
1267         ret["comment"] = " ".join(
1268             [ret["comment"], "Policy {} is present.".format(name)]
1269         )
1270         _describe = __salt__["boto_iam.get_policy_version"](
1271             name, policy.get("default_version_id"), region, key, keyid, profile
1272         ).get("policy_version", {})
1273         if isinstance(_describe["document"], str):
1274             describeDict = salt.utils.json.loads(_describe["document"])
1275         else:
1276             describeDict = _describe["document"]
1277         if isinstance(policy_document, str):
1278             policy_document = salt.utils.json.loads(policy_document)
1279         r = salt.utils.data.compare_dicts(describeDict, policy_document)
1280         if bool(r):
1281             if __opts__["test"]:
1282                 ret["comment"] = "Policy {} set to be modified.".format(name)
1283                 ret["result"] = None
1284                 return ret
1285 <a name="4"></a>            ret["comment"] = " ".join([ret["comment"], "Policy to be modified"])
1286             policy_document = salt.utils.json.dumps(policy_document)
1287             r <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= __salt__["boto_iam.create_policy_version"](
1288                 policy_name=name,
1289                 policy_document=policy_document,
1290                 set_as_default=True,
1291                 region=region,
1292                 key=key,
1293                 keyid=keyid,
1294                 profile=profile,
1295             )
1296             if not r.get("created"):
1297                 ret["result"] = False
1298                 ret["comment"] = "Failed to update policy: {}.".format(
1299                     r["error"][</b></font>"message"]
1300                 )
1301                 ret["changes"] = {}
1302                 return ret
1303             __salt__["boto_iam.delete_policy_version"](
1304                 policy_name=name,
1305                 version_id=policy["default_version_id"],
1306                 region=region,
1307                 key=key,
1308                 keyid=keyid,
1309                 profile=profile,
1310             )
1311             ret["changes"].setdefault("new", {})["document"] = policy_document
1312             ret["changes"].setdefault("old", {})["document"] = _describe["document"]
1313 <a name="25"></a>    return ret
1314 def policy_absent(name, region<font color="#5eac10"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=None, key=None, keyid=None, profile=None):
1315     ret = {"name": name, "result": True, "comment": "", "changes": {}}
1316 <a name="0"></a>    r = __salt__["boto_iam.policy_exists"](
1317         name, region=region, key=key, keyid=keyid, profile=</b></font>profile
1318     )
1319     <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>if not r:
1320         ret["comment"] = "Policy {} does not exist.".format(name)
1321         return ret
1322     if __opts__["test"]:
1323         ret["comment"] = "Policy {} is set to be removed.".format(name)
1324         ret["result"] = None
1325         return ret
1326     versions = __salt__["boto_iam.list_policy_versions"](
1327         name, region=region, key=key, keyid=keyid, profile=</b></font>profile
1328     )
1329     if versions:
1330         for version in versions:
1331             if version.get("is_default_version", False) in ("true", True):
1332                 continue
1333             r = __salt__["boto_iam.delete_policy_version"](
1334                 name,
1335                 version_id=version.get("version_id"),
1336                 region=region,
1337                 key=key,
1338                 keyid=keyid,
1339                 profile=profile,
1340             )
1341             if not r:
1342                 ret["result"] = False
1343                 ret["comment"] = "Failed to delete policy {}.".format(name)
1344                 return ret
1345     r = __salt__["boto_iam.delete_policy"](
1346         name, region=region, key=key, keyid=keyid, profile=profile
1347     )
1348 <a name="3"></a>    if not r:
1349         ret["result"] = False
1350         ret["comment"] = "Failed to delete policy {}.".format(name)
1351         <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>return ret
1352     ret["changes"]["old"] = {"policy": name}
1353     ret["changes"]["new"] = {"policy": None}
1354     ret["comment"] = "Policy {} deleted.".format(name)
1355     return ret
1356 def saml_provider_present(
1357     name, saml_metadata_document, region=None, key=None, keyid=None, profile=None
1358 ):
1359     ret =</b></font> {"name": name, "result": True, "comment": "", "changes": {}}
1360     if "salt://" in saml_metadata_document:
1361         try:
1362             saml_metadata_document = __salt__["cp.get_file_str"](saml_metadata_document)
1363             ET.fromstring(saml_metadata_document)
1364         except OSError as e:
1365             log.debug(e)
1366             ret[
1367                 "comment"
1368             ] = "SAML document file {} not found or could not be loaded".format(name)
1369             ret["result"] = False
1370             return ret
1371     for provider in __salt__["boto_iam.list_saml_providers"](
1372         region=region, key=key, keyid=keyid, profile=profile
1373     ):
1374 <a name="13"></a>        if provider == name:
1375             ret["comment"] = "SAML provider {} is present.".format(name)
1376             return ret
1377     <font color="#3b9c9c"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>if __opts__["test"]:
1378         ret["comment"] = "SAML provider {} is set to be create.".format(name)
1379         ret["result"] = None
1380         return ret
1381     created = __salt__["boto_iam.create_saml_provider"](
1382         name,
1383         saml_metadata_document,
1384         region=region,
1385         key=key,
1386         keyid=keyid,
1387         profile=</b></font>profile,
1388     )
1389     if created:
1390         ret["comment"] = "SAML provider {} was created.".format(name)
1391         ret["changes"]["new"] = name
1392         return ret
1393     ret["result"] = False
1394     ret["comment"] = "SAML provider {} failed to be created.".format(name)
1395 <a name="24"></a>    return ret
1396 def saml_provider_absent(name, region<font color="#79764d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=None, key=None, keyid=None, profile=None):
1397     ret = {"name": name, "result": True, "comment": "", "changes": {}}
1398     provider = __salt__["boto_iam.list_saml_providers"](
1399 <a name="1"></a>        region=region, key=key, keyid=keyid, profile=</b></font>profile
1400     )
1401     if len(provider) == 0:
1402         ret<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["comment"] = "SAML provider {} is absent.".format(name)
1403         return ret
1404     if __opts__["test"]:
1405         ret["comment"] = "SAML provider {} is set to be removed.".format(name)
1406         ret["result"] = None
1407         return ret
1408     deleted = __salt__["boto_iam.delete_saml_provider"](
1409         name, region=region, key=key, keyid=keyid, profile=</b></font>profile
1410     )
1411     if deleted is not False:
1412         ret["comment"] = "SAML provider {} was deleted.".format(name)
1413         ret["changes"]["old"] = name
1414         return ret
1415     ret["result"] = False
1416     ret["comment"] = "SAML provider {} failed to be deleted.".format(name)
1417     return ret
1418 def _get_error(error):
1419     error = "\n".join(error.split("\n")[1:])
1420     error = ET.fromstring(error)
1421     code = error[0][1].text
1422     message = error[0][2].text
1423     return code, message
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
