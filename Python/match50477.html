<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for travisci.py &amp; test_pydsl.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for travisci.py &amp; test_pydsl.py
      </h3>
<h1 align="center">
        5.7%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>travisci.py (31.16883%)<th>test_pydsl.py (3.1537452%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(75-78)<td><a href="#" name="0">(107-110)</a><td align="center"><font color="#ff0000">12</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(65-69)<td><a href="#" name="1">(192-200)</a><td align="center"><font color="#ff0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>travisci.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import base64
2 import urllib.parse
3 import salt.utils.json
4 from salt.utils.versions import LooseVersion as _LooseVersion
5 try:
6     import OpenSSL
7     import OpenSSL.crypto
8     HAS_OPENSSL = True
9 except ImportError:
10     HAS_OPENSSL = False
11 OPENSSL_MIN_VER = "16.0.0"
12 __virtualname__ = "travisci"
13 def __virtual__():
14     if HAS_OPENSSL is False:
15         return (
16             False,
17             "The travisci module was unable to be loaded: Install pyOpenssl &gt;= {}".format(
18                 OPENSSL_MIN_VER
19             ),
20         )
21     cur_version = _LooseVersion(OpenSSL.__version__)
22     min_version = _LooseVersion(OPENSSL_MIN_VER)
23     if cur_version &lt; min_version:
24         return (
25             False,
26             "The travisci module was unable to be loaded: Install pyOpenssl &gt;= {}".format(
27                 OPENSSL_MIN_VER
28             ),
29         )
30     return __virtualname__
31 def verify_webhook(signature, body):
32     public_key = __utils__<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["http.query"]("https://api.travis-ci.org/config")["config"][
33         "notifications"
34     ]["webhook"]["public_key"]
35     pkey_public_key = OpenSSL.crypto.load_publickey(
36         OpenSSL.crypto.</b></font>FILETYPE_PEM, public_key
37     )
38     certificate = OpenSSL.crypto.X509()
39     signature = base64<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.b64decode(signature)
40     payload = salt.utils.json.loads(urllib.parse.parse_qs(body)["payload"][</b></font>0])
41     try:
42         OpenSSL.crypto.verify(certificate, signature, payload, "sha1")
43     except OpenSSL.crypto.Error:
44         return False
45     return True
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_pydsl.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import copy
2 import io
3 import os
4 import shutil
5 import sys
6 import tempfile
7 import textwrap
8 import pytest
9 import salt.config
10 import salt.loader
11 import salt.utils.files
12 import salt.utils.versions
13 from salt.state import HighState
14 from salt.utils.pydsl import PyDslError
15 from tests.support.helpers import with_tempdir
16 from tests.support.runtests import RUNTIME_VARS
17 from tests.support.unit import TestCase
18 REQUISITES = ["require", "require_in", "use", "use_in", "watch", "watch_in"]
19 class CommonTestCaseBoilerplate(TestCase):
20     def setUp(self):
21         self.root_dir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)
22         self.addCleanup(shutil.rmtree, self.root_dir, ignore_errors=True)
23         self.state_tree_dir = os.path.join(self.root_dir, "state_tree")
24         self.cache_dir = os.path.join(self.root_dir, "cachedir")
25         if not os.path.isdir(self.root_dir):
26             os.makedirs(self.root_dir)
27         if not os.path.isdir(self.state_tree_dir):
28             os.makedirs(self.state_tree_dir)
29         if not os.path.isdir(self.cache_dir):
30             os.makedirs(self.cache_dir)
31         self.config = salt.config.minion_config(None)
32         self.config["root_dir"] = self.root_dir
33         self.config["state_events"] = False
34         self.config["id"] = "match"
35         self.config["file_client"] = "local"
36         self.config["file_roots"] = dict(base=[self.state_tree_dir])
37         self.config["cachedir"] = self.cache_dir
38         self.config["test"] = False
39         self.config["grains"] = salt.loader.grains(self.config)
40         self.HIGHSTATE = HighState(self.config)
41         self.HIGHSTATE.push_active()
42     def tearDown(self):
43         try:
44             self.HIGHSTATE.pop_active()
45         except IndexError:
46             pass
47         del self.config
48         del self.HIGHSTATE
49     def state_highstate(self, state, dirpath):
50         opts = copy.copy(self.config)
51         opts["file_roots"] = dict(base=[dirpath])
52         HIGHSTATE = HighState(opts)
53         HIGHSTATE.push_active()
54         try:
55             high, errors = HIGHSTATE.render_highstate(state)
56             if errors:
57                 import pprint
58                 pprint.pprint("\n".join(errors))
59                 pprint.pprint(high)
60             out = HIGHSTATE.state.call_high(high)
61         finally:
62             HIGHSTATE.pop_active()
63 class PyDSLRendererTestCase(CommonTestCaseBoilerplate):
64     def render_sls(self, content, sls="", saltenv="base", **kws):
65         if "env" in kws:
66             kws.pop("env")
67         return self.HIGHSTATE.state.rend["pydsl"](
68             io.StringIO(content), saltenv=saltenv, sls=sls, **kws
69         )
70     @pytest.mark.slow_test
71     def test_state_declarations(self):
72         result = self.render_sls(
73             textwrap.dedent(
74                 """
75         self<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertTrue("A" in result and "X" in result)
76         A_cmd = result["A"]["cmd"]
77         self.assertEqual(A_cmd[0], "run")
78         self.assertEqual(A_cmd[1][</b></font>"name"], "ls -la")
79         self.assertEqual(A_cmd[2]["cwd"], "/var/tmp")
80         self.assertEqual(A_cmd[3]["shell"], "/bin/bash")
81         A_service = result["A"]["service"]
82         self.assertEqual(A_service[0], "running")
83         self.assertEqual(A_service[1]["name"], "apache")
84         X_cmd = result["X"]["cmd"]
85         self.assertEqual(X_cmd[0], "run")
86         self.assertEqual(X_cmd[1]["name"], "echo hello world")
87         self.assertEqual(X_cmd[2]["cwd"], "/")
88         del result["A"]
89         del result["X"]
90         self.assertEqual(len(result), 2)
91         s_iter = iter(result.values())
92         try:
93             s = next(s_iter)["file"]
94         except KeyError:
95             s = next(s_iter)["file"]
96         self.assertEqual(s[0], "managed")
97         self.assertEqual(s[1]["name"], "myfile.txt")
98         self.assertEqual(s[2]["source"], "salt://path/to/file")
99     @pytest.mark.slow_test
100     def test_requisite_declarations(self):
101         result = self.render_sls(
102             textwrap.dedent(
103                 """
104             state('X').cmd.run('echo hello')
105             state('A').cmd.run('mkdir tmp', cwd='/var')
106             state('B').cmd.run('ls -la', cwd='/var/tmp') \
107                         .require(state('X').cmd) \
108                         .require(cmd='A') \
109                         .watch(service='G')
110             state('G').service.running(name='collectd')
111             state('G').service.watch_in(state('A').cmd)
112             state('H').cmd.require_in(cmd='echo hello')
113             state('H').cmd.run('echo world')
114         """
115             )
116         )
117         self.assertEqual(len(result), 6)
118         self.assertTrue(set("X A B G H".split()).issubset(set(result.keys())))
119         b = result["B"]["cmd"]
120         self.assertEqual(b[0], "run")
121         self.assertEqual(b[1]["name"], "ls -la")
122         self.assertEqual(b[2]["cwd"], "/var/tmp")
123         self.assertEqual(b[3]["require"][0]["cmd"], "X")
124         self.assertEqual(b[4]["require"][0]["cmd"], "A")
125         self.assertEqual(b[5]["watch"][0]["service"], "G")
126         self.assertEqual(result["G"]["service"][2]["watch_in"][0]["cmd"], "A")
127         self.assertEqual(result["H"]["cmd"][1]["require_in"][0]["cmd"], "echo hello")
128     @pytest.mark.slow_test
129     def test_include_extend(self):
130         result = self.render_sls(
131             textwrap.dedent(
132                 """
133             include(
134                 'some.sls.file',
135                 'another.sls.file',
136                 'more.sls.file',
137                 delayed=True
138             )
139             A = state('A').cmd.run('echo hoho', cwd='/')
140             state('B').cmd.run('echo hehe', cwd='/')
141             extend(
142                 A,
143                 state('X').cmd.run(cwd='/a/b/c'),
144                 state('Y').file('managed', name='a_file.txt'),
145                 state('Z').service.watch(file='A')
146             )
147         """
148         )
149         self.assertEqual(len(result), 4)
150         self<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertEqual(
151             result["include"],
152             [
153                 {"base": sls}
154                 for sls in ("some.sls.file", "another.sls.file", "more.sls.file")
155             ],
156         )
157         extend = result["extend"]
158         self.assertEqual(extend["X"][</b></font>"cmd"][0], "run")
159         self.assertEqual(extend["X"]["cmd"][1]["cwd"], "/a/b/c")
160         self.assertEqual(extend["Y"]["file"][0], "managed")
161         self.assertEqual(extend["Y"]["file"][1]["name"], "a_file.txt")
162         self.assertEqual(len(extend["Z"]["service"]), 1)
163         self.assertEqual(extend["Z"]["service"][0]["watch"][0]["file"], "A")
164         self.assertEqual(result["B"]["cmd"][0], "run")
165         self.assertTrue("A" not in result)
166         self.assertEqual(extend["A"]["cmd"][0], "run")
167     @pytest.mark.slow_test
168     def test_cmd_call(self):
169         result = self.HIGHSTATE.state.call_template_str(
170             textwrap.dedent(
171                 """\
172             state('A').cmd.run('echo this is state A', cwd='/')
173             some_var = 12345
174             def do_something(a, b, *args, **kws):
175                 return dict(result=True, changes={'a': a, 'b': b, 'args': args, 'kws': kws, 'some_var': some_var})
176             state('C').cmd.call(do_something, 1, 2, 3, x=1, y=2) \
177                           .require(state('A').cmd)
178             state('G').cmd.wait('echo this is state G', cwd='/') \
179                           .watch(state('C').cmd)
180         """
181             )
182         )
183         ret = next(result[k] for k in result.keys() if "do_something" in k)
184         changes = ret["changes"]
185         self.assertEqual(
186             changes, dict(a=1, b=2, args=(3,), kws=dict(x=1, y=2), some_var=12345)
187         )
188         ret = next(result[k] for k in result.keys() if "-G_" in k)
189         self.assertEqual(ret["changes"]["stdout"], "this is state G")
190     @pytest.mark.slow_test
191     def test_multiple_state_func_in_state_mod(self):
192         with self.assertRaisesRegex(PyDslError, "Multiple state functions"):
193             self.render_sls(
194                 textwrap.dedent(
195                     """
196                 state('A').cmd.run('echo hoho')
197                 state('A').cmd.wait('echo hehe')
198             """
199                 )
200             )
201     @pytest.mark.slow_test
202     def test_no_state_func_in_state_mod(self):
203         with self.assertRaisesRegex(PyDslError, "No state function specified"):
204             self.render_sls(
205                 textwrap.dedent(
206                     """
207                 state('B').cmd.require(cmd='hoho')
208             """
209                 )
210             )
211     @pytest.mark.slow_test
212     def test_load_highstate(self):
213         result = self.render_sls(
214             textwrap.dedent(
215                 '''
216             import salt.utils.yaml
217             __pydsl__.load_highstate(salt.utils.yaml.safe_load("""
218             A:
219               cmd.run:
220                 - name: echo hello
221                 - cwd: /
222             B:
223               pkg:
224                 - installed
225               service:
226                 - running
227                 - require:
228                   - pkg: B
229                 - watch:
230                   - cmd: A
231             """))
232             state('A').cmd.run(name='echo hello world')
233             '''
234             )
235         )
236         self.assertEqual(len(result), 3)
237         self.assertEqual(result["A"]["cmd"][0], "run")
238         self.assertIn({"name": "echo hello"}, result["A"]["cmd"])
239         self.assertIn({"cwd": "/"}, result["A"]["cmd"])
240         self.assertIn({"name": "echo hello world"}, result["A"]["cmd"])
241         self.assertEqual(len(result["A"]["cmd"]), 4)
242         self.assertEqual(len(result["B"]["pkg"]), 1)
243         self.assertEqual(result["B"]["pkg"][0], "installed")
244         self.assertEqual(result["B"]["service"][0], "running")
245         self.assertIn({"require": [{"pkg": "B"}]}, result["B"]["service"])
246         self.assertIn({"watch": [{"cmd": "A"}]}, result["B"]["service"])
247         self.assertEqual(len(result["B"]["service"]), 3)
248     @pytest.mark.slow_test
249     def test_ordered_states(self):
250         result = self.render_sls(
251             textwrap.dedent(
252                 """
253             __pydsl__.set(ordered=True)
254             A = state('A')
255             state('B').cmd.run('echo bbbb')
256             A.cmd.run('echo aaa')
257             state('B').cmd.run(cwd='/')
258             state('C').cmd.run('echo ccc')
259             state('B').file.managed(source='/a/b/c')
260             """
261             )
262         )
263         self.assertEqual(len(result["B"]["cmd"]), 3)
264         self.assertEqual(result["A"]["cmd"][1]["require"][0]["cmd"], "B")
265         self.assertEqual(result["C"]["cmd"][1]["require"][0]["cmd"], "A")
266         self.assertEqual(result["B"]["file"][1]["require"][0]["cmd"], "C")
267     @with_tempdir()
268     @pytest.mark.slow_test
269     def test_pipe_through_stateconf(self, dirpath):
270         output = os.path.join(dirpath, "output")
271         write_to(
272             os.path.join(dirpath, "xxx.sls"),
273             textwrap.dedent(
274                 """#!stateconf -os yaml . jinja
275             .X:
276               cmd.run:
277                 - name: echo X &gt;&gt; {0}
278                 - cwd: /
279             .Y:
280               cmd.run:
281                 - name: echo Y &gt;&gt; {0}
282                 - cwd: /
283             .Z:
284               cmd.run:
285                 - name: echo Z &gt;&gt; {0}
286                 - cwd: /
287             """.format(
288                     output.replace("\\", "/")
289                 )
290             ),
291         )
292         write_to(
293             os.path.join(dirpath, "yyy.sls"),
294             textwrap.dedent(
295                 """\
296             __pydsl__.set(ordered=True)
297             state('.D').cmd.run('echo D &gt;&gt; {0}', cwd='/')
298             state('.E').cmd.run('echo E &gt;&gt; {0}', cwd='/')
299             state('.F').cmd.run('echo F &gt;&gt; {0}', cwd='/')
300             """.format(
301                     output.replace("\\", "/")
302                 )
303             ),
304         )
305         write_to(
306             os.path.join(dirpath, "aaa.sls"),
307             textwrap.dedent(
308                 """\
309             include('xxx', 'yyy')
310             extend(state('.start').stateconf.require(stateconf='xxx::goal'))
311             extend(state('.goal').stateconf.require_in(stateconf='yyy::start'))
312             __pydsl__.set(ordered=True)
313             state('.A').cmd.run('echo A &gt;&gt; {0}', cwd='/')
314             state('.B').cmd.run('echo B &gt;&gt; {0}', cwd='/')
315             state('.C').cmd.run('echo C &gt;&gt; {0}', cwd='/')
316             """.format(
317                     output.replace("\\", "/")
318                 )
319             ),
320         )
321         self.state_highstate({"base": ["aaa"]}, dirpath)
322         with salt.utils.files.fopen(output, "r") as f:
323             self.assertEqual("".join(f.read().split()), "XYZABCDEF")
324     @with_tempdir()
325     @pytest.mark.slow_test
326     def test_compile_time_state_execution(self, dirpath):
327         if not sys.stdin.isatty():
328             self.skipTest("Not attached to a TTY")
329         write_to(
330             os.path.join(dirpath, "aaa.sls"),
331             textwrap.dedent(
332                 """\
333             __pydsl__.set(ordered=True)
334             A = state('A')
335             A.cmd.run('echo hehe&gt;{0}/zzz.txt', cwd='/')
336             A.file.managed('{0}/yyy.txt', source='salt://zzz.txt')
337             A()
338             A()
339             state().cmd.run('echo hoho&gt;&gt;{0}/yyy.txt', cwd='/')
340             A.file.managed('{0}/xxx.txt', source='salt://zzz.txt')
341             A()
342             """.format(
343                     dirpath.replace("\\", "/")
344                 )
345             ),
346         )
347         self.state_highstate({"base": ["aaa"]}, dirpath)
348         with salt.utils.files.fopen(os.path.join(dirpath, "yyy.txt"), "rt") as f:
349             self.assertEqual(f.read(), "hehe" + os.linesep + "hoho" + os.linesep)
350         with salt.utils.files.fopen(os.path.join(dirpath, "xxx.txt"), "rt") as f:
351             self.assertEqual(f.read(), "hehe" + os.linesep)
352     @with_tempdir()
353     @pytest.mark.slow_test
354     def test_nested_high_state_execution(self, dirpath):
355         output = os.path.join(dirpath, "output")
356         write_to(
357             os.path.join(dirpath, "aaa.sls"),
358             textwrap.dedent(
359                 """\
360             __salt__['state.sls']('bbb')
361             state().cmd.run('echo bbbbbb', cwd='/')
362             """
363             ),
364         )
365         write_to(
366             os.path.join(dirpath, "bbb.sls"),
367             textwrap.dedent(
368                 """
369             test:
370               cmd.run:
371                 - name: echo bbbbbbb
372                 - cwd: /
373             """
374             ),
375         )
376         write_to(
377             os.path.join(dirpath, "ccc.sls"),
378             textwrap.dedent(
379                 """
380             state().cmd.run('echo ccccc', cwd='/')
381             """
382             ),
383         )
384         self.state_highstate({"base": ["aaa"]}, dirpath)
385     @with_tempdir()
386     @pytest.mark.slow_test
387     def test_repeat_includes(self, dirpath):
388         output = os.path.join(dirpath, "output")
389         write_to(
390             os.path.join(dirpath, "b.sls"),
391             textwrap.dedent(
392                 """\
393             include('c')
394             include('d')
395             """
396             ),
397         )
398         write_to(
399             os.path.join(dirpath, "c.sls"),
400             textwrap.dedent(
401                 """\
402             modtest = include('e')
403             modtest.success
404             """
405             ),
406         )
407         write_to(
408             os.path.join(dirpath, "d.sls"),
409             textwrap.dedent(
410                 """\
411             modtest = include('e')
412             modtest.success
413             """
414             ),
415         )
416         write_to(
417             os.path.join(dirpath, "e.sls"),
418             textwrap.dedent(
419                 """\
420             success = True
421             """
422             ),
423         )
424         self.state_highstate({"base": ["b"]}, dirpath)
425         self.state_highstate({"base": ["c", "d"]}, dirpath)
426 def write_to(fpath, content):
427     with salt.utils.files.fopen(fpath, "w") as f:
428         f.write(content)
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
