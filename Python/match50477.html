<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for travisci.py &amp; test_pydsl.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for travisci.py &amp; test_pydsl.py
      </h3>
<h1 align="center">
        5.7%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>travisci.py (31.16883%)<th>test_pydsl.py (3.1537452%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(75-78)<td><a href="#" name="0">(107-110)</a><td align="center"><font color="#ff0000">12</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(65-69)<td><a href="#" name="1">(192-200)</a><td align="center"><font color="#ff0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>travisci.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
"""
Commands for working with travisci.
:depends: pyOpenSSL &gt;= 16.0.0
"""
import base64
import urllib.parse
import salt.utils.json
from salt.utils.versions import LooseVersion as _LooseVersion
try:
    import OpenSSL
    import OpenSSL.crypto
    HAS_OPENSSL = True
except ImportError:
    HAS_OPENSSL = False
OPENSSL_MIN_VER = "16.0.0"
__virtualname__ = "travisci"
def __virtual__():
    if HAS_OPENSSL is False:
        return (
            False,
            "The travisci module was unable to be loaded: Install pyOpenssl &gt;= {}".format(
                OPENSSL_MIN_VER
            ),
        )
    cur_version = _LooseVersion(OpenSSL.__version__)
    min_version = _LooseVersion(OPENSSL_MIN_VER)
    if cur_version &lt; min_version:
        return (
            False,
            "The travisci module was unable to be loaded: Install pyOpenssl &gt;= {}".format(
                OPENSSL_MIN_VER
            ),
        )
    return __virtualname__
def verify_webhook(signature, body):
    """
    Verify the webhook signature from travisci
    signature
        The signature header from the webhook header
    body
        The full payload body from the webhook post
    .. note:: The body needs to be the urlencoded version of the body.
    CLI Example:
    .. code-block:: bash
        salt '*' travisci.verify_webhook 'M6NucCX5722bxisQs7e...' 'payload=%7B%22id%22%3A183791261%2C%22repository...'
    """
    public_key = __utils__<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["http.query"]("https://api.travis-ci.org/config")["config"][
        "notifications"
    ]["webhook"]["public_key"]
    pkey_public_key = OpenSSL.crypto.load_publickey(
        OpenSSL.crypto.</b></font>FILETYPE_PEM, public_key
    )
    certificate = OpenSSL.crypto.X509()
    signature = base64<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.b64decode(signature)
    payload = salt.utils.json.loads(urllib.parse.parse_qs(body)["payload"][</b></font>0])
    try:
        OpenSSL.crypto.verify(certificate, signature, payload, "sha1")
    except OpenSSL.crypto.Error:
        return False
    return True
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_pydsl.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
import copy
import io
import os
import shutil
import sys
import tempfile
import textwrap
import pytest
import salt.config
import salt.loader
import salt.utils.files
import salt.utils.versions
from salt.state import HighState
from salt.utils.pydsl import PyDslError
from tests.support.helpers import with_tempdir
from tests.support.runtests import RUNTIME_VARS
from tests.support.unit import TestCase
REQUISITES = ["require", "require_in", "use", "use_in", "watch", "watch_in"]
class CommonTestCaseBoilerplate(TestCase):
    def setUp(self):
        self.root_dir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)
        self.addCleanup(shutil.rmtree, self.root_dir, ignore_errors=True)
        self.state_tree_dir = os.path.join(self.root_dir, "state_tree")
        self.cache_dir = os.path.join(self.root_dir, "cachedir")
        if not os.path.isdir(self.root_dir):
            os.makedirs(self.root_dir)
        if not os.path.isdir(self.state_tree_dir):
            os.makedirs(self.state_tree_dir)
        if not os.path.isdir(self.cache_dir):
            os.makedirs(self.cache_dir)
        self.config = salt.config.minion_config(None)
        self.config["root_dir"] = self.root_dir
        self.config["state_events"] = False
        self.config["id"] = "match"
        self.config["file_client"] = "local"
        self.config["file_roots"] = dict(base=[self.state_tree_dir])
        self.config["cachedir"] = self.cache_dir
        self.config["test"] = False
        self.config["grains"] = salt.loader.grains(self.config)
        self.HIGHSTATE = HighState(self.config)
        self.HIGHSTATE.push_active()
    def tearDown(self):
        try:
            self.HIGHSTATE.pop_active()
        except IndexError:
            pass
        del self.config
        del self.HIGHSTATE
    def state_highstate(self, state, dirpath):
        opts = copy.copy(self.config)
        opts["file_roots"] = dict(base=[dirpath])
        HIGHSTATE = HighState(opts)
        HIGHSTATE.push_active()
        try:
            high, errors = HIGHSTATE.render_highstate(state)
            if errors:
                import pprint
                pprint.pprint("\n".join(errors))
                pprint.pprint(high)
            out = HIGHSTATE.state.call_high(high)
        finally:
            HIGHSTATE.pop_active()
class PyDSLRendererTestCase(CommonTestCaseBoilerplate):
    """
    WARNING: If tests in here are flaky, they may need
    to be moved to their own class. Sharing HighState, especially
    through setUp/tearDown can create dangerous race conditions!
    """
    def render_sls(self, content, sls="", saltenv="base", **kws):
        if "env" in kws:
            kws.pop("env")
        return self.HIGHSTATE.state.rend["pydsl"](
            io.StringIO(content), saltenv=saltenv, sls=sls, **kws
        )
    @pytest.mark.slow_test
    def test_state_declarations(self):
        result = self.render_sls(
            textwrap.dedent(
                """
            state('A').cmd.run('ls -la', cwd='/var/tmp')
            state().file.managed('myfile.txt', source='salt://path/to/file')
            state('X').cmd('run', 'echo hello world', cwd='/')
            a_cmd = state('A').cmd
            a_cmd.run(shell='/bin/bash')
            state('A').service.running(name='apache')
            )
        )
        self<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertTrue("A" in result and "X" in result)
        A_cmd = result["A"]["cmd"]
        self.assertEqual(A_cmd[0], "run")
        self.assertEqual(A_cmd[1][</b></font>"name"], "ls -la")
        self.assertEqual(A_cmd[2]["cwd"], "/var/tmp")
        self.assertEqual(A_cmd[3]["shell"], "/bin/bash")
        A_service = result["A"]["service"]
        self.assertEqual(A_service[0], "running")
        self.assertEqual(A_service[1]["name"], "apache")
        X_cmd = result["X"]["cmd"]
        self.assertEqual(X_cmd[0], "run")
        self.assertEqual(X_cmd[1]["name"], "echo hello world")
        self.assertEqual(X_cmd[2]["cwd"], "/")
        del result["A"]
        del result["X"]
        self.assertEqual(len(result), 2)
        s_iter = iter(result.values())
        try:
            s = next(s_iter)["file"]
        except KeyError:
            s = next(s_iter)["file"]
        self.assertEqual(s[0], "managed")
        self.assertEqual(s[1]["name"], "myfile.txt")
        self.assertEqual(s[2]["source"], "salt://path/to/file")
    @pytest.mark.slow_test
    def test_requisite_declarations(self):
        result = self.render_sls(
            textwrap.dedent(
                """
            state('X').cmd.run('echo hello')
            state('A').cmd.run('mkdir tmp', cwd='/var')
            state('B').cmd.run('ls -la', cwd='/var/tmp') \
                        .require(state('X').cmd) \
                        .require(cmd='A') \
                        .watch(service='G')
            state('G').service.running(name='collectd')
            state('G').service.watch_in(state('A').cmd)
            state('H').cmd.require_in(cmd='echo hello')
            state('H').cmd.run('echo world')
        """
            )
        )
        self.assertEqual(len(result), 6)
        self.assertTrue(set("X A B G H".split()).issubset(set(result.keys())))
        b = result["B"]["cmd"]
        self.assertEqual(b[0], "run")
        self.assertEqual(b[1]["name"], "ls -la")
        self.assertEqual(b[2]["cwd"], "/var/tmp")
        self.assertEqual(b[3]["require"][0]["cmd"], "X")
        self.assertEqual(b[4]["require"][0]["cmd"], "A")
        self.assertEqual(b[5]["watch"][0]["service"], "G")
        self.assertEqual(result["G"]["service"][2]["watch_in"][0]["cmd"], "A")
        self.assertEqual(result["H"]["cmd"][1]["require_in"][0]["cmd"], "echo hello")
    @pytest.mark.slow_test
    def test_include_extend(self):
        result = self.render_sls(
            textwrap.dedent(
                """
            include(
                'some.sls.file',
                'another.sls.file',
                'more.sls.file',
                delayed=True
            )
            A = state('A').cmd.run('echo hoho', cwd='/')
            state('B').cmd.run('echo hehe', cwd='/')
            extend(
                A,
                state('X').cmd.run(cwd='/a/b/c'),
                state('Y').file('managed', name='a_file.txt'),
                state('Z').service.watch(file='A')
            )
        """
        )
        self.assertEqual(len(result), 4)
        self<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertEqual(
            result["include"],
            [
                {"base": sls}
                for sls in ("some.sls.file", "another.sls.file", "more.sls.file")
            ],
        )
        extend = result["extend"]
        self.assertEqual(extend["X"][</b></font>"cmd"][0], "run")
        self.assertEqual(extend["X"]["cmd"][1]["cwd"], "/a/b/c")
        self.assertEqual(extend["Y"]["file"][0], "managed")
        self.assertEqual(extend["Y"]["file"][1]["name"], "a_file.txt")
        self.assertEqual(len(extend["Z"]["service"]), 1)
        self.assertEqual(extend["Z"]["service"][0]["watch"][0]["file"], "A")
        self.assertEqual(result["B"]["cmd"][0], "run")
        self.assertTrue("A" not in result)
        self.assertEqual(extend["A"]["cmd"][0], "run")
    @pytest.mark.slow_test
    def test_cmd_call(self):
        result = self.HIGHSTATE.state.call_template_str(
            textwrap.dedent(
                """\
            state('A').cmd.run('echo this is state A', cwd='/')
            some_var = 12345
            def do_something(a, b, *args, **kws):
                return dict(result=True, changes={'a': a, 'b': b, 'args': args, 'kws': kws, 'some_var': some_var})
            state('C').cmd.call(do_something, 1, 2, 3, x=1, y=2) \
                          .require(state('A').cmd)
            state('G').cmd.wait('echo this is state G', cwd='/') \
                          .watch(state('C').cmd)
        """
            )
        )
        ret = next(result[k] for k in result.keys() if "do_something" in k)
        changes = ret["changes"]
        self.assertEqual(
            changes, dict(a=1, b=2, args=(3,), kws=dict(x=1, y=2), some_var=12345)
        )
        ret = next(result[k] for k in result.keys() if "-G_" in k)
        self.assertEqual(ret["changes"]["stdout"], "this is state G")
    @pytest.mark.slow_test
    def test_multiple_state_func_in_state_mod(self):
        with self.assertRaisesRegex(PyDslError, "Multiple state functions"):
            self.render_sls(
                textwrap.dedent(
                    """
                state('A').cmd.run('echo hoho')
                state('A').cmd.wait('echo hehe')
            """
                )
            )
    @pytest.mark.slow_test
    def test_no_state_func_in_state_mod(self):
        with self.assertRaisesRegex(PyDslError, "No state function specified"):
            self.render_sls(
                textwrap.dedent(
                    """
                state('B').cmd.require(cmd='hoho')
            """
                )
            )
    @pytest.mark.slow_test
    def test_load_highstate(self):
        result = self.render_sls(
            textwrap.dedent(
                '''
            import salt.utils.yaml
            __pydsl__.load_highstate(salt.utils.yaml.safe_load("""
            A:
              cmd.run:
                - name: echo hello
                - cwd: /
            B:
              pkg:
                - installed
              service:
                - running
                - require:
                  - pkg: B
                - watch:
                  - cmd: A
            """))
            state('A').cmd.run(name='echo hello world')
            '''
            )
        )
        self.assertEqual(len(result), 3)
        self.assertEqual(result["A"]["cmd"][0], "run")
        self.assertIn({"name": "echo hello"}, result["A"]["cmd"])
        self.assertIn({"cwd": "/"}, result["A"]["cmd"])
        self.assertIn({"name": "echo hello world"}, result["A"]["cmd"])
        self.assertEqual(len(result["A"]["cmd"]), 4)
        self.assertEqual(len(result["B"]["pkg"]), 1)
        self.assertEqual(result["B"]["pkg"][0], "installed")
        self.assertEqual(result["B"]["service"][0], "running")
        self.assertIn({"require": [{"pkg": "B"}]}, result["B"]["service"])
        self.assertIn({"watch": [{"cmd": "A"}]}, result["B"]["service"])
        self.assertEqual(len(result["B"]["service"]), 3)
    @pytest.mark.slow_test
    def test_ordered_states(self):
        result = self.render_sls(
            textwrap.dedent(
                """
            __pydsl__.set(ordered=True)
            A = state('A')
            state('B').cmd.run('echo bbbb')
            A.cmd.run('echo aaa')
            state('B').cmd.run(cwd='/')
            state('C').cmd.run('echo ccc')
            state('B').file.managed(source='/a/b/c')
            """
            )
        )
        self.assertEqual(len(result["B"]["cmd"]), 3)
        self.assertEqual(result["A"]["cmd"][1]["require"][0]["cmd"], "B")
        self.assertEqual(result["C"]["cmd"][1]["require"][0]["cmd"], "A")
        self.assertEqual(result["B"]["file"][1]["require"][0]["cmd"], "C")
    @with_tempdir()
    @pytest.mark.slow_test
    def test_pipe_through_stateconf(self, dirpath):
        output = os.path.join(dirpath, "output")
        write_to(
            os.path.join(dirpath, "xxx.sls"),
            textwrap.dedent(
                """#!stateconf -os yaml . jinja
            .X:
              cmd.run:
                - name: echo X &gt;&gt; {0}
                - cwd: /
            .Y:
              cmd.run:
                - name: echo Y &gt;&gt; {0}
                - cwd: /
            .Z:
              cmd.run:
                - name: echo Z &gt;&gt; {0}
                - cwd: /
            """.format(
                    output.replace("\\", "/")
                )
            ),
        )
        write_to(
            os.path.join(dirpath, "yyy.sls"),
            textwrap.dedent(
                """\
            __pydsl__.set(ordered=True)
            state('.D').cmd.run('echo D &gt;&gt; {0}', cwd='/')
            state('.E').cmd.run('echo E &gt;&gt; {0}', cwd='/')
            state('.F').cmd.run('echo F &gt;&gt; {0}', cwd='/')
            """.format(
                    output.replace("\\", "/")
                )
            ),
        )
        write_to(
            os.path.join(dirpath, "aaa.sls"),
            textwrap.dedent(
                """\
            include('xxx', 'yyy')
            extend(state('.start').stateconf.require(stateconf='xxx::goal'))
            extend(state('.goal').stateconf.require_in(stateconf='yyy::start'))
            __pydsl__.set(ordered=True)
            state('.A').cmd.run('echo A &gt;&gt; {0}', cwd='/')
            state('.B').cmd.run('echo B &gt;&gt; {0}', cwd='/')
            state('.C').cmd.run('echo C &gt;&gt; {0}', cwd='/')
            """.format(
                    output.replace("\\", "/")
                )
            ),
        )
        self.state_highstate({"base": ["aaa"]}, dirpath)
        with salt.utils.files.fopen(output, "r") as f:
            self.assertEqual("".join(f.read().split()), "XYZABCDEF")
    @with_tempdir()
    @pytest.mark.slow_test
    def test_compile_time_state_execution(self, dirpath):
        if not sys.stdin.isatty():
            self.skipTest("Not attached to a TTY")
        write_to(
            os.path.join(dirpath, "aaa.sls"),
            textwrap.dedent(
                """\
            __pydsl__.set(ordered=True)
            A = state('A')
            A.cmd.run('echo hehe&gt;{0}/zzz.txt', cwd='/')
            A.file.managed('{0}/yyy.txt', source='salt://zzz.txt')
            A()
            A()
            state().cmd.run('echo hoho&gt;&gt;{0}/yyy.txt', cwd='/')
            A.file.managed('{0}/xxx.txt', source='salt://zzz.txt')
            A()
            """.format(
                    dirpath.replace("\\", "/")
                )
            ),
        )
        self.state_highstate({"base": ["aaa"]}, dirpath)
        with salt.utils.files.fopen(os.path.join(dirpath, "yyy.txt"), "rt") as f:
            self.assertEqual(f.read(), "hehe" + os.linesep + "hoho" + os.linesep)
        with salt.utils.files.fopen(os.path.join(dirpath, "xxx.txt"), "rt") as f:
            self.assertEqual(f.read(), "hehe" + os.linesep)
    @with_tempdir()
    @pytest.mark.slow_test
    def test_nested_high_state_execution(self, dirpath):
        output = os.path.join(dirpath, "output")
        write_to(
            os.path.join(dirpath, "aaa.sls"),
            textwrap.dedent(
                """\
            __salt__['state.sls']('bbb')
            state().cmd.run('echo bbbbbb', cwd='/')
            """
            ),
        )
        write_to(
            os.path.join(dirpath, "bbb.sls"),
            textwrap.dedent(
                """
            test:
              cmd.run:
                - name: echo bbbbbbb
                - cwd: /
            """
            ),
        )
        write_to(
            os.path.join(dirpath, "ccc.sls"),
            textwrap.dedent(
                """
            state().cmd.run('echo ccccc', cwd='/')
            """
            ),
        )
        self.state_highstate({"base": ["aaa"]}, dirpath)
    @with_tempdir()
    @pytest.mark.slow_test
    def test_repeat_includes(self, dirpath):
        output = os.path.join(dirpath, "output")
        write_to(
            os.path.join(dirpath, "b.sls"),
            textwrap.dedent(
                """\
            include('c')
            include('d')
            """
            ),
        )
        write_to(
            os.path.join(dirpath, "c.sls"),
            textwrap.dedent(
                """\
            modtest = include('e')
            modtest.success
            """
            ),
        )
        write_to(
            os.path.join(dirpath, "d.sls"),
            textwrap.dedent(
                """\
            modtest = include('e')
            modtest.success
            """
            ),
        )
        write_to(
            os.path.join(dirpath, "e.sls"),
            textwrap.dedent(
                """\
            success = True
            """
            ),
        )
        self.state_highstate({"base": ["b"]}, dirpath)
        self.state_highstate({"base": ["c", "d"]}, dirpath)
def write_to(fpath, content):
    with salt.utils.files.fopen(fpath, "w") as f:
        f.write(content)
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
