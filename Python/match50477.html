<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for travisci.py & test_pydsl.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for travisci.py & test_pydsl.py
      </h3>
      <h1 align="center">
        5.7%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>travisci.py (31.16883%)<TH>test_pydsl.py (3.1537452%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match50477-0.html#0',2,'match50477-1.html#0',3)" NAME="0">(75-78)<TD><A HREF="javascript:ZweiFrames('match50477-0.html#0',2,'match50477-1.html#0',3)" NAME="0">(107-110)</A><TD ALIGN=center><FONT COLOR="#ff0000">12</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match50477-0.html#1',2,'match50477-1.html#1',3)" NAME="1">(65-69)<TD><A HREF="javascript:ZweiFrames('match50477-0.html#1',2,'match50477-1.html#1',3)" NAME="1">(192-200)</A><TD ALIGN=center><FONT COLOR="#ff0000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>travisci.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
Commands for working with travisci.

:depends: pyOpenSSL &gt;= 16.0.0
&quot;&quot;&quot;
import base64
import urllib.parse

import salt.utils.json
from salt.utils.versions import LooseVersion as _LooseVersion

try:
    import OpenSSL
    import OpenSSL.crypto

    HAS_OPENSSL = True
except ImportError:
    HAS_OPENSSL = False


OPENSSL_MIN_VER = &quot;16.0.0&quot;
__virtualname__ = &quot;travisci&quot;


def __virtual__():
    if HAS_OPENSSL is False:
        return (
            False,
            &quot;The travisci module was unable to be loaded: Install pyOpenssl &gt;= {}&quot;.format(
                OPENSSL_MIN_VER
            ),
        )
    cur_version = _LooseVersion(OpenSSL.__version__)
    min_version = _LooseVersion(OPENSSL_MIN_VER)
    if cur_version &lt; min_version:
        return (
            False,
            &quot;The travisci module was unable to be loaded: Install pyOpenssl &gt;= {}&quot;.format(
                OPENSSL_MIN_VER
            ),
        )
    return __virtualname__


def verify_webhook(signature, body):
    &quot;&quot;&quot;
    Verify the webhook signature from travisci

    signature
        The signature header from the webhook header

    body
        The full payload body from the webhook post

    .. note:: The body needs to be the urlencoded version of the body.

    CLI Example:

    .. code-block:: bash

        salt '*' travisci.verify_webhook 'M6NucCX5722bxisQs7e...' 'payload=%7B%22id%22%3A183791261%2C%22repository...'
<A NAME="1"></A>
    &quot;&quot;&quot;
    # get public key setup
    public_key = __utils__<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match50477-1.html#1',3,'match50477-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>[&quot;http.query&quot;](&quot;https://api.travis-ci.org/config&quot;)[&quot;config&quot;][
        &quot;notifications&quot;
    ][&quot;webhook&quot;][&quot;public_key&quot;]
    pkey_public_key = OpenSSL.crypto.load_publickey(
        OpenSSL.crypto.</B></FONT>FILETYPE_PEM, public_key
    )
    certificate = OpenSSL.crypto.X509()
<A NAME="0"></A>    certificate.set_pubkey(pkey_public_key)

    # decode signature
    signature = base64<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match50477-1.html#0',3,'match50477-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.b64decode(signature)

    # parse the urlencoded payload from travis
    payload = salt.utils.json.loads(urllib.parse.parse_qs(body)[&quot;payload&quot;][</B></FONT>0])

    try:
        OpenSSL.crypto.verify(certificate, signature, payload, &quot;sha1&quot;)
    except OpenSSL.crypto.Error:
        return False
    return True
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_pydsl.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
import copy
import io
import os
import shutil
import sys
import tempfile
import textwrap

import pytest
import salt.config
import salt.loader
import salt.utils.files
import salt.utils.versions
from salt.state import HighState
from salt.utils.pydsl import PyDslError
from tests.support.helpers import with_tempdir
from tests.support.runtests import RUNTIME_VARS
from tests.support.unit import TestCase

REQUISITES = [&quot;require&quot;, &quot;require_in&quot;, &quot;use&quot;, &quot;use_in&quot;, &quot;watch&quot;, &quot;watch_in&quot;]


class CommonTestCaseBoilerplate(TestCase):
    def setUp(self):
        self.root_dir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)
        self.addCleanup(shutil.rmtree, self.root_dir, ignore_errors=True)
        self.state_tree_dir = os.path.join(self.root_dir, &quot;state_tree&quot;)
        self.cache_dir = os.path.join(self.root_dir, &quot;cachedir&quot;)
        if not os.path.isdir(self.root_dir):
            os.makedirs(self.root_dir)

        if not os.path.isdir(self.state_tree_dir):
            os.makedirs(self.state_tree_dir)

        if not os.path.isdir(self.cache_dir):
            os.makedirs(self.cache_dir)
        self.config = salt.config.minion_config(None)
        self.config[&quot;root_dir&quot;] = self.root_dir
        self.config[&quot;state_events&quot;] = False
        self.config[&quot;id&quot;] = &quot;match&quot;
        self.config[&quot;file_client&quot;] = &quot;local&quot;
        self.config[&quot;file_roots&quot;] = dict(base=[self.state_tree_dir])
        self.config[&quot;cachedir&quot;] = self.cache_dir
        self.config[&quot;test&quot;] = False
        self.config[&quot;grains&quot;] = salt.loader.grains(self.config)
        self.HIGHSTATE = HighState(self.config)
        self.HIGHSTATE.push_active()

    def tearDown(self):
        try:
            self.HIGHSTATE.pop_active()
        except IndexError:
            pass
        del self.config
        del self.HIGHSTATE

    def state_highstate(self, state, dirpath):
        opts = copy.copy(self.config)
        opts[&quot;file_roots&quot;] = dict(base=[dirpath])
        HIGHSTATE = HighState(opts)
        HIGHSTATE.push_active()
        try:
            high, errors = HIGHSTATE.render_highstate(state)
            if errors:
                import pprint

                pprint.pprint(&quot;\n&quot;.join(errors))
                pprint.pprint(high)

            out = HIGHSTATE.state.call_high(high)
            # pprint.pprint(out)
        finally:
            HIGHSTATE.pop_active()


class PyDSLRendererTestCase(CommonTestCaseBoilerplate):
    &quot;&quot;&quot;
    WARNING: If tests in here are flaky, they may need
    to be moved to their own class. Sharing HighState, especially
    through setUp/tearDown can create dangerous race conditions!
    &quot;&quot;&quot;

    def render_sls(self, content, sls=&quot;&quot;, saltenv=&quot;base&quot;, **kws):
        if &quot;env&quot; in kws:
            # &quot;env&quot; is not supported; Use &quot;saltenv&quot;.
            kws.pop(&quot;env&quot;)

        return self.HIGHSTATE.state.rend[&quot;pydsl&quot;](
            io.StringIO(content), saltenv=saltenv, sls=sls, **kws
        )

    @pytest.mark.slow_test
    def test_state_declarations(self):
        result = self.render_sls(
            textwrap.dedent(
                &quot;&quot;&quot;
            state('A').cmd.run('ls -la', cwd='/var/tmp')
            state().file.managed('myfile.txt', source='salt://path/to/file')
            state('X').cmd('run', 'echo hello world', cwd='/')

            a_cmd = state('A').cmd
            a_cmd.run(shell='/bin/bash')
            state('A').service.running(name='apache')
<A NAME="0"></A>        &quot;&quot;&quot;
            )
        )
        self<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50477-0.html#0',2,'match50477-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.assertTrue(&quot;A&quot; in result and &quot;X&quot; in result)
        A_cmd = result[&quot;A&quot;][&quot;cmd&quot;]
        self.assertEqual(A_cmd[0], &quot;run&quot;)
        self.assertEqual(A_cmd[1][</B></FONT>&quot;name&quot;], &quot;ls -la&quot;)
        self.assertEqual(A_cmd[2][&quot;cwd&quot;], &quot;/var/tmp&quot;)
        self.assertEqual(A_cmd[3][&quot;shell&quot;], &quot;/bin/bash&quot;)

        A_service = result[&quot;A&quot;][&quot;service&quot;]
        self.assertEqual(A_service[0], &quot;running&quot;)
        self.assertEqual(A_service[1][&quot;name&quot;], &quot;apache&quot;)

        X_cmd = result[&quot;X&quot;][&quot;cmd&quot;]
        self.assertEqual(X_cmd[0], &quot;run&quot;)
        self.assertEqual(X_cmd[1][&quot;name&quot;], &quot;echo hello world&quot;)
        self.assertEqual(X_cmd[2][&quot;cwd&quot;], &quot;/&quot;)

        del result[&quot;A&quot;]
        del result[&quot;X&quot;]
        self.assertEqual(len(result), 2)
        # 2 rather than 1 because pydsl adds an extra no-op state
        # declaration.

        s_iter = iter(result.values())
        try:
            s = next(s_iter)[&quot;file&quot;]
        except KeyError:
            s = next(s_iter)[&quot;file&quot;]
        self.assertEqual(s[0], &quot;managed&quot;)
        self.assertEqual(s[1][&quot;name&quot;], &quot;myfile.txt&quot;)
        self.assertEqual(s[2][&quot;source&quot;], &quot;salt://path/to/file&quot;)

    @pytest.mark.slow_test
    def test_requisite_declarations(self):
        result = self.render_sls(
            textwrap.dedent(
                &quot;&quot;&quot;
            state('X').cmd.run('echo hello')
            state('A').cmd.run('mkdir tmp', cwd='/var')
            state('B').cmd.run('ls -la', cwd='/var/tmp') \
                        .require(state('X').cmd) \
                        .require(cmd='A') \
                        .watch(service='G')
            state('G').service.running(name='collectd')
            state('G').service.watch_in(state('A').cmd)

            state('H').cmd.require_in(cmd='echo hello')
            state('H').cmd.run('echo world')
        &quot;&quot;&quot;
            )
        )
        self.assertEqual(len(result), 6)
        self.assertTrue(set(&quot;X A B G H&quot;.split()).issubset(set(result.keys())))
        b = result[&quot;B&quot;][&quot;cmd&quot;]
        self.assertEqual(b[0], &quot;run&quot;)
        self.assertEqual(b[1][&quot;name&quot;], &quot;ls -la&quot;)
        self.assertEqual(b[2][&quot;cwd&quot;], &quot;/var/tmp&quot;)
        self.assertEqual(b[3][&quot;require&quot;][0][&quot;cmd&quot;], &quot;X&quot;)
        self.assertEqual(b[4][&quot;require&quot;][0][&quot;cmd&quot;], &quot;A&quot;)
        self.assertEqual(b[5][&quot;watch&quot;][0][&quot;service&quot;], &quot;G&quot;)
        self.assertEqual(result[&quot;G&quot;][&quot;service&quot;][2][&quot;watch_in&quot;][0][&quot;cmd&quot;], &quot;A&quot;)
        self.assertEqual(result[&quot;H&quot;][&quot;cmd&quot;][1][&quot;require_in&quot;][0][&quot;cmd&quot;], &quot;echo hello&quot;)

    @pytest.mark.slow_test
    def test_include_extend(self):
        result = self.render_sls(
            textwrap.dedent(
                &quot;&quot;&quot;
            include(
                'some.sls.file',
                'another.sls.file',
                'more.sls.file',
                delayed=True
            )
            A = state('A').cmd.run('echo hoho', cwd='/')
            state('B').cmd.run('echo hehe', cwd='/')
            extend(
                A,
                state('X').cmd.run(cwd='/a/b/c'),
                state('Y').file('managed', name='a_file.txt'),
                state('Z').service.watch(file='A')
            )
        &quot;&quot;&quot;
<A NAME="1"></A>            )
        )
        self.assertEqual(len(result), 4)
        self<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50477-0.html#1',2,'match50477-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.assertEqual(
            result[&quot;include&quot;],
            [
                {&quot;base&quot;: sls}
                for sls in (&quot;some.sls.file&quot;, &quot;another.sls.file&quot;, &quot;more.sls.file&quot;)
            ],
        )
        extend = result[&quot;extend&quot;]
        self.assertEqual(extend[&quot;X&quot;][</B></FONT>&quot;cmd&quot;][0], &quot;run&quot;)
        self.assertEqual(extend[&quot;X&quot;][&quot;cmd&quot;][1][&quot;cwd&quot;], &quot;/a/b/c&quot;)
        self.assertEqual(extend[&quot;Y&quot;][&quot;file&quot;][0], &quot;managed&quot;)
        self.assertEqual(extend[&quot;Y&quot;][&quot;file&quot;][1][&quot;name&quot;], &quot;a_file.txt&quot;)
        self.assertEqual(len(extend[&quot;Z&quot;][&quot;service&quot;]), 1)
        self.assertEqual(extend[&quot;Z&quot;][&quot;service&quot;][0][&quot;watch&quot;][0][&quot;file&quot;], &quot;A&quot;)

        self.assertEqual(result[&quot;B&quot;][&quot;cmd&quot;][0], &quot;run&quot;)
        self.assertTrue(&quot;A&quot; not in result)
        self.assertEqual(extend[&quot;A&quot;][&quot;cmd&quot;][0], &quot;run&quot;)

    @pytest.mark.slow_test
    def test_cmd_call(self):
        result = self.HIGHSTATE.state.call_template_str(
            textwrap.dedent(
                &quot;&quot;&quot;\
            #!pydsl
            state('A').cmd.run('echo this is state A', cwd='/')

            some_var = 12345
            def do_something(a, b, *args, **kws):
                return dict(result=True, changes={'a': a, 'b': b, 'args': args, 'kws': kws, 'some_var': some_var})

            state('C').cmd.call(do_something, 1, 2, 3, x=1, y=2) \
                          .require(state('A').cmd)

            state('G').cmd.wait('echo this is state G', cwd='/') \
                          .watch(state('C').cmd)
        &quot;&quot;&quot;
            )
        )
        ret = next(result[k] for k in result.keys() if &quot;do_something&quot; in k)
        changes = ret[&quot;changes&quot;]
        self.assertEqual(
            changes, dict(a=1, b=2, args=(3,), kws=dict(x=1, y=2), some_var=12345)
        )

        ret = next(result[k] for k in result.keys() if &quot;-G_&quot; in k)
        self.assertEqual(ret[&quot;changes&quot;][&quot;stdout&quot;], &quot;this is state G&quot;)

    @pytest.mark.slow_test
    def test_multiple_state_func_in_state_mod(self):
        with self.assertRaisesRegex(PyDslError, &quot;Multiple state functions&quot;):
            self.render_sls(
                textwrap.dedent(
                    &quot;&quot;&quot;
                state('A').cmd.run('echo hoho')
                state('A').cmd.wait('echo hehe')
            &quot;&quot;&quot;
                )
            )

    @pytest.mark.slow_test
    def test_no_state_func_in_state_mod(self):
        with self.assertRaisesRegex(PyDslError, &quot;No state function specified&quot;):
            self.render_sls(
                textwrap.dedent(
                    &quot;&quot;&quot;
                state('B').cmd.require(cmd='hoho')
            &quot;&quot;&quot;
                )
            )

    @pytest.mark.slow_test
    def test_load_highstate(self):
        result = self.render_sls(
            textwrap.dedent(
                '''
            import salt.utils.yaml
            __pydsl__.load_highstate(salt.utils.yaml.safe_load(&quot;&quot;&quot;
            A:
              cmd.run:
                - name: echo hello
                - cwd: /
            B:
              pkg:
                - installed
              service:
                - running
                - require:
                  - pkg: B
                - watch:
                  - cmd: A
            &quot;&quot;&quot;))

            state('A').cmd.run(name='echo hello world')
            '''
            )
        )
        self.assertEqual(len(result), 3)
        self.assertEqual(result[&quot;A&quot;][&quot;cmd&quot;][0], &quot;run&quot;)
        self.assertIn({&quot;name&quot;: &quot;echo hello&quot;}, result[&quot;A&quot;][&quot;cmd&quot;])
        self.assertIn({&quot;cwd&quot;: &quot;/&quot;}, result[&quot;A&quot;][&quot;cmd&quot;])
        self.assertIn({&quot;name&quot;: &quot;echo hello world&quot;}, result[&quot;A&quot;][&quot;cmd&quot;])
        self.assertEqual(len(result[&quot;A&quot;][&quot;cmd&quot;]), 4)

        self.assertEqual(len(result[&quot;B&quot;][&quot;pkg&quot;]), 1)
        self.assertEqual(result[&quot;B&quot;][&quot;pkg&quot;][0], &quot;installed&quot;)

        self.assertEqual(result[&quot;B&quot;][&quot;service&quot;][0], &quot;running&quot;)
        self.assertIn({&quot;require&quot;: [{&quot;pkg&quot;: &quot;B&quot;}]}, result[&quot;B&quot;][&quot;service&quot;])
        self.assertIn({&quot;watch&quot;: [{&quot;cmd&quot;: &quot;A&quot;}]}, result[&quot;B&quot;][&quot;service&quot;])
        self.assertEqual(len(result[&quot;B&quot;][&quot;service&quot;]), 3)

    @pytest.mark.slow_test
    def test_ordered_states(self):
        result = self.render_sls(
            textwrap.dedent(
                &quot;&quot;&quot;
            __pydsl__.set(ordered=True)
            A = state('A')
            state('B').cmd.run('echo bbbb')
            A.cmd.run('echo aaa')
            state('B').cmd.run(cwd='/')
            state('C').cmd.run('echo ccc')
            state('B').file.managed(source='/a/b/c')
            &quot;&quot;&quot;
            )
        )
        self.assertEqual(len(result[&quot;B&quot;][&quot;cmd&quot;]), 3)
        self.assertEqual(result[&quot;A&quot;][&quot;cmd&quot;][1][&quot;require&quot;][0][&quot;cmd&quot;], &quot;B&quot;)
        self.assertEqual(result[&quot;C&quot;][&quot;cmd&quot;][1][&quot;require&quot;][0][&quot;cmd&quot;], &quot;A&quot;)
        self.assertEqual(result[&quot;B&quot;][&quot;file&quot;][1][&quot;require&quot;][0][&quot;cmd&quot;], &quot;C&quot;)

    @with_tempdir()
    @pytest.mark.slow_test
    def test_pipe_through_stateconf(self, dirpath):
        output = os.path.join(dirpath, &quot;output&quot;)
        write_to(
            os.path.join(dirpath, &quot;xxx.sls&quot;),
            textwrap.dedent(
                &quot;&quot;&quot;#!stateconf -os yaml . jinja
            .X:
              cmd.run:
                - name: echo X &gt;&gt; {0}
                - cwd: /
            .Y:
              cmd.run:
                - name: echo Y &gt;&gt; {0}
                - cwd: /
            .Z:
              cmd.run:
                - name: echo Z &gt;&gt; {0}
                - cwd: /
            &quot;&quot;&quot;.format(
                    output.replace(&quot;\\&quot;, &quot;/&quot;)
                )
            ),
        )
        write_to(
            os.path.join(dirpath, &quot;yyy.sls&quot;),
            textwrap.dedent(
                &quot;&quot;&quot;\
            #!pydsl|stateconf -ps

            __pydsl__.set(ordered=True)
            state('.D').cmd.run('echo D &gt;&gt; {0}', cwd='/')
            state('.E').cmd.run('echo E &gt;&gt; {0}', cwd='/')
            state('.F').cmd.run('echo F &gt;&gt; {0}', cwd='/')
            &quot;&quot;&quot;.format(
                    output.replace(&quot;\\&quot;, &quot;/&quot;)
                )
            ),
        )

        write_to(
            os.path.join(dirpath, &quot;aaa.sls&quot;),
            textwrap.dedent(
                &quot;&quot;&quot;\
            #!pydsl|stateconf -ps

            include('xxx', 'yyy')

            # make all states in xxx run BEFORE states in this sls.
            extend(state('.start').stateconf.require(stateconf='xxx::goal'))

            # make all states in yyy run AFTER this sls.
            extend(state('.goal').stateconf.require_in(stateconf='yyy::start'))

            __pydsl__.set(ordered=True)

            state('.A').cmd.run('echo A &gt;&gt; {0}', cwd='/')
            state('.B').cmd.run('echo B &gt;&gt; {0}', cwd='/')
            state('.C').cmd.run('echo C &gt;&gt; {0}', cwd='/')
            &quot;&quot;&quot;.format(
                    output.replace(&quot;\\&quot;, &quot;/&quot;)
                )
            ),
        )

        self.state_highstate({&quot;base&quot;: [&quot;aaa&quot;]}, dirpath)
        with salt.utils.files.fopen(output, &quot;r&quot;) as f:
            self.assertEqual(&quot;&quot;.join(f.read().split()), &quot;XYZABCDEF&quot;)

    @with_tempdir()
    @pytest.mark.slow_test
    def test_compile_time_state_execution(self, dirpath):
        if not sys.stdin.isatty():
            self.skipTest(&quot;Not attached to a TTY&quot;)
        # The Windows shell will include any spaces before the redirect
        # in the text that is redirected.
        # For example: echo hello &gt; test.txt will contain &quot;hello &quot;
        write_to(
            os.path.join(dirpath, &quot;aaa.sls&quot;),
            textwrap.dedent(
                &quot;&quot;&quot;\
            #!pydsl

            __pydsl__.set(ordered=True)
            A = state('A')
            A.cmd.run('echo hehe&gt;{0}/zzz.txt', cwd='/')
            A.file.managed('{0}/yyy.txt', source='salt://zzz.txt')
            A()
            A()

            state().cmd.run('echo hoho&gt;&gt;{0}/yyy.txt', cwd='/')

            A.file.managed('{0}/xxx.txt', source='salt://zzz.txt')
            A()
            &quot;&quot;&quot;.format(
                    dirpath.replace(&quot;\\&quot;, &quot;/&quot;)
                )
            ),
        )
        self.state_highstate({&quot;base&quot;: [&quot;aaa&quot;]}, dirpath)
        with salt.utils.files.fopen(os.path.join(dirpath, &quot;yyy.txt&quot;), &quot;rt&quot;) as f:
            self.assertEqual(f.read(), &quot;hehe&quot; + os.linesep + &quot;hoho&quot; + os.linesep)
        with salt.utils.files.fopen(os.path.join(dirpath, &quot;xxx.txt&quot;), &quot;rt&quot;) as f:
            self.assertEqual(f.read(), &quot;hehe&quot; + os.linesep)

    @with_tempdir()
    @pytest.mark.slow_test
    def test_nested_high_state_execution(self, dirpath):
        output = os.path.join(dirpath, &quot;output&quot;)
        write_to(
            os.path.join(dirpath, &quot;aaa.sls&quot;),
            textwrap.dedent(
                &quot;&quot;&quot;\
            #!pydsl
            __salt__['state.sls']('bbb')
            state().cmd.run('echo bbbbbb', cwd='/')
            &quot;&quot;&quot;
            ),
        )
        write_to(
            os.path.join(dirpath, &quot;bbb.sls&quot;),
            textwrap.dedent(
                &quot;&quot;&quot;
            # {{ salt['state.sls']('ccc') }}
            test:
              cmd.run:
                - name: echo bbbbbbb
                - cwd: /
            &quot;&quot;&quot;
            ),
        )
        write_to(
            os.path.join(dirpath, &quot;ccc.sls&quot;),
            textwrap.dedent(
                &quot;&quot;&quot;
            #!pydsl
            state().cmd.run('echo ccccc', cwd='/')
            &quot;&quot;&quot;
            ),
        )
        self.state_highstate({&quot;base&quot;: [&quot;aaa&quot;]}, dirpath)

    @with_tempdir()
    @pytest.mark.slow_test
    def test_repeat_includes(self, dirpath):
        output = os.path.join(dirpath, &quot;output&quot;)
        write_to(
            os.path.join(dirpath, &quot;b.sls&quot;),
            textwrap.dedent(
                &quot;&quot;&quot;\
            #!pydsl
            include('c')
            include('d')
            &quot;&quot;&quot;
            ),
        )
        write_to(
            os.path.join(dirpath, &quot;c.sls&quot;),
            textwrap.dedent(
                &quot;&quot;&quot;\
            #!pydsl
            modtest = include('e')
            modtest.success
            &quot;&quot;&quot;
            ),
        )
        write_to(
            os.path.join(dirpath, &quot;d.sls&quot;),
            textwrap.dedent(
                &quot;&quot;&quot;\
            #!pydsl
            modtest = include('e')
            modtest.success
            &quot;&quot;&quot;
            ),
        )
        write_to(
            os.path.join(dirpath, &quot;e.sls&quot;),
            textwrap.dedent(
                &quot;&quot;&quot;\
            #!pydsl
            success = True
            &quot;&quot;&quot;
            ),
        )
        self.state_highstate({&quot;base&quot;: [&quot;b&quot;]}, dirpath)
        self.state_highstate({&quot;base&quot;: [&quot;c&quot;, &quot;d&quot;]}, dirpath)


def write_to(fpath, content):
    with salt.utils.files.fopen(fpath, &quot;w&quot;) as f:
        f.write(content)
</PRE>
</div>
  </div>
</body>
</html>
