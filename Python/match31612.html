<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_status_2.py & test_nxos_1.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_status_2.py & test_nxos_1.py
      </h3>
      <h1 align="center">
        7.7%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_status_2.py (12.914485%)<TH>test_nxos_1.py (5.5472264%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match31612-0.html#0',2,'match31612-1.html#0',3)" NAME="0">(247-253)<TD><A HREF="javascript:ZweiFrames('match31612-0.html#0',2,'match31612-1.html#0',3)" NAME="0">(1050-1059)</A><TD ALIGN=center><FONT COLOR="#ff0000">13</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match31612-0.html#1',2,'match31612-1.html#1',3)" NAME="1">(154-162)<TD><A HREF="javascript:ZweiFrames('match31612-0.html#1',2,'match31612-1.html#1',3)" NAME="1">(988-996)</A><TD ALIGN=center><FONT COLOR="#ff0000">13</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match31612-0.html#2',2,'match31612-1.html#2',3)" NAME="2">(366-370)<TD><A HREF="javascript:ZweiFrames('match31612-0.html#2',2,'match31612-1.html#2',3)" NAME="2">(1027-1032)</A><TD ALIGN=center><FONT COLOR="#eb0000">12</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match31612-0.html#3',2,'match31612-1.html#3',3)" NAME="3">(354-358)<TD><A HREF="javascript:ZweiFrames('match31612-0.html#3',2,'match31612-1.html#3',3)" NAME="3">(415-420)</A><TD ALIGN=center><FONT COLOR="#eb0000">12</FONT>
<TR><TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match31612-0.html#4',2,'match31612-1.html#4',3)" NAME="4">(294-298)<TD><A HREF="javascript:ZweiFrames('match31612-0.html#4',2,'match31612-1.html#4',3)" NAME="4">(80-84)</A><TD ALIGN=center><FONT COLOR="#eb0000">12</FONT>
<TR><TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT><TD><A HREF="javascript:ZweiFrames('match31612-0.html#5',2,'match31612-1.html#5',3)" NAME="5">(258-262)<TD><A HREF="javascript:ZweiFrames('match31612-0.html#5',2,'match31612-1.html#5',3)" NAME="5">(69-73)</A><TD ALIGN=center><FONT COLOR="#eb0000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_status_2.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
import os

import salt.modules.status as status
import salt.utils.platform
from salt.exceptions import CommandExecutionError
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import MagicMock, mock_open, patch
from tests.support.unit import TestCase


class StatusTestCase(TestCase, LoaderModuleMockMixin):
    &quot;&quot;&quot;
    test modules.status functions
    &quot;&quot;&quot;

    def setup_loader_modules(self):
        return {status: {}}

    def _set_up_test_uptime(self):
        &quot;&quot;&quot;
        Define common mock data for status.uptime tests
        &quot;&quot;&quot;

        class MockData:
            &quot;&quot;&quot;
            Store mock data
            &quot;&quot;&quot;

        m = MockData()
        m.now = 1477004312
        m.ut = 1540154.00
        m.idle = 3047777.32
        m.ret = {
            &quot;users&quot;: 3,
            &quot;seconds&quot;: 1540154,
            &quot;since_t&quot;: 1475464158,
            &quot;days&quot;: 17,
            &quot;since_iso&quot;: &quot;2016-10-03T03:09:18&quot;,
            &quot;time&quot;: &quot;19:49&quot;,
        }

        return m

    def _set_up_test_uptime_sunos(self):
        &quot;&quot;&quot;
        Define common mock data for cmd.run_all for status.uptime on SunOS
        &quot;&quot;&quot;

        class MockData:
            &quot;&quot;&quot;
            Store mock data
            &quot;&quot;&quot;

        m = MockData()
        m.ret = {
            &quot;retcode&quot;: 0,
            &quot;stdout&quot;: &quot;unix:0:system_misc:boot_time    1475464158&quot;,
        }

        return m

    def test_uptime_linux(self):
        &quot;&quot;&quot;
        Test modules.status.uptime function for Linux
        &quot;&quot;&quot;
        m = self._set_up_test_uptime()

        with patch.multiple(
            salt.utils.platform,
            is_linux=MagicMock(return_value=True),
            is_sunos=MagicMock(return_value=False),
            is_darwin=MagicMock(return_value=False),
            is_freebsd=MagicMock(return_value=False),
            is_openbsd=MagicMock(return_value=False),
            is_netbsd=MagicMock(return_value=False),
        ), patch(&quot;salt.utils.path.which&quot;, MagicMock(return_value=True)), patch.dict(
            status.__salt__,
            {&quot;cmd.run&quot;: MagicMock(return_value=os.linesep.join([&quot;1&quot;, &quot;2&quot;, &quot;3&quot;]))},
        ), patch(
            &quot;time.time&quot;, MagicMock(return_value=m.now)
        ), patch(
            &quot;os.path.exists&quot;, MagicMock(return_value=True)
        ):
            proc_uptime = salt.utils.stringutils.to_str(&quot;{} {}&quot;.format(m.ut, m.idle))

            with patch(&quot;salt.utils.files.fopen&quot;, mock_open(read_data=proc_uptime)):
                ret = status.uptime()
                self.assertDictEqual(ret, m.ret)
            with patch(&quot;os.path.exists&quot;, MagicMock(return_value=False)):
                with self.assertRaises(CommandExecutionError):
                    status.uptime()

    def test_uptime_sunos(self):
        &quot;&quot;&quot;
        Test modules.status.uptime function for SunOS
        &quot;&quot;&quot;
        m = self._set_up_test_uptime()
        m2 = self._set_up_test_uptime_sunos()
        with patch.multiple(
            salt.utils.platform,
            is_linux=MagicMock(return_value=False),
            is_sunos=MagicMock(return_value=True),
            is_darwin=MagicMock(return_value=False),
            is_freebsd=MagicMock(return_value=False),
            is_openbsd=MagicMock(return_value=False),
            is_netbsd=MagicMock(return_value=False),
        ), patch(&quot;salt.utils.path.which&quot;, MagicMock(return_value=True)), patch.dict(
            status.__salt__,
            {
                &quot;cmd.run&quot;: MagicMock(return_value=os.linesep.join([&quot;1&quot;, &quot;2&quot;, &quot;3&quot;])),
                &quot;cmd.run_all&quot;: MagicMock(return_value=m2.ret),
            },
        ), patch(
            &quot;time.time&quot;, MagicMock(return_value=m.now)
        ):
            ret = status.uptime()
            self.assertDictEqual(ret, m.ret)

    def test_uptime_macos(self):
        &quot;&quot;&quot;
        Test modules.status.uptime function for macOS
        &quot;&quot;&quot;
        m = self._set_up_test_uptime()

        kern_boottime = (
            &quot;{{ sec = {0}, usec = {1:0&lt;6} }} Mon Oct 03 03:09:18.23 2016&quot;.format(
                *str(m.now - m.ut).split(&quot;.&quot;)
            )
        )
        with patch.multiple(
            salt.utils.platform,
            is_linux=MagicMock(return_value=False),
            is_sunos=MagicMock(return_value=False),
            is_darwin=MagicMock(return_value=True),
            is_freebsd=MagicMock(return_value=False),
            is_openbsd=MagicMock(return_value=False),
            is_netbsd=MagicMock(return_value=False),
        ), patch(&quot;salt.utils.path.which&quot;, MagicMock(return_value=True)), patch.dict(
            status.__salt__,
            {
                &quot;cmd.run&quot;: MagicMock(return_value=os.linesep.join([&quot;1&quot;, &quot;2&quot;, &quot;3&quot;])),
                &quot;sysctl.get&quot;: MagicMock(return_value=kern_boottime),
            },
        ), patch(
            &quot;time.time&quot;, MagicMock(return_value=m.now)
        ):

            ret = status.uptime()
            self.assertDictEqual(ret, m.ret)

<A NAME="1"></A>            with patch.dict(
                status.__salt__, {&quot;sysctl.get&quot;: MagicMock(return_value=&quot;&quot;)}
            ):
                with self<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match31612-1.html#1',3,'match31612-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.assertRaises(CommandExecutionError):
                    status.uptime()

    def test_uptime_return_success_not_supported(self):
        &quot;&quot;&quot;
        Test modules.status.uptime function for other platforms
        &quot;&quot;&quot;
        with patch.multiple(
            salt.</B></FONT>utils.platform,
            is_linux=MagicMock(return_value=False),
            is_sunos=MagicMock(return_value=False),
            is_darwin=MagicMock(return_value=False),
            is_freebsd=MagicMock(return_value=False),
            is_openbsd=MagicMock(return_value=False),
            is_netbsd=MagicMock(return_value=False),
        ):
            exc_mock = MagicMock(side_effect=CommandExecutionError)
            with self.assertRaises(CommandExecutionError):
                with patch.dict(status.__salt__, {&quot;cmd.run&quot;: exc_mock}):
                    status.uptime()

    def _set_up_test_cpustats_openbsd(self):
        &quot;&quot;&quot;
        Define mock data for status.cpustats on OpenBSD
        &quot;&quot;&quot;

        class MockData:
            &quot;&quot;&quot;
            Store mock data
            &quot;&quot;&quot;

        m = MockData()
        m.ret = {
            &quot;0&quot;: {
                &quot;User&quot;: &quot;0.0%&quot;,
                &quot;Nice&quot;: &quot;0.0%&quot;,
                &quot;System&quot;: &quot;4.5%&quot;,
                &quot;Interrupt&quot;: &quot;0.5%&quot;,
                &quot;Idle&quot;: &quot;95.0%&quot;,
            }
        }

        return m

    def test_cpustats_openbsd(self):
        &quot;&quot;&quot;
        Test modules.status.cpustats function for OpenBSD
        &quot;&quot;&quot;
        m = self._set_up_test_cpustats_openbsd()

        systat = (
            &quot;\n\n   1 users Load 0.20 0.07 0.05                        salt.localdomain&quot;
            &quot; 09:42:42\nCPU                User           Nice        System    &quot;
            &quot; Interrupt          Idle\n0                  0.0%           0.0%         &quot;
            &quot; 4.5%          0.5%         95.0%\n&quot;
        )

        with patch.multiple(
            salt.utils.platform,
            is_linux=MagicMock(return_value=False),
            is_sunos=MagicMock(return_value=False),
            is_darwin=MagicMock(return_value=False),
            is_freebsd=MagicMock(return_value=False),
            is_openbsd=MagicMock(return_value=True),
            is_netbsd=MagicMock(return_value=False),
        ), patch(&quot;salt.utils.path.which&quot;, MagicMock(return_value=True)), patch.dict(
            status.__grains__, {&quot;kernel&quot;: &quot;OpenBSD&quot;}
        ), patch.dict(
            status.__salt__, {&quot;cmd.run&quot;: MagicMock(return_value=systat)}
        ):
            ret = status.cpustats()
            self.assertDictEqual(ret, m.ret)

    def _set_up_test_cpuinfo_bsd(self):
        class MockData:
            &quot;&quot;&quot;
            Store mock data
            &quot;&quot;&quot;

        m = MockData()
        m.ret = {
            &quot;hw.model&quot;: &quot;Intel(R) Core(TM) i5-7287U CPU @ 3.30GHz&quot;,
            &quot;hw.ncpu&quot;: &quot;4&quot;,
        }

        return m

    def test_cpuinfo_freebsd(self):
        m = self._set_up_test_cpuinfo_bsd()
        sysctl = &quot;hw.model:Intel(R) Core(TM) i5-7287U CPU @ 3.30GHz\nhw.ncpu:4&quot;
<A NAME="0"></A>
        with patch.dict(status.__grains__, {&quot;kernel&quot;: &quot;FreeBSD&quot;}):
            with patch.dict(
                status.__salt__, {&quot;cmd.run&quot;: MagicMock(return_value<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match31612-1.html#0',3,'match31612-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>=sysctl)}
            ):
                ret = status.cpuinfo()
                self.assertDictEqual(ret, m.ret)

    def test_cpuinfo_openbsd(self):
        m = self.</B></FONT>_set_up_test_cpuinfo_bsd()
        sysctl = &quot;hw.model=Intel(R) Core(TM) i5-7287U CPU @ 3.30GHz\nhw.ncpu=4&quot;
<A NAME="5"></A>
        for bsd in [&quot;NetBSD&quot;, &quot;OpenBSD&quot;]:
            with patch.dict(status.__grains__, {&quot;kernel&quot;: bsd}):
                <FONT color="#151b8d"><A HREF="javascript:ZweiFrames('match31612-1.html#5',3,'match31612-top.html#5',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>with patch.dict(
                    status.__salt__, {&quot;cmd.run&quot;: MagicMock(return_value=sysctl)}
                ):
                    ret = status.cpuinfo()
                    self.assertDictEqual(</B></FONT>ret, m.ret)

    def _set_up_test_meminfo_openbsd(self):
        class MockData:
            &quot;&quot;&quot;
            Store mock data
            &quot;&quot;&quot;

        m = MockData()
        m.ret = {
            &quot;active virtual pages&quot;: &quot;355M&quot;,
            &quot;free list size&quot;: &quot;305M&quot;,
            &quot;page faults&quot;: &quot;845&quot;,
            &quot;pages reclaimed&quot;: &quot;1&quot;,
            &quot;pages paged in&quot;: &quot;2&quot;,
            &quot;pages paged out&quot;: &quot;3&quot;,
            &quot;pages freed&quot;: &quot;4&quot;,
            &quot;pages scanned&quot;: &quot;5&quot;,
        }

        return m

    def test_meminfo_openbsd(self):
        m = self._set_up_test_meminfo_openbsd()
        vmstat = (
            &quot; procs    memory       page                    disks    traps         &quot;
            &quot; cpu\n r   s   avm     fre  flt  re  pi  po  fr  sr cd0 sd0  int   sys  &quot;
            &quot; cs us sy id\n 2 103  355M    305M  845   1   2   3   4   5   0   1   21  &quot;
            &quot; 682   86  1  1 98&quot;
<A NAME="4"></A>        )

        with patch.dict(status.__grains__, {&quot;kernel&quot;: &quot;OpenBSD&quot;}):
            <FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match31612-1.html#4',3,'match31612-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>with patch.dict(
                status.__salt__, {&quot;cmd.run&quot;: MagicMock(return_value=vmstat)}
            ):
                ret = status.meminfo()
                self.assertDictEqual(</B></FONT>ret, m.ret)

    def _set_up_test_w_linux(self):
        &quot;&quot;&quot;
        Define mock data for status.w on Linux
        &quot;&quot;&quot;

        class MockData:
            &quot;&quot;&quot;
            Store mock data
            &quot;&quot;&quot;

        m = MockData()
        m.ret = [
            {
                &quot;idle&quot;: &quot;0s&quot;,
                &quot;jcpu&quot;: &quot;0.24s&quot;,
                &quot;login&quot;: &quot;13:42&quot;,
                &quot;pcpu&quot;: &quot;0.16s&quot;,
                &quot;tty&quot;: &quot;pts/1&quot;,
                &quot;user&quot;: &quot;root&quot;,
                &quot;what&quot;: &quot;nmap -sV 10.2.2.2&quot;,
            }
        ]

        return m

    def _set_up_test_w_bsd(self):
        &quot;&quot;&quot;
        Define mock data for status.w on Linux
        &quot;&quot;&quot;

        class MockData:
            &quot;&quot;&quot;
            Store mock data
            &quot;&quot;&quot;

        m = MockData()
        m.ret = [
            {
                &quot;idle&quot;: &quot;0&quot;,
                &quot;from&quot;: &quot;10.2.2.1&quot;,
                &quot;login&quot;: &quot;1:42PM&quot;,
                &quot;tty&quot;: &quot;p1&quot;,
                &quot;user&quot;: &quot;root&quot;,
                &quot;what&quot;: &quot;nmap -sV 10.2.2.2&quot;,
            }
        ]

        return m

    def test_w_linux(self):
        m = self._set_up_test_w_linux()
<A NAME="3"></A>        w_output = &quot;root   pts/1  13:42    0s  0.24s  0.16s nmap -sV 10.2.2.2&quot;

        with patch.dict(status.__grains__, {&quot;kernel&quot;: &quot;Linux&quot;}):
            <FONT color="#53858b"><A HREF="javascript:ZweiFrames('match31612-1.html#3',3,'match31612-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>with patch.dict(
                status.__salt__, {&quot;cmd.run&quot;: MagicMock(return_value=w_output)}
            ):
                ret = status.w()
                self.assertListEqual(</B></FONT>ret, m.ret)

    def test_w_bsd(self):
        m = self._set_up_test_w_bsd()
        w_output = &quot;root   p1 10.2.2.1    1:42PM  0 nmap -sV 10.2.2.2&quot;
<A NAME="2"></A>
        for bsd in [&quot;Darwin&quot;, &quot;FreeBSD&quot;, &quot;OpenBSD&quot;]:
            with patch.dict(status.__grains__, {&quot;kernel&quot;: bsd}):
                <FONT color="#980517"><A HREF="javascript:ZweiFrames('match31612-1.html#2',3,'match31612-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>with patch.dict(
                    status.__salt__, {&quot;cmd.run&quot;: MagicMock(return_value=w_output)}
                ):
                    ret = status.w()
                    self.assertListEqual(</B></FONT>ret, m.ret)

    def _set_up_test_status_pid_linux(self):
        class MockData:
            &quot;&quot;&quot;
            Store mock data
            &quot;&quot;&quot;

        m = MockData()
        m.ret = &quot;2701\n7539\n7540\n7542\n7623&quot;
        return m

    def test_status_pid_linux(self):
        m = self._set_up_test_status_pid_linux()
        ps = (
            &quot;UID      PID PPID  C STIME TTY      TIME CMD\nroot     360    2  0 Jun08 ?&quot;
            &quot;    00:00:00   [jbd2/dm-0-8]\nroot     947    2  0 Jun08 ?    00:00:00  &quot;
            &quot; [jbd2/dm-1-8]\nroot     949    2  0 Jun08 ?    00:00:09  &quot;
            &quot; [jbd2/dm-3-8]\nroot     951    2  0 Jun08 ?    00:00:00  &quot;
            &quot; [jbd2/dm-4-8]\nroot    2701    1  0 Jun08 ?    00:00:28   /usr/sbin/httpd&quot;
            &quot; -k start\napache  7539 2701  0 04:40 ?    00:00:04     /usr/sbin/httpd -k&quot;
            &quot; start\napache  7540 2701  0 04:40 ?    00:00:02     /usr/sbin/httpd -k&quot;
            &quot; start\napache  7542 2701  0 04:40 ?    00:01:46     /usr/sbin/httpd -k&quot;
            &quot; start\napache  7623 2701  0 04:40 ?    00:02:41     /usr/sbin/httpd -k&quot;
            &quot; start\nroot    1564    1  0 Jun11 ?    00:07:19   /usr/bin/python3&quot;
            &quot; /usr/bin/salt-minion -d\nroot    6674 1564  0 19:53 ?    00:00:00    &quot;
            &quot; /usr/bin/python3 /usr/bin/salt-call status.pid httpd -l debug&quot;
        )

        with patch.dict(status.__grains__, {&quot;ps&quot;: &quot;ps -efHww&quot;}):
            with patch.dict(
                status.__salt__, {&quot;cmd.run_stdout&quot;: MagicMock(return_value=ps)}
            ):
                with patch.object(os, &quot;getpid&quot;, return_value=&quot;6674&quot;):
                    ret = status.pid(&quot;httpd&quot;)
                    self.assertEqual(ret, m.ret)
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_nxos_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Mike Wiebe &lt;@mikewiebe&gt;
&quot;&quot;&quot;

import salt.modules.cp as cp_module
import salt.modules.file as file_module
import salt.modules.nxos as nxos_module
import salt.utils.nxos as nxos_utils
import salt.utils.pycrypto
from salt.exceptions import CommandExecutionError, SaltInvocationError
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import MagicMock, create_autospec, patch
from tests.support.unit import TestCase, skipIf
from tests.unit.modules.nxos.nxos_config import (
    config_input_file,
    config_result,
    config_result_file,
    initial_config,
    initial_config_file,
    modified_config,
    modified_config_file,
    save_running_config,
    set_role,
    template_engine_file_str,
    template_engine_file_str_file,
    unset_role,
)
from tests.unit.modules.nxos.nxos_grains import n9k_grains
from tests.unit.modules.nxos.nxos_show_cmd_output import (
    n9k_get_user_output,
    n9k_show_user_account,
    n9k_show_user_account_list,
    n9k_show_ver,
    n9k_show_ver_int_list,
    n9k_show_ver_int_list_structured,
    n9k_show_ver_list,
)
from tests.unit.modules.nxos.nxos_show_run import (
    n9k_running_config,
    n9k_show_running_config_list,
    n9k_show_running_inc_username_list,
)


class NxosTestCase(TestCase, LoaderModuleMockMixin):

    &quot;&quot;&quot;Test cases for salt.modules.nxos&quot;&quot;&quot;

    COPY_RS = &quot;copy running-config startup-config&quot;

    def setup_loader_modules(self):
        sendline = create_autospec(
            nxos_module.sendline, autospec=True, return_value={&quot;command&quot;: &quot;fake_output&quot;}
        )
        return {nxos_module: {&quot;__proxy__&quot;: {&quot;nxos.sendline&quot;: sendline}}}

    @staticmethod
    def test_check_virtual():

        &quot;&quot;&quot;UT: nxos module:check_virtual method - return value&quot;&quot;&quot;

        result = nxos_module.__virtual__()
        assert &quot;nxos&quot; in result

    def test_ping_proxy(self):
<A NAME="5"></A>
        &quot;&quot;&quot;UT: nxos module:ping method - proxy&quot;&quot;&quot;
        with patch(&quot;salt.utils.platform.is_proxy&quot;, return_value=True, autospec=True):
            <FONT color="#151b8d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match31612-0.html#5',2,'match31612-top.html#5',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>with patch.dict(
                nxos_module.__proxy__, {&quot;nxos.ping&quot;: MagicMock(return_value=True)}
            ):
                result = nxos_module.ping()
                self.assertTrue(</B></FONT>result)

    def test_ping_native_minion(self):

<A NAME="4"></A>        &quot;&quot;&quot;UT: nxos module:ping method - proxy&quot;&quot;&quot;

        with patch(&quot;salt.utils.platform.is_proxy&quot;, return_value=False, autospec=True):
            <FONT color="#6cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match31612-0.html#4',2,'match31612-top.html#4',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>with patch.dict(
                nxos_module.__utils__, {&quot;nxos.ping&quot;: MagicMock(return_value=True)}
            ):
                result = nxos_module.ping()
                self.assertTrue(</B></FONT>result)

    def test_check_password_return_none(self):

        &quot;&quot;&quot;UT: nxos module:check_password method - return None&quot;&quot;&quot;

        username = &quot;admin&quot;
        password = &quot;foo&quot;

        with patch(&quot;salt.modules.nxos.get_user&quot;, return_value=None, autospec=True):
            result = nxos_module.check_password(username, password, encrypted=False)
            self.assertIsNone(result)

    def test_check_password_password_nxos_comment(self):

        &quot;&quot;&quot;UT: nxos module:check_password method - password_line has '!'&quot;&quot;&quot;

        username = &quot;admin&quot;
        password = &quot;foo&quot;

        with patch(&quot;salt.modules.nxos.get_user&quot;, return_value=&quot;!&quot;, autospec=True):
            result = nxos_module.check_password(username, password, encrypted=False)
            self.assertFalse(result)

    @skipIf(
        &quot;sha256&quot; not in salt.utils.pycrypto.methods,
        &quot;compatible crypt method for fake data not available&quot;,
    )
    def test_check_password_password_encrypted_false(self):

        &quot;&quot;&quot;UT: nxos module:check_password method - password is not encrypted&quot;&quot;&quot;

        username = &quot;salt_test&quot;
        password = &quot;foobar123&amp;&quot;

        with patch(
            &quot;salt.modules.nxos.get_user&quot;,
            return_value=n9k_get_user_output,
            autospec=True,
        ):
            result = nxos_module.check_password(username, password, encrypted=False)
            self.assertTrue(result)

    def test_check_password_password_encrypted_true(self):

        &quot;&quot;&quot;UT: nxos module:check_password method - password is encrypted&quot;&quot;&quot;

        username = &quot;salt_test&quot;
        password = &quot;$5$mkXh6O4T$YUVtA89HbXCnue63kgghPlaqPHyaXhdtxPBbPEHhbRC&quot;

        with patch(
            &quot;salt.modules.nxos.get_user&quot;,
            return_value=n9k_get_user_output,
            autospec=True,
        ):
            result = nxos_module.check_password(username, password, encrypted=True)
            self.assertTrue(result)

    def test_check_password_password_encrypted_true_negative(self):

        &quot;&quot;&quot;UT: nxos module:check_password method - password is not encrypted&quot;&quot;&quot;

        username = &quot;salt_test&quot;
        password = &quot;foobar123&amp;&quot;

        with patch(
            &quot;salt.modules.nxos.get_user&quot;, return_value=n9k_running_config, autospec=True
        ):
            result = nxos_module.check_password(username, password, encrypted=True)
            self.assertFalse(result)

    def test_check_role_true(self):

        &quot;&quot;&quot;UT: nxos module:check_role method - Role configured&quot;&quot;&quot;

        username = &quot;salt_test&quot;
        roles = [&quot;network-admin&quot;, &quot;dev-ops&quot;]

        with patch(&quot;salt.modules.nxos.get_roles&quot;, return_value=roles, autospec=True):
            result = nxos_module.check_role(username, &quot;dev-ops&quot;)
            self.assertTrue(result)

    def test_check_role_false(self):

        &quot;&quot;&quot;UT: nxos module:check_role method - Role not configured&quot;&quot;&quot;

        username = &quot;salt_test&quot;
        roles = [&quot;network-admin&quot;, &quot;dev-ops&quot;]

        with patch(&quot;salt.modules.nxos.get_roles&quot;, return_value=roles, autospec=True):
            result = nxos_module.check_role(username, &quot;network-operator&quot;)
            self.assertFalse(result)

    def test_cmd_any_function(self):

        &quot;&quot;&quot;UT: nxos module:cmd method - check_role function&quot;&quot;&quot;

        with patch.dict(
            nxos_module.__salt__,
            {
                &quot;nxos.check_role&quot;: create_autospec(
                    nxos_module.check_role, return_value=True
                )
            },
        ):
            result = nxos_module.cmd(
                &quot;check_role&quot;,
                &quot;salt_test&quot;,
                &quot;network-admin&quot;,
                encrypted=True,
                __pub_fun=&quot;nxos.cmd&quot;,
            )
            self.assertTrue(result)

    def test_cmd_function_absent(self):

        &quot;&quot;&quot;UT: nxos module:cmd method - non existent function&quot;&quot;&quot;

        result = nxos_module.cmd(
            &quot;cool_new_function&quot;, &quot;salt_test&quot;, &quot;network-admin&quot;, encrypted=True
        )
        self.assertFalse(result)

    def test_find_single_match(self):

        &quot;&quot;&quot;UT: nxos module:test_find method - Find single match in running config&quot;&quot;&quot;

        find_pattern = &quot;^vrf context testing$&quot;
        find_string = &quot;vrf context testing&quot;

        with patch(
            &quot;salt.modules.nxos.show_run&quot;, return_value=n9k_running_config, autospec=True
        ):
            result = nxos_module.find(find_pattern)
            self.assertIn(find_string, result)

    def test_find_multiple_matches(self):

        &quot;&quot;&quot;UT: nxos module:test_find method - Find multiple matches in running config&quot;&quot;&quot;

        find_pattern = &quot;^no logging.*$&quot;
        find_string = &quot;no logging event link-status enable&quot;

        with patch(
            &quot;salt.modules.nxos.show_run&quot;, return_value=n9k_running_config, autospec=True
        ):
            result = nxos_module.find(find_pattern)
            self.assertIn(find_string, result)
            self.assertEqual(len(result), 7)

    def test_get_roles_user_not_configured(self):

        &quot;&quot;&quot;UT: nxos module:get_roles method - User not configured&quot;&quot;&quot;

        username = &quot;salt_does_not_exist&quot;
        user_info = &quot;&quot;

        with patch(&quot;salt.modules.nxos.get_user&quot;, return_value=user_info, autospec=True):
            result = nxos_module.get_roles(username)
            self.assertEqual(result, [])

    def test_get_roles_user_configured(self):

        &quot;&quot;&quot;UT: nxos module:get_roles method - User configured&quot;&quot;&quot;

        username = &quot;salt_test&quot;
        expected_result = [&quot;network-operator&quot;, &quot;network-admin&quot;, &quot;dev-ops&quot;]

        with patch(&quot;salt.modules.nxos.get_user&quot;, return_value=username, autospec=True):
            for rv in [n9k_show_user_account, n9k_show_user_account_list]:
                with patch(&quot;salt.modules.nxos.show&quot;, return_value=rv, autospec=True):
                    result = nxos_module.get_roles(username)
                    self.assertEqual(result.sort(), expected_result.sort())

    def test_get_roles_user_configured_no_role(self):

        &quot;&quot;&quot;UT: nxos module:get_roles method - User configured no roles&quot;&quot;&quot;

        username = &quot;salt_test&quot;

        with patch(&quot;salt.modules.nxos.get_user&quot;, return_value=username, autospec=True):
            with patch(&quot;salt.modules.nxos.show&quot;, return_value=&quot;&quot;, autospec=True):
                result = nxos_module.get_roles(username)
                self.assertEqual(result, [])

    def test_get_user_configured(self):

        &quot;&quot;&quot;UT: nxos module:get_user method - User configured&quot;&quot;&quot;

        username = &quot;salt_test&quot;
        expected_output = n9k_show_running_inc_username_list[0]

        for rv in [
            n9k_show_running_inc_username_list[0],
            n9k_show_running_inc_username_list,
        ]:
            with patch(&quot;salt.modules.nxos.show&quot;, return_value=rv, autospec=True):
                result = nxos_module.get_user(username)
                self.assertEqual(result, expected_output)

    def test_grains(self):

        &quot;&quot;&quot;UT: nxos module:grains method&quot;&quot;&quot;

        nxos_module.DEVICE_DETAILS[&quot;grains_cache&quot;] = {}
        expected_grains = {
            &quot;software&quot;: {
                &quot;BIOS&quot;: &quot;version 08.36&quot;,
                &quot;NXOS&quot;: &quot;version 9.2(1)&quot;,
                &quot;BIOS compile time&quot;: &quot;06/07/2019&quot;,
                &quot;NXOS image file is&quot;: &quot;bootflash:///nxos.9.2.1.bin&quot;,
                &quot;NXOS compile time&quot;: &quot;7/17/2018 16:00:00 [07/18/2018 00:21:19]&quot;,
            },
            &quot;hardware&quot;: {&quot;Device name&quot;: &quot;n9k-device&quot;, &quot;bootflash&quot;: &quot;53298520 kB&quot;},
            &quot;plugins&quot;: [&quot;Core Plugin&quot;, &quot;Ethernet Plugin&quot;],
        }
        with patch.dict(
            nxos_module.__salt__,
            {
                &quot;utils.nxos.system_info&quot;: create_autospec(
                    nxos_utils.system_info, return_value=n9k_grains
                )
            },
        ):
            with patch(
                &quot;salt.modules.nxos.show_ver&quot;, return_value=n9k_show_ver, autospec=True
            ):
                result = nxos_module.grains()
                self.assertEqual(result, expected_grains)

    def test_grains_get_cache(self):

        &quot;&quot;&quot;UT: nxos module:grains method&quot;&quot;&quot;

        expected_grains = {
            &quot;software&quot;: {
                &quot;BIOS&quot;: &quot;version 08.36&quot;,
                &quot;NXOS&quot;: &quot;version 9.2(1)&quot;,
                &quot;BIOS compile time&quot;: &quot;06/07/2019&quot;,
                &quot;NXOS image file is&quot;: &quot;bootflash:///nxos.9.2.1.bin&quot;,
                &quot;NXOS compile time&quot;: &quot;7/17/2018 16:00:00 [07/18/2018 00:21:19]&quot;,
            },
            &quot;hardware&quot;: {&quot;Device name&quot;: &quot;n9k-device&quot;, &quot;bootflash&quot;: &quot;53298520 kB&quot;},
            &quot;plugins&quot;: [&quot;Core Plugin&quot;, &quot;Ethernet Plugin&quot;],
        }
        nxos_module.DEVICE_DETAILS[&quot;grains_cache&quot;] = expected_grains
        with patch.dict(
            nxos_module.__salt__,
            {
                &quot;utils.nxos.system_info&quot;: create_autospec(
                    nxos_utils.system_info, return_value=n9k_grains
                )
            },
        ):
            with patch(
                &quot;salt.modules.nxos.show_ver&quot;, return_value=n9k_show_ver, autospec=True
            ):
                result = nxos_module.grains()
                self.assertEqual(result, expected_grains)

    def test_grains_refresh(self):

        &quot;&quot;&quot;UT: nxos module:grains_refresh method&quot;&quot;&quot;

        expected_grains = {
            &quot;software&quot;: {
                &quot;BIOS&quot;: &quot;version 08.36&quot;,
                &quot;NXOS&quot;: &quot;version 9.2(1)&quot;,
                &quot;BIOS compile time&quot;: &quot;06/07/2019&quot;,
                &quot;NXOS image file is&quot;: &quot;bootflash:///nxos.9.2.1.bin&quot;,
                &quot;NXOS compile time&quot;: &quot;7/17/2018 16:00:00 [07/18/2018 00:21:19]&quot;,
            },
            &quot;hardware&quot;: {&quot;Device name&quot;: &quot;n9k-device&quot;, &quot;bootflash&quot;: &quot;53298520 kB&quot;},
            &quot;plugins&quot;: [&quot;Core Plugin&quot;, &quot;Ethernet Plugin&quot;],
        }

        with patch(
            &quot;salt.modules.nxos.grains&quot;, return_value=expected_grains, autospec=True
        ):
            result = nxos_module.grains_refresh()
            self.assertEqual(result, expected_grains)

    def test_system_info(self):

        &quot;&quot;&quot;UT: nxos module:system_info method&quot;&quot;&quot;

        expected_grains = {
            &quot;software&quot;: {
                &quot;BIOS&quot;: &quot;version 08.36&quot;,
                &quot;NXOS&quot;: &quot;version 9.2(1)&quot;,
                &quot;BIOS compile time&quot;: &quot;06/07/2019&quot;,
                &quot;NXOS image file is&quot;: &quot;bootflash:///nxos.9.2.1.bin&quot;,
                &quot;NXOS compile time&quot;: &quot;7/17/2018 16:00:00 [07/18/2018 00:21:19]&quot;,
            },
            &quot;hardware&quot;: {&quot;Device name&quot;: &quot;n9k-device&quot;, &quot;bootflash&quot;: &quot;53298520 kB&quot;},
            &quot;plugins&quot;: [&quot;Core Plugin&quot;, &quot;Ethernet Plugin&quot;],
        }
        with patch.dict(
            nxos_module.__salt__,
            {
                &quot;utils.nxos.system_info&quot;: create_autospec(
                    nxos_utils.system_info, return_value=n9k_grains
                )
            },
        ):
            with patch(
                &quot;salt.modules.nxos.show_ver&quot;, return_value=n9k_show_ver, autospec=True
            ):
                result = nxos_module.system_info()
                self.assertEqual(result, expected_grains)

    def test_sendline_invalid_method(self):

        &quot;&quot;&quot;UT: nxos module:sendline method - invalid method&quot;&quot;&quot;

        command = &quot;show version&quot;
        method = &quot;invalid&quot;

        # Execute the function under test
        result = nxos_module.sendline(command, method)

        self.assertIn(&quot;INPUT ERROR&quot;, result)

    def test_sendline_valid_method_proxy(self):

        &quot;&quot;&quot;UT: nxos module:sendline method - valid method over proxy&quot;&quot;&quot;

        command = &quot;show version&quot;
<A NAME="3"></A>        method = &quot;cli_show_ascii&quot;

        with patch(&quot;salt.utils.platform.is_proxy&quot;, return_value=True, autospec=True):
            <FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match31612-0.html#3',2,'match31612-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>with patch.dict(
                nxos_module.__proxy__,
                {&quot;nxos.sendline&quot;: MagicMock(return_value=n9k_show_ver)},
            ):
                result = nxos_module.sendline(command, method)
                self.assertIn(</B></FONT>n9k_show_ver, result)

    def test_sendline_valid_method_nxapi_uds(self):

        &quot;&quot;&quot;UT: nxos module:sendline method - valid method over nxapi uds&quot;&quot;&quot;

        command = &quot;show version&quot;
        method = &quot;cli_show_ascii&quot;

        with patch(&quot;salt.utils.platform.is_proxy&quot;, MagicMock(return_value=False)):
            with patch(
                &quot;salt.modules.nxos._nxapi_request&quot;,
                return_value=n9k_show_ver,
                autospec=True,
            ):
                result = nxos_module.sendline(command, method)
                self.assertIn(n9k_show_ver, result)

    def test_show_raw_text_invalid(self):

        &quot;&quot;&quot;UT: nxos module:show method - invalid argument&quot;&quot;&quot;

        command = &quot;show version&quot;
        raw_text = &quot;invalid&quot;

        result = nxos_module.show(command, raw_text)
        self.assertIn(&quot;INPUT ERROR&quot;, result)

    def test_show_raw_text_true(self):

        &quot;&quot;&quot;UT: nxos module:show method - raw_test true&quot;&quot;&quot;

        command = &quot;show version&quot;
        raw_text = True

        with patch(
            &quot;salt.modules.nxos.sendline&quot;, autospec=True, return_value=n9k_show_ver
        ):
            result = nxos_module.show(command, raw_text)
            self.assertEqual(result, n9k_show_ver)

    def test_show_raw_text_true_multiple_commands(self):

        &quot;&quot;&quot;UT: nxos module:show method - raw_test true multiple commands&quot;&quot;&quot;

        command = &quot;show bgp sessions ; show processes&quot;
        raw_text = True
        data = [&quot;bgp_session_data&quot;, &quot;process_data&quot;]

        with patch(&quot;salt.modules.nxos.sendline&quot;, autospec=True, return_value=data):
            result = nxos_module.show(command, raw_text)
            self.assertEqual(result, data)

    def test_show_nxapi(self):

        &quot;&quot;&quot;UT: nxos module:show method - nxapi returns info as list&quot;&quot;&quot;

        command = &quot;show version; show interface eth1/1&quot;
        raw_text = True

        with patch(
            &quot;salt.modules.nxos.sendline&quot;,
            autospec=True,
            return_value=n9k_show_ver_int_list,
        ):
            result = nxos_module.show(command, raw_text)
            self.assertEqual(result[0], n9k_show_ver_int_list[0])
            self.assertEqual(result[1], n9k_show_ver_int_list[1])

    def test_show_nxapi_structured(self):

        &quot;&quot;&quot;UT: nxos module:show method - nxapi returns info as list&quot;&quot;&quot;

        command = &quot;show version; show interface eth1/1&quot;
        raw_text = False

        with patch(
            &quot;salt.modules.nxos.sendline&quot;,
            autospec=True,
            return_value=n9k_show_ver_int_list_structured,
        ):
            result = nxos_module.show(command, raw_text)
            self.assertEqual(result[0], n9k_show_ver_int_list_structured[0])
            self.assertEqual(result[1], n9k_show_ver_int_list_structured[1])

    def test_show_run(self):

        &quot;&quot;&quot;UT: nxos module:show_run method&quot;&quot;&quot;

        expected_output = n9k_show_running_config_list[0]

        for rv in [n9k_show_running_config_list[0], n9k_show_running_config_list]:
            with patch(&quot;salt.modules.nxos.show&quot;, autospec=True, return_value=rv):
                result = nxos_module.show_run()
                self.assertEqual(result, expected_output)

    def test_show_ver(self):

        &quot;&quot;&quot;UT: nxos module:show_ver method&quot;&quot;&quot;

        expected_output = n9k_show_ver_list[0]

        for rv in [n9k_show_ver_list[0], n9k_show_ver_list]:
            with patch(&quot;salt.modules.nxos.show&quot;, autospec=True, return_value=rv):
                result = nxos_module.show_ver()
                self.assertEqual(result, expected_output)

    def test_add_config(self):

        &quot;&quot;&quot;UT: nxos module:add_config method&quot;&quot;&quot;

        expected_output = &quot;COMMAND_LIST: feature bgp&quot;

        with patch(
            &quot;salt.modules.nxos.config&quot;, autospec=True, return_value=expected_output
        ):
            result = nxos_module.add_config(&quot;feature bgp&quot;)
            self.assertEqual(result, expected_output)

    def test_config_commands(self):

        &quot;&quot;&quot;UT: nxos module:config method - Using commands arg&quot;&quot;&quot;

        commands = [&quot;no feature ospf&quot;, [&quot;no feature ospf&quot;]]
        expected_output = (
            &quot;COMMAND_LIST: no feature ospf\n\n--- \n+++ \n@@ -19,7 +19,6 @@\n feature&quot;
            &quot; bash-shell\n cfs eth distribute\n feature ngmvpn\n-feature ospf\n feature&quot;
            &quot; pim\n feature lldp\n \n&quot;
        )

        for cmd_set in commands:
            with patch(
                &quot;salt.modules.nxos.show&quot;,
                autospec=True,
                side_effect=[initial_config, modified_config],
            ):
                mock_cmd = create_autospec(
                    file_module.apply_template_on_contents,
                    return_value=template_engine_file_str,
                )
                with patch.dict(
                    nxos_module.__salt__, {&quot;file.apply_template_on_contents&quot;: mock_cmd}
                ):
                    with patch(
                        &quot;salt.modules.nxos._configure_device&quot;,
                        autospec=True,
                        return_value=config_result,
                    ):
                        result = nxos_module.config(cmd_set, save_config=False)
                        self.assertEqual(result, expected_output)

    def test_config_commands_template_none(self):

        &quot;&quot;&quot;UT: nxos module:config method - Template engine is None&quot;&quot;&quot;

        commands = [&quot;no feature ospf&quot;, [&quot;no feature ospf&quot;]]
        expected_output = (
            &quot;COMMAND_LIST: no feature ospf\n\n--- \n+++ \n@@ -19,7 +19,6 @@\n feature&quot;
            &quot; bash-shell\n cfs eth distribute\n feature ngmvpn\n-feature ospf\n feature&quot;
            &quot; pim\n feature lldp\n \n&quot;
        )

        for cmd_set in commands:
            with patch(
                &quot;salt.modules.nxos.show&quot;,
                autospec=True,
                side_effect=[initial_config, modified_config],
            ):
                mock_cmd = create_autospec(
                    file_module.apply_template_on_contents,
                    return_value=template_engine_file_str,
                )
                with patch.dict(
                    nxos_module.__salt__, {&quot;file.apply_template_on_contents&quot;: mock_cmd}
                ):
                    with patch(
                        &quot;salt.modules.nxos._configure_device&quot;,
                        autospec=True,
                        return_value=config_result,
                    ):
                        result = nxos_module.config(cmd_set, template_engine=None)
                        self.assertEqual(result, expected_output)

    def test_config_commands_string(self):

        &quot;&quot;&quot;UT: nxos module:config method - Using commands arg and output is string&quot;&quot;&quot;

        commands = &quot;no feature ospf&quot;
        expected_output = (
            &quot;COMMAND_LIST: no feature ospf\n\n--- \n+++ \n@@ -19,7 +19,6 @@\n feature&quot;
            &quot; bash-shell\n cfs eth distribute\n feature ngmvpn\n-feature ospf\n feature&quot;
            &quot; pim\n feature lldp\n \n&quot;
        )

        with patch(
            &quot;salt.modules.nxos.show&quot;,
            autospec=True,
            side_effect=[initial_config[0], modified_config[0]],
        ):
            mock_cmd = create_autospec(
                file_module.apply_template_on_contents,
                return_value=template_engine_file_str,
            )
            with patch.dict(
                nxos_module.__salt__, {&quot;file.apply_template_on_contents&quot;: mock_cmd}
            ):
                with patch(
                    &quot;salt.modules.nxos._configure_device&quot;,
                    autospec=True,
                    return_value=config_result,
                ):
                    result = nxos_module.config(commands)
                    self.assertEqual(result, expected_output)

    def test_config_file(self):

        &quot;&quot;&quot;UT: nxos module:config method - Using config_file arg&quot;&quot;&quot;

        config_file = &quot;salt://bgp_config.txt&quot;
        expected_output = (
            &quot;COMMAND_LIST: feature bgp ; ! ; router bgp 55 ; address-family ipv4&quot;
            &quot; unicast ; no client-to-client reflection ; additional-paths send\n\n---&quot;
            &quot; \n+++ \n@@ -19,6 +19,7 @@\n feature bash-shell\n cfs eth distribute\n&quot;
            &quot; feature ngmvpn\n+feature bgp\n feature pim\n feature lldp\n \n@@ -233,6&quot;
            &quot; +234,10 @@\n line console\n line vty\n boot nxos&quot;
            &quot; bootflash:/nxos.9.2.4.bin \n+router bgp 55\n+  address-family ipv4&quot;
            &quot; unicast\n+    no client-to-client reflection\n+    additional-paths&quot;
            &quot; send\n \n no logging logfile\n no logging monitor\n&quot;
        )

        with patch(
            &quot;salt.modules.nxos.show&quot;,
            autospec=True,
            side_effect=[initial_config_file, modified_config_file],
        ):
            mock_cmd = create_autospec(
                cp_module.get_file_str, return_value=config_input_file
            )
            with patch.dict(nxos_module.__salt__, {&quot;cp.get_file_str&quot;: mock_cmd}):
                mock_cmd = create_autospec(
                    file_module.apply_template_on_contents,
                    return_value=template_engine_file_str_file,
                )
                with patch.dict(
                    nxos_module.__salt__, {&quot;file.apply_template_on_contents&quot;: mock_cmd}
                ):
                    with patch(
                        &quot;salt.modules.nxos._configure_device&quot;,
                        autospec=True,
                        return_value=config_result_file,
                    ):
                        result = nxos_module.config(config_file=config_file)
                        self.assertEqual(result, expected_output)

    def test_config_file_error1(self):

        &quot;&quot;&quot;UT: nxos module:config method - Error file not found&quot;&quot;&quot;

        config_file = &quot;salt://bgp_config.txt&quot;

        with patch(
            &quot;salt.modules.nxos.show&quot;,
            autospec=True,
            side_effect=[initial_config_file, modified_config_file],
        ):
            mock_cmd = create_autospec(cp_module.get_file_str, return_value=False)
            with patch.dict(nxos_module.__salt__, {&quot;cp.get_file_str&quot;: mock_cmd}):
                mock_cmd = create_autospec(
                    file_module.apply_template_on_contents,
                    return_value=template_engine_file_str_file,
                )
                with patch.dict(
                    nxos_module.__salt__, {&quot;file.apply_template_on_contents&quot;: mock_cmd}
                ):
                    with patch(
                        &quot;salt.modules.nxos._configure_device&quot;,
                        autospec=True,
                        return_value=config_result_file,
                    ):
                        with self.assertRaises(CommandExecutionError):
                            nxos_module.config(config_file=config_file)

    def test_config_nxos_error_ssh(self):

        &quot;&quot;&quot;UT: nxos module:config method - nxos device error over ssh transport&quot;&quot;&quot;

        commands = [&quot;feature bgp&quot;, &quot;router bgp 57&quot;]
        config_result = [
            [&quot;feature bgp&quot;, &quot;router bgp 57&quot;],
            &quot;bgp instance is already running; Tag is 55&quot;,
        ]
        expected_output = (
            &quot;COMMAND_LIST: feature bgp ; router bgp 57\nbgp instance is already&quot;
            &quot; running; Tag is 55\n--- \n+++ \n@@ -19,7 +19,6 @@\n feature bash-shell\n&quot;
            &quot; cfs eth distribute\n feature ngmvpn\n-feature ospf\n feature pim\n&quot;
            &quot; feature lldp\n \n&quot;
        )

        with patch(
            &quot;salt.modules.nxos.show&quot;,
            autospec=True,
            side_effect=[initial_config[0], modified_config[0]],
        ):
            mock_cmd = create_autospec(
                file_module.apply_template_on_contents,
                return_value=template_engine_file_str,
            )
            with patch.dict(
                nxos_module.__salt__, {&quot;file.apply_template_on_contents&quot;: mock_cmd}
            ):
                with patch(
                    &quot;salt.modules.nxos._configure_device&quot;,
                    autospec=True,
                    return_value=config_result,
                ):
                    result = nxos_module.config(commands)
                    self.assertEqual(result, expected_output)

    def test_commands_error(self):

        &quot;&quot;&quot;UT: nxos module:config method - Mandatory arg commands not specified&quot;&quot;&quot;

        commands = None

        with patch(
            &quot;salt.modules.nxos.show&quot;,
            autospec=True,
            side_effect=[initial_config_file, modified_config_file],
        ):
            mock_cmd = create_autospec(cp_module.get_file_str, return_value=False)
            with patch.dict(nxos_module.__salt__, {&quot;cp.get_file_str&quot;: mock_cmd}):
                mock_cmd = create_autospec(
                    file_module.apply_template_on_contents,
                    return_value=template_engine_file_str_file,
                )
                with patch.dict(
                    nxos_module.__salt__, {&quot;file.apply_template_on_contents&quot;: mock_cmd}
                ):
                    with patch(
                        &quot;salt.modules.nxos._configure_device&quot;,
                        autospec=True,
                        return_value=config_result_file,
                    ):
                        with self.assertRaises(CommandExecutionError):
                            nxos_module.config(commands=commands)

    def test_config_file_error2(self):

        &quot;&quot;&quot;UT: nxos module:config method - Mandatory arg config_file not specified&quot;&quot;&quot;

        config_file = None

        with patch(
            &quot;salt.modules.nxos.show&quot;,
            autospec=True,
            side_effect=[initial_config_file, modified_config_file],
        ):
            mock_cmd = create_autospec(cp_module.get_file_str, return_value=False)
            with patch.dict(nxos_module.__salt__, {&quot;cp.get_file_str&quot;: mock_cmd}):
                mock_cmd = create_autospec(
                    file_module.apply_template_on_contents,
                    return_value=template_engine_file_str_file,
                )
                with patch.dict(
                    nxos_module.__salt__, {&quot;file.apply_template_on_contents&quot;: mock_cmd}
                ):
                    with patch(
                        &quot;salt.modules.nxos._configure_device&quot;,
                        autospec=True,
                        return_value=config_result_file,
                    ):
                        with self.assertRaises(CommandExecutionError):
                            nxos_module.config(config_file=config_file)

    def test_delete_config(self):

        &quot;&quot;&quot;UT: nxos module:delete_config method&quot;&quot;&quot;

        for lines in [&quot;feature bgp&quot;, [&quot;feature bgp&quot;]]:
            with patch(&quot;salt.modules.nxos.config&quot;, autospec=True):
                result = nxos_module.delete_config(lines)
                nxos_module.config.assert_called_with([&quot;no feature bgp&quot;])
                self.assertEqual(result, nxos_module.config.return_value)

    def test_remove_user(self):

        &quot;&quot;&quot;UT: nxos module:remove_user method&quot;&quot;&quot;

        with patch(&quot;salt.modules.nxos.config&quot;, autospec=True):
            result = nxos_module.remove_user(&quot;salt_test&quot;)
            nxos_module.config.assert_called_with(&quot;no username salt_test&quot;)
            self.assertEqual(result, nxos_module.config.return_value)

    def test_replace(self):

        &quot;&quot;&quot;UT: nxos module:replace method&quot;&quot;&quot;

        old_value = &quot;feature bgp&quot;
        new_value = &quot;feature ospf&quot;

        with patch(
            &quot;salt.modules.nxos.show_run&quot;,
            autospec=True,
            return_value=n9k_show_running_config_list[0],
        ):
            with patch(
                &quot;salt.modules.nxos.delete_config&quot;, autospec=True, return_value=None
            ):
                with patch(
                    &quot;salt.modules.nxos.add_config&quot;, autospec=True, return_value=None
                ):
                    result = nxos_module.replace(old_value, new_value)
                    self.assertEqual(result[&quot;old&quot;], [&quot;feature bgp&quot;])
                    self.assertEqual(result[&quot;new&quot;], [&quot;feature ospf&quot;])

    def test_replace_full_match_true(self):

        &quot;&quot;&quot;UT: nxos module:replace method - full match true&quot;&quot;&quot;

        old_value = &quot;feature bgp&quot;
        new_value = &quot;feature ospf&quot;

        with patch(
            &quot;salt.modules.nxos.show_run&quot;,
            autospec=True,
            return_value=n9k_show_running_config_list[0],
        ):
            with patch(
                &quot;salt.modules.nxos.delete_config&quot;, autospec=True, return_value=None
            ):
                with patch(
                    &quot;salt.modules.nxos.add_config&quot;, autospec=True, return_value=None
                ):
                    result = nxos_module.replace(old_value, new_value, full_match=True)
                    self.assertEqual(result[&quot;old&quot;], [&quot;feature bgp&quot;])
                    self.assertEqual(result[&quot;new&quot;], [&quot;feature ospf&quot;])

    def test_replace_no_match(self):

        &quot;&quot;&quot;UT: nxos module:replace method - no match&quot;&quot;&quot;

        old_value = &quot;feature does_not_exist&quot;
        new_value = &quot;feature ospf&quot;

        with patch(
            &quot;salt.modules.nxos.show_run&quot;,
            autospec=True,
            return_value=n9k_show_running_config_list[0],
        ):
            with patch(
                &quot;salt.modules.nxos.delete_config&quot;, autospec=True, return_value=None
            ):
                with patch(
                    &quot;salt.modules.nxos.add_config&quot;, autospec=True, return_value=None
                ):
                    result = nxos_module.replace(old_value, new_value)
                    self.assertEqual(result[&quot;old&quot;], [])
                    self.assertEqual(result[&quot;new&quot;], [])

    def test_save_running_config(self):

        &quot;&quot;&quot;UT: nxos module:save_running_config method&quot;&quot;&quot;

        with patch(
            &quot;salt.modules.nxos.config&quot;, autospec=True, return_value=save_running_config
        ):
            result = nxos_module.save_running_config()
            self.assertEqual(result, save_running_config)

    def test_set_password_enc_false_cs_none(self):

        &quot;&quot;&quot;UT: nxos module:set_password method - encrypted False, crypt_salt None&quot;&quot;&quot;

        username = &quot;devops&quot;
        password = &quot;test123TMM^&amp;&quot;
        hashed_pass = &quot;$5$ZcZqm15X$exHN2m6yrPKpYhGArK3Vml3ZjNbJaJYdzWyf0fp1Up2&quot;
        config_line = (
            &quot;username devops password 5&quot;
            &quot; $5$ZcZqm15X$exHN2m6yrPKpYhGArK3Vml3ZjNbJaJYdzWyf0fp1Up2&quot;
        )

        with patch(&quot;salt.modules.nxos.get_user&quot;, autospec=True):
            with patch(
                &quot;salt.modules.nxos.gen_hash&quot;, autospec=True, return_value=hashed_pass
            ):
                with patch(
                    &quot;salt.modules.nxos.config&quot;,
                    autospec=True,
                    return_value=&quot;password_set&quot;,
                ) as config:
                    result = nxos_module.set_password(username, password)
                    config.assert_called_with(config_line)
                    self.assertEqual(&quot;password_set&quot;, result)

    def test_set_password_enc_false_cs_set(self):

        &quot;&quot;&quot;UT: nxos module:set_password method - encrypted False, crypt_salt set&quot;&quot;&quot;

        username = &quot;devops&quot;
        password = &quot;test123TMM^&amp;&quot;
        crypt_salt = &quot;ZcZqm15X&quot;
        hashed_pass = &quot;$5$ZcZqm15X$exHN2m6yrPKpYhGArK3Vml3ZjNbJaJYdzWyf0fp1Up2&quot;
        config_line = (
            &quot;username devops password 5&quot;
            &quot; $5$ZcZqm15X$exHN2m6yrPKpYhGArK3Vml3ZjNbJaJYdzWyf0fp1Up2&quot;
        )

        with patch(&quot;salt.modules.nxos.get_user&quot;, autospec=True):
            with patch(
                &quot;salt.modules.nxos.gen_hash&quot;, autospec=True, return_value=hashed_pass
            ):
                with patch(
                    &quot;salt.modules.nxos.config&quot;,
                    autospec=True,
                    return_value=&quot;password_set&quot;,
                ) as config:
                    result = nxos_module.set_password(
                        username, password, crypt_salt=crypt_salt
                    )
                    config.assert_called_with(config_line)
                    self.assertEqual(&quot;password_set&quot;, result)

    def test_set_password_enc_true(self):

        &quot;&quot;&quot;UT: nxos module:set_password method - encrypted True&quot;&quot;&quot;

        username = &quot;devops&quot;
        password = &quot;test123TMM^&amp;&quot;
        hashed_pass = &quot;$5$ZcZqm15X$exHN2m6yrPKpYhGArK3Vml3ZjNbJaJYdzWyf0fp1Up2&quot;
        config_line = &quot;username devops password 5 test123TMM^&amp;&quot;

        with patch(&quot;salt.modules.nxos.get_user&quot;, autospec=True):
            with patch(
                &quot;salt.modules.nxos.gen_hash&quot;, autospec=True, return_value=hashed_pass
            ):
                with patch(
                    &quot;salt.modules.nxos.config&quot;,
                    autospec=True,
                    return_value=&quot;password_set&quot;,
                ) as config:
                    result = nxos_module.set_password(
                        username, password, encrypted=True
                    )
                    config.assert_called_with(config_line)
                    self.assertEqual(&quot;password_set&quot;, result)

    def test_set_password_role_none(self):

        &quot;&quot;&quot;UT: nxos module:set_password method - role none&quot;&quot;&quot;

        username = &quot;devops&quot;
        password = &quot;test123TMM^&amp;&quot;
        hashed_pass = &quot;$5$ZcZqm15X$exHN2m6yrPKpYhGArK3Vml3ZjNbJaJYdzWyf0fp1Up2&quot;
        config_line = &quot;username devops password 5 test123TMM^&amp; role devops&quot;

        with patch(&quot;salt.modules.nxos.get_user&quot;, autospec=True):
            with patch(
                &quot;salt.modules.nxos.gen_hash&quot;, autospec=True, return_value=hashed_pass
            ):
                with patch(
                    &quot;salt.modules.nxos.config&quot;,
                    autospec=True,
                    return_value=&quot;password_set&quot;,
                ) as config:
                    # Execute the function under test
<A NAME="1"></A>                    result = nxos_module.set_password(
                        username, password, encrypted=True, role=&quot;devops&quot;
                    )
                    config<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match31612-0.html#1',2,'match31612-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.assert_called_with(config_line)
                    self.assertEqual(&quot;password_set&quot;, result)

    def test_set_password_blowfish_crypt(self):

        &quot;&quot;&quot;UT: nxos module:set_password method - role none&quot;&quot;&quot;

        with self.assertRaises(SaltInvocationError):
            nxos_module.</B></FONT>set_password(
                &quot;username&quot;, &quot;password&quot;, encrypted=True, algorithm=&quot;blowfish&quot;
            )

    def test_set_role(self):

        &quot;&quot;&quot;UT: nxos module:save_running_config method&quot;&quot;&quot;

        username = &quot;salt_test&quot;
        role = &quot;vdc-admin&quot;

        with patch(&quot;salt.modules.nxos.config&quot;, autospec=True, return_value=set_role):
            result = nxos_module.set_role(username, role)
            self.assertEqual(result, set_role)

    def test_unset_role(self):

        &quot;&quot;&quot;UT: nxos module:save_running_config method&quot;&quot;&quot;

        username = &quot;salt_test&quot;
        role = &quot;vdc-admin&quot;

        with patch(&quot;salt.modules.nxos.config&quot;, autospec=True, return_value=unset_role):
            result = nxos_module.unset_role(username, role)
            self.assertEqual(result, unset_role)

    def test_configure_device(self):

<A NAME="2"></A>        &quot;&quot;&quot;UT: nxos module:_configure_device method&quot;&quot;&quot;

        with patch(&quot;salt.utils.platform.is_proxy&quot;, autospec=True, return_value=True):
            <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match31612-0.html#2',2,'match31612-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>with patch.dict(
                nxos_module.__proxy__,
                {&quot;nxos.proxy_config&quot;: MagicMock(return_value=&quot;configured&quot;)},
            ):
                result = nxos_module._configure_device(&quot;feature bgp&quot;)
                self.assertEqual(</B></FONT>result, &quot;configured&quot;)

        with patch(&quot;salt.utils.platform.is_proxy&quot;, autospec=True, return_value=False):
            with patch.object(
                nxos_module, &quot;_nxapi_config&quot;, MagicMock(return_value=&quot;configured&quot;)
            ):
                nxos_module._configure_device(&quot;feature bgp&quot;)
                self.assertEqual(result, &quot;configured&quot;)

    def test_nxapi_config(self):

        &quot;&quot;&quot;UT: nxos module:_nxapi_config method&quot;&quot;&quot;

        mock_cmd = MagicMock(return_value={&quot;nxos&quot;: {&quot;save_config&quot;: False}})
        with patch.dict(nxos_module.__salt__, {&quot;config.get&quot;: mock_cmd}):
<A NAME="0"></A>            with patch(
                &quot;salt.modules.nxos._nxapi_request&quot;,
                return_value=&quot;router_data&quot;,
                autospec<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match31612-0.html#0',2,'match31612-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>=True,
            ):
                result = nxos_module._nxapi_config(&quot;show version&quot;)
                self.assertEqual(result, [[&quot;show version&quot;], &quot;router_data&quot;])

    def test_nxapi_config_failure(self):

        &quot;&quot;&quot;UT: nxos module:_nxapi_config method&quot;&quot;&quot;

        side_effect = [&quot;Failure&quot;</B></FONT>, &quot;saved_data&quot;]

        mock_cmd = MagicMock(return_value={&quot;nxos&quot;: {&quot;save_config&quot;: True}})
        with patch.dict(nxos_module.__salt__, {&quot;config.get&quot;: mock_cmd}):
            with patch(
                &quot;salt.modules.nxos._nxapi_request&quot;,
                side_effect=side_effect,
                autospec=True,
            ):
                result = nxos_module._nxapi_config(&quot;show bad_command&quot;)
                self.assertEqual(result, [[&quot;show bad_command&quot;], &quot;Failure&quot;])

    def test_nxapi_request_proxy(self):

        &quot;&quot;&quot;UT: nxos module:_nxapi_request method - proxy&quot;&quot;&quot;

        with patch(&quot;salt.utils.platform.is_proxy&quot;, autospec=True, return_value=True):
            mock_request = create_autospec(
                nxos_utils.nxapi_request, return_value=&quot;router_data&quot;
            )
            with patch.dict(
                nxos_module.__proxy__, {&quot;nxos._nxapi_request&quot;: mock_request}
            ):
                result = nxos_module._nxapi_request(&quot;show version&quot;)
                self.assertEqual(result, &quot;router_data&quot;)

    def test_nxapi_request_no_proxy(self):

        &quot;&quot;&quot;UT: nxos module:_nxapi_request method - no proxy&quot;&quot;&quot;

        with patch(&quot;salt.utils.platform.is_proxy&quot;, autospec=True, return_value=False):
            mock_cmd = MagicMock(return_value={&quot;nxos&quot;: {&quot;save_config&quot;: False}})
            with patch.dict(nxos_module.__salt__, {&quot;config.get&quot;: mock_cmd}):
                mock_request = create_autospec(nxos_utils.nxapi_request)
                with patch.dict(
                    nxos_module.__utils__, {&quot;nxos.nxapi_request&quot;: mock_request}
                ):
                    result = nxos_module._nxapi_request(&quot;show version&quot;)
                    self.assertEqual(result, mock_request.return_value)
                    mock_request.assert_called_with(
                        &quot;show version&quot;, &quot;cli_conf&quot;, **mock_cmd.return_value
                    )
</PRE>
</div>
  </div>
</body>
</html>
