<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for digitalocean.py &amp; vmware.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for digitalocean.py &amp; vmware.py
      </h3>
<h1 align="center">
        4.7%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>digitalocean.py (11.10414%)<th>vmware.py (2.9888551%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(269-300)<td><a href="#" name="0">(2715-2755)</a><td align="center"><font color="#ff0000">29</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(62-86)<td><a href="#" name="1">(167-191)</a><td align="center"><font color="#d30000">24</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(906-917)<td><a href="#" name="2">(2702-2712)</a><td align="center"><font color="#af0000">20</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(851-878)<td><a href="#" name="3">(2636-2665)</a><td align="center"><font color="#9e0000">18</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(27-52)<td><a href="#" name="4">(119-138)</a><td align="center"><font color="#950000">17</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(1022-1026)<td><a href="#" name="5">(593-598)</a><td align="center"><font color="#8c0000">16</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(584-598)<td><a href="#" name="6">(3365-3378)</a><td align="center"><font color="#8c0000">16</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(491-497)<td><a href="#" name="7">(3005-3013)</a><td align="center"><font color="#720000">13</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(427-429)<td><a href="#" name="8">(3224-3226)</a><td align="center"><font color="#690000">12</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(117-134)<td><a href="#" name="9">(2070-2102)</a><td align="center"><font color="#690000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>digitalocean.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import decimal
2 import logging
3 import os
4 import pprint
5 import time
6 import salt.config as config
7 import salt.utils.cloud
8 import salt.utils.files
9 import salt.utils.json
10 import salt.utils.stringutils
11 from salt.exceptions import (
12     SaltCloudConfigError,
13     SaltCloudExecutionFailure,
14     SaltCloudExecutionTimeout,
15     SaltCloudNotFound,
16     SaltCloudSystemExit,
17     SaltInvocationError,
18 )
19 try:
20     import requests
21     HAS_REQUESTS = True
22 except ImportError:
23     HAS_REQUESTS =</b></font> False
24 log = logging.getLogger(__name__)
25 __virtualname__ = "digitalocean"
26 __virtual_aliases__ = ("digital_ocean", "do")
27 <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>def __virtual__():
28     if get_configured_provider() is False:
29         return False
30     if get_dependencies() is False:
31         return False
32     return __virtualname__
33 def _get_active_provider_name():
34     try:
35         return __active_provider_name__.value()
36     except AttributeError:
37         return __active_provider_name__
38 def get_configured_provider():
39     return config.is_provider_configured(</b></font>
40         opts=__opts__,
41         provider=_get_active_provider_name() or __virtualname__,
42         aliases=__virtual_aliases__,
43         required_keys=("personal_access_token",),
44     )
45 def get_dependencies():
46     return config.check_driver_dependencies(__virtualname__, {"requests": HAS_REQUESTS})
47 def avail_locations(call=None):
48     if call == "action":
49         raise SaltCloudSystemExit(
50             "The avail_locations function must be called with "
51             "-f or --function, or with the --list-locations option"
52         )
53     items = query(method="regions")
54     ret = {}
55         ret[region["name"]] = {}
56         for item in region.keys():
57             ret[region["name"]][item] = str(region[i<font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>tem])
58     return ret
59 def avail_images(call=None):
60     if call == "action":
61         raise SaltCloudSystemExit(
62             "The avail_images function must be called with "
63             "-f or --function, or with the --list-images option"
64         )
65     fetch = True
66     page = 1
67     ret =</b></font> {}
68     while fetch:
69         items = query(method="images", command="?page=" + str(page) + "&amp;per_page=200")
70         for image in items["images"]:
71             ret[image["name"]] = {}
72             for item in image.keys():
73                 ret[image["name"]][item] = image[item]
74         page += 1
75         try:
76             fetch = "next" in items["links"]["pages"]
77         except KeyError:
78             fetch = False
79     return ret
80 def avail_sizes(call=None):
81     if call == "action":
82         raise SaltCloudSystemExit(
83             "The avail_sizes function must be called with "
84             "-f or --function, or with the --list-sizes option"
85         )
86     items = query(method="sizes", command="?per_page=100")
87     ret = {}
88     for size in items["sizes"]:
89         ret[size["slug"]] = {}
90         for item in size.keys():
91             ret[size["slug"]][item] = str(size[item])
92     return ret
93 def list_nodes(call=None):
94     if call == "action":
95         raise SaltCloudSystemExit(
96             "The list_nodes function must be called with -f or --function."
97         )
98     return _list_nodes()
99 def list_nodes_full(call=None, for_output=True):
100     if call == "action":
101         raise SaltCloudSystemExit(
102             "The list_nodes_full function must be called with -f or --function."
103         )
104     return _list_nodes(full=True, for_output=for_output)
105 def list_nodes_select(call=None):
106     return salt.utils.cloud.list_nodes_select(
107         list_nodes_full("function"),
108         __opts__["query.selection"],
109         call,
110     )
111 def get_image(vm_):
112     images = avail_images()
113     vm_image = config.get_cloud_config_value(
114         "image", vm_, __opts__, search_global=False
115     )
116     if not isinstance(vm_image, str):
117         vm_image = str(vm_image)
118     for image in images:
119         if vm_image in (
120             images[image]["name"],
121             images[image]["slug"],
122             images[image]["id"],
123         ):
124             if images[image]["slug"] is not None:
125                 return images[image]["slug"]
126             return int(images[image]["id"])
127     raise SaltCloudNotFound(
128         "The specified image, '{}', could not be found.".format(vm_image)
129     )
130 def get_size(vm_):
131     sizes = avail_sizes()
132     vm_size = str(
133         config.get_cloud_config_value("size", vm_, __opts__, search_global=False)
134     )
135     for size in sizes:
136         if vm_size.lower() == sizes[size]["slug"]:
137             return sizes[size]["slug"]
138     raise SaltCloudNotFound(
139         "The specified size, '{}', could not be found.".format(vm_size)
140     )
141 def get_location(vm_):
142     locations = avail_locations()
143     vm_location = str(
144         config.get_cloud_config_value("location", vm_, __opts__, search_global=False)
145     )
146     for location in locations:
147         if vm_location in (locations[location]["name"], locations[location]["slug"]):
148             return locations[location]["slug"]
149     raise SaltCloudNotFound(
150         "The specified location, '{}', could not be found.".format(vm_location)
151     )
152 def create_node(args):
153     node = query(method="droplets", args=args, http_method="post")
154     <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>return node
155 def create(vm_):
156     try:
157         if (
158             vm_["profile"]
159             and config.is_profile_configured(
160                 __opts__,
161                 _get_active_provider_name() or "digitalocean",
162                 vm_["profile"],
163                 vm_=vm_,
164             )
165             is False
166         ):
167             return False
168     except AttributeError:
169         pass
170     __utils__["cloud.fire_event"](
171         "event",
172         "starting create",
173         "salt/cloud/{}/creating".format(vm_["name"]),
174         args=__utils__["cloud.filter_event"](
175             "creating", vm_, ["name", "profile", "provider", "driver"]
176         ),
177         sock_dir=__opts__["sock_dir"],
178         transport=__opts__[</b></font>"transport"],
179     )
180     log.info("Creating Cloud VM %s", vm_["name"])
181     kwargs = {
182         "name": vm_["name"],
183         "size": get_size(vm_),
184         "image": get_image(vm_),
185         "region": get_location(vm_),
186         "ssh_keys": [],
187         "tags": [],
188     }
189     ssh_key_name = config.get_cloud_config_value(
190         "ssh_key_name", vm_, __opts__, search_global=False
191     )
192     if ssh_key_name:
193         kwargs["ssh_keys"].append(get_keyid(ssh_key_name))
194     ssh_key_names = config.get_cloud_config_value(
195         "ssh_key_names", vm_, __opts__, search_global=False, default=False
196     )
197     if ssh_key_names:
198         for key in ssh_key_names.split(","):
199             kwargs["ssh_keys"].append(get_keyid(key))
200     key_filename = config.get_cloud_config_value(
201         "ssh_key_file", vm_, __opts__, search_global=False, default=None
202     )
203     if key_filename is not None and not os.path.isfile(key_filename):
204         raise SaltCloudConfigError(
205             "The defined key_filename '{}' does not exist".format(key_filename)
206         )
207     if not __opts__.get("ssh_agent", False) and key_filename is None:
208         raise SaltCloudConfigError(
209             "The DigitalOcean driver requires an ssh_key_file and an ssh_key_name "
210             "because it does not supply a root password upon building the server."
211         )
212     ssh_interface = config.get_cloud_config_value(
213         "ssh_interface", vm_, __opts__, search_global=False, default="public"
214     )
215     if ssh_interface in ["private", "public"]:
216         log.info("ssh_interface: Setting interface for ssh to %s", ssh_interface)
217         kwargs["ssh_interface"] = ssh_interface
218     else:
219         raise SaltCloudConfigError(
220             "The DigitalOcean driver requires ssh_interface to be defined as 'public'"
221             " or 'private'."
222         )
223     private_networking = config.get_cloud_config_value(
224         "private_networking",
225         vm_,
226         __opts__,
227         search_global=False,
228         default=None,
229     )
230     if private_networking is not None:
231         if not isinstance(private_networking, bool):
232             raise SaltCloudConfigError(
233                 "'private_networking' should be a boolean value."
234             )
235         kwargs["private_networking"] = private_networking
236     if not private_networking and ssh_interface == "private":
237         raise SaltCloudConfigError(
238             "The DigitalOcean driver requires ssh_interface if defined as 'private' "
239             "then private_networking should be set as 'True'."
240         )
241     backups_enabled = config.get_cloud_config_value(
242         "backups_enabled",
243         vm_,
244         __opts__,
245         search_global=False,
246         default=None,
247     )
248     if backups_enabled is not None:
249         if not isinstance(backups_enabled, bool):
250             raise SaltCloudConfigError("'backups_enabled' should be a boolean value.")
251         kwargs["backups"] = backups_enabled
252     ipv6 = config.get_cloud_config_value(
253         "ipv6",
254         vm_,
255         __opts__,
256         search_global=False,
257         default=None,
258     )
259     if ipv6 is not None:
260         if not isinstance(ipv6, bool):
261             raise SaltCloudConfigError("'ipv6' should be a boolean value.")
262         kwargs["ipv6"] = ipv6
263     monitoring = config.get_cloud_config_value(
264         "monitoring",
265         vm_,
266         __opts__,
267         search_global=False,
268         default=None,
269     )
270     if monitoring is not None:
271         if not isinstance(monitoring, bool):
272             raise SaltCloudConfigError("'monitoring' should be a boolean value.")
273         kwargs["monitoring"] = monitoring
274     kwargs["tags"] = config.get_cloud_config_value(
275         "tags", vm_, __opts__, search_global=False, default=False
276     )
277     userdata_file = config.get_cloud_config_value(
278         "userdata_file", vm_, __opts__, search_global=False, default=None
279     if userdata_file is not None:
280         try:
281             with salt<font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.utils.files.fopen(userdata_file, "r") as fp_:
282                 kwargs["user_data"] = salt.utils.cloud.userdata_template(
283                     __opts__, vm_, salt.utils.</b></font>stringutils.to_unicode(fp_.read())
284                 )
285         except Exception as exc:  # pylint: disable=broad-except
286             log.exception("Failed to read userdata from %s: %s", userdata_file, exc)
287     create_dns_record = config.get_cloud_config_value(
288         "create_dns_record",
289         vm_,
290         __opts__,
291         search_global=False,
292         default=None,
293     )
294     if create_dns_record:
295         log.info("create_dns_record: will attempt to write DNS records")
296         default_dns_domain = None
297         dns_domain_name = vm_["name"].split(".")
298         if len(dns_domain_name) &gt; 2:
299             log.debug(
300                 "create_dns_record: inferring default dns_hostname, dns_domain from"
301                 " minion name as FQDN"
302             )
303             default_dns_hostname = ".".join(dns_domain_name[:-2])
304             default_dns_domain = ".".join(dns_domain_name[-2:])
305         else:
306             log.debug("create_dns_record: can't infer dns_domain from %s", vm_["name"])
307             default_dns_hostname = dns_domain_name[0]
308         dns_hostname = config.get_cloud_config_value(
309             "dns_hostname",
310             vm_,
311             __opts__,
312             search_global=False,
313             default=default_dns_hostname,
314         )
315         dns_domain = config.get_cloud_config_value(
316             "dns_domain",
317             vm_,
318             __opts__,
319             search_global=False,
320             default=default_dns_domain,
321         )
322         if dns_hostname and dns_domain:
323             log.info(
324                 'create_dns_record: using dns_hostname="%s", dns_domain="%s"',
325                 dns_hostname,
326                 dns_domain,
327             )
328             __add_dns_addr__ = lambda t, d: post_dns_record(
329                 dns_domain=dns_domain, name=dns_hostname, record_type=t, record_data=d
330             )
331             log.debug("create_dns_record: %s", __add_dns_addr__)
332         else:
333             log.error(
334                 "create_dns_record: could not determine dns_hostname and/or dns_domain"
335             )
336             raise SaltCloudConfigError(
337                 "'create_dns_record' must be a dict specifying \"domain\" "
338             )
339     __utils__<font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["cloud.fire_event"](
340         "event",
341         "requesting instance",
342         "salt/cloud/{}/requesting".format(vm_["name"]),
343         args=__utils__["cloud.filter_event"]("requesting", kwargs, list(kwargs)),
344         sock_dir=__opts__["sock_dir"],
345         transport=__opts__[</b></font>"transport"],
346     )
347     try:
348         ret = create_node(kwargs)
349     except Exception as exc:  # pylint: disable=broad-except
350         log.error(
351             "Error creating %s on DIGITALOCEAN\n\n"
352             "The following exception was thrown when trying to "
353             "run the initial deployment: %s",
354             vm_["name"],
355             exc,
356             exc_info_on_loglevel=logging.DEBUG,
357         )
358         return False
359     def __query_node_data(vm_name):
360         data = show_instance(vm_name, "action")
361         if not data:
362             return False
363         if data["networks"].get("v4"):
364             for network in data["networks"]["v4"]:
365                 if network["type"] == "public":
366                     return data
367         return False
368     try:
369         data = salt.utils.cloud.wait_for_ip(
370             __query_node_data,
371             update_args=(vm_["name"],),
372             timeout=config.get_cloud_config_value(
373                 "wait_for_ip_timeout", vm_, __opts__, default=10 * 60
374             ),
375             interval=config.get_cloud_config_value(
376                 "wait_for_ip_interval", vm_, __opts__, default=10
377             ),
378         )
379     except (SaltCloudExecutionTimeout, SaltCloudExecutionFailure) as exc:
380         try:
381             destroy(vm_["name"])
382         except SaltCloudSystemExit:
383             pass
384         finally:
385             raise SaltCloudSystemExit(str(exc))
386     if not vm_.get("ssh_host"):
387         vm_["ssh_host"] = None
388     addr_families, dns_arec_types = (("v4", "v6"), ("A", "AAAA"))
389     arec_map = dict(list(zip(addr_families, dns_arec_types)))
390     for facing, addr_family, ip_address in [
391         (net["type"], family, net["ip_address"])
392         for family in addr_families
393         for net in data["networks"][family]
394     ]:
395         log.info('found %s IP%s interface for "%s"', facing, addr_family, ip_address)
396         dns_rec_type = arec_map[addr_family]
397         if facing == "public":
398             if create_dns_record:
399                 __add_dns_addr__(dns_rec_type, ip_address)
400         if facing == ssh_interface:
401             if not vm_["ssh_host"]:
402                 vm_["ssh_host"] = ip_address
403     if vm_["ssh_host"] is None:
404         raise SaltCloudSystemExit(
405             "No suitable IP addresses found for ssh minion bootstrapping: {}".format(
406                 repr(data["networks"])
407             )
408         )
409     log.debug(
410         "Found public IP address to use for ssh minion bootstrapping: %s",
411         vm_["ssh_host"],
412     )
413     vm_["key_filename"] = key_filename
414     ret = __utils__["cloud.bootstrap"](vm_, __opts__)
415     ret.update(data)
416     log.debug("'%s' VM creation details:\n%s", vm_["name"], pprint.pformat(data))
417     __utils__<font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["cloud.fire_event"](
418         "event",
419         "created instance",
420         "salt/cloud/{}/created".format(vm_["name"]),
421         args=__utils__["cloud.filter_event"](
422             "created", vm_, ["name", "profile", "provider", "driver"]
423         ),
424         sock_dir=__opts__["sock_dir"],
425         transport=__opts__["transport"],
426     )
427     return ret
428 def</b></font> query(
429     method="droplets", droplet_id=None, command=None, args=None, http_method="get"
430 ):
431     base_path = str(
432         config.get_cloud_config_value(
433             "api_root",
434             get_configured_provider(),
435             __opts__,
436             search_global=False,
437             default="https://api.digitalocean.com/v2",
438         )
439     )
440     path = "{}/{}/".format(base_path, method)
441     if droplet_id:
442         path += "{}/".format(droplet_id)
443     if command:
444         path += command
445     if not isinstance(args, dict):
446         args = {}
447     personal_access_token = config.get_cloud_config_value(
448         "personal_access_token",
449         get_configured_provider(),
450         __opts__,
451         search_global=False,
452     )
453     data = salt.utils.json.dumps(args)
454     requester = getattr(requests, http_method)
455     request = requester(
456         path,
457         data=data,
458         headers={
459             "Authorization": "Bearer " + personal_access_token,
460             "Content-Type": "application/json",
461         },
462     )
463     if request.status_code &gt; 299:
464         raise SaltCloudSystemExit(
465             "An error occurred while querying DigitalOcean. HTTP Code: {}  "
466             "Error: '{}'".format(
467                 request.status_code,
468                 request.text,
469             )
470         )
471     log.debug(request.url)
472     if request.status_code == 204:
473         return True
474     content = request.text
475     result = salt.utils.json.loads(content)
476     if result.get("status", "").lower() == "error":
477         raise SaltCloudSystemExit(pprint.pformat(result.get("error_message", {})))
478     return result
479 def script(vm_):
480     deploy_script = salt.utils.cloud.os_script(
481         config.get_cloud_config_value("script", vm_, __opts__),
482         vm_,
483         __opts__,
484         salt.utils.cloud.salt_config_to_yaml(
485             salt.utils.cloud.minion_config(__opts__, vm_)
486         ),
487     )
488     return deploy_script
489 def show_instance(name, call=None):
490     if call != "action":
491         raise SaltCloudSystemExit(
492             "The show_instance action must be called with -a or --action."
493         )
494     node = _get_node(name)
495     __utils__["cloud.cache_node"](node, _get_active_provider_name(), __opts__)
496     return node
497 def _get_node(name):
498     attempts = 10
499     while attempts &gt;= 0:
500         try:
501             return list_nodes_full(for_output=False)[name]
502         except KeyError:
503             attempts -= 1
504             log.debug(
505                 "Failed to get the data for node '%s'. Remaining attempts: %s",
506                 name,
507                 attempts,
508             )
509             time.sleep(0.5)
510     return {}
511 def list_keypairs(call=None):
512     if call != "function":
513         log.error("The list_keypairs function must be called with -f or --function.")
514         return False
515     fetch = True
516     page = 1
517     ret = {}
518     while fetch:
519         items = query(
520             method="account/keys",
521             command="?page=" + str(page) + "&amp;per_page=100",
522         )
523         for key_pair in items["ssh_keys"]:
524             name = key_pair["name"]
525             if name in ret:
526                 raise SaltCloudSystemExit(
527                     "A duplicate key pair name, '{}', was found in DigitalOcean's "
528                     "key pair list. Please change the key name stored by DigitalOcean. "
529                     "Be sure to adjust the value of 'ssh_key_file' in your cloud "
530                     "profile or provider configuration, if necessary.".format(name)
531                 )
532             ret[name] = {}
533             for item in key_pair.keys():
534                 ret[name][item] = str(key_pair[item])
535         page += 1
536         try:
537             fetch = "next" in items["links"]["pages"]
538         except KeyError:
539             fetch = False
540     return ret
541 def show_keypair(kwargs=None, call=None):
542     if call != "function":
543         log.error("The show_keypair function must be called with -f or --function.")
544         return False
545     if not kwargs:
546         kwargs = {}
547     if "keyname" not in kwargs:
548         log.error("A keyname is required.")
549         return False
550     keypairs = list_keypairs(call="function")
551     keyid = keypairs[kwargs["keyname"]]["id"]
552     log.debug("Key ID is %s", keyid)
553     details = query(method="account/keys", command=keyid)
554     return details
555 def import_keypair(kwargs=None, call=None):
556     with salt.utils.files.fopen(kwargs["file"], "r") as public_key_filename:
557         public_key_content = salt.utils.stringutils.to_unicode(
558             public_key_filename.read()
559         )
560     digitalocean_kwargs = {"name": kwargs["keyname"], "public_key": public_key_content}
561     created_result = create_key(digitalocean_kwargs, call=call)
562     return created_result
563 def create_key(kwargs=None, call=None):
564     if call != "function":
565         log.error("The create_key function must be called with -f or --function.")
566         return False
567     try:
568         result = query(
569             method="account",
570             command="keys",
571             args={"name": kwargs["name"], "public_key": kwargs["public_key"]},
572             http_method="post",
573         )
574     except KeyError:
575         log.info("`name` and `public_key` arguments must be specified")
576         return False
577     return result
578 def remove_key(kwargs=None, call=None):
579     if call != "function":
580         log.error("The create_key function must be called with -f or --function.")
581         return False
582     try:
583         result = query(
584             method="account", command="keys/" + kwargs["id"], http_method="delete"
585         )
586     except KeyError:
587         log.info("`id` argument must be specified")
588         return False
589     return result
590 def get_keyid(keyname):
591     if not keyname:
592         return None
593     keypairs = list_keypairs(call="function")
594     if keyid:
595         return keyid
596     raise SaltCloudNotFound(<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"The specified ssh key could not be found.")
597 def destroy(name, call=None):
598     if call == "function":
599         raise SaltCloudSystemExit(
600             "The destroy action must be called with -d, --destroy, -a or --action."
601         )
602     __utils__["cloud.fire_event"](
603         "event",
604         "destroying instance",
605         "salt/cloud/{}/destroying".format(name),
606         args={"name": name},
607         sock_dir=__opts__["sock_dir"],
608         transport=__opts__["transport"],
609     )
610     data =</b></font> show_instance(name, call="action")
611     node = query(method="droplets", droplet_id=data["id"], http_method="delete")
612     delete_dns_record = True
613     if not isinstance(delete_dns_record, bool):
614         raise SaltCloudConfigError("'delete_dns_record' should be a boolean value.")
615     log.debug("Deleting DNS records for %s.", name)
616     destroy_dns_records(name)
617     __utils__<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["cloud.fire_event"](
618         "event",
619         "destroyed instance",
620         "salt/cloud/{}/destroyed".format(name),
621         args={"name": name},
622         sock_dir=__opts__["sock_dir"],
623         transport=__opts__["transport"],
624     )
625     if __opts__.get("update_cachedir", False) is True:
626         __utils__["cloud.delete_minion_cachedir"](
627             name, _get_active_provider_name().split(":")[</b></font>0], __opts__
628         )
629     return node
630 def post_dns_record(**kwargs):
631     if "kwargs" in kwargs:  # flatten kwargs if called via salt-cloud -f
632         f_kwargs = kwargs["kwargs"]
633         del kwargs["kwargs"]
634         kwargs.update(f_kwargs)
635     mandatory_kwargs = ("dns_domain", "name", "record_type", "record_data")
636     for i in mandatory_kwargs:
637         if kwargs[i]:
638             pass
639         else:
640             error = '{}="{}" ## all mandatory args must be provided: {}'.format(
641                 i, kwargs[i], mandatory_kwargs
642             )
643             raise SaltInvocationError(error)
644     domain = query(method="domains", droplet_id=kwargs["dns_domain"])
645     if domain:
646         result = query(
647             method="domains",
648             droplet_id=kwargs["dns_domain"],
649             command="records",
650             args={
651                 "type": kwargs["record_type"],
652                 "name": kwargs["name"],
653                 "data": kwargs["record_data"],
654             },
655             http_method="post",
656         )
657         return result
658     return False
659 def destroy_dns_records(fqdn):
660     domain = ".".join(fqdn.split(".")[-2:])
661     hostname = ".".join(fqdn.split(".")[:-2])
662     try:
663         response = query(method="domains", droplet_id=domain, command="records")
664     except SaltCloudSystemExit:
665         log.debug("Failed to find domains.")
666         return False
667     log.debug("found DNS records: %s", pprint.pformat(response))
668     records = response["domain_records"]
669     if records:
670         record_ids = [r["id"] for r in records if r["name"].decode() == hostname]
671         log.debug("deleting DNS record IDs: %s", record_ids)
672         for id_ in record_ids:
673             try:
674                 log.info("deleting DNS record %s", id_)
675                 ret = query(
676                     method="domains",
677                     droplet_id=domain,
678                     command="records/{}".format(id_),
679                     http_method="delete",
680                 )
681             except SaltCloudSystemExit:
682                 log.error(
683                     "failed to delete DNS domain %s record ID %s.", domain, hostname
684                 )
685             log.debug("DNS deletion REST call returned: %s", pprint.pformat(ret))
686     return False
687 def show_pricing(kwargs=None, call=None):
688     profile = __opts__["profiles"].get(kwargs["profile"], {})
689     if not profile:
690         return {"Error": "The requested profile was not found"}
691     provider = profile.get("provider", "0:0")
692     comps = provider.split(":")
693     if len(comps) &lt; 2 or comps[1] != "digitalocean":
694         return {"Error": "The requested profile does not belong to DigitalOcean"}
695     ret = {}
696     sizes = avail_sizes()
697     ret["per_hour"] = decimal.Decimal(sizes<font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>[profile["size"]]["price_hourly"])
698     ret["per_day"] = ret["per_hour"] * 24
699     ret["per_week"] = ret["per_day"] * 7
700     ret["per_month"] = decimal.Decimal(sizes[profile["size"]][</b></font>"price_monthly"])
701     ret["per_year"] = ret["per_week"] * 52
702     if kwargs.get("raw", False):
703         ret["_raw"] = raw
704     return {profile["profile"]: ret}
705 def list_floating_ips(call=None):
706     if call == "action":
707         raise SaltCloudSystemExit(
708             "The list_floating_ips function must be called with "
709             "-f or --function, or with the --list-floating-ips option"
710         )
711     fetch = True
712     page = 1
713     ret = {}
714     while fetch:
715         items = query(
716             method="floating_ips",
717             command="?page=" + str(page) + "&amp;per_page=200",
718         )
719         for floating_ip in items["floating_ips"]:
720             ret[floating_ip["ip"]] = {}
721             for item in floating_ip.keys():
722                 ret[floating_ip["ip"]][item] = floating_ip[item]
723         page += 1
724         try:
725             fetch = "next" in items["links"]["pages"]
726         except KeyError:
727             fetch = False
728     return ret
729 def show_floating_ip(kwargs=None, call=None):
730     if call != "function":
731         log.error("The show_floating_ip function must be called with -f or --function.")
732         return False
733     if not kwargs:
734         kwargs = {}
735     if "floating_ip" not in kwargs:
736         log.error("A floating IP is required.")
737         return False
738     floating_ip = kwargs["floating_ip"]
739     log.debug("Floating ip is %s", floating_ip)
740     details = query(method="floating_ips", command=floating_ip)
741     return details
742 def create_floating_ip(kwargs=None, call=None):
743     if call != "function":
744         log.error(
745             "The create_floating_ip function must be called with -f or --function."
746         )
747         return False
748     if not kwargs:
749         kwargs = {}
750     if "droplet_id" in kwargs:
751         result = query(
752             method="floating_ips",
753             args={"droplet_id": kwargs["droplet_id"]},
754             http_method="post",
755         )
756         return result
757     elif "region" in kwargs:
758         result = query(
759             method="floating_ips", args={"region": kwargs["region"]}, http_method="post"
760         )
761         return result
762     else:
763         log.error("A droplet_id or region is required.")
764         return False
765 def delete_floating_ip(kwargs=None, call=None):
766     if call != "function":
767         log.error(
768             "The delete_floating_ip function must be called with -f or --function."
769         )
770         return False
771     if not kwargs:
772         kwargs = {}
773     if "floating_ip" not in kwargs:
774         log.error("A floating IP is required.")
775         return False
776     floating_ip = kwargs["floating_ip"]
777     log.debug("Floating ip is %s", kwargs["floating_ip"])
778     result = query(method="floating_ips", command=floating_ip, http_method="delete")
779     return result
780 def assign_floating_ip(kwargs=None, call=None):
781     if call != "function":
782         log.error(
783             "The assign_floating_ip function must be called with -f or --function."
784         )
785         return False
786     if not kwargs:
787         kwargs = {}
788     if "floating_ip" and "droplet_id" not in kwargs:
789         log.error("A floating IP and droplet_id is required.")
790         return False
791     result = query(
792         method="floating_ips",
793         command=kwargs["floating_ip"] + "/actions",
794         args={"droplet_id": kwargs["droplet_id"], "type": "assign"},
795         http_method="post",
796     )
797     return result
798 def unassign_floating_ip(kwargs=None, call=None):
799     if call != "function":
800         log.error(
801             "The inassign_floating_ip function must be called with -f or --function."
802         )
803         return False
804     if not kwargs:
805         kwargs = {}
806     if "floating_ip" not in kwargs:
807         log.error("A floating IP is required.")
808         return False
809     result = query(
810         method="floating_ips",
811         command=kwargs["floating_ip"] + "/actions",
812         args={"type": "unassign"},
813         http_method="post",
814     )
815     return result
816 def _list_nodes(full=False, for_output=False):
817     fetch = True
818     page = 1
819     ret = {}
820     while fetch:
821         items = query(method="droplets", command="?page=" + str(page) + "&amp;per_page=200")
822         for node in items["droplets"]:
823             name = node["name"]
824             ret[name] = {}
825             if full:
826                 ret[name] = _get_full_output(node, for_output=for_output)
827             else:
828                 public_ips, private_ips = _get_ips(node["networks"])
829                 ret[name] = {
830                     "id": node["id"],
831                     "image": node["image"]["name"],
832                     "name": name,
833                     "private_ips": private_ips,
834                     "public_ips": public_ips,
835                     "size": node["size_slug"],
836                     "state": str(node["status"]),
837                 }
838         page += 1
839         try:
840             fetch = "next" in items["links"]["pages"]
841         except KeyError:
842             fetch = False
843     return ret
844 def reboot(name, call=None):
845     if call != "action":
846         raise SaltCloudSystemExit(
847             "The reboot action must be called with -a or --action."
848         )
849     data = show_instance(name, call="action")
850     if data.get("status") == "off":
851         return {
852             "success": True,
853             "action": "stop",
854             "status": "off",
855             "msg": "Machine is already off.",
856         }
857     ret = query(
858         droplet_id=data["id"],
859         command="actions",
860         args={"type": "reboot"},
861         http_method="post",
862     )
863     return {
864         "success": True,
865         "action": ret["action"]["type"],
866         "state": ret["action"]["status"],
867     }
868 def start(name, call=None):
869     if call != "action":
870         raise SaltCloudSystemExit(
871             "The start action must be called with -a or --action."
872         )
873     data = show_instance(name, call="action")
874     if data.get("status") == "active":
875         return {
876             "success": True,
877             "action": "start",
878             "status": "active",
879             "msg": "Machine is already running.",
880         }
881     ret = query(
882         droplet_id=data["id"],
883         command="actions",
884         args={"type": "power_on"},
885         http_method="post",
886     )
887     return {
888         "success": True,
889         "action": ret["action"]["type"],
890         "state": ret["action"]["status"],
891     }
892 def stop(name, call=None):
893     if call != "action":
894         raise SaltCloudSystemExit("The stop action must be called with -a or --action.")
895     data = show_instance(name, call="action")
896     if data.get("status") == "off":
897         return {
898             "success": True,
899             "action": "stop",
900             "status": "off",
901             "msg": "Machine is already off.",
902         }
903     ret = query(
904         droplet_id=data["id"],
905         command="actions",
906         args={"type": "shutdown"},
907         http_method="post",
908     )
909     return {
910         "success": True,
911         "action": ret["action"]["type"],
912         "state": ret["action"]["status"],
913     }
914 def _get_full_output(node, for_output=False):
915     ret = {}
916     for item in node.keys():
917         value = node[item]
918         if value is not None and for_output:
919             value = str(value)
920         ret[item] = value
921     return ret
922 def _get_ips(networks):
923     v4s = networks.get("v4")
924     v6s = networks.get("v6")
925     public_ips = []
926     private_ips = []
927     if v4s:
928         for item in v4s:
929             ip_type = item.get("type")
930             ip_address = item.get("ip_address")
931             if ip_type == "public":
932                 public_ips.append(ip_address)
933             if ip_type == "private":
934                 private_ips.append(ip_address)
935     if v6s:
936         for item in v6s:
937             ip_type = item.get("type")
938             ip_address = item.get("ip_address")
939             if ip_type == "public":
940                 public_ips.append(ip_address)
941             if ip_type == "private":
942                 private_ips.append(ip_address)
943     return public_ips, private_ips
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>vmware.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import os.path
2 import pprint
3 <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import re
4 import subprocess
5 import time
6 from random import randint
7 import salt.config as config
8 import salt.utils.cloud
9 import salt.utils.network
10 import salt.utils.stringutils
11 import salt.utils.vmware
12 import salt.utils.xmlutil
13 from salt.exceptions import SaltCloudSystemExit
14 try:
15     from pyVmomi import vim  # pylint: disable=no-name-in-module
16     HAS_PYVMOMI = True
17 except ImportError:
18     HAS_PYVMOMI =</b></font> False
19 try:
20     from requests.packages.urllib3 import (
21         disable_warnings,
22     )  # pylint: disable=no-name-in-module
23     disable_warnings()
24 except ImportError:
25     pass
26 ESX_5_5_NAME_PORTION = "VMware ESXi 5.5"
27 SAFE_ESX_5_5_CONTROLLER_KEY_INDEX = 200
28 FLATTEN_DISK_FULL_CLONE = "moveAllDiskBackingsAndDisallowSharing"
29 COPY_ALL_DISKS_FULL_CLONE = "moveAllDiskBackingsAndAllowSharing"
30 CURRENT_STATE_LINKED_CLONE = "moveChildMostDiskBacking"
31 QUICK_LINKED_CLONE = "createNewChildDiskBacking"
32 IP_RE = r"^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
33 log = logging.getLogger(__name__)
34 __virtualname__ = "vmware"
35 <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>def __virtual__():
36     if get_configured_provider() is False:
37         return False
38     if get_dependencies() is False:
39         return False
40     return __virtualname__
41 def _get_active_provider_name():
42     try:
43         return __active_provider_name__.value()
44     except AttributeError:
45         return __active_provider_name__
46 def get_configured_provider():
47     return config.is_provider_configured(</b></font>
48         __opts__,
49         _get_active_provider_name() or __virtualname__,
50         (
51             "url",
52             "user",
53             "password",
54         ),
55     )
56 def get_dependencies():
57     deps = {
58         "pyVmomi": HAS_PYVMOMI,
59     }
60     return config.check_driver_dependencies(__virtualname__, deps)
61 def script(vm_):
62     script_name = config.get_cloud_config_value("script", vm_, __opts__)
63     if not script_name:
64         script_name = "bootstrap-salt"
65     return salt.utils.cloud.os_script(
66         script_name,
67         vm_,
68         __opts__,
69         salt.utils.cloud.salt_config_to_yaml(
70             salt.utils.cloud.minion_config(__opts__, vm_)
71         ),
72     )
73 def _str_to_bool(var):
74     if isinstance(var, bool):
75         return var
76     if isinstance(var, str):
77         return True if var.lower() == "true" else False
78     return None
79 def _get_si():
80     url = config.get_cloud_config_value(
81         "url", get_configured_provider(), __opts__, search_global=False
82     )
83     username = config.get_cloud_config_value(
84         "user", get_configured_provider(), __opts__, search_global=False
85     )
86     password = config.get_cloud_config_value(
87         "password", get_configured_provider(), __opts__, search_global=False
88     )
89     protocol = config.get_cloud_config_value(
90         "protocol",
91         get_configured_provider(),
92         __opts__,
93         search_global=False,
94         default="https",
95     )
96     port = config.get_cloud_config_value(
97         "port", get_configured_provider(), __opts__, search_global=False, default=443
98     )
99     verify_ssl = config.get_cloud_config_value(
100         "verify_ssl",
101         get_configured_provider(),
102         __opts__,
103         search_global=False,
104         default=True,
105     )
106     return salt.utils.vmware.get_service_instance(
107         url, username, password, protocol=protocol, port=port, verify_ssl=verify_ssl
108     )
109 def _edit_existing_hard_disk_helper(disk, size_kb=None, size_gb=None, mode=None):
110     if size_kb or size_gb:
111         disk.capacityInKB = size_kb if size_kb else int(size_gb * 1024.0 * 1024.0)
112     if mode:
113         disk.backing.diskMode = mode
114     disk_spec = vim.vm.device.VirtualDeviceSpec()
115     disk_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.edit
116     disk_spec.device = disk
117     return disk_spec
118 def _add_new_hard_disk_helper(
119     disk_label,
120     size_gb,
121     unit_number,
122     controller_key=1000,
123     thin_provision=False,
124     eagerly_scrub=False,
125     datastore=None,
126     vm_name=None,
127 ):
128     random_key = randint(-2099, -2000)
129     size_kb = int(size_gb * 1024.0 * 1024.0)
130     disk_spec = vim.vm.device.VirtualDeviceSpec()
131     disk_spec.fileOperation = "create"
132     disk_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.add
133     disk_spec.device = vim.vm.device.VirtualDisk()
134     disk_spec.device.key = random_key
135     disk_spec.device.deviceInfo = vim.Description()
136     disk_spec.device.deviceInfo.label = disk_label
137     disk_spec.device.deviceInfo.summary = "{} GB".format(size_gb)
138     disk_spec.device.backing = vim.vm.device.VirtualDisk.FlatVer2BackingInfo()
139     disk_spec.device.backing.thinProvisioned = thin_provision
140     disk_spec.device.backing.eagerlyScrub = eagerly_scrub
141     disk_spec.device.backing.diskMode = "persistent"
142     if datastore:
143         datastore_ref = salt.utils.vmware.get_mor_using_container_view(
144             _get_si(), vim.Datastore, datastore
145         )
146         if not datastore_ref:
147             datastore_cluster_ref = salt.utils.vmware.get_mor_using_container_view(
148                 _get_si(), vim.StoragePod, datastore
149             )
150             if not datastore_cluster_ref:
151                 raise SaltCloudSystemExit(
152                     "Specified datastore/datastore cluster ({}) for disk ({}) does not"
153                     " exist".format(datastore, disk_label)
154                 )
155             datastore_list = salt.utils.vmware.get_datastores(
156                 _get_si(), datastore_cluster_ref, get_all_datastores=True
157             )
158             datastore_free_space = 0
159             for ds_ref in datastore_list:
160                 log.trace(
161                     "Found datastore (%s) with free space (%s) in datastore "
162                     "cluster (%s)",
163                     ds_ref.name,
164                     ds_ref.summary.freeSpace,
165                     datastore,
166                 )
167                 if (
168                     ds_ref.summary.accessible
169                     and ds_ref.summary.freeSpace &gt; datastore_free_space
170                 ):
171                     datastore_free_space = ds_ref.summary.freeSpace
172                     datastore_ref = ds_ref
173             if not datastore_ref:
174                 raise SaltCloudSystemExit(
175                     "Specified datastore cluster ({}) for disk ({}) does not have any"
176                     " accessible datastores available".format(datastore, disk_label)
177                 )
178         datastore_path = "[" + str(datastore_ref.name) + "] " + vm_name
179         disk_spec.device.backing.fileName = datastore_path + "/" + disk_label + ".vmdk"
180         disk_spec.device.backing.datastore = datastore_ref
181         log.trace(
182             "Using datastore (%s) for disk (%s), vm_name (%s)",
183             datastore_ref.name,
184             disk_label,
185             vm_name,
186         )
187     disk_spec.device.controllerKey = controller_key
188     disk_spec.device.unitNumber = unit_number
189     disk_spec.device.capacityInKB = size_kb
190     return disk_spec
191 def _edit_existing_network_adapter(
192     network_adapter, new_network_name, adapter_type, switch_type, container_ref=None
193 ):
194     adapter_type.strip().lower()
195     switch_type.strip().lower()
196     if adapter_type in ["vmxnet", "vmxnet2", "vmxnet3", "e1000", "e1000e"]:
197         edited_network_adapter = salt.utils.vmware.get_network_adapter_type(
198             adapter_type
199         )
200         if isinstance(network_adapter, type(edited_network_adapter)):
201             edited_network_adapter = network_adapter
202         else:
203             log.debug(
204                 "Changing type of '%s' from '%s' to '%s'",
205                 network_adapter.deviceInfo.label,
206                 type(network_adapter).__name__.rsplit(".", 1)[1][7:].lower(),
207                 adapter_type,
208             )
209     else:
210         if adapter_type:
211             log.error(
212                 "Cannot change type of '%s' to '%s'. Not changing type",
213                 network_adapter.deviceInfo.label,
214                 adapter_type,
215             )
216         edited_network_adapter = network_adapter
217     if switch_type == "standard":
218         network_ref = salt.utils.vmware.get_mor_by_property(
219             _get_si(), vim.Network, new_network_name, container_ref=container_ref
220         )
221         edited_network_adapter.backing = (
222             vim.vm.device.VirtualEthernetCard.NetworkBackingInfo()
223         )
224         edited_network_adapter.backing.deviceName = new_network_name
225         edited_network_adapter.backing.network = network_ref
226     elif switch_type == "distributed":
227         network_ref = salt.utils.vmware.get_mor_by_property(
228             _get_si(),
229             vim.dvs.DistributedVirtualPortgroup,
230             new_network_name,
231             container_ref=container_ref,
232         )
233         dvs_port_connection = vim.dvs.PortConnection(
234             portgroupKey=network_ref.key,
235             switchUuid=network_ref.config.distributedVirtualSwitch.uuid,
236         )
237         edited_network_adapter.backing = (
238             vim.vm.device.VirtualEthernetCard.DistributedVirtualPortBackingInfo()
239         )
240         edited_network_adapter.backing.port = dvs_port_connection
241     else:
242         if not switch_type:
243             err_msg = (
244                 "The switch type to be used by '{}' has not been specified".format(
245                     network_adapter.deviceInfo.label
246                 )
247             )
248         else:
249             err_msg = "Cannot create '{}'. Invalid/unsupported switch type '{}'".format(
250                 network_adapter.deviceInfo.label, switch_type
251             )
252         raise SaltCloudSystemExit(err_msg)
253     edited_network_adapter.key = network_adapter.key
254     edited_network_adapter.deviceInfo = network_adapter.deviceInfo
255     edited_network_adapter.deviceInfo.summary = new_network_name
256     edited_network_adapter.connectable = network_adapter.connectable
257     edited_network_adapter.slotInfo = network_adapter.slotInfo
258     edited_network_adapter.controllerKey = network_adapter.controllerKey
259     edited_network_adapter.unitNumber = network_adapter.unitNumber
260     edited_network_adapter.addressType = network_adapter.addressType
261     edited_network_adapter.macAddress = network_adapter.macAddress
262     edited_network_adapter.wakeOnLanEnabled = network_adapter.wakeOnLanEnabled
263     network_spec = vim.vm.device.VirtualDeviceSpec()
264     network_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.edit
265     network_spec.device = edited_network_adapter
266     return network_spec
267 def _add_new_network_adapter_helper(
268     network_adapter_label,
269     network_name,
270     adapter_type,
271     switch_type,
272     mac,
273     container_ref=None,
274 ):
275     random_key = randint(-4099, -4000)
276     adapter_type.strip().lower()
277     switch_type.strip().lower()
278     network_spec = vim.vm.device.VirtualDeviceSpec()
279     if adapter_type in ["vmxnet", "vmxnet2", "vmxnet3", "e1000", "e1000e"]:
280         network_spec.device = salt.utils.vmware.get_network_adapter_type(adapter_type)
281     else:
282         if not adapter_type:
283             log.debug(
284                 "The type of '%s' has not been specified. "
285                 "Creating default type 'vmxnet3'",
286                 network_adapter_label,
287             )
288         else:
289             log.error(
290                 "Cannot create network adapter of type '%s'. "
291                 "Creating '%s' of default type 'vmxnet3'",
292                 adapter_type,
293                 network_adapter_label,
294             )
295         network_spec.device = vim.vm.device.VirtualVmxnet3()
296     network_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.add
297     if switch_type == "standard":
298         network_spec.device.backing = (
299             vim.vm.device.VirtualEthernetCard.NetworkBackingInfo()
300         )
301         network_spec.device.backing.deviceName = network_name
302         network_spec.device.backing.network = salt.utils.vmware.get_mor_by_property(
303             _get_si(), vim.Network, network_name, container_ref=container_ref
304         )
305     elif switch_type == "distributed":
306         network_ref = salt.utils.vmware.get_mor_by_property(
307             _get_si(),
308             vim.dvs.DistributedVirtualPortgroup,
309             network_name,
310             container_ref=container_ref,
311         )
312         dvs_port_connection = vim.dvs.PortConnection(
313             portgroupKey=network_ref.key,
314             switchUuid=network_ref.config.distributedVirtualSwitch.uuid,
315         )
316         network_spec.device.backing = (
317             vim.vm.device.VirtualEthernetCard.DistributedVirtualPortBackingInfo()
318         )
319         network_spec.device.backing.port = dvs_port_connection
320     else:
321         if not switch_type:
322             err_msg = (
323                 "The switch type to be used by '{}' has not been specified".format(
324                     network_adapter_label
325                 )
326             )
327         else:
328             err_msg = "Cannot create '{}'. Invalid/unsupported switch type '{}'".format(
329                 network_adapter_label, switch_type
330             )
331         raise SaltCloudSystemExit(err_msg)
332     if mac != "":
333         network_spec.device.addressType = "assigned"
334         network_spec.device.macAddress = mac
335     network_spec.device.key = random_key
336     network_spec.device.deviceInfo = vim.Description()
337     network_spec.device.deviceInfo.label = network_adapter_label
338     network_spec.device.deviceInfo.summary = network_name
339     network_spec.device.wakeOnLanEnabled = True
340     network_spec.device.connectable = vim.vm.device.VirtualDevice.ConnectInfo()
341     network_spec.device.connectable.startConnected = True
342     network_spec.device.connectable.allowGuestControl = True
343     return network_spec
344 def _edit_existing_scsi_controller(scsi_controller, bus_sharing):
345     scsi_controller.sharedBus = bus_sharing
346     scsi_spec = vim.vm.device.VirtualDeviceSpec()
347     scsi_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.edit
348     scsi_spec.device = scsi_controller
349     return scsi_spec
350 def _add_new_scsi_controller_helper(scsi_controller_label, properties, bus_number):
351     random_key = randint(-1050, -1000)
352     adapter_type = properties["type"].strip().lower() if "type" in properties else None
353     bus_sharing = (
354         properties["bus_sharing"].strip().lower()
355         if "bus_sharing" in properties
356         else None
357     )
358     scsi_spec = vim.vm.device.VirtualDeviceSpec()
359     if adapter_type == "lsilogic":
360         summary = "LSI Logic"
361         scsi_spec.device = vim.vm.device.VirtualLsiLogicController()
362     elif adapter_type == "lsilogic_sas":
363         summary = "LSI Logic Sas"
364         scsi_spec.device = vim.vm.device.VirtualLsiLogicSASController()
365     elif adapter_type == "paravirtual":
366         summary = "VMware paravirtual SCSI"
367         scsi_spec.device = vim.vm.device.ParaVirtualSCSIController()
368     else:
369         if not adapter_type:
370             err_msg = "The type of '{}' has not been specified".format(
371                 scsi_controller_label
372             )
373         else:
374             err_msg = "Cannot create '{}'. Invalid/unsupported type '{}'".format(
375                 scsi_controller_label, adapter_type
376         raise SaltCloudSystemExit(err_msg)
377     scsi_spec.operation = vim.vm.device.VirtualDeviceSpec<font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.Operation.add
378     scsi_spec.device.key = random_key
379     scsi_spec.device.busNumber = bus_number
380     scsi_spec.device.deviceInfo = vim.Description()
381     scsi_spec.device.deviceInfo.</b></font>label = scsi_controller_label
382     scsi_spec.device.deviceInfo.summary = summary
383     if bus_sharing == "virtual":
384         scsi_spec.device.sharedBus = (
385             vim.vm.device.VirtualSCSIController.Sharing.virtualSharing
386         )
387     elif bus_sharing == "physical":
388         scsi_spec.device.sharedBus = (
389             vim.vm.device.VirtualSCSIController.Sharing.physicalSharing
390         )
391     else:
392         scsi_spec.device.sharedBus = (
393             vim.vm.device.VirtualSCSIController.Sharing.noSharing
394         )
395     return scsi_spec
396 def _add_new_ide_controller_helper(ide_controller_label, controller_key, bus_number):
397     if controller_key is None:
398         controller_key = randint(-200, 250)
399     ide_spec = vim.vm.device.VirtualDeviceSpec()
400     ide_spec.device = vim.vm.device.VirtualIDEController()
401     ide_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.add
402     ide_spec.device.key = controller_key
403     ide_spec.device.busNumber = bus_number
404     ide_spec.device.deviceInfo = vim.Description()
405     ide_spec.device.deviceInfo.label = ide_controller_label
406     ide_spec.device.deviceInfo.summary = ide_controller_label
407     return ide_spec
408 def _set_cd_or_dvd_backing_type(drive, device_type, mode, iso_path):
409     if device_type == "datastore_iso_file":
410         drive.backing = vim.vm.device.VirtualCdrom.IsoBackingInfo()
411         drive.backing.fileName = iso_path
412         datastore = iso_path.partition("[")[-1].rpartition("]")[0]
413         datastore_ref = salt.utils.vmware.get_mor_by_property(
414             _get_si(), vim.Datastore, datastore
415         )
416         if datastore_ref:
417             drive.backing.datastore = datastore_ref
418         drive.deviceInfo.summary = "ISO {}".format(iso_path)
419     elif device_type == "client_device":
420         if mode == "passthrough":
421             drive.backing = vim.vm.device.VirtualCdrom.RemotePassthroughBackingInfo()
422             drive.deviceInfo.summary = "Remote Device"
423         elif mode == "atapi":
424             drive.backing = vim.vm.device.VirtualCdrom.RemoteAtapiBackingInfo()
425             drive.deviceInfo.summary = "Remote ATAPI"
426     return drive
427 def _edit_existing_cd_or_dvd_drive(drive, device_type, mode, iso_path):
428     device_type.strip().lower()
429     mode.strip().lower()
430     drive_spec = vim.vm.device.VirtualDeviceSpec()
431     drive_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.edit
432     drive_spec.device = _set_cd_or_dvd_backing_type(drive, device_type, mode, iso_path)
433     return drive_spec
434 def _add_new_cd_or_dvd_drive_helper(
435     drive_label, controller_key, device_type, mode, iso_path
436 ):
437     random_key = randint(-3025, -3000)
438     device_type.strip().lower()
439     mode.strip().lower()
440     drive_spec = vim.vm.device.VirtualDeviceSpec()
441     drive_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.add
442     drive_spec.device = vim.vm.device.VirtualCdrom()
443     drive_spec.device.deviceInfo = vim.Description()
444     if device_type in ["datastore_iso_file", "client_device"]:
445         drive_spec.device = _set_cd_or_dvd_backing_type(
446             drive_spec.device, device_type, mode, iso_path
447         )
448     else:
449         if not device_type:
450             log.debug(
451                 "The 'device_type' of '%s' has not been specified. "
452                 "Creating default type 'client_device'",
453                 drive_label,
454             )
455         else:
456             log.error(
457                 "Cannot create CD/DVD drive of type '%s'. "
458                 "Creating '%s' of default type 'client_device'",
459                 device_type,
460                 drive_label,
461             )
462         drive_spec.device.backing = (
463             vim.vm.device.VirtualCdrom.RemotePassthroughBackingInfo()
464         )
465         drive_spec.device.deviceInfo.summary = "Remote Device"
466     drive_spec.device.key = random_key
467     drive_spec.device.deviceInfo.label = drive_label
468     drive_spec.device.controllerKey = controller_key
469     drive_spec.device.connectable = vim.vm.device.VirtualDevice.ConnectInfo()
470     drive_spec.device.connectable.startConnected = True
471     drive_spec.device.connectable.allowGuestControl = True
472     return drive_spec
473 def _set_network_adapter_mapping(adapter_specs):
474     adapter_mapping = vim.vm.customization.AdapterMapping()
475     adapter_mapping.adapter = vim.vm.customization.IPSettings()
476     if "domain" in list(adapter_specs.keys()):
477         domain = adapter_specs["domain"]
478         adapter_mapping.adapter.dnsDomain = domain
479     if "gateway" in list(adapter_specs.keys()):
480         gateway = adapter_specs["gateway"]
481         adapter_mapping.adapter.gateway = gateway
482     if "ip" in list(adapter_specs.keys()):
483         ip = str(adapter_specs["ip"])
484         subnet_mask = str(adapter_specs["subnet_mask"])
485         adapter_mapping.adapter.ip = vim.vm.customization.FixedIp(ipAddress=ip)
486         adapter_mapping.adapter.subnetMask = subnet_mask
487     else:
488         adapter_mapping.adapter.ip = vim.vm.customization.DhcpIpGenerator()
489     return adapter_mapping
490 def _get_mode_spec(device, mode, disk_spec):
491     if device.backing.diskMode != mode:
492         if not disk_spec:
493             disk_spec = _edit_existing_hard_disk_helper(disk=device, mode=mode)
494         else:
495             disk_spec.device.backing.diskMode = mode
496     return disk_spec
497 def _get_size_spec(device, size_gb=None, size_kb=None):
498     if size_kb is None and size_gb is not None:
499         size_kb = int(size_gb * 1024.0 * 1024.0)
500     disk_spec = (
501         _edit_existing_hard_disk_helper(disk=device, size_kb=size_kb)
502         if device.capacityInKB &lt; size_kb
503         else None
504     )
505     return disk_spec
506 def _iter_disk_unit_number(unit_number):
507     unit_number += 1
508     if unit_number == 7:
509         unit_number += 1
510     return unit_number
511 def _manage_devices(devices, vm=None, container_ref=None, new_vm_name=None):
512     unit_number = 0
513     bus_number = 0
514     device_specs = []
515     existing_disks_label = []
516     existing_scsi_controllers_label = []
517     existing_ide_controllers_label = []
518     existing_network_adapters_label = []
519     existing_cd_drives_label = []
520     ide_controllers = {}
521     nics_map = []
522     cloning_from_vm = vm is not None
523     if cloning_from_vm:
524         for device in vm.config.hardware.device:
525             if isinstance(device, vim.vm.device.VirtualDisk):
526                 if "disk" in list(devices.keys()):
527                     unit_number = _iter_disk_unit_number(unit_number)
528                     existing_disks_label.append(device.deviceInfo.label)
529                     if device.deviceInfo.label in list(devices["disk"].keys()):
530                         disk_spec = None
531                         if "size" in devices["disk"][device.deviceInfo.label]:
532                             size_gb = float(
533                                 devices["disk"][device.deviceInfo.label]["size"]
534                             )
535                             size_kb = int(size_gb * 1024.0 * 1024.0)
536                         else:
537                             size_kb = device.capacityInKB
538                             size_gb = size_kb / (1024.0 * 1024.0)
539                             log.debug(
540                                 "Virtual disk size for '%s' was not "
541                                 "specified in the cloud profile or map file. "
542                                 "Using existing virtual disk size of '%sGB'",
543                                 device.deviceInfo.label,
544                                 size_gb,
545                             )
546                         if device.capacityInKB &gt; size_kb:
547                             raise SaltCloudSystemExit(
548                                 "The specified disk size '{}GB' for '{}' is "
549                                 "smaller than the disk image size '{}GB'. It must "
550                                 "be equal to or greater than the disk image".format(
551                                     float(
552                                         devices["disk"][device.deviceInfo.label]["size"]
553                                     ),
554                                     device.deviceInfo.label,
555                                     float(device.capacityInKB / (1024.0 * 1024.0)),
556                                 )
557                             )
558                         else:
559                             disk_spec = _get_size_spec(device=device, size_kb=size_kb)
560                         if "mode" in devices["disk"][device.deviceInfo.label]:
561                             if devices["disk"][device.deviceInfo.label]["mode"] in [
562                                 "independent_persistent",
563                                 "independent_nonpersistent",
564                                 "dependent",
565                             ]:
566                                 mode = devices["disk"][device.deviceInfo.label]["mode"]
567                                 disk_spec = _get_mode_spec(device, mode, disk_spec)
568                             else:
569                                 raise SaltCloudSystemExit(
570                                     "Invalid disk backing mode specified!"
571                                 )
572                         if disk_spec is not None:
573                             device_specs.append(disk_spec)
574             elif isinstance(
575                 device.backing,
576                 (
577                     vim.vm.device.VirtualEthernetCard.NetworkBackingInfo,
578                     vim.vm.device.VirtualEthernetCard.DistributedVirtualPortBackingInfo,
579                 ),
580             ):
581                 if "network" in list(devices.keys()):
582                     existing_network_adapters_label.append(device.deviceInfo.label)
583                     if device.deviceInfo.label in list(devices["network"].keys()):
584                         network_name = devices["network"][device.deviceInfo.label][
585                             "name"
586                         ]
587                         adapter_type = (
588                             devices["network"][device.deviceInfo.label]["adapter_type"]
589                             if "adapter_type"
590                             in devices["network"][device.deviceInfo.label]
591                             else ""
592                         )
593                         switch_type = (
594                             devices["network"][device.deviceInfo.label]["switch_type"]
595                             if "switch_type"
596                             in devices["network"][device.deviceInfo.label]
597                             else ""
598                         )
599                         network_spec = _edit_existing_network_adapter(
600                             device,
601                             network_name,
602                             adapter_type,
603                             switch_type,
604                             container_ref,
605                         )
606                         adapter_mapping = _set_network_adapter_mapping(
607                             devices["network"][device.deviceInfo.label]
608                         )
609                         device_specs.append(network_spec)
610                         nics_map.append(adapter_mapping)
611             elif hasattr(device, "scsiCtlrUnitNumber"):
612                 if "scsi" in list(devices.keys()):
613                     bus_number += 1
614                     existing_scsi_controllers_label.append(device.deviceInfo.label)
615                     if device.deviceInfo.label in list(devices["scsi"].keys()):
616                         scsi_controller_properties = devices["scsi"][
617                             device.deviceInfo.label
618                         ]
619                         bus_sharing = (
620                             scsi_controller_properties["bus_sharing"].strip().lower()
621                             if "bus_sharing" in scsi_controller_properties
622                             else None
623                         )
624                         if bus_sharing and bus_sharing in ["virtual", "physical", "no"]:
625                             bus_sharing = "{}Sharing".format(bus_sharing)
626                             if bus_sharing != device.sharedBus:
627                                 scsi_spec = _edit_existing_scsi_controller(
628                                     device, bus_sharing
629                                 )
630                                 device_specs.append(scsi_spec)
631             elif isinstance(device, vim.vm.device.VirtualCdrom):
632                 if "cd" in list(devices.keys()):
633                     existing_cd_drives_label.append(device.deviceInfo.label)
634                     if device.deviceInfo.label in list(devices["cd"].keys()):
635                         device_type = (
636                             devices["cd"][device.deviceInfo.label]["device_type"]
637                             if "device_type" in devices["cd"][device.deviceInfo.label]
638                             else ""
639                         )
640                         mode = (
641                             devices["cd"][device.deviceInfo.label]["mode"]
642                             if "mode" in devices["cd"][device.deviceInfo.label]
643                             else ""
644                         )
645                         iso_path = (
646                             devices["cd"][device.deviceInfo.label]["iso_path"]
647                             if "iso_path" in devices["cd"][device.deviceInfo.label]
648                             else ""
649                         )
650                         cd_drive_spec = _edit_existing_cd_or_dvd_drive(
651                             device, device_type, mode, iso_path
652                         )
653                         device_specs.append(cd_drive_spec)
654             elif isinstance(device, vim.vm.device.VirtualIDEController):
655                 ide_controllers[device.key] = len(device.device)
656     if "network" in list(devices.keys()):
657         network_adapters_to_create = list(
658             set(devices["network"].keys()) - set(existing_network_adapters_label)
659         )
660         network_adapters_to_create.sort()
661         if network_adapters_to_create:
662             log.debug("Networks adapters to create: %s", network_adapters_to_create)
663         for network_adapter_label in network_adapters_to_create:
664             network_name = devices["network"][network_adapter_label]["name"]
665             adapter_type = (
666                 devices["network"][network_adapter_label]["adapter_type"]
667                 if "adapter_type" in devices["network"][network_adapter_label]
668                 else ""
669             )
670             switch_type = (
671                 devices["network"][network_adapter_label]["switch_type"]
672                 if "switch_type" in devices["network"][network_adapter_label]
673                 else ""
674             )
675             mac = (
676                 devices["network"][network_adapter_label]["mac"]
677                 if "mac" in devices["network"][network_adapter_label]
678                 else ""
679             )
680             network_spec = _add_new_network_adapter_helper(
681                 network_adapter_label,
682                 network_name,
683                 adapter_type,
684                 switch_type,
685                 mac,
686                 container_ref,
687             )
688             adapter_mapping = _set_network_adapter_mapping(
689                 devices["network"][network_adapter_label]
690             )
691             device_specs.append(network_spec)
692             nics_map.append(adapter_mapping)
693     if "scsi" in list(devices.keys()):
694         scsi_controllers_to_create = list(
695             set(devices["scsi"].keys()) - set(existing_scsi_controllers_label)
696         )
697         scsi_controllers_to_create.sort()
698         if scsi_controllers_to_create:
699             log.debug("SCSI controllers to create: %s", scsi_controllers_to_create)
700         for scsi_controller_label in scsi_controllers_to_create:
701             scsi_controller_properties = devices["scsi"][scsi_controller_label]
702             scsi_spec = _add_new_scsi_controller_helper(
703                 scsi_controller_label, scsi_controller_properties, bus_number
704             )
705             device_specs.append(scsi_spec)
706             bus_number += 1
707     if "ide" in list(devices.keys()):
708         ide_controllers_to_create = list(
709             set(devices["ide"].keys()) - set(existing_ide_controllers_label)
710         )
711         ide_controllers_to_create.sort()
712         if ide_controllers_to_create:
713             log.debug("IDE controllers to create: %s", ide_controllers_to_create)
714         vcenter_name = get_vcenter_version(call="function")
715         controller_index = (
716             SAFE_ESX_5_5_CONTROLLER_KEY_INDEX
717             if ESX_5_5_NAME_PORTION in vcenter_name
718             else None
719         )
720         for ide_controller_label in ide_controllers_to_create:
721             ide_spec = _add_new_ide_controller_helper(
722                 ide_controller_label, controller_index, bus_number
723             )
724             device_specs.append(ide_spec)
725             bus_number += 1
726             if controller_index is not None:
727                 controller_index += 1
728     if "disk" in list(devices.keys()):
729         disks_to_create = list(set(devices["disk"].keys()) - set(existing_disks_label))
730         disks_to_create.sort()
731         if disks_to_create:
732             log.debug("Hard disks to create: %s", disks_to_create)
733         for disk_label in disks_to_create:
734             size_gb = float(devices["disk"][disk_label]["size"])
735             thin_provision = (
736                 bool(devices["disk"][disk_label]["thin_provision"])
737                 if "thin_provision" in devices["disk"][disk_label]
738                 else False
739             )
740             eagerly_scrub = (
741                 bool(devices["disk"][disk_label]["eagerly_scrub"])
742                 if "eagerly_scrub" in devices["disk"][disk_label]
743                 else False
744             )
745             datastore = devices["disk"][disk_label].get("datastore", None)
746             disk_spec = _add_new_hard_disk_helper(
747                 disk_label,
748                 size_gb,
749                 unit_number,
750                 thin_provision=thin_provision,
751                 eagerly_scrub=eagerly_scrub,
752                 datastore=datastore,
753                 vm_name=new_vm_name,
754             )
755             if "controller" in devices["disk"][disk_label]:
756                 for spec in device_specs:
757                     if (
758                         spec.device.deviceInfo.label
759                         == devices["disk"][disk_label]["controller"]
760                     ):
761                         disk_spec.device.controllerKey = spec.device.key
762                         break
763             device_specs.append(disk_spec)
764             unit_number = _iter_disk_unit_number(unit_number)
765     if "cd" in list(devices.keys()):
766         cd_drives_to_create = list(
767             set(devices["cd"].keys()) - set(existing_cd_drives_label)
768         )
769         cd_drives_to_create.sort()
770         if cd_drives_to_create:
771             log.debug("CD/DVD drives to create: %s", cd_drives_to_create)
772         for cd_drive_label in cd_drives_to_create:
773             device_type = (
774                 devices["cd"][cd_drive_label]["device_type"]
775                 if "device_type" in devices["cd"][cd_drive_label]
776                 else ""
777             )
778             mode = (
779                 devices["cd"][cd_drive_label]["mode"]
780                 if "mode" in devices["cd"][cd_drive_label]
781                 else ""
782             )
783             iso_path = (
784                 devices["cd"][cd_drive_label]["iso_path"]
785                 if "iso_path" in devices["cd"][cd_drive_label]
786                 else ""
787             )
788             controller_key = None
789             if "controller" in devices["cd"][cd_drive_label]:
790                 for spec in device_specs:
791                     if (
792                         spec.device.deviceInfo.label
793                         == devices["cd"][cd_drive_label]["controller"]
794                     ):
795                         controller_key = spec.device.key
796                         ide_controllers[controller_key] = 0
797                         break
798             else:
799                 for ide_controller_key, num_devices in ide_controllers.items():
800                     if num_devices &lt; 2:
801                         controller_key = ide_controller_key
802                         break
803             if not controller_key:
804                 log.error(
805                     "No more available controllers for '%s'. "
806                     "All IDE controllers are currently in use",
807                     cd_drive_label,
808                 )
809             else:
810                 cd_drive_spec = _add_new_cd_or_dvd_drive_helper(
811                     cd_drive_label, controller_key, device_type, mode, iso_path
812                 )
813                 device_specs.append(cd_drive_spec)
814                 ide_controllers[controller_key] += 1
815     ret = {"device_specs": device_specs, "nics_map": nics_map}
816     return ret
817 def _wait_for_vmware_tools(vm_ref, max_wait):
818     time_counter = 0
819     starttime = time.time()
820     while time_counter &lt; max_wait:
821         if time_counter % 5 == 0:
822             log.info(
823                 "[ %s ] Waiting for VMware tools to be running [%s s]",
824                 vm_ref.name,
825                 time_counter,
826             )
827         if str(vm_ref.summary.guest.toolsRunningStatus) == "guestToolsRunning":
828             log.info(
829                 "[ %s ] Successfully got VMware tools running on the guest in "
830                 "%s seconds",
831                 vm_ref.name,
832                 time_counter,
833             )
834             return True
835         time.sleep(1.0 - ((time.time() - starttime) % 1.0))
836         time_counter += 1
837     log.warning(
838         "[ %s ] Timeout Reached. VMware tools still not running after waiting "
839         "for %s seconds",
840         vm_ref.name,
841         max_wait,
842     )
843     return False
844 def _valid_ip(ip_address):
845     octets = ip_address.split(".")
846     if len(octets) != 4:
847         return False
848     for i, octet in enumerate(octets):
849         try:
850             octets[i] = int(octet)
851         except ValueError:
852             return False
853     first_octet, second_octet, third_octet, fourth_octet = octets
854     if first_octet &lt; 1 or first_octet &gt; 223 or first_octet == 127:
855         return False
856     if first_octet == 169 and second_octet == 254:
857         return False
858     for octet in (second_octet, third_octet, fourth_octet):
859         if (octet &lt; 0) or (octet &gt; 255):
860             return False
861     return True
862 def _wait_for_ip(vm_ref, max_wait):
863     max_wait_vmware_tools = max_wait
864     max_wait_ip = max_wait
865     vmware_tools_status = _wait_for_vmware_tools(vm_ref, max_wait_vmware_tools)
866     if not vmware_tools_status:
867         vm_name = vm_ref.summary.config.name
868         resolved_ips = salt.utils.network.host_to_ips(vm_name)
869         log.debug(
870             "Timeout waiting for VMware tools. The name %s resolved to %s",
871             vm_name,
872             resolved_ips,
873         )
874         if isinstance(resolved_ips, list) and resolved_ips:
875             return resolved_ips[0]
876         return False
877     time_counter = 0
878     starttime = time.time()
879     while time_counter &lt; max_wait_ip:
880         if time_counter % 5 == 0:
881             log.info(
882                 "[ %s ] Waiting to retrieve IPv4 information [%s s]",
883                 vm_ref.name,
884                 time_counter,
885             )
886         if vm_ref.summary.guest.ipAddress and _valid_ip(vm_ref.summary.guest.ipAddress):
887             log.info(
888                 "[ %s ] Successfully retrieved IPv4 information in %s seconds",
889                 vm_ref.name,
890                 time_counter,
891             )
892             return vm_ref.summary.guest.ipAddress
893         for net in vm_ref.guest.net:
894             if net.ipConfig.ipAddress:
895                 for current_ip in net.ipConfig.ipAddress:
896                     if _valid_ip(current_ip.ipAddress):
897                         log.info(
898                             "[ %s ] Successfully retrieved IPv4 information "
899                             "in %s seconds",
900                             vm_ref.name,
901                             time_counter,
902                         )
903                         return current_ip.ipAddress
904         time.sleep(1.0 - ((time.time() - starttime) % 1.0))
905         time_counter += 1
906     log.warning(
907         "[ %s ] Timeout Reached. Unable to retrieve IPv4 information after "
908         "waiting for %s seconds",
909         vm_ref.name,
910         max_wait_ip,
911     )
912     return False
913 def _wait_for_host(host_ref, task_type, sleep_seconds=5, log_level="debug"):
914     time_counter = 0
915     starttime = time.time()
916     while host_ref.runtime.connectionState != "notResponding":
917         if time_counter % sleep_seconds == 0:
918             log.log(
919                 logging.INFO if log_level == "info" else logging.DEBUG,
920                 "[ %s ] Waiting for host %s to finish [%s s]",
921                 host_ref.name,
922                 task_type,
923                 time_counter,
924             )
925         time.sleep(1.0 - ((time.time() - starttime) % 1.0))
926         time_counter += 1
927     while host_ref.runtime.connectionState != "connected":
928         if time_counter % sleep_seconds == 0:
929             log.log(
930                 logging.INFO if log_level == "info" else logging.DEBUG,
931                 "[ %s ] Waiting for host %s to finish [%s s]",
932                 host_ref.name,
933                 task_type,
934                 time_counter,
935             )
936         time.sleep(1.0 - ((time.time() - starttime) % 1.0))
937         time_counter += 1
938     if host_ref.runtime.connectionState == "connected":
939         log.log(
940             logging.INFO if log_level == "info" else logging.DEBUG,
941             "[ %s ] Successfully completed host %s in %s seconds",
942             host_ref.name,
943             task_type,
944             time_counter,
945         )
946     else:
947         log.error("Could not connect back to the host system")
948 def _format_instance_info_select(vm, selection):
949     def defaultto(machine, section, default="N/A"):
950         return default if section not in machine else machine[section]
951     vm_select_info = {}
952     if "id" in selection:
953         vm_select_info["id"] = vm["name"]
954     if "image" in selection:
955         vm_select_info["image"] = "{} (Detected)".format(
956             defaultto(vm, "config.guestFullName")
957         )
958     if "size" in selection:
959         cpu = defaultto(vm, "config.hardware.numCPU")
960         ram = "{} MB".format(defaultto(vm, "config.hardware.memoryMB"))
961         vm_select_info["size"] = "cpu: {}\nram: {}".format(cpu, ram)
962         vm_select_info["size_dict"] = {
963             "cpu": cpu,
964             "memory": ram,
965         }
966     if "state" in selection:
967         vm_select_info["state"] = str(defaultto(vm, "summary.runtime.powerState"))
968     if "guest_id" in selection:
969         vm_select_info["guest_id"] = defaultto(vm, "config.guestId")
970     if "hostname" in selection:
971         vm_select_info["hostname"] = vm["object"].guest.hostName
972     if "path" in selection:
973         vm_select_info["path"] = defaultto(vm, "config.files.vmPathName")
974     if "tools_status" in selection:
975         vm_select_info["tools_status"] = str(defaultto(vm, "guest.toolsStatus"))
976     if "private_ips" in selection or "networks" in selection:
977         network_full_info = {}
978         ip_addresses = []
979         if "guest.net" in vm:
980             for net in vm["guest.net"]:
981                 network_full_info[net.network] = {
982                     "connected": net.connected,
983                     "ip_addresses": net.ipAddress,
984                     "mac_address": net.macAddress,
985                 }
986                 ip_addresses.extend(net.ipAddress)
987         if "private_ips" in selection:
988             vm_select_info["private_ips"] = ip_addresses
989         if "networks" in selection:
990             vm_select_info["networks"] = network_full_info
991     if any(x in ["devices", "mac_address", "mac_addresses"] for x in selection):
992         device_full_info = {}
993         device_mac_addresses = []
994         if "config.hardware.device" in vm:
995             for device in vm["config.hardware.device"]:
996                 device_full_info[device.deviceInfo.label] = {}
997                 if "devices" in selection:
998                     device_full_info[device.deviceInfo.label]["key"] = (device.key,)
999                     device_full_info[device.deviceInfo.label]["label"] = (
1000                         device.deviceInfo.label,
1001                     )
1002                     device_full_info[device.deviceInfo.label]["summary"] = (
1003                         device.deviceInfo.summary,
1004                     )
1005                     device_full_info[device.deviceInfo.label]["type"] = type(
1006                         device
1007                     ).__name__.rsplit(".", 1)[1]
1008                     if device.unitNumber:
1009                         device_full_info[device.deviceInfo.label][
1010                             "unitNumber"
1011                         ] = device.unitNumber
1012                     if hasattr(device, "connectable") and device.connectable:
1013                         device_full_info[device.deviceInfo.label][
1014                             "startConnected"
1015                         ] = device.connectable.startConnected
1016                         device_full_info[device.deviceInfo.label][
1017                             "allowGuestControl"
1018                         ] = device.connectable.allowGuestControl
1019                         device_full_info[device.deviceInfo.label][
1020                             "connected"
1021                         ] = device.connectable.connected
1022                         device_full_info[device.deviceInfo.label][
1023                             "status"
1024                         ] = device.connectable.status
1025                     if hasattr(device, "controllerKey") and device.controllerKey:
1026                         device_full_info[device.deviceInfo.label][
1027                             "controllerKey"
1028                         ] = device.controllerKey
1029                     if hasattr(device, "addressType"):
1030                         device_full_info[device.deviceInfo.label][
1031                             "addressType"
1032                         ] = device.addressType
1033                     if hasattr(device, "busNumber"):
1034                         device_full_info[device.deviceInfo.label][
1035                             "busNumber"
1036                         ] = device.busNumber
1037                     if hasattr(device, "device"):
1038                         device_full_info[device.deviceInfo.label][
1039                             "deviceKeys"
1040                         ] = device.device
1041                     if hasattr(device, "videoRamSizeInKB"):
1042                         device_full_info[device.deviceInfo.label][
1043                             "videoRamSizeInKB"
1044                         ] = device.videoRamSizeInKB
1045                     if isinstance(device, vim.vm.device.VirtualDisk):
1046                         device_full_info[device.deviceInfo.label][
1047                             "capacityInKB"
1048                         ] = device.capacityInKB
1049                         device_full_info[device.deviceInfo.label][
1050                             "diskMode"
1051                         ] = device.backing.diskMode
1052                         device_full_info[device.deviceInfo.label][
1053                             "fileName"
1054                         ] = device.backing.fileName
1055                 if hasattr(device, "macAddress"):
1056                     device_full_info[device.deviceInfo.label][
1057                         "macAddress"
1058                     ] = device.macAddress
1059                     device_mac_addresses.append(device.macAddress)
1060         if "devices" in selection:
1061             vm_select_info["devices"] = device_full_info
1062         if "mac_address" in selection or "mac_addresses" in selection:
1063             vm_select_info["mac_addresses"] = device_mac_addresses
1064     if "storage" in selection:
1065         storage_full_info = {
1066             "committed": int(vm["summary.storage.committed"])
1067             if "summary.storage.committed" in vm
1068             else "N/A",
1069             "uncommitted": int(vm["summary.storage.uncommitted"])
1070             if "summary.storage.uncommitted" in vm
1071             else "N/A",
1072             "unshared": int(vm["summary.storage.unshared"])
1073             if "summary.storage.unshared" in vm
1074             else "N/A",
1075         }
1076         vm_select_info["storage"] = storage_full_info
1077     if "files" in selection:
1078         file_full_info = {}
1079         if "layoutEx.file" in vm:
1080             for filename in vm["layoutEx.file"]:
1081                 file_full_info[filename.key] = {
1082                     "key": filename.key,
1083                     "name": filename.name,
1084                     "size": filename.size,
1085                     "type": filename.type,
1086                 }
1087         vm_select_info["files"] = file_full_info
1088     return vm_select_info
1089 def _format_instance_info(vm):
1090     device_full_info = {}
1091     device_mac_addresses = []
1092     if "config.hardware.device" in vm:
1093         for device in vm["config.hardware.device"]:
1094             device_full_info[device.deviceInfo.label] = {
1095                 "key": device.key,
1096                 "label": device.deviceInfo.label,
1097                 "summary": device.deviceInfo.summary,
1098                 "type": type(device).__name__.rsplit(".", 1)[1],
1099             }
1100             if device.unitNumber:
1101                 device_full_info[device.deviceInfo.label][
1102                     "unitNumber"
1103                 ] = device.unitNumber
1104             if hasattr(device, "connectable") and device.connectable:
1105                 device_full_info[device.deviceInfo.label][
1106                     "startConnected"
1107                 ] = device.connectable.startConnected
1108                 device_full_info[device.deviceInfo.label][
1109                     "allowGuestControl"
1110                 ] = device.connectable.allowGuestControl
1111                 device_full_info[device.deviceInfo.label][
1112                     "connected"
1113                 ] = device.connectable.connected
1114                 device_full_info[device.deviceInfo.label][
1115                     "status"
1116                 ] = device.connectable.status
1117             if hasattr(device, "controllerKey") and device.controllerKey:
1118                 device_full_info[device.deviceInfo.label][
1119                     "controllerKey"
1120                 ] = device.controllerKey
1121             if hasattr(device, "addressType"):
1122                 device_full_info[device.deviceInfo.label][
1123                     "addressType"
1124                 ] = device.addressType
1125             if hasattr(device, "macAddress"):
1126                 device_full_info[device.deviceInfo.label][
1127                     "macAddress"
1128                 ] = device.macAddress
1129                 device_mac_addresses.append(device.macAddress)
1130             if hasattr(device, "busNumber"):
1131                 device_full_info[device.deviceInfo.label][
1132                     "busNumber"
1133                 ] = device.busNumber
1134             if hasattr(device, "device"):
1135                 device_full_info[device.deviceInfo.label]["deviceKeys"] = device.device
1136             if hasattr(device, "videoRamSizeInKB"):
1137                 device_full_info[device.deviceInfo.label][
1138                     "videoRamSizeInKB"
1139                 ] = device.videoRamSizeInKB
1140             if isinstance(device, vim.vm.device.VirtualDisk):
1141                 device_full_info[device.deviceInfo.label][
1142                     "capacityInKB"
1143                 ] = device.capacityInKB
1144                 device_full_info[device.deviceInfo.label][
1145                     "diskMode"
1146                 ] = device.backing.diskMode
1147                 device_full_info[device.deviceInfo.label][
1148                     "fileName"
1149                 ] = device.backing.fileName
1150     storage_full_info = {
1151         "committed": int(vm["summary.storage.committed"])
1152         if "summary.storage.committed" in vm
1153         else "N/A",
1154         "uncommitted": int(vm["summary.storage.uncommitted"])
1155         if "summary.storage.uncommitted" in vm
1156         else "N/A",
1157         "unshared": int(vm["summary.storage.unshared"])
1158         if "summary.storage.unshared" in vm
1159         else "N/A",
1160     }
1161     file_full_info = {}
1162     if "layoutEx.file" in vm:
1163         for filename in vm["layoutEx.file"]:
1164             file_full_info[filename.key] = {
1165                 "key": filename.key,
1166                 "name": filename.name,
1167                 "size": filename.size,
1168                 "type": filename.type,
1169             }
1170     network_full_info = {}
1171     ip_addresses = []
1172     if "guest.net" in vm:
1173         for net in vm["guest.net"]:
1174             network_full_info[net.network] = {
1175                 "connected": net.connected,
1176                 "ip_addresses": net.ipAddress,
1177                 "mac_address": net.macAddress,
1178             }
1179             ip_addresses.extend(net.ipAddress)
1180     cpu = vm["config.hardware.numCPU"] if "config.hardware.numCPU" in vm else "N/A"
1181     ram = (
1182         "{} MB".format(vm["config.hardware.memoryMB"])
1183         if "config.hardware.memoryMB" in vm
1184         else "N/A"
1185     )
1186     vm_full_info = {
1187         "id": str(vm["name"]),
1188         "image": "{} (Detected)".format(vm["config.guestFullName"])
1189         if "config.guestFullName" in vm
1190         else "N/A",
1191         "size": "cpu: {}\nram: {}".format(cpu, ram),
1192         "size_dict": {"cpu": cpu, "memory": ram},
1193         "state": str(vm["summary.runtime.powerState"])
1194         if "summary.runtime.powerState" in vm
1195         else "N/A",
1196         "private_ips": ip_addresses,
1197         "public_ips": [],
1198         "devices": device_full_info,
1199         "storage": storage_full_info,
1200         "files": file_full_info,
1201         "guest_id": str(vm["config.guestId"]) if "config.guestId" in vm else "N/A",
1202         "hostname": str(vm["object"].guest.hostName),
1203         "mac_addresses": device_mac_addresses,
1204         "networks": network_full_info,
1205         "path": str(vm["config.files.vmPathName"])
1206         if "config.files.vmPathName" in vm
1207         else "N/A",
1208         "tools_status": str(vm["guest.toolsStatus"])
1209         if "guest.toolsStatus" in vm
1210         else "N/A",
1211     }
1212     return vm_full_info
1213 def _get_snapshots(snapshot_list, current_snapshot=None, parent_snapshot_path=""):
1214     snapshots = {}
1215     for snapshot in snapshot_list:
1216         snapshot_path = "{}/{}".format(parent_snapshot_path, snapshot.name)
1217         snapshots[snapshot_path] = {
1218             "name": snapshot.name,
1219             "description": snapshot.description,
1220             "created": str(snapshot.createTime).split(".")[0],
1221             "state": snapshot.state,
1222             "path": snapshot_path,
1223         }
1224         if current_snapshot and current_snapshot == snapshot.snapshot:
1225             return snapshots[snapshot_path]
1226         if snapshot.childSnapshotList:
1227             ret = _get_snapshots(
1228                 snapshot.childSnapshotList, current_snapshot, snapshot_path
1229             )
1230             if current_snapshot:
1231                 return ret
1232             snapshots.update(ret)
1233     return snapshots
1234 def _get_snapshot_ref_helper(base_snapshot, snapshot_name):
1235     if base_snapshot.name == snapshot_name:
1236         return base_snapshot
1237     for snapshot in base_snapshot.childSnapshotList:
1238         snapshot_ref = _get_snapshot_ref_helper(snapshot, snapshot_name)
1239         if snapshot_ref is not None:
1240             return snapshot_ref
1241     return None
1242 def _get_snapshot_ref_by_name(vm_ref, snapshot_name):
1243     snapshot_ref = None
1244     try:
1245         for root_snapshot in vm_ref.snapshot.rootSnapshotList:
1246             snapshot_ref = _get_snapshot_ref_helper(root_snapshot, snapshot_name)
1247             if snapshot_ref is not None:
1248                 break
1249     except (IndexError, AttributeError):
1250         snapshot_ref = None
1251     return snapshot_ref
1252 def _upg_tools_helper(vm, reboot=False):
1253     if vm.config.template:
1254         status = "VMware tools cannot be updated on a template"
1255     elif vm.guest.toolsStatus == "toolsOk":
1256         status = "VMware tools is already up to date"
1257     elif vm.summary.runtime.powerState != "poweredOn":
1258         status = "VM must be powered on to upgrade tools"
1259     elif vm.guest.toolsStatus in ["toolsNotRunning", "toolsNotInstalled"]:
1260         status = "VMware tools is either not running or not installed"
1261     elif vm.guest.toolsStatus == "toolsOld":
1262         log.info("Upgrading VMware tools on %s", vm.name)
1263         try:
1264             if vm.guest.guestFamily == "windowsGuest" and not reboot:
1265                 log.info("Reboot suppressed on %s", vm.name)
1266                 task = vm.UpgradeTools('/S /v"/qn REBOOT=R"')
1267             elif vm.guest.guestFamily in ["linuxGuest", "windowsGuest"]:
1268                 task = vm.UpgradeTools()
1269             else:
1270                 return "Only Linux and Windows guests are currently supported"
1271             salt.utils.vmware.wait_for_task(
1272                 task, vm.name, "tools upgrade", sleep_seconds=5, log_level="info"
1273             )
1274         except Exception as exc:  # pylint: disable=broad-except
1275             log.error(
1276                 "Error while upgrading VMware tools on VM %s: %s",
1277                 vm.name,
1278                 exc,
1279                 exc_info_on_loglevel=logging.DEBUG,
1280             )
1281             return "VMware tools upgrade failed"
1282         status = "VMware tools upgrade succeeded"
1283     else:
1284         status = "VMWare tools could not be upgraded"
1285     return status
1286 def _get_hba_type(hba_type):
1287     if hba_type == "parallel":
1288         return vim.host.ParallelScsiHba
1289     elif hba_type == "block":
1290         return vim.host.BlockHba
1291     elif hba_type == "iscsi":
1292         return vim.host.InternetScsiHba
1293     elif hba_type == "fibre":
1294         return vim.host.FibreChannelHba
1295     raise ValueError("Unknown Host Bus Adapter Type")
1296 def test_vcenter_connection(kwargs=None, call=None):
1297     if call != "function":
1298         raise SaltCloudSystemExit(
1299             "The test_vcenter_connection function must be called with -f or --function."
1300         )
1301     try:
1302         _get_si()
1303     except Exception as exc:  # pylint: disable=broad-except
1304         return "failed to connect: {}".format(exc)
1305     return "connection successful"
1306 def get_vcenter_version(kwargs=None, call=None):
1307     if call != "function":
1308         raise SaltCloudSystemExit(
1309             "The get_vcenter_version function must be called with -f or --function."
1310         )
1311     inv = salt.utils.vmware.get_inventory(_get_si())
1312     return inv.about.fullName
1313 def list_datacenters(kwargs=None, call=None):
1314     if call != "function":
1315         raise SaltCloudSystemExit(
1316             "The list_datacenters function must be called with -f or --function."
1317         )
1318     return {"Datacenters": salt.utils.vmware.list_datacenters(_get_si())}
1319 def list_portgroups(kwargs=None, call=None):
1320     if call != "function":
1321         raise SaltCloudSystemExit(
1322             "The list_portgroups function must be called with -f or --function."
1323         )
1324     return {"Portgroups": salt.utils.vmware.list_portgroups(_get_si())}
1325 def list_clusters(kwargs=None, call=None):
1326     if call != "function":
1327         raise SaltCloudSystemExit(
1328             "The list_clusters function must be called with -f or --function."
1329         )
1330     return {"Clusters": salt.utils.vmware.list_clusters(_get_si())}
1331 def list_datastore_clusters(kwargs=None, call=None):
1332     if call != "function":
1333         raise SaltCloudSystemExit(
1334             "The list_datastore_clusters function must be called with -f or --function."
1335         )
1336     return {"Datastore Clusters": salt.utils.vmware.list_datastore_clusters(_get_si())}
1337 def list_datastores(kwargs=None, call=None):
1338     if call != "function":
1339         raise SaltCloudSystemExit(
1340             "The list_datastores function must be called with -f or --function."
1341         )
1342     return {"Datastores": salt.utils.vmware.list_datastores(_get_si())}
1343 def list_hosts(kwargs=None, call=None):
1344     if call != "function":
1345         raise SaltCloudSystemExit(
1346             "The list_hosts function must be called with -f or --function."
1347         )
1348     return {"Hosts": salt.utils.vmware.list_hosts(_get_si())}
1349 def list_resourcepools(kwargs=None, call=None):
1350     if call != "function":
1351         raise SaltCloudSystemExit(
1352             "The list_resourcepools function must be called with -f or --function."
1353         )
1354     return {"Resource Pools": salt.utils.vmware.list_resourcepools(_get_si())}
1355 def list_networks(kwargs=None, call=None):
1356     if call != "function":
1357         raise SaltCloudSystemExit(
1358             "The list_networks function must be called with -f or --function."
1359         )
1360     return {"Networks": salt.utils.vmware.list_networks(_get_si())}
1361 def list_nodes_min(kwargs=None, call=None):
1362     if call == "action":
1363         raise SaltCloudSystemExit(
1364             "The list_nodes_min function must be called with -f or --function."
1365         )
1366     ret = {}
1367     vm_properties = ["name"]
1368     vm_list = salt.utils.vmware.get_mors_with_properties(
1369         _get_si(), vim.VirtualMachine, vm_properties
1370     )
1371     for vm in vm_list:
1372         ret[vm["name"]] = {"state": "Running", "id": vm["name"]}
1373     return ret
1374 def list_nodes(kwargs=None, call=None):
1375     if call == "action":
1376         raise SaltCloudSystemExit(
1377             "The list_nodes function must be called with -f or --function."
1378         )
1379     ret = {}
1380     vm_properties = [
1381         "name",
1382         "guest.ipAddress",
1383         "config.guestFullName",
1384         "config.hardware.numCPU",
1385         "config.hardware.memoryMB",
1386         "summary.runtime.powerState",
1387     ]
1388     vm_list = salt.utils.vmware.get_mors_with_properties(
1389         _get_si(), vim.VirtualMachine, vm_properties
1390     )
1391     for vm in vm_list:
1392         cpu = vm["config.hardware.numCPU"] if "config.hardware.numCPU" in vm else "N/A"
1393         ram = (
1394             "{} MB".format(vm["config.hardware.memoryMB"])
1395             if "config.hardware.memoryMB" in vm
1396             else "N/A"
1397         )
1398         vm_info = {
1399             "id": vm["name"],
1400             "image": "{} (Detected)".format(vm["config.guestFullName"])
1401             if "config.guestFullName" in vm
1402             else "N/A",
1403             "size": "cpu: {}\nram: {}".format(cpu, ram),
1404             "size_dict": {"cpu": cpu, "memory": ram},
1405             "state": str(vm["summary.runtime.powerState"])
1406             if "summary.runtime.powerState" in vm
1407             else "N/A",
1408             "private_ips": [vm["guest.ipAddress"]] if "guest.ipAddress" in vm else [],
1409             "public_ips": [],
1410         }
1411         ret[vm_info["id"]] = vm_info
1412     return ret
1413 def list_nodes_full(kwargs=None, call=None):
1414     if call == "action":
1415         raise SaltCloudSystemExit(
1416             "The list_nodes_full function must be called with -f or --function."
1417         )
1418     ret = {}
1419     vm_properties = [
1420         "config.hardware.device",
1421         "summary.storage.committed",
1422         "summary.storage.uncommitted",
1423         "summary.storage.unshared",
1424         "layoutEx.file",
1425         "config.guestFullName",
1426         "config.guestId",
1427         "guest.net",
1428         "config.hardware.memoryMB",
1429         "name",
1430         "config.hardware.numCPU",
1431         "config.files.vmPathName",
1432         "summary.runtime.powerState",
1433         "guest.toolsStatus",
1434     ]
1435     vm_list = salt.utils.vmware.get_mors_with_properties(
1436         _get_si(), vim.VirtualMachine, vm_properties
1437     for vm in vm_list:
1438         ret[vm["name"]] = _format_instance_info(<font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>vm)
1439     return ret
1440 def list_nodes_select(call=None):
1441     if call == "action":
1442         raise SaltCloudSystemExit(
1443             "The list_nodes_select function must be called with -f or --function."
1444         )
1445     ret = {}
1446     vm_properties = []
1447     selection =</b></font> __opts__.get("query.selection")
1448     if not selection:
1449         raise SaltCloudSystemExit("query.selection not found in /etc/salt/cloud")
1450     if "id" in selection:
1451         vm_properties.append("name")
1452     if "image" in selection:
1453         vm_properties.append("config.guestFullName")
1454     if "size" in selection:
1455         vm_properties.extend(["config.hardware.numCPU", "config.hardware.memoryMB"])
1456     if "state" in selection:
1457         vm_properties.append("summary.runtime.powerState")
1458     if "private_ips" in selection or "networks" in selection:
1459         vm_properties.append("guest.net")
1460     if (
1461         "devices" in selection
1462         or "mac_address" in selection
1463         or "mac_addresses" in selection
1464     ):
1465         vm_properties.append("config.hardware.device")
1466     if "storage" in selection:
1467         vm_properties.extend(
1468             [
1469                 "config.hardware.device",
1470                 "summary.storage.committed",
1471                 "summary.storage.uncommitted",
1472                 "summary.storage.unshared",
1473             ]
1474         )
1475     if "files" in selection:
1476         vm_properties.append("layoutEx.file")
1477     if "guest_id" in selection:
1478         vm_properties.append("config.guestId")
1479     if "hostname" in selection:
1480         vm_properties.append("guest.hostName")
1481     if "path" in selection:
1482         vm_properties.append("config.files.vmPathName")
1483     if "tools_status" in selection:
1484         vm_properties.append("guest.toolsStatus")
1485     if not vm_properties:
1486         return {}
1487     elif "name" not in vm_properties:
1488         vm_properties.append("name")
1489     vm_list = salt.utils.vmware.get_mors_with_properties(
1490         _get_si(), vim.VirtualMachine, vm_properties
1491     )
1492     for vm in vm_list:
1493         ret[vm["name"]] = _format_instance_info_select(vm, selection)
1494     return ret
1495 def show_instance(name, call=None):
1496     if call != "action":
1497         raise SaltCloudSystemExit(
1498             "The show_instance action must be called with -a or --action."
1499         )
1500     vm_properties = [
1501         "config.hardware.device",
1502         "summary.storage.committed",
1503         "summary.storage.uncommitted",
1504         "summary.storage.unshared",
1505         "layoutEx.file",
1506         "config.guestFullName",
1507         "config.guestId",
1508         "guest.net",
1509         "config.hardware.memoryMB",
1510         "name",
1511         "config.hardware.numCPU",
1512         "config.files.vmPathName",
1513         "summary.runtime.powerState",
1514         "guest.toolsStatus",
1515     ]
1516     vm_list = salt.utils.vmware.get_mors_with_properties(
1517         _get_si(), vim.VirtualMachine, vm_properties
1518     )
1519     for vm in vm_list:
1520         if vm["name"] == name:
1521             return _format_instance_info(vm)
1522     return {}
1523 def avail_images(call=None):
1524     if call == "action":
1525         raise SaltCloudSystemExit(
1526             "The avail_images function must be called with "
1527             "-f or --function, or with the --list-images option."
1528         )
1529     templates = {}
1530     vm_properties = [
1531         "name",
1532         "config.template",
1533         "config.guestFullName",
1534         "config.hardware.numCPU",
1535         "config.hardware.memoryMB",
1536     ]
1537     vm_list = salt.utils.vmware.get_mors_with_properties(
1538         _get_si(), vim.VirtualMachine, vm_properties
1539     )
1540     for vm in vm_list:
1541         if "config.template" in vm and vm["config.template"]:
1542             templates[vm["name"]] = {
1543                 "name": vm["name"],
1544                 "guest_fullname": vm["config.guestFullName"]
1545                 if "config.guestFullName" in vm
1546                 else "N/A",
1547                 "cpus": vm["config.hardware.numCPU"]
1548                 if "config.hardware.numCPU" in vm
1549                 else "N/A",
1550                 "ram": vm["config.hardware.memoryMB"]
1551                 if "config.hardware.memoryMB" in vm
1552                 else "N/A",
1553             }
1554     return templates
1555 def avail_locations(call=None):
1556     if call == "action":
1557         raise SaltCloudSystemExit(
1558             "The avail_locations function must be called with "
1559             "-f or --function, or with the --list-locations option."
1560         )
1561     return list_datacenters(call="function")
1562 def avail_sizes(call=None):
1563     if call == "action":
1564         raise SaltCloudSystemExit(
1565             "The avail_sizes function must be called with "
1566             "-f or --function, or with the --list-sizes option."
1567         )
1568     log.warning(
1569         "Because sizes are built into templates with VMware, there are no sizes "
1570         "to return."
1571     )
1572     return {}
1573 def list_templates(kwargs=None, call=None):
1574     if call != "function":
1575         raise SaltCloudSystemExit(
1576             "The list_templates function must be called with -f or --function."
1577         )
1578     return {"Templates": avail_images(call="function")}
1579 def list_folders(kwargs=None, call=None):
1580     if call != "function":
1581         raise SaltCloudSystemExit(
1582             "The list_folders function must be called with -f or --function."
1583         )
1584     return {"Folders": salt.utils.vmware.list_folders(_get_si())}
1585 def list_snapshots(kwargs=None, call=None):
1586     if call != "function":
1587         raise SaltCloudSystemExit(
1588             "The list_snapshots function must be called with -f or --function."
1589         )
1590     ret = {}
1591     vm_properties = ["name", "rootSnapshot", "snapshot"]
1592     vm_list = salt.utils.vmware.get_mors_with_properties(
1593         _get_si(), vim.VirtualMachine, vm_properties
1594     )
1595     for vm in vm_list:
1596         if vm["rootSnapshot"]:
1597             if kwargs and kwargs.get("name") == vm["name"]:
1598                 return {vm["name"]: _get_snapshots(vm["snapshot"].rootSnapshotList)}
1599             else:
1600                 ret[vm["name"]] = _get_snapshots(vm["snapshot"].rootSnapshotList)
1601         else:
1602             if kwargs and kwargs.get("name") == vm["name"]:
1603                 return {}
1604     return ret
1605 def start(name, call=None):
1606     if call != "action":
1607         raise SaltCloudSystemExit(
1608             "The start action must be called with -a or --action."
1609         )
1610     vm_properties = ["name", "summary.runtime.powerState"]
1611     vm_list = salt.utils.vmware.get_mors_with_properties(
1612         _get_si(), vim.VirtualMachine, vm_properties
1613     )
1614     for vm in vm_list:
1615         if vm["name"] == name:
1616             if vm["summary.runtime.powerState"] == "poweredOn":
1617                 ret = "already powered on"
1618                 log.info("VM %s %s", name, ret)
1619                 return ret
1620             try:
1621                 log.info("Starting VM %s", name)
1622                 task = vm["object"].PowerOn()
1623                 salt.utils.vmware.wait_for_task(task, name, "power on")
1624             except Exception as exc:  # pylint: disable=broad-except
1625                 log.error(
1626                     "Error while powering on VM %s: %s",
1627                     name,
1628                     exc,
1629                     exc_info_on_loglevel=logging.DEBUG,
1630                 )
1631                 return "failed to power on"
1632     return "powered on"
1633 def stop(name, soft=False, call=None):
1634     if call != "action":
1635         raise SaltCloudSystemExit("The stop action must be called with -a or --action.")
1636     vm_properties = ["name", "summary.runtime.powerState"]
1637     vm_list = salt.utils.vmware.get_mors_with_properties(
1638         _get_si(), vim.VirtualMachine, vm_properties
1639     )
1640     for vm in vm_list:
1641         if vm["name"] == name:
1642             if vm["summary.runtime.powerState"] == "poweredOff":
1643                 ret = "already powered off"
1644                 log.info("VM %s %s", name, ret)
1645                 return ret
1646             try:
1647                 log.info("Stopping VM %s", name)
1648                 if soft:
1649                     vm["object"].ShutdownGuest()
1650                 else:
1651                     task = vm["object"].PowerOff()
1652                     salt.utils.vmware.wait_for_task(task, name, "power off")
1653             except Exception as exc:  # pylint: disable=broad-except
1654                 log.error(
1655                     "Error while powering off VM %s: %s",
1656                     name,
1657                     exc,
1658                     exc_info_on_loglevel=logging.DEBUG,
1659                 )
1660                 return "failed to power off"
1661     return "powered off"
1662 def suspend(name, call=None):
1663     if call != "action":
1664         raise SaltCloudSystemExit(
1665             "The suspend action must be called with -a or --action."
1666         )
1667     vm_properties = ["name", "summary.runtime.powerState"]
1668     vm_list = salt.utils.vmware.get_mors_with_properties(
1669         _get_si(), vim.VirtualMachine, vm_properties
1670     )
1671     for vm in vm_list:
1672         if vm["name"] == name:
1673             if vm["summary.runtime.powerState"] == "poweredOff":
1674                 ret = "cannot suspend in powered off state"
1675                 log.info("VM %s %s", name, ret)
1676                 return ret
1677             elif vm["summary.runtime.powerState"] == "suspended":
1678                 ret = "already suspended"
1679                 log.info("VM %s %s", name, ret)
1680                 return ret
1681             try:
1682                 log.info("Suspending VM %s", name)
1683                 task = vm["object"].Suspend()
1684                 salt.utils.vmware.wait_for_task(task, name, "suspend")
1685             except Exception as exc:  # pylint: disable=broad-except
1686                 log.error(
1687                     "Error while suspending VM %s: %s",
1688                     name,
1689                     exc,
1690                     exc_info_on_loglevel=logging.DEBUG,
1691                 )
1692                 return "failed to suspend"
1693     return "suspended"
1694 def reset(name, soft=False, call=None):
1695     if call != "action":
1696         raise SaltCloudSystemExit(
1697             "The reset action must be called with -a or --action."
1698         )
1699     vm_properties = ["name", "summary.runtime.powerState"]
1700     vm_list = salt.utils.vmware.get_mors_with_properties(
1701         _get_si(), vim.VirtualMachine, vm_properties
1702     )
1703     for vm in vm_list:
1704         if vm["name"] == name:
1705             if (
1706                 vm["summary.runtime.powerState"] == "suspended"
1707                 or vm["summary.runtime.powerState"] == "poweredOff"
1708             ):
1709                 ret = "cannot reset in suspended/powered off state"
1710                 log.info("VM %s %s", name, ret)
1711                 return ret
1712             try:
1713                 log.info("Resetting VM %s", name)
1714                 if soft:
1715                     vm["object"].RebootGuest()
1716                 else:
1717                     task = vm["object"].ResetVM_Task()
1718                     salt.utils.vmware.wait_for_task(task, name, "reset")
1719             except Exception as exc:  # pylint: disable=broad-except
1720                 log.error(
1721                     "Error while resetting VM %s: %s",
1722                     name,
1723                     exc,
1724                     exc_info_on_loglevel=logging.DEBUG,
1725                 )
1726                 return "failed to reset"
1727     return "reset"
1728 def terminate(name, call=None):
1729     if call != "action":
1730         raise SaltCloudSystemExit(
1731             "The terminate action must be called with -a or --action."
1732         )
1733     vm_properties = ["name", "summary.runtime.powerState"]
1734     vm_list = salt.utils.vmware.get_mors_with_properties(
1735         _get_si(), vim.VirtualMachine, vm_properties
1736     )
1737     for vm in vm_list:
1738         if vm["name"] == name:
1739             if vm["summary.runtime.powerState"] == "poweredOff":
1740                 ret = "already powered off"
1741                 log.info("VM %s %s", name, ret)
1742                 return ret
1743             try:
1744                 log.info("Terminating VM %s", name)
1745                 vm["object"].Terminate()
1746             except Exception as exc:  # pylint: disable=broad-except
1747                 log.error(
1748                     "Error while terminating VM %s: %s",
1749                     name,
1750                     exc,
1751                     exc_info_on_loglevel=logging.DEBUG,
1752                 return "failed to terminate"
1753     r<font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>eturn "terminated"
1754 def destroy(name, call=None):
1755     if call == "function":
1756         raise SaltCloudSystemExit(
1757             "The destroy action must be called with -d, --destroy, -a or --action."
1758         )
1759     __utils__["cloud.fire_event"](
1760         "event",
1761         "destroying instance",
1762         "salt/cloud/{}/destroying".format(name),
1763         args={"name": name},
1764         sock_dir=__opts__["sock_dir"],
1765         transport=__opts__["transport"],
1766     )
1767     vm_properties =</b></font> ["name", "summary.runtime.powerState"]
1768     vm_list = salt.utils.vmware.get_mors_with_properties(
1769         _get_si(), vim.VirtualMachine, vm_properties
1770     )
1771     for vm in vm_list:
1772         if vm["name"] == name:
1773             if vm["summary.runtime.powerState"] != "poweredOff":
1774                 try:
1775                     log.info("Powering Off VM %s", name)
1776                     task = vm["object"].PowerOff()
1777                     salt.utils.vmware.wait_for_task(task, name, "power off")
1778                 except Exception as exc:  # pylint: disable=broad-except
1779                     log.error(
1780                         "Error while powering off VM %s: %s",
1781                         name,
1782                         exc,
1783                         exc_info_on_loglevel=logging.DEBUG,
1784                     )
1785                     return "failed to destroy"
1786             try:
1787                 log.info("Destroying VM %s", name)
1788                 task = vm["object"].Destroy_Task()
1789                 salt.utils.vmware.wait_for_task(task, name, "destroy")
1790             except Exception as exc:  # pylint: disable=broad-except
1791                 log.error(
1792                     "Error while destroying VM %s: %s",
1793                     name,
1794                     exc,
1795                     exc_info_on_loglevel=logging.DEBUG,
1796                 return "failed to destroy"
1797     __utils__<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["cloud.fire_event"](
1798         "event",
1799         "destroyed instance",
1800         "salt/cloud/{}/destroyed".format(name),
1801         args={"name": name},
1802         sock_dir=__opts__["sock_dir"],
1803         transport=__opts__["transport"],
1804     )
1805     if __opts__.get("update_cachedir", False) is True:
1806         __utils__["cloud.delete_minion_cachedir"](
1807         )
1808     <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>return True
1809 def create(vm_):
1810     try:
1811         if (
1812             vm_["profile"]
1813             and config.is_profile_configured(
1814                 __opts__,
1815                 _get_active_provider_name() or "vmware",
1816                 vm_["profile"],
1817                 vm_=vm_,
1818             )
1819             is False
1820         ):
1821             return False
1822     except AttributeError:
1823         pass
1824     __utils__["cloud.fire_event"](
1825         "event",
1826         "starting create",
1827         "salt/cloud/{}/creating".format(vm_["name"]),
1828         args=__utils__["cloud.filter_event"](
1829             "creating", vm_, ["name", "profile", "provider", "driver"]
1830         ),
1831         sock_dir=__opts__["sock_dir"],
1832         transport=__opts__[</b></font>"transport"],
1833     )
1834     vm_name = config.get_cloud_config_value("name", vm_, __opts__, default=None)
1835     folder = config.get_cloud_config_value("folder", vm_, __opts__, default=None)
1836     datacenter = config.get_cloud_config_value(
1837         "datacenter", vm_, __opts__, default=None
1838     )
1839     resourcepool = config.get_cloud_config_value(
1840         "resourcepool", vm_, __opts__, default=None
1841     )
1842     cluster = config.get_cloud_config_value("cluster", vm_, __opts__, default=None)
1843     datastore = config.get_cloud_config_value("datastore", vm_, __opts__, default=None)
1844     host = config.get_cloud_config_value("host", vm_, __opts__, default=None)
1845     template = config.get_cloud_config_value("template", vm_, __opts__, default=False)
1846     num_cpus = config.get_cloud_config_value("num_cpus", vm_, __opts__, default=None)
1847     cores_per_socket = config.get_cloud_config_value(
1848         "cores_per_socket", vm_, __opts__, default=None
1849     )
1850     instant_clone = config.get_cloud_config_value(
1851         "instant_clone", vm_, __opts__, default=False
1852     )
1853     memory = config.get_cloud_config_value("memory", vm_, __opts__, default=None)
1854     devices = config.get_cloud_config_value("devices", vm_, __opts__, default=None)
1855     extra_config = config.get_cloud_config_value(
1856         "extra_config", vm_, __opts__, default=None
1857     )
1858     annotation = config.get_cloud_config_value(
1859         "annotation", vm_, __opts__, default=None
1860     )
1861     power = config.get_cloud_config_value("power_on", vm_, __opts__, default=True)
1862     key_filename = config.get_cloud_config_value(
1863         "private_key", vm_, __opts__, search_global=False, default=None
1864     )
1865     deploy = config.get_cloud_config_value(
1866         "deploy", vm_, __opts__, search_global=True, default=True
1867     )
1868     wait_for_ip_timeout = config.get_cloud_config_value(
1869         "wait_for_ip_timeout", vm_, __opts__, default=20 * 60
1870     )
1871     domain = config.get_cloud_config_value(
1872         "domain", vm_, __opts__, search_global=False, default="local"
1873     )
1874     hardware_version = config.get_cloud_config_value(
1875         "hardware_version", vm_, __opts__, search_global=False, default=None
1876     )
1877     guest_id = config.get_cloud_config_value(
1878         "image", vm_, __opts__, search_global=False, default=None
1879     )
1880     customization = config.get_cloud_config_value(
1881         "customization", vm_, __opts__, search_global=False, default=True
1882     )
1883     customization_spec = config.get_cloud_config_value(
1884         "customization_spec", vm_, __opts__, search_global=False, default=None
1885     )
1886     win_password = config.get_cloud_config_value(
1887         "win_password", vm_, __opts__, search_global=False, default=None
1888     )
1889     win_organization_name = config.get_cloud_config_value(
1890         "win_organization_name",
1891         vm_,
1892         __opts__,
1893         search_global=False,
1894         default="Organization",
1895     )
1896     plain_text = config.get_cloud_config_value(
1897         "plain_text", vm_, __opts__, search_global=False, default=False
1898     )
1899     win_user_fullname = config.get_cloud_config_value(
1900         "win_user_fullname", vm_, __opts__, search_global=False, default="Windows User"
1901     )
1902     win_run_once = config.get_cloud_config_value(
1903         "win_run_once", vm_, __opts__, search_global=False, default=None
1904     )
1905     cpu_hot_add = config.get_cloud_config_value(
1906         "cpu_hot_add", vm_, __opts__, search_global=False, default=None
1907     )
1908     cpu_hot_remove = config.get_cloud_config_value(
1909         "cpu_hot_remove", vm_, __opts__, search_global=False, default=None
1910     )
1911     mem_hot_add = config.get_cloud_config_value(
1912         "mem_hot_add", vm_, __opts__, search_global=False, default=None
1913     )
1914     nested_hv = config.get_cloud_config_value(
1915         "nested_hv", vm_, __opts__, search_global=False, default=None
1916     )
1917     vpmc = config.get_cloud_config_value(
1918         "vpmc", vm_, __opts__, search_global=False, default=None
1919     )
1920     si = _get_si()
1921     container_ref = None
1922     if datacenter:
1923         datacenter_ref = salt.utils.vmware.get_mor_by_property(
1924             _get_si(), vim.Datacenter, datacenter
1925         )
1926         container_ref = datacenter_ref if datacenter_ref else None
1927     if "clonefrom" in vm_:
1928         if datacenter:
1929             datacenter_ref = salt.utils.vmware.get_mor_by_property(
1930                 si, vim.Datacenter, datacenter
1931             )
1932             container_ref = datacenter_ref if datacenter_ref else None
1933         object_ref = salt.utils.vmware.get_mor_by_property(
1934             si, vim.VirtualMachine, vm_["clonefrom"], container_ref=container_ref
1935         )
1936         if object_ref:
1937             clone_type = "template" if object_ref.config.template else "vm"
1938         else:
1939             raise SaltCloudSystemExit(
1940                 "The VM/template that you have specified under clonefrom does not"
1941                 " exist."
1942             )
1943     else:
1944         clone_type = None
1945         object_ref = None
1946     if resourcepool:
1947         resourcepool_ref = salt.utils.vmware.get_mor_by_property(
1948             si, vim.ResourcePool, resourcepool, container_ref=container_ref
1949         )
1950         if not resourcepool_ref:
1951             log.error("Specified resource pool: '%s' does not exist", resourcepool)
1952             if not clone_type or clone_type == "template":
1953                 raise SaltCloudSystemExit(
1954                     "You must specify a resource pool that exists."
1955                 )
1956     elif cluster:
1957         cluster_ref = salt.utils.vmware.get_mor_by_property(
1958             si, vim.ClusterComputeResource, cluster, container_ref=container_ref
1959         )
1960         if not cluster_ref:
1961             log.error("Specified cluster: '%s' does not exist", cluster)
1962             if not clone_type or clone_type == "template":
1963                 raise SaltCloudSystemExit("You must specify a cluster that exists.")
1964         else:
1965             resourcepool_ref = cluster_ref.resourcePool
1966     elif clone_type == "template":
1967         raise SaltCloudSystemExit(
1968             "You must either specify a cluster or a resource pool when cloning from a"
1969             " template."
1970         )
1971     elif not clone_type:
1972         raise SaltCloudSystemExit(
1973             "You must either specify a cluster or a resource pool when creating."
1974         )
1975     else:
1976         log.debug("Using resource pool used by the %s %s", clone_type, vm_["clonefrom"])
1977     if folder:
1978         folder_parts = folder.split("/")
1979         search_reference = container_ref
1980         for folder_part in folder_parts:
1981             if folder_part:
1982                 folder_ref = salt.utils.vmware.get_mor_by_property(
1983                     si, vim.Folder, folder_part, container_ref=search_reference
1984                 )
1985                 search_reference = folder_ref
1986         if not folder_ref:
1987             log.error("Specified folder: '%s' does not exist", folder)
1988             log.debug(
1989                 "Using folder in which %s %s is present", clone_type, vm_["clonefrom"]
1990             )
1991             folder_ref = object_ref.parent
1992     elif datacenter:
1993         if not datacenter_ref:
1994             log.error("Specified datacenter: '%s' does not exist", datacenter)
1995             log.debug(
1996                 "Using datacenter folder in which %s %s is present",
1997                 clone_type,
1998                 vm_["clonefrom"],
1999             )
2000             folder_ref = object_ref.parent
2001         else:
2002             folder_ref = datacenter_ref.vmFolder
2003     elif not clone_type:
2004         raise SaltCloudSystemExit(
2005             "You must either specify a folder or a datacenter when creating not"
2006             " cloning."
2007         )
2008     else:
2009         log.debug(
2010             "Using folder in which %s %s is present", clone_type, vm_["clonefrom"]
2011         )
2012         folder_ref = object_ref.parent
2013     if "clonefrom" in vm_:
2014         reloc_spec = vim.vm.RelocateSpec()
2015         if (resourcepool and resourcepool_ref) or (cluster and cluster_ref):
2016             reloc_spec.pool = resourcepool_ref
2017         if datastore:
2018             datastore_ref = salt.utils.vmware.get_mor_by_property(
2019                 si, vim.Datastore, datastore, container_ref=container_ref
2020             )
2021             if datastore_ref:
2022                 reloc_spec.datastore = datastore_ref
2023             else:
2024                 datastore_cluster_ref = salt.utils.vmware.get_mor_by_property(
2025                     si, vim.StoragePod, datastore, container_ref=container_ref
2026                 )
2027                 if not datastore_cluster_ref:
2028                     log.error(
2029                         "Specified datastore/datastore cluster: '%s' does not exist",
2030                         datastore,
2031                     )
2032                     log.debug(
2033                         "Using datastore used by the %s %s",
2034                         clone_type,
2035                         vm_["clonefrom"],
2036                     )
2037         else:
2038             log.debug("No datastore/datastore cluster specified")
2039             log.debug("Using datastore used by the %s %s", clone_type, vm_["clonefrom"])
2040         if host:
2041             host_ref = salt.utils.vmware.get_mor_by_property(
2042                 si, vim.HostSystem, host, container_ref=container_ref
2043             )
2044             if host_ref:
2045                 reloc_spec.host = host_ref
2046             else:
2047                 log.error("Specified host: '%s' does not exist", host)
2048         if instant_clone:
2049             instant_clone_spec = vim.vm.InstantCloneSpec()
2050             instant_clone_spec.name = vm_name
2051             instant_clone_spec.location = reloc_spec
2052             event_kwargs = vm_.copy()
2053             if event_kwargs.get("password"):
2054             try:
2055                 __utils__<font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["cloud.fire_event"](
2056                     "event",
2057                     "requesting instance",
2058                     "salt/cloud/{}/requesting".format(vm_["name"]),
2059                     args=__utils__["cloud.filter_event"](
2060                         "requesting", event_kwargs, list(event_kwargs)
2061                     ),
2062                     sock_dir=__opts__["sock_dir"],
2063                     transport=__opts__[</b></font>"transport"],
2064                 )
2065                 log.info(
2066                     "Creating %s from %s(%s)", vm_["name"], clone_type, vm_["clonefrom"]
2067                 )
2068                 if datastore and not datastore_ref and datastore_cluster_ref:
2069                     pod_spec = vim.storageDrs.PodSelectionSpec(
2070                         storagePod=datastore_cluster_ref
2071                     )
2072                     storage_spec = vim.storageDrs.StoragePlacementSpec(
2073                         type="clone",
2074                         vm=object_ref,
2075                         podSelectionSpec=pod_spec,
2076                         cloneName=vm_name,
2077                         folder=folder_ref,
2078                     )
2079                     recommended_datastores = (
2080                         si.content.storageResourceManager.RecommendDatastores(
2081                             storageSpec=storage_spec
2082                         )
2083                     )
2084                     task = si.content.storageResourceManager.ApplyStorageDrsRecommendation_Task(
2085                         recommended_datastores.recommendations[0].key
2086                     )
2087                     salt.utils.vmware.wait_for_task(
2088                         task, vm_name, "apply storage DRS recommendations", 5, "info"
2089                     )
2090                 else:
2091                     task = object_ref.InstantClone_Task(spec=instant_clone_spec)
2092                     salt.utils.vmware.wait_for_task(
2093                         task, vm_name, "Instantclone", 5, "info"
2094                     )
2095             except Exception as exc:  # pylint: disable=broad-except
2096                 err_msg = "Error Instant cloning {}: {}".format(vm_["name"], exc)
2097                 log.error(
2098                     err_msg,
2099                     exc_info_on_loglevel=logging.DEBUG,
2100                 )
2101                 return {"Error": err_msg}
2102             new_vm_ref = salt.utils.vmware.get_mor_by_property(
2103                 si, vim.VirtualMachine, vm_name, container_ref=container_ref
2104             )
2105             out = None
2106             if not template and power:
2107                 ip = _wait_for_ip(new_vm_ref, wait_for_ip_timeout)
2108                 if ip:
2109                     log.info("[ %s ] IPv4 is: %s", vm_name, ip)
2110                     if deploy:
2111                         vm_["key_filename"] = key_filename
2112                         if "ssh_host" not in vm_:
2113                             vm_["ssh_host"] = ip
2114                         log.info("[ %s ] Deploying to %s", vm_name, vm_["ssh_host"])
2115                         out = __utils__["cloud.bootstrap"](vm_, __opts__)
2116             data = show_instance(vm_name, call="action")
2117             if deploy and isinstance(out, dict):
2118                 data["deploy_kwargs"] = out.get("deploy_kwargs", {})
2119             __utils__["cloud.fire_event"](
2120                 "event",
2121                 "created instance",
2122                 "salt/cloud/{}/created".format(vm_["name"]),
2123                 args=__utils__["cloud.filter_event"](
2124                     "created", vm_, ["name", "profile", "provider", "driver"]
2125                 ),
2126                 sock_dir=__opts__["sock_dir"],
2127                 transport=__opts__["transport"],
2128             )
2129             return {"Instant Clone created successfully": data}
2130     else:
2131         if not datastore:
2132             raise SaltCloudSystemExit(
2133                 "You must specify a datastore when creating not cloning."
2134             )
2135         else:
2136             datastore_ref = salt.utils.vmware.get_mor_by_property(
2137                 si, vim.Datastore, datastore
2138             )
2139             if not datastore_ref:
2140                 raise SaltCloudSystemExit(
2141                     "Specified datastore: '{}' does not exist".format(datastore)
2142                 )
2143         if host:
2144             host_ref = salt.utils.vmware.get_mor_by_property(
2145                 _get_si(), vim.HostSystem, host, container_ref=container_ref
2146             )
2147             if not host_ref:
2148                 log.error("Specified host: '%s' does not exist", host)
2149     config_spec = vim.vm.ConfigSpec()
2150     if hardware_version and object_ref is not None:
2151         hardware_version = "vmx-{:02}".format(hardware_version)
2152         if hardware_version != object_ref.config.version:
2153             log.debug(
2154                 "Scheduling hardware version upgrade from %s to %s",
2155                 object_ref.config.version,
2156                 hardware_version,
2157             )
2158             scheduled_hardware_upgrade = vim.vm.ScheduledHardwareUpgradeInfo()
2159             scheduled_hardware_upgrade.upgradePolicy = "always"
2160             scheduled_hardware_upgrade.versionKey = hardware_version
2161             config_spec.scheduledHardwareUpgradeInfo = scheduled_hardware_upgrade
2162         else:
2163             log.debug("Virtual hardware version already set to %s", hardware_version)
2164     if num_cpus:
2165         log.debug("Setting cpu to: %s", num_cpus)
2166         config_spec.numCPUs = int(num_cpus)
2167     if cores_per_socket:
2168         log.debug("Setting cores per socket to: %s", cores_per_socket)
2169         config_spec.numCoresPerSocket = int(cores_per_socket)
2170     if memory:
2171         try:
2172             memory_num, memory_unit = re.findall(r"[^\W\d_]+|\d+.\d+|\d+", memory)
2173             if memory_unit.lower() == "mb":
2174                 memory_mb = int(memory_num)
2175             elif memory_unit.lower() == "gb":
2176                 memory_mb = int(float(memory_num) * 1024.0)
2177             else:
2178                 err_msg = "Invalid memory type specified: '{}'".format(memory_unit)
2179                 log.error(err_msg)
2180                 return {"Error": err_msg}
2181         except (TypeError, ValueError):
2182             memory_mb = int(memory)
2183         log.debug("Setting memory to: %s MB", memory_mb)
2184         config_spec.memoryMB = memory_mb
2185     if devices:
2186         specs = _manage_devices(
2187             devices, vm=object_ref, container_ref=container_ref, new_vm_name=vm_name
2188         )
2189         config_spec.deviceChange = specs["device_specs"]
2190     if cpu_hot_add and hasattr(config_spec, "cpuHotAddEnabled"):
2191         config_spec.cpuHotAddEnabled = bool(cpu_hot_add)
2192     if cpu_hot_remove and hasattr(config_spec, "cpuHotRemoveEnabled"):
2193         config_spec.cpuHotRemoveEnabled = bool(cpu_hot_remove)
2194     if mem_hot_add and hasattr(config_spec, "memoryHotAddEnabled"):
2195         config_spec.memoryHotAddEnabled = bool(mem_hot_add)
2196     if nested_hv and hasattr(config_spec, "nestedHVEnabled"):
2197         config_spec.nestedHVEnabled = bool(nested_hv)
2198     if vpmc and hasattr(config_spec, "vPMCEnabled"):
2199         config_spec.vPMCEnabled = bool(vpmc)
2200     if extra_config:
2201         for key, value in extra_config.items():
2202             option = vim.option.OptionValue(key=key, value=value)
2203             config_spec.extraConfig.append(option)
2204     if annotation:
2205         config_spec.annotation = str(annotation)
2206     if "clonefrom" in vm_:
2207         clone_spec = handle_snapshot(config_spec, object_ref, reloc_spec, template, vm_)
2208         if not clone_spec:
2209             clone_spec = build_clonespec(config_spec, object_ref, reloc_spec, template)
2210         if customization and customization_spec:
2211             customization_spec = salt.utils.vmware.get_customizationspec_ref(
2212                 si=si, customization_spec_name=customization_spec
2213             )
2214             clone_spec.customization = customization_spec.spec
2215         elif customization and (devices and "network" in list(devices.keys())):
2216             global_ip = vim.vm.customization.GlobalIPSettings()
2217             if "dns_servers" in list(vm_.keys()):
2218                 global_ip.dnsServerList = vm_["dns_servers"]
2219             if "domain" in list(vm_.keys()):
2220                 global_ip.dnsSuffixList = vm_["domain"]
2221             non_hostname_chars = re.compile(r"[^\w-]")
2222             if re.search(non_hostname_chars, vm_name):
2223                 host_name = re.split(non_hostname_chars, vm_name, maxsplit=1)[0]
2224                 domain_name = re.split(non_hostname_chars, vm_name, maxsplit=1)[-1]
2225             else:
2226                 host_name = vm_name
2227                 domain_name = domain
2228             if "Windows" not in object_ref.config.guestFullName:
2229                 identity = vim.vm.customization.LinuxPrep()
2230                 identity.domain = domain_name
2231             else:
2232                 identity = vim<font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.vm.customization.Sysprep()
2233                 identity.guiUnattended = vim.vm.customization.GuiUnattended()
2234                 identity.guiUnattended.</b></font>autoLogon = True
2235                 identity.guiUnattended.autoLogonCount = 1
2236                 identity.guiUnattended.password = vim.vm.customization.Password()
2237                 identity.guiUnattended.password.value = win_password
2238                 identity.guiUnattended.password.plainText = plain_text
2239                 if win_run_once:
2240                     identity.guiRunOnce = vim.vm.customization.GuiRunOnce()
2241                     identity.guiRunOnce.commandList = win_run_once
2242                 identity.userData = vim.vm.customization.UserData()
2243                 identity.userData.fullName = win_user_fullname
2244                 identity.userData.orgName = win_organization_name
2245                 identity.userData.computerName = vim.vm.customization.FixedName()
2246                 identity.userData.computerName.name = host_name
2247                 identity.identification = vim.vm.customization.Identification()
2248             custom_spec = vim.vm.customization.Specification(
2249                 globalIPSettings=global_ip,
2250                 identity=identity,
2251                 nicSettingMap=specs["nics_map"],
2252             )
2253             clone_spec.customization = custom_spec
2254         if not template:
2255             clone_spec.powerOn = power
2256         log.debug("clone_spec set to:\n%s", pprint.pformat(clone_spec))
2257     else:
2258         config_spec.name = vm_name
2259         config_spec.files = vim.vm.FileInfo()
2260         config_spec.files.vmPathName = "[{0}] {1}/{1}.vmx".format(datastore, vm_name)
2261         config_spec.guestId = guest_id
2262         log.debug("config_spec set to:\n%s", pprint.pformat(config_spec))
2263     event_kwargs = vm_.copy()
2264     if event_kwargs.get("password"):
2265         del event_kwargs["password"]
2266     try:
2267         __utils__["cloud.fire_event"](
2268             "event",
2269             "requesting instance",
2270             "salt/cloud/{}/requesting".format(vm_["name"]),
2271             args=__utils__["cloud.filter_event"](
2272                 "requesting", event_kwargs, list(event_kwargs)
2273             ),
2274             sock_dir=__opts__["sock_dir"],
2275             transport=__opts__["transport"],
2276         )
2277         if "clonefrom" in vm_:
2278             log.info(
2279                 "Creating %s from %s(%s)", vm_["name"], clone_type, vm_["clonefrom"]
2280             )
2281             if datastore and not datastore_ref and datastore_cluster_ref:
2282                 pod_spec = vim.storageDrs.PodSelectionSpec(
2283                     storagePod=datastore_cluster_ref
2284                 )
2285                 storage_spec = vim.storageDrs.StoragePlacementSpec(
2286                     type="clone",
2287                     vm=object_ref,
2288                     podSelectionSpec=pod_spec,
2289                     cloneSpec=clone_spec,
2290                     cloneName=vm_name,
2291                     folder=folder_ref,
2292                 )
2293                 recommended_datastores = (
2294                     si.content.storageResourceManager.RecommendDatastores(
2295                         storageSpec=storage_spec
2296                     )
2297                 )
2298                 task = si.content.storageResourceManager.ApplyStorageDrsRecommendation_Task(
2299                     recommended_datastores.recommendations[0].key
2300                 )
2301                 salt.utils.vmware.wait_for_task(
2302                     task, vm_name, "apply storage DRS recommendations", 5, "info"
2303                 )
2304             else:
2305                 task = object_ref.Clone(folder_ref, vm_name, clone_spec)
2306                 salt.utils.vmware.wait_for_task(task, vm_name, "clone", 5, "info")
2307         else:
2308             log.info("Creating %s", vm_["name"])
2309             if host:
2310                 task = folder_ref.CreateVM_Task(config_spec, resourcepool_ref, host_ref)
2311             else:
2312                 task = folder_ref.CreateVM_Task(config_spec, resourcepool_ref)
2313             salt.utils.vmware.wait_for_task(task, vm_name, "create", 15, "info")
2314     except Exception as exc:  # pylint: disable=broad-except
2315         err_msg = "Error creating {}: {}".format(vm_["name"], exc)
2316         log.error(
2317             err_msg,
2318             exc_info_on_loglevel=logging.DEBUG,
2319         )
2320         return {"Error": err_msg}
2321     new_vm_ref = salt.utils.vmware.get_mor_by_property(
2322         si, vim.VirtualMachine, vm_name, container_ref=container_ref
2323     )
2324     try:
2325         if not clone_type and power:
2326             task = new_vm_ref.PowerOn()
2327             salt.utils.vmware.wait_for_task(task, vm_name, "power", 5, "info")
2328     except Exception as exc:  # pylint: disable=broad-except
2329         log.info("Powering on the VM threw this exception. Ignoring.")
2330         log.info(exc)
2331     out = None
2332     if not template and power:
2333         ip = _wait_for_ip(new_vm_ref, wait_for_ip_timeout)
2334         if ip:
2335             log.info("[ %s ] IPv4 is: %s", vm_name, ip)
2336             if deploy:
2337                 vm_["key_filename"] = key_filename
2338                 if "ssh_host" not in vm_:
2339                     vm_["ssh_host"] = ip
2340                 log.info("[ %s ] Deploying to %s", vm_name, vm_["ssh_host"])
2341                 out = __utils__["cloud.bootstrap"](vm_, __opts__)
2342     data = show_instance(vm_name, call="action")
2343         data["deploy_kwargs"] = out.get("deploy_kwargs", {})
2344     __utils__<font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["cloud.fire_event"](
2345         "event",
2346         "created instance",
2347         "salt/cloud/{}/created".format(vm_["name"]),
2348         args=__utils__["cloud.filter_event"](
2349             "created", vm_, ["name", "profile", "provider", "driver"]
2350         ),
2351         sock_dir=__opts__["sock_dir"],
2352         transport=__opts__["transport"],
2353     )
2354     return data
2355 def</b></font> handle_snapshot(config_spec, object_ref, reloc_spec, template, vm_):
2356     if "snapshot" not in vm_:
2357         return None
2358     allowed_types = [
2359         FLATTEN_DISK_FULL_CLONE,
2360         COPY_ALL_DISKS_FULL_CLONE,
2361         CURRENT_STATE_LINKED_CLONE,
2362         QUICK_LINKED_CLONE,
2363     ]
2364     clone_spec = get_clonespec_for_valid_snapshot(
2365         config_spec, object_ref, reloc_spec, template, vm_
2366     )
2367     if not clone_spec:
2368         raise SaltCloudSystemExit(
2369             "Invalid disk move type specified supported types are {}".format(
2370                 " ".join(allowed_types)
2371             )
2372         )
2373     return clone_spec
2374 def get_clonespec_for_valid_snapshot(
2375     config_spec, object_ref, reloc_spec, template, vm_
2376 ):
2377     moving = True
2378     if QUICK_LINKED_CLONE == vm_["snapshot"]["disk_move_type"]:
2379         reloc_spec.diskMoveType = QUICK_LINKED_CLONE
2380     elif CURRENT_STATE_LINKED_CLONE == vm_["snapshot"]["disk_move_type"]:
2381         reloc_spec.diskMoveType = CURRENT_STATE_LINKED_CLONE
2382     elif COPY_ALL_DISKS_FULL_CLONE == vm_["snapshot"]["disk_move_type"]:
2383         reloc_spec.diskMoveType = COPY_ALL_DISKS_FULL_CLONE
2384     elif FLATTEN_DISK_FULL_CLONE == vm_["snapshot"]["disk_move_type"]:
2385         reloc_spec.diskMoveType = FLATTEN_DISK_FULL_CLONE
2386     else:
2387         moving = False
2388     if moving:
2389         return build_clonespec(config_spec, object_ref, reloc_spec, template)
2390     return None
2391 def build_clonespec(config_spec, object_ref, reloc_spec, template):
2392     if reloc_spec.diskMoveType == QUICK_LINKED_CLONE:
2393         return vim.vm.CloneSpec(
2394             template=template,
2395             location=reloc_spec,
2396             config=config_spec,
2397             snapshot=object_ref.snapshot.currentSnapshot,
2398         )
2399     return vim.vm.CloneSpec(template=template, location=reloc_spec, config=config_spec)
2400 def create_datacenter(kwargs=None, call=None):
2401     if call != "function":
2402         raise SaltCloudSystemExit(
2403             "The create_datacenter function must be called with -f or --function."
2404         )
2405     datacenter_name = kwargs.get("name") if kwargs and "name" in kwargs else None
2406     if not datacenter_name:
2407         raise SaltCloudSystemExit(
2408             "You must specify name of the new datacenter to be created."
2409         )
2410     if not datacenter_name or len(datacenter_name) &gt;= 80:
2411         raise SaltCloudSystemExit(
2412             "The datacenter name must be a non empty string of less than 80 characters."
2413         )
2414     si = _get_si()
2415     datacenter_ref = salt.utils.vmware.get_mor_by_property(
2416         si, vim.Datacenter, datacenter_name
2417     )
2418     if datacenter_ref:
2419         return {datacenter_name: "datacenter already exists"}
2420     folder = si.content.rootFolder
2421     if isinstance(folder, vim.Folder):
2422         try:
2423             folder.CreateDatacenter(name=datacenter_name)
2424         except Exception as exc:  # pylint: disable=broad-except
2425             log.error(
2426                 "Error creating datacenter %s: %s",
2427                 datacenter_name,
2428                 exc,
2429                 exc_info_on_loglevel=logging.DEBUG,
2430             )
2431             return False
2432         log.debug("Created datacenter %s", datacenter_name)
2433         return {datacenter_name: "created"}
2434     return False
2435 def create_cluster(kwargs=None, call=None):
2436     if call != "function":
2437         raise SaltCloudSystemExit(
2438             "The create_cluster function must be called with -f or --function."
2439         )
2440     cluster_name = kwargs.get("name") if kwargs and "name" in kwargs else None
2441     datacenter = kwargs.get("datacenter") if kwargs and "datacenter" in kwargs else None
2442     if not cluster_name:
2443         raise SaltCloudSystemExit(
2444             "You must specify name of the new cluster to be created."
2445         )
2446     if not datacenter:
2447         raise SaltCloudSystemExit(
2448             "You must specify name of the datacenter where the cluster should be"
2449             " created."
2450         )
2451     si = _get_si()
2452     if not isinstance(datacenter, vim.Datacenter):
2453         datacenter = salt.utils.vmware.get_mor_by_property(
2454             si, vim.Datacenter, datacenter
2455         )
2456         if not datacenter:
2457             raise SaltCloudSystemExit("The specified datacenter does not exist.")
2458     cluster_ref = salt.utils.vmware.get_mor_by_property(
2459         si, vim.ClusterComputeResource, cluster_name
2460     )
2461     if cluster_ref:
2462         return {cluster_name: "cluster already exists"}
2463     cluster_spec = vim.cluster.ConfigSpecEx()
2464     folder = datacenter.hostFolder
2465     if isinstance(folder, vim.Folder):
2466         try:
2467             folder.CreateClusterEx(name=cluster_name, spec=cluster_spec)
2468         except Exception as exc:  # pylint: disable=broad-except
2469             log.error(
2470                 "Error creating cluster %s: %s",
2471                 cluster_name,
2472                 exc,
2473                 exc_info_on_loglevel=logging.DEBUG,
2474             )
2475             return False
2476         log.debug(
2477             "Created cluster %s under datacenter %s", cluster_name, datacenter.name
2478         )
2479         return {cluster_name: "created"}
2480     return False
2481 def rescan_hba(kwargs=None, call=None):
2482     if call != "function":
2483         raise SaltCloudSystemExit(
2484             "The rescan_hba function must be called with -f or --function."
2485         )
2486     hba = kwargs.get("hba") if kwargs and "hba" in kwargs else None
2487     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
2488     if not host_name:
2489         raise SaltCloudSystemExit("You must specify name of the host system.")
2490     host_ref = salt.utils.vmware.get_mor_by_property(
2491         _get_si(), vim.HostSystem, host_name
2492     )
2493     try:
2494         if hba:
2495             log.info("Rescanning HBA %s on host %s", hba, host_name)
2496             host_ref.configManager.storageSystem.RescanHba(hba)
2497             ret = "rescanned HBA {}".format(hba)
2498         else:
2499             log.info("Rescanning all HBAs on host %s", host_name)
2500             host_ref.configManager.storageSystem.RescanAllHba()
2501             ret = "rescanned all HBAs"
2502     except Exception as exc:  # pylint: disable=broad-except
2503         log.error(
2504             "Error while rescaning HBA on host %s: %s",
2505             host_name,
2506             exc,
2507             exc_info_on_loglevel=logging.DEBUG,
2508         )
2509         return {host_name: "failed to rescan HBA"}
2510     return {host_name: ret}
2511 def upgrade_tools_all(call=None):
2512     if call != "function":
2513         raise SaltCloudSystemExit(
2514             "The upgrade_tools_all function must be called with -f or --function."
2515         )
2516     ret = {}
2517     vm_properties = ["name"]
2518     vm_list = salt.utils.vmware.get_mors_with_properties(
2519         _get_si(), vim.VirtualMachine, vm_properties
2520     )
2521     for vm in vm_list:
2522         ret[vm["name"]] = _upg_tools_helper(vm["object"])
2523     return ret
2524 def upgrade_tools(name, reboot=False, call=None):
2525     if call != "action":
2526         raise SaltCloudSystemExit(
2527             "The upgrade_tools action must be called with -a or --action."
2528         )
2529     vm_ref = salt.utils.vmware.get_mor_by_property(_get_si(), vim.VirtualMachine, name)
2530     return _upg_tools_helper(vm_ref, reboot)
2531 def list_hosts_by_cluster(kwargs=None, call=None):
2532     if call != "function":
2533         raise SaltCloudSystemExit(
2534             "The list_hosts_by_cluster function must be called with -f or --function."
2535         )
2536     ret = {}
2537     cluster_name = kwargs.get("cluster") if kwargs and "cluster" in kwargs else None
2538     cluster_properties = ["name"]
2539     cluster_list = salt.utils.vmware.get_mors_with_properties(
2540         _get_si(), vim.ClusterComputeResource, cluster_properties
2541     )
2542     for cluster in cluster_list:
2543         ret[cluster["name"]] = []
2544         for host in cluster["object"].host:
2545             if isinstance(host, vim.HostSystem):
2546                 ret[cluster["name"]].append(host.name)
2547         if cluster_name and cluster_name == cluster["name"]:
2548             return {"Hosts by Cluster": {cluster_name: ret[cluster_name]}}
2549     return {"Hosts by Cluster": ret}
2550 def list_clusters_by_datacenter(kwargs=None, call=None):
2551     if call != "function":
2552         raise SaltCloudSystemExit(
2553             "The list_clusters_by_datacenter function must be called with "
2554             "-f or --function."
2555         )
2556     ret = {}
2557     datacenter_name = (
2558         kwargs.get("datacenter") if kwargs and "datacenter" in kwargs else None
2559     )
2560     datacenter_properties = ["name"]
2561     datacenter_list = salt.utils.vmware.get_mors_with_properties(
2562         _get_si(), vim.Datacenter, datacenter_properties
2563     )
2564     for datacenter in datacenter_list:
2565         ret[datacenter["name"]] = []
2566         for cluster in datacenter["object"].hostFolder.childEntity:
2567             if isinstance(cluster, vim.ClusterComputeResource):
2568                 ret[datacenter["name"]].append(cluster.name)
2569         if datacenter_name and datacenter_name == datacenter["name"]:
2570             return {"Clusters by Datacenter": {datacenter_name: ret[datacenter_name]}}
2571     return {"Clusters by Datacenter": ret}
2572 def list_hosts_by_datacenter(kwargs=None, call=None):
2573     if call != "function":
2574         raise SaltCloudSystemExit(
2575             "The list_hosts_by_datacenter function must be called with "
2576             "-f or --function."
2577         )
2578     ret = {}
2579     datacenter_name = (
2580         kwargs.get("datacenter") if kwargs and "datacenter" in kwargs else None
2581     )
2582     datacenter_properties = ["name"]
2583     datacenter_list = salt.utils.vmware.get_mors_with_properties(
2584         _get_si(), vim.Datacenter, datacenter_properties
2585     )
2586     for datacenter in datacenter_list:
2587         ret[datacenter["name"]] = []
2588         for cluster in datacenter["object"].hostFolder.childEntity:
2589             if isinstance(cluster, vim.ClusterComputeResource):
2590                 for host in cluster.host:
2591                     if isinstance(host, vim.HostSystem):
2592                         ret[datacenter["name"]].append(host.name)
2593         if datacenter_name and datacenter_name == datacenter["name"]:
2594             return {"Hosts by Datacenter": {datacenter_name: ret[datacenter_name]}}
2595     return {"Hosts by Datacenter": ret}
2596 def list_hbas(kwargs=None, call=None):
2597     if call != "function":
2598         raise SaltCloudSystemExit(
2599             "The list_hbas function must be called with -f or --function."
2600         )
2601     ret = {}
2602     hba_type = kwargs.get("type").lower() if kwargs and "type" in kwargs else None
2603     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
2604     host_properties = ["name", "config.storageDevice.hostBusAdapter"]
2605     if hba_type and hba_type not in ["parallel", "block", "iscsi", "fibre"]:
2606         raise SaltCloudSystemExit(
2607             "Specified hba type {} currently not supported.".format(hba_type)
2608         )
2609     host_list = salt.utils.vmware.get_mors_with_properties(
2610         _get_si(), vim.HostSystem, host_properties
2611     )
2612     for host in host_list:
2613         ret[host["name"]] = {}
2614         for hba in host["config.storageDevice.hostBusAdapter"]:
2615             hba_spec = {
2616                 "driver": hba.driver,
2617                 "status": hba.status,
2618                 "type": type(hba).__name__.rsplit(".", 1)[1],
2619             }
2620             if hba_type:
2621                 if isinstance(hba, _get_hba_type(hba_type)):
2622                     if hba.model in ret[host["name"]]:
2623                         ret[host["name"]][hba.model][hba.device] = hba_spec
2624                     else:
2625                         ret[host["name"]][hba.model] = {hba.device: hba_spec}
2626             else:
2627                 if hba.model in ret[host["name"]]:
2628                     ret[host["name"]][hba.model][hba.device] = hba_spec
2629                 else:
2630                     ret[host["name"]][hba.model] = {hba.device: hba_spec}
2631         if host["name"] == host_name:
2632             return {"HBAs by Host": {host_name: ret[host_name]}}
2633     return {"HBAs by Host": ret}
2634 def list_dvs(kwargs=None, call=None):
2635     if call != "function":
2636         raise SaltCloudSystemExit(
2637             "The list_dvs function must be called with -f or --function."
2638         )
2639     return {"Distributed Virtual Switches": salt.utils.vmware.list_dvs(_get_si())}
2640 def list_vapps(kwargs=None, call=None):
2641     if call != "function":
2642         raise SaltCloudSystemExit(
2643             "The list_vapps function must be called with -f or --function."
2644         )
2645     return {"vApps": salt.utils.vmware.list_vapps(_get_si())}
2646 def enter_maintenance_mode(kwargs=None, call=None):
2647     if call != "function":
2648         raise SaltCloudSystemExit(
2649             "The enter_maintenance_mode function must be called with -f or --function."
2650         )
2651     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
2652     host_ref = salt.utils.vmware.get_mor_by_property(
2653         _get_si(), vim.HostSystem, host_name
2654     )
2655     if not host_name or not host_ref:
2656         raise SaltCloudSystemExit("You must specify a valid name of the host system.")
2657     if host_ref.runtime.inMaintenanceMode:
2658         return {host_name: "already in maintenance mode"}
2659     try:
2660         task = host_ref.EnterMaintenanceMode(timeout=0, evacuatePoweredOffVms=True)
2661         salt.utils.vmware.wait_for_task(task, host_name, "enter maintenance mode")
2662     except Exception as exc:  # pylint: disable=broad-except
2663         log.error(
2664             "Error while moving host system %s in maintenance mode: %s",
2665             host_name,
2666             exc,
2667             exc_info_on_loglevel=logging.DEBUG,
2668         )
2669         return {host_name: "failed to enter maintenance mode"}
2670     return {host_name: "entered maintenance mode"}
2671 def exit_maintenance_mode(kwargs=None, call=None):
2672     if call != "function":
2673         raise SaltCloudSystemExit(
2674             "The exit_maintenance_mode function must be called with -f or --function."
2675         )
2676     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
2677     host_ref = salt.utils.vmware.get_mor_by_property(
2678         _get_si(), vim.HostSystem, host_name
2679     )
2680     if not host_name or not host_ref:
2681         raise SaltCloudSystemExit("You must specify a valid name of the host system.")
2682     if not host_ref.runtime.inMaintenanceMode:
2683         return {host_name: "already not in maintenance mode"}
2684     try:
2685         task = host_ref.ExitMaintenanceMode(timeout=0)
2686         salt.utils.vmware.wait_for_task(task, host_name, "exit maintenance mode")
2687     except Exception as exc:  # pylint: disable=broad-except
2688         log.error(
2689             "Error while moving host system %s out of maintenance mode: %s",
2690             host_name,
2691             exc,
2692             exc_info_on_loglevel=logging.DEBUG,
2693         )
2694         return {host_name: "failed to exit maintenance mode"}
2695     return {host_name: "exited maintenance mode"}
2696 def create_folder(kwargs=None, call=None):
2697     if call != "function":
2698         raise SaltCloudSystemExit(
2699             "The create_folder function must be called with -f or --function."
2700         )
2701     si = _get_si()
2702     folder_path = kwargs.get("path") if kwargs and "path" in kwargs else None
2703     if not folder_path:
2704         raise SaltCloudSystemExit("You must specify a non empty folder path.")
2705     folder_refs = []
2706     inventory_path = "/"
2707     path_exists = True
2708     for index, folder_name in enumerate(
2709         os.path.normpath(folder_path.strip("/")).split("/")
2710     ):
2711         inventory_path = os.path.join(inventory_path, folder_name)
2712         folder_ref = si.content.searchIndex.FindByInventoryPath(
2713             inventoryPath=inventory_path
2714         )
2715         if isinstance(folder_ref, vim.Folder):
2716             log.debug("Path %s/ exists in the inventory", inventory_path)
2717             folder_refs.append(folder_ref)
2718         elif isinstance(folder_ref, vim.Datacenter):
2719             log.debug("Path %s/ exists in the inventory", inventory_path)
2720             folder_refs.append(folder_ref)
2721         else:
2722             path_exists = False
2723             if not folder_refs:
2724                 log.debug(
2725                     "Creating folder %s under rootFolder in the inventory", folder_name
2726                 )
2727                 folder_refs.append(si.content.rootFolder.CreateFolder(folder_name))
2728             else:
2729                 log.debug("Creating path %s/ in the inventory", inventory_path)
2730                 folder_refs.append(folder_refs[index - 1].CreateFolder(folder_name))
2731     if path_exists:
2732         return {inventory_path: "specified path already exists"}
2733     return {inventory_path: "created the specified path"}
2734 def create_snapshot(name, kwargs=None, call=None):
2735     if call != "action":
2736         raise SaltCloudSystemExit(
2737             "The create_snapshot action must be called with -a or --action."
2738         )
2739     if kwargs is None:
2740         kwargs = {}
2741     snapshot_name = (
2742         kwargs.get("snapshot_name") if kwargs and "snapshot_name" in kwargs else None
2743     )
2744     if not snapshot_name:
2745         raise SaltCloudSystemExit(
2746             "You must specify snapshot name for the snapshot to be created."
2747         )
2748     memdump = _str_to_bool(kwargs.get("memdump", True))
2749     quiesce = _str_to_bool(kwargs.get("quiesce", False))
2750     vm_ref = salt.utils.vmware.get_mor_by_property(_get_si(), vim.VirtualMachine, name)
2751     if vm_ref.summary.runtime.powerState != "poweredOn":
2752         log.debug(
2753             "VM %s is not powered on. Setting both memdump and quiesce to False", name
2754         )
2755         memdump = False
2756         quiesce = False
2757     if memdump and quiesce:
2758         log.warning(
2759             "You can only set either memdump or quiesce to True. Setting quiesce=False"
2760         )
2761         quiesce = False
2762     desc = kwargs.get("description") if "description" in kwargs else ""
2763     try:
2764         task = vm_ref.CreateSnapshot(snapshot_name, desc, memdump, quiesce)
2765         salt.utils.vmware.wait_for_task(task, name, "create snapshot", 5, "info")
2766     except Exception as exc:  # pylint: disable=broad-except
2767         log.error(
2768             "Error while creating snapshot of %s: %s",
2769             name,
2770             exc,
2771             exc_info_on_loglevel=logging.DEBUG,
2772         )
2773         return "failed to create snapshot"
2774     return {
2775         "Snapshot created successfully": _get_snapshots(
2776             vm_ref.snapshot.rootSnapshotList, vm_ref.snapshot.currentSnapshot
2777         )
2778     }
2779 def revert_to_snapshot(name, kwargs=None, call=None):
2780     if call != "action":
2781         raise SaltCloudSystemExit(
2782             "The revert_to_snapshot action must be called with -a or --action."
2783         )
2784     if kwargs is None:
2785         kwargs = {}
2786     snapshot_name = (
2787         kwargs.get("snapshot_name") if kwargs and "snapshot_name" in kwargs else None
2788     )
2789     suppress_power_on = _str_to_bool(kwargs.get("power_off", False))
2790     vm_ref = salt.utils.vmware.get_mor_by_property(_get_si(), vim.VirtualMachine, name)
2791     if not vm_ref.rootSnapshot:
2792         log.error("VM %s does not contain any current snapshots", name)
2793         return "revert failed"
2794     msg = "reverted to current snapshot"
2795     try:
2796         if snapshot_name is None:
2797             log.debug("Reverting VM %s to current snapshot", name)
2798             task = vm_ref.RevertToCurrentSnapshot(suppressPowerOn=suppress_power_on)
2799         else:
2800             log.debug("Reverting VM %s to snapshot %s", name, snapshot_name)
2801             msg = "reverted to snapshot {}".format(snapshot_name)
2802             snapshot_ref = _get_snapshot_ref_by_name(vm_ref, snapshot_name)
2803             if snapshot_ref is None:
2804                 return "specified snapshot '{}' does not exist".format(snapshot_name)
2805             task = snapshot_ref.snapshot.Revert(suppressPowerOn=suppress_power_on)
2806         salt.utils.vmware.wait_for_task(task, name, "revert to snapshot", 5, "info")
2807     except Exception as exc:  # pylint: disable=broad-except
2808         log.error(
2809             "Error while reverting VM %s to snapshot: %s",
2810             name,
2811             exc,
2812             exc_info_on_loglevel=logging.DEBUG,
2813         )
2814         return "revert failed"
2815     return msg
2816 def remove_snapshot(name, kwargs=None, call=None):
2817     if call != "action":
2818         raise SaltCloudSystemExit(
2819             "The create_snapshot action must be called with -a or --action."
2820         )
2821     if kwargs is None:
2822         kwargs = {}
2823     snapshot_name = (
2824         kwargs.get("snapshot_name") if kwargs and "snapshot_name" in kwargs else None
2825     )
2826     remove_children = _str_to_bool(kwargs.get("remove_children", False))
2827     if not snapshot_name:
2828         raise SaltCloudSystemExit(
2829             "You must specify snapshot name for the snapshot to be deleted."
2830         )
2831     vm_ref = salt.utils.vmware.get_mor_by_property(_get_si(), vim.VirtualMachine, name)
2832     if not _get_snapshot_ref_by_name(vm_ref, snapshot_name):
2833         raise SaltCloudSystemExit(
2834             "Сould not find the snapshot with the specified name."
2835         )
2836     try:
2837         snap_obj = _get_snapshot_ref_by_name(vm_ref, snapshot_name).snapshot
2838         task = snap_obj.RemoveSnapshot_Task(remove_children)
2839         salt.utils.vmware.wait_for_task(task, name, "remove snapshot", 5, "info")
2840     except Exception as exc:  # pylint: disable=broad-except
2841         log.error(
2842             "Error while removing snapshot of %s: %s",
2843             name,
2844             exc,
2845             exc_info_on_loglevel=logging.DEBUG,
2846         )
2847         return "failed to remove snapshot"
2848     if vm_ref.snapshot:
2849         return {
2850             "Snapshot removed successfully": _get_snapshots(
2851                 vm_ref.snapshot.rootSnapshotList, vm_ref.snapshot.currentSnapshot
2852             )
2853         }
2854     return "Snapshots removed successfully"
2855 def remove_all_snapshots(name, kwargs=None, call=None):
2856     if call != "action":
2857         raise SaltCloudSystemExit(
2858             "The remove_all_snapshots action must be called with -a or --action."
2859         )
2860     vm_ref = salt.utils.vmware.get_mor_by_property(_get_si(), vim.VirtualMachine, name)
2861     try:
2862         task = vm_ref.RemoveAllSnapshots()
2863         salt.utils.vmware.wait_for_task(task, name, "remove snapshots", 5, "info")
2864     except Exception as exc:  # pylint: disable=broad-except
2865         log.error(
2866             "Error while removing snapshots on VM %s: %s",
2867             name,
2868             exc,
2869             exc_info_on_loglevel=logging.DEBUG,
2870         )
2871         return "Failed to remove snapshots"
2872     return "Removed all snapshots"
2873 def convert_to_template(name, kwargs=None, call=None):
2874     if call != "action":
2875         raise SaltCloudSystemExit(
2876             "The convert_to_template action must be called with -a or --action."
2877         )
2878     vm_ref = salt.utils.vmware.get_mor_by_property(_get_si(), vim.VirtualMachine, name)
2879     if vm_ref.config.template:
2880         raise SaltCloudSystemExit("{} already a template".format(name))
2881     try:
2882         vm_ref.MarkAsTemplate()
2883     except Exception as exc:  # pylint: disable=broad-except
2884         log.error(
2885             "Error while converting VM to template %s: %s",
2886             name,
2887             exc,
2888             exc_info_on_loglevel=logging.DEBUG,
2889         )
2890         return "failed to convert to teamplate"
2891     return "{} converted to template".format(name)
2892 def add_host(kwargs=None, call=None):
2893     if call != "function":
2894         raise SaltCloudSystemExit(
2895             "The add_host function must be called with -f or --function."
2896         )
2897     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
2898     cluster_name = kwargs.get("cluster") if kwargs and "cluster" in kwargs else None
2899     datacenter_name = (
2900         kwargs.get("datacenter") if kwargs and "datacenter" in kwargs else None
2901     )
2902     host_user = config.get_cloud_config_value(
2903         "esxi_host_user", get_configured_provider(), __opts__, search_global=False
2904     )
2905     host_password = config.get_cloud_config_value(
2906         "esxi_host_password", get_configured_provider(), __opts__, search_global=False
2907     )
2908     host_ssl_thumbprint = config.get_cloud_config_value(
2909         "esxi_host_ssl_thumbprint",
2910         get_configured_provider(),
2911         __opts__,
2912         search_global=False,
2913     )
2914     if not host_user:
2915         raise SaltCloudSystemExit(
2916             "You must specify the ESXi host username in your providers config."
2917         )
2918     if not host_password:
2919         raise SaltCloudSystemExit(
2920             "You must specify the ESXi host password in your providers config."
2921         )
2922     if not host_name:
2923         raise SaltCloudSystemExit(
2924             "You must specify either the IP or DNS name of the host system."
2925         )
2926     if (cluster_name and datacenter_name) or not (cluster_name or datacenter_name):
2927         raise SaltCloudSystemExit(
2928             "You must specify either the cluster name or the datacenter name."
2929         )
2930     si = _get_si()
2931     if cluster_name:
2932         cluster_ref = salt.utils.vmware.get_mor_by_property(
2933             si, vim.ClusterComputeResource, cluster_name
2934         )
2935         if not cluster_ref:
2936             raise SaltCloudSystemExit("Specified cluster does not exist.")
2937     if datacenter_name:
2938         datacenter_ref = salt.utils.vmware.get_mor_by_property(
2939             si, vim.Datacenter, datacenter_name
2940         )
2941         if not datacenter_ref:
2942             raise SaltCloudSystemExit("Specified datacenter does not exist.")
2943     spec = vim.host.ConnectSpec(
2944         hostName=host_name,
2945         userName=host_user,
2946         password=host_password,
2947     )
2948     if host_ssl_thumbprint:
2949         spec.sslThumbprint = host_ssl_thumbprint
2950     else:
2951         log.warning("SSL thumbprint has not been specified in provider configuration")
2952         try:
2953             log.debug("Trying to get the SSL thumbprint directly from the host system")
2954             p1 = subprocess.Popen(
2955                 ("echo", "-n"), stdout=subprocess.PIPE, stderr=subprocess.PIPE
2956             )
2957             p2 = subprocess.Popen(
2958                 ("openssl", "s_client", "-connect", "{}:443".format(host_name)),
2959                 stdin=p1.stdout,
2960                 stdout=subprocess.PIPE,
2961                 stderr=subprocess.PIPE,
2962             )
2963             p3 = subprocess.Popen(
2964                 ("openssl", "x509", "-noout", "-fingerprint", "-sha1"),
2965                 stdin=p2.stdout,
2966                 stdout=subprocess.PIPE,
2967                 stderr=subprocess.PIPE,
2968             )
2969             out = salt.utils.stringutils.to_str(p3.stdout.read())
2970             ssl_thumbprint = out.split("=")[-1].strip()
2971             log.debug(
2972                 "SSL thumbprint received from the host system: %s", ssl_thumbprint
2973             )
2974             spec.sslThumbprint = ssl_thumbprint
2975         except Exception as exc:  # pylint: disable=broad-except
2976             log.error(
2977                 "Error while trying to get SSL thumbprint of host %s: %s",
2978                 host_name,
2979                 exc,
2980                 exc_info_on_loglevel=logging.DEBUG,
2981             )
2982             return {host_name: "failed to add host"}
2983     try:
2984         if cluster_name:
2985             task = cluster_ref.AddHost(spec=spec, asConnected=True)
2986             ret = "added host system to cluster {}".format(cluster_name)
2987         if datacenter_name:
2988             task = datacenter_ref.hostFolder.AddStandaloneHost(
2989                 spec=spec, addConnected=True
2990             )
2991             ret = "added host system to datacenter {}".format(datacenter_name)
2992         salt.utils.vmware.wait_for_task(task, host_name, "add host system", 5, "info")
2993     except Exception as exc:  # pylint: disable=broad-except
2994         if isinstance(exc, vim.fault.SSLVerifyFault):
2995             log.error("Authenticity of the host's SSL certificate is not verified")
2996             log.info(
2997                 "Try again after setting the esxi_host_ssl_thumbprint "
2998                 "to %s in provider configuration",
2999                 spec.sslThumbprint,
3000             )
3001         log.error(
3002             "Error while adding host %s: %s",
3003             host_name,
3004             exc,
3005             exc_info_on_loglevel=logging.DEBUG,
3006         )
3007         return {host_name: "failed to add host"}
3008     return {host_name: ret}
3009 def remove_host(kwargs=None, call=None):
3010     if call != "function":
3011         raise SaltCloudSystemExit(
3012             "The remove_host function must be called with -f or --function."
3013         )
3014     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
3015     if not host_name:
3016         raise SaltCloudSystemExit("You must specify name of the host system.")
3017     si = _get_si()
3018     host_ref = salt.utils.vmware.get_mor_by_property(si, vim.HostSystem, host_name)
3019     if not host_ref:
3020         raise SaltCloudSystemExit("Specified host system does not exist.")
3021     try:
3022         if isinstance(host_ref.parent, vim.ClusterComputeResource):
3023             task = host_ref.Destroy_Task()
3024         else:
3025             task = host_ref.parent.Destroy_Task()
3026         salt.utils.vmware.wait_for_task(
3027             task, host_name, "remove host", log_level="info"
3028         )
3029     except Exception as exc:  # pylint: disable=broad-except
3030         log.error(
3031             "Error while removing host %s: %s",
3032             host_name,
3033             exc,
3034             exc_info_on_loglevel=logging.DEBUG,
3035         )
3036         return {host_name: "failed to remove host"}
3037     return {host_name: "removed host from vcenter"}
3038 def connect_host(kwargs=None, call=None):
3039     if call != "function":
3040         raise SaltCloudSystemExit(
3041             "The connect_host function must be called with -f or --function."
3042         )
3043     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
3044     if not host_name:
3045         raise SaltCloudSystemExit("You must specify name of the host system.")
3046     si = _get_si()
3047     host_ref = salt.utils.vmware.get_mor_by_property(si, vim.HostSystem, host_name)
3048     if not host_ref:
3049         raise SaltCloudSystemExit("Specified host system does not exist.")
3050     if host_ref.runtime.connectionState == "connected":
3051         return {host_name: "host system already connected"}
3052     try:
3053         task = host_ref.ReconnectHost_Task()
3054         salt.utils.vmware.wait_for_task(task, host_name, "connect host", 5, "info")
3055     except Exception as exc:  # pylint: disable=broad-except
3056         log.error(
3057             "Error while connecting host %s: %s",
3058             host_name,
3059             exc,
3060             exc_info_on_loglevel=logging.DEBUG,
3061         )
3062         return {host_name: "failed to connect host"}
3063     return {host_name: "connected host"}
3064 def disconnect_host(kwargs=None, call=None):
3065     if call != "function":
3066         raise SaltCloudSystemExit(
3067             "The disconnect_host function must be called with -f or --function."
3068         )
3069     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
3070     if not host_name:
3071         raise SaltCloudSystemExit("You must specify name of the host system.")
3072     si = _get_si()
3073     host_ref = salt.utils.vmware.get_mor_by_property(si, vim.HostSystem, host_name)
3074     if not host_ref:
3075         raise SaltCloudSystemExit("Specified host system does not exist.")
3076     if host_ref.runtime.connectionState == "disconnected":
3077         return {host_name: "host system already disconnected"}
3078     try:
3079         task = host_ref.DisconnectHost_Task()
3080         salt.utils.vmware.wait_for_task(
3081             task, host_name, "disconnect host", log_level="info"
3082         )
3083     except Exception as exc:  # pylint: disable=broad-except
3084         log.error(
3085             "Error while disconnecting host %s: %s",
3086             host_name,
3087             exc,
3088             exc_info_on_loglevel=logging.DEBUG,
3089         )
3090         return {host_name: "failed to disconnect host"}
3091     return {host_name: "disconnected host"}
3092 def reboot_host(kwargs=None, call=None):
3093     if call != "function":
3094         raise SaltCloudSystemExit(
3095             "The reboot_host function must be called with -f or --function."
3096         )
3097     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
3098     force = _str_to_bool(kwargs.get("force")) if kwargs and "force" in kwargs else False
3099     if not host_name:
3100         raise SaltCloudSystemExit("You must specify name of the host system.")
3101     si = _get_si()
3102     host_ref = salt.utils.vmware.get_mor_by_property(si, vim.HostSystem, host_name)
3103     if not host_ref:
3104         raise SaltCloudSystemExit("Specified host system does not exist.")
3105     if host_ref.runtime.connectionState == "notResponding":
3106         raise SaltCloudSystemExit(
3107             "Specified host system cannot be rebooted in it's current state (not"
3108             " responding)."
3109         )
3110     if not host_ref.capability.rebootSupported:
3111         raise SaltCloudSystemExit("Specified host system does not support reboot.")
3112     if not host_ref.runtime.inMaintenanceMode and not force:
3113         raise SaltCloudSystemExit(
3114             "Specified host system is not in maintenance mode. Specify force=True to"
3115             " force reboot even if there are virtual machines running or other"
3116             " operations in progress."
3117         )
3118     try:
3119         host_ref.RebootHost_Task(force)
3120         _wait_for_host(host_ref, "reboot", 10, "info")
3121     except Exception as exc:  # pylint: disable=broad-except
3122         log.error(
3123             "Error while rebooting host %s: %s",
3124             host_name,
3125             exc,
3126             exc_info_on_loglevel=logging.DEBUG,
3127         )
3128         return {host_name: "failed to reboot host"}
3129     return {host_name: "rebooted host"}
3130 def create_datastore_cluster(kwargs=None, call=None):
3131     if call != "function":
3132         raise SaltCloudSystemExit(
3133             "The create_datastore_cluster function must be called with "
3134             "-f or --function."
3135         )
3136     datastore_cluster_name = kwargs.get("name") if kwargs and "name" in kwargs else None
3137     datacenter_name = (
3138         kwargs.get("datacenter") if kwargs and "datacenter" in kwargs else None
3139     )
3140     if not datastore_cluster_name:
3141         raise SaltCloudSystemExit(
3142             "You must specify name of the new datastore cluster to be created."
3143         )
3144     if not datastore_cluster_name or len(datastore_cluster_name) &gt;= 80:
3145         raise SaltCloudSystemExit(
3146             "The datastore cluster name must be a non empty string of less than 80"
3147             " characters."
3148         )
3149     if not datacenter_name:
3150         raise SaltCloudSystemExit(
3151             "You must specify name of the datacenter where the datastore cluster should"
3152             " be created."
3153         )
3154     si = _get_si()
3155     datastore_cluster_ref = salt.utils.vmware.get_mor_by_property(
3156         si, vim.StoragePod, datastore_cluster_name
3157     )
3158     if datastore_cluster_ref:
3159         return {datastore_cluster_name: "datastore cluster already exists"}
3160     datacenter_ref = salt.utils.vmware.get_mor_by_property(
3161         si, vim.Datacenter, datacenter_name
3162     )
3163     if not datacenter_ref:
3164         raise SaltCloudSystemExit("The specified datacenter does not exist.")
3165     try:
3166         datacenter_ref.datastoreFolder.CreateStoragePod(name=datastore_cluster_name)
3167     except Exception as exc:  # pylint: disable=broad-except
3168         log.error(
3169             "Error creating datastore cluster %s: %s",
3170             datastore_cluster_name,
3171             exc,
3172             exc_info_on_loglevel=logging.DEBUG,
3173         )
3174         return False
3175     return {datastore_cluster_name: "created"}
3176 def shutdown_host(kwargs=None, call=None):
3177     if call != "function":
3178         raise SaltCloudSystemExit(
3179             "The shutdown_host function must be called with -f or --function."
3180         )
3181     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
3182     force = _str_to_bool(kwargs.get("force")) if kwargs and "force" in kwargs else False
3183     if not host_name:
3184         raise SaltCloudSystemExit("You must specify name of the host system.")
3185     si = _get_si()
3186     host_ref = salt.utils.vmware.get_mor_by_property(si, vim.HostSystem, host_name)
3187     if not host_ref:
3188         raise SaltCloudSystemExit("Specified host system does not exist.")
3189     if host_ref.runtime.connectionState == "notResponding":
3190         raise SaltCloudSystemExit(
3191             "Specified host system cannot be shut down in it's current state (not"
3192             " responding)."
3193         )
3194     if not host_ref.capability.rebootSupported:
3195         raise SaltCloudSystemExit("Specified host system does not support shutdown.")
3196     if not host_ref.runtime.inMaintenanceMode and not force:
3197         raise SaltCloudSystemExit(
3198             "Specified host system is not in maintenance mode. Specify force=True to"
3199             " force reboot even if there are virtual machines running or other"
3200             " operations in progress."
3201         )
3202     try:
3203         host_ref.ShutdownHost_Task(force)
3204     except Exception as exc:  # pylint: disable=broad-except
3205         log.error(
3206             "Error while shutting down host %s: %s",
3207             host_name,
3208             exc,
3209             exc_info_on_loglevel=logging.DEBUG,
3210         )
3211         return {host_name: "failed to shut down host"}
3212     return {host_name: "shut down host"}
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
