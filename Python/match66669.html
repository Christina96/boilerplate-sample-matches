<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for digitalocean.py &amp; vmware.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for digitalocean.py &amp; vmware.py
      </h3>
<h1 align="center">
        4.7%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>digitalocean.py (11.10414%)<th>vmware.py (2.9888551%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(269-300)<td><a href="#" name="0">(2715-2755)</a><td align="center"><font color="#ff0000">29</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(62-86)<td><a href="#" name="1">(167-191)</a><td align="center"><font color="#d30000">24</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(906-917)<td><a href="#" name="2">(2702-2712)</a><td align="center"><font color="#af0000">20</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(851-878)<td><a href="#" name="3">(2636-2665)</a><td align="center"><font color="#9e0000">18</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(27-52)<td><a href="#" name="4">(119-138)</a><td align="center"><font color="#950000">17</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(1022-1026)<td><a href="#" name="5">(593-598)</a><td align="center"><font color="#8c0000">16</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(584-598)<td><a href="#" name="6">(3365-3378)</a><td align="center"><font color="#8c0000">16</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(491-497)<td><a href="#" name="7">(3005-3013)</a><td align="center"><font color="#720000">13</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(427-429)<td><a href="#" name="8">(3224-3226)</a><td align="center"><font color="#690000">12</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(117-134)<td><a href="#" name="9">(2070-2102)</a><td align="center"><font color="#690000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>digitalocean.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import decimal
2 import logging
3 import os
4 import pprint
5 import time
6 import salt.config as config
7 import salt.utils.cloud
8 import salt.utils.files
9 import salt.utils.json
10 import salt.utils.stringutils
11 from salt.exceptions import (
12     SaltCloudConfigError,
13     SaltCloudExecutionFailure,
14     SaltCloudExecutionTimeout,
15     SaltCloudNotFound,
16     SaltCloudSystemExit,
17     SaltInvocationError,
18 )
19 try:
20     import requests
21     HAS_REQUESTS = True
22 except ImportError:
23     HAS_REQUESTS =</b></font> False
24 log = logging.getLogger(__name__)
25 __virtualname__ = "digitalocean"
26 __virtual_aliases__ = ("digital_ocean", "do")
27 <a name="1"></a>
28 <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>def __virtual__():
29     if get_configured_provider() is False:
30         return False
31     if get_dependencies() is False:
32         return False
33     return __virtualname__
34 def _get_active_provider_name():
35     try:
36         return __active_provider_name__.value()
37     except AttributeError:
38         return __active_provider_name__
39 def get_configured_provider():
40     return config.is_provider_configured(</b></font>
41         opts=__opts__,
42         provider=_get_active_provider_name() or __virtualname__,
43         aliases=__virtual_aliases__,
44         required_keys=("personal_access_token",),
45     )
46 def get_dependencies():
47     return config.check_driver_dependencies(__virtualname__, {"requests": HAS_REQUESTS})
48 def avail_locations(call=None):
49     if call == "action":
50         raise SaltCloudSystemExit(
51             "The avail_locations function must be called with "
52             "-f or --function, or with the --list-locations option"
53         )
54     items = query(method="regions")
55     ret = {}
56 <a name="9"></a>    for region in items["regions"]:
57         ret[region["name"]] = {}
58         for item in region.keys():
59             ret[region["name"]][item] = str(region[i<font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>tem])
60     return ret
61 def avail_images(call=None):
62     if call == "action":
63         raise SaltCloudSystemExit(
64             "The avail_images function must be called with "
65             "-f or --function, or with the --list-images option"
66         )
67     fetch = True
68     page = 1
69     ret =</b></font> {}
70     while fetch:
71         items = query(method="images", command="?page=" + str(page) + "&amp;per_page=200")
72         for image in items["images"]:
73             ret[image["name"]] = {}
74             for item in image.keys():
75                 ret[image["name"]][item] = image[item]
76         page += 1
77         try:
78             fetch = "next" in items["links"]["pages"]
79         except KeyError:
80             fetch = False
81     return ret
82 def avail_sizes(call=None):
83     if call == "action":
84         raise SaltCloudSystemExit(
85             "The avail_sizes function must be called with "
86             "-f or --function, or with the --list-sizes option"
87         )
88     items = query(method="sizes", command="?per_page=100")
89     ret = {}
90     for size in items["sizes"]:
91         ret[size["slug"]] = {}
92         for item in size.keys():
93             ret[size["slug"]][item] = str(size[item])
94     return ret
95 def list_nodes(call=None):
96     if call == "action":
97         raise SaltCloudSystemExit(
98             "The list_nodes function must be called with -f or --function."
99         )
100     return _list_nodes()
101 def list_nodes_full(call=None, for_output=True):
102     if call == "action":
103         raise SaltCloudSystemExit(
104             "The list_nodes_full function must be called with -f or --function."
105         )
106     return _list_nodes(full=True, for_output=for_output)
107 def list_nodes_select(call=None):
108     return salt.utils.cloud.list_nodes_select(
109         list_nodes_full("function"),
110         __opts__["query.selection"],
111         call,
112     )
113 def get_image(vm_):
114     images = avail_images()
115     vm_image = config.get_cloud_config_value(
116         "image", vm_, __opts__, search_global=False
117     )
118     if not isinstance(vm_image, str):
119         vm_image = str(vm_image)
120     for image in images:
121         if vm_image in (
122             images[image]["name"],
123             images[image]["slug"],
124             images[image]["id"],
125         ):
126             if images[image]["slug"] is not None:
127                 return images[image]["slug"]
128             return int(images[image]["id"])
129     raise SaltCloudNotFound(
130         "The specified image, '{}', could not be found.".format(vm_image)
131     )
132 def get_size(vm_):
133     sizes = avail_sizes()
134     vm_size = str(
135         config.get_cloud_config_value("size", vm_, __opts__, search_global=False)
136     )
137     for size in sizes:
138         if vm_size.lower() == sizes[size]["slug"]:
139             return sizes[size]["slug"]
140     raise SaltCloudNotFound(
141         "The specified size, '{}', could not be found.".format(vm_size)
142     )
143 def get_location(vm_):
144     locations = avail_locations()
145     vm_location = str(
146         config.get_cloud_config_value("location", vm_, __opts__, search_global=False)
147     )
148     for location in locations:
149         if vm_location in (locations[location]["name"], locations[location]["slug"]):
150             return locations[location]["slug"]
151     raise SaltCloudNotFound(
152         "The specified location, '{}', could not be found.".format(vm_location)
153     )
154 def create_node(args):
155     node = query(method="droplets", args=args, http_method="post")
156     <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>return node
157 def create(vm_):
158     try:
159         if (
160             vm_["profile"]
161             and config.is_profile_configured(
162                 __opts__,
163                 _get_active_provider_name() or "digitalocean",
164                 vm_["profile"],
165                 vm_=vm_,
166             )
167             is False
168         ):
169             return False
170     except AttributeError:
171         pass
172     __utils__["cloud.fire_event"](
173         "event",
174         "starting create",
175         "salt/cloud/{}/creating".format(vm_["name"]),
176         args=__utils__["cloud.filter_event"](
177             "creating", vm_, ["name", "profile", "provider", "driver"]
178         ),
179         sock_dir=__opts__["sock_dir"],
180         transport=__opts__[</b></font>"transport"],
181     )
182     log.info("Creating Cloud VM %s", vm_["name"])
183     kwargs = {
184         "name": vm_["name"],
185         "size": get_size(vm_),
186         "image": get_image(vm_),
187         "region": get_location(vm_),
188         "ssh_keys": [],
189         "tags": [],
190     }
191     ssh_key_name = config.get_cloud_config_value(
192         "ssh_key_name", vm_, __opts__, search_global=False
193     )
194     if ssh_key_name:
195         kwargs["ssh_keys"].append(get_keyid(ssh_key_name))
196     ssh_key_names = config.get_cloud_config_value(
197         "ssh_key_names", vm_, __opts__, search_global=False, default=False
198     )
199     if ssh_key_names:
200         for key in ssh_key_names.split(","):
201             kwargs["ssh_keys"].append(get_keyid(key))
202     key_filename = config.get_cloud_config_value(
203         "ssh_key_file", vm_, __opts__, search_global=False, default=None
204     )
205     if key_filename is not None and not os.path.isfile(key_filename):
206         raise SaltCloudConfigError(
207             "The defined key_filename '{}' does not exist".format(key_filename)
208         )
209     if not __opts__.get("ssh_agent", False) and key_filename is None:
210         raise SaltCloudConfigError(
211             "The DigitalOcean driver requires an ssh_key_file and an ssh_key_name "
212             "because it does not supply a root password upon building the server."
213         )
214     ssh_interface = config.get_cloud_config_value(
215         "ssh_interface", vm_, __opts__, search_global=False, default="public"
216     )
217     if ssh_interface in ["private", "public"]:
218         log.info("ssh_interface: Setting interface for ssh to %s", ssh_interface)
219         kwargs["ssh_interface"] = ssh_interface
220     else:
221         raise SaltCloudConfigError(
222             "The DigitalOcean driver requires ssh_interface to be defined as 'public'"
223             " or 'private'."
224         )
225     private_networking = config.get_cloud_config_value(
226         "private_networking",
227         vm_,
228         __opts__,
229         search_global=False,
230         default=None,
231     )
232     if private_networking is not None:
233         if not isinstance(private_networking, bool):
234             raise SaltCloudConfigError(
235                 "'private_networking' should be a boolean value."
236             )
237         kwargs["private_networking"] = private_networking
238     if not private_networking and ssh_interface == "private":
239         raise SaltCloudConfigError(
240             "The DigitalOcean driver requires ssh_interface if defined as 'private' "
241             "then private_networking should be set as 'True'."
242         )
243     backups_enabled = config.get_cloud_config_value(
244         "backups_enabled",
245         vm_,
246         __opts__,
247         search_global=False,
248         default=None,
249     )
250     if backups_enabled is not None:
251         if not isinstance(backups_enabled, bool):
252             raise SaltCloudConfigError("'backups_enabled' should be a boolean value.")
253         kwargs["backups"] = backups_enabled
254     ipv6 = config.get_cloud_config_value(
255         "ipv6",
256         vm_,
257         __opts__,
258         search_global=False,
259         default=None,
260     )
261     if ipv6 is not None:
262         if not isinstance(ipv6, bool):
263             raise SaltCloudConfigError("'ipv6' should be a boolean value.")
264         kwargs["ipv6"] = ipv6
265     monitoring = config.get_cloud_config_value(
266         "monitoring",
267         vm_,
268         __opts__,
269         search_global=False,
270         default=None,
271     )
272     if monitoring is not None:
273         if not isinstance(monitoring, bool):
274             raise SaltCloudConfigError("'monitoring' should be a boolean value.")
275         kwargs["monitoring"] = monitoring
276     kwargs["tags"] = config.get_cloud_config_value(
277         "tags", vm_, __opts__, search_global=False, default=False
278     )
279     userdata_file = config.get_cloud_config_value(
280         "userdata_file", vm_, __opts__, search_global=False, default=None
281 <a name="8"></a>    )
282     if userdata_file is not None:
283         try:
284             with salt<font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.utils.files.fopen(userdata_file, "r") as fp_:
285                 kwargs["user_data"] = salt.utils.cloud.userdata_template(
286                     __opts__, vm_, salt.utils.</b></font>stringutils.to_unicode(fp_.read())
287                 )
288         except Exception as exc:  # pylint: disable=broad-except
289             log.exception("Failed to read userdata from %s: %s", userdata_file, exc)
290     create_dns_record = config.get_cloud_config_value(
291         "create_dns_record",
292         vm_,
293         __opts__,
294         search_global=False,
295         default=None,
296     )
297     if create_dns_record:
298         log.info("create_dns_record: will attempt to write DNS records")
299         default_dns_domain = None
300         dns_domain_name = vm_["name"].split(".")
301         if len(dns_domain_name) &gt; 2:
302             log.debug(
303                 "create_dns_record: inferring default dns_hostname, dns_domain from"
304                 " minion name as FQDN"
305             )
306             default_dns_hostname = ".".join(dns_domain_name[:-2])
307             default_dns_domain = ".".join(dns_domain_name[-2:])
308         else:
309             log.debug("create_dns_record: can't infer dns_domain from %s", vm_["name"])
310             default_dns_hostname = dns_domain_name[0]
311         dns_hostname = config.get_cloud_config_value(
312             "dns_hostname",
313             vm_,
314             __opts__,
315             search_global=False,
316             default=default_dns_hostname,
317         )
318         dns_domain = config.get_cloud_config_value(
319             "dns_domain",
320             vm_,
321             __opts__,
322             search_global=False,
323             default=default_dns_domain,
324         )
325         if dns_hostname and dns_domain:
326             log.info(
327                 'create_dns_record: using dns_hostname="%s", dns_domain="%s"',
328                 dns_hostname,
329                 dns_domain,
330             )
331             __add_dns_addr__ = lambda t, d: post_dns_record(
332                 dns_domain=dns_domain, name=dns_hostname, record_type=t, record_data=d
333             )
334             log.debug("create_dns_record: %s", __add_dns_addr__)
335         else:
336             log.error(
337                 "create_dns_record: could not determine dns_hostname and/or dns_domain"
338             )
339             raise SaltCloudConfigError(
340                 "'create_dns_record' must be a dict specifying \"domain\" "
341 <a name="7"></a>                'and "hostname" or the minion name must be an FQDN.'
342             )
343     __utils__<font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["cloud.fire_event"](
344         "event",
345         "requesting instance",
346         "salt/cloud/{}/requesting".format(vm_["name"]),
347         args=__utils__["cloud.filter_event"]("requesting", kwargs, list(kwargs)),
348         sock_dir=__opts__["sock_dir"],
349         transport=__opts__[</b></font>"transport"],
350     )
351     try:
352         ret = create_node(kwargs)
353     except Exception as exc:  # pylint: disable=broad-except
354         log.error(
355             "Error creating %s on DIGITALOCEAN\n\n"
356             "The following exception was thrown when trying to "
357             "run the initial deployment: %s",
358             vm_["name"],
359             exc,
360             exc_info_on_loglevel=logging.DEBUG,
361         )
362         return False
363     def __query_node_data(vm_name):
364         data = show_instance(vm_name, "action")
365         if not data:
366             return False
367         if data["networks"].get("v4"):
368             for network in data["networks"]["v4"]:
369                 if network["type"] == "public":
370                     return data
371         return False
372     try:
373         data = salt.utils.cloud.wait_for_ip(
374             __query_node_data,
375             update_args=(vm_["name"],),
376             timeout=config.get_cloud_config_value(
377                 "wait_for_ip_timeout", vm_, __opts__, default=10 * 60
378             ),
379             interval=config.get_cloud_config_value(
380                 "wait_for_ip_interval", vm_, __opts__, default=10
381             ),
382         )
383     except (SaltCloudExecutionTimeout, SaltCloudExecutionFailure) as exc:
384         try:
385             destroy(vm_["name"])
386         except SaltCloudSystemExit:
387             pass
388         finally:
389             raise SaltCloudSystemExit(str(exc))
390     if not vm_.get("ssh_host"):
391         vm_["ssh_host"] = None
392     addr_families, dns_arec_types = (("v4", "v6"), ("A", "AAAA"))
393     arec_map = dict(list(zip(addr_families, dns_arec_types)))
394     for facing, addr_family, ip_address in [
395         (net["type"], family, net["ip_address"])
396         for family in addr_families
397         for net in data["networks"][family]
398     ]:
399         log.info('found %s IP%s interface for "%s"', facing, addr_family, ip_address)
400         dns_rec_type = arec_map[addr_family]
401         if facing == "public":
402             if create_dns_record:
403                 __add_dns_addr__(dns_rec_type, ip_address)
404         if facing == ssh_interface:
405             if not vm_["ssh_host"]:
406                 vm_["ssh_host"] = ip_address
407     if vm_["ssh_host"] is None:
408         raise SaltCloudSystemExit(
409             "No suitable IP addresses found for ssh minion bootstrapping: {}".format(
410                 repr(data["networks"])
411             )
412         )
413     log.debug(
414         "Found public IP address to use for ssh minion bootstrapping: %s",
415         vm_["ssh_host"],
416     )
417     vm_["key_filename"] = key_filename
418     ret = __utils__["cloud.bootstrap"](vm_, __opts__)
419     ret.update(data)
420 <a name="6"></a>    log.info("Created Cloud VM '%s'", vm_["name"])
421     log.debug("'%s' VM creation details:\n%s", vm_["name"], pprint.pformat(data))
422     __utils__<font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["cloud.fire_event"](
423         "event",
424         "created instance",
425         "salt/cloud/{}/created".format(vm_["name"]),
426         args=__utils__["cloud.filter_event"](
427             "created", vm_, ["name", "profile", "provider", "driver"]
428         ),
429         sock_dir=__opts__["sock_dir"],
430         transport=__opts__["transport"],
431     )
432     return ret
433 def</b></font> query(
434     method="droplets", droplet_id=None, command=None, args=None, http_method="get"
435 ):
436     base_path = str(
437         config.get_cloud_config_value(
438             "api_root",
439             get_configured_provider(),
440             __opts__,
441             search_global=False,
442             default="https://api.digitalocean.com/v2",
443         )
444     )
445     path = "{}/{}/".format(base_path, method)
446     if droplet_id:
447         path += "{}/".format(droplet_id)
448     if command:
449         path += command
450     if not isinstance(args, dict):
451         args = {}
452     personal_access_token = config.get_cloud_config_value(
453         "personal_access_token",
454         get_configured_provider(),
455         __opts__,
456         search_global=False,
457     )
458     data = salt.utils.json.dumps(args)
459     requester = getattr(requests, http_method)
460     request = requester(
461         path,
462         data=data,
463         headers={
464             "Authorization": "Bearer " + personal_access_token,
465             "Content-Type": "application/json",
466         },
467     )
468     if request.status_code &gt; 299:
469         raise SaltCloudSystemExit(
470             "An error occurred while querying DigitalOcean. HTTP Code: {}  "
471             "Error: '{}'".format(
472                 request.status_code,
473                 request.text,
474             )
475         )
476     log.debug(request.url)
477     if request.status_code == 204:
478         return True
479     content = request.text
480     result = salt.utils.json.loads(content)
481     if result.get("status", "").lower() == "error":
482         raise SaltCloudSystemExit(pprint.pformat(result.get("error_message", {})))
483     return result
484 def script(vm_):
485     deploy_script = salt.utils.cloud.os_script(
486         config.get_cloud_config_value("script", vm_, __opts__),
487         vm_,
488         __opts__,
489         salt.utils.cloud.salt_config_to_yaml(
490             salt.utils.cloud.minion_config(__opts__, vm_)
491         ),
492     )
493     return deploy_script
494 def show_instance(name, call=None):
495     if call != "action":
496         raise SaltCloudSystemExit(
497             "The show_instance action must be called with -a or --action."
498         )
499     node = _get_node(name)
500     __utils__["cloud.cache_node"](node, _get_active_provider_name(), __opts__)
501     return node
502 def _get_node(name):
503     attempts = 10
504     while attempts &gt;= 0:
505         try:
506             return list_nodes_full(for_output=False)[name]
507         except KeyError:
508             attempts -= 1
509             log.debug(
510                 "Failed to get the data for node '%s'. Remaining attempts: %s",
511                 name,
512                 attempts,
513             )
514             time.sleep(0.5)
515     return {}
516 def list_keypairs(call=None):
517     if call != "function":
518         log.error("The list_keypairs function must be called with -f or --function.")
519         return False
520     fetch = True
521     page = 1
522     ret = {}
523     while fetch:
524         items = query(
525             method="account/keys",
526             command="?page=" + str(page) + "&amp;per_page=100",
527         )
528         for key_pair in items["ssh_keys"]:
529             name = key_pair["name"]
530             if name in ret:
531                 raise SaltCloudSystemExit(
532                     "A duplicate key pair name, '{}', was found in DigitalOcean's "
533                     "key pair list. Please change the key name stored by DigitalOcean. "
534                     "Be sure to adjust the value of 'ssh_key_file' in your cloud "
535                     "profile or provider configuration, if necessary.".format(name)
536                 )
537             ret[name] = {}
538             for item in key_pair.keys():
539                 ret[name][item] = str(key_pair[item])
540         page += 1
541         try:
542             fetch = "next" in items["links"]["pages"]
543         except KeyError:
544             fetch = False
545     return ret
546 def show_keypair(kwargs=None, call=None):
547     if call != "function":
548         log.error("The show_keypair function must be called with -f or --function.")
549         return False
550     if not kwargs:
551         kwargs = {}
552     if "keyname" not in kwargs:
553         log.error("A keyname is required.")
554         return False
555     keypairs = list_keypairs(call="function")
556     keyid = keypairs[kwargs["keyname"]]["id"]
557     log.debug("Key ID is %s", keyid)
558     details = query(method="account/keys", command=keyid)
559     return details
560 def import_keypair(kwargs=None, call=None):
561     with salt.utils.files.fopen(kwargs["file"], "r") as public_key_filename:
562         public_key_content = salt.utils.stringutils.to_unicode(
563             public_key_filename.read()
564         )
565     digitalocean_kwargs = {"name": kwargs["keyname"], "public_key": public_key_content}
566     created_result = create_key(digitalocean_kwargs, call=call)
567     return created_result
568 def create_key(kwargs=None, call=None):
569     if call != "function":
570         log.error("The create_key function must be called with -f or --function.")
571         return False
572     try:
573         result = query(
574             method="account",
575             command="keys",
576             args={"name": kwargs["name"], "public_key": kwargs["public_key"]},
577             http_method="post",
578         )
579     except KeyError:
580         log.info("`name` and `public_key` arguments must be specified")
581         return False
582     return result
583 def remove_key(kwargs=None, call=None):
584     if call != "function":
585         log.error("The create_key function must be called with -f or --function.")
586         return False
587     try:
588         result = query(
589             method="account", command="keys/" + kwargs["id"], http_method="delete"
590         )
591     except KeyError:
592         log.info("`id` argument must be specified")
593         return False
594     return result
595 def get_keyid(keyname):
596     if not keyname:
597         return None
598     keypairs = list_keypairs(call="function")
599 <a name="3"></a>    keyid = keypairs[keyname]["id"]
600     if keyid:
601         return keyid
602     raise SaltCloudNotFound(<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"The specified ssh key could not be found.")
603 def destroy(name, call=None):
604     if call == "function":
605         raise SaltCloudSystemExit(
606             "The destroy action must be called with -d, --destroy, -a or --action."
607         )
608     __utils__["cloud.fire_event"](
609         "event",
610         "destroying instance",
611         "salt/cloud/{}/destroying".format(name),
612         args={"name": name},
613         sock_dir=__opts__["sock_dir"],
614         transport=__opts__["transport"],
615     )
616     data =</b></font> show_instance(name, call="action")
617     node = query(method="droplets", droplet_id=data["id"], http_method="delete")
618     delete_dns_record = True
619     if not isinstance(delete_dns_record, bool):
620         raise SaltCloudConfigError("'delete_dns_record' should be a boolean value.")
621     log.debug("Deleting DNS records for %s.", name)
622     destroy_dns_records(name)
623     __utils__<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>["cloud.fire_event"](
624         "event",
625         "destroyed instance",
626         "salt/cloud/{}/destroyed".format(name),
627         args={"name": name},
628         sock_dir=__opts__["sock_dir"],
629         transport=__opts__["transport"],
630     )
631     if __opts__.get("update_cachedir", False) is True:
632         __utils__["cloud.delete_minion_cachedir"](
633             name, _get_active_provider_name().split(":")[</b></font>0], __opts__
634         )
635     return node
636 def post_dns_record(**kwargs):
637     if "kwargs" in kwargs:  # flatten kwargs if called via salt-cloud -f
638         f_kwargs = kwargs["kwargs"]
639         del kwargs["kwargs"]
640         kwargs.update(f_kwargs)
641     mandatory_kwargs = ("dns_domain", "name", "record_type", "record_data")
642     for i in mandatory_kwargs:
643         if kwargs[i]:
644             pass
645         else:
646             error = '{}="{}" ## all mandatory args must be provided: {}'.format(
647                 i, kwargs[i], mandatory_kwargs
648             )
649             raise SaltInvocationError(error)
650     domain = query(method="domains", droplet_id=kwargs["dns_domain"])
651     if domain:
652         result = query(
653             method="domains",
654             droplet_id=kwargs["dns_domain"],
655             command="records",
656             args={
657                 "type": kwargs["record_type"],
658                 "name": kwargs["name"],
659                 "data": kwargs["record_data"],
660             },
661             http_method="post",
662         )
663         return result
664     return False
665 def destroy_dns_records(fqdn):
666     domain = ".".join(fqdn.split(".")[-2:])
667     hostname = ".".join(fqdn.split(".")[:-2])
668     try:
669         response = query(method="domains", droplet_id=domain, command="records")
670     except SaltCloudSystemExit:
671         log.debug("Failed to find domains.")
672         return False
673     log.debug("found DNS records: %s", pprint.pformat(response))
674     records = response["domain_records"]
675     if records:
676         record_ids = [r["id"] for r in records if r["name"].decode() == hostname]
677         log.debug("deleting DNS record IDs: %s", record_ids)
678         for id_ in record_ids:
679             try:
680                 log.info("deleting DNS record %s", id_)
681                 ret = query(
682                     method="domains",
683                     droplet_id=domain,
684                     command="records/{}".format(id_),
685                     http_method="delete",
686                 )
687             except SaltCloudSystemExit:
688                 log.error(
689                     "failed to delete DNS domain %s record ID %s.", domain, hostname
690                 )
691             log.debug("DNS deletion REST call returned: %s", pprint.pformat(ret))
692     return False
693 def show_pricing(kwargs=None, call=None):
694     profile = __opts__["profiles"].get(kwargs["profile"], {})
695     if not profile:
696         return {"Error": "The requested profile was not found"}
697     provider = profile.get("provider", "0:0")
698     comps = provider.split(":")
699     if len(comps) &lt; 2 or comps[1] != "digitalocean":
700         return {"Error": "The requested profile does not belong to DigitalOcean"}
701 <a name="5"></a>    raw = {}
702     ret = {}
703     sizes = avail_sizes()
704     ret["per_hour"] = decimal.Decimal(sizes<font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>[profile["size"]]["price_hourly"])
705     ret["per_day"] = ret["per_hour"] * 24
706     ret["per_week"] = ret["per_day"] * 7
707     ret["per_month"] = decimal.Decimal(sizes[profile["size"]][</b></font>"price_monthly"])
708     ret["per_year"] = ret["per_week"] * 52
709     if kwargs.get("raw", False):
710         ret["_raw"] = raw
711     return {profile["profile"]: ret}
712 def list_floating_ips(call=None):
713     if call == "action":
714         raise SaltCloudSystemExit(
715             "The list_floating_ips function must be called with "
716             "-f or --function, or with the --list-floating-ips option"
717         )
718     fetch = True
719     page = 1
720     ret = {}
721     while fetch:
722         items = query(
723             method="floating_ips",
724             command="?page=" + str(page) + "&amp;per_page=200",
725         )
726         for floating_ip in items["floating_ips"]:
727             ret[floating_ip["ip"]] = {}
728             for item in floating_ip.keys():
729                 ret[floating_ip["ip"]][item] = floating_ip[item]
730         page += 1
731         try:
732             fetch = "next" in items["links"]["pages"]
733         except KeyError:
734             fetch = False
735     return ret
736 def show_floating_ip(kwargs=None, call=None):
737     if call != "function":
738         log.error("The show_floating_ip function must be called with -f or --function.")
739         return False
740     if not kwargs:
741         kwargs = {}
742     if "floating_ip" not in kwargs:
743         log.error("A floating IP is required.")
744         return False
745     floating_ip = kwargs["floating_ip"]
746     log.debug("Floating ip is %s", floating_ip)
747     details = query(method="floating_ips", command=floating_ip)
748     return details
749 def create_floating_ip(kwargs=None, call=None):
750     if call != "function":
751         log.error(
752             "The create_floating_ip function must be called with -f or --function."
753         )
754         return False
755     if not kwargs:
756         kwargs = {}
757     if "droplet_id" in kwargs:
758         result = query(
759             method="floating_ips",
760             args={"droplet_id": kwargs["droplet_id"]},
761             http_method="post",
762         )
763         return result
764     elif "region" in kwargs:
765         result = query(
766             method="floating_ips", args={"region": kwargs["region"]}, http_method="post"
767         )
768         return result
769     else:
770         log.error("A droplet_id or region is required.")
771         return False
772 def delete_floating_ip(kwargs=None, call=None):
773     if call != "function":
774         log.error(
775             "The delete_floating_ip function must be called with -f or --function."
776         )
777         return False
778     if not kwargs:
779         kwargs = {}
780     if "floating_ip" not in kwargs:
781         log.error("A floating IP is required.")
782         return False
783     floating_ip = kwargs["floating_ip"]
784     log.debug("Floating ip is %s", kwargs["floating_ip"])
785     result = query(method="floating_ips", command=floating_ip, http_method="delete")
786     return result
787 def assign_floating_ip(kwargs=None, call=None):
788     if call != "function":
789         log.error(
790             "The assign_floating_ip function must be called with -f or --function."
791         )
792         return False
793     if not kwargs:
794         kwargs = {}
795     if "floating_ip" and "droplet_id" not in kwargs:
796         log.error("A floating IP and droplet_id is required.")
797         return False
798     result = query(
799         method="floating_ips",
800         command=kwargs["floating_ip"] + "/actions",
801         args={"droplet_id": kwargs["droplet_id"], "type": "assign"},
802         http_method="post",
803     )
804     return result
805 def unassign_floating_ip(kwargs=None, call=None):
806     if call != "function":
807         log.error(
808             "The inassign_floating_ip function must be called with -f or --function."
809         )
810         return False
811     if not kwargs:
812         kwargs = {}
813     if "floating_ip" not in kwargs:
814         log.error("A floating IP is required.")
815         return False
816     result = query(
817         method="floating_ips",
818         command=kwargs["floating_ip"] + "/actions",
819         args={"type": "unassign"},
820         http_method="post",
821     )
822     return result
823 def _list_nodes(full=False, for_output=False):
824     fetch = True
825     page = 1
826     ret = {}
827     while fetch:
828         items = query(method="droplets", command="?page=" + str(page) + "&amp;per_page=200")
829         for node in items["droplets"]:
830             name = node["name"]
831             ret[name] = {}
832             if full:
833                 ret[name] = _get_full_output(node, for_output=for_output)
834             else:
835                 public_ips, private_ips = _get_ips(node["networks"])
836                 ret[name] = {
837                     "id": node["id"],
838                     "image": node["image"]["name"],
839                     "name": name,
840                     "private_ips": private_ips,
841                     "public_ips": public_ips,
842                     "size": node["size_slug"],
843                     "state": str(node["status"]),
844                 }
845         page += 1
846         try:
847             fetch = "next" in items["links"]["pages"]
848         except KeyError:
849             fetch = False
850     return ret
851 def reboot(name, call=None):
852     if call != "action":
853         raise SaltCloudSystemExit(
854             "The reboot action must be called with -a or --action."
855         )
856     data = show_instance(name, call="action")
857     if data.get("status") == "off":
858         return {
859             "success": True,
860             "action": "stop",
861             "status": "off",
862             "msg": "Machine is already off.",
863         }
864     ret = query(
865         droplet_id=data["id"],
866         command="actions",
867         args={"type": "reboot"},
868         http_method="post",
869     )
870     return {
871         "success": True,
872         "action": ret["action"]["type"],
873         "state": ret["action"]["status"],
874     }
875 def start(name, call=None):
876     if call != "action":
877         raise SaltCloudSystemExit(
878             "The start action must be called with -a or --action."
879         )
880     data = show_instance(name, call="action")
881     if data.get("status") == "active":
882         return {
883             "success": True,
884             "action": "start",
885             "status": "active",
886             "msg": "Machine is already running.",
887         }
888     ret = query(
889         droplet_id=data["id"],
890         command="actions",
891         args={"type": "power_on"},
892         http_method="post",
893     )
894     return {
895         "success": True,
896         "action": ret["action"]["type"],
897         "state": ret["action"]["status"],
898     }
899 def stop(name, call=None):
900     if call != "action":
901         raise SaltCloudSystemExit("The stop action must be called with -a or --action.")
902     data = show_instance(name, call="action")
903     if data.get("status") == "off":
904         return {
905             "success": True,
906             "action": "stop",
907             "status": "off",
908             "msg": "Machine is already off.",
909         }
910     ret = query(
911         droplet_id=data["id"],
912         command="actions",
913         args={"type": "shutdown"},
914         http_method="post",
915     )
916     return {
917         "success": True,
918         "action": ret["action"]["type"],
919         "state": ret["action"]["status"],
920     }
921 def _get_full_output(node, for_output=False):
922     ret = {}
923     for item in node.keys():
924         value = node[item]
925         if value is not None and for_output:
926             value = str(value)
927         ret[item] = value
928     return ret
929 def _get_ips(networks):
930     v4s = networks.get("v4")
931     v6s = networks.get("v6")
932     public_ips = []
933     private_ips = []
934     if v4s:
935         for item in v4s:
936             ip_type = item.get("type")
937             ip_address = item.get("ip_address")
938             if ip_type == "public":
939                 public_ips.append(ip_address)
940             if ip_type == "private":
941                 private_ips.append(ip_address)
942     if v6s:
943         for item in v6s:
944             ip_type = item.get("type")
945             ip_address = item.get("ip_address")
946             if ip_type == "public":
947                 public_ips.append(ip_address)
948             if ip_type == "private":
949                 private_ips.append(ip_address)
950     return public_ips, private_ips
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>vmware.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <a name="4"></a>import logging
2 import os.path
3 import pprint
4 <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import re
5 import subprocess
6 import time
7 from random import randint
8 import salt.config as config
9 import salt.utils.cloud
10 import salt.utils.network
11 import salt.utils.stringutils
12 import salt.utils.vmware
13 import salt.utils.xmlutil
14 from salt.exceptions import SaltCloudSystemExit
15 try:
16     from pyVmomi import vim  # pylint: disable=no-name-in-module
17     HAS_PYVMOMI = True
18 except ImportError:
19     HAS_PYVMOMI =</b></font> False
20 try:
21     from requests.packages.urllib3 import (
22         disable_warnings,
23     )  # pylint: disable=no-name-in-module
24     disable_warnings()
25 except ImportError:
26     pass
27 ESX_5_5_NAME_PORTION = "VMware ESXi 5.5"
28 SAFE_ESX_5_5_CONTROLLER_KEY_INDEX = 200
29 FLATTEN_DISK_FULL_CLONE = "moveAllDiskBackingsAndDisallowSharing"
30 COPY_ALL_DISKS_FULL_CLONE = "moveAllDiskBackingsAndAllowSharing"
31 CURRENT_STATE_LINKED_CLONE = "moveChildMostDiskBacking"
32 QUICK_LINKED_CLONE = "createNewChildDiskBacking"
33 IP_RE = r"^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
34 log = logging.getLogger(__name__)
35 __virtualname__ = "vmware"
36 <a name="1"></a>
37 <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>def __virtual__():
38     if get_configured_provider() is False:
39         return False
40     if get_dependencies() is False:
41         return False
42     return __virtualname__
43 def _get_active_provider_name():
44     try:
45         return __active_provider_name__.value()
46     except AttributeError:
47         return __active_provider_name__
48 def get_configured_provider():
49     return config.is_provider_configured(</b></font>
50         __opts__,
51         _get_active_provider_name() or __virtualname__,
52         (
53             "url",
54             "user",
55             "password",
56         ),
57     )
58 def get_dependencies():
59     deps = {
60         "pyVmomi": HAS_PYVMOMI,
61     }
62     return config.check_driver_dependencies(__virtualname__, deps)
63 def script(vm_):
64     script_name = config.get_cloud_config_value("script", vm_, __opts__)
65     if not script_name:
66         script_name = "bootstrap-salt"
67     return salt.utils.cloud.os_script(
68         script_name,
69         vm_,
70         __opts__,
71         salt.utils.cloud.salt_config_to_yaml(
72             salt.utils.cloud.minion_config(__opts__, vm_)
73         ),
74     )
75 def _str_to_bool(var):
76     if isinstance(var, bool):
77         return var
78     if isinstance(var, str):
79         return True if var.lower() == "true" else False
80     return None
81 def _get_si():
82     url = config.get_cloud_config_value(
83         "url", get_configured_provider(), __opts__, search_global=False
84     )
85     username = config.get_cloud_config_value(
86         "user", get_configured_provider(), __opts__, search_global=False
87     )
88     password = config.get_cloud_config_value(
89         "password", get_configured_provider(), __opts__, search_global=False
90     )
91     protocol = config.get_cloud_config_value(
92         "protocol",
93         get_configured_provider(),
94         __opts__,
95         search_global=False,
96         default="https",
97     )
98     port = config.get_cloud_config_value(
99         "port", get_configured_provider(), __opts__, search_global=False, default=443
100     )
101     verify_ssl = config.get_cloud_config_value(
102         "verify_ssl",
103         get_configured_provider(),
104         __opts__,
105         search_global=False,
106         default=True,
107     )
108     return salt.utils.vmware.get_service_instance(
109         url, username, password, protocol=protocol, port=port, verify_ssl=verify_ssl
110     )
111 def _edit_existing_hard_disk_helper(disk, size_kb=None, size_gb=None, mode=None):
112     if size_kb or size_gb:
113         disk.capacityInKB = size_kb if size_kb else int(size_gb * 1024.0 * 1024.0)
114     if mode:
115         disk.backing.diskMode = mode
116     disk_spec = vim.vm.device.VirtualDeviceSpec()
117     disk_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.edit
118     disk_spec.device = disk
119     return disk_spec
120 def _add_new_hard_disk_helper(
121     disk_label,
122     size_gb,
123     unit_number,
124     controller_key=1000,
125     thin_provision=False,
126     eagerly_scrub=False,
127     datastore=None,
128     vm_name=None,
129 ):
130     random_key = randint(-2099, -2000)
131     size_kb = int(size_gb * 1024.0 * 1024.0)
132     disk_spec = vim.vm.device.VirtualDeviceSpec()
133     disk_spec.fileOperation = "create"
134     disk_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.add
135     disk_spec.device = vim.vm.device.VirtualDisk()
136     disk_spec.device.key = random_key
137     disk_spec.device.deviceInfo = vim.Description()
138     disk_spec.device.deviceInfo.label = disk_label
139     disk_spec.device.deviceInfo.summary = "{} GB".format(size_gb)
140     disk_spec.device.backing = vim.vm.device.VirtualDisk.FlatVer2BackingInfo()
141     disk_spec.device.backing.thinProvisioned = thin_provision
142     disk_spec.device.backing.eagerlyScrub = eagerly_scrub
143     disk_spec.device.backing.diskMode = "persistent"
144     if datastore:
145         datastore_ref = salt.utils.vmware.get_mor_using_container_view(
146             _get_si(), vim.Datastore, datastore
147         )
148         if not datastore_ref:
149             datastore_cluster_ref = salt.utils.vmware.get_mor_using_container_view(
150                 _get_si(), vim.StoragePod, datastore
151             )
152             if not datastore_cluster_ref:
153                 raise SaltCloudSystemExit(
154                     "Specified datastore/datastore cluster ({}) for disk ({}) does not"
155                     " exist".format(datastore, disk_label)
156                 )
157             datastore_list = salt.utils.vmware.get_datastores(
158                 _get_si(), datastore_cluster_ref, get_all_datastores=True
159             )
160             datastore_free_space = 0
161             for ds_ref in datastore_list:
162                 log.trace(
163                     "Found datastore (%s) with free space (%s) in datastore "
164                     "cluster (%s)",
165                     ds_ref.name,
166                     ds_ref.summary.freeSpace,
167                     datastore,
168                 )
169                 if (
170                     ds_ref.summary.accessible
171                     and ds_ref.summary.freeSpace &gt; datastore_free_space
172                 ):
173                     datastore_free_space = ds_ref.summary.freeSpace
174                     datastore_ref = ds_ref
175             if not datastore_ref:
176                 raise SaltCloudSystemExit(
177                     "Specified datastore cluster ({}) for disk ({}) does not have any"
178                     " accessible datastores available".format(datastore, disk_label)
179                 )
180         datastore_path = "[" + str(datastore_ref.name) + "] " + vm_name
181         disk_spec.device.backing.fileName = datastore_path + "/" + disk_label + ".vmdk"
182         disk_spec.device.backing.datastore = datastore_ref
183         log.trace(
184             "Using datastore (%s) for disk (%s), vm_name (%s)",
185             datastore_ref.name,
186             disk_label,
187             vm_name,
188         )
189     disk_spec.device.controllerKey = controller_key
190     disk_spec.device.unitNumber = unit_number
191     disk_spec.device.capacityInKB = size_kb
192     return disk_spec
193 def _edit_existing_network_adapter(
194     network_adapter, new_network_name, adapter_type, switch_type, container_ref=None
195 ):
196     adapter_type.strip().lower()
197     switch_type.strip().lower()
198     if adapter_type in ["vmxnet", "vmxnet2", "vmxnet3", "e1000", "e1000e"]:
199         edited_network_adapter = salt.utils.vmware.get_network_adapter_type(
200             adapter_type
201         )
202         if isinstance(network_adapter, type(edited_network_adapter)):
203             edited_network_adapter = network_adapter
204         else:
205             log.debug(
206                 "Changing type of '%s' from '%s' to '%s'",
207                 network_adapter.deviceInfo.label,
208                 type(network_adapter).__name__.rsplit(".", 1)[1][7:].lower(),
209                 adapter_type,
210             )
211     else:
212         if adapter_type:
213             log.error(
214                 "Cannot change type of '%s' to '%s'. Not changing type",
215                 network_adapter.deviceInfo.label,
216                 adapter_type,
217             )
218         edited_network_adapter = network_adapter
219     if switch_type == "standard":
220         network_ref = salt.utils.vmware.get_mor_by_property(
221             _get_si(), vim.Network, new_network_name, container_ref=container_ref
222         )
223         edited_network_adapter.backing = (
224             vim.vm.device.VirtualEthernetCard.NetworkBackingInfo()
225         )
226         edited_network_adapter.backing.deviceName = new_network_name
227         edited_network_adapter.backing.network = network_ref
228     elif switch_type == "distributed":
229         network_ref = salt.utils.vmware.get_mor_by_property(
230             _get_si(),
231             vim.dvs.DistributedVirtualPortgroup,
232             new_network_name,
233             container_ref=container_ref,
234         )
235         dvs_port_connection = vim.dvs.PortConnection(
236             portgroupKey=network_ref.key,
237             switchUuid=network_ref.config.distributedVirtualSwitch.uuid,
238         )
239         edited_network_adapter.backing = (
240             vim.vm.device.VirtualEthernetCard.DistributedVirtualPortBackingInfo()
241         )
242         edited_network_adapter.backing.port = dvs_port_connection
243     else:
244         if not switch_type:
245             err_msg = (
246                 "The switch type to be used by '{}' has not been specified".format(
247                     network_adapter.deviceInfo.label
248                 )
249             )
250         else:
251             err_msg = "Cannot create '{}'. Invalid/unsupported switch type '{}'".format(
252                 network_adapter.deviceInfo.label, switch_type
253             )
254         raise SaltCloudSystemExit(err_msg)
255     edited_network_adapter.key = network_adapter.key
256     edited_network_adapter.deviceInfo = network_adapter.deviceInfo
257     edited_network_adapter.deviceInfo.summary = new_network_name
258     edited_network_adapter.connectable = network_adapter.connectable
259     edited_network_adapter.slotInfo = network_adapter.slotInfo
260     edited_network_adapter.controllerKey = network_adapter.controllerKey
261     edited_network_adapter.unitNumber = network_adapter.unitNumber
262     edited_network_adapter.addressType = network_adapter.addressType
263     edited_network_adapter.macAddress = network_adapter.macAddress
264     edited_network_adapter.wakeOnLanEnabled = network_adapter.wakeOnLanEnabled
265     network_spec = vim.vm.device.VirtualDeviceSpec()
266     network_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.edit
267     network_spec.device = edited_network_adapter
268     return network_spec
269 def _add_new_network_adapter_helper(
270     network_adapter_label,
271     network_name,
272     adapter_type,
273     switch_type,
274     mac,
275     container_ref=None,
276 ):
277     random_key = randint(-4099, -4000)
278     adapter_type.strip().lower()
279     switch_type.strip().lower()
280     network_spec = vim.vm.device.VirtualDeviceSpec()
281     if adapter_type in ["vmxnet", "vmxnet2", "vmxnet3", "e1000", "e1000e"]:
282         network_spec.device = salt.utils.vmware.get_network_adapter_type(adapter_type)
283     else:
284         if not adapter_type:
285             log.debug(
286                 "The type of '%s' has not been specified. "
287                 "Creating default type 'vmxnet3'",
288                 network_adapter_label,
289             )
290         else:
291             log.error(
292                 "Cannot create network adapter of type '%s'. "
293                 "Creating '%s' of default type 'vmxnet3'",
294                 adapter_type,
295                 network_adapter_label,
296             )
297         network_spec.device = vim.vm.device.VirtualVmxnet3()
298     network_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.add
299     if switch_type == "standard":
300         network_spec.device.backing = (
301             vim.vm.device.VirtualEthernetCard.NetworkBackingInfo()
302         )
303         network_spec.device.backing.deviceName = network_name
304         network_spec.device.backing.network = salt.utils.vmware.get_mor_by_property(
305             _get_si(), vim.Network, network_name, container_ref=container_ref
306         )
307     elif switch_type == "distributed":
308         network_ref = salt.utils.vmware.get_mor_by_property(
309             _get_si(),
310             vim.dvs.DistributedVirtualPortgroup,
311             network_name,
312             container_ref=container_ref,
313         )
314         dvs_port_connection = vim.dvs.PortConnection(
315             portgroupKey=network_ref.key,
316             switchUuid=network_ref.config.distributedVirtualSwitch.uuid,
317         )
318         network_spec.device.backing = (
319             vim.vm.device.VirtualEthernetCard.DistributedVirtualPortBackingInfo()
320         )
321         network_spec.device.backing.port = dvs_port_connection
322     else:
323         if not switch_type:
324             err_msg = (
325                 "The switch type to be used by '{}' has not been specified".format(
326                     network_adapter_label
327                 )
328             )
329         else:
330             err_msg = "Cannot create '{}'. Invalid/unsupported switch type '{}'".format(
331                 network_adapter_label, switch_type
332             )
333         raise SaltCloudSystemExit(err_msg)
334     if mac != "":
335         network_spec.device.addressType = "assigned"
336         network_spec.device.macAddress = mac
337     network_spec.device.key = random_key
338     network_spec.device.deviceInfo = vim.Description()
339     network_spec.device.deviceInfo.label = network_adapter_label
340     network_spec.device.deviceInfo.summary = network_name
341     network_spec.device.wakeOnLanEnabled = True
342     network_spec.device.connectable = vim.vm.device.VirtualDevice.ConnectInfo()
343     network_spec.device.connectable.startConnected = True
344     network_spec.device.connectable.allowGuestControl = True
345     return network_spec
346 def _edit_existing_scsi_controller(scsi_controller, bus_sharing):
347     scsi_controller.sharedBus = bus_sharing
348     scsi_spec = vim.vm.device.VirtualDeviceSpec()
349     scsi_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.edit
350     scsi_spec.device = scsi_controller
351     return scsi_spec
352 def _add_new_scsi_controller_helper(scsi_controller_label, properties, bus_number):
353     random_key = randint(-1050, -1000)
354     adapter_type = properties["type"].strip().lower() if "type" in properties else None
355     bus_sharing = (
356         properties["bus_sharing"].strip().lower()
357         if "bus_sharing" in properties
358         else None
359     )
360     scsi_spec = vim.vm.device.VirtualDeviceSpec()
361     if adapter_type == "lsilogic":
362         summary = "LSI Logic"
363         scsi_spec.device = vim.vm.device.VirtualLsiLogicController()
364     elif adapter_type == "lsilogic_sas":
365         summary = "LSI Logic Sas"
366         scsi_spec.device = vim.vm.device.VirtualLsiLogicSASController()
367     elif adapter_type == "paravirtual":
368         summary = "VMware paravirtual SCSI"
369         scsi_spec.device = vim.vm.device.ParaVirtualSCSIController()
370     else:
371         if not adapter_type:
372             err_msg = "The type of '{}' has not been specified".format(
373                 scsi_controller_label
374             )
375         else:
376             err_msg = "Cannot create '{}'. Invalid/unsupported type '{}'".format(
377                 scsi_controller_label, adapter_type
378 <a name="5"></a>            )
379         raise SaltCloudSystemExit(err_msg)
380     scsi_spec.operation = vim.vm.device.VirtualDeviceSpec<font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.Operation.add
381     scsi_spec.device.key = random_key
382     scsi_spec.device.busNumber = bus_number
383     scsi_spec.device.deviceInfo = vim.Description()
384     scsi_spec.device.deviceInfo.</b></font>label = scsi_controller_label
385     scsi_spec.device.deviceInfo.summary = summary
386     if bus_sharing == "virtual":
387         scsi_spec.device.sharedBus = (
388             vim.vm.device.VirtualSCSIController.Sharing.virtualSharing
389         )
390     elif bus_sharing == "physical":
391         scsi_spec.device.sharedBus = (
392             vim.vm.device.VirtualSCSIController.Sharing.physicalSharing
393         )
394     else:
395         scsi_spec.device.sharedBus = (
396             vim.vm.device.VirtualSCSIController.Sharing.noSharing
397         )
398     return scsi_spec
399 def _add_new_ide_controller_helper(ide_controller_label, controller_key, bus_number):
400     if controller_key is None:
401         controller_key = randint(-200, 250)
402     ide_spec = vim.vm.device.VirtualDeviceSpec()
403     ide_spec.device = vim.vm.device.VirtualIDEController()
404     ide_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.add
405     ide_spec.device.key = controller_key
406     ide_spec.device.busNumber = bus_number
407     ide_spec.device.deviceInfo = vim.Description()
408     ide_spec.device.deviceInfo.label = ide_controller_label
409     ide_spec.device.deviceInfo.summary = ide_controller_label
410     return ide_spec
411 def _set_cd_or_dvd_backing_type(drive, device_type, mode, iso_path):
412     if device_type == "datastore_iso_file":
413         drive.backing = vim.vm.device.VirtualCdrom.IsoBackingInfo()
414         drive.backing.fileName = iso_path
415         datastore = iso_path.partition("[")[-1].rpartition("]")[0]
416         datastore_ref = salt.utils.vmware.get_mor_by_property(
417             _get_si(), vim.Datastore, datastore
418         )
419         if datastore_ref:
420             drive.backing.datastore = datastore_ref
421         drive.deviceInfo.summary = "ISO {}".format(iso_path)
422     elif device_type == "client_device":
423         if mode == "passthrough":
424             drive.backing = vim.vm.device.VirtualCdrom.RemotePassthroughBackingInfo()
425             drive.deviceInfo.summary = "Remote Device"
426         elif mode == "atapi":
427             drive.backing = vim.vm.device.VirtualCdrom.RemoteAtapiBackingInfo()
428             drive.deviceInfo.summary = "Remote ATAPI"
429     return drive
430 def _edit_existing_cd_or_dvd_drive(drive, device_type, mode, iso_path):
431     device_type.strip().lower()
432     mode.strip().lower()
433     drive_spec = vim.vm.device.VirtualDeviceSpec()
434     drive_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.edit
435     drive_spec.device = _set_cd_or_dvd_backing_type(drive, device_type, mode, iso_path)
436     return drive_spec
437 def _add_new_cd_or_dvd_drive_helper(
438     drive_label, controller_key, device_type, mode, iso_path
439 ):
440     random_key = randint(-3025, -3000)
441     device_type.strip().lower()
442     mode.strip().lower()
443     drive_spec = vim.vm.device.VirtualDeviceSpec()
444     drive_spec.operation = vim.vm.device.VirtualDeviceSpec.Operation.add
445     drive_spec.device = vim.vm.device.VirtualCdrom()
446     drive_spec.device.deviceInfo = vim.Description()
447     if device_type in ["datastore_iso_file", "client_device"]:
448         drive_spec.device = _set_cd_or_dvd_backing_type(
449             drive_spec.device, device_type, mode, iso_path
450         )
451     else:
452         if not device_type:
453             log.debug(
454                 "The 'device_type' of '%s' has not been specified. "
455                 "Creating default type 'client_device'",
456                 drive_label,
457             )
458         else:
459             log.error(
460                 "Cannot create CD/DVD drive of type '%s'. "
461                 "Creating '%s' of default type 'client_device'",
462                 device_type,
463                 drive_label,
464             )
465         drive_spec.device.backing = (
466             vim.vm.device.VirtualCdrom.RemotePassthroughBackingInfo()
467         )
468         drive_spec.device.deviceInfo.summary = "Remote Device"
469     drive_spec.device.key = random_key
470     drive_spec.device.deviceInfo.label = drive_label
471     drive_spec.device.controllerKey = controller_key
472     drive_spec.device.connectable = vim.vm.device.VirtualDevice.ConnectInfo()
473     drive_spec.device.connectable.startConnected = True
474     drive_spec.device.connectable.allowGuestControl = True
475     return drive_spec
476 def _set_network_adapter_mapping(adapter_specs):
477     adapter_mapping = vim.vm.customization.AdapterMapping()
478     adapter_mapping.adapter = vim.vm.customization.IPSettings()
479     if "domain" in list(adapter_specs.keys()):
480         domain = adapter_specs["domain"]
481         adapter_mapping.adapter.dnsDomain = domain
482     if "gateway" in list(adapter_specs.keys()):
483         gateway = adapter_specs["gateway"]
484         adapter_mapping.adapter.gateway = gateway
485     if "ip" in list(adapter_specs.keys()):
486         ip = str(adapter_specs["ip"])
487         subnet_mask = str(adapter_specs["subnet_mask"])
488         adapter_mapping.adapter.ip = vim.vm.customization.FixedIp(ipAddress=ip)
489         adapter_mapping.adapter.subnetMask = subnet_mask
490     else:
491         adapter_mapping.adapter.ip = vim.vm.customization.DhcpIpGenerator()
492     return adapter_mapping
493 def _get_mode_spec(device, mode, disk_spec):
494     if device.backing.diskMode != mode:
495         if not disk_spec:
496             disk_spec = _edit_existing_hard_disk_helper(disk=device, mode=mode)
497         else:
498             disk_spec.device.backing.diskMode = mode
499     return disk_spec
500 def _get_size_spec(device, size_gb=None, size_kb=None):
501     if size_kb is None and size_gb is not None:
502         size_kb = int(size_gb * 1024.0 * 1024.0)
503     disk_spec = (
504         _edit_existing_hard_disk_helper(disk=device, size_kb=size_kb)
505         if device.capacityInKB &lt; size_kb
506         else None
507     )
508     return disk_spec
509 def _iter_disk_unit_number(unit_number):
510     unit_number += 1
511     if unit_number == 7:
512         unit_number += 1
513     return unit_number
514 def _manage_devices(devices, vm=None, container_ref=None, new_vm_name=None):
515     unit_number = 0
516     bus_number = 0
517     device_specs = []
518     existing_disks_label = []
519     existing_scsi_controllers_label = []
520     existing_ide_controllers_label = []
521     existing_network_adapters_label = []
522     existing_cd_drives_label = []
523     ide_controllers = {}
524     nics_map = []
525     cloning_from_vm = vm is not None
526     if cloning_from_vm:
527         for device in vm.config.hardware.device:
528             if isinstance(device, vim.vm.device.VirtualDisk):
529                 if "disk" in list(devices.keys()):
530                     unit_number = _iter_disk_unit_number(unit_number)
531                     existing_disks_label.append(device.deviceInfo.label)
532                     if device.deviceInfo.label in list(devices["disk"].keys()):
533                         disk_spec = None
534                         if "size" in devices["disk"][device.deviceInfo.label]:
535                             size_gb = float(
536                                 devices["disk"][device.deviceInfo.label]["size"]
537                             )
538                             size_kb = int(size_gb * 1024.0 * 1024.0)
539                         else:
540                             size_kb = device.capacityInKB
541                             size_gb = size_kb / (1024.0 * 1024.0)
542                             log.debug(
543                                 "Virtual disk size for '%s' was not "
544                                 "specified in the cloud profile or map file. "
545                                 "Using existing virtual disk size of '%sGB'",
546                                 device.deviceInfo.label,
547                                 size_gb,
548                             )
549                         if device.capacityInKB &gt; size_kb:
550                             raise SaltCloudSystemExit(
551                                 "The specified disk size '{}GB' for '{}' is "
552                                 "smaller than the disk image size '{}GB'. It must "
553                                 "be equal to or greater than the disk image".format(
554                                     float(
555                                         devices["disk"][device.deviceInfo.label]["size"]
556                                     ),
557                                     device.deviceInfo.label,
558                                     float(device.capacityInKB / (1024.0 * 1024.0)),
559                                 )
560                             )
561                         else:
562                             disk_spec = _get_size_spec(device=device, size_kb=size_kb)
563                         if "mode" in devices["disk"][device.deviceInfo.label]:
564                             if devices["disk"][device.deviceInfo.label]["mode"] in [
565                                 "independent_persistent",
566                                 "independent_nonpersistent",
567                                 "dependent",
568                             ]:
569                                 mode = devices["disk"][device.deviceInfo.label]["mode"]
570                                 disk_spec = _get_mode_spec(device, mode, disk_spec)
571                             else:
572                                 raise SaltCloudSystemExit(
573                                     "Invalid disk backing mode specified!"
574                                 )
575                         if disk_spec is not None:
576                             device_specs.append(disk_spec)
577             elif isinstance(
578                 device.backing,
579                 (
580                     vim.vm.device.VirtualEthernetCard.NetworkBackingInfo,
581                     vim.vm.device.VirtualEthernetCard.DistributedVirtualPortBackingInfo,
582                 ),
583             ):
584                 if "network" in list(devices.keys()):
585                     existing_network_adapters_label.append(device.deviceInfo.label)
586                     if device.deviceInfo.label in list(devices["network"].keys()):
587                         network_name = devices["network"][device.deviceInfo.label][
588                             "name"
589                         ]
590                         adapter_type = (
591                             devices["network"][device.deviceInfo.label]["adapter_type"]
592                             if "adapter_type"
593                             in devices["network"][device.deviceInfo.label]
594                             else ""
595                         )
596                         switch_type = (
597                             devices["network"][device.deviceInfo.label]["switch_type"]
598                             if "switch_type"
599                             in devices["network"][device.deviceInfo.label]
600                             else ""
601                         )
602                         network_spec = _edit_existing_network_adapter(
603                             device,
604                             network_name,
605                             adapter_type,
606                             switch_type,
607                             container_ref,
608                         )
609                         adapter_mapping = _set_network_adapter_mapping(
610                             devices["network"][device.deviceInfo.label]
611                         )
612                         device_specs.append(network_spec)
613                         nics_map.append(adapter_mapping)
614             elif hasattr(device, "scsiCtlrUnitNumber"):
615                 if "scsi" in list(devices.keys()):
616                     bus_number += 1
617                     existing_scsi_controllers_label.append(device.deviceInfo.label)
618                     if device.deviceInfo.label in list(devices["scsi"].keys()):
619                         scsi_controller_properties = devices["scsi"][
620                             device.deviceInfo.label
621                         ]
622                         bus_sharing = (
623                             scsi_controller_properties["bus_sharing"].strip().lower()
624                             if "bus_sharing" in scsi_controller_properties
625                             else None
626                         )
627                         if bus_sharing and bus_sharing in ["virtual", "physical", "no"]:
628                             bus_sharing = "{}Sharing".format(bus_sharing)
629                             if bus_sharing != device.sharedBus:
630                                 scsi_spec = _edit_existing_scsi_controller(
631                                     device, bus_sharing
632                                 )
633                                 device_specs.append(scsi_spec)
634             elif isinstance(device, vim.vm.device.VirtualCdrom):
635                 if "cd" in list(devices.keys()):
636                     existing_cd_drives_label.append(device.deviceInfo.label)
637                     if device.deviceInfo.label in list(devices["cd"].keys()):
638                         device_type = (
639                             devices["cd"][device.deviceInfo.label]["device_type"]
640                             if "device_type" in devices["cd"][device.deviceInfo.label]
641                             else ""
642                         )
643                         mode = (
644                             devices["cd"][device.deviceInfo.label]["mode"]
645                             if "mode" in devices["cd"][device.deviceInfo.label]
646                             else ""
647                         )
648                         iso_path = (
649                             devices["cd"][device.deviceInfo.label]["iso_path"]
650                             if "iso_path" in devices["cd"][device.deviceInfo.label]
651                             else ""
652                         )
653                         cd_drive_spec = _edit_existing_cd_or_dvd_drive(
654                             device, device_type, mode, iso_path
655                         )
656                         device_specs.append(cd_drive_spec)
657             elif isinstance(device, vim.vm.device.VirtualIDEController):
658                 ide_controllers[device.key] = len(device.device)
659     if "network" in list(devices.keys()):
660         network_adapters_to_create = list(
661             set(devices["network"].keys()) - set(existing_network_adapters_label)
662         )
663         network_adapters_to_create.sort()
664         if network_adapters_to_create:
665             log.debug("Networks adapters to create: %s", network_adapters_to_create)
666         for network_adapter_label in network_adapters_to_create:
667             network_name = devices["network"][network_adapter_label]["name"]
668             adapter_type = (
669                 devices["network"][network_adapter_label]["adapter_type"]
670                 if "adapter_type" in devices["network"][network_adapter_label]
671                 else ""
672             )
673             switch_type = (
674                 devices["network"][network_adapter_label]["switch_type"]
675                 if "switch_type" in devices["network"][network_adapter_label]
676                 else ""
677             )
678             mac = (
679                 devices["network"][network_adapter_label]["mac"]
680                 if "mac" in devices["network"][network_adapter_label]
681                 else ""
682             )
683             network_spec = _add_new_network_adapter_helper(
684                 network_adapter_label,
685                 network_name,
686                 adapter_type,
687                 switch_type,
688                 mac,
689                 container_ref,
690             )
691             adapter_mapping = _set_network_adapter_mapping(
692                 devices["network"][network_adapter_label]
693             )
694             device_specs.append(network_spec)
695             nics_map.append(adapter_mapping)
696     if "scsi" in list(devices.keys()):
697         scsi_controllers_to_create = list(
698             set(devices["scsi"].keys()) - set(existing_scsi_controllers_label)
699         )
700         scsi_controllers_to_create.sort()
701         if scsi_controllers_to_create:
702             log.debug("SCSI controllers to create: %s", scsi_controllers_to_create)
703         for scsi_controller_label in scsi_controllers_to_create:
704             scsi_controller_properties = devices["scsi"][scsi_controller_label]
705             scsi_spec = _add_new_scsi_controller_helper(
706                 scsi_controller_label, scsi_controller_properties, bus_number
707             )
708             device_specs.append(scsi_spec)
709             bus_number += 1
710     if "ide" in list(devices.keys()):
711         ide_controllers_to_create = list(
712             set(devices["ide"].keys()) - set(existing_ide_controllers_label)
713         )
714         ide_controllers_to_create.sort()
715         if ide_controllers_to_create:
716             log.debug("IDE controllers to create: %s", ide_controllers_to_create)
717         vcenter_name = get_vcenter_version(call="function")
718         controller_index = (
719             SAFE_ESX_5_5_CONTROLLER_KEY_INDEX
720             if ESX_5_5_NAME_PORTION in vcenter_name
721             else None
722         )
723         for ide_controller_label in ide_controllers_to_create:
724             ide_spec = _add_new_ide_controller_helper(
725                 ide_controller_label, controller_index, bus_number
726             )
727             device_specs.append(ide_spec)
728             bus_number += 1
729             if controller_index is not None:
730                 controller_index += 1
731     if "disk" in list(devices.keys()):
732         disks_to_create = list(set(devices["disk"].keys()) - set(existing_disks_label))
733         disks_to_create.sort()
734         if disks_to_create:
735             log.debug("Hard disks to create: %s", disks_to_create)
736         for disk_label in disks_to_create:
737             size_gb = float(devices["disk"][disk_label]["size"])
738             thin_provision = (
739                 bool(devices["disk"][disk_label]["thin_provision"])
740                 if "thin_provision" in devices["disk"][disk_label]
741                 else False
742             )
743             eagerly_scrub = (
744                 bool(devices["disk"][disk_label]["eagerly_scrub"])
745                 if "eagerly_scrub" in devices["disk"][disk_label]
746                 else False
747             )
748             datastore = devices["disk"][disk_label].get("datastore", None)
749             disk_spec = _add_new_hard_disk_helper(
750                 disk_label,
751                 size_gb,
752                 unit_number,
753                 thin_provision=thin_provision,
754                 eagerly_scrub=eagerly_scrub,
755                 datastore=datastore,
756                 vm_name=new_vm_name,
757             )
758             if "controller" in devices["disk"][disk_label]:
759                 for spec in device_specs:
760                     if (
761                         spec.device.deviceInfo.label
762                         == devices["disk"][disk_label]["controller"]
763                     ):
764                         disk_spec.device.controllerKey = spec.device.key
765                         break
766             device_specs.append(disk_spec)
767             unit_number = _iter_disk_unit_number(unit_number)
768     if "cd" in list(devices.keys()):
769         cd_drives_to_create = list(
770             set(devices["cd"].keys()) - set(existing_cd_drives_label)
771         )
772         cd_drives_to_create.sort()
773         if cd_drives_to_create:
774             log.debug("CD/DVD drives to create: %s", cd_drives_to_create)
775         for cd_drive_label in cd_drives_to_create:
776             device_type = (
777                 devices["cd"][cd_drive_label]["device_type"]
778                 if "device_type" in devices["cd"][cd_drive_label]
779                 else ""
780             )
781             mode = (
782                 devices["cd"][cd_drive_label]["mode"]
783                 if "mode" in devices["cd"][cd_drive_label]
784                 else ""
785             )
786             iso_path = (
787                 devices["cd"][cd_drive_label]["iso_path"]
788                 if "iso_path" in devices["cd"][cd_drive_label]
789                 else ""
790             )
791             controller_key = None
792             if "controller" in devices["cd"][cd_drive_label]:
793                 for spec in device_specs:
794                     if (
795                         spec.device.deviceInfo.label
796                         == devices["cd"][cd_drive_label]["controller"]
797                     ):
798                         controller_key = spec.device.key
799                         ide_controllers[controller_key] = 0
800                         break
801             else:
802                 for ide_controller_key, num_devices in ide_controllers.items():
803                     if num_devices &lt; 2:
804                         controller_key = ide_controller_key
805                         break
806             if not controller_key:
807                 log.error(
808                     "No more available controllers for '%s'. "
809                     "All IDE controllers are currently in use",
810                     cd_drive_label,
811                 )
812             else:
813                 cd_drive_spec = _add_new_cd_or_dvd_drive_helper(
814                     cd_drive_label, controller_key, device_type, mode, iso_path
815                 )
816                 device_specs.append(cd_drive_spec)
817                 ide_controllers[controller_key] += 1
818     ret = {"device_specs": device_specs, "nics_map": nics_map}
819     return ret
820 def _wait_for_vmware_tools(vm_ref, max_wait):
821     time_counter = 0
822     starttime = time.time()
823     while time_counter &lt; max_wait:
824         if time_counter % 5 == 0:
825             log.info(
826                 "[ %s ] Waiting for VMware tools to be running [%s s]",
827                 vm_ref.name,
828                 time_counter,
829             )
830         if str(vm_ref.summary.guest.toolsRunningStatus) == "guestToolsRunning":
831             log.info(
832                 "[ %s ] Successfully got VMware tools running on the guest in "
833                 "%s seconds",
834                 vm_ref.name,
835                 time_counter,
836             )
837             return True
838         time.sleep(1.0 - ((time.time() - starttime) % 1.0))
839         time_counter += 1
840     log.warning(
841         "[ %s ] Timeout Reached. VMware tools still not running after waiting "
842         "for %s seconds",
843         vm_ref.name,
844         max_wait,
845     )
846     return False
847 def _valid_ip(ip_address):
848     octets = ip_address.split(".")
849     if len(octets) != 4:
850         return False
851     for i, octet in enumerate(octets):
852         try:
853             octets[i] = int(octet)
854         except ValueError:
855             return False
856     first_octet, second_octet, third_octet, fourth_octet = octets
857     if first_octet &lt; 1 or first_octet &gt; 223 or first_octet == 127:
858         return False
859     if first_octet == 169 and second_octet == 254:
860         return False
861     for octet in (second_octet, third_octet, fourth_octet):
862         if (octet &lt; 0) or (octet &gt; 255):
863             return False
864     return True
865 def _wait_for_ip(vm_ref, max_wait):
866     max_wait_vmware_tools = max_wait
867     max_wait_ip = max_wait
868     vmware_tools_status = _wait_for_vmware_tools(vm_ref, max_wait_vmware_tools)
869     if not vmware_tools_status:
870         vm_name = vm_ref.summary.config.name
871         resolved_ips = salt.utils.network.host_to_ips(vm_name)
872         log.debug(
873             "Timeout waiting for VMware tools. The name %s resolved to %s",
874             vm_name,
875             resolved_ips,
876         )
877         if isinstance(resolved_ips, list) and resolved_ips:
878             return resolved_ips[0]
879         return False
880     time_counter = 0
881     starttime = time.time()
882     while time_counter &lt; max_wait_ip:
883         if time_counter % 5 == 0:
884             log.info(
885                 "[ %s ] Waiting to retrieve IPv4 information [%s s]",
886                 vm_ref.name,
887                 time_counter,
888             )
889         if vm_ref.summary.guest.ipAddress and _valid_ip(vm_ref.summary.guest.ipAddress):
890             log.info(
891                 "[ %s ] Successfully retrieved IPv4 information in %s seconds",
892                 vm_ref.name,
893                 time_counter,
894             )
895             return vm_ref.summary.guest.ipAddress
896         for net in vm_ref.guest.net:
897             if net.ipConfig.ipAddress:
898                 for current_ip in net.ipConfig.ipAddress:
899                     if _valid_ip(current_ip.ipAddress):
900                         log.info(
901                             "[ %s ] Successfully retrieved IPv4 information "
902                             "in %s seconds",
903                             vm_ref.name,
904                             time_counter,
905                         )
906                         return current_ip.ipAddress
907         time.sleep(1.0 - ((time.time() - starttime) % 1.0))
908         time_counter += 1
909     log.warning(
910         "[ %s ] Timeout Reached. Unable to retrieve IPv4 information after "
911         "waiting for %s seconds",
912         vm_ref.name,
913         max_wait_ip,
914     )
915     return False
916 def _wait_for_host(host_ref, task_type, sleep_seconds=5, log_level="debug"):
917     time_counter = 0
918     starttime = time.time()
919     while host_ref.runtime.connectionState != "notResponding":
920         if time_counter % sleep_seconds == 0:
921             log.log(
922                 logging.INFO if log_level == "info" else logging.DEBUG,
923                 "[ %s ] Waiting for host %s to finish [%s s]",
924                 host_ref.name,
925                 task_type,
926                 time_counter,
927             )
928         time.sleep(1.0 - ((time.time() - starttime) % 1.0))
929         time_counter += 1
930     while host_ref.runtime.connectionState != "connected":
931         if time_counter % sleep_seconds == 0:
932             log.log(
933                 logging.INFO if log_level == "info" else logging.DEBUG,
934                 "[ %s ] Waiting for host %s to finish [%s s]",
935                 host_ref.name,
936                 task_type,
937                 time_counter,
938             )
939         time.sleep(1.0 - ((time.time() - starttime) % 1.0))
940         time_counter += 1
941     if host_ref.runtime.connectionState == "connected":
942         log.log(
943             logging.INFO if log_level == "info" else logging.DEBUG,
944             "[ %s ] Successfully completed host %s in %s seconds",
945             host_ref.name,
946             task_type,
947             time_counter,
948         )
949     else:
950         log.error("Could not connect back to the host system")
951 def _format_instance_info_select(vm, selection):
952     def defaultto(machine, section, default="N/A"):
953         return default if section not in machine else machine[section]
954     vm_select_info = {}
955     if "id" in selection:
956         vm_select_info["id"] = vm["name"]
957     if "image" in selection:
958         vm_select_info["image"] = "{} (Detected)".format(
959             defaultto(vm, "config.guestFullName")
960         )
961     if "size" in selection:
962         cpu = defaultto(vm, "config.hardware.numCPU")
963         ram = "{} MB".format(defaultto(vm, "config.hardware.memoryMB"))
964         vm_select_info["size"] = "cpu: {}\nram: {}".format(cpu, ram)
965         vm_select_info["size_dict"] = {
966             "cpu": cpu,
967             "memory": ram,
968         }
969     if "state" in selection:
970         vm_select_info["state"] = str(defaultto(vm, "summary.runtime.powerState"))
971     if "guest_id" in selection:
972         vm_select_info["guest_id"] = defaultto(vm, "config.guestId")
973     if "hostname" in selection:
974         vm_select_info["hostname"] = vm["object"].guest.hostName
975     if "path" in selection:
976         vm_select_info["path"] = defaultto(vm, "config.files.vmPathName")
977     if "tools_status" in selection:
978         vm_select_info["tools_status"] = str(defaultto(vm, "guest.toolsStatus"))
979     if "private_ips" in selection or "networks" in selection:
980         network_full_info = {}
981         ip_addresses = []
982         if "guest.net" in vm:
983             for net in vm["guest.net"]:
984                 network_full_info[net.network] = {
985                     "connected": net.connected,
986                     "ip_addresses": net.ipAddress,
987                     "mac_address": net.macAddress,
988                 }
989                 ip_addresses.extend(net.ipAddress)
990         if "private_ips" in selection:
991             vm_select_info["private_ips"] = ip_addresses
992         if "networks" in selection:
993             vm_select_info["networks"] = network_full_info
994     if any(x in ["devices", "mac_address", "mac_addresses"] for x in selection):
995         device_full_info = {}
996         device_mac_addresses = []
997         if "config.hardware.device" in vm:
998             for device in vm["config.hardware.device"]:
999                 device_full_info[device.deviceInfo.label] = {}
1000                 if "devices" in selection:
1001                     device_full_info[device.deviceInfo.label]["key"] = (device.key,)
1002                     device_full_info[device.deviceInfo.label]["label"] = (
1003                         device.deviceInfo.label,
1004                     )
1005                     device_full_info[device.deviceInfo.label]["summary"] = (
1006                         device.deviceInfo.summary,
1007                     )
1008                     device_full_info[device.deviceInfo.label]["type"] = type(
1009                         device
1010                     ).__name__.rsplit(".", 1)[1]
1011                     if device.unitNumber:
1012                         device_full_info[device.deviceInfo.label][
1013                             "unitNumber"
1014                         ] = device.unitNumber
1015                     if hasattr(device, "connectable") and device.connectable:
1016                         device_full_info[device.deviceInfo.label][
1017                             "startConnected"
1018                         ] = device.connectable.startConnected
1019                         device_full_info[device.deviceInfo.label][
1020                             "allowGuestControl"
1021                         ] = device.connectable.allowGuestControl
1022                         device_full_info[device.deviceInfo.label][
1023                             "connected"
1024                         ] = device.connectable.connected
1025                         device_full_info[device.deviceInfo.label][
1026                             "status"
1027                         ] = device.connectable.status
1028                     if hasattr(device, "controllerKey") and device.controllerKey:
1029                         device_full_info[device.deviceInfo.label][
1030                             "controllerKey"
1031                         ] = device.controllerKey
1032                     if hasattr(device, "addressType"):
1033                         device_full_info[device.deviceInfo.label][
1034                             "addressType"
1035                         ] = device.addressType
1036                     if hasattr(device, "busNumber"):
1037                         device_full_info[device.deviceInfo.label][
1038                             "busNumber"
1039                         ] = device.busNumber
1040                     if hasattr(device, "device"):
1041                         device_full_info[device.deviceInfo.label][
1042                             "deviceKeys"
1043                         ] = device.device
1044                     if hasattr(device, "videoRamSizeInKB"):
1045                         device_full_info[device.deviceInfo.label][
1046                             "videoRamSizeInKB"
1047                         ] = device.videoRamSizeInKB
1048                     if isinstance(device, vim.vm.device.VirtualDisk):
1049                         device_full_info[device.deviceInfo.label][
1050                             "capacityInKB"
1051                         ] = device.capacityInKB
1052                         device_full_info[device.deviceInfo.label][
1053                             "diskMode"
1054                         ] = device.backing.diskMode
1055                         device_full_info[device.deviceInfo.label][
1056                             "fileName"
1057                         ] = device.backing.fileName
1058                 if hasattr(device, "macAddress"):
1059                     device_full_info[device.deviceInfo.label][
1060                         "macAddress"
1061                     ] = device.macAddress
1062                     device_mac_addresses.append(device.macAddress)
1063         if "devices" in selection:
1064             vm_select_info["devices"] = device_full_info
1065         if "mac_address" in selection or "mac_addresses" in selection:
1066             vm_select_info["mac_addresses"] = device_mac_addresses
1067     if "storage" in selection:
1068         storage_full_info = {
1069             "committed": int(vm["summary.storage.committed"])
1070             if "summary.storage.committed" in vm
1071             else "N/A",
1072             "uncommitted": int(vm["summary.storage.uncommitted"])
1073             if "summary.storage.uncommitted" in vm
1074             else "N/A",
1075             "unshared": int(vm["summary.storage.unshared"])
1076             if "summary.storage.unshared" in vm
1077             else "N/A",
1078         }
1079         vm_select_info["storage"] = storage_full_info
1080     if "files" in selection:
1081         file_full_info = {}
1082         if "layoutEx.file" in vm:
1083             for filename in vm["layoutEx.file"]:
1084                 file_full_info[filename.key] = {
1085                     "key": filename.key,
1086                     "name": filename.name,
1087                     "size": filename.size,
1088                     "type": filename.type,
1089                 }
1090         vm_select_info["files"] = file_full_info
1091     return vm_select_info
1092 def _format_instance_info(vm):
1093     device_full_info = {}
1094     device_mac_addresses = []
1095     if "config.hardware.device" in vm:
1096         for device in vm["config.hardware.device"]:
1097             device_full_info[device.deviceInfo.label] = {
1098                 "key": device.key,
1099                 "label": device.deviceInfo.label,
1100                 "summary": device.deviceInfo.summary,
1101                 "type": type(device).__name__.rsplit(".", 1)[1],
1102             }
1103             if device.unitNumber:
1104                 device_full_info[device.deviceInfo.label][
1105                     "unitNumber"
1106                 ] = device.unitNumber
1107             if hasattr(device, "connectable") and device.connectable:
1108                 device_full_info[device.deviceInfo.label][
1109                     "startConnected"
1110                 ] = device.connectable.startConnected
1111                 device_full_info[device.deviceInfo.label][
1112                     "allowGuestControl"
1113                 ] = device.connectable.allowGuestControl
1114                 device_full_info[device.deviceInfo.label][
1115                     "connected"
1116                 ] = device.connectable.connected
1117                 device_full_info[device.deviceInfo.label][
1118                     "status"
1119                 ] = device.connectable.status
1120             if hasattr(device, "controllerKey") and device.controllerKey:
1121                 device_full_info[device.deviceInfo.label][
1122                     "controllerKey"
1123                 ] = device.controllerKey
1124             if hasattr(device, "addressType"):
1125                 device_full_info[device.deviceInfo.label][
1126                     "addressType"
1127                 ] = device.addressType
1128             if hasattr(device, "macAddress"):
1129                 device_full_info[device.deviceInfo.label][
1130                     "macAddress"
1131                 ] = device.macAddress
1132                 device_mac_addresses.append(device.macAddress)
1133             if hasattr(device, "busNumber"):
1134                 device_full_info[device.deviceInfo.label][
1135                     "busNumber"
1136                 ] = device.busNumber
1137             if hasattr(device, "device"):
1138                 device_full_info[device.deviceInfo.label]["deviceKeys"] = device.device
1139             if hasattr(device, "videoRamSizeInKB"):
1140                 device_full_info[device.deviceInfo.label][
1141                     "videoRamSizeInKB"
1142                 ] = device.videoRamSizeInKB
1143             if isinstance(device, vim.vm.device.VirtualDisk):
1144                 device_full_info[device.deviceInfo.label][
1145                     "capacityInKB"
1146                 ] = device.capacityInKB
1147                 device_full_info[device.deviceInfo.label][
1148                     "diskMode"
1149                 ] = device.backing.diskMode
1150                 device_full_info[device.deviceInfo.label][
1151                     "fileName"
1152                 ] = device.backing.fileName
1153     storage_full_info = {
1154         "committed": int(vm["summary.storage.committed"])
1155         if "summary.storage.committed" in vm
1156         else "N/A",
1157         "uncommitted": int(vm["summary.storage.uncommitted"])
1158         if "summary.storage.uncommitted" in vm
1159         else "N/A",
1160         "unshared": int(vm["summary.storage.unshared"])
1161         if "summary.storage.unshared" in vm
1162         else "N/A",
1163     }
1164     file_full_info = {}
1165     if "layoutEx.file" in vm:
1166         for filename in vm["layoutEx.file"]:
1167             file_full_info[filename.key] = {
1168                 "key": filename.key,
1169                 "name": filename.name,
1170                 "size": filename.size,
1171                 "type": filename.type,
1172             }
1173     network_full_info = {}
1174     ip_addresses = []
1175     if "guest.net" in vm:
1176         for net in vm["guest.net"]:
1177             network_full_info[net.network] = {
1178                 "connected": net.connected,
1179                 "ip_addresses": net.ipAddress,
1180                 "mac_address": net.macAddress,
1181             }
1182             ip_addresses.extend(net.ipAddress)
1183     cpu = vm["config.hardware.numCPU"] if "config.hardware.numCPU" in vm else "N/A"
1184     ram = (
1185         "{} MB".format(vm["config.hardware.memoryMB"])
1186         if "config.hardware.memoryMB" in vm
1187         else "N/A"
1188     )
1189     vm_full_info = {
1190         "id": str(vm["name"]),
1191         "image": "{} (Detected)".format(vm["config.guestFullName"])
1192         if "config.guestFullName" in vm
1193         else "N/A",
1194         "size": "cpu: {}\nram: {}".format(cpu, ram),
1195         "size_dict": {"cpu": cpu, "memory": ram},
1196         "state": str(vm["summary.runtime.powerState"])
1197         if "summary.runtime.powerState" in vm
1198         else "N/A",
1199         "private_ips": ip_addresses,
1200         "public_ips": [],
1201         "devices": device_full_info,
1202         "storage": storage_full_info,
1203         "files": file_full_info,
1204         "guest_id": str(vm["config.guestId"]) if "config.guestId" in vm else "N/A",
1205         "hostname": str(vm["object"].guest.hostName),
1206         "mac_addresses": device_mac_addresses,
1207         "networks": network_full_info,
1208         "path": str(vm["config.files.vmPathName"])
1209         if "config.files.vmPathName" in vm
1210         else "N/A",
1211         "tools_status": str(vm["guest.toolsStatus"])
1212         if "guest.toolsStatus" in vm
1213         else "N/A",
1214     }
1215     return vm_full_info
1216 def _get_snapshots(snapshot_list, current_snapshot=None, parent_snapshot_path=""):
1217     snapshots = {}
1218     for snapshot in snapshot_list:
1219         snapshot_path = "{}/{}".format(parent_snapshot_path, snapshot.name)
1220         snapshots[snapshot_path] = {
1221             "name": snapshot.name,
1222             "description": snapshot.description,
1223             "created": str(snapshot.createTime).split(".")[0],
1224             "state": snapshot.state,
1225             "path": snapshot_path,
1226         }
1227         if current_snapshot and current_snapshot == snapshot.snapshot:
1228             return snapshots[snapshot_path]
1229         if snapshot.childSnapshotList:
1230             ret = _get_snapshots(
1231                 snapshot.childSnapshotList, current_snapshot, snapshot_path
1232             )
1233             if current_snapshot:
1234                 return ret
1235             snapshots.update(ret)
1236     return snapshots
1237 def _get_snapshot_ref_helper(base_snapshot, snapshot_name):
1238     if base_snapshot.name == snapshot_name:
1239         return base_snapshot
1240     for snapshot in base_snapshot.childSnapshotList:
1241         snapshot_ref = _get_snapshot_ref_helper(snapshot, snapshot_name)
1242         if snapshot_ref is not None:
1243             return snapshot_ref
1244     return None
1245 def _get_snapshot_ref_by_name(vm_ref, snapshot_name):
1246     snapshot_ref = None
1247     try:
1248         for root_snapshot in vm_ref.snapshot.rootSnapshotList:
1249             snapshot_ref = _get_snapshot_ref_helper(root_snapshot, snapshot_name)
1250             if snapshot_ref is not None:
1251                 break
1252     except (IndexError, AttributeError):
1253         snapshot_ref = None
1254     return snapshot_ref
1255 def _upg_tools_helper(vm, reboot=False):
1256     if vm.config.template:
1257         status = "VMware tools cannot be updated on a template"
1258     elif vm.guest.toolsStatus == "toolsOk":
1259         status = "VMware tools is already up to date"
1260     elif vm.summary.runtime.powerState != "poweredOn":
1261         status = "VM must be powered on to upgrade tools"
1262     elif vm.guest.toolsStatus in ["toolsNotRunning", "toolsNotInstalled"]:
1263         status = "VMware tools is either not running or not installed"
1264     elif vm.guest.toolsStatus == "toolsOld":
1265         log.info("Upgrading VMware tools on %s", vm.name)
1266         try:
1267             if vm.guest.guestFamily == "windowsGuest" and not reboot:
1268                 log.info("Reboot suppressed on %s", vm.name)
1269                 task = vm.UpgradeTools('/S /v"/qn REBOOT=R"')
1270             elif vm.guest.guestFamily in ["linuxGuest", "windowsGuest"]:
1271                 task = vm.UpgradeTools()
1272             else:
1273                 return "Only Linux and Windows guests are currently supported"
1274             salt.utils.vmware.wait_for_task(
1275                 task, vm.name, "tools upgrade", sleep_seconds=5, log_level="info"
1276             )
1277         except Exception as exc:  # pylint: disable=broad-except
1278             log.error(
1279                 "Error while upgrading VMware tools on VM %s: %s",
1280                 vm.name,
1281                 exc,
1282                 exc_info_on_loglevel=logging.DEBUG,
1283             )
1284             return "VMware tools upgrade failed"
1285         status = "VMware tools upgrade succeeded"
1286     else:
1287         status = "VMWare tools could not be upgraded"
1288     return status
1289 def _get_hba_type(hba_type):
1290     if hba_type == "parallel":
1291         return vim.host.ParallelScsiHba
1292     elif hba_type == "block":
1293         return vim.host.BlockHba
1294     elif hba_type == "iscsi":
1295         return vim.host.InternetScsiHba
1296     elif hba_type == "fibre":
1297         return vim.host.FibreChannelHba
1298     raise ValueError("Unknown Host Bus Adapter Type")
1299 def test_vcenter_connection(kwargs=None, call=None):
1300     if call != "function":
1301         raise SaltCloudSystemExit(
1302             "The test_vcenter_connection function must be called with -f or --function."
1303         )
1304     try:
1305         _get_si()
1306     except Exception as exc:  # pylint: disable=broad-except
1307         return "failed to connect: {}".format(exc)
1308     return "connection successful"
1309 def get_vcenter_version(kwargs=None, call=None):
1310     if call != "function":
1311         raise SaltCloudSystemExit(
1312             "The get_vcenter_version function must be called with -f or --function."
1313         )
1314     inv = salt.utils.vmware.get_inventory(_get_si())
1315     return inv.about.fullName
1316 def list_datacenters(kwargs=None, call=None):
1317     if call != "function":
1318         raise SaltCloudSystemExit(
1319             "The list_datacenters function must be called with -f or --function."
1320         )
1321     return {"Datacenters": salt.utils.vmware.list_datacenters(_get_si())}
1322 def list_portgroups(kwargs=None, call=None):
1323     if call != "function":
1324         raise SaltCloudSystemExit(
1325             "The list_portgroups function must be called with -f or --function."
1326         )
1327     return {"Portgroups": salt.utils.vmware.list_portgroups(_get_si())}
1328 def list_clusters(kwargs=None, call=None):
1329     if call != "function":
1330         raise SaltCloudSystemExit(
1331             "The list_clusters function must be called with -f or --function."
1332         )
1333     return {"Clusters": salt.utils.vmware.list_clusters(_get_si())}
1334 def list_datastore_clusters(kwargs=None, call=None):
1335     if call != "function":
1336         raise SaltCloudSystemExit(
1337             "The list_datastore_clusters function must be called with -f or --function."
1338         )
1339     return {"Datastore Clusters": salt.utils.vmware.list_datastore_clusters(_get_si())}
1340 def list_datastores(kwargs=None, call=None):
1341     if call != "function":
1342         raise SaltCloudSystemExit(
1343             "The list_datastores function must be called with -f or --function."
1344         )
1345     return {"Datastores": salt.utils.vmware.list_datastores(_get_si())}
1346 def list_hosts(kwargs=None, call=None):
1347     if call != "function":
1348         raise SaltCloudSystemExit(
1349             "The list_hosts function must be called with -f or --function."
1350         )
1351     return {"Hosts": salt.utils.vmware.list_hosts(_get_si())}
1352 def list_resourcepools(kwargs=None, call=None):
1353     if call != "function":
1354         raise SaltCloudSystemExit(
1355             "The list_resourcepools function must be called with -f or --function."
1356         )
1357     return {"Resource Pools": salt.utils.vmware.list_resourcepools(_get_si())}
1358 def list_networks(kwargs=None, call=None):
1359     if call != "function":
1360         raise SaltCloudSystemExit(
1361             "The list_networks function must be called with -f or --function."
1362         )
1363     return {"Networks": salt.utils.vmware.list_networks(_get_si())}
1364 def list_nodes_min(kwargs=None, call=None):
1365     if call == "action":
1366         raise SaltCloudSystemExit(
1367             "The list_nodes_min function must be called with -f or --function."
1368         )
1369     ret = {}
1370     vm_properties = ["name"]
1371     vm_list = salt.utils.vmware.get_mors_with_properties(
1372         _get_si(), vim.VirtualMachine, vm_properties
1373     )
1374     for vm in vm_list:
1375         ret[vm["name"]] = {"state": "Running", "id": vm["name"]}
1376     return ret
1377 def list_nodes(kwargs=None, call=None):
1378     if call == "action":
1379         raise SaltCloudSystemExit(
1380             "The list_nodes function must be called with -f or --function."
1381         )
1382     ret = {}
1383     vm_properties = [
1384         "name",
1385         "guest.ipAddress",
1386         "config.guestFullName",
1387         "config.hardware.numCPU",
1388         "config.hardware.memoryMB",
1389         "summary.runtime.powerState",
1390     ]
1391     vm_list = salt.utils.vmware.get_mors_with_properties(
1392         _get_si(), vim.VirtualMachine, vm_properties
1393     )
1394     for vm in vm_list:
1395         cpu = vm["config.hardware.numCPU"] if "config.hardware.numCPU" in vm else "N/A"
1396         ram = (
1397             "{} MB".format(vm["config.hardware.memoryMB"])
1398             if "config.hardware.memoryMB" in vm
1399             else "N/A"
1400         )
1401         vm_info = {
1402             "id": vm["name"],
1403             "image": "{} (Detected)".format(vm["config.guestFullName"])
1404             if "config.guestFullName" in vm
1405             else "N/A",
1406             "size": "cpu: {}\nram: {}".format(cpu, ram),
1407             "size_dict": {"cpu": cpu, "memory": ram},
1408             "state": str(vm["summary.runtime.powerState"])
1409             if "summary.runtime.powerState" in vm
1410             else "N/A",
1411             "private_ips": [vm["guest.ipAddress"]] if "guest.ipAddress" in vm else [],
1412             "public_ips": [],
1413         }
1414         ret[vm_info["id"]] = vm_info
1415     return ret
1416 def list_nodes_full(kwargs=None, call=None):
1417     if call == "action":
1418         raise SaltCloudSystemExit(
1419             "The list_nodes_full function must be called with -f or --function."
1420         )
1421     ret = {}
1422     vm_properties = [
1423         "config.hardware.device",
1424         "summary.storage.committed",
1425         "summary.storage.uncommitted",
1426         "summary.storage.unshared",
1427         "layoutEx.file",
1428         "config.guestFullName",
1429         "config.guestId",
1430         "guest.net",
1431         "config.hardware.memoryMB",
1432         "name",
1433         "config.hardware.numCPU",
1434         "config.files.vmPathName",
1435         "summary.runtime.powerState",
1436         "guest.toolsStatus",
1437     ]
1438     vm_list = salt.utils.vmware.get_mors_with_properties(
1439         _get_si(), vim.VirtualMachine, vm_properties
1440 <a name="9"></a>    )
1441     for vm in vm_list:
1442         ret[vm["name"]] = _format_instance_info(<font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>vm)
1443     return ret
1444 def list_nodes_select(call=None):
1445     if call == "action":
1446         raise SaltCloudSystemExit(
1447             "The list_nodes_select function must be called with -f or --function."
1448         )
1449     ret = {}
1450     vm_properties = []
1451     selection =</b></font> __opts__.get("query.selection")
1452     if not selection:
1453         raise SaltCloudSystemExit("query.selection not found in /etc/salt/cloud")
1454     if "id" in selection:
1455         vm_properties.append("name")
1456     if "image" in selection:
1457         vm_properties.append("config.guestFullName")
1458     if "size" in selection:
1459         vm_properties.extend(["config.hardware.numCPU", "config.hardware.memoryMB"])
1460     if "state" in selection:
1461         vm_properties.append("summary.runtime.powerState")
1462     if "private_ips" in selection or "networks" in selection:
1463         vm_properties.append("guest.net")
1464     if (
1465         "devices" in selection
1466         or "mac_address" in selection
1467         or "mac_addresses" in selection
1468     ):
1469         vm_properties.append("config.hardware.device")
1470     if "storage" in selection:
1471         vm_properties.extend(
1472             [
1473                 "config.hardware.device",
1474                 "summary.storage.committed",
1475                 "summary.storage.uncommitted",
1476                 "summary.storage.unshared",
1477             ]
1478         )
1479     if "files" in selection:
1480         vm_properties.append("layoutEx.file")
1481     if "guest_id" in selection:
1482         vm_properties.append("config.guestId")
1483     if "hostname" in selection:
1484         vm_properties.append("guest.hostName")
1485     if "path" in selection:
1486         vm_properties.append("config.files.vmPathName")
1487     if "tools_status" in selection:
1488         vm_properties.append("guest.toolsStatus")
1489     if not vm_properties:
1490         return {}
1491     elif "name" not in vm_properties:
1492         vm_properties.append("name")
1493     vm_list = salt.utils.vmware.get_mors_with_properties(
1494         _get_si(), vim.VirtualMachine, vm_properties
1495     )
1496     for vm in vm_list:
1497         ret[vm["name"]] = _format_instance_info_select(vm, selection)
1498     return ret
1499 def show_instance(name, call=None):
1500     if call != "action":
1501         raise SaltCloudSystemExit(
1502             "The show_instance action must be called with -a or --action."
1503         )
1504     vm_properties = [
1505         "config.hardware.device",
1506         "summary.storage.committed",
1507         "summary.storage.uncommitted",
1508         "summary.storage.unshared",
1509         "layoutEx.file",
1510         "config.guestFullName",
1511         "config.guestId",
1512         "guest.net",
1513         "config.hardware.memoryMB",
1514         "name",
1515         "config.hardware.numCPU",
1516         "config.files.vmPathName",
1517         "summary.runtime.powerState",
1518         "guest.toolsStatus",
1519     ]
1520     vm_list = salt.utils.vmware.get_mors_with_properties(
1521         _get_si(), vim.VirtualMachine, vm_properties
1522     )
1523     for vm in vm_list:
1524         if vm["name"] == name:
1525             return _format_instance_info(vm)
1526     return {}
1527 def avail_images(call=None):
1528     if call == "action":
1529         raise SaltCloudSystemExit(
1530             "The avail_images function must be called with "
1531             "-f or --function, or with the --list-images option."
1532         )
1533     templates = {}
1534     vm_properties = [
1535         "name",
1536         "config.template",
1537         "config.guestFullName",
1538         "config.hardware.numCPU",
1539         "config.hardware.memoryMB",
1540     ]
1541     vm_list = salt.utils.vmware.get_mors_with_properties(
1542         _get_si(), vim.VirtualMachine, vm_properties
1543     )
1544     for vm in vm_list:
1545         if "config.template" in vm and vm["config.template"]:
1546             templates[vm["name"]] = {
1547                 "name": vm["name"],
1548                 "guest_fullname": vm["config.guestFullName"]
1549                 if "config.guestFullName" in vm
1550                 else "N/A",
1551                 "cpus": vm["config.hardware.numCPU"]
1552                 if "config.hardware.numCPU" in vm
1553                 else "N/A",
1554                 "ram": vm["config.hardware.memoryMB"]
1555                 if "config.hardware.memoryMB" in vm
1556                 else "N/A",
1557             }
1558     return templates
1559 def avail_locations(call=None):
1560     if call == "action":
1561         raise SaltCloudSystemExit(
1562             "The avail_locations function must be called with "
1563             "-f or --function, or with the --list-locations option."
1564         )
1565     return list_datacenters(call="function")
1566 def avail_sizes(call=None):
1567     if call == "action":
1568         raise SaltCloudSystemExit(
1569             "The avail_sizes function must be called with "
1570             "-f or --function, or with the --list-sizes option."
1571         )
1572     log.warning(
1573         "Because sizes are built into templates with VMware, there are no sizes "
1574         "to return."
1575     )
1576     return {}
1577 def list_templates(kwargs=None, call=None):
1578     if call != "function":
1579         raise SaltCloudSystemExit(
1580             "The list_templates function must be called with -f or --function."
1581         )
1582     return {"Templates": avail_images(call="function")}
1583 def list_folders(kwargs=None, call=None):
1584     if call != "function":
1585         raise SaltCloudSystemExit(
1586             "The list_folders function must be called with -f or --function."
1587         )
1588     return {"Folders": salt.utils.vmware.list_folders(_get_si())}
1589 def list_snapshots(kwargs=None, call=None):
1590     if call != "function":
1591         raise SaltCloudSystemExit(
1592             "The list_snapshots function must be called with -f or --function."
1593         )
1594     ret = {}
1595     vm_properties = ["name", "rootSnapshot", "snapshot"]
1596     vm_list = salt.utils.vmware.get_mors_with_properties(
1597         _get_si(), vim.VirtualMachine, vm_properties
1598     )
1599     for vm in vm_list:
1600         if vm["rootSnapshot"]:
1601             if kwargs and kwargs.get("name") == vm["name"]:
1602                 return {vm["name"]: _get_snapshots(vm["snapshot"].rootSnapshotList)}
1603             else:
1604                 ret[vm["name"]] = _get_snapshots(vm["snapshot"].rootSnapshotList)
1605         else:
1606             if kwargs and kwargs.get("name") == vm["name"]:
1607                 return {}
1608     return ret
1609 def start(name, call=None):
1610     if call != "action":
1611         raise SaltCloudSystemExit(
1612             "The start action must be called with -a or --action."
1613         )
1614     vm_properties = ["name", "summary.runtime.powerState"]
1615     vm_list = salt.utils.vmware.get_mors_with_properties(
1616         _get_si(), vim.VirtualMachine, vm_properties
1617     )
1618     for vm in vm_list:
1619         if vm["name"] == name:
1620             if vm["summary.runtime.powerState"] == "poweredOn":
1621                 ret = "already powered on"
1622                 log.info("VM %s %s", name, ret)
1623                 return ret
1624             try:
1625                 log.info("Starting VM %s", name)
1626                 task = vm["object"].PowerOn()
1627                 salt.utils.vmware.wait_for_task(task, name, "power on")
1628             except Exception as exc:  # pylint: disable=broad-except
1629                 log.error(
1630                     "Error while powering on VM %s: %s",
1631                     name,
1632                     exc,
1633                     exc_info_on_loglevel=logging.DEBUG,
1634                 )
1635                 return "failed to power on"
1636     return "powered on"
1637 def stop(name, soft=False, call=None):
1638     if call != "action":
1639         raise SaltCloudSystemExit("The stop action must be called with -a or --action.")
1640     vm_properties = ["name", "summary.runtime.powerState"]
1641     vm_list = salt.utils.vmware.get_mors_with_properties(
1642         _get_si(), vim.VirtualMachine, vm_properties
1643     )
1644     for vm in vm_list:
1645         if vm["name"] == name:
1646             if vm["summary.runtime.powerState"] == "poweredOff":
1647                 ret = "already powered off"
1648                 log.info("VM %s %s", name, ret)
1649                 return ret
1650             try:
1651                 log.info("Stopping VM %s", name)
1652                 if soft:
1653                     vm["object"].ShutdownGuest()
1654                 else:
1655                     task = vm["object"].PowerOff()
1656                     salt.utils.vmware.wait_for_task(task, name, "power off")
1657             except Exception as exc:  # pylint: disable=broad-except
1658                 log.error(
1659                     "Error while powering off VM %s: %s",
1660                     name,
1661                     exc,
1662                     exc_info_on_loglevel=logging.DEBUG,
1663                 )
1664                 return "failed to power off"
1665     return "powered off"
1666 def suspend(name, call=None):
1667     if call != "action":
1668         raise SaltCloudSystemExit(
1669             "The suspend action must be called with -a or --action."
1670         )
1671     vm_properties = ["name", "summary.runtime.powerState"]
1672     vm_list = salt.utils.vmware.get_mors_with_properties(
1673         _get_si(), vim.VirtualMachine, vm_properties
1674     )
1675     for vm in vm_list:
1676         if vm["name"] == name:
1677             if vm["summary.runtime.powerState"] == "poweredOff":
1678                 ret = "cannot suspend in powered off state"
1679                 log.info("VM %s %s", name, ret)
1680                 return ret
1681             elif vm["summary.runtime.powerState"] == "suspended":
1682                 ret = "already suspended"
1683                 log.info("VM %s %s", name, ret)
1684                 return ret
1685             try:
1686                 log.info("Suspending VM %s", name)
1687                 task = vm["object"].Suspend()
1688                 salt.utils.vmware.wait_for_task(task, name, "suspend")
1689             except Exception as exc:  # pylint: disable=broad-except
1690                 log.error(
1691                     "Error while suspending VM %s: %s",
1692                     name,
1693                     exc,
1694                     exc_info_on_loglevel=logging.DEBUG,
1695                 )
1696                 return "failed to suspend"
1697     return "suspended"
1698 def reset(name, soft=False, call=None):
1699     if call != "action":
1700         raise SaltCloudSystemExit(
1701             "The reset action must be called with -a or --action."
1702         )
1703     vm_properties = ["name", "summary.runtime.powerState"]
1704     vm_list = salt.utils.vmware.get_mors_with_properties(
1705         _get_si(), vim.VirtualMachine, vm_properties
1706     )
1707     for vm in vm_list:
1708         if vm["name"] == name:
1709             if (
1710                 vm["summary.runtime.powerState"] == "suspended"
1711                 or vm["summary.runtime.powerState"] == "poweredOff"
1712             ):
1713                 ret = "cannot reset in suspended/powered off state"
1714                 log.info("VM %s %s", name, ret)
1715                 return ret
1716             try:
1717                 log.info("Resetting VM %s", name)
1718                 if soft:
1719                     vm["object"].RebootGuest()
1720                 else:
1721                     task = vm["object"].ResetVM_Task()
1722                     salt.utils.vmware.wait_for_task(task, name, "reset")
1723             except Exception as exc:  # pylint: disable=broad-except
1724                 log.error(
1725                     "Error while resetting VM %s: %s",
1726                     name,
1727                     exc,
1728                     exc_info_on_loglevel=logging.DEBUG,
1729                 )
1730                 return "failed to reset"
1731     return "reset"
1732 def terminate(name, call=None):
1733     if call != "action":
1734         raise SaltCloudSystemExit(
1735             "The terminate action must be called with -a or --action."
1736         )
1737     vm_properties = ["name", "summary.runtime.powerState"]
1738     vm_list = salt.utils.vmware.get_mors_with_properties(
1739         _get_si(), vim.VirtualMachine, vm_properties
1740     )
1741     for vm in vm_list:
1742         if vm["name"] == name:
1743             if vm["summary.runtime.powerState"] == "poweredOff":
1744                 ret = "already powered off"
1745                 log.info("VM %s %s", name, ret)
1746                 return ret
1747             try:
1748                 log.info("Terminating VM %s", name)
1749                 vm["object"].Terminate()
1750             except Exception as exc:  # pylint: disable=broad-except
1751                 log.error(
1752                     "Error while terminating VM %s: %s",
1753                     name,
1754                     exc,
1755                     exc_info_on_loglevel=logging.DEBUG,
1756 <a name="3"></a>                )
1757                 return "failed to terminate"
1758     r<font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>eturn "terminated"
1759 def destroy(name, call=None):
1760     if call == "function":
1761         raise SaltCloudSystemExit(
1762             "The destroy action must be called with -d, --destroy, -a or --action."
1763         )
1764     __utils__["cloud.fire_event"](
1765         "event",
1766         "destroying instance",
1767         "salt/cloud/{}/destroying".format(name),
1768         args={"name": name},
1769         sock_dir=__opts__["sock_dir"],
1770         transport=__opts__["transport"],
1771     )
1772     vm_properties =</b></font> ["name", "summary.runtime.powerState"]
1773     vm_list = salt.utils.vmware.get_mors_with_properties(
1774         _get_si(), vim.VirtualMachine, vm_properties
1775     )
1776     for vm in vm_list:
1777         if vm["name"] == name:
1778             if vm["summary.runtime.powerState"] != "poweredOff":
1779                 try:
1780                     log.info("Powering Off VM %s", name)
1781                     task = vm["object"].PowerOff()
1782                     salt.utils.vmware.wait_for_task(task, name, "power off")
1783                 except Exception as exc:  # pylint: disable=broad-except
1784                     log.error(
1785                         "Error while powering off VM %s: %s",
1786                         name,
1787                         exc,
1788                         exc_info_on_loglevel=logging.DEBUG,
1789                     )
1790                     return "failed to destroy"
1791             try:
1792                 log.info("Destroying VM %s", name)
1793                 task = vm["object"].Destroy_Task()
1794                 salt.utils.vmware.wait_for_task(task, name, "destroy")
1795             except Exception as exc:  # pylint: disable=broad-except
1796                 log.error(
1797                     "Error while destroying VM %s: %s",
1798                     name,
1799                     exc,
1800                     exc_info_on_loglevel=logging.DEBUG,
1801 <a name="2"></a>                )
1802                 return "failed to destroy"
1803     __utils__<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["cloud.fire_event"](
1804         "event",
1805         "destroyed instance",
1806         "salt/cloud/{}/destroyed".format(name),
1807         args={"name": name},
1808         sock_dir=__opts__["sock_dir"],
1809         transport=__opts__["transport"],
1810     )
1811     if __opts__.get("update_cachedir", False) is True:
1812         __utils__["cloud.delete_minion_cachedir"](
1813 <a name="0"></a>            name, _get_active_provider_name().split(":")[</b></font>0], __opts__
1814         )
1815     <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>return True
1816 def create(vm_):
1817     try:
1818         if (
1819             vm_["profile"]
1820             and config.is_profile_configured(
1821                 __opts__,
1822                 _get_active_provider_name() or "vmware",
1823                 vm_["profile"],
1824                 vm_=vm_,
1825             )
1826             is False
1827         ):
1828             return False
1829     except AttributeError:
1830         pass
1831     __utils__["cloud.fire_event"](
1832         "event",
1833         "starting create",
1834         "salt/cloud/{}/creating".format(vm_["name"]),
1835         args=__utils__["cloud.filter_event"](
1836             "creating", vm_, ["name", "profile", "provider", "driver"]
1837         ),
1838         sock_dir=__opts__["sock_dir"],
1839         transport=__opts__[</b></font>"transport"],
1840     )
1841     vm_name = config.get_cloud_config_value("name", vm_, __opts__, default=None)
1842     folder = config.get_cloud_config_value("folder", vm_, __opts__, default=None)
1843     datacenter = config.get_cloud_config_value(
1844         "datacenter", vm_, __opts__, default=None
1845     )
1846     resourcepool = config.get_cloud_config_value(
1847         "resourcepool", vm_, __opts__, default=None
1848     )
1849     cluster = config.get_cloud_config_value("cluster", vm_, __opts__, default=None)
1850     datastore = config.get_cloud_config_value("datastore", vm_, __opts__, default=None)
1851     host = config.get_cloud_config_value("host", vm_, __opts__, default=None)
1852     template = config.get_cloud_config_value("template", vm_, __opts__, default=False)
1853     num_cpus = config.get_cloud_config_value("num_cpus", vm_, __opts__, default=None)
1854     cores_per_socket = config.get_cloud_config_value(
1855         "cores_per_socket", vm_, __opts__, default=None
1856     )
1857     instant_clone = config.get_cloud_config_value(
1858         "instant_clone", vm_, __opts__, default=False
1859     )
1860     memory = config.get_cloud_config_value("memory", vm_, __opts__, default=None)
1861     devices = config.get_cloud_config_value("devices", vm_, __opts__, default=None)
1862     extra_config = config.get_cloud_config_value(
1863         "extra_config", vm_, __opts__, default=None
1864     )
1865     annotation = config.get_cloud_config_value(
1866         "annotation", vm_, __opts__, default=None
1867     )
1868     power = config.get_cloud_config_value("power_on", vm_, __opts__, default=True)
1869     key_filename = config.get_cloud_config_value(
1870         "private_key", vm_, __opts__, search_global=False, default=None
1871     )
1872     deploy = config.get_cloud_config_value(
1873         "deploy", vm_, __opts__, search_global=True, default=True
1874     )
1875     wait_for_ip_timeout = config.get_cloud_config_value(
1876         "wait_for_ip_timeout", vm_, __opts__, default=20 * 60
1877     )
1878     domain = config.get_cloud_config_value(
1879         "domain", vm_, __opts__, search_global=False, default="local"
1880     )
1881     hardware_version = config.get_cloud_config_value(
1882         "hardware_version", vm_, __opts__, search_global=False, default=None
1883     )
1884     guest_id = config.get_cloud_config_value(
1885         "image", vm_, __opts__, search_global=False, default=None
1886     )
1887     customization = config.get_cloud_config_value(
1888         "customization", vm_, __opts__, search_global=False, default=True
1889     )
1890     customization_spec = config.get_cloud_config_value(
1891         "customization_spec", vm_, __opts__, search_global=False, default=None
1892     )
1893     win_password = config.get_cloud_config_value(
1894         "win_password", vm_, __opts__, search_global=False, default=None
1895     )
1896     win_organization_name = config.get_cloud_config_value(
1897         "win_organization_name",
1898         vm_,
1899         __opts__,
1900         search_global=False,
1901         default="Organization",
1902     )
1903     plain_text = config.get_cloud_config_value(
1904         "plain_text", vm_, __opts__, search_global=False, default=False
1905     )
1906     win_user_fullname = config.get_cloud_config_value(
1907         "win_user_fullname", vm_, __opts__, search_global=False, default="Windows User"
1908     )
1909     win_run_once = config.get_cloud_config_value(
1910         "win_run_once", vm_, __opts__, search_global=False, default=None
1911     )
1912     cpu_hot_add = config.get_cloud_config_value(
1913         "cpu_hot_add", vm_, __opts__, search_global=False, default=None
1914     )
1915     cpu_hot_remove = config.get_cloud_config_value(
1916         "cpu_hot_remove", vm_, __opts__, search_global=False, default=None
1917     )
1918     mem_hot_add = config.get_cloud_config_value(
1919         "mem_hot_add", vm_, __opts__, search_global=False, default=None
1920     )
1921     nested_hv = config.get_cloud_config_value(
1922         "nested_hv", vm_, __opts__, search_global=False, default=None
1923     )
1924     vpmc = config.get_cloud_config_value(
1925         "vpmc", vm_, __opts__, search_global=False, default=None
1926     )
1927     si = _get_si()
1928     container_ref = None
1929     if datacenter:
1930         datacenter_ref = salt.utils.vmware.get_mor_by_property(
1931             _get_si(), vim.Datacenter, datacenter
1932         )
1933         container_ref = datacenter_ref if datacenter_ref else None
1934     if "clonefrom" in vm_:
1935         if datacenter:
1936             datacenter_ref = salt.utils.vmware.get_mor_by_property(
1937                 si, vim.Datacenter, datacenter
1938             )
1939             container_ref = datacenter_ref if datacenter_ref else None
1940         object_ref = salt.utils.vmware.get_mor_by_property(
1941             si, vim.VirtualMachine, vm_["clonefrom"], container_ref=container_ref
1942         )
1943         if object_ref:
1944             clone_type = "template" if object_ref.config.template else "vm"
1945         else:
1946             raise SaltCloudSystemExit(
1947                 "The VM/template that you have specified under clonefrom does not"
1948                 " exist."
1949             )
1950     else:
1951         clone_type = None
1952         object_ref = None
1953     if resourcepool:
1954         resourcepool_ref = salt.utils.vmware.get_mor_by_property(
1955             si, vim.ResourcePool, resourcepool, container_ref=container_ref
1956         )
1957         if not resourcepool_ref:
1958             log.error("Specified resource pool: '%s' does not exist", resourcepool)
1959             if not clone_type or clone_type == "template":
1960                 raise SaltCloudSystemExit(
1961                     "You must specify a resource pool that exists."
1962                 )
1963     elif cluster:
1964         cluster_ref = salt.utils.vmware.get_mor_by_property(
1965             si, vim.ClusterComputeResource, cluster, container_ref=container_ref
1966         )
1967         if not cluster_ref:
1968             log.error("Specified cluster: '%s' does not exist", cluster)
1969             if not clone_type or clone_type == "template":
1970                 raise SaltCloudSystemExit("You must specify a cluster that exists.")
1971         else:
1972             resourcepool_ref = cluster_ref.resourcePool
1973     elif clone_type == "template":
1974         raise SaltCloudSystemExit(
1975             "You must either specify a cluster or a resource pool when cloning from a"
1976             " template."
1977         )
1978     elif not clone_type:
1979         raise SaltCloudSystemExit(
1980             "You must either specify a cluster or a resource pool when creating."
1981         )
1982     else:
1983         log.debug("Using resource pool used by the %s %s", clone_type, vm_["clonefrom"])
1984     if folder:
1985         folder_parts = folder.split("/")
1986         search_reference = container_ref
1987         for folder_part in folder_parts:
1988             if folder_part:
1989                 folder_ref = salt.utils.vmware.get_mor_by_property(
1990                     si, vim.Folder, folder_part, container_ref=search_reference
1991                 )
1992                 search_reference = folder_ref
1993         if not folder_ref:
1994             log.error("Specified folder: '%s' does not exist", folder)
1995             log.debug(
1996                 "Using folder in which %s %s is present", clone_type, vm_["clonefrom"]
1997             )
1998             folder_ref = object_ref.parent
1999     elif datacenter:
2000         if not datacenter_ref:
2001             log.error("Specified datacenter: '%s' does not exist", datacenter)
2002             log.debug(
2003                 "Using datacenter folder in which %s %s is present",
2004                 clone_type,
2005                 vm_["clonefrom"],
2006             )
2007             folder_ref = object_ref.parent
2008         else:
2009             folder_ref = datacenter_ref.vmFolder
2010     elif not clone_type:
2011         raise SaltCloudSystemExit(
2012             "You must either specify a folder or a datacenter when creating not"
2013             " cloning."
2014         )
2015     else:
2016         log.debug(
2017             "Using folder in which %s %s is present", clone_type, vm_["clonefrom"]
2018         )
2019         folder_ref = object_ref.parent
2020     if "clonefrom" in vm_:
2021         reloc_spec = vim.vm.RelocateSpec()
2022         if (resourcepool and resourcepool_ref) or (cluster and cluster_ref):
2023             reloc_spec.pool = resourcepool_ref
2024         if datastore:
2025             datastore_ref = salt.utils.vmware.get_mor_by_property(
2026                 si, vim.Datastore, datastore, container_ref=container_ref
2027             )
2028             if datastore_ref:
2029                 reloc_spec.datastore = datastore_ref
2030             else:
2031                 datastore_cluster_ref = salt.utils.vmware.get_mor_by_property(
2032                     si, vim.StoragePod, datastore, container_ref=container_ref
2033                 )
2034                 if not datastore_cluster_ref:
2035                     log.error(
2036                         "Specified datastore/datastore cluster: '%s' does not exist",
2037                         datastore,
2038                     )
2039                     log.debug(
2040                         "Using datastore used by the %s %s",
2041                         clone_type,
2042                         vm_["clonefrom"],
2043                     )
2044         else:
2045             log.debug("No datastore/datastore cluster specified")
2046             log.debug("Using datastore used by the %s %s", clone_type, vm_["clonefrom"])
2047         if host:
2048             host_ref = salt.utils.vmware.get_mor_by_property(
2049                 si, vim.HostSystem, host, container_ref=container_ref
2050             )
2051             if host_ref:
2052                 reloc_spec.host = host_ref
2053             else:
2054                 log.error("Specified host: '%s' does not exist", host)
2055         if instant_clone:
2056             instant_clone_spec = vim.vm.InstantCloneSpec()
2057             instant_clone_spec.name = vm_name
2058             instant_clone_spec.location = reloc_spec
2059             event_kwargs = vm_.copy()
2060             if event_kwargs.get("password"):
2061 <a name="7"></a>                del event_kwargs["password"]
2062             try:
2063                 __utils__<font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["cloud.fire_event"](
2064                     "event",
2065                     "requesting instance",
2066                     "salt/cloud/{}/requesting".format(vm_["name"]),
2067                     args=__utils__["cloud.filter_event"](
2068                         "requesting", event_kwargs, list(event_kwargs)
2069                     ),
2070                     sock_dir=__opts__["sock_dir"],
2071                     transport=__opts__[</b></font>"transport"],
2072                 )
2073                 log.info(
2074                     "Creating %s from %s(%s)", vm_["name"], clone_type, vm_["clonefrom"]
2075                 )
2076                 if datastore and not datastore_ref and datastore_cluster_ref:
2077                     pod_spec = vim.storageDrs.PodSelectionSpec(
2078                         storagePod=datastore_cluster_ref
2079                     )
2080                     storage_spec = vim.storageDrs.StoragePlacementSpec(
2081                         type="clone",
2082                         vm=object_ref,
2083                         podSelectionSpec=pod_spec,
2084                         cloneName=vm_name,
2085                         folder=folder_ref,
2086                     )
2087                     recommended_datastores = (
2088                         si.content.storageResourceManager.RecommendDatastores(
2089                             storageSpec=storage_spec
2090                         )
2091                     )
2092                     task = si.content.storageResourceManager.ApplyStorageDrsRecommendation_Task(
2093                         recommended_datastores.recommendations[0].key
2094                     )
2095                     salt.utils.vmware.wait_for_task(
2096                         task, vm_name, "apply storage DRS recommendations", 5, "info"
2097                     )
2098                 else:
2099                     task = object_ref.InstantClone_Task(spec=instant_clone_spec)
2100                     salt.utils.vmware.wait_for_task(
2101                         task, vm_name, "Instantclone", 5, "info"
2102                     )
2103             except Exception as exc:  # pylint: disable=broad-except
2104                 err_msg = "Error Instant cloning {}: {}".format(vm_["name"], exc)
2105                 log.error(
2106                     err_msg,
2107                     exc_info_on_loglevel=logging.DEBUG,
2108                 )
2109                 return {"Error": err_msg}
2110             new_vm_ref = salt.utils.vmware.get_mor_by_property(
2111                 si, vim.VirtualMachine, vm_name, container_ref=container_ref
2112             )
2113             out = None
2114             if not template and power:
2115                 ip = _wait_for_ip(new_vm_ref, wait_for_ip_timeout)
2116                 if ip:
2117                     log.info("[ %s ] IPv4 is: %s", vm_name, ip)
2118                     if deploy:
2119                         vm_["key_filename"] = key_filename
2120                         if "ssh_host" not in vm_:
2121                             vm_["ssh_host"] = ip
2122                         log.info("[ %s ] Deploying to %s", vm_name, vm_["ssh_host"])
2123                         out = __utils__["cloud.bootstrap"](vm_, __opts__)
2124             data = show_instance(vm_name, call="action")
2125             if deploy and isinstance(out, dict):
2126                 data["deploy_kwargs"] = out.get("deploy_kwargs", {})
2127             __utils__["cloud.fire_event"](
2128                 "event",
2129                 "created instance",
2130                 "salt/cloud/{}/created".format(vm_["name"]),
2131                 args=__utils__["cloud.filter_event"](
2132                     "created", vm_, ["name", "profile", "provider", "driver"]
2133                 ),
2134                 sock_dir=__opts__["sock_dir"],
2135                 transport=__opts__["transport"],
2136             )
2137             return {"Instant Clone created successfully": data}
2138     else:
2139         if not datastore:
2140             raise SaltCloudSystemExit(
2141                 "You must specify a datastore when creating not cloning."
2142             )
2143         else:
2144             datastore_ref = salt.utils.vmware.get_mor_by_property(
2145                 si, vim.Datastore, datastore
2146             )
2147             if not datastore_ref:
2148                 raise SaltCloudSystemExit(
2149                     "Specified datastore: '{}' does not exist".format(datastore)
2150                 )
2151         if host:
2152             host_ref = salt.utils.vmware.get_mor_by_property(
2153                 _get_si(), vim.HostSystem, host, container_ref=container_ref
2154             )
2155             if not host_ref:
2156                 log.error("Specified host: '%s' does not exist", host)
2157     config_spec = vim.vm.ConfigSpec()
2158     if hardware_version and object_ref is not None:
2159         hardware_version = "vmx-{:02}".format(hardware_version)
2160         if hardware_version != object_ref.config.version:
2161             log.debug(
2162                 "Scheduling hardware version upgrade from %s to %s",
2163                 object_ref.config.version,
2164                 hardware_version,
2165             )
2166             scheduled_hardware_upgrade = vim.vm.ScheduledHardwareUpgradeInfo()
2167             scheduled_hardware_upgrade.upgradePolicy = "always"
2168             scheduled_hardware_upgrade.versionKey = hardware_version
2169             config_spec.scheduledHardwareUpgradeInfo = scheduled_hardware_upgrade
2170         else:
2171             log.debug("Virtual hardware version already set to %s", hardware_version)
2172     if num_cpus:
2173         log.debug("Setting cpu to: %s", num_cpus)
2174         config_spec.numCPUs = int(num_cpus)
2175     if cores_per_socket:
2176         log.debug("Setting cores per socket to: %s", cores_per_socket)
2177         config_spec.numCoresPerSocket = int(cores_per_socket)
2178     if memory:
2179         try:
2180             memory_num, memory_unit = re.findall(r"[^\W\d_]+|\d+.\d+|\d+", memory)
2181             if memory_unit.lower() == "mb":
2182                 memory_mb = int(memory_num)
2183             elif memory_unit.lower() == "gb":
2184                 memory_mb = int(float(memory_num) * 1024.0)
2185             else:
2186                 err_msg = "Invalid memory type specified: '{}'".format(memory_unit)
2187                 log.error(err_msg)
2188                 return {"Error": err_msg}
2189         except (TypeError, ValueError):
2190             memory_mb = int(memory)
2191         log.debug("Setting memory to: %s MB", memory_mb)
2192         config_spec.memoryMB = memory_mb
2193     if devices:
2194         specs = _manage_devices(
2195             devices, vm=object_ref, container_ref=container_ref, new_vm_name=vm_name
2196         )
2197         config_spec.deviceChange = specs["device_specs"]
2198     if cpu_hot_add and hasattr(config_spec, "cpuHotAddEnabled"):
2199         config_spec.cpuHotAddEnabled = bool(cpu_hot_add)
2200     if cpu_hot_remove and hasattr(config_spec, "cpuHotRemoveEnabled"):
2201         config_spec.cpuHotRemoveEnabled = bool(cpu_hot_remove)
2202     if mem_hot_add and hasattr(config_spec, "memoryHotAddEnabled"):
2203         config_spec.memoryHotAddEnabled = bool(mem_hot_add)
2204     if nested_hv and hasattr(config_spec, "nestedHVEnabled"):
2205         config_spec.nestedHVEnabled = bool(nested_hv)
2206     if vpmc and hasattr(config_spec, "vPMCEnabled"):
2207         config_spec.vPMCEnabled = bool(vpmc)
2208     if extra_config:
2209         for key, value in extra_config.items():
2210             option = vim.option.OptionValue(key=key, value=value)
2211             config_spec.extraConfig.append(option)
2212     if annotation:
2213         config_spec.annotation = str(annotation)
2214     if "clonefrom" in vm_:
2215         clone_spec = handle_snapshot(config_spec, object_ref, reloc_spec, template, vm_)
2216         if not clone_spec:
2217             clone_spec = build_clonespec(config_spec, object_ref, reloc_spec, template)
2218         if customization and customization_spec:
2219             customization_spec = salt.utils.vmware.get_customizationspec_ref(
2220                 si=si, customization_spec_name=customization_spec
2221             )
2222             clone_spec.customization = customization_spec.spec
2223         elif customization and (devices and "network" in list(devices.keys())):
2224             global_ip = vim.vm.customization.GlobalIPSettings()
2225             if "dns_servers" in list(vm_.keys()):
2226                 global_ip.dnsServerList = vm_["dns_servers"]
2227             if "domain" in list(vm_.keys()):
2228                 global_ip.dnsSuffixList = vm_["domain"]
2229             non_hostname_chars = re.compile(r"[^\w-]")
2230             if re.search(non_hostname_chars, vm_name):
2231                 host_name = re.split(non_hostname_chars, vm_name, maxsplit=1)[0]
2232                 domain_name = re.split(non_hostname_chars, vm_name, maxsplit=1)[-1]
2233             else:
2234                 host_name = vm_name
2235                 domain_name = domain
2236             if "Windows" not in object_ref.config.guestFullName:
2237                 identity = vim.vm.customization.LinuxPrep()
2238 <a name="8"></a>                identity.hostName = vim.vm.customization.FixedName(name=host_name)
2239                 identity.domain = domain_name
2240             else:
2241                 identity = vim<font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.vm.customization.Sysprep()
2242                 identity.guiUnattended = vim.vm.customization.GuiUnattended()
2243                 identity.guiUnattended.</b></font>autoLogon = True
2244                 identity.guiUnattended.autoLogonCount = 1
2245                 identity.guiUnattended.password = vim.vm.customization.Password()
2246                 identity.guiUnattended.password.value = win_password
2247                 identity.guiUnattended.password.plainText = plain_text
2248                 if win_run_once:
2249                     identity.guiRunOnce = vim.vm.customization.GuiRunOnce()
2250                     identity.guiRunOnce.commandList = win_run_once
2251                 identity.userData = vim.vm.customization.UserData()
2252                 identity.userData.fullName = win_user_fullname
2253                 identity.userData.orgName = win_organization_name
2254                 identity.userData.computerName = vim.vm.customization.FixedName()
2255                 identity.userData.computerName.name = host_name
2256                 identity.identification = vim.vm.customization.Identification()
2257             custom_spec = vim.vm.customization.Specification(
2258                 globalIPSettings=global_ip,
2259                 identity=identity,
2260                 nicSettingMap=specs["nics_map"],
2261             )
2262             clone_spec.customization = custom_spec
2263         if not template:
2264             clone_spec.powerOn = power
2265         log.debug("clone_spec set to:\n%s", pprint.pformat(clone_spec))
2266     else:
2267         config_spec.name = vm_name
2268         config_spec.files = vim.vm.FileInfo()
2269         config_spec.files.vmPathName = "[{0}] {1}/{1}.vmx".format(datastore, vm_name)
2270         config_spec.guestId = guest_id
2271         log.debug("config_spec set to:\n%s", pprint.pformat(config_spec))
2272     event_kwargs = vm_.copy()
2273     if event_kwargs.get("password"):
2274         del event_kwargs["password"]
2275     try:
2276         __utils__["cloud.fire_event"](
2277             "event",
2278             "requesting instance",
2279             "salt/cloud/{}/requesting".format(vm_["name"]),
2280             args=__utils__["cloud.filter_event"](
2281                 "requesting", event_kwargs, list(event_kwargs)
2282             ),
2283             sock_dir=__opts__["sock_dir"],
2284             transport=__opts__["transport"],
2285         )
2286         if "clonefrom" in vm_:
2287             log.info(
2288                 "Creating %s from %s(%s)", vm_["name"], clone_type, vm_["clonefrom"]
2289             )
2290             if datastore and not datastore_ref and datastore_cluster_ref:
2291                 pod_spec = vim.storageDrs.PodSelectionSpec(
2292                     storagePod=datastore_cluster_ref
2293                 )
2294                 storage_spec = vim.storageDrs.StoragePlacementSpec(
2295                     type="clone",
2296                     vm=object_ref,
2297                     podSelectionSpec=pod_spec,
2298                     cloneSpec=clone_spec,
2299                     cloneName=vm_name,
2300                     folder=folder_ref,
2301                 )
2302                 recommended_datastores = (
2303                     si.content.storageResourceManager.RecommendDatastores(
2304                         storageSpec=storage_spec
2305                     )
2306                 )
2307                 task = si.content.storageResourceManager.ApplyStorageDrsRecommendation_Task(
2308                     recommended_datastores.recommendations[0].key
2309                 )
2310                 salt.utils.vmware.wait_for_task(
2311                     task, vm_name, "apply storage DRS recommendations", 5, "info"
2312                 )
2313             else:
2314                 task = object_ref.Clone(folder_ref, vm_name, clone_spec)
2315                 salt.utils.vmware.wait_for_task(task, vm_name, "clone", 5, "info")
2316         else:
2317             log.info("Creating %s", vm_["name"])
2318             if host:
2319                 task = folder_ref.CreateVM_Task(config_spec, resourcepool_ref, host_ref)
2320             else:
2321                 task = folder_ref.CreateVM_Task(config_spec, resourcepool_ref)
2322             salt.utils.vmware.wait_for_task(task, vm_name, "create", 15, "info")
2323     except Exception as exc:  # pylint: disable=broad-except
2324         err_msg = "Error creating {}: {}".format(vm_["name"], exc)
2325         log.error(
2326             err_msg,
2327             exc_info_on_loglevel=logging.DEBUG,
2328         )
2329         return {"Error": err_msg}
2330     new_vm_ref = salt.utils.vmware.get_mor_by_property(
2331         si, vim.VirtualMachine, vm_name, container_ref=container_ref
2332     )
2333     try:
2334         if not clone_type and power:
2335             task = new_vm_ref.PowerOn()
2336             salt.utils.vmware.wait_for_task(task, vm_name, "power", 5, "info")
2337     except Exception as exc:  # pylint: disable=broad-except
2338         log.info("Powering on the VM threw this exception. Ignoring.")
2339         log.info(exc)
2340     out = None
2341     if not template and power:
2342         ip = _wait_for_ip(new_vm_ref, wait_for_ip_timeout)
2343         if ip:
2344             log.info("[ %s ] IPv4 is: %s", vm_name, ip)
2345             if deploy:
2346                 vm_["key_filename"] = key_filename
2347                 if "ssh_host" not in vm_:
2348                     vm_["ssh_host"] = ip
2349                 log.info("[ %s ] Deploying to %s", vm_name, vm_["ssh_host"])
2350                 out = __utils__["cloud.bootstrap"](vm_, __opts__)
2351     data = show_instance(vm_name, call="action")
2352 <a name="6"></a>    if deploy and isinstance(out, dict):
2353         data["deploy_kwargs"] = out.get("deploy_kwargs", {})
2354     __utils__<font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["cloud.fire_event"](
2355         "event",
2356         "created instance",
2357         "salt/cloud/{}/created".format(vm_["name"]),
2358         args=__utils__["cloud.filter_event"](
2359             "created", vm_, ["name", "profile", "provider", "driver"]
2360         ),
2361         sock_dir=__opts__["sock_dir"],
2362         transport=__opts__["transport"],
2363     )
2364     return data
2365 def</b></font> handle_snapshot(config_spec, object_ref, reloc_spec, template, vm_):
2366     if "snapshot" not in vm_:
2367         return None
2368     allowed_types = [
2369         FLATTEN_DISK_FULL_CLONE,
2370         COPY_ALL_DISKS_FULL_CLONE,
2371         CURRENT_STATE_LINKED_CLONE,
2372         QUICK_LINKED_CLONE,
2373     ]
2374     clone_spec = get_clonespec_for_valid_snapshot(
2375         config_spec, object_ref, reloc_spec, template, vm_
2376     )
2377     if not clone_spec:
2378         raise SaltCloudSystemExit(
2379             "Invalid disk move type specified supported types are {}".format(
2380                 " ".join(allowed_types)
2381             )
2382         )
2383     return clone_spec
2384 def get_clonespec_for_valid_snapshot(
2385     config_spec, object_ref, reloc_spec, template, vm_
2386 ):
2387     moving = True
2388     if QUICK_LINKED_CLONE == vm_["snapshot"]["disk_move_type"]:
2389         reloc_spec.diskMoveType = QUICK_LINKED_CLONE
2390     elif CURRENT_STATE_LINKED_CLONE == vm_["snapshot"]["disk_move_type"]:
2391         reloc_spec.diskMoveType = CURRENT_STATE_LINKED_CLONE
2392     elif COPY_ALL_DISKS_FULL_CLONE == vm_["snapshot"]["disk_move_type"]:
2393         reloc_spec.diskMoveType = COPY_ALL_DISKS_FULL_CLONE
2394     elif FLATTEN_DISK_FULL_CLONE == vm_["snapshot"]["disk_move_type"]:
2395         reloc_spec.diskMoveType = FLATTEN_DISK_FULL_CLONE
2396     else:
2397         moving = False
2398     if moving:
2399         return build_clonespec(config_spec, object_ref, reloc_spec, template)
2400     return None
2401 def build_clonespec(config_spec, object_ref, reloc_spec, template):
2402     if reloc_spec.diskMoveType == QUICK_LINKED_CLONE:
2403         return vim.vm.CloneSpec(
2404             template=template,
2405             location=reloc_spec,
2406             config=config_spec,
2407             snapshot=object_ref.snapshot.currentSnapshot,
2408         )
2409     return vim.vm.CloneSpec(template=template, location=reloc_spec, config=config_spec)
2410 def create_datacenter(kwargs=None, call=None):
2411     if call != "function":
2412         raise SaltCloudSystemExit(
2413             "The create_datacenter function must be called with -f or --function."
2414         )
2415     datacenter_name = kwargs.get("name") if kwargs and "name" in kwargs else None
2416     if not datacenter_name:
2417         raise SaltCloudSystemExit(
2418             "You must specify name of the new datacenter to be created."
2419         )
2420     if not datacenter_name or len(datacenter_name) &gt;= 80:
2421         raise SaltCloudSystemExit(
2422             "The datacenter name must be a non empty string of less than 80 characters."
2423         )
2424     si = _get_si()
2425     datacenter_ref = salt.utils.vmware.get_mor_by_property(
2426         si, vim.Datacenter, datacenter_name
2427     )
2428     if datacenter_ref:
2429         return {datacenter_name: "datacenter already exists"}
2430     folder = si.content.rootFolder
2431     if isinstance(folder, vim.Folder):
2432         try:
2433             folder.CreateDatacenter(name=datacenter_name)
2434         except Exception as exc:  # pylint: disable=broad-except
2435             log.error(
2436                 "Error creating datacenter %s: %s",
2437                 datacenter_name,
2438                 exc,
2439                 exc_info_on_loglevel=logging.DEBUG,
2440             )
2441             return False
2442         log.debug("Created datacenter %s", datacenter_name)
2443         return {datacenter_name: "created"}
2444     return False
2445 def create_cluster(kwargs=None, call=None):
2446     if call != "function":
2447         raise SaltCloudSystemExit(
2448             "The create_cluster function must be called with -f or --function."
2449         )
2450     cluster_name = kwargs.get("name") if kwargs and "name" in kwargs else None
2451     datacenter = kwargs.get("datacenter") if kwargs and "datacenter" in kwargs else None
2452     if not cluster_name:
2453         raise SaltCloudSystemExit(
2454             "You must specify name of the new cluster to be created."
2455         )
2456     if not datacenter:
2457         raise SaltCloudSystemExit(
2458             "You must specify name of the datacenter where the cluster should be"
2459             " created."
2460         )
2461     si = _get_si()
2462     if not isinstance(datacenter, vim.Datacenter):
2463         datacenter = salt.utils.vmware.get_mor_by_property(
2464             si, vim.Datacenter, datacenter
2465         )
2466         if not datacenter:
2467             raise SaltCloudSystemExit("The specified datacenter does not exist.")
2468     cluster_ref = salt.utils.vmware.get_mor_by_property(
2469         si, vim.ClusterComputeResource, cluster_name
2470     )
2471     if cluster_ref:
2472         return {cluster_name: "cluster already exists"}
2473     cluster_spec = vim.cluster.ConfigSpecEx()
2474     folder = datacenter.hostFolder
2475     if isinstance(folder, vim.Folder):
2476         try:
2477             folder.CreateClusterEx(name=cluster_name, spec=cluster_spec)
2478         except Exception as exc:  # pylint: disable=broad-except
2479             log.error(
2480                 "Error creating cluster %s: %s",
2481                 cluster_name,
2482                 exc,
2483                 exc_info_on_loglevel=logging.DEBUG,
2484             )
2485             return False
2486         log.debug(
2487             "Created cluster %s under datacenter %s", cluster_name, datacenter.name
2488         )
2489         return {cluster_name: "created"}
2490     return False
2491 def rescan_hba(kwargs=None, call=None):
2492     if call != "function":
2493         raise SaltCloudSystemExit(
2494             "The rescan_hba function must be called with -f or --function."
2495         )
2496     hba = kwargs.get("hba") if kwargs and "hba" in kwargs else None
2497     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
2498     if not host_name:
2499         raise SaltCloudSystemExit("You must specify name of the host system.")
2500     host_ref = salt.utils.vmware.get_mor_by_property(
2501         _get_si(), vim.HostSystem, host_name
2502     )
2503     try:
2504         if hba:
2505             log.info("Rescanning HBA %s on host %s", hba, host_name)
2506             host_ref.configManager.storageSystem.RescanHba(hba)
2507             ret = "rescanned HBA {}".format(hba)
2508         else:
2509             log.info("Rescanning all HBAs on host %s", host_name)
2510             host_ref.configManager.storageSystem.RescanAllHba()
2511             ret = "rescanned all HBAs"
2512     except Exception as exc:  # pylint: disable=broad-except
2513         log.error(
2514             "Error while rescaning HBA on host %s: %s",
2515             host_name,
2516             exc,
2517             exc_info_on_loglevel=logging.DEBUG,
2518         )
2519         return {host_name: "failed to rescan HBA"}
2520     return {host_name: ret}
2521 def upgrade_tools_all(call=None):
2522     if call != "function":
2523         raise SaltCloudSystemExit(
2524             "The upgrade_tools_all function must be called with -f or --function."
2525         )
2526     ret = {}
2527     vm_properties = ["name"]
2528     vm_list = salt.utils.vmware.get_mors_with_properties(
2529         _get_si(), vim.VirtualMachine, vm_properties
2530     )
2531     for vm in vm_list:
2532         ret[vm["name"]] = _upg_tools_helper(vm["object"])
2533     return ret
2534 def upgrade_tools(name, reboot=False, call=None):
2535     if call != "action":
2536         raise SaltCloudSystemExit(
2537             "The upgrade_tools action must be called with -a or --action."
2538         )
2539     vm_ref = salt.utils.vmware.get_mor_by_property(_get_si(), vim.VirtualMachine, name)
2540     return _upg_tools_helper(vm_ref, reboot)
2541 def list_hosts_by_cluster(kwargs=None, call=None):
2542     if call != "function":
2543         raise SaltCloudSystemExit(
2544             "The list_hosts_by_cluster function must be called with -f or --function."
2545         )
2546     ret = {}
2547     cluster_name = kwargs.get("cluster") if kwargs and "cluster" in kwargs else None
2548     cluster_properties = ["name"]
2549     cluster_list = salt.utils.vmware.get_mors_with_properties(
2550         _get_si(), vim.ClusterComputeResource, cluster_properties
2551     )
2552     for cluster in cluster_list:
2553         ret[cluster["name"]] = []
2554         for host in cluster["object"].host:
2555             if isinstance(host, vim.HostSystem):
2556                 ret[cluster["name"]].append(host.name)
2557         if cluster_name and cluster_name == cluster["name"]:
2558             return {"Hosts by Cluster": {cluster_name: ret[cluster_name]}}
2559     return {"Hosts by Cluster": ret}
2560 def list_clusters_by_datacenter(kwargs=None, call=None):
2561     if call != "function":
2562         raise SaltCloudSystemExit(
2563             "The list_clusters_by_datacenter function must be called with "
2564             "-f or --function."
2565         )
2566     ret = {}
2567     datacenter_name = (
2568         kwargs.get("datacenter") if kwargs and "datacenter" in kwargs else None
2569     )
2570     datacenter_properties = ["name"]
2571     datacenter_list = salt.utils.vmware.get_mors_with_properties(
2572         _get_si(), vim.Datacenter, datacenter_properties
2573     )
2574     for datacenter in datacenter_list:
2575         ret[datacenter["name"]] = []
2576         for cluster in datacenter["object"].hostFolder.childEntity:
2577             if isinstance(cluster, vim.ClusterComputeResource):
2578                 ret[datacenter["name"]].append(cluster.name)
2579         if datacenter_name and datacenter_name == datacenter["name"]:
2580             return {"Clusters by Datacenter": {datacenter_name: ret[datacenter_name]}}
2581     return {"Clusters by Datacenter": ret}
2582 def list_hosts_by_datacenter(kwargs=None, call=None):
2583     if call != "function":
2584         raise SaltCloudSystemExit(
2585             "The list_hosts_by_datacenter function must be called with "
2586             "-f or --function."
2587         )
2588     ret = {}
2589     datacenter_name = (
2590         kwargs.get("datacenter") if kwargs and "datacenter" in kwargs else None
2591     )
2592     datacenter_properties = ["name"]
2593     datacenter_list = salt.utils.vmware.get_mors_with_properties(
2594         _get_si(), vim.Datacenter, datacenter_properties
2595     )
2596     for datacenter in datacenter_list:
2597         ret[datacenter["name"]] = []
2598         for cluster in datacenter["object"].hostFolder.childEntity:
2599             if isinstance(cluster, vim.ClusterComputeResource):
2600                 for host in cluster.host:
2601                     if isinstance(host, vim.HostSystem):
2602                         ret[datacenter["name"]].append(host.name)
2603         if datacenter_name and datacenter_name == datacenter["name"]:
2604             return {"Hosts by Datacenter": {datacenter_name: ret[datacenter_name]}}
2605     return {"Hosts by Datacenter": ret}
2606 def list_hbas(kwargs=None, call=None):
2607     if call != "function":
2608         raise SaltCloudSystemExit(
2609             "The list_hbas function must be called with -f or --function."
2610         )
2611     ret = {}
2612     hba_type = kwargs.get("type").lower() if kwargs and "type" in kwargs else None
2613     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
2614     host_properties = ["name", "config.storageDevice.hostBusAdapter"]
2615     if hba_type and hba_type not in ["parallel", "block", "iscsi", "fibre"]:
2616         raise SaltCloudSystemExit(
2617             "Specified hba type {} currently not supported.".format(hba_type)
2618         )
2619     host_list = salt.utils.vmware.get_mors_with_properties(
2620         _get_si(), vim.HostSystem, host_properties
2621     )
2622     for host in host_list:
2623         ret[host["name"]] = {}
2624         for hba in host["config.storageDevice.hostBusAdapter"]:
2625             hba_spec = {
2626                 "driver": hba.driver,
2627                 "status": hba.status,
2628                 "type": type(hba).__name__.rsplit(".", 1)[1],
2629             }
2630             if hba_type:
2631                 if isinstance(hba, _get_hba_type(hba_type)):
2632                     if hba.model in ret[host["name"]]:
2633                         ret[host["name"]][hba.model][hba.device] = hba_spec
2634                     else:
2635                         ret[host["name"]][hba.model] = {hba.device: hba_spec}
2636             else:
2637                 if hba.model in ret[host["name"]]:
2638                     ret[host["name"]][hba.model][hba.device] = hba_spec
2639                 else:
2640                     ret[host["name"]][hba.model] = {hba.device: hba_spec}
2641         if host["name"] == host_name:
2642             return {"HBAs by Host": {host_name: ret[host_name]}}
2643     return {"HBAs by Host": ret}
2644 def list_dvs(kwargs=None, call=None):
2645     if call != "function":
2646         raise SaltCloudSystemExit(
2647             "The list_dvs function must be called with -f or --function."
2648         )
2649     return {"Distributed Virtual Switches": salt.utils.vmware.list_dvs(_get_si())}
2650 def list_vapps(kwargs=None, call=None):
2651     if call != "function":
2652         raise SaltCloudSystemExit(
2653             "The list_vapps function must be called with -f or --function."
2654         )
2655     return {"vApps": salt.utils.vmware.list_vapps(_get_si())}
2656 def enter_maintenance_mode(kwargs=None, call=None):
2657     if call != "function":
2658         raise SaltCloudSystemExit(
2659             "The enter_maintenance_mode function must be called with -f or --function."
2660         )
2661     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
2662     host_ref = salt.utils.vmware.get_mor_by_property(
2663         _get_si(), vim.HostSystem, host_name
2664     )
2665     if not host_name or not host_ref:
2666         raise SaltCloudSystemExit("You must specify a valid name of the host system.")
2667     if host_ref.runtime.inMaintenanceMode:
2668         return {host_name: "already in maintenance mode"}
2669     try:
2670         task = host_ref.EnterMaintenanceMode(timeout=0, evacuatePoweredOffVms=True)
2671         salt.utils.vmware.wait_for_task(task, host_name, "enter maintenance mode")
2672     except Exception as exc:  # pylint: disable=broad-except
2673         log.error(
2674             "Error while moving host system %s in maintenance mode: %s",
2675             host_name,
2676             exc,
2677             exc_info_on_loglevel=logging.DEBUG,
2678         )
2679         return {host_name: "failed to enter maintenance mode"}
2680     return {host_name: "entered maintenance mode"}
2681 def exit_maintenance_mode(kwargs=None, call=None):
2682     if call != "function":
2683         raise SaltCloudSystemExit(
2684             "The exit_maintenance_mode function must be called with -f or --function."
2685         )
2686     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
2687     host_ref = salt.utils.vmware.get_mor_by_property(
2688         _get_si(), vim.HostSystem, host_name
2689     )
2690     if not host_name or not host_ref:
2691         raise SaltCloudSystemExit("You must specify a valid name of the host system.")
2692     if not host_ref.runtime.inMaintenanceMode:
2693         return {host_name: "already not in maintenance mode"}
2694     try:
2695         task = host_ref.ExitMaintenanceMode(timeout=0)
2696         salt.utils.vmware.wait_for_task(task, host_name, "exit maintenance mode")
2697     except Exception as exc:  # pylint: disable=broad-except
2698         log.error(
2699             "Error while moving host system %s out of maintenance mode: %s",
2700             host_name,
2701             exc,
2702             exc_info_on_loglevel=logging.DEBUG,
2703         )
2704         return {host_name: "failed to exit maintenance mode"}
2705     return {host_name: "exited maintenance mode"}
2706 def create_folder(kwargs=None, call=None):
2707     if call != "function":
2708         raise SaltCloudSystemExit(
2709             "The create_folder function must be called with -f or --function."
2710         )
2711     si = _get_si()
2712     folder_path = kwargs.get("path") if kwargs and "path" in kwargs else None
2713     if not folder_path:
2714         raise SaltCloudSystemExit("You must specify a non empty folder path.")
2715     folder_refs = []
2716     inventory_path = "/"
2717     path_exists = True
2718     for index, folder_name in enumerate(
2719         os.path.normpath(folder_path.strip("/")).split("/")
2720     ):
2721         inventory_path = os.path.join(inventory_path, folder_name)
2722         folder_ref = si.content.searchIndex.FindByInventoryPath(
2723             inventoryPath=inventory_path
2724         )
2725         if isinstance(folder_ref, vim.Folder):
2726             log.debug("Path %s/ exists in the inventory", inventory_path)
2727             folder_refs.append(folder_ref)
2728         elif isinstance(folder_ref, vim.Datacenter):
2729             log.debug("Path %s/ exists in the inventory", inventory_path)
2730             folder_refs.append(folder_ref)
2731         else:
2732             path_exists = False
2733             if not folder_refs:
2734                 log.debug(
2735                     "Creating folder %s under rootFolder in the inventory", folder_name
2736                 )
2737                 folder_refs.append(si.content.rootFolder.CreateFolder(folder_name))
2738             else:
2739                 log.debug("Creating path %s/ in the inventory", inventory_path)
2740                 folder_refs.append(folder_refs[index - 1].CreateFolder(folder_name))
2741     if path_exists:
2742         return {inventory_path: "specified path already exists"}
2743     return {inventory_path: "created the specified path"}
2744 def create_snapshot(name, kwargs=None, call=None):
2745     if call != "action":
2746         raise SaltCloudSystemExit(
2747             "The create_snapshot action must be called with -a or --action."
2748         )
2749     if kwargs is None:
2750         kwargs = {}
2751     snapshot_name = (
2752         kwargs.get("snapshot_name") if kwargs and "snapshot_name" in kwargs else None
2753     )
2754     if not snapshot_name:
2755         raise SaltCloudSystemExit(
2756             "You must specify snapshot name for the snapshot to be created."
2757         )
2758     memdump = _str_to_bool(kwargs.get("memdump", True))
2759     quiesce = _str_to_bool(kwargs.get("quiesce", False))
2760     vm_ref = salt.utils.vmware.get_mor_by_property(_get_si(), vim.VirtualMachine, name)
2761     if vm_ref.summary.runtime.powerState != "poweredOn":
2762         log.debug(
2763             "VM %s is not powered on. Setting both memdump and quiesce to False", name
2764         )
2765         memdump = False
2766         quiesce = False
2767     if memdump and quiesce:
2768         log.warning(
2769             "You can only set either memdump or quiesce to True. Setting quiesce=False"
2770         )
2771         quiesce = False
2772     desc = kwargs.get("description") if "description" in kwargs else ""
2773     try:
2774         task = vm_ref.CreateSnapshot(snapshot_name, desc, memdump, quiesce)
2775         salt.utils.vmware.wait_for_task(task, name, "create snapshot", 5, "info")
2776     except Exception as exc:  # pylint: disable=broad-except
2777         log.error(
2778             "Error while creating snapshot of %s: %s",
2779             name,
2780             exc,
2781             exc_info_on_loglevel=logging.DEBUG,
2782         )
2783         return "failed to create snapshot"
2784     return {
2785         "Snapshot created successfully": _get_snapshots(
2786             vm_ref.snapshot.rootSnapshotList, vm_ref.snapshot.currentSnapshot
2787         )
2788     }
2789 def revert_to_snapshot(name, kwargs=None, call=None):
2790     if call != "action":
2791         raise SaltCloudSystemExit(
2792             "The revert_to_snapshot action must be called with -a or --action."
2793         )
2794     if kwargs is None:
2795         kwargs = {}
2796     snapshot_name = (
2797         kwargs.get("snapshot_name") if kwargs and "snapshot_name" in kwargs else None
2798     )
2799     suppress_power_on = _str_to_bool(kwargs.get("power_off", False))
2800     vm_ref = salt.utils.vmware.get_mor_by_property(_get_si(), vim.VirtualMachine, name)
2801     if not vm_ref.rootSnapshot:
2802         log.error("VM %s does not contain any current snapshots", name)
2803         return "revert failed"
2804     msg = "reverted to current snapshot"
2805     try:
2806         if snapshot_name is None:
2807             log.debug("Reverting VM %s to current snapshot", name)
2808             task = vm_ref.RevertToCurrentSnapshot(suppressPowerOn=suppress_power_on)
2809         else:
2810             log.debug("Reverting VM %s to snapshot %s", name, snapshot_name)
2811             msg = "reverted to snapshot {}".format(snapshot_name)
2812             snapshot_ref = _get_snapshot_ref_by_name(vm_ref, snapshot_name)
2813             if snapshot_ref is None:
2814                 return "specified snapshot '{}' does not exist".format(snapshot_name)
2815             task = snapshot_ref.snapshot.Revert(suppressPowerOn=suppress_power_on)
2816         salt.utils.vmware.wait_for_task(task, name, "revert to snapshot", 5, "info")
2817     except Exception as exc:  # pylint: disable=broad-except
2818         log.error(
2819             "Error while reverting VM %s to snapshot: %s",
2820             name,
2821             exc,
2822             exc_info_on_loglevel=logging.DEBUG,
2823         )
2824         return "revert failed"
2825     return msg
2826 def remove_snapshot(name, kwargs=None, call=None):
2827     if call != "action":
2828         raise SaltCloudSystemExit(
2829             "The create_snapshot action must be called with -a or --action."
2830         )
2831     if kwargs is None:
2832         kwargs = {}
2833     snapshot_name = (
2834         kwargs.get("snapshot_name") if kwargs and "snapshot_name" in kwargs else None
2835     )
2836     remove_children = _str_to_bool(kwargs.get("remove_children", False))
2837     if not snapshot_name:
2838         raise SaltCloudSystemExit(
2839             "You must specify snapshot name for the snapshot to be deleted."
2840         )
2841     vm_ref = salt.utils.vmware.get_mor_by_property(_get_si(), vim.VirtualMachine, name)
2842     if not _get_snapshot_ref_by_name(vm_ref, snapshot_name):
2843         raise SaltCloudSystemExit(
2844             "ould not find the snapshot with the specified name."
2845         )
2846     try:
2847         snap_obj = _get_snapshot_ref_by_name(vm_ref, snapshot_name).snapshot
2848         task = snap_obj.RemoveSnapshot_Task(remove_children)
2849         salt.utils.vmware.wait_for_task(task, name, "remove snapshot", 5, "info")
2850     except Exception as exc:  # pylint: disable=broad-except
2851         log.error(
2852             "Error while removing snapshot of %s: %s",
2853             name,
2854             exc,
2855             exc_info_on_loglevel=logging.DEBUG,
2856         )
2857         return "failed to remove snapshot"
2858     if vm_ref.snapshot:
2859         return {
2860             "Snapshot removed successfully": _get_snapshots(
2861                 vm_ref.snapshot.rootSnapshotList, vm_ref.snapshot.currentSnapshot
2862             )
2863         }
2864     return "Snapshots removed successfully"
2865 def remove_all_snapshots(name, kwargs=None, call=None):
2866     if call != "action":
2867         raise SaltCloudSystemExit(
2868             "The remove_all_snapshots action must be called with -a or --action."
2869         )
2870     vm_ref = salt.utils.vmware.get_mor_by_property(_get_si(), vim.VirtualMachine, name)
2871     try:
2872         task = vm_ref.RemoveAllSnapshots()
2873         salt.utils.vmware.wait_for_task(task, name, "remove snapshots", 5, "info")
2874     except Exception as exc:  # pylint: disable=broad-except
2875         log.error(
2876             "Error while removing snapshots on VM %s: %s",
2877             name,
2878             exc,
2879             exc_info_on_loglevel=logging.DEBUG,
2880         )
2881         return "Failed to remove snapshots"
2882     return "Removed all snapshots"
2883 def convert_to_template(name, kwargs=None, call=None):
2884     if call != "action":
2885         raise SaltCloudSystemExit(
2886             "The convert_to_template action must be called with -a or --action."
2887         )
2888     vm_ref = salt.utils.vmware.get_mor_by_property(_get_si(), vim.VirtualMachine, name)
2889     if vm_ref.config.template:
2890         raise SaltCloudSystemExit("{} already a template".format(name))
2891     try:
2892         vm_ref.MarkAsTemplate()
2893     except Exception as exc:  # pylint: disable=broad-except
2894         log.error(
2895             "Error while converting VM to template %s: %s",
2896             name,
2897             exc,
2898             exc_info_on_loglevel=logging.DEBUG,
2899         )
2900         return "failed to convert to teamplate"
2901     return "{} converted to template".format(name)
2902 def add_host(kwargs=None, call=None):
2903     if call != "function":
2904         raise SaltCloudSystemExit(
2905             "The add_host function must be called with -f or --function."
2906         )
2907     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
2908     cluster_name = kwargs.get("cluster") if kwargs and "cluster" in kwargs else None
2909     datacenter_name = (
2910         kwargs.get("datacenter") if kwargs and "datacenter" in kwargs else None
2911     )
2912     host_user = config.get_cloud_config_value(
2913         "esxi_host_user", get_configured_provider(), __opts__, search_global=False
2914     )
2915     host_password = config.get_cloud_config_value(
2916         "esxi_host_password", get_configured_provider(), __opts__, search_global=False
2917     )
2918     host_ssl_thumbprint = config.get_cloud_config_value(
2919         "esxi_host_ssl_thumbprint",
2920         get_configured_provider(),
2921         __opts__,
2922         search_global=False,
2923     )
2924     if not host_user:
2925         raise SaltCloudSystemExit(
2926             "You must specify the ESXi host username in your providers config."
2927         )
2928     if not host_password:
2929         raise SaltCloudSystemExit(
2930             "You must specify the ESXi host password in your providers config."
2931         )
2932     if not host_name:
2933         raise SaltCloudSystemExit(
2934             "You must specify either the IP or DNS name of the host system."
2935         )
2936     if (cluster_name and datacenter_name) or not (cluster_name or datacenter_name):
2937         raise SaltCloudSystemExit(
2938             "You must specify either the cluster name or the datacenter name."
2939         )
2940     si = _get_si()
2941     if cluster_name:
2942         cluster_ref = salt.utils.vmware.get_mor_by_property(
2943             si, vim.ClusterComputeResource, cluster_name
2944         )
2945         if not cluster_ref:
2946             raise SaltCloudSystemExit("Specified cluster does not exist.")
2947     if datacenter_name:
2948         datacenter_ref = salt.utils.vmware.get_mor_by_property(
2949             si, vim.Datacenter, datacenter_name
2950         )
2951         if not datacenter_ref:
2952             raise SaltCloudSystemExit("Specified datacenter does not exist.")
2953     spec = vim.host.ConnectSpec(
2954         hostName=host_name,
2955         userName=host_user,
2956         password=host_password,
2957     )
2958     if host_ssl_thumbprint:
2959         spec.sslThumbprint = host_ssl_thumbprint
2960     else:
2961         log.warning("SSL thumbprint has not been specified in provider configuration")
2962         try:
2963             log.debug("Trying to get the SSL thumbprint directly from the host system")
2964             p1 = subprocess.Popen(
2965                 ("echo", "-n"), stdout=subprocess.PIPE, stderr=subprocess.PIPE
2966             )
2967             p2 = subprocess.Popen(
2968                 ("openssl", "s_client", "-connect", "{}:443".format(host_name)),
2969                 stdin=p1.stdout,
2970                 stdout=subprocess.PIPE,
2971                 stderr=subprocess.PIPE,
2972             )
2973             p3 = subprocess.Popen(
2974                 ("openssl", "x509", "-noout", "-fingerprint", "-sha1"),
2975                 stdin=p2.stdout,
2976                 stdout=subprocess.PIPE,
2977                 stderr=subprocess.PIPE,
2978             )
2979             out = salt.utils.stringutils.to_str(p3.stdout.read())
2980             ssl_thumbprint = out.split("=")[-1].strip()
2981             log.debug(
2982                 "SSL thumbprint received from the host system: %s", ssl_thumbprint
2983             )
2984             spec.sslThumbprint = ssl_thumbprint
2985         except Exception as exc:  # pylint: disable=broad-except
2986             log.error(
2987                 "Error while trying to get SSL thumbprint of host %s: %s",
2988                 host_name,
2989                 exc,
2990                 exc_info_on_loglevel=logging.DEBUG,
2991             )
2992             return {host_name: "failed to add host"}
2993     try:
2994         if cluster_name:
2995             task = cluster_ref.AddHost(spec=spec, asConnected=True)
2996             ret = "added host system to cluster {}".format(cluster_name)
2997         if datacenter_name:
2998             task = datacenter_ref.hostFolder.AddStandaloneHost(
2999                 spec=spec, addConnected=True
3000             )
3001             ret = "added host system to datacenter {}".format(datacenter_name)
3002         salt.utils.vmware.wait_for_task(task, host_name, "add host system", 5, "info")
3003     except Exception as exc:  # pylint: disable=broad-except
3004         if isinstance(exc, vim.fault.SSLVerifyFault):
3005             log.error("Authenticity of the host's SSL certificate is not verified")
3006             log.info(
3007                 "Try again after setting the esxi_host_ssl_thumbprint "
3008                 "to %s in provider configuration",
3009                 spec.sslThumbprint,
3010             )
3011         log.error(
3012             "Error while adding host %s: %s",
3013             host_name,
3014             exc,
3015             exc_info_on_loglevel=logging.DEBUG,
3016         )
3017         return {host_name: "failed to add host"}
3018     return {host_name: ret}
3019 def remove_host(kwargs=None, call=None):
3020     if call != "function":
3021         raise SaltCloudSystemExit(
3022             "The remove_host function must be called with -f or --function."
3023         )
3024     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
3025     if not host_name:
3026         raise SaltCloudSystemExit("You must specify name of the host system.")
3027     si = _get_si()
3028     host_ref = salt.utils.vmware.get_mor_by_property(si, vim.HostSystem, host_name)
3029     if not host_ref:
3030         raise SaltCloudSystemExit("Specified host system does not exist.")
3031     try:
3032         if isinstance(host_ref.parent, vim.ClusterComputeResource):
3033             task = host_ref.Destroy_Task()
3034         else:
3035             task = host_ref.parent.Destroy_Task()
3036         salt.utils.vmware.wait_for_task(
3037             task, host_name, "remove host", log_level="info"
3038         )
3039     except Exception as exc:  # pylint: disable=broad-except
3040         log.error(
3041             "Error while removing host %s: %s",
3042             host_name,
3043             exc,
3044             exc_info_on_loglevel=logging.DEBUG,
3045         )
3046         return {host_name: "failed to remove host"}
3047     return {host_name: "removed host from vcenter"}
3048 def connect_host(kwargs=None, call=None):
3049     if call != "function":
3050         raise SaltCloudSystemExit(
3051             "The connect_host function must be called with -f or --function."
3052         )
3053     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
3054     if not host_name:
3055         raise SaltCloudSystemExit("You must specify name of the host system.")
3056     si = _get_si()
3057     host_ref = salt.utils.vmware.get_mor_by_property(si, vim.HostSystem, host_name)
3058     if not host_ref:
3059         raise SaltCloudSystemExit("Specified host system does not exist.")
3060     if host_ref.runtime.connectionState == "connected":
3061         return {host_name: "host system already connected"}
3062     try:
3063         task = host_ref.ReconnectHost_Task()
3064         salt.utils.vmware.wait_for_task(task, host_name, "connect host", 5, "info")
3065     except Exception as exc:  # pylint: disable=broad-except
3066         log.error(
3067             "Error while connecting host %s: %s",
3068             host_name,
3069             exc,
3070             exc_info_on_loglevel=logging.DEBUG,
3071         )
3072         return {host_name: "failed to connect host"}
3073     return {host_name: "connected host"}
3074 def disconnect_host(kwargs=None, call=None):
3075     if call != "function":
3076         raise SaltCloudSystemExit(
3077             "The disconnect_host function must be called with -f or --function."
3078         )
3079     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
3080     if not host_name:
3081         raise SaltCloudSystemExit("You must specify name of the host system.")
3082     si = _get_si()
3083     host_ref = salt.utils.vmware.get_mor_by_property(si, vim.HostSystem, host_name)
3084     if not host_ref:
3085         raise SaltCloudSystemExit("Specified host system does not exist.")
3086     if host_ref.runtime.connectionState == "disconnected":
3087         return {host_name: "host system already disconnected"}
3088     try:
3089         task = host_ref.DisconnectHost_Task()
3090         salt.utils.vmware.wait_for_task(
3091             task, host_name, "disconnect host", log_level="info"
3092         )
3093     except Exception as exc:  # pylint: disable=broad-except
3094         log.error(
3095             "Error while disconnecting host %s: %s",
3096             host_name,
3097             exc,
3098             exc_info_on_loglevel=logging.DEBUG,
3099         )
3100         return {host_name: "failed to disconnect host"}
3101     return {host_name: "disconnected host"}
3102 def reboot_host(kwargs=None, call=None):
3103     if call != "function":
3104         raise SaltCloudSystemExit(
3105             "The reboot_host function must be called with -f or --function."
3106         )
3107     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
3108     force = _str_to_bool(kwargs.get("force")) if kwargs and "force" in kwargs else False
3109     if not host_name:
3110         raise SaltCloudSystemExit("You must specify name of the host system.")
3111     si = _get_si()
3112     host_ref = salt.utils.vmware.get_mor_by_property(si, vim.HostSystem, host_name)
3113     if not host_ref:
3114         raise SaltCloudSystemExit("Specified host system does not exist.")
3115     if host_ref.runtime.connectionState == "notResponding":
3116         raise SaltCloudSystemExit(
3117             "Specified host system cannot be rebooted in it's current state (not"
3118             " responding)."
3119         )
3120     if not host_ref.capability.rebootSupported:
3121         raise SaltCloudSystemExit("Specified host system does not support reboot.")
3122     if not host_ref.runtime.inMaintenanceMode and not force:
3123         raise SaltCloudSystemExit(
3124             "Specified host system is not in maintenance mode. Specify force=True to"
3125             " force reboot even if there are virtual machines running or other"
3126             " operations in progress."
3127         )
3128     try:
3129         host_ref.RebootHost_Task(force)
3130         _wait_for_host(host_ref, "reboot", 10, "info")
3131     except Exception as exc:  # pylint: disable=broad-except
3132         log.error(
3133             "Error while rebooting host %s: %s",
3134             host_name,
3135             exc,
3136             exc_info_on_loglevel=logging.DEBUG,
3137         )
3138         return {host_name: "failed to reboot host"}
3139     return {host_name: "rebooted host"}
3140 def create_datastore_cluster(kwargs=None, call=None):
3141     if call != "function":
3142         raise SaltCloudSystemExit(
3143             "The create_datastore_cluster function must be called with "
3144             "-f or --function."
3145         )
3146     datastore_cluster_name = kwargs.get("name") if kwargs and "name" in kwargs else None
3147     datacenter_name = (
3148         kwargs.get("datacenter") if kwargs and "datacenter" in kwargs else None
3149     )
3150     if not datastore_cluster_name:
3151         raise SaltCloudSystemExit(
3152             "You must specify name of the new datastore cluster to be created."
3153         )
3154     if not datastore_cluster_name or len(datastore_cluster_name) &gt;= 80:
3155         raise SaltCloudSystemExit(
3156             "The datastore cluster name must be a non empty string of less than 80"
3157             " characters."
3158         )
3159     if not datacenter_name:
3160         raise SaltCloudSystemExit(
3161             "You must specify name of the datacenter where the datastore cluster should"
3162             " be created."
3163         )
3164     si = _get_si()
3165     datastore_cluster_ref = salt.utils.vmware.get_mor_by_property(
3166         si, vim.StoragePod, datastore_cluster_name
3167     )
3168     if datastore_cluster_ref:
3169         return {datastore_cluster_name: "datastore cluster already exists"}
3170     datacenter_ref = salt.utils.vmware.get_mor_by_property(
3171         si, vim.Datacenter, datacenter_name
3172     )
3173     if not datacenter_ref:
3174         raise SaltCloudSystemExit("The specified datacenter does not exist.")
3175     try:
3176         datacenter_ref.datastoreFolder.CreateStoragePod(name=datastore_cluster_name)
3177     except Exception as exc:  # pylint: disable=broad-except
3178         log.error(
3179             "Error creating datastore cluster %s: %s",
3180             datastore_cluster_name,
3181             exc,
3182             exc_info_on_loglevel=logging.DEBUG,
3183         )
3184         return False
3185     return {datastore_cluster_name: "created"}
3186 def shutdown_host(kwargs=None, call=None):
3187     if call != "function":
3188         raise SaltCloudSystemExit(
3189             "The shutdown_host function must be called with -f or --function."
3190         )
3191     host_name = kwargs.get("host") if kwargs and "host" in kwargs else None
3192     force = _str_to_bool(kwargs.get("force")) if kwargs and "force" in kwargs else False
3193     if not host_name:
3194         raise SaltCloudSystemExit("You must specify name of the host system.")
3195     si = _get_si()
3196     host_ref = salt.utils.vmware.get_mor_by_property(si, vim.HostSystem, host_name)
3197     if not host_ref:
3198         raise SaltCloudSystemExit("Specified host system does not exist.")
3199     if host_ref.runtime.connectionState == "notResponding":
3200         raise SaltCloudSystemExit(
3201             "Specified host system cannot be shut down in it's current state (not"
3202             " responding)."
3203         )
3204     if not host_ref.capability.rebootSupported:
3205         raise SaltCloudSystemExit("Specified host system does not support shutdown.")
3206     if not host_ref.runtime.inMaintenanceMode and not force:
3207         raise SaltCloudSystemExit(
3208             "Specified host system is not in maintenance mode. Specify force=True to"
3209             " force reboot even if there are virtual machines running or other"
3210             " operations in progress."
3211         )
3212     try:
3213         host_ref.ShutdownHost_Task(force)
3214     except Exception as exc:  # pylint: disable=broad-except
3215         log.error(
3216             "Error while shutting down host %s: %s",
3217             host_name,
3218             exc,
3219             exc_info_on_loglevel=logging.DEBUG,
3220         )
3221         return {host_name: "failed to shut down host"}
3222     return {host_name: "shut down host"}
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
