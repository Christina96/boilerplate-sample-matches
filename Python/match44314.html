<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_postgres_1.py &amp; bigip.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_postgres_1.py &amp; bigip.py
      </h3>
<h1 align="center">
        6.2%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_postgres_1.py (6.6956997%)<th>bigip.py (5.8851676%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(514-537)<td><a href="#" name="0">(777-793)</a><td align="center"><font color="#ff0000">19</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(696-712)<td><a href="#" name="1">(960-975)</a><td align="center"><font color="#e40000">17</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(812-827)<td><a href="#" name="2">(1194-1208)</a><td align="center"><font color="#d60000">16</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(774-789)<td><a href="#" name="3">(1005-1019)</a><td align="center"><font color="#d60000">16</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(737-751)<td><a href="#" name="4">(369-382)</a><td align="center"><font color="#c90000">15</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(414-428)<td><a href="#" name="5">(338-350)</a><td align="center"><font color="#c90000">15</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(485-497)<td><a href="#" name="6">(508-519)</a><td align="center"><font color="#ae0000">13</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(1427-1439)<td><a href="#" name="7">(1966-1978)</a><td align="center"><font color="#a10000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_postgres_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import datetime
2 import logging
3 import re
4 import salt.modules.postgres as postgres
5 from salt.exceptions import SaltInvocationError
6 from tests.support.mixins import LoaderModuleMockMixin
7 from tests.support.mock import Mock, call, patch
8 from tests.support.unit import TestCase
9 test_list_db_csv = (
10     "Name,Owner,Encoding,Collate,Ctype,Access privileges,Tablespace\n"
11     "template1,postgres,LATIN1,en_US,en_US"
12     ',"{=c/postgres,postgres=CTc/postgres}",pg_default\n'
13     "template0,postgres,LATIN1,en_US,en_US"
14     ',"{=c/postgres,postgres=CTc/postgres}",pg_default\n'
15     "postgres,postgres,LATIN1,en_US,en_US,,pg_default\n"
16     "test_db,postgres,LATIN1,en_US,en_US,,pg_default"
17 )
18 test_list_schema_csv = (
19     "name,owner,acl\n"
20     'public,postgres,"{postgres=UC/postgres,=UC/postgres}"\n'
21     'pg_toast,postgres,""'
22 )
23 test_list_language_csv = "Name\ninternal\nc\nsql\nplpgsql\n"
24 test_privileges_list_table_csv = (
25     "name\n"
26     '"{baruwatest=arwdDxt/baruwatest,bayestest=arwd/baruwatest,baruwa=a*r*w*d*D*x*t*/baruwatest}"\n'
27 )
28 test_privileges_list_group_csv = (
29     "rolname,admin_option\nbaruwa,f\nbaruwatest2,t\nbaruwatest,f\n"
30 )
31 log = logging.getLogger(__name__)
32 class PostgresTestCase(TestCase, LoaderModuleMockMixin):
33     def setup_loader_modules(self):
34         patcher = patch("salt.utils.path.which", Mock(return_value="/usr/bin/pgsql"))
35         patcher.start()
36         self.addCleanup(patcher.stop)
37         return {
38             postgres: {
39                 "__grains__": {"os_family": "Linux"},
40                 "__salt__": {
41                     "config.option": Mock(),
42                     "cmd.run_all": Mock(),
43                     "file.chown": Mock(),
44                     "file.remove": Mock(),
45                 },
46             }
47         }
48     def test_run_psql(self):
49         postgres._run_psql('echo "hi"')
50         cmd = postgres.__salt__["cmd.run_all"]
51         self.assertEqual("postgres", cmd.call_args[1]["runas"])
52     def test_db_alter(self):
53         with patch(
54             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
55         ):
56             postgres.db_alter(
57                 "dbname",
58                 user="testuser",
59                 host="testhost",
60                 port="testport",
61                 maintenance_db="maint_db",
62                 password="foo",
63                 tablespace="testspace",
64                 owner="otheruser",
65                 runas="foo",
66             )
67             postgres._run_psql.assert_has_calls(
68                 [
69                     call(
70                         [
71                             "/usr/bin/pgsql",
72                             "--no-align",
73                             "--no-readline",
74                             "--no-psqlrc",
75                             "--no-password",
76                             "--username",
77                             "testuser",
78                             "--host",
79                             "testhost",
80                             "--port",
81                             "testport",
82                             "--dbname",
83                             "maint_db",
84                             "-c",
85                             'ALTER DATABASE "dbname" OWNER TO "otheruser"',
86                         ],
87                         host="testhost",
88                         user="testuser",
89                         password="foo",
90                         runas="foo",
91                         port="testport",
92                     ),
93                     call(
94                         [
95                             "/usr/bin/pgsql",
96                             "--no-align",
97                             "--no-readline",
98                             "--no-psqlrc",
99                             "--no-password",
100                             "--username",
101                             "testuser",
102                             "--host",
103                             "testhost",
104                             "--port",
105                             "testport",
106                             "--dbname",
107                             "maint_db",
108                             "-c",
109                             'ALTER DATABASE "dbname" SET TABLESPACE "testspace"',
110                         ],
111                         host="testhost",
112                         user="testuser",
113                         password="foo",
114                         runas="foo",
115                         port="testport",
116                     ),
117                 ]
118             )
119     def test_db_alter_owner_recurse(self):
120         with patch(
121             "salt.modules.postgres.owner_to", Mock(return_value={"retcode": None})
122         ):
123             postgres.db_alter(
124                 "dbname",
125                 user="testuser",
126                 host="testhost",
127                 port="testport",
128                 maintenance_db="maint_db",
129                 password="foo",
130                 tablespace="testspace",
131                 owner="otheruser",
132                 owner_recurse=True,
133                 runas="foo",
134             )
135             postgres.owner_to.assert_called_once_with(
136                 "dbname",
137                 "otheruser",
138                 user="testuser",
139                 host="testhost",
140                 port="testport",
141                 password="foo",
142                 runas="foo",
143             )
144     def test_db_create(self):
145         with patch(
146             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
147         ):
148             postgres.db_create(
149                 "dbname",
150                 user="testuser",
151                 host="testhost",
152                 port="testport",
153                 maintenance_db="maint_db",
154                 password="foo",
155                 tablespace="testspace",
156                 owner="otheruser",
157                 runas="foo",
158             )
159             postgres._run_psql.assert_called_once_with(
160                 [
161                     "/usr/bin/pgsql",
162                     "--no-align",
163                     "--no-readline",
164                     "--no-psqlrc",
165                     "--no-password",
166                     "--username",
167                     "testuser",
168                     "--host",
169                     "testhost",
170                     "--port",
171                     "testport",
172                     "--dbname",
173                     "maint_db",
174                     "-c",
175                     'CREATE DATABASE "dbname" WITH TABLESPACE = "testspace" '
176                     'OWNER = "otheruser"',
177                 ],
178                 host="testhost",
179                 user="testuser",
180                 password="foo",
181                 runas="foo",
182                 port="testport",
183             )
184     def test_db_create_empty_string_param(self):
185         with patch(
186             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
187         ):
188             postgres.db_create(
189                 "dbname",
190                 lc_collate="",
191                 encoding="utf8",
192                 user="testuser",
193                 host="testhost",
194                 port=1234,
195                 maintenance_db="maint_db",
196                 password="foo",
197             )
198             postgres._run_psql.assert_called_once_with(
199                 [
200                     "/usr/bin/pgsql",
201                     "--no-align",
202                     "--no-readline",
203                     "--no-psqlrc",
204                     "--no-password",
205                     "--username",
206                     "testuser",
207                     "--host",
208                     "testhost",
209                     "--port",
210                     "1234",
211                     "--dbname",
212                     "maint_db",
213                     "-c",
214                     "CREATE DATABASE \"dbname\" WITH ENCODING = 'utf8' LC_COLLATE = ''",
215                 ],
216                 host="testhost",
217                 password="foo",
218                 port=1234,
219                 runas=None,
220                 user="testuser",
221             )
222     def test_db_create_with_trivial_sql_injection(self):
223         with patch(
224             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
225         ):
226             self.assertRaises(
227                 SaltInvocationError,
228                 postgres.db_create,
229                 "dbname",
230                 lc_collate="foo' ENCODING='utf8",
231             )
232     def test_db_exists(self):
233         with patch(
234             "salt.modules.postgres._run_psql",
235             Mock(return_value={"retcode": 0, "stdout": test_list_db_csv}),
236         ):
237             ret = postgres.db_exists(
238                 "test_db",
239                 user="testuser",
240                 host="testhost",
241                 port="testport",
242                 maintenance_db="maint_db",
243                 password="foo",
244                 runas="foo",
245             )
246             self.assertTrue(ret)
247     def test_db_list(self):
248         with patch(
249             "salt.modules.postgres._run_psql",
250             Mock(return_value={"retcode": 0, "stdout": test_list_db_csv}),
251         ):
252             ret = postgres.db_list(
253                 user="testuser",
254                 host="testhost",
255                 port="testport",
256                 maintenance_db="maint_db",
257                 password="foo",
258                 runas="foo",
259             )
260             self.assertDictEqual(
261                 ret,
262                 {
263                     "test_db": {
264                         "Encoding": "LATIN1",
265                         "Ctype": "en_US",
266                         "Tablespace": "pg_default",
267                         "Collate": "en_US",
268                         "Owner": "postgres",
269                         "Access privileges": "",
270                     },
271                     "template1": {
272                         "Encoding": "LATIN1",
273                         "Ctype": "en_US",
274                         "Tablespace": "pg_default",
275                         "Collate": "en_US",
276                         "Owner": "postgres",
277                         "Access privileges": "{=c/postgres,postgres=CTc/postgres}",
278                     },
279                     "template0": {
280                         "Encoding": "LATIN1",
281                         "Ctype": "en_US",
282                         "Tablespace": "pg_default",
283                         "Collate": "en_US",
284                         "Owner": "postgres",
285                         "Access privileges": "{=c/postgres,postgres=CTc/postgres}",
286                     },
287                     "postgres": {
288                         "Encoding": "LATIN1",
289                         "Ctype": "en_US",
290                         "Tablespace": "pg_default",
291                         "Collate": "en_US",
292                         "Owner": "postgres",
293                         "Access privileges": "",
294                     },
295                 },
296             )
297     def test_db_remove(self):
298         with patch(
299             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
300         ):
301             postgres.db_remove(
302                 "test_db",
303                 user="testuser",
304                 host="testhost",
305                 port="testport",
306                 maintenance_db="maint_db",
307                 password="foo",
308                 runas="foo",
309             )
310             calls = (
311                 call(
312                     [
313                         "/usr/bin/pgsql",
314                         "--no-align",
315                         "--no-readline",
316                         "--no-psqlrc",
317                         "--no-password",
318                         "--username",
319                         "testuser",
320                         "--host",
321                         "testhost",
322                         "--port",
323                         "testport",
324                         "--dbname",
325                         "maint_db",
326                         "-c",
327                         'REVOKE CONNECT ON DATABASE "test_db" FROM public;',
328                     ],
329                     host="testhost",
330                     password="foo",
331                     port="testport",
332                     runas="foo",
333                     user="testuser",
334                 ),
335                 call(
336                     [
337                         "/usr/bin/pgsql",
338                         "--no-align",
339                         "--no-readline",
340                         "--no-psqlrc",
341                         "--no-password",
342                         "--username",
343                         "testuser",
344                         "--host",
345                         "testhost",
346                         "--port",
347                         "testport",
348                         "--dbname",
349                         "maint_db",
350                         "-c",
351                         "SELECT pid, pg_terminate_backend(pid) FROM pg_stat_activity"
352                         " WHERE datname = 'test_db' AND pid &lt;&gt; pg_backend_pid();",
353                     ],
354                     host="testhost",
355                     password="foo",
356                     port="testport",
357                     runas="foo",
358                     user="testuser",
359                 ),
360                 call(
361                     [
362                         "/usr/bin/pgsql",
363                         "--no-align",
364                         "--no-readline",
365                         "--no-psqlrc",
366                         "--no-password",
367                         "--username",
368                         "testuser",
369                         "--host",
370                         "testhost",
371                         "--port",
372                         "testport",
373                         "--dbname",
374                         "maint_db",
375                         "-c",
376                         'DROP DATABASE "test_db";',
377                     ],
378                     host="testhost",
379                     password="foo",
380                     port="testport",
381                     runas="foo",
382                     user="testuser",
383                 ),
384             )
385             postgres._run_psql.assert_has_calls(calls, any_order=True)
386     def test_group_create(self):
387 <a name="5"></a>        with patch(
388             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
389         ):
390             with patch("salt.modules.postgres.user_exists", Mock(return_value<font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=False)):
391                 postgres.group_create(
392                     "testgroup",
393                     user="testuser",
394                     host="testhost",
395                     port="testport",
396                     maintenance_db="maint_db",
397                     password="foo",
398                     createdb=False,
399                     encrypted=False,
400                     superuser=False,
401                     replication=False,
402                     rolepassword="testrolepass",
403                     groups="testgroup",
404                     runas=</b></font>"foo",
405                 )
406                 self.assertTrue(
407                     postgres._run_psql.call_args[0][0][14].startswith("CREATE ROLE")
408                 )
409     def test_group_remove(self):
410         with patch(
411             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
412         ):
413             with patch("salt.modules.postgres.user_exists", Mock(return_value=True)):
414                 postgres.group_remove(
415                     "testgroup",
416                     user="testuser",
417                     host="testhost",
418                     port="testport",
419                     maintenance_db="maint_db",
420                     password="foo",
421                     runas="foo",
422                 )
423                 postgres._run_psql.assert_called_once_with(
424                     [
425                         "/usr/bin/pgsql",
426                         "--no-align",
427                         "--no-readline",
428                         "--no-psqlrc",
429                         "--no-password",
430                         "--username",
431                         "testuser",
432                         "--host",
433                         "testhost",
434                         "--port",
435                         "testport",
436                         "--dbname",
437                         "maint_db",
438                         "-c",
439                         'DROP ROLE "testgroup"',
440                     ],
441                     host="testhost",
442                     user="testuser",
443                     password="foo",
444                     runas="foo",
445                     port="testport",
446                 )
447     def test_group_update(self):
448         with patch(
449             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
450         ):
451             with patch(
452 <a name="6"></a>                "salt.modules.postgres.role_get",
453                 Mock(return_value={"superuser": False}),
454             ):
455                 postgres<font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.group_update(
456                     "testgroup",
457                     user='"testuser"',
458                     host="testhost",
459                     port="testport",
460                     maintenance_db="maint_db",
461                     password="foo",
462                     createdb=False,
463                     encrypted=False,
464                     replication=False,
465                     rolepassword="test_role_pass",
466                     groups="testgroup",
467                     runas=</b></font>"foo",
468                 )
469                 self.assertTrue(
470                     re.match(
471                         'ALTER.* "testgroup" .* UNENCRYPTED PASSWORD',
472                         postgres._run_psql.call_args[0][0][14],
473                     )
474                 )
475     def test_user_create(self):
476 <a name="0"></a>        with patch(
477             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
478         ):
479             with patch("salt.modules.postgres.user_exists", Mock(return_value<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=False)):
480                 postgres.user_create(
481                     "testuser",
482                     user="testuser",
483                     host="testhost",
484                     port="testport",
485                     maintenance_db="maint_test",
486                     password="test_pass",
487                     login=True,
488                     createdb=False,
489                     createroles=False,
490                     encrypted=False,
491                     superuser=False,
492                     replication=False,
493                     rolepassword="test_role_pass",
494                     valid_until="2042-07-01",
495                     groups="test_groups",
496                     runas="foo",
497                 )
498                 call =</b></font> postgres._run_psql.call_args[0][0][14]
499                 self.assertTrue(re.match('CREATE ROLE "testuser"', call))
500                 for i in (
501                     "INHERIT",
502                     "NOCREATEDB",
503                     "NOCREATEROLE",
504                     "NOSUPERUSER",
505                     "NOREPLICATION",
506                     "LOGIN",
507                     "UNENCRYPTED",
508                     "PASSWORD",
509                     "VALID UNTIL",
510                 ):
511                     self.assertTrue(i in call, "{} not in {}".format(i, call))
512     def test_user_exists(self):
513         with patch(
514             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
515         ):
516             with patch("salt.modules.postgres.version", Mock(return_value="9.1")):
517                 with patch(
518                     "salt.modules.postgres.psql_query",
519                     Mock(
520                         return_value=[
521                             {
522                                 "name": "test_user",
523                                 "superuser": "t",
524                                 "inherits privileges": "t",
525                                 "can create roles": "t",
526                                 "can create databases": "t",
527                                 "can update system catalogs": "t",
528                                 "can login": "t",
529                                 "replication": None,
530                                 "password": "test_password",
531                                 "connections": "-1",
532                                 "groups": "",
533                                 "expiry time": "",
534                                 "defaults variables": None,
535                             }
536                         ]
537                     ),
538                 ):
539                     ret = postgres.user_exists(
540                         "test_user",
541                         user="test_user",
542                         host="test_host",
543                         port="test_port",
544                         maintenance_db="maint_db",
545                         password="test_password",
546                         runas="foo",
547                     )
548                     self.assertTrue(ret)
549     def test_user_list(self):
550         with patch(
551             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
552         ):
553             with patch("salt.modules.postgres.version", Mock(return_value="9.1")):
554                 with patch(
555                     "salt.modules.postgres.psql_query",
556                     Mock(
557                         return_value=[
558                             {
559                                 "name": "test_user",
560                                 "superuser": "t",
561                                 "inherits privileges": "t",
562                                 "can create roles": "t",
563                                 "can create databases": "t",
564                                 "can update system catalogs": "t",
565                                 "can login": "t",
566                                 "replication": None,
567                                 "connections": "-1",
568                                 "groups": "",
569                                 "expiry time": "2017-08-16 08:57:46",
570                                 "defaults variables": None,
571                             }
572                         ]
573                     ),
574                 ):
575                     ret = postgres.user_list(
576                         "test_user",
577                         host="test_host",
578                         port="test_port",
579                         maintenance_db="maint_db",
580                         password="test_password",
581                         runas="foo",
582                     )
583                     self.assertDictEqual(
584                         ret,
585                         {
586                             "test_user": {
587                                 "superuser": True,
588                                 "defaults variables": None,
589                                 "can create databases": True,
590                                 "can create roles": True,
591                                 "connections": None,
592                                 "replication": None,
593                                 "expiry time": datetime.datetime(
594                                     2017, 8, 16, 8, 57, 46
595                                 ),
596                                 "can login": True,
597                                 "can update system catalogs": True,
598                                 "groups": [],
599                                 "inherits privileges": True,
600                             }
601                         },
602                     )
603     def test_user_remove(self):
604         with patch(
605             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
606         ):
607             with patch("salt.modules.postgres.version", Mock(return_value="9.1")):
608                 with patch(
609                     "salt.modules.postgres.user_exists", Mock(return_value=True)
610                 ):
611                     postgres.user_remove(
612                         "testuser",
613                         user="testuser",
614                         host="testhost",
615                         port="testport",
616                         maintenance_db="maint_db",
617                         password="testpassword",
618                         runas="foo",
619                     )
620                     postgres._run_psql.assert_called_once_with(
621                         [
622                             "/usr/bin/pgsql",
623                             "--no-align",
624                             "--no-readline",
625                             "--no-psqlrc",
626                             "--no-password",
627                             "--username",
628                             "testuser",
629                             "--host",
630                             "testhost",
631                             "--port",
632                             "testport",
633                             "--dbname",
634                             "maint_db",
635                             "-c",
636                             'DROP ROLE "testuser"',
637                         ],
638                         host="testhost",
639                         port="testport",
640                         user="testuser",
641                         password="testpassword",
642                         runas="foo",
643                     )
644     def test_user_update(self):
645         with patch(
646             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
647         ):
648             with patch(
649 <a name="1"></a>                "salt.modules.postgres.role_get",
650                 Mock(return_value={"superuser": False}),
651             ):
652                 postgres<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.user_update(
653                     "test_username",
654                     user="test_user",
655                     host="test_host",
656                     port="test_port",
657                     maintenance_db="test_maint",
658                     password="test_pass",
659                     createdb=False,
660                     createroles=False,
661                     encrypted=False,
662                     inherit=True,
663                     login=True,
664                     replication=False,
665                     rolepassword="test_role_pass",
666                     valid_until="2017-07-01",
667                     groups="test_groups",
668                     runas=</b></font>"foo",
669                 )
670                 self.assertTrue(
671                     re.match(
672                         'ALTER ROLE "test_username" WITH  INHERIT NOCREATEDB '
673                         "NOCREATEROLE NOREPLICATION LOGIN "
674                         "UNENCRYPTED PASSWORD ['\"]{0,5}test_role_pass['\"]{0,5} "
675                         "VALID UNTIL '2017-07-01';"
676                         ' GRANT "test_groups" TO "test_username"',
677                         postgres._run_psql.call_args[0][0][14],
678                     )
679                 )
680     def test_user_update2(self):
681         with patch(
682             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
683         ):
684             with patch(
685 <a name="4"></a>                "salt.modules.postgres.role_get",
686                 Mock(return_value={"superuser": False}),
687             ):
688                 postgres<font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.user_update(
689                     "test_username",
690                     user="test_user",
691                     host="test_host",
692                     port="test_port",
693                     maintenance_db="test_maint",
694                     password="test_pass",
695                     createdb=False,
696                     createroles=True,
697                     encrypted=False,
698                     inherit=True,
699                     login=True,
700                     replication=False,
701                     groups="test_groups",
702                     runas=</b></font>"foo",
703                 )
704                 self.assertTrue(
705                     re.match(
706                         'ALTER ROLE "test_username" WITH  INHERIT NOCREATEDB '
707                         "CREATEROLE NOREPLICATION LOGIN;"
708                         ' GRANT "test_groups" TO "test_username"',
709                         postgres._run_psql.call_args[0][0][14],
710                     )
711                 )
712     def test_user_update3(self):
713         with patch(
714             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
715         ):
716             with patch(
717 <a name="3"></a>                "salt.modules.postgres.role_get",
718                 Mock(return_value={"superuser": False}),
719             ):
720                 postgres<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.user_update(
721                     "test_username",
722                     user="test_user",
723                     host="test_host",
724                     port="test_port",
725                     maintenance_db="test_maint",
726                     password="test_pass",
727                     createdb=False,
728                     createroles=True,
729                     encrypted=False,
730                     inherit=True,
731                     login=True,
732                     rolepassword=False,
733                     replication=False,
734                     groups="test_groups",
735                     runas=</b></font>"foo",
736                 )
737                 self.assertTrue(
738                     re.match(
739                         'ALTER ROLE "test_username" WITH  INHERIT NOCREATEDB '
740                         "CREATEROLE NOREPLICATION LOGIN NOPASSWORD;"
741                         ' GRANT "test_groups" TO "test_username"',
742                         postgres._run_psql.call_args[0][0][14],
743                     )
744                 )
745     def test_user_update_encrypted_passwd(self):
746         with patch(
747             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
748         ):
749             with patch(
750 <a name="2"></a>                "salt.modules.postgres.role_get",
751                 Mock(return_value={"superuser": False}),
752             ):
753                 postgres<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.user_update(
754                     "test_username",
755                     user="test_user",
756                     host="test_host",
757                     port="test_port",
758                     maintenance_db="test_maint",
759                     password="test_pass",
760                     createdb=False,
761                     createroles=True,
762                     encrypted=True,
763                     inherit=True,
764                     login=True,
765                     rolepassword="foobar",
766                     replication=False,
767                     groups="test_groups",
768                     runas=</b></font>"foo",
769                 )
770                 self.assertTrue(
771                     re.match(
772                         'ALTER ROLE "test_username" WITH  INHERIT NOCREATEDB '
773                         "CREATEROLE NOREPLICATION LOGIN "
774                         "ENCRYPTED PASSWORD "
775                         "['\"]{0,5}md531c27e68d3771c392b52102c01be1da1['\"]{0,5}"
776                         '; GRANT "test_groups" TO "test_username"',
777                         postgres._run_psql.call_args[0][0][14],
778                     )
779                 )
780     def test_version(self):
781         with patch(
782             "salt.modules.postgres._run_psql",
783             Mock(return_value={"retcode": 0, "stdout": "9.1.9"}),
784         ):
785             postgres.version(
786                 user="test_user",
787                 host="test_host",
788                 port="test_port",
789                 maintenance_db="test_maint",
790                 password="test_pass",
791                 runas="foo",
792             )
793             self.assertTrue(
794                 re.match(
795                     "SELECT setting FROM pg_catalog.pg_settings",
796                     postgres._run_psql.call_args[0][0][14],
797                 )
798             )
799     def test_installed_extensions(self):
800         with patch(
801             "salt.modules.postgres.psql_query",
802             Mock(return_value=[{"extname": "foo", "extversion": "1"}]),
803         ):
804             exts = postgres.installed_extensions()
805             self.assertEqual(exts, {"foo": {"extversion": "1", "extname": "foo"}})
806     def test_available_extensions(self):
807         with patch(
808             "salt.modules.postgres.psql_query",
809             Mock(return_value=[{"name": "foo", "default_version": "1"}]),
810         ):
811             exts = postgres.available_extensions()
812             self.assertEqual(exts, {"foo": {"default_version": "1", "name": "foo"}})
813     def test_drop_extension2(self):
814         with patch(
815             "salt.modules.postgres.installed_extensions", Mock(side_effect=[{}, {}])
816         ):
817             with patch(
818                 "salt.modules.postgres._psql_prepare_and_run", Mock(return_value=None)
819             ):
820                 with patch(
821                     "salt.modules.postgres.available_extensions",
822                     Mock(return_value={"foo": {"default_version": "1", "name": "foo"}}),
823                 ):
824                     self.assertEqual(postgres.drop_extension("foo"), True)
825     def test_drop_extension3(self):
826         with patch(
827             "salt.modules.postgres.installed_extensions",
828             Mock(side_effect=[{"foo": {"extversion": "1", "extname": "foo"}}, {}]),
829         ):
830             with patch(
831                 "salt.modules.postgres._psql_prepare_and_run", Mock(return_value=None)
832             ):
833                 with patch(
834                     "salt.modules.postgres.available_extensions",
835                     Mock(return_value={"foo": {"default_version": "1", "name": "foo"}}),
836                 ):
837                     self.assertEqual(postgres.drop_extension("foo"), True)
838     def test_drop_extension1(self):
839         with patch(
840             "salt.modules.postgres.installed_extensions",
841             Mock(
842                 side_effect=[
843                     {"foo": {"extversion": "1", "extname": "foo"}},
844                     {"foo": {"extversion": "1", "extname": "foo"}},
845                 ]
846             ),
847         ):
848             with patch(
849                 "salt.modules.postgres._psql_prepare_and_run", Mock(return_value=None)
850             ):
851                 with patch(
852                     "salt.modules.postgres.available_extensions",
853                     Mock(return_value={"foo": {"default_version": "1", "name": "foo"}}),
854                 ):
855                     self.assertEqual(postgres.drop_extension("foo"), False)
856     def test_create_mtdata(self):
857         with patch(
858             "salt.modules.postgres.installed_extensions",
859             Mock(
860                 return_value={
861                     "foo": {
862                         "extversion": "0.8",
863                         "extrelocatable": "t",
864                         "schema_name": "foo",
865                         "extname": "foo",
866                     }
867                 },
868             ),
869         ):
870             with patch(
871                 "salt.modules.postgres.available_extensions",
872                 Mock(return_value={"foo": {"default_version": "1.4", "name": "foo"}}),
873             ):
874                 ret = postgres.create_metadata("foo", schema="bar", ext_version="1.4")
875                 self.assertTrue(postgres._EXTENSION_INSTALLED in ret)
876                 self.assertTrue(postgres._EXTENSION_TO_UPGRADE in ret)
877                 self.assertTrue(postgres._EXTENSION_TO_MOVE in ret)
878                 ret = postgres.create_metadata("foo", schema="foo", ext_version="0.4")
879                 self.assertTrue(postgres._EXTENSION_INSTALLED in ret)
880                 self.assertFalse(postgres._EXTENSION_TO_UPGRADE in ret)
881                 self.assertFalse(postgres._EXTENSION_TO_MOVE in ret)
882                 ret = postgres.create_metadata("foo")
883                 self.assertTrue(postgres._EXTENSION_INSTALLED in ret)
884                 self.assertFalse(postgres._EXTENSION_TO_UPGRADE in ret)
885                 self.assertFalse(postgres._EXTENSION_TO_MOVE in ret)
886                 ret = postgres.create_metadata("foobar")
887                 self.assertTrue(postgres._EXTENSION_NOT_INSTALLED in ret)
888                 self.assertFalse(postgres._EXTENSION_INSTALLED in ret)
889                 self.assertFalse(postgres._EXTENSION_TO_UPGRADE in ret)
890                 self.assertFalse(postgres._EXTENSION_TO_MOVE in ret)
891     def test_create_extension_newerthan(self):
892         with patch(
893             "salt.modules.postgres.create_metadata",
894             Mock(
895                 side_effect=[
896                     [postgres._EXTENSION_NOT_INSTALLED],
897                     [postgres._EXTENSION_INSTALLED],
898                     [postgres._EXTENSION_NOT_INSTALLED],
899                     [postgres._EXTENSION_INSTALLED],
900                     [postgres._EXTENSION_NOT_INSTALLED],
901                     [postgres._EXTENSION_NOT_INSTALLED],
902                     [
903                         postgres._EXTENSION_TO_MOVE,
904                         postgres._EXTENSION_TO_UPGRADE,
905                         postgres._EXTENSION_INSTALLED,
906                     ],
907                     [postgres._EXTENSION_INSTALLED],
908                     [postgres._EXTENSION_TO_MOVE, postgres._EXTENSION_INSTALLED],
909                     [postgres._EXTENSION_INSTALLED],
910                     [postgres._EXTENSION_TO_UPGRADE, postgres._EXTENSION_INSTALLED],
911                     [postgres._EXTENSION_INSTALLED],
912                     [postgres._EXTENSION_TO_UPGRADE, postgres._EXTENSION_INSTALLED],
913                     [postgres._EXTENSION_TO_UPGRADE, postgres._EXTENSION_INSTALLED],
914                     [postgres._EXTENSION_TO_MOVE, postgres._EXTENSION_INSTALLED],
915                     [postgres._EXTENSION_TO_MOVE, postgres._EXTENSION_INSTALLED],
916                 ]
917             ),
918         ):
919             with patch(
920                 "salt.modules.postgres._psql_prepare_and_run", Mock(return_value=None)
921             ):
922                 with patch(
923                     "salt.modules.postgres.available_extensions",
924                     Mock(
925                         return_value={"foo": {"default_version": "1.4", "name": "foo"}}
926                     ),
927                 ):
928                     self.assertTrue(postgres.create_extension("foo"))
929                     self.assertTrue(
930                         re.match(
931                             'CREATE EXTENSION IF NOT EXISTS "foo" ;',
932                             postgres._psql_prepare_and_run.call_args[0][0][1],
933                         )
934                     )
935                     self.assertTrue(
936                         postgres.create_extension(
937                             "foo", schema="a", ext_version="b", from_version="c"
938                         )
939                     )
940                     self.assertTrue(
941                         re.match(
942                             'CREATE EXTENSION IF NOT EXISTS "foo" '
943                             'WITH SCHEMA "a" VERSION b FROM c ;',
944                             postgres._psql_prepare_and_run.call_args[0][0][1],
945                         )
946                     )
947                     self.assertFalse(postgres.create_extension("foo"))
948                     ret = postgres.create_extension("foo", ext_version="a", schema="b")
949                     self.assertTrue(ret)
950                     self.assertTrue(
951                         re.match(
952                             'ALTER EXTENSION "foo" SET SCHEMA "b";'
953                             ' ALTER EXTENSION "foo" UPDATE TO a;',
954                             postgres._psql_prepare_and_run.call_args[0][0][1],
955                         )
956                     )
957                     ret = postgres.create_extension("foo", ext_version="a", schema="b")
958                     self.assertTrue(ret)
959                     self.assertTrue(
960                         re.match(
961                             'ALTER EXTENSION "foo" SET SCHEMA "b";',
962                             postgres._psql_prepare_and_run.call_args[0][0][1],
963                         )
964                     )
965                     ret = postgres.create_extension("foo", ext_version="a", schema="b")
966                     self.assertTrue(ret)
967                     self.assertTrue(
968                         re.match(
969                             'ALTER EXTENSION "foo" UPDATE TO a;',
970                             postgres._psql_prepare_and_run.call_args[0][0][1],
971                         )
972                     )
973                     self.assertFalse(
974                         postgres.create_extension("foo", ext_version="a", schema="b")
975                     )
976                     self.assertFalse(
977                         postgres.create_extension("foo", ext_version="a", schema="b")
978                     )
979     def test_encrypt_passwords(self):
980         self.assertEqual(postgres._maybe_encrypt_password("foo", "bar", False), "bar")
981         self.assertEqual(
982             postgres._maybe_encrypt_password("foo", "bar", True),
983             "md596948aad3fcae80c08a35c9b5958cd89",
984         )
985     def test_schema_list(self):
986         with patch(
987             "salt.modules.postgres._run_psql",
988             Mock(return_value={"retcode": 0, "stdout": test_list_schema_csv}),
989         ):
990             ret = postgres.schema_list(
991                 "maint_db",
992                 db_user="testuser",
993                 db_host="testhost",
994                 db_port="testport",
995                 db_password="foo",
996             )
997             self.assertDictEqual(
998                 ret,
999                 {
1000                     "public": {
1001                         "acl": "{postgres=UC/postgres,=UC/postgres}",
1002                         "owner": "postgres",
1003                     },
1004                     "pg_toast": {"acl": "", "owner": "postgres"},
1005                 },
1006             )
1007     def test_schema_exists(self):
1008         with patch(
1009             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1010         ):
1011             with patch(
1012                 "salt.modules.postgres.psql_query",
1013                 Mock(
1014                     return_value=[
1015                         {
1016                             "name": "public",
1017                             "acl": "{postgres=UC/postgres,=UC/postgres}",
1018                             "owner": "postgres",
1019                         }
1020                     ]
1021                 ),
1022             ):
1023                 ret = postgres.schema_exists("template1", "public")
1024                 self.assertTrue(ret)
1025     def test_schema_get(self):
1026         with patch(
1027             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1028         ):
1029             with patch(
1030                 "salt.modules.postgres.psql_query",
1031                 Mock(
1032                     return_value=[
1033                         {
1034                             "name": "public",
1035                             "acl": "{postgres=UC/postgres,=UC/postgres}",
1036                             "owner": "postgres",
1037                         }
1038                     ]
1039                 ),
1040             ):
1041                 ret = postgres.schema_get("template1", "public")
1042                 self.assertTrue(ret)
1043     def test_schema_get_again(self):
1044         with patch(
1045             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1046         ):
1047             with patch(
1048                 "salt.modules.postgres.psql_query",
1049                 Mock(
1050                     return_value=[
1051                         {
1052                             "name": "public",
1053                             "acl": "{postgres=UC/postgres,=UC/postgres}",
1054                             "owner": "postgres",
1055                         }
1056                     ]
1057                 ),
1058             ):
1059                 ret = postgres.schema_get("template1", "pg_toast")
1060                 self.assertFalse(ret)
1061     def test_schema_create(self):
1062         with patch(
1063             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1064         ):
1065             with patch("salt.modules.postgres.schema_exists", Mock(return_value=False)):
1066                 postgres.schema_create(
1067                     "maint_db",
1068                     "testschema",
1069                     user="user",
1070                     db_host="testhost",
1071                     db_port="testport",
1072                     db_user="testuser",
1073                     db_password="testpassword",
1074                 )
1075                 postgres._run_psql.assert_called_once_with(
1076                     [
1077                         "/usr/bin/pgsql",
1078                         "--no-align",
1079                         "--no-readline",
1080                         "--no-psqlrc",
1081                         "--no-password",
1082                         "--username",
1083                         "testuser",
1084                         "--host",
1085                         "testhost",
1086                         "--port",
1087                         "testport",
1088                         "--dbname",
1089                         "maint_db",
1090                         "-c",
1091                         'CREATE SCHEMA "testschema"',
1092                     ],
1093                     host="testhost",
1094                     port="testport",
1095                     password="testpassword",
1096                     user="testuser",
1097                     runas="user",
1098                 )
1099     def test_schema_create2(self):
1100         with patch("salt.modules.postgres.schema_exists", Mock(return_value=True)):
1101             ret = postgres.schema_create(
1102                 "test_db",
1103                 "test_schema",
1104                 user="user",
1105                 db_host="test_host",
1106                 db_port="test_port",
1107                 db_user="test_user",
1108                 db_password="test_password",
1109             )
1110             self.assertFalse(ret)
1111     def test_schema_remove(self):
1112         with patch(
1113             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1114         ):
1115             with patch("salt.modules.postgres.schema_exists", Mock(return_value=True)):
1116                 postgres.schema_remove(
1117                     "maint_db",
1118                     "testschema",
1119                     user="user",
1120                     db_host="testhost",
1121                     db_port="testport",
1122                     db_user="testuser",
1123                     db_password="testpassword",
1124                 )
1125                 postgres._run_psql.assert_called_once_with(
1126                     [
1127                         "/usr/bin/pgsql",
1128                         "--no-align",
1129                         "--no-readline",
1130                         "--no-psqlrc",
1131                         "--no-password",
1132                         "--username",
1133                         "testuser",
1134                         "--host",
1135                         "testhost",
1136                         "--port",
1137                         "testport",
1138                         "--dbname",
1139                         "maint_db",
1140                         "-c",
1141                         'DROP SCHEMA "testschema"',
1142                     ],
1143                     host="testhost",
1144                     port="testport",
1145                     password="testpassword",
1146                     user="testuser",
1147                     runas="user",
1148                 )
1149     def test_schema_remove2(self):
1150         with patch("salt.modules.postgres.schema_exists", Mock(return_value=False)):
1151             ret = postgres.schema_remove(
1152                 "test_db",
1153                 "test_schema",
1154                 user="user",
1155                 db_host="test_host",
1156                 db_port="test_port",
1157                 db_user="test_user",
1158                 db_password="test_password",
1159             )
1160             self.assertFalse(ret)
1161     def test_language_list(self):
1162         with patch(
1163             "salt.modules.postgres._run_psql",
1164             Mock(return_value={"retcode": 0, "stdout": test_list_language_csv}),
1165         ):
1166             ret = postgres.language_list(
1167                 "testdb",
1168                 user="testuser",
1169                 host="testhost",
1170                 port="testport",
1171                 password="foo",
1172             )
1173             self.assertDictEqual(
1174                 ret,
1175                 {"c": "c", "internal": "internal", "plpgsql": "plpgsql", "sql": "sql"},
1176             )
1177     def test_language_exists(self):
1178         with patch(
1179             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1180         ):
1181             with patch(
1182                 "salt.modules.postgres.psql_query",
1183                 Mock(
1184                     return_value=[
1185                         {"Name": "internal"},
1186                         {"Name": "c"},
1187                         {"Name": "sql"},
1188                         {"Name": "plpgsql"},
1189                     ]
1190                 ),
1191             ):
1192                 with patch(
1193                     "salt.modules.postgres.language_exists", Mock(return_value=True)
1194                 ):
1195                     ret = postgres.language_exists("sql", "testdb")
1196                     self.assertTrue(ret)
1197     def test_language_create(self):
1198         with patch(
1199             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1200         ):
1201             with patch(
1202                 "salt.modules.postgres.language_exists", Mock(return_value=False)
1203             ):
1204                 postgres.language_create(
1205                     "plpythonu",
1206                     "testdb",
1207                     runas="user",
1208                     host="testhost",
1209                     port="testport",
1210                     user="testuser",
1211                     password="testpassword",
1212                 )
1213                 postgres._run_psql.assert_called_once_with(
1214                     [
1215                         "/usr/bin/pgsql",
1216                         "--no-align",
1217                         "--no-readline",
1218                         "--no-psqlrc",
1219                         "--no-password",
1220                         "--username",
1221                         "testuser",
1222                         "--host",
1223                         "testhost",
1224                         "--port",
1225                         "testport",
1226                         "--dbname",
1227                         "testdb",
1228                         "-c",
1229                         "CREATE LANGUAGE plpythonu",
1230                     ],
1231                     host="testhost",
1232                     port="testport",
1233                     password="testpassword",
1234                     user="testuser",
1235                     runas="user",
1236                 )
1237     def test_language_create_exists(self):
1238         with patch("salt.modules.postgres.language_exists", Mock(return_value=True)):
1239             ret = postgres.language_create(
1240                 "plpythonu",
1241                 "testdb",
1242                 runas="user",
1243                 host="testhost",
1244                 port="testport",
1245                 user="testuser",
1246                 password="testpassword",
1247             )
1248             self.assertFalse(ret)
1249     def test_language_remove(self):
1250         with patch(
1251             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1252         ):
1253             with patch(
1254                 "salt.modules.postgres.language_exists", Mock(return_value=True)
1255             ):
1256                 postgres.language_remove(
1257                     "plpgsql",
1258                     "testdb",
1259                     runas="user",
1260                     host="testhost",
1261                     port="testport",
1262                     user="testuser",
1263                     password="testpassword",
1264                 )
1265                 postgres._run_psql.assert_called_once_with(
1266                     [
1267                         "/usr/bin/pgsql",
1268                         "--no-align",
1269                         "--no-readline",
1270                         "--no-psqlrc",
1271                         "--no-password",
1272                         "--username",
1273                         "testuser",
1274                         "--host",
1275                         "testhost",
1276                         "--port",
1277                         "testport",
1278                         "--dbname",
1279                         "testdb",
1280                         "-c",
1281                         "DROP LANGUAGE plpgsql",
1282                     ],
1283                     host="testhost",
1284                     port="testport",
1285                     password="testpassword",
1286                     user="testuser",
1287                     runas="user",
1288                 )
1289     def test_language_remove_non_exist(self):
1290         with patch("salt.modules.postgres.language_exists", Mock(return_value=False)):
1291             ret = postgres.language_remove(
1292                 "plpgsql",
1293                 "testdb",
1294                 runas="user",
1295                 host="testhost",
1296                 port="testport",
1297                 user="testuser",
1298                 password="testpassword",
1299             )
1300             self.assertFalse(ret)
1301     def test_privileges_list_table(self):
1302             Mock(return_value<font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>={"retcode": 0, "stdout": test_privileges_list_table_csv}),
1303         ):
1304             ret = postgres.privileges_list(
1305                 "awl",
1306                 "table",
1307                 maintenance_db="db_name",
1308                 runas="user",
1309                 host="testhost",
1310                 port="testport",
1311                 user="testuser",
1312                 password="testpassword",
1313             )
1314             expected =</b></font> {
1315                 "bayestest": {
1316                     "INSERT": False,
1317                     "UPDATE": False,
1318                     "SELECT": False,
1319                     "DELETE": False,
1320                 },
1321                 "baruwa": {
1322                     "INSERT": True,
1323                     "TRUNCATE": True,
1324                     "UPDATE": True,
1325                     "TRIGGER": True,
1326                     "REFERENCES": True,
1327                     "SELECT": True,
1328                     "DELETE": True,
1329                 },
1330                 "baruwatest": {
1331                     "INSERT": False,
1332                     "TRUNCATE": False,
1333                     "UPDATE": False,
1334                     "TRIGGER": False,
1335                     "REFERENCES": False,
1336                     "SELECT": False,
1337                     "DELETE": False,
1338                 },
1339             }
1340             self.assertDictEqual(ret, expected)
1341             query = (
1342                 "COPY (SELECT relacl AS name FROM pg_catalog.pg_class c "
1343                 "JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace "
1344                 "WHERE nspname = 'public' AND relname = 'awl' AND relkind = 'r' "
1345                 "ORDER BY relname) TO STDOUT WITH CSV HEADER"
1346             )
1347             postgres._run_psql.assert_called_once_with(
1348                 [
1349                     "/usr/bin/pgsql",
1350                     "--no-align",
1351                     "--no-readline",
1352                     "--no-psqlrc",
1353                     "--no-password",
1354                     "--username",
1355                     "testuser",
1356                     "--host",
1357                     "testhost",
1358                     "--port",
1359                     "testport",
1360                     "--dbname",
1361                     "db_name",
1362                     "-v",
1363                     "datestyle=ISO,MDY",
1364                     "-c",
1365                     query,
1366                 ],
1367                 host="testhost",
1368                 port="testport",
1369                 password="testpassword",
1370                 user="testuser",
1371                 runas="user",
1372             )
1373     def test_privileges_list_group(self):
1374         with patch(
1375             "salt.modules.postgres._run_psql",
1376             Mock(return_value={"retcode": 0, "stdout": test_privileges_list_group_csv}),
1377         ):
1378             ret = postgres.privileges_list(
1379                 "admin",
1380                 "group",
1381                 maintenance_db="db_name",
1382                 runas="user",
1383                 host="testhost",
1384                 port="testport",
1385                 user="testuser",
1386                 password="testpassword",
1387             )
1388             expected = {
1389                 "baruwa": False,
1390                 "baruwatest": False,
1391                 "baruwatest2": True,
1392             }
1393             self.assertDictEqual(ret, expected)
1394             query = (
1395                 "COPY (SELECT rolname, admin_option "
1396                 "FROM pg_catalog.pg_auth_members m JOIN pg_catalog.pg_roles r "
1397                 "ON m.member=r.oid WHERE m.roleid IN (SELECT oid FROM "
1398                 "pg_catalog.pg_roles WHERE rolname='admin') ORDER BY rolname) "
1399                 "TO STDOUT WITH CSV HEADER"
1400             )
1401             postgres._run_psql.assert_called_once_with(
1402                 [
1403                     "/usr/bin/pgsql",
1404                     "--no-align",
1405                     "--no-readline",
1406                     "--no-psqlrc",
1407                     "--no-password",
1408                     "--username",
1409                     "testuser",
1410                     "--host",
1411                     "testhost",
1412                     "--port",
1413                     "testport",
1414                     "--dbname",
1415                     "db_name",
1416                     "-v",
1417                     "datestyle=ISO,MDY",
1418                     "-c",
1419                     query,
1420                 ],
1421                 host="testhost",
1422                 port="testport",
1423                 password="testpassword",
1424                 user="testuser",
1425                 runas="user",
1426             )
1427     def test_has_privileges_on_table(self):
1428         with patch(
1429             "salt.modules.postgres._run_psql",
1430             Mock(return_value={"retcode": 0, "stdout": test_privileges_list_table_csv}),
1431         ):
1432             ret = postgres.has_privileges(
1433                 "baruwa",
1434                 "awl",
1435                 "table",
1436                 "SELECT,INSERT",
1437                 grant_option=True,
1438                 maintenance_db="db_name",
1439                 runas="user",
1440                 host="testhost",
1441                 port="testport",
1442                 user="testuser",
1443                 password="testpassword",
1444             )
1445             self.assertTrue(ret)
1446             ret = postgres.has_privileges(
1447                 "baruwa",
1448                 "awl",
1449                 "table",
1450                 "ALL",
1451                 grant_option=True,
1452                 maintenance_db="db_name",
1453                 runas="user",
1454                 host="testhost",
1455                 port="testport",
1456                 user="testuser",
1457                 password="testpassword",
1458             )
1459             self.assertTrue(ret)
1460             ret = postgres.has_privileges(
1461                 "baruwa",
1462                 "awl",
1463                 "table",
1464                 "ALL",
1465                 grant_option=False,
1466                 maintenance_db="db_name",
1467                 runas="user",
1468                 host="testhost",
1469                 port="testport",
1470                 user="testuser",
1471                 password="testpassword",
1472             )
1473             self.assertTrue(ret)
1474             ret = postgres.has_privileges(
1475                 "bayestest",
1476                 "awl",
1477                 "table",
1478                 "SELECT,INSERT,TRUNCATE",
1479                 maintenance_db="db_name",
1480                 runas="user",
1481                 host="testhost",
1482                 port="testport",
1483                 user="testuser",
1484                 password="testpassword",
1485             )
1486             self.assertFalse(ret)
1487             ret = postgres.has_privileges(
1488                 "bayestest",
1489                 "awl",
1490                 "table",
1491                 "SELECT,INSERT",
1492                 maintenance_db="db_name",
1493                 runas="user",
1494                 host="testhost",
1495                 port="testport",
1496                 user="testuser",
1497                 password="testpassword",
1498             )
1499             self.assertTrue(ret)
1500     def test_has_privileges_on_group(self):
1501         with patch(
1502             "salt.modules.postgres._run_psql",
1503             Mock(return_value={"retcode": 0, "stdout": test_privileges_list_group_csv}),
1504         ):
1505             ret = postgres.has_privileges(
1506                 "baruwa",
1507                 "admin",
1508                 "group",
1509                 maintenance_db="db_name",
1510                 runas="user",
1511                 host="testhost",
1512                 port="testport",
1513                 user="testuser",
1514                 password="testpassword",
1515             )
1516             self.assertTrue(ret)
1517             ret = postgres.has_privileges(
1518                 "baruwa",
1519                 "admin",
1520                 "group",
1521                 grant_option=True,
1522                 maintenance_db="db_name",
1523                 runas="user",
1524                 host="testhost",
1525                 port="testport",
1526                 user="testuser",
1527                 password="testpassword",
1528             )
1529             self.assertFalse(ret)
1530             ret = postgres.has_privileges(
1531                 "tony",
1532                 "admin",
1533                 "group",
1534                 maintenance_db="db_name",
1535                 runas="user",
1536                 host="testhost",
1537                 port="testport",
1538                 user="testuser",
1539                 password="testpassword",
1540             )
1541             self.assertFalse(ret)
1542     def test_privileges_grant_table(self):
1543         with patch(
1544             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1545         ):
1546             with patch(
1547                 "salt.modules.postgres.has_privileges", Mock(return_value=False)
1548             ):
1549                 ret = postgres.privileges_grant(
1550                     "baruwa",
1551                     "awl",
1552                     "table",
1553                     "ALL",
1554                     grant_option=True,
1555                     maintenance_db="db_name",
1556                     runas="user",
1557                     host="testhost",
1558                     port="testport",
1559                     user="testuser",
1560                     password="testpassword",
1561                 )
1562                 query = 'GRANT ALL ON TABLE public."awl" TO "baruwa" WITH GRANT OPTION'
1563                 postgres._run_psql.assert_called_once_with(
1564                     [
1565                         "/usr/bin/pgsql",
1566                         "--no-align",
1567                         "--no-readline",
1568                         "--no-psqlrc",
1569                         "--no-password",
1570                         "--username",
1571                         "testuser",
1572                         "--host",
1573                         "testhost",
1574                         "--port",
1575                         "testport",
1576                         "--dbname",
1577                         "db_name",
1578                         "-c",
1579                         query,
1580                     ],
1581                     host="testhost",
1582                     port="testport",
1583                     password="testpassword",
1584                     user="testuser",
1585                     runas="user",
1586                 )
1587         with patch(
1588             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1589         ):
1590             with patch(
1591                 "salt.modules.postgres.has_privileges", Mock(return_value=False)
1592             ):
1593                 ret = postgres.privileges_grant(
1594                     "baruwa",
1595                     "awl",
1596                     "table",
1597                     "ALL",
1598                     maintenance_db="db_name",
1599                     runas="user",
1600                     host="testhost",
1601                     port="testport",
1602                     user="testuser",
1603                     password="testpassword",
1604                 )
1605                 query = 'GRANT ALL ON TABLE public."awl" TO "baruwa"'
1606                 postgres._run_psql.assert_called_once_with(
1607                     [
1608                         "/usr/bin/pgsql",
1609                         "--no-align",
1610                         "--no-readline",
1611                         "--no-psqlrc",
1612                         "--no-password",
1613                         "--username",
1614                         "testuser",
1615                         "--host",
1616                         "testhost",
1617                         "--port",
1618                         "testport",
1619                         "--dbname",
1620                         "db_name",
1621                         "-c",
1622                         query,
1623                     ],
1624                     host="testhost",
1625                     port="testport",
1626                     password="testpassword",
1627                     user="testuser",
1628                     runas="user",
1629                 )
1630         with patch(
1631             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1632         ):
1633             with patch(
1634                 "salt.modules.postgres.has_privileges", Mock(return_value=False)
1635             ):
1636                 ret = postgres.privileges_grant(
1637                     "baruwa",
1638                     "ALL",
1639                     "table",
1640                     "SELECT",
1641                     maintenance_db="db_name",
1642                     runas="user",
1643                     host="testhost",
1644                     port="testport",
1645                     user="testuser",
1646                     password="testpassword",
1647                 )
1648                 query = 'GRANT SELECT ON ALL TABLES IN SCHEMA public TO "baruwa"'
1649                 postgres._run_psql.assert_called_once_with(
1650                     [
1651                         "/usr/bin/pgsql",
1652                         "--no-align",
1653                         "--no-readline",
1654                         "--no-psqlrc",
1655                         "--no-password",
1656                         "--username",
1657                         "testuser",
1658                         "--host",
1659                         "testhost",
1660                         "--port",
1661                         "testport",
1662                         "--dbname",
1663                         "db_name",
1664                         "-c",
1665                         query,
1666                     ],
1667                     host="testhost",
1668                     port="testport",
1669                     password="testpassword",
1670                     user="testuser",
1671                     runas="user",
1672                 )
1673     def test_privileges_grant_group(self):
1674         with patch(
1675             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1676         ):
1677             with patch(
1678                 "salt.modules.postgres.has_privileges", Mock(return_value=False)
1679             ):
1680                 ret = postgres.privileges_grant(
1681                     "baruwa",
1682                     "admins",
1683                     "group",
1684                     grant_option=True,
1685                     maintenance_db="db_name",
1686                     runas="user",
1687                     host="testhost",
1688                     port="testport",
1689                     user="testuser",
1690                     password="testpassword",
1691                 )
1692                 query = 'GRANT admins TO "baruwa" WITH ADMIN OPTION'
1693                 postgres._run_psql.assert_called_once_with(
1694                     [
1695                         "/usr/bin/pgsql",
1696                         "--no-align",
1697                         "--no-readline",
1698                         "--no-psqlrc",
1699                         "--no-password",
1700                         "--username",
1701                         "testuser",
1702                         "--host",
1703                         "testhost",
1704                         "--port",
1705                         "testport",
1706                         "--dbname",
1707                         "db_name",
1708                         "-c",
1709                         query,
1710                     ],
1711                     host="testhost",
1712                     port="testport",
1713                     password="testpassword",
1714                     user="testuser",
1715                     runas="user",
1716                 )
1717         with patch(
1718             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1719         ):
1720             with patch(
1721                 "salt.modules.postgres.has_privileges", Mock(return_value=False)
1722             ):
1723                 ret = postgres.privileges_grant(
1724                     "baruwa",
1725                     "admins",
1726                     "group",
1727                     maintenance_db="db_name",
1728                     runas="user",
1729                     host="testhost",
1730                     port="testport",
1731                     user="testuser",
1732                     password="testpassword",
1733                 )
1734                 query = 'GRANT admins TO "baruwa"'
1735                 postgres._run_psql.assert_called_once_with(
1736                     [
1737                         "/usr/bin/pgsql",
1738                         "--no-align",
1739                         "--no-readline",
1740                         "--no-psqlrc",
1741                         "--no-password",
1742                         "--username",
1743                         "testuser",
1744                         "--host",
1745                         "testhost",
1746                         "--port",
1747                         "testport",
1748                         "--dbname",
1749                         "db_name",
1750                         "-c",
1751                         query,
1752                     ],
1753                     host="testhost",
1754                     port="testport",
1755                     password="testpassword",
1756                     user="testuser",
1757                     runas="user",
1758                 )
1759     def test_privileges_revoke_table(self):
1760         with patch(
1761             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1762         ):
1763             with patch("salt.modules.postgres.has_privileges", Mock(return_value=True)):
1764                 ret = postgres.privileges_revoke(
1765                     "baruwa",
1766                     "awl",
1767                     "table",
1768                     "ALL",
1769                     maintenance_db="db_name",
1770                     runas="user",
1771                     host="testhost",
1772                     port="testport",
1773                     user="testuser",
1774                     password="testpassword",
1775                 )
1776                 query = "REVOKE ALL ON TABLE public.awl FROM baruwa"
1777                 postgres._run_psql.assert_called_once_with(
1778                     [
1779                         "/usr/bin/pgsql",
1780                         "--no-align",
1781                         "--no-readline",
1782                         "--no-psqlrc",
1783                         "--no-password",
1784                         "--username",
1785                         "testuser",
1786                         "--host",
1787                         "testhost",
1788                         "--port",
1789                         "testport",
1790                         "--dbname",
1791                         "db_name",
1792                         "-c",
1793                         query,
1794                     ],
1795                     host="testhost",
1796                     port="testport",
1797                     password="testpassword",
1798                     user="testuser",
1799                     runas="user",
1800                 )
1801     def test_privileges_revoke_group(self):
1802         with patch(
1803             "salt.modules.postgres._run_psql", Mock(return_value={"retcode": 0})
1804         ):
1805             with patch("salt.modules.postgres.has_privileges", Mock(return_value=True)):
1806                 ret = postgres.privileges_revoke(
1807                     "baruwa",
1808                     "admins",
1809                     "group",
1810                     maintenance_db="db_name",
1811                     runas="user",
1812                     host="testhost",
1813                     port="testport",
1814                     user="testuser",
1815                     password="testpassword",
1816                 )
1817                 query = "REVOKE admins FROM baruwa"
1818                 postgres._run_psql.assert_called_once_with(
1819                     [
1820                         "/usr/bin/pgsql",
1821                         "--no-align",
1822                         "--no-readline",
1823                         "--no-psqlrc",
1824                         "--no-password",
1825                         "--username",
1826                         "testuser",
1827                         "--host",
1828                         "testhost",
1829                         "--port",
1830                         "testport",
1831                         "--dbname",
1832                         "db_name",
1833                         "-c",
1834                         query,
1835                     ],
1836                     host="testhost",
1837                     port="testport",
1838                     password="testpassword",
1839                     user="testuser",
1840                     runas="user",
1841                 )
1842     def test_datadir_init(self):
1843         with patch(
1844             "salt.modules.postgres._run_initdb", Mock(return_value={"retcode": 0})
1845         ):
1846             with patch(
1847                 "salt.modules.postgres.datadir_exists", Mock(return_value=False)
1848             ):
1849                 name = "/var/lib/pgsql/data"
1850                 ret = postgres.datadir_init(
1851                     name, user="postgres", password="test", runas="postgres"
1852                 )
1853                 postgres._run_initdb.assert_called_once_with(
1854                     name,
1855                     auth="password",
1856                     encoding="UTF8",
1857                     locale=None,
1858                     password="test",
1859                     runas="postgres",
1860                     checksums=False,
1861                     waldir=None,
1862                     user="postgres",
1863                 )
1864                 self.assertTrue(ret)
1865     def test_datadir_exists(self):
1866         with patch("os.path.isfile", Mock(return_value=True)):
1867             name = "/var/lib/pgsql/data"
1868             ret = postgres.datadir_exists(name)
1869             self.assertTrue(ret)
1870     def test_pg_is_older_ext_ver(self):
1871         self.assertTrue(postgres._pg_is_older_ext_ver("8.5", "9.5"))
1872         self.assertTrue(postgres._pg_is_older_ext_ver("8.5", "8.6"))
1873         self.assertTrue(postgres._pg_is_older_ext_ver("8.5.2", "8.5.3"))
1874         self.assertFalse(postgres._pg_is_older_ext_ver("9.5", "8.5"))
1875         self.assertTrue(postgres._pg_is_older_ext_ver("9.5", "9.6"))
1876         self.assertTrue(postgres._pg_is_older_ext_ver("9.5.0", "9.5.1"))
1877         self.assertTrue(postgres._pg_is_older_ext_ver("9.5", "9.5.1"))
1878         self.assertFalse(postgres._pg_is_older_ext_ver("9.5.1", "9.5"))
1879         self.assertFalse(postgres._pg_is_older_ext_ver("9.5b", "9.5a"))
1880         self.assertTrue(postgres._pg_is_older_ext_ver("10a", "10b"))
1881         self.assertTrue(postgres._pg_is_older_ext_ver("1.2.3.4", "1.2.3.5"))
1882         self.assertTrue(postgres._pg_is_older_ext_ver("10dev", "10next"))
1883         self.assertFalse(postgres._pg_is_older_ext_ver("10next", "10dev"))
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>bigip.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import salt.utils.json
2 def __virtual__():
3     if "bigip.list_transaction" in __salt__:
4         return "bigip"
5     return (False, "bigip module could not be loaded")
6 def _load_result(response, ret):
7     if response["code"] is None:
8         ret["comment"] = response["content"]
9     elif response["code"] == 401:
10         ret["comment"] = "401 Forbidden: Authentication required!"
11     elif response["code"] == 404:
12         ret["comment"] = response["content"]["message"]
13     elif response["code"] == 200:
14         ret["result"] = True
15         ret["comment"] = (
16             "Listing Current Configuration Only.  "
17             "Not action or changes occurred during the execution of this state."
18         )
19         ret["changes"] = response["content"]
20     else:
21         ret["comment"] = response["content"]["message"]
22     return ret
23 def _strip_key(dictionary, keyword):
24     for key, value in dictionary.items():
25         if key == keyword:
26             dictionary[key] = None
27         elif isinstance(value, dict):
28             _strip_key(value, keyword)
29         elif isinstance(value, list):
30             for item in value:
31                 if isinstance(item, dict):
32                     _strip_key(item, keyword)
33     return dictionary
34 def _check_for_changes(entity_type, ret, existing, modified):
35     ret["result"] = True
36     if isinstance(existing, dict) and isinstance(modified, dict):
37         if "generation" in modified["content"].keys():
38             del modified["content"]["generation"]
39         if "generation" in existing["content"].keys():
40             del existing["content"]["generation"]
41         if modified["content"] == existing["content"]:
42             ret["comment"] = (
43                 "{entity_type} is currently enforced to the desired state.  No changes"
44                 " made.".format(entity_type=entity_type)
45             )
46         else:
47             ret["comment"] = (
48                 "{entity_type} was enforced to the desired state.  Note: Only"
49                 " parameters specified were enforced. See changes for details.".format(
50                     entity_type=entity_type
51                 )
52             )
53             ret["changes"]["old"] = existing["content"]
54             ret["changes"]["new"] = modified["content"]
55     else:
56         if modified == existing:
57             ret["comment"] = (
58                 "{entity_type} is currently enforced to the desired state.  No changes"
59                 " made.".format(entity_type=entity_type)
60             )
61         else:
62             ret["comment"] = (
63                 "{entity_type} was enforced to the desired state.  Note: Only"
64                 " parameters specified were enforced. See changes for details.".format(
65                     entity_type=entity_type
66                 )
67             )
68             ret["changes"]["old"] = existing
69             ret["changes"]["new"] = modified
70     return ret
71 def _test_output(ret, action, params):
72     if action == "list":
73         ret[
74             "comment"
75         ] += "The list action will just list an entity and will make no changes.\n"
76     elif action == "create" or action == "add":
77         ret["comment"] += (
78             "The create action will attempt to create an entity if it does not already"
79             " exist.\n"
80         )
81     elif action == "delete":
82         ret["comment"] += (
83             "The delete action will attempt to delete an existing entity if it"
84             " exists.\n"
85         )
86     elif action == "manage":
87         ret["comment"] += (
88             "The manage action will create a new entity if it does not exist.  If it"
89             " does exist, it will be enforcedto the desired state.\n"
90         )
91     elif action == "modify":
92         ret["comment"] += (
93             "The modify action will attempt to modify an existing entity only if it"
94             " exists.\n"
95         )
96     ret["comment"] += "An iControl REST Request will be made using the parameters:\n"
97     ret["comment"] += salt.utils.json.dumps(params, indent=4)
98     ret["changes"] = {}
99     ret["result"] = None
100     return ret
101 def list_node(hostname, username, password, name):
102     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
103     if __opts__["test"]:
104         return _test_output(
105             ret,
106             "list",
107             params={
108                 "hostname": hostname,
109                 "username": username,
110                 "password": password,
111                 "name": name,
112             },
113         )
114     response = __salt__["bigip.list_node"](hostname, username, password, name)
115     return _load_result(response, ret)
116 def create_node(hostname, username, password, name, address):
117     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
118     if __opts__["test"]:
119         return _test_output(
120             ret,
121             "create",
122             params={
123                 "hostname": hostname,
124                 "username": username,
125                 "password": password,
126                 "name": name,
127                 "address": address,
128             },
129         )
130     existing = __salt__["bigip.list_node"](hostname, username, password, name)
131     if existing["code"] == 200:
132         ret["result"] = True
133         ret["comment"] = "A node by this name currently exists.  No change made."
134     elif existing["code"] == 404:
135         response = __salt__["bigip.create_node"](
136             hostname, username, password, name, address
137         )
138         ret["result"] = True
139         ret["changes"]["old"] = {}
140         ret["changes"]["new"] = response["content"]
141         ret["comment"] = "Node was successfully created."
142     else:
143         ret = _load_result(existing, ret)
144     return ret
145 def manage_node(
146     hostname,
147     username,
148     password,
149     name,
150     address,
151     connection_limit=None,
152     description=None,
153     dynamic_ratio=None,
154     logging=None,
155     monitor=None,
156     rate_limit=None,
157     ratio=None,
158     session=None,
159     node_state=None,
160 ):
161     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
162     if __opts__["test"]:
163         return _test_output(
164             ret,
165             "manage",
166             params={
167                 "hostname": hostname,
168                 "username": username,
169                 "password": password,
170                 "name": name,
171                 "address": address,
172                 "connection_limit": connection_limit,
173                 "description": description,
174                 "dynamic_ratio": dynamic_ratio,
175                 "logging": logging,
176                 "monitor": monitor,
177                 "rate_limit": rate_limit,
178                 "ratio": ratio,
179                 "session": session,
180                 "state:": node_state,
181             },
182         )
183     existing = __salt__["bigip.list_node"](hostname, username, password, name)
184     if existing["code"] == 200:
185         if existing["content"]["address"] != address:
186             ret["result"] = False
187             ret[
188 <a name="5"></a>                "comment"
189             ] = "A node with this name exists but the address does not match."
190         modified <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= __salt__["bigip.modify_node"](
191             hostname=hostname,
192             username=username,
193             password=password,
194             name=name,
195             connection_limit=connection_limit,
196             description=description,
197             dynamic_ratio=dynamic_ratio,
198             logging=logging,
199             monitor=monitor,
200             rate_limit=rate_limit,
201             ratio=ratio,
202             session=</b></font>session,
203             state=node_state,
204         )
205         if modified["code"] == 200:
206             ret = _check_for_changes("Node", ret, existing, modified)
207         else:
208             ret = _load_result(modified, ret)
209     elif existing["code"] == 404:
210         new = __salt__["bigip.create_node"](hostname, username, password, name, address)
211 <a name="4"></a>        if new["code"] == 200:
212             modified = __salt__<font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["bigip.modify_node"](
213                 hostname=hostname,
214                 username=username,
215                 password=password,
216                 name=name,
217                 connection_limit=connection_limit,
218                 description=description,
219                 dynamic_ratio=dynamic_ratio,
220                 logging=logging,
221                 monitor=monitor,
222                 rate_limit=rate_limit,
223                 ratio=ratio,
224                 session=session,
225                 state=</b></font>node_state,
226             )
227             if modified["code"] == 200:
228                 ret["result"] = True
229                 ret["comment"] = (
230                     "Node was created and enforced to the desired state.  Note: Only"
231                     " parameters specified were enforced.  See changes for details."
232                 )
233                 ret["changes"]["old"] = {}
234                 ret["changes"]["new"] = modified["content"]
235             else:
236                 deleted = __salt__["bigip.delete_node"](
237                     hostname, username, password, name
238                 )
239                 if deleted["code"] == 200:
240                     ret["comment"] = (
241                         "Node was successfully created but an error occurred during"
242                         " modification. The creation of the node has been rolled back."
243                         " Message is as follows:\n{message}".format(
244                             message=modified["content"]["message"]
245                         )
246                     )
247                 else:
248                     ret["comment"] = (
249                         "Node was successfully created but an error occurred during"
250                         " modification. The creation of the node was not able to be"
251                         " rolled back. Message is as follows:\n"
252                         " {message}\n{message_two}".format(
253                             message=modified["content"]["message"],
254                             message_two=deleted["content"]["message"],
255                         )
256                     )
257         else:
258             ret = _load_result(new, ret)
259     else:
260         ret = _load_result(existing, ret)
261     return ret
262 def modify_node(
263     hostname,
264     username,
265     password,
266     name,
267     connection_limit=None,
268     description=None,
269     dynamic_ratio=None,
270     logging=None,
271     monitor=None,
272     rate_limit=None,
273     ratio=None,
274     session=None,
275     node_state=None,
276 ):
277     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
278     if __opts__["test"]:
279         return _test_output(
280             ret,
281             "modify",
282             params={
283                 "hostname": hostname,
284                 "username": username,
285                 "password": password,
286                 "name": name,
287                 "connection_limit": connection_limit,
288                 "description": description,
289                 "dynamic_ratio": dynamic_ratio,
290                 "logging": logging,
291                 "monitor": monitor,
292                 "rate_limit": rate_limit,
293                 "ratio": ratio,
294                 "session": session,
295                 "state:": node_state,
296             },
297         )
298     existing = __salt__["bigip.list_node"](hostname, username, password, name)
299     if existing["code"] == 200:
300         modified = __salt__<font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["bigip.modify_node"](
301             hostname=hostname,
302             username=username,
303             password=password,
304             name=name,
305             connection_limit=connection_limit,
306             description=description,
307             dynamic_ratio=dynamic_ratio,
308             logging=logging,
309             monitor=monitor,
310             rate_limit=rate_limit,
311             ratio=</b></font>ratio,
312             session=session,
313             state=node_state,
314         )
315         if modified["code"] == 200:
316             ret = _check_for_changes("Node", ret, existing, modified)
317         else:
318             ret = _load_result(modified, ret)
319     elif existing["code"] == 404:
320         ret["comment"] = "A node with this name was not found."
321     else:
322         ret = _load_result(existing, ret)
323     return ret
324 def delete_node(hostname, username, password, name):
325     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
326     if __opts__["test"]:
327         return _test_output(
328             ret,
329             "delete",
330             params={
331                 "hostname": hostname,
332                 "username": username,
333                 "password": password,
334                 "name": name,
335             },
336         )
337     existing = __salt__["bigip.list_node"](hostname, username, password, name)
338     if existing["code"] == 200:
339         deleted = __salt__["bigip.delete_node"](hostname, username, password, name)
340         if deleted["code"] == 200:
341             ret["result"] = True
342             ret["comment"] = "Node was successfully deleted."
343             ret["changes"]["old"] = existing["content"]
344             ret["changes"]["new"] = {}
345         else:
346             ret = _load_result(existing, ret)
347     elif existing["code"] == 404:
348         ret["result"] = True
349         ret["comment"] = "This node already does not exist. No changes made."
350         ret["changes"]["old"] = {}
351         ret["changes"]["new"] = {}
352     else:
353         ret = _load_result(existing, ret)
354     return ret
355 def list_pool(hostname, username, password, name):
356     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
357     if __opts__["test"]:
358         return _test_output(
359             ret,
360             "list",
361             params={
362                 "hostname": hostname,
363                 "username": username,
364                 "password": password,
365                 "name": name,
366             },
367         )
368     response = __salt__["bigip.list_pool"](hostname, username, password, name)
369     return _load_result(response, ret)
370 def create_pool(
371     hostname,
372     username,
373     password,
374     name,
375     members=None,
376     allow_nat=None,
377     allow_snat=None,
378     description=None,
379     gateway_failsafe_device=None,
380     ignore_persisted_weight=None,
381     ip_tos_to_client=None,
382     ip_tos_to_server=None,
383     link_qos_to_client=None,
384     link_qos_to_server=None,
385     load_balancing_mode=None,
386     min_active_members=None,
387     min_up_members=None,
388     min_up_members_action=None,
389     min_up_members_checking=None,
390     monitor=None,
391     profiles=None,
392     queue_depth_limit=None,
393     queue_on_connection_limit=None,
394     queue_time_limit=None,
395     reselect_tries=None,
396     service_down_action=None,
397     slow_ramp_time=None,
398 ):
399     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
400     if __opts__["test"]:
401         return _test_output(
402             ret,
403             "create",
404             params={
405                 "hostname": hostname,
406                 "username": username,
407                 "password": password,
408                 "name": name,
409                 "members": members,
410                 "allow_nat": allow_nat,
411                 "allow_snat": allow_snat,
412                 "description": description,
413                 "gateway_failsafe_device": gateway_failsafe_device,
414                 "ignore_persisted_weight": ignore_persisted_weight,
415                 "ip_tos_client:": ip_tos_to_client,
416                 "ip_tos_server": ip_tos_to_server,
417                 "link_qos_to_client": link_qos_to_client,
418                 "link_qos_to_server": link_qos_to_server,
419                 "load_balancing_mode": load_balancing_mode,
420                 "min_active_members": min_active_members,
421                 "min_up_members": min_up_members,
422                 "min_up_members_checking": min_up_members_checking,
423                 "monitor": monitor,
424                 "profiles": profiles,
425                 "queue_depth_limit": queue_depth_limit,
426                 "queue_on_connection_limit": queue_on_connection_limit,
427                 "queue_time_limit": queue_time_limit,
428                 "reselect_tries": reselect_tries,
429                 "service_down_action": service_down_action,
430                 "slow_ramp_time": slow_ramp_time,
431             },
432         )
433     existing = __salt__["bigip.list_pool"](hostname, username, password, name)
434     if existing["code"] == 200:
435         ret["result"] = True
436         ret["comment"] = "A pool by this name currently exists.  No change made."
437     elif existing["code"] == 404:
438         response <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= __salt__["bigip.create_pool"](
439             hostname=hostname,
440             username=username,
441             password=password,
442             name=name,
443             members=members,
444             allow_nat=allow_nat,
445             allow_snat=allow_snat,
446             description=description,
447             gateway_failsafe_device=gateway_failsafe_device,
448             ignore_persisted_weight=ignore_persisted_weight,
449             ip_tos_to_client=ip_tos_to_client,
450             ip_tos_to_server=ip_tos_to_server,
451             link_qos_to_client=link_qos_to_client,
452             link_qos_to_server=link_qos_to_server,
453             load_balancing_mode=load_balancing_mode,
454             min_active_members=</b></font>min_active_members,
455             min_up_members=min_up_members,
456             min_up_members_action=min_up_members_action,
457             min_up_members_checking=min_up_members_checking,
458             monitor=monitor,
459             profiles=profiles,
460             queue_depth_limit=queue_depth_limit,
461             queue_on_connection_limit=queue_on_connection_limit,
462             queue_time_limit=queue_time_limit,
463             reselect_tries=reselect_tries,
464             service_down_action=service_down_action,
465             slow_ramp_time=slow_ramp_time,
466         )
467         if response["code"] == 200:
468             ret["result"] = True
469             ret["changes"]["old"] = {}
470             ret["changes"]["new"] = response["content"]
471             ret["comment"] = "Pool was successfully created."
472         else:
473             ret = _load_result(existing, ret)
474     else:
475         ret = _load_result(existing, ret)
476     return ret
477 def manage_pool(
478     hostname,
479     username,
480     password,
481     name,
482     allow_nat=None,
483     allow_snat=None,
484     description=None,
485     gateway_failsafe_device=None,
486     ignore_persisted_weight=None,
487     ip_tos_to_client=None,
488     ip_tos_to_server=None,
489     link_qos_to_client=None,
490     link_qos_to_server=None,
491     load_balancing_mode=None,
492     min_active_members=None,
493     min_up_members=None,
494     min_up_members_action=None,
495     min_up_members_checking=None,
496     monitor=None,
497     profiles=None,
498     queue_depth_limit=None,
499     queue_on_connection_limit=None,
500     queue_time_limit=None,
501     reselect_tries=None,
502     service_down_action=None,
503     slow_ramp_time=None,
504 ):
505     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
506     if __opts__["test"]:
507         return _test_output(
508             ret,
509             "manage",
510             params={
511                 "hostname": hostname,
512                 "username": username,
513                 "password": password,
514                 "name": name,
515                 "allow_nat": allow_nat,
516                 "allow_snat": allow_snat,
517                 "description": description,
518                 "gateway_failsafe_device": gateway_failsafe_device,
519                 "ignore_persisted_weight": ignore_persisted_weight,
520                 "ip_tos_client:": ip_tos_to_client,
521                 "ip_tos_server": ip_tos_to_server,
522                 "link_qos_to_client": link_qos_to_client,
523                 "link_qos_to_server": link_qos_to_server,
524                 "load_balancing_mode": load_balancing_mode,
525                 "min_active_members": min_active_members,
526                 "min_up_members": min_up_members,
527                 "min_up_members_checking": min_up_members_checking,
528                 "monitor": monitor,
529                 "profiles": profiles,
530                 "queue_depth_limit": queue_depth_limit,
531                 "queue_on_connection_limit": queue_on_connection_limit,
532                 "queue_time_limit": queue_time_limit,
533                 "reselect_tries": reselect_tries,
534                 "service_down_action": service_down_action,
535                 "slow_ramp_time": slow_ramp_time,
536             },
537         )
538     existing = __salt__["bigip.list_pool"](hostname, username, password, name)
539     if existing["code"] == 200:
540         modified = __salt__<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["bigip.modify_pool"](
541             hostname=hostname,
542             username=username,
543             password=password,
544             name=name,
545             allow_nat=allow_nat,
546             allow_snat=allow_snat,
547             description=description,
548             gateway_failsafe_device=gateway_failsafe_device,
549             ignore_persisted_weight=ignore_persisted_weight,
550             ip_tos_to_client=ip_tos_to_client,
551             ip_tos_to_server=ip_tos_to_server,
552             link_qos_to_client=link_qos_to_client,
553             link_qos_to_server=link_qos_to_server,
554             load_balancing_mode=load_balancing_mode,
555             min_active_members=</b></font>min_active_members,
556             min_up_members=min_up_members,
557             min_up_members_action=min_up_members_action,
558             min_up_members_checking=min_up_members_checking,
559             monitor=monitor,
560             profiles=profiles,
561             queue_depth_limit=queue_depth_limit,
562             queue_on_connection_limit=queue_on_connection_limit,
563             queue_time_limit=queue_time_limit,
564             reselect_tries=reselect_tries,
565             service_down_action=service_down_action,
566             slow_ramp_time=slow_ramp_time,
567         )
568         if modified["code"] == 200:
569             del existing["content"]["membersReference"]
570             del modified["content"]["membersReference"]
571             del existing["content"]["selfLink"]
572             del modified["content"]["selfLink"]
573             ret = _check_for_changes("Pool", ret, existing, modified)
574         else:
575             ret = _load_result(modified, ret)
576     elif existing["code"] == 404:
577         new = __salt__<font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["bigip.create_pool"](
578             hostname=hostname,
579             username=username,
580             password=password,
581             name=name,
582             allow_nat=allow_nat,
583             allow_snat=allow_snat,
584             description=description,
585             gateway_failsafe_device=gateway_failsafe_device,
586             ignore_persisted_weight=ignore_persisted_weight,
587             ip_tos_to_client=ip_tos_to_client,
588             ip_tos_to_server=ip_tos_to_server,
589             link_qos_to_client=link_qos_to_client,
590             link_qos_to_server=link_qos_to_server,
591             load_balancing_mode=</b></font>load_balancing_mode,
592             min_active_members=min_active_members,
593             min_up_members=min_up_members,
594             min_up_members_action=min_up_members_action,
595             min_up_members_checking=min_up_members_checking,
596             monitor=monitor,
597             profiles=profiles,
598             queue_depth_limit=queue_depth_limit,
599             queue_on_connection_limit=queue_on_connection_limit,
600             queue_time_limit=queue_time_limit,
601             reselect_tries=reselect_tries,
602             service_down_action=service_down_action,
603             slow_ramp_time=slow_ramp_time,
604         )
605         if new["code"] == 200:
606             ret["result"] = True
607             ret["comment"] = (
608                 "Pool was created and enforced to the desired state.  Note: Only"
609                 " parameters specified were enforced.  See changes for details."
610             )
611             ret["changes"]["old"] = {}
612             ret["changes"]["new"] = new["content"]
613         else:
614             ret = _load_result(new, ret)
615     else:
616         ret = _load_result(existing, ret)
617     return ret
618 def modify_pool(
619     hostname,
620     username,
621     password,
622     name,
623     allow_nat=None,
624     allow_snat=None,
625     description=None,
626     gateway_failsafe_device=None,
627     ignore_persisted_weight=None,
628     ip_tos_to_client=None,
629     ip_tos_to_server=None,
630     link_qos_to_client=None,
631     link_qos_to_server=None,
632     load_balancing_mode=None,
633     min_active_members=None,
634     min_up_members=None,
635     min_up_members_action=None,
636     min_up_members_checking=None,
637     monitor=None,
638     profiles=None,
639     queue_depth_limit=None,
640     queue_on_connection_limit=None,
641     queue_time_limit=None,
642     reselect_tries=None,
643     service_down_action=None,
644     slow_ramp_time=None,
645 ):
646     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
647     if __opts__["test"]:
648         return _test_output(
649             ret,
650             "modify",
651             params={
652                 "hostname": hostname,
653                 "username": username,
654                 "password": password,
655                 "name": name,
656                 "allow_nat": allow_nat,
657                 "allow_snat": allow_snat,
658                 "description": description,
659                 "gateway_failsafe_device": gateway_failsafe_device,
660                 "ignore_persisted_weight": ignore_persisted_weight,
661                 "ip_tos_client:": ip_tos_to_client,
662                 "ip_tos_server": ip_tos_to_server,
663                 "link_qos_to_client": link_qos_to_client,
664                 "link_qos_to_server": link_qos_to_server,
665                 "load_balancing_mode": load_balancing_mode,
666                 "min_active_members": min_active_members,
667                 "min_up_members": min_up_members,
668                 "min_up_members_checking": min_up_members_checking,
669                 "monitor": monitor,
670                 "profiles": profiles,
671                 "queue_depth_limit": queue_depth_limit,
672                 "queue_on_connection_limit": queue_on_connection_limit,
673                 "queue_time_limit": queue_time_limit,
674                 "reselect_tries": reselect_tries,
675                 "service_down_action": service_down_action,
676                 "slow_ramp_time": slow_ramp_time,
677             },
678         )
679     existing = __salt__["bigip.list_pool"](hostname, username, password, name)
680     if existing["code"] == 200:
681         modified = __salt__<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>["bigip.modify_pool"](
682             hostname=hostname,
683             username=username,
684             password=password,
685             name=name,
686             allow_nat=allow_nat,
687             allow_snat=allow_snat,
688             description=description,
689             gateway_failsafe_device=gateway_failsafe_device,
690             ignore_persisted_weight=ignore_persisted_weight,
691             ip_tos_to_client=ip_tos_to_client,
692             ip_tos_to_server=ip_tos_to_server,
693             link_qos_to_client=link_qos_to_client,
694             link_qos_to_server=link_qos_to_server,
695             load_balancing_mode=</b></font>load_balancing_mode,
696             min_active_members=min_active_members,
697             min_up_members=min_up_members,
698             min_up_members_action=min_up_members_action,
699             min_up_members_checking=min_up_members_checking,
700             monitor=monitor,
701             profiles=profiles,
702             queue_depth_limit=queue_depth_limit,
703             queue_on_connection_limit=queue_on_connection_limit,
704             queue_time_limit=queue_time_limit,
705             reselect_tries=reselect_tries,
706             service_down_action=service_down_action,
707             slow_ramp_time=slow_ramp_time,
708         )
709         if modified["code"] == 200:
710             del existing["content"]["membersReference"]
711             del modified["content"]["membersReference"]
712             del existing["content"]["selfLink"]
713             del modified["content"]["selfLink"]
714             ret = _check_for_changes("Pool", ret, existing, modified)
715         else:
716             ret = _load_result(modified, ret)
717     elif existing["code"] == 404:
718         ret["comment"] = "A pool with this name was not found."
719     else:
720         ret = _load_result(existing, ret)
721     return ret
722 def delete_pool(hostname, username, password, name):
723     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
724     if __opts__["test"]:
725         return _test_output(
726             ret,
727             "delete",
728             params={
729                 "hostname": hostname,
730                 "username": username,
731                 "password": password,
732                 "name": name,
733             },
734         )
735     existing = __salt__["bigip.list_pool"](hostname, username, password, name)
736     if existing["code"] == 200:
737         deleted = __salt__["bigip.delete_pool"](hostname, username, password, name)
738         if deleted["code"] == 200:
739             ret["result"] = True
740             ret["comment"] = "Pool was successfully deleted."
741             ret["changes"]["old"] = existing["content"]
742             ret["changes"]["new"] = {}
743         else:
744             ret = _load_result(deleted, ret)
745     elif existing["code"] == 404:
746         ret["result"] = True
747         ret["comment"] = "This pool already does not exist. No changes made."
748         ret["changes"]["old"] = {}
749         ret["changes"]["new"] = {}
750     else:
751         ret = _load_result(existing, ret)
752     return ret
753 def manage_pool_members(hostname, username, password, name, members):
754     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
755     if __opts__["test"]:
756         return _test_output(
757             ret,
758             "manage",
759             params={
760                 "hostname": hostname,
761                 "username": username,
762                 "password": password,
763                 "name": name,
764                 "members": members,
765             },
766         )
767     existing = __salt__["bigip.list_pool"](hostname, username, password, name)
768     if existing["code"] == 200:
769         current_members = existing["content"]["membersReference"]["items"]
770         modified = __salt__["bigip.replace_pool_members"](
771             hostname, username, password, name, members
772         )
773         if modified["code"] == 200:
774             new_listing = __salt__["bigip.list_pool"](
775                 hostname, username, password, name
776             )
777             if new_listing["code"] != 200:
778                 ret = _load_result(new_listing, ret)
779                 ret["comment"] = (
780                     "modification of the pool was successful but an error occurred upon"
781                     " retrieving new listing."
782                 )
783                 return ret
784             new_members = new_listing["content"]["membersReference"]["items"]
785             for current_member in current_members:
786                 del current_member["generation"]
787             for new_member in new_members:
788                 del new_member["generation"]
789             ret = _check_for_changes(
790                 "Pool Membership", ret, current_members, new_members
791             )
792         else:
793             ret = _load_result(modified, ret)
794     elif existing["code"] == 404:
795         ret["comment"] = "A pool with this name was not found."
796     else:
797         ret = _load_result(existing, ret)
798     return ret
799 def add_pool_member(hostname, username, password, name, member):
800     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
801     if __opts__["test"]:
802         return _test_output(
803             ret,
804             "add",
805             params={
806                 "hostname": hostname,
807                 "username": username,
808                 "password": password,
809                 "name": name,
810                 "members": member,
811             },
812         )
813     existing_pool = __salt__["bigip.list_pool"](hostname, username, password, name)
814     if existing_pool["code"] == 200:
815         current_members = existing_pool["content"]["membersReference"]["items"]
816         exists = False
817         for current_member in current_members:
818             if current_member["name"] == member["name"]:
819                 exists = True
820                 break
821         if exists:
822             ret["result"] = True
823             ret[
824                 "comment"
825             ] = "Member: {name} already exists within this pool.  No changes made.".format(
826                 name=member["name"]
827             )
828             ret["changes"]["old"] = {}
829             ret["changes"]["new"] = {}
830         else:
831             new_member = __salt__["bigip.add_pool_member"](
832                 hostname, username, password, name, member
833             )
834             if new_member["code"] == 200:
835                 ret["result"] = True
836                 ret[
837                     "comment"
838                 ] = "Member: {name} has been successfully added to the pool.".format(
839                     name=member["name"]
840                 )
841                 ret["changes"]["old"] = {}
842                 pool_listing = __salt__["bigip.list_pool"](
843                     hostname, username, password, name
844                 )
845                 if pool_listing["code"] != 200:
846                     ret = _load_result(new_member, ret)
847                     return ret
848                 members = pool_listing["content"]["membersReference"]["items"]
849                 for current_member in members:
850                     if current_member["name"] == member["name"]:
851                         added_member = current_member
852                         break
853                 ret["changes"]["new"] = added_member
854             else:
855                 ret = _load_result(new_member, ret)
856     elif existing_pool["code"] == 404:
857         ret["comment"] = "A pool with this name was not found."
858     else:
859         ret = _load_result(existing_pool, ret)
860     return ret
861 def modify_pool_member(
862     hostname,
863     username,
864     password,
865     name,
866     member,
867     connection_limit=None,
868     description=None,
869     dynamic_ratio=None,
870     inherit_profile=None,
871     logging=None,
872     monitor=None,
873     priority_group=None,
874     profiles=None,
875     rate_limit=None,
876     ratio=None,
877     session=None,
878     member_state=None,
879 ):
880     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
881     if __opts__["test"]:
882         return _test_output(
883             ret,
884             "modify",
885             params={
886                 "hostname": hostname,
887                 "username": username,
888                 "password": password,
889                 "name": name,
890                 "members": member,
891             },
892         )
893     existing_pool = __salt__["bigip.list_pool"](hostname, username, password, name)
894     if existing_pool["code"] == 200:
895         current_members = existing_pool["content"]["membersReference"]["items"]
896         exists = False
897         for current_member in current_members:
898             if current_member["name"] == member:
899                 exists = True
900                 existing_member = current_member
901                 break
902         if exists:
903             modified = __salt__["bigip.modify_pool_member"](
904                 hostname=hostname,
905                 username=username,
906                 password=password,
907                 name=name,
908                 member=member,
909                 connection_limit=connection_limit,
910                 description=description,
911                 dynamic_ratio=dynamic_ratio,
912                 inherit_profile=inherit_profile,
913                 logging=logging,
914                 monitor=monitor,
915                 priority_group=priority_group,
916                 profiles=profiles,
917                 rate_limit=rate_limit,
918                 ratio=ratio,
919                 session=session,
920                 state=member_state,
921             )
922             new_pool = __salt__["bigip.list_pool"](hostname, username, password, name)
923             if modified["code"] == 200 and modified["code"] == 200:
924                 new_members = new_pool["content"]["membersReference"]["items"]
925                 for new_member in new_members:
926                     if new_member["name"] == member:
927                         modified_member = new_member
928                         break
929                 old = {"content": existing_member}
930                 new = {"content": modified_member}
931                 ret = _check_for_changes(
932                     "Pool Member: {member}".format(member=member), ret, old, new
933                 )
934             else:
935                 ret = _load_result(modified, ret)
936         else:
937             ret[
938                 "comment"
939             ] = "Member: {name} does not exists within this pool.  No changes made.".format(
940                 name=member["name"]
941             )
942     elif existing_pool["code"] == 404:
943         ret["comment"] = "A pool with this name was not found."
944     else:
945         ret = _load_result(existing_pool, ret)
946     return ret
947 def delete_pool_member(hostname, username, password, name, member):
948     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
949     if __opts__["test"]:
950         return _test_output(
951             ret,
952             "delete",
953             params={
954                 "hostname": hostname,
955                 "username": username,
956                 "password": password,
957                 "name": name,
958                 "members": member,
959             },
960         )
961     existing = __salt__["bigip.list_pool"](hostname, username, password, name)
962     if existing["code"] == 200:
963         current_members = existing["content"]["membersReference"]["items"]
964         exists = False
965         for current_member in current_members:
966             if current_member["name"] == member:
967                 exists = True
968                 existing_member = current_member
969                 break
970         if exists:
971             deleted = __salt__["bigip.delete_pool_member"](
972                 hostname, username, password, name, member
973             )
974             if deleted["code"] == 200:
975                 ret["result"] = True
976                 ret[
977                     "comment"
978                 ] = "Pool Member: {member} was successfully deleted.".format(
979                     member=member
980                 )
981                 ret["changes"]["old"] = existing_member
982                 ret["changes"]["new"] = {}
983         else:
984             ret["result"] = True
985             ret["comment"] = "This pool member already does not exist. No changes made."
986             ret["changes"]["old"] = {}
987             ret["changes"]["new"] = {}
988     else:
989         ret = _load_result(existing, ret)
990     return ret
991 def list_virtual(hostname, username, password, name):
992     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
993     if __opts__["test"]:
994         return _test_output(
995             ret,
996             "list",
997             params={
998                 "hostname": hostname,
999                 "username": username,
1000                 "password": password,
1001                 "name": name,
1002             },
1003         )
1004     response = __salt__["bigip.list_virtual"](hostname, username, password, name)
1005     return _load_result(response, ret)
1006 def create_virtual(
1007     hostname,
1008     username,
1009     password,
1010     name,
1011     destination,
1012     pool=None,
1013     address_status=None,
1014     auto_lasthop=None,
1015     bwc_policy=None,
1016     cmp_enabled=None,
1017     connection_limit=None,
1018     dhcp_relay=None,
1019     description=None,
1020     fallback_persistence=None,
1021     flow_eviction_policy=None,
1022     gtm_score=None,
1023     ip_forward=None,
1024     ip_protocol=None,
1025     internal=None,
1026     twelve_forward=None,
1027     last_hop_pool=None,
1028     mask=None,
1029     mirror=None,
1030     nat64=None,
1031     persist=None,
1032     profiles=None,
1033     policies=None,
1034     rate_class=None,
1035     rate_limit=None,
1036     rate_limit_mode=None,
1037     rate_limit_dst=None,
1038     rate_limit_src=None,
1039     rules=None,
1040     related_rules=None,
1041     reject=None,
1042     source=None,
1043     source_address_translation=None,
1044     source_port=None,
1045     virtual_state=None,
1046     traffic_classes=None,
1047     translate_address=None,
1048     translate_port=None,
1049     vlans=None,
1050 ):
1051     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
1052     if __opts__["test"]:
1053         return _test_output(
1054             ret,
1055             "create",
1056             params={
1057                 "hostname": hostname,
1058                 "username": username,
1059                 "password": password,
1060                 "name": name,
1061                 "destination": destination,
1062                 "pool": pool,
1063                 "address_status": address_status,
1064                 "auto_lasthop": auto_lasthop,
1065                 "bwc_policy": bwc_policy,
1066                 "cmp_enabled": cmp_enabled,
1067                 "connection_limit": connection_limit,
1068                 "dhcp_relay": dhcp_relay,
1069                 "description": description,
1070                 "fallback_persistence": fallback_persistence,
1071                 "flow_eviction_policy": flow_eviction_policy,
1072                 "gtm_score": gtm_score,
1073                 "ip_forward": ip_forward,
1074                 "ip_protocol": ip_protocol,
1075                 "internal": internal,
1076                 "twelve_forward": twelve_forward,
1077                 "last_hop_pool": last_hop_pool,
1078                 "mask": mask,
1079                 "mirror": mirror,
1080                 "nat64": nat64,
1081                 "persist": persist,
1082                 "profiles": profiles,
1083                 "policies": policies,
1084                 "rate_class": rate_class,
1085                 "rate_limit": rate_limit,
1086                 "rate_limit_mode": rate_limit_mode,
1087                 "rate_limit_dst": rate_limit_dst,
1088                 "rate_limit_src": rate_limit_src,
1089                 "rules": rules,
1090                 "related_rules": related_rules,
1091                 "reject": reject,
1092                 "source": source,
1093                 "source_address_translation": source_address_translation,
1094                 "source_port": source_port,
1095                 "virtual_state": virtual_state,
1096                 "traffic_classes": traffic_classes,
1097                 "translate_address": translate_address,
1098                 "translate_port": translate_port,
1099                 "vlans": vlans,
1100             },
1101         )
1102     existing = __salt__["bigip.list_virtual"](hostname, username, password, name)
1103 <a name="7"></a>    if existing["code"] == 200:
1104         ret["result"] = True
1105         ret["comment"] <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "A virtual by this name currently exists.  No change made."
1106     elif existing["code"] == 404:
1107         virtual = __salt__["bigip.create_virtual"](
1108             hostname=hostname,
1109             username=username,
1110             password=password,
1111             name=name,
1112             destination=destination,
1113             description=description,
1114             pool=</b></font>pool,
1115             address_status=address_status,
1116             auto_lasthop=auto_lasthop,
1117             bwc_policy=bwc_policy,
1118             cmp_enabled=cmp_enabled,
1119             connection_limit=connection_limit,
1120             dhcp_relay=dhcp_relay,
1121             fallback_persistence=fallback_persistence,
1122             flow_eviction_policy=flow_eviction_policy,
1123             gtm_score=gtm_score,
1124             ip_forward=ip_forward,
1125             ip_protocol=ip_protocol,
1126             internal=internal,
1127             twelve_forward=twelve_forward,
1128             last_hop_pool=last_hop_pool,
1129             mask=mask,
1130             mirror=mirror,
1131             nat64=nat64,
1132             persist=persist,
1133             profiles=profiles,
1134             policies=policies,
1135             rate_class=rate_class,
1136             rate_limit=rate_limit,
1137             rate_limit_mode=rate_limit_mode,
1138             rate_limit_dst=rate_limit_dst,
1139             rate_limit_src=rate_limit_src,
1140             rules=rules,
1141             related_rules=related_rules,
1142             reject=reject,
1143             source=source,
1144             source_address_translation=source_address_translation,
1145             source_port=source_port,
1146             state=virtual_state,
1147             traffic_classes=traffic_classes,
1148             translate_address=translate_address,
1149             translate_port=translate_port,
1150             vlans=vlans,
1151         )
1152         if virtual["code"] == 200:
1153             ret["result"] = True
1154             ret["changes"]["old"] = {}
1155             ret["changes"]["new"] = virtual["content"]
1156             ret["comment"] = "Virtual was successfully created."
1157         else:
1158             ret = _load_result(existing, ret)
1159     else:
1160         ret = _load_result(existing, ret)
1161     return ret
1162 def manage_virtual(
1163     hostname,
1164     username,
1165     password,
1166     name,
1167     destination,
1168     pool=None,
1169     address_status=None,
1170     auto_lasthop=None,
1171     bwc_policy=None,
1172     cmp_enabled=None,
1173     connection_limit=None,
1174     dhcp_relay=None,
1175     description=None,
1176     fallback_persistence=None,
1177     flow_eviction_policy=None,
1178     gtm_score=None,
1179     ip_forward=None,
1180     ip_protocol=None,
1181     internal=None,
1182     twelve_forward=None,
1183     last_hop_pool=None,
1184     mask=None,
1185     mirror=None,
1186     nat64=None,
1187     persist=None,
1188     profiles=None,
1189     policies=None,
1190     rate_class=None,
1191     rate_limit=None,
1192     rate_limit_mode=None,
1193     rate_limit_dst=None,
1194     rate_limit_src=None,
1195     rules=None,
1196     related_rules=None,
1197     reject=None,
1198     source=None,
1199     source_address_translation=None,
1200     source_port=None,
1201     virtual_state=None,
1202     traffic_classes=None,
1203     translate_address=None,
1204     translate_port=None,
1205     vlans=None,
1206 ):
1207     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
1208     if __opts__["test"]:
1209         return _test_output(
1210             ret,
1211             "manage",
1212             params={
1213                 "hostname": hostname,
1214                 "username": username,
1215                 "password": password,
1216                 "name": name,
1217                 "destination": destination,
1218                 "pool": pool,
1219                 "address_status": address_status,
1220                 "auto_lasthop": auto_lasthop,
1221                 "bwc_policy": bwc_policy,
1222                 "cmp_enabled": cmp_enabled,
1223                 "connection_limit": connection_limit,
1224                 "dhcp_relay": dhcp_relay,
1225                 "description": description,
1226                 "fallback_persistence": fallback_persistence,
1227                 "flow_eviction_policy": flow_eviction_policy,
1228                 "gtm_score": gtm_score,
1229                 "ip_forward": ip_forward,
1230                 "ip_protocol": ip_protocol,
1231                 "internal": internal,
1232                 "twelve_forward": twelve_forward,
1233                 "last_hop_pool": last_hop_pool,
1234                 "mask": mask,
1235                 "mirror": mirror,
1236                 "nat64": nat64,
1237                 "persist": persist,
1238                 "profiles": profiles,
1239                 "policies": policies,
1240                 "rate_class": rate_class,
1241                 "rate_limit": rate_limit,
1242                 "rate_limit_mode": rate_limit_mode,
1243                 "rate_limit_dst": rate_limit_dst,
1244                 "rate_limit_src": rate_limit_src,
1245                 "rules": rules,
1246                 "related_rules": related_rules,
1247                 "reject": reject,
1248                 "source": source,
1249                 "source_address_translation": source_address_translation,
1250                 "source_port": source_port,
1251                 "virtual_state": virtual_state,
1252                 "traffic_classes": traffic_classes,
1253                 "translate_address": translate_address,
1254                 "translate_port": translate_port,
1255                 "vlans": vlans,
1256             },
1257         )
1258     existing = __salt__["bigip.list_virtual"](hostname, username, password, name)
1259     if existing["code"] == 200:
1260         modified = __salt__["bigip.modify_virtual"](
1261             hostname=hostname,
1262             username=username,
1263             password=password,
1264             name=name,
1265             destination=destination,
1266             description=description,
1267             pool=pool,
1268             address_status=address_status,
1269             auto_lasthop=auto_lasthop,
1270             bwc_policy=bwc_policy,
1271             cmp_enabled=cmp_enabled,
1272             connection_limit=connection_limit,
1273             dhcp_relay=dhcp_relay,
1274             fallback_persistence=fallback_persistence,
1275             flow_eviction_policy=flow_eviction_policy,
1276             gtm_score=gtm_score,
1277             ip_forward=ip_forward,
1278             ip_protocol=ip_protocol,
1279             internal=internal,
1280             twelve_forward=twelve_forward,
1281             last_hop_pool=last_hop_pool,
1282             mask=mask,
1283             mirror=mirror,
1284             nat64=nat64,
1285             persist=persist,
1286             profiles=profiles,
1287             policies=policies,
1288             rate_class=rate_class,
1289             rate_limit=rate_limit,
1290             rate_limit_mode=rate_limit_mode,
1291             rate_limit_dst=rate_limit_dst,
1292             rate_limit_src=rate_limit_src,
1293             rules=rules,
1294             related_rules=related_rules,
1295             reject=reject,
1296             source=source,
1297             source_address_translation=source_address_translation,
1298             source_port=source_port,
1299             state=virtual_state,
1300             traffic_classes=traffic_classes,
1301             translate_address=translate_address,
1302             translate_port=translate_port,
1303             vlans=vlans,
1304         )
1305         if modified["code"] == 200:
1306             relisting = __salt__["bigip.list_virtual"](
1307                 hostname, username, password, name
1308             )
1309             if relisting["code"] == 200:
1310                 relisting = _strip_key(relisting, "generation")
1311                 existing = _strip_key(existing, "generation")
1312                 ret = _check_for_changes("Virtual", ret, existing, relisting)
1313             else:
1314                 ret = _load_result(relisting, ret)
1315         else:
1316             ret = _load_result(modified, ret)
1317     elif existing["code"] == 404:
1318         virtual = __salt__["bigip.create_virtual"](
1319             hostname=hostname,
1320             username=username,
1321             password=password,
1322             name=name,
1323             destination=destination,
1324             description=description,
1325             pool=pool,
1326             address_status=address_status,
1327             auto_lasthop=auto_lasthop,
1328             bwc_policy=bwc_policy,
1329             cmp_enabled=cmp_enabled,
1330             connection_limit=connection_limit,
1331             dhcp_relay=dhcp_relay,
1332             fallback_persistence=fallback_persistence,
1333             flow_eviction_policy=flow_eviction_policy,
1334             gtm_score=gtm_score,
1335             ip_forward=ip_forward,
1336             ip_protocol=ip_protocol,
1337             internal=internal,
1338             twelve_forward=twelve_forward,
1339             last_hop_pool=last_hop_pool,
1340             mask=mask,
1341             mirror=mirror,
1342             nat64=nat64,
1343             persist=persist,
1344             profiles=profiles,
1345             policies=policies,
1346             rate_class=rate_class,
1347             rate_limit=rate_limit,
1348             rate_limit_mode=rate_limit_mode,
1349             rate_limit_dst=rate_limit_dst,
1350             rate_limit_src=rate_limit_src,
1351             rules=rules,
1352             related_rules=related_rules,
1353             reject=reject,
1354             source=source,
1355             source_address_translation=source_address_translation,
1356             source_port=source_port,
1357             state=virtual_state,
1358             traffic_classes=traffic_classes,
1359             translate_address=translate_address,
1360             translate_port=translate_port,
1361             vlans=vlans,
1362         )
1363         if virtual["code"] == 200:
1364             ret["result"] = True
1365             ret["changes"]["old"] = {}
1366             ret["changes"]["new"] = virtual["content"]
1367             ret[
1368                 "comment"
1369             ] = "Virtual was successfully created and enforced to the desired state."
1370         else:
1371             ret = _load_result(virtual, ret)
1372     else:
1373         ret = _load_result(existing, ret)
1374     return ret
1375 def modify_virtual(
1376     hostname,
1377     username,
1378     password,
1379     name,
1380     destination,
1381     pool=None,
1382     address_status=None,
1383     auto_lasthop=None,
1384     bwc_policy=None,
1385     cmp_enabled=None,
1386     connection_limit=None,
1387     dhcp_relay=None,
1388     description=None,
1389     fallback_persistence=None,
1390     flow_eviction_policy=None,
1391     gtm_score=None,
1392     ip_forward=None,
1393     ip_protocol=None,
1394     internal=None,
1395     twelve_forward=None,
1396     last_hop_pool=None,
1397     mask=None,
1398     mirror=None,
1399     nat64=None,
1400     persist=None,
1401     profiles=None,
1402     policies=None,
1403     rate_class=None,
1404     rate_limit=None,
1405     rate_limit_mode=None,
1406     rate_limit_dst=None,
1407     rate_limit_src=None,
1408     rules=None,
1409     related_rules=None,
1410     reject=None,
1411     source=None,
1412     source_address_translation=None,
1413     source_port=None,
1414     virtual_state=None,
1415     traffic_classes=None,
1416     translate_address=None,
1417     translate_port=None,
1418     vlans=None,
1419 ):
1420     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
1421     if __opts__["test"]:
1422         return _test_output(
1423             ret,
1424             "modify",
1425             params={
1426                 "hostname": hostname,
1427                 "username": username,
1428                 "password": password,
1429                 "name": name,
1430                 "destination": destination,
1431                 "pool": pool,
1432                 "address_status": address_status,
1433                 "auto_lasthop": auto_lasthop,
1434                 "bwc_policy": bwc_policy,
1435                 "cmp_enabled": cmp_enabled,
1436                 "connection_limit": connection_limit,
1437                 "dhcp_relay": dhcp_relay,
1438                 "description": description,
1439                 "fallback_persistence": fallback_persistence,
1440                 "flow_eviction_policy": flow_eviction_policy,
1441                 "gtm_score": gtm_score,
1442                 "ip_forward": ip_forward,
1443                 "ip_protocol": ip_protocol,
1444                 "internal": internal,
1445                 "twelve_forward": twelve_forward,
1446                 "last_hop_pool": last_hop_pool,
1447                 "mask": mask,
1448                 "mirror": mirror,
1449                 "nat64": nat64,
1450                 "persist": persist,
1451                 "profiles": profiles,
1452                 "policies": policies,
1453                 "rate_class": rate_class,
1454                 "rate_limit": rate_limit,
1455                 "rate_limit_mode": rate_limit_mode,
1456                 "rate_limit_dst": rate_limit_dst,
1457                 "rate_limit_src": rate_limit_src,
1458                 "rules": rules,
1459                 "related_rules": related_rules,
1460                 "reject": reject,
1461                 "source": source,
1462                 "source_address_translation": source_address_translation,
1463                 "source_port": source_port,
1464                 "virtual_state": virtual_state,
1465                 "traffic_classes": traffic_classes,
1466                 "translate_address": translate_address,
1467                 "translate_port": translate_port,
1468                 "vlans": vlans,
1469             },
1470         )
1471     existing = __salt__["bigip.list_virtual"](hostname, username, password, name)
1472     if existing["code"] == 200:
1473         modified = __salt__["bigip.modify_virtual"](
1474             hostname=hostname,
1475             username=username,
1476             password=password,
1477             name=name,
1478             destination=destination,
1479             description=description,
1480             pool=pool,
1481             address_status=address_status,
1482             auto_lasthop=auto_lasthop,
1483             bwc_policy=bwc_policy,
1484             cmp_enabled=cmp_enabled,
1485             connection_limit=connection_limit,
1486             dhcp_relay=dhcp_relay,
1487             fallback_persistence=fallback_persistence,
1488             flow_eviction_policy=flow_eviction_policy,
1489             gtm_score=gtm_score,
1490             ip_forward=ip_forward,
1491             ip_protocol=ip_protocol,
1492             internal=internal,
1493             twelve_forward=twelve_forward,
1494             last_hop_pool=last_hop_pool,
1495             mask=mask,
1496             mirror=mirror,
1497             nat64=nat64,
1498             persist=persist,
1499             profiles=profiles,
1500             policies=policies,
1501             rate_class=rate_class,
1502             rate_limit=rate_limit,
1503             rate_limit_mode=rate_limit_mode,
1504             rate_limit_dst=rate_limit_dst,
1505             rate_limit_src=rate_limit_src,
1506             rules=rules,
1507             related_rules=related_rules,
1508             reject=reject,
1509             source=source,
1510             source_address_translation=source_address_translation,
1511             source_port=source_port,
1512             state=virtual_state,
1513             traffic_classes=traffic_classes,
1514             translate_address=translate_address,
1515             translate_port=translate_port,
1516             vlans=vlans,
1517         )
1518         if modified["code"] == 200:
1519             relisting = __salt__["bigip.list_virtual"](
1520                 hostname, username, password, name
1521             )
1522             if relisting["code"] == 200:
1523                 relisting = _strip_key(relisting, "generation")
1524                 existing = _strip_key(existing, "generation")
1525                 ret = _check_for_changes("Virtual", ret, existing, relisting)
1526             else:
1527                 ret = _load_result(relisting, ret)
1528         else:
1529             ret = _load_result(modified, ret)
1530     elif existing["code"] == 404:
1531         ret["comment"] = "A Virtual with this name was not found."
1532     else:
1533         ret = _load_result(existing, ret)
1534     return ret
1535 def delete_virtual(hostname, username, password, name):
1536     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
1537     if __opts__["test"]:
1538         return _test_output(
1539             ret,
1540             "delete",
1541             params={
1542                 "hostname": hostname,
1543                 "username": username,
1544                 "password": password,
1545                 "name": name,
1546             },
1547         )
1548     existing = __salt__["bigip.list_virtual"](hostname, username, password, name)
1549     if existing["code"] == 200:
1550         deleted = __salt__["bigip.delete_virtual"](hostname, username, password, name)
1551         if deleted["code"] == 200:
1552             ret["result"] = True
1553             ret["comment"] = "Virtual was successfully deleted."
1554             ret["changes"]["old"] = existing["content"]
1555             ret["changes"]["new"] = {}
1556         else:
1557             ret = _load_result(deleted, ret)
1558     elif existing["code"] == 404:
1559         ret["result"] = True
1560         ret["comment"] = "This virtual already does not exist. No changes made."
1561         ret["changes"]["old"] = {}
1562         ret["changes"]["new"] = {}
1563     else:
1564         ret = _load_result(existing, ret)
1565     return ret
1566 def list_monitor(hostname, username, password, monitor_type, name):
1567     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
1568     if __opts__["test"]:
1569         return _test_output(
1570             ret,
1571             "list",
1572             params={
1573                 "hostname": hostname,
1574                 "username": username,
1575                 "password": password,
1576                 "monitor_type": monitor_type,
1577                 "name": name,
1578             },
1579         )
1580     response = __salt__["bigip.list_monitor"](
1581         hostname, username, password, monitor_type, name
1582     )
1583     return _load_result(response, ret)
1584 def create_monitor(hostname, username, password, monitor_type, name, **kwargs):
1585     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
1586     if __opts__["test"]:
1587         params = {
1588             "hostname": hostname,
1589             "username": username,
1590             "password": password,
1591             "monitor_type": monitor_type,
1592             "name": name,
1593         }
1594         for key, value in kwargs.items():
1595             params[key] = value
1596         return _test_output(ret, "create", params)
1597     existing = __salt__["bigip.list_monitor"](
1598         hostname, username, password, monitor_type, name
1599     )
1600     if existing["code"] == 200:
1601         ret["result"] = True
1602         ret["comment"] = "A monitor by this name currently exists.  No change made."
1603     elif existing["code"] == 404:
1604         response = __salt__["bigip.create_monitor"](
1605             hostname, username, password, monitor_type, name, **kwargs
1606         )
1607         if response["code"] == 200:
1608             ret["result"] = True
1609             ret["changes"]["old"] = {}
1610             ret["changes"]["new"] = response["content"]
1611             ret["comment"] = "Monitor was successfully created."
1612         else:
1613             ret = _load_result(response, ret)
1614     else:
1615         ret = _load_result(existing, ret)
1616     return ret
1617 def manage_monitor(hostname, username, password, monitor_type, name, **kwargs):
1618     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
1619     if __opts__["test"]:
1620         params = {
1621             "hostname": hostname,
1622             "username": username,
1623             "password": password,
1624             "monitor_type": monitor_type,
1625             "name": name,
1626         }
1627         for key, value in kwargs.items():
1628             params[key] = value
1629         return _test_output(ret, "manage", params)
1630     existing = __salt__["bigip.list_monitor"](
1631         hostname, username, password, monitor_type, name
1632     )
1633     if existing["code"] == 200:
1634         modified = __salt__["bigip.modify_monitor"](
1635             hostname, username, password, monitor_type, name, **kwargs
1636         )
1637         if modified["code"] == 200:
1638             del existing["content"]["selfLink"]
1639             del modified["content"]["selfLink"]
1640             ret = _check_for_changes("Monitor", ret, existing, modified)
1641         else:
1642             ret = _load_result(modified, ret)
1643     elif existing["code"] == 404:
1644         response = __salt__["bigip.create_monitor"](
1645             hostname, username, password, monitor_type, name, **kwargs
1646         )
1647         if response["code"] == 200:
1648             ret["result"] = True
1649             ret["changes"]["old"] = {}
1650             ret["changes"]["new"] = response["content"]
1651             ret["comment"] = "Monitor was successfully created."
1652         else:
1653             ret = _load_result(response, ret)
1654     else:
1655         ret = _load_result(existing, ret)
1656     return ret
1657 def modify_monitor(hostname, username, password, monitor_type, name, **kwargs):
1658     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
1659     if __opts__["test"]:
1660         params = {
1661             "hostname": hostname,
1662             "username": username,
1663             "password": password,
1664             "monitor_type": monitor_type,
1665             "name": name,
1666         }
1667         for key, value in kwargs.items():
1668             params[key] = value
1669         return _test_output(ret, "modify", params)
1670     existing = __salt__["bigip.list_monitor"](
1671         hostname, username, password, monitor_type, name
1672     )
1673     if existing["code"] == 200:
1674         modified = __salt__["bigip.modify_monitor"](
1675             hostname, username, password, monitor_type, name, **kwargs
1676         )
1677         if modified["code"] == 200:
1678             del existing["content"]["selfLink"]
1679             del modified["content"]["selfLink"]
1680             ret = _check_for_changes("Monitor", ret, existing, modified)
1681         else:
1682             ret = _load_result(modified, ret)
1683     elif existing["code"] == 404:
1684         ret["comment"] = "A Monitor with this name was not found."
1685     else:
1686         ret = _load_result(existing, ret)
1687     return ret
1688 def delete_monitor(hostname, username, password, monitor_type, name):
1689     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
1690     if __opts__["test"]:
1691         return _test_output(
1692             ret,
1693             "delete",
1694             params={
1695                 "hostname": hostname,
1696                 "username": username,
1697                 "password": password,
1698                 "monitor_type": monitor_type,
1699                 "name": name,
1700             },
1701         )
1702     existing = __salt__["bigip.list_monitor"](
1703         hostname, username, password, monitor_type, name
1704     )
1705     if existing["code"] == 200:
1706         deleted = __salt__["bigip.delete_monitor"](
1707             hostname, username, password, monitor_type, name
1708         )
1709         if deleted["code"] == 200:
1710             ret["result"] = True
1711             ret["comment"] = "Monitor was successfully deleted."
1712             ret["changes"]["old"] = existing["content"]
1713             ret["changes"]["new"] = {}
1714         else:
1715             ret = _load_result(deleted, ret)
1716     elif existing["code"] == 404:
1717         ret["result"] = True
1718         ret["comment"] = "This Monitor already does not exist. No changes made."
1719         ret["changes"]["old"] = {}
1720         ret["changes"]["new"] = {}
1721     else:
1722         ret = _load_result(existing, ret)
1723     return ret
1724 def list_profile(hostname, username, password, profile_type, name):
1725     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
1726     if __opts__["test"]:
1727         return _test_output(
1728             ret,
1729             "list",
1730             params={
1731                 "hostname": hostname,
1732                 "username": username,
1733                 "password": password,
1734                 "profile_type": profile_type,
1735                 "name": name,
1736             },
1737         )
1738     response = __salt__["bigip.list_profile"](
1739         hostname, username, password, profile_type, name
1740     )
1741     return _load_result(response, ret)
1742 def create_profile(hostname, username, password, profile_type, name, **kwargs):
1743     r"""
1744     A function to connect to a bigip device and create a profile.
1745     hostname
1746         The host/address of the bigip device
1747     username
1748         The iControl REST username
1749     password
1750         The iControl REST password
1751     profile_type
1752         The type of profile to create
1753     name
1754         The name of the profile to create
1755     kwargs
1756         [ arg=val ] ...
1757         Consult F5 BIGIP user guide for specific options for each profile type.
1758         Typically, tmsh arg names are used.
1759     Special Characters ``|``, ``,`` and ``:`` must be escaped using ``\`` when
1760     used within strings.
1761     Create a new profile if a monitor of this type and name does not already exists.  If it does exists, only
1762     the parameters specified will be enforced.
1763     hostname
1764         The host/address of the bigip device
1765     username
1766         The iControl REST username
1767     password
1768         The iControl REST password
1769     profile_type
1770         The type of profile to create
1771     name
1772         The name of the profile to create
1773     kwargs
1774         [ arg=val ] ...
1775         Consult F5 BIGIP user guide for specific options for each profile type.
1776         Typically, tmsh arg names are used.
1777     Modify an existing profile.  If it does exists, only
1778     the parameters specified will be enforced.
1779     hostname
1780         The host/address of the bigip device
1781     username
1782         The iControl REST username
1783     password
1784         The iControl REST password
1785     profile_type
1786         The type of profile to create
1787     name
1788         The name of the profile to create
1789     kwargs
1790         [ arg=val ] ...
1791         Consult F5 BIGIP user guide for specific options for each monitor type.
1792         Typically, tmsh arg names are used.
1793     Modify an existing profile.  If it does exists, only
1794     the parameters specified will be enforced.
1795     hostname
1796         The host/address of the bigip device
1797     username
1798         The iControl REST username
1799     password
1800         The iControl REST password
1801     profile_type
1802         The type of profile to create
1803     name
1804         The name of the profile to create
1805     kwargs
1806         [ arg=val ] ...
1807         Consult F5 BIGIP user guide for specific options for each profile type.
1808         Typically, tmsh arg names are used.
1809     """
1810     ret = {"name": name, "changes": {}, "result": False, "comment": ""}
1811     if __opts__["test"]:
1812         return _test_output(
1813             ret,
1814             "delete",
1815             params={
1816                 "hostname": hostname,
1817                 "username": username,
1818                 "password": password,
1819                 "profile_type": profile_type,
1820                 "name": name,
1821             },
1822         )
1823     existing = __salt__["bigip.list_profile"](
1824         hostname, username, password, profile_type, name
1825     )
1826     if existing["code"] == 200:
1827         deleted = __salt__["bigip.delete_profile"](
1828             hostname, username, password, profile_type, name
1829         )
1830         if deleted["code"] == 200:
1831             ret["result"] = True
1832             ret["comment"] = "Profile was successfully deleted."
1833             ret["changes"]["old"] = existing["content"]
1834             ret["changes"]["new"] = {}
1835         else:
1836             ret = _load_result(deleted, ret)
1837     elif existing["code"] == 404:
1838         ret["result"] = True
1839         ret["comment"] = "This Profile already does not exist. No changes made."
1840         ret["changes"]["old"] = {}
1841         ret["changes"]["new"] = {}
1842     else:
1843         ret = _load_result(existing, ret)
1844     return ret
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
