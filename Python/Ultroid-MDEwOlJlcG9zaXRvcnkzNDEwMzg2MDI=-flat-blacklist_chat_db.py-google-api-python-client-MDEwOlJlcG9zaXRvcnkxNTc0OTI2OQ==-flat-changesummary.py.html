
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 4.014598540145985%, Tokens: 11, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Ultroid-MDEwOlJlcG9zaXRvcnkzNDEwMzg2MDI=-flat-blacklist_chat_db.py</h3>
            <pre><code>1  from .. import udB
<span onclick='openModal()' class='match'>2  def add_black_chat(chat_id):
3      chat = udB.get_key("BLACKLIST_CHATS") or []
4      if chat_id not in chat:
5          chat.append(chat_id)
6          return udB.set_key("BLACKLIST_CHATS", chat)
7  def rem_black_chat(chat_id):
8      chat = udB.get_key("BLACKLIST_CHATS") or []
9      if chat_id in chat:
10          chat.remove(chat_id)
</span>11          return udB.set_key("BLACKLIST_CHATS", chat)
</code></pre>
        </div>
        <div class="column">
            <h3>google-api-python-client-MDEwOlJlcG9zaXRvcnkxNTc0OTI2OQ==-flat-changesummary.py</h3>
            <pre><code>1  from enum import IntEnum
2  import json
3  from multiprocessing import Pool
4  import pathlib
5  import numpy as np
6  import pandas as pd
7  BRANCH_ARTIFACTS_DIR = (
8      pathlib.Path(__file__).parent.resolve()
9      / "googleapiclient"
10      / "discovery_cache"
11      / "documents"
12  )
13  MAIN_ARTIFACTS_DIR = (
14      pathlib.Path(__file__).parent.resolve()
15      / ".."
16      / "main"
17      / "googleapiclient"
18      / "discovery_cache"
19      / "documents"
20  )
21  MULTIPROCESSING_NUM_PER_BATCH = 5
22  MULTIPROCESSING_NUM_AGENTS = 10
23  class ChangeType(IntEnum):
24      UNKNOWN = 0
25      DELETED = 1
26      ADDED = 2
27      CHANGED = 3
28  class DirectoryDoesNotExist(ValueError):
29      pass
30  class ChangeSummary:
31      def __init__(self, new_artifacts_dir, current_artifacts_dir, temp_dir, file_list):
32          self._file_list = file_list
33          self._new_artifacts_dir = pathlib.Path(new_artifacts_dir)
34          self._current_artifacts_dir = pathlib.Path(current_artifacts_dir)
35          self._temp_dir = pathlib.Path(temp_dir)
36          self._raise_if_directory_not_found(self._new_artifacts_dir)
37          self._raise_if_directory_not_found(self._current_artifacts_dir)
38          self._raise_if_directory_not_found(self._temp_dir)
<span onclick='openModal()' class='match'>39      def _raise_if_directory_not_found(self, directory):
40          if not pathlib.Path(directory).exists():
41              raise DirectoryDoesNotExist(
42                  "Directory does not exist : {0}".format(directory)
43              )
44      def _load_json_to_dataframe(self, file_path):
45          dataframe_doc = pd.DataFrame()
46          if pathlib.Path(file_path).is_file():
</span>47              with open(file_path, "r") as f:
48                  dataframe_doc = pd.json_normalize(json.load(f))
49          return dataframe_doc
50      def _get_discovery_differences(self, filename):
51          current_artifact_path = self._current_artifacts_dir / filename
52          new_artifact_path = self._new_artifacts_dir / filename
53          current_doc = self._load_json_to_dataframe(current_artifact_path)
54          new_doc = self._load_json_to_dataframe(new_artifact_path)
55          combined_docs = (
56              pd.concat([current_doc, new_doc], keys=["CurrentValue", "NewValue"])
57              .reset_index(drop=True, level=1)
58              .rename_axis(["Key"], axis=1).transpose()
59              .reset_index()
60          )
61          if "CurrentValue" not in combined_docs.columns:
62              combined_docs["CurrentValue"] = np.nan
63          if "NewValue" not in combined_docs.columns:
64              combined_docs["NewValue"] = np.nan
65          parent_child_df = combined_docs["Key"].str.rsplit(".", n=1, expand=True)
66          if len(parent_child_df.columns) == 1:
67              parent_child_df.columns = ["Parent"]
68          else:
69              parent_child_df.columns = ["Parent", "Child"]
70          combined_docs = combined_docs.join(parent_child_df)
71          combined_docs["Added"] = np.where(
72              combined_docs["CurrentValue"].isnull(), True, False
73          )
74          combined_docs["Deleted"] = np.where(
75              combined_docs["NewValue"].isnull(), True, False
76          )
77          parent_added_agg = (
78              combined_docs.groupby("Parent")
79              .Added.value_counts(normalize=True)
80              .reset_index(name="Proportion")
81          )
82          parent_added_agg["NumLevels"] = (
83              parent_added_agg["Parent"].str.split(".").apply(lambda x: len(x))
84          )
85          parent_deleted_agg = (
86              combined_docs.groupby("Parent")
87              .Deleted.value_counts(normalize=True)
88              .reset_index(name="Proportion")
89          )
90          parent_deleted_agg["NumLevels"] = (
91              parent_added_agg["Parent"].str.split(".").apply(lambda x: len(x))
92          )
93          all_added = (
94              parent_added_agg[
95                  (parent_added_agg["Proportion"] == 1)
96                  & (parent_added_agg["Added"] == True)
97              ][["Parent", "NumLevels"]]
98              .sort_values("NumLevels", ascending=True)
99              .Parent.to_list()
100          )
101          all_deleted = (
102              parent_deleted_agg[
103                  (parent_deleted_agg["Proportion"] == 1)
104                  & (parent_deleted_agg["Deleted"] == True)
105              ][["Parent", "NumLevels"]]
106              .sort_values("NumLevels", ascending=True)
107              .Parent.to_list()
108          )
109          for i in range(0, len(all_added)):
110              word = all_added[i]
111              combined_docs.Parent = np.where(
112                  combined_docs["Parent"].str.startswith(word), word, combined_docs.Parent
113              )
114          for i in range(0, len(all_deleted)):
115              word = all_deleted[i]
116              combined_docs.Parent = np.where(
117                  combined_docs["Parent"].str.startswith(word), word, combined_docs.Parent
118              )
119          docs_diff = combined_docs[
120              combined_docs["CurrentValue"] != combined_docs["NewValue"]
121          ].copy(deep=False)
122          api_version_string = filename.split(".")[:-1]
123          docs_diff["Name"] = api_version_string[0]
124          docs_diff["Version"] = ".".join(api_version_string[1:])
125          deleted_condition = docs_diff["NewValue"].isnull()
126          added_condition = docs_diff["CurrentValue"].isnull()
127          docs_diff["ChangeType"] = np.where(
128              deleted_condition,
129              ChangeType.DELETED,
130              np.where(added_condition, ChangeType.ADDED, ChangeType.CHANGED),
131          )
132          docs_diff = docs_diff[
133              ~docs_diff["Key"].str.contains(
134                  "|".join(self._get_keys_to_ignore()), case=False
135              )
136          ]
137          docs_diff_with_count = (
138              docs_diff.groupby(
139                  ["Parent", "Added", "Deleted", "Name", "Version", "ChangeType"]
140              )
141              .size()
142              .reset_index(name="Count")
143          )
144          docs_diff = docs_diff.merge(docs_diff_with_count)
145          docs_diff.loc[docs_diff["Count"] > 1, "Key"] = docs_diff["Parent"]
146          return docs_diff[
147              ["Key", "Added", "Deleted", "Name", "Version", "ChangeType", "Count"]
148          ].drop_duplicates()
149      def _build_summary_message(self, api_name, is_feature):
150          commit_type = "feat" if is_feature else "fix"
151          return "{0}({1}): update the api".format(commit_type, api_name)
152      def _get_keys_to_ignore(self):
153          keys_to_ignore = [
154              "description",
155              "documentation",
156              "enum",
157              "etag",
158              "revision",
159              "title",
160              "url",
161              "rootUrl",
162          ]
163          return keys_to_ignore
164      def _get_stable_versions(self, versions):
165          return versions.str.extract(r"(v\d?\.?\d?\.?\d+$)").notnull()
166      def _get_summary_and_write_to_disk(self, dataframe, directory):
167          dataframe["IsStable"] = self._get_stable_versions(dataframe["Version"])
168          filter_features = (dataframe["ChangeType"] == ChangeType.DELETED) | (
169              dataframe["ChangeType"] == ChangeType.ADDED
170          )
171          dataframe["IsFeature"] = np.where(filter_features, True, np.nan)
172          dataframe["IsFeatureAggregate"] = dataframe.groupby("Name").IsFeature.transform(
173              lambda x: x.any()
174          )
175          dataframe["Summary"] = np.vectorize(self._build_summary_message)(
176              dataframe["Name"], dataframe["IsFeatureAggregate"]
177          )
178          dataframe.to_csv(directory / "allapis.dataframe")
179          return dataframe
180      def _write_verbose_changes_to_disk(self, dataframe, directory, summary_df):
181          verbose_changes = []
182          dataframe.sort_values(
183              by=["Name", "Version", "ChangeType"], ascending=True, inplace=True
184          )
185          change_type_groups = dataframe[
186              ["Name", "Version", "ChangeType", "Key", "Count"]
187          ].groupby(["Name", "Version", "ChangeType"])
188          lastApi = ""
189          lastVersion = ""
190          lastType = ChangeType.UNKNOWN
191          f = None
192          for name, group in change_type_groups:
193              currentApi = name[0]
194              currentVersion = name[1]
195              currentType = name[2]
196              if lastApi != currentApi:
197                  if f is not None:
198                      f.writelines(verbose_changes)
199                      f.close()
200                      f = None
201                  verbose_changes = []
202                  lastVersion = ""
203                  filename = "{0}.verbose".format(currentApi)
204                  f = open(pathlib.Path(directory / filename), "a")
205                  lastApi = currentApi
206                  current_api_filter = summary_df["Name"] == currentApi
207                  verbose_changes.append(summary_df[current_api_filter].Summary.iloc[0])
208              if lastVersion != currentVersion:
209                  verbose_changes.append(
210                      "\n\n#### {0}:{1}\n\n".format(currentApi, currentVersion)
211                  )
212                  lastVersion = currentVersion
213                  lastType = ChangeType.UNKNOWN
214              if currentType != lastType:
215                  if currentType == ChangeType.DELETED:
216                      verbose_changes.append("\nThe following keys were deleted:\n")
217                  elif currentType == ChangeType.ADDED:
218                      verbose_changes.append("\nThe following keys were added:\n")
219                  else:
220                      verbose_changes.append("\nThe following keys were changed:\n")
221                  lastType = currentType
222                  verbose_changes.extend(
223                      [
224                          "- {0} (Total Keys: {1})\n".format(row["Key"], row["Count"])
225                          for index, row in group[["Key", "Count"]].iterrows()
226                      ]
227                  )
228          if f is not None:
229              f.writelines(verbose_changes)
230              f.close()
231              f = None
232      def detect_discovery_changes(self):
233          result = pd.DataFrame()
234          with Pool(processes=MULTIPROCESSING_NUM_AGENTS) as pool:
235              if len(self._file_list):
236                  result = pd.concat(
237                      pool.map(
238                          self._get_discovery_differences,
239                          self._file_list,
240                          MULTIPROCESSING_NUM_PER_BATCH,
241                      )
242                  )
243          if len(result):
244              sort_columns = ["Name", "Version", "ChangeType", "Key"]
245              result.sort_values(by=sort_columns, ascending=True, inplace=True)
246              pathlib.Path(self._temp_dir).mkdir(exist_ok=True)
247              summary_df = self._get_summary_and_write_to_disk(result, self._temp_dir)
248              self._write_verbose_changes_to_disk(result, self._temp_dir, summary_df)
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Ultroid-MDEwOlJlcG9zaXRvcnkzNDEwMzg2MDI=-flat-blacklist_chat_db.py</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from google-api-python-client-MDEwOlJlcG9zaXRvcnkxNTc0OTI2OQ==-flat-changesummary.py</div>
                </div>
                <div class="column column_space"><pre><code>2  def add_black_chat(chat_id):
3      chat = udB.get_key("BLACKLIST_CHATS") or []
4      if chat_id not in chat:
5          chat.append(chat_id)
6          return udB.set_key("BLACKLIST_CHATS", chat)
7  def rem_black_chat(chat_id):
8      chat = udB.get_key("BLACKLIST_CHATS") or []
9      if chat_id in chat:
10          chat.remove(chat_id)
</pre></code></div>
                <div class="column column_space"><pre><code>39      def _raise_if_directory_not_found(self, directory):
40          if not pathlib.Path(directory).exists():
41              raise DirectoryDoesNotExist(
42                  "Directory does not exist : {0}".format(directory)
43              )
44      def _load_json_to_dataframe(self, file_path):
45          dataframe_doc = pd.DataFrame()
46          if pathlib.Path(file_path).is_file():
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    