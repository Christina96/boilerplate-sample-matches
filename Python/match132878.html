<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_pub_server_channel.py &amp; __init___9.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_pub_server_channel.py &amp; __init___9.py
      </h3>
<h1 align="center">
        2.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_pub_server_channel.py (10.852714%)<th>__init___9.py (1.509434%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(1-19)<td><a href="#" name="0">(4-22)</a><td align="center"><font color="#ff0000">18</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(171-178)<td><a href="#" name="1">(405-481)</a><td align="center"><font color="#c60000">14</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(111-114)<td><a href="#" name="2">(1708-1718)</a><td align="center"><font color="#aa0000">12</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(44-47)<td><a href="#" name="3">(2543-2550)</a><td align="center"><font color="#aa0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_pub_server_channel.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <a name="0"></a><font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import logging
2 import multiprocessing
3 import time
4 from concurrent.futures.thread import ThreadPoolExecutor
5 import pytest
6 import salt.config
7 import salt.exceptions
8 import salt.ext.tornado.gen
9 import salt.ext.tornado.ioloop
10 import salt.log.setup
11 import salt.master
12 import salt.transport.zeromq
13 import salt.utils.platform
14 import salt.utils.process
15 import salt.utils.stringutils
16 import zmq
17 from saltfactories.utils.processes import terminate_process
18 from</b></font> tests.support.mock import MagicMock, patch
19 log = logging.getLogger(__name__)
20 class Collector(salt.utils.process.SignalHandlingProcess):
21     def __init__(self, minion_config, pub_uri, timeout=30, zmq_filtering=False):
22         super().__init__()
23         self.minion_config = minion_config
24         self.pub_uri = pub_uri
25         self.timeout = timeout
26         self.hard_timeout = time.time() + timeout + 30
27         self.manager = multiprocessing.Manager()
28         self.results = self.manager.list()
29         self.zmq_filtering = zmq_filtering
30         self.stopped = multiprocessing.Event()
31         self.started = multiprocessing.Event()
32         self.running = multiprocessing.Event()
33     def run(self):
34         ctx = zmq.Context()
35         sock = ctx<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.socket(zmq.SUB)
36         sock.setsockopt(zmq.LINGER, -1)
37         sock.setsockopt(zmq.SUBSCRIBE, b"")
38         sock.connect(self.</b></font>pub_uri)
39         last_msg = time.time()
40         self.started.set()
41         while True:
42             curr_time = time.time()
43             if time.time() &gt; self.hard_timeout:
44                 break
45             if curr_time - last_msg &gt;= self.timeout:
46                 break
47             try:
48                 payload = sock.recv(zmq.NOBLOCK)
49             except zmq.ZMQError:
50                 time.sleep(0.1)
51             else:
52                 try:
53                     payload = salt.payload.loads(payload)
54                     if "start" in payload:
55                         self.running.set()
56                         continue
57                     if "stop" in payload:
58                         break
59                     last_msg = time.time()
60                     self.results.append(payload["jid"])
61                 except salt.exceptions.SaltDeserializationError:
62                     if not self.zmq_filtering:
63                         log.exception("Failed to deserialize...")
64                         break
65     def __enter__(self):
66         self.manager.__enter__()
67         self.start()
68         self.started.wait()
69         self.started.clear()
70         return self
71     def __exit__(self, *args):
72         join_secs = self.hard_timeout - time.time()
73         log.info("Waiting at most %s seconds before exiting the collector", join_secs)
74         self.join(join_secs)
75         self.terminate()
76         self.results = list(self.results)
77         self.manager.__exit__(*args)
78         log.debug("The collector has exited")
79         self.stopped.set()
80 class PubServerChannelProcess(salt.utils.process.SignalHandlingProcess):
81     def __init__(self, master_config, minion_config, **collector_kwargs):
82         super().__init__()
83         self._closing = False
84         self.master_config = master_config
85         self.minion_config = minion_config
86         self.collector_kwargs = collector_kwargs
87         self.process_manager = salt.utils.process.ProcessManager(
88             name="ZMQ-PubServer-ProcessManager"
89         )
90         self.pub_server_channel = salt.transport.zeromq.PublishServer(
91 <a name="2"></a>            self.master_config
92         )
93         self.pub_server_channel.pre_fork(self.process_manager)
94         self.pub_uri = "tcp://{interface}:{publish_port}"<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.format(**self.master_config)
95         self.queue = multiprocessing.Queue()
96         self.stopped = multiprocessing.Event()
97         self.</b></font>collector = Collector(
98             self.minion_config, self.pub_uri, **self.collector_kwargs
99         )
100     def run(self):
101         try:
102             while True:
103                 payload = self.queue.get()
104                 if payload is None:
105                     log.debug("We received the stop sentinel")
106                     break
107                 self.pub_server_channel.publish(payload)
108         except KeyboardInterrupt:
109             pass
110         finally:
111             self.stopped.set()
112     def _handle_signals(self, signum, sigframe):
113         self.close()
114         super()._handle_signals(signum, sigframe)
115     def close(self):
116         if self._closing:
117             return
118         self._closing = True
119         if self.process_manager is None:
120             return
121         self.process_manager.terminate()
122         self.pub_server_channel.pub_close()
123         for pid in self.process_manager._process_map:
124             terminate_process(pid=pid, kill_children=True, slow_stop=False)
125         self.process_manager = None
126     def publish(self, payload):
127         self.queue.put(payload)
128     def __enter__(self):
129         self.start()
130         self.collector.__enter__()
131         attempts = 30
132         while attempts &gt; 0:
133             self.publish({"tgt_type": "glob", "tgt": "*", "jid": -1, "start": True})
134             if self.collector.running.wait(1) is True:
135                 break
136             attempts -= 1
137         else:
138             pytest.fail("Failed to confirm the collector has started")
139         return self
140     def __exit__(self, *args):
141         self.publish({"tgt_type": "glob", "tgt": "*", "jid": -1, "stop": True})
142 <a name="1"></a>        self.collector.__exit__(*args)
143         self.collector.stopped<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.wait()
144         self.queue.put(None)
145         self.stopped.wait(10)
146         self.close()
147         self.terminate()
148         log.info(</b></font>"The PubServerChannelProcess has terminated")
149 @pytest.mark.skip_on_windows
150 @pytest.mark.slow_test
151 def test_publish_to_pubserv_ipc(salt_master, salt_minion):
152     opts = dict(salt_master.config.copy(), ipc_mode="ipc", pub_hwm=0)
153     with PubServerChannelProcess(opts, salt_minion.config.copy()) as server_channel:
154         send_num = 10000
155         expect = []
156         for idx in range(send_num):
157             expect.append(idx)
158             load = {"tgt_type": "glob", "tgt": "*", "jid": idx}
159             server_channel.publish(load)
160     results = server_channel.collector.results
161     assert len(results) == send_num, "{} != {}, difference: {}".format(
162         len(results), send_num, set(expect).difference(results)
163     )
164 @pytest.mark.skip_on_freebsd
165 @pytest.mark.slow_test
166 def test_issue_36469_tcp(salt_master, salt_minion):
167     def _send_small(server_channel, sid, num=10):
168         for idx in range(num):
169             load = {"tgt_type": "glob", "tgt": "*", "jid": "{}-s{}".format(sid, idx)}
170             server_channel.publish(load)
171     def _send_large(server_channel, sid, num=10, size=250000 * 3):
172         for idx in range(num):
173             load = {
174                 "tgt_type": "glob",
175                 "tgt": "*",
176                 "jid": "{}-l{}".format(sid, idx),
177                 "xdata": "0" * size,
178             }
179             server_channel.publish(load)
180     opts = dict(salt_master.config.copy(), ipc_mode="tcp", pub_hwm=0)
181     send_num = 10 * 4
182     expect = []
183     with PubServerChannelProcess(opts, salt_minion.config.copy()) as server_channel:
184         with ThreadPoolExecutor(max_workers=4) as executor:
185             executor.submit(_send_small, server_channel, 1)
186             executor.submit(_send_large, server_channel, 2)
187             executor.submit(_send_small, server_channel, 3)
188             executor.submit(_send_large, server_channel, 4)
189         expect.extend(["{}-s{}".format(a, b) for a in range(10) for b in (1, 3)])
190         expect.extend(["{}-l{}".format(a, b) for a in range(10) for b in (2, 4)])
191     results = server_channel.collector.results
192     assert len(results) == send_num, "{} != {}, difference: {}".format(
193         len(results), send_num, set(expect).difference(results)
194     )
195 @pytest.mark.skip_on_windows
196 @pytest.mark.slow_test
197 def test_zeromq_filtering(salt_master, salt_minion):
198     opts = dict(
199         salt_master.config.copy(),
200         ipc_mode="ipc",
201         pub_hwm=0,
202         zmq_filtering=True,
203         acceptance_wait_time=5,
204     )
205     send_num = 1
206     expect = []
207     with patch(
208         "salt.utils.minions.CkMinions.check_minions",
209         MagicMock(
210             return_value={
211                 "minions": [salt_minion.id],
212                 "missing": [],
213                 "ssh_minions": False,
214             }
215         ),
216     ):
217         with PubServerChannelProcess(
218             opts, salt_minion.config.copy(), zmq_filtering=True
219         ) as server_channel:
220             expect.append(send_num)
221             load = {"tgt_type": "glob", "tgt": "*", "jid": send_num}
222             server_channel.publish(load)
223         results = server_channel.collector.results
224         assert len(results) == send_num, "{} != {}, difference: {}".format(
225             len(results), send_num, set(expect).difference(results)
226         )
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>__init___9.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <a name="0"></a>"""
2 All salt configuration loading and defaults should be in this module
3 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import codecs
4 import glob
5 import logging
6 import os
7 import re
8 import sys
9 import time
10 import types
11 import urllib.parse
12 from copy import deepcopy
13 import salt.defaults.exitcodes
14 import salt.exceptions
15 import salt.syspaths
16 import salt.utils.data
17 import salt.utils.dictupdate
18 import salt.utils.files
19 import salt.utils.immutabletypes as immutabletypes
20 import</b></font> salt.utils.network
21 import salt.utils.path
22 import salt.utils.platform
23 import salt.utils.stringutils
24 import salt.utils.user
25 import salt.utils.validate.path
26 import salt.utils.xdg
27 import salt.utils.yaml
28 import salt.utils.zeromq
29 try:
30     import psutil
31     if not hasattr(psutil, "virtual_memory"):
32         raise ImportError("Version of psutil too old.")
33     HAS_PSUTIL = True
34 except ImportError:
35     HAS_PSUTIL = False
36 log = logging.getLogger(__name__)
37 _DFLT_LOG_DATEFMT = "%H:%M:%S"
38 _DFLT_LOG_DATEFMT_LOGFILE = "%Y-%m-%d %H:%M:%S"
39 _DFLT_LOG_FMT_CONSOLE = "[%(levelname)-8s] %(message)s"
40 _DFLT_LOG_FMT_LOGFILE = (
41     "%(asctime)s,%(msecs)03d [%(name)-17s:%(lineno)-4d][%(levelname)-8s][%(process)d]"
42     " %(message)s"
43 )
44 _DFLT_LOG_FMT_JID = "[JID: %(jid)s]"
45 _DFLT_REFSPECS = ["+refs/heads/*:refs/remotes/origin/*", "+refs/tags/*:refs/tags/*"]
46 DEFAULT_INTERVAL = 60
47 if salt.utils.platform.is_windows():
48     _DFLT_IPC_MODE = "tcp"
49     _DFLT_FQDNS_GRAINS = False
50     _MASTER_TRIES = -1
51     _MASTER_USER = "SYSTEM"
52 elif salt.utils.platform.is_proxy():
53     _DFLT_IPC_MODE = "ipc"
54     _DFLT_FQDNS_GRAINS = False
55     _MASTER_TRIES = 1
56     _MASTER_USER = salt.utils.user.get_user()
57 else:
58     _DFLT_IPC_MODE = "ipc"
59     _DFLT_FQDNS_GRAINS = True
60     _MASTER_TRIES = 1
61     _MASTER_USER = salt.utils.user.get_user()
62 def _gather_buffer_space():
63     if HAS_PSUTIL and psutil.version_info &gt;= (0, 6, 0):
64         total_mem = psutil.virtual_memory().total
65     else:
66         import platform
67         import salt.grains.core
68         os_data = {"kernel": platform.system()}
69         grains = salt.grains.core._memdata(os_data)
70         total_mem = grains["mem_total"]
71     return max([total_mem * 0.05, 10 &lt;&lt; 20])
72 _DFLT_IPC_WBUFFER = _gather_buffer_space() * 0.5
73 _DFLT_IPC_RBUFFER = _gather_buffer_space() * 0.5
74 VALID_OPTS = immutabletypes.freeze(
75     {
76         "master": (str, list),
77         "master_port": (str, int),
78         "master_type": str,
79         "master_uri_format": str,
80         "source_interface_name": str,
81         "source_address": str,
82         "source_ret_port": (str, int),
83         "source_publish_port": (str, int),
84         "master_finger": str,
85         "master_shuffle": bool,
86         "master_alive_interval": int,
87         "master_failback": bool,
88         "master_failback_interval": int,
89         "master_sign_key_name": str,
90         "master_sign_pubkey": bool,
91         "verify_master_pubkey_sign": bool,
92         "always_verify_signature": bool,
93         "master_pubkey_signature": str,
94         "master_use_pubkey_signature": bool,
95         "master_stats": bool,
96         "master_stats_event_iter": int,
97         "syndic_finger": str,
98         "key_cache": str,
99         "user": str,
100         "root_dir": str,
101         "pki_dir": str,
102         "id": str,
103         "id_function": (dict, str),
104         "cachedir": str,
105         "append_minionid_config_dirs": list,
106         "cache_jobs": bool,
107         "conf_file": str,
108         "sock_dir": str,
109         "sock_pool_size": int,
110         "backup_mode": str,
111         "renderer": str,
112         "renderer_whitelist": list,
113         "renderer_blacklist": list,
114         "failhard": bool,
115         "autoload_dynamic_modules": bool,
116         "saltenv": (type(None), str),
117         "lock_saltenv": bool,
118         "pillarenv": (type(None), str),
119         "pillarenv_from_saltenv": bool,
120         "state_top": str,
121         "state_top_saltenv": (type(None), str),
122         "startup_states": str,
123         "sls_list": list,
124         "snapper_states": bool,
125         "snapper_states_config": str,
126         "top_file": str,
127         "file_client": str,
128         "local": bool,
129         "use_master_when_local": bool,
130         "file_roots": dict,
131         "pillar_roots": dict,
132         "on_demand_ext_pillar": list,
133         "decrypt_pillar": list,
134         "decrypt_pillar_delimiter": str,
135         "decrypt_pillar_default": str,
136         "decrypt_pillar_renderers": list,
137         "gpg_decrypt_must_succeed": bool,
138         "hash_type": str,
139         "optimization_order": list,
140         "disable_modules": list,
141         "disable_returners": list,
142         "whitelist_modules": list,
143         "module_dirs": list,
144         "returner_dirs": list,
145         "states_dirs": list,
146         "grains_dirs": list,
147         "render_dirs": list,
148         "outputter_dirs": list,
149         "utils_dirs": list,
150         "providers": dict,
151         "clean_dynamic_modules": bool,
152         "open_mode": bool,
153         "multiprocessing": bool,
154         "process_count_max": int,
155         "mine_enabled": bool,
156         "mine_return_job": bool,
157         "mine_interval": int,
158         "ipc_mode": str,
159         "ipv6": (type(None), bool),
160         "file_buffer_size": int,
161         "tcp_pub_port": int,
162         "tcp_pull_port": int,
163         "tcp_master_pub_port": int,
164         "tcp_master_pull_port": int,
165         "tcp_master_publish_pull": int,
166         "tcp_master_workers": int,
167         "log_file": str,
168         "log_level": str,
169         "log_level_logfile": (type(None), str),
170         "log_datefmt": str,
171         "log_datefmt_logfile": str,
172         "log_fmt_console": str,
173         "log_fmt_logfile": (tuple, str),
174         "log_granular_levels": dict,
175         "log_rotate_max_bytes": int,
176         "log_rotate_backup_count": int,
177         "max_event_size": int,
178         "enable_legacy_startup_events": bool,
179         "test": bool,
180         "cython_enable": bool,
181         "enable_fqdns_grains": bool,
182         "enable_gpu_grains": bool,
183         "enable_zip_modules": bool,
184         "show_timeout": bool,
185         "show_jid": bool,
186         "unique_jid": bool,
187         "state_verbose": bool,
188         "state_output": str,
189         "state_output_diff": bool,
190         "state_output_profile": bool,
191         "state_output_pct": bool,
192         "state_compress_ids": bool,
193         "state_auto_order": bool,
194         "state_events": bool,
195         "acceptance_wait_time": float,
196         "acceptance_wait_time_max": float,
197         "rejected_retry": bool,
198         "loop_interval": float,
199         "verify_env": bool,
200         "grains": dict,
201         "permissive_pki_access": bool,
202         "key_pass": (type(None), str),
203         "signing_key_pass": (<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>type(None), str),
204         "default_include": str,
205         "update_url": (bool, str),
206         "update_restart_services": list,
207         "retry_dns": float,
208         "retry_dns_count": (type(None), int),
209         "resolve_dns_fallback": bool,
210         "recon_max": float,
211         "recon_default": float,
212         "recon_randomize": bool,
213         "return_retry_timer": int,
214         "return_retry_timer_max": int,
215         "return_retry_tries": int,
216         "event_return": (list, str),
217         "event_return_queue": int,
218         "event_return_queue_max_seconds": int,
219         "event_return_whitelist": list,
220         "event_return_blacklist": list,
221         "event_match_type": str,
222         "pidfile": str,
223         "range_server": str,
224         "tcp_keepalive": bool,
225         "tcp_keepalive_idle": float,
226         "tcp_keepalive_cnt": float,
227         "tcp_keepalive_intvl": float,
228         "interface": str,
229         "publish_port": int,
230         "auth_mode": int,
231         "zmq_backlog": int,
232         "pub_hwm": int,
233         "ipc_write_buffer": int,
234         "req_server_niceness": (type(None), int),
235         "pub_server_niceness": (type(None), int),
236         "fileserver_update_niceness": (type(None), int),
237         "maintenance_niceness": (type(</b></font>None), int),
238         "mworker_niceness": (type(None), int),
239         "mworker_queue_niceness": (type(None), int),
240         "event_return_niceness": (type(None), int),
241         "event_publisher_niceness": (type(None), int),
242         "reactor_niceness": (type(None), int),
243         "worker_threads": int,
244         "ret_port": int,
245         "keep_jobs": int,
246         "archive_jobs": bool,
247         "master_roots": dict,
248         "add_proxymodule_to_opts": bool,
249         "proxy_merge_pillar_in_opts": bool,
250         "proxy_deep_merge_pillar_in_opts": bool,
251         "proxy_merge_pillar_in_opts_strategy": str,
252         "proxy_mines_pillar": bool,
253         "proxy_always_alive": bool,
254         "proxy_keep_alive": bool,
255         "proxy_keep_alive_interval": int,
256         "roots_update_interval": int,
257         "azurefs_update_interval": int,
258         "gitfs_update_interval": int,
259         "git_pillar_update_interval": int,
260         "hgfs_update_interval": int,
261         "minionfs_update_interval": int,
262         "s3fs_update_interval": int,
263         "svnfs_update_interval": int,
264         "git_pillar_ssl_verify": bool,
265         "git_pillar_global_lock": bool,
266         "git_pillar_user": str,
267         "git_pillar_password": str,
268         "git_pillar_insecure_auth": bool,
269         "git_pillar_privkey": str,
270         "git_pillar_pubkey": str,
271         "git_pillar_passphrase": str,
272         "git_pillar_refspecs": list,
273         "git_pillar_includes": bool,
274         "git_pillar_verify_config": bool,
275         "gitfs_remotes": list,
276         "gitfs_insecure_auth": bool,
277         "gitfs_privkey": str,
278         "gitfs_pubkey": str,
279         "gitfs_passphrase": str,
280         "gitfs_saltenv_whitelist": list,
281         "gitfs_saltenv_blacklist": list,
282         "gitfs_ssl_verify": bool,
283         "gitfs_global_lock": bool,
284         "gitfs_saltenv": list,
285         "gitfs_ref_types": list,
286         "gitfs_refspecs": list,
287         "gitfs_disable_saltenv_mapping": bool,
288         "hgfs_remotes": list,
289         "hgfs_mountpoint": str,
290         "hgfs_root": str,
291         "hgfs_base": str,
292         "hgfs_branch_method": str,
293         "hgfs_saltenv_whitelist": list,
294         "hgfs_saltenv_blacklist": list,
295         "svnfs_remotes": list,
296         "svnfs_mountpoint": str,
297         "svnfs_root": str,
298         "svnfs_trunk": str,
299         "svnfs_branches": str,
300         "svnfs_tags": str,
301         "svnfs_saltenv_whitelist": list,
302         "svnfs_saltenv_blacklist": list,
303         "minionfs_env": str,
304         "minionfs_mountpoint": str,
305         "minionfs_whitelist": list,
306         "minionfs_blacklist": list,
307         "ext_pillar": list,
308         "pillar_version": int,
309         "pillar_opts": bool,
310         "pillar_cache": bool,
311         "pillar_cache_ttl": int,
312         "pillar_cache_backend": str,
313         "gpg_cache": bool,
314         "gpg_cache_ttl": int,
315         "gpg_cache_backend": str,
316         "pillar_safe_render_error": bool,
317         "pillar_source_merging_strategy": str,
318         "pillar_merge_lists": bool,
319         "pillar_includes_override_sls": bool,
320         "top_file_merging_strategy": str,
321         "env_order": list,
322         "default_top": str,
323         "ping_on_rotate": bool,
324         "peer": dict,
325         "preserve_minion_cache": bool,
326         "syndic_master": (str, list),
327         "syndic_failover": str,
328         "syndic_forward_all_events": bool,
329         "runner_dirs": list,
330         "client_acl_verify": bool,
331         "publisher_acl": dict,
332         "publisher_acl_blacklist": dict,
333         "sudo_acl": bool,
334         "external_auth": dict,
335         "token_expire": int,
336         "token_expire_user_override": (bool, dict),
337         "file_recv": bool,
338         "file_recv_max_size": int,
339         "file_ignore_regex": (list, str),
340         "file_ignore_glob": (list, str),
341         "fileserver_backend": list,
342         "fileserver_followsymlinks": bool,
343         "fileserver_ignoresymlinks": bool,
344         "fileserver_verify_config": bool,
345         "permissive_acl": bool,
346         "keep_acl_in_token": bool,
347         "eauth_acl_module": str,
348         "eauth_tokens": str,
349         "max_open_files": int,
350         "auto_accept": bool,
351         "autosign_timeout": int,
352         "master_tops": dict,
353         "master_tops_first": bool,
354         "order_masters": bool,
355         "job_cache": bool,
356         "ext_job_cache": str,
357         "master_job_cache": str,
358         "job_cache_store_endtime": bool,
359         "minion_data_cache": bool,
360         "publish_session": int,
361         "reactor": list,
362         "reactor_refresh_interval": int,
363         "reactor_worker_threads": int,
364         "reactor_worker_hwm": int,
365         "engines": list,
366         "runner_returns": bool,
367         "serial": str,
368         "search": str,
369         "nodegroups": (dict, list),
370         "ssh_list_nodegroups": dict,
371         "ssh_use_home_key": bool,
372         "key_logfile": str,
373         "random_startup_delay": int,
374         "winrepo_source_dir": str,
375         "winrepo_dir": str,
376         "winrepo_dir_ng": str,
377         "winrepo_cachefile": str,
378         "winrepo_cache_expire_max": int,
379         "winrepo_cache_expire_min": int,
380         "winrepo_remotes": list,
381         "winrepo_remotes_ng": list,
382         "winrepo_ssl_verify": bool,
383         "winrepo_user": str,
384         "winrepo_password": str,
385         "winrepo_insecure_auth": bool,
386         "winrepo_privkey": str,
387         "winrepo_pubkey": str,
388         "winrepo_passphrase": str,
389         "winrepo_refspecs": list,
390         "modules_max_memory": int,
391         "grains_blacklist": list,
392         "grains_refresh_every": int,
393         "grains_refresh_pre_exec": bool,
394         "enable_lspci": bool,
395         "syndic_wait": int,
396         "jinja_env": dict,
397         "jinja_sls_env": dict,
398         "jinja_lstrip_blocks": bool,
399         "jinja_trim_blocks": bool,
400         "minion_id_caching": bool,
401         "minion_id_lowercase": bool,
402         "minion_id_remove_domain": (str, bool),
403         "sign_pub_messages": bool,
404         "keysize": int,
405         "transport": str,
406         "gather_job_timeout": int,
407         "auth_timeout": int,
408         "auth_tries": int,
409         "master_tries": int,
410         "auth_safemode": bool,
411         "random_master": bool,
412         "random_reauth_delay": int,
413         "syndic_event_forward_timeout": float,
414         "syndic_jid_forward_cache_hwm": int,
415         "ssh_passwd": str,
416         "ssh_port": str,
417         "ssh_sudo": bool,
418         "ssh_sudo_user": str,
419         "ssh_timeout": float,
420         "ssh_user": str,
421         "ssh_scan_ports": str,
422         "ssh_scan_timeout": float,
423         "ssh_identities_only": bool,
424         "ssh_log_file": str,
425         "ssh_config_file": str,
426         "ssh_merge_pillar": bool,
427         "ssh_run_pre_flight": bool,
428         "cluster_mode": bool,
429         "sqlite_queue_dir": str,
430         "queue_dirs": list,
431         "ping_interval": int,
432         "cli_summary": bool,
433         "max_minions": int,
434         "username": (type(None), str),
435         "password": (type(None), str),
436         "zmq_filtering": bool,
437         "con_cache": bool,
438         "rotate_aes_key": bool,
439         "cache_sreqs": bool,
440         "cmd_safe": bool,
441         "rest_timeout": int,
442         "sudo_user": str,
443         "http_connect_timeout": float,
444         "http_request_timeout": float,
445         "http_max_body": int,
446         "bootstrap_delay": int,
447         "proxy_merge_grains_in_module": bool,
448         "minion_restart_command": list,
449         "pub_ret": bool,
450         "proxy_host": str,
451         "proxy_username": str,
452         "proxy_password": str,
453         "proxy_port": int,
454         "no_proxy": list,
455         "minion_jid_queue_hwm": int,
456         "cache": str,
457         "memcache_expire_seconds": int,
458         "memcache_max_items": int,
459         "memcache_full_cleanup": bool,
460         "memcache_debug": bool,
461         "thin_extra_mods": str,
462         "min_extra_mods": str,
463         "return": (str, list),
464         "ssl": (dict, bool, type(None)),
465         "multifunc_ordered": bool,
466         "beacons_before_connect": bool,
467         "scheduler_before_connect": bool,
468         "extmod_whitelist": dict,
469         "extmod_blacklist": dict,
470         "django_auth_path": str,
471         "django_auth_settings": str,
472         "tcp_authentication_retries": int,
473         "tcp_reconnect_backoff": float,
474         "allow_minion_key_revoke": bool,
475         "salt_cp_chunk_size": int,
476         "minion_sign_messages": bool,
477         "drop_messages_signature_fail": bool,
478         "require_minion_sign_messages": bool,
479         "pass_to_ext_pillars": (str, list),
480         "discovery": (dict, bool),
481         "schedule": dict,
482         "auth_events": bool,
483         "minion_data_cache_events": bool,
484         "enable_ssh_minions": bool,
485         "thoriumenv": (type(None), str),
486         "thorium_top": str,
487         "netapi_allow_raw_shell": bool,
488         "disabled_requisites": (str, list),
489         "features": dict,
490         "fips_mode": bool,
491         "detect_remote_minions": bool,
492         "remote_minions_port": int,
493     }
494 )
495 DEFAULT_MINION_OPTS = immutabletypes.freeze(
496     {
497         "interface": "0.0.0.0",
498         "master": "salt",
499         "master_type": "str",
500         "master_uri_format": "default",
501         "source_interface_name": "",
502         "source_address": "",
503         "source_ret_port": 0,
504         "source_publish_port": 0,
505         "master_port": 4506,
506         "master_finger": "",
507         "master_shuffle": False,
508         "master_alive_interval": 0,
509         "master_failback": False,
510         "master_failback_interval": 0,
511         "verify_master_pubkey_sign": False,
512         "sign_pub_messages": False,
513         "always_verify_signature": False,
514         "master_sign_key_name": "master_sign",
515         "syndic_finger": "",
516         "user": salt.utils.user.get_user(),
517         "root_dir": salt.syspaths.ROOT_DIR,
518         "pki_dir": os.path.join(salt.syspaths.CONFIG_DIR, "pki", "minion"),
519         "id": "",
520         "id_function": {},
521         "cachedir": os.path.join(salt.syspaths.CACHE_DIR, "minion"),
522         "append_minionid_config_dirs": [],
523         "cache_jobs": False,
524         "grains_blacklist": [],
525         "grains_cache": False,
526         "grains_cache_expiration": 300,
527         "grains_deep_merge": False,
528         "conf_file": os.path.join(salt.syspaths.CONFIG_DIR, "minion"),
529         "sock_dir": os.path.join(salt.syspaths.SOCK_DIR, "minion"),
530         "sock_pool_size": 1,
531         "backup_mode": "",
532         "renderer": "jinja|yaml",
533         "renderer_whitelist": [],
534         "renderer_blacklist": [],
535         "random_startup_delay": 0,
536         "failhard": False,
537         "autoload_dynamic_modules": True,
538         "saltenv": None,
539         "lock_saltenv": False,
540         "pillarenv": None,
541         "pillarenv_from_saltenv": False,
542         "pillar_opts": False,
543         "pillar_source_merging_strategy": "smart",
544         "pillar_merge_lists": False,
545         "pillar_includes_override_sls": False,
546         "pillar_cache": False,
547         "pillar_cache_ttl": 3600,
548         "pillar_cache_backend": "disk",
549         "gpg_cache": False,
550         "gpg_cache_ttl": 86400,
551         "gpg_cache_backend": "disk",
552         "extension_modules": os.path.join(salt.syspaths.CACHE_DIR, "minion", "extmods"),
553         "state_top": "top.sls",
554         "state_top_saltenv": None,
555         "startup_states": "",
556         "sls_list": [],
557         "start_event_grains": [],
558         "top_file": "",
559         "thoriumenv": None,
560         "thorium_top": "top.sls",
561         "thorium_interval": 0.5,
562         "thorium_roots": {"base": [salt.syspaths.BASE_THORIUM_ROOTS_DIR]},
563         "file_client": "remote",
564         "local": False,
565         "use_master_when_local": False,
566         "file_roots": {
567             "base": [salt.syspaths.BASE_FILE_ROOTS_DIR, salt.syspaths.SPM_FORMULA_PATH]
568         },
569         "top_file_merging_strategy": "merge",
570         "env_order": [],
571         "default_top": "base",
572         "file_recv": False,
573         "file_recv_max_size": 100,
574         "file_ignore_regex": [],
575         "file_ignore_glob": [],
576         "fileserver_backend": ["roots"],
577         "fileserver_followsymlinks": True,
578         "fileserver_ignoresymlinks": False,
579         "pillar_roots": {
580             "base": [salt.syspaths.BASE_PILLAR_ROOTS_DIR, salt.syspaths.SPM_PILLAR_PATH]
581         },
582         "on_demand_ext_pillar": ["libvirt", "virtkey"],
583         "decrypt_pillar": [],
584         "decrypt_pillar_delimiter": ":",
585         "decrypt_pillar_default": "gpg",
586         "decrypt_pillar_renderers": ["gpg"],
587         "gpg_decrypt_must_succeed": False,
588         "roots_update_interval": DEFAULT_INTERVAL,
589         "azurefs_update_interval": DEFAULT_INTERVAL,
590         "gitfs_update_interval": DEFAULT_INTERVAL,
591         "git_pillar_update_interval": DEFAULT_INTERVAL,
592         "hgfs_update_interval": DEFAULT_INTERVAL,
593         "minionfs_update_interval": DEFAULT_INTERVAL,
594         "s3fs_update_interval": DEFAULT_INTERVAL,
595         "svnfs_update_interval": DEFAULT_INTERVAL,
596         "git_pillar_base": "master",
597         "git_pillar_branch": "master",
598         "git_pillar_env": "",
599         "git_pillar_fallback": "",
600         "git_pillar_root": "",
601         "git_pillar_ssl_verify": True,
602         "git_pillar_global_lock": True,
603         "git_pillar_user": "",
604         "git_pillar_password": "",
605         "git_pillar_insecure_auth": False,
606         "git_pillar_privkey": "",
607         "git_pillar_pubkey": "",
608         "git_pillar_passphrase": "",
609         "git_pillar_refspecs": _DFLT_REFSPECS,
610         "git_pillar_includes": True,
611         "gitfs_remotes": [],
612         "gitfs_mountpoint": "",
613         "gitfs_root": "",
614         "gitfs_base": "master",
615         "gitfs_fallback": "",
616         "gitfs_user": "",
617         "gitfs_password": "",
618         "gitfs_insecure_auth": False,
619         "gitfs_privkey": "",
620         "gitfs_pubkey": "",
621         "gitfs_passphrase": "",
622         "gitfs_saltenv_whitelist": [],
623         "gitfs_saltenv_blacklist": [],
624         "gitfs_global_lock": True,
625         "gitfs_ssl_verify": True,
626         "gitfs_saltenv": [],
627         "gitfs_ref_types": ["branch", "tag", "sha"],
628         "gitfs_refspecs": _DFLT_REFSPECS,
629         "gitfs_disable_saltenv_mapping": False,
630         "unique_jid": False,
631         "hash_type": "sha256",
632         "optimization_order": [0, 1, 2],
633         "disable_modules": [],
634         "disable_returners": [],
635         "whitelist_modules": [],
636         "module_dirs": [],
637         "returner_dirs": [],
638         "grains_dirs": [],
639         "states_dirs": [],
640         "render_dirs": [],
641         "outputter_dirs": [],
642         "utils_dirs": [],
643         "publisher_acl": {},
644         "publisher_acl_blacklist": {},
645         "providers": {},
646         "clean_dynamic_modules": True,
647         "open_mode": False,
648         "auto_accept": True,
649         "autosign_timeout": 120,
650         "multiprocessing": True,
651         "process_count_max": -1,
652         "mine_enabled": True,
653         "mine_return_job": False,
654         "mine_interval": 60,
655         "ipc_mode": _DFLT_IPC_MODE,
656         "ipc_write_buffer": _DFLT_IPC_WBUFFER,
657         "ipv6": None,
658         "file_buffer_size": 262144,
659         "tcp_pub_port": 4510,
660         "tcp_pull_port": 4511,
661         "tcp_authentication_retries": 5,
662         "tcp_reconnect_backoff": 1,
663         "log_file": os.path.join(salt.syspaths.LOGS_DIR, "minion"),
664         "log_level": "warning",
665         "log_level_logfile": None,
666         "log_datefmt": _DFLT_LOG_DATEFMT,
667         "log_datefmt_logfile": _DFLT_LOG_DATEFMT_LOGFILE,
668         "log_fmt_console": _DFLT_LOG_FMT_CONSOLE,
669         "log_fmt_logfile": _DFLT_LOG_FMT_LOGFILE,
670         "log_fmt_jid": _DFLT_LOG_FMT_JID,
671         "log_granular_levels": {},
672         "log_rotate_max_bytes": 0,
673         "log_rotate_backup_count": 0,
674         "max_event_size": 1048576,
675         "enable_legacy_startup_events": True,
676         "test": False,
677         "ext_job_cache": "",
678         "cython_enable": False,
679         "enable_fqdns_grains": _DFLT_FQDNS_GRAINS,
680         "enable_gpu_grains": True,
681         "enable_zip_modules": False,
682         "state_verbose": True,
683         "state_output": "full",
684         "state_output_diff": False,
685         "state_output_profile": True,
686         "state_auto_order": True,
687         "state_events": False,
688         "state_aggregate": False,
689         "snapper_states": False,
690         "snapper_states_config": "root",
691         "acceptance_wait_time": 10,
692         "acceptance_wait_time_max": 0,
693         "rejected_retry": False,
694         "loop_interval": 1,
695         "verify_env": True,
696         "grains": {},
697         "permissive_pki_access": False,
698         "default_include": "minion.d/*.conf",
699         "update_url": False,
700         "update_restart_services": [],
701         "retry_dns": 30,
702         "retry_dns_count": None,
703         "resolve_dns_fallback": True,
704         "recon_max": 10000,
705         "recon_default": 1000,
706         "recon_randomize": True,
707         "return_retry_timer": 5,
708         "return_retry_timer_max": 10,
709         "return_retry_tries": 3,
710         "random_reauth_delay": 10,
711         "winrepo_source_dir": "salt://win/repo-ng/",
712         "winrepo_dir": os.path.join(salt.syspaths.BASE_FILE_ROOTS_DIR, "win", "repo"),
713         "winrepo_dir_ng": os.path.join(
714             salt.syspaths.BASE_FILE_ROOTS_DIR, "win", "repo-ng"
715         ),
716         "winrepo_cachefile": "winrepo.p",
717         "winrepo_cache_expire_max": 604800,
718         "winrepo_cache_expire_min": 1800,
719         "winrepo_remotes": ["https://github.com/saltstack/salt-winrepo.git"],
720         "winrepo_remotes_ng": ["https://github.com/saltstack/salt-winrepo-ng.git"],
721         "winrepo_branch": "master",
722         "winrepo_fallback": "",
723         "winrepo_ssl_verify": True,
724         "winrepo_user": "",
725         "winrepo_password": "",
726         "winrepo_insecure_auth": False,
727         "winrepo_privkey": "",
728         "winrepo_pubkey": "",
729         "winrepo_passphrase": "",
730         "winrepo_refspecs": _DFLT_REFSPECS,
731         "pidfile": os.path.join(salt.syspaths.PIDFILE_DIR, "salt-minion.pid"),
732         "range_server": "range:80",
733         "reactor_refresh_interval": 60,
734         "reactor_worker_threads": 10,
735         "reactor_worker_hwm": 10000,
736         "engines": [],
737         "tcp_keepalive": True,
738         "tcp_keepalive_idle": 300,
739         "tcp_keepalive_cnt": -1,
740         "tcp_keepalive_intvl": -1,
741         "modules_max_memory": -1,
742         "grains_refresh_every": 0,
743         "minion_id_caching": True,
744         "minion_id_lowercase": False,
745         "minion_id_remove_domain": False,
746         "keysize": 2048,
747         "transport": "zeromq",
748         "auth_timeout": 5,
749         "auth_tries": 7,
750         "master_tries": _MASTER_TRIES,
751         "master_tops_first": False,
752         "auth_safemode": False,
753         "random_master": False,
754         "cluster_mode": False,
755         "restart_on_error": False,
756         "ping_interval": 0,
757         "username": None,
758         "password": None,
759         "zmq_filtering": False,
760         "zmq_monitor": False,
761         "cache_sreqs": True,
762         "cmd_safe": True,
763         "sudo_user": "",
764         "http_connect_timeout": 20.0,  # tornado default - 20 seconds
765         "http_request_timeout": 1 * 60 * 60.0,  # 1 hour
766         "http_max_body": 100 * 1024 * 1024 * 1024,  # 100GB
767         "event_match_type": "startswith",
768         "minion_restart_command": [],
769         "pub_ret": True,
770         "proxy_host": "",
771         "proxy_username": "",
772         "proxy_password": "",
773         "proxy_port": 0,
774         "minion_jid_queue_hwm": 100,
775         "ssl": None,
776         "multifunc_ordered": False,
777         "beacons_before_connect": False,
778         "scheduler_before_connect": False,
779         "cache": "localfs",
780         "salt_cp_chunk_size": 65536,
781         "extmod_whitelist": {},
782         "extmod_blacklist": {},
783         "minion_sign_messages": False,
784         "discovery": False,
785         "schedule": {},
786         "ssh_merge_pillar": True,
787         "disabled_requisites": [],
788         "reactor_niceness": None,
789         "fips_mode": False,
790     }
791 )
792 DEFAULT_MASTER_OPTS = immutabletypes.freeze(
793     {
794         "interface": "0.0.0.0",
795         "publish_port": 4505,
796         "zmq_backlog": 1000,
797         "pub_hwm": 1000,
798         "auth_mode": 1,
799         "user": _MASTER_USER,
800         "worker_threads": 5,
801         "sock_dir": os.path.join(salt.syspaths.SOCK_DIR, "master"),
802         "sock_pool_size": 1,
803         "ret_port": 4506,
804         "timeout": 5,
805         "keep_jobs": 24,
806         "archive_jobs": False,
807         "root_dir": salt.syspaths.ROOT_DIR,
808         "pki_dir": os.path.join(salt.syspaths.CONFIG_DIR, "pki", "master"),
809         "key_cache": "",
810         "cachedir": os.path.join(salt.syspaths.CACHE_DIR, "master"),
811         "file_roots": {
812             "base": [salt.syspaths.BASE_FILE_ROOTS_DIR, salt.syspaths.SPM_FORMULA_PATH]
813         },
814         "master_roots": {"base": [salt.syspaths.BASE_MASTER_ROOTS_DIR]},
815         "pillar_roots": {
816             "base": [salt.syspaths.BASE_PILLAR_ROOTS_DIR, salt.syspaths.SPM_PILLAR_PATH]
817         },
818         "on_demand_ext_pillar": ["libvirt", "virtkey"],
819         "decrypt_pillar": [],
820         "decrypt_pillar_delimiter": ":",
821         "decrypt_pillar_default": "gpg",
822         "decrypt_pillar_renderers": ["gpg"],
823         "gpg_decrypt_must_succeed": False,
824         "thoriumenv": None,
825         "thorium_top": "top.sls",
826         "thorium_interval": 0.5,
827         "thorium_roots": {"base": [salt.syspaths.BASE_THORIUM_ROOTS_DIR]},
828         "top_file_merging_strategy": "merge",
829         "env_order": [],
830         "saltenv": None,
831         "lock_saltenv": False,
832         "pillarenv": None,
833         "default_top": "base",
834         "file_client": "local",
835         "local": True,
836         "roots_update_interval": DEFAULT_INTERVAL,
837         "azurefs_update_interval": DEFAULT_INTERVAL,
838         "gitfs_update_interval": DEFAULT_INTERVAL,
839         "git_pillar_update_interval": DEFAULT_INTERVAL,
840         "hgfs_update_interval": DEFAULT_INTERVAL,
841         "minionfs_update_interval": DEFAULT_INTERVAL,
842         "s3fs_update_interval": DEFAULT_INTERVAL,
843         "svnfs_update_interval": DEFAULT_INTERVAL,
844         "git_pillar_base": "master",
845         "git_pillar_branch": "master",
846         "git_pillar_env": "",
847         "git_pillar_fallback": "",
848         "git_pillar_root": "",
849         "git_pillar_ssl_verify": True,
850         "git_pillar_global_lock": True,
851         "git_pillar_user": "",
852         "git_pillar_password": "",
853         "git_pillar_insecure_auth": False,
854         "git_pillar_privkey": "",
855         "git_pillar_pubkey": "",
856         "git_pillar_passphrase": "",
857         "git_pillar_refspecs": _DFLT_REFSPECS,
858         "git_pillar_includes": True,
859         "git_pillar_verify_config": True,
860         "gitfs_remotes": [],
861         "gitfs_mountpoint": "",
862         "gitfs_root": "",
863         "gitfs_base": "master",
864         "gitfs_fallback": "",
865         "gitfs_user": "",
866         "gitfs_password": "",
867         "gitfs_insecure_auth": False,
868         "gitfs_privkey": "",
869         "gitfs_pubkey": "",
870         "gitfs_passphrase": "",
871         "gitfs_saltenv_whitelist": [],
872         "gitfs_saltenv_blacklist": [],
873         "gitfs_global_lock": True,
874         "gitfs_ssl_verify": True,
875         "gitfs_saltenv": [],
876         "gitfs_ref_types": ["branch", "tag", "sha"],
877         "gitfs_refspecs": _DFLT_REFSPECS,
878         "gitfs_disable_saltenv_mapping": False,
879         "hgfs_remotes": [],
880         "hgfs_mountpoint": "",
881         "hgfs_root": "",
882         "hgfs_base": "default",
883         "hgfs_branch_method": "branches",
884         "hgfs_saltenv_whitelist": [],
885         "hgfs_saltenv_blacklist": [],
886         "show_timeout": True,
887         "show_jid": False,
888         "unique_jid": False,
889         "svnfs_remotes": [],
890         "svnfs_mountpoint": "",
891         "svnfs_root": "",
892         "svnfs_trunk": "trunk",
893         "svnfs_branches": "branches",
894         "svnfs_tags": "tags",
895         "svnfs_saltenv_whitelist": [],
896         "svnfs_saltenv_blacklist": [],
897         "max_event_size": 1048576,
898         "master_stats": False,
899         "master_stats_event_iter": 60,
900         "minionfs_env": "base",
901         "minionfs_mountpoint": "",
902         "minionfs_whitelist": [],
903         "minionfs_blacklist": [],
904         "ext_pillar": [],
905         "pillar_version": 2,
906         "pillar_opts": False,
907         "pillar_safe_render_error": True,
908         "pillar_source_merging_strategy": "smart",
909         "pillar_merge_lists": False,
910         "pillar_includes_override_sls": False,
911         "pillar_cache": False,
912         "pillar_cache_ttl": 3600,
913         "pillar_cache_backend": "disk",
914         "gpg_cache": False,
915         "gpg_cache_ttl": 86400,
916         "gpg_cache_backend": "disk",
917         "ping_on_rotate": False,
918         "peer": {},
919         "preserve_minion_cache": False,
920         "syndic_master": "masterofmasters",
921         "syndic_failover": "random",
922         "syndic_forward_all_events": False,
923         "syndic_log_file": os.path.join(salt.syspaths.LOGS_DIR, "syndic"),
924         "syndic_pidfile": os.path.join(salt.syspaths.PIDFILE_DIR, "salt-syndic.pid"),
925         "outputter_dirs": [],
926         "runner_dirs": [],
927         "utils_dirs": [],
928         "client_acl_verify": True,
929         "publisher_acl": {},
930         "publisher_acl_blacklist": {},
931         "sudo_acl": False,
932         "external_auth": {},
933         "token_expire": 43200,
934         "token_expire_user_override": False,
935         "permissive_acl": False,
936         "keep_acl_in_token": False,
937         "eauth_acl_module": "",
938         "eauth_tokens": "localfs",
939         "extension_modules": os.path.join(salt.syspaths.CACHE_DIR, "master", "extmods"),
940         "module_dirs": [],
941         "file_recv": False,
942         "file_recv_max_size": 100,
943         "file_buffer_size": 1048576,
944         "file_ignore_regex": [],
945         "file_ignore_glob": [],
946         "fileserver_backend": ["roots"],
947         "fileserver_followsymlinks": True,
948         "fileserver_ignoresymlinks": False,
949         "fileserver_verify_config": True,
950         "max_open_files": 100000,
951         "hash_type": "sha256",
952         "optimization_order": [0, 1, 2],
953         "conf_file": os.path.join(salt.syspaths.CONFIG_DIR, "master"),
954         "open_mode": False,
955         "auto_accept": False,
956         "renderer": "jinja|yaml",
957         "renderer_whitelist": [],
958         "renderer_blacklist": [],
959         "failhard": False,
960         "state_top": "top.sls",
961         "state_top_saltenv": None,
962         "master_tops": {},
963         "master_tops_first": False,
964         "order_masters": False,
965         "job_cache": True,
966         "ext_job_cache": "",
967         "master_job_cache": "local_cache",
968         "job_cache_store_endtime": False,
969         "minion_data_cache": True,
970         "enforce_mine_cache": False,
971         "ipc_mode": _DFLT_IPC_MODE,
972         "ipc_write_buffer": _DFLT_IPC_WBUFFER,
973         "req_server_niceness": None,
974         "pub_server_niceness": None,
975         "fileserver_update_niceness": None,
976         "mworker_niceness": None,
977         "mworker_queue_niceness": None,
978         "maintenance_niceness": None,
979         "event_return_niceness": None,
980         "event_publisher_niceness": None,
981         "reactor_niceness": None,
982         "ipv6": None,
983         "tcp_master_pub_port": 4512,
984         "tcp_master_pull_port": 4513,
985         "tcp_master_publish_pull": 4514,
986         "tcp_master_workers": 4515,
987         "log_file": os.path.join(salt.syspaths.LOGS_DIR, "master"),
988         "log_level": "warning",
989         "log_level_logfile": None,
990         "log_datefmt": _DFLT_LOG_DATEFMT,
991         "log_datefmt_logfile": _DFLT_LOG_DATEFMT_LOGFILE,
992         "log_fmt_console": _DFLT_LOG_FMT_CONSOLE,
993         "log_fmt_logfile": _DFLT_LOG_FMT_LOGFILE,
994         "log_fmt_jid": _DFLT_LOG_FMT_JID,
995         "log_granular_levels": {},
996         "log_rotate_max_bytes": 0,
997         "log_rotate_backup_count": 0,
998         "pidfile": os.path.join(salt.syspaths.PIDFILE_DIR, "salt-master.pid"),
999         "publish_session": 86400,
1000         "range_server": "range:80",
1001         "reactor": [],
1002         "reactor_refresh_interval": 60,
1003         "reactor_worker_threads": 10,
1004         "reactor_worker_hwm": 10000,
1005         "engines": [],
1006         "event_return": "",
1007         "event_return_queue": 0,
1008         "event_return_whitelist": [],
1009         "event_return_blacklist": [],
1010         "event_match_type": "startswith",
1011         "runner_returns": True,
1012         "serial": "msgpack",
1013         "test": False,
1014         "state_verbose": True,
1015         "state_output": "full",
1016         "state_output_diff": False,
1017         "state_output_profile": True,
1018         "state_auto_order": True,
1019         "state_events": False,
1020         "state_aggregate": False,
1021         "search": "",
1022         "loop_interval": 60,
1023         "nodegroups": {},
1024         "ssh_list_nodegroups": {},
1025         "ssh_use_home_key": False,
1026         "cython_enable": False,
1027         "enable_gpu_grains": False,
1028         "key_logfile": os.path.join(salt.syspaths.LOGS_DIR, "key"),
1029         "verify_env": True,
1030         "permissive_pki_access": False,
1031         "key_pass": None,
1032         "signing_key_pass": None,
1033         "default_include": "master.d/*.conf",
1034         "winrepo_dir": os.path.join(salt.syspaths.BASE_FILE_ROOTS_DIR, "win", "repo"),
1035         "winrepo_dir_ng": os.path.join(
1036             salt.syspaths.BASE_FILE_ROOTS_DIR, "win", "repo-ng"
1037         ),
1038         "winrepo_cachefile": "winrepo.p",
1039         "winrepo_remotes": ["https://github.com/saltstack/salt-winrepo.git"],
1040         "winrepo_remotes_ng": ["https://github.com/saltstack/salt-winrepo-ng.git"],
1041         "winrepo_branch": "master",
1042         "winrepo_fallback": "",
1043         "winrepo_ssl_verify": True,
1044         "winrepo_user": "",
1045         "winrepo_password": "",
1046         "winrepo_insecure_auth": False,
1047         "winrepo_privkey": "",
1048         "winrepo_pubkey": "",
1049         "winrepo_passphrase": "",
1050         "winrepo_refspecs": _DFLT_REFSPECS,
1051         "syndic_wait": 5,
1052         "jinja_env": {},
1053         "jinja_sls_env": {},
1054         "jinja_lstrip_blocks": False,
1055         "jinja_trim_blocks": False,
1056         "tcp_keepalive": True,
1057         "tcp_keepalive_idle": 300,
1058         "tcp_keepalive_cnt": -1,
1059         "tcp_keepalive_intvl": -1,
1060         "sign_pub_messages": True,
1061         "keysize": 2048,
1062         "transport": "zeromq",
1063         "gather_job_timeout": 10,
1064         "syndic_event_forward_timeout": 0.5,
1065         "syndic_jid_forward_cache_hwm": 100,
1066         "regen_thin": False,
1067         "ssh_passwd": "",
1068         "ssh_priv_passwd": "",
1069         "ssh_port": "22",
1070         "ssh_sudo": False,
1071         "ssh_sudo_user": "",
1072         "ssh_timeout": 60,
1073         "ssh_user": "root",
1074         "ssh_scan_ports": "22",
1075         "ssh_scan_timeout": 0.01,
1076         "ssh_identities_only": False,
1077         "ssh_log_file": os.path.join(salt.syspaths.LOGS_DIR, "ssh"),
1078         "ssh_config_file": os.path.join(salt.syspaths.HOME_DIR, ".ssh", "config"),
1079         "cluster_mode": False,
1080         "sqlite_queue_dir": os.path.join(salt.syspaths.CACHE_DIR, "master", "queues"),
1081         "queue_dirs": [],
1082         "cli_summary": False,
1083         "max_minions": 0,
1084         "master_sign_key_name": "master_sign",
1085         "master_sign_pubkey": False,
1086         "master_pubkey_signature": "master_pubkey_signature",
1087         "master_use_pubkey_signature": False,
1088         "zmq_filtering": False,
1089         "zmq_monitor": False,
1090         "con_cache": False,
1091         "rotate_aes_key": True,
1092         "cache_sreqs": True,
1093         "dummy_pub": False,
1094         "http_connect_timeout": 20.0,  # tornado default - 20 seconds
1095         "http_request_timeout": 1 * 60 * 60.0,  # 1 hour
1096         "http_max_body": 100 * 1024 * 1024 * 1024,  # 100GB
1097         "cache": "localfs",
1098         "memcache_expire_seconds": 0,
1099         "memcache_max_items": 1024,
1100         "memcache_full_cleanup": False,
1101         "memcache_debug": False,
1102         "thin_extra_mods": "",
1103         "min_extra_mods": "",
1104         "ssl": None,
1105         "extmod_whitelist": {},
1106         "extmod_blacklist": {},
1107         "clean_dynamic_modules": True,
1108         "django_auth_path": "",
1109         "django_auth_settings": "",
1110         "allow_minion_key_revoke": True,
1111         "salt_cp_chunk_size": 98304,
1112         "require_minion_sign_messages": False,
1113         "drop_messages_signature_fail": False,
1114         "discovery": False,
1115         "schedule": {},
1116         "auth_events": True,
1117         "minion_data_cache_events": True,
1118         "enable_ssh_minions": False,
1119         "netapi_allow_raw_shell": False,
1120         "fips_mode": False,
1121         "detect_remote_minions": False,
1122         "remote_minions_port": 22,
1123     }
1124 )
1125 DEFAULT_PROXY_MINION_OPTS = immutabletypes.freeze(
1126     {
1127         "conf_file": os.path.join(salt.syspaths.CONFIG_DIR, "proxy"),
1128         "log_file": os.path.join(salt.syspaths.LOGS_DIR, "proxy"),
1129         "add_proxymodule_to_opts": False,
1130         "proxy_merge_grains_in_module": True,
1131         "extension_modules": os.path.join(salt.syspaths.CACHE_DIR, "proxy", "extmods"),
1132         "append_minionid_config_dirs": [
1133             "cachedir",
1134             "pidfile",
1135             "default_include",
1136             "extension_modules",
1137         ],
1138         "default_include": "proxy.d/*.conf",
1139         "proxy_merge_pillar_in_opts": False,
1140         "proxy_deep_merge_pillar_in_opts": False,
1141         "proxy_merge_pillar_in_opts_strategy": "smart",
1142         "proxy_mines_pillar": True,
1143         "proxy_always_alive": True,
1144         "proxy_keep_alive": True,  # by default will try to keep alive the connection
1145         "proxy_keep_alive_interval": 1,  # frequency of the proxy keepalive in minutes
1146         "pki_dir": os.path.join(salt.syspaths.CONFIG_DIR, "pki", "proxy"),
1147         "cachedir": os.path.join(salt.syspaths.CACHE_DIR, "proxy"),
1148         "sock_dir": os.path.join(salt.syspaths.SOCK_DIR, "proxy"),
1149     }
1150 )
1151 DEFAULT_CLOUD_OPTS = immutabletypes.freeze(
1152     {
1153         "verify_env": True,
1154         "default_include": "cloud.conf.d/*.conf",
1155         "ssh_auth": "",
1156         "cachedir": os.path.join(salt.syspaths.CACHE_DIR, "cloud"),
1157         "keysize": 4096,
1158         "os": "",
1159         "script": "bootstrap-salt",
1160         "start_action": None,
1161         "enable_hard_maps": False,
1162         "delete_sshkeys": False,
1163         "deploy_scripts_search_path": "cloud.deploy.d",
1164         "log_file": os.path.join(salt.syspaths.LOGS_DIR, "cloud"),
1165         "log_level": "warning",
1166         "log_level_logfile": None,
1167         "log_datefmt": _DFLT_LOG_DATEFMT,
1168         "log_datefmt_logfile": _DFLT_LOG_DATEFMT_LOGFILE,
1169         "log_fmt_console": _DFLT_LOG_FMT_CONSOLE,
1170         "log_fmt_logfile": _DFLT_LOG_FMT_LOGFILE,
1171         "log_fmt_jid": _DFLT_LOG_FMT_JID,
1172         "log_granular_levels": {},
1173         "log_rotate_max_bytes": 0,
1174         "log_rotate_backup_count": 0,
1175         "bootstrap_delay": 0,
1176         "cache": "localfs",
1177     }
1178 )
1179 DEFAULT_API_OPTS = immutabletypes.freeze(
1180     {
1181         "api_pidfile": os.path.join(salt.syspaths.PIDFILE_DIR, "salt-api.pid"),
1182         "api_logfile": os.path.join(salt.syspaths.LOGS_DIR, "api"),
1183         "rest_timeout": 300,
1184     }
1185 )
1186 DEFAULT_SPM_OPTS = immutabletypes.freeze(
1187     {
1188         "spm_conf_file": os.path.join(salt.syspaths.CONFIG_DIR, "spm"),
1189         "formula_path": salt.syspaths.SPM_FORMULA_PATH,
1190         "pillar_path": salt.syspaths.SPM_PILLAR_PATH,
1191         "reactor_path": salt.syspaths.SPM_REACTOR_PATH,
1192         "spm_logfile": os.path.join(salt.syspaths.LOGS_DIR, "spm"),
1193         "spm_default_include": "spm.d/*.conf",
1194         "spm_repos_config": "/etc/salt/spm.repos",
1195         "spm_cache_dir": os.path.join(salt.syspaths.CACHE_DIR, "spm"),
1196         "spm_build_dir": os.path.join(salt.syspaths.SRV_ROOT_DIR, "spm_build"),
1197         "spm_build_exclude": ["CVS", ".hg", ".git", ".svn"],
1198         "spm_db": os.path.join(salt.syspaths.CACHE_DIR, "spm", "packages.db"),
1199         "cache": "localfs",
1200         "spm_repo_dups": "ignore",
1201         "spm_node_type": "",
1202         "spm_share_dir": os.path<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.join(salt.syspaths.SHARE_DIR, "spm"),
1203     }
1204 )
1205 VM_CONFIG_DEFAULTS = immutabletypes.freeze(
1206     {"default_include": "cloud.profiles.d/*.conf"}
1207 )
1208 PROVIDER_CONFIG_DEFAULTS = immutabletypes.freeze(
1209     {"default_include"</b></font>: "cloud.providers.d/*.conf"}
1210 )
1211 def _normalize_roots(file_roots):
1212     for saltenv, dirs in file_roots.items():
1213         normalized_saltenv = str(saltenv)
1214         if normalized_saltenv != saltenv:
1215             file_roots[normalized_saltenv] = file_roots.pop(saltenv)
1216         if not isinstance(dirs, (list, tuple)):
1217             file_roots[normalized_saltenv] = []
1218         file_roots[normalized_saltenv] = _expand_glob_path(
1219             file_roots[normalized_saltenv]
1220         )
1221     return file_roots
1222 def _validate_pillar_roots(pillar_roots):
1223     if not isinstance(pillar_roots, dict):
1224         log.warning(
1225             "The pillar_roots parameter is not properly formatted, using defaults"
1226         )
1227         return {"base": _expand_glob_path([salt.syspaths.BASE_PILLAR_ROOTS_DIR])}
1228     return _normalize_roots(pillar_roots)
1229 def _validate_file_roots(file_roots):
1230     if not isinstance(file_roots, dict):
1231         log.warning(
1232             "The file_roots parameter is not properly formatted, using defaults"
1233         )
1234         return {"base": _expand_glob_path([salt.syspaths.BASE_FILE_ROOTS_DIR])}
1235     return _normalize_roots(file_roots)
1236 def _expand_glob_path(file_roots):
1237     unglobbed_path = []
1238     for path in file_roots:
1239         try:
1240             if glob.has_magic(path):
1241                 unglobbed_path.extend(glob.glob(path))
1242             else:
1243                 unglobbed_path.append(path)
1244         except Exception:  # pylint: disable=broad-except
1245             unglobbed_path.append(path)
1246     return unglobbed_path
1247 def _validate_opts(opts):
1248     def format_multi_opt(valid_type):
1249         try:
1250             num_types = len(valid_type)
1251         except TypeError:
1252             return valid_type.__name__
1253         else:
1254             def get_types(types, type_tuple):
1255                 for item in type_tuple:
1256                     if isinstance(item, tuple):
1257                         get_types(types, item)
1258                     else:
1259                         try:
1260                             types.append(item.__name__)
1261                         except AttributeError:
1262                             log.warning(
1263                                 "Unable to interpret type %s while validating "
1264                                 "configuration",
1265                                 item,
1266                             )
1267             types = []
1268             get_types(types, valid_type)
1269             ret = ", ".join(types[:-1])
1270             ret += " or " + types[-1]
1271             return ret
1272     errors = []
1273     err = (
1274         "Config option '{}' with value {} has an invalid type of {}, a "
1275         "{} is required for this option"
1276     )
1277     for key, val in opts.items():
1278         if key in VALID_OPTS:
1279             if val is None:
1280                 if VALID_OPTS[key] is None:
1281                     continue
1282                 else:
1283                     try:
1284                         if None in VALID_OPTS[key]:
1285                             continue
1286                     except TypeError:
1287                         pass
1288             if isinstance(val, VALID_OPTS[key]):
1289                 continue
1290             if isinstance(val, str) and val.startswith("sdb://"):
1291                 continue
1292             if hasattr(VALID_OPTS[key], "__call__"):
1293                 try:
1294                     VALID_OPTS[key](val)
1295                     if isinstance(val, (list, dict)):
1296                         errors.append(
1297                             err.format(
1298                                 key, val, type(val).__name__, VALID_OPTS[key].__name__
1299                             )
1300                         )
1301                 except (TypeError, ValueError):
1302                     errors.append(
1303                         err.format(
1304                             key, val, type(val).__name__, VALID_OPTS[key].__name__
1305                         )
1306                     )
1307                 continue
1308             errors.append(
1309                 err.format(
1310                     key, val, type(val).__name__, format_multi_opt(VALID_OPTS[key])
1311                 )
1312             )
1313     if isinstance(opts.get("return"), list):
1314         opts["return"] = ",".join(opts["return"])
1315     for error in errors:
1316         log.warning(error)
1317     if errors:
1318         return False
1319     return True
1320 def _validate_ssh_minion_opts(opts):
1321     ssh_minion_opts = opts.get("ssh_minion_opts", {})
1322     if not isinstance(ssh_minion_opts, dict):
1323         log.error("Invalidly-formatted ssh_minion_opts")
1324         opts.pop("ssh_minion_opts")
1325     for opt_name in list(ssh_minion_opts):
1326         if (
1327             re.match("^[a-z0-9]+fs_", opt_name, flags=re.IGNORECASE)
1328             or ("pillar" in opt_name and not "ssh_merge_pillar" == opt_name)
1329             or opt_name in ("fileserver_backend",)
1330         ):
1331             log.warning(
1332                 "'%s' is not a valid ssh_minion_opts parameter, ignoring", opt_name
1333             )
1334             ssh_minion_opts.pop(opt_name)
1335 def _append_domain(opts):
1336     if opts["id"].endswith(opts["append_domain"]):
1337         return opts["id"]
1338     if opts["id"].endswith("."):
1339         return opts["id"]
1340     return "{0[id]}.{0[append_domain]}".format(opts)
1341 def _read_conf_file(path):
1342     log.debug("Reading configuration from %s", path)
1343     append_file_suffix_YAMLError = False
1344     with salt.utils.files.fopen(path, "r") as conf_file:
1345         try:
1346             conf_opts = salt.utils.yaml.safe_load(conf_file) or {}
1347         except salt.utils.yaml.YAMLError as err:
1348             message = "Error parsing configuration file: {} - {}".format(path, err)
1349             log.error(message)
1350             if path.endswith("_schedule.conf"):
1351                 conf_opts = {}
1352                 append_file_suffix_YAMLError = True
1353             else:
1354                 raise salt.exceptions.SaltConfigurationError(message)
1355     if append_file_suffix_YAMLError:
1356         message = "Renaming to {}".format(path + "YAMLError")
1357         log.error(message)
1358         os.replace(path, path + "YAMLError")
1359     if not isinstance(conf_opts, dict):
1360         message = (
1361             "Error parsing configuration file: {} - conf "
1362             "should be a document, not {}.".format(path, type(conf_opts))
1363         )
1364         log.error(message)
1365         raise salt.exceptions.SaltConfigurationError(message)
1366     if "id" in conf_opts:
1367         if not isinstance(conf_opts["id"], str):
1368             conf_opts["id"] = str(conf_opts["id"])
1369         else:
1370             conf_opts["id"] = salt.utils.data.decode(conf_opts["id"])
1371     return conf_opts
1372 def _absolute_path(path, relative_to=None):
1373     if path and os.path.isabs(path):
1374         return path
1375     if path and relative_to is not None:
1376         _abspath = os.path.join(relative_to, path)
1377         if os.path.isfile(_abspath):
1378             log.debug(
1379                 "Relative path '%s' converted to existing absolute path '%s'",
1380                 path,
1381                 _abspath,
1382             )
1383             return _abspath
1384     return path
1385 def load_config(path, env_var, default_path=None, exit_on_config_errors=True):
1386     if path is None:
1387         return {}
1388     if default_path is None:
1389         import inspect
1390         previous_frame = inspect.getframeinfo(inspect.currentframe().f_back)
1391         log.warning(
1392             "The function '%s()' defined in '%s' is not yet using the "
1393             "new 'default_path' argument to `salt.config.load_config()`. "
1394             "As such, the '%s' environment variable will be ignored",
1395             previous_frame.function,
1396             previous_frame.filename,
1397             env_var,
1398         )
1399         default_path = DEFAULT_MASTER_OPTS["conf_file"]
1400     env_path = os.environ.get(env_var, path)
1401     if not env_path or not os.path.isfile(env_path):
1402         env_path = path
1403     if path != default_path:
1404         env_path = path
1405     path = env_path
1406     if not os.path.isfile(path):
1407         template = "{}.template".format(path)
1408         if os.path.isfile(template):
1409             log.debug("Writing %s based on %s", path, template)
1410             with salt.utils.files.fopen(path, "w") as out:
1411                 with salt.utils.files.fopen(template, "r") as ifile:
1412                     ifile.readline()  # skip first line
1413                     out.write(ifile.read())
1414     opts = {}
1415     if salt.utils.validate.path.is_readable(path):
1416         try:
1417             opts = _read_conf_file(path)
1418             opts["conf_file"] = path
1419         except salt.exceptions.SaltConfigurationError as error:
1420             log.error(error)
1421             if exit_on_config_errors:
1422                 sys.exit(salt.defaults.exitcodes.EX_GENERIC)
1423     else:
1424         log.debug("Missing configuration file: %s", path)
1425     return opts
1426 def include_config(include, orig_path, verbose, exit_on_config_errors=False):
1427     if not include:
1428         return {}
1429     if orig_path is None:
1430         return {}
1431     if isinstance(include, str):
1432         include = [include]
1433     configuration = {}
1434     for path in include:
1435         path = os.path.expanduser(path)
1436         if not os.path.isabs(path):
1437             path = os.path.join(os.path.dirname(orig_path), path)
1438         glob_matches = glob.glob(path)
1439         if not glob_matches:
1440             if verbose:
1441                 log.warning(
1442                     'Warning parsing configuration file: "include" path/glob '
1443                     "'%s' matches no files",
1444                     path,
1445                 )
1446         for fn_ in sorted(glob_matches):
1447             log.debug("Including configuration from '%s'", fn_)
1448             try:
1449                 opts = _read_conf_file(fn_)
1450             except salt.exceptions.SaltConfigurationError as error:
1451                 log.error(error)
1452                 if exit_on_config_errors:
1453                     sys.exit(salt.defaults.exitcodes.EX_GENERIC)
1454                 else:
1455                     opts = {}
1456             schedule = opts.get("schedule", {})
1457             if schedule and "schedule" in configuration:
1458                 configuration["schedule"].update(schedule)
1459             include = opts.get("include", [])
1460             if include:
1461                 opts.update(include_config(include, fn_, verbose))
1462             salt.utils.dictupdate.update(configuration, opts, True, True)
1463     return configuration
1464 def prepend_root_dir(opts, path_options):
1465     root_dir = os.path.abspath(opts["root_dir"])
1466     def_root_dir = salt.syspaths.ROOT_DIR.rstrip(os.sep)
1467     for path_option in path_options:
1468         if path_option in opts:
1469             path = opts[path_option]
1470             tmp_path_def_root_dir = None
1471             tmp_path_root_dir = None
1472             if path == def_root_dir or path.startswith(def_root_dir + os.sep):
1473                 tmp_path_def_root_dir = path[len(def_root_dir) :]
1474             if root_dir and (path == root_dir or path.startswith(root_dir + os.sep)):
1475                 tmp_path_root_dir = path[len(root_dir) :]
1476             if tmp_path_def_root_dir and not tmp_path_root_dir:
1477                 path = tmp_path_def_root_dir
1478             elif tmp_path_root_dir and not tmp_path_def_root_dir:
1479                 path = tmp_path_root_dir
1480             elif tmp_path_def_root_dir and tmp_path_root_dir:
1481                 if def_root_dir in root_dir:
1482                     path = tmp_path_root_dir
1483                 else:
1484                     path = tmp_path_def_root_dir
1485             elif salt.utils.platform.is_windows() and not os.path.splitdrive(path)[0]:
1486                 pass
1487             elif os.path.isabs(path):
1488                 continue
1489             opts[path_option] = salt.utils.path.join(root_dir, path)
1490 def insert_system_path(opts, paths):
1491     if isinstance(paths, str):
1492         paths = [paths]
1493     for path in paths:
1494         path_options = {"path": path, "root_dir": opts["root_dir"]}
1495         prepend_root_dir(path_options, path_options)
1496         if os.path.isdir(path_options["path"]) and path_options["path"] not in sys.path:
1497             sys.path.insert(0, path_options["path"])
1498 def minion_config(
1499     path,
1500     env_var="SALT_MINION_CONFIG",
1501     defaults=None,
1502     cache_minion_id=False,
1503     ignore_config_errors=True,
1504     minion_id=None,
1505     role="minion",
1506 ):
1507     if defaults is None:
1508         defaults = DEFAULT_MINION_OPTS.copy()
1509     if not os.environ.get(env_var, None):
1510         salt_config_dir = os.environ.get("SALT_CONFIG_DIR", None)
1511         if salt_config_dir:
1512             env_config_file_path = os.path.join(salt_config_dir, "minion")
1513             if salt_config_dir and os.path.isfile(env_config_file_path):
1514                 os.environ[env_var] = env_config_file_path
1515     overrides = load_config(path, env_var, DEFAULT_MINION_OPTS["conf_file"])
1516     default_include = overrides.get("default_include", defaults["default_include"])
1517     include = overrides.get("include", [])
1518     overrides.update(
1519         include_config(
1520             default_include,
1521             path,
1522             verbose=False,
1523             exit_on_config_errors=not ignore_config_errors,
1524         )
1525     )
1526     overrides.update(
1527         include_config(
1528             include, path, verbose=True, exit_on_config_errors=not ignore_config_errors
1529         )
1530     )
1531     opts = apply_minion_config(
1532         overrides, defaults, cache_minion_id=cache_minion_id, minion_id=minion_id
1533     )
1534     opts["__role"] = role
1535     if role != "master":
1536         apply_sdb(opts)
1537         _validate_opts(opts)
1538     return opts
1539 def mminion_config(path, overrides, ignore_config_errors=True):
1540     opts = minion_config(path, ignore_config_errors=ignore_config_errors, role="master")
1541     opts.update(overrides)
1542     apply_sdb(opts)
1543     _validate_opts(opts)
1544     opts["grains"] = salt.loader.grains(opts)
1545     opts["pillar"] = {}
1546     return opts
1547 def proxy_config(
1548     path,
1549     env_var="SALT_PROXY_CONFIG",
1550     defaults=None,
1551     cache_minion_id=False,
1552     ignore_config_errors=True,
1553     minion_id=None,
1554 ):
1555     if defaults is None:
1556         defaults = DEFAULT_MINION_OPTS.copy()
1557     defaults.update(DEFAULT_PROXY_MINION_OPTS)
1558     if not os.environ.get(env_var, None):
1559         salt_config_dir = os.environ.get("SALT_CONFIG_DIR", None)
1560         if salt_config_dir:
1561             env_config_file_path = os.path.join(salt_config_dir, "proxy")
1562             if salt_config_dir and os.path.isfile(env_config_file_path):
1563                 os.environ[env_var] = env_config_file_path
1564     overrides = load_config(path, env_var, DEFAULT_PROXY_MINION_OPTS["conf_file"])
1565     default_include = overrides.get("default_include", defaults["default_include"])
1566     include = overrides.get("include", [])
1567     overrides.update(
1568         include_config(
1569             default_include,
1570             path,
1571             verbose=False,
1572             exit_on_config_errors=not ignore_config_errors,
1573         )
1574     )
1575     overrides.update(
1576         include_config(
1577             include, path, verbose=True, exit_on_config_errors=not ignore_config_errors
1578         )
1579     )
1580     opts = apply_minion_config(
1581         overrides, defaults, cache_minion_id=cache_minion_id, minion_id=minion_id
1582     )
1583     default_include = opts.get("default_include", defaults["default_include"])
1584     include = opts.get("include", [])
1585     overrides.update(
1586         include_config(
1587             default_include,
1588             path,
1589             verbose=False,
1590             exit_on_config_errors=not ignore_config_errors,
1591         )
1592     )
1593     overrides.update(
1594         include_config(
1595             include, path, verbose=True, exit_on_config_errors=not ignore_config_errors
1596         )
1597     )
1598     opts = apply_minion_config(
1599         overrides, defaults, cache_minion_id=cache_minion_id, minion_id=minion_id
1600     )
1601     apply_sdb(opts)
1602     _validate_opts(opts)
1603     return opts
1604 def syndic_config(
1605     master_config_path,
1606     minion_config_path,
1607     master_env_var="SALT_MASTER_CONFIG",
1608     minion_env_var="SALT_MINION_CONFIG",
1609     minion_defaults=None,
1610     master_defaults=None,
1611 ):
1612     if minion_defaults is None:
1613         minion_defaults = DEFAULT_MINION_OPTS.copy()
1614     if master_defaults is None:
1615         master_defaults = DEFAULT_MASTER_OPTS.copy()
1616     opts = {}
1617     master_opts = master_config(master_config_path, master_env_var, master_defaults)
1618     minion_opts = minion_config(minion_config_path, minion_env_var, minion_defaults)
1619     opts["_minion_conf_file"] = master_opts["conf_file"]
1620     opts["_master_conf_file"] = minion_opts["conf_file"]
1621     opts.update(master_opts)
1622     opts.update(minion_opts)
1623     syndic_opts = {
1624         "__role": "syndic",
1625         "root_dir": opts.get("root_dir", salt.syspaths.ROOT_DIR),
1626         "pidfile": opts.get("syndic_pidfile", "salt-syndic.pid"),
1627         "log_file": opts.get("syndic_log_file", "salt-syndic.log"),
1628         "log_level": master_opts["log_level"],
1629         "id": minion_opts["id"],
1630         "pki_dir": minion_opts["pki_dir"],
1631         "master": opts["syndic_master"],
1632         "interface": master_opts["interface"],
1633         "master_port": int(
1634             opts.get(
1635                 "syndic_master_port",
1636                 opts.get(
1637                     "master_port",
1638                     minion_defaults.get(
1639                         "master_port",
1640                         DEFAULT_MINION_OPTS["master_port"],
1641                     ),
1642                 ),
1643             )
1644         ),
1645         "user": opts.get("syndic_user", opts["user"]),
1646         "sock_dir": os.path.join(
1647             opts["cachedir"], opts.get("syndic_sock_dir", opts["sock_dir"])
1648         ),
1649         "sock_pool_size": master_opts["sock_pool_size"],
1650         "cachedir": master_opts["cachedir"],
1651     }
1652     opts.update(syndic_opts)
1653     prepend_root_dirs = [
1654         "pki_dir",
1655         "cachedir",
1656         "pidfile",
1657         "sock_dir",
1658         "extension_modules",
1659         "autosign_file",
1660         "autoreject_file",
1661         "token_dir",
1662         "autosign_grains_dir",
1663     ]
1664     for config_key in ("log_file", "key_logfile", "syndic_log_file"):
1665         if urllib.parse.urlparse(opts.get(config_key, "")).scheme == "":
1666             prepend_root_dirs.append(config_key)
1667     prepend_root_dir(opts, prepend_root_dirs)
1668     return opts
1669 def apply_sdb(opts, sdb_opts=None):
1670     import salt.utils.sdb
1671     if sdb_opts is None:
1672         sdb_opts = opts
1673     if isinstance(sdb_opts, str) and sdb_opts.startswith("sdb://"):
1674         return salt.utils.sdb.sdb_get(sdb_opts, opts)
1675     elif isinstance(sdb_opts, dict):
1676         for key, value in sdb_opts.items():
1677             if value is None:
1678                 continue
1679             sdb_opts[key] = apply_sdb(opts, value)
1680     elif isinstance(sdb_opts, list):
1681         for key, value in enumerate(sdb_opts):
1682             if value is None:
1683                 continue
1684             sdb_opts[key] = apply_sdb(opts, value)
1685     return sdb_opts
1686 def cloud_config(
1687     path,
1688     env_var="SALT_CLOUD_CONFIG",
1689     defaults=None,
1690     master_config_path=None,
1691     master_config=None,
1692     providers_config_path=None,
1693     providers_config=None,
1694     profiles_config_path=None,
1695     profiles_config=None,
1696 ):
1697     if path:
1698         config_dir = os.path.dirname(path)
1699     else:
1700         config_dir = salt.syspaths.CONFIG_DIR
1701     overrides = load_config(path, env_var, os.path.join(config_dir, "cloud"))
1702     if defaults is None:
1703         defaults = DEFAULT_CLOUD_OPTS.copy()
1704     defaults.update(overrides)
1705     overrides = defaults
1706     overrides.update(
1707         salt.config.include_config(overrides["default_include"], path, verbose=False)
1708     )
1709     include = overrides.get("include", [])
1710     overrides.update(salt.config.include_config(include, path, verbose=True))
1711     if "master_config" in overrides and master_config_path is None:
1712         master_config_path = overrides["master_config"]
1713     elif (
1714         "master_config" not in overrides
1715         and not master_config
1716         and not master_config_path
1717     ):
1718         master_config_path = os.path.join(config_dir, "master")
1719     master_config_path = _absolute_path(master_config_path, config_dir)
1720     if "providers_config" in overrides and providers_config_path is None:
1721         providers_config_path = overrides["providers_config"]
1722     elif (
1723         "providers_config" not in overrides
1724         and not providers_config
1725         and not providers_config_path
1726     ):
1727         providers_config_path = os.path.join(config_dir, "cloud.providers")
1728     providers_config_path = _absolute_path(providers_config_path, config_dir)
1729     if "profiles_config" in overrides and profiles_config_path is None:
1730         profiles_config_path = overrides["profiles_config"]
1731     elif (
1732         "profiles_config" not in overrides
1733         and not profiles_config
1734         and not profiles_config_path
1735     ):
1736         profiles_config_path = os.path.join(config_dir, "cloud.profiles")
1737     profiles_config_path = _absolute_path(profiles_config_path, config_dir)
1738     deploy_scripts_search_path = overrides.get(
1739         "deploy_scripts_search_path",
1740         defaults.get("deploy_scripts_search_path", "cloud.deploy.d"),
1741     )
1742     if isinstance(deploy_scripts_search_path, str):
1743         deploy_scripts_search_path = [deploy_scripts_search_path]
1744     for idx, entry in enumerate(deploy_scripts_search_path[:]):
1745         if not os.path.isabs(entry):
1746             entry = os.path.join(os.path.dirname(path), entry)
1747         if os.path.isdir(entry):
1748             deploy_scripts_search_path[idx] = entry
1749             continue
1750 <a name="3"></a>        deploy_scripts_search_path.pop(idx)
1751     deploy_scripts_search_path<font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.append(
1752         os.path.abspath(
1753             os.path.join(os.path.dirname(__file__), "..", "cloud", "deploy")
1754         )
1755     )
1756     overrides.</b></font>update(deploy_scripts_search_path=tuple(deploy_scripts_search_path))
1757     if master_config_path is not None and master_config is not None:
1758         raise salt.exceptions.SaltCloudConfigError(
1759             "Only pass `master_config` or `master_config_path`, not both."
1760         )
1761     elif master_config_path is None and master_config is None:
1762         master_config = salt.config.master_config(
1763             overrides.get(
1764                 "master_config",
1765                 os.path.join(salt.syspaths.CONFIG_DIR, "master"),
1766             )
1767         )
1768     elif master_config_path is not None and master_config is None:
1769         master_config = salt.config.master_config(master_config_path)
1770     del master_config["cachedir"]
1771     master_config.update(overrides)
1772     overrides = master_config
1773     if providers_config_path is not None and providers_config is not None:
1774         raise salt.exceptions.SaltCloudConfigError(
1775             "Only pass `providers_config` or `providers_config_path`, not both."
1776         )
1777     elif providers_config_path is None and providers_config is None:
1778         providers_config_path = overrides.get(
1779             "providers_config",
1780             os.path.join(salt.syspaths.CONFIG_DIR, "cloud.providers"),
1781         )
1782     if profiles_config_path is not None and profiles_config is not None:
1783         raise salt.exceptions.SaltCloudConfigError(
1784             "Only pass `profiles_config` or `profiles_config_path`, not both."
1785         )
1786     elif profiles_config_path is None and profiles_config is None:
1787         profiles_config_path = overrides.get(
1788             "profiles_config",
1789             os.path.join(salt.syspaths.CONFIG_DIR, "cloud.profiles"),
1790         )
1791     opts = apply_cloud_config(overrides, defaults)
1792     if "providers" in opts:
1793         if providers_config is not None:
1794             raise salt.exceptions.SaltCloudConfigError(
1795                 "Do not mix the old cloud providers configuration with "
1796                 "the passing a pre-configured providers configuration "
1797                 "dictionary."
1798             )
1799         if providers_config_path is not None:
1800             providers_confd = os.path.join(
1801                 os.path.dirname(providers_config_path), "cloud.providers.d", "*"
1802             )
1803             if os.path.isfile(providers_config_path) or glob.glob(providers_confd):
1804                 raise salt.exceptions.SaltCloudConfigError(
1805                     "Do not mix the old cloud providers configuration with "
1806                     "the new one. The providers configuration should now go "
1807                     "in the file `{0}` or a separate `*.conf` file within "
1808                     "`cloud.providers.d/` which is relative to `{0}`.".format(
1809                         os.path.join(salt.syspaths.CONFIG_DIR, "cloud.providers")
1810                     )
1811                 )
1812         providers_config = opts["providers"]
1813     elif providers_config_path is not None:
1814         providers_config = cloud_providers_config(providers_config_path)
1815     opts["providers"] = providers_config
1816     if profiles_config is None:
1817         profiles_config = vm_profiles_config(profiles_config_path, providers_config)
1818     opts["profiles"] = profiles_config
1819     apply_sdb(opts)
1820     prepend_root_dirs = ["cachedir"]
1821     if "log_file" in opts and urllib.parse.urlparse(opts["log_file"]).scheme == "":
1822         prepend_root_dirs.append(opts["log_file"])
1823     prepend_root_dir(opts, prepend_root_dirs)
1824     return opts
1825 def apply_cloud_config(overrides, defaults=None):
1826     if defaults is None:
1827         defaults = DEFAULT_CLOUD_OPTS.copy()
1828     config = defaults.copy()
1829     if overrides:
1830         config.update(overrides)
1831     if "providers" in config:
1832         providers = config["providers"].copy()
1833         config["providers"] = {}
1834         for alias, details in providers.items():
1835             if isinstance(details, list):
1836                 for detail in details:
1837                     if "driver" not in detail:
1838                         raise salt.exceptions.SaltCloudConfigError(
1839                             "The cloud provider alias '{}' has an entry "
1840                             "missing the required setting of 'driver'.".format(alias)
1841                         )
1842                     driver = detail["driver"]
1843                     if ":" in driver:
1844                         alias, driver = driver.split(":")
1845                     if alias not in config["providers"]:
1846                         config["providers"][alias] = {}
1847                     detail["provider"] = "{}:{}".format(alias, driver)
1848                     config["providers"][alias][driver] = detail
1849             elif isinstance(details, dict):
1850                 if "driver" not in details:
1851                     raise salt.exceptions.SaltCloudConfigError(
1852                         "The cloud provider alias '{}' has an entry "
1853                         "missing the required setting of 'driver'".format(alias)
1854                     )
1855                 driver = details["driver"]
1856                 if ":" in driver:
1857                     alias, driver = driver.split(":")
1858                 if alias not in config["providers"]:
1859                     config["providers"][alias] = {}
1860                 details["provider"] = "{}:{}".format(alias, driver)
1861                 config["providers"][alias][driver] = details
1862     config = old_to_new(config)
1863     return config
1864 def old_to_new(opts):
1865     providers = (
1866         "AWS",
1867         "CLOUDSTACK",
1868         "DIGITALOCEAN",
1869         "EC2",
1870         "GOGRID",
1871         "IBMSCE",
1872         "JOYENT",
1873         "LINODE",
1874         "OPENSTACK",
1875         "PARALLELS",
1876         "RACKSPACE",
1877         "SALTIFY",
1878     )
1879     for provider in providers:
1880         provider_config = {}
1881         for opt, val in opts.items():
1882             if provider in opt:
1883                 value = val
1884                 name = opt.split(".", 1)[1]
1885                 provider_config[name] = value
1886         lprovider = provider.lower()
1887         if provider_config:
1888             provider_config["provider"] = lprovider
1889             opts.setdefault("providers", {})
1890             opts["providers"][lprovider] = {}
1891             opts["providers"][lprovider][lprovider] = provider_config
1892     return opts
1893 def vm_profiles_config(path, providers, env_var="SALT_CLOUDVM_CONFIG", defaults=None):
1894     if defaults is None:
1895         defaults = VM_CONFIG_DEFAULTS
1896     overrides = salt.config.load_config(
1897         path, env_var, os.path.join(salt.syspaths.CONFIG_DIR, "cloud.profiles")
1898     )
1899     default_include = overrides.get("default_include", defaults["default_include"])
1900     include = overrides.get("include", [])
1901     overrides.update(salt.config.include_config(default_include, path, verbose=False))
1902     overrides.update(salt.config.include_config(include, path, verbose=True))
1903     return apply_vm_profiles_config(providers, overrides, defaults)
1904 def apply_vm_profiles_config(providers, overrides, defaults=None):
1905     if defaults is None:
1906         defaults = VM_CONFIG_DEFAULTS
1907     config = defaults.copy()
1908     if overrides:
1909         config.update(overrides)
1910     vms = {}
1911     for key, val in config.items():
1912         if key in ("conf_file", "include", "default_include", "user"):
1913             continue
1914         if not isinstance(val, dict):
1915             raise salt.exceptions.SaltCloudConfigError(
1916                 "The VM profiles configuration found in '{0[conf_file]}' is "
1917                 "not in the proper format".format(config)
1918             )
1919         val["profile"] = key
1920         vms[key] = val
1921     for profile, details in vms.copy().items():
1922         if "extends" not in details:
1923             if ":" in details["provider"]:
1924                 alias, driver = details["provider"].split(":")
1925                 if alias not in providers or driver not in providers[alias]:
1926                     log.trace(
1927                         "The profile '%s' is defining '%s' "
1928                         "as the provider. Since there is no valid "
1929                         "configuration for that provider, the profile will be "
1930                         "removed from the available listing",
1931                         profile,
1932                         details["provider"],
1933                     )
1934                     vms.pop(profile)
1935                     continue
1936                 if "profiles" not in providers[alias][driver]:
1937                     providers[alias][driver]["profiles"] = {}
1938                 providers[alias][driver]["profiles"][profile] = details
1939             if details["provider"] not in providers:
1940                 log.trace(
1941                     "The profile '%s' is defining '%s' as the "
1942                     "provider. Since there is no valid configuration for "
1943                     "that provider, the profile will be removed from the "
1944                     "available listing",
1945                     profile,
1946                     details["provider"],
1947                 )
1948                 vms.pop(profile)
1949                 continue
1950             driver = next(iter(list(providers[details["provider"]].keys())))
1951             providers[details["provider"]][driver].setdefault("profiles", {}).update(
1952                 {profile: details}
1953             )
1954             details["provider"] = "{0[provider]}:{1}".format(details, driver)
1955             vms[profile] = details
1956             continue
1957         extends = details.pop("extends")
1958         if extends not in vms:
1959             log.error(
1960                 "The '%s' profile is trying to extend data from '%s' "
1961                 "though '%s' is not defined in the salt profiles loaded "
1962                 "data. Not extending and removing from listing!",
1963                 profile,
1964                 extends,
1965                 extends,
1966             )
1967             vms.pop(profile)
1968             continue
1969         extended = deepcopy(vms.get(extends))
1970         extended.pop("profile")
1971         extended = salt.utils.dictupdate.update(extended, details)
1972         if ":" not in extended["provider"]:
1973             if extended["provider"] not in providers:
1974                 log.trace(
1975                     "The profile '%s' is defining '%s' as the "
1976                     "provider. Since there is no valid configuration for "
1977                     "that provider, the profile will be removed from the "
1978                     "available listing",
1979                     profile,
1980                     extended["provider"],
1981                 )
1982                 vms.pop(profile)
1983                 continue
1984             driver = next(iter(list(providers[extended["provider"]].keys())))
1985             providers[extended["provider"]][driver].setdefault("profiles", {}).update(
1986                 {profile: extended}
1987             )
1988             extended["provider"] = "{0[provider]}:{1}".format(extended, driver)
1989         else:
1990             alias, driver = extended["provider"].split(":")
1991             if alias not in providers or driver not in providers[alias]:
1992                 log.trace(
1993                     "The profile '%s' is defining '%s' as "
1994                     "the provider. Since there is no valid configuration "
1995                     "for that provider, the profile will be removed from "
1996                     "the available listing",
1997                     profile,
1998                     extended["provider"],
1999                 )
2000                 vms.pop(profile)
2001                 continue
2002             providers[alias][driver].setdefault("profiles", {}).update(
2003                 {profile: extended}
2004             )
2005         vms[profile] = extended
2006     return vms
2007 def cloud_providers_config(path, env_var="SALT_CLOUD_PROVIDERS_CONFIG", defaults=None):
2008     if defaults is None:
2009         defaults = PROVIDER_CONFIG_DEFAULTS
2010     overrides = salt.config.load_config(
2011         path, env_var, os.path.join(salt.syspaths.CONFIG_DIR, "cloud.providers")
2012     )
2013     default_include = overrides.get("default_include", defaults["default_include"])
2014     include = overrides.get("include", [])
2015     overrides.update(salt.config.include_config(default_include, path, verbose=False))
2016     overrides.update(salt.config.include_config(include, path, verbose=True))
2017     return apply_cloud_providers_config(overrides, defaults)
2018 def apply_cloud_providers_config(overrides, defaults=None):
2019     if defaults is None:
2020         defaults = PROVIDER_CONFIG_DEFAULTS
2021     config = defaults.copy()
2022     if overrides:
2023         config.update(overrides)
2024     for name, settings in config.copy().items():
2025         if "." in name:
2026             log.warning("Please switch to the new providers configuration syntax")
2027             config = old_to_new(config)
2028             for prov_name, prov_settings in config.pop("providers").items():
2029                 config[prov_name] = prov_settings
2030             break
2031     providers = {}
2032     ext_count = 0
2033     for key, val in config.items():
2034         if key in ("conf_file", "include", "default_include", "user"):
2035             continue
2036         if not isinstance(val, (list, tuple)):
2037             val = [val]
2038         else:
2039             handled_providers = set()
2040             for details in val:
2041                 if "driver" not in details:
2042                     if "extends" not in details:
2043                         log.error(
2044                             "Please check your cloud providers configuration. "
2045                             "There's no 'driver' nor 'extends' definition "
2046                             "referenced."
2047                         )
2048                     continue
2049                 if details["driver"] in handled_providers:
2050                     log.error(
2051                         "You can only have one entry per cloud provider. For "
2052                         "example, if you have a cloud provider configuration "
2053                         "section named, 'production', you can only have a "
2054                         "single entry for EC2, Joyent, Openstack, and so "
2055                         "forth."
2056                     )
2057                     raise salt.exceptions.SaltCloudConfigError(
2058                         "The cloud provider alias '{0}' has multiple entries "
2059                         "for the '{1[driver]}' driver.".format(key, details)
2060                     )
2061                 handled_providers.add(details["driver"])
2062         for entry in val:
2063             if "driver" not in entry:
2064                 entry["driver"] = "-only-extendable-{}".format(ext_count)
2065                 ext_count += 1
2066             if key not in providers:
2067                 providers[key] = {}
2068             provider = entry["driver"]
2069             if provider not in providers[key]:
2070                 providers[key][provider] = entry
2071     while True:
2072         keep_looping = False
2073         for provider_alias, entries in providers.copy().items():
2074             for driver, details in entries.items():
2075                 providers[provider_alias][driver]["profiles"] = {}
2076                 if "extends" not in details:
2077                     continue
2078                 extends = details.pop("extends")
2079                 if ":" in extends:
2080                     alias, provider = extends.split(":")
2081                     if alias not in providers:
2082                         raise salt.exceptions.SaltCloudConfigError(
2083                             "The '{0}' cloud provider entry in '{1}' is "
2084                             "trying to extend data from '{2}' though "
2085                             "'{2}' is not defined in the salt cloud "
2086                             "providers loaded data.".format(
2087                                 details["driver"], provider_alias, alias
2088                             )
2089                         )
2090                     if provider not in providers.get(alias):
2091                         raise salt.exceptions.SaltCloudConfigError(
2092                             "The '{0}' cloud provider entry in '{1}' is "
2093                             "trying to extend data from '{2}:{3}' though "
2094                             "'{3}' is not defined in '{1}'".format(
2095                                 details["driver"], provider_alias, alias, provider
2096                             )
2097                         )
2098                     details["extends"] = "{}:{}".format(alias, provider)
2099                     details["driver"] = provider
2100                 elif providers.get(extends):
2101                     raise salt.exceptions.SaltCloudConfigError(
2102                         "The '{}' cloud provider entry in '{}' is "
2103                         "trying to extend from '{}' and no provider was "
2104                         "specified. Not extending!".format(
2105                             details["driver"], provider_alias, extends
2106                         )
2107                     )
2108                 elif extends not in providers:
2109                     raise salt.exceptions.SaltCloudConfigError(
2110                         "The '{0}' cloud provider entry in '{1}' is "
2111                         "trying to extend data from '{2}' though '{2}' "
2112                         "is not defined in the salt cloud providers loaded "
2113                         "data.".format(details["driver"], provider_alias, extends)
2114                     )
2115                 else:
2116                     if driver in providers.get(extends):
2117                         details["extends"] = "{}:{}".format(extends, driver)
2118                     elif "-only-extendable-" in providers.get(extends):
2119                         details["extends"] = "{}:{}".format(
2120                             extends, "-only-extendable-{}".format(ext_count)
2121                         )
2122                     else:
2123                         details["extends"] = extends
2124                         keep_looping = True
2125         if not keep_looping:
2126             break
2127     while True:
2128         keep_looping = False
2129         for alias, entries in providers.copy().items():
2130             for driver in list(entries.keys()):
2131                 details = entries[driver]
2132                 if "extends" not in details:
2133                     continue
2134                 if "extends" in details["extends"]:
2135                     keep_looping = True
2136                     continue
2137                 extends = details.pop("extends")
2138                 ext_alias, ext_driver = extends.split(":")
2139                 extended = providers.get(ext_alias).get(ext_driver).copy()
2140                 extended = salt.utils.dictupdate.update(extended, details)
2141                 providers[alias][driver] = extended
2142                 if driver.startswith("-only-extendable-"):
2143                     providers[alias][ext_driver] = providers[alias][driver]
2144                     del providers[alias][driver]
2145         if not keep_looping:
2146             break
2147     for provider_alias, entries in providers.copy().items():
2148         for driver, details in entries.copy().items():
2149             if not driver.startswith("-only-extendable-"):
2150                 continue
2151             log.info(
2152                 "There's at least one cloud driver under the '%s' "
2153                 "cloud provider alias which does not have the required "
2154                 "'driver' setting. Removing it from the available "
2155                 "providers listing.",
2156                 provider_alias,
2157             )
2158             providers[provider_alias].pop(driver)
2159         if not providers[provider_alias]:
2160             providers.pop(provider_alias)
2161     return providers
2162 def get_cloud_config_value(name, vm_, opts, default=None, search_global=True):
2163     value = default
2164     if search_global is True and opts.get(name, None) is not None:
2165         value = deepcopy(opts[name])
2166     if vm_ and name:
2167         if "profile" in vm_ and vm_["profile"] is not None:
2168             if name in opts["profiles"][vm_["profile"]]:
2169                 if isinstance(value, dict):
2170                     value.update(opts["profiles"][vm_["profile"]][name].copy())
2171                 else:
2172                     value = deepcopy(opts["profiles"][vm_["profile"]][name])
2173         if ":" in vm_["driver"]:
2174             alias, driver = vm_["driver"].split(":")
2175             if alias in opts["providers"] and driver in opts["providers"][alias]:
2176                 details = opts["providers"][alias][driver]
2177                 if name in details:
2178                     if isinstance(value, dict):
2179                         value.update(details[name].copy())
2180                     else:
2181                         value = deepcopy(details[name])
2182         elif len(opts["providers"].get(vm_["driver"], ())) &gt; 1:
2183             log.error(
2184                 "The '%s' cloud provider definition has more than one "
2185                 "entry. Your VM configuration should be specifying the "
2186                 "provider as 'driver: %s:&lt;driver-engine&gt;'. Since "
2187                 "it's not, we're returning the first definition which "
2188                 "might not be what you intended.",
2189                 vm_["driver"],
2190                 vm_["driver"],
2191             )
2192         if vm_["driver"] in opts["providers"]:
2193             alias_defs = opts["providers"].get(vm_["driver"])
2194             provider_driver_defs = alias_defs[next(iter(list(alias_defs.keys())))]
2195             if name in provider_driver_defs:
2196                 if isinstance(value, dict):
2197                     value.update(provider_driver_defs[name].copy())
2198                 else:
2199                     value = deepcopy(provider_driver_defs[name])
2200     if name and vm_ and name in vm_:
2201         if isinstance(vm_[name], types.GeneratorType):
2202             value = next(vm_[name], "")
2203         else:
2204             if isinstance(value, dict) and isinstance(vm_[name], dict):
2205                 value.update(vm_[name].copy())
2206             else:
2207                 value = deepcopy(vm_[name])
2208     return value
2209 def is_provider_configured(
2210     opts, provider, required_keys=(), log_message=True, aliases=()
2211 ):
2212     if ":" in provider:
2213         alias, driver = provider.split(":")
2214         if alias not in opts["providers"]:
2215             return False
2216         if driver not in opts["providers"][alias]:
2217             return False
2218         for key in required_keys:
2219             if opts["providers"][alias][driver].get(key, None) is None:
2220                 if log_message is True:
2221                     log.warning(
2222                         "The required '%s' configuration setting is missing "
2223                         "from the '%s' driver, which is configured under the "
2224                         "'%s' alias.",
2225                         key,
2226                         provider,
2227                         alias,
2228                     )
2229                 return False
2230         return opts["providers"][alias][driver]
2231     for alias, drivers in opts["providers"].items():
2232         for driver, provider_details in drivers.items():
2233             if driver != provider and driver not in aliases:
2234                 continue
2235             skip_provider = False
2236             for key in required_keys:
2237                 if provider_details.get(key, None) is None:
2238                     if log_message is True:
2239                         log.warning(
2240                             "The required '%s' configuration setting is "
2241                             "missing from the '%s' driver, which is configured "
2242                             "under the '%s' alias.",
2243                             key,
2244                             provider,
2245                             alias,
2246                         )
2247                     skip_provider = True
2248                     break
2249             if skip_provider:
2250                 continue
2251             return provider_details
2252     return False
2253 def is_profile_configured(opts, provider, profile_name, vm_=None):
2254     required_keys = ["provider"]
2255     alias, driver = provider.split(":")
2256     non_image_drivers = [
2257         "nova",
2258         "virtualbox",
2259         "libvirt",
2260         "softlayer",
2261         "oneandone",
2262         "profitbricks",
2263     ]
2264     non_size_drivers = [
2265         "opennebula",
2266         "parallels",
2267         "proxmox",
2268         "scaleway",
2269         "softlayer",
2270         "softlayer_hw",
2271         "vmware",
2272         "vsphere",
2273         "virtualbox",
2274         "libvirt",
2275         "oneandone",
2276         "profitbricks",
2277     ]
2278     provider_key = opts["providers"][alias][driver]
2279     profile_key = opts["providers"][alias][driver]["profiles"][profile_name]
2280     if driver == "linode" and profile_key.get("clonefrom", False):
2281         non_image_drivers.append("linode")
2282         non_size_drivers.append("linode")
2283     elif driver == "gce" and "sourceImage" in str(vm_.get("ex_disks_gce_struct")):
2284         non_image_drivers.append("gce")
2285     if driver == "vmware" and "image" not in list(profile_key.keys()):
2286         non_image_drivers.append("vmware")
2287     if driver not in non_image_drivers:
2288         required_keys.append("image")
2289         if driver == "vmware":
2290             required_keys.append("datastore")
2291     elif driver in ["linode", "virtualbox"]:
2292         required_keys.append("clonefrom")
2293     elif driver == "nova":
2294         nova_image_keys = [
2295             "image",
2296             "block_device_mapping",
2297             "block_device",
2298             "boot_volume",
2299         ]
2300         if not any([key in provider_key for key in nova_image_keys]) and not any(
2301             [key in profile_key for key in nova_image_keys]
2302         ):
2303             required_keys.extend(nova_image_keys)
2304     if driver not in non_size_drivers:
2305         required_keys.append("size")
2306     for item in list(required_keys):
2307         if item in provider_key:
2308             required_keys.remove(item)
2309     if vm_:
2310         for item in list(required_keys):
2311             if item in vm_:
2312                 required_keys.remove(item)
2313     for item in required_keys:
2314         if profile_key.get(item, None) is None:
2315             log.error(
2316                 "The required '%s' configuration setting is missing from "
2317                 "the '%s' profile, which is configured under the '%s' alias.",
2318                 item,
2319                 profile_name,
2320                 alias,
2321             )
2322             return False
2323     return True
2324 def check_driver_dependencies(driver, dependencies):
2325     ret = True
2326     for key, value in dependencies.items():
2327         if value is False:
2328             log.warning(
2329                 "Missing dependency: '%s'. The %s driver requires "
2330                 "'%s' to be installed.",
2331                 key,
2332                 driver,
2333                 key,
2334             )
2335             ret = False
2336     return ret
2337 def _cache_id(minion_id, cache_file):
2338     path = os.path.dirname(cache_file)
2339     try:
2340         if not os.path.isdir(path):
2341             os.makedirs(path)
2342     except OSError as exc:
2343         if os.path.isdir(path):
2344             pass
2345         else:
2346             log.error("Failed to create dirs to minion_id file: %s", exc)
2347     try:
2348         with salt.utils.files.fopen(cache_file, "w") as idf:
2349             idf.write(minion_id)
2350     except OSError as exc:
2351         log.error("Could not cache minion ID: %s", exc)
2352 def call_id_function(opts):
2353     if opts.get("id"):
2354         return opts["id"]
2355     import salt.loader as loader
2356     if isinstance(opts["id_function"], str):
2357         mod_fun = opts["id_function"]
2358         fun_kwargs = {}
2359     elif isinstance(opts["id_function"], dict):
2360         mod_fun, fun_kwargs = next(iter(opts["id_function"].items()))
2361         if fun_kwargs is None:
2362             fun_kwargs = {}
2363     else:
2364         log.error("'id_function' option is neither a string nor a dictionary")
2365         sys.exit(salt.defaults.exitcodes.EX_GENERIC)
2366     mod, fun = mod_fun.split(".")
2367     if not opts.get("grains"):
2368         opts["grains"] = loader.grains(opts)
2369     try:
2370         id_mod = loader.raw_mod(opts, mod, fun)
2371         if not id_mod:
2372             raise KeyError
2373         newid = id_mod[mod_fun](**fun_kwargs)
2374         if not isinstance(newid, str) or not newid:
2375             log.error(
2376                 'Function %s returned value "%s" of type %s instead of string',
2377                 mod_fun,
2378                 newid,
2379                 type(newid),
2380             )
2381             sys.exit(salt.defaults.exitcodes.EX_GENERIC)
2382         log.info("Evaluated minion ID from module: %s %s", mod_fun, newid)
2383         return newid
2384     except TypeError:
2385         log.error(
2386             "Function arguments %s are incorrect for function %s", fun_kwargs, mod_fun
2387         )
2388         sys.exit(salt.defaults.exitcodes.EX_GENERIC)
2389     except KeyError:
2390         log.error("Failed to load module %s", mod_fun)
2391         sys.exit(salt.defaults.exitcodes.EX_GENERIC)
2392 def remove_domain_from_fqdn(opts, newid):
2393     opt_domain = opts.get("minion_id_remove_domain")
2394     if opt_domain is True:
2395         if "." in newid:
2396             newid, xdomain = newid.split(".", 1)
2397             log.debug("Removed any domain (%s) from minion id.", xdomain)
2398     else:
2399         if newid.upper().endswith("." + opt_domain.upper()):
2400             newid = newid[: -len("." + opt_domain)]
2401             log.debug("Removed single domain %s from minion id.", opt_domain)
2402     return newid
2403 def get_id(opts, cache_minion_id=False):
2404     if opts["root_dir"] is None:
2405         root_dir = salt.syspaths.ROOT_DIR
2406     else:
2407         root_dir = opts["root_dir"]
2408     config_dir = salt.syspaths.CONFIG_DIR
2409     if config_dir.startswith(salt.syspaths.ROOT_DIR):
2410         config_dir = config_dir.split(salt.syspaths.ROOT_DIR, 1)[-1]
2411     id_cache = os.path.join(root_dir, config_dir.lstrip(os.path.sep), "minion_id")
2412     if opts.get("minion_id_caching", True):
2413         try:
2414             with salt.utils.files.fopen(id_cache) as idf:
2415                 name = salt.utils.stringutils.to_unicode(idf.readline().strip())
2416                 bname = salt.utils.stringutils.to_bytes(name)
2417                 if bname.startswith(codecs.BOM):  # Remove BOM if exists
2418                     name = salt.utils.stringutils.to_str(
2419                         bname.replace(codecs.BOM, "", 1)
2420                     )
2421             if name and name != "localhost":
2422                 log.debug("Using cached minion ID from %s: %s", id_cache, name)
2423                 return name, False
2424         except OSError:
2425             pass
2426     if "__role" in opts and opts.get("__role") == "minion":
2427         log.debug(
2428             "Guessing ID. The id can be explicitly set in %s",
2429             os.path.join(salt.syspaths.CONFIG_DIR, "minion"),
2430         )
2431     if opts.get("id_function"):
2432         newid = call_id_function(opts)
2433     else:
2434         newid = salt.utils.network.generate_minion_id()
2435     if opts.get("minion_id_lowercase"):
2436         newid = newid.lower()
2437         log.debug("Changed minion id %s to lowercase.", newid)
2438     if opts.get("minion_id_remove_domain"):
2439         newid = remove_domain_from_fqdn(opts, newid)
2440     if "__role" in opts and opts.get("__role") == "minion":
2441         if opts.get("id_function"):
2442             log.debug(
2443                 "Found minion id from external function %s: %s",
2444                 opts["id_function"],
2445                 newid,
2446             )
2447         else:
2448             log.debug("Found minion id from generate_minion_id(): %s", newid)
2449     if cache_minion_id and opts.get("minion_id_caching", True):
2450         _cache_id(newid, id_cache)
2451     is_ipv4 = salt.utils.network.is_ipv4(newid)
2452     return newid, is_ipv4
2453 def _update_ssl_config(opts):
2454     if opts["ssl"] in (None, False):
2455         opts["ssl"] = None
2456         return
2457     if opts["ssl"] is True:
2458         opts["ssl"] = {}
2459         return
2460     import ssl
2461     for key, prefix in (("cert_reqs", "CERT_"), ("ssl_version", "PROTOCOL_")):
2462         val = opts["ssl"].get(key)
2463         if val is None:
2464             continue
2465         if (
2466             not isinstance(val, str)
2467             or not val.startswith(prefix)
2468             or not hasattr(ssl, val)
2469         ):
2470             message = "SSL option '{}' must be set to one of the following values: '{}'.".format(
2471                 key,
2472                 "', '".join([val for val in dir(ssl) if val.startswith(prefix)]),
2473             )
2474             log.error(message)
2475             raise salt.exceptions.SaltConfigurationError(message)
2476         opts["ssl"][key] = getattr(ssl, val)
2477 def _adjust_log_file_override(overrides, default_log_file):
2478     if overrides.get("log_dir"):
2479         if overrides.get("log_file"):
2480             if not os.path.isabs(overrides["log_file"]):
2481                 overrides["log_file"] = os.path.join(
2482                     overrides["log_dir"], overrides["log_file"]
2483                 )
2484         else:
2485             overrides["log_file"] = os.path.join(
2486                 overrides["log_dir"], os.path.basename(default_log_file)
2487             )
2488 def apply_minion_config(
2489     overrides=None, defaults=None, cache_minion_id=False, minion_id=None
2490 ):
2491     if defaults is None:
2492         defaults = DEFAULT_MINION_OPTS.copy()
2493     if overrides is None:
2494         overrides = {}
2495     opts = defaults.copy()
2496     opts["__role"] = "minion"
2497     _adjust_log_file_override(overrides, defaults["log_file"])
2498     if overrides:
2499         opts.update(overrides)
2500     if "environment" in opts:
2501         if opts["saltenv"] is not None:
2502             log.warning(
2503                 "The 'saltenv' and 'environment' minion config options "
2504                 "cannot both be used. Ignoring 'environment' in favor of "
2505                 "'saltenv'."
2506             )
2507             opts["environment"] = opts["saltenv"]
2508         else:
2509             log.warning(
2510                 "The 'environment' minion config option has been renamed "
2511                 "to 'saltenv'. Using %s as the 'saltenv' config value.",
2512                 opts["environment"],
2513             )
2514             opts["saltenv"] = opts["environment"]
2515     for idx, val in enumerate(opts["fileserver_backend"]):
2516         if val in ("git", "hg", "svn", "minion"):
2517             new_val = val + "fs"
2518             log.debug(
2519                 "Changed %s to %s in minion opts' fileserver_backend list", val, new_val
2520             )
2521             opts["fileserver_backend"][idx] = new_val
2522     opts["__cli"] = salt.utils.stringutils.to_unicode(os.path.basename(sys.argv[0]))
2523     using_ip_for_id = False
2524     if not opts.get("id"):
2525         if minion_id:
2526             opts["id"] = minion_id
2527         else:
2528             opts["id"], using_ip_for_id = get_id(opts, cache_minion_id=cache_minion_id)
2529     if not using_ip_for_id and "append_domain" in opts:
2530         opts["id"] = _append_domain(opts)
2531     for directory in opts.get("append_minionid_config_dirs", []):
2532         if directory in ("pki_dir", "cachedir", "extension_modules"):
2533             newdirectory = os.path.join(opts[directory], opts["id"])
2534             opts[directory] = newdirectory
2535         elif directory == "default_include" and directory in opts:
2536             include_dir = os.path.dirname(opts[directory])
2537             new_include_dir = os.path.join(
2538                 include_dir, opts["id"], os.path.basename(opts[directory])
2539             )
2540             opts[directory] = new_include_dir
2541     if "pidfile" in opts.get("append_minionid_config_dirs", []):
2542         newpath_list = os.path.split(opts["pidfile"])
2543         opts["pidfile"] = os.path.join(
2544             newpath_list[0], "salt", opts["id"], newpath_list[1]
2545         )
2546     if len(opts["sock_dir"]) &gt; len(opts["cachedir"]) + 10:
2547         opts["sock_dir"] = os.path.join(opts["cachedir"], ".salt-unix")
2548     opts["open_mode"] = opts["open_mode"] is True
2549     opts["file_roots"] = _validate_file_roots(opts["file_roots"])
2550     opts["pillar_roots"] = _validate_pillar_roots(opts["pillar_roots"])
2551     opts["extension_modules"] = opts.get("extension_modules") or os.path.join(
2552         opts["cachedir"], "extmods"
2553     )
2554     opts["utils_dirs"] = opts.get("utils_dirs") or [
2555         os.path.join(opts["extension_modules"], "utils")
2556     ]
2557     insert_system_path(opts, opts["utils_dirs"])
2558     prepend_root_dirs = [
2559         "pki_dir",
2560         "cachedir",
2561         "sock_dir",
2562         "extension_modules",
2563         "pidfile",
2564     ]
2565     for config_key in ("log_file", "key_logfile"):
2566         if urllib.parse.urlparse(opts.get(config_key, "")).scheme == "":
2567             prepend_root_dirs.append(config_key)
2568     prepend_root_dir(opts, prepend_root_dirs)
2569     if "beacons" not in opts:
2570         opts["beacons"] = {}
2571     if overrides.get("ipc_write_buffer", "") == "dynamic":
2572         opts["ipc_write_buffer"] = _DFLT_IPC_WBUFFER
2573     if "ipc_write_buffer" not in overrides:
2574         opts["ipc_write_buffer"] = 0
2575     opts["hash_type"] = opts["hash_type"].lower()
2576     _update_ssl_config(opts)
2577     _update_discovery_config(opts)
2578     return opts
2579 def _update_discovery_config(opts):
2580     if opts.get("discovery") not in (None, False):
2581         if opts["discovery"] is True:
2582             opts["discovery"] = {}
2583         discovery_config = {
2584             "attempts": 3,
2585             "pause": 5,
2586             "port": 4520,
2587             "match": "any",
2588             "mapping": {},
2589         }
2590         for key in opts["discovery"]:
2591             if key not in discovery_config:
2592                 raise salt.exceptions.SaltConfigurationError(
2593                     "Unknown discovery option: {}".format(key)
2594                 )
2595         if opts.get("__role") != "minion":
2596             for key in ["attempts", "pause", "match"]:
2597                 del discovery_config[key]
2598         opts["discovery"] = salt.utils.dictupdate.update(
2599             discovery_config, opts["discovery"], True, True
2600         )
2601 def master_config(
2602     path, env_var="SALT_MASTER_CONFIG", defaults=None, exit_on_config_errors=False
2603 ):
2604     if defaults is None:
2605         defaults = DEFAULT_MASTER_OPTS.copy()
2606     if not os.environ.get(env_var, None):
2607         salt_config_dir = os.environ.get("SALT_CONFIG_DIR", None)
2608         if salt_config_dir:
2609             env_config_file_path = os.path.join(salt_config_dir, "master")
2610             if salt_config_dir and os.path.isfile(env_config_file_path):
2611                 os.environ[env_var] = env_config_file_path
2612     overrides = load_config(path, env_var, DEFAULT_MASTER_OPTS["conf_file"])
2613     default_include = overrides.get("default_include", defaults["default_include"])
2614     include = overrides.get("include", [])
2615     overrides.update(
2616         include_config(
2617             default_include,
2618             path,
2619             verbose=False,
2620             exit_on_config_errors=exit_on_config_errors,
2621         )
2622     )
2623     overrides.update(
2624         include_config(
2625             include, path, verbose=True, exit_on_config_errors=exit_on_config_errors
2626         )
2627     )
2628     opts = apply_master_config(overrides, defaults)
2629     _validate_ssh_minion_opts(opts)
2630     _validate_opts(opts)
2631     if opts.get("nodegroups") is None:
2632         opts["nodegroups"] = DEFAULT_MASTER_OPTS.get("nodegroups", {})
2633     if salt.utils.data.is_dictlist(opts["nodegroups"]):
2634         opts["nodegroups"] = salt.utils.data.repack_dictlist(opts["nodegroups"])
2635     apply_sdb(opts)
2636     return opts
2637 def apply_master_config(overrides=None, defaults=None):
2638     if defaults is None:
2639         defaults = DEFAULT_MASTER_OPTS.copy()
2640     if overrides is None:
2641         overrides = {}
2642     opts = defaults.copy()
2643     opts["__role"] = "master"
2644     _adjust_log_file_override(overrides, defaults["log_file"])
2645     if overrides:
2646         opts.update(overrides)
2647     opts["__cli"] = salt.utils.stringutils.to_unicode(os.path.basename(sys.argv[0]))
2648     if "environment" in opts:
2649         if opts["saltenv"] is not None:
2650             log.warning(
2651                 "The 'saltenv' and 'environment' master config options "
2652                 "cannot both be used. Ignoring 'environment' in favor of "
2653                 "'saltenv'."
2654             )
2655             opts["environment"] = opts["saltenv"]
2656         else:
2657             log.warning(
2658                 "The 'environment' master config option has been renamed "
2659                 "to 'saltenv'. Using %s as the 'saltenv' config value.",
2660                 opts["environment"],
2661             )
2662             opts["saltenv"] = opts["environment"]
2663     for idx, val in enumerate(opts["fileserver_backend"]):
2664         if val in ("git", "hg", "svn", "minion"):
2665             new_val = val + "fs"
2666             log.debug(
2667                 "Changed %s to %s in master opts' fileserver_backend list", val, new_val
2668             )
2669             opts["fileserver_backend"][idx] = new_val
2670     if len(opts["sock_dir"]) &gt; len(opts["cachedir"]) + 10:
2671         opts["sock_dir"] = os.path.join(opts["cachedir"], ".salt-unix")
2672     opts["token_dir"] = os.path.join(opts["cachedir"], "tokens")
2673     opts["syndic_dir"] = os.path.join(opts["cachedir"], "syndics")
2674     opts["extension_modules"] = opts.get("extension_modules") or os.path.join(
2675         opts["cachedir"], "extmods"
2676     )
2677     opts["utils_dirs"] = opts.get("utils_dirs") or [
2678         os.path.join(opts["extension_modules"], "utils")
2679     ]
2680     insert_system_path(opts, opts["utils_dirs"])
2681     if overrides.get("ipc_write_buffer", "") == "dynamic":
2682         opts["ipc_write_buffer"] = _DFLT_IPC_WBUFFER
2683     if "ipc_write_buffer" not in overrides:
2684         opts["ipc_write_buffer"] = 0
2685     using_ip_for_id = False
2686     append_master = False
2687     if not opts.get("id"):
2688         opts["id"], using_ip_for_id = get_id(opts, cache_minion_id=None)
2689         append_master = True
2690     if not using_ip_for_id and "append_domain" in opts:
2691         opts["id"] = _append_domain(opts)
2692     if append_master:
2693         opts["id"] += "_master"
2694     prepend_root_dirs = [
2695         "pki_dir",
2696         "cachedir",
2697         "pidfile",
2698         "sock_dir",
2699         "extension_modules",
2700         "autosign_file",
2701         "autoreject_file",
2702         "token_dir",
2703         "syndic_dir",
2704         "sqlite_queue_dir",
2705         "autosign_grains_dir",
2706     ]
2707     for config_key in ("log_file", "key_logfile", "ssh_log_file"):
2708         log_setting = opts.get(config_key, "")
2709         if log_setting is None:
2710             continue
2711         if urllib.parse.urlparse(log_setting).scheme == "":
2712             prepend_root_dirs.append(config_key)
2713     prepend_root_dir(opts, prepend_root_dirs)
2714     opts["open_mode"] = opts["open_mode"] is True
2715     opts["auto_accept"] = opts["auto_accept"] is True
2716     opts["file_roots"] = _validate_file_roots(opts["file_roots"])
2717     opts["pillar_roots"] = _validate_file_roots(opts["pillar_roots"])
2718     if opts["file_ignore_regex"]:
2719         if isinstance(opts["file_ignore_regex"], str):
2720             ignore_regex = [opts["file_ignore_regex"]]
2721         elif isinstance(opts["file_ignore_regex"], list):
2722             ignore_regex = opts["file_ignore_regex"]
2723         opts["file_ignore_regex"] = []
2724         for regex in ignore_regex:
2725             try:
2726                 re.compile(regex)
2727                 opts["file_ignore_regex"].append(regex)
2728             except Exception:  # pylint: disable=broad-except
2729                 log.warning("Unable to parse file_ignore_regex. Skipping: %s", regex)
2730     if opts["file_ignore_glob"]:
2731         if isinstance(opts["file_ignore_glob"], str):
2732             opts["file_ignore_glob"] = [opts["file_ignore_glob"]]
2733     if opts["worker_threads"] &lt; 3 and opts.get("peer", None):
2734         log.warning(
2735             "The 'worker_threads' setting in '%s' cannot be lower than "
2736             "3. Resetting it to the default value of 3.",
2737             opts["conf_file"],
2738         )
2739         opts["worker_threads"] = 3
2740     opts.setdefault("pillar_source_merging_strategy", "smart")
2741     opts["hash_type"] = opts["hash_type"].lower()
2742     _update_ssl_config(opts)
2743     _update_discovery_config(opts)
2744     return opts
2745 def client_config(path, env_var="SALT_CLIENT_CONFIG", defaults=None):
2746     if defaults is None:
2747         defaults = DEFAULT_MASTER_OPTS.copy()
2748     xdg_dir = salt.utils.xdg.xdg_config_dir()
2749     if os.path.isdir(xdg_dir):
2750         client_config_dir = xdg_dir
2751         saltrc_config_file = "saltrc"
2752     else:
2753         client_config_dir = os.path.expanduser("~")
2754         saltrc_config_file = ".saltrc"
2755     opts = {
2756         "token_file": defaults.get(
2757             "token_file", os.path.join(client_config_dir, "salt_token")
2758         )
2759     }
2760     opts.update(master_config(path, defaults=defaults))
2761     saltrc_config = os.path.join(client_config_dir, saltrc_config_file)
2762     opts.update(load_config(saltrc_config, env_var, saltrc_config))
2763     if "token_file" in opts:
2764         opts["token_file"] = os.path.abspath(os.path.expanduser(opts["token_file"]))
2765     if os.path.isfile(opts["token_file"]):
2766         expire = opts.get("token_expire", 43200)
2767         if os.stat(opts["token_file"]).st_mtime + expire &gt; time.mktime(
2768             time.localtime()
2769         ):
2770             with salt.utils.files.fopen(opts["token_file"]) as fp_:
2771                 opts["token"] = fp_.read().strip()
2772     if opts["interface"] == "0.0.0.0":
2773         opts["interface"] = "127.0.0.1"
2774     if "master_uri" not in opts:
2775         opts["master_uri"] = "tcp://{ip}:{port}".format(
2776             ip=salt.utils.zeromq.ip_bracket(opts["interface"]), port=opts["ret_port"]
2777         )
2778     _validate_opts(opts)
2779     return opts
2780 def api_config(path):
2781     opts = DEFAULT_API_OPTS.copy()
2782     opts.update(client_config(path, defaults=DEFAULT_MASTER_OPTS.copy()))
2783     opts.update(
2784         {
2785             "pidfile": opts.get("api_pidfile", DEFAULT_API_OPTS["api_pidfile"]),
2786             "log_file": opts.get("api_logfile", DEFAULT_API_OPTS["api_logfile"]),
2787         }
2788     )
2789     prepend_root_dir(opts, ["api_pidfile", "api_logfile", "log_file", "pidfile"])
2790     return opts
2791 def spm_config(path):
2792     defaults = DEFAULT_MASTER_OPTS.copy()
2793     defaults.update(DEFAULT_SPM_OPTS)
2794     overrides = load_config(path, "SPM_CONFIG", DEFAULT_SPM_OPTS["spm_conf_file"])
2795     default_include = overrides.get(
2796         "spm_default_include", defaults["spm_default_include"]
2797     )
2798     include = overrides.get("include", [])
2799     overrides.update(include_config(default_include, path, verbose=False))
2800     overrides.update(include_config(include, path, verbose=True))
2801     defaults = apply_master_config(overrides, defaults)
2802     defaults = apply_spm_config(overrides, defaults)
2803     return client_config(path, env_var="SPM_CONFIG", defaults=defaults)
2804 def apply_spm_config(overrides, defaults):
2805     opts = defaults.copy()
2806     _adjust_log_file_override(overrides, defaults["log_file"])
2807     if overrides:
2808         opts.update(overrides)
2809     prepend_root_dirs = [
2810         "formula_path",
2811         "pillar_path",
2812         "reactor_path",
2813         "spm_cache_dir",
2814         "spm_build_dir",
2815     ]
2816     for config_key in ("spm_logfile",):
2817         log_setting = opts.get(config_key, "")
2818         if log_setting is None:
2819             continue
2820         if urllib.parse.urlparse(log_setting).scheme == "":
2821             prepend_root_dirs.append(config_key)
2822     prepend_root_dir(opts, prepend_root_dirs)
2823     return opts
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
