<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_pub_server_channel.py &amp; __init___9.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_pub_server_channel.py &amp; __init___9.py
      </h3>
<h1 align="center">
        2.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_pub_server_channel.py (10.852714%)<th>__init___9.py (1.509434%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(1-19)<td><a href="#" name="0">(4-22)</a><td align="center"><font color="#ff0000">18</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(171-178)<td><a href="#" name="1">(405-481)</a><td align="center"><font color="#c60000">14</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(111-114)<td><a href="#" name="2">(1708-1718)</a><td align="center"><font color="#aa0000">12</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(44-47)<td><a href="#" name="3">(2543-2550)</a><td align="center"><font color="#aa0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_pub_server_channel.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import multiprocessing
2 import time
3 from concurrent.futures.thread import ThreadPoolExecutor
4 import pytest
5 import salt.config
6 import salt.exceptions
7 import salt.ext.tornado.gen
8 import salt.ext.tornado.ioloop
9 import salt.log.setup
10 import salt.master
11 import salt.transport.zeromq
12 import salt.utils.platform
13 import salt.utils.process
14 import salt.utils.stringutils
15 import zmq
16 from saltfactories.utils.processes import terminate_process
17 from</b></font> tests.support.mock import MagicMock, patch
18 log = logging.getLogger(__name__)
19 class Collector(salt.utils.process.SignalHandlingProcess):
20     def __init__(self, minion_config, pub_uri, timeout=30, zmq_filtering=False):
21         super().__init__()
22         self.minion_config = minion_config
23         self.pub_uri = pub_uri
24         self.timeout = timeout
25         self.hard_timeout = time.time() + timeout + 30
26         self.manager = multiprocessing.Manager()
27         self.results = self.manager.list()
28         self.zmq_filtering = zmq_filtering
29         self.stopped = multiprocessing.Event()
30         self.started = multiprocessing.Event()
31         self.running = multiprocessing.Event()
32     def run(self):
33         ctx = zmq.Context()
34         sock = ctx<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.socket(zmq.SUB)
35         sock.setsockopt(zmq.LINGER, -1)
36         sock.setsockopt(zmq.SUBSCRIBE, b"")
37         sock.connect(self.</b></font>pub_uri)
38         last_msg = time.time()
39         self.started.set()
40         while True:
41             curr_time = time.time()
42             if time.time() &gt; self.hard_timeout:
43                 break
44             if curr_time - last_msg &gt;= self.timeout:
45                 break
46             try:
47                 payload = sock.recv(zmq.NOBLOCK)
48             except zmq.ZMQError:
49                 time.sleep(0.1)
50             else:
51                 try:
52                     payload = salt.payload.loads(payload)
53                     if "start" in payload:
54                         self.running.set()
55                         continue
56                     if "stop" in payload:
57                         break
58                     last_msg = time.time()
59                     self.results.append(payload["jid"])
60                 except salt.exceptions.SaltDeserializationError:
61                     if not self.zmq_filtering:
62                         log.exception("Failed to deserialize...")
63                         break
64     def __enter__(self):
65         self.manager.__enter__()
66         self.start()
67         self.started.wait()
68         self.started.clear()
69         return self
70     def __exit__(self, *args):
71         join_secs = self.hard_timeout - time.time()
72         log.info("Waiting at most %s seconds before exiting the collector", join_secs)
73         self.join(join_secs)
74         self.terminate()
75         self.results = list(self.results)
76         self.manager.__exit__(*args)
77         log.debug("The collector has exited")
78         self.stopped.set()
79 class PubServerChannelProcess(salt.utils.process.SignalHandlingProcess):
80     def __init__(self, master_config, minion_config, **collector_kwargs):
81         super().__init__()
82         self._closing = False
83         self.master_config = master_config
84         self.minion_config = minion_config
85         self.collector_kwargs = collector_kwargs
86         self.process_manager = salt.utils.process.ProcessManager(
87             name="ZMQ-PubServer-ProcessManager"
88         )
89         self.pub_server_channel = salt.transport.zeromq.PublishServer(
90         )
91         self.pub_server_channel.pre_fork(self.process_manager)
92         self.pub_uri = "tcp://{interface}:{publish_port}"<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.format(**self.master_config)
93         self.queue = multiprocessing.Queue()
94         self.stopped = multiprocessing.Event()
95         self.</b></font>collector = Collector(
96             self.minion_config, self.pub_uri, **self.collector_kwargs
97         )
98     def run(self):
99         try:
100             while True:
101                 payload = self.queue.get()
102                 if payload is None:
103                     log.debug("We received the stop sentinel")
104                     break
105                 self.pub_server_channel.publish(payload)
106         except KeyboardInterrupt:
107             pass
108         finally:
109             self.stopped.set()
110     def _handle_signals(self, signum, sigframe):
111         self.close()
112         super()._handle_signals(signum, sigframe)
113     def close(self):
114         if self._closing:
115             return
116         self._closing = True
117         if self.process_manager is None:
118             return
119         self.process_manager.terminate()
120         self.pub_server_channel.pub_close()
121         for pid in self.process_manager._process_map:
122             terminate_process(pid=pid, kill_children=True, slow_stop=False)
123         self.process_manager = None
124     def publish(self, payload):
125         self.queue.put(payload)
126     def __enter__(self):
127         self.start()
128         self.collector.__enter__()
129         attempts = 30
130         while attempts &gt; 0:
131             self.publish({"tgt_type": "glob", "tgt": "*", "jid": -1, "start": True})
132             if self.collector.running.wait(1) is True:
133                 break
134             attempts -= 1
135         else:
136             pytest.fail("Failed to confirm the collector has started")
137         return self
138     def __exit__(self, *args):
139         self.publish({"tgt_type": "glob", "tgt": "*", "jid": -1, "stop": True})
140         self.collector.stopped<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.wait()
141         self.queue.put(None)
142         self.stopped.wait(10)
143         self.close()
144         self.terminate()
145         log.info(</b></font>"The PubServerChannelProcess has terminated")
146 @pytest.mark.skip_on_windows
147 @pytest.mark.slow_test
148 def test_publish_to_pubserv_ipc(salt_master, salt_minion):
149     opts = dict(salt_master.config.copy(), ipc_mode="ipc", pub_hwm=0)
150     with PubServerChannelProcess(opts, salt_minion.config.copy()) as server_channel:
151         send_num = 10000
152         expect = []
153         for idx in range(send_num):
154             expect.append(idx)
155             load = {"tgt_type": "glob", "tgt": "*", "jid": idx}
156             server_channel.publish(load)
157     results = server_channel.collector.results
158     assert len(results) == send_num, "{} != {}, difference: {}".format(
159         len(results), send_num, set(expect).difference(results)
160     )
161 @pytest.mark.skip_on_freebsd
162 @pytest.mark.slow_test
163 def test_issue_36469_tcp(salt_master, salt_minion):
164     def _send_small(server_channel, sid, num=10):
165         for idx in range(num):
166             load = {"tgt_type": "glob", "tgt": "*", "jid": "{}-s{}".format(sid, idx)}
167             server_channel.publish(load)
168     def _send_large(server_channel, sid, num=10, size=250000 * 3):
169         for idx in range(num):
170             load = {
171                 "tgt_type": "glob",
172                 "tgt": "*",
173                 "jid": "{}-l{}".format(sid, idx),
174                 "xdata": "0" * size,
175             }
176             server_channel.publish(load)
177     opts = dict(salt_master.config.copy(), ipc_mode="tcp", pub_hwm=0)
178     send_num = 10 * 4
179     expect = []
180     with PubServerChannelProcess(opts, salt_minion.config.copy()) as server_channel:
181         with ThreadPoolExecutor(max_workers=4) as executor:
182             executor.submit(_send_small, server_channel, 1)
183             executor.submit(_send_large, server_channel, 2)
184             executor.submit(_send_small, server_channel, 3)
185             executor.submit(_send_large, server_channel, 4)
186         expect.extend(["{}-s{}".format(a, b) for a in range(10) for b in (1, 3)])
187         expect.extend(["{}-l{}".format(a, b) for a in range(10) for b in (2, 4)])
188     results = server_channel.collector.results
189     assert len(results) == send_num, "{} != {}, difference: {}".format(
190         len(results), send_num, set(expect).difference(results)
191     )
192 @pytest.mark.skip_on_windows
193 @pytest.mark.slow_test
194 def test_zeromq_filtering(salt_master, salt_minion):
195     opts = dict(
196         salt_master.config.copy(),
197         ipc_mode="ipc",
198         pub_hwm=0,
199         zmq_filtering=True,
200         acceptance_wait_time=5,
201     )
202     send_num = 1
203     expect = []
204     with patch(
205         "salt.utils.minions.CkMinions.check_minions",
206         MagicMock(
207             return_value={
208                 "minions": [salt_minion.id],
209                 "missing": [],
210                 "ssh_minions": False,
211             }
212         ),
213     ):
214         with PubServerChannelProcess(
215             opts, salt_minion.config.copy(), zmq_filtering=True
216         ) as server_channel:
217             expect.append(send_num)
218             load = {"tgt_type": "glob", "tgt": "*", "jid": send_num}
219             server_channel.publish(load)
220         results = server_channel.collector.results
221         assert len(results) == send_num, "{} != {}, difference: {}".format(
222             len(results), send_num, set(expect).difference(results)
223         )
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>__init___9.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 All salt configuration loading and defaults should be in this module
2 """
3 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import codecs
4 import glob
5 import logging
6 import os
7 import re
8 import sys
9 import time
10 import types
11 import urllib.parse
12 from copy import deepcopy
13 import salt.defaults.exitcodes
14 import salt.exceptions
15 import salt.syspaths
16 import salt.utils.data
17 import salt.utils.dictupdate
18 import salt.utils.files
19 import salt.utils.immutabletypes as immutabletypes
20 import</b></font> salt.utils.network
21 import salt.utils.path
22 import salt.utils.platform
23 import salt.utils.stringutils
24 import salt.utils.user
25 import salt.utils.validate.path
26 import salt.utils.xdg
27 import salt.utils.yaml
28 import salt.utils.zeromq
29 try:
30     import psutil
31     if not hasattr(psutil, "virtual_memory"):
32         raise ImportError("Version of psutil too old.")
33     HAS_PSUTIL = True
34 except ImportError:
35     HAS_PSUTIL = False
36 log = logging.getLogger(__name__)
37 _DFLT_LOG_DATEFMT = "%H:%M:%S"
38 _DFLT_LOG_DATEFMT_LOGFILE = "%Y-%m-%d %H:%M:%S"
39 _DFLT_LOG_FMT_CONSOLE = "[%(levelname)-8s] %(message)s"
40 _DFLT_LOG_FMT_LOGFILE = (
41     "%(asctime)s,%(msecs)03d [%(name)-17s:%(lineno)-4d][%(levelname)-8s][%(process)d]"
42     " %(message)s"
43 )
44 _DFLT_LOG_FMT_JID = "[JID: %(jid)s]"
45 _DFLT_REFSPECS = ["+refs/heads/*:refs/remotes/origin/*", "+refs/tags/*:refs/tags/*"]
46 DEFAULT_INTERVAL = 60
47 if salt.utils.platform.is_windows():
48     _DFLT_IPC_MODE = "tcp"
49     _DFLT_FQDNS_GRAINS = False
50     _MASTER_TRIES = -1
51     _MASTER_USER = "SYSTEM"
52 elif salt.utils.platform.is_proxy():
53     _DFLT_IPC_MODE = "ipc"
54     _DFLT_FQDNS_GRAINS = False
55     _MASTER_TRIES = 1
56     _MASTER_USER = salt.utils.user.get_user()
57 else:
58     _DFLT_IPC_MODE = "ipc"
59     _DFLT_FQDNS_GRAINS = True
60     _MASTER_TRIES = 1
61     _MASTER_USER = salt.utils.user.get_user()
62 def _gather_buffer_space():
63     """
64     Gather some system data and then calculate
65     buffer space.
66     Result is in bytes.
67     """
68     if HAS_PSUTIL and psutil.version_info &gt;= (0, 6, 0):
69         total_mem = psutil.virtual_memory().total
70     else:
71         import platform
72         import salt.grains.core
73         os_data = {"kernel": platform.system()}
74         grains = salt.grains.core._memdata(os_data)
75         total_mem = grains["mem_total"]
76     return max([total_mem * 0.05, 10 &lt;&lt; 20])
77 _DFLT_IPC_WBUFFER = _gather_buffer_space() * 0.5
78 _DFLT_IPC_RBUFFER = _gather_buffer_space() * 0.5
79 VALID_OPTS = immutabletypes.freeze(
80     {
81         "master": (str, list),
82         "master_port": (str, int),
83         "master_type": str,
84         "master_uri_format": str,
85         "source_interface_name": str,
86         "source_address": str,
87         "source_ret_port": (str, int),
88         "source_publish_port": (str, int),
89         "master_finger": str,
90         "master_shuffle": bool,
91         "master_alive_interval": int,
92         "master_failback": bool,
93         "master_failback_interval": int,
94         "master_sign_key_name": str,
95         "master_sign_pubkey": bool,
96         "verify_master_pubkey_sign": bool,
97         "always_verify_signature": bool,
98         "master_pubkey_signature": str,
99         "master_use_pubkey_signature": bool,
100         "master_stats": bool,
101         "master_stats_event_iter": int,
102         "syndic_finger": str,
103         "key_cache": str,
104         "user": str,
105         "root_dir": str,
106         "pki_dir": str,
107         "id": str,
108         "id_function": (dict, str),
109         "cachedir": str,
110         "append_minionid_config_dirs": list,
111         "cache_jobs": bool,
112         "conf_file": str,
113         "sock_dir": str,
114         "sock_pool_size": int,
115         "backup_mode": str,
116         "renderer": str,
117         "renderer_whitelist": list,
118         "renderer_blacklist": list,
119         "failhard": bool,
120         "autoload_dynamic_modules": bool,
121         "saltenv": (type(None), str),
122         "lock_saltenv": bool,
123         "pillarenv": (type(None), str),
124         "pillarenv_from_saltenv": bool,
125         "state_top": str,
126         "state_top_saltenv": (type(None), str),
127         "startup_states": str,
128         "sls_list": list,
129         "snapper_states": bool,
130         "snapper_states_config": str,
131         "top_file": str,
132         "file_client": str,
133         "local": bool,
134         "use_master_when_local": bool,
135         "file_roots": dict,
136         "pillar_roots": dict,
137         "on_demand_ext_pillar": list,
138         "decrypt_pillar": list,
139         "decrypt_pillar_delimiter": str,
140         "decrypt_pillar_default": str,
141         "decrypt_pillar_renderers": list,
142         "gpg_decrypt_must_succeed": bool,
143         "hash_type": str,
144         "optimization_order": list,
145         "disable_modules": list,
146         "disable_returners": list,
147         "whitelist_modules": list,
148         "module_dirs": list,
149         "returner_dirs": list,
150         "states_dirs": list,
151         "grains_dirs": list,
152         "render_dirs": list,
153         "outputter_dirs": list,
154         "utils_dirs": list,
155         "providers": dict,
156         "clean_dynamic_modules": bool,
157         "open_mode": bool,
158         "multiprocessing": bool,
159         "process_count_max": int,
160         "mine_enabled": bool,
161         "mine_return_job": bool,
162         "mine_interval": int,
163         "ipc_mode": str,
164         "ipv6": (type(None), bool),
165         "file_buffer_size": int,
166         "tcp_pub_port": int,
167         "tcp_pull_port": int,
168         "tcp_master_pub_port": int,
169         "tcp_master_pull_port": int,
170         "tcp_master_publish_pull": int,
171         "tcp_master_workers": int,
172         "log_file": str,
173         "log_level": str,
174         "log_level_logfile": (type(None), str),
175         "log_datefmt": str,
176         "log_datefmt_logfile": str,
177         "log_fmt_console": str,
178         "log_fmt_logfile": (tuple, str),
179         "log_granular_levels": dict,
180         "log_rotate_max_bytes": int,
181         "log_rotate_backup_count": int,
182         "max_event_size": int,
183         "enable_legacy_startup_events": bool,
184         "test": bool,
185         "cython_enable": bool,
186         "enable_fqdns_grains": bool,
187         "enable_gpu_grains": bool,
188         "enable_zip_modules": bool,
189         "show_timeout": bool,
190         "show_jid": bool,
191         "unique_jid": bool,
192         "state_verbose": bool,
193         "state_output": str,
194         "state_output_diff": bool,
195         "state_output_profile": bool,
196         "state_output_pct": bool,
197         "state_compress_ids": bool,
198         "state_auto_order": bool,
199         "state_events": bool,
200         "acceptance_wait_time": float,
201         "acceptance_wait_time_max": float,
202         "rejected_retry": bool,
203         "loop_interval": float,
204         "verify_env": bool,
205         "grains": dict,
206         "permissive_pki_access": bool,
207         "key_pass": (type(None), str),
208         "signing_key_pass": (<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>type(None), str),
209         "default_include": str,
210         "update_url": (bool, str),
211         "update_restart_services": list,
212         "retry_dns": float,
213         "retry_dns_count": (type(None), int),
214         "resolve_dns_fallback": bool,
215         "recon_max": float,
216         "recon_default": float,
217         "recon_randomize": bool,
218         "return_retry_timer": int,
219         "return_retry_timer_max": int,
220         "return_retry_tries": int,
221         "event_return": (list, str),
222         "event_return_queue": int,
223         "event_return_queue_max_seconds": int,
224         "event_return_whitelist": list,
225         "event_return_blacklist": list,
226         "event_match_type": str,
227         "pidfile": str,
228         "range_server": str,
229         "tcp_keepalive": bool,
230         "tcp_keepalive_idle": float,
231         "tcp_keepalive_cnt": float,
232         "tcp_keepalive_intvl": float,
233         "interface": str,
234         "publish_port": int,
235         "auth_mode": int,
236         "zmq_backlog": int,
237         "pub_hwm": int,
238         "ipc_write_buffer": int,
239         "req_server_niceness": (type(None), int),
240         "pub_server_niceness": (type(None), int),
241         "fileserver_update_niceness": (type(None), int),
242         "maintenance_niceness": (type(</b></font>None), int),
243         "mworker_niceness": (type(None), int),
244         "mworker_queue_niceness": (type(None), int),
245         "event_return_niceness": (type(None), int),
246         "event_publisher_niceness": (type(None), int),
247         "reactor_niceness": (type(None), int),
248         "worker_threads": int,
249         "ret_port": int,
250         "keep_jobs": int,
251         "archive_jobs": bool,
252         "master_roots": dict,
253         "add_proxymodule_to_opts": bool,
254         "proxy_merge_pillar_in_opts": bool,
255         "proxy_deep_merge_pillar_in_opts": bool,
256         "proxy_merge_pillar_in_opts_strategy": str,
257         "proxy_mines_pillar": bool,
258         "proxy_always_alive": bool,
259         "proxy_keep_alive": bool,
260         "proxy_keep_alive_interval": int,
261         "roots_update_interval": int,
262         "azurefs_update_interval": int,
263         "gitfs_update_interval": int,
264         "git_pillar_update_interval": int,
265         "hgfs_update_interval": int,
266         "minionfs_update_interval": int,
267         "s3fs_update_interval": int,
268         "svnfs_update_interval": int,
269         "git_pillar_ssl_verify": bool,
270         "git_pillar_global_lock": bool,
271         "git_pillar_user": str,
272         "git_pillar_password": str,
273         "git_pillar_insecure_auth": bool,
274         "git_pillar_privkey": str,
275         "git_pillar_pubkey": str,
276         "git_pillar_passphrase": str,
277         "git_pillar_refspecs": list,
278         "git_pillar_includes": bool,
279         "git_pillar_verify_config": bool,
280         "gitfs_remotes": list,
281         "gitfs_insecure_auth": bool,
282         "gitfs_privkey": str,
283         "gitfs_pubkey": str,
284         "gitfs_passphrase": str,
285         "gitfs_saltenv_whitelist": list,
286         "gitfs_saltenv_blacklist": list,
287         "gitfs_ssl_verify": bool,
288         "gitfs_global_lock": bool,
289         "gitfs_saltenv": list,
290         "gitfs_ref_types": list,
291         "gitfs_refspecs": list,
292         "gitfs_disable_saltenv_mapping": bool,
293         "hgfs_remotes": list,
294         "hgfs_mountpoint": str,
295         "hgfs_root": str,
296         "hgfs_base": str,
297         "hgfs_branch_method": str,
298         "hgfs_saltenv_whitelist": list,
299         "hgfs_saltenv_blacklist": list,
300         "svnfs_remotes": list,
301         "svnfs_mountpoint": str,
302         "svnfs_root": str,
303         "svnfs_trunk": str,
304         "svnfs_branches": str,
305         "svnfs_tags": str,
306         "svnfs_saltenv_whitelist": list,
307         "svnfs_saltenv_blacklist": list,
308         "minionfs_env": str,
309         "minionfs_mountpoint": str,
310         "minionfs_whitelist": list,
311         "minionfs_blacklist": list,
312         "ext_pillar": list,
313         "pillar_version": int,
314         "pillar_opts": bool,
315         "pillar_cache": bool,
316         "pillar_cache_ttl": int,
317         "pillar_cache_backend": str,
318         "gpg_cache": bool,
319         "gpg_cache_ttl": int,
320         "gpg_cache_backend": str,
321         "pillar_safe_render_error": bool,
322         "pillar_source_merging_strategy": str,
323         "pillar_merge_lists": bool,
324         "pillar_includes_override_sls": bool,
325         "top_file_merging_strategy": str,
326         "env_order": list,
327         "default_top": str,
328         "ping_on_rotate": bool,
329         "peer": dict,
330         "preserve_minion_cache": bool,
331         "syndic_master": (str, list),
332         "syndic_failover": str,
333         "syndic_forward_all_events": bool,
334         "runner_dirs": list,
335         "client_acl_verify": bool,
336         "publisher_acl": dict,
337         "publisher_acl_blacklist": dict,
338         "sudo_acl": bool,
339         "external_auth": dict,
340         "token_expire": int,
341         "token_expire_user_override": (bool, dict),
342         "file_recv": bool,
343         "file_recv_max_size": int,
344         "file_ignore_regex": (list, str),
345         "file_ignore_glob": (list, str),
346         "fileserver_backend": list,
347         "fileserver_followsymlinks": bool,
348         "fileserver_ignoresymlinks": bool,
349         "fileserver_verify_config": bool,
350         "permissive_acl": bool,
351         "keep_acl_in_token": bool,
352         "eauth_acl_module": str,
353         "eauth_tokens": str,
354         "max_open_files": int,
355         "auto_accept": bool,
356         "autosign_timeout": int,
357         "master_tops": dict,
358         "master_tops_first": bool,
359         "order_masters": bool,
360         "job_cache": bool,
361         "ext_job_cache": str,
362         "master_job_cache": str,
363         "job_cache_store_endtime": bool,
364         "minion_data_cache": bool,
365         "publish_session": int,
366         "reactor": list,
367         "reactor_refresh_interval": int,
368         "reactor_worker_threads": int,
369         "reactor_worker_hwm": int,
370         "engines": list,
371         "runner_returns": bool,
372         "serial": str,
373         "search": str,
374         "nodegroups": (dict, list),
375         "ssh_list_nodegroups": dict,
376         "ssh_use_home_key": bool,
377         "key_logfile": str,
378         "random_startup_delay": int,
379         "winrepo_source_dir": str,
380         "winrepo_dir": str,
381         "winrepo_dir_ng": str,
382         "winrepo_cachefile": str,
383         "winrepo_cache_expire_max": int,
384         "winrepo_cache_expire_min": int,
385         "winrepo_remotes": list,
386         "winrepo_remotes_ng": list,
387         "winrepo_ssl_verify": bool,
388         "winrepo_user": str,
389         "winrepo_password": str,
390         "winrepo_insecure_auth": bool,
391         "winrepo_privkey": str,
392         "winrepo_pubkey": str,
393         "winrepo_passphrase": str,
394         "winrepo_refspecs": list,
395         "modules_max_memory": int,
396         "grains_blacklist": list,
397         "grains_refresh_every": int,
398         "grains_refresh_pre_exec": bool,
399         "enable_lspci": bool,
400         "syndic_wait": int,
401         "jinja_env": dict,
402         "jinja_sls_env": dict,
403         "jinja_lstrip_blocks": bool,
404         "jinja_trim_blocks": bool,
405         "minion_id_caching": bool,
406         "minion_id_lowercase": bool,
407         "minion_id_remove_domain": (str, bool),
408         "sign_pub_messages": bool,
409         "keysize": int,
410         "transport": str,
411         "gather_job_timeout": int,
412         "auth_timeout": int,
413         "auth_tries": int,
414         "master_tries": int,
415         "auth_safemode": bool,
416         "random_master": bool,
417         "random_reauth_delay": int,
418         "syndic_event_forward_timeout": float,
419         "syndic_jid_forward_cache_hwm": int,
420         "ssh_passwd": str,
421         "ssh_port": str,
422         "ssh_sudo": bool,
423         "ssh_sudo_user": str,
424         "ssh_timeout": float,
425         "ssh_user": str,
426         "ssh_scan_ports": str,
427         "ssh_scan_timeout": float,
428         "ssh_identities_only": bool,
429         "ssh_log_file": str,
430         "ssh_config_file": str,
431         "ssh_merge_pillar": bool,
432         "ssh_run_pre_flight": bool,
433         "cluster_mode": bool,
434         "sqlite_queue_dir": str,
435         "queue_dirs": list,
436         "ping_interval": int,
437         "cli_summary": bool,
438         "max_minions": int,
439         "username": (type(None), str),
440         "password": (type(None), str),
441         "zmq_filtering": bool,
442         "con_cache": bool,
443         "rotate_aes_key": bool,
444         "cache_sreqs": bool,
445         "cmd_safe": bool,
446         "rest_timeout": int,
447         "sudo_user": str,
448         "http_connect_timeout": float,
449         "http_request_timeout": float,
450         "http_max_body": int,
451         "bootstrap_delay": int,
452         "proxy_merge_grains_in_module": bool,
453         "minion_restart_command": list,
454         "pub_ret": bool,
455         "proxy_host": str,
456         "proxy_username": str,
457         "proxy_password": str,
458         "proxy_port": int,
459         "no_proxy": list,
460         "minion_jid_queue_hwm": int,
461         "cache": str,
462         "memcache_expire_seconds": int,
463         "memcache_max_items": int,
464         "memcache_full_cleanup": bool,
465         "memcache_debug": bool,
466         "thin_extra_mods": str,
467         "min_extra_mods": str,
468         "return": (str, list),
469         "ssl": (dict, bool, type(None)),
470         "multifunc_ordered": bool,
471         "beacons_before_connect": bool,
472         "scheduler_before_connect": bool,
473         "extmod_whitelist": dict,
474         "extmod_blacklist": dict,
475         "django_auth_path": str,
476         "django_auth_settings": str,
477         "tcp_authentication_retries": int,
478         "tcp_reconnect_backoff": float,
479         "allow_minion_key_revoke": bool,
480         "salt_cp_chunk_size": int,
481         "minion_sign_messages": bool,
482         "drop_messages_signature_fail": bool,
483         "require_minion_sign_messages": bool,
484         "pass_to_ext_pillars": (str, list),
485         "discovery": (dict, bool),
486         "schedule": dict,
487         "auth_events": bool,
488         "minion_data_cache_events": bool,
489         "enable_ssh_minions": bool,
490         "thoriumenv": (type(None), str),
491         "thorium_top": str,
492         "netapi_allow_raw_shell": bool,
493         "disabled_requisites": (str, list),
494         "features": dict,
495         "fips_mode": bool,
496         "detect_remote_minions": bool,
497         "remote_minions_port": int,
498     }
499 )
500 DEFAULT_MINION_OPTS = immutabletypes.freeze(
501     {
502         "interface": "0.0.0.0",
503         "master": "salt",
504         "master_type": "str",
505         "master_uri_format": "default",
506         "source_interface_name": "",
507         "source_address": "",
508         "source_ret_port": 0,
509         "source_publish_port": 0,
510         "master_port": 4506,
511         "master_finger": "",
512         "master_shuffle": False,
513         "master_alive_interval": 0,
514         "master_failback": False,
515         "master_failback_interval": 0,
516         "verify_master_pubkey_sign": False,
517         "sign_pub_messages": False,
518         "always_verify_signature": False,
519         "master_sign_key_name": "master_sign",
520         "syndic_finger": "",
521         "user": salt.utils.user.get_user(),
522         "root_dir": salt.syspaths.ROOT_DIR,
523         "pki_dir": os.path.join(salt.syspaths.CONFIG_DIR, "pki", "minion"),
524         "id": "",
525         "id_function": {},
526         "cachedir": os.path.join(salt.syspaths.CACHE_DIR, "minion"),
527         "append_minionid_config_dirs": [],
528         "cache_jobs": False,
529         "grains_blacklist": [],
530         "grains_cache": False,
531         "grains_cache_expiration": 300,
532         "grains_deep_merge": False,
533         "conf_file": os.path.join(salt.syspaths.CONFIG_DIR, "minion"),
534         "sock_dir": os.path.join(salt.syspaths.SOCK_DIR, "minion"),
535         "sock_pool_size": 1,
536         "backup_mode": "",
537         "renderer": "jinja|yaml",
538         "renderer_whitelist": [],
539         "renderer_blacklist": [],
540         "random_startup_delay": 0,
541         "failhard": False,
542         "autoload_dynamic_modules": True,
543         "saltenv": None,
544         "lock_saltenv": False,
545         "pillarenv": None,
546         "pillarenv_from_saltenv": False,
547         "pillar_opts": False,
548         "pillar_source_merging_strategy": "smart",
549         "pillar_merge_lists": False,
550         "pillar_includes_override_sls": False,
551         "pillar_cache": False,
552         "pillar_cache_ttl": 3600,
553         "pillar_cache_backend": "disk",
554         "gpg_cache": False,
555         "gpg_cache_ttl": 86400,
556         "gpg_cache_backend": "disk",
557         "extension_modules": os.path.join(salt.syspaths.CACHE_DIR, "minion", "extmods"),
558         "state_top": "top.sls",
559         "state_top_saltenv": None,
560         "startup_states": "",
561         "sls_list": [],
562         "start_event_grains": [],
563         "top_file": "",
564         "thoriumenv": None,
565         "thorium_top": "top.sls",
566         "thorium_interval": 0.5,
567         "thorium_roots": {"base": [salt.syspaths.BASE_THORIUM_ROOTS_DIR]},
568         "file_client": "remote",
569         "local": False,
570         "use_master_when_local": False,
571         "file_roots": {
572             "base": [salt.syspaths.BASE_FILE_ROOTS_DIR, salt.syspaths.SPM_FORMULA_PATH]
573         },
574         "top_file_merging_strategy": "merge",
575         "env_order": [],
576         "default_top": "base",
577         "file_recv": False,
578         "file_recv_max_size": 100,
579         "file_ignore_regex": [],
580         "file_ignore_glob": [],
581         "fileserver_backend": ["roots"],
582         "fileserver_followsymlinks": True,
583         "fileserver_ignoresymlinks": False,
584         "pillar_roots": {
585             "base": [salt.syspaths.BASE_PILLAR_ROOTS_DIR, salt.syspaths.SPM_PILLAR_PATH]
586         },
587         "on_demand_ext_pillar": ["libvirt", "virtkey"],
588         "decrypt_pillar": [],
589         "decrypt_pillar_delimiter": ":",
590         "decrypt_pillar_default": "gpg",
591         "decrypt_pillar_renderers": ["gpg"],
592         "gpg_decrypt_must_succeed": False,
593         "roots_update_interval": DEFAULT_INTERVAL,
594         "azurefs_update_interval": DEFAULT_INTERVAL,
595         "gitfs_update_interval": DEFAULT_INTERVAL,
596         "git_pillar_update_interval": DEFAULT_INTERVAL,
597         "hgfs_update_interval": DEFAULT_INTERVAL,
598         "minionfs_update_interval": DEFAULT_INTERVAL,
599         "s3fs_update_interval": DEFAULT_INTERVAL,
600         "svnfs_update_interval": DEFAULT_INTERVAL,
601         "git_pillar_base": "master",
602         "git_pillar_branch": "master",
603         "git_pillar_env": "",
604         "git_pillar_fallback": "",
605         "git_pillar_root": "",
606         "git_pillar_ssl_verify": True,
607         "git_pillar_global_lock": True,
608         "git_pillar_user": "",
609         "git_pillar_password": "",
610         "git_pillar_insecure_auth": False,
611         "git_pillar_privkey": "",
612         "git_pillar_pubkey": "",
613         "git_pillar_passphrase": "",
614         "git_pillar_refspecs": _DFLT_REFSPECS,
615         "git_pillar_includes": True,
616         "gitfs_remotes": [],
617         "gitfs_mountpoint": "",
618         "gitfs_root": "",
619         "gitfs_base": "master",
620         "gitfs_fallback": "",
621         "gitfs_user": "",
622         "gitfs_password": "",
623         "gitfs_insecure_auth": False,
624         "gitfs_privkey": "",
625         "gitfs_pubkey": "",
626         "gitfs_passphrase": "",
627         "gitfs_saltenv_whitelist": [],
628         "gitfs_saltenv_blacklist": [],
629         "gitfs_global_lock": True,
630         "gitfs_ssl_verify": True,
631         "gitfs_saltenv": [],
632         "gitfs_ref_types": ["branch", "tag", "sha"],
633         "gitfs_refspecs": _DFLT_REFSPECS,
634         "gitfs_disable_saltenv_mapping": False,
635         "unique_jid": False,
636         "hash_type": "sha256",
637         "optimization_order": [0, 1, 2],
638         "disable_modules": [],
639         "disable_returners": [],
640         "whitelist_modules": [],
641         "module_dirs": [],
642         "returner_dirs": [],
643         "grains_dirs": [],
644         "states_dirs": [],
645         "render_dirs": [],
646         "outputter_dirs": [],
647         "utils_dirs": [],
648         "publisher_acl": {},
649         "publisher_acl_blacklist": {},
650         "providers": {},
651         "clean_dynamic_modules": True,
652         "open_mode": False,
653         "auto_accept": True,
654         "autosign_timeout": 120,
655         "multiprocessing": True,
656         "process_count_max": -1,
657         "mine_enabled": True,
658         "mine_return_job": False,
659         "mine_interval": 60,
660         "ipc_mode": _DFLT_IPC_MODE,
661         "ipc_write_buffer": _DFLT_IPC_WBUFFER,
662         "ipv6": None,
663         "file_buffer_size": 262144,
664         "tcp_pub_port": 4510,
665         "tcp_pull_port": 4511,
666         "tcp_authentication_retries": 5,
667         "tcp_reconnect_backoff": 1,
668         "log_file": os.path.join(salt.syspaths.LOGS_DIR, "minion"),
669         "log_level": "warning",
670         "log_level_logfile": None,
671         "log_datefmt": _DFLT_LOG_DATEFMT,
672         "log_datefmt_logfile": _DFLT_LOG_DATEFMT_LOGFILE,
673         "log_fmt_console": _DFLT_LOG_FMT_CONSOLE,
674         "log_fmt_logfile": _DFLT_LOG_FMT_LOGFILE,
675         "log_fmt_jid": _DFLT_LOG_FMT_JID,
676         "log_granular_levels": {},
677         "log_rotate_max_bytes": 0,
678         "log_rotate_backup_count": 0,
679         "max_event_size": 1048576,
680         "enable_legacy_startup_events": True,
681         "test": False,
682         "ext_job_cache": "",
683         "cython_enable": False,
684         "enable_fqdns_grains": _DFLT_FQDNS_GRAINS,
685         "enable_gpu_grains": True,
686         "enable_zip_modules": False,
687         "state_verbose": True,
688         "state_output": "full",
689         "state_output_diff": False,
690         "state_output_profile": True,
691         "state_auto_order": True,
692         "state_events": False,
693         "state_aggregate": False,
694         "snapper_states": False,
695         "snapper_states_config": "root",
696         "acceptance_wait_time": 10,
697         "acceptance_wait_time_max": 0,
698         "rejected_retry": False,
699         "loop_interval": 1,
700         "verify_env": True,
701         "grains": {},
702         "permissive_pki_access": False,
703         "default_include": "minion.d/*.conf",
704         "update_url": False,
705         "update_restart_services": [],
706         "retry_dns": 30,
707         "retry_dns_count": None,
708         "resolve_dns_fallback": True,
709         "recon_max": 10000,
710         "recon_default": 1000,
711         "recon_randomize": True,
712         "return_retry_timer": 5,
713         "return_retry_timer_max": 10,
714         "return_retry_tries": 3,
715         "random_reauth_delay": 10,
716         "winrepo_source_dir": "salt://win/repo-ng/",
717         "winrepo_dir": os.path.join(salt.syspaths.BASE_FILE_ROOTS_DIR, "win", "repo"),
718         "winrepo_dir_ng": os.path.join(
719             salt.syspaths.BASE_FILE_ROOTS_DIR, "win", "repo-ng"
720         ),
721         "winrepo_cachefile": "winrepo.p",
722         "winrepo_cache_expire_max": 604800,
723         "winrepo_cache_expire_min": 1800,
724         "winrepo_remotes": ["https://github.com/saltstack/salt-winrepo.git"],
725         "winrepo_remotes_ng": ["https://github.com/saltstack/salt-winrepo-ng.git"],
726         "winrepo_branch": "master",
727         "winrepo_fallback": "",
728         "winrepo_ssl_verify": True,
729         "winrepo_user": "",
730         "winrepo_password": "",
731         "winrepo_insecure_auth": False,
732         "winrepo_privkey": "",
733         "winrepo_pubkey": "",
734         "winrepo_passphrase": "",
735         "winrepo_refspecs": _DFLT_REFSPECS,
736         "pidfile": os.path.join(salt.syspaths.PIDFILE_DIR, "salt-minion.pid"),
737         "range_server": "range:80",
738         "reactor_refresh_interval": 60,
739         "reactor_worker_threads": 10,
740         "reactor_worker_hwm": 10000,
741         "engines": [],
742         "tcp_keepalive": True,
743         "tcp_keepalive_idle": 300,
744         "tcp_keepalive_cnt": -1,
745         "tcp_keepalive_intvl": -1,
746         "modules_max_memory": -1,
747         "grains_refresh_every": 0,
748         "minion_id_caching": True,
749         "minion_id_lowercase": False,
750         "minion_id_remove_domain": False,
751         "keysize": 2048,
752         "transport": "zeromq",
753         "auth_timeout": 5,
754         "auth_tries": 7,
755         "master_tries": _MASTER_TRIES,
756         "master_tops_first": False,
757         "auth_safemode": False,
758         "random_master": False,
759         "cluster_mode": False,
760         "restart_on_error": False,
761         "ping_interval": 0,
762         "username": None,
763         "password": None,
764         "zmq_filtering": False,
765         "zmq_monitor": False,
766         "cache_sreqs": True,
767         "cmd_safe": True,
768         "sudo_user": "",
769         "http_connect_timeout": 20.0,  # tornado default - 20 seconds
770         "http_request_timeout": 1 * 60 * 60.0,  # 1 hour
771         "http_max_body": 100 * 1024 * 1024 * 1024,  # 100GB
772         "event_match_type": "startswith",
773         "minion_restart_command": [],
774         "pub_ret": True,
775         "proxy_host": "",
776         "proxy_username": "",
777         "proxy_password": "",
778         "proxy_port": 0,
779         "minion_jid_queue_hwm": 100,
780         "ssl": None,
781         "multifunc_ordered": False,
782         "beacons_before_connect": False,
783         "scheduler_before_connect": False,
784         "cache": "localfs",
785         "salt_cp_chunk_size": 65536,
786         "extmod_whitelist": {},
787         "extmod_blacklist": {},
788         "minion_sign_messages": False,
789         "discovery": False,
790         "schedule": {},
791         "ssh_merge_pillar": True,
792         "disabled_requisites": [],
793         "reactor_niceness": None,
794         "fips_mode": False,
795     }
796 )
797 DEFAULT_MASTER_OPTS = immutabletypes.freeze(
798     {
799         "interface": "0.0.0.0",
800         "publish_port": 4505,
801         "zmq_backlog": 1000,
802         "pub_hwm": 1000,
803         "auth_mode": 1,
804         "user": _MASTER_USER,
805         "worker_threads": 5,
806         "sock_dir": os.path.join(salt.syspaths.SOCK_DIR, "master"),
807         "sock_pool_size": 1,
808         "ret_port": 4506,
809         "timeout": 5,
810         "keep_jobs": 24,
811         "archive_jobs": False,
812         "root_dir": salt.syspaths.ROOT_DIR,
813         "pki_dir": os.path.join(salt.syspaths.CONFIG_DIR, "pki", "master"),
814         "key_cache": "",
815         "cachedir": os.path.join(salt.syspaths.CACHE_DIR, "master"),
816         "file_roots": {
817             "base": [salt.syspaths.BASE_FILE_ROOTS_DIR, salt.syspaths.SPM_FORMULA_PATH]
818         },
819         "master_roots": {"base": [salt.syspaths.BASE_MASTER_ROOTS_DIR]},
820         "pillar_roots": {
821             "base": [salt.syspaths.BASE_PILLAR_ROOTS_DIR, salt.syspaths.SPM_PILLAR_PATH]
822         },
823         "on_demand_ext_pillar": ["libvirt", "virtkey"],
824         "decrypt_pillar": [],
825         "decrypt_pillar_delimiter": ":",
826         "decrypt_pillar_default": "gpg",
827         "decrypt_pillar_renderers": ["gpg"],
828         "gpg_decrypt_must_succeed": False,
829         "thoriumenv": None,
830         "thorium_top": "top.sls",
831         "thorium_interval": 0.5,
832         "thorium_roots": {"base": [salt.syspaths.BASE_THORIUM_ROOTS_DIR]},
833         "top_file_merging_strategy": "merge",
834         "env_order": [],
835         "saltenv": None,
836         "lock_saltenv": False,
837         "pillarenv": None,
838         "default_top": "base",
839         "file_client": "local",
840         "local": True,
841         "roots_update_interval": DEFAULT_INTERVAL,
842         "azurefs_update_interval": DEFAULT_INTERVAL,
843         "gitfs_update_interval": DEFAULT_INTERVAL,
844         "git_pillar_update_interval": DEFAULT_INTERVAL,
845         "hgfs_update_interval": DEFAULT_INTERVAL,
846         "minionfs_update_interval": DEFAULT_INTERVAL,
847         "s3fs_update_interval": DEFAULT_INTERVAL,
848         "svnfs_update_interval": DEFAULT_INTERVAL,
849         "git_pillar_base": "master",
850         "git_pillar_branch": "master",
851         "git_pillar_env": "",
852         "git_pillar_fallback": "",
853         "git_pillar_root": "",
854         "git_pillar_ssl_verify": True,
855         "git_pillar_global_lock": True,
856         "git_pillar_user": "",
857         "git_pillar_password": "",
858         "git_pillar_insecure_auth": False,
859         "git_pillar_privkey": "",
860         "git_pillar_pubkey": "",
861         "git_pillar_passphrase": "",
862         "git_pillar_refspecs": _DFLT_REFSPECS,
863         "git_pillar_includes": True,
864         "git_pillar_verify_config": True,
865         "gitfs_remotes": [],
866         "gitfs_mountpoint": "",
867         "gitfs_root": "",
868         "gitfs_base": "master",
869         "gitfs_fallback": "",
870         "gitfs_user": "",
871         "gitfs_password": "",
872         "gitfs_insecure_auth": False,
873         "gitfs_privkey": "",
874         "gitfs_pubkey": "",
875         "gitfs_passphrase": "",
876         "gitfs_saltenv_whitelist": [],
877         "gitfs_saltenv_blacklist": [],
878         "gitfs_global_lock": True,
879         "gitfs_ssl_verify": True,
880         "gitfs_saltenv": [],
881         "gitfs_ref_types": ["branch", "tag", "sha"],
882         "gitfs_refspecs": _DFLT_REFSPECS,
883         "gitfs_disable_saltenv_mapping": False,
884         "hgfs_remotes": [],
885         "hgfs_mountpoint": "",
886         "hgfs_root": "",
887         "hgfs_base": "default",
888         "hgfs_branch_method": "branches",
889         "hgfs_saltenv_whitelist": [],
890         "hgfs_saltenv_blacklist": [],
891         "show_timeout": True,
892         "show_jid": False,
893         "unique_jid": False,
894         "svnfs_remotes": [],
895         "svnfs_mountpoint": "",
896         "svnfs_root": "",
897         "svnfs_trunk": "trunk",
898         "svnfs_branches": "branches",
899         "svnfs_tags": "tags",
900         "svnfs_saltenv_whitelist": [],
901         "svnfs_saltenv_blacklist": [],
902         "max_event_size": 1048576,
903         "master_stats": False,
904         "master_stats_event_iter": 60,
905         "minionfs_env": "base",
906         "minionfs_mountpoint": "",
907         "minionfs_whitelist": [],
908         "minionfs_blacklist": [],
909         "ext_pillar": [],
910         "pillar_version": 2,
911         "pillar_opts": False,
912         "pillar_safe_render_error": True,
913         "pillar_source_merging_strategy": "smart",
914         "pillar_merge_lists": False,
915         "pillar_includes_override_sls": False,
916         "pillar_cache": False,
917         "pillar_cache_ttl": 3600,
918         "pillar_cache_backend": "disk",
919         "gpg_cache": False,
920         "gpg_cache_ttl": 86400,
921         "gpg_cache_backend": "disk",
922         "ping_on_rotate": False,
923         "peer": {},
924         "preserve_minion_cache": False,
925         "syndic_master": "masterofmasters",
926         "syndic_failover": "random",
927         "syndic_forward_all_events": False,
928         "syndic_log_file": os.path.join(salt.syspaths.LOGS_DIR, "syndic"),
929         "syndic_pidfile": os.path.join(salt.syspaths.PIDFILE_DIR, "salt-syndic.pid"),
930         "outputter_dirs": [],
931         "runner_dirs": [],
932         "utils_dirs": [],
933         "client_acl_verify": True,
934         "publisher_acl": {},
935         "publisher_acl_blacklist": {},
936         "sudo_acl": False,
937         "external_auth": {},
938         "token_expire": 43200,
939         "token_expire_user_override": False,
940         "permissive_acl": False,
941         "keep_acl_in_token": False,
942         "eauth_acl_module": "",
943         "eauth_tokens": "localfs",
944         "extension_modules": os.path.join(salt.syspaths.CACHE_DIR, "master", "extmods"),
945         "module_dirs": [],
946         "file_recv": False,
947         "file_recv_max_size": 100,
948         "file_buffer_size": 1048576,
949         "file_ignore_regex": [],
950         "file_ignore_glob": [],
951         "fileserver_backend": ["roots"],
952         "fileserver_followsymlinks": True,
953         "fileserver_ignoresymlinks": False,
954         "fileserver_verify_config": True,
955         "max_open_files": 100000,
956         "hash_type": "sha256",
957         "optimization_order": [0, 1, 2],
958         "conf_file": os.path.join(salt.syspaths.CONFIG_DIR, "master"),
959         "open_mode": False,
960         "auto_accept": False,
961         "renderer": "jinja|yaml",
962         "renderer_whitelist": [],
963         "renderer_blacklist": [],
964         "failhard": False,
965         "state_top": "top.sls",
966         "state_top_saltenv": None,
967         "master_tops": {},
968         "master_tops_first": False,
969         "order_masters": False,
970         "job_cache": True,
971         "ext_job_cache": "",
972         "master_job_cache": "local_cache",
973         "job_cache_store_endtime": False,
974         "minion_data_cache": True,
975         "enforce_mine_cache": False,
976         "ipc_mode": _DFLT_IPC_MODE,
977         "ipc_write_buffer": _DFLT_IPC_WBUFFER,
978         "req_server_niceness": None,
979         "pub_server_niceness": None,
980         "fileserver_update_niceness": None,
981         "mworker_niceness": None,
982         "mworker_queue_niceness": None,
983         "maintenance_niceness": None,
984         "event_return_niceness": None,
985         "event_publisher_niceness": None,
986         "reactor_niceness": None,
987         "ipv6": None,
988         "tcp_master_pub_port": 4512,
989         "tcp_master_pull_port": 4513,
990         "tcp_master_publish_pull": 4514,
991         "tcp_master_workers": 4515,
992         "log_file": os.path.join(salt.syspaths.LOGS_DIR, "master"),
993         "log_level": "warning",
994         "log_level_logfile": None,
995         "log_datefmt": _DFLT_LOG_DATEFMT,
996         "log_datefmt_logfile": _DFLT_LOG_DATEFMT_LOGFILE,
997         "log_fmt_console": _DFLT_LOG_FMT_CONSOLE,
998         "log_fmt_logfile": _DFLT_LOG_FMT_LOGFILE,
999         "log_fmt_jid": _DFLT_LOG_FMT_JID,
1000         "log_granular_levels": {},
1001         "log_rotate_max_bytes": 0,
1002         "log_rotate_backup_count": 0,
1003         "pidfile": os.path.join(salt.syspaths.PIDFILE_DIR, "salt-master.pid"),
1004         "publish_session": 86400,
1005         "range_server": "range:80",
1006         "reactor": [],
1007         "reactor_refresh_interval": 60,
1008         "reactor_worker_threads": 10,
1009         "reactor_worker_hwm": 10000,
1010         "engines": [],
1011         "event_return": "",
1012         "event_return_queue": 0,
1013         "event_return_whitelist": [],
1014         "event_return_blacklist": [],
1015         "event_match_type": "startswith",
1016         "runner_returns": True,
1017         "serial": "msgpack",
1018         "test": False,
1019         "state_verbose": True,
1020         "state_output": "full",
1021         "state_output_diff": False,
1022         "state_output_profile": True,
1023         "state_auto_order": True,
1024         "state_events": False,
1025         "state_aggregate": False,
1026         "search": "",
1027         "loop_interval": 60,
1028         "nodegroups": {},
1029         "ssh_list_nodegroups": {},
1030         "ssh_use_home_key": False,
1031         "cython_enable": False,
1032         "enable_gpu_grains": False,
1033         "key_logfile": os.path.join(salt.syspaths.LOGS_DIR, "key"),
1034         "verify_env": True,
1035         "permissive_pki_access": False,
1036         "key_pass": None,
1037         "signing_key_pass": None,
1038         "default_include": "master.d/*.conf",
1039         "winrepo_dir": os.path.join(salt.syspaths.BASE_FILE_ROOTS_DIR, "win", "repo"),
1040         "winrepo_dir_ng": os.path.join(
1041             salt.syspaths.BASE_FILE_ROOTS_DIR, "win", "repo-ng"
1042         ),
1043         "winrepo_cachefile": "winrepo.p",
1044         "winrepo_remotes": ["https://github.com/saltstack/salt-winrepo.git"],
1045         "winrepo_remotes_ng": ["https://github.com/saltstack/salt-winrepo-ng.git"],
1046         "winrepo_branch": "master",
1047         "winrepo_fallback": "",
1048         "winrepo_ssl_verify": True,
1049         "winrepo_user": "",
1050         "winrepo_password": "",
1051         "winrepo_insecure_auth": False,
1052         "winrepo_privkey": "",
1053         "winrepo_pubkey": "",
1054         "winrepo_passphrase": "",
1055         "winrepo_refspecs": _DFLT_REFSPECS,
1056         "syndic_wait": 5,
1057         "jinja_env": {},
1058         "jinja_sls_env": {},
1059         "jinja_lstrip_blocks": False,
1060         "jinja_trim_blocks": False,
1061         "tcp_keepalive": True,
1062         "tcp_keepalive_idle": 300,
1063         "tcp_keepalive_cnt": -1,
1064         "tcp_keepalive_intvl": -1,
1065         "sign_pub_messages": True,
1066         "keysize": 2048,
1067         "transport": "zeromq",
1068         "gather_job_timeout": 10,
1069         "syndic_event_forward_timeout": 0.5,
1070         "syndic_jid_forward_cache_hwm": 100,
1071         "regen_thin": False,
1072         "ssh_passwd": "",
1073         "ssh_priv_passwd": "",
1074         "ssh_port": "22",
1075         "ssh_sudo": False,
1076         "ssh_sudo_user": "",
1077         "ssh_timeout": 60,
1078         "ssh_user": "root",
1079         "ssh_scan_ports": "22",
1080         "ssh_scan_timeout": 0.01,
1081         "ssh_identities_only": False,
1082         "ssh_log_file": os.path.join(salt.syspaths.LOGS_DIR, "ssh"),
1083         "ssh_config_file": os.path.join(salt.syspaths.HOME_DIR, ".ssh", "config"),
1084         "cluster_mode": False,
1085         "sqlite_queue_dir": os.path.join(salt.syspaths.CACHE_DIR, "master", "queues"),
1086         "queue_dirs": [],
1087         "cli_summary": False,
1088         "max_minions": 0,
1089         "master_sign_key_name": "master_sign",
1090         "master_sign_pubkey": False,
1091         "master_pubkey_signature": "master_pubkey_signature",
1092         "master_use_pubkey_signature": False,
1093         "zmq_filtering": False,
1094         "zmq_monitor": False,
1095         "con_cache": False,
1096         "rotate_aes_key": True,
1097         "cache_sreqs": True,
1098         "dummy_pub": False,
1099         "http_connect_timeout": 20.0,  # tornado default - 20 seconds
1100         "http_request_timeout": 1 * 60 * 60.0,  # 1 hour
1101         "http_max_body": 100 * 1024 * 1024 * 1024,  # 100GB
1102         "cache": "localfs",
1103         "memcache_expire_seconds": 0,
1104         "memcache_max_items": 1024,
1105         "memcache_full_cleanup": False,
1106         "memcache_debug": False,
1107         "thin_extra_mods": "",
1108         "min_extra_mods": "",
1109         "ssl": None,
1110         "extmod_whitelist": {},
1111         "extmod_blacklist": {},
1112         "clean_dynamic_modules": True,
1113         "django_auth_path": "",
1114         "django_auth_settings": "",
1115         "allow_minion_key_revoke": True,
1116         "salt_cp_chunk_size": 98304,
1117         "require_minion_sign_messages": False,
1118         "drop_messages_signature_fail": False,
1119         "discovery": False,
1120         "schedule": {},
1121         "auth_events": True,
1122         "minion_data_cache_events": True,
1123         "enable_ssh_minions": False,
1124         "netapi_allow_raw_shell": False,
1125         "fips_mode": False,
1126         "detect_remote_minions": False,
1127         "remote_minions_port": 22,
1128     }
1129 )
1130 DEFAULT_PROXY_MINION_OPTS = immutabletypes.freeze(
1131     {
1132         "conf_file": os.path.join(salt.syspaths.CONFIG_DIR, "proxy"),
1133         "log_file": os.path.join(salt.syspaths.LOGS_DIR, "proxy"),
1134         "add_proxymodule_to_opts": False,
1135         "proxy_merge_grains_in_module": True,
1136         "extension_modules": os.path.join(salt.syspaths.CACHE_DIR, "proxy", "extmods"),
1137         "append_minionid_config_dirs": [
1138             "cachedir",
1139             "pidfile",
1140             "default_include",
1141             "extension_modules",
1142         ],
1143         "default_include": "proxy.d/*.conf",
1144         "proxy_merge_pillar_in_opts": False,
1145         "proxy_deep_merge_pillar_in_opts": False,
1146         "proxy_merge_pillar_in_opts_strategy": "smart",
1147         "proxy_mines_pillar": True,
1148         "proxy_always_alive": True,
1149         "proxy_keep_alive": True,  # by default will try to keep alive the connection
1150         "proxy_keep_alive_interval": 1,  # frequency of the proxy keepalive in minutes
1151         "pki_dir": os.path.join(salt.syspaths.CONFIG_DIR, "pki", "proxy"),
1152         "cachedir": os.path.join(salt.syspaths.CACHE_DIR, "proxy"),
1153         "sock_dir": os.path.join(salt.syspaths.SOCK_DIR, "proxy"),
1154     }
1155 )
1156 DEFAULT_CLOUD_OPTS = immutabletypes.freeze(
1157     {
1158         "verify_env": True,
1159         "default_include": "cloud.conf.d/*.conf",
1160         "ssh_auth": "",
1161         "cachedir": os.path.join(salt.syspaths.CACHE_DIR, "cloud"),
1162         "keysize": 4096,
1163         "os": "",
1164         "script": "bootstrap-salt",
1165         "start_action": None,
1166         "enable_hard_maps": False,
1167         "delete_sshkeys": False,
1168         "deploy_scripts_search_path": "cloud.deploy.d",
1169         "log_file": os.path.join(salt.syspaths.LOGS_DIR, "cloud"),
1170         "log_level": "warning",
1171         "log_level_logfile": None,
1172         "log_datefmt": _DFLT_LOG_DATEFMT,
1173         "log_datefmt_logfile": _DFLT_LOG_DATEFMT_LOGFILE,
1174         "log_fmt_console": _DFLT_LOG_FMT_CONSOLE,
1175         "log_fmt_logfile": _DFLT_LOG_FMT_LOGFILE,
1176         "log_fmt_jid": _DFLT_LOG_FMT_JID,
1177         "log_granular_levels": {},
1178         "log_rotate_max_bytes": 0,
1179         "log_rotate_backup_count": 0,
1180         "bootstrap_delay": 0,
1181         "cache": "localfs",
1182     }
1183 )
1184 DEFAULT_API_OPTS = immutabletypes.freeze(
1185     {
1186         "api_pidfile": os.path.join(salt.syspaths.PIDFILE_DIR, "salt-api.pid"),
1187         "api_logfile": os.path.join(salt.syspaths.LOGS_DIR, "api"),
1188         "rest_timeout": 300,
1189     }
1190 )
1191 DEFAULT_SPM_OPTS = immutabletypes.freeze(
1192     {
1193         "spm_conf_file": os.path.join(salt.syspaths.CONFIG_DIR, "spm"),
1194         "formula_path": salt.syspaths.SPM_FORMULA_PATH,
1195         "pillar_path": salt.syspaths.SPM_PILLAR_PATH,
1196         "reactor_path": salt.syspaths.SPM_REACTOR_PATH,
1197         "spm_logfile": os.path.join(salt.syspaths.LOGS_DIR, "spm"),
1198         "spm_default_include": "spm.d/*.conf",
1199         "spm_repos_config": "/etc/salt/spm.repos",
1200         "spm_cache_dir": os.path.join(salt.syspaths.CACHE_DIR, "spm"),
1201         "spm_build_dir": os.path.join(salt.syspaths.SRV_ROOT_DIR, "spm_build"),
1202         "spm_build_exclude": ["CVS", ".hg", ".git", ".svn"],
1203         "spm_db": os.path.join(salt.syspaths.CACHE_DIR, "spm", "packages.db"),
1204         "cache": "localfs",
1205         "spm_repo_dups": "ignore",
1206         "spm_node_type": "",
1207         "spm_share_dir": os.path<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.join(salt.syspaths.SHARE_DIR, "spm"),
1208     }
1209 )
1210 VM_CONFIG_DEFAULTS = immutabletypes.freeze(
1211     {"default_include": "cloud.profiles.d/*.conf"}
1212 )
1213 PROVIDER_CONFIG_DEFAULTS = immutabletypes.freeze(
1214     {"default_include"</b></font>: "cloud.providers.d/*.conf"}
1215 )
1216 def _normalize_roots(file_roots):
1217     """
1218     Normalize file or pillar roots.
1219     """
1220     for saltenv, dirs in file_roots.items():
1221         normalized_saltenv = str(saltenv)
1222         if normalized_saltenv != saltenv:
1223             file_roots[normalized_saltenv] = file_roots.pop(saltenv)
1224         if not isinstance(dirs, (list, tuple)):
1225             file_roots[normalized_saltenv] = []
1226         file_roots[normalized_saltenv] = _expand_glob_path(
1227             file_roots[normalized_saltenv]
1228         )
1229     return file_roots
1230 def _validate_pillar_roots(pillar_roots):
1231     """
1232     If the pillar_roots option has a key that is None then we will error out,
1233     just replace it with an empty list
1234     """
1235     if not isinstance(pillar_roots, dict):
1236         log.warning(
1237             "The pillar_roots parameter is not properly formatted, using defaults"
1238         )
1239         return {"base": _expand_glob_path([salt.syspaths.BASE_PILLAR_ROOTS_DIR])}
1240     return _normalize_roots(pillar_roots)
1241 def _validate_file_roots(file_roots):
1242     """
1243     If the file_roots option has a key that is None then we will error out,
1244     just replace it with an empty list
1245     """
1246     if not isinstance(file_roots, dict):
1247         log.warning(
1248             "The file_roots parameter is not properly formatted, using defaults"
1249         )
1250         return {"base": _expand_glob_path([salt.syspaths.BASE_FILE_ROOTS_DIR])}
1251     return _normalize_roots(file_roots)
1252 def _expand_glob_path(file_roots):
1253     """
1254     Applies shell globbing to a set of directories and returns
1255     the expanded paths
1256     """
1257     unglobbed_path = []
1258     for path in file_roots:
1259         try:
1260             if glob.has_magic(path):
1261                 unglobbed_path.extend(glob.glob(path))
1262             else:
1263                 unglobbed_path.append(path)
1264         except Exception:  # pylint: disable=broad-except
1265             unglobbed_path.append(path)
1266     return unglobbed_path
1267 def _validate_opts(opts):
1268     """
1269     Check that all of the types of values passed into the config are
1270     of the right types
1271     """
1272     def format_multi_opt(valid_type):
1273         try:
1274             num_types = len(valid_type)
1275         except TypeError:
1276             return valid_type.__name__
1277         else:
1278             def get_types(types, type_tuple):
1279                 for item in type_tuple:
1280                     if isinstance(item, tuple):
1281                         get_types(types, item)
1282                     else:
1283                         try:
1284                             types.append(item.__name__)
1285                         except AttributeError:
1286                             log.warning(
1287                                 "Unable to interpret type %s while validating "
1288                                 "configuration",
1289                                 item,
1290                             )
1291             types = []
1292             get_types(types, valid_type)
1293             ret = ", ".join(types[:-1])
1294             ret += " or " + types[-1]
1295             return ret
1296     errors = []
1297     err = (
1298         "Config option '{}' with value {} has an invalid type of {}, a "
1299         "{} is required for this option"
1300     )
1301     for key, val in opts.items():
1302         if key in VALID_OPTS:
1303             if val is None:
1304                 if VALID_OPTS[key] is None:
1305                     continue
1306                 else:
1307                     try:
1308                         if None in VALID_OPTS[key]:
1309                             continue
1310                     except TypeError:
1311                         pass
1312             if isinstance(val, VALID_OPTS[key]):
1313                 continue
1314             if isinstance(val, str) and val.startswith("sdb://"):
1315                 continue
1316             if hasattr(VALID_OPTS[key], "__call__"):
1317                 try:
1318                     VALID_OPTS[key](val)
1319                     if isinstance(val, (list, dict)):
1320                         errors.append(
1321                             err.format(
1322                                 key, val, type(val).__name__, VALID_OPTS[key].__name__
1323                             )
1324                         )
1325                 except (TypeError, ValueError):
1326                     errors.append(
1327                         err.format(
1328                             key, val, type(val).__name__, VALID_OPTS[key].__name__
1329                         )
1330                     )
1331                 continue
1332             errors.append(
1333                 err.format(
1334                     key, val, type(val).__name__, format_multi_opt(VALID_OPTS[key])
1335                 )
1336             )
1337     if isinstance(opts.get("return"), list):
1338         opts["return"] = ",".join(opts["return"])
1339     for error in errors:
1340         log.warning(error)
1341     if errors:
1342         return False
1343     return True
1344 def _validate_ssh_minion_opts(opts):
1345     """
1346     Ensure we're not using any invalid ssh_minion_opts. We want to make sure
1347     that the ssh_minion_opts does not override any pillar or fileserver options
1348     inherited from the master config. To add other items, modify the if
1349     statement in the for loop below.
1350     """
1351     ssh_minion_opts = opts.get("ssh_minion_opts", {})
1352     if not isinstance(ssh_minion_opts, dict):
1353         log.error("Invalidly-formatted ssh_minion_opts")
1354         opts.pop("ssh_minion_opts")
1355     for opt_name in list(ssh_minion_opts):
1356         if (
1357             re.match("^[a-z0-9]+fs_", opt_name, flags=re.IGNORECASE)
1358             or ("pillar" in opt_name and not "ssh_merge_pillar" == opt_name)
1359             or opt_name in ("fileserver_backend",)
1360         ):
1361             log.warning(
1362                 "'%s' is not a valid ssh_minion_opts parameter, ignoring", opt_name
1363             )
1364             ssh_minion_opts.pop(opt_name)
1365 def _append_domain(opts):
1366     """
1367     Append a domain to the existing id if it doesn't already exist
1368     """
1369     if opts["id"].endswith(opts["append_domain"]):
1370         return opts["id"]
1371     if opts["id"].endswith("."):
1372         return opts["id"]
1373     return "{0[id]}.{0[append_domain]}".format(opts)
1374 def _read_conf_file(path):
1375     """
1376     Read in a config file from a given path and process it into a dictionary
1377     """
1378     log.debug("Reading configuration from %s", path)
1379     append_file_suffix_YAMLError = False
1380     with salt.utils.files.fopen(path, "r") as conf_file:
1381         try:
1382             conf_opts = salt.utils.yaml.safe_load(conf_file) or {}
1383         except salt.utils.yaml.YAMLError as err:
1384             message = "Error parsing configuration file: {} - {}".format(path, err)
1385             log.error(message)
1386             if path.endswith("_schedule.conf"):
1387                 conf_opts = {}
1388                 append_file_suffix_YAMLError = True
1389             else:
1390                 raise salt.exceptions.SaltConfigurationError(message)
1391     if append_file_suffix_YAMLError:
1392         message = "Renaming to {}".format(path + "YAMLError")
1393         log.error(message)
1394         os.replace(path, path + "YAMLError")
1395     if not isinstance(conf_opts, dict):
1396         message = (
1397             "Error parsing configuration file: {} - conf "
1398             "should be a document, not {}.".format(path, type(conf_opts))
1399         )
1400         log.error(message)
1401         raise salt.exceptions.SaltConfigurationError(message)
1402     if "id" in conf_opts:
1403         if not isinstance(conf_opts["id"], str):
1404             conf_opts["id"] = str(conf_opts["id"])
1405         else:
1406             conf_opts["id"] = salt.utils.data.decode(conf_opts["id"])
1407     return conf_opts
1408 def _absolute_path(path, relative_to=None):
1409     """
1410     Return an absolute path. In case ``relative_to`` is passed and ``path`` is
1411     not an absolute path, we try to prepend ``relative_to`` to ``path``and if
1412     that path exists, return that one
1413     """
1414     if path and os.path.isabs(path):
1415         return path
1416     if path and relative_to is not None:
1417         _abspath = os.path.join(relative_to, path)
1418         if os.path.isfile(_abspath):
1419             log.debug(
1420                 "Relative path '%s' converted to existing absolute path '%s'",
1421                 path,
1422                 _abspath,
1423             )
1424             return _abspath
1425     return path
1426 def load_config(path, env_var, default_path=None, exit_on_config_errors=True):
1427     """
1428     Returns configuration dict from parsing either the file described by
1429     ``path`` or the environment variable described by ``env_var`` as YAML.
1430     """
1431     if path is None:
1432         return {}
1433     if default_path is None:
1434         import inspect
1435         previous_frame = inspect.getframeinfo(inspect.currentframe().f_back)
1436         log.warning(
1437             "The function '%s()' defined in '%s' is not yet using the "
1438             "new 'default_path' argument to `salt.config.load_config()`. "
1439             "As such, the '%s' environment variable will be ignored",
1440             previous_frame.function,
1441             previous_frame.filename,
1442             env_var,
1443         )
1444         default_path = DEFAULT_MASTER_OPTS["conf_file"]
1445     env_path = os.environ.get(env_var, path)
1446     if not env_path or not os.path.isfile(env_path):
1447         env_path = path
1448     if path != default_path:
1449         env_path = path
1450     path = env_path
1451     if not os.path.isfile(path):
1452         template = "{}.template".format(path)
1453         if os.path.isfile(template):
1454             log.debug("Writing %s based on %s", path, template)
1455             with salt.utils.files.fopen(path, "w") as out:
1456                 with salt.utils.files.fopen(template, "r") as ifile:
1457                     ifile.readline()  # skip first line
1458                     out.write(ifile.read())
1459     opts = {}
1460     if salt.utils.validate.path.is_readable(path):
1461         try:
1462             opts = _read_conf_file(path)
1463             opts["conf_file"] = path
1464         except salt.exceptions.SaltConfigurationError as error:
1465             log.error(error)
1466             if exit_on_config_errors:
1467                 sys.exit(salt.defaults.exitcodes.EX_GENERIC)
1468     else:
1469         log.debug("Missing configuration file: %s", path)
1470     return opts
1471 def include_config(include, orig_path, verbose, exit_on_config_errors=False):
1472     """
1473     Parses extra configuration file(s) specified in an include list in the
1474     main config file.
1475     """
1476     if not include:
1477         return {}
1478     if orig_path is None:
1479         return {}
1480     if isinstance(include, str):
1481         include = [include]
1482     configuration = {}
1483     for path in include:
1484         path = os.path.expanduser(path)
1485         if not os.path.isabs(path):
1486             path = os.path.join(os.path.dirname(orig_path), path)
1487         glob_matches = glob.glob(path)
1488         if not glob_matches:
1489             if verbose:
1490                 log.warning(
1491                     'Warning parsing configuration file: "include" path/glob '
1492                     "'%s' matches no files",
1493                     path,
1494                 )
1495         for fn_ in sorted(glob_matches):
1496             log.debug("Including configuration from '%s'", fn_)
1497             try:
1498                 opts = _read_conf_file(fn_)
1499             except salt.exceptions.SaltConfigurationError as error:
1500                 log.error(error)
1501                 if exit_on_config_errors:
1502                     sys.exit(salt.defaults.exitcodes.EX_GENERIC)
1503                 else:
1504                     opts = {}
1505             schedule = opts.get("schedule", {})
1506             if schedule and "schedule" in configuration:
1507                 configuration["schedule"].update(schedule)
1508             include = opts.get("include", [])
1509             if include:
1510                 opts.update(include_config(include, fn_, verbose))
1511             salt.utils.dictupdate.update(configuration, opts, True, True)
1512     return configuration
1513 def prepend_root_dir(opts, path_options):
1514     """
1515     Prepends the options that represent filesystem paths with value of the
1516     'root_dir' option.
1517     """
1518     root_dir = os.path.abspath(opts["root_dir"])
1519     def_root_dir = salt.syspaths.ROOT_DIR.rstrip(os.sep)
1520     for path_option in path_options:
1521         if path_option in opts:
1522             path = opts[path_option]
1523             tmp_path_def_root_dir = None
1524             tmp_path_root_dir = None
1525             if path == def_root_dir or path.startswith(def_root_dir + os.sep):
1526                 tmp_path_def_root_dir = path[len(def_root_dir) :]
1527             if root_dir and (path == root_dir or path.startswith(root_dir + os.sep)):
1528                 tmp_path_root_dir = path[len(root_dir) :]
1529             if tmp_path_def_root_dir and not tmp_path_root_dir:
1530                 path = tmp_path_def_root_dir
1531             elif tmp_path_root_dir and not tmp_path_def_root_dir:
1532                 path = tmp_path_root_dir
1533             elif tmp_path_def_root_dir and tmp_path_root_dir:
1534                 if def_root_dir in root_dir:
1535                     path = tmp_path_root_dir
1536                 else:
1537                     path = tmp_path_def_root_dir
1538             elif salt.utils.platform.is_windows() and not os.path.splitdrive(path)[0]:
1539                 pass
1540             elif os.path.isabs(path):
1541                 continue
1542             opts[path_option] = salt.utils.path.join(root_dir, path)
1543 def insert_system_path(opts, paths):
1544     """
1545     Inserts path into python path taking into consideration 'root_dir' option.
1546     """
1547     if isinstance(paths, str):
1548         paths = [paths]
1549     for path in paths:
1550         path_options = {"path": path, "root_dir": opts["root_dir"]}
1551         prepend_root_dir(path_options, path_options)
1552         if os.path.isdir(path_options["path"]) and path_options["path"] not in sys.path:
1553             sys.path.insert(0, path_options["path"])
1554 def minion_config(
1555     path,
1556     env_var="SALT_MINION_CONFIG",
1557     defaults=None,
1558     cache_minion_id=False,
1559     ignore_config_errors=True,
1560     minion_id=None,
1561     role="minion",
1562 ):
1563     """
1564     Reads in the minion configuration file and sets up special options
1565     This is useful for Minion-side operations, such as the
1566     :py:class:`~salt.client.Caller` class, and manually running the loader
1567     interface.
1568     .. code-block:: python
1569         import salt.config
1570         minion_opts = salt.config.minion_config('/etc/salt/minion')
1571     """
1572     if defaults is None:
1573         defaults = DEFAULT_MINION_OPTS.copy()
1574     if not os.environ.get(env_var, None):
1575         salt_config_dir = os.environ.get("SALT_CONFIG_DIR", None)
1576         if salt_config_dir:
1577             env_config_file_path = os.path.join(salt_config_dir, "minion")
1578             if salt_config_dir and os.path.isfile(env_config_file_path):
1579                 os.environ[env_var] = env_config_file_path
1580     overrides = load_config(path, env_var, DEFAULT_MINION_OPTS["conf_file"])
1581     default_include = overrides.get("default_include", defaults["default_include"])
1582     include = overrides.get("include", [])
1583     overrides.update(
1584         include_config(
1585             default_include,
1586             path,
1587             verbose=False,
1588             exit_on_config_errors=not ignore_config_errors,
1589         )
1590     )
1591     overrides.update(
1592         include_config(
1593             include, path, verbose=True, exit_on_config_errors=not ignore_config_errors
1594         )
1595     )
1596     opts = apply_minion_config(
1597         overrides, defaults, cache_minion_id=cache_minion_id, minion_id=minion_id
1598     )
1599     opts["__role"] = role
1600     if role != "master":
1601         apply_sdb(opts)
1602         _validate_opts(opts)
1603     return opts
1604 def mminion_config(path, overrides, ignore_config_errors=True):
1605     opts = minion_config(path, ignore_config_errors=ignore_config_errors, role="master")
1606     opts.update(overrides)
1607     apply_sdb(opts)
1608     _validate_opts(opts)
1609     opts["grains"] = salt.loader.grains(opts)
1610     opts["pillar"] = {}
1611     return opts
1612 def proxy_config(
1613     path,
1614     env_var="SALT_PROXY_CONFIG",
1615     defaults=None,
1616     cache_minion_id=False,
1617     ignore_config_errors=True,
1618     minion_id=None,
1619 ):
1620     """
1621     Reads in the proxy minion configuration file and sets up special options
1622     This is useful for Minion-side operations, such as the
1623     :py:class:`~salt.client.Caller` class, and manually running the loader
1624     interface.
1625     .. code-block:: python
1626         import salt.config
1627         proxy_opts = salt.config.proxy_config('/etc/salt/proxy')
1628     """
1629     if defaults is None:
1630         defaults = DEFAULT_MINION_OPTS.copy()
1631     defaults.update(DEFAULT_PROXY_MINION_OPTS)
1632     if not os.environ.get(env_var, None):
1633         salt_config_dir = os.environ.get("SALT_CONFIG_DIR", None)
1634         if salt_config_dir:
1635             env_config_file_path = os.path.join(salt_config_dir, "proxy")
1636             if salt_config_dir and os.path.isfile(env_config_file_path):
1637                 os.environ[env_var] = env_config_file_path
1638     overrides = load_config(path, env_var, DEFAULT_PROXY_MINION_OPTS["conf_file"])
1639     default_include = overrides.get("default_include", defaults["default_include"])
1640     include = overrides.get("include", [])
1641     overrides.update(
1642         include_config(
1643             default_include,
1644             path,
1645             verbose=False,
1646             exit_on_config_errors=not ignore_config_errors,
1647         )
1648     )
1649     overrides.update(
1650         include_config(
1651             include, path, verbose=True, exit_on_config_errors=not ignore_config_errors
1652         )
1653     )
1654     opts = apply_minion_config(
1655         overrides, defaults, cache_minion_id=cache_minion_id, minion_id=minion_id
1656     )
1657     default_include = opts.get("default_include", defaults["default_include"])
1658     include = opts.get("include", [])
1659     overrides.update(
1660         include_config(
1661             default_include,
1662             path,
1663             verbose=False,
1664             exit_on_config_errors=not ignore_config_errors,
1665         )
1666     )
1667     overrides.update(
1668         include_config(
1669             include, path, verbose=True, exit_on_config_errors=not ignore_config_errors
1670         )
1671     )
1672     opts = apply_minion_config(
1673         overrides, defaults, cache_minion_id=cache_minion_id, minion_id=minion_id
1674     )
1675     apply_sdb(opts)
1676     _validate_opts(opts)
1677     return opts
1678 def syndic_config(
1679     master_config_path,
1680     minion_config_path,
1681     master_env_var="SALT_MASTER_CONFIG",
1682     minion_env_var="SALT_MINION_CONFIG",
1683     minion_defaults=None,
1684     master_defaults=None,
1685 ):
1686     if minion_defaults is None:
1687         minion_defaults = DEFAULT_MINION_OPTS.copy()
1688     if master_defaults is None:
1689         master_defaults = DEFAULT_MASTER_OPTS.copy()
1690     opts = {}
1691     master_opts = master_config(master_config_path, master_env_var, master_defaults)
1692     minion_opts = minion_config(minion_config_path, minion_env_var, minion_defaults)
1693     opts["_minion_conf_file"] = master_opts["conf_file"]
1694     opts["_master_conf_file"] = minion_opts["conf_file"]
1695     opts.update(master_opts)
1696     opts.update(minion_opts)
1697     syndic_opts = {
1698         "__role": "syndic",
1699         "root_dir": opts.get("root_dir", salt.syspaths.ROOT_DIR),
1700         "pidfile": opts.get("syndic_pidfile", "salt-syndic.pid"),
1701         "log_file": opts.get("syndic_log_file", "salt-syndic.log"),
1702         "log_level": master_opts["log_level"],
1703         "id": minion_opts["id"],
1704         "pki_dir": minion_opts["pki_dir"],
1705         "master": opts["syndic_master"],
1706         "interface": master_opts["interface"],
1707         "master_port": int(
1708             opts.get(
1709                 "syndic_master_port",
1710                 opts.get(
1711                     "master_port",
1712                     minion_defaults.get(
1713                         "master_port",
1714                         DEFAULT_MINION_OPTS["master_port"],
1715                     ),
1716                 ),
1717             )
1718         ),
1719         "user": opts.get("syndic_user", opts["user"]),
1720         "sock_dir": os.path.join(
1721             opts["cachedir"], opts.get("syndic_sock_dir", opts["sock_dir"])
1722         ),
1723         "sock_pool_size": master_opts["sock_pool_size"],
1724         "cachedir": master_opts["cachedir"],
1725     }
1726     opts.update(syndic_opts)
1727     prepend_root_dirs = [
1728         "pki_dir",
1729         "cachedir",
1730         "pidfile",
1731         "sock_dir",
1732         "extension_modules",
1733         "autosign_file",
1734         "autoreject_file",
1735         "token_dir",
1736         "autosign_grains_dir",
1737     ]
1738     for config_key in ("log_file", "key_logfile", "syndic_log_file"):
1739         if urllib.parse.urlparse(opts.get(config_key, "")).scheme == "":
1740             prepend_root_dirs.append(config_key)
1741     prepend_root_dir(opts, prepend_root_dirs)
1742     return opts
1743 def apply_sdb(opts, sdb_opts=None):
1744     """
1745     Recurse for sdb:// links for opts
1746     """
1747     import salt.utils.sdb
1748     if sdb_opts is None:
1749         sdb_opts = opts
1750     if isinstance(sdb_opts, str) and sdb_opts.startswith("sdb://"):
1751         return salt.utils.sdb.sdb_get(sdb_opts, opts)
1752     elif isinstance(sdb_opts, dict):
1753         for key, value in sdb_opts.items():
1754             if value is None:
1755                 continue
1756             sdb_opts[key] = apply_sdb(opts, value)
1757     elif isinstance(sdb_opts, list):
1758         for key, value in enumerate(sdb_opts):
1759             if value is None:
1760                 continue
1761             sdb_opts[key] = apply_sdb(opts, value)
1762     return sdb_opts
1763 def cloud_config(
1764     path,
1765     env_var="SALT_CLOUD_CONFIG",
1766     defaults=None,
1767     master_config_path=None,
1768     master_config=None,
1769     providers_config_path=None,
1770     providers_config=None,
1771     profiles_config_path=None,
1772     profiles_config=None,
1773 ):
1774     """
1775     Read in the Salt Cloud config and return the dict
1776     """
1777     if path:
1778         config_dir = os.path.dirname(path)
1779     else:
1780         config_dir = salt.syspaths.CONFIG_DIR
1781     overrides = load_config(path, env_var, os.path.join(config_dir, "cloud"))
1782     if defaults is None:
1783         defaults = DEFAULT_CLOUD_OPTS.copy()
1784     defaults.update(overrides)
1785     overrides = defaults
1786     overrides.update(
1787         salt.config.include_config(overrides["default_include"], path, verbose=False)
1788     )
1789     include = overrides.get("include", [])
1790     overrides.update(salt.config.include_config(include, path, verbose=True))
1791     if "master_config" in overrides and master_config_path is None:
1792         master_config_path = overrides["master_config"]
1793     elif (
1794         "master_config" not in overrides
1795         and not master_config
1796         and not master_config_path
1797     ):
1798         master_config_path = os.path.join(config_dir, "master")
1799     master_config_path = _absolute_path(master_config_path, config_dir)
1800     if "providers_config" in overrides and providers_config_path is None:
1801         providers_config_path = overrides["providers_config"]
1802     elif (
1803         "providers_config" not in overrides
1804         and not providers_config
1805         and not providers_config_path
1806     ):
1807         providers_config_path = os.path.join(config_dir, "cloud.providers")
1808     providers_config_path = _absolute_path(providers_config_path, config_dir)
1809     if "profiles_config" in overrides and profiles_config_path is None:
1810         profiles_config_path = overrides["profiles_config"]
1811     elif (
1812         "profiles_config" not in overrides
1813         and not profiles_config
1814         and not profiles_config_path
1815     ):
1816         profiles_config_path = os.path.join(config_dir, "cloud.profiles")
1817     profiles_config_path = _absolute_path(profiles_config_path, config_dir)
1818     deploy_scripts_search_path = overrides.get(
1819         "deploy_scripts_search_path",
1820         defaults.get("deploy_scripts_search_path", "cloud.deploy.d"),
1821     )
1822     if isinstance(deploy_scripts_search_path, str):
1823         deploy_scripts_search_path = [deploy_scripts_search_path]
1824     for idx, entry in enumerate(deploy_scripts_search_path[:]):
1825         if not os.path.isabs(entry):
1826             entry = os.path.join(os.path.dirname(path), entry)
1827         if os.path.isdir(entry):
1828             deploy_scripts_search_path[idx] = entry
1829             continue
1830     deploy_scripts_search_path<font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.append(
1831         os.path.abspath(
1832             os.path.join(os.path.dirname(__file__), "..", "cloud", "deploy")
1833         )
1834     )
1835     overrides.</b></font>update(deploy_scripts_search_path=tuple(deploy_scripts_search_path))
1836     if master_config_path is not None and master_config is not None:
1837         raise salt.exceptions.SaltCloudConfigError(
1838             "Only pass `master_config` or `master_config_path`, not both."
1839         )
1840     elif master_config_path is None and master_config is None:
1841         master_config = salt.config.master_config(
1842             overrides.get(
1843                 "master_config",
1844                 os.path.join(salt.syspaths.CONFIG_DIR, "master"),
1845             )
1846         )
1847     elif master_config_path is not None and master_config is None:
1848         master_config = salt.config.master_config(master_config_path)
1849     del master_config["cachedir"]
1850     master_config.update(overrides)
1851     overrides = master_config
1852     if providers_config_path is not None and providers_config is not None:
1853         raise salt.exceptions.SaltCloudConfigError(
1854             "Only pass `providers_config` or `providers_config_path`, not both."
1855         )
1856     elif providers_config_path is None and providers_config is None:
1857         providers_config_path = overrides.get(
1858             "providers_config",
1859             os.path.join(salt.syspaths.CONFIG_DIR, "cloud.providers"),
1860         )
1861     if profiles_config_path is not None and profiles_config is not None:
1862         raise salt.exceptions.SaltCloudConfigError(
1863             "Only pass `profiles_config` or `profiles_config_path`, not both."
1864         )
1865     elif profiles_config_path is None and profiles_config is None:
1866         profiles_config_path = overrides.get(
1867             "profiles_config",
1868             os.path.join(salt.syspaths.CONFIG_DIR, "cloud.profiles"),
1869         )
1870     opts = apply_cloud_config(overrides, defaults)
1871     if "providers" in opts:
1872         if providers_config is not None:
1873             raise salt.exceptions.SaltCloudConfigError(
1874                 "Do not mix the old cloud providers configuration with "
1875                 "the passing a pre-configured providers configuration "
1876                 "dictionary."
1877             )
1878         if providers_config_path is not None:
1879             providers_confd = os.path.join(
1880                 os.path.dirname(providers_config_path), "cloud.providers.d", "*"
1881             )
1882             if os.path.isfile(providers_config_path) or glob.glob(providers_confd):
1883                 raise salt.exceptions.SaltCloudConfigError(
1884                     "Do not mix the old cloud providers configuration with "
1885                     "the new one. The providers configuration should now go "
1886                     "in the file `{0}` or a separate `*.conf` file within "
1887                     "`cloud.providers.d/` which is relative to `{0}`.".format(
1888                         os.path.join(salt.syspaths.CONFIG_DIR, "cloud.providers")
1889                     )
1890                 )
1891         providers_config = opts["providers"]
1892     elif providers_config_path is not None:
1893         providers_config = cloud_providers_config(providers_config_path)
1894     opts["providers"] = providers_config
1895     if profiles_config is None:
1896         profiles_config = vm_profiles_config(profiles_config_path, providers_config)
1897     opts["profiles"] = profiles_config
1898     apply_sdb(opts)
1899     prepend_root_dirs = ["cachedir"]
1900     if "log_file" in opts and urllib.parse.urlparse(opts["log_file"]).scheme == "":
1901         prepend_root_dirs.append(opts["log_file"])
1902     prepend_root_dir(opts, prepend_root_dirs)
1903     return opts
1904 def apply_cloud_config(overrides, defaults=None):
1905     """
1906     Return a cloud config
1907     """
1908     if defaults is None:
1909         defaults = DEFAULT_CLOUD_OPTS.copy()
1910     config = defaults.copy()
1911     if overrides:
1912         config.update(overrides)
1913     if "providers" in config:
1914         providers = config["providers"].copy()
1915         config["providers"] = {}
1916         for alias, details in providers.items():
1917             if isinstance(details, list):
1918                 for detail in details:
1919                     if "driver" not in detail:
1920                         raise salt.exceptions.SaltCloudConfigError(
1921                             "The cloud provider alias '{}' has an entry "
1922                             "missing the required setting of 'driver'.".format(alias)
1923                         )
1924                     driver = detail["driver"]
1925                     if ":" in driver:
1926                         alias, driver = driver.split(":")
1927                     if alias not in config["providers"]:
1928                         config["providers"][alias] = {}
1929                     detail["provider"] = "{}:{}".format(alias, driver)
1930                     config["providers"][alias][driver] = detail
1931             elif isinstance(details, dict):
1932                 if "driver" not in details:
1933                     raise salt.exceptions.SaltCloudConfigError(
1934                         "The cloud provider alias '{}' has an entry "
1935                         "missing the required setting of 'driver'".format(alias)
1936                     )
1937                 driver = details["driver"]
1938                 if ":" in driver:
1939                     alias, driver = driver.split(":")
1940                 if alias not in config["providers"]:
1941                     config["providers"][alias] = {}
1942                 details["provider"] = "{}:{}".format(alias, driver)
1943                 config["providers"][alias][driver] = details
1944     config = old_to_new(config)
1945     return config
1946 def old_to_new(opts):
1947     providers = (
1948         "AWS",
1949         "CLOUDSTACK",
1950         "DIGITALOCEAN",
1951         "EC2",
1952         "GOGRID",
1953         "IBMSCE",
1954         "JOYENT",
1955         "LINODE",
1956         "OPENSTACK",
1957         "PARALLELS",
1958         "RACKSPACE",
1959         "SALTIFY",
1960     )
1961     for provider in providers:
1962         provider_config = {}
1963         for opt, val in opts.items():
1964             if provider in opt:
1965                 value = val
1966                 name = opt.split(".", 1)[1]
1967                 provider_config[name] = value
1968         lprovider = provider.lower()
1969         if provider_config:
1970             provider_config["provider"] = lprovider
1971             opts.setdefault("providers", {})
1972             opts["providers"][lprovider] = {}
1973             opts["providers"][lprovider][lprovider] = provider_config
1974     return opts
1975 def vm_profiles_config(path, providers, env_var="SALT_CLOUDVM_CONFIG", defaults=None):
1976     """
1977     Read in the salt cloud VM config file
1978     """
1979     if defaults is None:
1980         defaults = VM_CONFIG_DEFAULTS
1981     overrides = salt.config.load_config(
1982         path, env_var, os.path.join(salt.syspaths.CONFIG_DIR, "cloud.profiles")
1983     )
1984     default_include = overrides.get("default_include", defaults["default_include"])
1985     include = overrides.get("include", [])
1986     overrides.update(salt.config.include_config(default_include, path, verbose=False))
1987     overrides.update(salt.config.include_config(include, path, verbose=True))
1988     return apply_vm_profiles_config(providers, overrides, defaults)
1989 def apply_vm_profiles_config(providers, overrides, defaults=None):
1990     if defaults is None:
1991         defaults = VM_CONFIG_DEFAULTS
1992     config = defaults.copy()
1993     if overrides:
1994         config.update(overrides)
1995     vms = {}
1996     for key, val in config.items():
1997         if key in ("conf_file", "include", "default_include", "user"):
1998             continue
1999         if not isinstance(val, dict):
2000             raise salt.exceptions.SaltCloudConfigError(
2001                 "The VM profiles configuration found in '{0[conf_file]}' is "
2002                 "not in the proper format".format(config)
2003             )
2004         val["profile"] = key
2005         vms[key] = val
2006     for profile, details in vms.copy().items():
2007         if "extends" not in details:
2008             if ":" in details["provider"]:
2009                 alias, driver = details["provider"].split(":")
2010                 if alias not in providers or driver not in providers[alias]:
2011                     log.trace(
2012                         "The profile '%s' is defining '%s' "
2013                         "as the provider. Since there is no valid "
2014                         "configuration for that provider, the profile will be "
2015                         "removed from the available listing",
2016                         profile,
2017                         details["provider"],
2018                     )
2019                     vms.pop(profile)
2020                     continue
2021                 if "profiles" not in providers[alias][driver]:
2022                     providers[alias][driver]["profiles"] = {}
2023                 providers[alias][driver]["profiles"][profile] = details
2024             if details["provider"] not in providers:
2025                 log.trace(
2026                     "The profile '%s' is defining '%s' as the "
2027                     "provider. Since there is no valid configuration for "
2028                     "that provider, the profile will be removed from the "
2029                     "available listing",
2030                     profile,
2031                     details["provider"],
2032                 )
2033                 vms.pop(profile)
2034                 continue
2035             driver = next(iter(list(providers[details["provider"]].keys())))
2036             providers[details["provider"]][driver].setdefault("profiles", {}).update(
2037                 {profile: details}
2038             )
2039             details["provider"] = "{0[provider]}:{1}".format(details, driver)
2040             vms[profile] = details
2041             continue
2042         extends = details.pop("extends")
2043         if extends not in vms:
2044             log.error(
2045                 "The '%s' profile is trying to extend data from '%s' "
2046                 "though '%s' is not defined in the salt profiles loaded "
2047                 "data. Not extending and removing from listing!",
2048                 profile,
2049                 extends,
2050                 extends,
2051             )
2052             vms.pop(profile)
2053             continue
2054         extended = deepcopy(vms.get(extends))
2055         extended.pop("profile")
2056         extended = salt.utils.dictupdate.update(extended, details)
2057         if ":" not in extended["provider"]:
2058             if extended["provider"] not in providers:
2059                 log.trace(
2060                     "The profile '%s' is defining '%s' as the "
2061                     "provider. Since there is no valid configuration for "
2062                     "that provider, the profile will be removed from the "
2063                     "available listing",
2064                     profile,
2065                     extended["provider"],
2066                 )
2067                 vms.pop(profile)
2068                 continue
2069             driver = next(iter(list(providers[extended["provider"]].keys())))
2070             providers[extended["provider"]][driver].setdefault("profiles", {}).update(
2071                 {profile: extended}
2072             )
2073             extended["provider"] = "{0[provider]}:{1}".format(extended, driver)
2074         else:
2075             alias, driver = extended["provider"].split(":")
2076             if alias not in providers or driver not in providers[alias]:
2077                 log.trace(
2078                     "The profile '%s' is defining '%s' as "
2079                     "the provider. Since there is no valid configuration "
2080                     "for that provider, the profile will be removed from "
2081                     "the available listing",
2082                     profile,
2083                     extended["provider"],
2084                 )
2085                 vms.pop(profile)
2086                 continue
2087             providers[alias][driver].setdefault("profiles", {}).update(
2088                 {profile: extended}
2089             )
2090         vms[profile] = extended
2091     return vms
2092 def cloud_providers_config(path, env_var="SALT_CLOUD_PROVIDERS_CONFIG", defaults=None):
2093     """
2094     Read in the salt cloud providers configuration file
2095     """
2096     if defaults is None:
2097         defaults = PROVIDER_CONFIG_DEFAULTS
2098     overrides = salt.config.load_config(
2099         path, env_var, os.path.join(salt.syspaths.CONFIG_DIR, "cloud.providers")
2100     )
2101     default_include = overrides.get("default_include", defaults["default_include"])
2102     include = overrides.get("include", [])
2103     overrides.update(salt.config.include_config(default_include, path, verbose=False))
2104     overrides.update(salt.config.include_config(include, path, verbose=True))
2105     return apply_cloud_providers_config(overrides, defaults)
2106 def apply_cloud_providers_config(overrides, defaults=None):
2107     """
2108     Apply the loaded cloud providers configuration.
2109     """
2110     if defaults is None:
2111         defaults = PROVIDER_CONFIG_DEFAULTS
2112     config = defaults.copy()
2113     if overrides:
2114         config.update(overrides)
2115     for name, settings in config.copy().items():
2116         if "." in name:
2117             log.warning("Please switch to the new providers configuration syntax")
2118             config = old_to_new(config)
2119             for prov_name, prov_settings in config.pop("providers").items():
2120                 config[prov_name] = prov_settings
2121             break
2122     providers = {}
2123     ext_count = 0
2124     for key, val in config.items():
2125         if key in ("conf_file", "include", "default_include", "user"):
2126             continue
2127         if not isinstance(val, (list, tuple)):
2128             val = [val]
2129         else:
2130             handled_providers = set()
2131             for details in val:
2132                 if "driver" not in details:
2133                     if "extends" not in details:
2134                         log.error(
2135                             "Please check your cloud providers configuration. "
2136                             "There's no 'driver' nor 'extends' definition "
2137                             "referenced."
2138                         )
2139                     continue
2140                 if details["driver"] in handled_providers:
2141                     log.error(
2142                         "You can only have one entry per cloud provider. For "
2143                         "example, if you have a cloud provider configuration "
2144                         "section named, 'production', you can only have a "
2145                         "single entry for EC2, Joyent, Openstack, and so "
2146                         "forth."
2147                     )
2148                     raise salt.exceptions.SaltCloudConfigError(
2149                         "The cloud provider alias '{0}' has multiple entries "
2150                         "for the '{1[driver]}' driver.".format(key, details)
2151                     )
2152                 handled_providers.add(details["driver"])
2153         for entry in val:
2154             if "driver" not in entry:
2155                 entry["driver"] = "-only-extendable-{}".format(ext_count)
2156                 ext_count += 1
2157             if key not in providers:
2158                 providers[key] = {}
2159             provider = entry["driver"]
2160             if provider not in providers[key]:
2161                 providers[key][provider] = entry
2162     while True:
2163         keep_looping = False
2164         for provider_alias, entries in providers.copy().items():
2165             for driver, details in entries.items():
2166                 providers[provider_alias][driver]["profiles"] = {}
2167                 if "extends" not in details:
2168                     continue
2169                 extends = details.pop("extends")
2170                 if ":" in extends:
2171                     alias, provider = extends.split(":")
2172                     if alias not in providers:
2173                         raise salt.exceptions.SaltCloudConfigError(
2174                             "The '{0}' cloud provider entry in '{1}' is "
2175                             "trying to extend data from '{2}' though "
2176                             "'{2}' is not defined in the salt cloud "
2177                             "providers loaded data.".format(
2178                                 details["driver"], provider_alias, alias
2179                             )
2180                         )
2181                     if provider not in providers.get(alias):
2182                         raise salt.exceptions.SaltCloudConfigError(
2183                             "The '{0}' cloud provider entry in '{1}' is "
2184                             "trying to extend data from '{2}:{3}' though "
2185                             "'{3}' is not defined in '{1}'".format(
2186                                 details["driver"], provider_alias, alias, provider
2187                             )
2188                         )
2189                     details["extends"] = "{}:{}".format(alias, provider)
2190                     details["driver"] = provider
2191                 elif providers.get(extends):
2192                     raise salt.exceptions.SaltCloudConfigError(
2193                         "The '{}' cloud provider entry in '{}' is "
2194                         "trying to extend from '{}' and no provider was "
2195                         "specified. Not extending!".format(
2196                             details["driver"], provider_alias, extends
2197                         )
2198                     )
2199                 elif extends not in providers:
2200                     raise salt.exceptions.SaltCloudConfigError(
2201                         "The '{0}' cloud provider entry in '{1}' is "
2202                         "trying to extend data from '{2}' though '{2}' "
2203                         "is not defined in the salt cloud providers loaded "
2204                         "data.".format(details["driver"], provider_alias, extends)
2205                     )
2206                 else:
2207                     if driver in providers.get(extends):
2208                         details["extends"] = "{}:{}".format(extends, driver)
2209                     elif "-only-extendable-" in providers.get(extends):
2210                         details["extends"] = "{}:{}".format(
2211                             extends, "-only-extendable-{}".format(ext_count)
2212                         )
2213                     else:
2214                         details["extends"] = extends
2215                         keep_looping = True
2216         if not keep_looping:
2217             break
2218     while True:
2219         keep_looping = False
2220         for alias, entries in providers.copy().items():
2221             for driver in list(entries.keys()):
2222                 details = entries[driver]
2223                 if "extends" not in details:
2224                     continue
2225                 if "extends" in details["extends"]:
2226                     keep_looping = True
2227                     continue
2228                 extends = details.pop("extends")
2229                 ext_alias, ext_driver = extends.split(":")
2230                 extended = providers.get(ext_alias).get(ext_driver).copy()
2231                 extended = salt.utils.dictupdate.update(extended, details)
2232                 providers[alias][driver] = extended
2233                 if driver.startswith("-only-extendable-"):
2234                     providers[alias][ext_driver] = providers[alias][driver]
2235                     del providers[alias][driver]
2236         if not keep_looping:
2237             break
2238     for provider_alias, entries in providers.copy().items():
2239         for driver, details in entries.copy().items():
2240             if not driver.startswith("-only-extendable-"):
2241                 continue
2242             log.info(
2243                 "There's at least one cloud driver under the '%s' "
2244                 "cloud provider alias which does not have the required "
2245                 "'driver' setting. Removing it from the available "
2246                 "providers listing.",
2247                 provider_alias,
2248             )
2249             providers[provider_alias].pop(driver)
2250         if not providers[provider_alias]:
2251             providers.pop(provider_alias)
2252     return providers
2253 def get_cloud_config_value(name, vm_, opts, default=None, search_global=True):
2254     """
2255     Search and return a setting in a known order:
2256         1. In the virtual machine's configuration
2257         2. In the virtual machine's profile configuration
2258         3. In the virtual machine's provider configuration
2259         4. In the salt cloud configuration if global searching is enabled
2260         5. Return the provided default
2261     """
2262     value = default
2263     if search_global is True and opts.get(name, None) is not None:
2264         value = deepcopy(opts[name])
2265     if vm_ and name:
2266         if "profile" in vm_ and vm_["profile"] is not None:
2267             if name in opts["profiles"][vm_["profile"]]:
2268                 if isinstance(value, dict):
2269                     value.update(opts["profiles"][vm_["profile"]][name].copy())
2270                 else:
2271                     value = deepcopy(opts["profiles"][vm_["profile"]][name])
2272         if ":" in vm_["driver"]:
2273             alias, driver = vm_["driver"].split(":")
2274             if alias in opts["providers"] and driver in opts["providers"][alias]:
2275                 details = opts["providers"][alias][driver]
2276                 if name in details:
2277                     if isinstance(value, dict):
2278                         value.update(details[name].copy())
2279                     else:
2280                         value = deepcopy(details[name])
2281         elif len(opts["providers"].get(vm_["driver"], ())) &gt; 1:
2282             log.error(
2283                 "The '%s' cloud provider definition has more than one "
2284                 "entry. Your VM configuration should be specifying the "
2285                 "provider as 'driver: %s:&lt;driver-engine&gt;'. Since "
2286                 "it's not, we're returning the first definition which "
2287                 "might not be what you intended.",
2288                 vm_["driver"],
2289                 vm_["driver"],
2290             )
2291         if vm_["driver"] in opts["providers"]:
2292             alias_defs = opts["providers"].get(vm_["driver"])
2293             provider_driver_defs = alias_defs[next(iter(list(alias_defs.keys())))]
2294             if name in provider_driver_defs:
2295                 if isinstance(value, dict):
2296                     value.update(provider_driver_defs[name].copy())
2297                 else:
2298                     value = deepcopy(provider_driver_defs[name])
2299     if name and vm_ and name in vm_:
2300         if isinstance(vm_[name], types.GeneratorType):
2301             value = next(vm_[name], "")
2302         else:
2303             if isinstance(value, dict) and isinstance(vm_[name], dict):
2304                 value.update(vm_[name].copy())
2305             else:
2306                 value = deepcopy(vm_[name])
2307     return value
2308 def is_provider_configured(
2309     opts, provider, required_keys=(), log_message=True, aliases=()
2310 ):
2311     """
2312     Check and return the first matching and fully configured cloud provider
2313     configuration.
2314     """
2315     if ":" in provider:
2316         alias, driver = provider.split(":")
2317         if alias not in opts["providers"]:
2318             return False
2319         if driver not in opts["providers"][alias]:
2320             return False
2321         for key in required_keys:
2322             if opts["providers"][alias][driver].get(key, None) is None:
2323                 if log_message is True:
2324                     log.warning(
2325                         "The required '%s' configuration setting is missing "
2326                         "from the '%s' driver, which is configured under the "
2327                         "'%s' alias.",
2328                         key,
2329                         provider,
2330                         alias,
2331                     )
2332                 return False
2333         return opts["providers"][alias][driver]
2334     for alias, drivers in opts["providers"].items():
2335         for driver, provider_details in drivers.items():
2336             if driver != provider and driver not in aliases:
2337                 continue
2338             skip_provider = False
2339             for key in required_keys:
2340                 if provider_details.get(key, None) is None:
2341                     if log_message is True:
2342                         log.warning(
2343                             "The required '%s' configuration setting is "
2344                             "missing from the '%s' driver, which is configured "
2345                             "under the '%s' alias.",
2346                             key,
2347                             provider,
2348                             alias,
2349                         )
2350                     skip_provider = True
2351                     break
2352             if skip_provider:
2353                 continue
2354             return provider_details
2355     return False
2356 def is_profile_configured(opts, provider, profile_name, vm_=None):
2357     """
2358     Check if the requested profile contains the minimum required parameters for
2359     a profile.
2360     Required parameters include image and provider for all drivers, while some
2361     drivers also require size keys.
2362     .. versionadded:: 2015.8.0
2363     """
2364     required_keys = ["provider"]
2365     alias, driver = provider.split(":")
2366     non_image_drivers = [
2367         "nova",
2368         "virtualbox",
2369         "libvirt",
2370         "softlayer",
2371         "oneandone",
2372         "profitbricks",
2373     ]
2374     non_size_drivers = [
2375         "opennebula",
2376         "parallels",
2377         "proxmox",
2378         "scaleway",
2379         "softlayer",
2380         "softlayer_hw",
2381         "vmware",
2382         "vsphere",
2383         "virtualbox",
2384         "libvirt",
2385         "oneandone",
2386         "profitbricks",
2387     ]
2388     provider_key = opts["providers"][alias][driver]
2389     profile_key = opts["providers"][alias][driver]["profiles"][profile_name]
2390     if driver == "linode" and profile_key.get("clonefrom", False):
2391         non_image_drivers.append("linode")
2392         non_size_drivers.append("linode")
2393     elif driver == "gce" and "sourceImage" in str(vm_.get("ex_disks_gce_struct")):
2394         non_image_drivers.append("gce")
2395     if driver == "vmware" and "image" not in list(profile_key.keys()):
2396         non_image_drivers.append("vmware")
2397     if driver not in non_image_drivers:
2398         required_keys.append("image")
2399         if driver == "vmware":
2400             required_keys.append("datastore")
2401     elif driver in ["linode", "virtualbox"]:
2402         required_keys.append("clonefrom")
2403     elif driver == "nova":
2404         nova_image_keys = [
2405             "image",
2406             "block_device_mapping",
2407             "block_device",
2408             "boot_volume",
2409         ]
2410         if not any([key in provider_key for key in nova_image_keys]) and not any(
2411             [key in profile_key for key in nova_image_keys]
2412         ):
2413             required_keys.extend(nova_image_keys)
2414     if driver not in non_size_drivers:
2415         required_keys.append("size")
2416     for item in list(required_keys):
2417         if item in provider_key:
2418             required_keys.remove(item)
2419     if vm_:
2420         for item in list(required_keys):
2421             if item in vm_:
2422                 required_keys.remove(item)
2423     for item in required_keys:
2424         if profile_key.get(item, None) is None:
2425             log.error(
2426                 "The required '%s' configuration setting is missing from "
2427                 "the '%s' profile, which is configured under the '%s' alias.",
2428                 item,
2429                 profile_name,
2430                 alias,
2431             )
2432             return False
2433     return True
2434 def check_driver_dependencies(driver, dependencies):
2435     """
2436     Check if the driver's dependencies are available.
2437     .. versionadded:: 2015.8.0
2438     driver
2439         The name of the driver.
2440     dependencies
2441         The dictionary of dependencies to check.
2442     """
2443     ret = True
2444     for key, value in dependencies.items():
2445         if value is False:
2446             log.warning(
2447                 "Missing dependency: '%s'. The %s driver requires "
2448                 "'%s' to be installed.",
2449                 key,
2450                 driver,
2451                 key,
2452             )
2453             ret = False
2454     return ret
2455 def _cache_id(minion_id, cache_file):
2456     """
2457     Helper function, writes minion id to a cache file.
2458     """
2459     path = os.path.dirname(cache_file)
2460     try:
2461         if not os.path.isdir(path):
2462             os.makedirs(path)
2463     except OSError as exc:
2464         if os.path.isdir(path):
2465             pass
2466         else:
2467             log.error("Failed to create dirs to minion_id file: %s", exc)
2468     try:
2469         with salt.utils.files.fopen(cache_file, "w") as idf:
2470             idf.write(minion_id)
2471     except OSError as exc:
2472         log.error("Could not cache minion ID: %s", exc)
2473 def call_id_function(opts):
2474     """
2475     Evaluate the function that determines the ID if the 'id_function'
2476     option is set and return the result
2477     """
2478     if opts.get("id"):
2479         return opts["id"]
2480     import salt.loader as loader
2481     if isinstance(opts["id_function"], str):
2482         mod_fun = opts["id_function"]
2483         fun_kwargs = {}
2484     elif isinstance(opts["id_function"], dict):
2485         mod_fun, fun_kwargs = next(iter(opts["id_function"].items()))
2486         if fun_kwargs is None:
2487             fun_kwargs = {}
2488     else:
2489         log.error("'id_function' option is neither a string nor a dictionary")
2490         sys.exit(salt.defaults.exitcodes.EX_GENERIC)
2491     mod, fun = mod_fun.split(".")
2492     if not opts.get("grains"):
2493         opts["grains"] = loader.grains(opts)
2494     try:
2495         id_mod = loader.raw_mod(opts, mod, fun)
2496         if not id_mod:
2497             raise KeyError
2498         newid = id_mod[mod_fun](**fun_kwargs)
2499         if not isinstance(newid, str) or not newid:
2500             log.error(
2501                 'Function %s returned value "%s" of type %s instead of string',
2502                 mod_fun,
2503                 newid,
2504                 type(newid),
2505             )
2506             sys.exit(salt.defaults.exitcodes.EX_GENERIC)
2507         log.info("Evaluated minion ID from module: %s %s", mod_fun, newid)
2508         return newid
2509     except TypeError:
2510         log.error(
2511             "Function arguments %s are incorrect for function %s", fun_kwargs, mod_fun
2512         )
2513         sys.exit(salt.defaults.exitcodes.EX_GENERIC)
2514     except KeyError:
2515         log.error("Failed to load module %s", mod_fun)
2516         sys.exit(salt.defaults.exitcodes.EX_GENERIC)
2517 def remove_domain_from_fqdn(opts, newid):
2518     """
2519     Depending on the values of `minion_id_remove_domain`,
2520     remove all domains or a single domain from a FQDN, effectivly generating a hostname.
2521     """
2522     opt_domain = opts.get("minion_id_remove_domain")
2523     if opt_domain is True:
2524         if "." in newid:
2525             newid, xdomain = newid.split(".", 1)
2526             log.debug("Removed any domain (%s) from minion id.", xdomain)
2527     else:
2528         if newid.upper().endswith("." + opt_domain.upper()):
2529             newid = newid[: -len("." + opt_domain)]
2530             log.debug("Removed single domain %s from minion id.", opt_domain)
2531     return newid
2532 def get_id(opts, cache_minion_id=False):
2533     """
2534     Guess the id of the minion.
2535     If CONFIG_DIR/minion_id exists, use the cached minion ID from that file.
2536     If no minion id is configured, use multiple sources to find a FQDN.
2537     If no FQDN is found you may get an ip address.
2538     Returns two values: the detected ID, and a boolean value noting whether or
2539     not an IP address is being used for the ID.
2540     """
2541     if opts["root_dir"] is None:
2542         root_dir = salt.syspaths.ROOT_DIR
2543     else:
2544         root_dir = opts["root_dir"]
2545     config_dir = salt.syspaths.CONFIG_DIR
2546     if config_dir.startswith(salt.syspaths.ROOT_DIR):
2547         config_dir = config_dir.split(salt.syspaths.ROOT_DIR, 1)[-1]
2548     id_cache = os.path.join(root_dir, config_dir.lstrip(os.path.sep), "minion_id")
2549     if opts.get("minion_id_caching", True):
2550         try:
2551             with salt.utils.files.fopen(id_cache) as idf:
2552                 name = salt.utils.stringutils.to_unicode(idf.readline().strip())
2553                 bname = salt.utils.stringutils.to_bytes(name)
2554                 if bname.startswith(codecs.BOM):  # Remove BOM if exists
2555                     name = salt.utils.stringutils.to_str(
2556                         bname.replace(codecs.BOM, "", 1)
2557                     )
2558             if name and name != "localhost":
2559                 log.debug("Using cached minion ID from %s: %s", id_cache, name)
2560                 return name, False
2561         except OSError:
2562             pass
2563     if "__role" in opts and opts.get("__role") == "minion":
2564         log.debug(
2565             "Guessing ID. The id can be explicitly set in %s",
2566             os.path.join(salt.syspaths.CONFIG_DIR, "minion"),
2567         )
2568     if opts.get("id_function"):
2569         newid = call_id_function(opts)
2570     else:
2571         newid = salt.utils.network.generate_minion_id()
2572     if opts.get("minion_id_lowercase"):
2573         newid = newid.lower()
2574         log.debug("Changed minion id %s to lowercase.", newid)
2575     if opts.get("minion_id_remove_domain"):
2576         newid = remove_domain_from_fqdn(opts, newid)
2577     if "__role" in opts and opts.get("__role") == "minion":
2578         if opts.get("id_function"):
2579             log.debug(
2580                 "Found minion id from external function %s: %s",
2581                 opts["id_function"],
2582                 newid,
2583             )
2584         else:
2585             log.debug("Found minion id from generate_minion_id(): %s", newid)
2586     if cache_minion_id and opts.get("minion_id_caching", True):
2587         _cache_id(newid, id_cache)
2588     is_ipv4 = salt.utils.network.is_ipv4(newid)
2589     return newid, is_ipv4
2590 def _update_ssl_config(opts):
2591     """
2592     Resolves string names to integer constant in ssl configuration.
2593     """
2594     if opts["ssl"] in (None, False):
2595         opts["ssl"] = None
2596         return
2597     if opts["ssl"] is True:
2598         opts["ssl"] = {}
2599         return
2600     import ssl
2601     for key, prefix in (("cert_reqs", "CERT_"), ("ssl_version", "PROTOCOL_")):
2602         val = opts["ssl"].get(key)
2603         if val is None:
2604             continue
2605         if (
2606             not isinstance(val, str)
2607             or not val.startswith(prefix)
2608             or not hasattr(ssl, val)
2609         ):
2610             message = "SSL option '{}' must be set to one of the following values: '{}'.".format(
2611                 key,
2612                 "', '".join([val for val in dir(ssl) if val.startswith(prefix)]),
2613             )
2614             log.error(message)
2615             raise salt.exceptions.SaltConfigurationError(message)
2616         opts["ssl"][key] = getattr(ssl, val)
2617 def _adjust_log_file_override(overrides, default_log_file):
2618     """
2619     Adjusts the log_file based on the log_dir override
2620     """
2621     if overrides.get("log_dir"):
2622         if overrides.get("log_file"):
2623             if not os.path.isabs(overrides["log_file"]):
2624                 overrides["log_file"] = os.path.join(
2625                     overrides["log_dir"], overrides["log_file"]
2626                 )
2627         else:
2628             overrides["log_file"] = os.path.join(
2629                 overrides["log_dir"], os.path.basename(default_log_file)
2630             )
2631 def apply_minion_config(
2632     overrides=None, defaults=None, cache_minion_id=False, minion_id=None
2633 ):
2634     """
2635     Returns minion configurations dict.
2636     """
2637     if defaults is None:
2638         defaults = DEFAULT_MINION_OPTS.copy()
2639     if overrides is None:
2640         overrides = {}
2641     opts = defaults.copy()
2642     opts["__role"] = "minion"
2643     _adjust_log_file_override(overrides, defaults["log_file"])
2644     if overrides:
2645         opts.update(overrides)
2646     if "environment" in opts:
2647         if opts["saltenv"] is not None:
2648             log.warning(
2649                 "The 'saltenv' and 'environment' minion config options "
2650                 "cannot both be used. Ignoring 'environment' in favor of "
2651                 "'saltenv'."
2652             )
2653             opts["environment"] = opts["saltenv"]
2654         else:
2655             log.warning(
2656                 "The 'environment' minion config option has been renamed "
2657                 "to 'saltenv'. Using %s as the 'saltenv' config value.",
2658                 opts["environment"],
2659             )
2660             opts["saltenv"] = opts["environment"]
2661     for idx, val in enumerate(opts["fileserver_backend"]):
2662         if val in ("git", "hg", "svn", "minion"):
2663             new_val = val + "fs"
2664             log.debug(
2665                 "Changed %s to %s in minion opts' fileserver_backend list", val, new_val
2666             )
2667             opts["fileserver_backend"][idx] = new_val
2668     opts["__cli"] = salt.utils.stringutils.to_unicode(os.path.basename(sys.argv[0]))
2669     using_ip_for_id = False
2670     if not opts.get("id"):
2671         if minion_id:
2672             opts["id"] = minion_id
2673         else:
2674             opts["id"], using_ip_for_id = get_id(opts, cache_minion_id=cache_minion_id)
2675     if not using_ip_for_id and "append_domain" in opts:
2676         opts["id"] = _append_domain(opts)
2677     for directory in opts.get("append_minionid_config_dirs", []):
2678         if directory in ("pki_dir", "cachedir", "extension_modules"):
2679             newdirectory = os.path.join(opts[directory], opts["id"])
2680             opts[directory] = newdirectory
2681         elif directory == "default_include" and directory in opts:
2682             include_dir = os.path.dirname(opts[directory])
2683             new_include_dir = os.path.join(
2684                 include_dir, opts["id"], os.path.basename(opts[directory])
2685             )
2686             opts[directory] = new_include_dir
2687     if "pidfile" in opts.get("append_minionid_config_dirs", []):
2688         newpath_list = os.path.split(opts["pidfile"])
2689         opts["pidfile"] = os.path.join(
2690             newpath_list[0], "salt", opts["id"], newpath_list[1]
2691         )
2692     if len(opts["sock_dir"]) &gt; len(opts["cachedir"]) + 10:
2693         opts["sock_dir"] = os.path.join(opts["cachedir"], ".salt-unix")
2694     opts["open_mode"] = opts["open_mode"] is True
2695     opts["file_roots"] = _validate_file_roots(opts["file_roots"])
2696     opts["pillar_roots"] = _validate_pillar_roots(opts["pillar_roots"])
2697     opts["extension_modules"] = opts.get("extension_modules") or os.path.join(
2698         opts["cachedir"], "extmods"
2699     )
2700     opts["utils_dirs"] = opts.get("utils_dirs") or [
2701         os.path.join(opts["extension_modules"], "utils")
2702     ]
2703     insert_system_path(opts, opts["utils_dirs"])
2704     prepend_root_dirs = [
2705         "pki_dir",
2706         "cachedir",
2707         "sock_dir",
2708         "extension_modules",
2709         "pidfile",
2710     ]
2711     for config_key in ("log_file", "key_logfile"):
2712         if urllib.parse.urlparse(opts.get(config_key, "")).scheme == "":
2713             prepend_root_dirs.append(config_key)
2714     prepend_root_dir(opts, prepend_root_dirs)
2715     if "beacons" not in opts:
2716         opts["beacons"] = {}
2717     if overrides.get("ipc_write_buffer", "") == "dynamic":
2718         opts["ipc_write_buffer"] = _DFLT_IPC_WBUFFER
2719     if "ipc_write_buffer" not in overrides:
2720         opts["ipc_write_buffer"] = 0
2721     opts["hash_type"] = opts["hash_type"].lower()
2722     _update_ssl_config(opts)
2723     _update_discovery_config(opts)
2724     return opts
2725 def _update_discovery_config(opts):
2726     """
2727     Update discovery config for all instances.
2728     :param opts:
2729     :return:
2730     """
2731     if opts.get("discovery") not in (None, False):
2732         if opts["discovery"] is True:
2733             opts["discovery"] = {}
2734         discovery_config = {
2735             "attempts": 3,
2736             "pause": 5,
2737             "port": 4520,
2738             "match": "any",
2739             "mapping": {},
2740         }
2741         for key in opts["discovery"]:
2742             if key not in discovery_config:
2743                 raise salt.exceptions.SaltConfigurationError(
2744                     "Unknown discovery option: {}".format(key)
2745                 )
2746         if opts.get("__role") != "minion":
2747             for key in ["attempts", "pause", "match"]:
2748                 del discovery_config[key]
2749         opts["discovery"] = salt.utils.dictupdate.update(
2750             discovery_config, opts["discovery"], True, True
2751         )
2752 def master_config(
2753     path, env_var="SALT_MASTER_CONFIG", defaults=None, exit_on_config_errors=False
2754 ):
2755     """
2756     Reads in the master configuration file and sets up default options
2757     This is useful for running the actual master daemon. For running
2758     Master-side client interfaces that need the master opts see
2759     :py:func:`salt.client.client_config`.
2760     """
2761     if defaults is None:
2762         defaults = DEFAULT_MASTER_OPTS.copy()
2763     if not os.environ.get(env_var, None):
2764         salt_config_dir = os.environ.get("SALT_CONFIG_DIR", None)
2765         if salt_config_dir:
2766             env_config_file_path = os.path.join(salt_config_dir, "master")
2767             if salt_config_dir and os.path.isfile(env_config_file_path):
2768                 os.environ[env_var] = env_config_file_path
2769     overrides = load_config(path, env_var, DEFAULT_MASTER_OPTS["conf_file"])
2770     default_include = overrides.get("default_include", defaults["default_include"])
2771     include = overrides.get("include", [])
2772     overrides.update(
2773         include_config(
2774             default_include,
2775             path,
2776             verbose=False,
2777             exit_on_config_errors=exit_on_config_errors,
2778         )
2779     )
2780     overrides.update(
2781         include_config(
2782             include, path, verbose=True, exit_on_config_errors=exit_on_config_errors
2783         )
2784     )
2785     opts = apply_master_config(overrides, defaults)
2786     _validate_ssh_minion_opts(opts)
2787     _validate_opts(opts)
2788     if opts.get("nodegroups") is None:
2789         opts["nodegroups"] = DEFAULT_MASTER_OPTS.get("nodegroups", {})
2790     if salt.utils.data.is_dictlist(opts["nodegroups"]):
2791         opts["nodegroups"] = salt.utils.data.repack_dictlist(opts["nodegroups"])
2792     apply_sdb(opts)
2793     return opts
2794 def apply_master_config(overrides=None, defaults=None):
2795     """
2796     Returns master configurations dict.
2797     """
2798     if defaults is None:
2799         defaults = DEFAULT_MASTER_OPTS.copy()
2800     if overrides is None:
2801         overrides = {}
2802     opts = defaults.copy()
2803     opts["__role"] = "master"
2804     _adjust_log_file_override(overrides, defaults["log_file"])
2805     if overrides:
2806         opts.update(overrides)
2807     opts["__cli"] = salt.utils.stringutils.to_unicode(os.path.basename(sys.argv[0]))
2808     if "environment" in opts:
2809         if opts["saltenv"] is not None:
2810             log.warning(
2811                 "The 'saltenv' and 'environment' master config options "
2812                 "cannot both be used. Ignoring 'environment' in favor of "
2813                 "'saltenv'."
2814             )
2815             opts["environment"] = opts["saltenv"]
2816         else:
2817             log.warning(
2818                 "The 'environment' master config option has been renamed "
2819                 "to 'saltenv'. Using %s as the 'saltenv' config value.",
2820                 opts["environment"],
2821             )
2822             opts["saltenv"] = opts["environment"]
2823     for idx, val in enumerate(opts["fileserver_backend"]):
2824         if val in ("git", "hg", "svn", "minion"):
2825             new_val = val + "fs"
2826             log.debug(
2827                 "Changed %s to %s in master opts' fileserver_backend list", val, new_val
2828             )
2829             opts["fileserver_backend"][idx] = new_val
2830     if len(opts["sock_dir"]) &gt; len(opts["cachedir"]) + 10:
2831         opts["sock_dir"] = os.path.join(opts["cachedir"], ".salt-unix")
2832     opts["token_dir"] = os.path.join(opts["cachedir"], "tokens")
2833     opts["syndic_dir"] = os.path.join(opts["cachedir"], "syndics")
2834     opts["extension_modules"] = opts.get("extension_modules") or os.path.join(
2835         opts["cachedir"], "extmods"
2836     )
2837     opts["utils_dirs"] = opts.get("utils_dirs") or [
2838         os.path.join(opts["extension_modules"], "utils")
2839     ]
2840     insert_system_path(opts, opts["utils_dirs"])
2841     if overrides.get("ipc_write_buffer", "") == "dynamic":
2842         opts["ipc_write_buffer"] = _DFLT_IPC_WBUFFER
2843     if "ipc_write_buffer" not in overrides:
2844         opts["ipc_write_buffer"] = 0
2845     using_ip_for_id = False
2846     append_master = False
2847     if not opts.get("id"):
2848         opts["id"], using_ip_for_id = get_id(opts, cache_minion_id=None)
2849         append_master = True
2850     if not using_ip_for_id and "append_domain" in opts:
2851         opts["id"] = _append_domain(opts)
2852     if append_master:
2853         opts["id"] += "_master"
2854     prepend_root_dirs = [
2855         "pki_dir",
2856         "cachedir",
2857         "pidfile",
2858         "sock_dir",
2859         "extension_modules",
2860         "autosign_file",
2861         "autoreject_file",
2862         "token_dir",
2863         "syndic_dir",
2864         "sqlite_queue_dir",
2865         "autosign_grains_dir",
2866     ]
2867     for config_key in ("log_file", "key_logfile", "ssh_log_file"):
2868         log_setting = opts.get(config_key, "")
2869         if log_setting is None:
2870             continue
2871         if urllib.parse.urlparse(log_setting).scheme == "":
2872             prepend_root_dirs.append(config_key)
2873     prepend_root_dir(opts, prepend_root_dirs)
2874     opts["open_mode"] = opts["open_mode"] is True
2875     opts["auto_accept"] = opts["auto_accept"] is True
2876     opts["file_roots"] = _validate_file_roots(opts["file_roots"])
2877     opts["pillar_roots"] = _validate_file_roots(opts["pillar_roots"])
2878     if opts["file_ignore_regex"]:
2879         if isinstance(opts["file_ignore_regex"], str):
2880             ignore_regex = [opts["file_ignore_regex"]]
2881         elif isinstance(opts["file_ignore_regex"], list):
2882             ignore_regex = opts["file_ignore_regex"]
2883         opts["file_ignore_regex"] = []
2884         for regex in ignore_regex:
2885             try:
2886                 re.compile(regex)
2887                 opts["file_ignore_regex"].append(regex)
2888             except Exception:  # pylint: disable=broad-except
2889                 log.warning("Unable to parse file_ignore_regex. Skipping: %s", regex)
2890     if opts["file_ignore_glob"]:
2891         if isinstance(opts["file_ignore_glob"], str):
2892             opts["file_ignore_glob"] = [opts["file_ignore_glob"]]
2893     if opts["worker_threads"] &lt; 3 and opts.get("peer", None):
2894         log.warning(
2895             "The 'worker_threads' setting in '%s' cannot be lower than "
2896             "3. Resetting it to the default value of 3.",
2897             opts["conf_file"],
2898         )
2899         opts["worker_threads"] = 3
2900     opts.setdefault("pillar_source_merging_strategy", "smart")
2901     opts["hash_type"] = opts["hash_type"].lower()
2902     _update_ssl_config(opts)
2903     _update_discovery_config(opts)
2904     return opts
2905 def client_config(path, env_var="SALT_CLIENT_CONFIG", defaults=None):
2906     """
2907     Load Master configuration data
2908     Usage:
2909     .. code-block:: python
2910         import salt.config
2911         master_opts = salt.config.client_config('/etc/salt/master')
2912     Returns a dictionary of the Salt Master configuration file with necessary
2913     options needed to communicate with a locally-running Salt Master daemon.
2914     This function searches for client specific configurations and adds them to
2915     the data from the master configuration.
2916     This is useful for master-side operations like
2917     :py:class:`~salt.client.LocalClient`.
2918     """
2919     if defaults is None:
2920         defaults = DEFAULT_MASTER_OPTS.copy()
2921     xdg_dir = salt.utils.xdg.xdg_config_dir()
2922     if os.path.isdir(xdg_dir):
2923         client_config_dir = xdg_dir
2924         saltrc_config_file = "saltrc"
2925     else:
2926         client_config_dir = os.path.expanduser("~")
2927         saltrc_config_file = ".saltrc"
2928     opts = {
2929         "token_file": defaults.get(
2930             "token_file", os.path.join(client_config_dir, "salt_token")
2931         )
2932     }
2933     opts.update(master_config(path, defaults=defaults))
2934     saltrc_config = os.path.join(client_config_dir, saltrc_config_file)
2935     opts.update(load_config(saltrc_config, env_var, saltrc_config))
2936     if "token_file" in opts:
2937         opts["token_file"] = os.path.abspath(os.path.expanduser(opts["token_file"]))
2938     if os.path.isfile(opts["token_file"]):
2939         expire = opts.get("token_expire", 43200)
2940         if os.stat(opts["token_file"]).st_mtime + expire &gt; time.mktime(
2941             time.localtime()
2942         ):
2943             with salt.utils.files.fopen(opts["token_file"]) as fp_:
2944                 opts["token"] = fp_.read().strip()
2945     if opts["interface"] == "0.0.0.0":
2946         opts["interface"] = "127.0.0.1"
2947     if "master_uri" not in opts:
2948         opts["master_uri"] = "tcp://{ip}:{port}".format(
2949             ip=salt.utils.zeromq.ip_bracket(opts["interface"]), port=opts["ret_port"]
2950         )
2951     _validate_opts(opts)
2952     return opts
2953 def api_config(path):
2954     """
2955     Read in the Salt Master config file and add additional configs that
2956     need to be stubbed out for salt-api
2957     """
2958     opts = DEFAULT_API_OPTS.copy()
2959     opts.update(client_config(path, defaults=DEFAULT_MASTER_OPTS.copy()))
2960     opts.update(
2961         {
2962             "pidfile": opts.get("api_pidfile", DEFAULT_API_OPTS["api_pidfile"]),
2963             "log_file": opts.get("api_logfile", DEFAULT_API_OPTS["api_logfile"]),
2964         }
2965     )
2966     prepend_root_dir(opts, ["api_pidfile", "api_logfile", "log_file", "pidfile"])
2967     return opts
2968 def spm_config(path):
2969     """
2970     Read in the salt master config file and add additional configs that
2971     need to be stubbed out for spm
2972     .. versionadded:: 2015.8.0
2973     """
2974     defaults = DEFAULT_MASTER_OPTS.copy()
2975     defaults.update(DEFAULT_SPM_OPTS)
2976     overrides = load_config(path, "SPM_CONFIG", DEFAULT_SPM_OPTS["spm_conf_file"])
2977     default_include = overrides.get(
2978         "spm_default_include", defaults["spm_default_include"]
2979     )
2980     include = overrides.get("include", [])
2981     overrides.update(include_config(default_include, path, verbose=False))
2982     overrides.update(include_config(include, path, verbose=True))
2983     defaults = apply_master_config(overrides, defaults)
2984     defaults = apply_spm_config(overrides, defaults)
2985     return client_config(path, env_var="SPM_CONFIG", defaults=defaults)
2986 def apply_spm_config(overrides, defaults):
2987     """
2988     Returns the spm configurations dict.
2989     .. versionadded:: 2015.8.1
2990     """
2991     opts = defaults.copy()
2992     _adjust_log_file_override(overrides, defaults["log_file"])
2993     if overrides:
2994         opts.update(overrides)
2995     prepend_root_dirs = [
2996         "formula_path",
2997         "pillar_path",
2998         "reactor_path",
2999         "spm_cache_dir",
3000         "spm_build_dir",
3001     ]
3002     for config_key in ("spm_logfile",):
3003         log_setting = opts.get(config_key, "")
3004         if log_setting is None:
3005             continue
3006         if urllib.parse.urlparse(log_setting).scheme == "":
3007             prepend_root_dirs.append(config_key)
3008     prepend_root_dir(opts, prepend_root_dirs)
3009     return opts
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
