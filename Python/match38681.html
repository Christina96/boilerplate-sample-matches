<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_layman.py & test_jboss7.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_layman.py & test_jboss7.py
      </h3>
      <h1 align="center">
        6.8%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_layman.py (31.034483%)<TH>test_jboss7.py (3.8461537%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match38681-0.html#0',2,'match38681-1.html#0',3)" NAME="0">(22-25)<TD><A HREF="javascript:ZweiFrames('match38681-0.html#0',2,'match38681-1.html#0',3)" NAME="0">(689-703)</A><TD ALIGN=center><FONT COLOR="#ff0000">15</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match38681-0.html#1',2,'match38681-1.html#1',3)" NAME="1">(42-44)<TD><A HREF="javascript:ZweiFrames('match38681-0.html#1',2,'match38681-1.html#1',3)" NAME="1">(470-481)</A><TD ALIGN=center><FONT COLOR="#cc0000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_layman.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Jayesh Kariya &lt;jayeshk@saltstack.com&gt;
&quot;&quot;&quot;
import pytest
import salt.states.layman as layman
from tests.support.mock import MagicMock, patch


@pytest.fixture
def configure_loader_modules():
    return {layman: {}}


def test_present():
    &quot;&quot;&quot;
    Test to verify that the overlay is present.
    &quot;&quot;&quot;
    name = &quot;sunrise&quot;
<A NAME="0"></A>
    ret = {&quot;name&quot;: name, &quot;result&quot;: True, &quot;comment&quot;: &quot;&quot;, &quot;changes&quot;: {}}

    mock <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match38681-1.html#0',3,'match38681-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= MagicMock(side_effect=[[name], []])
    with patch.dict(layman.__salt__, {&quot;layman.list_local&quot;: mock}):
        comt = &quot;Overlay {} already present&quot;.format(name)
        ret.update({&quot;comment&quot;</B></FONT>: comt})
        assert layman.present(name) == ret

        with patch.dict(layman.__opts__, {&quot;test&quot;: True}):
            comt = &quot;Overlay {} is set to be added&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
            assert layman.present(name) == ret


def test_absent():
    &quot;&quot;&quot;
    Test to verify that the overlay is absent.
    &quot;&quot;&quot;
    name = &quot;sunrise&quot;
<A NAME="1"></A>
    ret = {&quot;name&quot;: name, &quot;result&quot;: True, &quot;comment&quot;: &quot;&quot;, &quot;changes&quot;: {}}

    mock <FONT color="#f63526"><A HREF="javascript:ZweiFrames('match38681-1.html#1',3,'match38681-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= MagicMock(side_effect=[[], [name]])
    with patch.dict(layman.__salt__, {&quot;layman.list_local&quot;: mock}):
        comt = &quot;Overlay {} already absent&quot;.format(</B></FONT>name)
        ret.update({&quot;comment&quot;: comt})
        assert layman.absent(name) == ret

        with patch.dict(layman.__opts__, {&quot;test&quot;: True}):
            comt = &quot;Overlay {} is set to be deleted&quot;.format(name)
            ret.update({&quot;comment&quot;: comt, &quot;result&quot;: None})
            assert layman.absent(name) == ret
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_jboss7.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
# pylint: disable=unused-argument


import salt.states.jboss7 as jboss7
from salt.exceptions import CommandExecutionError
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import MagicMock, patch
from tests.support.unit import TestCase


class JBoss7StateTestCase(TestCase, LoaderModuleMockMixin):
    def setup_loader_modules(self):
        return {
            jboss7: {
                &quot;__salt__&quot;: {
                    &quot;jboss7.read_datasource&quot;: MagicMock(),
                    &quot;jboss7.create_datasource&quot;: MagicMock(),
                    &quot;jboss7.update_datasource&quot;: MagicMock(),
                    &quot;jboss7.remove_datasource&quot;: MagicMock(),
                    &quot;jboss7.read_simple_binding&quot;: MagicMock(),
                    &quot;jboss7.create_simple_binding&quot;: MagicMock(),
                    &quot;jboss7.update_simple_binding&quot;: MagicMock(),
                    &quot;jboss7.undeploy&quot;: MagicMock(),
                    &quot;jboss7.deploy&quot;: MagicMock,
                    &quot;file.get_managed&quot;: MagicMock,
                    &quot;file.manage_file&quot;: MagicMock,
                    &quot;jboss7.list_deployments&quot;: MagicMock,
                },
                &quot;__env__&quot;: &quot;base&quot;,
            }
        }

    def test_should_not_redeploy_unchanged(self):
        # given
        parameters = {
            &quot;target_file&quot;: &quot;some_artifact&quot;,
            &quot;undeploy_force&quot;: False,
            &quot;undeploy&quot;: &quot;some_artifact&quot;,
            &quot;source&quot;: &quot;some_artifact_on_master&quot;,
        }
        jboss_conf = {&quot;cli_path&quot;: &quot;somewhere&quot;, &quot;controller&quot;: &quot;some_controller&quot;}

        def list_deployments(jboss_config):
            return [&quot;some_artifact&quot;]

        def file_get_managed(
            name,
            template,
            source,
            source_hash,
            source_hash_name,
            user,
            group,
            mode,
            attrs,
            saltenv,
            context,
            defaults,
            skip_verify,
            kwargs,
        ):
            return &quot;sfn&quot;, &quot;hash&quot;, &quot;&quot;

        def file_manage_file(
            name,
            sfn,
            ret,
            source,
            source_sum,
            user,
            group,
            mode,
            attrs,
            saltenv,
            backup,
            makedirs,
            template,
            show_diff,
            contents,
            dir_mode,
        ):
            return {&quot;result&quot;: True, &quot;changes&quot;: False}

        jboss7_undeploy_mock = MagicMock()
        jboss7_deploy_mock = MagicMock()
        file_get_managed = MagicMock(side_effect=file_get_managed)
        file_manage_file = MagicMock(side_effect=file_manage_file)
        list_deployments_mock = MagicMock(side_effect=list_deployments)
        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.undeploy&quot;: jboss7_undeploy_mock,
                &quot;jboss7.deploy&quot;: jboss7_deploy_mock,
                &quot;file.get_managed&quot;: file_get_managed,
                &quot;file.manage_file&quot;: file_manage_file,
                &quot;jboss7.list_deployments&quot;: list_deployments_mock,
            },
        ):
            # when
            result = jboss7.deployed(
                name=&quot;unchanged&quot;, jboss_config=jboss_conf, salt_source=parameters
            )

            # then
            self.assertFalse(jboss7_undeploy_mock.called)
            self.assertFalse(jboss7_deploy_mock.called)

    def test_should_redeploy_changed(self):
        # given
        parameters = {
            &quot;target_file&quot;: &quot;some_artifact&quot;,
            &quot;undeploy_force&quot;: False,
            &quot;undeploy&quot;: &quot;some_artifact&quot;,
            &quot;source&quot;: &quot;some_artifact_on_master&quot;,
        }
        jboss_conf = {&quot;cli_path&quot;: &quot;somewhere&quot;, &quot;controller&quot;: &quot;some_controller&quot;}

        def list_deployments(jboss_config):
            return [&quot;some_artifact&quot;]

        def file_get_managed(
            name,
            template,
            source,
            source_hash,
            source_hash_name,
            user,
            group,
            mode,
            attrs,
            saltenv,
            context,
            defaults,
            skip_verify,
            kwargs,
        ):
            return &quot;sfn&quot;, &quot;hash&quot;, &quot;&quot;

        def file_manage_file(
            name,
            sfn,
            ret,
            source,
            source_sum,
            user,
            group,
            mode,
            attrs,
            saltenv,
            backup,
            makedirs,
            template,
            show_diff,
            contents,
            dir_mode,
        ):
            return {&quot;result&quot;: True, &quot;changes&quot;: True}

        jboss7_undeploy_mock = MagicMock()
        jboss7_deploy_mock = MagicMock()
        file_get_managed = MagicMock(side_effect=file_get_managed)
        file_manage_file = MagicMock(side_effect=file_manage_file)
        list_deployments_mock = MagicMock(side_effect=list_deployments)
        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.undeploy&quot;: jboss7_undeploy_mock,
                &quot;jboss7.deploy&quot;: jboss7_deploy_mock,
                &quot;file.get_managed&quot;: file_get_managed,
                &quot;file.manage_file&quot;: file_manage_file,
                &quot;jboss7.list_deployments&quot;: list_deployments_mock,
            },
        ):
            # when
            result = jboss7.deployed(
                name=&quot;unchanged&quot;, jboss_config=jboss_conf, salt_source=parameters
            )

            # then
            self.assertTrue(jboss7_undeploy_mock.called)
            self.assertTrue(jboss7_deploy_mock.called)

    def test_should_deploy_different_artifact(self):
        # given
        parameters = {
            &quot;target_file&quot;: &quot;some_artifact&quot;,
            &quot;undeploy_force&quot;: False,
            &quot;undeploy&quot;: &quot;some_artifact&quot;,
            &quot;source&quot;: &quot;some_artifact_on_master&quot;,
        }
        jboss_conf = {&quot;cli_path&quot;: &quot;somewhere&quot;, &quot;controller&quot;: &quot;some_controller&quot;}

        def list_deployments(jboss_config):
            return [&quot;some_other_artifact&quot;]

        def file_get_managed(
            name,
            template,
            source,
            source_hash,
            source_hash_name,
            user,
            group,
            mode,
            attrs,
            saltenv,
            context,
            defaults,
            skip_verify,
            kwargs,
        ):
            return &quot;sfn&quot;, &quot;hash&quot;, &quot;&quot;

        def file_manage_file(
            name,
            sfn,
            ret,
            source,
            source_sum,
            user,
            group,
            mode,
            attrs,
            saltenv,
            backup,
            makedirs,
            template,
            show_diff,
            contents,
            dir_mode,
        ):
            return {&quot;result&quot;: True, &quot;changes&quot;: False}

        jboss7_undeploy_mock = MagicMock()
        jboss7_deploy_mock = MagicMock()
        file_get_managed = MagicMock(side_effect=file_get_managed)
        file_manage_file = MagicMock(side_effect=file_manage_file)
        list_deployments_mock = MagicMock(side_effect=list_deployments)
        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.undeploy&quot;: jboss7_undeploy_mock,
                &quot;jboss7.deploy&quot;: jboss7_deploy_mock,
                &quot;file.get_managed&quot;: file_get_managed,
                &quot;file.manage_file&quot;: file_manage_file,
                &quot;jboss7.list_deployments&quot;: list_deployments_mock,
            },
        ):
            # when
            result = jboss7.deployed(
                name=&quot;unchanged&quot;, jboss_config=jboss_conf, salt_source=parameters
            )

            # then
            self.assertFalse(jboss7_undeploy_mock.called)
            self.assertTrue(jboss7_deploy_mock.called)

    def test_should_redploy_undeploy_force(self):
        # given
        parameters = {
            &quot;target_file&quot;: &quot;some_artifact&quot;,
            &quot;undeploy_force&quot;: True,
            &quot;undeploy&quot;: &quot;some_artifact&quot;,
            &quot;source&quot;: &quot;some_artifact_on_master&quot;,
        }
        jboss_conf = {&quot;cli_path&quot;: &quot;somewhere&quot;, &quot;controller&quot;: &quot;some_controller&quot;}

        def list_deployments(jboss_config):
            return [&quot;some_artifact&quot;]

        def file_get_managed(
            name,
            template,
            source,
            source_hash,
            source_hash_name,
            user,
            group,
            mode,
            attrs,
            saltenv,
            context,
            defaults,
            skip_verify,
            kwargs,
        ):
            return &quot;sfn&quot;, &quot;hash&quot;, &quot;&quot;

        def file_manage_file(
            name,
            sfn,
            ret,
            source,
            source_sum,
            user,
            group,
            mode,
            attrs,
            saltenv,
            backup,
            makedirs,
            template,
            show_diff,
            contents,
            dir_mode,
        ):
            return {&quot;result&quot;: True, &quot;changes&quot;: False}

        jboss7_undeploy_mock = MagicMock()
        jboss7_deploy_mock = MagicMock()
        file_get_managed = MagicMock(side_effect=file_get_managed)
        file_manage_file = MagicMock(side_effect=file_manage_file)
        list_deployments_mock = MagicMock(side_effect=list_deployments)
        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.undeploy&quot;: jboss7_undeploy_mock,
                &quot;jboss7.deploy&quot;: jboss7_deploy_mock,
                &quot;file.get_managed&quot;: file_get_managed,
                &quot;file.manage_file&quot;: file_manage_file,
                &quot;jboss7.list_deployments&quot;: list_deployments_mock,
            },
        ):
            # when
            result = jboss7.deployed(
                name=&quot;unchanged&quot;, jboss_config=jboss_conf, salt_source=parameters
            )

            # then
            self.assertTrue(jboss7_undeploy_mock.called)
            self.assertTrue(jboss7_deploy_mock.called)

    def test_should_create_new_datasource_if_not_exists(self):
        # given
        datasource_properties = {&quot;connection-url&quot;: &quot;jdbc:/old-connection-url&quot;}
        ds_status = {&quot;created&quot;: False}

        def read_func(jboss_config, name, profile):
            if ds_status[&quot;created&quot;]:
                return {&quot;success&quot;: True, &quot;result&quot;: datasource_properties}
            else:
                return {&quot;success&quot;: False, &quot;err_code&quot;: &quot;JBAS014807&quot;}

        def create_func(jboss_config, name, datasource_properties, profile):
            ds_status[&quot;created&quot;] = True
            return {&quot;success&quot;: True}

        read_mock = MagicMock(side_effect=read_func)
        create_mock = MagicMock(side_effect=create_func)
        update_mock = MagicMock()
        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.read_datasource&quot;: read_mock,
                &quot;jboss7.create_datasource&quot;: create_mock,
                &quot;jboss7.update_datasource&quot;: update_mock,
            },
        ):

            # when
            result = jboss7.datasource_exists(
                name=&quot;appDS&quot;,
                jboss_config={},
                datasource_properties=datasource_properties,
                profile=None,
            )

            # then
            create_mock.assert_called_with(
                name=&quot;appDS&quot;,
                jboss_config={},
                datasource_properties=datasource_properties,
                profile=None,
            )

            self.assertFalse(update_mock.called)
            self.assertEqual(result[&quot;comment&quot;], &quot;Datasource created.&quot;)

    def test_should_update_the_datasource_if_exists(self):
        ds_status = {&quot;updated&quot;: False}

        def read_func(jboss_config, name, profile):
            if ds_status[&quot;updated&quot;]:
                return {
                    &quot;success&quot;: True,
                    &quot;result&quot;: {&quot;connection-url&quot;: &quot;jdbc:/new-connection-url&quot;},
                }
            else:
                return {
                    &quot;success&quot;: True,
                    &quot;result&quot;: {&quot;connection-url&quot;: &quot;jdbc:/old-connection-url&quot;},
                }

        def update_func(jboss_config, name, new_properties, profile):
            ds_status[&quot;updated&quot;] = True
            return {&quot;success&quot;: True}

        read_mock = MagicMock(side_effect=read_func)
        create_mock = MagicMock()
        update_mock = MagicMock(side_effect=update_func)
        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.read_datasource&quot;: read_mock,
                &quot;jboss7.create_datasource&quot;: create_mock,
                &quot;jboss7.update_datasource&quot;: update_mock,
            },
        ):
            result = jboss7.datasource_exists(
                name=&quot;appDS&quot;,
                jboss_config={},
                datasource_properties={&quot;connection-url&quot;: &quot;jdbc:/new-connection-url&quot;},
                profile=None,
            )

            update_mock.assert_called_with(
                name=&quot;appDS&quot;,
                jboss_config={},
                new_properties={&quot;connection-url&quot;: &quot;jdbc:/new-connection-url&quot;},
                profile=None,
            )
            self.assertTrue(read_mock.called)
            self.assertEqual(result[&quot;comment&quot;], &quot;Datasource updated.&quot;)

    def test_should_recreate_the_datasource_if_specified(self):
        read_mock = MagicMock(
            return_value={
                &quot;success&quot;: True,
                &quot;result&quot;: {&quot;connection-url&quot;: &quot;jdbc:/same-connection-url&quot;},
            }
        )
        create_mock = MagicMock(return_value={&quot;success&quot;: True})
        remove_mock = MagicMock(return_value={&quot;success&quot;: True})
        update_mock = MagicMock()
        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.read_datasource&quot;: read_mock,
                &quot;jboss7.create_datasource&quot;: create_mock,
                &quot;jboss7.remove_datasource&quot;: remove_mock,
                &quot;jboss7.update_datasource&quot;: update_mock,
            },
        ):
            result = jboss7.datasource_exists(
                name=&quot;appDS&quot;,
                jboss_config={},
                datasource_properties={&quot;connection-url&quot;: &quot;jdbc:/same-connection-url&quot;},
                recreate=True,
            )

            remove_mock.assert_called_with(name=&quot;appDS&quot;, jboss_config={}, profile=None)
            create_mock.assert_called_with(
                name=&quot;appDS&quot;,
                jboss_config={},
                datasource_properties={&quot;connection-url&quot;: &quot;jdbc:/same-connection-url&quot;},
                profile=None,
            )
            self.assertEqual(result[&quot;changes&quot;][&quot;removed&quot;], &quot;appDS&quot;)
            self.assertEqual(result[&quot;changes&quot;][&quot;created&quot;], &quot;appDS&quot;)

    def test_should_inform_if_the_datasource_has_not_changed(self):
        read_mock = MagicMock(
            return_value={
                &quot;success&quot;: True,
                &quot;result&quot;: {&quot;connection-url&quot;: &quot;jdbc:/same-connection-url&quot;},
            }
<A NAME="1"></A>        )
        create_mock = MagicMock()
        remove_mock = MagicMock()
        update_mock <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match38681-0.html#1',2,'match38681-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= MagicMock(return_value={&quot;success&quot;: True})

        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.read_datasource&quot;: read_mock,
                &quot;jboss7.create_datasource&quot;: create_mock,
                &quot;jboss7.remove_datasource&quot;: remove_mock,
                &quot;jboss7.update_datasource&quot;: update_mock,
            },
        ):
            result = jboss7.datasource_exists(</B></FONT>
                name=&quot;appDS&quot;,
                jboss_config={},
                datasource_properties={&quot;connection-url&quot;: &quot;jdbc:/old-connection-url&quot;},
            )

            update_mock.assert_called_with(
                name=&quot;appDS&quot;,
                jboss_config={},
                new_properties={&quot;connection-url&quot;: &quot;jdbc:/old-connection-url&quot;},
                profile=None,
            )
            self.assertFalse(create_mock.called)
            self.assertEqual(result[&quot;comment&quot;], &quot;Datasource not changed.&quot;)

    def test_should_create_binding_if_not_exists(self):
        # given
        binding_status = {&quot;created&quot;: False}

        def read_func(jboss_config, binding_name, profile):
            if binding_status[&quot;created&quot;]:
                return {&quot;success&quot;: True, &quot;result&quot;: {&quot;value&quot;: &quot;DEV&quot;}}
            else:
                return {&quot;success&quot;: False, &quot;err_code&quot;: &quot;JBAS014807&quot;}

        def create_func(jboss_config, binding_name, value, profile):
            binding_status[&quot;created&quot;] = True
            return {&quot;success&quot;: True}

        read_mock = MagicMock(side_effect=read_func)
        create_mock = MagicMock(side_effect=create_func)
        update_mock = MagicMock()

        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.read_simple_binding&quot;: read_mock,
                &quot;jboss7.create_simple_binding&quot;: create_mock,
                &quot;jboss7.update_simple_binding&quot;: update_mock,
            },
        ):

            # when
            result = jboss7.bindings_exist(
                name=&quot;bindings&quot;, jboss_config={}, bindings={&quot;env&quot;: &quot;DEV&quot;}, profile=None
            )

            # then
            create_mock.assert_called_with(
                jboss_config={}, binding_name=&quot;env&quot;, value=&quot;DEV&quot;, profile=None
            )
            self.assertEqual(update_mock.call_count, 0)
            self.assertEqual(result[&quot;changes&quot;], {&quot;added&quot;: &quot;env:DEV\n&quot;})
            self.assertEqual(result[&quot;comment&quot;], &quot;Bindings changed.&quot;)

    def test_should_update_bindings_if_exists_and_different(self):
        # given
        binding_status = {&quot;updated&quot;: False}

        def read_func(jboss_config, binding_name, profile):
            if binding_status[&quot;updated&quot;]:
                return {&quot;success&quot;: True, &quot;result&quot;: {&quot;value&quot;: &quot;DEV2&quot;}}
            else:
                return {&quot;success&quot;: True, &quot;result&quot;: {&quot;value&quot;: &quot;DEV&quot;}}

        def update_func(jboss_config, binding_name, value, profile):
            binding_status[&quot;updated&quot;] = True
            return {&quot;success&quot;: True}

        read_mock = MagicMock(side_effect=read_func)
        create_mock = MagicMock()
        update_mock = MagicMock(side_effect=update_func)

        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.read_simple_binding&quot;: read_mock,
                &quot;jboss7.create_simple_binding&quot;: create_mock,
                &quot;jboss7.update_simple_binding&quot;: update_mock,
            },
        ):
            # when
            result = jboss7.bindings_exist(
                name=&quot;bindings&quot;, jboss_config={}, bindings={&quot;env&quot;: &quot;DEV2&quot;}, profile=None
            )

            # then
            update_mock.assert_called_with(
                jboss_config={}, binding_name=&quot;env&quot;, value=&quot;DEV2&quot;, profile=None
            )
            self.assertEqual(create_mock.call_count, 0)
            self.assertEqual(result[&quot;changes&quot;], {&quot;changed&quot;: &quot;env:DEV-&gt;DEV2\n&quot;})
            self.assertEqual(result[&quot;comment&quot;], &quot;Bindings changed.&quot;)

    def test_should_not_update_bindings_if_same(self):
        # given
        read_mock = MagicMock(
            return_value={&quot;success&quot;: True, &quot;result&quot;: {&quot;value&quot;: &quot;DEV2&quot;}}
        )
        create_mock = MagicMock()
        update_mock = MagicMock()

        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.read_simple_binding&quot;: read_mock,
                &quot;jboss7.create_simple_binding&quot;: create_mock,
                &quot;jboss7.update_simple_binding&quot;: update_mock,
            },
        ):
            # when
            result = jboss7.bindings_exist(
                name=&quot;bindings&quot;, jboss_config={}, bindings={&quot;env&quot;: &quot;DEV2&quot;}
            )

            # then
            self.assertEqual(create_mock.call_count, 0)
            self.assertEqual(update_mock.call_count, 0)
            self.assertEqual(result[&quot;changes&quot;], {})
            self.assertEqual(result[&quot;comment&quot;], &quot;Bindings not changed.&quot;)

    def test_should_raise_exception_if_cannot_create_binding(self):
        def read_func(jboss_config, binding_name, profile):
            return {&quot;success&quot;: False, &quot;err_code&quot;: &quot;JBAS014807&quot;}

        def create_func(jboss_config, binding_name, value, profile):
            return {&quot;success&quot;: False, &quot;failure-description&quot;: &quot;Incorrect binding name.&quot;}

        read_mock = MagicMock(side_effect=read_func)
        create_mock = MagicMock(side_effect=create_func)
        update_mock = MagicMock()

        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.read_simple_binding&quot;: read_mock,
                &quot;jboss7.create_simple_binding&quot;: create_mock,
                &quot;jboss7.update_simple_binding&quot;: update_mock,
            },
        ):
            # when
            try:
                jboss7.bindings_exist(
                    name=&quot;bindings&quot;,
                    jboss_config={},
                    bindings={&quot;env&quot;: &quot;DEV2&quot;},
                    profile=None,
                )
                self.fail(&quot;An exception should be thrown&quot;)
            except CommandExecutionError as e:
                self.assertEqual(str(e), &quot;Incorrect binding name.&quot;)

    def test_should_raise_exception_if_cannot_update_binding(self):
        def read_func(jboss_config, binding_name, profile):
            return {&quot;success&quot;: True, &quot;result&quot;: {&quot;value&quot;: &quot;DEV&quot;}}

        def update_func(jboss_config, binding_name, value, profile):
            return {&quot;success&quot;: False, &quot;failure-description&quot;: &quot;Incorrect binding name.&quot;}

        read_mock = MagicMock(side_effect=read_func)
        create_mock = MagicMock()
        update_mock = MagicMock(side_effect=update_func)

        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.read_simple_binding&quot;: read_mock,
                &quot;jboss7.create_simple_binding&quot;: create_mock,
                &quot;jboss7.update_simple_binding&quot;: update_mock,
            },
        ):

            # when
            try:
                jboss7.bindings_exist(
                    name=&quot;bindings&quot;,
                    jboss_config={},
                    bindings={&quot;env&quot;: &quot;!@#!///some weird value&quot;},
                    profile=None,
                )
                self.fail(&quot;An exception should be thrown&quot;)
            except CommandExecutionError as e:
                self.assertEqual(str(e), &quot;Incorrect binding name.&quot;)

    def test_datasource_exist_create_datasource_good_code(self):
        jboss_config = {
            &quot;cli_path&quot;: &quot;/home/ch44d/Desktop/wildfly-18.0.0.Final/bin/jboss-cli.sh&quot;,
            &quot;controller&quot;: &quot;127.0.0.1: 9990&quot;,
            &quot;cli_user&quot;: &quot;user&quot;,
            &quot;cli_password&quot;: &quot;user&quot;,
        }

        datasource_properties = {
            &quot;driver - name&quot;: &quot;h2&quot;,
            &quot;connection - url&quot;: &quot;jdbc:sqlserver://127.0.0.1:1433;DatabaseName=test_s2&quot;,
            &quot;jndi - name&quot;: (
                &quot;java:/home/ch44d/Desktop/sqljdbc_7.4/enu/mssql-jdbc-7.4.1.jre8.jar&quot;
            ),
            &quot;user - name&quot;: &quot;user&quot;,
            &quot;password&quot;: &quot;user&quot;,
            &quot;use - java - context&quot;: True,
        }

        read_datasource = MagicMock(
            return_value={&quot;success&quot;: False, &quot;err_code&quot;: &quot;WFLYCTL0216&quot;}
<A NAME="0"></A>        )

        error_msg = &quot;Error: -1&quot;
        create_datasource <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match38681-0.html#0',2,'match38681-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= MagicMock(
            return_value={&quot;success&quot;: False, &quot;stdout&quot;: error_msg}
        )

        with patch.dict(
            jboss7.__salt__,
            {
                &quot;jboss7.read_datasource&quot;: read_datasource,
                &quot;jboss7.create_datasource&quot;: create_datasource,
            },
        ):
            ret = jboss7.datasource_exists(&quot;SQL&quot;, jboss_config, datasource_properties)

            self.assertTrue(&quot;result&quot; in ret)
            self.</B></FONT>assertFalse(ret[&quot;result&quot;])
            self.assertTrue(&quot;comment&quot; in ret)
            self.assertTrue(error_msg in ret[&quot;comment&quot;])

            read_datasource.assert_called_once()
            create_datasource.assert_called_once()

    def test_datasource_exist_create_datasource_bad_code(self):
        jboss_config = {
            &quot;cli_path&quot;: &quot;/home/ch44d/Desktop/wildfly-18.0.0.Final/bin/jboss-cli.sh&quot;,
            &quot;controller&quot;: &quot;127.0.0.1: 9990&quot;,
            &quot;cli_user&quot;: &quot;user&quot;,
            &quot;cli_password&quot;: &quot;user&quot;,
        }

        datasource_properties = {
            &quot;driver - name&quot;: &quot;h2&quot;,
            &quot;connection - url&quot;: &quot;jdbc:sqlserver://127.0.0.1:1433;DatabaseName=test_s2&quot;,
            &quot;jndi - name&quot;: (
                &quot;java:/home/ch44d/Desktop/sqljdbc_7.4/enu/mssql-jdbc-7.4.1.jre8.jar&quot;
            ),
            &quot;user - name&quot;: &quot;user&quot;,
            &quot;password&quot;: &quot;user&quot;,
            &quot;use - java - context&quot;: True,
        }

        read_datasource = MagicMock(
            return_value={
                &quot;success&quot;: False,
                &quot;err_code&quot;: &quot;WFLYCTL0217&quot;,
                &quot;failure-description&quot;: &quot;Something happened&quot;,
            }
        )

        with patch.dict(jboss7.__salt__, {&quot;jboss7.read_datasource&quot;: read_datasource}):
            self.assertRaises(
                CommandExecutionError,
                jboss7.datasource_exists,
                &quot;SQL&quot;,
                jboss_config,
                datasource_properties,
            )
            read_datasource.assert_called_once()
</PRE>
</div>
  </div>
</body>
</html>
