<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for network_info.py & mac_shadow.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for network_info.py & mac_shadow.py
      </h3>
      <h1 align="center">
        5.1%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>network_info.py (9.090909%)<TH>mac_shadow.py (3.6253777%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match58503-0.html#0',2,'match58503-1.html#0',3)" NAME="0">(6-20)<TD><A HREF="javascript:ZweiFrames('match58503-0.html#0',2,'match58503-1.html#0',3)" NAME="0">(16-29)</A><TD ALIGN=center><FONT COLOR="#ff0000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>network_info.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
Beacon to monitor statistics from ethernet adapters
<A NAME="0"></A>
.. versionadded:: 2015.5.0
&quot;&quot;&quot;
<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match58503-1.html#0',3,'match58503-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>import logging

import salt.utils.beacons

try:
    import salt.utils.psutil_compat as psutil

    HAS_PSUTIL = True
except ImportError:
    HAS_PSUTIL = False


log = logging.getLogger(__name__)

__virtualname__ =</B></FONT> &quot;network_info&quot;

__attrs = [
    &quot;bytes_sent&quot;,
    &quot;bytes_recv&quot;,
    &quot;packets_sent&quot;,
    &quot;packets_recv&quot;,
    &quot;errin&quot;,
    &quot;errout&quot;,
    &quot;dropin&quot;,
    &quot;dropout&quot;,
]


def _to_list(obj):
    &quot;&quot;&quot;
    Convert snetinfo object to list
    &quot;&quot;&quot;
    ret = {}

    for attr in __attrs:
        if hasattr(obj, attr):
            ret[attr] = getattr(obj, attr)
    return ret


def __virtual__():
    if not HAS_PSUTIL:
        err_msg = &quot;psutil not available&quot;
        log.error(&quot;Unable to load %s beacon: %s&quot;, __virtualname__, err_msg)
        return False, err_msg
    return __virtualname__


def validate(config):
    &quot;&quot;&quot;
    Validate the beacon configuration
    &quot;&quot;&quot;

    VALID_ITEMS = [
        &quot;type&quot;,
        &quot;bytes_sent&quot;,
        &quot;bytes_recv&quot;,
        &quot;packets_sent&quot;,
        &quot;packets_recv&quot;,
        &quot;errin&quot;,
        &quot;errout&quot;,
        &quot;dropin&quot;,
        &quot;dropout&quot;,
    ]

    # Configuration for load beacon should be a list of dicts
    if not isinstance(config, list):
        return False, &quot;Configuration for network_info beacon must be a list.&quot;
    else:

        config = salt.utils.beacons.list_to_dict(config)

        for item in config.get(&quot;interfaces&quot;, {}):
            if not isinstance(config[&quot;interfaces&quot;][item], dict):
                return (
                    False,
                    &quot;Configuration for network_info beacon must &quot;
                    &quot;be a list of dictionaries.&quot;,
                )
            else:
                if not any(j in VALID_ITEMS for j in config[&quot;interfaces&quot;][item]):
                    return (
                        False,
                        &quot;Invalid configuration item in Beacon configuration.&quot;,
                    )
    return True, &quot;Valid beacon configuration&quot;


def beacon(config):
    &quot;&quot;&quot;
    Emit the network statistics of this host.

    Specify thresholds for each network stat
    and only emit a beacon if any of them are
    exceeded.

    Emit beacon when any values are equal to
    configured values.

    .. code-block:: yaml

        beacons:
          network_info:
            - interfaces:
                eth0:
                  type: equal
                  bytes_sent: 100000
                  bytes_recv: 100000
                  packets_sent: 100000
                  packets_recv: 100000
                  errin: 100
                  errout: 100
                  dropin: 100
                  dropout: 100

    Emit beacon when any values are greater
    than configured values.

    .. code-block:: yaml

        beacons:
          network_info:
            - interfaces:
                eth0:
                  type: greater
                  bytes_sent: 100000
                  bytes_recv: 100000
                  packets_sent: 100000
                  packets_recv: 100000
                  errin: 100
                  errout: 100
                  dropin: 100
                  dropout: 100


    &quot;&quot;&quot;
    ret = []

    config = salt.utils.beacons.list_to_dict(config)

    log.debug(&quot;psutil.net_io_counters %s&quot;, psutil.net_io_counters)

    _stats = psutil.net_io_counters(pernic=True)

    log.debug(&quot;_stats %s&quot;, _stats)
    for interface in config.get(&quot;interfaces&quot;, {}):
        if interface in _stats:
            interface_config = config[&quot;interfaces&quot;][interface]
            _if_stats = _stats[interface]
            _diff = False
            for attr in __attrs:
                if attr in interface_config:
                    if (
                        &quot;type&quot; in interface_config
                        and interface_config[&quot;type&quot;] == &quot;equal&quot;
                    ):
                        if getattr(_if_stats, attr, None) == int(
                            interface_config[attr]
                        ):
                            _diff = True
                    elif (
                        &quot;type&quot; in interface_config
                        and interface_config[&quot;type&quot;] == &quot;greater&quot;
                    ):
                        if getattr(_if_stats, attr, None) &gt; int(interface_config[attr]):
                            _diff = True
                        else:
                            log.debug(&quot;attr %s&quot;, getattr(_if_stats, attr, None))
                    else:
                        if getattr(_if_stats, attr, None) == int(
                            interface_config[attr]
                        ):
                            _diff = True
            if _diff:
                ret.append(
                    {&quot;interface&quot;: interface, &quot;network_info&quot;: _to_list(_if_stats)}
                )
    return ret
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>mac_shadow.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
Manage macOS local directory passwords and policies

.. versionadded:: 2016.3.0

Note that it is usually better to apply password policies through the creation
of a configuration profile.
&quot;&quot;&quot;
# Authentication concepts reference:
# https://developer.apple.com/library/mac/documentation/Networking/Conceptual/Open_Directory/openDirectoryConcepts/openDirectoryConcepts.html#//apple_ref/doc/uid/TP40000917-CH3-CIFCAIBB

import logging
<A NAME="0"></A>from datetime import datetime

import salt.utils.mac_utils
<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match58503-0.html#0',2,'match58503-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>import salt.utils.platform
from salt.exceptions import CommandExecutionError

try:
    import pwd

    HAS_PWD = True
except ImportError:
    HAS_PWD = False


log = logging.getLogger(__name__)  # Start logging

__virtualname__ =</B></FONT> &quot;shadow&quot;


def __virtual__():
    # Is this macOS?
    if not salt.utils.platform.is_darwin():
        return False, &quot;Not macOS&quot;

    if HAS_PWD:
        return __virtualname__
    else:
        return (False, &quot;The pwd module failed to load.&quot;)


def _get_account_policy(name):
    &quot;&quot;&quot;
    Get the entire accountPolicy and return it as a dictionary. For use by this
    module only

    :param str name: The user name

    :return: a dictionary containing all values for the accountPolicy
    :rtype: dict

    :raises: CommandExecutionError on user not found or any other unknown error
    &quot;&quot;&quot;

    cmd = &quot;pwpolicy -u {} -getpolicy&quot;.format(name)
    try:
        ret = salt.utils.mac_utils.execute_return_result(cmd)
    except CommandExecutionError as exc:
        if &quot;Error: user &lt;{}&gt; not found&quot;.format(name) in exc.strerror:
            raise CommandExecutionError(&quot;User not found: {}&quot;.format(name))
        raise CommandExecutionError(&quot;Unknown error: {}&quot;.format(exc.strerror))

    try:
        policy_list = ret.split(&quot;\n&quot;)[1].split(&quot; &quot;)
        policy_dict = {}
        for policy in policy_list:
            if &quot;=&quot; in policy:
                key, value = policy.split(&quot;=&quot;)
                policy_dict[key] = value
        return policy_dict
    except IndexError:
        return {}


def _set_account_policy(name, policy):
    &quot;&quot;&quot;
    Set a value in the user accountPolicy. For use by this module only

    :param str name: The user name
    :param str policy: The policy to apply

    :return: True if success, otherwise False
    :rtype: bool

    :raises: CommandExecutionError on user not found or any other unknown error
    &quot;&quot;&quot;
    cmd = 'pwpolicy -u {} -setpolicy &quot;{}&quot;'.format(name, policy)

    try:
        return salt.utils.mac_utils.execute_return_success(cmd)
    except CommandExecutionError as exc:
        if &quot;Error: user &lt;{}&gt; not found&quot;.format(name) in exc.strerror:
            raise CommandExecutionError(&quot;User not found: {}&quot;.format(name))
        raise CommandExecutionError(&quot;Unknown error: {}&quot;.format(exc.strerror))


def _get_account_policy_data_value(name, key):
    &quot;&quot;&quot;
    Return the value for a key in the accountPolicy section of the user's plist
    file. For use by this module only

    :param str name: The username
    :param str key: The accountPolicy key

    :return: The value contained within the key
    :rtype: str

    :raises: CommandExecutionError on user not found or any other unknown error
    &quot;&quot;&quot;
    cmd = &quot;dscl . -readpl /Users/{} accountPolicyData {}&quot;.format(name, key)
    try:
        ret = salt.utils.mac_utils.execute_return_result(cmd)
    except CommandExecutionError as exc:
        if &quot;eDSUnknownNodeName&quot; in exc.strerror:
            raise CommandExecutionError(&quot;User not found: {}&quot;.format(name))
        raise CommandExecutionError(&quot;Unknown error: {}&quot;.format(exc.strerror))

    return ret


def _convert_to_datetime(unix_timestamp):
    &quot;&quot;&quot;
    Converts a unix timestamp to a human readable date/time

    :param float unix_timestamp: A unix timestamp

    :return: A date/time in the format YYYY-mm-dd HH:MM:SS
    :rtype: str
    &quot;&quot;&quot;
    try:
        unix_timestamp = float(unix_timestamp)
        return datetime.fromtimestamp(unix_timestamp).strftime(&quot;%Y-%m-%d %H:%M:%S&quot;)
    except (ValueError, TypeError):
        return &quot;Invalid Timestamp&quot;


def info(name):
    &quot;&quot;&quot;
    Return information for the specified user

    :param str name: The username

    :return: A dictionary containing the user's shadow information
    :rtype: dict

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.info admin
    &quot;&quot;&quot;
    try:
        data = pwd.getpwnam(name)
        return {
            &quot;name&quot;: data.pw_name,
            &quot;passwd&quot;: data.pw_passwd,
            &quot;account_created&quot;: get_account_created(name),
            &quot;login_failed_count&quot;: get_login_failed_count(name),
            &quot;login_failed_last&quot;: get_login_failed_last(name),
            &quot;lstchg&quot;: get_last_change(name),
            &quot;max&quot;: get_maxdays(name),
            &quot;expire&quot;: get_expire(name),
            &quot;change&quot;: get_change(name),
            &quot;min&quot;: &quot;Unavailable&quot;,
            &quot;warn&quot;: &quot;Unavailable&quot;,
            &quot;inact&quot;: &quot;Unavailable&quot;,
        }

    except KeyError:
        log.debug(&quot;User not found: %s&quot;, name)
        return {
            &quot;name&quot;: &quot;&quot;,
            &quot;passwd&quot;: &quot;&quot;,
            &quot;account_created&quot;: &quot;&quot;,
            &quot;login_failed_count&quot;: &quot;&quot;,
            &quot;login_failed_last&quot;: &quot;&quot;,
            &quot;lstchg&quot;: &quot;&quot;,
            &quot;max&quot;: &quot;&quot;,
            &quot;expire&quot;: &quot;&quot;,
            &quot;change&quot;: &quot;&quot;,
            &quot;min&quot;: &quot;&quot;,
            &quot;warn&quot;: &quot;&quot;,
            &quot;inact&quot;: &quot;&quot;,
        }


def get_account_created(name):
    &quot;&quot;&quot;
    Get the date/time the account was created

    :param str name: The username of the account

    :return: The date/time the account was created (yyyy-mm-dd hh:mm:ss)
    :rtype: str

    :raises: CommandExecutionError on user not found or any other unknown error

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.get_account_created admin
    &quot;&quot;&quot;
    ret = _get_account_policy_data_value(name, &quot;creationTime&quot;)

    unix_timestamp = salt.utils.mac_utils.parse_return(ret)

    date_text = _convert_to_datetime(unix_timestamp)

    return date_text


def get_last_change(name):
    &quot;&quot;&quot;
    Get the date/time the account was changed

    :param str name: The username of the account

    :return: The date/time the account was modified (yyyy-mm-dd hh:mm:ss)
    :rtype: str

    :raises: CommandExecutionError on user not found or any other unknown error

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.get_last_change admin
    &quot;&quot;&quot;
    ret = _get_account_policy_data_value(name, &quot;passwordLastSetTime&quot;)

    unix_timestamp = salt.utils.mac_utils.parse_return(ret)

    date_text = _convert_to_datetime(unix_timestamp)

    return date_text


def get_login_failed_count(name):
    &quot;&quot;&quot;
    Get the number of failed login attempts

    :param str name: The username of the account

    :return: The number of failed login attempts
    :rtype: int

    :raises: CommandExecutionError on user not found or any other unknown error

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.get_login_failed_count admin
    &quot;&quot;&quot;
    ret = _get_account_policy_data_value(name, &quot;failedLoginCount&quot;)

    return salt.utils.mac_utils.parse_return(ret)


def get_login_failed_last(name):
    &quot;&quot;&quot;
    Get the date/time of the last failed login attempt

    :param str name: The username of the account

    :return: The date/time of the last failed login attempt on this account
        (yyyy-mm-dd hh:mm:ss)
    :rtype: str

    :raises: CommandExecutionError on user not found or any other unknown error

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.get_login_failed_last admin
    &quot;&quot;&quot;
    ret = _get_account_policy_data_value(name, &quot;failedLoginTimestamp&quot;)

    unix_timestamp = salt.utils.mac_utils.parse_return(ret)

    date_text = _convert_to_datetime(unix_timestamp)

    return date_text


def set_maxdays(name, days):
    &quot;&quot;&quot;
    Set the maximum age of the password in days

    :param str name: The username of the account

    :param int days: The maximum age of the account in days

    :return: True if successful, False if not
    :rtype: bool

    :raises: CommandExecutionError on user not found or any other unknown error

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.set_maxdays admin 90
    &quot;&quot;&quot;
    minutes = days * 24 * 60

    _set_account_policy(name, &quot;maxMinutesUntilChangePassword={}&quot;.format(minutes))

    return get_maxdays(name) == days


def get_maxdays(name):
    &quot;&quot;&quot;
    Get the maximum age of the password

    :param str name: The username of the account

    :return: The maximum age of the password in days
    :rtype: int

    :raises: CommandExecutionError on user not found or any other unknown error

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.get_maxdays admin 90
    &quot;&quot;&quot;
    policies = _get_account_policy(name)

    if &quot;maxMinutesUntilChangePassword&quot; in policies:
        max_minutes = policies[&quot;maxMinutesUntilChangePassword&quot;]
        return int(max_minutes) / 24 / 60

    return 0


def set_mindays(name, days):
    &quot;&quot;&quot;
    Set the minimum password age in days. Not available in macOS.

    :param str name: The user name

    :param int days: The number of days

    :return: Will always return False until macOS supports this feature.
    :rtype: bool

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.set_mindays admin 90
    &quot;&quot;&quot;
    return False


def set_inactdays(name, days):
    &quot;&quot;&quot;
    Set the number if inactive days before the account is locked. Not available
    in macOS

    :param str name: The user name

    :param int days: The number of days

    :return: Will always return False until macOS supports this feature.
    :rtype: bool

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.set_inactdays admin 90
    &quot;&quot;&quot;
    return False


def set_warndays(name, days):
    &quot;&quot;&quot;
    Set the number of days before the password expires that the user will start
    to see a warning. Not available in macOS

    :param str name: The user name

    :param int days: The number of days

    :return: Will always return False until macOS supports this feature.
    :rtype: bool

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.set_warndays admin 90
    &quot;&quot;&quot;
    return False


def set_change(name, date):
    &quot;&quot;&quot;
    Sets the date on which the password expires. The user will be required to
    change their password. Format is mm/dd/yyyy

    :param str name: The name of the user account

    :param date date: The date the password will expire. Must be in mm/dd/yyyy
        format.

    :return: True if successful, otherwise False
    :rtype: bool

    :raises: CommandExecutionError on user not found or any other unknown error

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.set_change username 09/21/2016
    &quot;&quot;&quot;
    _set_account_policy(name, &quot;usingExpirationDate=1 expirationDateGMT={}&quot;.format(date))

    return get_change(name) == date


def get_change(name):
    &quot;&quot;&quot;
    Gets the date on which the password expires

    :param str name: The name of the user account

    :return: The date the password will expire
    :rtype: str

    :raises: CommandExecutionError on user not found or any other unknown error

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.get_change username
    &quot;&quot;&quot;
    policies = _get_account_policy(name)

    if &quot;expirationDateGMT&quot; in policies:
        return policies[&quot;expirationDateGMT&quot;]

    return &quot;Value not set&quot;


def set_expire(name, date):
    &quot;&quot;&quot;
    Sets the date on which the account expires. The user will not be able to
    login after this date. Date format is mm/dd/yyyy

    :param str name: The name of the user account

    :param datetime date: The date the account will expire. Format must be
        mm/dd/yyyy.

    :return: True if successful, False if not
    :rtype: bool

    :raises: CommandExecutionError on user not found or any other unknown error

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.set_expire username 07/23/2015
    &quot;&quot;&quot;
    _set_account_policy(
        name, &quot;usingHardExpirationDate=1 hardExpireDateGMT={}&quot;.format(date)
    )

    return get_expire(name) == date


def get_expire(name):
    &quot;&quot;&quot;
    Gets the date on which the account expires

    :param str name: The name of the user account

    :return: The date the account expires
    :rtype: str

    :raises: CommandExecutionError on user not found or any other unknown error

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.get_expire username
    &quot;&quot;&quot;
    policies = _get_account_policy(name)

    if &quot;hardExpireDateGMT&quot; in policies:
        return policies[&quot;hardExpireDateGMT&quot;]

    return &quot;Value not set&quot;


def del_password(name):
    &quot;&quot;&quot;
    Deletes the account password

    :param str name: The user name of the account

    :return: True if successful, otherwise False
    :rtype: bool

    :raises: CommandExecutionError on user not found or any other unknown error

    CLI Example:

    .. code-block:: bash

        salt '*' shadow.del_password username
    &quot;&quot;&quot;
    # This removes the password
    cmd = &quot;dscl . -passwd /Users/{} ''&quot;.format(name)
    try:
        salt.utils.mac_utils.execute_return_success(cmd)
    except CommandExecutionError as exc:
        if &quot;eDSUnknownNodeName&quot; in exc.strerror:
            raise CommandExecutionError(&quot;User not found: {}&quot;.format(name))
        raise CommandExecutionError(&quot;Unknown error: {}&quot;.format(exc.strerror))

    # This is so it looks right in shadow.info
    cmd = &quot;dscl . -create /Users/{} Password '*'&quot;.format(name)
    salt.utils.mac_utils.execute_return_success(cmd)

    return info(name)[&quot;passwd&quot;] == &quot;*&quot;


def set_password(name, password):
    &quot;&quot;&quot;
    Set the password for a named user (insecure, the password will be in the
    process list while the command is running)

    :param str name: The name of the local user, which is assumed to be in the
        local directory service

    :param str password: The plaintext password to set

    :return: True if successful, otherwise False
    :rtype: bool

    :raises: CommandExecutionError on user not found or any other unknown error

    CLI Example:

    .. code-block:: bash

        salt '*' mac_shadow.set_password macuser macpassword
    &quot;&quot;&quot;
    cmd = &quot;dscl . -passwd /Users/{} '{}'&quot;.format(name, password)
    try:
        salt.utils.mac_utils.execute_return_success(cmd)
    except CommandExecutionError as exc:
        if &quot;eDSUnknownNodeName&quot; in exc.strerror:
            raise CommandExecutionError(&quot;User not found: {}&quot;.format(name))
        raise CommandExecutionError(&quot;Unknown error: {}&quot;.format(exc.strerror))

    return True
</PRE>
</div>
  </div>
</body>
</html>
