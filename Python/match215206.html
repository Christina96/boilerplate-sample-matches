<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for heat.py &amp; mysql_2.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for heat.py &amp; mysql_2.py
      </h3>
<h1 align="center">
        1.4%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>heat.py (6.5789475%)<th>mysql_2.py (0.8389262%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(97-146)<td><a href="#" name="0">(1431-1464)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(212-213)<td><a href="#" name="1">(861-862)</a><td align="center"><font color="#eb0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>heat.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import salt.exceptions
3 import salt.utils.files
4 import salt.utils.json
5 import salt.utils.stringutils
6 import salt.utils.versions
7 import salt.utils.yaml
8 HAS_OSLO = False
9 try:
10     from oslo_serialization import jsonutils
11     HAS_OSLO = True
12 except ImportError:
13     pass
14 logging.basicConfig(level=logging.DEBUG)
15 log = logging.getLogger(__name__)
16 def __virtual__():
17     if HAS_OSLO:
18         return "heat"
19     return (
20         False,
21         "The heat state module cannot be loaded: "
22         "the oslo_serialization python library is not available.",
23     )
24 def _parse_template(tmpl_str):
25     tmpl_str = tmpl_str.strip()
26     if tmpl_str.startswith("{"):
27         tpl = salt.utils.json.loads(tmpl_str)
28     else:
29         try:
30             tpl = salt.utils.yaml.safe_load(tmpl_str)
31         except salt.utils.yaml.YAMLError as exc:
32             raise ValueError(str(exc))
33         else:
34             if tpl is None:
35                 tpl = {}
36     if not (
37         "HeatTemplateFormatVersion" in tpl
38         or "AWSTemplateFormatVersion" in tpl
39     ):
40         raise ValueError(<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"Template format version not found.")
41     return tpl
42 def deployed(
43     name,
44     template=None,
45     environment=None,
46     params=None,
47     poll=5,
48     rollback=False,
49     timeout=60,
50     update=False,
51     profile=None,
52     **connection_args
53 ):
54     log.</b></font>debug(
55         "Deployed with(%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)",
56         name,
57         template,
58         environment,
59         params,
60         poll,
61         rollback,
62         timeout,
63         update,
64         profile,
65         connection_args,
66     )
67     ret = {"name": None, "comment": "", "changes": {}, "result": True}
68     if not name:
69         ret["result"] = False
70         ret["comment"] = "Name ist not valid"
71         return ret
72     ret["name"] = (name,)
73     existing_stack = __salt__["heat.show_stack"](name, profile=profile)
74     if existing_stack["result"] and not update:
75         ret["comment"] = "Stack {} is deployed".format(name)
76         return ret
77     if existing_stack["result"] and update:
78         if template:
79             template_tmp_file = salt.utils.files.mkstemp()
80             tsfn, source_sum, comment_ = __salt__["file.get_managed"](
81                 name=template_tmp_file,
82                 template=None,
83                 source=template,
84                 source_hash=None,
85                 user=None,
86                 group=None,
87                 mode=None,
88                 saltenv="base",
89                 context=None,
90                 defaults=None,
91                 skip_verify=False,
92                 kwargs=None,
93             )
94             template_manage_result = __salt__["file.manage_file"](
95                 name=template_tmp_file,
96                 sfn=tsfn,
97                 ret=None,
98                 source=template,
99                 source_sum=source_sum,
100                 user=None,
101                 group=None,
102                 mode=None,
103                 saltenv="base",
104                 backup=None,
105                 makedirs=True,
106                 template=None,
107                 show_changes=False,
108                 contents=None,
109                 dir_mode=None,
110             )
111                 (__opts__["test"]) and (template_manage_result["result"] is not False)
112             ):
113                 <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>with salt.utils.files.fopen(template_tmp_file, "r") as tfp_:
114                     tpl = salt.utils.stringutils.to_unicode(tfp_.read(</b></font>))
115                     salt.utils.files.safe_rm(template_tmp_file)
116                     try:
117                         template_parse = _parse_template(tpl)
118                         if "heat_template_version" in template_parse:
119                             template_new = salt.utils.yaml.safe_dump(template_parse)
120                         else:
121                             template_new = jsonutils.dumps(
122                                 template_parse, indent=2, ensure_ascii=False
123                             )
124                         salt.utils.files.safe_rm(template_tmp_file)
125                     except ValueError as ex:
126                         ret["result"] = False
127                         ret["comment"] = "Error parsing template {}".format(ex)
128             else:
129                 ret["result"] = False
130                 ret["comment"] = "Can not open template: {} {}".format(
131                     template, comment_
132                 )
133         else:
134             ret["result"] = False
135             ret["comment"] = "Can not open template"
136         if ret["result"] is True:
137             template_stack = __salt__["heat.template_stack"](name=name, profile=profile)
138             if not template_stack["result"]:
139                 ret["result"] = False
140                 ret["comment"] = template_stack["comment"]
141         if ret["result"] is False:
142             return ret
143         try:
144             checksum_template = __salt__["hashutil.digest"](template_new)
145             checksum_stack = __salt__["hashutil.digest"](template_stack["template"])
146         except salt.exceptions.CommandExecutionError as cmdexc:
147             ret["result"] = False
148             ret["comment"] = "{}".format(cmdexc)
149         if ret["result"] is True:
150             if checksum_template == checksum_stack:
151                 if __opts__["test"]:
152                     ret["result"] = True
153                     ret["comment"] = "Stack {} is deployed".format(name)
154                     return ret
155                 else:
156                     ret["result"] = False
157                     ret["comment"] = "Templates have same checksum: {} {}".format(
158                         checksum_template, checksum_stack
159                     )
160         if ret["result"] is False:
161             return ret
162         if __opts__["test"]:
163             stack = {
164                 "result": None,
165                 "comment": "Stack {} is set to be updated".format(name),
166             }
167         else:
168             stack = __salt__["heat.update_stack"](
169                 name=name,
170                 template_file=template,
171                 environment=environment,
172                 parameters=params,
173                 poll=poll,
174                 rollback=rollback,
175                 timeout=timeout,
176                 profile=profile,
177             )
178             ret["changes"]["stack_name"] = name
179             ret["changes"]["comment"] = "Update stack"
180     else:
181         if __opts__["test"]:
182             stack = {
183                 "result": None,
184                 "comment": "Stack {} is set to be created".format(name),
185             }
186         else:
187             stack = __salt__["heat.create_stack"](
188                 name=name,
189                 template_file=template,
190                 environment=environment,
191                 parameters=params,
192                 poll=poll,
193                 rollback=rollback,
194                 timeout=timeout,
195                 profile=profile,
196             )
197             ret["changes"]["stack_name"] = name
198             ret["changes"]["comment"] = "Create stack"
199     ret["result"] = stack["result"]
200     ret["comment"] = stack["comment"]
201     return ret
202 def absent(name, poll=5, timeout=60, profile=None):
203     log.debug("Absent with(%s, %s %s)", name, poll, profile)
204     ret = {"name": None, "comment": "", "changes": {}, "result": True}
205     if not name:
206         ret["result"] = False
207         ret["comment"] = "Name ist not valid"
208         return ret
209     ret["name"] = (name,)
210     existing_stack = __salt__["heat.show_stack"](name, profile=profile)
211     if not existing_stack["result"]:
212         ret["result"] = True
213         ret["comment"] = "Stack not exist"
214         return ret
215     if __opts__["test"]:
216         ret["result"] = None
217         ret["comment"] = "Stack {} is set to be removed".format(name)
218         return ret
219     stack = __salt__["heat.delete_stack"](
220         name=name, poll=poll, timeout=timeout, profile=profile
221     )
222     ret["result"] = stack["result"]
223     ret["comment"] = stack["comment"]
224     ret["changes"]["stack_name"] = name
225     ret["changes"]["comment"] = "Delete stack"
226     return ret
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>mysql_2.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import copy
2 import hashlib
3 import logging
4 import os
5 import re
6 import shlex
7 import sys
8 import time
9 import salt.utils.data
10 import salt.utils.files
11 import salt.utils.stringutils
12 try:
13     import MySQLdb
14     import MySQLdb.cursors
15     import MySQLdb.converters
16     from MySQLdb.constants import FIELD_TYPE, FLAG, CLIENT
17     from MySQLdb import OperationalError
18 except ImportError:
19     try:
20         import pymysql
21         pymysql.install_as_MySQLdb()
22         import MySQLdb
23         import MySQLdb.cursors
24         import MySQLdb.converters
25         from MySQLdb.constants import FIELD_TYPE, FLAG, CLIENT
26         from MySQLdb import OperationalError
27     except ImportError:
28         MySQLdb = None
29 try:
30     import sqlparse
31     HAS_SQLPARSE = True
32 except ImportError:
33     HAS_SQLPARSE = False
34 log = logging.getLogger(__name__)
35 __opts__ = {}
36 __grants__ = [
37     "ALL PRIVILEGES",
38     "ALTER",
39     "ALTER ROUTINE",
40     "BACKUP_ADMIN",
41     "BINLOG_ADMIN",
42     "CONNECTION_ADMIN",
43     "CREATE",
44     "CREATE ROLE",
45     "CREATE ROUTINE",
46     "CREATE TABLESPACE",
47     "CREATE TEMPORARY TABLES",
48     "CREATE USER",
49     "CREATE VIEW",
50     "DELETE",
51     "DROP",
52     "DROP ROLE",
53     "ENCRYPTION_KEY_ADMIN",
54     "EVENT",
55     "EXECUTE",
56     "FILE",
57     "GRANT OPTION",
58     "GROUP_REPLICATION_ADMIN",
59     "INDEX",
60     "INSERT",
61     "LOCK TABLES",
62     "PERSIST_RO_VARIABLES_ADMIN",
63     "PROCESS",
64     "REFERENCES",
65     "RELOAD",
66     "REPLICATION CLIENT",
67     "REPLICATION SLAVE",
68     "REPLICATION_SLAVE_ADMIN",
69     "RESOURCE_GROUP_ADMIN",
70     "RESOURCE_GROUP_USER",
71     "ROLE_ADMIN",
72     "SELECT",
73     "SET_USER_ID",
74     "SHOW DATABASES",
75     "SHOW VIEW",
76     "SHUTDOWN",
77     "SLAVE MONITOR",
78     "SUPER",
79     "SYSTEM_VARIABLES_ADMIN",
80     "TRIGGER",
81     "UPDATE",
82     "USAGE",
83     "XA_RECOVER_ADMIN",
84 ]
85 __ssl_options_parameterized__ = ["CIPHER", "ISSUER", "SUBJECT"]
86 __ssl_options__ = __ssl_options_parameterized__ + ["SSL", "X509"]
87 __all_privileges__ = [
88     "ALTER",
89     "ALTER ROUTINE",
90     "BACKUP_ADMIN",
91     "BINLOG_ADMIN",
92     "CONNECTION_ADMIN",
93     "CREATE",
94     "CREATE ROLE",
95     "CREATE ROUTINE",
96     "CREATE TABLESPACE",
97     "CREATE TEMPORARY TABLES",
98     "CREATE USER",
99     "CREATE VIEW",
100     "DELETE",
101     "DROP",
102     "DROP ROLE",
103     "ENCRYPTION_KEY_ADMIN",
104     "EVENT",
105     "EXECUTE",
106     "FILE",
107     "GROUP_REPLICATION_ADMIN",
108     "INDEX",
109     "INSERT",
110     "LOCK TABLES",
111     "PERSIST_RO_VARIABLES_ADMIN",
112     "PROCESS",
113     "REFERENCES",
114     "RELOAD",
115     "REPLICATION CLIENT",
116     "REPLICATION SLAVE",
117     "REPLICATION_SLAVE_ADMIN",
118     "RESOURCE_GROUP_ADMIN",
119     "RESOURCE_GROUP_USER",
120     "ROLE_ADMIN",
121     "SELECT",
122     "SET_USER_ID",
123     "SHOW DATABASES",
124     "SHOW VIEW",
125     "SHUTDOWN",
126     "SUPER",
127     "SYSTEM_VARIABLES_ADMIN",
128     "TRIGGER",
129     "UPDATE",
130     "XA_RECOVER_ADMIN",
131 ]
132 r'''
133 DEVELOPER NOTE: ABOUT arguments management, escapes, formats, arguments and
134 security of SQL.
135 A general rule of SQL security is to use queries with _execute call in this
136 code using args parameter to let MySQLdb manage the arguments proper escaping.
137 Another way of escaping values arguments could be '{0!r}'.format(), using
138 __repr__ to ensure things get properly used as strings. But this could lead
139 to three problems:
140  * In ANSI mode, which is available on MySQL, but not by default, double
141 quotes " should not be used as a string delimiters, in ANSI mode this is an
142 identifier delimiter (like `).
143  * Some rare exploits with bad multibytes management, either on python or
144 MySQL could defeat this barrier, bindings internal escape functions
145 should manage theses cases.
146  * Unicode strings in Python 2 will include the 'u' before the repr'ed string,
147    like so:
148     Python 2.7.10 (default, May 26 2015, 04:16:29)
149     [GCC 5.1.0] on linux2
150     Type "help", "copyright", "credits" or "license" for more information.
151     &gt;&gt;&gt; u'something something {0!r}'.format(u'foo')
152     u"something something u'foo'"
153 So query with arguments should use a paramstyle defined in PEP249:
154 http://www.python.org/dev/peps/pep-0249/#paramstyle
155 We use pyformat, which means 'SELECT * FROM foo WHERE bar=%(myval)s'
156 used with {'myval': 'some user input'}
157 So far so good. But this cannot be used for identifier escapes. Identifiers
158 are database names, table names and column names. Theses names are not values
159 and do not follow the same escape rules (see quote_identifier function for
160 details on `_ and % escape policies on identifiers). Using value escaping on
161 identifier could fool the SQL engine (badly escaping quotes and not doubling
162 ` characters. So for identifiers a call to quote_identifier should be done and
163 theses identifiers should then be added in strings with format, but without
164 __repr__ filter.
165 Note also that when using query with arguments in _execute all '%' characters
166 used in the query should get escaped to '%%' fo MySQLdb, but should not be
167 escaped if the query runs without arguments. This is managed by _execute() and
168 quote_identifier. This is not the same as escaping '%' to '\%' or '_' to '\%'
169 when using a LIKE query (example in db_exists), as this escape is there to
170 avoid having _ or % characters interpreted in LIKE queries. The string parted
171 of the first query could become (still used with args dictionary for myval):
172 'SELECT * FROM {0} WHERE bar=%(myval)s'.format(quote_identifier('user input'))
173 Check integration tests if you find a hole in theses strings and escapes rules
174 Finally some examples to sum up.
175 Given a name f_o%o`b'a"r, in python that would be """f_o%o`b'a"r""". I'll
176 avoid python syntax for clarity:
177 The MySQL way of writing this name is:
178 value                         : 'f_o%o`b\'a"r' (managed by MySQLdb)
179 identifier                    : `f_o%o``b'a"r`
180 db identifier in general GRANT: `f\_o\%o``b'a"r`
181 db identifier in table GRANT  : `f_o%o``b'a"r`
182 in mySQLdb, query with args   : `f_o%%o``b'a"r` (as identifier)
183 in mySQLdb, query without args: `f_o%o``b'a"r` (as identifier)
184 value in a LIKE query         : 'f\_o\%o`b\'a"r' (quotes managed by MySQLdb)
185 And theses could be mixed, in a like query value with args: 'f\_o\%%o`b\'a"r'
186 '''
187         <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>with salt.utils.files.fopen(file_name, "r") as ifile:
188             contents = salt.utils.stringutils.to_unicode(ifile.read(</b></font>))
189     else:
190         log.error('File "%s" does not exist', file_name)
191         return False
192     query_string = ""
193     ret = {
194         "rows returned": 0,
195         "columns": [],
196         "results": [],
197         "rows affected": 0,
198         "query time": {"raw": 0},
199     }
200     contents = _sanitize_comments(contents)
201     for line in contents.splitlines():
202         if not re.search(r"[^-;]+;", line):  # keep appending lines that don't end in ;
203             query_string = query_string + line
204         else:
205             query_string = (
206                 query_string + line
207             )  # append lines that end with ; and run query
208             query_result = query(database, query_string, **connection_args)
209             query_string = ""
210             if query_result is False:
211                 return False
212             if "query time" in query_result:
213                 ret["query time"]["raw"] += float(query_result["query time"]["raw"])
214             if "rows returned" in query_result:
215                 ret["rows returned"] += query_result["rows returned"]
216             if "columns" in query_result:
217                 ret["columns"].append(query_result["columns"])
218             if "results" in query_result:
219                 ret["results"].append(query_result["results"])
220             if "rows affected" in query_result:
221                 ret["rows affected"] += query_result["rows affected"]
222     ret["query time"]["human"] = str(round(float(ret["query time"]["raw"]), 2)) + "s"
223     ret["query time"]["raw"] = round(float(ret["query time"]["raw"]), 5)
224     ret = {k: v for k, v in ret.items() if v}
225     return ret
226 def status(**connection_args):
227     """
228     Return the status of a MySQL server using the output from the ``SHOW
229     STATUS`` query.
230     CLI Example:
231     .. code-block:: bash
232         salt '*' mysql.status
233     """
234     dbc = _connect(**connection_args)
235     if dbc is None:
236         return {}
237     cur = dbc.cursor()
238     qry = "SHOW STATUS"
239     try:
240         _execute(cur, qry)
241     except OperationalError as exc:
242         err = "MySQL Error {}: {}".format(*exc.args)
243         __context__["mysql.error"] = err
244         log.error(err)
245         return {}
246     ret = {}
247     for _ in range(cur.rowcount):
248         row = cur.fetchone()
249         ret[row[0]] = row[1]
250     return ret
251 def version(**connection_args):
252     """
253     Return the version of a MySQL server using the output from the ``SELECT
254     VERSION()`` query.
255     CLI Example:
256     .. code-block:: bash
257         salt '*' mysql.version
258     """
259     if "mysql.version" in __context__:
260         return __context__["mysql.version"]
261     dbc = _connect(**connection_args)
262     if dbc is None:
263         return ""
264     cur = dbc.cursor()
265     qry = "SELECT VERSION()"
266     try:
267         _execute(cur, qry)
268     except MySQLdb.OperationalError as exc:
269         err = "MySQL Error {}: {}".format(*exc.args)
270         __context__["mysql.error"] = err
271         log.error(err)
272         return ""
273     try:
274         __context__["mysql.version"] = salt.utils.data.decode(cur.fetchone()[0])
275         return __context__["mysql.version"]
276     except IndexError:
277         return ""
278 def slave_lag(**connection_args):
279     """
280     Return the number of seconds that a slave SQL server is lagging behind the
281     master, if the host is not a slave it will return -1.  If the server is
282     configured to be a slave for replication but slave IO is not running then
283     -2 will be returned. If there was an error connecting to the database or
284     checking the slave status, -3 will be returned.
285     CLI Example:
286     .. code-block:: bash
287         salt '*' mysql.slave_lag
288     """
289     dbc = _connect(**connection_args)
290     if dbc is None:
291         return -3
292     cur = dbc.cursor(MySQLdb.cursors.DictCursor)
293     qry = "show slave status"
294     try:
295         _execute(cur, qry)
296     except MySQLdb.OperationalError as exc:
297         err = "MySQL Error {}: {}".format(*exc.args)
298         __context__["mysql.error"] = err
299         log.error(err)
300         return -3
301     results = cur.fetchone()
302     if cur.rowcount == 0:
303         return -1
304     else:
305         if results["Slave_IO_Running"] == "Yes":
306             return results["Seconds_Behind_Master"]
307         else:
308             return -2
309 def free_slave(**connection_args):
310     """
311     Frees a slave from its master.  This is a WIP, do not use.
312     CLI Example:
313     .. code-block:: bash
314         salt '*' mysql.free_slave
315     """
316     slave_db = _connect(**connection_args)
317     if slave_db is None:
318         return ""
319     slave_cur = slave_db.cursor(MySQLdb.cursors.DictCursor)
320     slave_cur.execute("show slave status")
321     slave_status = slave_cur.fetchone()
322     master = {"host": slave_status["Master_Host"]}
323     try:
324         master_db = _connect(**master)
325         if master_db is None:
326             return ""
327         master_cur = master_db.cursor()
328         master_cur.execute("flush logs")
329         master_db.close()
330     except MySQLdb.OperationalError:
331         pass
332     slave_cur.execute("stop slave")
333     slave_cur.execute("reset master")
334     slave_cur.execute("change master to MASTER_HOST=")
335     slave_cur.execute("show slave status")
336     results = slave_cur.fetchone()
337     if results is None:
338         return "promoted"
339     else:
340         return "failed"
341 def db_list(**connection_args):
342     """
343     Return a list of databases of a MySQL server using the output
344     from the ``SHOW DATABASES`` query.
345     CLI Example:
346     .. code-block:: bash
347         salt '*' mysql.db_list
348     """
349     dbc = _connect(**connection_args)
350     if dbc is None:
351         return []
352     cur = dbc.cursor()
353     qry = "SHOW DATABASES"
354     try:
355         _execute(cur, qry)
356     except MySQLdb.OperationalError as exc:
357         err = "MySQL Error {}: {}".format(*exc.args)
358         __context__["mysql.error"] = err
359         log.error(err)
360         return []
361     ret = []
362     results = cur.fetchall()
363     for dbs in results:
364         ret.append(dbs[0])
365     log.debug(ret)
366     return ret
367 def alter_db(name, character_set=None, collate=None, **connection_args):
368     """
369     Modify database using ``ALTER DATABASE %(dbname)s CHARACTER SET %(charset)s
370     COLLATE %(collation)s;`` query.
371     CLI Example:
372     .. code-block:: bash
373         salt '*' mysql.alter_db testdb charset='latin1'
374     """
375     dbc = _connect(**connection_args)
376     if dbc is None:
377         return []
378     cur = dbc.cursor()
379     existing = db_get(name, **connection_args)
380     qry = "ALTER DATABASE `{}` CHARACTER SET {} COLLATE {};".format(
381         name,
382         character_set or existing.get("character_set"),
383         collate or existing.get("collate"),
384     )
385     args = {}
386     try:
387         if _execute(cur, qry, args):
388             log.info("DB '%s' altered", name)
389             return True
390     except MySQLdb.OperationalError as exc:
391         err = "MySQL Error {}: {}".format(*exc.args)
392         __context__["mysql.error"] = err
393         log.error(err)
394     return False
395 def db_get(name, **connection_args):
396     """
397     Return a list of databases of a MySQL server using the output
398     from the ``SELECT DEFAULT_CHARACTER_SET_NAME, DEFAULT_COLLATION_NAME FROM
399     INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME='dbname';`` query.
400     CLI Example:
401     .. code-block:: bash
402         salt '*' mysql.db_get test
403     """
404     dbc = _connect(**connection_args)
405     if dbc is None:
406         return []
407     cur = dbc.cursor()
408     qry = (
409         "SELECT DEFAULT_CHARACTER_SET_NAME, DEFAULT_COLLATION_NAME FROM "
410         "INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME=%(dbname)s;"
411     )
412     args = {"dbname": name}
413     try:
414         _execute(cur, qry, args)
415     except MySQLdb.OperationalError as exc:
416         err = "MySQL Error {}: {}".format(*exc.args)
417         __context__["mysql.error"] = err
418         log.error(err)
419         return []
420     if cur.rowcount:
421         rows = cur.fetchall()
422         return {"character_set": rows[0][0], "collate": rows[0][1]}
423     return {}
424 def db_tables(name, **connection_args):
425     """
426     Shows the tables in the given MySQL database (if exists)
427     CLI Example:
428     .. code-block:: bash
429         salt '*' mysql.db_tables 'database'
430     """
431     if not db_exists(name, **connection_args):
432         log.info("Database '%s' does not exist", name)
433         return False
434     dbc = _connect(**connection_args)
435     if dbc is None:
436         return []
437     cur = dbc.cursor()
438     s_name = quote_identifier(name)
439     qry = "SHOW TABLES IN {}".format(s_name)
440     try:
441         _execute(cur, qry)
442     except MySQLdb.OperationalError as exc:
443         err = "MySQL Error {}: {}".format(*exc.args)
444         __context__["mysql.error"] = err
445         log.error(err)
446         return []
447     ret = []
448     results = cur.fetchall()
449     for table in results:
450         ret.append(table[0])
451     log.debug(ret)
452     return ret
453 def db_exists(name, **connection_args):
454     """
455     Checks if a database exists on the MySQL server.
456     CLI Example:
457     .. code-block:: bash
458         salt '*' mysql.db_exists 'dbname'
459     """
460     dbc = _connect(**connection_args)
461     if dbc is None:
462         return False
463     cur = dbc.cursor()
464     args = {"dbname": name}
465     qry = "SHOW DATABASES LIKE %(dbname)s;"
466     try:
467         _execute(cur, qry, args)
468     except MySQLdb.OperationalError as exc:
469         err = "MySQL Error {}: {}".format(*exc.args)
470         __context__["mysql.error"] = err
471         log.error(err)
472         return False
473     cur.fetchall()
474     return cur.rowcount == 1
475 def db_create(name, character_set=None, collate=None, **connection_args):
476     """
477     Adds a databases to the MySQL server.
478     name
479         The name of the database to manage
480     character_set
481         The character set, if left empty the MySQL default will be used
482     collate
483         The collation, if left empty the MySQL default will be used
484     CLI Example:
485     .. code-block:: bash
486         salt '*' mysql.db_create 'dbname'
487         salt '*' mysql.db_create 'dbname' 'utf8' 'utf8_general_ci'
488     """
489     if db_exists(name, **connection_args):
490         log.info("DB '%s' already exists", name)
491         return False
492     dbc = _connect(**connection_args)
493     if dbc is None:
494         return False
495     cur = dbc.cursor()
496     s_name = quote_identifier(name)
497     qry = "CREATE DATABASE IF NOT EXISTS {}".format(s_name)
498     args = {}
499     if character_set is not None:
500         qry += " CHARACTER SET %(character_set)s"
501         args["character_set"] = character_set
502     if collate is not None:
503         qry += " COLLATE %(collate)s"
504         args["collate"] = collate
505     qry += ";"
506     try:
507         if _execute(cur, qry, args):
508             log.info("DB '%s' created", name)
509             return True
510     except MySQLdb.OperationalError as exc:
511         err = "MySQL Error {}: {}".format(*exc.args)
512         __context__["mysql.error"] = err
513         log.error(err)
514     return False
515 def db_remove(name, **connection_args):
516     """
517     Removes a databases from the MySQL server.
518     CLI Example:
519     .. code-block:: bash
520         salt '*' mysql.db_remove 'dbname'
521     """
522     if not db_exists(name, **connection_args):
523         log.info("DB '%s' does not exist", name)
524         return False
525     if name in ("mysql", "information_scheme"):
526         log.info("DB '%s' may not be removed", name)
527         return False
528     dbc = _connect(**connection_args)
529     if dbc is None:
530         return False
531     cur = dbc.cursor()
532     s_name = quote_identifier(name)
533     qry = "DROP DATABASE {};".format(s_name)
534     try:
535         _execute(cur, qry)
536     except MySQLdb.OperationalError as exc:
537         err = "MySQL Error {}: {}".format(*exc.args)
538         __context__["mysql.error"] = err
539         log.error(err)
540         return False
541     if not db_exists(name, **connection_args):
542         log.info("Database '%s' has been removed", name)
543         return True
544     log.info("Database '%s' has not been removed", name)
545     return False
546 def user_list(**connection_args):
547     """
548     Return a list of users on a MySQL server
549     CLI Example:
550     .. code-block:: bash
551         salt '*' mysql.user_list
552     """
553     dbc = _connect(**connection_args)
554     if dbc is None:
555         return []
556     cur = dbc.cursor(MySQLdb.cursors.DictCursor)
557     try:
558         qry = "SELECT User,Host FROM mysql.user"
559         _execute(cur, qry)
560     except MySQLdb.OperationalError as exc:
561         err = "MySQL Error {}: {}".format(*exc.args)
562         __context__["mysql.error"] = err
563         log.error(err)
564         return []
565     results = cur.fetchall()
566     log.debug(results)
567     return results
568 def _mysql_user_exists(
569     user,
570     host="localhost",
571     password=None,
572     password_hash=None,
573     passwordless=False,
574     unix_socket=False,
575     password_column=None,
576     auth_plugin="mysql_native_password",
577     **connection_args
578 ):
579     server_version = salt.utils.data.decode(version(**connection_args))
580     compare_version = "8.0.11"
581     qry = "SELECT User,Host FROM mysql.user WHERE User = %(user)s AND Host = %(host)s"
582     args = {}
583     args["user"] = user
584     args["host"] = host
585     if salt.utils.data.is_true(passwordless):
586         if salt.utils.data.is_true(unix_socket):
587             qry += " AND plugin=%(unix_socket)s"
588             args["unix_socket"] = "auth_socket"
589         else:
590             qry += " AND " + password_column + " = ''"
591     elif password:
592         if salt.utils.versions.version_cmp(server_version, compare_version) &gt;= 0:
593             if auth_plugin == "mysql_native_password":
594                 _password = __mysql_hash_password(str(password))
595                 qry += " AND " + password_column + " = %(password)s"
596                 args["password"] = str(_password)
597             else:
598                 err = "Unable to verify password."
599                 log.error(err)
600                 __context__["mysql.error"] = err
601         else:
602             qry += " AND " + password_column + " = PASSWORD(%(password)s)"
603             args["password"] = str(password)
604     elif password_hash:
605         qry += " AND " + password_column + " = %(password)s"
606         args["password"] = password_hash
607     return qry, args
608 def _mariadb_user_exists(
609     user,
610     host="localhost",
611     password=None,
612     password_hash=None,
613     passwordless=False,
614     unix_socket=False,
615     password_column=None,
616     auth_plugin="mysql_native_password",
617     **connection_args
618 ):
619     qry = "SELECT User,Host FROM mysql.user WHERE User = %(user)s AND Host = %(host)s"
620     args = {}
621     args["user"] = user
622     args["host"] = host
623     if salt.utils.data.is_true(passwordless):
624         if salt.utils.data.is_true(unix_socket):
625             qry += " AND plugin=%(unix_socket)s"
626             args["unix_socket"] = "unix_socket"
627         else:
628             qry += " AND " + password_column + " = ''"
629     elif password:
630         qry += " AND " + password_column + " = PASSWORD(%(password)s)"
631     elif password_hash:
632         qry += " AND " + password_column + " = %(password)s"
633         args["password"] =<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b> password_hash
634     return qry, args
635 def user_exists(
636     user,
637     host="localhost",
638     password=None,
639     password_hash=None,
640     passwordless=False,
641     unix_socket=False,
642     password_column=None,
643     **connection_args
644 ):
645     """
646     Checks if a user exists on the MySQL server. A login can be checked to see
647     if passwordless login is permitted by omitting ``password`` and
648     ``password_hash``, and using ``passwordless=True``.
649     .. versionadded:: 0.16.2
650         The ``passwordless`` option was added.
651     CLI Example:
652     .. code-block:: bash
653         salt '*' mysql.user_exists 'username' 'hostname' 'password'
654         salt '*' mysql.user_exists 'username' 'hostname' password_hash='hash'
655         salt '*' mysql.user_exists 'username' passwordless=True
656         salt '*' mysql.user_exists 'username' password_column='authentication_string'
657     """
658     run_verify = False
659     server_version = salt.</b></font>utils.data.decode(version(**connection_args))
660     if not server_version and password:
661         __context__["mysql.error"] = None
662         connection_args["connection_pass"] = password
663         server_version = salt.utils.data.decode(version(**connection_args))
664         if not server_version:
665             last_err = __context__["mysql.error"]
666             err = (
667                 "MySQL Error: Unable to fetch current server version. Last error was:"
668                 ' "{}"'.format(last_err)
669             )
670             log.error(err)
671             return False
672     dbc = _connect(**connection_args)
673     if (
674         dbc is None
675         and __context__["mysql.error"].startswith(
676             "MySQL Error 1045: Access denied for user '{}'@".format(user)
677         )
678         and password
679     ):
680         __context__["mysql.error"] = None
681         connection_args["connection_pass"] = password
682         dbc = _connect(**connection_args)
683     if dbc is None:
684         return False
685     if not password_column:
686         password_column = __password_column(**connection_args)
687     auth_plugin = __get_auth_plugin(user, host, **connection_args)
688     cur = dbc.cursor()
689     if "MariaDB" in server_version:
690         qry, args = _mariadb_user_exists(
691             user,
692             host,
693             password,
694             password_hash,
695             passwordless,
696             unix_socket,
697             password_column=password_column,
698             auth_plugin=auth_plugin,
699             **connection_args
700         )
701     else:
702         qry, args = _mysql_user_exists(
703             user,
704             host,
705             password,
706             password_hash,
707             passwordless,
708             unix_socket,
709             password_column=password_column,
710             auth_plugin=auth_plugin,
711             **connection_args
712         )
713     try:
714         _execute(cur, qry, args)
715     except MySQLdb.OperationalError as exc:
716         err = "MySQL Error {}: {}".format(*exc.args)
717         __context__["mysql.error"] = err
718         log.error(err)
719         return False
720     return cur.rowcount == 1
721 def user_info(user, host="localhost", **connection_args):
722     """
723     Get full info on a MySQL user
724     CLI Example:
725     .. code-block:: bash
726         salt '*' mysql.user_info root localhost
727     """
728     dbc = _connect(**connection_args)
729     if dbc is None:
730         return False
731     cur = dbc.cursor(MySQLdb.cursors.DictCursor)
732     qry = "SELECT * FROM mysql.user WHERE User = %(user)s AND Host = %(host)s"
733     args = {}
734     args["user"] = user
735     args["host"] = host
736     try:
737         _execute(cur, qry, args)
738     except MySQLdb.OperationalError as exc:
739         err = "MySQL Error {}: {}".format(*exc.args)
740         __context__["mysql.error"] = err
741         log.error(err)
742         return False
743     result = cur.fetchone()
744     log.debug(result)
745     return result
746 def _mysql_user_create(
747     user,
748     host="localhost",
749     password=None,
750     password_hash=None,
751     allow_passwordless=False,
752     unix_socket=False,
753     password_column=None,
754     auth_plugin="mysql_native_password",
755     **connection_args
756 ):
757     server_version = salt.utils.data.decode(version(**connection_args))
758     compare_version = "8.0.11"
759     qry = "CREATE USER %(user)s@%(host)s"
760     args = {}
761     args["user"] = user
762     args["host"] = host
763     if unix_socket:
764         if not plugin_status("auth_socket", **connection_args):
765             err = "The auth_socket plugin is not enabled."
766             log.error(err)
767             __context__["mysql.error"] = err
768             qry = False
769         else:
770             if host == "localhost":
771                 qry += " IDENTIFIED WITH auth_socket"
772             else:
773                 log.error("Auth via unix_socket can be set only for host=localhost")
774                 __context__["mysql.error"] = err
775                 qry = False
776     else:
777         if not salt.utils.data.is_true(allow_passwordless):
778             if password is not None:
779                 if (
780                     salt.utils.versions.version_cmp(server_version, compare_version)
781                     &gt;= 0
782                 ):
783                     args["auth_plugin"] = auth_plugin
784                     qry += " IDENTIFIED WITH %(auth_plugin)s BY %(password)s"
785                 else:
786                     qry += " IDENTIFIED BY %(password)s"
787                 args["password"] = str(password)
788             elif password_hash is not None:
789                 if (
790                     salt.utils.versions.version_cmp(server_version, compare_version)
791                     &gt;= 0
792                 ):
793                     args["auth_plugin"] = auth_plugin
794                     qry += " IDENTIFIED WITH %(auth_plugin)s AS %(password)s"
795                 else:
796                     qry += " IDENTIFIED BY PASSWORD %(password)s"
797                 args["password"] = password_hash
798             else:
799                 log.error(
800                     "password or password_hash must be specified, unless "
801                     "allow_passwordless=True"
802                 )
803                 qry = False
804     return qry, args
805 def _mariadb_user_create(
806     user,
807     host="localhost",
808     password=None,
809     password_hash=None,
810     allow_passwordless=False,
811     unix_socket=False,
812     password_column=None,
813     auth_plugin="mysql_native_password",
814     **connection_args
815 ):
816     qry = "CREATE USER %(user)s@%(host)s"
817     args = {}
818     args["user"] = user
819     args["host"] = host
820     if unix_socket:
821         if not plugin_status("unix_socket", **connection_args):
822             err = "The unix_socket plugin is not enabled."
823             log.error(err)
824             __context__["mysql.error"] = err
825             qry = False
826         else:
827             if host == "localhost":
828                 qry += " IDENTIFIED VIA unix_socket"
829             else:
830                 log.error("Auth via unix_socket can be set only for host=localhost")
831                 __context__["mysql.error"] = err
832                 qry = False
833     else:
834         if not salt.utils.data.is_true(allow_passwordless):
835             if password is not None:
836                 qry += " IDENTIFIED BY %(password)s"
837                 args["password"] = str(password)
838             elif password_hash is not None:
839                 qry += " IDENTIFIED BY PASSWORD %(password)s"
840                 args["password"] = password_hash
841             else:
842                 log.error(
843                     "password or password_hash must be specified, unless "
844                     "allow_passwordless=True"
845                 )
846                 qry = False
847     return qry, args
848 def user_create(
849     user,
850     host="localhost",
851     password=None,
852     password_hash=None,
853     allow_passwordless=False,
854     unix_socket=False,
855     password_column=None,
856     auth_plugin="mysql_native_password",
857     **connection_args
858 ):
859     """
860     Creates a MySQL user
861     host
862         Host for which this user/password combo applies
863     password
864         The password to use for the new user. Will take precedence over the
865         ``password_hash`` option if both are specified.
866     password_hash
867         The password in hashed form. Be sure to quote the password because YAML
868         doesn't like the ``*``. A password hash can be obtained from the mysql
869         command-line client like so::
870             mysql&gt; SELECT PASSWORD('mypass');
871             +-------------------------------------------+
872             | PASSWORD('mypass')                        |
873             +-------------------------------------------+
874             | *6C8989366EAF75BB670AD8EA7A7FC1176A95CEF4 |
875             +-------------------------------------------+
876             1 row in set (0.00 sec)
877     allow_passwordless
878         If ``True``, then ``password`` and ``password_hash`` can be omitted (or
879         set to ``None``) to permit a passwordless login.
880     unix_socket
881         If ``True`` and allow_passwordless is ``True`` then will be used unix_socket auth plugin.
882     password_column
883         The password column to use in the user table.
884     auth_plugin
885         The authentication plugin to use, default is to use the mysql_native_password plugin.
886     .. versionadded:: 0.16.2
887         The ``allow_passwordless`` option was added.
888     CLI Examples:
889     .. code-block:: bash
890         salt '*' mysql.user_create 'username' 'hostname' 'password'
891         salt '*' mysql.user_create 'username' 'hostname' password_hash='hash'
892         salt '*' mysql.user_create 'username' 'hostname' allow_passwordless=True
893     """
894     server_version = salt.utils.data.decode(version(**connection_args))
895     if not server_version and password:
896         __context__["mysql.error"] = None
897         connection_args["connection_pass"] = password
898         server_version = salt.utils.data.decode(version(**connection_args))
899         if not server_version:
900             last_err = __context__["mysql.error"]
901             err = (
902                 "MySQL Error: Unable to fetch current server version. Last error was:"
903                 ' "{}"'.format(last_err)
904             )
905             log.error(err)
906             return False
907     if user_exists(user, host, **connection_args):
908         log.info("User '%s'@'%s' already exists", user, host)
909         return False
910     dbc = _connect(**connection_args)
911     if dbc is None:
912         return False
913     if not password_column:
914         password_column = __password_column(**connection_args)
915     cur = dbc.cursor()
916     if "MariaDB" in server_version:
917         qry, args = _mariadb_user_create(
918             user,
919             host,
920             password,
921             password_hash,
922             allow_passwordless,
923             unix_socket,
924             password_column=password_column,
925             auth_plugin=auth_plugin,
926             **connection_args
927         )
928     else:
929         qry, args = _mysql_user_create(
930             user,
931             host,
932             password,
933             password_hash,
934             allow_passwordless,
935             unix_socket,
936             password_column=password_column,
937             auth_plugin=auth_plugin,
938             **connection_args
939         )
940     if isinstance(qry, bool):
941         return qry
942     try:
943         _execute(cur, qry, args)
944     except MySQLdb.OperationalError as exc:
945         err = "MySQL Error {}: {}".format(*exc.args)
946         __context__["mysql.error"] = err
947         log.error(err)
948         return False
949     if user_exists(
950         user,
951         host,
952         password,
953         password_hash,
954         password_column=password_column,
955         **connection_args
956     ):
957         msg = "User '{}'@'{}' has been created".format(user, host)
958         if not any((password, password_hash)):
959             msg += " with passwordless login"
960         log.info(msg)
961         return True
962     log.info("User '%s'@'%s' was not created", user, host)
963     return False
964 def _mysql_user_chpass(
965     user,
966     host="localhost",
967     password=None,
968     password_hash=None,
969     allow_passwordless=False,
970     unix_socket=None,
971     password_column=None,
972     auth_plugin="mysql_native_password",
973     **connection_args
974 ):
975     server_version = salt.utils.data.decode(version(**connection_args))
976     compare_version = "8.0.11"
977     args = {}
978     if password is not None:
979         if salt.utils.versions.version_cmp(server_version, compare_version) &gt;= 0:
980             password_sql = "%(password)s"
981         else:
982             password_sql = "PASSWORD(%(password)s)"
983         args["password"] = password
984     elif password_hash is not None:
985         password_sql = "%(password)s"
986         args["password"] = password_hash
987     elif not salt.utils.data.is_true(allow_passwordless):
988         log.error(
989             "password or password_hash must be specified, unless "
990             "allow_passwordless=True"
991         )
992         return False
993     else:
994         password_sql = "''"
995     args["user"] = user
996     args["host"] = host
997     if salt.utils.versions.version_cmp(server_version, compare_version) &gt;= 0:
998         args["auth_plugin"] = auth_plugin
999         qry = "ALTER USER %(user)s@%(host)s IDENTIFIED WITH %(auth_plugin)s "
1000         if password is not None:
1001             qry += "BY %(password)s;"
1002         elif password_hash is not None:
1003             qry += "AS %(password)s;"
1004     else:
1005         qry = (
1006             "UPDATE mysql.user SET "
1007             + password_column
1008             + "="
1009             + password_sql
1010             + " WHERE User=%(user)s AND Host = %(host)s;"
1011         )
1012     if salt.utils.data.is_true(allow_passwordless) and salt.utils.data.is_true(
1013         unix_socket
1014     ):
1015         if host == "localhost":
1016             if not plugin_status("auth_socket", **connection_args):
1017                 err = "The auth_socket plugin is not enabled."
1018                 log.error(err)
1019                 __context__["mysql.error"] = err
1020                 qry = False
1021             else:
1022                 args["unix_socket"] = "auth_socket"
1023                 if (
1024                     salt.utils.versions.version_cmp(server_version, compare_version)
1025                     &gt;= 0
1026                 ):
1027                     qry = (
1028                         "ALTER USER %(user)s@%(host)s IDENTIFIED WITH %(unix_socket)s"
1029                         " AS %(user)s;"
1030                     )
1031                 else:
1032                     qry = (
1033                         "UPDATE mysql.user SET "
1034                         + password_column
1035                         + "="
1036                         + password_sql
1037                         + ", plugin=%(unix_socket)s"
1038                         + " WHERE User=%(user)s AND Host = %(host)s;"
1039                     )
1040         else:
1041             log.error("Auth via unix_socket can be set only for host=localhost")
1042     return qry, args
1043 def _mariadb_user_chpass(
1044     user,
1045     host="localhost",
1046     password=None,
1047     password_hash=None,
1048     allow_passwordless=False,
1049     unix_socket=None,
1050     password_column=None,
1051     auth_plugin="mysql_native_password",
1052     **connection_args
1053 ):
1054     server_version = salt.utils.data.decode(version(**connection_args))
1055     compare_version = "10.4"
1056     args = {}
1057     if password is not None:
1058         password_sql = "PASSWORD(%(password)s)"
1059         args["password"] = password
1060     elif password_hash is not None:
1061         password_sql = "%(password)s"
1062         args["password"] = password_hash
1063     elif not salt.utils.data.is_true(allow_passwordless):
1064         log.error(
1065             "password or password_hash must be specified, unless "
1066             "allow_passwordless=True"
1067         )
1068         return False
1069     else:
1070         password_sql = "''"
1071     args["user"] = user
1072     args["host"] = host
1073     if salt.utils.versions.version_cmp(server_version, compare_version) &gt;= 0:
1074         args["auth_plugin"] = auth_plugin
1075         qry = "ALTER USER %(user)s@%(host)s IDENTIFIED VIA %(auth_plugin)s USING "
1076         qry += password_sql
1077     else:
1078         qry = (
1079             "UPDATE mysql.user SET "
1080             + password_column
1081             + "="
1082             + password_sql
1083             + " WHERE User=%(user)s AND Host = %(host)s;"
1084         )
1085     if salt.utils.data.is_true(allow_passwordless) and salt.utils.data.is_true(
1086         unix_socket
1087     ):
1088         if host == "localhost":
1089             if not plugin_status("unix_socket", **connection_args):
1090                 err = "The unix_socket plugin is not enabled."
1091                 log.error(err)
1092                 __context__["mysql.error"] = err
1093                 qry = False
1094             else:
1095                 args["unix_socket"] = "unix_socket"
1096                 qry = (
1097                     "UPDATE mysql.user SET "
1098                     + password_column
1099                     + "="
1100                     + password_sql
1101                     + ", plugin=%(unix_socket)s"
1102                     + " WHERE User=%(user)s AND Host = %(host)s;"
1103                 )
1104         else:
1105             log.error("Auth via unix_socket can be set only for host=localhost")
1106     return qry, args
1107 def user_chpass(
1108     user,
1109     host="localhost",
1110     password=None,
1111     password_hash=None,
1112     allow_passwordless=False,
1113     unix_socket=None,
1114     password_column=None,
1115     **connection_args
1116 ):
1117     """
1118     Change password for a MySQL user
1119     host
1120         Host for which this user/password combo applies
1121     password
1122         The password to set for the new user. Will take precedence over the
1123         ``password_hash`` option if both are specified.
1124     password_hash
1125         The password in hashed form. Be sure to quote the password because YAML
1126         doesn't like the ``*``. A password hash can be obtained from the mysql
1127         command-line client like so::
1128             mysql&gt; SELECT PASSWORD('mypass');
1129             +-------------------------------------------+
1130             | PASSWORD('mypass')                        |
1131             +-------------------------------------------+
1132             | *6C8989366EAF75BB670AD8EA7A7FC1176A95CEF4 |
1133             +-------------------------------------------+
1134             1 row in set (0.00 sec)
1135     allow_passwordless
1136         If ``True``, then ``password`` and ``password_hash`` can be omitted (or
1137         set to ``None``) to permit a passwordless login.
1138     .. versionadded:: 0.16.2
1139         The ``allow_passwordless`` option was added.
1140     CLI Examples:
1141     .. code-block:: bash
1142         salt '*' mysql.user_chpass frank localhost newpassword
1143         salt '*' mysql.user_chpass frank localhost password_hash='hash'
1144         salt '*' mysql.user_chpass frank localhost allow_passwordless=True
1145     """
1146     server_version = salt.utils.data.decode(version(**connection_args))
1147     if not server_version and password:
1148         __context__["mysql.error"] = None
1149         connection_args["connection_pass"] = password
1150         server_version = salt.utils.data.decode(version(**connection_args))
1151         if not server_version:
1152             last_err = __context__["mysql.error"]
1153             err = (
1154                 "MySQL Error: Unable to fetch current server version. Last error was:"
1155                 ' "{}"'.format(last_err)
1156             )
1157             log.error(err)
1158             return False
1159     if not user_exists(user, host, **connection_args):
1160         log.info("User '%s'@'%s' does not exists", user, host)
1161         return False
1162     dbc = _connect(**connection_args)
1163     if dbc is None:
1164         return False
1165     if not password_column:
1166         password_column = __password_column(**connection_args)
1167     auth_plugin = __get_auth_plugin(user, host, **connection_args)
1168     cur = dbc.cursor()
1169     if "MariaDB" in server_version:
1170         qry, args = _mariadb_user_chpass(
1171             user,
1172             host,
1173             password,
1174             password_hash,
1175             allow_passwordless,
1176             unix_socket,
1177             password_column=password_column,
1178             auth_plugin=auth_plugin,
1179             **connection_args
1180         )
1181     else:
1182         qry, args = _mysql_user_chpass(
1183             user,
1184             host,
1185             password,
1186             password_hash,
1187             allow_passwordless,
1188             unix_socket,
1189             password_column=password_column,
1190             auth_plugin=auth_plugin,
1191             **connection_args
1192         )
1193     try:
1194         result = _execute(cur, qry, args)
1195     except MySQLdb.OperationalError as exc:
1196         err = "MySQL Error {}: {}".format(*exc.args)
1197         __context__["mysql.error"] = err
1198         log.error(err)
1199         return False
1200     compare_version = "10.4.0" if "MariaDB" in server_version else "8.0.11"
1201     res = False
1202     if salt.utils.versions.version_cmp(server_version, compare_version) &gt;= 0:
1203         _execute(cur, "FLUSH PRIVILEGES;")
1204         res = True
1205     else:
1206         if result:
1207             _execute(cur, "FLUSH PRIVILEGES;")
1208             res = True
1209     if res:
1210         log.info(
1211             "Password for user '%s'@'%s' has been %s",
1212             user,
1213             host,
1214             "changed" if any((password, password_hash)) else "cleared",
1215         )
1216         return True
1217     else:
1218         log.info(
1219             "Password for user '%s'@'%s' was not %s",
1220             user,
1221             host,
1222             "changed" if any((password, password_hash)) else "cleared",
1223         )
1224         return False
1225 def user_remove(user, host="localhost", **connection_args):
1226     """
1227     Delete MySQL user
1228     CLI Example:
1229     .. code-block:: bash
1230         salt '*' mysql.user_remove frank localhost
1231     """
1232     if not user_exists(user, host, **connection_args):
1233         err = "User '%s'@'%s' does not exists", user, host
1234         __context__["mysql.error"] = err
1235         log.info(err)
1236         return False
1237     dbc = _connect(**connection_args)
1238     if dbc is None:
1239         return False
1240     cur = dbc.cursor()
1241     qry = "DROP USER %(user)s@%(host)s"
1242     args = {}
1243     args["user"] = user
1244     args["host"] = host
1245     try:
1246         _execute(cur, qry, args)
1247     except MySQLdb.OperationalError as exc:
1248         err = "MySQL Error {}: {}".format(*exc.args)
1249         __context__["mysql.error"] = err
1250         log.error(err)
1251         return False
1252     if not user_exists(user, host, **connection_args):
1253         log.info("User '%s'@'%s' has been removed", user, host)
1254         return True
1255     log.info("User '%s'@'%s' has NOT been removed", user, host)
1256     return False
1257 def tokenize_grant(grant):
1258     """
1259     External wrapper function
1260     :param grant:
1261     :return: dict
1262     CLI Example:
1263     .. code-block:: bash
1264         salt '*' mysql.tokenize_grant \
1265             "GRANT SELECT, INSERT ON testdb.* TO 'testuser'@'localhost'"
1266     """
1267     return _grant_to_tokens(grant)
1268 def db_check(name, table=None, **connection_args):
1269     """
1270     Repairs the full database or just a given table
1271     CLI Example:
1272     .. code-block:: bash
1273         salt '*' mysql.db_check dbname
1274         salt '*' mysql.db_check dbname dbtable
1275     """
1276     ret = []
1277     if table is None:
1278         tables = db_tables(name, **connection_args)
1279         for table in tables:
1280             log.info("Checking table '%s' in db '%s'..", name, table)
1281             ret.append(__check_table(name, table, **connection_args))
1282     else:
1283         log.info("Checking table '%s' in db '%s'..", name, table)
1284         ret = __check_table(name, table, **connection_args)
1285     return ret
1286 def db_repair(name, table=None, **connection_args):
1287     """
1288     Repairs the full database or just a given table
1289     CLI Example:
1290     .. code-block:: bash
1291         salt '*' mysql.db_repair dbname
1292     """
1293     ret = []
1294     if table is None:
1295         tables = db_tables(name, **connection_args)
1296         for table in tables:
1297             log.info("Repairing table '%s' in db '%s'..", name, table)
1298             ret.append(__repair_table(name, table, **connection_args))
1299     else:
1300         log.info("Repairing table '%s' in db '%s'..", name, table)
1301         ret = __repair_table(name, table, **connection_args)
1302     return ret
1303 def db_optimize(name, table=None, **connection_args):
1304     """
1305     Optimizes the full database or just a given table
1306     CLI Example:
1307     .. code-block:: bash
1308         salt '*' mysql.db_optimize dbname
1309     """
1310     ret = []
1311     if table is None:
1312         tables = db_tables(name, **connection_args)
1313         for table in tables:
1314             log.info("Optimizing table '%s' in db '%s'..", name, table)
1315             ret.append(__optimize_table(name, table, **connection_args))
1316     else:
1317         log.info("Optimizing table '%s' in db '%s'..", name, table)
1318         ret = __optimize_table(name, table, **connection_args)
1319     return ret
1320 def __grant_normalize(grant):
1321     if grant.strip().upper() == "ALL":
1322         grant = "ALL PRIVILEGES"
1323     exploded_grants = __grant_split(grant)
1324     for chkgrant, _ in exploded_grants:
1325         if chkgrant.strip().upper() not in __grants__:
1326             raise Exception("Invalid grant : '{}'".format(chkgrant))
1327     return grant
1328 def __grant_split(grant):
1329     pattern = re.compile(r"([\w\s]+)(\([^)(]*\))?\s*,?")
1330     return pattern.findall(grant)
1331 def __ssl_option_sanitize(ssl_option):
1332     new_ssl_option = []
1333     for opt in ssl_option:
1334         key = next(iter(opt.keys()))
1335         normal_key = key.strip().upper()
1336         if normal_key not in __ssl_options__:
1337             raise Exception("Invalid SSL option : '{}'".format(key))
1338         if normal_key in __ssl_options_parameterized__:
1339             new_ssl_option.append(
1340                 "{} '{}'".format(normal_key, opt[key].replace("'", ""))
1341             )
1342         elif opt[key]:
1343             new_ssl_option.append(normal_key)
1344     return " REQUIRE " + " AND ".join(new_ssl_option)
1345 def __grant_generate(
1346     grant,
1347     database,
1348     user,
1349     host="localhost",
1350     grant_option=False,
1351     escape=True,
1352     ssl_option=False,
1353 ):
1354     """
1355     Validate grants and build the query that could set the given grants
1356     Note that this query contains arguments for user and host but not for
1357     grants or database.
1358     """
1359     grant = re.sub(r"\s*,\s*", ", ", grant).upper()
1360     grant = __grant_normalize(grant)
1361     db_part = database.rpartition(".")
1362     dbc = db_part[0]
1363     table = db_part[2]
1364     if escape:
1365         if dbc != "*":
1366             dbc = quote_identifier(dbc, for_grants=(table == "*"))
1367         if table != "*":
1368             table = quote_identifier(table)
1369     qry = "GRANT {} ON {}.{} TO %(user)s@%(host)s".format(grant, dbc, table)
1370     args = {}
1371     args["user"] = user
1372     args["host"] = host
1373     if ssl_option and isinstance(ssl_option, list):
1374         qry += __ssl_option_sanitize(ssl_option)
1375     if salt.utils.data.is_true(grant_option):
1376         qry += " WITH GRANT OPTION"
1377     log.debug("Grant Query generated: %s args %s", qry, repr(args))
1378     return {"qry": qry, "args": args}
1379 def user_grants(user, host="localhost", **connection_args):
1380     """
1381     Shows the grants for the given MySQL user (if it exists)
1382     CLI Example:
1383     .. code-block:: bash
1384         salt '*' mysql.user_grants 'frank' 'localhost'
1385     """
1386     if not user_exists(user, host, **connection_args):
1387         log.info("User '%s'@'%s' does not exist", user, host)
1388         return False
1389     dbc = _connect(**connection_args)
1390     if dbc is None:
1391         return False
1392     cur = dbc.cursor()
1393     qry = "SHOW GRANTS FOR %(user)s@%(host)s"
1394     args = {}
1395     args["user"] = user
1396     args["host"] = host
1397     try:
1398         _execute(cur, qry, args)
1399     except MySQLdb.OperationalError as exc:
1400         err = "MySQL Error {}: {}".format(*exc.args)
1401         __context__["mysql.error"] = err
1402         log.error(err)
1403         return False
1404     ret = []
1405     results = salt.utils.data.decode(cur.fetchall())
1406     for grant in results:
1407         tmp = grant[0].split(" IDENTIFIED BY")[0]
1408         if "WITH GRANT OPTION" in grant[0] and "WITH GRANT OPTION" not in tmp:
1409             tmp = "{} WITH GRANT OPTION".format(tmp)
1410         ret.append(tmp)
1411     log.debug(ret)
1412     return ret
1413 def grant_exists(
1414     grant,
1415     database,
1416     user,
1417     host="localhost",
1418     grant_option=False,
1419     escape=True,
1420     **connection_args
1421 ):
1422     """
1423     Checks to see if a grant exists in the database
1424     CLI Example:
1425     .. code-block:: bash
1426         salt '*' mysql.grant_exists \
1427              'SELECT,INSERT,UPDATE,...' 'database.*' 'frank' 'localhost'
1428     """
1429     server_version = salt.utils.data.decode(version(**connection_args))
1430     if not server_version:
1431         last_err = __context__["mysql.error"]
1432         err = 'MySQL Error: Unable to fetch current server version. Last error was: "{}"'.format(
1433             last_err
1434         )
1435         log.error(err)
1436         return False
1437     if "ALL" in grant.upper():
1438         if (
1439             salt.utils.versions.version_cmp(server_version, "8.0") &gt;= 0
1440             and "MariaDB" not in server_version
1441             and database == "*.*"
1442         ):
1443             grant = ",".join([i for i in __all_privileges__])
1444         else:
1445             grant = "ALL PRIVILEGES"
1446     try:
1447         target = __grant_generate(grant, database, user, host, grant_option, escape)
1448     except Exception:  # pylint: disable=broad-except
1449         log.error("Error during grant generation.")
1450         return False
1451     grants = user_grants(user, host, **connection_args)
1452     if grants is False:
1453         log.error(
1454             "Grant does not exist or may not be ordered properly. In some cases, "
1455             "this could also indicate a connection error. Check your configuration."
1456         )
1457         return False
1458     _grants = {}
1459     for grant in grants:
1460         grant_token = _grant_to_tokens(grant)
1461         if grant_token["database"] not in _grants:
1462             _grants[grant_token["database"]] = {
1463                 "user": grant_token["user"],
1464                 "database": grant_token["database"],
1465                 "host": grant_token["host"],
1466                 "grant": grant_token["grant"],
1467             }
1468         else:
1469             _grants[grant_token["database"]]["grant"].extend(grant_token["grant"])
1470     target_tokens = _grant_to_tokens(target)
1471     for database, grant_tokens in _grants.items():
1472         try:
1473             _grant_tokens = {}
1474             _target_tokens = {}
1475             _grant_matches = [
1476                 True if i in grant_tokens["grant"] else False
1477                 for i in target_tokens["grant"]
1478             ]
1479             for item in ["user", "database", "host"]:
1480                 _grant_tokens[item] = (
1481                     grant_tokens[item]
1482                     .replace('"', "")
1483                     .replace("\\", "")
1484                     .replace("`", "")
1485                 )
1486                 _target_tokens[item] = (
1487                     target_tokens[item]
1488                     .replace('"', "")
1489                     .replace("\\", "")
1490                     .replace("`", "")
1491                 )
1492             if (
1493                 _grant_tokens["user"] == _target_tokens["user"]
1494                 and _grant_tokens["database"] == _target_tokens["database"]
1495                 and _grant_tokens["host"] == _target_tokens["host"]
1496                 and all(_grant_matches)
1497             ):
1498                 return True
1499             else:
1500                 log.debug("grants mismatch '%s'&lt;&gt;'%s'", grant_tokens, target_tokens)
1501         except Exception as exc:  # pylint: disable=broad-except
1502             log.exception(exc)
1503             if grants is not False and target in grants:
1504                 log.debug("Grant exists.")
1505                 return True
1506     log.debug("Grant does not exist, or is perhaps not ordered properly?")
1507     return False
1508 def grant_add(
1509     grant,
1510     database,
1511     user,
1512     host="localhost",
1513     grant_option=False,
1514     escape=True,
1515     ssl_option=False,
1516     **connection_args
1517 ):
1518     """
1519     Adds a grant to the MySQL server.
1520     For database, make sure you specify database.table or database.*
1521     CLI Example:
1522     .. code-block:: bash
1523         salt '*' mysql.grant_add \
1524             'SELECT,INSERT,UPDATE,...' 'database.*' 'frank' 'localhost'
1525     """
1526     dbc = _connect(**connection_args)
1527     if dbc is None:
1528         return False
1529     cur = dbc.cursor()
1530     grant = grant.strip()
1531     try:
1532         qry = __grant_generate(
1533             grant, database, user, host, grant_option, escape, ssl_option
1534         )
1535     except Exception:  # pylint: disable=broad-except
1536         log.error("Error during grant generation")
1537         return False
1538     try:
1539         _execute(cur, qry["qry"], qry["args"])
1540     except (MySQLdb.OperationalError, MySQLdb.ProgrammingError) as exc:
1541         err = "MySQL Error {}: {}".format(*exc.args)
1542         __context__["mysql.error"] = err
1543         log.error(err)
1544         return False
1545     if grant_exists(
1546         grant, database, user, host, grant_option, escape, **connection_args
1547     ):
1548         log.info(
1549             "Grant '%s' on '%s' for user '%s' has been added", grant, database, user
1550         )
1551         return True
1552     log.info(
1553         "Grant '%s' on '%s' for user '%s' has NOT been added", grant, database, user
1554     )
1555     return False
1556 def grant_revoke(
1557     grant,
1558     database,
1559     user,
1560     host="localhost",
1561     grant_option=False,
1562     escape=True,
1563     **connection_args
1564 ):
1565     """
1566     Removes a grant from the MySQL server.
1567     CLI Example:
1568     .. code-block:: bash
1569         salt '*' mysql.grant_revoke \
1570             'SELECT,INSERT,UPDATE' 'database.*' 'frank' 'localhost'
1571     """
1572     dbc = _connect(**connection_args)
1573     if dbc is None:
1574         return False
1575     cur = dbc.cursor()
1576     grant = __grant_normalize(grant)
1577     if salt.utils.data.is_true(grant_option):
1578         grant += ", GRANT OPTION"
1579     db_part = database.rpartition(".")
1580     dbc = db_part[0]
1581     table = db_part[2]
1582     if dbc != "*":
1583         s_database = quote_identifier(dbc, for_grants=(table == "*"))
1584     if dbc == "*":
1585         s_database = dbc
1586     if table != "*":
1587         table = quote_identifier(table)
1588     qry = "REVOKE {} ON {}.{} FROM %(user)s@%(host)s;".format(grant, s_database, table)
1589     args = {}
1590     args["user"] = user
1591     args["host"] = host
1592     try:
1593         _execute(cur, qry, args)
1594     except MySQLdb.OperationalError as exc:
1595         err = "MySQL Error {}: {}".format(*exc.args)
1596         __context__["mysql.error"] = err
1597         log.error(err)
1598         return False
1599     if not grant_exists(
1600         grant, database, user, host, grant_option, escape, **connection_args
1601     ):
1602         log.info(
1603             "Grant '%s' on '%s' for user '%s' has been revoked",
1604             grant,
1605             database,
1606             user,
1607         )
1608         return True
1609     log.info(
1610         "Grant '%s' on '%s' for user '%s' has NOT been revoked",
1611         grant,
1612         database,
1613         user,
1614     )
1615     return False
1616 def processlist(**connection_args):
1617     """
1618     Retrieves the processlist from the MySQL server via
1619     "SHOW FULL PROCESSLIST".
1620     Returns: a list of dicts, with each dict representing a process:
1621     .. code-block:: python
1622         {'Command': 'Query',
1623         'Host': 'localhost',
1624         'Id': 39,
1625         'Info': 'SHOW FULL PROCESSLIST',
1626         'Rows_examined': 0,
1627         'Rows_read': 1,
1628         'Rows_sent': 0,
1629         'State': None,
1630         'Time': 0,
1631         'User': 'root',
1632         'db': 'mysql'}
1633     CLI Example:
1634     .. code-block:: bash
1635         salt '*' mysql.processlist
1636     """
1637     ret = []
1638     dbc = _connect(**connection_args)
1639     if dbc is None:
1640         return []
1641     cur = dbc.cursor()
1642     _execute(cur, "SHOW FULL PROCESSLIST")
1643     hdr = [c[0] for c in cur.description]
1644     for _ in range(cur.rowcount):
1645         row = cur.fetchone()
1646         idx_r = {}
1647         for idx_j, value_j in enumerate(hdr):
1648             idx_r[hdr[idx_j]] = row[idx_j]
1649         ret.append(idx_r)
1650     cur.close()
1651     return ret
1652 def __do_query_into_hash(conn, sql_str):
1653     """
1654     Perform the query that is passed to it (sql_str).
1655     Returns:
1656        results in a dict.
1657     """
1658     mod = sys._getframe().f_code.co_name
1659     log.debug("%s&lt;--(%s)", mod, sql_str)
1660     rtn_results = []
1661     try:
1662         cursor = conn.cursor()
1663     except MySQLdb.MySQLError:
1664         log.error("%s: Can't get cursor for SQL-&gt;%s", mod, sql_str)
1665         cursor.close()
1666         log.debug("%s--&gt;", mod)
1667         return rtn_results
1668     try:
1669         _execute(cursor, sql_str)
1670     except MySQLdb.MySQLError:
1671         log.error("%s: try to execute : SQL-&gt;%s", mod, sql_str)
1672         cursor.close()
1673         log.debug("%s--&gt;", mod)
1674         return rtn_results
1675     qrs = cursor.fetchall()
1676     for row_data in qrs:
1677         col_cnt = 0
1678         row = {}
1679         for col_data in cursor.description:
1680             col_name = col_data[0]
1681             row[col_name] = row_data[col_cnt]
1682             col_cnt += 1
1683         rtn_results.append(row)
1684     cursor.close()
1685     log.debug("%s--&gt;", mod)
1686     return rtn_results
1687 def get_master_status(**connection_args):
1688     """
1689     Retrieves the master status from the minion.
1690     Returns::
1691         {'host.domain.com': {'Binlog_Do_DB': '',
1692                          'Binlog_Ignore_DB': '',
1693                          'File': 'mysql-bin.000021',
1694                          'Position': 107}}
1695     CLI Example:
1696     .. code-block:: bash
1697         salt '*' mysql.get_master_status
1698     """
1699     mod = sys._getframe().f_code.co_name
1700     log.debug("%s&lt;--", mod)
1701     conn = _connect(**connection_args)
1702     if conn is None:
1703         return []
1704     rtnv = __do_query_into_hash(conn, "SHOW MASTER STATUS")
1705     conn.close()
1706     if not rtnv:
1707         rtnv.append([])
1708     log.debug("%s--&gt;%s", mod, len(rtnv[0]))
1709     return rtnv[0]
1710 def get_slave_status(**connection_args):
1711     """
1712     Retrieves the slave status from the minion.
1713     Returns::
1714         {'host.domain.com': {'Connect_Retry': 60,
1715                        'Exec_Master_Log_Pos': 107,
1716                        'Last_Errno': 0,
1717                        'Last_Error': '',
1718                        'Last_IO_Errno': 0,
1719                        'Last_IO_Error': '',
1720                        'Last_SQL_Errno': 0,
1721                        'Last_SQL_Error': '',
1722                        'Master_Host': 'comet.scion-eng.com',
1723                        'Master_Log_File': 'mysql-bin.000021',
1724                        'Master_Port': 3306,
1725                        'Master_SSL_Allowed': 'No',
1726                        'Master_SSL_CA_File': '',
1727                        'Master_SSL_CA_Path': '',
1728                        'Master_SSL_Cert': '',
1729                        'Master_SSL_Cipher': '',
1730                        'Master_SSL_Key': '',
1731                        'Master_SSL_Verify_Server_Cert': 'No',
1732                        'Master_Server_Id': 1,
1733                        'Master_User': 'replu',
1734                        'Read_Master_Log_Pos': 107,
1735                        'Relay_Log_File': 'klo-relay-bin.000071',
1736                        'Relay_Log_Pos': 253,
1737                        'Relay_Log_Space': 553,
1738                        'Relay_Master_Log_File': 'mysql-bin.000021',
1739                        'Replicate_Do_DB': '',
1740                        'Replicate_Do_Table': '',
1741                        'Replicate_Ignore_DB': '',
1742                        'Replicate_Ignore_Server_Ids': '',
1743                        'Replicate_Ignore_Table': '',
1744                        'Replicate_Wild_Do_Table': '',
1745                        'Replicate_Wild_Ignore_Table': '',
1746                        'Seconds_Behind_Master': 0,
1747                        'Skip_Counter': 0,
1748                        'Slave_IO_Running': 'Yes',
1749                        'Slave_IO_State': 'Waiting for master to send event',
1750                        'Slave_SQL_Running': 'Yes',
1751                        'Until_Condition': 'None',
1752                        'Until_Log_File': '',
1753                        'Until_Log_Pos': 0}}
1754     CLI Example:
1755     .. code-block:: bash
1756         salt '*' mysql.get_slave_status
1757     """
1758     mod = sys._getframe().f_code.co_name
1759     log.debug("%s&lt;--", mod)
1760     conn = _connect(**connection_args)
1761     if conn is None:
1762         return []
1763     rtnv = __do_query_into_hash(conn, "SHOW SLAVE STATUS")
1764     conn.close()
1765     if not rtnv:
1766         rtnv.append([])
1767     log.debug("%s--&gt;%s", mod, len(rtnv[0]))
1768     return rtnv[0]
1769 def showvariables(**connection_args):
1770     """
1771     Retrieves the show variables from the minion.
1772     Returns::
1773         show variables full dict
1774     CLI Example:
1775     .. code-block:: bash
1776         salt '*' mysql.showvariables
1777     """
1778     mod = sys._getframe().f_code.co_name
1779     log.debug("%s&lt;--", mod)
1780     conn = _connect(**connection_args)
1781     if conn is None:
1782         return []
1783     rtnv = __do_query_into_hash(conn, "SHOW VARIABLES")
1784     conn.close()
1785     if not rtnv:
1786         rtnv.append([])
1787     log.debug("%s--&gt;%s", mod, len(rtnv[0]))
1788     return rtnv
1789 def showglobal(**connection_args):
1790     """
1791     Retrieves the show global variables from the minion.
1792     Returns::
1793         show global variables full dict
1794     CLI Example:
1795     .. code-block:: bash
1796         salt '*' mysql.showglobal
1797     """
1798     mod = sys._getframe().f_code.co_name
1799     log.debug("%s&lt;--", mod)
1800     conn = _connect(**connection_args)
1801     if conn is None:
1802         return []
1803     rtnv = __do_query_into_hash(conn, "SHOW GLOBAL VARIABLES")
1804     conn.close()
1805     if not rtnv:
1806         rtnv.append([])
1807     log.debug("%s--&gt;%s", mod, len(rtnv[0]))
1808     return rtnv
1809 def verify_login(user, password=None, **connection_args):
1810     """
1811     Attempt to login using the provided credentials.
1812     If successful, return true.  Otherwise, return False.
1813     CLI Example:
1814     .. code-block:: bash
1815         salt '*' mysql.verify_login root password
1816     """
1817     connection_args["connection_user"] = user
1818     connection_args["connection_pass"] = password
1819     dbc = _connect(**connection_args)
1820     if dbc is None:
1821         if "mysql.error" in __context__:
1822             del __context__["mysql.error"]
1823         return False
1824     return True
1825 def plugins_list(**connection_args):
1826     """
1827     Return a list of plugins and their status
1828     from the ``SHOW PLUGINS`` query.
1829     CLI Example:
1830     .. code-block:: bash
1831         salt '*' mysql.plugins_list
1832     """
1833     dbc = _connect(**connection_args)
1834     if dbc is None:
1835         return []
1836     cur = dbc.cursor()
1837     qry = "SHOW PLUGINS"
1838     try:
1839         _execute(cur, qry)
1840     except MySQLdb.OperationalError as exc:
1841         err = "MySQL Error {}: {}".format(*exc.args)
1842         __context__["mysql.error"] = err
1843         log.error(err)
1844         return []
1845     ret = []
1846     results = cur.fetchall()
1847     for dbs in results:
1848         ret.append({"name": dbs[0], "status": dbs[1]})
1849     log.debug(ret)
1850     return ret
1851 def plugin_add(name, soname=None, **connection_args):
1852     """
1853     Add a plugina.
1854     CLI Example:
1855     .. code-block:: bash
1856         salt '*' mysql.plugin_add auth_socket
1857     """
1858     if not name:
1859         log.error("Plugin name is required.")
1860         return False
1861     if plugin_status(name, **connection_args):
1862         log.error("Plugin %s is already installed.", name)
1863         return True
1864     dbc = _connect(**connection_args)
1865     if dbc is None:
1866         return False
1867     cur = dbc.cursor()
1868     qry = "INSTALL PLUGIN {}".format(name)
1869     if soname:
1870         qry += ' SONAME "{}"'.format(soname)
1871     else:
1872         qry += ' SONAME "{}.so"'.format(name)
1873     try:
1874         _execute(cur, qry)
1875     except MySQLdb.OperationalError as exc:
1876         err = "MySQL Error {}: {}".format(*exc.args)
1877         __context__["mysql.error"] = err
1878         log.error(err)
1879         return False
1880     return True
1881 def plugin_remove(name, **connection_args):
1882     """
1883     Remove a plugin.
1884     CLI Example:
1885     .. code-block:: bash
1886         salt '*' mysql.plugin_remove auth_socket
1887     """
1888     if not name:
1889         log.error("Plugin name is required.")
1890         return False
1891     if not plugin_status(name, **connection_args):
1892         log.error("Plugin %s is not installed.", name)
1893         return True
1894     dbc = _connect(**connection_args)
1895     if dbc is None:
1896         return False
1897     cur = dbc.cursor()
1898     qry = "UNINSTALL PLUGIN {}".format(name)
1899     args = {}
1900     args["name"] = name
1901     try:
1902         _execute(cur, qry)
1903     except MySQLdb.OperationalError as exc:
1904         err = "MySQL Error {}: {}".format(*exc.args)
1905         __context__["mysql.error"] = err
1906         log.error(err)
1907         return False
1908     return True
1909 def plugin_status(name, **connection_args):
1910     """
1911     Return the status of a plugin.
1912     CLI Example:
1913     .. code-block:: bash
1914         salt '*' mysql.plugin_status auth_socket
1915     """
1916     if not name:
1917         log.error("Plugin name is required.")
1918         return False
1919     dbc = _connect(**connection_args)
1920     if dbc is None:
1921         return ""
1922     cur = dbc.cursor()
1923     qry = (
1924         "SELECT PLUGIN_STATUS FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME ="
1925         " %(name)s"
1926     )
1927     args = {}
1928     args["name"] = name
1929     try:
1930         _execute(cur, qry, args)
1931     except MySQLdb.OperationalError as exc:
1932         err = "MySQL Error {}: {}".format(*exc.args)
1933         __context__["mysql.error"] = err
1934         log.error(err)
1935         return ""
1936     try:
1937         status = cur.fetchone()
1938         if status is None:
1939             return ""
1940         else:
1941             return status[0]
1942     except IndexError:
1943         return ""
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
