<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_dig.py & test_pkgng_1.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_dig.py & test_pkgng_1.py
      </h3>
      <h1 align="center">
        6.6%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_dig.py (25.66845%)<TH>test_pkgng_1.py (3.8125496%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match40519-0.html#0',2,'match40519-1.html#0',3)" NAME="0">(148-166)<TD><A HREF="javascript:ZweiFrames('match40519-0.html#0',2,'match40519-1.html#0',3)" NAME="0">(126-137)</A><TD ALIGN=center><FONT COLOR="#ff0000">12</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match40519-0.html#1',2,'match40519-1.html#1',3)" NAME="1">(122-126)<TD><A HREF="javascript:ZweiFrames('match40519-0.html#1',2,'match40519-1.html#1',3)" NAME="1">(342-352)</A><TD ALIGN=center><FONT COLOR="#ff0000">12</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match40519-0.html#2',2,'match40519-1.html#2',3)" NAME="2">(90-108)<TD><A HREF="javascript:ZweiFrames('match40519-0.html#2',2,'match40519-1.html#2',3)" NAME="2">(103-111)</A><TD ALIGN=center><FONT COLOR="#ff0000">12</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match40519-0.html#3',2,'match40519-1.html#3',3)" NAME="3">(68-86)<TD><A HREF="javascript:ZweiFrames('match40519-0.html#3',2,'match40519-1.html#3',3)" NAME="3">(952-966)</A><TD ALIGN=center><FONT COLOR="#ff0000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_dig.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Nicole Thomas &lt;nicole@saltstack.com&gt;
&quot;&quot;&quot;


import salt.modules.dig as dig
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import MagicMock, patch
from tests.support.unit import TestCase, skipIf

_SPF_VALUES = {
    &quot;dig +short xmission.com TXT&quot;: {
        &quot;pid&quot;: 27282,
        &quot;retcode&quot;: 0,
        &quot;stderr&quot;: &quot;&quot;,
        &quot;stdout&quot;: '&quot;v=spf1 a mx include:_spf.xmission.com ?all&quot;',
    },
    &quot;dig +short _spf.xmission.com TXT&quot;: {
        &quot;pid&quot;: 27282,
        &quot;retcode&quot;: 0,
        &quot;stderr&quot;: &quot;&quot;,
        &quot;stdout&quot;: '&quot;v=spf1 a mx ip4:198.60.22.0/24 ip4:166.70.13.0/24 ~all&quot;',
    },
    &quot;dig +short xmission-redirect.com TXT&quot;: {
        &quot;pid&quot;: 27282,
        &quot;retcode&quot;: 0,
        &quot;stderr&quot;: &quot;&quot;,
        &quot;stdout&quot;: &quot;v=spf1 redirect=_spf.xmission.com&quot;,
    },
    &quot;dig +short foo.com TXT&quot;: {
        &quot;pid&quot;: 27282,
        &quot;retcode&quot;: 0,
        &quot;stderr&quot;: &quot;&quot;,
        &quot;stdout&quot;: &quot;v=spf1 ip4:216.73.93.70/31 ip4:216.73.93.72/31 ~all&quot;,
    },
}


def _spf_side_effect(key, python_shell=False):
    return _SPF_VALUES.get(
        &quot; &quot;.join(key), {&quot;pid&quot;: 27310, &quot;retcode&quot;: 0, &quot;stderr&quot;: &quot;&quot;, &quot;stdout&quot;: &quot;&quot;}
    )


@skipIf(dig.__virtual__() is False, &quot;Dig must be installed&quot;)
class DigTestCase(TestCase, LoaderModuleMockMixin):
    def setup_loader_modules(self):
        return {dig: {}}

    def test_check_ip(self):
        self.assertTrue(dig.check_ip(&quot;127.0.0.1&quot;), msg=&quot;Not a valid ip address&quot;)

    def test_check_ip_ipv6(self):
        self.assertTrue(
            dig.check_ip(&quot;1111:2222:3333:4444:5555:6666:7777:8888&quot;),
            msg=&quot;Not a valid ip address&quot;,
        )

    def test_check_ip_ipv6_valid(self):
        self.assertTrue(dig.check_ip(&quot;2607:fa18:0:3::4&quot;))

    def test_check_ip_neg(self):
        self.assertFalse(
            dig.check_ip(&quot;-127.0.0.1&quot;), msg=&quot;Did not detect negative value as invalid&quot;
<A NAME="3"></A>        )

    def test_check_ip_empty(self):
        self.assertFalse(dig.check_ip(&quot;&quot;), msg<FONT color="#53858b"><A HREF="javascript:ZweiFrames('match40519-1.html#3',3,'match40519-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>=&quot;Did not detect empty value as invalid&quot;)

    def test_a(self):
        dig_mock = MagicMock(
            return_value={
                &quot;pid&quot;: 3656,
                &quot;retcode&quot;: 0,
                &quot;stderr&quot;: &quot;&quot;,
                &quot;stdout&quot;: (
                    &quot;74.125.193.104\n&quot;
                    &quot;74.125.193.105\n&quot;
                    &quot;74.125.193.99\n&quot;
                    &quot;74.125.193.106\n&quot;
                    &quot;74.125.193.103\n&quot;
                    &quot;74.125.193.147&quot;
                ),
            }
        )
        with patch.dict(dig.__salt__, {&quot;cmd.run_all&quot;</B></FONT>: dig_mock}):
<A NAME="2"></A>            self.assertEqual(
                dig.A(&quot;www.google.com&quot;),
                [
                    &quot;<FONT color="#980517"><A HREF="javascript:ZweiFrames('match40519-1.html#2',3,'match40519-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>74.125.193.104&quot;,
                    &quot;74.125.193.105&quot;,
                    &quot;74.125.193.99&quot;,
                    &quot;74.125.193.106&quot;,
                    &quot;74.125.193.103&quot;,
                    &quot;74.125.193.147&quot;,
                ],
            )

    def test_aaaa(self):
        dig_mock = MagicMock(
            return_value={
                &quot;pid&quot;: 25451,
                &quot;retcode&quot;: 0,
                &quot;stderr&quot;: &quot;&quot;,
                &quot;stdout&quot;: &quot;2607:f8b0:400f:801::1014&quot;,
            }
        )
        with patch.dict(dig.__salt__, {&quot;cmd.run_all&quot;</B></FONT>: dig_mock}):
            self.assertEqual(dig.AAAA(&quot;www.google.com&quot;), [&quot;2607:f8b0:400f:801::1014&quot;])

    def test_ns(self):
        with patch(&quot;salt.modules.dig.A&quot;, MagicMock(return_value=[&quot;ns4.google.com.&quot;])):
            dig_mock = MagicMock(
                return_value={
                    &quot;pid&quot;: 26136,
                    &quot;retcode&quot;: 0,
                    &quot;stderr&quot;: &quot;&quot;,
                    &quot;stdout&quot;: &quot;ns4.google.com.&quot;,
<A NAME="1"></A>                }
            )
            with patch.dict(dig.__salt__, {&quot;cmd.run_all&quot;: dig_mock}):
                self.assertEqual(dig.NS(<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match40519-1.html#1',3,'match40519-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>&quot;google.com&quot;), [&quot;ns4.google.com.&quot;])

    def test_spf(self):
        dig_mock = MagicMock(side_effect=_spf_side_effect)
        with patch.dict(dig.__salt__, {&quot;cmd.run_all&quot;</B></FONT>: dig_mock}):
            self.assertEqual(dig.SPF(&quot;foo.com&quot;), [&quot;216.73.93.70/31&quot;, &quot;216.73.93.72/31&quot;])

    def test_spf_redir(self):
        &quot;&quot;&quot;
        Test for SPF records which use the 'redirect' SPF mechanism
        https://en.wikipedia.org/wiki/Sender_Policy_Framework#Mechanisms
        &quot;&quot;&quot;
        dig_mock = MagicMock(side_effect=_spf_side_effect)
        with patch.dict(dig.__salt__, {&quot;cmd.run_all&quot;: dig_mock}):
            self.assertEqual(
                dig.SPF(&quot;xmission-redirect.com&quot;), [&quot;198.60.22.0/24&quot;, &quot;166.70.13.0/24&quot;]
            )

    def test_spf_include(self):
        &quot;&quot;&quot;
        Test for SPF records which use the 'include' SPF mechanism
        https://en.wikipedia.org/wiki/Sender_Policy_Framework#Mechanisms
        &quot;&quot;&quot;
<A NAME="0"></A>        dig_mock = MagicMock(side_effect=_spf_side_effect)
        with patch.dict(dig.__salt__, {&quot;cmd.run_all&quot;: dig_mock}):
            self.assertEqual(
                dig.SPF(&quot;xmission.com&quot;), [&quot;<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match40519-1.html#0',3,'match40519-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>198.60.22.0/24&quot;, &quot;166.70.13.0/24&quot;]
            )

    def test_mx(self):
        dig_mock = MagicMock(
            return_value={
                &quot;pid&quot;: 27780,
                &quot;retcode&quot;: 0,
                &quot;stderr&quot;: &quot;&quot;,
                &quot;stdout&quot;: (
                    &quot;10 aspmx.l.google.com.\n&quot;
                    &quot;20 alt1.aspmx.l.google.com.\n&quot;
                    &quot;40 alt3.aspmx.l.google.com.\n&quot;
                    &quot;50 alt4.aspmx.l.google.com.\n&quot;
                    &quot;30 alt2.aspmx.l.google.com.&quot;
                ),
            }
        )
        with patch.dict(dig.__salt__, {&quot;cmd.run_all&quot;</B></FONT>: dig_mock}):
            self.assertEqual(
                dig.MX(&quot;google.com&quot;),
                [
                    [&quot;10&quot;, &quot;aspmx.l.google.com.&quot;],
                    [&quot;20&quot;, &quot;alt1.aspmx.l.google.com.&quot;],
                    [&quot;40&quot;, &quot;alt3.aspmx.l.google.com.&quot;],
                    [&quot;50&quot;, &quot;alt4.aspmx.l.google.com.&quot;],
                    [&quot;30&quot;, &quot;alt2.aspmx.l.google.com.&quot;],
                ],
            )
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_pkgng_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
import textwrap

import pytest
import salt.modules.pkgng as pkgng
from salt.utils.odict import OrderedDict
from tests.support.mock import MagicMock, patch


@pytest.fixture
def configure_loader_modules():
    return {pkgng: {}}


@pytest.fixture
def pkgs():
    return [
        {&quot;openvpn&quot;: &quot;2.4.8_2&quot;},
        {&quot;openvpn&quot;: &quot;2.4.8_2&quot;, &quot;gettext-runtime&quot;: &quot;0.20.1&quot;, &quot;p5-Mojolicious&quot;: &quot;8.40&quot;},
    ]


def test_latest_version(pkgs):
    &quot;&quot;&quot;
    Test basic usage of pkgng.latest_version
    &quot;&quot;&quot;
    pkgs_mock = MagicMock(side_effect=pkgs)
    search_cmd = MagicMock(return_value=&quot;bash-5.1.4&quot;)
    with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
        with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: search_cmd}):
            result = pkgng.latest_version(&quot;bash&quot;)
            search_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;search&quot;, &quot;-eqS&quot;, &quot;name&quot;, &quot;-U&quot;, &quot;bash&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
            )
            assert result == &quot;5.1.4&quot;


def test_latest_version_origin(pkgs):
    &quot;&quot;&quot;
    Test pkgng.latest_version with a specific package origin
    &quot;&quot;&quot;
    pkgs_mock = MagicMock(side_effect=pkgs)
    search_cmd = MagicMock(return_value=&quot;bash-5.1.4_2&quot;)
    with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
        with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: search_cmd}):
            result = pkgng.latest_version(&quot;shells/bash&quot;)
            search_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;search&quot;, &quot;-eqS&quot;, &quot;origin&quot;, &quot;-U&quot;, &quot;shells/bash&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
            )
            assert result == &quot;5.1.4_2&quot;


def test_latest_version_outofdatedate(pkgs):
    &quot;&quot;&quot;
    Test pkgng.latest_version with an out-of-date package
    &quot;&quot;&quot;
    pkgs_mock = MagicMock(side_effect=pkgs)
    search_cmd = MagicMock(return_value=&quot;openvpn-2.4.8_3&quot;)
    with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
        with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: search_cmd}):
            result = pkgng.latest_version(&quot;openvpn&quot;)
            search_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;search&quot;, &quot;-eqS&quot;, &quot;name&quot;, &quot;-U&quot;, &quot;openvpn&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
            )
            assert result == &quot;2.4.8_3&quot;


def test_latest_version_unavailable(pkgs):
    &quot;&quot;&quot;
    Test pkgng.latest_version when the requested package is not available
    &quot;&quot;&quot;
    pkgs_mock = MagicMock(side_effect=pkgs)
    search_cmd = MagicMock(return_value=&quot;&quot;)
    with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
        with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: search_cmd}):
            result = pkgng.latest_version(&quot;does_not_exist&quot;)
            search_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;search&quot;, &quot;-eqS&quot;, &quot;name&quot;, &quot;-U&quot;, &quot;does_not_exist&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
            )


def test_latest_version_uptodate(pkgs):
    &quot;&quot;&quot;
    Test pkgng.latest_version with an up-to-date package
    &quot;&quot;&quot;
    pkgs_mock = MagicMock(side_effect=pkgs)
    search_cmd = MagicMock(return_value=&quot;openvpn-2.4.8_2&quot;)
    with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
        with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: search_cmd}):
            result = pkgng.latest_version(&quot;openvpn&quot;)
            search_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;search&quot;, &quot;-eqS&quot;, &quot;name&quot;, &quot;-U&quot;, &quot;openvpn&quot;],
<A NAME="2"></A>                output_loglevel=&quot;trace&quot;,
                python_shell=False,
            )
            as<FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match40519-0.html#2',2,'match40519-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>sert result == &quot;&quot;


def test_lock():
    &quot;&quot;&quot;
    Test pkgng.lock
    &quot;&quot;&quot;
    lock_cmd = MagicMock(return_value={&quot;stdout&quot;: &quot;pkga-1.0\npkgb-2.0\n&quot;, &quot;retcode&quot;: 0})
    with patch.dict(pkgng.__salt__, {&quot;cmd.run_all&quot;</B></FONT>: lock_cmd}):

        result = pkgng.lock(&quot;pkga&quot;)
        assert result
        lock_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;lock&quot;, &quot;-y&quot;, &quot;--quiet&quot;, &quot;--show-locked&quot;, &quot;pkga&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )

        result = pkgng.lock(&quot;dummy&quot;)
        assert not result
<A NAME="0"></A>        lock_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;lock&quot;, &quot;-y&quot;, &quot;--quiet&quot;, &quot;--show-locked&quot;, &quot;dummy&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match40519-0.html#0',2,'match40519-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>False,
        )


def test_unlock():
    &quot;&quot;&quot;
    Test pkgng.unlock
    &quot;&quot;&quot;
    unlock_cmd = MagicMock(
        return_value={&quot;stdout&quot;: &quot;pkga-1.0\npkgb-2.0\n&quot;, &quot;retcode&quot;: 0}
    )
    with patch.dict(pkgng.__salt__, {&quot;cmd.run_all&quot;</B></FONT>: unlock_cmd}):

        result = pkgng.unlock(&quot;pkga&quot;)
        assert not result
        unlock_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;unlock&quot;, &quot;-y&quot;, &quot;--quiet&quot;, &quot;--show-locked&quot;, &quot;pkga&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )

        result = pkgng.unlock(&quot;dummy&quot;)
        assert result
        unlock_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;unlock&quot;, &quot;-y&quot;, &quot;--quiet&quot;, &quot;--show-locked&quot;, &quot;dummy&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_locked():
    &quot;&quot;&quot;
    Test pkgng.unlock
    &quot;&quot;&quot;
    lock_cmd = MagicMock(return_value={&quot;stdout&quot;: &quot;pkga-1.0\npkgb-2.0\n&quot;, &quot;retcode&quot;: 0})
    with patch.dict(pkgng.__salt__, {&quot;cmd.run_all&quot;: lock_cmd}):

        result = pkgng.locked(&quot;pkga&quot;)
        assert result
        lock_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;lock&quot;, &quot;-y&quot;, &quot;--quiet&quot;, &quot;--show-locked&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )

        result = pkgng.locked(&quot;dummy&quot;)
        assert not result
        lock_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;lock&quot;, &quot;-y&quot;, &quot;--quiet&quot;, &quot;--show-locked&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_list_upgrades_present():
    &quot;&quot;&quot;
    Test pkgng.list_upgrades with upgrades available
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(
        return_value=textwrap.dedent(
            &quot;&quot;&quot;
        The following 6 package(s) will be affected (of 0 checked):

        Installed packages to be UPGRADED:
                pkga: 1.0 -&gt; 1.1
                pkgb: 2.0 -&gt; 2.1 [FreeBSD]
                pkgc: 3.0 -&gt; 3.1 [FreeBSD] (dependency changed)
                pkgd: 4.0 -&gt; 4.1 (dependency changed)

        New packages to be INSTALLED:
                pkge: 1.0
                pkgf: 2.0 [FreeBSD]
                pkgg: 3.0 [FreeBSD] (dependency changed)
                pkgh: 4.0 (dependency changed)

        Installed packages to be REINSTALLED:
                pkgi-1.0
                pkgj-2.0 [FreeBSD]
                pkgk-3.0 [FreeBSD] (direct dependency changed: pkga)
                pkgl-4.0 (direct dependency changed: pkgb)

        Installed packages to be DOWNGRADED:
                pkgm: 1.1 -&gt; 1.0
                pkgn: 2.1 -&gt; 2.0 [FreeBSD]
                pkgo: 3.1 -&gt; 3.0 [FreeBSD] (dependency changed)
                pkgp: 4.1 -&gt; 4.0 (dependency changed)

        Installed packages to be REMOVED:
                pkgq-1.0
                pkgr-2.0 [FreeBSD]
                pkgs-3.0 [FreeBSD] (direct dependency changed: pkga)
                pkgt-4.0 (direct dependency changed: pkgb)

        Number of packages to be upgraded: 2
        Number of packages to be reinstalled: 2

        The process will require 14 MiB more space.
        22 MiB to be downloaded.
        &quot;&quot;&quot;
        )
    )

    with patch.dict(pkgng.__salt__, {&quot;cmd.run_stdout&quot;: pkg_cmd}):

        result = pkgng.list_upgrades(refresh=False)
        assert result == {&quot;pkga&quot;: &quot;1.1&quot;, &quot;pkgb&quot;: &quot;2.1&quot;, &quot;pkgc&quot;: &quot;3.1&quot;, &quot;pkgd&quot;: &quot;4.1&quot;}
        pkg_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;upgrade&quot;, &quot;--dry-run&quot;, &quot;--quiet&quot;, &quot;--no-repo-update&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
            ignore_retcode=True,
        )


def test_list_upgrades_absent():
    &quot;&quot;&quot;
    Test pkgng.list_upgrades with no upgrades available
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=&quot;&quot;)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run_stdout&quot;: pkg_cmd}):
        result = pkgng.list_upgrades(refresh=False)
        assert result == {}
        pkg_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;upgrade&quot;, &quot;--dry-run&quot;, &quot;--quiet&quot;, &quot;--no-repo-update&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
            ignore_retcode=True,
        )


def test_upgrade_without_fromrepo(pkgs):
    &quot;&quot;&quot;
    Test pkg upgrade to upgrade all available packages
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value={&quot;retcode&quot;: 0})
    pkgs_mock = MagicMock(side_effect=pkgs)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run_all&quot;: pkg_cmd}):
        with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
            result = pkgng.upgrade()
            expected = {
                &quot;gettext-runtime&quot;: {&quot;new&quot;: &quot;0.20.1&quot;, &quot;old&quot;: &quot;&quot;},
                &quot;p5-Mojolicious&quot;: {&quot;new&quot;: &quot;8.40&quot;, &quot;old&quot;: &quot;&quot;},
            }
            assert result == expected
            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;upgrade&quot;, &quot;-y&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
            )


def test_upgrade_with_fromrepo(pkgs):
    &quot;&quot;&quot;
    Test pkg upgrade to upgrade all available packages
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value={&quot;retcode&quot;: 0})
    pkgs_mock = MagicMock(side_effect=pkgs)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run_all&quot;: pkg_cmd}):
        with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
            result = pkgng.upgrade(fromrepo=&quot;FreeBSD&quot;)
            expected = {
                &quot;gettext-runtime&quot;: {&quot;new&quot;: &quot;0.20.1&quot;, &quot;old&quot;: &quot;&quot;},
                &quot;p5-Mojolicious&quot;: {&quot;new&quot;: &quot;8.40&quot;, &quot;old&quot;: &quot;&quot;},
            }
            assert result == expected
            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;upgrade&quot;, &quot;-y&quot;, &quot;--repository&quot;, &quot;FreeBSD&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
            )


def test_upgrade_with_fetchonly(pkgs):
    &quot;&quot;&quot;
    Test pkg upgrade to fetch packages only
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value={&quot;retcode&quot;: 0})
    pkgs_mock = MagicMock(side_effect=pkgs)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run_all&quot;: pkg_cmd}):
        with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
            result = pkgng.upgrade(fetchonly=True)
            expected = {
                &quot;gettext-runtime&quot;: {&quot;new&quot;: &quot;0.20.1&quot;, &quot;old&quot;: &quot;&quot;},
                &quot;p5-Mojolicious&quot;: {&quot;new&quot;: &quot;8.40&quot;, &quot;old&quot;: &quot;&quot;},
            }
            assert result == expected
            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;upgrade&quot;, &quot;-Fy&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
            )


def test_upgrade_with_local(pkgs):
    &quot;&quot;&quot;
    Test pkg upgrade to supress automatic update of the local copy of the
    repository catalogue from remote
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value={&quot;retcode&quot;: 0})
    pkgs_mock = MagicMock(side_effect=pkgs)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run_all&quot;: pkg_cmd}):
        with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
            result = pkgng.upgrade(local=True)
            expected = {
                &quot;gettext-runtime&quot;: {&quot;new&quot;: &quot;0.20.1&quot;, &quot;old&quot;: &quot;&quot;},
                &quot;p5-Mojolicious&quot;: {&quot;new&quot;: &quot;8.40&quot;, &quot;old&quot;: &quot;&quot;},
            }
            assert result == expected
<A NAME="1"></A>            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;upgrade&quot;, &quot;-Uy&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match40519-0.html#1',2,'match40519-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>False,
            )


def test_stats_with_local():
    &quot;&quot;&quot;
    Test pkg.stats for local packages
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=&quot;&quot;)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;</B></FONT>: pkg_cmd}):
        result = pkgng.stats(local=True)
        assert result == []
        pkg_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;stats&quot;, &quot;-l&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_stats_with_remote():
    &quot;&quot;&quot;
    Test pkg.stats for remote packages
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=&quot;&quot;)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: pkg_cmd}):
        result = pkgng.stats(remote=True)
        assert result == []
        pkg_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;stats&quot;, &quot;-r&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_stats_with_bytes_remote():
    &quot;&quot;&quot;
    Test pkg.stats to show disk space usage in bytes only for remote
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=&quot;&quot;)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: pkg_cmd}):
        result = pkgng.stats(remote=True, bytes=True)
        assert result == []
        pkg_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;stats&quot;, &quot;-rb&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_stats_with_bytes_local():
    &quot;&quot;&quot;
    Test pkg.stats to show disk space usage in bytes only for local
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=&quot;&quot;)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: pkg_cmd}):
        result = pkgng.stats(local=True, bytes=True)
        assert result == []
        pkg_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;stats&quot;, &quot;-lb&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_install_without_args(pkgs):
    &quot;&quot;&quot;
    Test pkg.install to install a package without arguments
    &quot;&quot;&quot;
    parsed_targets = (
        OrderedDict(((&quot;gettext-runtime&quot;, None), (&quot;p5-Mojolicious&quot;, None))),
        &quot;repository&quot;,
    )
    pkg_cmd = MagicMock(return_value={&quot;retcode&quot;: 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        &quot;cmd.run_all&quot;: pkg_cmd,
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
            added = pkgng.install()
            expected = {
                &quot;gettext-runtime&quot;: {&quot;new&quot;: &quot;0.20.1&quot;, &quot;old&quot;: &quot;&quot;},
                &quot;p5-Mojolicious&quot;: {&quot;new&quot;: &quot;8.40&quot;, &quot;old&quot;: &quot;&quot;},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;install&quot;, &quot;-y&quot;, &quot;gettext-runtime&quot;, &quot;p5-Mojolicious&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
                env={},
            )


def test_install_with_local(pkgs):
    &quot;&quot;&quot;
    Test pkg.install to install a package with local=True argument
    &quot;&quot;&quot;
    parsed_targets = (
        OrderedDict(((&quot;gettext-runtime&quot;, None), (&quot;p5-Mojolicious&quot;, None))),
        &quot;repository&quot;,
    )
    pkg_cmd = MagicMock(return_value={&quot;retcode&quot;: 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        &quot;cmd.run_all&quot;: pkg_cmd,
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
            added = pkgng.install(local=True)
            expected = {
                &quot;gettext-runtime&quot;: {&quot;new&quot;: &quot;0.20.1&quot;, &quot;old&quot;: &quot;&quot;},
                &quot;p5-Mojolicious&quot;: {&quot;new&quot;: &quot;8.40&quot;, &quot;old&quot;: &quot;&quot;},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;install&quot;, &quot;-yU&quot;, &quot;gettext-runtime&quot;, &quot;p5-Mojolicious&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
                env={},
            )


def test_install_with_fromrepo(pkgs):
    &quot;&quot;&quot;
    Test pkg.install to install a package with fromrepo=FreeBSD argument
    &quot;&quot;&quot;
    parsed_targets = (
        OrderedDict(((&quot;gettext-runtime&quot;, None), (&quot;p5-Mojolicious&quot;, None))),
        &quot;repository&quot;,
    )
    pkg_cmd = MagicMock(return_value={&quot;retcode&quot;: 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        &quot;cmd.run_all&quot;: pkg_cmd,
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
            added = pkgng.install(fromrepo=&quot;FreeBSD&quot;)
            expected = {
                &quot;gettext-runtime&quot;: {&quot;new&quot;: &quot;0.20.1&quot;, &quot;old&quot;: &quot;&quot;},
                &quot;p5-Mojolicious&quot;: {&quot;new&quot;: &quot;8.40&quot;, &quot;old&quot;: &quot;&quot;},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                [
                    &quot;pkg&quot;,
                    &quot;install&quot;,
                    &quot;-r&quot;,
                    &quot;FreeBSD&quot;,
                    &quot;-y&quot;,
                    &quot;gettext-runtime&quot;,
                    &quot;p5-Mojolicious&quot;,
                ],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
                env={},
            )


def test_install_with_glob(pkgs):
    &quot;&quot;&quot;
    Test pkg.install to install a package with glob=True argument
    &quot;&quot;&quot;
    parsed_targets = (
        OrderedDict(((&quot;gettext-runtime&quot;, None), (&quot;p5-Mojolicious&quot;, None))),
        &quot;repository&quot;,
    )
    pkg_cmd = MagicMock(return_value={&quot;retcode&quot;: 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        &quot;cmd.run_all&quot;: pkg_cmd,
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
            added = pkgng.install(glob=True)
            expected = {
                &quot;gettext-runtime&quot;: {&quot;new&quot;: &quot;0.20.1&quot;, &quot;old&quot;: &quot;&quot;},
                &quot;p5-Mojolicious&quot;: {&quot;new&quot;: &quot;8.40&quot;, &quot;old&quot;: &quot;&quot;},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;install&quot;, &quot;-yg&quot;, &quot;gettext-runtime&quot;, &quot;p5-Mojolicious&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
                env={},
            )


def test_install_with_reinstall_requires(pkgs):
    &quot;&quot;&quot;
    Test pkg.install to install a package with reinstall_requires=True argument
    &quot;&quot;&quot;
    parsed_targets = (
        OrderedDict(((&quot;gettext-runtime&quot;, None), (&quot;p5-Mojolicious&quot;, None))),
        &quot;repository&quot;,
    )
    pkg_cmd = MagicMock(return_value={&quot;retcode&quot;: 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        &quot;cmd.run_all&quot;: pkg_cmd,
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
            added = pkgng.install(reinstall_requires=True, force=True)
            expected = {
                &quot;gettext-runtime&quot;: {&quot;new&quot;: &quot;0.20.1&quot;, &quot;old&quot;: &quot;&quot;},
                &quot;p5-Mojolicious&quot;: {&quot;new&quot;: &quot;8.40&quot;, &quot;old&quot;: &quot;&quot;},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;install&quot;, &quot;-yfR&quot;, &quot;gettext-runtime&quot;, &quot;p5-Mojolicious&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
                env={},
            )


def test_install_with_regex(pkgs):
    &quot;&quot;&quot;
    Test pkg.install to install a package with regex=True argument
    &quot;&quot;&quot;
    parsed_targets = (
        OrderedDict(((&quot;gettext-runtime&quot;, None), (&quot;p5-Mojolicious&quot;, None))),
        &quot;repository&quot;,
    )
    pkg_cmd = MagicMock(return_value={&quot;retcode&quot;: 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        &quot;cmd.run_all&quot;: pkg_cmd,
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
            added = pkgng.install(regex=True)
            expected = {
                &quot;gettext-runtime&quot;: {&quot;new&quot;: &quot;0.20.1&quot;, &quot;old&quot;: &quot;&quot;},
                &quot;p5-Mojolicious&quot;: {&quot;new&quot;: &quot;8.40&quot;, &quot;old&quot;: &quot;&quot;},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;install&quot;, &quot;-yx&quot;, &quot;gettext-runtime&quot;, &quot;p5-Mojolicious&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
                env={},
            )


def test_install_with_batch(pkgs):
    &quot;&quot;&quot;
    Test pkg.install to install a package with batch=True argument
    &quot;&quot;&quot;
    parsed_targets = (
        OrderedDict(((&quot;gettext-runtime&quot;, None), (&quot;p5-Mojolicious&quot;, None))),
        &quot;repository&quot;,
    )
    pkg_cmd = MagicMock(return_value={&quot;retcode&quot;: 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        &quot;cmd.run_all&quot;: pkg_cmd,
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
            added = pkgng.install(batch=True)
            expected = {
                &quot;gettext-runtime&quot;: {&quot;new&quot;: &quot;0.20.1&quot;, &quot;old&quot;: &quot;&quot;},
                &quot;p5-Mojolicious&quot;: {&quot;new&quot;: &quot;8.40&quot;, &quot;old&quot;: &quot;&quot;},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;install&quot;, &quot;-y&quot;, &quot;gettext-runtime&quot;, &quot;p5-Mojolicious&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
                env={&quot;BATCH&quot;: &quot;true&quot;, &quot;ASSUME_ALWAYS_YES&quot;: &quot;YES&quot;},
            )


def test_install_with_pcre(pkgs):
    &quot;&quot;&quot;
    Test pkg.install to install a package with pcre=True argument
    &quot;&quot;&quot;
    parsed_targets = (
        OrderedDict(((&quot;gettext-runtime&quot;, None), (&quot;p5-Mojolicious&quot;, None))),
        &quot;repository&quot;,
    )
    pkg_cmd = MagicMock(return_value={&quot;retcode&quot;: 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        &quot;cmd.run_all&quot;: pkg_cmd,
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
            added = pkgng.install(pcre=True)
            expected = {
                &quot;gettext-runtime&quot;: {&quot;new&quot;: &quot;0.20.1&quot;, &quot;old&quot;: &quot;&quot;},
                &quot;p5-Mojolicious&quot;: {&quot;new&quot;: &quot;8.40&quot;, &quot;old&quot;: &quot;&quot;},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;install&quot;, &quot;-yX&quot;, &quot;gettext-runtime&quot;, &quot;p5-Mojolicious&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
                env={},
            )


def test_install_with_orphan(pkgs):
    &quot;&quot;&quot;
    Test pkg.install to install a package with orphan=True argument
    &quot;&quot;&quot;
    parsed_targets = (
        OrderedDict(((&quot;gettext-runtime&quot;, None), (&quot;p5-Mojolicious&quot;, None))),
        &quot;repository&quot;,
    )
    pkg_cmd = MagicMock(return_value={&quot;retcode&quot;: 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        &quot;cmd.run_all&quot;: pkg_cmd,
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch(&quot;salt.modules.pkgng.list_pkgs&quot;, pkgs_mock):
            added = pkgng.install(orphan=True)
            expected = {
                &quot;gettext-runtime&quot;: {&quot;new&quot;: &quot;0.20.1&quot;, &quot;old&quot;: &quot;&quot;},
                &quot;p5-Mojolicious&quot;: {&quot;new&quot;: &quot;8.40&quot;, &quot;old&quot;: &quot;&quot;},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;install&quot;, &quot;-yA&quot;, &quot;gettext-runtime&quot;, &quot;p5-Mojolicious&quot;],
                output_loglevel=&quot;trace&quot;,
                python_shell=False,
                env={},
            )


def test_check_depends():
    &quot;&quot;&quot;
    Test pkgng.check to check and install missing dependencies
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=&quot;&quot;)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: pkg_cmd}):
        result = pkgng.check(depends=True)
        assert result == &quot;&quot;
        pkg_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;check&quot;, &quot;-dy&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_check_checksum():
    &quot;&quot;&quot;
    Test pkgng.check for packages with invalid checksums
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=&quot;&quot;)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: pkg_cmd}):
        result = pkgng.check(checksum=True)
        assert result == &quot;&quot;
        pkg_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;check&quot;, &quot;-s&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_check_recompute():
    &quot;&quot;&quot;
    Test pkgng.check to recalculate the checksums of installed packages
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=&quot;&quot;)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: pkg_cmd}):
        result = pkgng.check(recompute=True)
        assert result == &quot;&quot;
        pkg_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;check&quot;, &quot;-r&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_check_checklibs():
    &quot;&quot;&quot;
    Test pkgng.check to regenerate the library dependency metadata
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=&quot;&quot;)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: pkg_cmd}):
        result = pkgng.check(checklibs=True)
        assert result == &quot;&quot;
        pkg_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;check&quot;, &quot;-B&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_autoremove_with_dryrun():
    &quot;&quot;&quot;
    Test pkgng.autoremove with dryrun argument
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=&quot;&quot;)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: pkg_cmd}):
        result = pkgng.autoremove(dryrun=True)
        assert result == &quot;&quot;
        pkg_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;autoremove&quot;, &quot;-n&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_autoremove():
    &quot;&quot;&quot;
    Test pkgng.autoremove
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=&quot;&quot;)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: pkg_cmd}):

        result = pkgng.autoremove()
        assert result == &quot;&quot;
        pkg_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;autoremove&quot;, &quot;-y&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_audit():
    &quot;&quot;&quot;
    Test pkgng.audit
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=&quot;&quot;)

    with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: pkg_cmd}):

        result = pkgng.audit()
        assert result == &quot;&quot;
        pkg_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;audit&quot;, &quot;-F&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_version():
    &quot;&quot;&quot;
    Test pkgng.version
    &quot;&quot;&quot;
    version = &quot;2.0.6&quot;
    mock = MagicMock(return_value=version)
    with patch.dict(pkgng.__salt__, {&quot;pkg_resource.version&quot;: mock}):

        assert pkgng.version(*[&quot;mutt&quot;]) == version
        assert not pkgng.version(*[&quot;mutt&quot;]) == &quot;2.0.10&quot;


def test_refresh_db_without_forced_flag():
    &quot;&quot;&quot;
    Test pkgng.refresh_db with force=False
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=0)
    with patch(&quot;salt.utils.pkg.clear_rtag&quot;, MagicMock()):
        with patch.dict(pkgng.__salt__, {&quot;cmd.retcode&quot;: pkg_cmd}):

            result = pkgng.refresh_db()
            assert result is True
            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;update&quot;],
                python_shell=False,
            )


def test_refresh_db_with_forced_flag():
    &quot;&quot;&quot;
    Test pkgng.refresh_db with force=True
    &quot;&quot;&quot;
    pkg_cmd = MagicMock(return_value=0)
    with patch(&quot;salt.utils.pkg.clear_rtag&quot;, MagicMock()):
        with patch.dict(pkgng.__salt__, {&quot;cmd.retcode&quot;: pkg_cmd}):

            result = pkgng.refresh_db(force=True)
            assert result is True
            pkg_cmd.assert_called_with(
                [&quot;pkg&quot;, &quot;update&quot;, &quot;-f&quot;],
                python_shell=False,
            )


def test_fetch_with_default_flag():
    &quot;&quot;&quot;
    Test pkgng.fetch with default options
    &quot;&quot;&quot;

    targets = &quot;mutt&quot;
    pkg_cmd = MagicMock(return_value=targets)
    patches = {
        &quot;cmd.run&quot;: pkg_cmd,
        &quot;pkg_resource.stringify&quot;: MagicMock(),
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        pkgs = pkgng.fetch(targets)
        assert pkgs == targets
    pkg_cmd.assert_called_once_with(
        [&quot;pkg&quot;, &quot;fetch&quot;, &quot;-y&quot;, &quot;-g&quot;, &quot;mutt&quot;],
        output_loglevel=&quot;trace&quot;,
        python_shell=False,
    )


def test_fetch_with_dependency_flag():
    &quot;&quot;&quot;
    Test pkgng.fetch with enabled dependency flag
    &quot;&quot;&quot;

    targets = &quot;mutt&quot;
    pkg_cmd = MagicMock(return_value=targets)
    patches = {
        &quot;cmd.run&quot;: pkg_cmd,
        &quot;pkg_resource.stringify&quot;: MagicMock(),
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        pkgs = pkgng.fetch(targets, depends=True)
        assert pkgs == targets
    pkg_cmd.assert_called_once_with(
        [&quot;pkg&quot;, &quot;fetch&quot;, &quot;-y&quot;, &quot;-gd&quot;, &quot;mutt&quot;],
        output_loglevel=&quot;trace&quot;,
        python_shell=False,
    )


def test_fetch_with_regex_flag():
    &quot;&quot;&quot;
    Test pkgng.fetch with enabled regex flag
    &quot;&quot;&quot;

    targets = &quot;mutt&quot;
    pkg_cmd = MagicMock(return_value=targets)
    patches = {
        &quot;cmd.run&quot;: pkg_cmd,
        &quot;pkg_resource.stringify&quot;: MagicMock(),
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        pkgs = pkgng.fetch(targets, regex=True)
        assert pkgs == targets
    pkg_cmd.assert_called_once_with(
        [&quot;pkg&quot;, &quot;fetch&quot;, &quot;-y&quot;, &quot;-gx&quot;, &quot;mutt&quot;],
        output_loglevel=&quot;trace&quot;,
        python_shell=False,
    )


def test_fetch_with_fromrepo_flag():
    &quot;&quot;&quot;
    Test pkgng.fetch with enabled fromrepo flag
    &quot;&quot;&quot;

    targets = &quot;mutt&quot;
    pkg_cmd = MagicMock(return_value=targets)
    patches = {
        &quot;cmd.run&quot;: pkg_cmd,
        &quot;pkg_resource.stringify&quot;: MagicMock(),
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        pkgs = pkgng.fetch(targets, fromrepo=&quot;FreeBSD-poudriere&quot;)
        assert pkgs == targets
    pkg_cmd.assert_called_once_with(
        [&quot;pkg&quot;, &quot;fetch&quot;, &quot;-y&quot;, &quot;-r&quot;, &quot;FreeBSD-poudriere&quot;, &quot;-g&quot;, &quot;mutt&quot;],
        output_loglevel=&quot;trace&quot;,
        python_shell=False,
    )


def test_fetch_with_localcache_flag():
    &quot;&quot;&quot;
    Test pkgng.fetch with enabled localcache flag
    &quot;&quot;&quot;

    targets = &quot;mutt&quot;
    pkg_cmd = MagicMock(return_value=targets)
    patches = {
        &quot;cmd.run&quot;: pkg_cmd,
        &quot;pkg_resource.stringify&quot;: MagicMock(),
        &quot;pkg_resource.parse_targets&quot;: MagicMock(return_value=targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        pkgs = pkgng.fetch(targets, local=True)
        assert pkgs == targets
<A NAME="3"></A>    pkg_cmd.assert_called_once_with(
        [&quot;pkg&quot;, &quot;fetch&quot;, &quot;-y&quot;, &quot;-gL&quot;, &quot;mutt&quot;],
        output_loglevel=&quot;trace&quot;,
        python_shell<FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match40519-0.html#3',2,'match40519-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>=False,
    )


def test_which_with_default_flags():
    &quot;&quot;&quot;
    Test pkgng.which
    &quot;&quot;&quot;
    which_cmd = MagicMock(
        return_value={
            &quot;stdout&quot;: &quot;/usr/local/bin/mutt was installed by package mutt-2.0.6&quot;,
            &quot;retcode&quot;: 0,
        }
    )
    with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;</B></FONT>: which_cmd}):

        result = pkgng.which(&quot;/usr/local/bin/mutt&quot;)
        assert result
        which_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;which&quot;, &quot;/usr/local/bin/mutt&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )


def test_which_with_origin_flag():
    &quot;&quot;&quot;
    Test pkgng.which with enabled origin flag
    &quot;&quot;&quot;
    which_cmd = MagicMock(
        return_value={
            &quot;stdout&quot;: &quot;/usr/local/bin/mutt was installed by package mail/mutt&quot;,
            &quot;retcode&quot;: 0,
        }
    )
    with patch.dict(pkgng.__salt__, {&quot;cmd.run&quot;: which_cmd}):

        result = pkgng.which(&quot;/usr/local/bin/mutt&quot;, origin=True)
        assert result
        which_cmd.assert_called_with(
            [&quot;pkg&quot;, &quot;which&quot;, &quot;-o&quot;, &quot;/usr/local/bin/mutt&quot;],
            output_loglevel=&quot;trace&quot;,
            python_shell=False,
        )
</PRE>
</div>
  </div>
</body>
</html>
