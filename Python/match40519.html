<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_dig.py &amp; test_pkgng_1.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_dig.py &amp; test_pkgng_1.py
      </h3>
<h1 align="center">
        6.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_dig.py (25.66845%)<th>test_pkgng_1.py (3.8125496%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(148-166)<td><a href="#" name="0">(126-137)</a><td align="center"><font color="#ff0000">12</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(122-126)<td><a href="#" name="1">(342-352)</a><td align="center"><font color="#ff0000">12</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(90-108)<td><a href="#" name="2">(103-111)</a><td align="center"><font color="#ff0000">12</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(68-86)<td><a href="#" name="3">(952-966)</a><td align="center"><font color="#ff0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_dig.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
"""
    :codeauthor: Nicole Thomas &lt;nicole@saltstack.com&gt;
"""
import salt.modules.dig as dig
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import MagicMock, patch
from tests.support.unit import TestCase, skipIf
_SPF_VALUES = {
    "dig +short xmission.com TXT": {
        "pid": 27282,
        "retcode": 0,
        "stderr": "",
        "stdout": '"v=spf1 a mx include:_spf.xmission.com ?all"',
    },
    "dig +short _spf.xmission.com TXT": {
        "pid": 27282,
        "retcode": 0,
        "stderr": "",
        "stdout": '"v=spf1 a mx ip4:198.60.22.0/24 ip4:166.70.13.0/24 ~all"',
    },
    "dig +short xmission-redirect.com TXT": {
        "pid": 27282,
        "retcode": 0,
        "stderr": "",
        "stdout": "v=spf1 redirect=_spf.xmission.com",
    },
    "dig +short foo.com TXT": {
        "pid": 27282,
        "retcode": 0,
        "stderr": "",
        "stdout": "v=spf1 ip4:216.73.93.70/31 ip4:216.73.93.72/31 ~all",
    },
}
def _spf_side_effect(key, python_shell=False):
    return _SPF_VALUES.get(
        " ".join(key), {"pid": 27310, "retcode": 0, "stderr": "", "stdout": ""}
    )
@skipIf(dig.__virtual__() is False, "Dig must be installed")
class DigTestCase(TestCase, LoaderModuleMockMixin):
    def setup_loader_modules(self):
        return {dig: {}}
    def test_check_ip(self):
        self.assertTrue(dig.check_ip("127.0.0.1"), msg="Not a valid ip address")
    def test_check_ip_ipv6(self):
        self.assertTrue(
            dig.check_ip("1111:2222:3333:4444:5555:6666:7777:8888"),
            msg="Not a valid ip address",
        )
    def test_check_ip_ipv6_valid(self):
        self.assertTrue(dig.check_ip("2607:fa18:0:3::4"))
    def test_check_ip_neg(self):
        self.assertFalse(
            dig.check_ip("-127.0.0.1"), msg="Did not detect negative value as invalid"
    def test_check_ip_empty(self):
        self.assertFalse(dig.check_ip(""), msg<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>="Did not detect empty value as invalid")
    def test_a(self):
        dig_mock = MagicMock(
            return_value={
                "pid": 3656,
                "retcode": 0,
                "stderr": "",
                "stdout": (
                    "74.125.193.104\n"
                    "74.125.193.105\n"
                    "74.125.193.99\n"
                    "74.125.193.106\n"
                    "74.125.193.103\n"
                    "74.125.193.147"
                ),
            }
        )
        with patch.dict(dig.__salt__, {"cmd.run_all"</b></font>: dig_mock}):
                dig.A("www.google.com"),
                [
                    "<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>74.125.193.104",
                    "74.125.193.105",
                    "74.125.193.99",
                    "74.125.193.106",
                    "74.125.193.103",
                    "74.125.193.147",
                ],
            )
    def test_aaaa(self):
        dig_mock = MagicMock(
            return_value={
                "pid": 25451,
                "retcode": 0,
                "stderr": "",
                "stdout": "2607:f8b0:400f:801::1014",
            }
        )
        with patch.dict(dig.__salt__, {"cmd.run_all"</b></font>: dig_mock}):
            self.assertEqual(dig.AAAA("www.google.com"), ["2607:f8b0:400f:801::1014"])
    def test_ns(self):
        with patch("salt.modules.dig.A", MagicMock(return_value=["ns4.google.com."])):
            dig_mock = MagicMock(
                return_value={
                    "pid": 26136,
                    "retcode": 0,
                    "stderr": "",
                    "stdout": "ns4.google.com.",
            )
            with patch.dict(dig.__salt__, {"cmd.run_all": dig_mock}):
                self.assertEqual(dig.NS(<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"google.com"), ["ns4.google.com."])
    def test_spf(self):
        dig_mock = MagicMock(side_effect=_spf_side_effect)
        with patch.dict(dig.__salt__, {"cmd.run_all"</b></font>: dig_mock}):
            self.assertEqual(dig.SPF("foo.com"), ["216.73.93.70/31", "216.73.93.72/31"])
    def test_spf_redir(self):
        """
        Test for SPF records which use the 'redirect' SPF mechanism
        https://en.wikipedia.org/wiki/Sender_Policy_Framework#Mechanisms
        """
        dig_mock = MagicMock(side_effect=_spf_side_effect)
        with patch.dict(dig.__salt__, {"cmd.run_all": dig_mock}):
            self.assertEqual(
                dig.SPF("xmission-redirect.com"), ["198.60.22.0/24", "166.70.13.0/24"]
            )
    def test_spf_include(self):
        """
        Test for SPF records which use the 'include' SPF mechanism
        https://en.wikipedia.org/wiki/Sender_Policy_Framework#Mechanisms
        """
        with patch.dict(dig.__salt__, {"cmd.run_all": dig_mock}):
            self.assertEqual(
                dig.SPF("xmission.com"), ["<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>198.60.22.0/24", "166.70.13.0/24"]
            )
    def test_mx(self):
        dig_mock = MagicMock(
            return_value={
                "pid": 27780,
                "retcode": 0,
                "stderr": "",
                "stdout": (
                    "10 aspmx.l.google.com.\n"
                    "20 alt1.aspmx.l.google.com.\n"
                    "40 alt3.aspmx.l.google.com.\n"
                    "50 alt4.aspmx.l.google.com.\n"
                    "30 alt2.aspmx.l.google.com."
                ),
            }
        )
        with patch.dict(dig.__salt__, {"cmd.run_all"</b></font>: dig_mock}):
            self.assertEqual(
                dig.MX("google.com"),
                [
                    ["10", "aspmx.l.google.com."],
                    ["20", "alt1.aspmx.l.google.com."],
                    ["40", "alt3.aspmx.l.google.com."],
                    ["50", "alt4.aspmx.l.google.com."],
                    ["30", "alt2.aspmx.l.google.com."],
                ],
            )
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_pkgng_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
import textwrap
import pytest
import salt.modules.pkgng as pkgng
from salt.utils.odict import OrderedDict
from tests.support.mock import MagicMock, patch
@pytest.fixture
def configure_loader_modules():
    return {pkgng: {}}
@pytest.fixture
def pkgs():
    return [
        {"openvpn": "2.4.8_2"},
        {"openvpn": "2.4.8_2", "gettext-runtime": "0.20.1", "p5-Mojolicious": "8.40"},
    ]
def test_latest_version(pkgs):
    """
    Test basic usage of pkgng.latest_version
    """
    pkgs_mock = MagicMock(side_effect=pkgs)
    search_cmd = MagicMock(return_value="bash-5.1.4")
    with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
        with patch.dict(pkgng.__salt__, {"cmd.run": search_cmd}):
            result = pkgng.latest_version("bash")
            search_cmd.assert_called_with(
                ["pkg", "search", "-eqS", "name", "-U", "bash"],
                output_loglevel="trace",
                python_shell=False,
            )
            assert result == "5.1.4"
def test_latest_version_origin(pkgs):
    """
    Test pkgng.latest_version with a specific package origin
    """
    pkgs_mock = MagicMock(side_effect=pkgs)
    search_cmd = MagicMock(return_value="bash-5.1.4_2")
    with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
        with patch.dict(pkgng.__salt__, {"cmd.run": search_cmd}):
            result = pkgng.latest_version("shells/bash")
            search_cmd.assert_called_with(
                ["pkg", "search", "-eqS", "origin", "-U", "shells/bash"],
                output_loglevel="trace",
                python_shell=False,
            )
            assert result == "5.1.4_2"
def test_latest_version_outofdatedate(pkgs):
    """
    Test pkgng.latest_version with an out-of-date package
    """
    pkgs_mock = MagicMock(side_effect=pkgs)
    search_cmd = MagicMock(return_value="openvpn-2.4.8_3")
    with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
        with patch.dict(pkgng.__salt__, {"cmd.run": search_cmd}):
            result = pkgng.latest_version("openvpn")
            search_cmd.assert_called_with(
                ["pkg", "search", "-eqS", "name", "-U", "openvpn"],
                output_loglevel="trace",
                python_shell=False,
            )
            assert result == "2.4.8_3"
def test_latest_version_unavailable(pkgs):
    """
    Test pkgng.latest_version when the requested package is not available
    """
    pkgs_mock = MagicMock(side_effect=pkgs)
    search_cmd = MagicMock(return_value="")
    with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
        with patch.dict(pkgng.__salt__, {"cmd.run": search_cmd}):
            result = pkgng.latest_version("does_not_exist")
            search_cmd.assert_called_with(
                ["pkg", "search", "-eqS", "name", "-U", "does_not_exist"],
                output_loglevel="trace",
                python_shell=False,
            )
def test_latest_version_uptodate(pkgs):
    """
    Test pkgng.latest_version with an up-to-date package
    """
    pkgs_mock = MagicMock(side_effect=pkgs)
    search_cmd = MagicMock(return_value="openvpn-2.4.8_2")
    with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
        with patch.dict(pkgng.__salt__, {"cmd.run": search_cmd}):
            result = pkgng.latest_version("openvpn")
            search_cmd.assert_called_with(
                ["pkg", "search", "-eqS", "name", "-U", "openvpn"],
                python_shell=False,
            )
            as<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>sert result == ""
def test_lock():
    """
    Test pkgng.lock
    """
    lock_cmd = MagicMock(return_value={"stdout": "pkga-1.0\npkgb-2.0\n", "retcode": 0})
    with patch.dict(pkgng.__salt__, {"cmd.run_all"</b></font>: lock_cmd}):
        result = pkgng.lock("pkga")
        assert result
        lock_cmd.assert_called_with(
            ["pkg", "lock", "-y", "--quiet", "--show-locked", "pkga"],
            output_loglevel="trace",
            python_shell=False,
        )
        result = pkgng.lock("dummy")
        assert not result
            ["pkg", "lock", "-y", "--quiet", "--show-locked", "dummy"],
            output_loglevel="trace",
            python_shell=<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>False,
        )
def test_unlock():
    """
    Test pkgng.unlock
    """
    unlock_cmd = MagicMock(
        return_value={"stdout": "pkga-1.0\npkgb-2.0\n", "retcode": 0}
    )
    with patch.dict(pkgng.__salt__, {"cmd.run_all"</b></font>: unlock_cmd}):
        result = pkgng.unlock("pkga")
        assert not result
        unlock_cmd.assert_called_with(
            ["pkg", "unlock", "-y", "--quiet", "--show-locked", "pkga"],
            output_loglevel="trace",
            python_shell=False,
        )
        result = pkgng.unlock("dummy")
        assert result
        unlock_cmd.assert_called_with(
            ["pkg", "unlock", "-y", "--quiet", "--show-locked", "dummy"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_locked():
    """
    Test pkgng.unlock
    """
    lock_cmd = MagicMock(return_value={"stdout": "pkga-1.0\npkgb-2.0\n", "retcode": 0})
    with patch.dict(pkgng.__salt__, {"cmd.run_all": lock_cmd}):
        result = pkgng.locked("pkga")
        assert result
        lock_cmd.assert_called_with(
            ["pkg", "lock", "-y", "--quiet", "--show-locked"],
            output_loglevel="trace",
            python_shell=False,
        )
        result = pkgng.locked("dummy")
        assert not result
        lock_cmd.assert_called_with(
            ["pkg", "lock", "-y", "--quiet", "--show-locked"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_list_upgrades_present():
    """
    Test pkgng.list_upgrades with upgrades available
    """
    pkg_cmd = MagicMock(
        return_value=textwrap.dedent(
            """
        The following 6 package(s) will be affected (of 0 checked):
        Installed packages to be UPGRADED:
                pkga: 1.0 -&gt; 1.1
                pkgb: 2.0 -&gt; 2.1 [FreeBSD]
                pkgc: 3.0 -&gt; 3.1 [FreeBSD] (dependency changed)
                pkgd: 4.0 -&gt; 4.1 (dependency changed)
        New packages to be INSTALLED:
                pkge: 1.0
                pkgf: 2.0 [FreeBSD]
                pkgg: 3.0 [FreeBSD] (dependency changed)
                pkgh: 4.0 (dependency changed)
        Installed packages to be REINSTALLED:
                pkgi-1.0
                pkgj-2.0 [FreeBSD]
                pkgk-3.0 [FreeBSD] (direct dependency changed: pkga)
                pkgl-4.0 (direct dependency changed: pkgb)
        Installed packages to be DOWNGRADED:
                pkgm: 1.1 -&gt; 1.0
                pkgn: 2.1 -&gt; 2.0 [FreeBSD]
                pkgo: 3.1 -&gt; 3.0 [FreeBSD] (dependency changed)
                pkgp: 4.1 -&gt; 4.0 (dependency changed)
        Installed packages to be REMOVED:
                pkgq-1.0
                pkgr-2.0 [FreeBSD]
                pkgs-3.0 [FreeBSD] (direct dependency changed: pkga)
                pkgt-4.0 (direct dependency changed: pkgb)
        Number of packages to be upgraded: 2
        Number of packages to be reinstalled: 2
        The process will require 14 MiB more space.
        22 MiB to be downloaded.
        """
        )
    )
    with patch.dict(pkgng.__salt__, {"cmd.run_stdout": pkg_cmd}):
        result = pkgng.list_upgrades(refresh=False)
        assert result == {"pkga": "1.1", "pkgb": "2.1", "pkgc": "3.1", "pkgd": "4.1"}
        pkg_cmd.assert_called_with(
            ["pkg", "upgrade", "--dry-run", "--quiet", "--no-repo-update"],
            output_loglevel="trace",
            python_shell=False,
            ignore_retcode=True,
        )
def test_list_upgrades_absent():
    """
    Test pkgng.list_upgrades with no upgrades available
    """
    pkg_cmd = MagicMock(return_value="")
    with patch.dict(pkgng.__salt__, {"cmd.run_stdout": pkg_cmd}):
        result = pkgng.list_upgrades(refresh=False)
        assert result == {}
        pkg_cmd.assert_called_with(
            ["pkg", "upgrade", "--dry-run", "--quiet", "--no-repo-update"],
            output_loglevel="trace",
            python_shell=False,
            ignore_retcode=True,
        )
def test_upgrade_without_fromrepo(pkgs):
    """
    Test pkg upgrade to upgrade all available packages
    """
    pkg_cmd = MagicMock(return_value={"retcode": 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    with patch.dict(pkgng.__salt__, {"cmd.run_all": pkg_cmd}):
        with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
            result = pkgng.upgrade()
            expected = {
                "gettext-runtime": {"new": "0.20.1", "old": ""},
                "p5-Mojolicious": {"new": "8.40", "old": ""},
            }
            assert result == expected
            pkg_cmd.assert_called_with(
                ["pkg", "upgrade", "-y"],
                output_loglevel="trace",
                python_shell=False,
            )
def test_upgrade_with_fromrepo(pkgs):
    """
    Test pkg upgrade to upgrade all available packages
    """
    pkg_cmd = MagicMock(return_value={"retcode": 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    with patch.dict(pkgng.__salt__, {"cmd.run_all": pkg_cmd}):
        with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
            result = pkgng.upgrade(fromrepo="FreeBSD")
            expected = {
                "gettext-runtime": {"new": "0.20.1", "old": ""},
                "p5-Mojolicious": {"new": "8.40", "old": ""},
            }
            assert result == expected
            pkg_cmd.assert_called_with(
                ["pkg", "upgrade", "-y", "--repository", "FreeBSD"],
                output_loglevel="trace",
                python_shell=False,
            )
def test_upgrade_with_fetchonly(pkgs):
    """
    Test pkg upgrade to fetch packages only
    """
    pkg_cmd = MagicMock(return_value={"retcode": 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    with patch.dict(pkgng.__salt__, {"cmd.run_all": pkg_cmd}):
        with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
            result = pkgng.upgrade(fetchonly=True)
            expected = {
                "gettext-runtime": {"new": "0.20.1", "old": ""},
                "p5-Mojolicious": {"new": "8.40", "old": ""},
            }
            assert result == expected
            pkg_cmd.assert_called_with(
                ["pkg", "upgrade", "-Fy"],
                output_loglevel="trace",
                python_shell=False,
            )
def test_upgrade_with_local(pkgs):
    """
    Test pkg upgrade to supress automatic update of the local copy of the
    repository catalogue from remote
    """
    pkg_cmd = MagicMock(return_value={"retcode": 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    with patch.dict(pkgng.__salt__, {"cmd.run_all": pkg_cmd}):
        with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
            result = pkgng.upgrade(local=True)
            expected = {
                "gettext-runtime": {"new": "0.20.1", "old": ""},
                "p5-Mojolicious": {"new": "8.40", "old": ""},
            }
            assert result == expected
                ["pkg", "upgrade", "-Uy"],
                output_loglevel="trace",
                python_shell=<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>False,
            )
def test_stats_with_local():
    """
    Test pkg.stats for local packages
    """
    pkg_cmd = MagicMock(return_value="")
    with patch.dict(pkgng.__salt__, {"cmd.run"</b></font>: pkg_cmd}):
        result = pkgng.stats(local=True)
        assert result == []
        pkg_cmd.assert_called_with(
            ["pkg", "stats", "-l"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_stats_with_remote():
    """
    Test pkg.stats for remote packages
    """
    pkg_cmd = MagicMock(return_value="")
    with patch.dict(pkgng.__salt__, {"cmd.run": pkg_cmd}):
        result = pkgng.stats(remote=True)
        assert result == []
        pkg_cmd.assert_called_with(
            ["pkg", "stats", "-r"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_stats_with_bytes_remote():
    """
    Test pkg.stats to show disk space usage in bytes only for remote
    """
    pkg_cmd = MagicMock(return_value="")
    with patch.dict(pkgng.__salt__, {"cmd.run": pkg_cmd}):
        result = pkgng.stats(remote=True, bytes=True)
        assert result == []
        pkg_cmd.assert_called_with(
            ["pkg", "stats", "-rb"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_stats_with_bytes_local():
    """
    Test pkg.stats to show disk space usage in bytes only for local
    """
    pkg_cmd = MagicMock(return_value="")
    with patch.dict(pkgng.__salt__, {"cmd.run": pkg_cmd}):
        result = pkgng.stats(local=True, bytes=True)
        assert result == []
        pkg_cmd.assert_called_with(
            ["pkg", "stats", "-lb"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_install_without_args(pkgs):
    """
    Test pkg.install to install a package without arguments
    """
    parsed_targets = (
        OrderedDict((("gettext-runtime", None), ("p5-Mojolicious", None))),
        "repository",
    )
    pkg_cmd = MagicMock(return_value={"retcode": 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        "cmd.run_all": pkg_cmd,
        "pkg_resource.parse_targets": MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
            added = pkgng.install()
            expected = {
                "gettext-runtime": {"new": "0.20.1", "old": ""},
                "p5-Mojolicious": {"new": "8.40", "old": ""},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                ["pkg", "install", "-y", "gettext-runtime", "p5-Mojolicious"],
                output_loglevel="trace",
                python_shell=False,
                env={},
            )
def test_install_with_local(pkgs):
    """
    Test pkg.install to install a package with local=True argument
    """
    parsed_targets = (
        OrderedDict((("gettext-runtime", None), ("p5-Mojolicious", None))),
        "repository",
    )
    pkg_cmd = MagicMock(return_value={"retcode": 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        "cmd.run_all": pkg_cmd,
        "pkg_resource.parse_targets": MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
            added = pkgng.install(local=True)
            expected = {
                "gettext-runtime": {"new": "0.20.1", "old": ""},
                "p5-Mojolicious": {"new": "8.40", "old": ""},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                ["pkg", "install", "-yU", "gettext-runtime", "p5-Mojolicious"],
                output_loglevel="trace",
                python_shell=False,
                env={},
            )
def test_install_with_fromrepo(pkgs):
    """
    Test pkg.install to install a package with fromrepo=FreeBSD argument
    """
    parsed_targets = (
        OrderedDict((("gettext-runtime", None), ("p5-Mojolicious", None))),
        "repository",
    )
    pkg_cmd = MagicMock(return_value={"retcode": 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        "cmd.run_all": pkg_cmd,
        "pkg_resource.parse_targets": MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
            added = pkgng.install(fromrepo="FreeBSD")
            expected = {
                "gettext-runtime": {"new": "0.20.1", "old": ""},
                "p5-Mojolicious": {"new": "8.40", "old": ""},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                [
                    "pkg",
                    "install",
                    "-r",
                    "FreeBSD",
                    "-y",
                    "gettext-runtime",
                    "p5-Mojolicious",
                ],
                output_loglevel="trace",
                python_shell=False,
                env={},
            )
def test_install_with_glob(pkgs):
    """
    Test pkg.install to install a package with glob=True argument
    """
    parsed_targets = (
        OrderedDict((("gettext-runtime", None), ("p5-Mojolicious", None))),
        "repository",
    )
    pkg_cmd = MagicMock(return_value={"retcode": 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        "cmd.run_all": pkg_cmd,
        "pkg_resource.parse_targets": MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
            added = pkgng.install(glob=True)
            expected = {
                "gettext-runtime": {"new": "0.20.1", "old": ""},
                "p5-Mojolicious": {"new": "8.40", "old": ""},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                ["pkg", "install", "-yg", "gettext-runtime", "p5-Mojolicious"],
                output_loglevel="trace",
                python_shell=False,
                env={},
            )
def test_install_with_reinstall_requires(pkgs):
    """
    Test pkg.install to install a package with reinstall_requires=True argument
    """
    parsed_targets = (
        OrderedDict((("gettext-runtime", None), ("p5-Mojolicious", None))),
        "repository",
    )
    pkg_cmd = MagicMock(return_value={"retcode": 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        "cmd.run_all": pkg_cmd,
        "pkg_resource.parse_targets": MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
            added = pkgng.install(reinstall_requires=True, force=True)
            expected = {
                "gettext-runtime": {"new": "0.20.1", "old": ""},
                "p5-Mojolicious": {"new": "8.40", "old": ""},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                ["pkg", "install", "-yfR", "gettext-runtime", "p5-Mojolicious"],
                output_loglevel="trace",
                python_shell=False,
                env={},
            )
def test_install_with_regex(pkgs):
    """
    Test pkg.install to install a package with regex=True argument
    """
    parsed_targets = (
        OrderedDict((("gettext-runtime", None), ("p5-Mojolicious", None))),
        "repository",
    )
    pkg_cmd = MagicMock(return_value={"retcode": 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        "cmd.run_all": pkg_cmd,
        "pkg_resource.parse_targets": MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
            added = pkgng.install(regex=True)
            expected = {
                "gettext-runtime": {"new": "0.20.1", "old": ""},
                "p5-Mojolicious": {"new": "8.40", "old": ""},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                ["pkg", "install", "-yx", "gettext-runtime", "p5-Mojolicious"],
                output_loglevel="trace",
                python_shell=False,
                env={},
            )
def test_install_with_batch(pkgs):
    """
    Test pkg.install to install a package with batch=True argument
    """
    parsed_targets = (
        OrderedDict((("gettext-runtime", None), ("p5-Mojolicious", None))),
        "repository",
    )
    pkg_cmd = MagicMock(return_value={"retcode": 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        "cmd.run_all": pkg_cmd,
        "pkg_resource.parse_targets": MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
            added = pkgng.install(batch=True)
            expected = {
                "gettext-runtime": {"new": "0.20.1", "old": ""},
                "p5-Mojolicious": {"new": "8.40", "old": ""},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                ["pkg", "install", "-y", "gettext-runtime", "p5-Mojolicious"],
                output_loglevel="trace",
                python_shell=False,
                env={"BATCH": "true", "ASSUME_ALWAYS_YES": "YES"},
            )
def test_install_with_pcre(pkgs):
    """
    Test pkg.install to install a package with pcre=True argument
    """
    parsed_targets = (
        OrderedDict((("gettext-runtime", None), ("p5-Mojolicious", None))),
        "repository",
    )
    pkg_cmd = MagicMock(return_value={"retcode": 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        "cmd.run_all": pkg_cmd,
        "pkg_resource.parse_targets": MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
            added = pkgng.install(pcre=True)
            expected = {
                "gettext-runtime": {"new": "0.20.1", "old": ""},
                "p5-Mojolicious": {"new": "8.40", "old": ""},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                ["pkg", "install", "-yX", "gettext-runtime", "p5-Mojolicious"],
                output_loglevel="trace",
                python_shell=False,
                env={},
            )
def test_install_with_orphan(pkgs):
    """
    Test pkg.install to install a package with orphan=True argument
    """
    parsed_targets = (
        OrderedDict((("gettext-runtime", None), ("p5-Mojolicious", None))),
        "repository",
    )
    pkg_cmd = MagicMock(return_value={"retcode": 0})
    pkgs_mock = MagicMock(side_effect=pkgs)
    patches = {
        "cmd.run_all": pkg_cmd,
        "pkg_resource.parse_targets": MagicMock(return_value=parsed_targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        with patch("salt.modules.pkgng.list_pkgs", pkgs_mock):
            added = pkgng.install(orphan=True)
            expected = {
                "gettext-runtime": {"new": "0.20.1", "old": ""},
                "p5-Mojolicious": {"new": "8.40", "old": ""},
            }
            assert added == expected
            pkg_cmd.assert_called_with(
                ["pkg", "install", "-yA", "gettext-runtime", "p5-Mojolicious"],
                output_loglevel="trace",
                python_shell=False,
                env={},
            )
def test_check_depends():
    """
    Test pkgng.check to check and install missing dependencies
    """
    pkg_cmd = MagicMock(return_value="")
    with patch.dict(pkgng.__salt__, {"cmd.run": pkg_cmd}):
        result = pkgng.check(depends=True)
        assert result == ""
        pkg_cmd.assert_called_with(
            ["pkg", "check", "-dy"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_check_checksum():
    """
    Test pkgng.check for packages with invalid checksums
    """
    pkg_cmd = MagicMock(return_value="")
    with patch.dict(pkgng.__salt__, {"cmd.run": pkg_cmd}):
        result = pkgng.check(checksum=True)
        assert result == ""
        pkg_cmd.assert_called_with(
            ["pkg", "check", "-s"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_check_recompute():
    """
    Test pkgng.check to recalculate the checksums of installed packages
    """
    pkg_cmd = MagicMock(return_value="")
    with patch.dict(pkgng.__salt__, {"cmd.run": pkg_cmd}):
        result = pkgng.check(recompute=True)
        assert result == ""
        pkg_cmd.assert_called_with(
            ["pkg", "check", "-r"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_check_checklibs():
    """
    Test pkgng.check to regenerate the library dependency metadata
    """
    pkg_cmd = MagicMock(return_value="")
    with patch.dict(pkgng.__salt__, {"cmd.run": pkg_cmd}):
        result = pkgng.check(checklibs=True)
        assert result == ""
        pkg_cmd.assert_called_with(
            ["pkg", "check", "-B"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_autoremove_with_dryrun():
    """
    Test pkgng.autoremove with dryrun argument
    """
    pkg_cmd = MagicMock(return_value="")
    with patch.dict(pkgng.__salt__, {"cmd.run": pkg_cmd}):
        result = pkgng.autoremove(dryrun=True)
        assert result == ""
        pkg_cmd.assert_called_with(
            ["pkg", "autoremove", "-n"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_autoremove():
    """
    Test pkgng.autoremove
    """
    pkg_cmd = MagicMock(return_value="")
    with patch.dict(pkgng.__salt__, {"cmd.run": pkg_cmd}):
        result = pkgng.autoremove()
        assert result == ""
        pkg_cmd.assert_called_with(
            ["pkg", "autoremove", "-y"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_audit():
    """
    Test pkgng.audit
    """
    pkg_cmd = MagicMock(return_value="")
    with patch.dict(pkgng.__salt__, {"cmd.run": pkg_cmd}):
        result = pkgng.audit()
        assert result == ""
        pkg_cmd.assert_called_with(
            ["pkg", "audit", "-F"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_version():
    """
    Test pkgng.version
    """
    version = "2.0.6"
    mock = MagicMock(return_value=version)
    with patch.dict(pkgng.__salt__, {"pkg_resource.version": mock}):
        assert pkgng.version(*["mutt"]) == version
        assert not pkgng.version(*["mutt"]) == "2.0.10"
def test_refresh_db_without_forced_flag():
    """
    Test pkgng.refresh_db with force=False
    """
    pkg_cmd = MagicMock(return_value=0)
    with patch("salt.utils.pkg.clear_rtag", MagicMock()):
        with patch.dict(pkgng.__salt__, {"cmd.retcode": pkg_cmd}):
            result = pkgng.refresh_db()
            assert result is True
            pkg_cmd.assert_called_with(
                ["pkg", "update"],
                python_shell=False,
            )
def test_refresh_db_with_forced_flag():
    """
    Test pkgng.refresh_db with force=True
    """
    pkg_cmd = MagicMock(return_value=0)
    with patch("salt.utils.pkg.clear_rtag", MagicMock()):
        with patch.dict(pkgng.__salt__, {"cmd.retcode": pkg_cmd}):
            result = pkgng.refresh_db(force=True)
            assert result is True
            pkg_cmd.assert_called_with(
                ["pkg", "update", "-f"],
                python_shell=False,
            )
def test_fetch_with_default_flag():
    """
    Test pkgng.fetch with default options
    """
    targets = "mutt"
    pkg_cmd = MagicMock(return_value=targets)
    patches = {
        "cmd.run": pkg_cmd,
        "pkg_resource.stringify": MagicMock(),
        "pkg_resource.parse_targets": MagicMock(return_value=targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        pkgs = pkgng.fetch(targets)
        assert pkgs == targets
    pkg_cmd.assert_called_once_with(
        ["pkg", "fetch", "-y", "-g", "mutt"],
        output_loglevel="trace",
        python_shell=False,
    )
def test_fetch_with_dependency_flag():
    """
    Test pkgng.fetch with enabled dependency flag
    """
    targets = "mutt"
    pkg_cmd = MagicMock(return_value=targets)
    patches = {
        "cmd.run": pkg_cmd,
        "pkg_resource.stringify": MagicMock(),
        "pkg_resource.parse_targets": MagicMock(return_value=targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        pkgs = pkgng.fetch(targets, depends=True)
        assert pkgs == targets
    pkg_cmd.assert_called_once_with(
        ["pkg", "fetch", "-y", "-gd", "mutt"],
        output_loglevel="trace",
        python_shell=False,
    )
def test_fetch_with_regex_flag():
    """
    Test pkgng.fetch with enabled regex flag
    """
    targets = "mutt"
    pkg_cmd = MagicMock(return_value=targets)
    patches = {
        "cmd.run": pkg_cmd,
        "pkg_resource.stringify": MagicMock(),
        "pkg_resource.parse_targets": MagicMock(return_value=targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        pkgs = pkgng.fetch(targets, regex=True)
        assert pkgs == targets
    pkg_cmd.assert_called_once_with(
        ["pkg", "fetch", "-y", "-gx", "mutt"],
        output_loglevel="trace",
        python_shell=False,
    )
def test_fetch_with_fromrepo_flag():
    """
    Test pkgng.fetch with enabled fromrepo flag
    """
    targets = "mutt"
    pkg_cmd = MagicMock(return_value=targets)
    patches = {
        "cmd.run": pkg_cmd,
        "pkg_resource.stringify": MagicMock(),
        "pkg_resource.parse_targets": MagicMock(return_value=targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        pkgs = pkgng.fetch(targets, fromrepo="FreeBSD-poudriere")
        assert pkgs == targets
    pkg_cmd.assert_called_once_with(
        ["pkg", "fetch", "-y", "-r", "FreeBSD-poudriere", "-g", "mutt"],
        output_loglevel="trace",
        python_shell=False,
    )
def test_fetch_with_localcache_flag():
    """
    Test pkgng.fetch with enabled localcache flag
    """
    targets = "mutt"
    pkg_cmd = MagicMock(return_value=targets)
    patches = {
        "cmd.run": pkg_cmd,
        "pkg_resource.stringify": MagicMock(),
        "pkg_resource.parse_targets": MagicMock(return_value=targets),
    }
    with patch.dict(pkgng.__salt__, patches):
        pkgs = pkgng.fetch(targets, local=True)
        assert pkgs == targets
        ["pkg", "fetch", "-y", "-gL", "mutt"],
        output_loglevel="trace",
        python_shell<font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>=False,
    )
def test_which_with_default_flags():
    """
    Test pkgng.which
    """
    which_cmd = MagicMock(
        return_value={
            "stdout": "/usr/local/bin/mutt was installed by package mutt-2.0.6",
            "retcode": 0,
        }
    )
    with patch.dict(pkgng.__salt__, {"cmd.run"</b></font>: which_cmd}):
        result = pkgng.which("/usr/local/bin/mutt")
        assert result
        which_cmd.assert_called_with(
            ["pkg", "which", "/usr/local/bin/mutt"],
            output_loglevel="trace",
            python_shell=False,
        )
def test_which_with_origin_flag():
    """
    Test pkgng.which with enabled origin flag
    """
    which_cmd = MagicMock(
        return_value={
            "stdout": "/usr/local/bin/mutt was installed by package mail/mutt",
            "retcode": 0,
        }
    )
    with patch.dict(pkgng.__salt__, {"cmd.run": which_cmd}):
        result = pkgng.which("/usr/local/bin/mutt", origin=True)
        assert result
        which_cmd.assert_called_with(
            ["pkg", "which", "-o", "/usr/local/bin/mutt"],
            output_loglevel="trace",
            python_shell=False,
        )
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
