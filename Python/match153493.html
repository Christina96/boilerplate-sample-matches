<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for ssh.py & test_cp_1.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for ssh.py & test_cp_1.py
      </h3>
      <h1 align="center">
        2.2%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>ssh.py (34.210526%)<TH>test_cp_1.py (1.1861314%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match153493-0.html#0',2,'match153493-1.html#0',3)" NAME="0">(12-13)<TD><A HREF="javascript:ZweiFrames('match153493-0.html#0',2,'match153493-1.html#0',3)" NAME="0">(48-49)</A><TD ALIGN=center><FONT COLOR="#ff0000">13</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>ssh.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
import re

import salt.utils.files
import salt.utils.stringutils
from salt.exceptions import CommandExecutionError


def key_is_encrypted(key):
<A NAME="0"></A>    # NOTE: this is a temporary workaround until we can get salt/modules/ssh.py
    # working on Windows.
    try:
        <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match153493-1.html#0',3,'match153493-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>with salt.utils.files.fopen(key, &quot;r&quot;) as fp_:
            key_data = salt.utils.stringutils.to_unicode(fp_.read(</B></FONT>))
    except OSError as exc:
        # Raise a CommandExecutionError
        salt.utils.files.process_read_exception(exc, key)

    is_private_key = re.search(r&quot;BEGIN (?:\w+\s)*PRIVATE KEY&quot;, key_data)
    is_encrypted = &quot;ENCRYPTED&quot; in key_data
    del key_data

    if not is_private_key:
        raise CommandExecutionError(&quot;{} is not a private key&quot;.format(key))

    return is_encrypted
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_cp_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
import hashlib
import logging
import os
import shutil
import signal
import tempfile
import textwrap
import time
import uuid

import psutil  # pylint: disable=3rd-party-module-not-gated
import pytest
import salt.utils.files
import salt.utils.path
import salt.utils.platform
import salt.utils.stringutils
from saltfactories.utils.ports import get_unused_localhost_port
from saltfactories.utils.tempfiles import temp_file
from tests.support.case import ModuleCase
from tests.support.helpers import with_tempfile
from tests.support.runtests import RUNTIME_VARS
from tests.support.unit import skipIf

log = logging.getLogger(__name__)


@pytest.mark.windows_whitelisted
class CPModuleTest(ModuleCase):
    &quot;&quot;&quot;
    Validate the cp module
    &quot;&quot;&quot;

    def run_function(self, *args, **kwargs):  # pylint: disable=arguments-differ
        &quot;&quot;&quot;
        Ensure that results are decoded

        TODO: maybe move this behavior to ModuleCase itself?
        &quot;&quot;&quot;
        return salt.utils.data.decode(super().run_function(*args, **kwargs))

    @with_tempfile()
    @pytest.mark.slow_test
    def test_get_file(self, tgt):
        &quot;&quot;&quot;
<A NAME="0"></A>        cp.get_file
        &quot;&quot;&quot;
        self.run_function(&quot;cp.get_file&quot;, [&quot;salt://grail/scene33&quot;, tgt])
        <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match153493-0.html#0',2,'match153493-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>with salt.utils.files.fopen(tgt, &quot;r&quot;) as scene:
            data = salt.utils.stringutils.to_unicode(scene.read(</B></FONT>))
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, data)
        self.assertNotIn(&quot;bacon&quot;, data)

    @pytest.mark.slow_test
    def test_get_file_to_dir(self):
        &quot;&quot;&quot;
        cp.get_file
        &quot;&quot;&quot;
        tgt = os.path.join(RUNTIME_VARS.TMP, &quot;&quot;)
        self.run_function(&quot;cp.get_file&quot;, [&quot;salt://grail/scene33&quot;, tgt])
        with salt.utils.files.fopen(tgt + &quot;scene33&quot;, &quot;r&quot;) as scene:
            data = salt.utils.stringutils.to_unicode(scene.read())
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, data)
        self.assertNotIn(&quot;bacon&quot;, data)

    @with_tempfile()
    @skipIf(
        salt.utils.platform.is_windows(),
        &quot;This test hangs on Windows on Py3&quot;,
    )
    def test_get_file_templated_paths(self, tgt):
        &quot;&quot;&quot;
        cp.get_file
        &quot;&quot;&quot;
        self.run_function(
            &quot;cp.get_file&quot;,
            [
                &quot;salt://{{grains.test_grain}}&quot;,
                tgt.replace(&quot;cheese&quot;, &quot;{{grains.test_grain}}&quot;),
            ],
            template=&quot;jinja&quot;,
        )
        with salt.utils.files.fopen(tgt, &quot;r&quot;) as cheese:
            data = salt.utils.stringutils.to_unicode(cheese.read())
        self.assertIn(&quot;Gromit&quot;, data)
        self.assertNotIn(&quot;bacon&quot;, data)

    @with_tempfile()
    @pytest.mark.slow_test
    def test_get_file_gzipped(self, tgt):
        &quot;&quot;&quot;
        cp.get_file
        &quot;&quot;&quot;
        src = os.path.join(RUNTIME_VARS.FILES, &quot;file&quot;, &quot;base&quot;, &quot;file.big&quot;)
        with salt.utils.files.fopen(src, &quot;rb&quot;) as fp_:
            hash_str = hashlib.md5(fp_.read()).hexdigest()

        self.run_function(&quot;cp.get_file&quot;, [&quot;salt://file.big&quot;, tgt], gzip=5)
        with salt.utils.files.fopen(tgt, &quot;rb&quot;) as scene:
            data = scene.read()
        self.assertEqual(hash_str, hashlib.md5(data).hexdigest())
        data = salt.utils.stringutils.to_unicode(data)
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, data)
        self.assertNotIn(&quot;bacon&quot;, data)

    @pytest.mark.slow_test
    def test_get_file_makedirs(self):
        &quot;&quot;&quot;
        cp.get_file
        &quot;&quot;&quot;
        tgt = os.path.join(RUNTIME_VARS.TMP, &quot;make&quot;, &quot;dirs&quot;, &quot;scene33&quot;)
        self.run_function(&quot;cp.get_file&quot;, [&quot;salt://grail/scene33&quot;, tgt], makedirs=True)
        self.addCleanup(
            shutil.rmtree, os.path.join(RUNTIME_VARS.TMP, &quot;make&quot;), ignore_errors=True
        )
        with salt.utils.files.fopen(tgt, &quot;r&quot;) as scene:
            data = salt.utils.stringutils.to_unicode(scene.read())
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, data)
        self.assertNotIn(&quot;bacon&quot;, data)

    @with_tempfile()
    @pytest.mark.slow_test
    def test_get_template(self, tgt):
        &quot;&quot;&quot;
        cp.get_template
        &quot;&quot;&quot;
        self.run_function(
            &quot;cp.get_template&quot;, [&quot;salt://grail/scene33&quot;, tgt], spam=&quot;bacon&quot;
        )
        with salt.utils.files.fopen(tgt, &quot;r&quot;) as scene:
            data = salt.utils.stringutils.to_unicode(scene.read())
        self.assertIn(&quot;bacon&quot;, data)
        self.assertNotIn(&quot;spam&quot;, data)

    @pytest.mark.slow_test
    def test_get_dir(self):
        &quot;&quot;&quot;
        cp.get_dir
        &quot;&quot;&quot;
        tgt = os.path.join(RUNTIME_VARS.TMP, &quot;many&quot;)
        self.run_function(&quot;cp.get_dir&quot;, [&quot;salt://grail&quot;, tgt])
        self.assertIn(&quot;grail&quot;, os.listdir(tgt))
        self.assertIn(&quot;36&quot;, os.listdir(os.path.join(tgt, &quot;grail&quot;)))
        self.assertIn(&quot;empty&quot;, os.listdir(os.path.join(tgt, &quot;grail&quot;)))
        self.assertIn(&quot;scene&quot;, os.listdir(os.path.join(tgt, &quot;grail&quot;, &quot;36&quot;)))

    @pytest.mark.slow_test
    def test_get_dir_templated_paths(self):
        &quot;&quot;&quot;
        cp.get_dir
        &quot;&quot;&quot;
        tgt = os.path.join(RUNTIME_VARS.TMP, &quot;many&quot;)
        self.run_function(
            &quot;cp.get_dir&quot;,
            [&quot;salt://{{grains.script}}&quot;, tgt.replace(&quot;many&quot;, &quot;{{grains.alot}}&quot;)],
        )
        self.assertIn(&quot;grail&quot;, os.listdir(tgt))
        self.assertIn(&quot;36&quot;, os.listdir(os.path.join(tgt, &quot;grail&quot;)))
        self.assertIn(&quot;empty&quot;, os.listdir(os.path.join(tgt, &quot;grail&quot;)))
        self.assertIn(&quot;scene&quot;, os.listdir(os.path.join(tgt, &quot;grail&quot;, &quot;36&quot;)))

    # cp.get_url tests

    @with_tempfile()
    @pytest.mark.slow_test
    def test_get_url(self, tgt):
        &quot;&quot;&quot;
        cp.get_url with salt:// source given
        &quot;&quot;&quot;
        self.run_function(&quot;cp.get_url&quot;, [&quot;salt://grail/scene33&quot;, tgt])
        with salt.utils.files.fopen(tgt, &quot;r&quot;) as scene:
            data = salt.utils.stringutils.to_unicode(scene.read())
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, data)
        self.assertNotIn(&quot;bacon&quot;, data)

    @pytest.mark.slow_test
    def test_get_url_makedirs(self):
        &quot;&quot;&quot;
        cp.get_url
        &quot;&quot;&quot;
        tgt = os.path.join(RUNTIME_VARS.TMP, &quot;make&quot;, &quot;dirs&quot;, &quot;scene33&quot;)
        self.run_function(&quot;cp.get_url&quot;, [&quot;salt://grail/scene33&quot;, tgt], makedirs=True)
        self.addCleanup(
            shutil.rmtree, os.path.join(RUNTIME_VARS.TMP, &quot;make&quot;), ignore_errors=True
        )
        with salt.utils.files.fopen(tgt, &quot;r&quot;) as scene:
            data = salt.utils.stringutils.to_unicode(scene.read())
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, data)
        self.assertNotIn(&quot;bacon&quot;, data)

    @pytest.mark.slow_test
    def test_get_url_dest_empty(self):
        &quot;&quot;&quot;
        cp.get_url with salt:// source given and destination omitted.
        &quot;&quot;&quot;
        ret = self.run_function(&quot;cp.get_url&quot;, [&quot;salt://grail/scene33&quot;])
        with salt.utils.files.fopen(ret, &quot;r&quot;) as scene:
            data = salt.utils.stringutils.to_unicode(scene.read())
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, data)
        self.assertNotIn(&quot;bacon&quot;, data)

    @pytest.mark.slow_test
    def test_get_url_no_dest(self):
        &quot;&quot;&quot;
        cp.get_url with salt:// source given and destination set as None
        &quot;&quot;&quot;
        tgt = None
        ret = self.run_function(&quot;cp.get_url&quot;, [&quot;salt://grail/scene33&quot;, tgt])
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, ret)

    @pytest.mark.slow_test
    def test_get_url_nonexistent_source(self):
        &quot;&quot;&quot;
        cp.get_url with nonexistent salt:// source given
        &quot;&quot;&quot;
        tgt = None
        ret = self.run_function(&quot;cp.get_url&quot;, [&quot;salt://grail/nonexistent_scene&quot;, tgt])
        self.assertEqual(ret, False)

    @pytest.mark.slow_test
    def test_get_url_to_dir(self):
        &quot;&quot;&quot;
        cp.get_url with salt:// source
        &quot;&quot;&quot;
        tgt = os.path.join(RUNTIME_VARS.TMP, &quot;&quot;)
        self.run_function(&quot;cp.get_url&quot;, [&quot;salt://grail/scene33&quot;, tgt])
        with salt.utils.files.fopen(tgt + &quot;scene33&quot;, &quot;r&quot;) as scene:
            data = salt.utils.stringutils.to_unicode(scene.read())
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, data)
        self.assertNotIn(&quot;bacon&quot;, data)

    @with_tempfile()
    @pytest.mark.slow_test
    def test_get_url_https(self, tgt):
        &quot;&quot;&quot;
        cp.get_url with https:// source given
        &quot;&quot;&quot;
        self.run_function(&quot;cp.get_url&quot;, [&quot;https://repo.saltproject.io/index.html&quot;, tgt])
        with salt.utils.files.fopen(tgt, &quot;r&quot;) as instructions:
            data = salt.utils.stringutils.to_unicode(instructions.read())
        self.assertIn(&quot;Bootstrap&quot;, data)
        self.assertIn(&quot;Debian&quot;, data)
        self.assertIn(&quot;Windows&quot;, data)
        self.assertNotIn(&quot;AYBABTU&quot;, data)

    @pytest.mark.slow_test
    def test_get_url_https_dest_empty(self):
        &quot;&quot;&quot;
        cp.get_url with https:// source given and destination omitted.
        &quot;&quot;&quot;
        ret = self.run_function(
            &quot;cp.get_url&quot;, [&quot;https://repo.saltproject.io/index.html&quot;]
        )

        with salt.utils.files.fopen(ret, &quot;r&quot;) as instructions:
            data = salt.utils.stringutils.to_unicode(instructions.read())
        self.assertIn(&quot;Bootstrap&quot;, data)
        self.assertIn(&quot;Debian&quot;, data)
        self.assertIn(&quot;Windows&quot;, data)
        self.assertNotIn(&quot;AYBABTU&quot;, data)

    @pytest.mark.slow_test
    def test_get_url_https_no_dest(self):
        &quot;&quot;&quot;
        cp.get_url with https:// source given and destination set as None
        &quot;&quot;&quot;
        timeout = 500
        start = time.time()
        sleep = 5
        tgt = None
        while time.time() - start &lt;= timeout:
            ret = self.run_function(
                &quot;cp.get_url&quot;, [&quot;https://repo.saltproject.io/index.html&quot;, tgt]
            )
            if ret.find(&quot;HTTP 599&quot;) == -1:
                break
            time.sleep(sleep)
        if ret.find(&quot;HTTP 599&quot;) != -1:
            raise Exception(&quot;https://repo.saltproject.io/index.html returned 599 error&quot;)
        self.assertIn(&quot;Bootstrap&quot;, ret)
        self.assertIn(&quot;Debian&quot;, ret)
        self.assertIn(&quot;Windows&quot;, ret)
        self.assertNotIn(&quot;AYBABTU&quot;, ret)

    @pytest.mark.slow_test
    def test_get_url_file(self):
        &quot;&quot;&quot;
        cp.get_url with file:// source given
        &quot;&quot;&quot;
        tgt = &quot;&quot;
        src = os.path.join(&quot;file://&quot;, RUNTIME_VARS.FILES, &quot;file&quot;, &quot;base&quot;, &quot;file.big&quot;)
        ret = self.run_function(&quot;cp.get_url&quot;, [src, tgt])
        with salt.utils.files.fopen(ret, &quot;r&quot;) as scene:
            data = salt.utils.stringutils.to_unicode(scene.read())
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, data)
        self.assertNotIn(&quot;bacon&quot;, data)

    @pytest.mark.slow_test
    def test_get_url_file_no_dest(self):
        &quot;&quot;&quot;
        cp.get_url with file:// source given and destination set as None
        &quot;&quot;&quot;
        tgt = None
        src = os.path.join(&quot;file://&quot;, RUNTIME_VARS.FILES, &quot;file&quot;, &quot;base&quot;, &quot;file.big&quot;)
        ret = self.run_function(&quot;cp.get_url&quot;, [src, tgt])
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, ret)
        self.assertNotIn(&quot;bacon&quot;, ret)

    @with_tempfile()
    @pytest.mark.slow_test
    def test_get_url_ftp(self, tgt):
        &quot;&quot;&quot;
        cp.get_url with https:// source given
        &quot;&quot;&quot;
        self.run_function(
            &quot;cp.get_url&quot;,
            [
                &quot;ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/12.0-RELEASE/MANIFEST&quot;,
                tgt,
            ],
        )
        with salt.utils.files.fopen(tgt, &quot;r&quot;) as instructions:
            data = salt.utils.stringutils.to_unicode(instructions.read())
        self.assertIn(&quot;Base system&quot;, data)

    # cp.get_file_str tests

    @pytest.mark.slow_test
    def test_get_file_str_salt(self):
        &quot;&quot;&quot;
        cp.get_file_str with salt:// source given
        &quot;&quot;&quot;
        src = &quot;salt://grail/scene33&quot;
        ret = self.run_function(&quot;cp.get_file_str&quot;, [src])
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, ret)

    @pytest.mark.slow_test
    def test_get_file_str_nonexistent_source(self):
        &quot;&quot;&quot;
        cp.get_file_str with nonexistent salt:// source given
        &quot;&quot;&quot;
        src = &quot;salt://grail/nonexistent_scene&quot;
        ret = self.run_function(&quot;cp.get_file_str&quot;, [src])
        self.assertEqual(ret, False)

    @pytest.mark.slow_test
    def test_get_file_str_https(self):
        &quot;&quot;&quot;
        cp.get_file_str with https:// source given
        &quot;&quot;&quot;
        src = &quot;https://repo.saltproject.io/index.html&quot;
        ret = self.run_function(&quot;cp.get_file_str&quot;, [src])
        self.assertIn(&quot;Bootstrap&quot;, ret)
        self.assertIn(&quot;Debian&quot;, ret)
        self.assertIn(&quot;Windows&quot;, ret)
        self.assertNotIn(&quot;AYBABTU&quot;, ret)

    @pytest.mark.slow_test
    def test_get_file_str_local(self):
        &quot;&quot;&quot;
        cp.get_file_str with file:// source given
        &quot;&quot;&quot;
        src = os.path.join(&quot;file://&quot;, RUNTIME_VARS.FILES, &quot;file&quot;, &quot;base&quot;, &quot;file.big&quot;)
        ret = self.run_function(&quot;cp.get_file_str&quot;, [src])
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, ret)
        self.assertNotIn(&quot;bacon&quot;, ret)

    # caching tests

    @pytest.mark.slow_test
    def test_cache_file(self):
        &quot;&quot;&quot;
        cp.cache_file
        &quot;&quot;&quot;
        ret = self.run_function(&quot;cp.cache_file&quot;, [&quot;salt://grail/scene33&quot;])
        with salt.utils.files.fopen(ret, &quot;r&quot;) as scene:
            data = salt.utils.stringutils.to_unicode(scene.read())
        self.assertIn(&quot;KNIGHT:  They're nervous, sire.&quot;, data)
        self.assertNotIn(&quot;bacon&quot;, data)

    @pytest.mark.slow_test
    def test_cache_files(self):
        &quot;&quot;&quot;
        cp.cache_files
        &quot;&quot;&quot;
        ret = self.run_function(
            &quot;cp.cache_files&quot;, [[&quot;salt://grail/scene33&quot;, &quot;salt://grail/36/scene&quot;]]
        )
        for path in ret:
            with salt.utils.files.fopen(path, &quot;r&quot;) as scene:
                data = salt.utils.stringutils.to_unicode(scene.read())
            self.assertIn(&quot;ARTHUR:&quot;, data)
            self.assertNotIn(&quot;bacon&quot;, data)

    @with_tempfile()
    @pytest.mark.slow_test
    def test_cache_master(self, tgt):
        &quot;&quot;&quot;
        cp.cache_master
        &quot;&quot;&quot;
        ret = self.run_function(
            &quot;cp.cache_master&quot;,
            [tgt],
        )
        for path in ret:
            self.assertTrue(os.path.exists(path))

    @pytest.mark.slow_test
    def test_cache_local_file(self):
        &quot;&quot;&quot;
        cp.cache_local_file
        &quot;&quot;&quot;
        src = os.path.join(RUNTIME_VARS.TMP, &quot;random&quot;)
        with salt.utils.files.fopen(src, &quot;w+&quot;) as fn_:
            fn_.write(salt.utils.stringutils.to_str(&quot;foo&quot;))
        ret = self.run_function(&quot;cp.cache_local_file&quot;, [src])
        with salt.utils.files.fopen(ret, &quot;r&quot;) as cp_:
            self.assertEqual(salt.utils.stringutils.to_unicode(cp_.read()), &quot;foo&quot;)

    @skipIf(not salt.utils.path.which(&quot;nginx&quot;), &quot;nginx not installed&quot;)
    @pytest.mark.slow_test
    @pytest.mark.skip_if_not_root
    def test_cache_remote_file(self):
        &quot;&quot;&quot;
        cp.cache_file
        &quot;&quot;&quot;
        nginx_port = get_unused_localhost_port()
        url_prefix = &quot;http://localhost:{}/&quot;.format(nginx_port)
        temp_dir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)
        self.addCleanup(shutil.rmtree, temp_dir, ignore_errors=True)
        nginx_root_dir = os.path.join(temp_dir, &quot;root&quot;)
        nginx_conf_dir = os.path.join(temp_dir, &quot;conf&quot;)
        nginx_conf = os.path.join(nginx_conf_dir, &quot;nginx.conf&quot;)
        nginx_pidfile = os.path.join(nginx_conf_dir, &quot;nginx.pid&quot;)
        file_contents = &quot;Hello world!&quot;

        for dirname in (nginx_root_dir, nginx_conf_dir):
            os.makedirs(dirname)

        # Write the temp file
        with salt.utils.files.fopen(
            os.path.join(nginx_root_dir, &quot;actual_file&quot;), &quot;w&quot;
        ) as fp_:
            fp_.write(salt.utils.stringutils.to_str(file_contents))

        # Write the nginx config
        with salt.utils.files.fopen(nginx_conf, &quot;w&quot;) as fp_:
            fp_.write(
                textwrap.dedent(
                    salt.utils.stringutils.to_str(
                        &quot;&quot;&quot;\
                user root;
                worker_processes 1;
                error_log {nginx_conf_dir}/server_error.log;
                pid {nginx_pidfile};

                events {{
                    worker_connections 1024;
                }}

                http {{
                    include       /etc/nginx/mime.types;
                    default_type  application/octet-stream;

                    access_log {nginx_conf_dir}/access.log;
                    error_log {nginx_conf_dir}/error.log;

                    server {{
                        listen {nginx_port} default_server;
                        server_name cachefile.local;
                        root {nginx_root_dir};

                        location ~ ^/301$ {{
                            return 301 /actual_file;
                        }}

                        location ~ ^/302$ {{
                            return 302 /actual_file;
                        }}
                    }}
                }}&quot;&quot;&quot;.format(
                            **locals()
                        )
                    )
                )
            )

        self.run_function(&quot;cmd.run&quot;, [[&quot;nginx&quot;, &quot;-c&quot;, nginx_conf]], python_shell=False)
        with salt.utils.files.fopen(nginx_pidfile) as fp_:
            nginx_pid = int(fp_.read().strip())
            nginx_proc = psutil.Process(pid=nginx_pid)
            self.addCleanup(nginx_proc.send_signal, signal.SIGQUIT)

        for code in (&quot;&quot;, &quot;301&quot;, &quot;302&quot;):
            url = url_prefix + (code or &quot;actual_file&quot;)
            log.debug(&quot;attempting to cache %s&quot;, url)
            ret = self.run_function(&quot;cp.cache_file&quot;, [url])
            self.assertTrue(ret)
            with salt.utils.files.fopen(ret) as fp_:
                cached_contents = salt.utils.stringutils.to_unicode(fp_.read())
                self.assertEqual(cached_contents, file_contents)

    @pytest.mark.slow_test
    def test_list_states(self):
        &quot;&quot;&quot;
        cp.list_states
        &quot;&quot;&quot;
        top_sls = &quot;&quot;&quot;
        base:
          '*':
            - core
            &quot;&quot;&quot;

        core_state = &quot;&quot;&quot;
        {}/testfile:
          file:
            - managed
            - source: salt://testfile
            - makedirs: true
            &quot;&quot;&quot;.format(
            RUNTIME_VARS.TMP
        )

        with temp_file(
            &quot;top.sls&quot;, top_sls, RUNTIME_VARS.TMP_BASEENV_STATE_TREE
        ), temp_file(&quot;core.sls&quot;, core_state, RUNTIME_VARS.TMP_BASEENV_STATE_TREE):
            ret = self.run_function(
                &quot;cp.list_states&quot;,
            )
            self.assertIn(&quot;core&quot;, ret)
            self.assertIn(&quot;top&quot;, ret)

    @pytest.mark.slow_test
    def test_list_minion(self):
        &quot;&quot;&quot;
        cp.list_minion
        &quot;&quot;&quot;
        self.run_function(&quot;cp.cache_file&quot;, [&quot;salt://grail/scene33&quot;])
        ret = self.run_function(&quot;cp.list_minion&quot;)
        found = False
        search = &quot;grail/scene33&quot;
        if salt.utils.platform.is_windows():
            search = r&quot;grail\scene33&quot;
        for path in ret:
            if search in path:
                found = True
                break
        self.assertTrue(found)

    @pytest.mark.slow_test
    def test_is_cached(self):
        &quot;&quot;&quot;
        cp.is_cached
        &quot;&quot;&quot;
        self.run_function(&quot;cp.cache_file&quot;, [&quot;salt://grail/scene33&quot;])
        ret1 = self.run_function(&quot;cp.is_cached&quot;, [&quot;salt://grail/scene33&quot;])
        self.assertTrue(ret1)
        ret2 = self.run_function(&quot;cp.is_cached&quot;, [&quot;salt://fasldkgj/poicxzbn&quot;])
        self.assertFalse(ret2)

    @pytest.mark.slow_test
    def test_hash_file(self):
        &quot;&quot;&quot;
        cp.hash_file
        &quot;&quot;&quot;
        sha256_hash = self.run_function(&quot;cp.hash_file&quot;, [&quot;salt://grail/scene33&quot;])
        path = self.run_function(&quot;cp.cache_file&quot;, [&quot;salt://grail/scene33&quot;])
        with salt.utils.files.fopen(path, &quot;rb&quot;) as fn_:
            data = fn_.read()
            self.assertEqual(sha256_hash[&quot;hsum&quot;], hashlib.sha256(data).hexdigest())

    @with_tempfile()
    @pytest.mark.slow_test
    def test_get_file_from_env_predefined(self, tgt):
        &quot;&quot;&quot;
        cp.get_file
        &quot;&quot;&quot;
        tgt = os.path.join(RUNTIME_VARS.TMP, &quot;cheese&quot;)
        try:
            self.run_function(&quot;cp.get_file&quot;, [&quot;salt://cheese&quot;, tgt])
            with salt.utils.files.fopen(tgt, &quot;r&quot;) as cheese:
                data = salt.utils.stringutils.to_unicode(cheese.read())
            self.assertIn(&quot;Gromit&quot;, data)
            self.assertNotIn(&quot;Comte&quot;, data)
        finally:
            os.unlink(tgt)

    @with_tempfile()
    @pytest.mark.slow_test
    def test_get_file_from_env_in_url(self, tgt):
        tgt = os.path.join(RUNTIME_VARS.TMP, &quot;cheese&quot;)
        try:
            self.run_function(&quot;cp.get_file&quot;, [&quot;salt://cheese?saltenv=prod&quot;, tgt])
            with salt.utils.files.fopen(tgt, &quot;r&quot;) as cheese:
                data = salt.utils.stringutils.to_unicode(cheese.read())
            self.assertIn(&quot;Gromit&quot;, data)
            self.assertIn(&quot;Comte&quot;, data)
        finally:
            os.unlink(tgt)

    @pytest.mark.slow_test
    def test_push(self):
        log_to_xfer = os.path.join(RUNTIME_VARS.TMP, uuid.uuid4().hex)
        open(log_to_xfer, &quot;w&quot;).close()  # pylint: disable=resource-leakage
        try:
            self.run_function(&quot;cp.push&quot;, [log_to_xfer])
            tgt_cache_file = os.path.join(
                RUNTIME_VARS.TMP,
                &quot;master-minion-root&quot;,
                &quot;cache&quot;,
                &quot;minions&quot;,
                &quot;minion&quot;,
                &quot;files&quot;,
                RUNTIME_VARS.TMP,
                log_to_xfer,
            )
            self.assertTrue(
                os.path.isfile(tgt_cache_file), &quot;File was not cached on the master&quot;
            )
        finally:
            os.unlink(tgt_cache_file)

    @pytest.mark.slow_test
    def test_envs(self):
        self.assertEqual(sorted(self.run_function(&quot;cp.envs&quot;)), sorted([&quot;base&quot;, &quot;prod&quot;]))
</PRE>
</div>
  </div>
</body>
</html>
