<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for ssh.py &amp; test_cp_1.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for ssh.py &amp; test_cp_1.py
      </h3>
<h1 align="center">
        2.2%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>ssh.py (34.210526%)<th>test_cp_1.py (1.1861314%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(12-13)<td><a href="#" name="0">(48-49)</a><td align="center"><font color="#ff0000">13</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>ssh.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import re
2 import salt.utils.files
3 import salt.utils.stringutils
4 from salt.exceptions import CommandExecutionError
5 def key_is_encrypted(key):
6     try:
7         <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>with salt.utils.files.fopen(key, "r") as fp_:
8             key_data = salt.utils.stringutils.to_unicode(fp_.read(</b></font>))
9     except OSError as exc:
10         salt.utils.files.process_read_exception(exc, key)
11     is_private_key = re.search(r"BEGIN (?:\w+\s)*PRIVATE KEY", key_data)
12     is_encrypted = "ENCRYPTED" in key_data
13     del key_data
14     if not is_private_key:
15         raise CommandExecutionError("{} is not a private key".format(key))
16     return is_encrypted
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_cp_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import hashlib
2 import logging
3 import os
4 import shutil
5 import signal
6 import tempfile
7 import textwrap
8 import time
9 import uuid
10 import psutil  # pylint: disable=3rd-party-module-not-gated
11 import pytest
12 import salt.utils.files
13 import salt.utils.path
14 import salt.utils.platform
15 import salt.utils.stringutils
16 from saltfactories.utils.ports import get_unused_localhost_port
17 from saltfactories.utils.tempfiles import temp_file
18 from tests.support.case import ModuleCase
19 from tests.support.helpers import with_tempfile
20 from tests.support.runtests import RUNTIME_VARS
21 from tests.support.unit import skipIf
22 log = logging.getLogger(__name__)
23 @pytest.mark.windows_whitelisted
24 class CPModuleTest(ModuleCase):
25     def run_function(self, *args, **kwargs):  # pylint: disable=arguments-differ
26         return salt.utils.data.decode(super().run_function(*args, **kwargs))
27     @with_tempfile()
28     @pytest.mark.slow_test
29     def test_get_file(self, tgt):
30         self.run_function("cp.get_file", ["salt://grail/scene33", tgt])
31         <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>with salt.utils.files.fopen(tgt, "r") as scene:
32             data = salt.utils.stringutils.to_unicode(scene.read(</b></font>))
33         self.assertIn("KNIGHT:  They're nervous, sire.", data)
34         self.assertNotIn("bacon", data)
35     @pytest.mark.slow_test
36     def test_get_file_to_dir(self):
37         tgt = os.path.join(RUNTIME_VARS.TMP, "")
38         self.run_function("cp.get_file", ["salt://grail/scene33", tgt])
39         with salt.utils.files.fopen(tgt + "scene33", "r") as scene:
40             data = salt.utils.stringutils.to_unicode(scene.read())
41         self.assertIn("KNIGHT:  They're nervous, sire.", data)
42         self.assertNotIn("bacon", data)
43     @with_tempfile()
44     @skipIf(
45         salt.utils.platform.is_windows(),
46         "This test hangs on Windows on Py3",
47     )
48     def test_get_file_templated_paths(self, tgt):
49         self.run_function(
50             "cp.get_file",
51             [
52                 "salt://{{grains.test_grain}}",
53                 tgt.replace("cheese", "{{grains.test_grain}}"),
54             ],
55             template="jinja",
56         )
57         with salt.utils.files.fopen(tgt, "r") as cheese:
58             data = salt.utils.stringutils.to_unicode(cheese.read())
59         self.assertIn("Gromit", data)
60         self.assertNotIn("bacon", data)
61     @with_tempfile()
62     @pytest.mark.slow_test
63     def test_get_file_gzipped(self, tgt):
64         src = os.path.join(RUNTIME_VARS.FILES, "file", "base", "file.big")
65         with salt.utils.files.fopen(src, "rb") as fp_:
66             hash_str = hashlib.md5(fp_.read()).hexdigest()
67         self.run_function("cp.get_file", ["salt://file.big", tgt], gzip=5)
68         with salt.utils.files.fopen(tgt, "rb") as scene:
69             data = scene.read()
70         self.assertEqual(hash_str, hashlib.md5(data).hexdigest())
71         data = salt.utils.stringutils.to_unicode(data)
72         self.assertIn("KNIGHT:  They're nervous, sire.", data)
73         self.assertNotIn("bacon", data)
74     @pytest.mark.slow_test
75     def test_get_file_makedirs(self):
76         tgt = os.path.join(RUNTIME_VARS.TMP, "make", "dirs", "scene33")
77         self.run_function("cp.get_file", ["salt://grail/scene33", tgt], makedirs=True)
78         self.addCleanup(
79             shutil.rmtree, os.path.join(RUNTIME_VARS.TMP, "make"), ignore_errors=True
80         )
81         with salt.utils.files.fopen(tgt, "r") as scene:
82             data = salt.utils.stringutils.to_unicode(scene.read())
83         self.assertIn("KNIGHT:  They're nervous, sire.", data)
84         self.assertNotIn("bacon", data)
85     @with_tempfile()
86     @pytest.mark.slow_test
87     def test_get_template(self, tgt):
88         self.run_function(
89             "cp.get_template", ["salt://grail/scene33", tgt], spam="bacon"
90         )
91         with salt.utils.files.fopen(tgt, "r") as scene:
92             data = salt.utils.stringutils.to_unicode(scene.read())
93         self.assertIn("bacon", data)
94         self.assertNotIn("spam", data)
95     @pytest.mark.slow_test
96     def test_get_dir(self):
97         tgt = os.path.join(RUNTIME_VARS.TMP, "many")
98         self.run_function("cp.get_dir", ["salt://grail", tgt])
99         self.assertIn("grail", os.listdir(tgt))
100         self.assertIn("36", os.listdir(os.path.join(tgt, "grail")))
101         self.assertIn("empty", os.listdir(os.path.join(tgt, "grail")))
102         self.assertIn("scene", os.listdir(os.path.join(tgt, "grail", "36")))
103     @pytest.mark.slow_test
104     def test_get_dir_templated_paths(self):
105         tgt = os.path.join(RUNTIME_VARS.TMP, "many")
106         self.run_function(
107             "cp.get_dir",
108             ["salt://{{grains.script}}", tgt.replace("many", "{{grains.alot}}")],
109         )
110         self.assertIn("grail", os.listdir(tgt))
111         self.assertIn("36", os.listdir(os.path.join(tgt, "grail")))
112         self.assertIn("empty", os.listdir(os.path.join(tgt, "grail")))
113         self.assertIn("scene", os.listdir(os.path.join(tgt, "grail", "36")))
114     @with_tempfile()
115     @pytest.mark.slow_test
116     def test_get_url(self, tgt):
117         self.run_function("cp.get_url", ["salt://grail/scene33", tgt])
118         with salt.utils.files.fopen(tgt, "r") as scene:
119             data = salt.utils.stringutils.to_unicode(scene.read())
120         self.assertIn("KNIGHT:  They're nervous, sire.", data)
121         self.assertNotIn("bacon", data)
122     @pytest.mark.slow_test
123     def test_get_url_makedirs(self):
124         tgt = os.path.join(RUNTIME_VARS.TMP, "make", "dirs", "scene33")
125         self.run_function("cp.get_url", ["salt://grail/scene33", tgt], makedirs=True)
126         self.addCleanup(
127             shutil.rmtree, os.path.join(RUNTIME_VARS.TMP, "make"), ignore_errors=True
128         )
129         with salt.utils.files.fopen(tgt, "r") as scene:
130             data = salt.utils.stringutils.to_unicode(scene.read())
131         self.assertIn("KNIGHT:  They're nervous, sire.", data)
132         self.assertNotIn("bacon", data)
133     @pytest.mark.slow_test
134     def test_get_url_dest_empty(self):
135         ret = self.run_function("cp.get_url", ["salt://grail/scene33"])
136         with salt.utils.files.fopen(ret, "r") as scene:
137             data = salt.utils.stringutils.to_unicode(scene.read())
138         self.assertIn("KNIGHT:  They're nervous, sire.", data)
139         self.assertNotIn("bacon", data)
140     @pytest.mark.slow_test
141     def test_get_url_no_dest(self):
142         tgt = None
143         ret = self.run_function("cp.get_url", ["salt://grail/scene33", tgt])
144         self.assertIn("KNIGHT:  They're nervous, sire.", ret)
145     @pytest.mark.slow_test
146     def test_get_url_nonexistent_source(self):
147         tgt = None
148         ret = self.run_function("cp.get_url", ["salt://grail/nonexistent_scene", tgt])
149         self.assertEqual(ret, False)
150     @pytest.mark.slow_test
151     def test_get_url_to_dir(self):
152         tgt = os.path.join(RUNTIME_VARS.TMP, "")
153         self.run_function("cp.get_url", ["salt://grail/scene33", tgt])
154         with salt.utils.files.fopen(tgt + "scene33", "r") as scene:
155             data = salt.utils.stringutils.to_unicode(scene.read())
156         self.assertIn("KNIGHT:  They're nervous, sire.", data)
157         self.assertNotIn("bacon", data)
158     @with_tempfile()
159     @pytest.mark.slow_test
160     def test_get_url_https(self, tgt):
161         self.run_function("cp.get_url", ["https://repo.saltproject.io/index.html", tgt])
162         with salt.utils.files.fopen(tgt, "r") as instructions:
163             data = salt.utils.stringutils.to_unicode(instructions.read())
164         self.assertIn("Bootstrap", data)
165         self.assertIn("Debian", data)
166         self.assertIn("Windows", data)
167         self.assertNotIn("AYBABTU", data)
168     @pytest.mark.slow_test
169     def test_get_url_https_dest_empty(self):
170         ret = self.run_function(
171             "cp.get_url", ["https://repo.saltproject.io/index.html"]
172         )
173         with salt.utils.files.fopen(ret, "r") as instructions:
174             data = salt.utils.stringutils.to_unicode(instructions.read())
175         self.assertIn("Bootstrap", data)
176         self.assertIn("Debian", data)
177         self.assertIn("Windows", data)
178         self.assertNotIn("AYBABTU", data)
179     @pytest.mark.slow_test
180     def test_get_url_https_no_dest(self):
181         timeout = 500
182         start = time.time()
183         sleep = 5
184         tgt = None
185         while time.time() - start &lt;= timeout:
186             ret = self.run_function(
187                 "cp.get_url", ["https://repo.saltproject.io/index.html", tgt]
188             )
189             if ret.find("HTTP 599") == -1:
190                 break
191             time.sleep(sleep)
192         if ret.find("HTTP 599") != -1:
193             raise Exception("https://repo.saltproject.io/index.html returned 599 error")
194         self.assertIn("Bootstrap", ret)
195         self.assertIn("Debian", ret)
196         self.assertIn("Windows", ret)
197         self.assertNotIn("AYBABTU", ret)
198     @pytest.mark.slow_test
199     def test_get_url_file(self):
200         tgt = ""
201         src = os.path.join("file://", RUNTIME_VARS.FILES, "file", "base", "file.big")
202         ret = self.run_function("cp.get_url", [src, tgt])
203         with salt.utils.files.fopen(ret, "r") as scene:
204             data = salt.utils.stringutils.to_unicode(scene.read())
205         self.assertIn("KNIGHT:  They're nervous, sire.", data)
206         self.assertNotIn("bacon", data)
207     @pytest.mark.slow_test
208     def test_get_url_file_no_dest(self):
209         tgt = None
210         src = os.path.join("file://", RUNTIME_VARS.FILES, "file", "base", "file.big")
211         ret = self.run_function("cp.get_url", [src, tgt])
212         self.assertIn("KNIGHT:  They're nervous, sire.", ret)
213         self.assertNotIn("bacon", ret)
214     @with_tempfile()
215     @pytest.mark.slow_test
216     def test_get_url_ftp(self, tgt):
217         self.run_function(
218             "cp.get_url",
219             [
220                 "ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/12.0-RELEASE/MANIFEST",
221                 tgt,
222             ],
223         )
224         with salt.utils.files.fopen(tgt, "r") as instructions:
225             data = salt.utils.stringutils.to_unicode(instructions.read())
226         self.assertIn("Base system", data)
227     @pytest.mark.slow_test
228     def test_get_file_str_salt(self):
229         src = "salt://grail/scene33"
230         ret = self.run_function("cp.get_file_str", [src])
231         self.assertIn("KNIGHT:  They're nervous, sire.", ret)
232     @pytest.mark.slow_test
233     def test_get_file_str_nonexistent_source(self):
234         src = "salt://grail/nonexistent_scene"
235         ret = self.run_function("cp.get_file_str", [src])
236         self.assertEqual(ret, False)
237     @pytest.mark.slow_test
238     def test_get_file_str_https(self):
239         src = "https://repo.saltproject.io/index.html"
240         ret = self.run_function("cp.get_file_str", [src])
241         self.assertIn("Bootstrap", ret)
242         self.assertIn("Debian", ret)
243         self.assertIn("Windows", ret)
244         self.assertNotIn("AYBABTU", ret)
245     @pytest.mark.slow_test
246     def test_get_file_str_local(self):
247         src = os.path.join("file://", RUNTIME_VARS.FILES, "file", "base", "file.big")
248         ret = self.run_function("cp.get_file_str", [src])
249         self.assertIn("KNIGHT:  They're nervous, sire.", ret)
250         self.assertNotIn("bacon", ret)
251     @pytest.mark.slow_test
252     def test_cache_file(self):
253         ret = self.run_function("cp.cache_file", ["salt://grail/scene33"])
254         with salt.utils.files.fopen(ret, "r") as scene:
255             data = salt.utils.stringutils.to_unicode(scene.read())
256         self.assertIn("KNIGHT:  They're nervous, sire.", data)
257         self.assertNotIn("bacon", data)
258     @pytest.mark.slow_test
259     def test_cache_files(self):
260         ret = self.run_function(
261             "cp.cache_files", [["salt://grail/scene33", "salt://grail/36/scene"]]
262         )
263         for path in ret:
264             with salt.utils.files.fopen(path, "r") as scene:
265                 data = salt.utils.stringutils.to_unicode(scene.read())
266             self.assertIn("ARTHUR:", data)
267             self.assertNotIn("bacon", data)
268     @with_tempfile()
269     @pytest.mark.slow_test
270     def test_cache_master(self, tgt):
271         ret = self.run_function(
272             "cp.cache_master",
273             [tgt],
274         )
275         for path in ret:
276             self.assertTrue(os.path.exists(path))
277     @pytest.mark.slow_test
278     def test_cache_local_file(self):
279         src = os.path.join(RUNTIME_VARS.TMP, "random")
280         with salt.utils.files.fopen(src, "w+") as fn_:
281             fn_.write(salt.utils.stringutils.to_str("foo"))
282         ret = self.run_function("cp.cache_local_file", [src])
283         with salt.utils.files.fopen(ret, "r") as cp_:
284             self.assertEqual(salt.utils.stringutils.to_unicode(cp_.read()), "foo")
285     @skipIf(not salt.utils.path.which("nginx"), "nginx not installed")
286     @pytest.mark.slow_test
287     @pytest.mark.skip_if_not_root
288     def test_cache_remote_file(self):
289         nginx_port = get_unused_localhost_port()
290         url_prefix = "http://localhost:{}/".format(nginx_port)
291         temp_dir = tempfile.mkdtemp(dir=RUNTIME_VARS.TMP)
292         self.addCleanup(shutil.rmtree, temp_dir, ignore_errors=True)
293         nginx_root_dir = os.path.join(temp_dir, "root")
294         nginx_conf_dir = os.path.join(temp_dir, "conf")
295         nginx_conf = os.path.join(nginx_conf_dir, "nginx.conf")
296         nginx_pidfile = os.path.join(nginx_conf_dir, "nginx.pid")
297         file_contents = "Hello world!"
298         for dirname in (nginx_root_dir, nginx_conf_dir):
299             os.makedirs(dirname)
300         with salt.utils.files.fopen(
301             os.path.join(nginx_root_dir, "actual_file"), "w"
302         ) as fp_:
303             fp_.write(salt.utils.stringutils.to_str(file_contents))
304         with salt.utils.files.fopen(nginx_conf, "w") as fp_:
305             fp_.write(
306                 textwrap.dedent(
307                     salt.utils.stringutils.to_str(
308         cp.list_states
309         core_state = """
310         {}/testfile:
311           file:
312             - managed
313             - source: salt://testfile
314             - makedirs: true
315         cp.list_minion
316         cp.is_cached
317         cp.hash_file
318         cp.get_file
319         """
320         tgt = os.path.join(RUNTIME_VARS.TMP, "cheese")
321         try:
322             self.run_function("cp.get_file", ["salt://cheese", tgt])
323             with salt.utils.files.fopen(tgt, "r") as cheese:
324                 data = salt.utils.stringutils.to_unicode(cheese.read())
325             self.assertIn("Gromit", data)
326             self.assertNotIn("Comte", data)
327         finally:
328             os.unlink(tgt)
329     @with_tempfile()
330     @pytest.mark.slow_test
331     def test_get_file_from_env_in_url(self, tgt):
332         tgt = os.path.join(RUNTIME_VARS.TMP, "cheese")
333         try:
334             self.run_function("cp.get_file", ["salt://cheese?saltenv=prod", tgt])
335             with salt.utils.files.fopen(tgt, "r") as cheese:
336                 data = salt.utils.stringutils.to_unicode(cheese.read())
337             self.assertIn("Gromit", data)
338             self.assertIn("Comte", data)
339         finally:
340             os.unlink(tgt)
341     @pytest.mark.slow_test
342     def test_push(self):
343         log_to_xfer = os.path.join(RUNTIME_VARS.TMP, uuid.uuid4().hex)
344         open(log_to_xfer, "w").close()  # pylint: disable=resource-leakage
345         try:
346             self.run_function("cp.push", [log_to_xfer])
347             tgt_cache_file = os.path.join(
348                 RUNTIME_VARS.TMP,
349                 "master-minion-root",
350                 "cache",
351                 "minions",
352                 "minion",
353                 "files",
354                 RUNTIME_VARS.TMP,
355                 log_to_xfer,
356             )
357             self.assertTrue(
358                 os.path.isfile(tgt_cache_file), "File was not cached on the master"
359             )
360         finally:
361             os.unlink(tgt_cache_file)
362     @pytest.mark.slow_test
363     def test_envs(self):
364         self.assertEqual(sorted(self.run_function("cp.envs")), sorted(["base", "prod"]))
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
