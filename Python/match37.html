<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_sequence.py &amp; test_tree.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_sequence.py &amp; test_tree.py
      </h3>
<h1 align="center">
        15.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_sequence.py (13.162808%)<th>test_tree.py (19.304491%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(2091-2097)<td><a href="#" name="0">(209-214)</a><td align="center"><font color="#ff0000">21</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(2047-2053)<td><a href="#" name="1">(383-386)</a><td align="center"><font color="#ff0000">21</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(2098-2102)<td><a href="#" name="2">(215-218)</a><td align="center"><font color="#f20000">20</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(2054-2058)<td><a href="#" name="3">(191-194)</a><td align="center"><font color="#f20000">20</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(1380-1384)<td><a href="#" name="4">(1113-1123)</a><td align="center"><font color="#e60000">19</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(1345-1349)<td><a href="#" name="5">(1003-1010)</a><td align="center"><font color="#e60000">19</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(1100-1106)<td><a href="#" name="6">(1073-1082)</a><td align="center"><font color="#ce0000">17</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(2065-2069)<td><a href="#" name="7">(218-221)</a><td align="center"><font color="#c20000">16</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(802-807)<td><a href="#" name="8">(629-633)</a><td align="center"><font color="#c20000">16</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(174-179)<td><a href="#" name="9">(669-676)</a><td align="center"><font color="#c20000">16</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(1825-1827)<td><a href="#" name="10">(198-201)</a><td align="center"><font color="#b60000">15</font>
<tr onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b041ff"><font color="#b041ff">-</font><td><a href="#" name="11">(1371-1376)<td><a href="#" name="11">(778-785)</a><td align="center"><font color="#b60000">15</font>
<tr onclick='openModal("#571b7e")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#571b7e"><font color="#571b7e">-</font><td><a href="#" name="12">(1336-1341)<td><a href="#" name="12">(622-627)</a><td align="center"><font color="#b60000">15</font>
<tr onclick='openModal("#3b9c9c")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3b9c9c"><font color="#3b9c9c">-</font><td><a href="#" name="13">(1080-1086)<td><a href="#" name="13">(975-978)</a><td align="center"><font color="#b60000">15</font>
<tr onclick='openModal("#842dce")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#842dce"><font color="#842dce">-</font><td><a href="#" name="14">(821-826)<td><a href="#" name="14">(1338-1345)</a><td align="center"><font color="#b60000">15</font>
<tr onclick='openModal("#f52887")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f52887"><font color="#f52887">-</font><td><a href="#" name="15">(208-211)<td><a href="#" name="15">(447-451)</a><td align="center"><font color="#b60000">15</font>
<tr onclick='openModal("#2981b2")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#2981b2"><font color="#2981b2">-</font><td><a href="#" name="16">(2115-2122)<td><a href="#" name="16">(725-727)</a><td align="center"><font color="#aa0000">14</font>
<tr onclick='openModal("#3090c7")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3090c7"><font color="#3090c7">-</font><td><a href="#" name="17">(2071-2078)<td><a href="#" name="17">(723-725)</a><td align="center"><font color="#aa0000">14</font>
<tr onclick='openModal("#800517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#800517"><font color="#800517">-</font><td><a href="#" name="18">(1265-1277)<td><a href="#" name="18">(407-412)</a><td align="center"><font color="#aa0000">14</font>
<tr onclick='openModal("#f62817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f62817"><font color="#f62817">-</font><td><a href="#" name="19">(1010-1015)<td><a href="#" name="19">(910-915)</a><td align="center"><font color="#aa0000">14</font>
<tr onclick='openModal("#4e9258")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4e9258"><font color="#4e9258">-</font><td><a href="#" name="20">(773-777)<td><a href="#" name="20">(1380-1385)</a><td align="center"><font color="#aa0000">14</font>
<tr onclick='openModal("#947010")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#947010"><font color="#947010">-</font><td><a href="#" name="21">(411-422)<td><a href="#" name="21">(251-257)</a><td align="center"><font color="#aa0000">14</font>
<tr onclick='openModal("#4cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4cc417"><font color="#4cc417">-</font><td><a href="#" name="22">(2085-2090)<td><a href="#" name="22">(997-999)</a><td align="center"><font color="#9d0000">13</font>
<tr onclick='openModal("#f660ab")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f660ab"><font color="#f660ab">-</font><td><a href="#" name="23">(2041-2046)<td><a href="#" name="23">(843-846)</a><td align="center"><font color="#9d0000">13</font>
<tr onclick='openModal("#79764d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#79764d"><font color="#79764d">-</font><td><a href="#" name="24">(1662-1669)<td><a href="#" name="24">(991-995)</a><td align="center"><font color="#9d0000">13</font>
<tr onclick='openModal("#5eac10")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#5eac10"><font color="#5eac10">-</font><td><a href="#" name="25">(1620-1627)<td><a href="#" name="25">(764-767)</a><td align="center"><font color="#9d0000">13</font>
<tr onclick='openModal("#68818b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#68818b"><font color="#68818b">-</font><td><a href="#" name="26">(1087-1090)<td><a href="#" name="26">(1052-1059)</a><td align="center"><font color="#9d0000">13</font>
<tr onclick='openModal("#e77471")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#e77471"><font color="#e77471">-</font><td><a href="#" name="27">(811-816)<td><a href="#" name="27">(637-639)</a><td align="center"><font color="#9d0000">13</font>
<tr onclick='openModal("#717d7d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#717d7d"><font color="#717d7d">-</font><td><a href="#" name="28">(740-743)<td><a href="#" name="28">(262-266)</a><td align="center"><font color="#9d0000">13</font>
<tr onclick='openModal("#af7a82")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#af7a82"><font color="#af7a82">-</font><td><a href="#" name="29">(530-535)<td><a href="#" name="29">(277-280)</a><td align="center"><font color="#9d0000">13</font>
<tr onclick='openModal("#ae694a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ae694a"><font color="#ae694a">-</font><td><a href="#" name="30">(304-307)<td><a href="#" name="30">(303-306)</a><td align="center"><font color="#9d0000">13</font>
<tr onclick='openModal("#3ea99f")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3ea99f"><font color="#3ea99f">-</font><td><a href="#" name="31">(280-282)<td><a href="#" name="31">(33-36)</a><td align="center"><font color="#9d0000">13</font>
<tr onclick='openModal("#5b8daf")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#5b8daf"><font color="#5b8daf">-</font><td><a href="#" name="32">(2109-2112)<td><a href="#" name="32">(269-272)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#736aff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#736aff"><font color="#736aff">-</font><td><a href="#" name="33">(1930-1935)<td><a href="#" name="33">(1019-1023)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#827d6b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#827d6b"><font color="#827d6b">-</font><td><a href="#" name="34">(1841-1848)<td><a href="#" name="34">(162-167)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#41a317")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#41a317"><font color="#41a317">-</font><td><a href="#" name="35">(1800-1807)<td><a href="#" name="35">(658-662)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#ff00ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ff00ff"><font color="#ff00ff">-</font><td><a href="#" name="36">(1672-1676)<td><a href="#" name="36">(651-655)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#810541")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#810541"><font color="#810541">-</font><td><a href="#" name="37">(1592-1596)<td><a href="#" name="37">(792-796)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#348781")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#348781"><font color="#348781">-</font><td><a href="#" name="38">(1587-1592)<td><a href="#" name="38">(663-666)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#152dc6")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#152dc6"><font color="#152dc6">-</font><td><a href="#" name="39">(1238-1243)<td><a href="#" name="39">(1041-1049)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#347235")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#347235"><font color="#347235">-</font><td><a href="#" name="40">(992-997)<td><a href="#" name="40">(1263-1273)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#f87a17")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f87a17"><font color="#f87a17">-</font><td><a href="#" name="41">(831-834)<td><a href="#" name="41">(643-644)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#c57717")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c57717"><font color="#c57717">-</font><td><a href="#" name="42">(602-612)<td><a href="#" name="42">(891-896)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#c22817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c22817"><font color="#c22817">-</font><td><a href="#" name="43">(515-519)<td><a href="#" name="43">(424-428)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#a057a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#a057a5"><font color="#a057a5">-</font><td><a href="#" name="44">(391-396)<td><a href="#" name="44">(603-608)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#549748")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#549748"><font color="#549748">-</font><td><a href="#" name="45">(327-329)<td><a href="#" name="45">(37-40)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#668b8b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#668b8b"><font color="#668b8b">-</font><td><a href="#" name="46">(262-269)<td><a href="#" name="46">(201-205)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#d16587")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#d16587"><font color="#d16587">-</font><td><a href="#" name="47">(145-150)<td><a href="#" name="47">(420-423)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#c57726")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c57726"><font color="#c57726">-</font><td><a href="#" name="48">(129-134)<td><a href="#" name="48">(413-417)</a><td align="center"><font color="#910000">12</font>
<tr onclick='openModal("#8e35ef")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8e35ef"><font color="#8e35ef">-</font><td><a href="#" name="49">(19-39)<td><a href="#" name="49">(9-27)</a><td align="center"><font color="#910000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_sequence.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import copy
2 import functools
3 import itertools
4 import re
5 from types import GeneratorType
6 from collections.abc import Hashable
7 from unittest import TestCase, main
8 <a name="49"></a>
9 import numpy as np
10 import numpy.testing as npt
11 <font color="#8e35ef"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import pandas as pd
12 import scipy.spatial.distance
13 import skbio.sequence.distance
14 from skbio import Sequence, DNA
15 from skbio.util import assert_data_frame_almost_equal
16 from skbio.sequence._sequence import (_single_index_to_slice, _is_single_index,
17                                       _as_slice_if_single_index)
18 from skbio.util._testing import ReallyEqualMixin
19 from skbio.metadata._testing import (MetadataMixinTests,
20                                      IntervalMetadataMixinTests,
21                                      PositionalMetadataMixinTests)
22 from skbio.metadata import IntervalMetadata
23 class SequenceSubclass(Sequence):
24     pass
25 class</b></font> SequenceSubclassTwo(Sequence):
26     pass
27 class TestSequenceMetadata(TestCase, ReallyEqualMixin, MetadataMixinTests):
28     def setUp(self):
29         self._metadata_constructor_ = functools.partial(Sequence, '')
30 class TestSequencePositionalMetadata(TestCase, ReallyEqualMixin,
31                                      PositionalMetadataMixinTests):
32     def setUp(self):
33         def factory(axis_len, positional_metadata=None):
34             return Sequence('Z' * axis_len,
35                             positional_metadata=positional_metadata)
36         self._positional_metadata_constructor_ = factory
37 class TestSequenceIntervalMetadata(TestCase, ReallyEqualMixin,
38                                    IntervalMetadataMixinTests):
39     def setUp(self):
40         super()._set_up()
41         def factory(axis_len, interval_metadata=None):
42             return Sequence('Z' * axis_len,
43                             interval_metadata=interval_metadata)
44         self._interval_metadata_constructor_ = factory
45 class TestSequenceBase(TestCase):
46     def setUp(self):
47         self.sequence_kinds = frozenset([
48             str, Sequence,
49             lambda s: np.frombuffer(s.encode('ascii'), dtype='|S1'),
50             lambda s: np.frombuffer(s.encode('ascii'), dtype=np.uint8)])
51 class TestSequence(TestSequenceBase, ReallyEqualMixin):
52     def setUp(self):
53         super(TestSequence, self).setUp()
54         self.lowercase_seq = Sequence('AAAAaaaa', lowercase='key')
55         def empty_generator():
56             yield from ()
57         self.getitem_empty_indices = [
58             [],
59             (),
60             {},
61             empty_generator(),
62             np.array([]),
63             np.array([], dtype=int)]
64     def test_concat_bad_how(self):
65         seq1 = seq2 = Sequence("123")
66         with self.assertRaises(ValueError):
67             Sequence.concat([seq1, seq2], how='foo')
68     def test_concat_on_subclass(self):
69         seq1 = SequenceSubclass("123")
70         seq2 = Sequence("123")
71         result = SequenceSubclass.concat([seq1, seq2])
72         self.assertIs(type(result), SequenceSubclass)
73         self.assertEqual(result, SequenceSubclass("123123"))
74     def test_concat_on_empty_iterator(self):
75         result = SequenceSubclass.concat((_ for _ in []))
76         self.assertIs(type(result), SequenceSubclass)
77         self.assertEqual(result, SequenceSubclass(""))
78     def test_concat_on_bad_subclass(self):
79         seq1 = Sequence("123")
80         seq2 = SequenceSubclassTwo("123")
81         with self.assertRaises(TypeError):
82             SequenceSubclass.concat([seq1, seq2])
83     def test_concat_interval_metadata(self):
84         seq1 = Sequence("1234")
85         seq1.interval_metadata.add(
86             [(0, 2)], [(True, False)], {'gene': 'sagA'})
87         seq2 = Sequence("5678")
88         seq2.interval_metadata.add(
89             [(1, 3)], [(False, True)], {'gene': 'sagB'})
90         obs = Sequence.concat([seq1, seq2])
91 <a name="48"></a>        exp = Sequence('12345678')
92         exp.interval_metadata.add(
93             [(0, 2)], [(True, False)], {'gene': 'sagA'})
94         exp.interval_metadata<font color="#c57726"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.add(
95             [(5, 7)], [(False, True)], {'gene': 'sagB'})
96         self.assertEqual(exp, obs)
97     def test_concat_one_seq_has_none_interval_metadata(self):
98         seq1 =</b></font> Sequence("1234")
99         seq1.interval_metadata.add(
100             [(0, 2)], [(True, False)], {'gene': 'sagA'})
101         seq2 = Sequence("5678")
102         seq3 = Sequence("910")
103         seq3.interval_metadata.add(
104             [(1, 3)], [(False, True)], {'gene': 'sagB'})
105         obs = Sequence.concat([seq1, seq2, seq3])
106 <a name="47"></a>        exp = Sequence('12345678910')
107         exp.interval_metadata.add(
108             [(0, 2)], [(True, False)], {'gene': 'sagA'})
109         exp.interval_metadata<font color="#d16587"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.add(
110             [(9, 11)], [(False, True)], {'gene': 'sagB'})
111         self.assertEqual(exp, obs)
112     def test_concat_default_how(self):
113         seq1 =</b></font> Sequence("1234", positional_metadata={'a': [1]*4})
114         seq2 = Sequence("5678", positional_metadata={'a': [2]*4})
115         seqbad = Sequence("9", positional_metadata={'b': [9]})
116         result1 = Sequence.concat([seq1, seq2])
117         result2 = Sequence.concat([seq1, seq2], how='strict')
118         self.assertEqual(result1, result2)
119         with self.assertRaisesRegex(ValueError,
120                                     r'.*positional.*metadata.*inner.*outer.*'):
121             Sequence.concat([seq1, seq2, seqbad])
122     def test_concat_strict_simple(self):
123         expected = Sequence(
124             "12345678", positional_metadata={'a': [1, 1, 1, 1, 2, 2, 2, 2]})
125         seq1 = Sequence("1234", positional_metadata={'a': [1]*4})
126         seq2 = Sequence("5678", positional_metadata={'a': [2]*4})
127         result = Sequence.concat([seq1, seq2], how='strict')
128         self.assertEqual(result, expected)
129         self.assertFalse(result.metadata)
130     def test_concat_strict_many(self):
131         odd_key = frozenset()
132 <a name="9"></a>        expected = Sequence("13579",
133                             positional_metadata={'a': list('skbio'),
134                                                  odd_key: [1, 2, 3, 4, 5]})
135         result = Sequence<font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.concat([
136                 Sequence("1", positional_metadata={'a': ['s'], odd_key: [1]}),
137                 Sequence("3", positional_metadata={'a': ['k'], odd_key: [2]}),
138                 Sequence("5", positional_metadata={'a': ['b'], odd_key: [3]}),
139                 Sequence("7", positional_metadata={'a': ['i'], odd_key: [4]}),
140                 Sequence(</b></font>"9", positional_metadata={'a': ['o'], odd_key: [5]})
141             ], how='strict')
142         self.assertEqual(result, expected)
143         self.assertFalse(result.metadata)
144     def test_concat_strict_fail(self):
145         seq1 = Sequence("1", positional_metadata={'a': [1]})
146         seq2 = Sequence("2", positional_metadata={'b': [2]})
147         with self.assertRaisesRegex(ValueError,
148                                     r'.*positional.*metadata.*inner.*outer.*'):
149             Sequence.concat([seq1, seq2], how='strict')
150     def test_concat_outer_simple(self):
151         seq1 = Sequence("1234")
152         seq2 = Sequence("5678")
153         result = Sequence.concat([seq1, seq2], how='outer')
154         self.assertEqual(result, Sequence("12345678"))
155         self.assertFalse(result.metadata)
156     def test_concat_outer_missing(self):
157         a = {}
158         b = {}
159         seq1 = Sequence("12", positional_metadata={'a': ['1', '2']})
160         seq2 = Sequence("34", positional_metadata={'b': [3, 4], 'c': [a, b]})
161         seq3 = Sequence("56")
162         seq4 = Sequence("78", positional_metadata={'a': [7, 8]})
163 <a name="15"></a>        seq5 = Sequence("90", positional_metadata={'b': [9, 0]})
164         result = Sequence.concat([seq1, seq2, seq3, seq4, seq5], how='outer')
165         expected = Sequence<font color="#f52887"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>("1234567890", positional_metadata={
166                                 'a': ['1', '2', np.nan, np.nan, np.nan, np.nan,
167                                       7, 8, np.nan, np.nan],
168                                 'b': [np.nan, np.nan, 3, 4, np.nan, np.</b></font>nan,
169                                       np.nan, np.nan, 9, 0],
170                                 'c': [np.nan, np.nan, a, b, np.nan, np.nan,
171                                       np.nan, np.nan, np.nan, np.nan]
172                             })
173         self.assertEqual(result, expected)
174         self.assertFalse(result.metadata)
175     def test_concat_inner_simple(self):
176         seq1 = Sequence("1234")
177         seq2 = Sequence("5678", positional_metadata={'discarded': [1] * 4})
178         result = Sequence.concat([seq1, seq2], how='inner')
179         self.assertEqual(result, Sequence("12345678"))
180         self.assertFalse(result.metadata)
181     def test_concat_inner_missing(self):
182         seq1 = Sequence("12", positional_metadata={'a': ['1', '2'],
183                                                    'c': [{}, {}]})
184         seq2 = Sequence("34", positional_metadata={'a': [3, 4], 'b': [3, 4]})
185         seq3 = Sequence("56", positional_metadata={'a': [5, 6], 'b': [5, 6]})
186         result = Sequence.concat([seq1, seq2, seq3], how='inner')
187         expected = Sequence("123456", positional_metadata={'a': ['1', '2', 3,
188                                                                  4, 5, 6]})
189         self.assertEqual(result, expected)
190         self.assertFalse(result.metadata)
191     def test_init_default_parameters(self):
192         seq = Sequence('.ABC123xyz-')
193         npt.assert_equal(seq.values, np.array('.ABC123xyz-', dtype='c'))
194         self.assertEqual('.ABC123xyz-', str(seq))
195         self.assertFalse(seq.metadata)
196         self.assertEqual(seq.metadata, {})
197         assert_data_frame_almost_equal(seq.positional_metadata,
198                                        pd.DataFrame(index=range(11)))
199         self.assertEqual(seq.interval_metadata,
200                          IntervalMetadata(len(seq)))
201     def test_init_nondefault_parameters(self):
202         s = '.ABC123xyz-'
203         im = IntervalMetadata(len(s))
204         im.add([(0, 1)], metadata={'gene': 'sagA'})
205         seq = Sequence(s,
206                        metadata={'id': 'foo', 'description': 'bar baz'},
207                        positional_metadata={'quality': range(11)},
208                        interval_metadata=im)
209 <a name="46"></a>        self.assertEqual(seq.interval_metadata, im)
210         npt.assert_equal(seq.values, np.array('.ABC123xyz-', dtype='c'))
211         self.assertEqual(s, str<font color="#668b8b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>(seq))
212         self.assertTrue(seq.metadata)
213         self.assertEqual(seq.metadata, {'id': 'foo', 'description': 'bar baz'})
214         assert_data_frame_almost_equal(
215             seq.positional_metadata,
216             pd.DataFrame(</b></font>{'quality': range(11)}, index=range(11)))
217     def test_init_empty_sequence(self):
218         for s in (b'',  # bytes
219                   '',  # unicode
220                   np.array('', dtype='c'),  # char vector
221                   np.frombuffer(b'', dtype=np.uint8),  # byte vec
222             seq = Sequence(s)
223             self<font color="#3ea99f"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertIsInstance(seq.values, np.ndarray)
224             self.assertEqual(seq.values.dtype, '|S1')
225             self.assertEqual(seq.values.shape, (0</b></font>, ))
226             npt.assert_equal(seq.values, np.array('', dtype='c'))
227             self.assertEqual(str(seq), '')
228             self.assertEqual(len(seq), 0)
229             self.assertFalse(seq.metadata)
230             self.assertEqual(seq.metadata, {})
231             self.assertEqual(seq.interval_metadata,
232                              IntervalMetadata(0))
233             assert_data_frame_almost_equal(seq.positional_metadata,
234                                            pd.DataFrame(index=range(0)))
235     def test_init_single_character_sequence(self):
236         for s in (b'A',
237                   'A',
238                   np.array('A', dtype='c'),
239                   np.frombuffer(b'A', dtype=np.uint8),
240 <a name="30"></a>                  Sequence('A')):
241             seq = Sequence(s)
242             self.assertIsInstance<font color="#ae694a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>(seq.values, np.ndarray)
243             self.assertEqual(seq.values.dtype, '|S1')
244             self.assertEqual(seq.values.shape, (1,))
245             npt.</b></font>assert_equal(seq.values, np.array('A', dtype='c'))
246             self.assertEqual(str(seq), 'A')
247             self.assertEqual(len(seq), 1)
248             self.assertFalse(seq.metadata)
249             self.assertEqual(seq.metadata, {})
250             self.assertEqual(seq.interval_metadata,
251                              IntervalMetadata(1))
252             assert_data_frame_almost_equal(seq.positional_metadata,
253                                            pd.DataFrame(index=range(1)))
254     def test_init_multiple_character_sequence(self):
255         for s in (b'.ABC\t123  xyz-',
256                   '.ABC\t123  xyz-',
257                   np.array('.ABC\t123  xyz-', dtype='c'),
258                   np.frombuffer(b'.ABC\t123  xyz-', dtype=np.uint8),
259 <a name="45"></a>                  Sequence('.ABC\t123  xyz-')):
260             seq = Sequence(s)
261             self<font color="#549748"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertIsInstance(seq.values, np.ndarray)
262             self.assertEqual(seq.values.dtype, '|S1')
263             self.assertEqual(seq.values.</b></font>shape, (14,))
264             npt.assert_equal(seq.values,
265                              np.array('.ABC\t123  xyz-', dtype='c'))
266             self.assertEqual(str(seq), '.ABC\t123  xyz-')
267             self.assertEqual(len(seq), 14)
268             self.assertFalse(seq.metadata)
269             self.assertEqual(seq.metadata, {})
270             self.assertEqual(seq.interval_metadata,
271                              IntervalMetadata(14))
272             assert_data_frame_almost_equal(seq.positional_metadata,
273                                            pd.DataFrame(index=range(14)))
274     def test_init_from_sequence_object(self):
275         seq = Sequence('ACGT')
276         self.assertEqual(Sequence(seq), seq)
277         seq = Sequence('ACGT',
278                        metadata={'id': 'foo', 'description': 'bar baz'},
279                        positional_metadata={'quality': range(4)})
280         seq.interval_metadata.add([(0, 1)], metadata={'gene': 'sagA'})
281         self.assertEqual(Sequence(seq), seq)
282         im = IntervalMetadata(4)
283         im.add([(0, 2)], metadata={'gene': 'sagB'})
284         self.assertEqual(
285             Sequence(seq, metadata={'id': 'abc', 'description': '123'},
286                      positional_metadata={'quality': [42] * 4},
287                      interval_metadata=im),
288             Sequence('ACGT', metadata={'id': 'abc', 'description': '123'},
289                      positional_metadata={'quality': [42] * 4},
290                      interval_metadata=im))
291         im = IntervalMetadata(4)
292         im.add([(0, 2)], metadata={'gene': 'sagB'})
293         seq = SequenceSubclass('ACGT',
294                                metadata={'id': 'foo',
295                                          'description': 'bar baz'},
296                                positional_metadata={'quality': range(4)},
297                                interval_metadata=im)
298         self.assertEqual(
299             Sequence(seq),
300             Sequence('ACGT', metadata={'id': 'foo', 'description': 'bar baz'},
301                      positional_metadata={'quality': range(4)},
302                      interval_metadata=im))
303     def test_init_from_non_descendant_sequence_object(self):
304         seq = SequenceSubclass('ACGT')
305         with self.assertRaises(TypeError) as cm:
306 <a name="44"></a>            SequenceSubclassTwo(seq)
307         error = str(cm.exception)
308         self<font color="#a057a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertIn("SequenceSubclass", error)
309         self.assertIn("SequenceSubclassTwo", error)
310         self.assertIn("cast", error)
311     def test_init_from_contiguous_sequence_bytes_view(self):
312         bytes = np.array([65</b></font>, 42, 66, 42, 65], dtype=np.uint8)
313         view = bytes[:3]
314         seq = Sequence(view)
315         self.assertEqual(seq, Sequence('A*B'))
316         self.assertFalse(seq._owns_bytes)
317         with self.assertRaises(ValueError):
318 <a name="21"></a>            view[1] = 100
319         self<font color="#947010"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertEqual(seq, Sequence('A*B'))
320         bytes[0] = 99
321         self.assertEqual(seq, Sequence('c*B'))
322     def test_init_from_noncontiguous_sequence_bytes_view(self):
323         bytes = np.array([65</b></font>, 42, 66, 42, 65], dtype=np.uint8)
324         view = bytes[::2]
325         seq = Sequence(view)
326         self.assertEqual(seq, Sequence('ABA'))
327         self.assertTrue(seq._owns_bytes)
328         bytes[0] = 99
329         view[1] = 100
330         self.assertEqual(seq, Sequence('ABA'))
331     def test_init_no_copy_of_sequence(self):
332         bytes = np.array([65, 66, 65], dtype=np.uint8)
333         seq = Sequence(bytes)
334         self.assertIs(seq._bytes, bytes)
335         with self.assertRaises(ValueError):
336             bytes[1] = 42
337     def test_init_invalid_sequence(self):
338         with self.assertRaises(TypeError):
339             Sequence(np.array([1, 2, 3]))
340         with self.assertRaises(TypeError):
341             Sequence(np.array([1, "23", 3]))
342         with self.assertRaises(TypeError):
343             Sequence(np.array([1, {}, ()]))
344         with self.assertRaisesRegex(TypeError, r'tuple'):
345             Sequence(('a', 'b', 'c'))
346         with self.assertRaisesRegex(TypeError, r'list'):
347             Sequence(['a', 'b', 'c'])
348         with self.assertRaisesRegex(TypeError, r'set'):
349             Sequence({'a', 'b', 'c'})
350         with self.assertRaisesRegex(TypeError, r'dict'):
351             Sequence({'a': 42, 'b': 43, 'c': 44})
352         with self.assertRaisesRegex(TypeError, r'int'):
353             Sequence(42)
354         with self.assertRaisesRegex(TypeError, r'float'):
355             Sequence(4.2)
356         with self.assertRaisesRegex(TypeError, r'int64'):
357             Sequence(np.int_(50))
358         with self.assertRaisesRegex(TypeError, r'float64'):
359             Sequence(np.float_(50))
360         with self.assertRaisesRegex(TypeError, r'Foo'):
361             class Foo:
362                 pass
363             Sequence(Foo())
364         with self.assertRaises(UnicodeEncodeError):
365             Sequence('abc\u1F30')
366     def test_values_property(self):
367         seq = Sequence('ACGT')
368         self.assertIsInstance(seq.values, np.ndarray)
369         self.assertEqual(seq.values.dtype, '|S1')
370         npt.assert_equal(seq.values, np.array('ACGT', dtype='c'))
371         with self.assertRaises(ValueError):
372             seq.values[1] = 'A'
373         with self.assertRaises(AttributeError):
374             seq.values = np.array("GGGG", dtype='c')
375 <a name="43"></a>    def test_sequence_numpy_compatibility(self):
376         seq = Sequence('abc123')
377         array = np<font color="#c22817"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.asarray(seq)
378         self.assertIsInstance(array, np.ndarray)
379         self.assertEqual(array.dtype, '|S1')
380         npt.assert_equal(array, np.array(</b></font>'abc123', dtype='c'))
381         npt.assert_equal(array, seq.values)
382         with self.assertRaises(ValueError):
383             array[1] = 'B'
384     def test_observed_chars_property(self):
385         self.assertEqual(Sequence('').observed_chars, set())
386 <a name="29"></a>        self.assertEqual(Sequence('x').observed_chars, {'x'})
387         self.assertEqual(Sequence('xYz').observed_chars, {'x', 'Y', 'z'})
388         self.assertEqual(Sequence('zzz').observed_chars, {'z'})
389         self.assertEqual(Sequence('xYzxxZz')<font color="#af7a82"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.observed_chars,
390                          {'x', 'Y', 'z', 'Z'})
391         self.assertEqual(Sequence('\t   ').observed_chars, {' ', '\t'})
392         im = IntervalMetadata(6)
393         im.add([(0</b></font>, 2)], metadata={'gene': 'sagB'})
394         self.assertEqual(
395             Sequence('aabbcc', metadata={'foo': 'bar'},
396                      positional_metadata={'foo': range(6)},
397                      interval_metadata=im).observed_chars,
398             {'a', 'b', 'c'})
399         with self.assertRaises(AttributeError):
400             Sequence('ACGT').observed_chars = {'a', 'b', 'c'}
401     def test_eq_and_ne(self):
402         seq_a = Sequence("A")
403         seq_b = Sequence("B")
404         im = IntervalMetadata(1)
405         im.add([(0, 1)], metadata={'gene': 'sagA'})
406         im2 = IntervalMetadata(1)
407         im.add([(0, 1)], metadata={'gene': 'sagB'})
408         self.assertTrue(seq_a == seq_a)
409         self.assertTrue(Sequence("a") == Sequence("a"))
410         self.assertTrue(Sequence("a", metadata={'id': 'b'}) ==
411                         Sequence("a", metadata={'id': 'b'}))
412         self.assertTrue(Sequence("a",
413                                  metadata={'id': 'b', 'description': 'c'}) ==
414                         Sequence("a",
415                                  metadata={'id': 'b', 'description': 'c'}))
416         self.assertTrue(Sequence("a", metadata={'id': 'b', 'description': 'c'},
417                                  positional_metadata={'quality': [1]},
418                                  interval_metadata=im) ==
419                         Sequence("a", metadata={'id': 'b', 'description': 'c'},
420                                  positional_metadata={'quality': [1]},
421                                  interval_metadata=im))
422         self.assertTrue(seq_a != seq_b)
423         self.assertTrue(SequenceSubclass("a") != Sequence("a"))
424         self.assertTrue(Sequence("a") != Sequence("b"))
425         self.assertTrue(Sequence("a") != Sequence("a", metadata={'id': 'b'}))
426         self.assertTrue(Sequence("a", metadata={'id': 'c'}) !=
427                         Sequence("a",
428                                  metadata={'id': 'c', 'description': 't'}))
429         self.assertTrue(Sequence("a", positional_metadata={'quality': [1]}) !=
430                         Sequence("a"))
431         self.assertTrue(Sequence("a", interval_metadata=im) !=
432                         Sequence("a"))
433         self.assertTrue(Sequence("a", positional_metadata={'quality': [1]}) !=
434                         Sequence("a", positional_metadata={'quality': [2]}))
435         self.assertTrue(Sequence("a", interval_metadata=im) !=
436                         Sequence("a", interval_metadata=im2))
437         self.assertTrue(Sequence("c", positional_metadata={'quality': [3]}) !=
438                         Sequence("b", positional_metadata={'quality': [3]}))
439         self.assertTrue(Sequence("c", interval_metadata=im) !=
440                         Sequence("b", interval_metadata=im))
441         self.assertTrue(Sequence("a", metadata={'id': 'b'}) !=
442                         Sequence("c", metadata={'id': 'b'}))
443     def test_eq_sequences_without_metadata_compare_equal(self):
444         self.assertTrue(Sequence('') == Sequence(''))
445         self.assertTrue(Sequence('z') == Sequence('z'))
446         self.assertTrue(
447             Sequence('ACGT') == Sequence('ACGT'))
448 <a name="42"></a>    def test_eq_sequences_with_metadata_compare_equal(self):
449         seq1 = Sequence('ACGT', metadata={'id': 'foo', 'desc': 'abc'},
450                         positional_metadata={'qual': [1, 2, 3, 4]})
451         seq2 = Sequence('ACGT', metadata<font color="#c57717"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>={'id': 'foo', 'desc': 'abc'},
452                         positional_metadata={'qual': [1, 2, 3, 4]})
453         self.assertTrue(seq1 == seq2)
454         self.assertTrue(seq2 == seq1)
455     def test_eq_sequences_from_different_sources_compare_equal(self):
456         im =</b></font> IntervalMetadata(4)
457         im.add([(0, 2)], metadata={'gene': 'sagB'})
458         seq1 = Sequence('ACGT', metadata={'id': 'foo', 'desc': 'abc'},
459                         positional_metadata={'quality': (1, 2, 3, 4)},
460                         interval_metadata=im)
461         seq2 = Sequence(np.array([65, 67, 71, 84], dtype=np.uint8),
462                         metadata={'id': 'foo', 'desc': 'abc'},
463                         positional_metadata={'quality': np.array([1, 2, 3,
464                                                                   4])},
465                         interval_metadata=im)
466         self.assertTrue(seq1 == seq2)
467     def test_eq_type_mismatch(self):
468         seq1 = Sequence('ACGT')
469         seq2 = SequenceSubclass('ACGT')
470         self.assertFalse(seq1 == seq2)
471     def test_eq_positional_metadata_mismatch(self):
472         seq1 = Sequence('ACGT', positional_metadata={'quality': [1, 2, 3, 4]})
473         seq2 = Sequence('ACGT', positional_metadata={'quality': [1, 2, 3, 5]})
474         self.assertFalse(seq1 == seq2)
475         seq1 = Sequence('ACGT', positional_metadata={'quality': [1, 2, 3, 4]})
476         seq2 = Sequence('ACGT')
477         self.assertFalse(seq1 == seq2)
478     def test_eq_interval_metadata_mismatch(self):
479         im1 = IntervalMetadata(4)
480         im1.add([(0, 3)], metadata={'gene': 'sagA'})
481         im2 = IntervalMetadata(4)
482         im2.add([(0, 2)], metadata={'gene': 'sagA'})
483         seq1 = Sequence('ACGT', interval_metadata=im1)
484         seq2 = Sequence('ACGT', interval_metadata=im2)
485         self.assertFalse(seq1 == seq2)
486         seq1 = Sequence('ACGT', interval_metadata=im1)
487         seq2 = Sequence('ACGT')
488         self.assertFalse(seq1 == seq2)
489     def test_eq_sequence_mismatch(self):
490         seq1 = Sequence('ACGT')
491         seq2 = Sequence('TGCA')
492         self.assertFalse(seq1 == seq2)
493     def test_getitem_gives_new_sequence(self):
494         seq = Sequence("Sequence string !1@2#3?.,")
495         self.assertFalse(seq is seq[:])
496     def test_getitem_drops_interval_metadata(self):
497         s = "Sequence string !1@2#3?.,"
498         seq = Sequence(s, metadata={'id': 'id', 'description': 'dsc'})
499         seq.interval_metadata.add([(0, 3)], metadata={'gene': 'sagA'})
500         eseq = Sequence('Se', metadata={'id': 'id', 'description': 'dsc'})
501         self.assertEqual(seq[:2], eseq)
502     def test_getitem_with_int_has_positional_metadata(self):
503         s = "Sequence string !1@2#3?.,"
504         length = len(s)
505         seq = Sequence(s, metadata={'id': 'id', 'description': 'dsc'},
506                        positional_metadata={'quality': np.arange(length)})
507         eseq = Sequence("S", {'id': 'id', 'description': 'dsc'},
508                         positional_metadata={'quality': np.array([0])})
509         self.assertEqual(seq[0], eseq)
510         eseq = Sequence(",", metadata={'id': 'id', 'description': 'dsc'},
511                         positional_metadata={'quality':
512                                              np.array([len(seq) - 1])})
513         self.assertEqual(seq[len(seq) - 1], eseq)
514         eseq = Sequence("t", metadata={'id': 'id', 'description': 'dsc'},
515                         positional_metadata={'quality': [10]})
516         self.assertEqual(seq[10], eseq)
517     def test_single_index_to_slice(self):
518         a = [1, 2, 3, 4]
519         self.assertEqual(slice(0, 1), _single_index_to_slice(0))
520         self.assertEqual([1], a[_single_index_to_slice(0)])
521         self.assertEqual(slice(-1, None),
522                          _single_index_to_slice(-1))
523         self.assertEqual([4], a[_single_index_to_slice(-1)])
524     def test_is_single_index(self):
525         self.assertTrue(_is_single_index(0))
526         self.assertFalse(_is_single_index(True))
527         self.assertFalse(_is_single_index(bool()))
528         self.assertFalse(_is_single_index('a'))
529     def test_as_slice_if_single_index(self):
530         self.assertEqual(slice(0, 1), _as_slice_if_single_index(0))
531         slice_obj = slice(2, 3)
532         self.assertIs(slice_obj,
533                       _as_slice_if_single_index(slice_obj))
534     def test_slice_positional_metadata(self):
535         seq = Sequence('ABCDEFGHIJ',
536                        positional_metadata={'foo': np.arange(10),
537                                             'bar': np.arange(100, 110)})
538         self.assertTrue(pd.DataFrame({'foo': [0], 'bar': [100]}).equals(
539                         seq._slice_positional_metadata(0)))
540         self.assertTrue(pd.DataFrame({'foo': [0], 'bar': [100]}).equals(
541                         seq._slice_positional_metadata(slice(0, 1))))
542         self.assertTrue(pd.DataFrame({'foo': [0, 1],
543                                       'bar': [100, 101]}).equals(
544                         seq._slice_positional_metadata(slice(0, 2))))
545         self.assertTrue(pd.DataFrame(
546             {'foo': [9], 'bar': [109]}, index=[9]).equals(
547                 seq._slice_positional_metadata(9)))
548     def test_getitem_with_int_no_positional_metadata(self):
549         seq = Sequence("Sequence string !1@2#3?.,",
550                        metadata={'id': 'id2', 'description': 'no_qual'})
551         eseq = Sequence("t", metadata={'id': 'id2', 'description': 'no_qual'})
552         self.assertEqual(seq[10], eseq)
553     def test_getitem_with_slice_has_positional_metadata(self):
554         s = "0123456789abcdef"
555         length = len(s)
556         seq = Sequence(s, metadata={'id': 'id3', 'description': 'dsc3'},
557 <a name="28"></a>                       positional_metadata={'quality': np.arange(length)})
558         eseq = Sequence("012", metadata={'id': 'id3', 'description': 'dsc3'},
559                         positional_metadata<font color="#717d7d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>={'quality': np.arange(3)})
560         self.assertEqual(seq[0:3], eseq)
561         self.assertEqual(seq[:3], eseq)
562         self.assertEqual(seq[</b></font>:3:1], eseq)
563         eseq = Sequence("def", metadata={'id': 'id3', 'description': 'dsc3'},
564                         positional_metadata={'quality': [13, 14, 15]})
565         self.assertEqual(seq[-3:], eseq)
566         self.assertEqual(seq[-3::1], eseq)
567         eseq = Sequence("02468ace",
568                         metadata={'id': 'id3', 'description': 'dsc3'},
569                         positional_metadata={'quality': [0, 2, 4, 6, 8, 10,
570                                                          12, 14]})
571         self.assertEqual(seq[0:length:2], eseq)
572         self.assertEqual(seq[::2], eseq)
573         eseq = Sequence(s[::-1], metadata={'id': 'id3', 'description': 'dsc3'},
574                         positional_metadata={'quality':
575                                              np.arange(length)[::-1]})
576         self.assertEqual(seq[length::-1], eseq)
577         self.assertEqual(seq[::-1], eseq)
578         eseq = Sequence('fdb97531',
579                         metadata={'id': 'id3', 'description': 'dsc3'},
580                         positional_metadata={'quality': [15, 13, 11, 9, 7, 5,
581                                                          3, 1]})
582         self.assertEqual(seq[length::-2], eseq)
583         self.assertEqual(seq[::-2], eseq)
584 <a name="20"></a>        self.assertEqual(seq[0:500:], seq)
585         eseq = Sequence('', metadata={'id': 'id3', 'description': 'dsc3'},
586                         positional_metadata={<font color="#4e9258"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>'quality':
587                                              np.array([], dtype=np.int64)})
588         self.assertEqual(seq[length:0], eseq)
589         self.assertEqual(seq[-length:0], eseq)
590         self.assertEqual(seq[</b></font>1:0], eseq)
591         eseq = Sequence("0", metadata={'id': 'id3', 'description': 'dsc3'},
592                         positional_metadata={'quality': [0]})
593         self.assertEqual(seq[0:1], eseq)
594         self.assertEqual(seq[0:1:1], eseq)
595         self.assertEqual(seq[-length::-1], eseq)
596     def test_getitem_with_slice_no_positional_metadata(self):
597         s = "0123456789abcdef"
598         length = len(s)
599         seq = Sequence(s, metadata={'id': 'id4', 'description': 'no_qual4'})
600         eseq = Sequence("02468ace",
601                         metadata={'id': 'id4', 'description': 'no_qual4'})
602         self.assertEqual(seq[0:length:2], eseq)
603         self.assertEqual(seq[::2], eseq)
604     def test_getitem_with_tuple_of_mixed_with_positional_metadata(self):
605         s = "0123456789abcdef"
606         length = len(s)
607         seq = Sequence(s, metadata={'id': 'id5', 'description': 'dsc5'},
608 <a name="8"></a>                       positional_metadata={'quality': np.arange(length)})
609         eseq = Sequence("00000", metadata={'id': 'id5', 'description': 'dsc5'},
610                         positional_metadata={'quality': [<font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>0, 0, 0, 0, 0]})
611         self.assertEqual(seq[0, 0, 0, 0, 0], eseq)
612         self.assertEqual(seq[0, 0:1, 0, 0, 0], eseq)
613         self.assertEqual(seq[0, 0:1, 0, -length::-1, 0, 1:0], eseq)
614         self.assertEqual(seq[0:1, 0:1, 0:1, 0:1, 0:1], eseq)
615         self.assertEqual(seq[</b></font>0:1, 0, 0, 0, 0], eseq)
616 <a name="27"></a>
617         eseq = Sequence("0123fed9",
618                         metadata={'id': 'id5', 'description': 'dsc5'},
619                         positional_metadata={'quality': [<font color="#e77471"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>0, 1, 2, 3, 15, 14,
620                                                          13, 9]})
621         self.assertEqual(seq[0, 1, 2, 3, 15, 14, 13, 9], eseq)
622         self.assertEqual(seq[0, 1, 2, 3, :-4:-1, 9], eseq)
623         self.assertEqual(seq[0:4, :-4:-1, 9, 1:0], eseq)
624         self.assertEqual(seq[</b></font>0:4, :-4:-1, 9:10], eseq)
625 <a name="14"></a>    def test_getitem_with_tuple_of_mixed_no_positional_metadata(self):
626         seq = Sequence("0123456789abcdef",
627                        metadata={'id': 'id6', 'description': 'no_qual6'})
628         eseq = Sequence<font color="#842dce"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>("0123fed9",
629                         metadata={'id': 'id6', 'description': 'no_qual6'})
630         self.assertEqual(seq[0, 1, 2, 3, 15, 14, 13, 9], eseq)
631         self.assertEqual(seq[0, 1, 2, 3, :-4:-1, 9], eseq)
632         self.assertEqual(seq[0:4, :-4:-1, 9], eseq)
633         self.assertEqual(seq[</b></font>0:4, :-4:-1, 9:10], eseq)
634 <a name="41"></a>    def test_getitem_with_tuple_of_mixed_no_metadata(self):
635         seq = Sequence("0123456789abcdef")
636         eseq = Sequence("0123fed9")
637         self<font color="#f87a17"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertEqual(seq[0, 1, 2, 3, 15, 14, 13, 9], eseq)
638         self.assertEqual(seq[0, 1, 2, 3, :-4:-1, 9], eseq)
639         self.assertEqual(seq[0:4, :-4:-1, 9], eseq)
640         self.assertEqual(seq[</b></font>0:4, :-4:-1, 9:10], eseq)
641     def test_getitem_with_iterable_of_mixed_has_positional_metadata(self):
642         s = "0123456789abcdef"
643         length = len(s)
644         seq = Sequence(s, metadata={'id': 'id7', 'description': 'dsc7'},
645                        positional_metadata={'quality': np.arange(length)})
646         def generator():
647             yield slice(0, 4)
648             yield slice(200, 400)
649             yield -1
650             yield slice(-2, -4, -1)
651             yield 9
652         eseq = Sequence("0123fed9",
653                         metadata={'id': 'id7', 'description': 'dsc7'},
654                         positional_metadata={'quality': [0, 1, 2, 3, 15, 14,
655                                                          13, 9]})
656         self.assertEqual(seq[[0, 1, 2, 3, 15, 14, 13, 9]], eseq)
657         self.assertEqual(seq[generator()], eseq)
658         self.assertEqual(seq[[slice(0, 4), slice(None, -4, -1), 9]], eseq)
659         self.assertEqual(seq[
660             [slice(0, 4), slice(None, -4, -1), slice(9, 10)]], eseq)
661     def test_getitem_with_iterable_of_mixed_no_positional_metadata(self):
662         s = "0123456789abcdef"
663         seq = Sequence(s, metadata={'id': 'id7', 'description': 'dsc7'})
664         def generator():
665             yield slice(0, 4)
666             yield slice(200, 400)
667             yield slice(None, -4, -1)
668             yield 9
669         eseq = Sequence("0123fed9",
670                         metadata={'id': 'id7', 'description': 'dsc7'})
671         self.assertEqual(seq[[0, 1, 2, 3, 15, 14, 13, 9]], eseq)
672         self.assertEqual(seq[generator()], eseq)
673         self.assertEqual(seq[[slice(0, 4), slice(None, -4, -1), 9]], eseq)
674         self.assertEqual(seq[
675             [slice(0, 4), slice(None, -4, -1), slice(9, 10)]], eseq)
676     def test_getitem_with_numpy_index_has_positional_metadata(self):
677         s = "0123456789abcdef"
678         length = len(s)
679         seq = Sequence(s, metadata={'id': 'id9', 'description': 'dsc9'},
680                        positional_metadata={'quality': np.arange(length)})
681         eseq = Sequence("0123fed9",
682                         metadata={'id': 'id9', 'description': 'dsc9'},
683                         positional_metadata={'quality': [0, 1, 2, 3, 15, 14,
684                                                          13, 9]})
685         self.assertEqual(seq[np.array([0, 1, 2, 3, 15, 14, 13, 9])], eseq)
686     def test_getitem_with_numpy_index_no_positional_metadata(self):
687         s = "0123456789abcdef"
688         seq = Sequence(s, metadata={'id': 'id10', 'description': 'dsc10'})
689         eseq = Sequence("0123fed9",
690                         metadata={'id': 'id10', 'description': 'dsc10'})
691         self.assertEqual(seq[np.array([0, 1, 2, 3, 15, 14, 13, 9])], eseq)
692     def test_getitem_with_empty_indices_empty_seq_no_pos_metadata(self):
693         s = ""
694         seq = Sequence(s, metadata={'id': 'id10', 'description': 'dsc10'})
695         eseq = Sequence('', metadata={'id': 'id10', 'description': 'dsc10'})
696         tested = 0
697         for index in self.getitem_empty_indices:
698             tested += 1
699             self.assertEqual(seq[index], eseq)
700         self.assertEqual(tested, 6)
701     def test_getitem_with_empty_indices_non_empty_seq_no_pos_metadata(self):
702         s = "0123456789abcdef"
703         seq = Sequence(s, metadata={'id': 'id10', 'description': 'dsc10'})
704         eseq = Sequence('', metadata={'id': 'id10', 'description': 'dsc10'})
705         tested = 0
706         for index in self.getitem_empty_indices:
707             tested += 1
708             self.assertEqual(seq[index], eseq)
709         self.assertEqual(tested, 6)
710     def test_getitem_with_boolean_vector_has_qual(self):
711         s = "0123456789abcdef"
712         length = len(s)
713         seq = Sequence(s, metadata={'id': 'id11', 'description': 'dsc11'},
714                        positional_metadata={'quality': np.arange(length)})
715         eseq = Sequence("13579bdf",
716                         metadata={'id': 'id11', 'description': 'dsc11'},
717                         positional_metadata={'quality': [1, 3, 5, 7, 9, 11,
718                                                          13, 15]})
719         self.assertEqual(seq[np.array([False, True] * 8)], eseq)
720         self.assertEqual(seq[[False, True] * 8], eseq)
721     def test_getitem_with_boolean_vector_no_positional_metadata(self):
722         s = "0123456789abcdef"
723         seq = Sequence(s, metadata={'id': 'id11', 'description': 'dsc11'})
724         eseq = Sequence("13579bdf",
725                         metadata={'id': 'id11', 'description': 'dsc11'})
726         self.assertEqual(seq[np.array([False, True] * 8)], eseq)
727     def test_getitem_with_invalid(self):
728         seq = Sequence("123456",
729                        metadata={'id': 'idm', 'description': 'description'},
730                        positional_metadata={'quality': [1, 2, 3, 4, 5, 6]})
731         with self.assertRaises(IndexError):
732             seq['not an index']
733         with self.assertRaises(IndexError):
734             seq[['1', '2']]
735         with self.assertRaises(IndexError):
736             seq[[1, slice(1, 2), 'a']]
737         with self.assertRaises(IndexError):
738             seq[[1, slice(1, 2), True]]
739         with self.assertRaises(IndexError):
740             seq[True]
741         with self.assertRaises(IndexError):
742             seq[np.array([True, False])]
743         with self.assertRaises(IndexError):
744             seq[999]
745         with self.assertRaises(IndexError):
746             seq[0, 0, 999]
747         with self.assertRaises(Exception):
748             seq[100 * [True, False, True]]
749     def test_getitem_empty_positional_metadata(self):
750         seq = Sequence('ACGT')
751         seq.positional_metadata  # This will create empty positional_metadata
752         self.assertEqual(Sequence('A'), seq[0])
753     def test_len(self):
754         self.assertEqual(len(Sequence("")), 0)
755         self.assertEqual(len(Sequence("a")), 1)
756         self.assertEqual(len(Sequence("abcdef")), 6)
757     def test_nonzero(self):
758         self.assertFalse(Sequence(""))
759         self.assertFalse(Sequence("",
760                                   metadata={<font color="#347235"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>'id': 'foo'},
761                                   positional_metadata={'quality': range(0)}))
762         self.assertTrue(Sequence("A"))
763         self.assertTrue(Sequence("A",
764                                  metadata={'id'</b></font>: 'foo'},
765                                  positional_metadata={'quality': range(1)}))
766         self.assertTrue(Sequence("ACGT"))
767         self.assertTrue(Sequence("ACGT",
768                                  metadata={'id': 'foo'},
769                                  positional_metadata={'quality': range(4)}))
770     def test_contains(self):
771         seq = Sequence("#@ACGT,24.13**02")
772 <a name="19"></a>        tested = 0
773         for c in self.sequence_kinds:
774             tested += 1
775             self<font color="#f62817"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertTrue(c(',24') in seq)
776             self.assertTrue(c('*') in seq)
777             self.assertTrue(c('') in seq)
778             self.assertFalse(c("$") in seq)
779             self.assertFalse(</b></font>c("AGT") in seq)
780         self.assertEqual(tested, 4)
781     def test_contains_sequence_subclass(self):
782         with self.assertRaises(TypeError):
783             SequenceSubclass("A") in Sequence("AAA")
784         self.assertTrue(SequenceSubclass("A").values in Sequence("AAA"))
785     def test_hash(self):
786         with self.assertRaises(TypeError):
787             hash(Sequence("ABCDEFG"))
788         self.assertNotIsInstance(Sequence("ABCDEFG"), Hashable)
789     def test_iter_has_positional_metadata(self):
790         tested = False
791         seq = Sequence("0123456789", metadata={'id': 'a', 'desc': 'b'},
792                        positional_metadata={'qual': np.arange(10)})
793         for i, s in enumerate(seq):
794             tested = True
795             self.assertEqual(s, Sequence(str(i),
796                                          metadata={'id': 'a', 'desc': 'b'},
797                                          positional_metadata={'qual': [i]}))
798         self.assertTrue(tested)
799     def test_iter_no_positional_metadata(self):
800         tested = False
801         seq = Sequence("0123456789", metadata={'id': 'a', 'desc': 'b'})
802         for i, s in enumerate(seq):
803             tested = True
804             self.assertEqual(s, Sequence(str(i),
805                                          metadata={'id': 'a', 'desc': 'b'}))
806         self.assertTrue(tested)
807     def test_reversed_has_positional_metadata(self):
808         tested = False
809         seq = Sequence("0123456789", metadata={'id': 'a', 'desc': 'b'},
810                        positional_metadata={'qual': np.arange(10)})
811         for i, s in enumerate(reversed(seq)):
812             tested = True
813             self.assertEqual(s, Sequence(str(9 - i),
814                                          metadata={'id': 'a', 'desc': 'b'},
815                                          positional_metadata={'qual':
816                                                               [9 - i]}))
817         self.assertTrue(tested)
818     def test_reversed_no_positional_metadata(self):
819         tested = False
820         seq = Sequence("0123456789", metadata={'id': 'a', 'desc': 'b'})
821         for i, s in enumerate(reversed(seq)):
822             tested = True
823             self.assertEqual(s, Sequence(str(9 - i),
824                                          metadata={'id': 'a', 'desc': 'b'}))
825         self.assertTrue(tested)
826     def test_repr(self):
827 <a name="13"></a>
828         obs = repr(Sequence(''))
829         self<font color="#3b9c9c"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertEqual(obs.count('\n'), 4)
830         self.assertTrue(obs.startswith('Sequence'))
831         self.assertIn('length: 0', obs)
832         self.assertTrue(obs.endswith('-'))
833 <a name="26"></a>
834         obs =</b></font> repr(Sequence('ACGT'))
835         self<font color="#68818b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertEqual(obs.count('\n'), 5)
836         self.assertTrue(obs.startswith('Sequence'))
837         self.assertIn('length: 4', obs)
838         self.assertTrue(obs.</b></font>endswith('0 ACGT'))
839         obs = repr(
840             Sequence(
841                 'ACGT',
842                 metadata={'foo': 'bar', b'bar': 33.33, None: True, False: {},
843 <a name="6"></a>                          (1, 2): 3, 'acb' * 100: "'", 10: 11},
844                 positional_metadata={'foo': range(4),
845                                      42: ['a', 'b', [], 'c']}))
846         self<font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertEqual(obs.count('\n'), 16)
847         self.assertTrue(obs.startswith('Sequence'))
848         self.assertIn('None: True', obs)
849         self.assertIn('\'foo\': \'bar\'', obs)
850         self.assertIn('42: &lt;dtype: object&gt;', obs)
851         self.assertIn('\'foo\': &lt;dtype: int64&gt;', obs)
852         self.</b></font>assertIn('length: 4', obs)
853         self.assertTrue(obs.endswith('0 ACGT'))
854         obs = repr(Sequence('A' * 301))
855         self.assertEqual(obs.count('\n'), 9)
856         self.assertTrue(obs.startswith('Sequence'))
857         self.assertIn('length: 301', obs)
858         self.assertIn('...', obs)
859         self.assertTrue(obs.endswith('300 A'))
860     def test_str(self):
861         self.assertEqual(str(Sequence("GATTACA")), "GATTACA")
862         self.assertEqual(str(Sequence("ACCGGTACC")), "ACCGGTACC")
863         self.assertEqual(str(Sequence("GREG")), "GREG")
864         self.assertEqual(
865             str(Sequence("ABC",
866                          positional_metadata={'quality': [1, 2, 3]})),
867             "ABC")
868         self.assertIs(type(str(Sequence("A"))), str)
869     def test_count(self):
870         def construct_char_array(s):
871             return np.frombuffer(s.encode('ascii'), dtype='|S1')
872         def construct_uint8_array(s):
873             return np.frombuffer(s.encode('ascii'), dtype=np.uint8)
874         seq = Sequence("1234567899876555")
875         tested = 0
876         for c in self.sequence_kinds:
877             tested += 1
878             self.assertEqual(seq.count(c('4')), 1)
879             self.assertEqual(seq.count(c('8')), 2)
880             self.assertEqual(seq.count(c('5')), 4)
881             self.assertEqual(seq.count(c('555')), 1)
882             self.assertEqual(seq.count(c('555'), 0, 4), 0)
883             self.assertEqual(seq.count(c('555'), start=0, end=4), 0)
884             self.assertEqual(seq.count(c('5'), start=10), 3)
885             self.assertEqual(seq.count(c('5'), end=10), 1)
886             with self.assertRaises(ValueError):
887                 seq.count(c(''))
888         self.assertEqual(tested, 4)
889     def test_count_on_subclass(self):
890         with self.assertRaises(TypeError) as cm:
891             Sequence("abcd").count(SequenceSubclass("a"))
892         self.assertIn("Sequence", str(cm.exception))
893         self.assertIn("SequenceSubclass", str(cm.exception))
894     def test_replace_sanity(self):
895         seq = Sequence('AAGCATGCCCTTTACATTTG')
896         index = self._make_index('10011011001111110111')
897         obs = seq.replace(index, '_')
898         exp = Sequence('_AG__T__CC______T___')
899         self.assertEqual(obs, exp)
900     def test_replace_index_array(self):
901         seq = Sequence('TCGGGTGTTGTGCAACCACC')
902         for _type in list, tuple, np.array, pd.Series:
903             index = _type([0, 2, 5, 8, 9])
904             obs = seq.replace(index, '-')
905             exp = Sequence('-C-GG-GT--TGCAACCACC')
906             self.assertEqual(obs, exp)
907     def test_replace_iterable_slices(self):
908         seq = Sequence('CATTATGGACCCAGCGTGCC')
909         slices = (slice(0, 5), slice(8, 12), slice(15, 17))
910         mixed_slices = (0, 1, 2, 3, 4, slice(8, 12), 15, 16)
911         for _type in (lambda x: x, list, tuple, lambda x: np.array(tuple(x)),
912                       lambda x: pd.Series(tuple(x))):
913             index = (_type(slices), _type(mixed_slices))
914             obs_slices = seq.replace(index[0], '-')
915             obs_mixed = seq.replace(index[1], '-')
916             exp = Sequence('-----TGG----AGC--GCC')
917             self.assertEqual(obs_slices, exp)
918             self.assertEqual(obs_mixed, exp)
919     def test_replace_index_in_positional_metadata(self):
920         positional_metadata = {'where': self._make_index('001110110'
921                                                          '10001110000')}
922         seq = Sequence('AAGATTGATACCACAGTTGT',
923                        positional_metadata=positional_metadata)
924         obs = seq.replace('where', '-')
925         exp = Sequence('AA---T--T-CCA---TTGT',
926                        positional_metadata=positional_metadata)
927         self.assertEqual(obs, exp)
928     def test_replace_does_not_mutate_original(self):
929         seq = Sequence('ATCG')
930         index = self._make_index('0011')
931         seq.replace(index, '-')
932         obs = seq
933         exp = Sequence('ATCG')
934         self.assertEqual(obs, exp)
935     def test_replace_with_metadata(self):
936         seq = Sequence('GCACGGCAAGAAGCGCCCCA',
937                        metadata={'NM': 'Kestrel Gorlick'},
938                        positional_metadata={'diff':
939                                             list('01100001110010001100')})
940         seq.interval_metadata.add([(0, 1)], metadata={'gene': 'sagA'})
941         index = self._make_index('01100001110010001100')
942         obs = seq.replace(index, '-')
943         exp = Sequence('G--CGGC---AA-CGC--CA',
944                        metadata={'NM': 'Kestrel Gorlick'},
945                        positional_metadata={'diff':
946                                             list('01100001110010001100')})
947         exp.interval_metadata.add([(0, 1)], metadata={'gene': 'sagA'})
948         self.assertEqual(obs, exp)
949     def test_replace_with_subclass(self):
950         seq = DNA('CGACAACCGATGTGCTGTAA')
951         index = self._make_index('10101000111111110011')
952         obs = seq.replace(index, '-')
953         exp = DNA('-G-C-ACC--------GT--')
954         self.assertEqual(obs, exp)
955     def test_replace_with_bytes(self):
956         seq = Sequence('ABC123')
957         obs = seq.replace([1, 3, 5], b'*')
958         self.assertEqual(obs, Sequence('A*C*2*'))
959 <a name="39"></a>
960     def test_replace_invalid_char_for_type_error(self):
961         seq = DNA('TAAACGGAACGCTACGTCTG')
962         index <font color="#152dc6"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= self._make_index('01000001101011001001')
963         with self.assertRaisesRegex(ValueError, r"Invalid character.*'F'"):
964             seq.replace(index, 'F')
965     def test_replace_invalid_char_error(self):
966         seq =</b></font> Sequence('GGGAGCTAGA')
967         index = self._make_index('1000101110')
968         with self.assertRaisesRegex(UnicodeEncodeError,
969                                     r"can't encode character.*not in "
970                                     r"range\(128\)"):
971             seq.replace(index, '\uFFFF')
972     def test_replace_non_single_character_error(self):
973         seq = Sequence('CCGAACTGTC')
974         index = self._make_index('1100110011')
975         with self.assertRaisesRegex(TypeError, r'string of length 2 found'):
976             seq.replace(index, 'AB')
977     def _make_index(self, bools):
978         return [bool(int(char)) for char in bools]
979     def test_lowercase_mungeable_key(self):
980         self.assertEqual('AAAAaaaa', self<font color="#800517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.lowercase_seq.lowercase('key'))
981     def test_lowercase_array_key(self):
982         self.assertEqual('aaAAaaaa',
983                          self.lowercase_seq.lowercase(
984                              np.array([True, True, False, False, True, True,
985                                        True, True])))
986         self.</b></font>assertEqual('AaAAaAAA',
987                          self.lowercase_seq.lowercase([1, 4]))
988     def test_matches(self):
989         tested = 0
990         for constructor in self.sequence_kinds:
991             tested += 1
992             seq1 = Sequence("AACCEEGG")
993             seq2 = constructor("ABCDEFGH")
994             expected = np.array([True, False] * 4)
995             npt.assert_equal(seq1.matches(seq2), expected)
996         self.assertEqual(tested, 4)
997     def test_matches_on_subclass(self):
998         seq1 = Sequence("AACCEEGG")
999         seq2 = SequenceSubclass("ABCDEFGH")
1000         with self.assertRaises(TypeError):
1001             seq1.matches(seq2)
1002     def test_matches_unequal_length(self):
1003         seq1 = Sequence("AACCEEGG")
1004         seq2 = Sequence("TOOLONGTOCOMPARE")
1005         with self.assertRaises(ValueError):
1006             seq1.matches(seq2)
1007     def test_mismatches(self):
1008         tested = 0
1009         for constructor in self.sequence_kinds:
1010             tested += 1
1011             seq1 = Sequence("AACCEEGG")
1012             seq2 = constructor("ABCDEFGH")
1013             expected = np.array([False, True] * 4)
1014             npt.assert_equal(seq1.mismatches(seq2), expected)
1015         self.assertEqual(tested, 4)
1016     def test_mismatches_on_subclass(self):
1017         seq1 = Sequence("AACCEEGG")
1018         seq2 = SequenceSubclass("ABCDEFGH")
1019         with self.assertRaises(TypeError):
1020             seq1.mismatches(seq2)
1021     def test_mismatches_unequal_length(self):
1022         seq1 = Sequence("AACCEEGG")
1023         seq2 = Sequence("TOOLONGTOCOMPARE")
1024         with self.assertRaises(ValueError):
1025             seq1.mismatches(seq2)
1026     def test_mismatch_frequency(self):
1027         seq1 = Sequence("AACCEEGG")
1028         seq2 = Sequence("ABCDEFGH")
1029 <a name="12"></a>        seq3 = Sequence("TTTTTTTT")
1030         self.assertIs(type(seq1.mismatch_frequency(seq1)), int)
1031         self<font color="#571b7e"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertEqual(seq1.mismatch_frequency(seq1), 0)
1032         self.assertEqual(seq1.mismatch_frequency(seq2), 4)
1033         self.assertEqual(seq1.mismatch_frequency(seq3), 8)
1034     def test_mismatch_frequency_relative(self):
1035         seq1 =</b></font> Sequence("AACCEEGG")
1036 <a name="5"></a>        seq2 = Sequence("ABCDEFGH")
1037         seq3 = Sequence("TTTTTTTT")
1038         self.assertIs(type<font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>(seq1.mismatch_frequency(seq1, relative=True)),
1039                       float)
1040         self.assertEqual(seq1.mismatch_frequency(seq1, relative=True), 0.0)
1041         self.assertEqual(seq1.mismatch_frequency(seq2, relative=True), 0.5)
1042         self.assertEqual(seq1.mismatch_frequency(seq3, relative=</b></font>True), 1.0)
1043     def test_mismatch_frequency_unequal_length(self):
1044         seq1 = Sequence("AACCEEGG")
1045         seq2 = Sequence("TOOLONGTOCOMPARE")
1046         with self.assertRaises(ValueError):
1047             seq1.mismatch_frequency(seq2)
1048     def test_mismatch_frequence_on_subclass(self):
1049         seq1 = Sequence("AACCEEGG")
1050         seq2 = SequenceSubclass("ABCDEFGH")
1051         with self.assertRaises(TypeError):
1052             seq1.mismatch_frequency(seq2)
1053     def test_match_frequency(self):
1054         seq1 = Sequence("AACCEEGG")
1055         seq2 = Sequence("ABCDEFGH")
1056 <a name="11"></a>        seq3 = Sequence("TTTTTTTT")
1057         self.assertIs(type(seq1.match_frequency(seq1)), int)
1058         self<font color="#b041ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertEqual(seq1.match_frequency(seq1), 8)
1059         self.assertEqual(seq1.match_frequency(seq2), 4)
1060         self.assertEqual(seq1.match_frequency(seq3), 0)
1061     def test_match_frequency_relative(self):
1062         seq1 =</b></font> Sequence("AACCEEGG")
1063 <a name="4"></a>        seq2 = Sequence("ABCDEFGH")
1064         seq3 = Sequence("TTTTTTTT")
1065         self.assertIs(type<font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>(seq1.match_frequency(seq1, relative=True)),
1066                       float)
1067         self.assertEqual(seq1.match_frequency(seq1, relative=True), 1.0)
1068         self.assertEqual(seq1.match_frequency(seq2, relative=True), 0.5)
1069         self.assertEqual(seq1.match_frequency(seq3, relative=</b></font>True), 0.0)
1070     def test_match_frequency_unequal_length(self):
1071         seq1 = Sequence("AACCEEGG")
1072         seq2 = Sequence("TOOLONGTOCOMPARE")
1073         with self.assertRaises(ValueError):
1074             seq1.match_frequency(seq2)
1075     def test_match_frequency_on_subclass(self):
1076         seq1 = Sequence("AACCEEGG")
1077         seq2 = SequenceSubclass("ABCDEFGH")
1078         with self.assertRaises(TypeError):
1079             seq1.match_frequency(seq2)
1080     def test_index(self):
1081         tested = 0
1082         for c in self.sequence_kinds:
1083             tested += 1
1084             seq = Sequence("ABCDEFG@@ABCDFOO")
1085             self.assertEqual(seq.index(c("A")), 0)
1086             self.assertEqual(seq.index(c("@")), 7)
1087             self.assertEqual(seq.index(c("@@")), 7)
1088             with self.assertRaises(ValueError):
1089                 seq.index("A", start=1, end=5)
1090         self.assertEqual(tested, 4)
1091     def test_index_on_subclass(self):
1092         with self.assertRaises(TypeError):
1093             Sequence("ABCDEFG").index(SequenceSubclass("A"))
1094         self.assertEqual(
1095             SequenceSubclass("ABCDEFG").index(SequenceSubclass("A")), 0)
1096     def test_frequencies_empty_sequence(self):
1097         seq = Sequence('')
1098         self.assertEqual(seq.frequencies(), {})
1099         self.assertEqual(seq.frequencies(relative=True), {})
1100         self.assertEqual(seq.frequencies(chars=set()), {})
1101         self.assertEqual(seq.frequencies(chars=set(), relative=True), {})
1102         self.assertEqual(seq.frequencies(chars={'a', 'b'}), {'a': 0, 'b': 0})
1103         npt.assert_equal(seq.frequencies(chars={'a', 'b'}, relative=True),
1104                          {'a': np.nan, 'b': np.nan})
1105     def test_frequencies_observed_chars(self):
1106         seq = Sequence('x')
1107         self.assertEqual(seq.frequencies(), {'x': 1})
1108         self.assertEqual(seq.frequencies(relative=True), {'x': 1.0})
1109         seq = Sequence('xYz')
1110         self.assertEqual(seq.frequencies(), {'x': 1, 'Y': 1, 'z': 1})
1111         self.assertEqual(seq.frequencies(relative=True),
1112                          {'x': 1/3, 'Y': 1/3, 'z': 1/3})
1113         seq = Sequence('zzz')
1114         self.assertEqual(seq.frequencies(), {'z': 3})
1115         self.assertEqual(seq.frequencies(relative=True), {'z': 1.0})
1116         seq = Sequence('xYzxxZz')
1117         self.assertEqual(seq.frequencies(), {'x': 3, 'Y': 1, 'Z': 1, 'z': 2})
1118         self.assertEqual(seq.frequencies(relative=True),
1119                          {'x': 3/7, 'Y': 1/7, 'Z': 1/7, 'z': 2/7})
1120         seq = Sequence('\t   ')
1121         self.assertEqual(seq.frequencies(), {'\t': 1, ' ': 3})
1122         self.assertEqual(seq.frequencies(relative=True), {'\t': 1/4, ' ': 3/4})
1123         seq = Sequence('aabbcc', metadata={'foo': 'bar'},
1124                        positional_metadata={'foo': range(6)})
1125         self.assertEqual(seq.frequencies(), {'a': 2, 'b': 2, 'c': 2})
1126         self.assertEqual(seq.frequencies(relative=True),
1127                          {'a': 2/6, 'b': 2/6, 'c': 2/6})
1128     def test_frequencies_specified_chars(self):
1129         seq = Sequence('abcbca')
1130         self.assertEqual(seq.frequencies(chars=set()), {})
1131         self.assertEqual(seq.frequencies(chars=set(), relative=True), {})
1132         self.assertEqual(seq.frequencies(chars='a'), {'a': 2})
1133         self.assertEqual(seq.frequencies(chars='a', relative=True), {'a': 2/6})
1134         self.assertEqual(seq.frequencies(chars={'a'}), {'a': 2})
1135         self.assertEqual(seq.frequencies(chars={'a'}, relative=True),
1136                          {'a': 2/6})
1137         self.assertEqual(seq.frequencies(chars={'a', 'b'}), {'a': 2, 'b': 2})
1138         self.assertEqual(seq.frequencies(chars={'a', 'b'}, relative=True),
1139                          {'a': 2/6, 'b': 2/6})
1140         self.assertEqual(seq.frequencies(chars={'a', 'b', 'd'}),
1141                          {'a': 2, 'b': 2, 'd': 0})
1142         self.assertEqual(seq.frequencies(chars={'a', 'b', 'd'}, relative=True),
1143                          {'a': 2/6, 'b': 2/6, 'd': 0.0})
1144         self.assertEqual(seq.frequencies(chars={'x', 'y', 'z'}),
1145                          {'x': 0, 'y': 0, 'z': 0})
1146         self.assertEqual(seq.frequencies(chars={'x', 'y', 'z'}, relative=True),
1147                          {'x': 0.0, 'y': 0.0, 'z': 0.0})
1148     def test_frequencies_chars_varied_type(self):
1149         seq = Sequence('zabczzzabcz')
1150         chars = b'z'
1151         self.assertEqual(seq.frequencies(chars=chars), {b'z': 5})
1152         self.assertEqual(seq.frequencies(chars=chars, relative=True),
1153                          {b'z': 5/11})
1154         chars = 'z'
1155         self.assertEqual(seq.frequencies(chars=chars), {'z': 5})
1156         self.assertEqual(seq.frequencies(chars=chars, relative=True),
1157                          {'z': 5/11})
1158         chars = np.frombuffer('z'.encode('ascii'), dtype='|S1')[0]
1159         self.assertEqual(seq.frequencies(chars=chars), {b'z': 5})
1160         self.assertEqual(seq.frequencies(chars=chars, relative=True),
1161                          {b'z': 5/11})
1162         chars = {b'x', b'z'}
1163         self.assertEqual(seq.frequencies(chars=chars), {b'x': 0, b'z': 5})
1164         self.assertEqual(seq.frequencies(chars=chars, relative=True),
1165                          {b'x': 0.0, b'z': 5/11})
1166         chars = {'x', 'z'}
1167         self.assertEqual(seq.frequencies(chars=chars), {'x': 0, 'z': 5})
1168         self.assertEqual(seq.frequencies(chars=chars, relative=True),
1169                          {'x': 0.0, 'z': 5/11})
1170         chars = {
1171             np.frombuffer('x'.encode('ascii'), dtype='|S1')[0],
1172             np.frombuffer('z'.encode('ascii'), dtype='|S1')[0]
1173         }
1174         self.assertEqual(seq.frequencies(chars=chars), {b'x': 0, b'z': 5})
1175         self.assertEqual(seq.frequencies(chars=chars, relative=True),
1176                          {b'x': 0.0, b'z': 5/11})
1177     def test_frequencies_equivalent_to_kmer_frequencies_k_of_1(self):
1178         seq = Sequence('abcabc')
1179         exp = {'a': 2, 'b': 2, 'c': 2}
1180         self.assertEqual(seq.frequencies(chars=None), exp)
1181         self.assertEqual(seq.kmer_frequencies(k=1), exp)
1182         exp = {'a': 2/6, 'b': 2/6, 'c': 2/6}
1183         self.assertEqual(seq.frequencies(chars=None, relative=True), exp)
1184         self.assertEqual(seq.kmer_frequencies(k=1, relative=True), exp)
1185     def test_frequencies_passing_observed_chars_equivalent_to_default(self):
1186         seq = Sequence('abcabc')
1187         exp = {'a': 2, 'b': 2, 'c': 2}
1188         self.assertEqual(seq.frequencies(chars=None), exp)
1189         self.assertEqual(seq.frequencies(chars=seq.observed_chars), exp)
1190         exp = {'a': 2/6, 'b': 2/6, 'c': 2/6}
1191         self.assertEqual(seq.frequencies(chars=None, relative=True), exp)
1192         self.assertEqual(
1193             seq.frequencies(chars=seq.observed_chars, relative=True),
1194             exp)
1195     def test_frequencies_invalid_chars(self):
1196         seq = Sequence('abcabc')
1197         with self.assertRaisesRegex(ValueError, r'0 characters'):
1198             seq.frequencies(chars='')
1199         with self.assertRaisesRegex(ValueError, r'0 characters'):
1200             seq.frequencies(chars={''})
1201         with self.assertRaisesRegex(ValueError, r'2 characters'):
1202             seq.frequencies(chars='ab')
1203         with self.assertRaisesRegex(ValueError, r'2 characters'):
1204             seq.frequencies(chars={'b', 'ab'})
1205         with self.assertRaisesRegex(TypeError, r'string.*NoneType'):
1206             seq.frequencies(chars={'a', None})
1207         with self.assertRaisesRegex(ValueError, r'outside the range'):
1208             seq.frequencies(chars='\u1F30')
1209         with self.assertRaisesRegex(ValueError, r'outside the range'):
1210             seq.frequencies(chars={'c', '\u1F30'})
1211         with self.assertRaisesRegex(TypeError, r'set.*int'):
1212             seq.frequencies(chars=42)
1213     def _compare_kmers_results(self, observed, expected):
1214         for obs, exp in itertools.zip_longest(observed, expected,
1215                                               fillvalue=None):
1216 <a name="38"></a>            self.assertEqual(obs, exp)
1217     def test_iter_kmers(self):
1218         seq = Sequence('GATTACA', positional_metadata<font color="#348781"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>={'quality': range(7)})
1219 <a name="37"></a>        expected = [
1220             Sequence('G', positional_metadata={'quality': [0]}),
1221             Sequence('A', positional_metadata={'quality': [1]}),
1222             Sequence(</b></font>'T', positional_metadata<font color="#810541"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>={'quality': [2]}),
1223             Sequence('T', positional_metadata={'quality': [3]}),
1224             Sequence('A', positional_metadata={'quality': [4]}),
1225             Sequence('C', positional_metadata={'quality': [5]}),
1226             Sequence(</b></font>'A', positional_metadata={'quality': [6]})
1227         ]
1228         self._compare_kmers_results(
1229             seq.iter_kmers(1, overlap=False), expected)
1230         expected = [
1231             Sequence('GA', positional_metadata={'quality': [0, 1]}),
1232             Sequence('TT', positional_metadata={'quality': [2, 3]}),
1233             Sequence('AC', positional_metadata={'quality': [4, 5]})
1234         ]
1235         self._compare_kmers_results(
1236             seq.iter_kmers(2, overlap=False), expected)
1237         expected = [
1238             Sequence('GAT', positional_metadata={'quality': [0, 1, 2]}),
1239             Sequence('TAC', positional_metadata={'quality': [3, 4, 5]})
1240         ]
1241         self._compare_kmers_results(
1242             seq.iter_kmers(3, overlap=False), expected)
1243         expected = [
1244 <a name="25"></a>            Sequence('GATTACA',
1245                      positional_metadata={'quality': [0, 1, 2, 3, 4, 5, 6]})
1246         ]
1247         self<font color="#5eac10"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>._compare_kmers_results(
1248             seq.iter_kmers(7, overlap=False), expected)
1249         expected = []
1250         self._compare_kmers_results(
1251             seq.iter_kmers(8, overlap=False), expected)
1252         self.assertIs(</b></font>type(seq.iter_kmers(1)), GeneratorType)
1253     def test_iter_kmers_no_positional_metadata(self):
1254         seq = Sequence('GATTACA')
1255         expected = [
1256             Sequence('G'),
1257             Sequence('A'),
1258             Sequence('T'),
1259             Sequence('T'),
1260             Sequence('A'),
1261             Sequence('C'),
1262             Sequence('A')
1263         ]
1264         self._compare_kmers_results(
1265             seq.iter_kmers(1, overlap=False), expected)
1266         expected = [
1267             Sequence('GA'),
1268             Sequence('TT'),
1269             Sequence('AC')
1270         ]
1271         self._compare_kmers_results(
1272             seq.iter_kmers(2, overlap=False), expected)
1273         expected = [
1274             Sequence('GAT'),
1275             Sequence('TAC')
1276         ]
1277         self._compare_kmers_results(
1278             seq.iter_kmers(3, overlap=False), expected)
1279 <a name="24"></a>        expected = [
1280             Sequence('GATTACA')
1281         ]
1282         self<font color="#79764d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>._compare_kmers_results(
1283             seq.iter_kmers(7, overlap=False), expected)
1284         expected = []
1285         self._compare_kmers_results(
1286             seq.iter_kmers(8, overlap=False), expected)
1287 <a name="36"></a>        self.assertIs(</b></font>type(seq.iter_kmers(1)), GeneratorType)
1288     def test_iter_kmers_with_overlap(self):
1289         seq = Sequence('GATTACA', positional_metadata={<font color="#ff00ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>'quality': range(7)})
1290         expected = [
1291             Sequence('G', positional_metadata={'quality': [0]}),
1292             Sequence('A', positional_metadata={'quality': [1]}),
1293             Sequence('T', positional_metadata=</b></font>{'quality': [2]}),
1294             Sequence('T', positional_metadata={'quality': [3]}),
1295             Sequence('A', positional_metadata={'quality': [4]}),
1296             Sequence('C', positional_metadata={'quality': [5]}),
1297             Sequence('A', positional_metadata={'quality': [6]})
1298         ]
1299         self._compare_kmers_results(
1300             seq.iter_kmers(1, overlap=True), expected)
1301         expected = [
1302             Sequence('GA', positional_metadata={'quality': [0, 1]}),
1303             Sequence('AT', positional_metadata={'quality': [1, 2]}),
1304             Sequence('TT', positional_metadata={'quality': [2, 3]}),
1305             Sequence('TA', positional_metadata={'quality': [3, 4]}),
1306             Sequence('AC', positional_metadata={'quality': [4, 5]}),
1307             Sequence('CA', positional_metadata={'quality': [5, 6]})
1308         ]
1309         self._compare_kmers_results(
1310             seq.iter_kmers(2, overlap=True), expected)
1311         expected = [
1312             Sequence('GAT', positional_metadata={'quality': [0, 1, 2]}),
1313             Sequence('ATT', positional_metadata={'quality': [1, 2, 3]}),
1314             Sequence('TTA', positional_metadata={'quality': [2, 3, 4]}),
1315             Sequence('TAC', positional_metadata={'quality': [3, 4, 5]}),
1316             Sequence('ACA', positional_metadata={'quality': [4, 5, 6]})
1317         ]
1318         self._compare_kmers_results(
1319             seq.iter_kmers(3, overlap=True), expected)
1320         expected = [
1321             Sequence('GATTACA',
1322                      positional_metadata={'quality': [0, 1, 2, 3, 4, 5, 6]})
1323         ]
1324         self._compare_kmers_results(
1325             seq.iter_kmers(7, overlap=True), expected)
1326         expected = []
1327         self._compare_kmers_results(
1328             seq.iter_kmers(8, overlap=True), expected)
1329         self.assertIs(type(seq.iter_kmers(1)), GeneratorType)
1330     def test_iter_kmers_with_overlap_no_positional_metadata(self):
1331         seq = Sequence('GATTACA')
1332         expected = [
1333             Sequence('G'),
1334             Sequence('A'),
1335             Sequence('T'),
1336             Sequence('T'),
1337             Sequence('A'),
1338             Sequence('C'),
1339             Sequence('A')
1340         ]
1341         self._compare_kmers_results(
1342             seq.iter_kmers(1, overlap=True), expected)
1343         expected = [
1344             Sequence('GA'),
1345             Sequence('AT'),
1346             Sequence('TT'),
1347             Sequence('TA'),
1348             Sequence('AC'),
1349             Sequence('CA')
1350         ]
1351         self._compare_kmers_results(
1352             seq.iter_kmers(2, overlap=True), expected)
1353         expected = [
1354             Sequence('GAT'),
1355             Sequence('ATT'),
1356             Sequence('TTA'),
1357             Sequence('TAC'),
1358             Sequence('ACA')
1359         ]
1360         self._compare_kmers_results(
1361             seq.iter_kmers(3, overlap=True), expected)
1362         expected = [
1363             Sequence('GATTACA')
1364         ]
1365         self._compare_kmers_results(
1366             seq.iter_kmers(7, overlap=True), expected)
1367         expected = []
1368         self._compare_kmers_results(
1369             seq.iter_kmers(8, overlap=True), expected)
1370         self.assertIs(type(seq.iter_kmers(1)), GeneratorType)
1371     def test_iter_kmers_invalid_k(self):
1372         seq = Sequence('GATTACA', positional_metadata={'quality': range(7)})
1373         with self.assertRaises(ValueError):
1374             list(seq.iter_kmers(0))
1375         with self.assertRaises(ValueError):
1376             list(seq.iter_kmers(-42))
1377     def test_iter_kmers_invalid_k_no_positional_metadata(self):
1378         seq = Sequence('GATTACA')
1379         with self.assertRaises(ValueError):
1380             list(seq.iter_kmers(0))
1381         with self.assertRaises(ValueError):
1382             list(seq.iter_kmers(-42))
1383     def test_iter_kmers_different_sequences(self):
1384         seq = Sequence('HE..--..LLO',
1385                        metadata={'id': 'hello', 'desc': 'gapped hello'},
1386                        positional_metadata={'quality': range(11)})
1387         expected = [
1388             Sequence('HE.', positional_metadata={'quality': [0, 1, 2]},
1389                      metadata={'id': 'hello', 'desc': 'gapped hello'}),
1390             Sequence('.--', positional_metadata={'quality': [3, 4, 5]},
1391                      metadata={'id': 'hello', 'desc': 'gapped hello'}),
1392             Sequence('..L', positional_metadata={'quality': [6, 7, 8]},
1393                      metadata={'id': 'hello', 'desc': 'gapped hello'})
1394         ]
1395         self._compare_kmers_results(seq.iter_kmers(3, overlap=False), expected)
1396 <a name="35"></a>
1397     def test_iter_kmers_different_sequences_no_positional_metadata(self):
1398         seq = Sequence('HE..--..LLO',
1399                        metadata<font color="#41a317"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>={'id': 'hello', 'desc': 'gapped hello'})
1400         expected = [
1401             Sequence('HE.',
1402                      metadata={'id': 'hello', 'desc': 'gapped hello'}),
1403             Sequence('.--',
1404                      metadata={'id': 'hello', 'desc': 'gapped hello'}),
1405             Sequence('..L',
1406                      metadata=</b></font>{'id': 'hello', 'desc': 'gapped hello'})
1407         ]
1408         self._compare_kmers_results(seq.iter_kmers(3, overlap=False), expected)
1409     def test_iter_kmers_empty_sequence(self):
1410         seq = Sequence('')
1411         expected = []
1412         self._compare_kmers_results(seq.iter_kmers(3, overlap=False), expected)
1413     def test_iter_kmers_empty_sequence_with_positional_metadata(self):
1414         seq = Sequence('', positional_metadata={'quality': []})
1415         expected = []
1416         self._compare_kmers_results(seq.iter_kmers(3, overlap=False), expected)
1417     def test_kmer_frequencies_empty_sequence(self):
1418 <a name="10"></a>        seq = Sequence('')
1419         self.assertEqual(seq.kmer_frequencies(1), {})
1420         self<font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertEqual(seq.kmer_frequencies(1, overlap=False), {})
1421         self.assertEqual(seq.kmer_frequencies(1, relative=True), {})
1422         self.assertEqual(seq.kmer_frequencies(1, relative=</b></font>True, overlap=False),
1423                          {})
1424     def test_kmer_frequencies(self):
1425         seq = Sequence('GATTACA', positional_metadata={'quality': range(7)})
1426         expected = {'G': 1, 'A': 3, 'T': 2, 'C': 1}
1427         self.assertEqual(seq.kmer_frequencies(1, overlap=True), expected)
1428         expected = {'GAT': 1, 'ATT': 1, 'TTA': 1, 'TAC': 1, 'ACA': 1}
1429 <a name="34"></a>        self.assertEqual(seq.kmer_frequencies(3, overlap=True), expected)
1430         expected = {}
1431         self.assertEqual(seq.kmer_frequencies(8, overlap<font color="#827d6b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=True), expected)
1432         expected = {'GAT': 1, 'TAC': 1}
1433         self.assertEqual(seq.kmer_frequencies(3, overlap=False), expected)
1434         expected = {'GATTACA': 1}
1435         self.assertEqual(</b></font>seq.kmer_frequencies(7, overlap=False), expected)
1436         expected = {}
1437         self.assertEqual(seq.kmer_frequencies(8, overlap=False), expected)
1438     def test_kmer_frequencies_relative(self):
1439         seq = Sequence('GATTACA', positional_metadata={'quality': range(7)})
1440         expected = {'A': 3/7, 'C': 1/7, 'G': 1/7, 'T': 2/7}
1441         self.assertEqual(seq.kmer_frequencies(1, overlap=True, relative=True),
1442                          expected)
1443         expected = {'GAT': 1/5, 'ATT': 1/5, 'TTA': 1/5, 'TAC': 1/5, 'ACA': 1/5}
1444         self.assertEqual(seq.kmer_frequencies(3, overlap=True, relative=True),
1445                          expected)
1446         expected = {}
1447         self.assertEqual(seq.kmer_frequencies(8, overlap=True, relative=True),
1448                          expected)
1449         expected = {'GAT': 1/2, 'TAC': 1/2}
1450         self.assertEqual(seq.kmer_frequencies(3, overlap=False, relative=True),
1451                          expected)
1452         expected = {'GATTACA': 1.0}
1453         self.assertEqual(seq.kmer_frequencies(7, overlap=False, relative=True),
1454                          expected)
1455         expected = {}
1456         self.assertEqual(seq.kmer_frequencies(8, overlap=False, relative=True),
1457                          expected)
1458     def test_kmer_frequencies_floating_point_precision(self):
1459         seq = Sequence('AAAAAAAAAA')
1460         self.assertEqual(seq.kmer_frequencies(1, relative=True), {'A': 1.0})
1461     def test_find_with_regex(self):
1462         seq = Sequence('GATTACA', positional_metadata={'quality': range(7)})
1463         pat = re.compile('(T+A)(CA)')
1464         obs = list(seq.find_with_regex(pat))
1465         exp = [slice(2, 5), slice(5, 7)]
1466         self.assertEqual(obs, exp)
1467         self.assertIs(type(seq.find_with_regex(pat)), GeneratorType)
1468     def test_find_with_regex_string_as_input(self):
1469         seq = Sequence('GATTACA', positional_metadata={'quality': range(7)})
1470         pat = '(T+A)(CA)'
1471         obs = list(seq.find_with_regex(pat))
1472         exp = [slice(2, 5), slice(5, 7)]
1473         self.assertEqual(obs, exp)
1474         self.assertIs(type(seq.find_with_regex(pat)), GeneratorType)
1475     def test_find_with_regex_no_groups(self):
1476         seq = Sequence('GATTACA', positional_metadata={'quality': range(7)})
1477         pat = re.compile('(FOO)')
1478         self.assertEqual(list(seq.find_with_regex(pat)), [])
1479     def test_find_with_regex_ignore_no_difference(self):
1480 <a name="33"></a>        seq = Sequence('..ABCDEFG..')
1481         pat = "([A-Z]+)"
1482         exp = [slice(2, 9)]
1483         self.assertEqual(list(seq<font color="#736aff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.find_with_regex(pat)), exp)
1484         obs = seq.find_with_regex(
1485             pat, ignore=np.array([1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1],
1486                                  dtype=bool))
1487         self.assertEqual(</b></font>list(obs), exp)
1488     def test_find_with_regex_ignore(self):
1489         obs = Sequence('A..A..BBAAB.A..AB..A.').find_with_regex(
1490             "(A+)", ignore=np.array([0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1,
1491                                      1, 0, 0, 1, 1, 0, 1], dtype=bool))
1492         self.assertEqual(list(obs), [slice(0, 4), slice(8, 10), slice(12, 16),
1493                                      slice(19, 20)])
1494     def test_find_with_regex_ignore_index_array(self):
1495         obs = Sequence('A..A..BBAAB.A..AB..A.').find_with_regex(
1496             "(A+)", ignore=np.array([1, 2, 4, 5, 11, 13, 14, 17, 18, 20]))
1497         self.assertEqual(list(obs), [slice(0, 4), slice(8, 10), slice(12, 16),
1498                                      slice(19, 20)])
1499     def test_iter_contiguous_index_array(self):
1500         s = Sequence("0123456789abcdef")
1501         for c in list, tuple, np.array, pd.Series:
1502             exp = [Sequence("0123"), Sequence("89ab")]
1503             obs = s.iter_contiguous(c([0, 1, 2, 3, 8, 9, 10, 11]))
1504             self.assertEqual(list(obs), exp)
1505     def test_iter_contiguous_boolean_vector(self):
1506         s = Sequence("0123456789abcdef")
1507         for c in list, tuple, np.array, pd.Series:
1508             exp = [Sequence("0123"), Sequence("89ab")]
1509             obs = s.iter_contiguous(c(([True] * 4 + [False] * 4) * 2))
1510             self.assertEqual(list(obs), exp)
1511     def test_iter_contiguous_iterable_slices(self):
1512         def spaced_out():
1513             yield slice(0, 4)
1514             yield slice(8, 12)
1515         def contiguous():
1516             yield slice(0, 4)
1517             yield slice(4, 8)
1518             yield slice(12, 16)
1519         s = Sequence("0123456789abcdef")
1520         for c in (lambda x: x, list, tuple, lambda x: np.array(tuple(x)),
1521                   lambda x: pd.Series(tuple(x))):
1522             exp = [Sequence("0123"), Sequence("89ab")]
1523             obs = s.iter_contiguous(c(spaced_out()))
1524             self.assertEqual(list(obs), exp)
1525             exp = [Sequence("01234567"), Sequence("cdef")]
1526             obs = s.iter_contiguous(c(contiguous()))
1527             self.assertEqual(list(obs), exp)
1528     def test_iter_contiguous_with_max_length(self):
1529         s = Sequence("0123456789abcdef")
1530         for c in list, tuple, np.array, pd.Series:
1531             exp = [Sequence("234"), Sequence("678"), Sequence("abc")]
1532             obs = s.iter_contiguous(c([True, False, True, True] * 4),
1533                                     min_length=3)
1534             self.assertEqual(list(obs), exp)
1535             exp = [Sequence("0"), Sequence("234"), Sequence("678"),
1536                    Sequence("abc"), Sequence("ef")]
1537             obs1 = list(s.iter_contiguous(c([True, False, True, True] * 4),
1538                                           min_length=1))
1539             obs2 = list(s.iter_contiguous(c([True, False, True, True] * 4)))
1540             self.assertEqual(obs1, obs2)
1541             self.assertEqual(obs1, exp)
1542     def test_iter_contiguous_with_invert(self):
1543         def spaced_out():
1544             yield slice(0, 4)
1545             yield slice(8, 12)
1546         def contiguous():
1547             yield slice(0, 4)
1548             yield slice(4, 8)
1549             yield slice(12, 16)
1550         s = Sequence("0123456789abcdef")
1551         for c in (lambda x: x, list, tuple, lambda x: np.array(tuple(x)),
1552                   lambda x: pd.Series(tuple(x))):
1553             exp = [Sequence("4567"), Sequence("cdef")]
1554             obs = s.iter_contiguous(c(spaced_out()), invert=True)
1555             self.assertEqual(list(obs), exp)
1556             exp = [Sequence("89ab")]
1557             obs = s.iter_contiguous(c(contiguous()), invert=True)
1558             self.assertEqual(list(obs), exp)
1559     def test_copy_without_metadata(self):
1560         for copy_method in copy.copy, copy.deepcopy:
1561             seq = Sequence('ACGT')
1562             seq_copy = copy_method(seq)
1563             self.assertEqual(seq_copy, seq)
1564             self.assertIsNot(seq_copy, seq)
1565             self.assertIsNot(seq_copy._bytes, seq._bytes)
1566     def test_copy_with_metadata_shallow(self):
1567         seq = Sequence('ACGT', metadata={'foo': [1]},
1568                        positional_metadata={'bar': [[], [], [], []],
1569 <a name="23"></a>                                            'baz': [42, 42, 42, 42]})
1570         seq.interval_metadata.add([(0, 3)], metadata={'gene': ['sagA']})
1571         seq_copy = copy<font color="#f660ab"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.copy(seq)
1572         self.assertEqual(seq_copy, seq)
1573 <a name="1"></a>        self.assertIsNot(seq_copy, seq)
1574         self.assertIsNot(seq_copy._bytes, seq._bytes)
1575         self.assertIsNot(seq_copy.</b></font>_metadata, seq._metadata)
1576         self.assertIsNot<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>(seq_copy._positional_metadata,
1577                          seq._positional_metadata)
1578         self.assertIsNot(seq_copy._positional_metadata.values,
1579                          seq._positional_metadata.values)
1580 <a name="3"></a>        self.assertIs(seq_copy._metadata['foo'], seq._metadata['foo'])
1581         self.assertIs(seq_copy._positional_metadata.loc[0, 'bar'],
1582                       seq.</b></font>_positional_metadata.loc[0, 'bar'])
1583         self.assertIsNot<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>(seq_copy.interval_metadata, seq.interval_metadata)
1584         self.assertIsNot(seq_copy.interval_metadata._intervals[0],
1585                          seq.interval_metadata._intervals[0])
1586         self.assertIsNot(seq_copy.interval_metadata._intervals[0].metadata,
1587                          seq.interval_metadata._intervals[</b></font>0].metadata)
1588         self.assertIs(
1589             seq_copy.interval_metadata._intervals[0].metadata['gene'],
1590             seq.interval_metadata._intervals[0].metadata['gene'])
1591 <a name="7"></a>        seq_copy.metadata['foo'].append(2)
1592         seq_copy.metadata['foo2'] = 42
1593         self.assertEqual(seq_copy<font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.metadata, {'foo': [1, 2], 'foo2': 42})
1594         self.assertEqual(seq.metadata, {'foo': [1, 2]})
1595 <a name="17"></a>        seq_copy.positional_metadata.loc[0, 'bar'].append(1)
1596         seq_copy.positional_metadata.loc[</b></font>0, 'baz'] = 43
1597         assert_data_frame_almost_equal<font color="#3090c7"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>(
1598             seq_copy.positional_metadata,
1599             pd.DataFrame({'bar': [[1], [], [], []],
1600                           'baz': [43, 42, 42, 42]}))
1601         assert_data_frame_almost_equal(
1602             seq.positional_metadata,
1603             pd.DataFrame({'bar': [[1], [], [], []],
1604                           'baz': [42</b></font>, 42, 42, 42]}))
1605     def test_copy_with_metadata_deep(self):
1606         seq = Sequence('ACGT', metadata={'foo': [1]},
1607 <a name="22"></a>                       positional_metadata={'bar': [[], [], [], []],
1608                                             'baz': [42, 42, 42, 42]})
1609         seq.interval_metadata.add([(0, 3)], metadata={'gene': ['sagA']})
1610         seq_copy = copy.deepcopy<font color="#4cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>(seq)
1611         self.assertEqual(seq_copy, seq)
1612 <a name="0"></a>        self.assertIsNot(seq_copy, seq)
1613         self.assertIsNot(seq_copy._bytes, seq._bytes)
1614         self.assertIsNot(seq_copy._metadata, seq.</b></font>_metadata)
1615         self.assertIsNot(seq_copy<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>._positional_metadata,
1616                          seq._positional_metadata)
1617         self.assertIsNot(seq_copy._positional_metadata.values,
1618                          seq._positional_metadata.values)
1619 <a name="2"></a>        self.assertIsNot(seq_copy._metadata['foo'], seq._metadata['foo'])
1620         self.assertIsNot(seq_copy._positional_metadata.loc[0, 'bar'],
1621                          seq._positional_metadata.</b></font>loc[0, 'bar'])
1622         self.assertIsNot<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>(seq_copy.interval_metadata, seq.interval_metadata)
1623         self.assertIsNot(seq_copy.interval_metadata._intervals[0],
1624                          seq.interval_metadata._intervals[0])
1625         self.assertIsNot(seq_copy.interval_metadata._intervals[0].metadata,
1626                          seq.interval_metadata._intervals[</b></font>0].metadata)
1627         self.assertIsNot(
1628             seq_copy.interval_metadata._intervals[0].metadata['gene'],
1629             seq.interval_metadata._intervals[0].metadata['gene'])
1630 <a name="32"></a>        seq_copy.metadata['foo'].append(2)
1631         seq_copy.metadata['foo2'] = 42
1632         self<font color="#5b8daf"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.assertEqual(seq_copy.metadata, {'foo': [1, 2], 'foo2': 42})
1633         self.assertEqual(seq.metadata, {'foo': [1]})
1634 <a name="16"></a>        seq_copy.positional_metadata.loc[</b></font>0, 'bar'].append(1)
1635         seq_copy.positional_metadata.loc[0, 'baz'] = 43
1636         assert_data_frame_almost_equal<font color="#2981b2"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>(
1637             seq_copy.positional_metadata,
1638             pd.DataFrame({'bar': [[1], [], [], []],
1639                           'baz': [43, 42, 42, 42]}))
1640         assert_data_frame_almost_equal(
1641             seq.positional_metadata,
1642             pd.DataFrame({'bar': [[], [], [], []],
1643                           'baz': [42</b></font>, 42, 42, 42]}))
1644     def test_copy_preserves_read_only_flag_on_bytes(self):
1645         seq = Sequence('ACGT')
1646         seq_copy = copy.copy(seq)
1647         with self.assertRaises(ValueError):
1648             seq_copy._bytes[0] = 'B'
1649     def test_deepcopy_memo_is_respected(self):
1650         seq = Sequence('ACGT', metadata={'foo': 'bar'})
1651         memo = {}
1652         copy.deepcopy(seq, memo)
1653         self.assertGreater(len(memo), 2)
1654     def test_munge_to_index_array_valid_index_array(self):
1655         s = Sequence('123456')
1656         for c in list, tuple, np.array, pd.Series:
1657             exp = np.array([1, 2, 3], dtype=int)
1658             obs = s._munge_to_index_array(c([1, 2, 3]))
1659             npt.assert_equal(obs, exp)
1660             exp = np.array([1, 3, 5], dtype=int)
1661             obs = s._munge_to_index_array(c([1, 3, 5]))
1662             npt.assert_equal(obs, exp)
1663     def test_munge_to_index_array_invalid_index_array(self):
1664         s = Sequence("12345678")
1665         for c in list, tuple, np.array, pd.Series:
1666             with self.assertRaises(ValueError):
1667                 s._munge_to_index_array(c([3, 2, 1]))
1668             with self.assertRaises(ValueError):
1669                 s._munge_to_index_array(c([5, 6, 7, 2]))
1670             with self.assertRaises(ValueError):
1671                 s._munge_to_index_array(c([0, 1, 2, 1]))
1672     def test_munge_to_index_array_valid_bool_array(self):
1673         s = Sequence('123456')
1674         for c in list, tuple, np.array, pd.Series:
1675             exp = np.array([2, 3, 5], dtype=int)
1676             obs = s._munge_to_index_array(
1677                 c([False, False, True, True, False, True]))
1678             npt.assert_equal(obs, exp)
1679             exp = np.array([], dtype=int)
1680             obs = s._munge_to_index_array(
1681                 c([False] * 6))
1682             npt.assert_equal(obs, exp)
1683             exp = np.arange(6)
1684             obs = s._munge_to_index_array(
1685                 c([True] * 6))
1686             npt.assert_equal(obs, exp)
1687     def test_munge_to_index_array_invalid_bool_array(self):
1688         s = Sequence('123456')
1689         for c in (list, tuple, lambda x: np.array(x, dtype=bool),
1690                   lambda x: pd.Series(x, dtype=bool)):
1691             with self.assertRaises(ValueError):
1692                 s._munge_to_index_array(c([]))
1693             with self.assertRaises(ValueError):
1694                 s._munge_to_index_array(c([True]))
1695             with self.assertRaises(ValueError):
1696                 s._munge_to_index_array(c([True] * 10))
1697     def test_munge_to_index_array_valid_iterable(self):
1698         s = Sequence('')
1699         def slices_only():
1700             return (slice(i, i+1) for i in range(0, 10, 2))
1701         def mixed():
1702             return (slice(i, i+1) if i % 2 == 0 else i for i in range(10))
1703         def unthinkable():
1704             for i in range(10):
1705                 if i % 3 == 0:
1706                     yield slice(i, i+1)
1707                 elif i % 3 == 1:
1708                     yield i
1709                 else:
1710                     yield np.array([i], dtype=int)
1711         for c in (lambda x: x, list, tuple, lambda x: np.array(tuple(x)),
1712                   lambda x: pd.Series(tuple(x))):
1713             exp = np.arange(10, dtype=int)
1714             obs = s._munge_to_index_array(c(mixed()))
1715             npt.assert_equal(obs, exp)
1716             exp = np.arange(10, dtype=int)
1717             obs = s._munge_to_index_array(c(unthinkable()))
1718             npt.assert_equal(obs, exp)
1719             exp = np.arange(10, step=2, dtype=int)
1720             obs = s._munge_to_index_array(c(slices_only()))
1721             npt.assert_equal(obs, exp)
1722     def test_munge_to_index_array_invalid_iterable(self):
1723         s = Sequence('')
1724         def bad1():
1725             yield "r"
1726             yield [1, 2, 3]
1727         def bad2():
1728             yield 1
1729             yield 'str'
1730         def bad3():
1731             yield False
1732             yield True
1733             yield 2
1734         def bad4():
1735             yield np.array([False, True])
1736             yield slice(2, 5)
1737         for c in (lambda x: x, list, tuple, lambda x: np.array(tuple(x)),
1738                   lambda x: pd.Series(tuple(x))):
1739             with self.assertRaises(TypeError):
1740                 s._munge_to_index_array(bad1())
1741             with self.assertRaises(TypeError):
1742                 s._munge_to_index_array(bad2())
1743             with self.assertRaises(TypeError):
1744                 s._munge_to_index_array(bad3())
1745             with self.assertRaises(TypeError):
1746                 s._munge_to_index_array(bad4())
1747     def test_munge_to_index_array_valid_string(self):
1748         seq = Sequence('ACGTACGT',
1749                        positional_metadata={'introns': [False, True, True,
1750                                                         False, False, True,
1751                                                         False, False]})
1752         npt.assert_equal(np.array([1, 2, 5]),
1753                          seq._munge_to_index_array('introns'))
1754         seq.positional_metadata['exons'] = ~seq.positional_metadata['introns']
1755         npt.assert_equal(np.array([0, 3, 4, 6, 7]),
1756                          seq._munge_to_index_array('exons'))
1757     def test_munge_to_index_array_invalid_string(self):
1758         seq_str = 'ACGT'
1759         seq = Sequence(seq_str,
1760                        positional_metadata={'quality': range(len(seq_str))})
1761         with self.assertRaisesRegex(ValueError,
1762                                     r"No positional metadata associated with "
1763                                     "key 'introns'"):
1764             seq._munge_to_index_array('introns')
1765         with self.assertRaisesRegex(TypeError,
1766                                     r"Column 'quality' in positional metadata "
1767                                     "does not correspond to a boolean "
1768                                     "vector"):
1769             seq._munge_to_index_array('quality')
1770     def test_munge_to_bytestring_return_bytes(self):
1771         seq = Sequence('')
1772         m = 'dummy_method'
1773         str_inputs = ('', 'a', 'acgt')
1774         unicode_inputs = ('', 'a', 'acgt')
1775         byte_inputs = (b'', b'a', b'acgt')
1776         seq_inputs = (Sequence(''), Sequence('a'), Sequence('acgt'))
1777         all_inputs = str_inputs + unicode_inputs + byte_inputs + seq_inputs
1778         all_expected = [b'', b'a', b'acgt'] * 4
1779         for input_, expected in zip(all_inputs, all_expected):
1780             observed = seq._munge_to_bytestring(input_, m)
1781             self.assertEqual(observed, expected)
1782             self.assertIs(type(observed), bytes)
1783     def test_munge_to_bytestring_unicode_out_of_ascii_range(self):
1784         seq = Sequence('')
1785         all_inputs = ('\x80', 'abc\x80', '\x80abc')
1786         for input_ in all_inputs:
1787             with self.assertRaisesRegex(UnicodeEncodeError,
1788                                         r"'ascii' codec can't encode character"
1789                                         r".*in position.*: ordinal not in"
1790                                         r" range\(128\)"):
1791                 seq._munge_to_bytestring(input_, 'dummy_method')
1792 class TestDistance(TestSequenceBase):
1793     def test_mungeable_inputs_to_sequence(self):
1794         def metric(a, b):
1795             self.assertEqual(a, Sequence("abcdef"))
1796             self.assertEqual(b, Sequence("12bcef"))
1797             return 42.0
1798         for constructor in self.sequence_kinds:
1799             seq1 = Sequence("abcdef")
1800             seq2 = constructor("12bcef")
1801             distance = seq1.distance(seq2, metric=metric)
1802             self.assertEqual(distance, 42.0)
1803     def test_mungeable_inputs_to_sequence_subclass(self):
1804         def metric(a, b):
1805             self.assertEqual(a, SequenceSubclass("abcdef"))
1806             self.assertEqual(b, SequenceSubclass("12bcef"))
1807             return -42.0
1808         sequence_kinds = frozenset([
1809             str, SequenceSubclass,
1810             lambda s: np.frombuffer(s.encode('ascii'), dtype='|S1'),
1811             lambda s: np.frombuffer(s.encode('ascii'), dtype=np.uint8)])
1812         for constructor in sequence_kinds:
1813             seq1 = SequenceSubclass("abcdef")
1814             seq2 = constructor("12bcef")
1815             distance = seq1.distance(seq2, metric=metric)
1816             self.assertEqual(distance, -42.0)
1817     def test_sequence_type_mismatch(self):
1818         seq1 = SequenceSubclass("abcdef")
1819         seq2 = Sequence("12bcef")
1820         with self.assertRaisesRegex(TypeError,
1821                                     r'SequenceSubclass.*Sequence.*`distance`'):
1822             seq1.distance(seq2)
1823         with self.assertRaisesRegex(TypeError,
1824                                     r'Sequence.*SequenceSubclass.*`distance`'):
1825             seq2.distance(seq1)
1826     def test_munging_invalid_characters_to_self_type(self):
1827         with self.assertRaisesRegex(ValueError, r'Invalid characters.*X'):
1828             DNA("ACGT").distance("WXYZ")
1829     def test_munging_invalid_type_to_self_type(self):
1830         with self.assertRaises(TypeError):
1831             Sequence("ACGT").distance(42)
1832     def test_return_type_coercion(self):
1833         def metric(a, b):
1834             return 42
1835         distance = Sequence('abc').distance('cba', metric=metric)
1836         self.assertIsInstance(distance, float)
1837     def test_invalid_return_type(self):
1838         def metric(a, b):
1839             return 'too far'
1840         with self.assertRaisesRegex(ValueError, r'string.*float'):
1841             Sequence('abc').distance('cba', metric=metric)
1842     def test_arbitrary_metric(self):
1843         def metric(x, y):
1844             return len(x) ** 2 + len(y) ** 2
1845         seq1 = Sequence("12345678")
1846         seq2 = Sequence("1234")
1847         distance = seq1.distance(seq2, metric=metric)
1848         self.assertEqual(distance, 80.0)
1849     def test_scipy_hamming_metric_with_metadata(self):
1850         seqs1 = [
1851             Sequence("ACGT"),
1852             Sequence("ACGT", metadata={'id': 'abc'}),
1853             Sequence("ACGT", positional_metadata={'qual': range(4)})
1854         ]
1855         seqs2 = [
1856             Sequence("AAAA"),
1857             Sequence("AAAA", metadata={'id': 'def'}),
1858             Sequence("AAAA", positional_metadata={'qual': range(4, 8)})
1859         ]
1860         for seqs in seqs1, seqs2:
1861             for seq1, seq2 in itertools.product(seqs, repeat=2):
1862                 distance = seq1.distance(seq2,
1863                                          metric=scipy.spatial.distance.hamming)
1864                 self.assertEqual(distance, 0.0)
1865         for seq1, seq2 in itertools.product(seqs1, seqs2):
1866             distance = seq1.distance(seq2,
1867                                      metric=scipy.spatial.distance.hamming)
1868             self.assertEqual(distance, 0.75)
1869     def test_default_metric_with_metadata(self):
1870         seqs1 = [
1871             Sequence("ACGT"),
1872             Sequence("ACGT", metadata={'id': 'abc'}),
1873             Sequence("ACGT", positional_metadata={'qual': range(4)})
1874         ]
1875         seqs2 = [
1876             Sequence("AAAA"),
1877             Sequence("AAAA", metadata={'id': 'def'}),
1878             Sequence("AAAA", positional_metadata={'qual': range(4, 8)})
1879         ]
1880         for seqs in seqs1, seqs2:
1881             for seq1, seq2 in itertools.product(seqs, repeat=2):
1882                 distance = seq1.distance(seq2)
1883                 self.assertEqual(distance, 0.0)
1884         for seq1, seq2 in itertools.product(seqs1, seqs2):
1885             distance = seq1.distance(seq2)
1886             self.assertEqual(distance, 0.75)
1887     def test_default_metric_matches_hamming(self):
1888         seq1 = Sequence("abcdef")
1889         seq2 = Sequence("12bcef")
1890         seq_wrong = Sequence("abcdefghijklmnop")
1891         distance1 = seq1.distance(seq2)
1892         distance2 = skbio.sequence.distance.hamming(seq1, seq2)
1893         self.assertEqual(distance1, distance2)
1894         with self.assertRaises(ValueError):
1895             seq1.distance(seq_wrong)
1896         with self.assertRaises(ValueError):
1897             seq_wrong.distance(seq1)
1898 class SequenceReprDoctests:
1899     r"""&gt;&gt;&gt; import pandas as pd
1900     &gt;&gt;&gt; from skbio import Sequence
1901     Empty (minimal) sequence:
1902     &gt;&gt;&gt; Sequence('')
1903     Sequence
1904     -------------
1905     Stats:
1906         length: 0
1907     -------------
1908     Single character sequence:
1909     &gt;&gt;&gt; Sequence('G')
1910     Sequence
1911     -------------
1912     Stats:
1913         length: 1
1914     -------------
1915     0 G
1916     Multicharacter sequence:
1917     &gt;&gt;&gt; Sequence('ACGT')
1918     Sequence
1919     -------------
1920     Stats:
1921         length: 4
1922     -------------
1923     0 ACGT
1924     Full single line:
1925     &gt;&gt;&gt; Sequence('A' * 60)
1926     Sequence
1927     -------------------------------------------------------------------
1928     Stats:
1929         length: 60
1930     -------------------------------------------------------------------
1931     0 AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
1932     Full single line with 1 character overflow:
1933     &gt;&gt;&gt; Sequence('A' * 61)
1934     Sequence
1935     --------------------------------------------------------------------
1936     Stats:
1937         length: 61
1938     --------------------------------------------------------------------
1939     0  AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
1940     60 A
1941     Two full lines:
1942     &gt;&gt;&gt; Sequence('T' * 120)
1943     Sequence
1944     --------------------------------------------------------------------
1945     Stats:
1946         length: 120
1947     --------------------------------------------------------------------
1948     0  TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT
1949     60 TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT
1950     Two full lines with 1 character overflow:
1951     &gt;&gt;&gt; Sequence('T' * 121)
1952     Sequence
1953     ---------------------------------------------------------------------
1954     Stats:
1955         length: 121
1956     ---------------------------------------------------------------------
1957     0   TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT
1958     60  TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT TTTTTTTTTT
1959     120 T
1960     Five full lines (maximum amount of information):
1961     &gt;&gt;&gt; Sequence('A' * 300)
1962     Sequence
1963     ---------------------------------------------------------------------
1964     Stats:
1965         length: 300
1966     ---------------------------------------------------------------------
1967     0   AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
1968     60  AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
1969     120 AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
1970     180 AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
1971     240 AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
1972     Six lines starts "summarized" output:
1973     &gt;&gt;&gt; Sequence('A' * 301)
1974     Sequence
1975     ---------------------------------------------------------------------
1976     Stats:
1977         length: 301
1978     ---------------------------------------------------------------------
1979     0   AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
1980     60  AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
1981     ...
1982     240 AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
1983     300 A
1984     A naive algorithm would assume the width of the first column (noting
1985     position) based on the sequence's length alone. This can be off by one if
1986     the last position (in the last line) has a shorter width than the width
1987     calculated from the sequence's length. This test case ensures that only a
1988     single space is inserted between position 99960 and the first sequence
1989     chunk:
1990     &gt;&gt;&gt; Sequence('A' * 100000)
1991     Sequence
1992     -----------------------------------------------------------------------
1993     Stats:
1994         length: 100000
1995     -----------------------------------------------------------------------
1996     0     AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
1997     60    AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
1998     ...
1999     99900 AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
2000     99960 AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
2001     The largest sequence that can be displayed using six chunks per line:
2002     &gt;&gt;&gt; Sequence('A' * 100020)
2003     Sequence
2004     -----------------------------------------------------------------------
2005     Stats:
2006         length: 100020
2007     -----------------------------------------------------------------------
2008     0     AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
2009     60    AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
2010     ...
2011     99900 AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
2012     99960 AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
2013     A single character longer than the previous sequence causes the optimal
2014     number of chunks per line to be 5:
2015     &gt;&gt;&gt; Sequence('A' * 100021)
2016     Sequence
2017     -------------------------------------------------------------
2018     Stats:
2019         length: 100021
2020     -------------------------------------------------------------
2021     0      AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
2022     50     AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
2023     ...
2024     99950  AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA AAAAAAAAAA
2025     100000 AAAAAAAAAA AAAAAAAAAA A
2026     Wide range of characters (locale-independent):
2027     &gt;&gt;&gt; import string
2028     &gt;&gt;&gt; Sequence((string.ascii_letters + string.punctuation + string.digits +
2029     ...          'a space') * 567)
2030     Sequence
2031     -----------------------------------------------------------------------
2032     Stats:
2033         length: 57267
2034     -----------------------------------------------------------------------
2035     0     abcdefghij klmnopqrst uvwxyzABCD EFGHIJKLMN OPQRSTUVWX YZ!"#$%&amp;'(
2036     60    )*+,-./:;&lt; =&gt;?@[\]^_` {|}~012345 6789a spac eabcdefghi jklmnopqrs
2037     ...
2038     57180 opqrstuvwx yzABCDEFGH IJKLMNOPQR STUVWXYZ!" #$%&amp;'()*+, -./:;&lt;=&gt;?@
2039     57240 [\]^_`{|}~ 0123456789 a space
2040     Supply horrendous metadata, positional, and interval metadata to
2041     exercise a variety of metadata formatting cases and rules. Sorting
2042     should be by type, then by value within each type (Python 3
2043     doesn't allow sorting of mixed types):
2044     &gt;&gt;&gt; metadata = {
2045     ...     # str key, str value
2046     ...     'abc': 'some description',
2047     ...     # int value
2048     ...     'foo': 42,
2049     ...     # unsupported type (dict) value
2050     ...     'bar': {},
2051     ...     # int key, wrapped str (single line)
2052     ...     42: 'some words to test text wrapping and such... yada yada yada '
2053     ...         'yada yada yada yada yada.',
2054     ...     # bool key, wrapped str (multi-line)
2055     ...     True: 'abc ' * 34,
2056     ...     # float key, truncated str (too long)
2057     ...     42.5: 'abc ' * 200,
2058     ...     # unsupported type (tuple) key, unsupported type (list) value
2059     ...     ('foo', 'bar'): [1, 2, 3],
2060     ...     # bytes key, single long word that wraps
2061     ...     b'long word': 'abc' * 30,
2062     ...     # truncated key (too long), None value
2063     ...     'too long of a key name to display in repr': None,
2064     ...     # wrapped bytes value (has b'' prefix)
2065     ...     'bytes wrapped value': b'abcd' * 25,
2066     ...     # float value
2067     ...     0.1: 99.9999,
2068     ...     # bool value
2069     ...     43: False,
2070     ...     # None key, complex value
2071     ...     None: complex(-1.0, 0.0),
2072     ...     # nested quotes
2073     ...     10: '"\''
2074     ... }
2075     &gt;&gt;&gt; positional_metadata = pd.DataFrame({
2076     ...     # str key, int list value
2077     ...     'foo': [1, 2, 3, 4],
2078     ...     # float key, float list value
2079     ...     42.5: [2.5, 3.0, 4.2, -0.00001],
2080     ...     # int key, object list value
2081     ...     42: [[], 4, 5, {}],
2082     ...     # truncated key (too long), bool list value
2083     ...     'abc' * 90: [True, False, False, True],
2084     ...     # None key
2085     ...     None: range(4)})
2086     &gt;&gt;&gt; positional_metadata = positional_metadata.reindex(
2087     ...     columns=['foo', 42.5, 42, 'abc' * 90, None])
2088     &gt;&gt;&gt; interval_metadata = IntervalMetadata(4)
2089     &gt;&gt;&gt; _ = interval_metadata.add([(0, 2), (1, 3)],
2090     ...                           [(False, True), (False, False)],
2091     ...                           {'gene': 'p53'})
2092     &gt;&gt;&gt; _ = interval_metadata.add([(1, 4)])
2093     &gt;&gt;&gt; Sequence('ACGT', metadata=metadata,
2094     ...          positional_metadata=positional_metadata,
2095     ...          interval_metadata=interval_metadata)
2096     Sequence
2097     -----------------------------------------------------------------------
2098     Metadata:
2099         None: (-1+0j)
2100         True: 'abc abc abc abc abc abc abc abc abc abc abc abc abc abc abc
2101                abc abc abc abc abc abc abc abc abc abc abc abc abc abc abc
2102                abc abc abc abc '
2103         b'long word': 'abcabcabcabcabcabcabcabcabcabcabcabcabcabcabcabcabca
2104                        bcabcabcabcabcabcabcabcabcabcabcabcabc'
2105         0.1: 99.9999
2106         42.5: &lt;class 'str'&gt;
2107         10: '"\''
2108         42: 'some words to test text wrapping and such... yada yada yada
2109              yada yada yada yada yada.'
2110         43: False
2111         'abc': 'some description'
2112         'bar': &lt;class 'dict'&gt;
2113         'bytes wrapped value': b'abcdabcdabcdabcdabcdabcdabcdabcdabcdabcdab
2114                                  cdabcdabcdabcdabcdabcdabcdabcdabcdabcdabcd
2115                                  abcdabcdabcdabcd'
2116         'foo': 42
2117         &lt;class 'str'&gt;: None
2118         &lt;class 'tuple'&gt;: &lt;class 'list'&gt;
2119     Positional metadata:
2120         'foo': &lt;dtype: int64&gt;
2121         42.5: &lt;dtype: float64&gt;
2122         42: &lt;dtype: object&gt;
2123         &lt;class 'str'&gt;: &lt;dtype: bool&gt;
2124         None: &lt;dtype: int64&gt;
2125     Interval metadata:
2126         2 interval features
2127     Stats:
2128         length: 4
2129     -----------------------------------------------------------------------
2130     0 ACGT
2131 <font color="#8e35ef"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import io
2132 from unittest import TestCase, main
2133 from collections import defaultdict
2134 import numpy as np
2135 import numpy.testing as npt
2136 from scipy.stats import pearsonr
2137 from skbio import DistanceMatrix, TreeNode
2138 from skbio.tree import (DuplicateNodeError, NoLengthError,
2139                         TreeError, MissingNodeError, NoParentError)
2140 from skbio.util import RepresentationWarning
2141 class TreeNodeSubclass(TreeNode):
2142     pass
2143 class</b></font> TreeTests(TestCase):
2144     def setUp(self):
2145 <a name="31"></a>        """Prep the self"""
2146         self.simple_t = TreeNode.read(io.StringIO("((a,b)i1,(c,d)i2)root;"))
2147         nodes = dict([(x, TreeNode(x)) for x in 'abcdefgh'])
2148         nodes['a']<font color="#3ea99f"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.append(nodes['b'])
2149 <a name="45"></a>        nodes['b'].append(nodes['c'])
2150         nodes['c'].append(nodes['d'])
2151         nodes['c'].</b></font>append(nodes['e'])
2152         nodes['c']<font color="#549748"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.append(nodes['f'])
2153         nodes['f'].append(nodes['g'])
2154         nodes['a'].append(nodes['h'])
2155         self.</b></font>TreeRoot = nodes['a']
2156         def rev_f(items):
2157             items.reverse()
2158         def rotate_f(items):
2159             tmp = items[-1]
2160             items[1:] = items[:-1]
2161             items[0] = tmp
2162         self.rev_f = rev_f
2163         self.rotate_f = rotate_f
2164         self.complex_tree = TreeNode.read(io.StringIO(
2165             "(((a,b)int1,(x,y,(w,z)int2,(c,d)int3)int4),(e,f)int5);"))
2166     def test_bug_issue_1416(self):
2167         tree = TreeNode.read(['(((a,b,f,g),c),d);'])
2168         new_tree = tree.shear(['a', 'b', 'c', 'f'])
2169         exp = {'a', 'b', 'c', 'f'}
2170         obs = {n.name for n in new_tree.tips()}
2171         self.assertEqual(obs, exp)
2172         self.assertEqual(id(new_tree), id(new_tree.children[0].parent))
2173         self.assertEqual(id(new_tree), id(new_tree.children[1].parent))
2174     def test_observed_node_counts(self):
2175         otu_counts = {}
2176         expected = defaultdict(int)
2177         self.assertEqual(self.simple_t.observed_node_counts(otu_counts),
2178                          expected)
2179         otu_counts = {'a': 0}
2180         self.assertRaises(ValueError, self.simple_t.observed_node_counts,
2181                           otu_counts)
2182         otu_counts = {'a': 0, 'b': 0, 'c': 0, 'd': 0}
2183         self.assertRaises(ValueError, self.simple_t.observed_node_counts,
2184                           otu_counts)
2185         otu_counts = {'a': 1, 'b': 1, 'c': 1, 'd': 1}
2186         expected = defaultdict(int)
2187         expected[self.simple_t.find('root')] = 4
2188         expected[self.simple_t.find('i1')] = 2
2189         expected[self.simple_t.find('i2')] = 2
2190         expected[self.simple_t.find('a')] = 1
2191         expected[self.simple_t.find('b')] = 1
2192         expected[self.simple_t.find('c')] = 1
2193         expected[self.simple_t.find('d')] = 1
2194         self.assertEqual(self.simple_t.observed_node_counts(otu_counts),
2195                          expected)
2196         otu_counts = {'a': 2, 'b': 1, 'c': 1, 'd': 1}
2197         expected = defaultdict(int)
2198         expected[self.simple_t.find('root')] = 5
2199         expected[self.simple_t.find('i1')] = 3
2200         expected[self.simple_t.find('i2')] = 2
2201         expected[self.simple_t.find('a')] = 2
2202         expected[self.simple_t.find('b')] = 1
2203         expected[self.simple_t.find('c')] = 1
2204         expected[self.simple_t.find('d')] = 1
2205         self.assertEqual(self.simple_t.observed_node_counts(otu_counts),
2206                          expected)
2207         otu_counts = {'a': 2, 'b': 1, 'c': 1, 'd': 2}
2208         expected = defaultdict(int)
2209         expected[self.simple_t.find('root')] = 6
2210         expected[self.simple_t.find('i1')] = 3
2211         expected[self.simple_t.find('i2')] = 3
2212         expected[self.simple_t.find('a')] = 2
2213         expected[self.simple_t.find('b')] = 1
2214         expected[self.simple_t.find('c')] = 1
2215         expected[self.simple_t.find('d')] = 2
2216         self.assertEqual(self.simple_t.observed_node_counts(otu_counts),
2217                          expected)
2218         otu_counts = {'a': 2, 'b': 1}
2219         expected = defaultdict(int)
2220         expected[self.simple_t.find('root')] = 3
2221         expected[self.simple_t.find('i1')] = 3
2222         expected[self.simple_t.find('a')] = 2
2223         expected[self.simple_t.find('b')] = 1
2224         self.assertEqual(self.simple_t.observed_node_counts(otu_counts),
2225                          expected)
2226         otu_counts = {'d': 1}
2227         expected = defaultdict(int)
2228         expected[self.simple_t.find('root')] = 1
2229         expected[self.simple_t.find('i2')] = 1
2230         expected[self.simple_t.find('d')] = 1
2231         self.assertEqual(self.simple_t.observed_node_counts(otu_counts),
2232                          expected)
2233         otu_counts = {'a': 2, 'e': 1}
2234         self.assertRaises(MissingNodeError, self.simple_t.observed_node_counts,
2235                           otu_counts)
2236         otu_counts = {'a': 2, 'i1': 1}
2237         self.assertRaises(MissingNodeError, self.simple_t.observed_node_counts,
2238                           otu_counts)
2239         otu_counts = {}
2240         expected = defaultdict(int)
2241         self.assertEqual(self.complex_tree.observed_node_counts(otu_counts),
2242                          expected)
2243         otu_counts = {'e': 42, 'f': 1}
2244         expected[self.complex_tree.root()] = 43
2245         expected[self.complex_tree.find('int5')] = 43
2246         expected[self.complex_tree.find('e')] = 42
2247         expected[self.complex_tree.find('f')] = 1
2248         self.assertEqual(self.complex_tree.observed_node_counts(otu_counts),
2249                          expected)
2250 <a name="34"></a>
2251     def test_count(self):
2252         exp <font color="#827d6b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= 7
2253         obs = self.simple_t.count()
2254         self.assertEqual(obs, exp)
2255         exp = 4
2256         obs = self.simple_t.count(</b></font>tips=True)
2257         self.assertEqual(obs, exp)
2258     def test_copy(self):
2259         self.simple_t.children[0].length = 1.2
2260         self.simple_t.children[1].children[0].length = 0.5
2261         cp = self.simple_t.copy()
2262         gen = zip(cp.traverse(include_self=True),
2263                   self.simple_t.traverse(include_self=True))
2264         for a, b in gen:
2265             self.assertIsNot(a, b)
2266             self.assertEqual(a.name, b.name)
2267             self.assertEqual(a.length, b.length)
2268     def test_append(self):
2269         second_tree = TreeNode.read(io.StringIO("(x,y)z;"))
2270         self.simple_t.append(second_tree)
2271 <a name="3"></a>        self.assertEqual(self.simple_t.children[0].name, 'i1')
2272         self.assertEqual(self.simple_t.children[1].name, 'i2')
2273         self.assertEqual(self.simple_t.children[2].name, 'z')
2274         self.assertEqual(len<font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>(self.simple_t.children), 3)
2275         self.assertEqual(self.simple_t.children[2].children[0].name, 'x')
2276         self.assertEqual(self.simple_t.children[2].children[1].name, 'y')
2277         self.</b></font>assertEqual(second_tree.parent, self.simple_t)
2278 <a name="10"></a>
2279     def test_extend(self):
2280 <a name="46"></a>        second_tree = TreeNode<font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.read(io.StringIO("(x1,y1)z1;"))
2281         third_tree = TreeNode.read(io.StringIO("(x2,y2)z2;"))
2282         first_tree = TreeNode.read(io.StringIO("(x1,y1)z1;"))
2283         fourth_tree =</b></font> TreeNode.read<font color="#668b8b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>(io.StringIO("(x2,y2)z2;"))
2284         self.simple_t.extend([second_tree, third_tree])
2285         first_tree.extend(fourth_tree.children)
2286         self.assertEqual(</b></font>0, len(fourth_tree.children))
2287 <a name="0"></a>        self.assertEqual(first_tree.children[0].name, 'x1')
2288         self.assertEqual(first_tree.children[1].name, 'y1')
2289         self.assertEqual(first_tree.children[2].name, 'x2')
2290         self.assertEqual(first_tree.children<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>[3].name, 'y2')
2291         self.assertEqual(self.simple_t.children[0].name, 'i1')
2292 <a name="2"></a>        self.assertEqual(self.simple_t.children[1].name, 'i2')
2293         self.assertEqual(self.simple_t.children[2].name, 'z1')
2294         self.</b></font>assertEqual(self.simple_t.children[3].name, 'z2')
2295 <a name="7"></a>        self.assertEqual(len<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>(self.simple_t.children), 4)
2296         self.assertEqual(self.simple_t.children[2].children[0].name, 'x1')
2297         self.assertEqual(self.simple_t.children[2].children[1].name, 'y1')
2298         self.</b></font>assertEqual(self.simple_t.children[3]<font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.children[0].name, 'x2')
2299         self.assertEqual(self.simple_t.children[3].children[1].name, 'y2')
2300         self.assertIs(second_tree.parent, self.simple_t)
2301         self.</b></font>assertIs(third_tree.parent, self.simple_t)
2302     def test_extend_empty(self):
2303         self.simple_t.extend([])
2304         self.assertEqual(self.simple_t.children[0].name, 'i1')
2305         self.assertEqual(self.simple_t.children[1].name, 'i2')
2306         self.assertEqual(len(self.simple_t.children), 2)
2307     def test_iter(self):
2308         exp = ['i1', 'i2']
2309         obs = [n.name for n in self.simple_t]
2310         self.assertEqual(obs, exp)
2311     def test_gops(self):
2312         p = TreeNode()
2313         self.assertEqual(str(p), ';\n')
2314         p.name = 'abc'
2315         self.assertEqual(str(p), 'abc;\n')
2316         p.length = 3
2317         self.assertEqual(str(p), 'abc:3;\n')  # don't suppress branch from root
2318         q = TreeNode()
2319         p.append(q)
2320         self.assertEqual(str(p), '()abc:3;\n')
2321         r = TreeNode()
2322 <a name="21"></a>        q.append(r)
2323         self.assertEqual(str(p), '(())abc:3;\n')
2324         r.name = 'xyz'
2325         self<font color="#947010"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertEqual(str(p), '((xyz))abc:3;\n')
2326         q.length = 2
2327         self.assertEqual(str(p), '((xyz):2)abc:3;\n')
2328     def test_pop(self):
2329         second_tree = TreeNode.read(io.</b></font>StringIO("(x1,y1)z1;"))
2330         third_tree = TreeNode.read(io.StringIO("(x2,y2)z2;"))
2331 <a name="28"></a>        self.simple_t.extend([second_tree, third_tree])
2332         i1 = self.simple_t.pop(0)
2333         z2 <font color="#717d7d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= self.simple_t.pop()
2334         self.assertEqual(i1.name, 'i1')
2335         self.assertEqual(z2.name, 'z2')
2336 <a name="32"></a>        self.assertEqual(i1.</b></font>children[0].name, 'a')
2337         self.assertEqual(i1.children[1].name, 'b')
2338         self.assertEqual(z2.children[0].name, 'x2')
2339         self<font color="#5b8daf"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertEqual(z2.children[1].name, 'y2')
2340         self.assertEqual(self.simple_t.children[0].name, 'i2')
2341         self.</b></font>assertEqual(self.simple_t.children[1].name, 'z1')
2342         self.assertEqual(len(self.simple_t.children), 2)
2343 <a name="29"></a>
2344     def test_remove(self):
2345         self.assertTrue(self.simple_t.remove(self.simple_t<font color="#af7a82"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.children[0]))
2346         self.assertEqual(len(self.simple_t.children), 1)
2347         n = TreeNode()
2348         self.assertFalse(self.simple_t.</b></font>remove(n))
2349     def test_remove_deleted(self):
2350         def f(node):
2351             return node.name in ['b', 'd']
2352         self.simple_t.remove_deleted(f)
2353         exp = "((a)i1,(c)i2)root;\n"
2354         obs = str(self.simple_t)
2355         self.assertEqual(obs, exp)
2356     def test_adopt(self):
2357         n1 = TreeNode(name='n1')
2358         n2 = TreeNode(name='n2')
2359         n3 = TreeNode(name='n3')
2360         self.simple_t._adopt(n1)
2361         self.simple_t.children[-1]._adopt(n2)
2362 <a name="30"></a>        n2._adopt(n3)
2363         self.assertEqual(len<font color="#ae694a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>(self.simple_t.children), 2)
2364         self.assertIs(n1.parent, self.simple_t)
2365         self.assertIs(n2.parent, self.simple_t.children[</b></font>-1])
2366         self.assertIs(n3.parent, n2)
2367     def test_remove_node(self):
2368         n = self.simple_t._remove_node(-1)
2369         self.assertEqual(n.parent, None)
2370         self.assertEqual(len(self.simple_t.children), 1)
2371         self.assertEqual(len(n.children), 2)
2372         self.assertNotIn(n, self.simple_t.children)
2373     def test_shear_prune_parent_dropped(self):
2374         bugtree = "((a,b),((c,d),(e,f)));"
2375         to_keep = ['c', 'd']
2376         exp = "(c,d);\n"
2377         obs = str(TreeNode.read(io.StringIO(bugtree)).shear(to_keep))
2378         self.assertEqual(obs, exp)
2379     def test_prune_nested_single_descendent(self):
2380         bugtree = "(((a,b)));"
2381         exp = "(a,b);\n"
2382         t = TreeNode.read(io.StringIO(bugtree))
2383         t.prune()
2384         obs = str(t)
2385         self.assertEqual(obs, exp)
2386     def test_prune_root_single_desc(self):
2387         t = TreeNode.read(["((a,b)c)extra;"])
2388         exp = "(a,b)c;\n"
2389         t.prune()
2390         self.assertEqual(str(t), exp)
2391     def test_prune(self):
2392         cp = self.simple_t.copy()
2393         self.simple_t.prune()
2394         gen = zip(cp.traverse(include_self=True),
2395                   self.simple_t.traverse(include_self=True))
2396         for a, b in gen:
2397             self.assertIsNot(a, b)
2398             self.assertEqual(a.name, b.name)
2399             self.assertEqual(a.length, b.length)
2400         n = self.simple_t.children[0]
2401         n.remove(n.children[0])
2402         self.simple_t.prune()
2403         self.assertEqual(len(self.simple_t.children), 2)
2404         self.assertEqual(self.simple_t.children[0].name, 'i2')
2405         self.assertEqual(self.simple_t.children[1].name, 'b')
2406     def test_prune_length(self):
2407         cp = self.simple_t.copy()
2408         self.simple_t.prune()
2409         gen = zip(cp.traverse(include_self=True),
2410                   self.simple_t.traverse(include_self=True))
2411         for a, b in gen:
2412             self.assertIsNot(a, b)
2413             self.assertEqual(a.name, b.name)
2414             self.assertEqual(a.length, b.length)
2415         for n in self.simple_t.traverse():
2416             n.length = 1.0
2417         n = self.simple_t.children[0]
2418 <a name="1"></a>        n.remove(n.children[0])
2419         self.simple_t.prune()
2420         self.assertEqual(len<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>(self.simple_t.children), 2)
2421         self.assertEqual(self.simple_t.children[0].name, 'i2')
2422         self.assertEqual(self.simple_t.children[1].name, 'b')
2423         self.assertEqual(self.simple_t.children[1].</b></font>length, 2.0)
2424     def test_subset(self):
2425         t = self.simple_t
2426         self.assertEqual(t.subset(), frozenset('abcd'))
2427         c = t.children[0]
2428         self.assertEqual(c.subset(), frozenset('ab'))
2429         leaf = c.children[1]
2430         self.assertEqual(leaf.subset(), frozenset(''))
2431     def test_subsets(self):
2432         t = self.simple_t
2433         self.assertEqual(t.subsets(), frozenset(
2434             [frozenset('ab'), frozenset('cd')]))
2435     def test_is_tip(self):
2436 <a name="18"></a>        """see if we're a tip or not"""
2437         self.assertFalse(self.simple_t.is_tip())
2438         self.assertFalse(self.simple_t.children[0].is_tip())
2439         self.assertTrue(self.simple_t.children[0].children<font color="#800517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>[0].is_tip())
2440     def test_is_root(self):
2441 <a name="48"></a>        """see if we're at the root or not"""
2442         self.assertTrue(self.simple_t.is_root())
2443         self.assertFalse(self.simple_t.</b></font>children[0].is_root())
2444         self<font color="#c57726"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertFalse(self.simple_t.children[0].children[0].is_root())
2445     def test_root(self):
2446 <a name="47"></a>        root =</b></font> self.simple_t
2447         self.assertIs(root, self.simple_t.root())
2448         self.assertIs(root, self.simple_t.children[0].root())
2449         self<font color="#d16587"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertIs(root, self.simple_t.children[1].children[1].root())
2450 <a name="43"></a>
2451     def test_invalidate_lookup_caches(self):
2452         root =</b></font> self.simple_t
2453         root<font color="#c22817"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.create_caches()
2454         self.assertNotEqual(root._tip_cache, {})
2455         self.assertNotEqual(root._non_tip_cache, {})
2456         root.invalidate_caches()
2457         self.assertEqual(</b></font>root._tip_cache, {})
2458         self.assertEqual(root._non_tip_cache, {})
2459     def test_invalidate_attr_caches(self):
2460         tree = TreeNode.read(io.StringIO("((a,b,(c,d)e)f,(g,h)i)root;"))
2461         def f(n):
2462             return [n.name] if n.is_tip() else []
2463         tree.cache_attr(f, 'tip_names')
2464         tree.invalidate_caches()
2465         for n in tree.traverse(include_self=True):
2466             self.assertFalse(hasattr(n, 'tip_names'))
2467     def test_create_caches_duplicate_tip_names(self):
2468         with self.assertRaises(DuplicateNodeError):
2469 <a name="15"></a>            TreeNode.read(io.StringIO('(a, a);')).create_caches()
2470     def test_find_all(self):
2471         t = TreeNode.read(io.StringIO<font color="#f52887"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>("((a,b)c,((d,e)c)c,(f,(g,h)c)a)root;"))
2472         exp = [t.children[0],
2473                t.children[1].children[0],
2474                t.children[1],
2475                t.children[2].children[</b></font>1]]
2476         obs = t.find_all('c')
2477         self.assertEqual(obs, exp)
2478         identity = t.find_all(t)
2479         self.assertEqual(len(identity), 1)
2480         self.assertEqual(identity[0], t)
2481         identity_name = t.find_all('root')
2482         self.assertEqual(len(identity_name), 1)
2483         self.assertEqual(identity_name[0], t)
2484         exp = [t.children[2],
2485                t.children[0].children[0]]
2486         obs = t.find_all('a')
2487         self.assertEqual(obs, exp)
2488         with self.assertRaises(MissingNodeError):
2489             t.find_all('missing')
2490     def test_find(self):
2491         t = TreeNode.read(io.StringIO("((a,b)c,(d,e)f);"))
2492         exp = t.children[0]
2493         obs = t.find('c')
2494         self.assertEqual(obs, exp)
2495         exp = t.children[0].children[1]
2496         obs = t.find('b')
2497         self.assertEqual(obs, exp)
2498         with self.assertRaises(MissingNodeError):
2499             t.find('does not exist')
2500     def test_find_cache_bug(self):
2501         t = TreeNode.read(io.StringIO("((a,b)c,(d,e)f,(g,h)f);"))
2502         exp_tip_cache_keys = set(['a', 'b', 'd', 'e', 'g', 'h'])
2503         exp_non_tip_cache_keys = set(['c', 'f'])
2504         tip_a = t.children[0].children[0]
2505         tip_a.create_caches()
2506         self.assertEqual(tip_a._tip_cache, {})
2507         self.assertEqual(set(t._tip_cache), exp_tip_cache_keys)
2508         self.assertEqual(set(t._non_tip_cache), exp_non_tip_cache_keys)
2509         self.assertEqual(t._non_tip_cache['f'], [t.children[1], t.children[2]])
2510     def test_find_by_id(self):
2511         t1 = TreeNode.read(io.StringIO("((,),(,,));"))
2512         t2 = TreeNode.read(io.StringIO("((,),(,,));"))
2513         exp = t1.children[1]
2514         obs = t1.find_by_id(6)  # right inner node with 3 children
2515         self.assertEqual(obs, exp)
2516         exp = t2.children[1]
2517         obs = t2.find_by_id(6)  # right inner node with 3 children
2518         self.assertEqual(obs, exp)
2519         with self.assertRaises(MissingNodeError):
2520             t1.find_by_id(100)
2521     def test_find_by_func(self):
2522         t = TreeNode.read(io.StringIO("((a,b)c,(d,e)f);"))
2523         def func(x):
2524             return x.parent == t.find('c')
2525         exp = ['a', 'b']
2526         obs = [n.name for n in t.find_by_func(func)]
2527         self.assertEqual(obs, exp)
2528     def test_ancestors(self):
2529         exp = ['i1', 'root']
2530         obs = self.simple_t.children[0].children[0].ancestors()
2531         self.assertEqual([o.name for o in obs], exp)
2532         exp = ['root']
2533         obs = self.simple_t.children[0].ancestors()
2534         self.assertEqual([o.name for o in obs], exp)
2535         exp = []
2536         obs = self.simple_t.ancestors()
2537         self.assertEqual([o.name for o in obs], exp)
2538     def test_siblings(self):
2539         exp = []
2540         obs = self.simple_t.siblings()
2541         self.assertEqual(obs, exp)
2542         exp = ['i2']
2543         obs = self.simple_t.children[0].siblings()
2544         self.assertEqual([o.name for o in obs], exp)
2545         exp = ['c']
2546         obs = self.simple_t.children[1].children[1].siblings()
2547         self.assertEqual([o.name for o in obs], exp)
2548         self.simple_t.append(TreeNode(name="foo"))
2549         self.simple_t.append(TreeNode(name="bar"))
2550         exp = ['i1', 'foo', 'bar']
2551         obs = self.simple_t.children[1].siblings()
2552         self.assertEqual([o.name for o in obs], exp)
2553     def test_ascii_art(self):
2554         tr = TreeNode.read(io.StringIO("(B:0.2,(C:0.3,D:0.4):0.6)F;"))
2555         obs = tr.ascii_art(show_internal=True, compact=False)
2556         exp = ("          /-B\n"
2557                "-F-------|\n"
2558                "         |          /-C\n"
2559                "          \\--------|\n"
2560                "                    \\-D")
2561         self.assertEqual(obs, exp)
2562         obs = tr.ascii_art(show_internal=True, compact=True)
2563         exp = ("-F------- /-B\n"
2564                "          \\-------- /-C\n"
2565                "                    \\-D")
2566         self.assertEqual(obs, exp)
2567         obs = tr.ascii_art(show_internal=False, compact=False)
2568         exp = ("          /-B\n"
2569                "---------|\n"
2570                "         |          /-C\n"
2571                "          \\--------|\n"
2572                "                    \\-D")
2573         self.assertEqual(obs, exp)
2574     def test_ascii_art_with_support(self):
2575         tr = TreeNode.read(io.StringIO("(B:0.2,(C:0.3,D:0.4)90:0.6)F;"))
2576         exp = "          /-B\n-F-------|\n         |          /-C\n         "\
2577               " \\90------|\n                    \\-D"
2578         obs = tr.ascii_art(show_internal=True, compact=False)
2579         self.assertEqual(obs, exp)
2580         tr.assign_supports()
2581         obs = tr.ascii_art(show_internal=True, compact=False)
2582         self.assertEqual(obs, exp)
2583         tr = TreeNode.read(io.StringIO("((A,B)75,(C,D)'80:spA');"))
2584         exp = "                    /-A\n          /75------|\n         |    "\
2585               "      \\-B\n---------|\n         |          /-C\n          \\"\
2586               "80:spA--|\n                    \\-D"
2587         obs = tr.ascii_art(show_internal=True, compact=False)
2588         self.assertEqual(obs, exp)
2589         tr.assign_supports()
2590         obs = tr.ascii_art(show_internal=True, compact=False)
2591 <a name="44"></a>        self.assertEqual(obs, exp)
2592     def test_ascii_art_three_children(self):
2593         obs = TreeNode.read(io<font color="#a057a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.StringIO('(a,(b,c,d));')).ascii_art()
2594         self.assertEqual(obs, exp_ascii_art_three_children)
2595     def test_accumulate_to_ancestor(self):
2596         t = TreeNode.read(io.</b></font>StringIO(
2597             "((a:0.1,b:0.2)c:0.3,(d:0.4,e)f:0.5)root;"))
2598         a = t.find('a')
2599         b = t.find('b')
2600         exp_to_root = 0.1 + 0.3
2601         obs_to_root = a.accumulate_to_ancestor(t)
2602         self.assertEqual(obs_to_root, exp_to_root)
2603         with self.assertRaises(NoParentError):
2604             a.accumulate_to_ancestor(b)
2605 <a name="12"></a>    def test_distance_nontip(self):
2606         tstr = "((A:1.0,B:2.0)'g__genus1':3.0)root;"
2607         tree = TreeNode<font color="#571b7e"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.read(io.StringIO(tstr))
2608         self.assertEqual(tree.find('A').distance(tree.find('g__genus1')), 1.0)
2609     def test_distance(self):
2610 <a name="8"></a>        """Get the distance between two nodes"""
2611         t =</b></font> TreeNode.read(io.StringIO(
2612             "((a:0.1,b:0.2)c:0.3,(d:0.4,e)f:0.5)root;"))
2613         tips = sorted([n for n in t.tips()], key=lambda x: x<font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.name)
2614         npt.assert_almost_equal(tips[0].distance(tips[0]), 0.0)
2615         npt.assert_almost_equal(tips[0].distance(tips[1]), 0.3)
2616         npt.assert_almost_equal(tips[</b></font>0].distance(tips[2]), 1.3)
2617 <a name="27"></a>        with self.assertRaises(NoLengthError):
2618             tips[0].distance(tips[3])
2619         npt.assert_almost_equal(tips<font color="#e77471"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>[1].distance(tips[0]), 0.3)
2620         npt.assert_almost_equal(tips[1].distance(tips[1]), 0.0)
2621         npt.assert_almost_equal(tips[</b></font>1].distance(tips[2]), 1.4)
2622 <a name="41"></a>        with self.assertRaises(NoLengthError):
2623             tips[1].distance(tips[3])
2624         self<font color="#f87a17"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertEqual(tips[2].distance(tips[0]), 1.3)
2625         self.assertEqual(tips[2].distance(tips[</b></font>1]), 1.4)
2626         self.assertEqual(tips[2].distance(tips[2]), 0.0)
2627         with self.assertRaises(NoLengthError):
2628             tips[2].distance(tips[3])
2629 <a name="36"></a>
2630     def test_lowest_common_ancestor(self):
2631         t1 = TreeNode.read(io<font color="#ff00ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.StringIO("((a,(b,c)d)e,f,(g,h)i)j;"))
2632         t2 = t1.copy()
2633         t3 = t1.copy()
2634         t4 = t1.copy()
2635         input2 = ['a', 'b']  # return e
2636         input3 = ['b', 'c']  # return d
2637         input4 <font color="#41a317"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= ['a', 'h', 'g']  # return j
2638         exp1 = t1.find('a')
2639 <a name="38"></a>        exp2 = t2.find('e')
2640         exp3 = t3.find('d')
2641         exp4 =</b></font> t4
2642         obs1 <font color="#348781"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= t1.lowest_common_ancestor(input1)
2643         obs2 = t2.lowest_common_ancestor(input2)
2644         obs3 = t3.lowest_common_ancestor(input3)
2645 <a name="9"></a>        obs4 = t4.lowest_common_ancestor(</b></font>input4)
2646         self.assertEqual(obs1, exp1)
2647         self.assertEqual(obs2, exp2)
2648         self<font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.assertEqual(obs3, exp3)
2649         self.assertEqual(obs4, exp4)
2650         t_mul = t1.copy()
2651         exp_1 = t_mul.find('d')
2652         exp_2 = t_mul.find('i')
2653         obs_1 = t_mul.lowest_common_ancestor(</b></font>['b', 'c'])
2654         obs_2 = t_mul.lowest_common_ancestor(['g', 'h'])
2655         self.assertEqual(obs_1, exp_1)
2656         self.assertEqual(obs_2, exp_2)
2657         with self.assertRaises(ValueError):
2658             t1.lowest_common_ancestor([])
2659     def test_get_max_distance(self):
2660         tree = TreeNode.read(io.StringIO(
2661             "((a:0.1,b:0.2)c:0.3,(d:0.4,e:0.5)f:0.6)root;"))
2662         dist, nodes = tree.get_max_distance()
2663         npt.assert_almost_equal(dist, 1.6)
2664         self.assertEqual(sorted([n.name for n in nodes]), ['b', 'e'])
2665     def test_set_max_distance(self):
2666         tree = TreeNode.read(io.StringIO(
2667             "((a:0.1,b:0.2)c:0.3,(d:0.4,e:0.5)f:0.6)root;"))
2668         tree._set_max_distance()
2669         tip_a, tip_b = tree.MaxDistTips
2670         self.assertEqual(tip_a[0] + tip_b[0], 1.6)
2671         self.assertEqual(sorted([tip_a[1].name, tip_b[1].name]), ['b', 'e'])
2672     def test_set_max_distance_tie_bug(self):
2673         s = io.StringIO("((a:1,b:1)c:2,(d:3,e:4)f:5)root;")
2674         t = TreeNode.read(s)
2675         exp = ((3.0, t.find('a')), (9.0, t.find('e')))
2676         t._set_max_distance()
2677         self.assertEqual(t.MaxDistTips, exp)
2678     def test_set_max_distance_inplace_modification_bug(self):
2679 <a name="17"></a>        s = io.StringIO("((a:1,b:1)c:2,(d:3,e:4)f:5)root;")
2680         t = TreeNode.read(s)
2681 <a name="16"></a>
2682         exp = [((0.0, t.find<font color="#3090c7"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>('a')), (0.0, t.find('a'))),
2683                ((0.0, t.find('b')), (0.0, t.find('b'))),
2684                ((1.0, t.</b></font>find<font color="#2981b2"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>('a')), (1.0, t.find('b'))),
2685                ((0.0, t.find('d')), (0.0, t.find('d'))),
2686                ((0.0, t.</b></font>find('e')), (0.0, t.find('e'))),
2687                ((3.0, t.find('d')), (4.0, t.find('e'))),
2688                ((3.0, t.find('a')), (9.0, t.find('e')))]
2689         t._set_max_distance()
2690         self.assertEqual([n.MaxDistTips for n in t.postorder()], exp)
2691     def test_shear(self):
2692         t = TreeNode.read(io.StringIO('((H:1,G:1):2,(R:0.5,M:0.7):3);'))
2693         obs = str(t.shear(['G', 'M']))
2694         exp = '(G:3.0,M:3.7);\n'
2695         self.assertEqual(obs, exp)
2696     def test_compare_tip_distances(self):
2697         t = TreeNode.read(io.StringIO('((H:1,G:1):2,(R:0.5,M:0.7):3);'))
2698         t2 = TreeNode.read(io.StringIO('(((H:1,G:1,O:1):2,R:3):1,X:4);'))
2699         obs = t.compare_tip_distances(t2)
2700         m1 = np.array([[0, 2, 6.5], [2, 0, 6.5], [6.5, 6.5, 0]])
2701         m2 = np.array([[0, 2, 6], [2, 0, 6], [6, 6, 0]])
2702         r = pearsonr(m1.flat, m2.flat)[0]
2703         self.assertAlmostEqual(obs, (1 - r) / 2)
2704     def test_compare_tip_distances_sample(self):
2705         t = TreeNode.read(io.StringIO('((H:1,G:1):2,(R:0.5,M:0.7):3);'))
2706         t2 = TreeNode.read(io.StringIO('(((H:1,G:1,O:1):2,R:3):1,X:4);'))
2707         obs = t.compare_tip_distances(t2, sample=3, shuffle_f=sorted)
2708         m1 = np.array([[0, 2, 6.5], [2, 0, 6.5], [6.5, 6.5, 0]])
2709         m2 = np.array([[0, 2, 6], [2, 0, 6], [6, 6, 0]])
2710         r = pearsonr(m1.flat, m2.flat)[0]
2711         self.assertAlmostEqual(obs, (1 - r) / 2)
2712 <a name="25"></a>
2713         s = '((H:1,G:1):2,(R:0.5,M:0.7,Q:5):3);'
2714         t = TreeNode<font color="#5eac10"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.read(io.StringIO(s))
2715         s3 = '(((H:1,G:1,O:1):2,R:3,Q:10):1,X:4);'
2716         t3 = TreeNode.read(io.StringIO(s3))
2717         obs = t.compare_tip_distances(</b></font>t3, sample=3, shuffle_f=sorted)
2718     def test_compare_tip_distances_no_common_tips(self):
2719         t = TreeNode.read(io.StringIO('((H:1,G:1):2,(R:0.5,M:0.7):3);'))
2720         t2 = TreeNode.read(io.StringIO('(((Z:1,Y:1,X:1):2,W:3):1,V:4);'))
2721         with self.assertRaises(ValueError):
2722             t.compare_tip_distances(t2)
2723 <a name="11"></a>
2724     def test_compare_tip_distances_single_common_tip(self):
2725         t = TreeNode.read(io.StringIO('((H:1,G:1):2,(R:0.5,M:0.7):3);'))
2726         t2 = TreeNode<font color="#b041ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.read(io.StringIO('(((R:1,Y:1,X:1):2,W:3):1,V:4);'))
2727         self.assertEqual(t.compare_tip_distances(t2), 1)
2728         self.assertEqual(t2.compare_tip_distances(t), 1)
2729     def test_tip_tip_distances_endpoints(self):
2730         t =</b></font> TreeNode.read(io.StringIO('((H:1,G:1):2,(R:0.5,M:0.7):3);'))
2731         nodes = [t.find('H'), t.find('G'), t.find('M')]
2732         names = ['H', 'G', 'M']
2733         exp = DistanceMatrix(np.array([[0, 2.0, 6.7],
2734 <a name="37"></a>                                       [2.0, 0, 6.7],
2735                                        [6.7, 6.7, 0.0]]), ['H', 'G', 'M'])
2736         obs <font color="#810541"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= t.tip_tip_distances(endpoints=names)
2737         self.assertEqual(obs, exp)
2738         obs = t.tip_tip_distances(endpoints=nodes)
2739         self.assertEqual(</b></font>obs, exp)
2740     def test_tip_tip_distances_non_tip_endpoints(self):
2741         t = TreeNode.read(io.StringIO('((H:1,G:1)foo:2,(R:0.5,M:0.7):3);'))
2742         with self.assertRaises(ValueError):
2743             t.tip_tip_distances(endpoints=['foo'])
2744     def test_tip_tip_distances_no_length(self):
2745         t = TreeNode.read(io.StringIO("((a,b)c,(d,e)f);"))
2746         exp_t = TreeNode.read(io.StringIO("((a:0,b:0)c:0,(d:0,e:0)f:0);"))
2747         exp_t_dm = exp_t.tip_tip_distances()
2748         t_dm = npt.assert_warns(RepresentationWarning, t.tip_tip_distances)
2749         self.assertEqual(t_dm, exp_t_dm)
2750         for node in t.preorder():
2751             self.assertIs(node.length, None)
2752     def test_tip_tip_distances_missing_length(self):
2753         t = TreeNode.read(io.StringIO("((a,b:6)c:4,(d,e:0)f);"))
2754         exp_t = TreeNode.read(io.StringIO("((a:0,b:6)c:4,(d:0,e:0)f:0);"))
2755         exp_t_dm = exp_t.tip_tip_distances()
2756         t_dm = npt.assert_warns(RepresentationWarning, t.tip_tip_distances)
2757         self.assertEqual(t_dm, exp_t_dm)
2758     def test_neighbors(self):
2759         t = TreeNode.read(io.StringIO("((a,b)c,(d,e)f);"))
2760         exp = t.children
2761         obs = t.neighbors()
2762         self.assertEqual(obs, exp)
2763         exp = t.children[0].children + [t]
2764         obs = t.children[0].neighbors()
2765         self.assertEqual(obs, exp)
2766         exp = [t.children[0].children[0]] + [t]
2767         obs = t.children[0].neighbors(ignore=t.children[0].children[1])
2768         self.assertEqual(obs, exp)
2769         exp = [t.children[0]]
2770         obs = t.children[0].children[0].neighbors()
2771         self.assertEqual(obs, exp)
2772 <a name="23"></a>
2773     def test_has_children(self):
2774         t = TreeNode.read(io<font color="#f660ab"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.StringIO("((a,b)c,(d,e)f);"))
2775         self.assertTrue(t.has_children())
2776         self.assertTrue(t.children[0].has_children())
2777         self.</b></font>assertTrue(t.children[1].has_children())
2778         self.assertFalse(t.children[0].children[0].has_children())
2779         self.assertFalse(t.children[0].children[1].has_children())
2780         self.assertFalse(t.children[1].children[0].has_children())
2781         self.assertFalse(t.children[1].children[1].has_children())
2782     def test_tips(self):
2783         exp = ['a', 'b', 'c', 'd']
2784         obs = [n.name for n in self.simple_t.tips()]
2785         self.assertEqual(obs, exp)
2786         obs2 = [n.name for n in self.simple_t.traverse(False, False)]
2787         self.assertEqual(obs2, exp)
2788     def test_tips_self(self):
2789         tree = TreeNode.read(['(c, (b,a)x)y;'])
2790         ts = list(tree.find('c').tips(include_self=True))
2791         self.assertEqual(len(ts), 1)
2792         t = ts[0]
2793         self.assertEqual(t.name, 'c')
2794         self.assertTrue(t.is_tip())
2795     def test_pre_and_postorder(self):
2796         exp = ['root', 'i1', 'a', 'b', 'i1', 'i2', 'c', 'd', 'i2', 'root']
2797         obs = [n.name for n in self.simple_t.pre_and_postorder()]
2798         self.assertEqual(obs, exp)
2799         obs2 = [n.name for n in self.simple_t.traverse(True, True)]
2800         self.assertEqual(obs2, exp)
2801     def test_pre_and_postorder_no_children(self):
2802         t = TreeNode('brofist')
2803         exp = ['brofist']
2804         obs = [n.name for n in t.pre_and_postorder()]
2805         self.assertEqual(obs, exp)
2806         obs = list(t.pre_and_postorder(include_self=False))
2807         self.assertEqual(obs, [])
2808 <a name="42"></a>
2809     def test_levelorder(self):
2810         exp <font color="#c57717"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= ['root', 'i1', 'i2', 'a', 'b', 'c', 'd']
2811         obs = [n.name for n in self.simple_t.levelorder()]
2812         self.assertEqual(obs, exp)
2813     def test_bifurcate(self):
2814         t1 =</b></font> TreeNode.read(io.StringIO('(((a,b),c),(d,e));'))
2815         t2 = TreeNode.read(io.StringIO('((a,b,c));'))
2816         t3 = t2.copy()
2817         t1.bifurcate()
2818         t2.bifurcate()
2819         t3.bifurcate(insert_length=0)
2820         self.assertEqual(str(t1), '(((a,b),c),(d,e));\n')
2821         self.assertEqual(str(t2), '((c,(a,b)));\n')
2822         self.assertEqual(str(t3), '((c,(a,b):0));\n')
2823 <a name="19"></a>
2824     def test_bifurcate_with_subclass(self):
2825         tree = TreeNodeSubclass()
2826         tree<font color="#f62817"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.append(TreeNodeSubclass())
2827         tree.append(TreeNodeSubclass())
2828         tree.append(TreeNodeSubclass())
2829         tree.append(TreeNodeSubclass())
2830         tree.bifurcate(</b></font>)
2831         for node in tree.traverse():
2832             self.assertIs(type(node), TreeNodeSubclass)
2833     def test_index_tree_single_node(self):
2834         t1 = TreeNode.read(io.StringIO('root;'))
2835         id_index, child_index = t1.index_tree()
2836         self.assertEqual(id_index[0], t1)
2837         npt.assert_equal(child_index, np.array([[]]))
2838     def test_index_tree(self):
2839         t1 = TreeNode.read(io.StringIO('(((a,b),c),(d,e));'))
2840         t2 = TreeNode.read(io.StringIO('(((a,b),(c,d)),(e,f));'))
2841         t3 = TreeNode.read(io.StringIO('(((a,b,c),(d)),(e,f));'))
2842         id_1, child_1 = t1.index_tree()
2843         nodes_1 = [n.id for n in t1.traverse(self_before=False,
2844                    self_after=True)]
2845         self.assertEqual(nodes_1, [0, 1, 2, 3, 6, 4, 5, 7, 8])
2846         npt.assert_equal(child_1, np.array([[2, 0, 1], [6, 2, 3], [7, 4, 5],
2847                                             [8, 6, 7]]))
2848         id_2, child_2 = t2.index_tree()
2849         nodes_2 = [n.id for n in t2.traverse(self_before=False,
2850                    self_after=True)]
2851         self.assertEqual(nodes_2, [0, 1, 4, 2, 3, 5, 8, 6, 7, 9, 10])
2852         npt.assert_equal(child_2, np.array([[4, 0, 1], [5, 2, 3],
2853                                             [8, 4, 5], [9, 6, 7],
2854                                             [10, 8, 9]]))
2855         id_3, child_3 = t3.index_tree()
2856         nodes_3 = [n.id for n in t3.traverse(self_before=False,
2857                    self_after=True)]
2858         self.assertEqual(nodes_3, [0, 1, 2, 4, 3, 5, 8, 6, 7, 9, 10])
2859         npt.assert_equal(child_3, np.array([[4, 0, 2], [5, 3, 3], [8, 4, 5],
2860                                             [9, 6, 7], [10, 8, 9]]))
2861     def test_root_at(self):
2862         t = TreeNode.read(io.StringIO("(((a,b)c,(d,e)f)g,h)i;"))
2863         with self.assertRaises(TreeError):
2864             t.root_at(t.find('h'))
2865         exp = "(a,b,((d,e)f,(h)g)c)root;\n"
2866         rooted = t.root_at('c')
2867         obs = str(rooted)
2868         self.assertEqual(obs, exp)
2869     def test_root_at_midpoint(self):
2870         tree1 = self.TreeRoot
2871 <a name="13"></a>        for n in tree1.traverse():
2872             n.length = 1
2873         result = tree1<font color="#3b9c9c"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.root_at_midpoint()
2874         self.assertEqual(result.distance(result.find('e')), 1.5)
2875         self.assertEqual(result.distance(result.find('g')), 2.5)
2876         exp_dist =</b></font> tree1.tip_tip_distances()
2877         obs_dist = result.tip_tip_distances()
2878         self.assertEqual(obs_dist, exp_dist)
2879     def test_root_at_midpoint_no_lengths(self):
2880         nwk = '(a,b)c;\n'
2881         t = TreeNode.read(io.StringIO(nwk))
2882         obs = t.root_at_midpoint()
2883         self.assertEqual(str(obs), nwk)
2884 <a name="24"></a>
2885     def test_root_at_midpoint_tie(self):
2886         nwk = "(((a:1,b:1)c:2,(d:3,e:4)f:5),g:1)root;"
2887         t = TreeNode<font color="#79764d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.read(io.StringIO(nwk))
2888         exp = "((d:3,e:4)f:2,((a:1,b:1)c:2,(g:1)):3)root;"
2889         texp = TreeNode.read(io.StringIO(exp))
2890 <a name="22"></a>
2891         obs = t.root_at_midpoint(</b></font>)
2892         for o, e in zip<font color="#4cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>(obs.traverse(), texp.traverse()):
2893             self.assertEqual(o.name, e.name)
2894             self.assertEqual(o.length, e.</b></font>length)
2895 <a name="5"></a>
2896     def test_compare_subsets(self):
2897         t = TreeNode.read<font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>(io.StringIO('((H,G),(R,M));'))
2898         t2 = TreeNode.read(io.StringIO('(((H,G),R),M);'))
2899         t4 = TreeNode.read(io.StringIO('(((H,G),(O,R)),X);'))
2900         result = t.compare_subsets(t)
2901         self.assertEqual(result, 0)
2902         result =</b></font> t2.compare_subsets(t2)
2903         self.assertEqual(result, 0)
2904         result = t.compare_subsets(t2)
2905         self.assertEqual(result, 0.5)
2906 <a name="33"></a>        result = t.compare_subsets(t4)
2907         self.assertEqual(result, 1 - 2. / 5)
2908         result = t<font color="#736aff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.compare_subsets(t4, exclude_absent_taxa=True)
2909         self.assertEqual(result, 1 - 2. / 3)
2910         result = t.compare_subsets(self.TreeRoot, exclude_absent_taxa=True)
2911         self.assertEqual(</b></font>result, 1)
2912         result = t.compare_subsets(self.TreeRoot)
2913         self.assertEqual(result, 1)
2914     def test_compare_rfd(self):
2915         t = TreeNode.read(io.StringIO('((H,G),(R,M));'))
2916         t2 = TreeNode.read(io.StringIO('(((H,G),R),M);'))
2917         t4 = TreeNode.read(io.StringIO('(((H,G),(O,R)),X);'))
2918         obs = t.compare_rfd(t2)
2919         exp = 2.0
2920         self.assertEqual(obs, exp)
2921 <a name="39"></a>        self.assertEqual(t.compare_rfd(t2), t2.compare_rfd(t))
2922         obs = t.compare_rfd(t2, proportion=True)
2923         exp <font color="#152dc6"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= 0.5
2924         self.assertEqual(obs, exp)
2925         with self.assertRaises(ValueError):
2926             t.compare_rfd(t4)
2927     def test_assign_ids(self):
2928 <a name="26"></a>        t1 =</b></font> TreeNode.read(io.StringIO("(((a,b),c),(e,f),(g));"))
2929         t2 = TreeNode.read(io.StringIO("(((a,b),c),(e,f),(g));"))
2930         t3 = TreeNode.read(io.StringIO("((g),(e,f),(c,(a,b)));"))
2931         t1_copy = t1<font color="#68818b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.copy()
2932         t1.assign_ids()
2933         t2.assign_ids()
2934         t3.assign_ids()
2935         t1_copy.assign_ids()
2936         self.assertEqual([(</b></font>n.name, n.id) for n in t1.traverse()],
2937                          [(n.name, n.id) for n in t2.traverse()])
2938         self.assertEqual([(n.name, n.id) for n in t1.traverse()],
2939                          [(n.name, n.id) for n in t1_copy.traverse()])
2940         self.assertNotEqual([(n.name, n.id) for n in t1.traverse()],
2941                             [(n.name, n.id) for n in t3.traverse()])
2942     def test_assign_ids_index_tree(self):
2943         t1 = TreeNode.read(io.StringIO('(((a,b),c),(d,e));'))
2944         t2 = TreeNode.read(io.StringIO('(((a,b),(c,d)),(e,f));'))
2945 <a name="6"></a>        t3 = TreeNode.read(io.StringIO('(((a,b,c),(d)),(e,f));'))
2946         t1_copy = t1.copy()
2947         t2_copy = t2.copy()
2948         t3_copy = t3<font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.copy()
2949         t1.assign_ids()
2950         t1_copy.index_tree()
2951         t2.assign_ids()
2952         t2_copy.index_tree()
2953         t3.assign_ids()
2954         t3_copy.index_tree()
2955         self.assertEqual([n.</b></font>id for n in t1.traverse()],
2956                          [n.id for n in t1_copy.traverse()])
2957         self.assertEqual([n.id for n in t2.traverse()],
2958                          [n.id for n in t2_copy.traverse()])
2959         self.assertEqual([n.id for n in t3.traverse()],
2960                          [n.id for n in t3_copy.traverse()])
2961     def test_unrooted_deepcopy(self):
2962         t = TreeNode.read(io.StringIO("((a,(b,c)d)e,(f,g)h)i;"))
2963         exp = "(b,c,(a,((f,g)h)e)d)root;\n"
2964         obs = t.find('d').unrooted_deepcopy()
2965         self.assertEqual(str(obs), exp)
2966         t_ids = {id(n) for n in t.traverse()}
2967         obs_ids = {id(n) for n in obs.traverse()}
2968         self.assertEqual(t_ids.intersection(obs_ids), set())
2969     def test_descending_branch_length(self):
2970         tr = TreeNode.read(io.StringIO(
2971             "(((A:.1,B:1.2)C:.6,(D:.9,E:.6)F:.9)G:2.4,(H:.4,I:.5)J:1.3)K;"))
2972         tdbl = tr.descending_branch_length()
2973         sdbl = tr.descending_branch_length(['A', 'E'])
2974         npt.assert_almost_equal(tdbl, 8.9)
2975         npt.assert_almost_equal(sdbl, 2.2)
2976         self.assertRaises(ValueError, tr.descending_branch_length,
2977 <a name="4"></a>                          ['A', 'DNE'])
2978         self.assertRaises(ValueError, tr.descending_branch_length, ['A', 'C'])
2979         tr = TreeNode.read<font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>(io.StringIO(
2980             "(((A,B:1.2)C:.6,(D:.9,E:.6)F:.9)G:2.4,(H:.4,I:.5)J:1.3)K;"))
2981         tdbl = tr.descending_branch_length()
2982         npt.assert_almost_equal(tdbl, 8.8)
2983         tr = TreeNode.read(io.StringIO(
2984             "(((A,B:1.2)C:.6,(D:.9,E:.6)F)G:2.4,(H:.4,I:.5)J:1.3)K;"))
2985         tdbl = tr.descending_branch_length()
2986         npt.assert_almost_equal(tdbl, 7.9)
2987         tr =</b></font> TreeNode.read(io.StringIO(
2988             "(((A,B:1.2)C:.6,(D:.9,E:.6)F)G:2.4,(H:.4,I:.5)J:1.3)K;"))
2989         tdbl = tr.descending_branch_length(['A', 'D', 'E'])
2990         npt.assert_almost_equal(tdbl, 2.1)
2991         tr = TreeNode.read(io.StringIO(
2992             "(((A,B:1.2)C:.6,(D:.9,E:.6)F:.9)G:2.4,(H:.4,I:.5)J:1.3)K;"))
2993         tdbl = tr.descending_branch_length(['I', 'D', 'E'])
2994         npt.assert_almost_equal(tdbl, 6.6)
2995         tr = TreeNode.read(io.StringIO(
2996             "(((A,B:1.2):.6,(D:.9,E:.6)F):2.4,(H:.4,I:.5)J:1.3);"))
2997         tdbl = tr.descending_branch_length()
2998         npt.assert_almost_equal(tdbl, 7.9)
2999     def test_to_array(self):
3000         t = TreeNode.read(io.StringIO(
3001             '(((a:1,b:2,c:3)x:4,(d:5)y:6)z:7,(e:8,f:9)z:10);'))
3002         id_index, child_index = t.index_tree()
3003         arrayed = t.to_array()
3004         self.assertEqual(id_index, arrayed['id_index'])
3005         npt.assert_equal(child_index, arrayed['child_index'])
3006         exp = np.array([1, 2, 3, 5, 4, 6, 8, 9, 7, 10, np.nan])
3007         obs = arrayed['length']
3008         npt.assert_equal(obs, exp)
3009         exp = np.array(['a', 'b', 'c', 'd', 'x',
3010                         'y', 'e', 'f', 'z', 'z', None])
3011         obs = arrayed['name']
3012         npt.assert_equal(obs, exp)
3013         exp = np.array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10])
3014         obs = arrayed['id']
3015         npt.assert_equal(obs, exp)
3016     def test_to_array_attrs(self):
3017         t = TreeNode.read(io.StringIO(
3018             '(((a:1,b:2,c:3)x:4,(d:5)y:6)z:7,(e:8,f:9)z:10);'))
3019         id_index, child_index = t.index_tree()
3020         arrayed = t.to_array(attrs=[('name', object)])
3021         self.assertEqual(len(arrayed), 3)
3022         self.assertEqual(id_index, arrayed['id_index'])
3023         npt.assert_equal(child_index, arrayed['child_index'])
3024         exp = np.array(['a', 'b', 'c', 'd', 'x',
3025                         'y', 'e', 'f', 'z', 'z', None])
3026         obs = arrayed['name']
3027         npt.assert_equal(obs, exp)
3028         with self.assertRaises(AttributeError):
3029             t.to_array(attrs=[('name', object), ('brofist', int)])
3030     def test_to_array_nan_length_value(self):
3031         t = TreeNode.read(io.StringIO("((a:1, b:2)c:3)root;"))
3032         indexed = t.to_array(nan_length_value=None)
3033         npt.assert_equal(indexed['length'],
3034                          np.array([1, 2, 3, np.nan], dtype=float))
3035         indexed = t.to_array(nan_length_value=0.0)
3036         npt.assert_equal(indexed['length'],
3037                          np.array([1, 2, 3, 0.0], dtype=float))
3038         indexed = t.to_array(nan_length_value=42.0)
3039         npt.assert_equal(indexed['length'],
3040                          np.array([1, 2, 3, 42.0], dtype=float))
3041         t = TreeNode.read(io.StringIO("((a:1, b:2)c:3)root:4;"))
3042         indexed = t.to_array(nan_length_value=42.0)
3043         npt.assert_equal(indexed['length'],
3044                          np.array([1, 2, 3, 4], dtype=float))
3045         t = TreeNode.read(io.StringIO("((a:1, b:2)c)root;"))
3046         indexed = t.to_array(nan_length_value=42.0)
3047         npt.assert_equal(indexed['length'],
3048                          np.array([1, 2, 42.0, 42.0], dtype=float))
3049     def test_from_taxonomy(self):
3050         input_lineages = {'1': ['a', 'b', 'c', 'd', 'e', 'f', 'g'],
3051                           '2': ['a', 'b', 'c', None, None, 'x', 'y'],
3052                           '3': ['h', 'i', 'j', 'k', 'l', 'm', 'n'],
3053                           '4': ['h', 'i', 'j', 'k', 'l', 'm', 'q'],
3054                           '5': ['h', 'i', 'j', 'k', 'l', 'm', 'n']}
3055         exp = TreeNode.read(io.StringIO(
3056             "((((((((1)g)f)e)d,((((2)y)x)))c)b)a,"
3057             "(((((((3,5)n,(4)q)m)l)k)j)i)h);"))
3058         root = TreeNode.from_taxonomy(input_lineages.items())
3059         self.assertIs(type(root), TreeNode)
3060         self.assertEqual(root.compare_subsets(exp), 0.0)
3061         root = TreeNodeSubclass.from_taxonomy(input_lineages.items())
3062         self.assertIs(type(root), TreeNodeSubclass)
3063     def test_to_taxonomy(self):
3064         input_lineages = {'1': ['a', 'b', 'c', 'd', 'e', 'f', 'g'],
3065                           '2': ['a', 'b', 'c', None, None, 'x', 'y'],
3066                           '3': ['h', 'i', 'j', 'k', 'l', 'm', 'n'],
3067                           '4': ['h', 'i', 'j', 'k', 'l', 'm', 'q'],
3068                           '5': ['h', 'i', 'j', 'k', 'l', 'm', 'n']}
3069         tree = TreeNode.from_taxonomy(input_lineages.items())
3070         exp = sorted(input_lineages.items())
3071         obs = [(n.name, lin) for n, lin in tree.to_taxonomy(allow_empty=True)]
3072         self.assertEqual(sorted(obs), exp)
3073     def test_to_taxonomy_filter(self):
3074         input_lineages = {'1': ['a', 'b', 'c', 'd', 'e', 'f', 'g'],
3075                           '2': ['a', 'b', 'c', None, None, 'x', 'y'],
3076                           '3': ['h', 'i', 'j', 'k', 'l'],  # test jagged
3077                           '4': ['h', 'i', 'j', 'k', 'l', 'm', 'q'],
3078                           '5': ['h', 'i', 'j', 'k', 'l', 'm', 'n']}
3079         tree = TreeNode.from_taxonomy(input_lineages.items())
3080         def f(node, lin):
3081             return 'k' in lin or 'x' in lin
3082         exp = [('2', ['a', 'b', 'c', 'x', 'y']),
3083                ('3', ['h', 'i', 'j', 'k', 'l']),
3084                ('4', ['h', 'i', 'j', 'k', 'l', 'm', 'q']),
3085                ('5', ['h', 'i', 'j', 'k', 'l', 'm', 'n'])]
3086         obs = [(n.name, lin) for n, lin in tree.to_taxonomy(filter_f=f)]
3087         self.assertEqual(sorted(obs), exp)
3088     def test_linkage_matrix(self):
3089         id_list = ['A', 'B', 'C', 'D', 'E', 'F', 'G']
3090         linkage = np.asarray([[1.0,  5.0,  1.0,  2.0],
3091                               [0.0,  3.0,  8.0,  2.0],
3092 <a name="40"></a>                              [6.0,  7.0, 12.5,  3.0],
3093                               [8.0,  9.0, 16.5,  5.0],
3094                               [2.0, 10.0, 29.0,  6.0],
3095                               [<font color="#347235"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>4.0, 11.0, 34.0,  7.0]])
3096         tree = TreeNode.from_linkage_matrix(linkage, id_list)
3097         self.assertIs(type(tree), TreeNode)
3098         self.assertEqual("(E:17.0,(C:14.5,((A:4.0,D:4.0):4.25,(G:6.25,(B:0.5,"
3099                          "F:0.5):5.75):2.0):6.25):2.5);\n",
3100                          str(tree))
3101         tree = TreeNodeSubclass.</b></font>from_linkage_matrix(linkage, id_list)
3102         self.assertIs(type(tree), TreeNodeSubclass)
3103     def test_shuffle_invalid_iter(self):
3104         shuffler = self.simple_t.shuffle(n=-1)
3105         with self.assertRaises(ValueError):
3106             next(shuffler)
3107     def test_shuffle_n_2(self):
3108         exp = ["((a,b)i1,(d,c)i2)root;\n",
3109                "((a,b)i1,(c,d)i2)root;\n",
3110                "((a,b)i1,(d,c)i2)root;\n",
3111                "((a,b)i1,(c,d)i2)root;\n",
3112                "((a,b)i1,(d,c)i2)root;\n"]
3113         obs_g = self.simple_t.shuffle(k=2, shuffle_f=self.rev_f, n=np.inf)
3114         obs = [str(next(obs_g)) for i in range(5)]
3115         self.assertEqual(obs, exp)
3116     def test_shuffle_n_none(self):
3117         exp = ["((d,c)i1,(b,a)i2)root;\n",
3118                "((a,b)i1,(c,d)i2)root;\n",
3119                "((d,c)i1,(b,a)i2)root;\n",
3120                "((a,b)i1,(c,d)i2)root;\n"]
3121         obs_g = self.simple_t.shuffle(shuffle_f=self.rev_f, n=4)
3122         obs = [str(next(obs_g)) for i in range(4)]
3123         self.assertEqual(obs, exp)
3124     def test_shuffle_complex(self):
3125         exp = ["(((a,b)int1,(x,y,(w,z)int2,(f,e)int3)int4),(d,c)int5);\n",
3126                "(((a,b)int1,(x,y,(w,z)int2,(c,d)int3)int4),(e,f)int5);\n",
3127                "(((a,b)int1,(x,y,(w,z)int2,(f,e)int3)int4),(d,c)int5);\n",
3128                "(((a,b)int1,(x,y,(w,z)int2,(c,d)int3)int4),(e,f)int5);\n"]
3129         obs_g = self.complex_tree.shuffle(shuffle_f=self.rev_f,
3130                                           names=['c', 'd', 'e', 'f'], n=4)
3131         obs = [str(next(obs_g)) for i in range(4)]
3132         self.assertEqual(obs, exp)
3133     def test_shuffle_names(self):
3134         exp = ["((c,a)i1,(b,d)i2)root;\n",
3135                "((b,c)i1,(a,d)i2)root;\n",
3136                "((a,b)i1,(c,d)i2)root;\n",
3137                "((c,a)i1,(b,d)i2)root;\n"]
3138         obs_g = self.simple_t.shuffle(names=['a', 'b', 'c'],
3139                                       shuffle_f=self.rotate_f, n=np.inf)
3140         obs = [str(next(obs_g)) for i in range(4)]
3141         self.assertEqual(obs, exp)
3142     def test_shuffle_raises(self):
3143         with self.assertRaises(ValueError):
3144             next(self.simple_t.shuffle(k=1))
3145         with self.assertRaises(ValueError):
3146             next(self.simple_t.shuffle(k=5, names=['a', 'b']))
3147         with self.assertRaises(MissingNodeError):
3148             next(self.simple_t.shuffle(names=['x', 'y']))
3149     def test_assign_supports(self):
3150 <a name="14"></a>        """Extract support values of internal nodes."""
3151         tree = TreeNode.read(['((a,b)75,(c,d)90);'])
3152         tree.assign_supports<font color="#842dce"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>()
3153         node1, node2 = tree.children
3154         self.assertEqual(node1.support, 75)
3155         self.assertEqual(node2.support, 90)
3156         self.assertIsNone(node1.name)
3157         self.assertIsNone(node2.</b></font>name)
3158         self.assertIsNone(tree.support)
3159         for taxon in ('a', 'b', 'c', 'd'):
3160             self.assertIsNone(tree.find(taxon).support)
3161         tree = TreeNode.read(['((a,b)0.85:1.23,(c,d)0.95:4.56);'])
3162         tree.assign_supports()
3163         node1, node2 = tree.children
3164         self.assertEqual(node1.support, 0.85)
3165         self.assertEqual(node2.support, 0.95)
3166         tree = TreeNode.read(['((a,b)75,(c,d)80.0,(e,f)97.5,(g,h)0.95);'])
3167         tree.assign_supports()
3168         node1, node2, node3, node4 = tree.children
3169         self.assertTrue(isinstance(node1.support, int))
3170         self.assertEqual(node1.support, 75)
3171         self.assertTrue(isinstance(node2.support, float))
3172         self.assertEqual(node2.support, 80.0)
3173         self.assertTrue(isinstance(node3.support, float))
3174         self.assertEqual(node3.support, 97.5)
3175         self.assertTrue(isinstance(node4.support, float))
3176         self.assertEqual(node4.support, 0.95)
3177         tree = TreeNode.read(['((a,b)-1.23,(c,d)1.23e-4);'])
3178         tree.assign_supports()
3179         node1, node2 = tree.children
3180         self.assertEqual(node1.support, -1.23)
3181 <a name="20"></a>        self.assertEqual(node2.support, 0.000123)
3182         tree = TreeNode.read([<font color="#4e9258"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>'((a,b)\'80:X\',(c,d)\'60:Y\');'])
3183         tree.assign_supports()
3184         node1, node2 = tree.children
3185         self.assertEqual(node1.support, 80)
3186         self.assertEqual(node1.name, 'X')
3187         self.assertEqual(node2.</b></font>support, 60)
3188         self.assertEqual(node2.name, 'Y')
3189         tree = TreeNode.read(['((a,b),(c,d)x,(e,f):1.0);'])
3190         tree.assign_supports()
3191         for node in tree.children:
3192             self.assertIsNone(node.support)
3193     def test_unpack(self):
3194         tree = TreeNode.read(['((c,d)a,(e,f)b);'])
3195         tree.find('b').unpack()
3196         exp = '((c,d)a,e,f);\n'
3197         self.assertEqual(str(tree), exp)
3198         tree = TreeNode.read(['((c:2.0,d:3.0)a:1.0,(e:2.0,f:1.0)b:2.0);'])
3199         tree.find('b').unpack()
3200         exp = '((c:2.0,d:3.0)a:1.0,e:4.0,f:3.0);'
3201         self.assertEqual(str(tree).rstrip(), exp)
3202         tree = TreeNode.read(['((d,e)b,(f,g)c)a;'])
3203         msg = 'Cannot unpack root.'
3204         with self.assertRaisesRegex(TreeError, msg):
3205             tree.find('a').unpack()
3206         msg = 'Cannot unpack tip.'
3207         with self.assertRaisesRegex(TreeError, msg):
3208             tree.find('d').unpack()
3209     def test_unpack_by_func(self):
3210         def func(x):
3211             return x.length &lt;= 1.0
3212         tree = TreeNode.read(['((c:2,d:3)a:1,(e:1,f:2)b:2);'])
3213         tree.unpack_by_func(func)
3214         exp = '((e:1.0,f:2.0)b:2.0,c:3.0,d:4.0);'
3215         self.assertEqual(str(tree).rstrip(), exp)
3216         tree = TreeNode.read(['((c:2,d:3)a:1,(e:1,f:2)b:2);'])
3217         tree.unpack_by_func(lambda x: x.length &lt;= 2.0)
3218         exp = '(c:3.0,d:4.0,e:3.0,f:4.0);'
3219         self.assertEqual(str(tree).rstrip(), exp)
3220         tree = TreeNode.read(['(((e:3,f:2)c:1,d:3)a:1,b:4);'])
3221         tree.unpack_by_func(lambda x: x.length &lt;= 2.0)
3222         exp = '(b:4.0,d:4.0,e:5.0,f:4.0);'
3223         self.assertEqual(str(tree).rstrip(), exp)
3224         def func(x):
3225             return x.length &lt; 2.0
3226         tree = TreeNode.read(['(((a:1.04,b:2.32,c:1.44)d:3.20,'
3227                               '(e:3.91,f:2.47)g:1.21)h:1.75,'
3228                               '(i:4.14,(j:2.06,k:1.58)l:3.32)m:0.77);'])
3229         tree.unpack_by_func(func)
3230         exp = ('((a:1.04,b:2.32,c:1.44)d:4.95,e:6.87,f:5.43,i:4.91,'
3231                '(j:2.06,k:1.58)l:4.09);')
3232         self.assertEqual(str(tree).rstrip(), exp)
3233         def func(x):
3234             return x.support &lt; 75
3235         tree = TreeNode.read(['(((a,b)85,(c,d)78)75,(e,(f,g)64)80);'])
3236         tree.assign_supports()
3237         tree.unpack_by_func(func)
3238         exp = '(((a,b)85,(c,d)78)75,(e,f,g)80);'
3239         self.assertEqual(str(tree).rstrip(), exp)
3240         tree = TreeNode.read(['(((a,b)85,(c,d)78)75,(e,(f,g)64)80);'])
3241         tree.assign_supports()
3242         tree.unpack_by_func(lambda x: x.support &lt; 85)
3243         exp = '((a,b)85,c,d,e,f,g);'
3244         self.assertEqual(str(tree).rstrip(), exp)
3245         tree = TreeNode.read(['(((a,b)0.97,(c,d)0.98)1.0,(e,(f,g)0.88)0.96);'])
3246         tree.assign_supports()
3247         tree.unpack_by_func(lambda x: x.support &lt; 0.95)
3248         exp = '(((a,b)0.97,(c,d)0.98)1.0,(e,f,g)0.96);'
3249         self.assertEqual(str(tree).rstrip(), exp)
3250         tree = TreeNode.read(['(((a:1.02,b:0.33)85:0.12,(c:0.86,d:2.23)'
3251                               '70:3.02)75:0.95,(e:1.43,(f:1.69,g:1.92)64:0.20)'
3252                               'node:0.35)root;'])
3253         tree.assign_supports()
3254         tree.unpack_by_func(lambda x: x.support is not None and x.support &lt; 75)
3255         exp = ('(((a:1.02,b:0.33)85:0.12,c:3.88,d:5.25)75:0.95,'
3256                '(e:1.43,f:1.89,g:2.12)node:0.35)root;')
3257         self.assertEqual(str(tree).rstrip(), exp)
3258 sample = """
3259 (
3260 (
3261 xyz:0.28124,
3262 (
3263 def:0.24498,
3264 mno:0.03627)
3265 :0.17710)
3266 :0.04870,
3267 abc:0.05925,
3268 (
3269 ghi:0.06914,
3270 jkl:0.13776)
3271 :0.09853);
3272 minimal = "();"
3273 no_names = "((,),(,));"
3274 missing_tip_name = "((a,b),(c,));"
3275 empty = '();'
3276 single = '(abc:3);'
3277 double = '(abc:3, def:4);'
3278 onenest = '(abc:3, (def:4, ghi:5):6 );'
3279 nodedata = '(abc:3, (def:4, ghi:5)jkl:6 );'
3280 exp_ascii_art_three_children = r"""          /-a
3281          |
3282 ---------|          /-b
3283          |         |
3284           \--------|--c
3285                    |
3286                     \-d"""
3287 if __name__ == '__main__':
3288     main()
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
