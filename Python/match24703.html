<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_pkgutil.py &amp; test_module_3.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_pkgutil.py &amp; test_module_3.py
      </h3>
<h1 align="center">
        9.0%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_pkgutil.py (25.0%)<th>test_module_3.py (5.5135136%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(243-255)<td><a href="#" name="0">(372-377)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(206-209)<td><a href="#" name="1">(529-534)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(174-186)<td><a href="#" name="2">(507-512)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(99-111)<td><a href="#" name="3">(460-465)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(73-86)<td><a href="#" name="4">(438-443)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(56-61)<td><a href="#" name="5">(394-399)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(214-225)<td><a href="#" name="6">(145-148)</a><td align="center"><font color="#eb0000">12</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(25-27)<td><a href="#" name="7">(556-560)</a><td align="center"><font color="#eb0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_pkgutil.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import pytest
2 import salt.modules.pkgutil as pkgutil
3 import salt.utils.pkg
4 from salt.exceptions import CommandExecutionError, MinionError
5 from tests.support.mock import MagicMock, Mock, patch
6 @pytest.fixture
7 def configure_loader_modules():
8     return {pkgutil: {}}
9 def test_refresh_db():
10     Test if it updates the pkgutil repo database (pkgutil -U).
11     """
12     mock <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= MagicMock(return_value=0)
13     with patch.dict(pkgutil.__salt__, {"cmd.retcode": mock}):
14         with patch.object(salt.</b></font>utils.pkg, "clear_rtag", Mock()):
15             assert pkgutil.refresh_db()
16 def test_upgrade_available():
17     """
18     Test if there is an upgrade available for a certain package.
19     """
20     mock = MagicMock(return_value="A\n B\n SAME")
21     with patch.dict(pkgutil.__salt__, {"cmd.run_stdout": mock}):
22         assert pkgutil.upgrade_available("CSWpython") == ""
23     mock = MagicMock(side_effect=["A\n B\n SALT", None])
24     with patch.dict(pkgutil.__salt__, {"cmd.run_stdout": mock}):
25         assert pkgutil.upgrade_available("CSWpython") == "SALT"
26         assert pkgutil.upgrade_available("CSWpython") == ""
27 def test_list_upgrades():
28     Test if it list all available package upgrades on this system.
29     """
30     mock_run = MagicMock(return_value<font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>="A\t B\t SAME")
31     mock_ret = MagicMock(return_value=0)
32     with patch.dict(
33         pkgutil.__salt__, {"cmd.run_stdout": mock_run, "cmd.retcode": mock_ret}
34     ):
35         with patch.object(salt.</b></font>utils.pkg, "clear_rtag", Mock()):
36             assert pkgutil.list_upgrades() == {"A": " B"}
37 def test_upgrade():
38     """
39     """
40     mock_run = MagicMock(return_value="A\t B\t SAME")
41     mock_ret = MagicMock(return_value<font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=0)
42     mock_pkg = MagicMock(return_value="")
43     with patch.dict(
44         pkgutil.__salt__,
45         {
46             "cmd.run_stdout": mock_run,
47             "cmd.retcode": mock_ret,
48             "pkg_resource.stringify": mock_pkg,
49             "pkg_resource.sort_pkglist": mock_pkg,
50             "cmd.run_all": mock_ret,
51             "cmd.run": mock_run,
52         },
53     ):
54         with patch.dict(pkgutil.</b></font>__context__, {"pkg.list_pkgs": mock_ret}):
55             with patch.object(salt.utils.pkg, "clear_rtag", Mock()):
56                 assert pkgutil.upgrade() == {}
57 def test_list_pkgs():
58     """
59     """
60     mock_run = MagicMock(return_value="A\t B\t SAME")
61     mock_ret = MagicMock(return_value<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=True)
62     mock_pkg = MagicMock(return_value="")
63     with patch.dict(
64         pkgutil.__salt__,
65         {
66             "cmd.run_stdout": mock_run,
67             "cmd.retcode": mock_ret,
68             "pkg_resource.stringify": mock_pkg,
69             "pkg_resource.sort_pkglist": mock_pkg,
70             "cmd.run": mock_run,
71         },
72     ):
73         with patch.dict(pkgutil.</b></font>__context__, {"pkg.list_pkgs": mock_ret}):
74             assert pkgutil.list_pkgs(versions_as_list=True, removed=True) == {}
75         assert pkgutil.list_pkgs() == {}
76     with patch.dict(pkgutil.__context__, {"pkg.list_pkgs": True}):
77         assert pkgutil.list_pkgs(versions_as_list=True)
78         mock_pkg = MagicMock(return_value=True)
79         with patch.dict(pkgutil.__salt__, {"pkg_resource.stringify": mock_pkg}):
80             assert pkgutil.list_pkgs()
81 def test_list_pkgs_no_context():
82     """
83     Test if it list the packages currently installed as a dict.
84     """
85     mock_run = MagicMock(return_value="A\t B\t SAME")
86     mock_ret = MagicMock(return_value=True)
87     mock_pkg = MagicMock(return_value="")
88     with patch.dict(
89         pkgutil.__salt__,
90         {
91             "cmd.run_stdout": mock_run,
92             "cmd.retcode": mock_ret,
93             "pkg_resource.stringify": mock_pkg,
94             "pkg_resource.sort_pkglist": mock_pkg,
95             "cmd.run": mock_run,
96         },
97     ), patch.object(pkgutil, "_list_pkgs_from_context") as list_pkgs_context_mock:
98         pkgs = pkgutil.list_pkgs(versions_as_list=True, removed=True, use_context=False)
99         list_pkgs_context_mock.assert_not_called()
100         list_pkgs_context_mock.reset_mock()
101         pkgs = pkgutil.list_pkgs(versions_as_list=True, removed=True, use_context=False)
102         list_pkgs_context_mock.assert_not_called()
103         list_pkgs_context_mock.reset_mock()
104 def test_version():
105     """
106     Test if it returns a version if the package is installed.
107     """
108     mock_ret = MagicMock(return_value=True)
109     with patch.dict(pkgutil.__salt__, {"pkg_resource.version": mock_ret}):
110         assert pkgutil.version("CSWpython")
111 def test_latest_version():
112     """
113     Test if it return the latest version of the named package
114     available for upgrade or installation.
115     """
116     assert pkgutil.latest_version() == ""
117     mock_run_all = MagicMock(return_value="A\t B\t SAME")
118     mock_run = MagicMock(return_value={"stdout": ""})
119     mock_ret = MagicMock(return_value<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=True)
120     mock_pkg = MagicMock(return_value="")
121     with patch.dict(
122         pkgutil.__salt__,
123         {
124             "cmd.retcode": mock_ret,
125             "pkg_resource.stringify": mock_pkg,
126             "pkg_resource.sort_pkglist": mock_pkg,
127             "cmd.run_all": mock_run,
128             "cmd.run": mock_run_all,
129         },
130     ):
131         with patch.object(salt.</b></font>utils.pkg, "clear_rtag", Mock()):
132             assert pkgutil.latest_version("CSWpython") == ""
133             assert pkgutil.latest_version("CSWpython", "Python") == {
134                 "Python": "",
135                 "CSWpython": "",
136             }
137 def test_install():
138     """
139     Test if it install packages using the pkgutil tool.
140     """
141     mock_pkg = MagicMock(side_effect=MinionError)
142         pytest.raises(CommandExecutionError, pkgutil.install)
143     mock_ret = MagicMock(return_value<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=True)
144     mock_pkg = MagicMock(return_value=[""])
145     with patch.dict(pkgutil.__salt__, {"pkg_resource.parse_targets": mock_pkg}):
146         with patch.dict(pkgutil.</b></font>__context__, {"pkg.list_pkgs": mock_ret}):
147             assert pkgutil.install() == {}
148     mock_run = MagicMock(return_value="A\t B\t SAME")
149     mock_run_all = MagicMock(return_value={"stdout": ""})
150     mock_pkg <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= MagicMock(return_value=[{"bar": "1.2.3"}])
151     with patch.dict(
152         pkgutil.__salt__,
153         {
154             "pkg_resource.parse_targets": mock_pkg,
155             "pkg_resource.stringify": mock_pkg,
156             "pkg_resource.sort_pkglist": mock_pkg,
157             "cmd.run_all": mock_run_all,
158             "cmd.run": mock_run,
159         },
160     ):
161         with patch.dict(</b></font>pkgutil.__context__, {"pkg.list_pkgs": mock_ret}):
162             assert pkgutil.install(pkgs='["foo", {"bar": "1.2.3"}]') == {}
163 def test_remove():
164     """
165     Test if it remove a package and all its dependencies
166     which are not in use by other packages.
167     """
168     mock_pkg = MagicMock(side_effect=MinionError)
169     with patch.dict(pkgutil.__salt__, {"pkg_resource.parse_targets": mock_pkg}):
170         pytest.raises(CommandExecutionError, pkgutil.remove)
171     mock_ret = MagicMock(return_value=True)
172     mock_run = MagicMock(return_value="A\t B\t SAME")
173     mock_run_all = MagicMock(return_value={<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"stdout": ""})
174     mock_pkg = MagicMock(return_value=[""])
175     with patch.dict(
176         pkgutil.__salt__,
177         {
178             "pkg_resource.parse_targets": mock_pkg,
179             "pkg_resource.stringify": mock_pkg,
180             "pkg_resource.sort_pkglist": mock_pkg,
181             "cmd.run_all": mock_run_all,
182             "cmd.run": mock_run,
183         },
184     ):
185         with patch.dict(pkgutil.</b></font>__context__, {"pkg.list_pkgs": mock_ret}):
186             assert pkgutil.remove() == {}
187     mock_pkg = MagicMock(return_value=[{"bar": "1.2.3"}])
188     with patch.dict(
189         pkgutil.__salt__,
190         {
191             "pkg_resource.parse_targets": mock_pkg,
192             "pkg_resource.stringify": mock_pkg,
193             "pkg_resource.sort_pkglist": mock_pkg,
194             "cmd.run_all": mock_run_all,
195             "cmd.run": mock_run,
196         },
197     ):
198         with patch.dict(pkgutil.__context__, {"pkg.list_pkgs": mock_ret}):
199             with patch.object(pkgutil, "list_pkgs", return_value={"bar": "1.2.3"}):
200                 assert pkgutil.remove(pkgs='["foo", "bar"]') == {}
201 def test_purge():
202     """
203     Test if it package purges are not supported,
204     this function is identical to ``remove()``.
205     """
206     mock_pkg = MagicMock(side_effect=MinionError)
207     with patch.dict(pkgutil.__salt__, {"pkg_resource.parse_targets": mock_pkg}):
208         pytest.raises(CommandExecutionError, pkgutil.purge)
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_module_3.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 """
2 Unit tests for the docker module
3 """
4 import logging
5 import pytest
6 import salt.config
7 import salt.loader
8 import salt.modules.dockermod as docker_mod
9 import salt.utils.platform
10 from salt.exceptions import CommandExecutionError, SaltInvocationError
11 from tests.support.mock import MagicMock, Mock, call, patch
12 log = logging.getLogger(__name__)
13 pytest.importorskip(
14     "docker", reason="The python 'docker' package must be installed to run these tests"
15 )
16 @pytest.fixture
17 def configure_loader_modules():
18     utils = salt.loader.utils(
19         salt.config.DEFAULT_MINION_OPTS.copy(),
20         whitelist=[
21             "args",
22             "docker",
23             "json",
24             "state",
25             "thin",
26             "systemd",
27             "path",
28             "platform",
29         ],
30     )
31     return {
32         docker_mod: {
33             "__context__": {"docker.docker_version": ""},
34             "__utils__": utils,
35         }
36     }
37 def test_failed_login():
38     """
39     Check that when docker.login failed a retcode other then 0
40     is part of the return.
41     """
42     client = Mock()
43     get_client_mock = MagicMock(return_value=client)
44     ref_out = {"stdout": "", "stderr": "login failed", "retcode": 1}
45     with patch.dict(
46         docker_mod.__pillar__,
47         {
48             "docker-registries": {
49                 "portus.example.com:5000": {
50                     "username": "admin",
51                     "password": "linux12345",
52                     "email": "tux@example.com",
53                 }
54             }
55         },
56     ):
57         with patch.object(docker_mod, "_get_client", get_client_mock):
58             dunder_salt = {
59                 "cmd.run_all": MagicMock(return_value=ref_out),
60                 "config.get": MagicMock(return_value={}),
61                 "config.option": MagicMock(return_value={}),
62             }
63             with patch.dict(docker_mod.__salt__, dunder_salt):
64                 ret = docker_mod.login("portus.example.com:5000")
65                 assert "retcode" in ret
66                 assert ret["retcode"] != 0
67 def test_logout_calls_docker_cli_logout_single():
68     client = Mock()
69     get_client_mock = MagicMock(return_value=client)
70     ref_out = {"stdout": "", "stderr": "", "retcode": 0}
71     registry_auth_data = {
72         "portus.example.com:5000": {
73             "username": "admin",
74             "password": "linux12345",
75             "email": "tux@example.com",
76         }
77     }
78     docker_mock = MagicMock(return_value=ref_out)
79     with patch.object(docker_mod, "_get_client", get_client_mock):
80         dunder_salt = {
81             "config.get": MagicMock(return_value=registry_auth_data),
82             "cmd.run_all": docker_mock,
83             "config.option": MagicMock(return_value={}),
84         }
85         with patch.dict(docker_mod.__salt__, dunder_salt):
86             ret = docker_mod.logout("portus.example.com:5000")
87             assert "retcode" in ret
88             assert ret["retcode"] == 0
89             docker_mock.assert_called_with(
90                 ["docker", "logout", "portus.example.com:5000"],
91                 python_shell=False,
92                 output_loglevel="quiet",
93             )
94 def test_logout_calls_docker_cli_logout_all():
95     client = Mock()
96     get_client_mock = MagicMock(return_value=client)
97     ref_out = {"stdout": "", "stderr": "", "retcode": 0}
98     registry_auth_data = {
99         "portus.example.com:5000": {
100             "username": "admin",
101             "password": "linux12345",
102             "email": "tux@example.com",
103         },
104         "portus2.example.com:5000": {
105             "username": "admin",
106             "password": "linux12345",
107             "email": "tux@example.com",
108         },
109     }
110     docker_mock = MagicMock(return_value=ref_out)
111     with patch.object(docker_mod, "_get_client", get_client_mock):
112         dunder_salt = {
113             "config.get": MagicMock(return_value=registry_auth_data),
114             "cmd.run_all": docker_mock,
115             "config.option": MagicMock(return_value={}),
116         }
117         with patch.dict(docker_mod.__salt__, dunder_salt):
118             ret = docker_mod.logout()
119             assert "retcode" in ret
120             assert ret["retcode"] == 0
121             assert docker_mock.call_count == 2
122 def test_ps_with_host_true():
123     """
124     Check that docker.ps called with host is ``True``,
125     include resutlt of ``network.interfaces`` command in returned result.
126     """
127     client.containers = MagicMock(return_value=[])
128     get_client_mock = MagicMock(return_value=client)
129     network_interfaces <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= Mock(return_value={"mocked": None})
130     with patch.dict(docker_mod.__salt__, {"network.interfaces": network_interfaces}):
131         with patch.object(</b></font>docker_mod, "_get_client", get_client_mock):
132             ret = docker_mod.ps_(host=True)
133             assert ret == {"host": {"interfaces": {"mocked": None}}}
134 def test_ps_with_filters():
135     """
136     Check that docker.ps accept filters parameter.
137     """
138     client = Mock()
139     client.containers = MagicMock(return_value=[])
140     get_client_mock = MagicMock(return_value=client)
141     with patch.object(docker_mod, "_get_client", get_client_mock):
142         docker_mod.ps_(filters={"label": "KEY"})
143         client.containers.assert_called_once_with(all=True, filters={"label": "KEY"})
144 @pytest.mark.slow_test
145 @pytest.mark.parametrize(
146     "command_name, args",
147     (
148         ("create", ()),
149         ("rm_", ()),
150         ("kill", ()),
151         ("pause", ()),
152         ("signal_", ("KILL",)),
153         ("start_", ()),
154         ("stop", ()),
155         ("unpause", ()),
156         ("_run", ("command",)),
157         ("_script", ("command",)),
158     ),
159 )
160 def test_check_mine_cache_is_refreshed_on_container_change_event(command_name, args):
161     """
162     Every command that might modify docker containers state.
163     Should trig an update on ``mine.send``
164     """
165     if salt.utils.platform.is_windows() and command_name == "_script":
166         pytest.skip(
167             "Skipping test since `dockermod._script` will create a temporary file in /tmp "
168             "which does not exist on windows"
169         )
170     with patch.object(docker_mod, "_get_exec_driver"):
171         client_args_mock = MagicMock(
172             return_value={
173                 "create_container": [
174                     "image",
175                     "command",
176                     "hostname",
177                     "user",
178                     "detach",
179                     "stdin_open",
180                     "tty",
181                     "ports",
182                     "environment",
183                     "volumes",
184                     "network_disabled",
185                     "name",
186                     "entrypoint",
187                     "working_dir",
188                     "domainname",
189                     "cpuset",
190                     "host_config",
191                     "mac_address",
192                     "labels",
193                     "volume_driver",
194                     "stop_signal",
195                     "networking_config",
196                     "healthcheck",
197                     "stop_timeout",
198                 ],
199                 "host_config": [
200                     "binds",
201                     "port_bindings",
202                     "lxc_conf",
203                     "publish_all_ports",
204                     "links",
205                     "privileged",
206                     "dns",
207                     "dns_search",
208                     "volumes_from",
209                     "network_mode",
210                     "restart_policy",
211                     "cap_add",
212                     "cap_drop",
213                     "devices",
214                     "extra_hosts",
215                     "read_only",
216                     "pid_mode",
217                     "ipc_mode",
218                     "security_opt",
219                     "ulimits",
220                     "log_config",
221                     "mem_limit",
222                     "memswap_limit",
223                     "mem_reservation",
224                     "kernel_memory",
225                     "mem_swappiness",
226                     "cgroup_parent",
227                     "group_add",
228                     "cpu_quota",
229                     "cpu_period",
230                     "blkio_weight",
231                     "blkio_weight_device",
232                     "device_read_bps",
233                     "device_write_bps",
234                     "device_read_iops",
235                     "device_write_iops",
236                     "oom_kill_disable",
237                     "shm_size",
238                     "sysctls",
239                     "tmpfs",
240                     "oom_score_adj",
241                     "dns_opt",
242                     "cpu_shares",
243                     "cpuset_cpus",
244                     "userns_mode",
245                     "pids_limit",
246                     "isolation",
247                     "auto_remove",
248                     "storage_opt",
249                 ],
250                 "networking_config": [
251                     "aliases",
252                     "links",
253                     "ipv4_address",
254                     "ipv6_address",
255                     "link_local_ips",
256                 ],
257             }
258         )
259         mine_send = Mock()
260         command = getattr(docker_mod, command_name)
261         client = MagicMock()
262         client.api_version = "1.12"
263         with patch.dict(
264             docker_mod.__salt__,
265             {
266                 "mine.send": mine_send,
267                 "container_resource.run": MagicMock(),
268                 "config.get": MagicMock(return_value=True),
269                 "config.option": MagicMock(return_value=True),
270                 "cp.cache_file": MagicMock(return_value=False),
271             },
272         ):
273             with patch.dict(
274                 docker_mod.__utils__,
275                 {"docker.get_client_args": client_args_mock},
276             ):
277                 with patch.object(docker_mod, "_get_client", client):
278                     command("container", *args)
279         try:
280             mine_send.assert_called_with("docker.ps", verbose=True, all=True, host=True)
281         except AssertionError as exc:
282             raise Exception(
283                 "command '{}' did not call docker.ps with expected "
284                 "arguments: {}".format(command_name, exc)
285             )
286 def test_update_mine():
287     """
288     Test the docker.update_mine config option
289     """
290     def config_get_disabled(val, default):
291         return {
292             "base_url": docker_mod.NOTSET,
293             "version": docker_mod.NOTSET,
294             "docker.url": docker_mod.NOTSET,
295             "docker.version": docker_mod.NOTSET,
296             "docker.machine": docker_mod.NOTSET,
297             "docker.update_mine": False,
298         }[val]
299     def config_get_enabled(val, default):
300         return {
301             "base_url": docker_mod.NOTSET,
302             "version": docker_mod.NOTSET,
303             "docker.url": docker_mod.NOTSET,
304             "docker.version": docker_mod.NOTSET,
305             "docker.machine": docker_mod.NOTSET,
306             "docker.update_mine": True,
307         }[val]
308     mine_mock = Mock()
309     dunder_salt = {
310         "config.get": MagicMock(side_effect=config_get_disabled),
311         "config.option": MagicMock(return_value=False),
312         "mine.send": mine_mock,
313     }
314     with patch.dict(docker_mod.__salt__, dunder_salt), patch.dict(
315         docker_mod.__context__, {"docker.client": Mock()}
316     ), patch.object(docker_mod, "state", MagicMock(return_value="stopped")):
317         docker_mod.stop("foo", timeout=1)
318         mine_mock.assert_not_called()
319     with patch.dict(docker_mod.__salt__, dunder_salt), patch.dict(
320         docker_mod.__context__, {"docker.client": Mock()}
321     ), patch.object(docker_mod, "state", MagicMock(return_value="stopped")):
322         dunder_salt["config.get"].side_effect = config_get_enabled
323         dunder_salt["config.option"].return_value = True
324         docker_mod.stop("foo", timeout=1)
325         mine_mock.assert_called_once()
326 @pytest.mark.skipif(
327     docker_mod.docker.version_info &lt; (1, 5, 0),
328     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
329 )
330 def test_list_networks():
331     """
332     test list networks.
333     """
334     __salt__ = {
335         "config.get": Mock(),
336         "mine.send": Mock(),
337     }
338     client.api_version = "1.21"
339     client.networks = Mock(
340         return_value=[{<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>"Name": "foo", "Id": "01234", "Containers": {}}]
341     )
342     get_client_mock = MagicMock(return_value=client)
343     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
344         with patch.object(docker_mod, "_get_client", get_client_mock):
345             docker_mod.</b></font>networks(names=["foo"], ids=["01234"])
346     client.networks.assert_called_once_with(names=["foo"], ids=["01234"])
347 @pytest.mark.skipif(
348     docker_mod.docker.version_info &lt; (1, 5, 0),
349     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
350 )
351 def test_create_network():
352     """
353     test create network.
354     """
355     __salt__ = {
356         "config.get": Mock(),
357     }
358     client = Mock()
359     client.api_version <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "1.21"
360     get_client_mock = MagicMock(return_value=client)
361     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
362         with patch.object(docker_mod, "_get_client", get_client_mock):
363             docker_mod.</b></font>create_network(
364                 "foo",
365                 driver="bridge",
366                 driver_opts={},
367                 gateway="192.168.0.1",
368                 ip_range="192.168.0.128/25",
369                 subnet="192.168.0.0/24",
370             )
371     client.create_network.assert_called_once_with(
372         "foo",
373         driver="bridge",
374         options={},
375         ipam={
376             "Config": [
377                 {
378                     "Gateway": "192.168.0.1",
379                     "IPRange": "192.168.0.128/25",
380                     "Subnet": "192.168.0.0/24",
381                 }
382             ],
383             "Driver": "default",
384         },
385         check_duplicate=True,
386     )
387 @pytest.mark.skipif(
388     docker_mod.docker.version_info &lt; (1, 5, 0),
389     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
390 )
391 def test_remove_network():
392     """
393     test remove network.
394     """
395     __salt__ = {
396         "config.get": Mock(),
397     }
398     client = Mock()
399     client.api_version <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "1.21"
400     get_client_mock = MagicMock(return_value=client)
401     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
402         with patch.object(docker_mod, "_get_client", get_client_mock):
403             docker_mod.</b></font>remove_network("foo")
404     client.remove_network.assert_called_once_with("foo")
405 @pytest.mark.skipif(
406     docker_mod.docker.version_info &lt; (1, 5, 0),
407     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
408 )
409 def test_inspect_network():
410     """
411     test inspect network.
412     """
413     __salt__ = {
414         "config.get": Mock(),
415     }
416     client = Mock()
417     client.api_version <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "1.21"
418     get_client_mock = MagicMock(return_value=client)
419     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
420         with patch.object(docker_mod, "_get_client", get_client_mock):
421             docker_mod.</b></font>inspect_network("foo")
422     client.inspect_network.assert_called_once_with("foo")
423 @pytest.mark.skipif(
424     docker_mod.docker.version_info &lt; (1, 5, 0),
425     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
426 )
427 def test_connect_container_to_network():
428     """
429     test connect_container_to_network
430     """
431     __salt__ = {
432         "config.get": Mock(),
433         "mine.send": Mock(),
434     }
435     client = Mock()
436     client.api_version = "1.21"
437     get_client_mock = MagicMock(return_value=client)
438     context = {"docker.exec_driver": "docker-exec"}
439     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
440         with patch.dict(docker_mod.__context__, context):
441             with patch.object(docker_mod, "_get_client", get_client_mock):
442                 docker_mod.connect_container_to_network("container", "foo")
443     client.connect_container_to_network.assert_called_once_with("container", "foo")
444 @pytest.mark.skipif(
445     docker_mod.docker.version_info &lt; (1, 5, 0),
446     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
447 )
448 def test_disconnect_container_from_network():
449     """
450     test disconnect_container_from_network
451     """
452     __salt__ = {
453         "config.get": Mock(),
454     }
455     client = Mock()
456     client.api_version <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "1.21"
457     get_client_mock = MagicMock(return_value=client)
458     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
459         with patch.object(docker_mod, "_get_client", get_client_mock):
460             docker_mod.</b></font>disconnect_container_from_network("container", "foo")
461     client.disconnect_container_from_network.assert_called_once_with("container", "foo")
462 @pytest.mark.skipif(
463     docker_mod.docker.version_info &lt; (1, 5, 0),
464     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
465 )
466 def test_list_volumes():
467     """
468     test list volumes.
469     """
470     __salt__ = {
471         "config.get": Mock(),
472     }
473     client = Mock()
474     client.api_version <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "1.21"
475     get_client_mock = MagicMock(return_value=client)
476     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
477         with patch.object(docker_mod, "_get_client", get_client_mock):
478             docker_mod.</b></font>volumes(
479                 filters={"dangling": [True]},
480             )
481     client.volumes.assert_called_once_with(
482         filters={"dangling": [True]},
483     )
484 @pytest.mark.skipif(
485     docker_mod.docker.version_info &lt; (1, 5, 0),
486     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
487 )
488 def test_create_volume():
489     """
490     test create volume.
491     """
492     __salt__ = {
493         "config.get": Mock(),
494         "mine.send": Mock(),
495     client = Mock()
496     client.api_version = "1.21"
497     get_client_mock <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= MagicMock(return_value=client)
498     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
499         with patch.object(docker_mod, "_get_client", get_client_mock):
500             docker_mod.</b></font>create_volume(
501                 "foo",
502                 driver="bridge",
503                 driver_opts={},
504             )
505     client.create_volume.assert_called_once_with(
506         "foo",
507         driver="bridge",
508         driver_opts={},
509     )
510 @pytest.mark.skipif(
511     docker_mod.docker.version_info &lt; (1, 5, 0),
512     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
513 )
514 def test_remove_volume():
515     """
516     test remove volume.
517     """
518     __salt__ = {
519         "config.get": Mock(),
520         "mine.send": Mock(),
521     }
522     client = Mock()
523     client.api_version = "1.21"
524     get_client_mock = MagicMock(return_value=client)
525     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
526         with patch.object(docker_mod, "_get_client", get_client_mock):
527             docker_mod.remove_volume("foo")
528     client.remove_volume.assert_called_once_with("foo")
529 @pytest.mark.skipif(
530     docker_mod.docker.version_info &lt; (1, 5, 0),
531     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
532 )
533 def test_inspect_volume():
534     """
535     test inspect volume.
536     """
537     __salt__ = {
538         "config.get": Mock(),
539         "mine.send": Mock(),
540     }
541     client = Mock()
542     client.api_version = "1.21"
543     get_client_mock = MagicMock(return_value=client)
544     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
545         with patch.object(docker_mod, "_get_client", get_client_mock):
546             docker_mod.inspect_volume("foo")
547     client.inspect_volume.assert_called_once_with("foo")
548 def test_wait_success():
549     client = Mock()
550     client.api_version = "1.21"
551     client.wait = Mock(return_value=0)
552     get_client_mock = MagicMock(return_value=client)
553     docker_inspect_container = Mock(
554         side_effect=[{"State": {"Running": True}}, {"State": {"Stopped": True}}]
555     )
556     with patch.object(docker_mod, "inspect_container", docker_inspect_container):
557         with patch.object(docker_mod, "_get_client", get_client_mock):
558             docker_mod._clear_context()
559             result = docker_mod.wait("foo")
560     assert result == {
561         "result": True,
562         "exit_status": 0,
563         "state": {"new": "stopped", "old": "running"},
564     }
565 def test_wait_fails_already_stopped():
566     client = Mock()
567     client.api_version = "1.21"
568     client.wait = Mock(return_value=0)
569     get_client_mock = MagicMock(return_value=client)
570     docker_inspect_container = Mock(
571         side_effect=[{"State": {"Stopped": True}}, {"State": {"Stopped": True}}]
572     )
573     with patch.object(docker_mod, "inspect_container", docker_inspect_container):
574         with patch.object(docker_mod, "_get_client", get_client_mock):
575             docker_mod._clear_context()
576             result = docker_mod.wait("foo")
577     assert result == {
578         "result": False,
579         "comment": "Container 'foo' already stopped",
580         "exit_status": 0,
581         "state": {"new": "stopped", "old": "stopped"},
582     }
583 def test_wait_success_already_stopped():
584     client = Mock()
585     client.api_version = "1.21"
586     client.wait = Mock(return_value=0)
587     get_client_mock = MagicMock(return_value=client)
588     docker_inspect_container = Mock(
589         side_effect=[{"State": {"Stopped": True}}, {"State": {"Stopped": True}}]
590     )
591     with patch.object(docker_mod, "inspect_container", docker_inspect_container):
592         with patch.object(docker_mod, "_get_client", get_client_mock):
593             docker_mod._clear_context()
594             result = docker_mod.wait("foo", ignore_already_stopped=True)
595     assert result == {
596         "result": True,
597         "comment": "Container 'foo' already stopped",
598         "exit_status": 0,
599         "state": {"new": "stopped", "old": "stopped"},
600     }
601 def test_wait_success_absent_container():
602     client = Mock()
603     client.api_version = "1.21"
604     get_client_mock = MagicMock(return_value=client)
605     docker_inspect_container = Mock(side_effect=CommandExecutionError)
606     with patch.object(docker_mod, "inspect_container", docker_inspect_container):
607         with patch.object(docker_mod, "_get_client", get_client_mock):
608             docker_mod._clear_context()
609             result = docker_mod.wait("foo", ignore_already_stopped=True)
610     assert result == {"result": True, "comment": "Container 'foo' absent"}
611 def test_wait_fails_on_exit_status():
612     client = Mock()
613     client.api_version = "1.21"
614     client.wait = Mock(return_value=1)
615     get_client_mock = MagicMock(return_value=client)
616     docker_inspect_container = Mock(
617         side_effect=[{"State": {"Running": True}}, {"State": {"Stopped": True}}]
618     )
619     with patch.object(docker_mod, "inspect_container", docker_inspect_container):
620         with patch.object(docker_mod, "_get_client", get_client_mock):
621             docker_mod._clear_context()
622             result = docker_mod.wait("foo", fail_on_exit_status=True)
623     assert result == {
624         "result": False,
625         "exit_status": 1,
626         "state": {"new": "stopped", "old": "running"},
627     }
628 def test_wait_fails_on_exit_status_and_already_stopped():
629     client = Mock()
630     client.api_version = "1.21"
631     client.wait = Mock(return_value=1)
632     get_client_mock = MagicMock(return_value=client)
633     docker_inspect_container = Mock(
634         side_effect=[{"State": {"Stopped": True}}, {"State": {"Stopped": True}}]
635     )
636     with patch.object(docker_mod, "inspect_container", docker_inspect_container):
637         with patch.object(docker_mod, "_get_client", get_client_mock):
638             docker_mod._clear_context()
639             result = docker_mod.wait(
640                 "foo", ignore_already_stopped=True, fail_on_exit_status=True
641             )
642     assert result == {
643         "result": False,
644         "comment": "Container 'foo' already stopped",
645         "exit_status": 1,
646         "state": {"new": "stopped", "old": "stopped"},
647     }
648 def test_sls_build():
649     """
650     test build sls image.
651     """
652     docker_start_mock = MagicMock(return_value={})
653     docker_create_mock = MagicMock(return_value={"Id": "ID", "Name": "NAME"})
654     docker_stop_mock = MagicMock(
655         return_value={"state": {"old": "running", "new": "stopped"}, "result": True}
656     )
657     docker_rm_mock = MagicMock(return_value={})
658     docker_commit_mock = MagicMock(
659         return_value={"Id": "ID2", "Image": "foo", "Time_Elapsed": 42}
660     )
661     docker_sls_mock = MagicMock(
662         return_value={
663             "file_|-/etc/test.sh_|-/etc/test.sh_|-managed": {
664                 "comment": "File /etc/test.sh is in the correct state",
665                 "name": "/etc/test.sh",
666                 "start_time": "07:04:26.834792",
667                 "result": True,
668                 "duration": 13.492,
669                 "__run_num__": 0,
670                 "changes": {},
671             },
672             "test_|-always-passes_|-foo_|-succeed_without_changes": {
673                 "comment": "Success!",
674                 "name": "foo",
675                 "start_time": "07:04:26.848915",
676                 "result": True,
677                 "duration": 0.363,
678                 "__run_num__": 1,
679                 "changes": {},
680             },
681         }
682     )
683     ret = None
684     with patch.object(docker_mod, "start_", docker_start_mock), patch.object(
685         docker_mod, "create", docker_create_mock
686     ), patch.object(docker_mod, "stop", docker_stop_mock), patch.object(
687         docker_mod, "commit", docker_commit_mock
688     ), patch.object(
689         docker_mod, "sls", docker_sls_mock
690     ), patch.object(
691         docker_mod, "rm_", docker_rm_mock
692     ):
693         ret = docker_mod.sls_build("foo", mods="foo")
694     docker_create_mock.assert_called_once_with(
695         cmd="sleep infinity", image="opensuse/python", interactive=True, tty=True
696     )
697     docker_start_mock.assert_called_once_with("ID")
698     docker_sls_mock.assert_called_once_with("ID", "foo")
699     docker_stop_mock.assert_called_once_with("ID")
700     docker_rm_mock.assert_called_once_with("ID")
701     docker_commit_mock.assert_called_once_with("ID", "foo", tag="latest")
702     assert {"Id": "ID2", "Image": "foo", "Time_Elapsed": 42} == ret
703 def test_sls_build_dryrun():
704     """
705     test build sls image in dryrun mode.
706     """
707     docker_start_mock = MagicMock(return_value={})
708     docker_create_mock = MagicMock(return_value={"Id": "ID", "Name": "NAME"})
709     docker_stop_mock = MagicMock(
710         return_value={"state": {"old": "running", "new": "stopped"}, "result": True}
711     )
712     docker_rm_mock = MagicMock(return_value={})
713     docker_sls_mock = MagicMock(
714         return_value={
715             "file_|-/etc/test.sh_|-/etc/test.sh_|-managed": {
716                 "comment": "File /etc/test.sh is in the correct state",
717                 "name": "/etc/test.sh",
718                 "start_time": "07:04:26.834792",
719                 "result": True,
720                 "duration": 13.492,
721                 "__run_num__": 0,
722                 "changes": {},
723             },
724             "test_|-always-passes_|-foo_|-succeed_without_changes": {
725                 "comment": "Success!",
726                 "name": "foo",
727                 "start_time": "07:04:26.848915",
728                 "result": True,
729                 "duration": 0.363,
730                 "__run_num__": 1,
731                 "changes": {},
732             },
733         }
734     )
735     ret = None
736     with patch.object(docker_mod, "start_", docker_start_mock), patch.object(
737         docker_mod, "create", docker_create_mock
738     ), patch.object(docker_mod, "stop", docker_stop_mock), patch.object(
739         docker_mod, "rm_", docker_rm_mock
740     ), patch.object(
741         docker_mod, "sls", docker_sls_mock
742     ):
743         ret = docker_mod.sls_build("foo", mods="foo", dryrun=True)
744     docker_create_mock.assert_called_once_with(
745         cmd="sleep infinity", image="opensuse/python", interactive=True, tty=True
746     )
747     docker_start_mock.assert_called_once_with("ID")
748     docker_sls_mock.assert_called_once_with("ID", "foo")
749     docker_stop_mock.assert_called_once_with("ID")
750     docker_rm_mock.assert_called_once_with("ID")
751     assert {
752         "file_|-/etc/test.sh_|-/etc/test.sh_|-managed": {
753             "comment": "File /etc/test.sh is in the correct state",
754             "name": "/etc/test.sh",
755             "start_time": "07:04:26.834792",
756             "result": True,
757             "duration": 13.492,
758             "__run_num__": 0,
759             "changes": {},
760         },
761         "test_|-always-passes_|-foo_|-succeed_without_changes": {
762             "comment": "Success!",
763             "name": "foo",
764             "start_time": "07:04:26.848915",
765             "result": True,
766             "duration": 0.363,
767             "__run_num__": 1,
768             "changes": {},
769         },
770     } == ret
771 @pytest.mark.slow_test
772 def test_call_success():
773     """
774     test module calling inside containers
775     """
776     ret = None
777     docker_run_all_mock = MagicMock(
778         return_value={
779             "retcode": 0,
780             "stdout": '{"retcode": 0, "comment": "container cmd"}',
781             "stderr": "err",
782         }
783     )
784     docker_copy_to_mock = MagicMock(return_value={"retcode": 0})
785     docker_config_mock = MagicMock(return_value="")
786     client = Mock()
787     client.put_archive = Mock()
788     get_client_mock = MagicMock(return_value=client)
789     context = {"docker.exec_driver": "docker-exec"}
790     salt_dunder = {"config.option": docker_config_mock}
791     with patch.object(docker_mod, "run_all", docker_run_all_mock), patch.object(
792         docker_mod, "copy_to", docker_copy_to_mock
793     ), patch.object(docker_mod, "_get_client", get_client_mock), patch.dict(
794         docker_mod.__opts__, {"cachedir": "/tmp"}
795     ), patch.dict(
796         docker_mod.__salt__, salt_dunder
797     ), patch.dict(
798         docker_mod.__context__, context
799     ):
800         for i in range(2):
801             ret = docker_mod.call("ID", "test.arg", 1, 2, arg1="val1")
802     assert "mkdir" in docker_run_all_mock.mock_calls[0][1][1]
803     assert "mkdir" in docker_run_all_mock.mock_calls[5][1][1]
804     assert (
805         docker_run_all_mock.mock_calls[0][1][1]
806         != docker_run_all_mock.mock_calls[5][1][1]
807     )
808     assert "python3 --version" == docker_run_all_mock.mock_calls[1][1][1]
809     assert "salt-call" in docker_run_all_mock.mock_calls[3][1][1]
810     assert "salt-call" in docker_run_all_mock.mock_calls[8][1][1]
811     assert (
812         docker_run_all_mock.mock_calls[3][1][1]
813         != docker_run_all_mock.mock_calls[8][1][1]
814     )
815     assert "tarfile" in docker_run_all_mock.mock_calls[2][1][1]
816     assert "tarfile" in docker_run_all_mock.mock_calls[7][1][1]
817     assert (
818         docker_run_all_mock.mock_calls[2][1][1]
819         != docker_run_all_mock.mock_calls[7][1][1]
820     )
821     assert "rm -rf" in docker_run_all_mock.mock_calls[4][1][1]
822     assert "rm -rf" in docker_run_all_mock.mock_calls[9][1][1]
823     assert (
824         docker_run_all_mock.mock_calls[4][1][1]
825         != docker_run_all_mock.mock_calls[9][1][1]
826     )
827     assert {"retcode": 0, "comment": "container cmd"} == ret
828 def test_images_with_empty_tags():
829     """
830     docker 1.12 reports also images without tags with `null`.
831     """
832     client = Mock()
833     client.api_version = "1.24"
834     client.images = Mock(
835         return_value=[
836             {"Id": "sha256:abcde", "RepoTags": None},
837             {"Id": "sha256:abcdef"},
838             {"Id": "sha256:abcdefg", "RepoTags": ["image:latest"]},
839         ]
840     )
841     get_client_mock = MagicMock(return_value=client)
842     with patch.object(docker_mod, "_get_client", get_client_mock):
843         docker_mod._clear_context()
844         result = docker_mod.images()
845     assert result == {"sha256:abcdefg": {"RepoTags": ["image:latest"]}}
846 def test_compare_container_image_id_resolution():
847     """
848     Test comparing two containers when one's inspect output is an ID and
849     not formatted in image:tag notation.
850     """
851     def _inspect_container_effect(id_):
852         return {
853             "container1": {
854                 "Config": {"Image": "realimage:latest"},
855                 "HostConfig": {},
856             },
857             "container2": {"Config": {"Image": "image_id"}, "HostConfig": {}},
858         }[id_]
859     def _inspect_image_effect(id_):
860         return {
861             "realimage:latest": {"Id": "image_id"},
862             "image_id": {"Id": "image_id"},
863         }[id_]
864     inspect_container_mock = MagicMock(side_effect=_inspect_container_effect)
865     inspect_image_mock = MagicMock(side_effect=_inspect_image_effect)
866     with patch.object(docker_mod, "inspect_container", inspect_container_mock):
867         with patch.object(docker_mod, "inspect_image", inspect_image_mock):
868             ret = docker_mod.compare_containers("container1", "container2")
869             assert ret == {}
870 def test_compare_container_ulimits_order():
871     """
872     Test comparing two containers when the order of the Ulimits HostConfig
873     values are different, but the values are the same.
874     """
875     def _inspect_container_effect(id_):
876         return {
877             "container1": {
878                 "Config": {},
879                 "HostConfig": {
880                     "Ulimits": [
881                         {"Hard": -1, "Soft": -1, "Name": "core"},
882                         {"Hard": 65536, "Soft": 65536, "Name": "nofile"},
883                     ]
884                 },
885             },
886             "container2": {
887                 "Config": {},
888                 "HostConfig": {
889                     "Ulimits": [
890                         {"Hard": 65536, "Soft": 65536, "Name": "nofile"},
891                         {"Hard": -1, "Soft": -1, "Name": "core"},
892                     ]
893                 },
894             },
895         }[id_]
896     inspect_container_mock = MagicMock(side_effect=_inspect_container_effect)
897     with patch.object(docker_mod, "inspect_container", inspect_container_mock):
898         ret = docker_mod.compare_container("container1", "container2")
899         assert ret == {}
900 def test_compare_container_env_order():
901     """
902     Test comparing two containers when the order of the Env HostConfig
903     values are different, but the values are the same.
904     """
905     def _inspect_container_effect(id_):
906         return {
907             "container1": {
908                 "Config": {},
909                 "HostConfig": {"Env": ["FOO=bar", "HELLO=world"]},
910             },
911             "container2": {
912                 "Config": {},
913                 "HostConfig": {"Env": ["HELLO=world", "FOO=bar"]},
914             },
915         }[id_]
916     inspect_container_mock = MagicMock(side_effect=_inspect_container_effect)
917     with patch.object(docker_mod, "inspect_container", inspect_container_mock):
918         ret = docker_mod.compare_container("container1", "container2")
919         assert ret == {}
920 def test_resolve_tag():
921     """
922     Test the resolve_tag function. It runs docker.insect_image on the image
923     name passed and then looks for the RepoTags key in the result
924     """
925     id_ = "sha256:6ad733544a6317992a6fac4eb19fe1df577d4dec7529efec28a5bd0edad0fd30"
926     tags = ["foo:latest", "foo:bar"]
927     mock_tagged = MagicMock(return_value={"Id": id_, "RepoTags": tags})
928     mock_untagged = MagicMock(return_value={"Id": id_, "RepoTags": []})
929     mock_unexpected = MagicMock(return_value={"Id": id_})
930     mock_not_found = MagicMock(side_effect=CommandExecutionError())
931     with patch.object(docker_mod, "inspect_image", mock_tagged):
932         assert docker_mod.resolve_tag("foo") == tags[0]
933         assert docker_mod.resolve_tag("foo", all=True) == tags
934     with patch.object(docker_mod, "inspect_image", mock_untagged):
935         assert docker_mod.resolve_tag("foo") == id_
936         assert docker_mod.resolve_tag("foo", all=True) == [id_]
937     with patch.object(docker_mod, "inspect_image", mock_unexpected):
938         assert docker_mod.resolve_tag("foo") == id_
939         assert docker_mod.resolve_tag("foo", all=True) == [id_]
940     with patch.object(docker_mod, "inspect_image", mock_not_found):
941         assert docker_mod.resolve_tag("foo") is False
942         assert docker_mod.resolve_tag("foo", all=True) is False
943 def test_prune():
944     """
945     Test the prune function
946     """
947     def _run(**kwargs):
948         side_effect = kwargs.pop("side_effect", None)
949         client = Mock()
950         if side_effect is not None:
951             client.side_effect = side_effect
952         with patch.object(docker_mod, "_client_wrapper", client):
953             docker_mod.prune(**kwargs)
954         return client
955     client = _run(containers=True)
956     client.assert_called_once_with("prune_containers", filters={})
957     client = _run(containers=True, until="24h", label="foo,bar=baz")
958     client.assert_called_once_with(
959         "prune_containers", filters={"until": ["24h"], "label": ["foo", "bar=baz"]}
960     )
961     client = _run(images=True)
962     client.assert_called_once_with("prune_images", filters={})
963     client = _run(images=True, dangling=True, until="24h", label="foo,bar=baz")
964     client.assert_called_once_with(
965         "prune_images",
966         filters={"dangling": True, "until": ["24h"], "label": ["foo", "bar=baz"]},
967     )
968     client = _run(networks=True)
969     client.assert_called_once_with("prune_networks", filters={})
970     client = _run(networks=True, until="24h", label="foo,bar=baz")
971     client.assert_called_once_with(
972         "prune_networks", filters={"until": ["24h"], "label": ["foo", "bar=baz"]}
973     )
974     client = _run(system=False, volumes=True)
975     client.assert_called_once_with("prune_volumes", filters={})
976     client = _run(system=False, volumes=True, label="foo,bar=baz")
977     client.assert_called_once_with(
978         "prune_volumes", filters={"label": ["foo", "bar=baz"]}
979     )
980     client = _run(containers=True, images=True)
981     assert client.call_args_list == [
982         call("prune_containers", filters={}),
983         call("prune_images", filters={}),
984     ]
985     client = _run(containers=True, images=True, until="24h", label="foo,bar=baz")
986     assert client.call_args_list == [
987         call(
988             "prune_containers",
989             filters={"until": ["24h"], "label": ["foo", "bar=baz"]},
990         ),
991         call(
992             "prune_images",
993             filters={"until": ["24h"], "label": ["foo", "bar=baz"]},
994         ),
995     ]
996     client = _run(system=True)
997     assert client.call_args_list == [
998         call("prune_containers", filters={}),
999         call("prune_images", filters={}),
1000         call("prune_networks", filters={}),
1001         call("prune_build", filters={}),
1002     ]
1003     client = _run(
1004         system=True,
1005         side_effect=[None, None, None, SaltInvocationError(), None, None, None],
1006     )
1007     assert client.call_args_list == [
1008         call("prune_containers", filters={}),
1009         call("prune_images", filters={}),
1010         call("prune_networks", filters={}),
1011         call("prune_build", filters={}),
1012         call("_url", "/build/prune"),
1013         call("_post", None),
1014         call("_result", None, True),
1015     ]
1016     client = _run(system=True, label="foo,bar=baz")
1017     assert client.call_args_list == [
1018         call("prune_containers", filters={"label": ["foo", "bar=baz"]}),
1019         call("prune_images", filters={"label": ["foo", "bar=baz"]}),
1020         call("prune_networks", filters={"label": ["foo", "bar=baz"]}),
1021         call("prune_build", filters={"label": ["foo", "bar=baz"]}),
1022     ]
1023     client = _run(
1024         system=True,
1025         label="foo,bar=baz",
1026         side_effect=[None, None, None, SaltInvocationError(), None, None, None],
1027     )
1028     assert client.call_args_list == [
1029         call("prune_containers", filters={"label": ["foo", "bar=baz"]}),
1030         call("prune_images", filters={"label": ["foo", "bar=baz"]}),
1031         call("prune_networks", filters={"label": ["foo", "bar=baz"]}),
1032         call("prune_build", filters={"label": ["foo", "bar=baz"]}),
1033         call("_url", "/build/prune"),
1034         call("_post", None),
1035         call("_result", None, True),
1036     ]
1037     client = _run(system=True, volumes=True)
1038     assert client.call_args_list == [
1039         call("prune_containers", filters={}),
1040         call("prune_images", filters={}),
1041         call("prune_networks", filters={}),
1042         call("prune_build", filters={}),
1043         call("prune_volumes", filters={}),
1044     ]
1045     client = _run(
1046         system=True,
1047         volumes=True,
1048         side_effect=[
1049             None,
1050             None,
1051             None,
1052             SaltInvocationError(),
1053             None,
1054             None,
1055             None,
1056             None,
1057         ],
1058     )
1059     assert client.call_args_list == [
1060         call("prune_containers", filters={}),
1061         call("prune_images", filters={}),
1062         call("prune_networks", filters={}),
1063         call("prune_build", filters={}),
1064         call("_url", "/build/prune"),
1065         call("_post", None),
1066         call("_result", None, True),
1067         call("prune_volumes", filters={}),
1068     ]
1069     client = _run(system=True, volumes=True, label="foo,bar=baz")
1070     assert client.call_args_list == [
1071         call("prune_containers", filters={"label": ["foo", "bar=baz"]}),
1072         call("prune_images", filters={"label": ["foo", "bar=baz"]}),
1073         call("prune_networks", filters={"label": ["foo", "bar=baz"]}),
1074         call("prune_build", filters={"label": ["foo", "bar=baz"]}),
1075         call("prune_volumes", filters={"label": ["foo", "bar=baz"]}),
1076     ]
1077     client = _run(
1078         system=True,
1079         volumes=True,
1080         label="foo,bar=baz",
1081         side_effect=[
1082             None,
1083             None,
1084             None,
1085             SaltInvocationError(),
1086             None,
1087             None,
1088             None,
1089             None,
1090         ],
1091     )
1092     assert client.call_args_list == [
1093         call("prune_containers", filters={"label": ["foo", "bar=baz"]}),
1094         call("prune_images", filters={"label": ["foo", "bar=baz"]}),
1095         call("prune_networks", filters={"label": ["foo", "bar=baz"]}),
1096         call("prune_build", filters={"label": ["foo", "bar=baz"]}),
1097         call("_url", "/build/prune"),
1098         call("_post", None),
1099         call("_result", None, True),
1100         call("prune_volumes", filters={"label": ["foo", "bar=baz"]}),
1101     ]
1102 def test_port():
1103     """
1104     Test docker.port function. Note that this test case does not test what
1105     happens when a specific container name is passed and that container
1106     does not exist. When that happens, the Docker API will just raise a 404
1107     error. Since we're using as side_effect to mock
1108     docker.inspect_container, it would be meaningless to code raising an
1109     exception into it and then test that we raised that exception.
1110     """
1111     ports = {
1112         "foo": {
1113             "5555/tcp": [{"HostIp": "0.0.0.0", "HostPort": "32768"}],
1114             "6666/tcp": [{"HostIp": "0.0.0.0", "HostPort": "32769"}],
1115         },
1116         "bar": {
1117             "4444/udp": [{"HostIp": "0.0.0.0", "HostPort": "32767"}],
1118             "5555/tcp": [{"HostIp": "0.0.0.0", "HostPort": "32768"}],
1119             "6666/tcp": [{"HostIp": "0.0.0.0", "HostPort": "32769"}],
1120         },
1121         "baz": {
1122             "5555/tcp": [{"HostIp": "0.0.0.0", "HostPort": "32768"}],
1123             "6666/udp": [{"HostIp": "0.0.0.0", "HostPort": "32769"}],
1124         },
1125     }
1126     list_mock = MagicMock(return_value=["bar", "baz", "foo"])
1127     inspect_mock = MagicMock(
1128         side_effect=lambda x: {"NetworkSettings": {"Ports": ports.get(x)}}
1129     )
1130     with patch.object(docker_mod, "list_containers", list_mock), patch.object(
1131         docker_mod, "inspect_container", inspect_mock
1132     ):
1133         ret = docker_mod.port("foo")
1134         assert ret == ports["foo"]
1135         ret = docker_mod.port("foo", private_port="5555/tcp")
1136         assert ret == {"5555/tcp": ports["foo"]["5555/tcp"]}
1137         ret = docker_mod.port("ba*")
1138         assert ret == {"bar": ports["bar"], "baz": ports["baz"]}
1139         ret = docker_mod.port("ba?")
1140         assert ret == {"bar": ports["bar"], "baz": ports["baz"]}
1141         ret = docker_mod.port("ba[rz]")
1142         assert ret == {"bar": ports["bar"], "baz": ports["baz"]}
1143         ret = docker_mod.port("ba*", private_port="6666/tcp")
1144         assert ret == {"bar": {"6666/tcp": ports["bar"]["6666/tcp"]}, "baz": {}}
1145         ret = docker_mod.port("ba?", private_port="6666/tcp")
1146         assert ret == {"bar": {"6666/tcp": ports["bar"]["6666/tcp"]}, "baz": {}}
1147         ret = docker_mod.port("ba[rz]", private_port="6666/tcp")
1148         assert ret == {"bar": {"6666/tcp": ports["bar"]["6666/tcp"]}, "baz": {}}
1149         ret = docker_mod.port("*")
1150         assert ret == ports
1151         ret = docker_mod.port("*", private_port="5555/tcp")
1152         assert ret == {
1153             "foo": {"5555/tcp": ports["foo"]["5555/tcp"]},
1154             "bar": {"5555/tcp": ports["bar"]["5555/tcp"]},
1155             "baz": {"5555/tcp": ports["baz"]["5555/tcp"]},
1156         }
1157         ret = docker_mod.port("*", private_port=6666)
1158         assert ret == {
1159             "foo": {"6666/tcp": ports["foo"]["6666/tcp"]},
1160             "bar": {"6666/tcp": ports["bar"]["6666/tcp"]},
1161             "baz": {"6666/udp": ports["baz"]["6666/udp"]},
1162         }
1163         ret = docker_mod.port("*", private_port="6666/tcp")
1164         assert ret == {
1165             "foo": {"6666/tcp": ports["foo"]["6666/tcp"]},
1166             "bar": {"6666/tcp": ports["bar"]["6666/tcp"]},
1167             "baz": {},
1168         }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
