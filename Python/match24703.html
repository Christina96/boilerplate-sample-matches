<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_pkgutil.py &amp; test_module_3.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_pkgutil.py &amp; test_module_3.py
      </h3>
<h1 align="center">
        9.0%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_pkgutil.py (25.0%)<th>test_module_3.py (5.5135136%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(243-255)<td><a href="#" name="0">(372-377)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(206-209)<td><a href="#" name="1">(529-534)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(174-186)<td><a href="#" name="2">(507-512)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(99-111)<td><a href="#" name="3">(460-465)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(73-86)<td><a href="#" name="4">(438-443)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(56-61)<td><a href="#" name="5">(394-399)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(214-225)<td><a href="#" name="6">(145-148)</a><td align="center"><font color="#eb0000">12</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(25-27)<td><a href="#" name="7">(556-560)</a><td align="center"><font color="#eb0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_pkgutil.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import pytest
2 import salt.modules.pkgutil as pkgutil
3 import salt.utils.pkg
4 from salt.exceptions import CommandExecutionError, MinionError
5 from tests.support.mock import MagicMock, Mock, patch
6 @pytest.fixture
7 def configure_loader_modules():
8     return {pkgutil: {}}
9 def test_refresh_db():
10 <a name="7"></a>    """
11     Test if it updates the pkgutil repo database (pkgutil -U).
12     mock <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= MagicMock(return_value=0)
13     with patch.dict(pkgutil.__salt__, {"cmd.retcode": mock}):
14         with patch.object(salt.</b></font>utils.pkg, "clear_rtag", Mock()):
15             assert pkgutil.refresh_db()
16 def test_upgrade_available():
17     mock = MagicMock(return_value="A\n B\n SAME")
18     with patch.dict(pkgutil.__salt__, {"cmd.run_stdout": mock}):
19         assert pkgutil.upgrade_available("CSWpython") == ""
20     mock = MagicMock(side_effect=["A\n B\n SALT", None])
21     with patch.dict(pkgutil.__salt__, {"cmd.run_stdout": mock}):
22         assert pkgutil.upgrade_available("CSWpython") == "SALT"
23         assert pkgutil.upgrade_available("CSWpython") == ""
24 def test_list_upgrades():
25 <a name="5"></a>    """
26     Test if it list all available package upgrades on this system.
27     mock_run = MagicMock(return_value<font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>="A\t B\t SAME")
28     mock_ret = MagicMock(return_value=0)
29     with patch.dict(
30         pkgutil.__salt__, {"cmd.run_stdout": mock_run, "cmd.retcode": mock_ret}
31     ):
32         with patch.object(salt.</b></font>utils.pkg, "clear_rtag", Mock()):
33             assert pkgutil.list_upgrades() == {"A": " B"}
34 def test_upgrade():
35     mock_run = MagicMock(return_value="A\t B\t SAME")
36     mock_ret = MagicMock(return_value<font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=0)
37     mock_pkg = MagicMock(return_value="")
38     with patch.dict(
39         pkgutil.__salt__,
40         {
41             "cmd.run_stdout": mock_run,
42             "cmd.retcode": mock_ret,
43             "pkg_resource.stringify": mock_pkg,
44             "pkg_resource.sort_pkglist": mock_pkg,
45             "cmd.run_all": mock_ret,
46             "cmd.run": mock_run,
47         },
48     ):
49         with patch.dict(pkgutil.</b></font>__context__, {"pkg.list_pkgs": mock_ret}):
50             with patch.object(salt.utils.pkg, "clear_rtag", Mock()):
51                 assert pkgutil.upgrade() == {}
52 def test_list_pkgs():
53     mock_run = MagicMock(return_value="A\t B\t SAME")
54     mock_ret = MagicMock(return_value<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=True)
55     mock_pkg = MagicMock(return_value="")
56     with patch.dict(
57         pkgutil.__salt__,
58         {
59             "cmd.run_stdout": mock_run,
60             "cmd.retcode": mock_ret,
61             "pkg_resource.stringify": mock_pkg,
62             "pkg_resource.sort_pkglist": mock_pkg,
63             "cmd.run": mock_run,
64         },
65     ):
66         with patch.dict(pkgutil.</b></font>__context__, {"pkg.list_pkgs": mock_ret}):
67             assert pkgutil.list_pkgs(versions_as_list=True, removed=True) == {}
68         assert pkgutil.list_pkgs() == {}
69     with patch.dict(pkgutil.__context__, {"pkg.list_pkgs": True}):
70         assert pkgutil.list_pkgs(versions_as_list=True)
71         mock_pkg = MagicMock(return_value=True)
72         with patch.dict(pkgutil.__salt__, {"pkg_resource.stringify": mock_pkg}):
73             assert pkgutil.list_pkgs()
74 def test_list_pkgs_no_context():
75     mock_run = MagicMock(return_value="A\t B\t SAME")
76     mock_ret = MagicMock(return_value=True)
77     mock_pkg = MagicMock(return_value="")
78     with patch.dict(
79         pkgutil.__salt__,
80         {
81             "cmd.run_stdout": mock_run,
82             "cmd.retcode": mock_ret,
83             "pkg_resource.stringify": mock_pkg,
84             "pkg_resource.sort_pkglist": mock_pkg,
85             "cmd.run": mock_run,
86         },
87     ), patch.object(pkgutil, "_list_pkgs_from_context") as list_pkgs_context_mock:
88         pkgs = pkgutil.list_pkgs(versions_as_list=True, removed=True, use_context=False)
89         list_pkgs_context_mock.assert_not_called()
90         list_pkgs_context_mock.reset_mock()
91         pkgs = pkgutil.list_pkgs(versions_as_list=True, removed=True, use_context=False)
92         list_pkgs_context_mock.assert_not_called()
93         list_pkgs_context_mock.reset_mock()
94 def test_version():
95     mock_ret = MagicMock(return_value=True)
96     with patch.dict(pkgutil.__salt__, {"pkg_resource.version": mock_ret}):
97         assert pkgutil.version("CSWpython")
98 def test_latest_version():
99     assert pkgutil.latest_version() == ""
100 <a name="2"></a>
101     mock_run_all = MagicMock(return_value="A\t B\t SAME")
102     mock_run = MagicMock(return_value={"stdout": ""})
103     mock_ret = MagicMock(return_value<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=True)
104     mock_pkg = MagicMock(return_value="")
105     with patch.dict(
106         pkgutil.__salt__,
107         {
108             "cmd.retcode": mock_ret,
109             "pkg_resource.stringify": mock_pkg,
110             "pkg_resource.sort_pkglist": mock_pkg,
111             "cmd.run_all": mock_run,
112             "cmd.run": mock_run_all,
113         },
114     ):
115         with patch.object(salt.</b></font>utils.pkg, "clear_rtag", Mock()):
116             assert pkgutil.latest_version("CSWpython") == ""
117             assert pkgutil.latest_version("CSWpython", "Python") == {
118                 "Python": "",
119                 "CSWpython": "",
120             }
121 def test_install():
122     mock_pkg = MagicMock(side_effect=MinionError)
123 <a name="1"></a>    with patch.dict(pkgutil.__salt__, {"pkg_resource.parse_targets": mock_pkg}):
124         pytest.raises(CommandExecutionError, pkgutil.install)
125     mock_ret = MagicMock(return_value<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>=True)
126     mock_pkg = MagicMock(return_value=[""])
127     with patch.dict(pkgutil.__salt__, {"pkg_resource.parse_targets": mock_pkg}):
128         with patch.dict(pkgutil.</b></font>__context__, {"pkg.list_pkgs": mock_ret}):
129             assert pkgutil.install() == {}
130 <a name="6"></a>
131     mock_run = MagicMock(return_value="A\t B\t SAME")
132     mock_run_all = MagicMock(return_value={"stdout": ""})
133     mock_pkg <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= MagicMock(return_value=[{"bar": "1.2.3"}])
134     with patch.dict(
135         pkgutil.__salt__,
136         {
137             "pkg_resource.parse_targets": mock_pkg,
138             "pkg_resource.stringify": mock_pkg,
139             "pkg_resource.sort_pkglist": mock_pkg,
140             "cmd.run_all": mock_run_all,
141             "cmd.run": mock_run,
142         },
143     ):
144         with patch.dict(</b></font>pkgutil.__context__, {"pkg.list_pkgs": mock_ret}):
145             assert pkgutil.install(pkgs='["foo", {"bar": "1.2.3"}]') == {}
146 def test_remove():
147     mock_pkg = MagicMock(side_effect=MinionError)
148     with patch.dict(pkgutil.__salt__, {"pkg_resource.parse_targets": mock_pkg}):
149         pytest.raises(CommandExecutionError, pkgutil.remove)
150 <a name="0"></a>
151     mock_ret = MagicMock(return_value=True)
152     mock_run = MagicMock(return_value="A\t B\t SAME")
153     mock_run_all = MagicMock(return_value={<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>"stdout": ""})
154     mock_pkg = MagicMock(return_value=[""])
155     with patch.dict(
156         pkgutil.__salt__,
157         {
158             "pkg_resource.parse_targets": mock_pkg,
159             "pkg_resource.stringify": mock_pkg,
160             "pkg_resource.sort_pkglist": mock_pkg,
161             "cmd.run_all": mock_run_all,
162             "cmd.run": mock_run,
163         },
164     ):
165         with patch.dict(pkgutil.</b></font>__context__, {"pkg.list_pkgs": mock_ret}):
166             assert pkgutil.remove() == {}
167     mock_pkg = MagicMock(return_value=[{"bar": "1.2.3"}])
168     with patch.dict(
169         pkgutil.__salt__,
170         {
171             "pkg_resource.parse_targets": mock_pkg,
172             "pkg_resource.stringify": mock_pkg,
173             "pkg_resource.sort_pkglist": mock_pkg,
174             "cmd.run_all": mock_run_all,
175             "cmd.run": mock_run,
176         },
177     ):
178         with patch.dict(pkgutil.__context__, {"pkg.list_pkgs": mock_ret}):
179             with patch.object(pkgutil, "list_pkgs", return_value={"bar": "1.2.3"}):
180                 assert pkgutil.remove(pkgs='["foo", "bar"]') == {}
181 def test_purge():
182     mock_pkg = MagicMock(side_effect=MinionError)
183     with patch.dict(pkgutil.__salt__, {"pkg_resource.parse_targets": mock_pkg}):
184         pytest.raises(CommandExecutionError, pkgutil.purge)
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_module_3.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import pytest
3 import salt.config
4 import salt.loader
5 import salt.modules.dockermod as docker_mod
6 import salt.utils.platform
7 from salt.exceptions import CommandExecutionError, SaltInvocationError
8 from tests.support.mock import MagicMock, Mock, call, patch
9 log = logging.getLogger(__name__)
10 pytest.importorskip(
11     "docker", reason="The python 'docker' package must be installed to run these tests"
12 )
13 @pytest.fixture
14 def configure_loader_modules():
15     utils = salt.loader.utils(
16         salt.config.DEFAULT_MINION_OPTS.copy(),
17         whitelist=[
18             "args",
19             "docker",
20             "json",
21             "state",
22             "thin",
23             "systemd",
24             "path",
25             "platform",
26         ],
27     )
28     return {
29         docker_mod: {
30             "__context__": {"docker.docker_version": ""},
31             "__utils__": utils,
32         }
33     }
34 def test_failed_login():
35     client = Mock()
36     get_client_mock = MagicMock(return_value=client)
37     ref_out = {"stdout": "", "stderr": "login failed", "retcode": 1}
38     with patch.dict(
39         docker_mod.__pillar__,
40         {
41             "docker-registries": {
42                 "portus.example.com:5000": {
43                     "username": "admin",
44                     "password": "linux12345",
45                     "email": "tux@example.com",
46                 }
47             }
48         },
49     ):
50         with patch.object(docker_mod, "_get_client", get_client_mock):
51             dunder_salt = {
52                 "cmd.run_all": MagicMock(return_value=ref_out),
53                 "config.get": MagicMock(return_value={}),
54                 "config.option": MagicMock(return_value={}),
55             }
56             with patch.dict(docker_mod.__salt__, dunder_salt):
57                 ret = docker_mod.login("portus.example.com:5000")
58                 assert "retcode" in ret
59                 assert ret["retcode"] != 0
60 def test_logout_calls_docker_cli_logout_single():
61     client = Mock()
62     get_client_mock = MagicMock(return_value=client)
63     ref_out = {"stdout": "", "stderr": "", "retcode": 0}
64     registry_auth_data = {
65         "portus.example.com:5000": {
66             "username": "admin",
67             "password": "linux12345",
68             "email": "tux@example.com",
69         }
70     }
71     docker_mock = MagicMock(return_value=ref_out)
72     with patch.object(docker_mod, "_get_client", get_client_mock):
73         dunder_salt = {
74             "config.get": MagicMock(return_value=registry_auth_data),
75             "cmd.run_all": docker_mock,
76             "config.option": MagicMock(return_value={}),
77         }
78         with patch.dict(docker_mod.__salt__, dunder_salt):
79             ret = docker_mod.logout("portus.example.com:5000")
80             assert "retcode" in ret
81             assert ret["retcode"] == 0
82             docker_mock.assert_called_with(
83                 ["docker", "logout", "portus.example.com:5000"],
84                 python_shell=False,
85                 output_loglevel="quiet",
86             )
87 def test_logout_calls_docker_cli_logout_all():
88     client = Mock()
89     get_client_mock = MagicMock(return_value=client)
90     ref_out = {"stdout": "", "stderr": "", "retcode": 0}
91     registry_auth_data = {
92         "portus.example.com:5000": {
93             "username": "admin",
94             "password": "linux12345",
95             "email": "tux@example.com",
96         },
97         "portus2.example.com:5000": {
98             "username": "admin",
99             "password": "linux12345",
100             "email": "tux@example.com",
101         },
102     }
103     docker_mock = MagicMock(return_value=ref_out)
104     with patch.object(docker_mod, "_get_client", get_client_mock):
105         dunder_salt = {
106             "config.get": MagicMock(return_value=registry_auth_data),
107             "cmd.run_all": docker_mock,
108             "config.option": MagicMock(return_value={}),
109         }
110         with patch.dict(docker_mod.__salt__, dunder_salt):
111             ret = docker_mod.logout()
112             assert "retcode" in ret
113             assert ret["retcode"] == 0
114             assert docker_mock.call_count == 2
115 def test_ps_with_host_true():
116 <a name="6"></a>    client = Mock()
117     client.containers = MagicMock(return_value=[])
118     get_client_mock = MagicMock(return_value=client)
119     network_interfaces <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= Mock(return_value={"mocked": None})
120     with patch.dict(docker_mod.__salt__, {"network.interfaces": network_interfaces}):
121         with patch.object(</b></font>docker_mod, "_get_client", get_client_mock):
122             ret = docker_mod.ps_(host=True)
123             assert ret == {"host": {"interfaces": {"mocked": None}}}
124 def test_ps_with_filters():
125     client = Mock()
126     client.containers = MagicMock(return_value=[])
127     get_client_mock = MagicMock(return_value=client)
128     with patch.object(docker_mod, "_get_client", get_client_mock):
129         docker_mod.ps_(filters={"label": "KEY"})
130         client.containers.assert_called_once_with(all=True, filters={"label": "KEY"})
131 @pytest.mark.slow_test
132 @pytest.mark.parametrize(
133     "command_name, args",
134     (
135         ("create", ()),
136         ("rm_", ()),
137         ("kill", ()),
138         ("pause", ()),
139         ("signal_", ("KILL",)),
140         ("start_", ()),
141         ("stop", ()),
142         ("unpause", ()),
143         ("_run", ("command",)),
144         ("_script", ("command",)),
145     ),
146 )
147 def test_check_mine_cache_is_refreshed_on_container_change_event(command_name, args):
148     if salt.utils.platform.is_windows() and command_name == "_script":
149         pytest.skip(
150             "Skipping test since `dockermod._script` will create a temporary file in /tmp "
151             "which does not exist on windows"
152         )
153     with patch.object(docker_mod, "_get_exec_driver"):
154         client_args_mock = MagicMock(
155             return_value={
156                 "create_container": [
157                     "image",
158                     "command",
159                     "hostname",
160                     "user",
161                     "detach",
162                     "stdin_open",
163                     "tty",
164                     "ports",
165                     "environment",
166                     "volumes",
167                     "network_disabled",
168                     "name",
169                     "entrypoint",
170                     "working_dir",
171                     "domainname",
172                     "cpuset",
173                     "host_config",
174                     "mac_address",
175                     "labels",
176                     "volume_driver",
177                     "stop_signal",
178                     "networking_config",
179                     "healthcheck",
180                     "stop_timeout",
181                 ],
182                 "host_config": [
183                     "binds",
184                     "port_bindings",
185                     "lxc_conf",
186                     "publish_all_ports",
187                     "links",
188                     "privileged",
189                     "dns",
190                     "dns_search",
191                     "volumes_from",
192                     "network_mode",
193                     "restart_policy",
194                     "cap_add",
195                     "cap_drop",
196                     "devices",
197                     "extra_hosts",
198                     "read_only",
199                     "pid_mode",
200                     "ipc_mode",
201                     "security_opt",
202                     "ulimits",
203                     "log_config",
204                     "mem_limit",
205                     "memswap_limit",
206                     "mem_reservation",
207                     "kernel_memory",
208                     "mem_swappiness",
209                     "cgroup_parent",
210                     "group_add",
211                     "cpu_quota",
212                     "cpu_period",
213                     "blkio_weight",
214                     "blkio_weight_device",
215                     "device_read_bps",
216                     "device_write_bps",
217                     "device_read_iops",
218                     "device_write_iops",
219                     "oom_kill_disable",
220                     "shm_size",
221                     "sysctls",
222                     "tmpfs",
223                     "oom_score_adj",
224                     "dns_opt",
225                     "cpu_shares",
226                     "cpuset_cpus",
227                     "userns_mode",
228                     "pids_limit",
229                     "isolation",
230                     "auto_remove",
231                     "storage_opt",
232                 ],
233                 "networking_config": [
234                     "aliases",
235                     "links",
236                     "ipv4_address",
237                     "ipv6_address",
238                     "link_local_ips",
239                 ],
240             }
241         )
242         mine_send = Mock()
243         command = getattr(docker_mod, command_name)
244         client = MagicMock()
245         client.api_version = "1.12"
246         with patch.dict(
247             docker_mod.__salt__,
248             {
249                 "mine.send": mine_send,
250                 "container_resource.run": MagicMock(),
251                 "config.get": MagicMock(return_value=True),
252                 "config.option": MagicMock(return_value=True),
253                 "cp.cache_file": MagicMock(return_value=False),
254             },
255         ):
256             with patch.dict(
257                 docker_mod.__utils__,
258                 {"docker.get_client_args": client_args_mock},
259             ):
260                 with patch.object(docker_mod, "_get_client", client):
261                     command("container", *args)
262         try:
263             mine_send.assert_called_with("docker.ps", verbose=True, all=True, host=True)
264         except AssertionError as exc:
265             raise Exception(
266                 "command '{}' did not call docker.ps with expected "
267                 "arguments: {}".format(command_name, exc)
268             )
269 def test_update_mine():
270     def config_get_disabled(val, default):
271         return {
272             "base_url": docker_mod.NOTSET,
273             "version": docker_mod.NOTSET,
274             "docker.url": docker_mod.NOTSET,
275             "docker.version": docker_mod.NOTSET,
276             "docker.machine": docker_mod.NOTSET,
277             "docker.update_mine": False,
278         }[val]
279     def config_get_enabled(val, default):
280         return {
281             "base_url": docker_mod.NOTSET,
282             "version": docker_mod.NOTSET,
283             "docker.url": docker_mod.NOTSET,
284             "docker.version": docker_mod.NOTSET,
285             "docker.machine": docker_mod.NOTSET,
286             "docker.update_mine": True,
287         }[val]
288     mine_mock = Mock()
289     dunder_salt = {
290         "config.get": MagicMock(side_effect=config_get_disabled),
291         "config.option": MagicMock(return_value=False),
292         "mine.send": mine_mock,
293     }
294     with patch.dict(docker_mod.__salt__, dunder_salt), patch.dict(
295         docker_mod.__context__, {"docker.client": Mock()}
296     ), patch.object(docker_mod, "state", MagicMock(return_value="stopped")):
297         docker_mod.stop("foo", timeout=1)
298         mine_mock.assert_not_called()
299     with patch.dict(docker_mod.__salt__, dunder_salt), patch.dict(
300         docker_mod.__context__, {"docker.client": Mock()}
301     ), patch.object(docker_mod, "state", MagicMock(return_value="stopped")):
302         dunder_salt["config.get"].side_effect = config_get_enabled
303         dunder_salt["config.option"].return_value = True
304         docker_mod.stop("foo", timeout=1)
305         mine_mock.assert_called_once()
306 @pytest.mark.skipif(
307     docker_mod.docker.version_info &lt; (1, 5, 0),
308     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
309 )
310 def test_list_networks():
311     __salt__ = {
312         "config.get": Mock(),
313         "mine.send": Mock(),
314     }
315 <a name="0"></a>    client = Mock()
316     client.api_version = "1.21"
317     client.networks = Mock(
318         return_value=[{<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>"Name": "foo", "Id": "01234", "Containers": {}}]
319     )
320     get_client_mock = MagicMock(return_value=client)
321     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
322         with patch.object(docker_mod, "_get_client", get_client_mock):
323             docker_mod.</b></font>networks(names=["foo"], ids=["01234"])
324     client.networks.assert_called_once_with(names=["foo"], ids=["01234"])
325 @pytest.mark.skipif(
326     docker_mod.docker.version_info &lt; (1, 5, 0),
327     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
328 )
329 def test_create_network():
330     __salt__ = {
331         "config.get": Mock(),
332 <a name="5"></a>        "mine.send": Mock(),
333     }
334     client = Mock()
335     client.api_version <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "1.21"
336     get_client_mock = MagicMock(return_value=client)
337     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
338         with patch.object(docker_mod, "_get_client", get_client_mock):
339             docker_mod.</b></font>create_network(
340                 "foo",
341                 driver="bridge",
342                 driver_opts={},
343                 gateway="192.168.0.1",
344                 ip_range="192.168.0.128/25",
345                 subnet="192.168.0.0/24",
346             )
347     client.create_network.assert_called_once_with(
348         "foo",
349         driver="bridge",
350         options={},
351         ipam={
352             "Config": [
353                 {
354                     "Gateway": "192.168.0.1",
355                     "IPRange": "192.168.0.128/25",
356                     "Subnet": "192.168.0.0/24",
357                 }
358             ],
359             "Driver": "default",
360         },
361         check_duplicate=True,
362     )
363 @pytest.mark.skipif(
364     docker_mod.docker.version_info &lt; (1, 5, 0),
365     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
366 )
367 def test_remove_network():
368     __salt__ = {
369         "config.get": Mock(),
370 <a name="4"></a>        "mine.send": Mock(),
371     }
372     client = Mock()
373     client.api_version <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "1.21"
374     get_client_mock = MagicMock(return_value=client)
375     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
376         with patch.object(docker_mod, "_get_client", get_client_mock):
377             docker_mod.</b></font>remove_network("foo")
378     client.remove_network.assert_called_once_with("foo")
379 @pytest.mark.skipif(
380     docker_mod.docker.version_info &lt; (1, 5, 0),
381     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
382 )
383 def test_inspect_network():
384     __salt__ = {
385         "config.get": Mock(),
386 <a name="3"></a>        "mine.send": Mock(),
387     }
388     client = Mock()
389     client.api_version <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "1.21"
390     get_client_mock = MagicMock(return_value=client)
391     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
392         with patch.object(docker_mod, "_get_client", get_client_mock):
393             docker_mod.</b></font>inspect_network("foo")
394     client.inspect_network.assert_called_once_with("foo")
395 @pytest.mark.skipif(
396     docker_mod.docker.version_info &lt; (1, 5, 0),
397     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
398 )
399 def test_connect_container_to_network():
400     __salt__ = {
401         "config.get": Mock(),
402         "mine.send": Mock(),
403     }
404     client = Mock()
405     client.api_version = "1.21"
406     get_client_mock = MagicMock(return_value=client)
407     context = {"docker.exec_driver": "docker-exec"}
408     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
409         with patch.dict(docker_mod.__context__, context):
410             with patch.object(docker_mod, "_get_client", get_client_mock):
411                 docker_mod.connect_container_to_network("container", "foo")
412     client.connect_container_to_network.assert_called_once_with("container", "foo")
413 @pytest.mark.skipif(
414     docker_mod.docker.version_info &lt; (1, 5, 0),
415     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
416 )
417 def test_disconnect_container_from_network():
418     __salt__ = {
419         "config.get": Mock(),
420 <a name="2"></a>        "mine.send": Mock(),
421     }
422     client = Mock()
423     client.api_version <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "1.21"
424     get_client_mock = MagicMock(return_value=client)
425     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
426         with patch.object(docker_mod, "_get_client", get_client_mock):
427             docker_mod.</b></font>disconnect_container_from_network("container", "foo")
428     client.disconnect_container_from_network.assert_called_once_with("container", "foo")
429 @pytest.mark.skipif(
430     docker_mod.docker.version_info &lt; (1, 5, 0),
431     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
432 )
433 def test_list_volumes():
434     __salt__ = {
435         "config.get": Mock(),
436 <a name="1"></a>        "mine.send": Mock(),
437     }
438     client = Mock()
439     client.api_version <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "1.21"
440     get_client_mock = MagicMock(return_value=client)
441     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
442         with patch.object(docker_mod, "_get_client", get_client_mock):
443             docker_mod.</b></font>volumes(
444                 filters={"dangling": [True]},
445             )
446     client.volumes.assert_called_once_with(
447         filters={"dangling": [True]},
448     )
449 @pytest.mark.skipif(
450     docker_mod.docker.version_info &lt; (1, 5, 0),
451     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
452 )
453 def test_create_volume():
454     __salt__ = {
455         "config.get": Mock(),
456         "mine.send": Mock(),
457 <a name="7"></a>    }
458     client = Mock()
459     client.api_version = "1.21"
460     get_client_mock <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= MagicMock(return_value=client)
461     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
462         with patch.object(docker_mod, "_get_client", get_client_mock):
463             docker_mod.</b></font>create_volume(
464                 "foo",
465                 driver="bridge",
466                 driver_opts={},
467             )
468     client.create_volume.assert_called_once_with(
469         "foo",
470         driver="bridge",
471         driver_opts={},
472     )
473 @pytest.mark.skipif(
474     docker_mod.docker.version_info &lt; (1, 5, 0),
475     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
476 )
477 def test_remove_volume():
478     __salt__ = {
479         "config.get": Mock(),
480         "mine.send": Mock(),
481     }
482     client = Mock()
483     client.api_version = "1.21"
484     get_client_mock = MagicMock(return_value=client)
485     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
486         with patch.object(docker_mod, "_get_client", get_client_mock):
487             docker_mod.remove_volume("foo")
488     client.remove_volume.assert_called_once_with("foo")
489 @pytest.mark.skipif(
490     docker_mod.docker.version_info &lt; (1, 5, 0),
491     reason="docker module must be installed to run this test or is too old. &gt;=1.5.0",
492 )
493 def test_inspect_volume():
494     __salt__ = {
495         "config.get": Mock(),
496         "mine.send": Mock(),
497     }
498     client = Mock()
499     client.api_version = "1.21"
500     get_client_mock = MagicMock(return_value=client)
501     with patch.dict(docker_mod.__dict__, {"__salt__": __salt__}):
502         with patch.object(docker_mod, "_get_client", get_client_mock):
503             docker_mod.inspect_volume("foo")
504     client.inspect_volume.assert_called_once_with("foo")
505 def test_wait_success():
506     client = Mock()
507     client.api_version = "1.21"
508     client.wait = Mock(return_value=0)
509     get_client_mock = MagicMock(return_value=client)
510     docker_inspect_container = Mock(
511         side_effect=[{"State": {"Running": True}}, {"State": {"Stopped": True}}]
512     )
513     with patch.object(docker_mod, "inspect_container", docker_inspect_container):
514         with patch.object(docker_mod, "_get_client", get_client_mock):
515             docker_mod._clear_context()
516             result = docker_mod.wait("foo")
517     assert result == {
518         "result": True,
519         "exit_status": 0,
520         "state": {"new": "stopped", "old": "running"},
521     }
522 def test_wait_fails_already_stopped():
523     client = Mock()
524     client.api_version = "1.21"
525     client.wait = Mock(return_value=0)
526     get_client_mock = MagicMock(return_value=client)
527     docker_inspect_container = Mock(
528         side_effect=[{"State": {"Stopped": True}}, {"State": {"Stopped": True}}]
529     )
530     with patch.object(docker_mod, "inspect_container", docker_inspect_container):
531         with patch.object(docker_mod, "_get_client", get_client_mock):
532             docker_mod._clear_context()
533             result = docker_mod.wait("foo")
534     assert result == {
535         "result": False,
536         "comment": "Container 'foo' already stopped",
537         "exit_status": 0,
538         "state": {"new": "stopped", "old": "stopped"},
539     }
540 def test_wait_success_already_stopped():
541     client = Mock()
542     client.api_version = "1.21"
543     client.wait = Mock(return_value=0)
544     get_client_mock = MagicMock(return_value=client)
545     docker_inspect_container = Mock(
546         side_effect=[{"State": {"Stopped": True}}, {"State": {"Stopped": True}}]
547     )
548     with patch.object(docker_mod, "inspect_container", docker_inspect_container):
549         with patch.object(docker_mod, "_get_client", get_client_mock):
550             docker_mod._clear_context()
551             result = docker_mod.wait("foo", ignore_already_stopped=True)
552     assert result == {
553         "result": True,
554         "comment": "Container 'foo' already stopped",
555         "exit_status": 0,
556         "state": {"new": "stopped", "old": "stopped"},
557     }
558 def test_wait_success_absent_container():
559     client = Mock()
560     client.api_version = "1.21"
561     get_client_mock = MagicMock(return_value=client)
562     docker_inspect_container = Mock(side_effect=CommandExecutionError)
563     with patch.object(docker_mod, "inspect_container", docker_inspect_container):
564         with patch.object(docker_mod, "_get_client", get_client_mock):
565             docker_mod._clear_context()
566             result = docker_mod.wait("foo", ignore_already_stopped=True)
567     assert result == {"result": True, "comment": "Container 'foo' absent"}
568 def test_wait_fails_on_exit_status():
569     client = Mock()
570     client.api_version = "1.21"
571     client.wait = Mock(return_value=1)
572     get_client_mock = MagicMock(return_value=client)
573     docker_inspect_container = Mock(
574         side_effect=[{"State": {"Running": True}}, {"State": {"Stopped": True}}]
575     )
576     with patch.object(docker_mod, "inspect_container", docker_inspect_container):
577         with patch.object(docker_mod, "_get_client", get_client_mock):
578             docker_mod._clear_context()
579             result = docker_mod.wait("foo", fail_on_exit_status=True)
580     assert result == {
581         "result": False,
582         "exit_status": 1,
583         "state": {"new": "stopped", "old": "running"},
584     }
585 def test_wait_fails_on_exit_status_and_already_stopped():
586     client = Mock()
587     client.api_version = "1.21"
588     client.wait = Mock(return_value=1)
589     get_client_mock = MagicMock(return_value=client)
590     docker_inspect_container = Mock(
591         side_effect=[{"State": {"Stopped": True}}, {"State": {"Stopped": True}}]
592     )
593     with patch.object(docker_mod, "inspect_container", docker_inspect_container):
594         with patch.object(docker_mod, "_get_client", get_client_mock):
595             docker_mod._clear_context()
596             result = docker_mod.wait(
597                 "foo", ignore_already_stopped=True, fail_on_exit_status=True
598             )
599     assert result == {
600         "result": False,
601         "comment": "Container 'foo' already stopped",
602         "exit_status": 1,
603         "state": {"new": "stopped", "old": "stopped"},
604     }
605 def test_sls_build():
606     docker_start_mock = MagicMock(return_value={})
607     docker_create_mock = MagicMock(return_value={"Id": "ID", "Name": "NAME"})
608     docker_stop_mock = MagicMock(
609         return_value={"state": {"old": "running", "new": "stopped"}, "result": True}
610     )
611     docker_rm_mock = MagicMock(return_value={})
612     docker_commit_mock = MagicMock(
613         return_value={"Id": "ID2", "Image": "foo", "Time_Elapsed": 42}
614     )
615     docker_sls_mock = MagicMock(
616         return_value={
617             "file_|-/etc/test.sh_|-/etc/test.sh_|-managed": {
618                 "comment": "File /etc/test.sh is in the correct state",
619                 "name": "/etc/test.sh",
620                 "start_time": "07:04:26.834792",
621                 "result": True,
622                 "duration": 13.492,
623                 "__run_num__": 0,
624                 "changes": {},
625             },
626             "test_|-always-passes_|-foo_|-succeed_without_changes": {
627                 "comment": "Success!",
628                 "name": "foo",
629                 "start_time": "07:04:26.848915",
630                 "result": True,
631                 "duration": 0.363,
632                 "__run_num__": 1,
633                 "changes": {},
634             },
635         }
636     )
637     ret = None
638     with patch.object(docker_mod, "start_", docker_start_mock), patch.object(
639         docker_mod, "create", docker_create_mock
640     ), patch.object(docker_mod, "stop", docker_stop_mock), patch.object(
641         docker_mod, "commit", docker_commit_mock
642     ), patch.object(
643         docker_mod, "sls", docker_sls_mock
644     ), patch.object(
645         docker_mod, "rm_", docker_rm_mock
646     ):
647         ret = docker_mod.sls_build("foo", mods="foo")
648     docker_create_mock.assert_called_once_with(
649         cmd="sleep infinity", image="opensuse/python", interactive=True, tty=True
650     )
651     docker_start_mock.assert_called_once_with("ID")
652     docker_sls_mock.assert_called_once_with("ID", "foo")
653     docker_stop_mock.assert_called_once_with("ID")
654     docker_rm_mock.assert_called_once_with("ID")
655     docker_commit_mock.assert_called_once_with("ID", "foo", tag="latest")
656     assert {"Id": "ID2", "Image": "foo", "Time_Elapsed": 42} == ret
657 def test_sls_build_dryrun():
658     docker_start_mock = MagicMock(return_value={})
659     docker_create_mock = MagicMock(return_value={"Id": "ID", "Name": "NAME"})
660     docker_stop_mock = MagicMock(
661         return_value={"state": {"old": "running", "new": "stopped"}, "result": True}
662     )
663     docker_rm_mock = MagicMock(return_value={})
664     docker_sls_mock = MagicMock(
665         return_value={
666             "file_|-/etc/test.sh_|-/etc/test.sh_|-managed": {
667                 "comment": "File /etc/test.sh is in the correct state",
668                 "name": "/etc/test.sh",
669                 "start_time": "07:04:26.834792",
670                 "result": True,
671                 "duration": 13.492,
672                 "__run_num__": 0,
673                 "changes": {},
674             },
675             "test_|-always-passes_|-foo_|-succeed_without_changes": {
676                 "comment": "Success!",
677                 "name": "foo",
678                 "start_time": "07:04:26.848915",
679                 "result": True,
680                 "duration": 0.363,
681                 "__run_num__": 1,
682                 "changes": {},
683             },
684         }
685     )
686     ret = None
687     with patch.object(docker_mod, "start_", docker_start_mock), patch.object(
688         docker_mod, "create", docker_create_mock
689     ), patch.object(docker_mod, "stop", docker_stop_mock), patch.object(
690         docker_mod, "rm_", docker_rm_mock
691     ), patch.object(
692         docker_mod, "sls", docker_sls_mock
693     ):
694         ret = docker_mod.sls_build("foo", mods="foo", dryrun=True)
695     docker_create_mock.assert_called_once_with(
696         cmd="sleep infinity", image="opensuse/python", interactive=True, tty=True
697     )
698     docker_start_mock.assert_called_once_with("ID")
699     docker_sls_mock.assert_called_once_with("ID", "foo")
700     docker_stop_mock.assert_called_once_with("ID")
701     docker_rm_mock.assert_called_once_with("ID")
702     assert {
703         "file_|-/etc/test.sh_|-/etc/test.sh_|-managed": {
704             "comment": "File /etc/test.sh is in the correct state",
705             "name": "/etc/test.sh",
706             "start_time": "07:04:26.834792",
707             "result": True,
708             "duration": 13.492,
709             "__run_num__": 0,
710             "changes": {},
711         },
712         "test_|-always-passes_|-foo_|-succeed_without_changes": {
713             "comment": "Success!",
714             "name": "foo",
715             "start_time": "07:04:26.848915",
716             "result": True,
717             "duration": 0.363,
718             "__run_num__": 1,
719             "changes": {},
720         },
721     } == ret
722 @pytest.mark.slow_test
723 def test_call_success():
724     ret = None
725     docker_run_all_mock = MagicMock(
726         return_value={
727             "retcode": 0,
728             "stdout": '{"retcode": 0, "comment": "container cmd"}',
729             "stderr": "err",
730         }
731     )
732     docker_copy_to_mock = MagicMock(return_value={"retcode": 0})
733     docker_config_mock = MagicMock(return_value="")
734     client = Mock()
735     client.put_archive = Mock()
736     get_client_mock = MagicMock(return_value=client)
737     context = {"docker.exec_driver": "docker-exec"}
738     salt_dunder = {"config.option": docker_config_mock}
739     with patch.object(docker_mod, "run_all", docker_run_all_mock), patch.object(
740         docker_mod, "copy_to", docker_copy_to_mock
741     ), patch.object(docker_mod, "_get_client", get_client_mock), patch.dict(
742         docker_mod.__opts__, {"cachedir": "/tmp"}
743     ), patch.dict(
744         docker_mod.__salt__, salt_dunder
745     ), patch.dict(
746         docker_mod.__context__, context
747     ):
748         for i in range(2):
749             ret = docker_mod.call("ID", "test.arg", 1, 2, arg1="val1")
750     assert "mkdir" in docker_run_all_mock.mock_calls[0][1][1]
751     assert "mkdir" in docker_run_all_mock.mock_calls[5][1][1]
752     assert (
753         docker_run_all_mock.mock_calls[0][1][1]
754         != docker_run_all_mock.mock_calls[5][1][1]
755     )
756     assert "python3 --version" == docker_run_all_mock.mock_calls[1][1][1]
757     assert "salt-call" in docker_run_all_mock.mock_calls[3][1][1]
758     assert "salt-call" in docker_run_all_mock.mock_calls[8][1][1]
759     assert (
760         docker_run_all_mock.mock_calls[3][1][1]
761         != docker_run_all_mock.mock_calls[8][1][1]
762     )
763     assert "tarfile" in docker_run_all_mock.mock_calls[2][1][1]
764     assert "tarfile" in docker_run_all_mock.mock_calls[7][1][1]
765     assert (
766         docker_run_all_mock.mock_calls[2][1][1]
767         != docker_run_all_mock.mock_calls[7][1][1]
768     )
769     assert "rm -rf" in docker_run_all_mock.mock_calls[4][1][1]
770     assert "rm -rf" in docker_run_all_mock.mock_calls[9][1][1]
771     assert (
772         docker_run_all_mock.mock_calls[4][1][1]
773         != docker_run_all_mock.mock_calls[9][1][1]
774     )
775     assert {"retcode": 0, "comment": "container cmd"} == ret
776 def test_images_with_empty_tags():
777     client = Mock()
778     client.api_version = "1.24"
779     client.images = Mock(
780         return_value=[
781             {"Id": "sha256:abcde", "RepoTags": None},
782             {"Id": "sha256:abcdef"},
783             {"Id": "sha256:abcdefg", "RepoTags": ["image:latest"]},
784         ]
785     )
786     get_client_mock = MagicMock(return_value=client)
787     with patch.object(docker_mod, "_get_client", get_client_mock):
788         docker_mod._clear_context()
789         result = docker_mod.images()
790     assert result == {"sha256:abcdefg": {"RepoTags": ["image:latest"]}}
791 def test_compare_container_image_id_resolution():
792     def _inspect_container_effect(id_):
793         return {
794             "container1": {
795                 "Config": {"Image": "realimage:latest"},
796                 "HostConfig": {},
797             },
798             "container2": {"Config": {"Image": "image_id"}, "HostConfig": {}},
799         }[id_]
800     def _inspect_image_effect(id_):
801         return {
802             "realimage:latest": {"Id": "image_id"},
803             "image_id": {"Id": "image_id"},
804         }[id_]
805     inspect_container_mock = MagicMock(side_effect=_inspect_container_effect)
806     inspect_image_mock = MagicMock(side_effect=_inspect_image_effect)
807     with patch.object(docker_mod, "inspect_container", inspect_container_mock):
808         with patch.object(docker_mod, "inspect_image", inspect_image_mock):
809             ret = docker_mod.compare_containers("container1", "container2")
810             assert ret == {}
811 def test_compare_container_ulimits_order():
812     def _inspect_container_effect(id_):
813         return {
814             "container1": {
815                 "Config": {},
816                 "HostConfig": {
817                     "Ulimits": [
818                         {"Hard": -1, "Soft": -1, "Name": "core"},
819                         {"Hard": 65536, "Soft": 65536, "Name": "nofile"},
820                     ]
821                 },
822             },
823             "container2": {
824                 "Config": {},
825                 "HostConfig": {
826                     "Ulimits": [
827                         {"Hard": 65536, "Soft": 65536, "Name": "nofile"},
828                         {"Hard": -1, "Soft": -1, "Name": "core"},
829                     ]
830                 },
831             },
832         }[id_]
833     inspect_container_mock = MagicMock(side_effect=_inspect_container_effect)
834     with patch.object(docker_mod, "inspect_container", inspect_container_mock):
835         ret = docker_mod.compare_container("container1", "container2")
836         assert ret == {}
837 def test_compare_container_env_order():
838     def _inspect_container_effect(id_):
839         return {
840             "container1": {
841                 "Config": {},
842                 "HostConfig": {"Env": ["FOO=bar", "HELLO=world"]},
843             },
844             "container2": {
845                 "Config": {},
846                 "HostConfig": {"Env": ["HELLO=world", "FOO=bar"]},
847             },
848         }[id_]
849     inspect_container_mock = MagicMock(side_effect=_inspect_container_effect)
850     with patch.object(docker_mod, "inspect_container", inspect_container_mock):
851         ret = docker_mod.compare_container("container1", "container2")
852         assert ret == {}
853 def test_resolve_tag():
854     id_ = "sha256:6ad733544a6317992a6fac4eb19fe1df577d4dec7529efec28a5bd0edad0fd30"
855     tags = ["foo:latest", "foo:bar"]
856     mock_tagged = MagicMock(return_value={"Id": id_, "RepoTags": tags})
857     mock_untagged = MagicMock(return_value={"Id": id_, "RepoTags": []})
858     mock_unexpected = MagicMock(return_value={"Id": id_})
859     mock_not_found = MagicMock(side_effect=CommandExecutionError())
860     with patch.object(docker_mod, "inspect_image", mock_tagged):
861         assert docker_mod.resolve_tag("foo") == tags[0]
862         assert docker_mod.resolve_tag("foo", all=True) == tags
863     with patch.object(docker_mod, "inspect_image", mock_untagged):
864         assert docker_mod.resolve_tag("foo") == id_
865         assert docker_mod.resolve_tag("foo", all=True) == [id_]
866     with patch.object(docker_mod, "inspect_image", mock_unexpected):
867         assert docker_mod.resolve_tag("foo") == id_
868         assert docker_mod.resolve_tag("foo", all=True) == [id_]
869     with patch.object(docker_mod, "inspect_image", mock_not_found):
870         assert docker_mod.resolve_tag("foo") is False
871         assert docker_mod.resolve_tag("foo", all=True) is False
872 def test_prune():
873     def _run(**kwargs):
874         side_effect = kwargs.pop("side_effect", None)
875         client = Mock()
876         if side_effect is not None:
877             client.side_effect = side_effect
878         with patch.object(docker_mod, "_client_wrapper", client):
879             docker_mod.prune(**kwargs)
880         return client
881     client = _run(containers=True)
882     client.assert_called_once_with("prune_containers", filters={})
883     client = _run(containers=True, until="24h", label="foo,bar=baz")
884     client.assert_called_once_with(
885         "prune_containers", filters={"until": ["24h"], "label": ["foo", "bar=baz"]}
886     )
887     client = _run(images=True)
888     client.assert_called_once_with("prune_images", filters={})
889     client = _run(images=True, dangling=True, until="24h", label="foo,bar=baz")
890     client.assert_called_once_with(
891         "prune_images",
892         filters={"dangling": True, "until": ["24h"], "label": ["foo", "bar=baz"]},
893     )
894     client = _run(networks=True)
895     client.assert_called_once_with("prune_networks", filters={})
896     client = _run(networks=True, until="24h", label="foo,bar=baz")
897     client.assert_called_once_with(
898         "prune_networks", filters={"until": ["24h"], "label": ["foo", "bar=baz"]}
899     )
900     client = _run(system=False, volumes=True)
901     client.assert_called_once_with("prune_volumes", filters={})
902     client = _run(system=False, volumes=True, label="foo,bar=baz")
903     client.assert_called_once_with(
904         "prune_volumes", filters={"label": ["foo", "bar=baz"]}
905     )
906     client = _run(containers=True, images=True)
907     assert client.call_args_list == [
908         call("prune_containers", filters={}),
909         call("prune_images", filters={}),
910     ]
911     client = _run(containers=True, images=True, until="24h", label="foo,bar=baz")
912     assert client.call_args_list == [
913         call(
914             "prune_containers",
915             filters={"until": ["24h"], "label": ["foo", "bar=baz"]},
916         ),
917         call(
918             "prune_images",
919             filters={"until": ["24h"], "label": ["foo", "bar=baz"]},
920         ),
921     ]
922     client = _run(system=True)
923     assert client.call_args_list == [
924         call("prune_containers", filters={}),
925         call("prune_images", filters={}),
926         call("prune_networks", filters={}),
927         call("prune_build", filters={}),
928     ]
929     client = _run(
930         system=True,
931         side_effect=[None, None, None, SaltInvocationError(), None, None, None],
932     )
933     assert client.call_args_list == [
934         call("prune_containers", filters={}),
935         call("prune_images", filters={}),
936         call("prune_networks", filters={}),
937         call("prune_build", filters={}),
938         call("_url", "/build/prune"),
939         call("_post", None),
940         call("_result", None, True),
941     ]
942     client = _run(system=True, label="foo,bar=baz")
943     assert client.call_args_list == [
944         call("prune_containers", filters={"label": ["foo", "bar=baz"]}),
945         call("prune_images", filters={"label": ["foo", "bar=baz"]}),
946         call("prune_networks", filters={"label": ["foo", "bar=baz"]}),
947         call("prune_build", filters={"label": ["foo", "bar=baz"]}),
948     ]
949     client = _run(
950         system=True,
951         label="foo,bar=baz",
952         side_effect=[None, None, None, SaltInvocationError(), None, None, None],
953     )
954     assert client.call_args_list == [
955         call("prune_containers", filters={"label": ["foo", "bar=baz"]}),
956         call("prune_images", filters={"label": ["foo", "bar=baz"]}),
957         call("prune_networks", filters={"label": ["foo", "bar=baz"]}),
958         call("prune_build", filters={"label": ["foo", "bar=baz"]}),
959         call("_url", "/build/prune"),
960         call("_post", None),
961         call("_result", None, True),
962     ]
963     client = _run(system=True, volumes=True)
964     assert client.call_args_list == [
965         call("prune_containers", filters={}),
966         call("prune_images", filters={}),
967         call("prune_networks", filters={}),
968         call("prune_build", filters={}),
969         call("prune_volumes", filters={}),
970     ]
971     client = _run(
972         system=True,
973         volumes=True,
974         side_effect=[
975             None,
976             None,
977             None,
978             SaltInvocationError(),
979             None,
980             None,
981             None,
982             None,
983         ],
984     )
985     assert client.call_args_list == [
986         call("prune_containers", filters={}),
987         call("prune_images", filters={}),
988         call("prune_networks", filters={}),
989         call("prune_build", filters={}),
990         call("_url", "/build/prune"),
991         call("_post", None),
992         call("_result", None, True),
993         call("prune_volumes", filters={}),
994     ]
995     client = _run(system=True, volumes=True, label="foo,bar=baz")
996     assert client.call_args_list == [
997         call("prune_containers", filters={"label": ["foo", "bar=baz"]}),
998         call("prune_images", filters={"label": ["foo", "bar=baz"]}),
999         call("prune_networks", filters={"label": ["foo", "bar=baz"]}),
1000         call("prune_build", filters={"label": ["foo", "bar=baz"]}),
1001         call("prune_volumes", filters={"label": ["foo", "bar=baz"]}),
1002     ]
1003     client = _run(
1004         system=True,
1005         volumes=True,
1006         label="foo,bar=baz",
1007         side_effect=[
1008             None,
1009             None,
1010             None,
1011             SaltInvocationError(),
1012             None,
1013             None,
1014             None,
1015             None,
1016         ],
1017     )
1018     assert client.call_args_list == [
1019         call("prune_containers", filters={"label": ["foo", "bar=baz"]}),
1020         call("prune_images", filters={"label": ["foo", "bar=baz"]}),
1021         call("prune_networks", filters={"label": ["foo", "bar=baz"]}),
1022         call("prune_build", filters={"label": ["foo", "bar=baz"]}),
1023         call("_url", "/build/prune"),
1024         call("_post", None),
1025         call("_result", None, True),
1026         call("prune_volumes", filters={"label": ["foo", "bar=baz"]}),
1027     ]
1028 def test_port():
1029     ports = {
1030         "foo": {
1031             "5555/tcp": [{"HostIp": "0.0.0.0", "HostPort": "32768"}],
1032             "6666/tcp": [{"HostIp": "0.0.0.0", "HostPort": "32769"}],
1033         },
1034         "bar": {
1035             "4444/udp": [{"HostIp": "0.0.0.0", "HostPort": "32767"}],
1036             "5555/tcp": [{"HostIp": "0.0.0.0", "HostPort": "32768"}],
1037             "6666/tcp": [{"HostIp": "0.0.0.0", "HostPort": "32769"}],
1038         },
1039         "baz": {
1040             "5555/tcp": [{"HostIp": "0.0.0.0", "HostPort": "32768"}],
1041             "6666/udp": [{"HostIp": "0.0.0.0", "HostPort": "32769"}],
1042         },
1043     }
1044     list_mock = MagicMock(return_value=["bar", "baz", "foo"])
1045     inspect_mock = MagicMock(
1046         side_effect=lambda x: {"NetworkSettings": {"Ports": ports.get(x)}}
1047     )
1048     with patch.object(docker_mod, "list_containers", list_mock), patch.object(
1049         docker_mod, "inspect_container", inspect_mock
1050     ):
1051         ret = docker_mod.port("foo")
1052         assert ret == ports["foo"]
1053         ret = docker_mod.port("foo", private_port="5555/tcp")
1054         assert ret == {"5555/tcp": ports["foo"]["5555/tcp"]}
1055         ret = docker_mod.port("ba*")
1056         assert ret == {"bar": ports["bar"], "baz": ports["baz"]}
1057         ret = docker_mod.port("ba?")
1058         assert ret == {"bar": ports["bar"], "baz": ports["baz"]}
1059         ret = docker_mod.port("ba[rz]")
1060         assert ret == {"bar": ports["bar"], "baz": ports["baz"]}
1061         ret = docker_mod.port("ba*", private_port="6666/tcp")
1062         assert ret == {"bar": {"6666/tcp": ports["bar"]["6666/tcp"]}, "baz": {}}
1063         ret = docker_mod.port("ba?", private_port="6666/tcp")
1064         assert ret == {"bar": {"6666/tcp": ports["bar"]["6666/tcp"]}, "baz": {}}
1065         ret = docker_mod.port("ba[rz]", private_port="6666/tcp")
1066         assert ret == {"bar": {"6666/tcp": ports["bar"]["6666/tcp"]}, "baz": {}}
1067         ret = docker_mod.port("*")
1068         assert ret == ports
1069         ret = docker_mod.port("*", private_port="5555/tcp")
1070         assert ret == {
1071             "foo": {"5555/tcp": ports["foo"]["5555/tcp"]},
1072             "bar": {"5555/tcp": ports["bar"]["5555/tcp"]},
1073             "baz": {"5555/tcp": ports["baz"]["5555/tcp"]},
1074         }
1075         ret = docker_mod.port("*", private_port=6666)
1076         assert ret == {
1077             "foo": {"6666/tcp": ports["foo"]["6666/tcp"]},
1078             "bar": {"6666/tcp": ports["bar"]["6666/tcp"]},
1079             "baz": {"6666/udp": ports["baz"]["6666/udp"]},
1080         }
1081         ret = docker_mod.port("*", private_port="6666/tcp")
1082         assert ret == {
1083             "foo": {"6666/tcp": ports["foo"]["6666/tcp"]},
1084             "bar": {"6666/tcp": ports["bar"]["6666/tcp"]},
1085             "baz": {},
1086         }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
