<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for modjk_1.py &amp; debuild_pkgbuild.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for modjk_1.py &amp; debuild_pkgbuild.py
      </h3>
<h1 align="center">
        1.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>modjk_1.py (3.3248081%)<th>debuild_pkgbuild.py (1.0638298%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(65-69)<td><a href="#" name="0">(725-733)</a><td align="center"><font color="#ff0000">13</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>modjk_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import urllib.parse
2 import urllib.request
3 def __virtual__():
4     return True
5 def _auth(url, user, passwd, realm):
6     basic = urllib.request.HTTPBasicAuthHandler()
7     basic.add_password(realm=realm, uri=url, user=user, passwd=passwd)
8     digest = urllib.request.HTTPDigestAuthHandler()
9     digest.add_password(realm=realm, uri=url, user=user, passwd=passwd)
10     return urllib.request.build_opener(basic, digest)
11 def _do_http(opts, profile="default"):
12     ret = {}
13 <a name="0"></a>    url = __salt__["config.get"]("modjk:{}:url".format(profile), "")
14     user = __salt__["config.get"]("modjk:{}:user".format(profile), "")
15     passwd = __salt__["config.get"]("modjk:{}:pass".format(profile), "")
16     realm <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= __salt__["config.get"]("modjk:{}:realm".format(profile), "")
17     timeout = __salt__["config.get"]("modjk:{}:timeout".format(profile), "")
18     if not url:
19         raise Exception(</b></font>"missing url in profile {}".format(profile))
20     if user and passwd:
21         auth = _auth(url=url, realm=realm, user=user, passwd=passwd)
22         urllib.request.install_opener(auth)
23     url += "?{}".format(urllib.parse.urlencode(opts))
24     for line in urllib.request.urlopen(url, timeout=timeout).read().splitlines():
25         splt = line.split("=", 1)
26         if splt[0] in ret:
27             ret[splt[0]] += ",{}".format(splt[1])
28         else:
29             ret[splt[0]] = splt[1]
30     return ret
31 def _worker_ctl(worker, lbn, vwa, profile="default"):
32     cmd = {
33         "cmd": "update",
34         "mime": "prop",
35         "w": lbn,
36         "sw": worker,
37         "vwa": vwa,
38     }
39     return _do_http(cmd, profile)["worker.result.type"] == "OK"
40 def version(profile="default"):
41     cmd = {
42         "cmd": "version",
43         "mime": "prop",
44     }
45     return _do_http(cmd, profile)["worker.jk_version"].split("/")[-1]
46 def get_running(profile="default"):
47     cmd = {
48         "cmd": "list",
49         "mime": "prop",
50     }
51     return _do_http(cmd, profile)
52 def dump_config(profile="default"):
53     cmd = {
54         "cmd": "dump",
55         "mime": "prop",
56     }
57     return _do_http(cmd, profile)
58 def list_configured_members(lbn, profile="default"):
59     config = dump_config(profile)
60     try:
61         ret = config["worker.{}.balance_workers".format(lbn)]
62     except KeyError:
63         return []
64     return [_f for _f in ret.strip().split(",") if _f]
65 def workers(profile="default"):
66     config = get_running(profile)
67     lbn = config["worker.list"].split(",")
68     worker_list = []
69     ret = {}
70     for lb in lbn:
71         try:
72             worker_list.extend(
73                 config["worker.{}.balance_workers".format(lb)].split(",")
74             )
75         except KeyError:
76             pass
77     worker_list = list(set(worker_list))
78     for worker in worker_list:
79         ret[worker] = {
80             "activation": config["worker.{}.activation".format(worker)],
81             "state": config["worker.{}.state".format(worker)],
82         }
83     return ret
84 def recover_all(lbn, profile="default"):
85     ret = {}
86     config = get_running(profile)
87     try:
88         workers_ = config["worker.{}.balance_workers".format(lbn)].split(",")
89     except KeyError:
90         return ret
91     for worker in workers_:
92         curr_state = worker_status(worker, profile)
93         if curr_state["activation"] != "ACT":
94             worker_activate(worker, lbn, profile)
95         if not curr_state["state"].startswith("OK"):
96             worker_recover(worker, lbn, profile)
97         ret[worker] = worker_status(worker, profile)
98     return ret
99 def reset_stats(lbn, profile="default"):
100     cmd = {
101         "cmd": "reset",
102         "mime": "prop",
103         "w": lbn,
104     }
105     return _do_http(cmd, profile)["worker.result.type"] == "OK"
106 def lb_edit(lbn, settings, profile="default"):
107     settings["cmd"] = "update"
108     settings["mime"] = "prop"
109     settings["w"] = lbn
110     return _do_http(settings, profile)["worker.result.type"] == "OK"
111 def bulk_stop(workers, lbn, profile="default"):
112     ret = {}
113     if isinstance(workers, str):
114         workers = workers.split(",")
115     for worker in workers:
116         try:
117             ret[worker] = worker_stop(worker, lbn, profile)
118         except Exception:  # pylint: disable=broad-except
119             ret[worker] = False
120     return ret
121 def bulk_activate(workers, lbn, profile="default"):
122     ret = {}
123     if isinstance(workers, str):
124         workers = workers.split(",")
125     for worker in workers:
126         try:
127             ret[worker] = worker_activate(worker, lbn, profile)
128         except Exception:  # pylint: disable=broad-except
129             ret[worker] = False
130     return ret
131 def bulk_disable(workers, lbn, profile="default"):
132     ret = {}
133     if isinstance(workers, str):
134         workers = workers.split(",")
135     for worker in workers:
136         try:
137             ret[worker] = worker_disable(worker, lbn, profile)
138         except Exception:  # pylint: disable=broad-except
139             ret[worker] = False
140     return ret
141 def bulk_recover(workers, lbn, profile="default"):
142     ret = {}
143     if isinstance(workers, str):
144         workers = workers.split(",")
145     for worker in workers:
146         try:
147             ret[worker] = worker_recover(worker, lbn, profile)
148         except Exception:  # pylint: disable=broad-except
149             ret[worker] = False
150     return ret
151 def worker_status(worker, profile="default"):
152     config = get_running(profile)
153     try:
154         return {
155             "activation": config["worker.{}.activation".format(worker)],
156             "state": config["worker.{}.state".format(worker)],
157         }
158     except KeyError:
159         return False
160 def worker_recover(worker, lbn, profile="default"):
161     cmd = {
162         "cmd": "recover",
163         "mime": "prop",
164         "w": lbn,
165         "sw": worker,
166     }
167     return _do_http(cmd, profile)
168 def worker_disable(worker, lbn, profile="default"):
169     return _worker_ctl(worker, lbn, "d", profile)
170 def worker_activate(worker, lbn, profile="default"):
171     return _worker_ctl(worker, lbn, "a", profile)
172 def worker_stop(worker, lbn, profile="default"):
173     return _worker_ctl(worker, lbn, "s", profile)
174 def worker_edit(worker, lbn, settings, profile="default"):
175     settings["cmd"] = "update"
176     settings["mime"] = "prop"
177     settings["w"] = lbn
178     settings["sw"] = worker
179     return _do_http(settings, profile)["worker.result.type"] == "OK"
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>debuild_pkgbuild.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import errno
2 import logging
3 import os
4 import re
5 import shutil
6 import tempfile
7 import time
8 import traceback
9 import urllib.parse
10 import salt.utils.files
11 import salt.utils.path
12 import salt.utils.stringutils
13 import salt.utils.vt
14 from salt.exceptions import CommandExecutionError, SaltInvocationError
15 HAS_LIBS = False
16 SIGN_PROMPT_RE = re.compile(r"Enter passphrase: ", re.M)
17 REPREPRO_SIGN_PROMPT_RE = re.compile(r"Passphrase: ", re.M)
18 try:
19     import gnupg  # pylint: disable=unused-import
20     import salt.modules.gpg
21     HAS_LIBS = True
22 except ImportError:
23     pass
24 log = logging.getLogger(__name__)
25 __virtualname__ = "pkgbuild"
26 def __virtual__():
27     if __grains__.get("os_family", False) in ("Kali", "Debian"):
28         missing_util = False
29         utils_reqd = ["gpg", "debuild", "pbuilder", "reprepro"]
30         for named_util in utils_reqd:
31             if not salt.utils.path.which(named_util):
32                 missing_util = True
33                 break
34         if HAS_LIBS and not missing_util:
35             return __virtualname__
36         else:
37             return (
38                 False,
39                 "The debbuild module could not be loaded: requires python-gnupg, gpg,"
40                 " debuild, pbuilder and reprepro utilities to be installed",
41             )
42     else:
43         return (False, "The debbuild module could not be loaded: unsupported OS family")
44 def _check_repo_sign_utils_support(name):
45     if salt.utils.path.which(name):
46         return True
47     else:
48         raise CommandExecutionError(
49             "utility '{}' needs to be installed or made available in search path".format(
50                 name
51             )
52         )
53 def _check_repo_gpg_phrase_utils():
54     util_name = "/usr/lib/gnupg2/gpg-preset-passphrase"
55     if __salt__["file.file_exists"](util_name):
56         return True
57     else:
58         raise CommandExecutionError(
59             "utility '{}' needs to be installed".format(util_name)
60         )
61 def _get_build_env(env):
62     env_override = ""
63     if env is None:
64         return env_override
65     if not isinstance(env, dict):
66         raise SaltInvocationError("'env' must be a Python dictionary")
67     for key, value in env.items():
68         env_override += "{}={}\n".format(key, value)
69         env_override += "export {}\n".format(key)
70     return env_override
71 def _get_repo_options_env(env):
72     env_options = ""
73     if env is None:
74         return env_options
75     if not isinstance(env, dict):
76         raise SaltInvocationError("'env' must be a Python dictionary")
77     for key, value in env.items():
78         if key == "OPTIONS":
79             env_options += "{}\n".format(value)
80     return env_options
81 def _get_repo_dists_env(env):
82     dflts_dict = {
83         "OPTIONS": ("I", "", "processed by _get_repo_options_env"),
84         "ORIGIN": ("O", "Origin", "SaltStack"),
85         "LABEL": ("O", "Label", "salt_debian"),
86         "SUITE": ("O", "Suite", "stable"),
87         "VERSION": ("O", "Version", "9.0"),
88         "CODENAME": ("M", "Codename", "stretch"),
89         "ARCHS": ("M", "Architectures", "i386 amd64 source"),
90         "COMPONENTS": ("M", "Components", "main"),
91         "DESCRIPTION": ("O", "Description", "SaltStack debian package repo"),
92     }
93     env_dists = ""
94     codename = ""
95     dflts_keys = list(dflts_dict.keys())
96     if env is None:
97         for key, value in dflts_dict.items():
98             if dflts_dict[key][0] == "M":
99                 env_dists += "{}: {}\n".format(dflts_dict[key][1], dflts_dict[key][2])
100                 if key == "CODENAME":
101                     codename = dflts_dict[key][2]
102         return (codename, env_dists)
103     if not isinstance(env, dict):
104         raise SaltInvocationError("'env' must be a Python dictionary")
105     env_man_seen = []
106     for key, value in env.items():
107         if key in dflts_keys:
108             if dflts_dict[key][0] == "M":
109                 env_man_seen.append(key)
110                 if key == "CODENAME":
111                     codename = value
112             if dflts_dict[key][0] != "I":
113                 env_dists += "{}: {}\n".format(dflts_dict[key][1], value)
114         else:
115             env_dists += "{}: {}\n".format(key, value)
116     env_keys = list(env.keys())
117     for key in env_keys:
118         if key in dflts_keys and dflts_dict[key][0] == "M" and key not in env_man_seen:
119             env_dists += "{}: {}\n".format(dflts_dict[key][1], dflts_dict[key][2])
120             if key == "CODENAME":
121                 codename = value
122     return (codename, env_dists)
123 def _create_pbuilders(env, runas="root"):
124     home = os.path.expanduser("~{}".format(runas))
125     pbuilderrc = os.path.join(home, ".pbuilderrc")
126     if not os.path.isfile(pbuilderrc):
127         raise SaltInvocationError("pbuilderrc environment is incorrectly setup")
128     env_overrides = _get_build_env(env)
129     if env_overrides and not env_overrides.isspace():
130         with salt.utils.files.fopen(pbuilderrc, "a") as fow:
131             fow.write(salt.utils.stringutils.to_str(env_overrides))
132     cmd = "chown {0}:{0} {1}".format(runas, pbuilderrc)
133     retrc = __salt__["cmd.retcode"](cmd, runas="root")
134     if retrc != 0:
135         raise SaltInvocationError(
136             "Create pbuilderrc in home directory failed with return error '{}', "
137             "check logs for further details".format(retrc)
138         )
139 def _mk_tree():
140     basedir = tempfile.mkdtemp()
141     return basedir
142 def _get_spec(tree_base, spec, saltenv="base"):
143     spec_tgt = os.path.basename(spec)
144     dest = os.path.join(tree_base, spec_tgt)
145     return __salt__["cp.get_url"](spec, dest, saltenv=saltenv)
146 def _get_src(tree_base, source, saltenv="base"):
147     parsed = urllib.parse.urlparse(source)
148     sbase = os.path.basename(source)
149     dest = os.path.join(tree_base, sbase)
150     if parsed.scheme:
151         __salt__["cp.get_url"](source, dest, saltenv=saltenv)
152     else:
153         shutil.copy(source, dest)
154 def make_src_pkg(dest_dir, spec, sources, env=None, saltenv="base", runas="root"):
155     _create_pbuilders(env, runas)
156     tree_base = _mk_tree()
157     ret = []
158     if not os.path.isdir(dest_dir):
159         os.makedirs(dest_dir)
160     root_user = "root"
161     retrc = 0
162     cmd = "chown {0}:{0} {1}".format(runas, tree_base)
163     retrc = __salt__["cmd.retcode"](cmd, runas="root")
164     if retrc != 0:
165         raise SaltInvocationError(
166             "make_src_pkg ensuring tree_base '{}' ownership failed with return error"
167             " '{}', check logs for further details".format(tree_base, retrc)
168         )
169     cmd = "chown {0}:{0} {1}".format(runas, dest_dir)
170     retrc = __salt__["cmd.retcode"](cmd, runas=root_user)
171     if retrc != 0:
172         raise SaltInvocationError(
173             "make_src_pkg ensuring dest_dir '{}' ownership failed with return error"
174             " '{}', check logs for further details".format(dest_dir, retrc)
175         )
176     spec_pathfile = _get_spec(tree_base, spec, saltenv)
177     if isinstance(sources, str):
178         sources = sources.split(",")
179     for src in sources:
180         _get_src(tree_base, src, saltenv)
181     if spec_pathfile.endswith(".dsc"):
182         for efile in os.listdir(tree_base):
183             full = os.path.join(tree_base, efile)
184             trgt = os.path.join(dest_dir, efile)
185             shutil.copy(full, trgt)
186             ret.append(trgt)
187         return ret
188     salttarball = None
189     for afile in os.listdir(tree_base):
190         if afile.startswith("salt-") and afile.endswith(".tar.gz"):
191             salttarball = afile
192             break
193     else:
194         return ret
195     frontname = salttarball.split(".tar.gz")
196     salttar_name = frontname[0]
197     k = salttar_name.rfind("-")
198     debname = salttar_name[:k] + "_" + salttar_name[k + 1 :]
199     debname += "+ds"
200     debname_orig = debname + ".orig.tar.gz"
201     abspath_debname = os.path.join(tree_base, debname)
202     cmd = "tar -xvzf {}".format(salttarball)
203     retrc = __salt__["cmd.retcode"](cmd, cwd=tree_base, runas=root_user)
204     cmd = "mv {} {}".format(salttar_name, debname)
205     retrc |= __salt__["cmd.retcode"](cmd, cwd=tree_base, runas=root_user)
206     cmd = "tar -cvzf {} {}".format(os.path.join(tree_base, debname_orig), debname)
207     retrc |= __salt__["cmd.retcode"](cmd, cwd=tree_base, runas=root_user)
208     cmd = "rm -f {}".format(salttarball)
209     retrc |= __salt__["cmd.retcode"](cmd, cwd=tree_base, runas=root_user, env=env)
210     cmd = "cp {}  {}".format(spec_pathfile, abspath_debname)
211     retrc |= __salt__["cmd.retcode"](cmd, cwd=abspath_debname, runas=root_user)
212     cmd = "tar -xvJf {}".format(spec_pathfile)
213     retrc |= __salt__["cmd.retcode"](cmd, cwd=abspath_debname, runas=root_user, env=env)
214     cmd = "rm -f {}".format(os.path.basename(spec_pathfile))
215     retrc |= __salt__["cmd.retcode"](cmd, cwd=abspath_debname, runas=root_user)
216     cmd = "debuild -S -uc -us -sa"
217     retrc |= __salt__["cmd.retcode"](
218         cmd, cwd=abspath_debname, runas=root_user, python_shell=True, env=env
219     )
220     cmd = "rm -fR {}".format(abspath_debname)
221     retrc |= __salt__["cmd.retcode"](cmd, runas=root_user)
222     if retrc != 0:
223         raise SaltInvocationError(
224             "Make source package for destination directory {}, spec {}, sources {},"
225             " failed with return error {}, check logs for further details".format(
226                 dest_dir, spec, sources, retrc
227             )
228         )
229     for dfile in os.listdir(tree_base):
230         if not dfile.endswith(".build"):
231             full = os.path.join(tree_base, dfile)
232             trgt = os.path.join(dest_dir, dfile)
233             shutil.copy(full, trgt)
234             ret.append(trgt)
235     return ret
236 def build(
237     runas,
238     tgt,
239     dest_dir,
240     spec,
241     sources,
242     deps,
243     env,
244     template,
245     saltenv="base",
246     log_dir="/var/log/salt/pkgbuild",
247 ):  # pylint: disable=unused-argument
248     ret = {}
249     retrc = 0
250     try:
251         os.makedirs(dest_dir)
252     except OSError as exc:
253         if exc.errno != errno.EEXIST:
254             raise
255     dsc_dir = tempfile.mkdtemp()
256     try:
257         dscs = make_src_pkg(dsc_dir, spec, sources, env, saltenv, runas)
258     except Exception as exc:  # pylint: disable=broad-except
259         shutil.rmtree(dsc_dir)
260         log.error("Failed to make src package, exception '%s'", exc)
261         return ret
262     root_user = "root"
263     if runas != root_user:
264         user_home = os.path.expanduser("~{}".format(runas))
265         root_home = os.path.expanduser("~root")
266         cmd = "cp {}/.pbuilderrc {}/".format(user_home, root_home)
267         retrc = __salt__["cmd.retcode"](
268             cmd, runas=root_user, python_shell=True, env=env
269         )
270         cmd = "cp -R {}/.pbuilder-hooks {}/".format(user_home, root_home)
271         retrc = __salt__["cmd.retcode"](
272             cmd, runas=root_user, python_shell=True, env=env
273         )
274         if retrc != 0:
275             raise SaltInvocationError(
276                 "build copy pbuilder files from '{}' to '{}' returned error '{}', "
277                 "check logs for further details".format(user_home, root_home, retrc)
278             )
279     cmd = "/usr/sbin/pbuilder --create"
280     retrc = __salt__["cmd.retcode"](cmd, runas=root_user, python_shell=True, env=env)
281     if retrc != 0:
282         raise SaltInvocationError(
283             "pbuilder create failed with return error '{}', "
284             "check logs for further details".format(retrc)
285         )
286     results_dir = "/var/cache/pbuilder/result"
287     cmd = "rm -fR {}".format(results_dir)
288     retrc |= __salt__["cmd.retcode"](cmd, runas=root_user, python_shell=True, env=env)
289     for dsc in dscs:
290         afile = os.path.basename(dsc)
291         os.path.join(dest_dir, afile)
292         if dsc.endswith(".dsc"):
293             dbase = os.path.dirname(dsc)
294             try:
295                 cmd = "chown {0}:{0} -R {1}".format(runas, dbase)
296                 retrc |= __salt__["cmd.retcode"](
297                     cmd, runas=root_user, python_shell=True, env=env
298                 )
299                 cmd = "/usr/sbin/pbuilder update --override-config"
300                 retrc |= __salt__["cmd.retcode"](
301                     cmd, runas=root_user, python_shell=True, env=env
302                 )
303                 cmd = '/usr/sbin/pbuilder build --debbuildopts "-sa" {}'.format(dsc)
304                 retrc |= __salt__["cmd.retcode"](
305                     cmd, runas=root_user, python_shell=True, env=env
306                 )
307                 if retrc != 0:
308                     raise SaltInvocationError(
309                         "pbuilder build or update failed with return error {}, "
310                         "check logs for further details".format(retrc)
311                     )
312                 for bfile in os.listdir(results_dir):
313                     if bfile != "Packages":
314                         full = os.path.join(results_dir, bfile)
315                         bdist = os.path.join(dest_dir, bfile)
316                         shutil.copy(full, bdist)
317                         ret.setdefault("Packages", []).append(bdist)
318             except Exception as exc:  # pylint: disable=broad-except
319                 log.error("Error building from '%s', execption '%s'", dsc, exc)
320     for pkgzfile in os.listdir(dest_dir):
321         if pkgzfile == "Packages":
322             pkgzabsfile = os.path.join(dest_dir, pkgzfile)
323             os.remove(pkgzabsfile)
324     cmd = "chown {0}:{0} -R {1}".format(runas, dest_dir)
325     __salt__["cmd.retcode"](cmd, runas=root_user, python_shell=True, env=env)
326     shutil.rmtree(dsc_dir)
327     return ret
328 def make_repo(
329     repodir,
330     keyid=None,
331     env=None,
332     use_passphrase=False,
333     gnupghome="/etc/salt/gpgkeys",
334     runas="root",
335     timeout=15.0,
336 ):
337     res = {"retcode": 1, "stdout": "", "stderr": "initialization value"}
338     retrc = 0
339     if gnupghome and env is None:
340         env = {}
341         env["GNUPGHOME"] = gnupghome
342     repoconf = os.path.join(repodir, "conf")
343     if not os.path.isdir(repoconf):
344         os.makedirs(repoconf)
345     codename, repocfg_dists = _get_repo_dists_env(env)
346     repoconfdist = os.path.join(repoconf, "distributions")
347     with salt.utils.files.fopen(repoconfdist, "w") as fow:
348         fow.write(salt.utils.stringutils.to_str(repocfg_dists))
349     repocfg_opts = _get_repo_options_env(env)
350     repoconfopts = os.path.join(repoconf, "options")
351     with salt.utils.files.fopen(repoconfopts, "w") as fow:
352         fow.write(salt.utils.stringutils.to_str(repocfg_opts))
353     cmd = "chown {0}:{0} -R {1}".format(runas, repoconf)
354     retrc = __salt__["cmd.retcode"](cmd, runas="root")
355     if retrc != 0:
356         raise SaltInvocationError(
357             "failed to ensure rights to repoconf directory, error {}, "
358             "check logs for further details".format(retrc)
359         )
360     local_keygrip_to_use = None
361     local_key_fingerprint = None
362     local_keyid = None
363     phrase = ""
364     gpg_info_file = "{}/gpg-agent-info-salt".format(gnupghome)
365     gpg_tty_info_file = "{}/gpg-tty-info-salt".format(gnupghome)
366     older_gnupg = __salt__["file.file_exists"](gpg_info_file)
367     if keyid is not None:
368         with salt.utils.files.fopen(repoconfdist, "a") as fow:
369 <a name="0"></a>            fow.write(salt.utils.stringutils.to_str("SignWith: {}\n".format(keyid)))
370         pkg_pub_key_file <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "{}/{}".format(
371             gnupghome, __salt__["pillar.get"]("gpg_pkg_pub_keyname", None)
372         )
373         pkg_priv_key_file = "{}/{}".format(
374             gnupghome, __salt__["pillar.get"]("gpg_pkg_priv_keyname", None)
375         )
376         if pkg_pub_key_file is None or pkg_priv_key_file is None:
377             raise SaltInvocationError(</b></font>
378                 "Pillar data should contain Public and Private keys associated with"
379                 " 'keyid'"
380             )
381         try:
382             __salt__["gpg.import_key"](
383                 user=runas, filename=pkg_pub_key_file, gnupghome=gnupghome
384             )
385             __salt__["gpg.import_key"](
386                 user=runas, filename=pkg_priv_key_file, gnupghome=gnupghome
387             )
388         except SaltInvocationError:
389             raise SaltInvocationError(
390                 "Public and Private key files associated with Pillar data and 'keyid' "
391                 "{} could not be found".format(keyid)
392             )
393         local_keys = __salt__["gpg.list_keys"](user=runas, gnupghome=gnupghome)
394         for gpg_key in local_keys:
395             if keyid == gpg_key["keyid"][8:]:
396                 local_keygrip_to_use = gpg_key["fingerprint"]
397                 local_key_fingerprint = gpg_key["fingerprint"]
398                 local_keyid = gpg_key["keyid"]
399                 break
400         if not older_gnupg:
401             try:
402                 _check_repo_sign_utils_support("gpg2")
403                 cmd = "gpg2 --with-keygrip --list-secret-keys"
404             except CommandExecutionError:
405                 cmd = "gpg --with-keygrip --list-secret-keys"
406             local_keys2_keygrip = __salt__["cmd.run"](cmd, runas=runas, env=env)
407             local_keys2 = iter(local_keys2_keygrip.splitlines())
408             try:
409                 for line in local_keys2:
410                     if line.startswith("sec"):
411                         line_fingerprint = next(local_keys2).lstrip().rstrip()
412                         if local_key_fingerprint == line_fingerprint:
413                             lkeygrip = next(local_keys2).split("=")
414                             local_keygrip_to_use = lkeygrip[1].lstrip().rstrip()
415                             break
416             except StopIteration:
417                 raise SaltInvocationError(
418                     "unable to find keygrip associated with fingerprint '{}' for keyid"
419                     " '{}'".format(local_key_fingerprint, local_keyid)
420                 )
421         if local_keyid is None:
422             raise SaltInvocationError(
423                 "The key ID '{}' was not found in GnuPG keyring at '{}'".format(
424                     keyid, gnupghome
425                 )
426             )
427         _check_repo_sign_utils_support("debsign")
428         if older_gnupg:
429             with salt.utils.files.fopen(gpg_info_file, "r") as fow:
430                 gpg_raw_info = fow.readlines()
431             for gpg_info_line in gpg_raw_info:
432                 gpg_info_line = salt.utils.stringutils.to_unicode(gpg_info_line)
433                 gpg_info = gpg_info_line.split("=")
434                 env[gpg_info[0]] = gpg_info[1]
435                 break
436         else:
437             with salt.utils.files.fopen(gpg_tty_info_file, "r") as fow:
438                 gpg_raw_info = fow.readlines()
439             for gpg_tty_info_line in gpg_raw_info:
440                 gpg_tty_info_line = salt.utils.stringutils.to_unicode(gpg_tty_info_line)
441                 gpg_tty_info = gpg_tty_info_line.split("=")
442                 env[gpg_tty_info[0]] = gpg_tty_info[1]
443                 break
444         if use_passphrase:
445             _check_repo_gpg_phrase_utils()
446             phrase = __salt__["pillar.get"]("gpg_passphrase")
447             cmd = (
448                 "/usr/lib/gnupg2/gpg-preset-passphrase --verbose --preset --passphrase"
449                 ' "{}" {}'.format(phrase, local_keygrip_to_use)
450             )
451             retrc |= __salt__["cmd.retcode"](cmd, runas=runas, env=env)
452     for debfile in os.listdir(repodir):
453         abs_file = os.path.join(repodir, debfile)
454         if debfile.endswith(".changes"):
455             os.remove(abs_file)
456         if debfile.endswith(".dsc"):
457             if older_gnupg:
458                 if local_keyid is not None:
459                     cmd = "debsign --re-sign -k {} {}".format(keyid, abs_file)
460                     retrc |= __salt__["cmd.retcode"](
461                         cmd, runas=runas, cwd=repodir, use_vt=True, env=env
462                     )
463                 cmd = (
464                     "reprepro --ignore=wrongdistribution --component=main -Vb ."
465                     " includedsc {} {}".format(codename, abs_file)
466                 )
467                 retrc |= __salt__["cmd.retcode"](
468                     cmd, runas=runas, cwd=repodir, use_vt=True, env=env
469                 )
470             else:
471                 interval = 0.5
472                 if local_keyid is not None:
473                     number_retries = timeout / interval
474                     times_looped = 0
475                     error_msg = "Failed to debsign file {}".format(abs_file)
476                     if (
477                         __grains__["os"] in ["Ubuntu"]
478                         and __grains__["osmajorrelease"] &lt; 18
479                     ) or (
480                         __grains__["os"] in ["Debian"]
481                         and __grains__["osmajorrelease"] &lt;= 8
482                     ):
483                         cmd = "debsign --re-sign -k {} {}".format(keyid, abs_file)
484                         try:
485                             proc = salt.utils.vt.Terminal(
486                                 cmd,
487                                 env=env,
488                                 shell=True,
489                                 stream_stdout=True,
490                                 stream_stderr=True,
491                             )
492                             while proc.has_unread_data:
493                                 stdout, _ = proc.recv()
494                                 if stdout and SIGN_PROMPT_RE.search(stdout):
495                                     proc.sendline(phrase)
496                                 else:
497                                     times_looped += 1
498                                 if times_looped &gt; number_retries:
499                                     raise SaltInvocationError(
500                                         "Attempting to sign file {} failed, timed out"
501                                         " after {} seconds".format(
502                                             abs_file, int(times_looped * interval)
503                                         )
504                                     )
505                                 time.sleep(interval)
506                             proc_exitstatus = proc.exitstatus
507                             if proc_exitstatus != 0:
508                                 raise SaltInvocationError(
509                                     "Signing file {} failed with proc.status {}".format(
510                                         abs_file, proc_exitstatus
511                                     )
512                                 )
513                         except salt.utils.vt.TerminalException as err:
514                             trace = traceback.format_exc()
515                             log.error(error_msg, err, trace)
516                             res = {"retcode": 1, "stdout": "", "stderr": trace}
517                         finally:
518                             proc.close(terminate=True, kill=True)
519                     else:
520                         cmd = "debsign --re-sign -k {} {}".format(
521                             local_key_fingerprint, abs_file
522                         )
523                         retrc |= __salt__["cmd.retcode"](
524                             cmd, runas=runas, cwd=repodir, use_vt=True, env=env
525                         )
526                 number_retries = timeout / interval
527                 times_looped = 0
528                 error_msg = "Failed to reprepro includedsc file {}".format(abs_file)
529                 cmd = (
530                     "reprepro --ignore=wrongdistribution --component=main -Vb ."
531                     " includedsc {} {}".format(codename, abs_file)
532                 )
533                 if (
534                     __grains__["os"] in ["Ubuntu"] and __grains__["osmajorrelease"] &lt; 18
535                 ) or (
536                     __grains__["os"] in ["Debian"] and __grains__["osmajorrelease"] &lt;= 8
537                 ):
538                     try:
539                         proc = salt.utils.vt.Terminal(
540                             cmd,
541                             env=env,
542                             shell=True,
543                             cwd=repodir,
544                             stream_stdout=True,
545                             stream_stderr=True,
546                         )
547                         while proc.has_unread_data:
548                             stdout, _ = proc.recv()
549                             if stdout and REPREPRO_SIGN_PROMPT_RE.search(stdout):
550                                 proc.sendline(phrase)
551                             else:
552                                 times_looped += 1
553                             if times_looped &gt; number_retries:
554                                 raise SaltInvocationError(
555                                     "Attempting to reprepro includedsc for file {}"
556                                     " failed, timed out after {} loops".format(
557                                         abs_file, times_looped
558                                     )
559                                 )
560                             time.sleep(interval)
561                         proc_exitstatus = proc.exitstatus
562                         if proc_exitstatus != 0:
563                             raise SaltInvocationError(
564                                 "Reprepro includedsc for codename {} and file {} failed"
565                                 " with proc.status {}".format(
566                                     codename, abs_file, proc_exitstatus
567                                 )
568                             )
569                     except salt.utils.vt.TerminalException as err:
570                         trace = traceback.format_exc()
571                         log.error(error_msg, err, trace)
572                         res = {"retcode": 1, "stdout": "", "stderr": trace}
573                     finally:
574                         proc.close(terminate=True, kill=True)
575                 else:
576                     retrc |= __salt__["cmd.retcode"](
577                         cmd, runas=runas, cwd=repodir, use_vt=True, env=env
578                     )
579         if retrc != 0:
580             raise SaltInvocationError(
581                 "Making a repo encountered errors, return error {}, check logs for"
582                 " further details".format(retrc)
583             )
584         if debfile.endswith(".deb"):
585             cmd = (
586                 "reprepro --ignore=wrongdistribution --component=main -Vb . includedeb"
587                 " {} {}".format(codename, abs_file)
588             )
589             res = __salt__["cmd.run_all"](
590                 cmd, runas=runas, cwd=repodir, use_vt=True, env=env
591             )
592     return res
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
