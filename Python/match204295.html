<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for modjk_1.py &amp; debuild_pkgbuild.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for modjk_1.py &amp; debuild_pkgbuild.py
      </h3>
<h1 align="center">
        1.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>modjk_1.py (3.3248081%)<th>debuild_pkgbuild.py (1.0638298%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(65-69)<td><a href="#" name="0">(725-733)</a><td align="center"><font color="#ff0000">13</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>modjk_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import urllib.parse
2 import urllib.request
3 def __virtual__():
4     return True
5 def _auth(url, user, passwd, realm):
6     basic = urllib.request.HTTPBasicAuthHandler()
7     basic.add_password(realm=realm, uri=url, user=user, passwd=passwd)
8     digest = urllib.request.HTTPDigestAuthHandler()
9     digest.add_password(realm=realm, uri=url, user=user, passwd=passwd)
10     return urllib.request.build_opener(basic, digest)
11 def _do_http(opts, profile="default"):
12     ret = {}
13     user = __salt__["config.get"]("modjk:{}:user".format(profile), "")
14     passwd = __salt__["config.get"]("modjk:{}:pass".format(profile), "")
15     realm <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= __salt__["config.get"]("modjk:{}:realm".format(profile), "")
16     timeout = __salt__["config.get"]("modjk:{}:timeout".format(profile), "")
17     if not url:
18         raise Exception(</b></font>"missing url in profile {}".format(profile))
19     if user and passwd:
20         auth = _auth(url=url, realm=realm, user=user, passwd=passwd)
21         urllib.request.install_opener(auth)
22     url += "?{}".format(urllib.parse.urlencode(opts))
23     for line in urllib.request.urlopen(url, timeout=timeout).read().splitlines():
24         splt = line.split("=", 1)
25         if splt[0] in ret:
26             ret[splt[0]] += ",{}".format(splt[1])
27         else:
28             ret[splt[0]] = splt[1]
29     return ret
30 def _worker_ctl(worker, lbn, vwa, profile="default"):
31     cmd = {
32         "cmd": "update",
33         "mime": "prop",
34         "w": lbn,
35         "sw": worker,
36         "vwa": vwa,
37     }
38     return _do_http(cmd, profile)["worker.result.type"] == "OK"
39 def version(profile="default"):
40     cmd = {
41         "cmd": "version",
42         "mime": "prop",
43     }
44     return _do_http(cmd, profile)["worker.jk_version"].split("/")[-1]
45 def get_running(profile="default"):
46     cmd = {
47         "cmd": "list",
48         "mime": "prop",
49     }
50     return _do_http(cmd, profile)
51 def dump_config(profile="default"):
52     cmd = {
53         "cmd": "dump",
54         "mime": "prop",
55     }
56     return _do_http(cmd, profile)
57 def list_configured_members(lbn, profile="default"):
58     config = dump_config(profile)
59     try:
60         ret = config["worker.{}.balance_workers".format(lbn)]
61     except KeyError:
62         return []
63     return [_f for _f in ret.strip().split(",") if _f]
64 def workers(profile="default"):
65     config = get_running(profile)
66     lbn = config["worker.list"].split(",")
67     worker_list = []
68     ret = {}
69     for lb in lbn:
70         try:
71             worker_list.extend(
72                 config["worker.{}.balance_workers".format(lb)].split(",")
73             )
74         except KeyError:
75             pass
76     worker_list = list(set(worker_list))
77     for worker in worker_list:
78         ret[worker] = {
79             "activation": config["worker.{}.activation".format(worker)],
80             "state": config["worker.{}.state".format(worker)],
81         }
82     return ret
83 def recover_all(lbn, profile="default"):
84     ret = {}
85     config = get_running(profile)
86     try:
87         workers_ = config["worker.{}.balance_workers".format(lbn)].split(",")
88     except KeyError:
89         return ret
90     for worker in workers_:
91         curr_state = worker_status(worker, profile)
92         if curr_state["activation"] != "ACT":
93             worker_activate(worker, lbn, profile)
94         if not curr_state["state"].startswith("OK"):
95             worker_recover(worker, lbn, profile)
96         ret[worker] = worker_status(worker, profile)
97     return ret
98 def reset_stats(lbn, profile="default"):
99     cmd = {
100         "cmd": "reset",
101         "mime": "prop",
102         "w": lbn,
103     }
104     return _do_http(cmd, profile)["worker.result.type"] == "OK"
105 def lb_edit(lbn, settings, profile="default"):
106     settings["cmd"] = "update"
107     settings["mime"] = "prop"
108     settings["w"] = lbn
109     return _do_http(settings, profile)["worker.result.type"] == "OK"
110 def bulk_stop(workers, lbn, profile="default"):
111     ret = {}
112     if isinstance(workers, str):
113         workers = workers.split(",")
114     for worker in workers:
115         try:
116             ret[worker] = worker_stop(worker, lbn, profile)
117         except Exception:  # pylint: disable=broad-except
118             ret[worker] = False
119     return ret
120 def bulk_activate(workers, lbn, profile="default"):
121     ret = {}
122     if isinstance(workers, str):
123         workers = workers.split(",")
124     for worker in workers:
125         try:
126             ret[worker] = worker_activate(worker, lbn, profile)
127         except Exception:  # pylint: disable=broad-except
128             ret[worker] = False
129     return ret
130 def bulk_disable(workers, lbn, profile="default"):
131     ret = {}
132     if isinstance(workers, str):
133         workers = workers.split(",")
134     for worker in workers:
135         try:
136             ret[worker] = worker_disable(worker, lbn, profile)
137         except Exception:  # pylint: disable=broad-except
138             ret[worker] = False
139     return ret
140 def bulk_recover(workers, lbn, profile="default"):
141     ret = {}
142     if isinstance(workers, str):
143         workers = workers.split(",")
144     for worker in workers:
145         try:
146             ret[worker] = worker_recover(worker, lbn, profile)
147         except Exception:  # pylint: disable=broad-except
148             ret[worker] = False
149     return ret
150 def worker_status(worker, profile="default"):
151     config = get_running(profile)
152     try:
153         return {
154             "activation": config["worker.{}.activation".format(worker)],
155             "state": config["worker.{}.state".format(worker)],
156         }
157     except KeyError:
158         return False
159 def worker_recover(worker, lbn, profile="default"):
160     cmd = {
161         "cmd": "recover",
162         "mime": "prop",
163         "w": lbn,
164         "sw": worker,
165     }
166     return _do_http(cmd, profile)
167 def worker_disable(worker, lbn, profile="default"):
168     return _worker_ctl(worker, lbn, "d", profile)
169 def worker_activate(worker, lbn, profile="default"):
170     return _worker_ctl(worker, lbn, "a", profile)
171 def worker_stop(worker, lbn, profile="default"):
172     return _worker_ctl(worker, lbn, "s", profile)
173 def worker_edit(worker, lbn, settings, profile="default"):
174     settings["cmd"] = "update"
175     settings["mime"] = "prop"
176     settings["w"] = lbn
177     settings["sw"] = worker
178     return _do_http(settings, profile)["worker.result.type"] == "OK"
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>debuild_pkgbuild.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import errno
2 import logging
3 import os
4 import re
5 import shutil
6 import tempfile
7 import time
8 import traceback
9 import urllib.parse
10 import salt.utils.files
11 import salt.utils.path
12 import salt.utils.stringutils
13 import salt.utils.vt
14 from salt.exceptions import CommandExecutionError, SaltInvocationError
15 HAS_LIBS = False
16 SIGN_PROMPT_RE = re.compile(r"Enter passphrase: ", re.M)
17 REPREPRO_SIGN_PROMPT_RE = re.compile(r"Passphrase: ", re.M)
18 try:
19     import gnupg  # pylint: disable=unused-import
20     import salt.modules.gpg
21     HAS_LIBS = True
22 except ImportError:
23     pass
24 log = logging.getLogger(__name__)
25 __virtualname__ = "pkgbuild"
26 def __virtual__():
27     if __grains__.get("os_family", False) in ("Kali", "Debian"):
28         missing_util = False
29         utils_reqd = ["gpg", "debuild", "pbuilder", "reprepro"]
30         for named_util in utils_reqd:
31             if not salt.utils.path.which(named_util):
32                 missing_util = True
33                 break
34         if HAS_LIBS and not missing_util:
35             return __virtualname__
36         else:
37             return (
38                 False,
39                 "The debbuild module could not be loaded: requires python-gnupg, gpg,"
40                 " debuild, pbuilder and reprepro utilities to be installed",
41             )
42     else:
43         return (False, "The debbuild module could not be loaded: unsupported OS family")
44 def _check_repo_sign_utils_support(name):
45     if salt.utils.path.which(name):
46         return True
47     else:
48         raise CommandExecutionError(
49             "utility '{}' needs to be installed or made available in search path".format(
50                 name
51             )
52         )
53 def _check_repo_gpg_phrase_utils():
54     util_name = "/usr/lib/gnupg2/gpg-preset-passphrase"
55     if __salt__["file.file_exists"](util_name):
56         return True
57     else:
58         raise CommandExecutionError(
59             "utility '{}' needs to be installed".format(util_name)
60         )
61 def _get_build_env(env):
62     env_override = ""
63     if env is None:
64         return env_override
65     if not isinstance(env, dict):
66         raise SaltInvocationError("'env' must be a Python dictionary")
67     for key, value in env.items():
68         env_override += "{}={}\n".format(key, value)
69         env_override += "export {}\n".format(key)
70     return env_override
71 def _get_repo_options_env(env):
72     env_options = ""
73     if env is None:
74         return env_options
75     if not isinstance(env, dict):
76         raise SaltInvocationError("'env' must be a Python dictionary")
77     for key, value in env.items():
78         if key == "OPTIONS":
79             env_options += "{}\n".format(value)
80     return env_options
81 def _get_repo_dists_env(env):
82     dflts_dict = {
83         "OPTIONS": ("I", "", "processed by _get_repo_options_env"),
84         "ORIGIN": ("O", "Origin", "SaltStack"),
85         "LABEL": ("O", "Label", "salt_debian"),
86         "SUITE": ("O", "Suite", "stable"),
87         "VERSION": ("O", "Version", "9.0"),
88         "CODENAME": ("M", "Codename", "stretch"),
89         "ARCHS": ("M", "Architectures", "i386 amd64 source"),
90         "COMPONENTS": ("M", "Components", "main"),
91         "DESCRIPTION": ("O", "Description", "SaltStack debian package repo"),
92     }
93     env_dists = ""
94     codename = ""
95     dflts_keys = list(dflts_dict.keys())
96     if env is None:
97         for key, value in dflts_dict.items():
98             if dflts_dict[key][0] == "M":
99                 env_dists += "{}: {}\n".format(dflts_dict[key][1], dflts_dict[key][2])
100                 if key == "CODENAME":
101                     codename = dflts_dict[key][2]
102         return (codename, env_dists)
103     if not isinstance(env, dict):
104         raise SaltInvocationError("'env' must be a Python dictionary")
105     env_man_seen = []
106     for key, value in env.items():
107         if key in dflts_keys:
108             if dflts_dict[key][0] == "M":
109                 env_man_seen.append(key)
110                 if key == "CODENAME":
111                     codename = value
112             if dflts_dict[key][0] != "I":
113                 env_dists += "{}: {}\n".format(dflts_dict[key][1], value)
114         else:
115             env_dists += "{}: {}\n".format(key, value)
116     env_keys = list(env.keys())
117     for key in env_keys:
118         if key in dflts_keys and dflts_dict[key][0] == "M" and key not in env_man_seen:
119             env_dists += "{}: {}\n".format(dflts_dict[key][1], dflts_dict[key][2])
120             if key == "CODENAME":
121                 codename = value
122     return (codename, env_dists)
123 def _create_pbuilders(env, runas="root"):
124     home = os.path.expanduser("~{}".format(runas))
125     pbuilderrc = os.path.join(home, ".pbuilderrc")
126     if not os.path.isfile(pbuilderrc):
127         raise SaltInvocationError("pbuilderrc environment is incorrectly setup")
128     env_overrides = _get_build_env(env)
129     if env_overrides and not env_overrides.isspace():
130         with salt.utils.files.fopen(pbuilderrc, "a") as fow:
131             fow.write(salt.utils.stringutils.to_str(env_overrides))
132     cmd = "chown {0}:{0} {1}".format(runas, pbuilderrc)
133     retrc = __salt__["cmd.retcode"](cmd, runas="root")
134     if retrc != 0:
135         raise SaltInvocationError(
136             "Create pbuilderrc in home directory failed with return error '{}', "
137             "check logs for further details".format(retrc)
138         )
139 def _mk_tree():
140     basedir = tempfile.mkdtemp()
141     return basedir
142 def _get_spec(tree_base, spec, saltenv="base"):
143     spec_tgt = os.path.basename(spec)
144     dest = os.path.join(tree_base, spec_tgt)
145     return __salt__["cp.get_url"](spec, dest, saltenv=saltenv)
146 def _get_src(tree_base, source, saltenv="base"):
147     parsed = urllib.parse.urlparse(source)
148     sbase = os.path.basename(source)
149     dest = os.path.join(tree_base, sbase)
150     if parsed.scheme:
151         __salt__["cp.get_url"](source, dest, saltenv=saltenv)
152     else:
153         shutil.copy(source, dest)
154 def make_src_pkg(dest_dir, spec, sources, env=None, saltenv="base", runas="root"):
155     _create_pbuilders(env, runas)
156     tree_base = _mk_tree()
157     ret = []
158     if not os.path.isdir(dest_dir):
159         os.makedirs(dest_dir)
160     root_user = "root"
161     retrc = 0
162     cmd = "chown {0}:{0} {1}".format(runas, tree_base)
163     retrc = __salt__["cmd.retcode"](cmd, runas="root")
164     if retrc != 0:
165         raise SaltInvocationError(
166             "make_src_pkg ensuring tree_base '{}' ownership failed with return error"
167             " '{}', check logs for further details".format(tree_base, retrc)
168         )
169     cmd = "chown {0}:{0} {1}".format(runas, dest_dir)
170     retrc = __salt__["cmd.retcode"](cmd, runas=root_user)
171     if retrc != 0:
172         raise SaltInvocationError(
173             "make_src_pkg ensuring dest_dir '{}' ownership failed with return error"
174             " '{}', check logs for further details".format(dest_dir, retrc)
175         )
176     spec_pathfile = _get_spec(tree_base, spec, saltenv)
177     if isinstance(sources, str):
178         sources = sources.split(",")
179     for src in sources:
180         _get_src(tree_base, src, saltenv)
181     if spec_pathfile.endswith(".dsc"):
182         for efile in os.listdir(tree_base):
183             full = os.path.join(tree_base, efile)
184             trgt = os.path.join(dest_dir, efile)
185             shutil.copy(full, trgt)
186             ret.append(trgt)
187         return ret
188     salttarball = None
189     for afile in os.listdir(tree_base):
190         if afile.startswith("salt-") and afile.endswith(".tar.gz"):
191             salttarball = afile
192             break
193     else:
194         return ret
195     frontname = salttarball.split(".tar.gz")
196     salttar_name = frontname[0]
197     k = salttar_name.rfind("-")
198     debname = salttar_name[:k] + "_" + salttar_name[k + 1 :]
199     debname += "+ds"
200     debname_orig = debname + ".orig.tar.gz"
201     abspath_debname = os.path.join(tree_base, debname)
202     cmd = "tar -xvzf {}".format(salttarball)
203     retrc = __salt__["cmd.retcode"](cmd, cwd=tree_base, runas=root_user)
204     cmd = "mv {} {}".format(salttar_name, debname)
205     retrc |= __salt__["cmd.retcode"](cmd, cwd=tree_base, runas=root_user)
206     cmd = "tar -cvzf {} {}".format(os.path.join(tree_base, debname_orig), debname)
207     retrc |= __salt__["cmd.retcode"](cmd, cwd=tree_base, runas=root_user)
208     cmd = "rm -f {}".format(salttarball)
209     retrc |= __salt__["cmd.retcode"](cmd, cwd=tree_base, runas=root_user, env=env)
210     cmd = "cp {}  {}".format(spec_pathfile, abspath_debname)
211     retrc |= __salt__["cmd.retcode"](cmd, cwd=abspath_debname, runas=root_user)
212     cmd = "tar -xvJf {}".format(spec_pathfile)
213     retrc |= __salt__["cmd.retcode"](cmd, cwd=abspath_debname, runas=root_user, env=env)
214     cmd = "rm -f {}".format(os.path.basename(spec_pathfile))
215     retrc |= __salt__["cmd.retcode"](cmd, cwd=abspath_debname, runas=root_user)
216     cmd = "debuild -S -uc -us -sa"
217     retrc |= __salt__["cmd.retcode"](
218         cmd, cwd=abspath_debname, runas=root_user, python_shell=True, env=env
219     )
220     cmd = "rm -fR {}".format(abspath_debname)
221     retrc |= __salt__["cmd.retcode"](cmd, runas=root_user)
222     if retrc != 0:
223         raise SaltInvocationError(
224             "Make source package for destination directory {}, spec {}, sources {},"
225             " failed with return error {}, check logs for further details".format(
226                 dest_dir, spec, sources, retrc
227             )
228         )
229     for dfile in os.listdir(tree_base):
230         if not dfile.endswith(".build"):
231             full = os.path.join(tree_base, dfile)
232             trgt = os.path.join(dest_dir, dfile)
233             shutil.copy(full, trgt)
234             ret.append(trgt)
235     return ret
236 def build(
237     runas,
238     tgt,
239     dest_dir,
240     spec,
241     sources,
242     deps,
243     env,
244     template,
245     saltenv="base",
246     log_dir="/var/log/salt/pkgbuild",
247 ):  # pylint: disable=unused-argument
248     ret = {}
249     retrc = 0
250     try:
251         os.makedirs(dest_dir)
252     except OSError as exc:
253         if exc.errno != errno.EEXIST:
254             raise
255     dsc_dir = tempfile.mkdtemp()
256     try:
257         dscs = make_src_pkg(dsc_dir, spec, sources, env, saltenv, runas)
258     except Exception as exc:  # pylint: disable=broad-except
259         shutil.rmtree(dsc_dir)
260         log.error("Failed to make src package, exception '%s'", exc)
261         return ret
262     root_user = "root"
263     if runas != root_user:
264         user_home = os.path.expanduser("~{}".format(runas))
265         root_home = os.path.expanduser("~root")
266         cmd = "cp {}/.pbuilderrc {}/".format(user_home, root_home)
267         retrc = __salt__["cmd.retcode"](
268             cmd, runas=root_user, python_shell=True, env=env
269         )
270         cmd = "cp -R {}/.pbuilder-hooks {}/".format(user_home, root_home)
271         retrc = __salt__["cmd.retcode"](
272             cmd, runas=root_user, python_shell=True, env=env
273         )
274         if retrc != 0:
275             raise SaltInvocationError(
276                 "build copy pbuilder files from '{}' to '{}' returned error '{}', "
277                 "check logs for further details".format(user_home, root_home, retrc)
278             )
279     cmd = "/usr/sbin/pbuilder --create"
280     retrc = __salt__["cmd.retcode"](cmd, runas=root_user, python_shell=True, env=env)
281     if retrc != 0:
282         raise SaltInvocationError(
283             "pbuilder create failed with return error '{}', "
284             "check logs for further details".format(retrc)
285         )
286     results_dir = "/var/cache/pbuilder/result"
287     cmd = "rm -fR {}".format(results_dir)
288     retrc |= __salt__["cmd.retcode"](cmd, runas=root_user, python_shell=True, env=env)
289     for dsc in dscs:
290         afile = os.path.basename(dsc)
291         os.path.join(dest_dir, afile)
292         if dsc.endswith(".dsc"):
293             dbase = os.path.dirname(dsc)
294             try:
295                 cmd = "chown {0}:{0} -R {1}".format(runas, dbase)
296                 retrc |= __salt__["cmd.retcode"](
297                     cmd, runas=root_user, python_shell=True, env=env
298                 )
299                 cmd = "/usr/sbin/pbuilder update --override-config"
300                 retrc |= __salt__["cmd.retcode"](
301                     cmd, runas=root_user, python_shell=True, env=env
302                 )
303                 cmd = '/usr/sbin/pbuilder build --debbuildopts "-sa" {}'.format(dsc)
304                 retrc |= __salt__["cmd.retcode"](
305                     cmd, runas=root_user, python_shell=True, env=env
306                 )
307                 if retrc != 0:
308                     raise SaltInvocationError(
309                         "pbuilder build or update failed with return error {}, "
310                         "check logs for further details".format(retrc)
311                     )
312                 for bfile in os.listdir(results_dir):
313                     if bfile != "Packages":
314                         full = os.path.join(results_dir, bfile)
315                         bdist = os.path.join(dest_dir, bfile)
316                         shutil.copy(full, bdist)
317                         ret.setdefault("Packages", []).append(bdist)
318             except Exception as exc:  # pylint: disable=broad-except
319                 log.error("Error building from '%s', execption '%s'", dsc, exc)
320     for pkgzfile in os.listdir(dest_dir):
321         if pkgzfile == "Packages":
322             pkgzabsfile = os.path.join(dest_dir, pkgzfile)
323             os.remove(pkgzabsfile)
324     cmd = "chown {0}:{0} -R {1}".format(runas, dest_dir)
325     __salt__["cmd.retcode"](cmd, runas=root_user, python_shell=True, env=env)
326     shutil.rmtree(dsc_dir)
327     return ret
328 def make_repo(
329     repodir,
330     keyid=None,
331     env=None,
332     use_passphrase=False,
333     gnupghome="/etc/salt/gpgkeys",
334     runas="root",
335     timeout=15.0,
336 ):
337     res = {"retcode": 1, "stdout": "", "stderr": "initialization value"}
338     retrc = 0
339     if gnupghome and env is None:
340         env = {}
341         env["GNUPGHOME"] = gnupghome
342     repoconf = os.path.join(repodir, "conf")
343     if not os.path.isdir(repoconf):
344         os.makedirs(repoconf)
345     codename, repocfg_dists = _get_repo_dists_env(env)
346     repoconfdist = os.path.join(repoconf, "distributions")
347     with salt.utils.files.fopen(repoconfdist, "w") as fow:
348         fow.write(salt.utils.stringutils.to_str(repocfg_dists))
349     repocfg_opts = _get_repo_options_env(env)
350     repoconfopts = os.path.join(repoconf, "options")
351     with salt.utils.files.fopen(repoconfopts, "w") as fow:
352         fow.write(salt.utils.stringutils.to_str(repocfg_opts))
353     cmd = "chown {0}:{0} -R {1}".format(runas, repoconf)
354     retrc = __salt__["cmd.retcode"](cmd, runas="root")
355     if retrc != 0:
356         raise SaltInvocationError(
357             "failed to ensure rights to repoconf directory, error {}, "
358             "check logs for further details".format(retrc)
359         )
360     local_keygrip_to_use = None
361     local_key_fingerprint = None
362     local_keyid = None
363     phrase = ""
364     gpg_info_file = "{}/gpg-agent-info-salt".format(gnupghome)
365     gpg_tty_info_file = "{}/gpg-tty-info-salt".format(gnupghome)
366     older_gnupg = __salt__["file.file_exists"](gpg_info_file)
367     if keyid is not None:
368         with salt.utils.files.fopen(repoconfdist, "a") as fow:
369         pkg_pub_key_file <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "{}/{}".format(
370             gnupghome, __salt__["pillar.get"]("gpg_pkg_pub_keyname", None)
371         )
372         pkg_priv_key_file = "{}/{}".format(
373             gnupghome, __salt__["pillar.get"]("gpg_pkg_priv_keyname", None)
374         )
375         if pkg_pub_key_file is None or pkg_priv_key_file is None:
376             raise SaltInvocationError(</b></font>
377                 "Pillar data should contain Public and Private keys associated with"
378                 " 'keyid'"
379             )
380         try:
381             __salt__["gpg.import_key"](
382                 user=runas, filename=pkg_pub_key_file, gnupghome=gnupghome
383             )
384             __salt__["gpg.import_key"](
385                 user=runas, filename=pkg_priv_key_file, gnupghome=gnupghome
386             )
387         except SaltInvocationError:
388             raise SaltInvocationError(
389                 "Public and Private key files associated with Pillar data and 'keyid' "
390                 "{} could not be found".format(keyid)
391             )
392         local_keys = __salt__["gpg.list_keys"](user=runas, gnupghome=gnupghome)
393         for gpg_key in local_keys:
394             if keyid == gpg_key["keyid"][8:]:
395                 local_keygrip_to_use = gpg_key["fingerprint"]
396                 local_key_fingerprint = gpg_key["fingerprint"]
397                 local_keyid = gpg_key["keyid"]
398                 break
399         if not older_gnupg:
400             try:
401                 _check_repo_sign_utils_support("gpg2")
402                 cmd = "gpg2 --with-keygrip --list-secret-keys"
403             except CommandExecutionError:
404                 cmd = "gpg --with-keygrip --list-secret-keys"
405             local_keys2_keygrip = __salt__["cmd.run"](cmd, runas=runas, env=env)
406             local_keys2 = iter(local_keys2_keygrip.splitlines())
407             try:
408                 for line in local_keys2:
409                     if line.startswith("sec"):
410                         line_fingerprint = next(local_keys2).lstrip().rstrip()
411                         if local_key_fingerprint == line_fingerprint:
412                             lkeygrip = next(local_keys2).split("=")
413                             local_keygrip_to_use = lkeygrip[1].lstrip().rstrip()
414                             break
415             except StopIteration:
416                 raise SaltInvocationError(
417                     "unable to find keygrip associated with fingerprint '{}' for keyid"
418                     " '{}'".format(local_key_fingerprint, local_keyid)
419                 )
420         if local_keyid is None:
421             raise SaltInvocationError(
422                 "The key ID '{}' was not found in GnuPG keyring at '{}'".format(
423                     keyid, gnupghome
424                 )
425             )
426         _check_repo_sign_utils_support("debsign")
427         if older_gnupg:
428             with salt.utils.files.fopen(gpg_info_file, "r") as fow:
429                 gpg_raw_info = fow.readlines()
430             for gpg_info_line in gpg_raw_info:
431                 gpg_info_line = salt.utils.stringutils.to_unicode(gpg_info_line)
432                 gpg_info = gpg_info_line.split("=")
433                 env[gpg_info[0]] = gpg_info[1]
434                 break
435         else:
436             with salt.utils.files.fopen(gpg_tty_info_file, "r") as fow:
437                 gpg_raw_info = fow.readlines()
438             for gpg_tty_info_line in gpg_raw_info:
439                 gpg_tty_info_line = salt.utils.stringutils.to_unicode(gpg_tty_info_line)
440                 gpg_tty_info = gpg_tty_info_line.split("=")
441                 env[gpg_tty_info[0]] = gpg_tty_info[1]
442                 break
443         if use_passphrase:
444             _check_repo_gpg_phrase_utils()
445             phrase = __salt__["pillar.get"]("gpg_passphrase")
446             cmd = (
447                 "/usr/lib/gnupg2/gpg-preset-passphrase --verbose --preset --passphrase"
448                 ' "{}" {}'.format(phrase, local_keygrip_to_use)
449             )
450             retrc |= __salt__["cmd.retcode"](cmd, runas=runas, env=env)
451     for debfile in os.listdir(repodir):
452         abs_file = os.path.join(repodir, debfile)
453         if debfile.endswith(".changes"):
454             os.remove(abs_file)
455         if debfile.endswith(".dsc"):
456             if older_gnupg:
457                 if local_keyid is not None:
458                     cmd = "debsign --re-sign -k {} {}".format(keyid, abs_file)
459                     retrc |= __salt__["cmd.retcode"](
460                         cmd, runas=runas, cwd=repodir, use_vt=True, env=env
461                     )
462                 cmd = (
463                     "reprepro --ignore=wrongdistribution --component=main -Vb ."
464                     " includedsc {} {}".format(codename, abs_file)
465                 )
466                 retrc |= __salt__["cmd.retcode"](
467                     cmd, runas=runas, cwd=repodir, use_vt=True, env=env
468                 )
469             else:
470                 interval = 0.5
471                 if local_keyid is not None:
472                     number_retries = timeout / interval
473                     times_looped = 0
474                     error_msg = "Failed to debsign file {}".format(abs_file)
475                     if (
476                         __grains__["os"] in ["Ubuntu"]
477                         and __grains__["osmajorrelease"] &lt; 18
478                     ) or (
479                         __grains__["os"] in ["Debian"]
480                         and __grains__["osmajorrelease"] &lt;= 8
481                     ):
482                         cmd = "debsign --re-sign -k {} {}".format(keyid, abs_file)
483                         try:
484                             proc = salt.utils.vt.Terminal(
485                                 cmd,
486                                 env=env,
487                                 shell=True,
488                                 stream_stdout=True,
489                                 stream_stderr=True,
490                             )
491                             while proc.has_unread_data:
492                                 stdout, _ = proc.recv()
493                                 if stdout and SIGN_PROMPT_RE.search(stdout):
494                                     proc.sendline(phrase)
495                                 else:
496                                     times_looped += 1
497                                 if times_looped &gt; number_retries:
498                                     raise SaltInvocationError(
499                                         "Attempting to sign file {} failed, timed out"
500                                         " after {} seconds".format(
501                                             abs_file, int(times_looped * interval)
502                                         )
503                                     )
504                                 time.sleep(interval)
505                             proc_exitstatus = proc.exitstatus
506                             if proc_exitstatus != 0:
507                                 raise SaltInvocationError(
508                                     "Signing file {} failed with proc.status {}".format(
509                                         abs_file, proc_exitstatus
510                                     )
511                                 )
512                         except salt.utils.vt.TerminalException as err:
513                             trace = traceback.format_exc()
514                             log.error(error_msg, err, trace)
515                             res = {"retcode": 1, "stdout": "", "stderr": trace}
516                         finally:
517                             proc.close(terminate=True, kill=True)
518                     else:
519                         cmd = "debsign --re-sign -k {} {}".format(
520                             local_key_fingerprint, abs_file
521                         )
522                         retrc |= __salt__["cmd.retcode"](
523                             cmd, runas=runas, cwd=repodir, use_vt=True, env=env
524                         )
525                 number_retries = timeout / interval
526                 times_looped = 0
527                 error_msg = "Failed to reprepro includedsc file {}".format(abs_file)
528                 cmd = (
529                     "reprepro --ignore=wrongdistribution --component=main -Vb ."
530                     " includedsc {} {}".format(codename, abs_file)
531                 )
532                 if (
533                     __grains__["os"] in ["Ubuntu"] and __grains__["osmajorrelease"] &lt; 18
534                 ) or (
535                     __grains__["os"] in ["Debian"] and __grains__["osmajorrelease"] &lt;= 8
536                 ):
537                     try:
538                         proc = salt.utils.vt.Terminal(
539                             cmd,
540                             env=env,
541                             shell=True,
542                             cwd=repodir,
543                             stream_stdout=True,
544                             stream_stderr=True,
545                         )
546                         while proc.has_unread_data:
547                             stdout, _ = proc.recv()
548                             if stdout and REPREPRO_SIGN_PROMPT_RE.search(stdout):
549                                 proc.sendline(phrase)
550                             else:
551                                 times_looped += 1
552                             if times_looped &gt; number_retries:
553                                 raise SaltInvocationError(
554                                     "Attempting to reprepro includedsc for file {}"
555                                     " failed, timed out after {} loops".format(
556                                         abs_file, times_looped
557                                     )
558                                 )
559                             time.sleep(interval)
560                         proc_exitstatus = proc.exitstatus
561                         if proc_exitstatus != 0:
562                             raise SaltInvocationError(
563                                 "Reprepro includedsc for codename {} and file {} failed"
564                                 " with proc.status {}".format(
565                                     codename, abs_file, proc_exitstatus
566                                 )
567                             )
568                     except salt.utils.vt.TerminalException as err:
569                         trace = traceback.format_exc()
570                         log.error(error_msg, err, trace)
571                         res = {"retcode": 1, "stdout": "", "stderr": trace}
572                     finally:
573                         proc.close(terminate=True, kill=True)
574                 else:
575                     retrc |= __salt__["cmd.retcode"](
576                         cmd, runas=runas, cwd=repodir, use_vt=True, env=env
577                     )
578         if retrc != 0:
579             raise SaltInvocationError(
580                 "Making a repo encountered errors, return error {}, check logs for"
581                 " further details".format(retrc)
582             )
583         if debfile.endswith(".deb"):
584             cmd = (
585                 "reprepro --ignore=wrongdistribution --component=main -Vb . includedeb"
586                 " {} {}".format(codename, abs_file)
587             )
588             res = __salt__["cmd.run_all"](
589                 cmd, runas=runas, cwd=repodir, use_vt=True, env=env
590             )
591     return res
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
