<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_arguments.py & test_chroot.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_arguments.py & test_chroot.py
      </h3>
      <h1 align="center">
        5.3%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_arguments.py (29.268293%)<TH>test_chroot.py (2.9629629%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match55456-0.html#0',2,'match55456-1.html#0',3)" NAME="0">(36-50)<TD><A HREF="javascript:ZweiFrames('match55456-0.html#0',2,'match55456-1.html#0',3)" NAME="0">(91-99)</A><TD ALIGN=center><FONT COLOR="#ff0000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_arguments.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    Test Salt's argument parser
&quot;&quot;&quot;

import pytest
import salt.utils.args
from tests.support.case import ModuleCase


@pytest.mark.requires_salt_modules(&quot;test.ping&quot;, &quot;test.arg&quot;)
@pytest.mark.windows_whitelisted
class ArgumentTestCase(ModuleCase):
    @pytest.mark.slow_test
    def test_unsupported_kwarg(self):
        &quot;&quot;&quot;
        Test passing a non-supported keyword argument. The relevant code that
        checks for invalid kwargs is located in salt/minion.py, within the
        'load_args_and_kwargs' function.
        &quot;&quot;&quot;
        self.assertIn(
            &quot;ERROR executing 'test.ping': The following keyword arguments&quot;,
            self.run_function(&quot;test.ping&quot;, foo=&quot;bar&quot;),
        )

    @pytest.mark.slow_test
    def test_kwarg_name_containing_dashes(self):
        &quot;&quot;&quot;
        Tests the arg parser to ensure that kwargs with dashes in the arg name
        are properly identified as kwargs. If this fails, then the KWARG_REGEX
        variable in salt/utils/__init__.py needs to be fixed.
        &quot;&quot;&quot;
        # We need to use parse_input here because run_function now requires
<A NAME="0"></A>        # kwargs to be passed in as *actual* kwargs, and dashes are not valid
        # characters in Python kwargs.
        self.assertEqual(
            self.run_function(&quot;test.arg&quot;, salt.utils.args<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match55456-1.html#0',3,'match55456-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.parse_input([&quot;foo-bar=baz&quot;]))
            .get(&quot;kwargs&quot;, {})
            .get(&quot;foo-bar&quot;),
            &quot;baz&quot;,
        )

    @pytest.mark.slow_test
    def test_argument_containing_pound_sign(self):
        &quot;&quot;&quot;
        Tests the argument parsing to ensure that a CLI argument with a pound
        sign doesn't have the pound sign interpreted as a comment and removed.
        See https://github.com/saltstack/salt/issues/8585 for more info.
        &quot;&quot;&quot;
        arg = &quot;foo bar #baz&quot;
        self.</B></FONT>assertEqual(self.run_function(&quot;test.echo&quot;, [arg]), arg)
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_chroot.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
#
# Author: Alberto Planas &lt;aplanas@suse.com&gt;
#
# Copyright 2018 SUSE LINUX GmbH, Nuernberg, Germany.
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# &quot;License&quot;); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

&quot;&quot;&quot;
:maintainer:    Alberto Planas &lt;aplanas@suse.com&gt;
:platform:      Linux
&quot;&quot;&quot;

import sys

import salt.loader.context
import salt.modules.chroot as chroot
import salt.utils.platform
from salt.exceptions import CommandExecutionError
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import MagicMock, patch
from tests.support.unit import TestCase, skipIf


@skipIf(salt.utils.platform.is_windows(), &quot;This test cannot work on Windows&quot;)
class ChrootTestCase(TestCase, LoaderModuleMockMixin):
    &quot;&quot;&quot;
    Test cases for salt.modules.chroot
    &quot;&quot;&quot;

    def setup_loader_modules(self):
        loader_context = salt.loader.context.LoaderContext()
        return {
            chroot: {
                &quot;__salt__&quot;: {},
                &quot;__utils__&quot;: {&quot;files.rm_rf&quot;: MagicMock()},
                &quot;__opts__&quot;: {&quot;extension_modules&quot;: &quot;&quot;, &quot;cachedir&quot;: &quot;/tmp/&quot;},
                &quot;__pillar__&quot;: salt.loader.context.NamedLoaderContext(
                    &quot;__pillar__&quot;, loader_context, {}
                ),
            }
        }

    def test__create_and_execute_salt_state(self):
        with patch(
            &quot;salt.client.ssh.wrapper.state._cleanup_slsmod_low_data&quot;, MagicMock()
        ):
            with patch(
                &quot;salt.utils.hashutils.get_hash&quot;, MagicMock(return_value=&quot;deadbeaf&quot;)
            ):
                with patch(&quot;salt.fileclient.get_file_client&quot;, MagicMock()):
                    with patch(&quot;salt.modules.chroot.call&quot;, MagicMock()):
                        chroot._create_and_execute_salt_state(&quot;&quot;, {}, {}, False, &quot;md5&quot;)

    @patch(&quot;os.path.isdir&quot;)
    def test_exist(self, isdir):
        &quot;&quot;&quot;
        Test if the chroot environment exist.
        &quot;&quot;&quot;
        isdir.side_effect = (True, True, True, True)
        self.assertTrue(chroot.exist(&quot;/chroot&quot;))

        isdir.side_effect = (True, True, True, False)
        self.assertFalse(chroot.exist(&quot;/chroot&quot;))

    @patch(&quot;os.makedirs&quot;)
    @patch(&quot;salt.modules.chroot.exist&quot;)
    def test_create(self, exist, makedirs):
        &quot;&quot;&quot;
        Test the creation of an empty chroot environment.
        &quot;&quot;&quot;
        exist.return_value = True
        self.assertTrue(chroot.create(&quot;/chroot&quot;))
<A NAME="0"></A>        makedirs.assert_not_called()

        exist.return_value = False
        self<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match55456-0.html#0',2,'match55456-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.assertTrue(chroot.create(&quot;/chroot&quot;))
        makedirs.assert_called()

    @patch(&quot;salt.utils.files.fopen&quot;)
    def test_in_chroot(self, fopen):
        &quot;&quot;&quot;
        Test the detection of chroot environment.
        &quot;&quot;&quot;
        matrix = ((</B></FONT>&quot;a&quot;, &quot;b&quot;, True), (&quot;a&quot;, &quot;a&quot;, False))
        for root_mountinfo, self_mountinfo, result in matrix:
            fopen.return_value.__enter__.return_value = fopen
            fopen.read = MagicMock(side_effect=(root_mountinfo, self_mountinfo))
            self.assertEqual(chroot.in_chroot(), result)

    @patch(&quot;salt.modules.chroot.exist&quot;)
    def test_call_fails_input_validation(self, exist):
        &quot;&quot;&quot;
        Test execution of Salt functions in chroot.
        &quot;&quot;&quot;
        # Basic input validation
        exist.return_value = False
        self.assertRaises(CommandExecutionError, chroot.call, &quot;/chroot&quot;, &quot;&quot;)
        self.assertRaises(CommandExecutionError, chroot.call, &quot;/chroot&quot;, &quot;test.ping&quot;)

    @patch(&quot;salt.modules.chroot.exist&quot;)
    @patch(&quot;tempfile.mkdtemp&quot;)
    def test_call_fails_untar(self, mkdtemp, exist):
        &quot;&quot;&quot;
        Test execution of Salt functions in chroot.
        &quot;&quot;&quot;
        # Fail the tar command
        exist.return_value = True
        mkdtemp.return_value = &quot;/chroot/tmp01&quot;
        utils_mock = {
            &quot;thin.gen_thin&quot;: MagicMock(return_value=&quot;/salt-thin.tgz&quot;),
            &quot;files.rm_rf&quot;: MagicMock(),
        }
        salt_mock = {
            &quot;cmd.run&quot;: MagicMock(return_value=&quot;Error&quot;),
            &quot;config.option&quot;: MagicMock(),
        }
        with patch.dict(chroot.__utils__, utils_mock), patch.dict(
            chroot.__salt__, salt_mock
        ):
            self.assertEqual(
                chroot.call(&quot;/chroot&quot;, &quot;test.ping&quot;),
                {&quot;result&quot;: False, &quot;comment&quot;: &quot;Error&quot;},
            )
            utils_mock[&quot;thin.gen_thin&quot;].assert_called_once()
            salt_mock[&quot;config.option&quot;].assert_called()
            salt_mock[&quot;cmd.run&quot;].assert_called_once()
            utils_mock[&quot;files.rm_rf&quot;].assert_called_once()

    @patch(&quot;salt.modules.chroot.exist&quot;)
    @patch(&quot;tempfile.mkdtemp&quot;)
    def test_call_fails_salt_thin(self, mkdtemp, exist):
        &quot;&quot;&quot;
        Test execution of Salt functions in chroot.
        &quot;&quot;&quot;
        # Fail the inner command
        exist.return_value = True
        mkdtemp.return_value = &quot;/chroot/tmp01&quot;
        utils_mock = {
            &quot;thin.gen_thin&quot;: MagicMock(return_value=&quot;/salt-thin.tgz&quot;),
            &quot;files.rm_rf&quot;: MagicMock(),
            &quot;json.find_json&quot;: MagicMock(side_effect=ValueError()),
        }
        salt_mock = {
            &quot;cmd.run&quot;: MagicMock(return_value=&quot;&quot;),
            &quot;config.option&quot;: MagicMock(),
            &quot;cmd.run_chroot&quot;: MagicMock(
                return_value={&quot;retcode&quot;: 1, &quot;stdout&quot;: &quot;&quot;, &quot;stderr&quot;: &quot;Error&quot;}
            ),
        }
        with patch.dict(chroot.__utils__, utils_mock), patch.dict(
            chroot.__salt__, salt_mock
        ):
            self.assertEqual(
                chroot.call(&quot;/chroot&quot;, &quot;test.ping&quot;),
                {
                    &quot;result&quot;: False,
                    &quot;retcode&quot;: 1,
                    &quot;comment&quot;: {&quot;stdout&quot;: &quot;&quot;, &quot;stderr&quot;: &quot;Error&quot;},
                },
            )
            utils_mock[&quot;thin.gen_thin&quot;].assert_called_once()
            salt_mock[&quot;config.option&quot;].assert_called()
            salt_mock[&quot;cmd.run&quot;].assert_called_once()
            salt_mock[&quot;cmd.run_chroot&quot;].assert_called_with(
                &quot;/chroot&quot;,
                [
                    &quot;python{}&quot;.format(sys.version_info[0]),
                    &quot;/tmp01/salt-call&quot;,
                    &quot;--metadata&quot;,
                    &quot;--local&quot;,
                    &quot;--log-file&quot;,
                    &quot;/tmp01/log&quot;,
                    &quot;--cachedir&quot;,
                    &quot;/tmp01/cache&quot;,
                    &quot;--out&quot;,
                    &quot;json&quot;,
                    &quot;-l&quot;,
                    &quot;quiet&quot;,
                    &quot;--&quot;,
                    &quot;test.ping&quot;,
                ],
            )
            utils_mock[&quot;files.rm_rf&quot;].assert_called_once()

    @patch(&quot;salt.modules.chroot.exist&quot;)
    @patch(&quot;tempfile.mkdtemp&quot;)
    def test_call_success(self, mkdtemp, exist):
        &quot;&quot;&quot;
        Test execution of Salt functions in chroot.
        &quot;&quot;&quot;
        # Success test
        exist.return_value = True
        mkdtemp.return_value = &quot;/chroot/tmp01&quot;
        utils_mock = {
            &quot;thin.gen_thin&quot;: MagicMock(return_value=&quot;/salt-thin.tgz&quot;),
            &quot;files.rm_rf&quot;: MagicMock(),
            &quot;json.find_json&quot;: MagicMock(return_value={&quot;return&quot;: &quot;result&quot;}),
        }
        salt_mock = {
            &quot;cmd.run&quot;: MagicMock(return_value=&quot;&quot;),
            &quot;config.option&quot;: MagicMock(),
            &quot;cmd.run_chroot&quot;: MagicMock(return_value={&quot;retcode&quot;: 0, &quot;stdout&quot;: &quot;&quot;}),
        }
        with patch.dict(chroot.__utils__, utils_mock), patch.dict(
            chroot.__salt__, salt_mock
        ):
            self.assertEqual(chroot.call(&quot;/chroot&quot;, &quot;test.ping&quot;), &quot;result&quot;)
            utils_mock[&quot;thin.gen_thin&quot;].assert_called_once()
            salt_mock[&quot;config.option&quot;].assert_called()
            salt_mock[&quot;cmd.run&quot;].assert_called_once()
            salt_mock[&quot;cmd.run_chroot&quot;].assert_called_with(
                &quot;/chroot&quot;,
                [
                    &quot;python{}&quot;.format(sys.version_info[0]),
                    &quot;/tmp01/salt-call&quot;,
                    &quot;--metadata&quot;,
                    &quot;--local&quot;,
                    &quot;--log-file&quot;,
                    &quot;/tmp01/log&quot;,
                    &quot;--cachedir&quot;,
                    &quot;/tmp01/cache&quot;,
                    &quot;--out&quot;,
                    &quot;json&quot;,
                    &quot;-l&quot;,
                    &quot;quiet&quot;,
                    &quot;--&quot;,
                    &quot;test.ping&quot;,
                ],
            )
            utils_mock[&quot;files.rm_rf&quot;].assert_called_once()

    @patch(&quot;salt.modules.chroot.exist&quot;)
    @patch(&quot;tempfile.mkdtemp&quot;)
    def test_call_success_parameters(self, mkdtemp, exist):
        &quot;&quot;&quot;
        Test execution of Salt functions in chroot with parameters.
        &quot;&quot;&quot;
        # Success test
        exist.return_value = True
        mkdtemp.return_value = &quot;/chroot/tmp01&quot;
        utils_mock = {
            &quot;thin.gen_thin&quot;: MagicMock(return_value=&quot;/salt-thin.tgz&quot;),
            &quot;files.rm_rf&quot;: MagicMock(),
            &quot;json.find_json&quot;: MagicMock(return_value={&quot;return&quot;: &quot;result&quot;}),
        }
        salt_mock = {
            &quot;cmd.run&quot;: MagicMock(return_value=&quot;&quot;),
            &quot;config.option&quot;: MagicMock(),
            &quot;cmd.run_chroot&quot;: MagicMock(return_value={&quot;retcode&quot;: 0, &quot;stdout&quot;: &quot;&quot;}),
        }
        with patch.dict(chroot.__utils__, utils_mock), patch.dict(
            chroot.__salt__, salt_mock
        ):
            self.assertEqual(
                chroot.call(&quot;/chroot&quot;, &quot;module.function&quot;, key=&quot;value&quot;), &quot;result&quot;
            )
            utils_mock[&quot;thin.gen_thin&quot;].assert_called_once()
            salt_mock[&quot;config.option&quot;].assert_called()
            salt_mock[&quot;cmd.run&quot;].assert_called_once()
            salt_mock[&quot;cmd.run_chroot&quot;].assert_called_with(
                &quot;/chroot&quot;,
                [
                    &quot;python{}&quot;.format(sys.version_info[0]),
                    &quot;/tmp01/salt-call&quot;,
                    &quot;--metadata&quot;,
                    &quot;--local&quot;,
                    &quot;--log-file&quot;,
                    &quot;/tmp01/log&quot;,
                    &quot;--cachedir&quot;,
                    &quot;/tmp01/cache&quot;,
                    &quot;--out&quot;,
                    &quot;json&quot;,
                    &quot;-l&quot;,
                    &quot;quiet&quot;,
                    &quot;--&quot;,
                    &quot;module.function&quot;,
                    &quot;key=value&quot;,
                ],
            )
            utils_mock[&quot;files.rm_rf&quot;].assert_called_once()

    @patch(&quot;salt.modules.chroot._create_and_execute_salt_state&quot;)
    @patch(&quot;salt.client.ssh.state.SSHHighState&quot;)
    @patch(&quot;salt.fileclient.get_file_client&quot;)
    @patch(&quot;salt.utils.state.get_sls_opts&quot;)
    def test_sls(
        self,
        get_sls_opts,
        get_file_client,
        SSHHighState,
        _create_and_execute_salt_state,
    ):
        &quot;&quot;&quot;
        Test execution of Salt states in chroot.
        &quot;&quot;&quot;
        SSHHighState.return_value = SSHHighState
        SSHHighState.render_highstate.return_value = (None, [])
        SSHHighState.state.reconcile_extend.return_value = (None, [])
        SSHHighState.state.requisite_in.return_value = (None, [])
        SSHHighState.state.verify_high.return_value = []

        _create_and_execute_salt_state.return_value = &quot;result&quot;
        opts_mock = {
            &quot;hash_type&quot;: &quot;md5&quot;,
        }
        get_sls_opts.return_value = opts_mock
        with patch.dict(chroot.__opts__, opts_mock):
            self.assertEqual(chroot.sls(&quot;/chroot&quot;, &quot;module&quot;), &quot;result&quot;)
            _create_and_execute_salt_state.assert_called_once()

    @patch(&quot;salt.modules.chroot._create_and_execute_salt_state&quot;)
    @patch(&quot;salt.client.ssh.state.SSHHighState&quot;)
    @patch(&quot;salt.fileclient.get_file_client&quot;)
    @patch(&quot;salt.utils.state.get_sls_opts&quot;)
    def test_highstate(
        self,
        get_sls_opts,
        get_file_client,
        SSHHighState,
        _create_and_execute_salt_state,
    ):
        &quot;&quot;&quot;
        Test execution of Salt states in chroot.
        &quot;&quot;&quot;
        SSHHighState.return_value = SSHHighState

        _create_and_execute_salt_state.return_value = &quot;result&quot;
        opts_mock = {
            &quot;hash_type&quot;: &quot;md5&quot;,
        }
        get_sls_opts.return_value = opts_mock
        with patch.dict(chroot.__opts__, opts_mock):
            self.assertEqual(chroot.highstate(&quot;/chroot&quot;), &quot;result&quot;)
            _create_and_execute_salt_state.assert_called_once()
</PRE>
</div>
  </div>
</body>
</html>
