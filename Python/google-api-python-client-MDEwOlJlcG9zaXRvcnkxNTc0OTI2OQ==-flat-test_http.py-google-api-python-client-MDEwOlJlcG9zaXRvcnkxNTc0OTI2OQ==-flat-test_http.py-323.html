
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 16, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>google-api-python-client-MDEwOlJlcG9zaXRvcnkxNTc0OTI2OQ==-flat-test_http.py</h3>
            <pre><code>1  #!/usr/bin/env python
2  from __future__ import absolute_import
3  __author__ = &quot;jcgregorio@google.com (Joe Gregorio)&quot;
4  import io
5  from io import FileIO
6  import json
7  import logging
8  import os
9  import random
10  import socket
11  import ssl
12  import time
13  import unittest
14  from unittest import mock
15  import urllib
16  import httplib2
17  from googleapiclient.discovery import build
18  from googleapiclient.errors import BatchError, HttpError, InvalidChunkSizeError
19  from googleapiclient.http import (
20      MAX_URI_LENGTH,
21      BatchHttpRequest,
22      HttpMock,
23      HttpMockSequence,
24      HttpRequest,
25      MediaFileUpload,
26      MediaInMemoryUpload,
27      MediaIoBaseDownload,
28      MediaIoBaseUpload,
29      MediaUpload,
30      _StreamSlice,
31      build_http,
32      set_user_agent,
33  )
34  from googleapiclient.model import JsonModel
35  class MockCredentials:
36      def __init__(self, bearer_token, expired=False):
37          super(MockCredentials, self).__init__()
38          self._authorized = 0
39          self._refreshed = 0
40          self._applied = 0
41          self._bearer_token = bearer_token
42          self._access_token_expired = expired
43      @property
44      def access_token(self):
45          return self._bearer_token
46      @property
47      def access_token_expired(self):
48          return self._access_token_expired
49      def authorize(self, http):
50          self._authorized += 1
51          request_orig = http.request
52          def new_request(
53              uri,
54              method=&quot;GET&quot;,
55              body=None,
56              headers=None,
57              redirections=httplib2.DEFAULT_MAX_REDIRECTS,
58              connection_type=None,
59          ):
60              if headers is None:
61                  headers = {}
62              self.apply(headers)
63              resp, content = request_orig(
64                  uri, method, body, headers, redirections, connection_type
65              )
66              return resp, content
67          http.request = new_request
68          setattr(http.request, &quot;credentials&quot;, self)
69          return http
70      def refresh(self, http):
71          self._refreshed += 1
72      def apply(self, headers):
73          self._applied += 1
74          headers[&quot;authorization&quot;] = self._bearer_token + &quot; &quot; + str(self._refreshed)
75  class HttpMockWithErrors(object):
76      def __init__(self, num_errors, success_json, success_data):
77          self.num_errors = num_errors
78          self.success_json = success_json
79          self.success_data = success_data
80      def request(self, *args, **kwargs):
81          if not self.num_errors:
82              return httplib2.Response(self.success_json), self.success_data
83          elif self.num_errors == 5:
84              ex = ConnectionResetError  # noqa: F821
85          elif self.num_errors == 4:
86              ex = httplib2.ServerNotFoundError()
87          elif self.num_errors == 3:
88              ex = OSError()
89              ex.errno = socket.errno.EPIPE
90          elif self.num_errors == 2:
91              ex = ssl.SSLError()
92          else:
93              try:
94                  ex = OSError()
95                  ex.errno = socket.errno.WSAETIMEDOUT
96              except AttributeError:
97                  ex = socket.timeout()
98          self.num_errors -= 1
99          raise ex
100  class HttpMockWithNonRetriableErrors(object):
101      def __init__(self, num_errors, success_json, success_data):
102          self.num_errors = num_errors
103          self.success_json = success_json
104          self.success_data = success_data
105      def request(self, *args, **kwargs):
106          if not self.num_errors:
107              return httplib2.Response(self.success_json), self.success_data
108          else:
109              self.num_errors -= 1
110              ex = OSError()
111              try:
112                  ex.errno = socket.errno.WSAEHOSTUNREACH
113              except AttributeError:
114                  ex.errno = socket.errno.EHOSTUNREACH
115              raise ex
116  DATA_DIR = os.path.join(os.path.dirname(__file__), &quot;data&quot;)
117  def datafile(filename):
118      return os.path.join(DATA_DIR, filename)
119  def _postproc_none(*kwargs):
120      pass
121  class TestUserAgent(unittest.TestCase):
122      def test_set_user_agent(self):
123          http = HttpMockSequence([({&quot;status&quot;: &quot;200&quot;}, &quot;echo_request_headers&quot;)])
124          http = set_user_agent(http, &quot;my_app/5.5&quot;)
125          resp, content = http.request(&quot;http://example.com&quot;)
126          self.assertEqual(&quot;my_app/5.5&quot;, content[&quot;user-agent&quot;])
127      def test_set_user_agent_nested(self):
128          http = HttpMockSequence([({&quot;status&quot;: &quot;200&quot;}, &quot;echo_request_headers&quot;)])
129          http = set_user_agent(http, &quot;my_app/5.5&quot;)
130          http = set_user_agent(http, &quot;my_library/0.1&quot;)
131          resp, content = http.request(&quot;http://example.com&quot;)
132          self.assertEqual(&quot;my_app/5.5 my_library/0.1&quot;, content[&quot;user-agent&quot;])
133  class TestMediaUpload(unittest.TestCase):
134      def test_media_file_upload_closes_fd_in___del__(self):
135          file_desc = mock.Mock(spec=io.TextIOWrapper)
136          opener = mock.mock_open(file_desc)
137          with mock.patch(&quot;builtins.open&quot;, return_value=opener):
138              upload = MediaFileUpload(datafile(&quot;test_close&quot;), mimetype=&quot;text/plain&quot;)
139          self.assertIs(upload.stream(), file_desc)
140          del upload
141          file_desc.close.assert_called_once_with()
142      def test_media_file_upload_mimetype_detection(self):
143          upload = MediaFileUpload(datafile(&quot;small.png&quot;))
144          self.assertEqual(&quot;image/png&quot;, upload.mimetype())
145          upload = MediaFileUpload(datafile(&quot;empty&quot;))
146          self.assertEqual(&quot;application/octet-stream&quot;, upload.mimetype())
147      def test_media_file_upload_to_from_json(self):
148          upload = MediaFileUpload(datafile(&quot;small.png&quot;), chunksize=500, resumable=True)
149          self.assertEqual(&quot;image/png&quot;, upload.mimetype())
150          self.assertEqual(190, upload.size())
151          self.assertEqual(True, upload.resumable())
152          self.assertEqual(500, upload.chunksize())
153          self.assertEqual(b&quot;PNG&quot;, upload.getbytes(1, 3))
154          json = upload.to_json()
155          new_upload = MediaUpload.new_from_json(json)
156          self.assertEqual(&quot;image/png&quot;, new_upload.mimetype())
157          self.assertEqual(190, new_upload.size())
158          self.assertEqual(True, new_upload.resumable())
159          self.assertEqual(500, new_upload.chunksize())
160          self.assertEqual(b&quot;PNG&quot;, new_upload.getbytes(1, 3))
161      def test_media_file_upload_raises_on_file_not_found(self):
162          with self.assertRaises(FileNotFoundError):
163              MediaFileUpload(datafile(&quot;missing.png&quot;))
164      def test_media_file_upload_raises_on_invalid_chunksize(self):
165          self.assertRaises(
166              InvalidChunkSizeError,
167              MediaFileUpload,
168              datafile(&quot;small.png&quot;),
169              mimetype=&quot;image/png&quot;,
<span onclick='openModal()' class='match'>170              chunksize=-2,
171              resumable=True,
172          )
173      def test_media_inmemory_upload(self):
174          media = MediaInMemoryUpload(
</span>175              b&quot;abcdef&quot;, mimetype=&quot;text/plain&quot;, chunksize=10, resumable=True
176          )
177          self.assertEqual(&quot;text/plain&quot;, media.mimetype())
178          self.assertEqual(10, media.chunksize())
179          self.assertTrue(media.resumable())
180          self.assertEqual(b&quot;bc&quot;, media.getbytes(1, 2))
181          self.assertEqual(6, media.size())
182      def test_http_request_to_from_json(self):
183          http = build_http()
184          media_upload = MediaFileUpload(
185              datafile(&quot;small.png&quot;), chunksize=500, resumable=True
186          )
187          req = HttpRequest(
188              http,
189              _postproc_none,
190              &quot;http://example.com&quot;,
191              method=&quot;POST&quot;,
192              body=&quot;{}&quot;,
193              headers={&quot;content-type&quot;: &#x27;multipart/related; boundary=&quot;---flubber&quot;&#x27;},
194              methodId=&quot;foo&quot;,
195              resumable=media_upload,
196          )
197          json = req.to_json()
198          new_req = HttpRequest.from_json(json, http, _postproc_none)
199          self.assertEqual(
200              {&quot;content-type&quot;: &#x27;multipart/related; boundary=&quot;---flubber&quot;&#x27;},
201              new_req.headers,
202          )
203          self.assertEqual(&quot;http://example.com&quot;, new_req.uri)
204          self.assertEqual(&quot;{}&quot;, new_req.body)
205          self.assertEqual(http, new_req.http)
206          self.assertEqual(media_upload.to_json(), new_req.resumable.to_json())
207          self.assertEqual(random.random, new_req._rand)
208          self.assertEqual(time.sleep, new_req._sleep)
209  class TestMediaIoBaseUpload(unittest.TestCase):
210      def test_media_io_base_upload_from_file_io(self):
211          fd = FileIO(datafile(&quot;small.png&quot;), &quot;r&quot;)
212          upload = MediaIoBaseUpload(
213              fd=fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
214          )
215          self.assertEqual(&quot;image/png&quot;, upload.mimetype())
216          self.assertEqual(190, upload.size())
217          self.assertEqual(True, upload.resumable())
218          self.assertEqual(500, upload.chunksize())
219          self.assertEqual(b&quot;PNG&quot;, upload.getbytes(1, 3))
220      def test_media_io_base_upload_from_file_object(self):
221          f = open(datafile(&quot;small.png&quot;), &quot;rb&quot;)
222          upload = MediaIoBaseUpload(
223              fd=f, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
224          )
225          self.assertEqual(&quot;image/png&quot;, upload.mimetype())
226          self.assertEqual(190, upload.size())
227          self.assertEqual(True, upload.resumable())
228          self.assertEqual(500, upload.chunksize())
229          self.assertEqual(b&quot;PNG&quot;, upload.getbytes(1, 3))
230          f.close()
231      def test_media_io_base_upload_serializable(self):
232          f = open(datafile(&quot;small.png&quot;), &quot;rb&quot;)
233          upload = MediaIoBaseUpload(fd=f, mimetype=&quot;image/png&quot;)
234          try:
235              json = upload.to_json()
236              self.fail(&quot;MediaIoBaseUpload should not be serializable.&quot;)
237          except NotImplementedError:
238              pass
239      def test_media_io_base_upload_from_bytes(self):
240          f = open(datafile(&quot;small.png&quot;), &quot;rb&quot;)
241          fd = io.BytesIO(f.read())
242          upload = MediaIoBaseUpload(
243              fd=fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
244          )
245          self.assertEqual(&quot;image/png&quot;, upload.mimetype())
246          self.assertEqual(190, upload.size())
247          self.assertEqual(True, upload.resumable())
248          self.assertEqual(500, upload.chunksize())
249          self.assertEqual(b&quot;PNG&quot;, upload.getbytes(1, 3))
250      def test_media_io_base_upload_raises_on_invalid_chunksize(self):
251          f = open(datafile(&quot;small.png&quot;), &quot;rb&quot;)
252          fd = io.BytesIO(f.read())
253          self.assertRaises(
254              InvalidChunkSizeError,
255              MediaIoBaseUpload,
256              fd,
257              &quot;image/png&quot;,
258              chunksize=-2,
259              resumable=True,
260          )
261      def test_media_io_base_upload_streamable(self):
262          fd = io.BytesIO(b&quot;stuff&quot;)
263          upload = MediaIoBaseUpload(
264              fd=fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
265          )
266          self.assertEqual(True, upload.has_stream())
267          self.assertEqual(fd, upload.stream())
268      def test_media_io_base_next_chunk_retries(self):
269          f = open(datafile(&quot;small.png&quot;), &quot;rb&quot;)
270          fd = io.BytesIO(f.read())
271          upload = MediaIoBaseUpload(
272              fd=fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
273          )
274          http = HttpMockSequence(
275              [
276                  ({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;),
277                  ({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;),
278                  ({&quot;status&quot;: &quot;503&quot;}, &quot;&quot;),
279                  ({&quot;status&quot;: &quot;200&quot;, &quot;location&quot;: &quot;location&quot;}, &quot;&quot;),
280                  ({&quot;status&quot;: &quot;403&quot;}, USER_RATE_LIMIT_EXCEEDED_RESPONSE_NO_STATUS),
281                  ({&quot;status&quot;: &quot;403&quot;}, RATE_LIMIT_EXCEEDED_RESPONSE),
282                  ({&quot;status&quot;: &quot;429&quot;}, &quot;&quot;),
283                  ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;),
284              ]
285          )
286          model = JsonModel()
287          uri = &quot;https://www.googleapis.com/someapi/v1/upload/?foo=bar&quot;
288          method = &quot;POST&quot;
289          request = HttpRequest(
290              http, model.response, uri, method=method, headers={}, resumable=upload
291          )
292          sleeptimes = []
293          request._sleep = lambda x: sleeptimes.append(x)
294          request._rand = lambda: 10
295          request.execute(num_retries=3)
296          self.assertEqual([20, 40, 80, 20, 40, 80], sleeptimes)
297      def test_media_io_base_next_chunk_no_retry_403_not_configured(self):
298          fd = io.BytesIO(b&quot;i am png&quot;)
299          upload = MediaIoBaseUpload(
300              fd=fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
301          )
302          http = HttpMockSequence(
303              [({&quot;status&quot;: &quot;403&quot;}, NOT_CONFIGURED_RESPONSE), ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;)]
304          )
305          model = JsonModel()
306          uri = &quot;https://www.googleapis.com/someapi/v1/upload/?foo=bar&quot;
307          method = &quot;POST&quot;
308          request = HttpRequest(
309              http, model.response, uri, method=method, headers={}, resumable=upload
310          )
311          request._rand = lambda: 1.0
312          request._sleep = mock.MagicMock()
313          with self.assertRaises(HttpError):
314              request.execute(num_retries=3)
315          request._sleep.assert_not_called()
316      def test_media_io_base_empty_file(self):
317          fd = io.BytesIO()
318          upload = MediaIoBaseUpload(
319              fd=fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
320          )
321          http = HttpMockSequence(
322              [
323                  (
324                      {
325                          &quot;status&quot;: &quot;200&quot;,
326                          &quot;location&quot;: &quot;https://www.googleapis.com/someapi/v1/upload?foo=bar&quot;,
327                      },
328                      &quot;{}&quot;,
329                  ),
330                  (
331                      {
332                          &quot;status&quot;: &quot;200&quot;,
333                          &quot;location&quot;: &quot;https://www.googleapis.com/someapi/v1/upload?foo=bar&quot;,
334                      },
335                      &quot;{}&quot;,
336                  ),
337              ]
338          )
339          model = JsonModel()
340          uri = &quot;https://www.googleapis.com/someapi/v1/upload/?foo=bar&quot;
341          method = &quot;POST&quot;
342          request = HttpRequest(
343              http, model.response, uri, method=method, headers={}, resumable=upload
344          )
345          request.execute()
346          self.assertTrue(&quot;Content-Range&quot; not in http.request_sequence[-1][-1])
347          self.assertEqual(&quot;0&quot;, http.request_sequence[-1][-1][&quot;Content-Length&quot;])
348  class TestMediaIoBaseDownload(unittest.TestCase):
349      def setUp(self):
350          http = HttpMock(datafile(&quot;zoo.json&quot;), {&quot;status&quot;: &quot;200&quot;})
351          zoo = build(&quot;zoo&quot;, &quot;v1&quot;, http=http, static_discovery=False)
352          self.request = zoo.animals().get_media(name=&quot;Lion&quot;)
353          self.fd = io.BytesIO()
354      def test_media_io_base_download(self):
355          self.request.http = HttpMockSequence(
356              [
357                  ({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/5&quot;}, b&quot;123&quot;),
358                  ({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;3-4/5&quot;}, b&quot;45&quot;),
359              ]
360          )
361          self.assertEqual(True, self.request.http.follow_redirects)
362          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
363          self.assertEqual(self.fd, download._fd)
364          self.assertEqual(3, download._chunksize)
365          self.assertEqual(0, download._progress)
366          self.assertEqual(None, download._total_size)
367          self.assertEqual(False, download._done)
368          self.assertEqual(self.request.uri, download._uri)
369          status, done = download.next_chunk()
370          self.assertEqual(self.fd.getvalue(), b&quot;123&quot;)
371          self.assertEqual(False, done)
372          self.assertEqual(3, download._progress)
373          self.assertEqual(5, download._total_size)
374          self.assertEqual(3, status.resumable_progress)
375          status, done = download.next_chunk()
376          self.assertEqual(self.fd.getvalue(), b&quot;12345&quot;)
377          self.assertEqual(True, done)
378          self.assertEqual(5, download._progress)
379          self.assertEqual(5, download._total_size)
380      def test_media_io_base_download_range_request_header(self):
381          self.request.http = HttpMockSequence(
382              [
383                  (
384                      {&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/5&quot;},
385                      &quot;echo_request_headers_as_json&quot;,
386                  ),
387              ]
388          )
389          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
390          status, done = download.next_chunk()
391          result = json.loads(self.fd.getvalue().decode(&quot;utf-8&quot;))
392          self.assertEqual(result.get(&quot;range&quot;), &quot;bytes=0-2&quot;)
393      def test_media_io_base_download_custom_request_headers(self):
394          self.request.http = HttpMockSequence(
395              [
396                  (
397                      {&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/5&quot;},
398                      &quot;echo_request_headers_as_json&quot;,
399                  ),
400                  (
401                      {&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;3-4/5&quot;},
402                      &quot;echo_request_headers_as_json&quot;,
403                  ),
404              ]
405          )
406          self.assertEqual(True, self.request.http.follow_redirects)
407          self.request.headers[&quot;Cache-Control&quot;] = &quot;no-store&quot;
408          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
409          self.assertEqual(download._headers.get(&quot;Cache-Control&quot;), &quot;no-store&quot;)
410          status, done = download.next_chunk()
411          result = json.loads(self.fd.getvalue().decode(&quot;utf-8&quot;))
412          self.assertEqual(result.get(&quot;Cache-Control&quot;), &quot;no-store&quot;)
413          download._fd = self.fd = io.BytesIO()
414          status, done = download.next_chunk()
415          result = json.loads(self.fd.getvalue().decode(&quot;utf-8&quot;))
416          self.assertEqual(result.get(&quot;Cache-Control&quot;), &quot;no-store&quot;)
417      def test_media_io_base_download_handle_redirects(self):
418          self.request.http = HttpMockSequence(
419              [
420                  (
421                      {
422                          &quot;status&quot;: &quot;200&quot;,
423                          &quot;content-location&quot;: &quot;https://secure.example.net/lion&quot;,
424                      },
425                      b&quot;&quot;,
426                  ),
427                  ({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/5&quot;}, b&quot;abc&quot;),
428              ]
429          )
430          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
431          status, done = download.next_chunk()
432          self.assertEqual(&quot;https://secure.example.net/lion&quot;, download._uri)
433      def test_media_io_base_download_handle_4xx(self):
434          self.request.http = HttpMockSequence([({&quot;status&quot;: &quot;400&quot;}, &quot;&quot;)])
435          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
436          try:
437              status, done = download.next_chunk()
438              self.fail(&quot;Should raise an exception&quot;)
439          except HttpError:
440              pass
441          self.request.http = HttpMockSequence(
442              [({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/5&quot;}, b&quot;123&quot;)]
443          )
444          status, done = download.next_chunk()
445          self.assertEqual(self.fd.getvalue(), b&quot;123&quot;)
446      def test_media_io_base_download_retries_connection_errors(self):
447          self.request.http = HttpMockWithErrors(
448              5, {&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/3&quot;}, b&quot;123&quot;
449          )
450          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
451          download._sleep = lambda _x: 0  # do nothing
452          download._rand = lambda: 10
453          status, done = download.next_chunk(num_retries=5)
454          self.assertEqual(self.fd.getvalue(), b&quot;123&quot;)
455          self.assertEqual(True, done)
456      def test_media_io_base_download_retries_5xx(self):
457          self.request.http = HttpMockSequence(
458              [
459                  ({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;),
460                  ({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;),
461                  ({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;),
462                  ({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/5&quot;}, b&quot;123&quot;),
463                  ({&quot;status&quot;: &quot;503&quot;}, &quot;&quot;),
464                  ({&quot;status&quot;: &quot;503&quot;}, &quot;&quot;),
465                  ({&quot;status&quot;: &quot;503&quot;}, &quot;&quot;),
466                  ({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;3-4/5&quot;}, b&quot;45&quot;),
467              ]
468          )
469          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
470          self.assertEqual(self.fd, download._fd)
471          self.assertEqual(3, download._chunksize)
472          self.assertEqual(0, download._progress)
473          self.assertEqual(None, download._total_size)
474          self.assertEqual(False, download._done)
475          self.assertEqual(self.request.uri, download._uri)
476          sleeptimes = []
477          download._sleep = lambda x: sleeptimes.append(x)
478          download._rand = lambda: 10
479          status, done = download.next_chunk(num_retries=3)
480          self.assertEqual([20, 40, 80], sleeptimes)
481          self.assertEqual(self.fd.getvalue(), b&quot;123&quot;)
482          self.assertEqual(False, done)
483          self.assertEqual(3, download._progress)
484          self.assertEqual(5, download._total_size)
485          self.assertEqual(3, status.resumable_progress)
486          del sleeptimes[0 : len(sleeptimes)]
487          status, done = download.next_chunk(num_retries=3)
488          self.assertEqual([20, 40, 80], sleeptimes)
489          self.assertEqual(self.fd.getvalue(), b&quot;12345&quot;)
490          self.assertEqual(True, done)
491          self.assertEqual(5, download._progress)
492          self.assertEqual(5, download._total_size)
493      def test_media_io_base_download_empty_file(self):
494          self.request.http = HttpMockSequence(
495              [({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-0/0&quot;}, b&quot;&quot;)]
496          )
497          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
498          self.assertEqual(self.fd, download._fd)
499          self.assertEqual(0, download._progress)
500          self.assertEqual(None, download._total_size)
501          self.assertEqual(False, download._done)
502          self.assertEqual(self.request.uri, download._uri)
503          status, done = download.next_chunk()
504          self.assertEqual(True, done)
505          self.assertEqual(0, download._progress)
506          self.assertEqual(0, download._total_size)
507          self.assertEqual(0, status.progress())
508      def test_media_io_base_download_empty_file_416_response(self):
509          self.request.http = HttpMockSequence(
510              [({&quot;status&quot;: &quot;416&quot;, &quot;content-range&quot;: &quot;0-0/0&quot;}, b&quot;&quot;)]
511          )
512          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
513          self.assertEqual(self.fd, download._fd)
514          self.assertEqual(0, download._progress)
515          self.assertEqual(None, download._total_size)
516          self.assertEqual(False, download._done)
517          self.assertEqual(self.request.uri, download._uri)
518          status, done = download.next_chunk()
519          self.assertEqual(True, done)
520          self.assertEqual(0, download._progress)
521          self.assertEqual(0, download._total_size)
522          self.assertEqual(0, status.progress())
523      def test_media_io_base_download_unknown_media_size(self):
524          self.request.http = HttpMockSequence([({&quot;status&quot;: &quot;200&quot;}, b&quot;123&quot;)])
525          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
526          self.assertEqual(self.fd, download._fd)
527          self.assertEqual(0, download._progress)
528          self.assertEqual(None, download._total_size)
529          self.assertEqual(False, download._done)
530          self.assertEqual(self.request.uri, download._uri)
531          status, done = download.next_chunk()
532          self.assertEqual(self.fd.getvalue(), b&quot;123&quot;)
533          self.assertEqual(True, done)
534          self.assertEqual(3, download._progress)
535          self.assertEqual(None, download._total_size)
536          self.assertEqual(0, status.progress())
537  EXPECTED = 
538  NO_BODY_EXPECTED = 
539  NO_BODY_EXPECTED_GET = 
540  RESPONSE = 
541  BATCH_RESPONSE = b
542  BATCH_ERROR_RESPONSE = b
543  BATCH_RESPONSE_WITH_401 = b
544  BATCH_SINGLE_RESPONSE = b
545  USER_RATE_LIMIT_EXCEEDED_RESPONSE_NO_STATUS = 
546  USER_RATE_LIMIT_EXCEEDED_RESPONSE_WITH_STATUS = 
547  RATE_LIMIT_EXCEEDED_RESPONSE = 
548  NOT_CONFIGURED_RESPONSE = 
549  LIST_NOT_CONFIGURED_RESPONSE = 
550  class Callbacks(object):
551      def __init__(self):
552          self.responses = {}
553          self.exceptions = {}
554      def f(self, request_id, response, exception):
555          self.responses[request_id] = response
556          self.exceptions[request_id] = exception
557  class TestHttpRequest(unittest.TestCase):
558      def test_unicode(self):
559          http = HttpMock(datafile(&quot;zoo.json&quot;), headers={&quot;status&quot;: &quot;200&quot;})
560          model = JsonModel()
561          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
562          method = &quot;POST&quot;
563          request = HttpRequest(
564              http,
565              model.response,
566              uri,
567              method=method,
568              body=&quot;{}&quot;,
569              headers={&quot;content-type&quot;: &quot;application/json&quot;},
570          )
571          request.execute()
572          self.assertEqual(uri, http.uri)
573          self.assertEqual(str, type(http.uri))
574          self.assertEqual(method, http.method)
575          self.assertEqual(str, type(http.method))
576      def test_empty_content_type(self):
577          http = HttpMock(None, headers={&quot;status&quot;: 200})
578          uri = &quot;https://www.googleapis.com/someapi/v1/upload/?foo=bar&quot;
579          method = &quot;POST&quot;
580          request = HttpRequest(
581              http, _postproc_none, uri, method=method, headers={&quot;content-type&quot;: &quot;&quot;}
582          )
583          request.execute()
584          self.assertEqual(&quot;&quot;, http.headers.get(&quot;content-type&quot;))
585      def test_no_retry_connection_errors(self):
586          model = JsonModel()
587          request = HttpRequest(
588              HttpMockWithNonRetriableErrors(1, {&quot;status&quot;: &quot;200&quot;}, &#x27;{&quot;foo&quot;: &quot;bar&quot;}&#x27;),
589              model.response,
590              &quot;https://www.example.com/json_api_endpoint&quot;,
591          )
592          request._sleep = lambda _x: 0  # do nothing
593          request._rand = lambda: 10
594          with self.assertRaises(OSError):
595              response = request.execute(num_retries=3)
596      def test_retry_connection_errors_non_resumable(self):
597          model = JsonModel()
598          request = HttpRequest(
599              HttpMockWithErrors(5, {&quot;status&quot;: &quot;200&quot;}, &#x27;{&quot;foo&quot;: &quot;bar&quot;}&#x27;),
600              model.response,
601              &quot;https://www.example.com/json_api_endpoint&quot;,
602          )
603          request._sleep = lambda _x: 0  # do nothing
604          request._rand = lambda: 10
605          response = request.execute(num_retries=5)
606          self.assertEqual({&quot;foo&quot;: &quot;bar&quot;}, response)
607      def test_retry_connection_errors_resumable(self):
608          with open(datafile(&quot;small.png&quot;), &quot;rb&quot;) as small_png_file:
609              small_png_fd = io.BytesIO(small_png_file.read())
610          upload = MediaIoBaseUpload(
611              fd=small_png_fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
612          )
613          model = JsonModel()
614          request = HttpRequest(
615              HttpMockWithErrors(
616                  5, {&quot;status&quot;: &quot;200&quot;, &quot;location&quot;: &quot;location&quot;}, &#x27;{&quot;foo&quot;: &quot;bar&quot;}&#x27;
617              ),
618              model.response,
619              &quot;https://www.example.com/file_upload&quot;,
620              method=&quot;POST&quot;,
621              resumable=upload,
622          )
623          request._sleep = lambda _x: 0  # do nothing
624          request._rand = lambda: 10
625          response = request.execute(num_retries=5)
626          self.assertEqual({&quot;foo&quot;: &quot;bar&quot;}, response)
627      def test_retry(self):
628          num_retries = 6
629          resp_seq = [({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;)] * (num_retries - 4)
630          resp_seq.append(({&quot;status&quot;: &quot;403&quot;}, RATE_LIMIT_EXCEEDED_RESPONSE))
631          resp_seq.append(
632              ({&quot;status&quot;: &quot;403&quot;}, USER_RATE_LIMIT_EXCEEDED_RESPONSE_NO_STATUS)
633          )
634          resp_seq.append(
635              ({&quot;status&quot;: &quot;403&quot;}, USER_RATE_LIMIT_EXCEEDED_RESPONSE_WITH_STATUS)
636          )
637          resp_seq.append(({&quot;status&quot;: &quot;429&quot;}, &quot;&quot;))
638          resp_seq.append(({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;))
639          http = HttpMockSequence(resp_seq)
640          model = JsonModel()
641          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
642          method = &quot;POST&quot;
643          request = HttpRequest(
644              http,
645              model.response,
646              uri,
647              method=method,
648              body=&quot;{}&quot;,
649              headers={&quot;content-type&quot;: &quot;application/json&quot;},
650          )
651          sleeptimes = []
652          request._sleep = lambda x: sleeptimes.append(x)
653          request._rand = lambda: 10
654          request.execute(num_retries=num_retries)
655          self.assertEqual(num_retries, len(sleeptimes))
656          for retry_num in range(num_retries):
657              self.assertEqual(10 * 2 ** (retry_num + 1), sleeptimes[retry_num])
658      def test_no_retry_succeeds(self):
659          num_retries = 5
660          resp_seq = [({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;)] * (num_retries)
661          http = HttpMockSequence(resp_seq)
662          model = JsonModel()
663          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
664          method = &quot;POST&quot;
665          request = HttpRequest(
666              http,
667              model.response,
668              uri,
669              method=method,
670              body=&quot;{}&quot;,
671              headers={&quot;content-type&quot;: &quot;application/json&quot;},
672          )
673          sleeptimes = []
674          request._sleep = lambda x: sleeptimes.append(x)
675          request._rand = lambda: 10
676          request.execute(num_retries=num_retries)
677          self.assertEqual(0, len(sleeptimes))
678      def test_no_retry_fails_fast(self):
679          http = HttpMockSequence([({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;), ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;)])
680          model = JsonModel()
681          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
682          method = &quot;POST&quot;
683          request = HttpRequest(
684              http,
685              model.response,
686              uri,
687              method=method,
688              body=&quot;{}&quot;,
689              headers={&quot;content-type&quot;: &quot;application/json&quot;},
690          )
691          request._rand = lambda: 1.0
692          request._sleep = mock.MagicMock()
693          with self.assertRaises(HttpError):
694              request.execute()
695          request._sleep.assert_not_called()
696      def test_no_retry_403_not_configured_fails_fast(self):
697          http = HttpMockSequence(
698              [({&quot;status&quot;: &quot;403&quot;}, NOT_CONFIGURED_RESPONSE), ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;)]
699          )
700          model = JsonModel()
701          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
702          method = &quot;POST&quot;
703          request = HttpRequest(
704              http,
705              model.response,
706              uri,
707              method=method,
708              body=&quot;{}&quot;,
709              headers={&quot;content-type&quot;: &quot;application/json&quot;},
710          )
711          request._rand = lambda: 1.0
712          request._sleep = mock.MagicMock()
713          with self.assertRaises(HttpError):
714              request.execute()
715          request._sleep.assert_not_called()
716      def test_no_retry_403_fails_fast(self):
717          http = HttpMockSequence([({&quot;status&quot;: &quot;403&quot;}, &quot;&quot;), ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;)])
718          model = JsonModel()
719          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
720          method = &quot;POST&quot;
721          request = HttpRequest(
722              http,
723              model.response,
724              uri,
725              method=method,
726              body=&quot;{}&quot;,
727              headers={&quot;content-type&quot;: &quot;application/json&quot;},
728          )
729          request._rand = lambda: 1.0
730          request._sleep = mock.MagicMock()
731          with self.assertRaises(HttpError):
732              request.execute()
733          request._sleep.assert_not_called()
734      def test_no_retry_401_fails_fast(self):
735          http = HttpMockSequence([({&quot;status&quot;: &quot;401&quot;}, &quot;&quot;), ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;)])
736          model = JsonModel()
737          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
738          method = &quot;POST&quot;
739          request = HttpRequest(
740              http,
741              model.response,
742              uri,
743              method=method,
744              body=&quot;{}&quot;,
745              headers={&quot;content-type&quot;: &quot;application/json&quot;},
746          )
747          request._rand = lambda: 1.0
748          request._sleep = mock.MagicMock()
749          with self.assertRaises(HttpError):
750              request.execute()
751          request._sleep.assert_not_called()
752      def test_no_retry_403_list_fails(self):
753          http = HttpMockSequence(
754              [
755                  ({&quot;status&quot;: &quot;403&quot;}, LIST_NOT_CONFIGURED_RESPONSE),
756                  ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;),
757              ]
758          )
759          model = JsonModel()
760          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
761          method = &quot;POST&quot;
762          request = HttpRequest(
763              http,
764              model.response,
765              uri,
766              method=method,
767              body=&quot;{}&quot;,
768              headers={&quot;content-type&quot;: &quot;application/json&quot;},
769          )
770          request._rand = lambda: 1.0
771          request._sleep = mock.MagicMock()
772          with self.assertRaises(HttpError):
773              request.execute()
774          request._sleep.assert_not_called()
775      def test_null_postproc(self):
776          resp, content = HttpRequest.null_postproc(&quot;foo&quot;, &quot;bar&quot;)
777          self.assertEqual(resp, &quot;foo&quot;)
778          self.assertEqual(content, &quot;bar&quot;)
779  class TestBatch(unittest.TestCase):
780      def setUp(self):
781          model = JsonModel()
782          self.request1 = HttpRequest(
783              None,
784              model.response,
785              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
786              method=&quot;POST&quot;,
787              body=&quot;{}&quot;,
788              headers={&quot;content-type&quot;: &quot;application/json&quot;},
789          )
790          self.request2 = HttpRequest(
791              None,
792              model.response,
793              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
794              method=&quot;GET&quot;,
795              body=&quot;&quot;,
796              headers={&quot;content-type&quot;: &quot;application/json&quot;},
797          )
798      def test_id_to_from_content_id_header(self):
799          batch = BatchHttpRequest()
800          self.assertEqual(&quot;12&quot;, batch._header_to_id(batch._id_to_header(&quot;12&quot;)))
801      def test_invalid_content_id_header(self):
802          batch = BatchHttpRequest()
803          self.assertRaises(BatchError, batch._header_to_id, &quot;[foo+x]&quot;)
804          self.assertRaises(BatchError, batch._header_to_id, &quot;foo+1&quot;)
805          self.assertRaises(BatchError, batch._header_to_id, &quot;&lt;foo&gt;&quot;)
806      def test_serialize_request(self):
807          batch = BatchHttpRequest()
808          request = HttpRequest(
809              None,
810              None,
811              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
812              method=&quot;POST&quot;,
813              body=&quot;{}&quot;,
814              headers={&quot;content-type&quot;: &quot;application/json&quot;},
815              methodId=None,
816              resumable=None,
817          )
818          s = batch._serialize_request(request).splitlines()
819          self.assertEqual(EXPECTED.splitlines(), s)
820      def test_serialize_request_media_body(self):
821          batch = BatchHttpRequest()
822          f = open(datafile(&quot;small.png&quot;), &quot;rb&quot;)
823          body = f.read()
824          f.close()
825          request = HttpRequest(
826              None,
827              None,
828              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
829              method=&quot;POST&quot;,
830              body=body,
831              headers={&quot;content-type&quot;: &quot;application/json&quot;},
832              methodId=None,
833              resumable=None,
834          )
835          s = batch._serialize_request(request).splitlines()
836      def test_serialize_request_no_body(self):
837          batch = BatchHttpRequest()
838          request = HttpRequest(
839              None,
840              None,
841              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
842              method=&quot;POST&quot;,
843              body=b&quot;&quot;,
844              headers={&quot;content-type&quot;: &quot;application/json&quot;},
845              methodId=None,
846              resumable=None,
847          )
848          s = batch._serialize_request(request).splitlines()
849          self.assertEqual(NO_BODY_EXPECTED.splitlines(), s)
850      def test_serialize_get_request_no_body(self):
851          batch = BatchHttpRequest()
852          request = HttpRequest(
853              None,
854              None,
855              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
856              method=&quot;GET&quot;,
857              body=None,
858              headers={&quot;content-type&quot;: &quot;application/json&quot;},
859              methodId=None,
860              resumable=None,
861          )
862          s = batch._serialize_request(request).splitlines()
863          self.assertEqual(NO_BODY_EXPECTED_GET.splitlines(), s)
864      def test_deserialize_response(self):
865          batch = BatchHttpRequest()
866          resp, content = batch._deserialize_response(RESPONSE)
867          self.assertEqual(200, resp.status)
868          self.assertEqual(&quot;OK&quot;, resp.reason)
869          self.assertEqual(11, resp.version)
870          self.assertEqual(&#x27;{&quot;answer&quot;: 42}&#x27;, content)
871      def test_new_id(self):
872          batch = BatchHttpRequest()
873          id_ = batch._new_id()
874          self.assertEqual(&quot;1&quot;, id_)
875          id_ = batch._new_id()
876          self.assertEqual(&quot;2&quot;, id_)
877          batch.add(self.request1, request_id=&quot;3&quot;)
878          id_ = batch._new_id()
879          self.assertEqual(&quot;4&quot;, id_)
880      def test_add(self):
881          batch = BatchHttpRequest()
882          batch.add(self.request1, request_id=&quot;1&quot;)
883          self.assertRaises(KeyError, batch.add, self.request1, request_id=&quot;1&quot;)
884      def test_add_fail_for_over_limit(self):
885          from googleapiclient.http import MAX_BATCH_LIMIT
886          batch = BatchHttpRequest()
887          for i in range(0, MAX_BATCH_LIMIT):
888              batch.add(
889                  HttpRequest(
890                      None,
891                      None,
892                      &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
893                      method=&quot;POST&quot;,
894                      body=&quot;{}&quot;,
895                      headers={&quot;content-type&quot;: &quot;application/json&quot;},
896                  )
897              )
898          self.assertRaises(BatchError, batch.add, self.request1)
899      def test_add_fail_for_resumable(self):
900          batch = BatchHttpRequest()
901          upload = MediaFileUpload(datafile(&quot;small.png&quot;), chunksize=500, resumable=True)
902          self.request1.resumable = upload
903          with self.assertRaises(BatchError) as batch_error:
904              batch.add(self.request1, request_id=&quot;1&quot;)
905          str(batch_error.exception)
906      def test_execute_empty_batch_no_http(self):
907          batch = BatchHttpRequest()
908          ret = batch.execute()
909          self.assertEqual(None, ret)
910      def test_execute(self):
911          batch = BatchHttpRequest()
912          callbacks = Callbacks()
913          batch.add(self.request1, callback=callbacks.f)
914          batch.add(self.request2, callback=callbacks.f)
915          http = HttpMockSequence(
916              [
917                  (
918                      {
919                          &quot;status&quot;: &quot;200&quot;,
920                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
921                      },
922                      BATCH_RESPONSE,
923                  )
924              ]
925          )
926          batch.execute(http=http)
927          self.assertEqual({&quot;foo&quot;: 42}, callbacks.responses[&quot;1&quot;])
928          self.assertEqual(None, callbacks.exceptions[&quot;1&quot;])
929          self.assertEqual({&quot;baz&quot;: &quot;qux&quot;}, callbacks.responses[&quot;2&quot;])
930          self.assertEqual(None, callbacks.exceptions[&quot;2&quot;])
931      def test_execute_request_body(self):
932          batch = BatchHttpRequest()
933          batch.add(self.request1)
934          batch.add(self.request2)
935          http = HttpMockSequence(
936              [
937                  (
938                      {
939                          &quot;status&quot;: &quot;200&quot;,
940                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
941                      },
942                      &quot;echo_request_body&quot;,
943                  )
944              ]
945          )
946          try:
947              batch.execute(http=http)
948              self.fail(&quot;Should raise exception&quot;)
949          except BatchError as e:
950              boundary, _ = e.content.split(None, 1)
951              self.assertEqual(&quot;--&quot;, boundary[:2])
952              parts = e.content.split(boundary)
953              self.assertEqual(4, len(parts))
954              self.assertEqual(&quot;&quot;, parts[0])
955              self.assertEqual(&quot;--&quot;, parts[3].rstrip())
956              header = parts[1].splitlines()[1]
957              self.assertEqual(&quot;Content-Type: application/http&quot;, header)
958      def test_execute_request_body_with_custom_long_request_ids(self):
959          batch = BatchHttpRequest()
960          batch.add(self.request1, request_id=&quot;abc&quot; * 20)
961          batch.add(self.request2, request_id=&quot;def&quot; * 20)
962          http = HttpMockSequence(
963              [
964                  (
965                      {
966                          &quot;status&quot;: &quot;200&quot;,
967                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
968                      },
969                      &quot;echo_request_body&quot;,
970                  )
971              ]
972          )
973          try:
974              batch.execute(http=http)
975              self.fail(&quot;Should raise exception&quot;)
976          except BatchError as e:
977              boundary, _ = e.content.split(None, 1)
978              self.assertEqual(&quot;--&quot;, boundary[:2])
979              parts = e.content.split(boundary)
980              self.assertEqual(4, len(parts))
981              self.assertEqual(&quot;&quot;, parts[0])
982              self.assertEqual(&quot;--&quot;, parts[3].rstrip())
983              for partindex, request_id in ((1, &quot;abc&quot; * 20), (2, &quot;def&quot; * 20)):
984                  lines = parts[partindex].splitlines()
985                  for n, line in enumerate(lines):
986                      if line.startswith(&quot;Content-ID:&quot;):
987                          self.assertTrue(line.endswith(&quot;+&quot;), line)
988                          header_continuation = lines[n + 1]
989                          self.assertEqual(
990                              header_continuation,
991                              &quot; %s&gt;&quot; % request_id,
992                              header_continuation,
993                          )
994      def test_execute_initial_refresh_oauth2(self):
995          batch = BatchHttpRequest()
996          callbacks = Callbacks()
997          cred = MockCredentials(&quot;Foo&quot;, expired=True)
998          http = HttpMockSequence(
999              [
1000                  (
1001                      {
1002                          &quot;status&quot;: &quot;200&quot;,
1003                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1004                      },
1005                      BATCH_SINGLE_RESPONSE,
1006                  )
1007              ]
1008          )
1009          cred.authorize(http)
1010          batch.add(self.request1, callback=callbacks.f)
1011          batch.execute(http=http)
1012          self.assertEqual({&quot;foo&quot;: 42}, callbacks.responses[&quot;1&quot;])
1013          self.assertIsNone(callbacks.exceptions[&quot;1&quot;])
1014          self.assertEqual(1, cred._refreshed)
1015          self.assertEqual(1, cred._authorized)
1016          self.assertEqual(1, cred._applied)
1017      def test_execute_refresh_and_retry_on_401(self):
1018          batch = BatchHttpRequest()
1019          callbacks = Callbacks()
1020          cred_1 = MockCredentials(&quot;Foo&quot;)
1021          cred_2 = MockCredentials(&quot;Bar&quot;)
1022          http = HttpMockSequence(
1023              [
1024                  (
1025                      {
1026                          &quot;status&quot;: &quot;200&quot;,
1027                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1028                      },
1029                      BATCH_RESPONSE_WITH_401,
1030                  ),
1031                  (
1032                      {
1033                          &quot;status&quot;: &quot;200&quot;,
1034                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1035                      },
1036                      BATCH_SINGLE_RESPONSE,
1037                  ),
1038              ]
1039          )
1040          creds_http_1 = HttpMockSequence([])
1041          cred_1.authorize(creds_http_1)
1042          creds_http_2 = HttpMockSequence([])
1043          cred_2.authorize(creds_http_2)
1044          self.request1.http = creds_http_1
1045          self.request2.http = creds_http_2
1046          batch.add(self.request1, callback=callbacks.f)
1047          batch.add(self.request2, callback=callbacks.f)
1048          batch.execute(http=http)
1049          self.assertEqual({&quot;foo&quot;: 42}, callbacks.responses[&quot;1&quot;])
1050          self.assertEqual(None, callbacks.exceptions[&quot;1&quot;])
1051          self.assertEqual({&quot;baz&quot;: &quot;qux&quot;}, callbacks.responses[&quot;2&quot;])
1052          self.assertEqual(None, callbacks.exceptions[&quot;2&quot;])
1053          self.assertEqual(1, cred_1._refreshed)
1054          self.assertEqual(0, cred_2._refreshed)
1055          self.assertEqual(1, cred_1._authorized)
1056          self.assertEqual(1, cred_2._authorized)
1057          self.assertEqual(1, cred_2._applied)
1058          self.assertEqual(2, cred_1._applied)
1059      def test_http_errors_passed_to_callback(self):
1060          batch = BatchHttpRequest()
1061          callbacks = Callbacks()
1062          cred_1 = MockCredentials(&quot;Foo&quot;)
1063          cred_2 = MockCredentials(&quot;Bar&quot;)
1064          http = HttpMockSequence(
1065              [
1066                  (
1067                      {
1068                          &quot;status&quot;: &quot;200&quot;,
1069                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1070                      },
1071                      BATCH_RESPONSE_WITH_401,
1072                  ),
1073                  (
1074                      {
1075                          &quot;status&quot;: &quot;200&quot;,
1076                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1077                      },
1078                      BATCH_RESPONSE_WITH_401,
1079                  ),
1080              ]
1081          )
1082          creds_http_1 = HttpMockSequence([])
1083          cred_1.authorize(creds_http_1)
1084          creds_http_2 = HttpMockSequence([])
1085          cred_2.authorize(creds_http_2)
1086          self.request1.http = creds_http_1
1087          self.request2.http = creds_http_2
1088          batch.add(self.request1, callback=callbacks.f)
1089          batch.add(self.request2, callback=callbacks.f)
1090          batch.execute(http=http)
1091          self.assertEqual(None, callbacks.responses[&quot;1&quot;])
1092          self.assertEqual(401, callbacks.exceptions[&quot;1&quot;].resp.status)
1093          self.assertEqual(
1094              &quot;Authorization Required&quot;, callbacks.exceptions[&quot;1&quot;].resp.reason
1095          )
1096          self.assertEqual({&quot;baz&quot;: &quot;qux&quot;}, callbacks.responses[&quot;2&quot;])
1097          self.assertEqual(None, callbacks.exceptions[&quot;2&quot;])
1098      def test_execute_global_callback(self):
1099          callbacks = Callbacks()
1100          batch = BatchHttpRequest(callback=callbacks.f)
1101          batch.add(self.request1)
1102          batch.add(self.request2)
1103          http = HttpMockSequence(
1104              [
1105                  (
1106                      {
1107                          &quot;status&quot;: &quot;200&quot;,
1108                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1109                      },
1110                      BATCH_RESPONSE,
1111                  )
1112              ]
1113          )
1114          batch.execute(http=http)
1115          self.assertEqual({&quot;foo&quot;: 42}, callbacks.responses[&quot;1&quot;])
1116          self.assertEqual({&quot;baz&quot;: &quot;qux&quot;}, callbacks.responses[&quot;2&quot;])
1117      def test_execute_batch_http_error(self):
1118          callbacks = Callbacks()
1119          batch = BatchHttpRequest(callback=callbacks.f)
1120          batch.add(self.request1)
1121          batch.add(self.request2)
1122          http = HttpMockSequence(
1123              [
1124                  (
1125                      {
1126                          &quot;status&quot;: &quot;200&quot;,
1127                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1128                      },
1129                      BATCH_ERROR_RESPONSE,
1130                  )
1131              ]
1132          )
1133          batch.execute(http=http)
1134          self.assertEqual({&quot;foo&quot;: 42}, callbacks.responses[&quot;1&quot;])
1135          expected = (
1136              &quot;&lt;HttpError 403 when requesting &quot;
1137              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar returned &quot;
1138              &#x27;&quot;Access Not Configured&quot;. &#x27;
1139              &quot;Details: \&quot;[{&#x27;domain&#x27;: &#x27;usageLimits&#x27;, &#x27;reason&#x27;: &#x27;accessNotConfigured&#x27;, &#x27;message&#x27;: &#x27;Access Not Configured&#x27;, &#x27;debugInfo&#x27;: &#x27;QuotaState: BLOCKED&#x27;}]\&quot;&gt;&quot;
1140          )
1141          self.assertEqual(expected, str(callbacks.exceptions[&quot;2&quot;]))
1142  class TestRequestUriTooLong(unittest.TestCase):
1143      def test_turn_get_into_post(self):
1144          def _postproc(resp, content):
1145              return content
1146          http = HttpMockSequence(
1147              [
1148                  ({&quot;status&quot;: &quot;200&quot;}, &quot;echo_request_body&quot;),
1149                  ({&quot;status&quot;: &quot;200&quot;}, &quot;echo_request_headers&quot;),
1150              ]
1151          )
1152          query = {&quot;q&quot;: &quot;a&quot; * MAX_URI_LENGTH + &quot;?&amp;&quot;}
1153          req = HttpRequest(
1154              http,
1155              _postproc,
1156              &quot;http://example.com?&quot; + urllib.parse.urlencode(query),
1157              method=&quot;GET&quot;,
1158              body=None,
1159              headers={},
1160              methodId=&quot;foo&quot;,
1161              resumable=None,
1162          )
1163          response = req.execute()
1164          self.assertEqual(b&quot;q=&quot; + b&quot;a&quot; * MAX_URI_LENGTH + b&quot;%3F%26&quot;, response)
1165          response = req.execute()
1166          self.assertEqual(&quot;GET&quot;, response[&quot;x-http-method-override&quot;])
1167          self.assertEqual(str(MAX_URI_LENGTH + 8), response[&quot;content-length&quot;])
1168          self.assertEqual(&quot;application/x-www-form-urlencoded&quot;, response[&quot;content-type&quot;])
1169  class TestStreamSlice(unittest.TestCase):
1170      def setUp(self):
1171          self.stream = io.BytesIO(b&quot;0123456789&quot;)
1172      def test_read(self):
1173          s = _StreamSlice(self.stream, 0, 4)
1174          self.assertEqual(b&quot;&quot;, s.read(0))
1175          self.assertEqual(b&quot;0&quot;, s.read(1))
1176          self.assertEqual(b&quot;123&quot;, s.read())
1177      def test_read_too_much(self):
1178          s = _StreamSlice(self.stream, 1, 4)
1179          self.assertEqual(b&quot;1234&quot;, s.read(6))
1180      def test_read_all(self):
1181          s = _StreamSlice(self.stream, 2, 1)
1182          self.assertEqual(b&quot;2&quot;, s.read(-1))
1183  class TestResponseCallback(unittest.TestCase):
1184      def test_ensure_response_callback(self):
1185          m = JsonModel()
1186          request = HttpRequest(
1187              None,
1188              m.response,
1189              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
1190              method=&quot;POST&quot;,
1191              body=&quot;{}&quot;,
1192              headers={&quot;content-type&quot;: &quot;application/json&quot;},
1193          )
1194          h = HttpMockSequence([({&quot;status&quot;: 200}, &quot;{}&quot;)])
1195          responses = []
1196          def _on_response(resp, responses=responses):
1197              responses.append(resp)
1198          request.add_response_callback(_on_response)
1199          request.execute(http=h)
1200          self.assertEqual(1, len(responses))
1201  class TestHttpMock(unittest.TestCase):
1202      def test_default_response_headers(self):
1203          http = HttpMock(datafile(&quot;zoo.json&quot;))
1204          resp, content = http.request(&quot;http://example.com&quot;)
1205          self.assertEqual(resp.status, 200)
1206      def test_error_response(self):
1207          http = HttpMock(datafile(&quot;bad_request.json&quot;), {&quot;status&quot;: &quot;400&quot;})
1208          model = JsonModel()
1209          request = HttpRequest(
1210              http,
1211              model.response,
1212              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
1213              method=&quot;GET&quot;,
1214              headers={},
1215          )
1216          self.assertRaises(HttpError, request.execute)
1217  class TestHttpBuild(unittest.TestCase):
1218      original_socket_default_timeout = None
1219      @classmethod
1220      def setUpClass(cls):
1221          cls.original_socket_default_timeout = socket.getdefaulttimeout()
1222      @classmethod
1223      def tearDownClass(cls):
1224          socket.setdefaulttimeout(cls.original_socket_default_timeout)
1225      def test_build_http_sets_default_timeout_if_none_specified(self):
1226          socket.setdefaulttimeout(None)
1227          http = build_http()
1228          self.assertIsInstance(http.timeout, int)
1229          self.assertGreater(http.timeout, 0)
1230      def test_build_http_default_timeout_can_be_overridden(self):
1231          socket.setdefaulttimeout(1.5)
1232          http = build_http()
1233          self.assertAlmostEqual(http.timeout, 1.5, delta=0.001)
1234      def test_build_http_default_timeout_can_be_set_to_zero(self):
1235          socket.setdefaulttimeout(0)
1236          http = build_http()
1237          self.assertEqual(http.timeout, 0)
1238      def test_build_http_default_308_is_excluded_as_redirect(self):
1239          http = build_http()
1240          self.assertTrue(308 not in http.redirect_codes)
1241  if __name__ == &quot;__main__&quot;:
1242      logging.getLogger().setLevel(logging.ERROR)
1243      unittest.main()
</code></pre>
        </div>
        <div class="column">
            <h3>google-api-python-client-MDEwOlJlcG9zaXRvcnkxNTc0OTI2OQ==-flat-test_http.py</h3>
            <pre><code>1  #!/usr/bin/env python
2  from __future__ import absolute_import
3  __author__ = &quot;jcgregorio@google.com (Joe Gregorio)&quot;
4  import io
5  from io import FileIO
6  import json
7  import logging
8  import os
9  import random
10  import socket
11  import ssl
12  import time
13  import unittest
14  from unittest import mock
15  import urllib
16  import httplib2
17  from googleapiclient.discovery import build
18  from googleapiclient.errors import BatchError, HttpError, InvalidChunkSizeError
19  from googleapiclient.http import (
20      MAX_URI_LENGTH,
21      BatchHttpRequest,
22      HttpMock,
23      HttpMockSequence,
24      HttpRequest,
25      MediaFileUpload,
26      MediaInMemoryUpload,
27      MediaIoBaseDownload,
28      MediaIoBaseUpload,
29      MediaUpload,
30      _StreamSlice,
31      build_http,
32      set_user_agent,
33  )
34  from googleapiclient.model import JsonModel
35  class MockCredentials:
36      def __init__(self, bearer_token, expired=False):
37          super(MockCredentials, self).__init__()
38          self._authorized = 0
39          self._refreshed = 0
40          self._applied = 0
41          self._bearer_token = bearer_token
42          self._access_token_expired = expired
43      @property
44      def access_token(self):
45          return self._bearer_token
46      @property
47      def access_token_expired(self):
48          return self._access_token_expired
49      def authorize(self, http):
50          self._authorized += 1
51          request_orig = http.request
52          def new_request(
53              uri,
54              method=&quot;GET&quot;,
55              body=None,
56              headers=None,
57              redirections=httplib2.DEFAULT_MAX_REDIRECTS,
58              connection_type=None,
59          ):
60              if headers is None:
61                  headers = {}
62              self.apply(headers)
63              resp, content = request_orig(
64                  uri, method, body, headers, redirections, connection_type
65              )
66              return resp, content
67          http.request = new_request
68          setattr(http.request, &quot;credentials&quot;, self)
69          return http
70      def refresh(self, http):
71          self._refreshed += 1
72      def apply(self, headers):
73          self._applied += 1
74          headers[&quot;authorization&quot;] = self._bearer_token + &quot; &quot; + str(self._refreshed)
75  class HttpMockWithErrors(object):
76      def __init__(self, num_errors, success_json, success_data):
77          self.num_errors = num_errors
78          self.success_json = success_json
79          self.success_data = success_data
80      def request(self, *args, **kwargs):
81          if not self.num_errors:
82              return httplib2.Response(self.success_json), self.success_data
83          elif self.num_errors == 5:
84              ex = ConnectionResetError  # noqa: F821
85          elif self.num_errors == 4:
86              ex = httplib2.ServerNotFoundError()
87          elif self.num_errors == 3:
88              ex = OSError()
89              ex.errno = socket.errno.EPIPE
90          elif self.num_errors == 2:
91              ex = ssl.SSLError()
92          else:
93              try:
94                  ex = OSError()
95                  ex.errno = socket.errno.WSAETIMEDOUT
96              except AttributeError:
97                  ex = socket.timeout()
98          self.num_errors -= 1
99          raise ex
100  class HttpMockWithNonRetriableErrors(object):
101      def __init__(self, num_errors, success_json, success_data):
102          self.num_errors = num_errors
103          self.success_json = success_json
104          self.success_data = success_data
105      def request(self, *args, **kwargs):
106          if not self.num_errors:
107              return httplib2.Response(self.success_json), self.success_data
108          else:
109              self.num_errors -= 1
110              ex = OSError()
111              try:
112                  ex.errno = socket.errno.WSAEHOSTUNREACH
113              except AttributeError:
114                  ex.errno = socket.errno.EHOSTUNREACH
115              raise ex
116  DATA_DIR = os.path.join(os.path.dirname(__file__), &quot;data&quot;)
117  def datafile(filename):
118      return os.path.join(DATA_DIR, filename)
119  def _postproc_none(*kwargs):
120      pass
121  class TestUserAgent(unittest.TestCase):
122      def test_set_user_agent(self):
123          http = HttpMockSequence([({&quot;status&quot;: &quot;200&quot;}, &quot;echo_request_headers&quot;)])
124          http = set_user_agent(http, &quot;my_app/5.5&quot;)
125          resp, content = http.request(&quot;http://example.com&quot;)
126          self.assertEqual(&quot;my_app/5.5&quot;, content[&quot;user-agent&quot;])
127      def test_set_user_agent_nested(self):
128          http = HttpMockSequence([({&quot;status&quot;: &quot;200&quot;}, &quot;echo_request_headers&quot;)])
129          http = set_user_agent(http, &quot;my_app/5.5&quot;)
130          http = set_user_agent(http, &quot;my_library/0.1&quot;)
131          resp, content = http.request(&quot;http://example.com&quot;)
132          self.assertEqual(&quot;my_app/5.5 my_library/0.1&quot;, content[&quot;user-agent&quot;])
133  class TestMediaUpload(unittest.TestCase):
134      def test_media_file_upload_closes_fd_in___del__(self):
135          file_desc = mock.Mock(spec=io.TextIOWrapper)
136          opener = mock.mock_open(file_desc)
137          with mock.patch(&quot;builtins.open&quot;, return_value=opener):
138              upload = MediaFileUpload(datafile(&quot;test_close&quot;), mimetype=&quot;text/plain&quot;)
139          self.assertIs(upload.stream(), file_desc)
140          del upload
141          file_desc.close.assert_called_once_with()
142      def test_media_file_upload_mimetype_detection(self):
143          upload = MediaFileUpload(datafile(&quot;small.png&quot;))
144          self.assertEqual(&quot;image/png&quot;, upload.mimetype())
145          upload = MediaFileUpload(datafile(&quot;empty&quot;))
146          self.assertEqual(&quot;application/octet-stream&quot;, upload.mimetype())
147      def test_media_file_upload_to_from_json(self):
148          upload = MediaFileUpload(datafile(&quot;small.png&quot;), chunksize=500, resumable=True)
149          self.assertEqual(&quot;image/png&quot;, upload.mimetype())
150          self.assertEqual(190, upload.size())
151          self.assertEqual(True, upload.resumable())
152          self.assertEqual(500, upload.chunksize())
153          self.assertEqual(b&quot;PNG&quot;, upload.getbytes(1, 3))
154          json = upload.to_json()
155          new_upload = MediaUpload.new_from_json(json)
156          self.assertEqual(&quot;image/png&quot;, new_upload.mimetype())
157          self.assertEqual(190, new_upload.size())
158          self.assertEqual(True, new_upload.resumable())
159          self.assertEqual(500, new_upload.chunksize())
160          self.assertEqual(b&quot;PNG&quot;, new_upload.getbytes(1, 3))
161      def test_media_file_upload_raises_on_file_not_found(self):
162          with self.assertRaises(FileNotFoundError):
163              MediaFileUpload(datafile(&quot;missing.png&quot;))
164      def test_media_file_upload_raises_on_invalid_chunksize(self):
165          self.assertRaises(
166              InvalidChunkSizeError,
167              MediaFileUpload,
168              datafile(&quot;small.png&quot;),
169              mimetype=&quot;image/png&quot;,
170              chunksize=-2,
171              resumable=True,
172          )
173      def test_media_inmemory_upload(self):
174          media = MediaInMemoryUpload(
175              b&quot;abcdef&quot;, mimetype=&quot;text/plain&quot;, chunksize=10, resumable=True
176          )
177          self.assertEqual(&quot;text/plain&quot;, media.mimetype())
178          self.assertEqual(10, media.chunksize())
179          self.assertTrue(media.resumable())
180          self.assertEqual(b&quot;bc&quot;, media.getbytes(1, 2))
181          self.assertEqual(6, media.size())
182      def test_http_request_to_from_json(self):
183          http = build_http()
184          media_upload = MediaFileUpload(
185              datafile(&quot;small.png&quot;), chunksize=500, resumable=True
186          )
187          req = HttpRequest(
188              http,
189              _postproc_none,
190              &quot;http://example.com&quot;,
191              method=&quot;POST&quot;,
192              body=&quot;{}&quot;,
193              headers={&quot;content-type&quot;: &#x27;multipart/related; boundary=&quot;---flubber&quot;&#x27;},
194              methodId=&quot;foo&quot;,
195              resumable=media_upload,
196          )
197          json = req.to_json()
198          new_req = HttpRequest.from_json(json, http, _postproc_none)
199          self.assertEqual(
200              {&quot;content-type&quot;: &#x27;multipart/related; boundary=&quot;---flubber&quot;&#x27;},
201              new_req.headers,
202          )
203          self.assertEqual(&quot;http://example.com&quot;, new_req.uri)
204          self.assertEqual(&quot;{}&quot;, new_req.body)
205          self.assertEqual(http, new_req.http)
206          self.assertEqual(media_upload.to_json(), new_req.resumable.to_json())
207          self.assertEqual(random.random, new_req._rand)
208          self.assertEqual(time.sleep, new_req._sleep)
209  class TestMediaIoBaseUpload(unittest.TestCase):
210      def test_media_io_base_upload_from_file_io(self):
211          fd = FileIO(datafile(&quot;small.png&quot;), &quot;r&quot;)
212          upload = MediaIoBaseUpload(
213              fd=fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
214          )
215          self.assertEqual(&quot;image/png&quot;, upload.mimetype())
216          self.assertEqual(190, upload.size())
217          self.assertEqual(True, upload.resumable())
218          self.assertEqual(500, upload.chunksize())
219          self.assertEqual(b&quot;PNG&quot;, upload.getbytes(1, 3))
220      def test_media_io_base_upload_from_file_object(self):
221          f = open(datafile(&quot;small.png&quot;), &quot;rb&quot;)
222          upload = MediaIoBaseUpload(
223              fd=f, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
224          )
225          self.assertEqual(&quot;image/png&quot;, upload.mimetype())
226          self.assertEqual(190, upload.size())
227          self.assertEqual(True, upload.resumable())
228          self.assertEqual(500, upload.chunksize())
229          self.assertEqual(b&quot;PNG&quot;, upload.getbytes(1, 3))
230          f.close()
231      def test_media_io_base_upload_serializable(self):
232          f = open(datafile(&quot;small.png&quot;), &quot;rb&quot;)
233          upload = MediaIoBaseUpload(fd=f, mimetype=&quot;image/png&quot;)
234          try:
235              json = upload.to_json()
236              self.fail(&quot;MediaIoBaseUpload should not be serializable.&quot;)
237          except NotImplementedError:
238              pass
239      def test_media_io_base_upload_from_bytes(self):
240          f = open(datafile(&quot;small.png&quot;), &quot;rb&quot;)
241          fd = io.BytesIO(f.read())
242          upload = MediaIoBaseUpload(
243              fd=fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
244          )
245          self.assertEqual(&quot;image/png&quot;, upload.mimetype())
246          self.assertEqual(190, upload.size())
247          self.assertEqual(True, upload.resumable())
248          self.assertEqual(500, upload.chunksize())
249          self.assertEqual(b&quot;PNG&quot;, upload.getbytes(1, 3))
250      def test_media_io_base_upload_raises_on_invalid_chunksize(self):
251          f = open(datafile(&quot;small.png&quot;), &quot;rb&quot;)
252          fd = io.BytesIO(f.read())
253          self.assertRaises(
254              InvalidChunkSizeError,
255              MediaIoBaseUpload,
256              fd,
257              &quot;image/png&quot;,
<span onclick='openModal()' class='match'>258              chunksize=-2,
259              resumable=True,
260          )
261      def test_media_io_base_upload_streamable(self):
262          fd = io.BytesIO(b&quot;stuff&quot;)
</span>263          upload = MediaIoBaseUpload(
264              fd=fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
265          )
266          self.assertEqual(True, upload.has_stream())
267          self.assertEqual(fd, upload.stream())
268      def test_media_io_base_next_chunk_retries(self):
269          f = open(datafile(&quot;small.png&quot;), &quot;rb&quot;)
270          fd = io.BytesIO(f.read())
271          upload = MediaIoBaseUpload(
272              fd=fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
273          )
274          http = HttpMockSequence(
275              [
276                  ({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;),
277                  ({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;),
278                  ({&quot;status&quot;: &quot;503&quot;}, &quot;&quot;),
279                  ({&quot;status&quot;: &quot;200&quot;, &quot;location&quot;: &quot;location&quot;}, &quot;&quot;),
280                  ({&quot;status&quot;: &quot;403&quot;}, USER_RATE_LIMIT_EXCEEDED_RESPONSE_NO_STATUS),
281                  ({&quot;status&quot;: &quot;403&quot;}, RATE_LIMIT_EXCEEDED_RESPONSE),
282                  ({&quot;status&quot;: &quot;429&quot;}, &quot;&quot;),
283                  ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;),
284              ]
285          )
286          model = JsonModel()
287          uri = &quot;https://www.googleapis.com/someapi/v1/upload/?foo=bar&quot;
288          method = &quot;POST&quot;
289          request = HttpRequest(
290              http, model.response, uri, method=method, headers={}, resumable=upload
291          )
292          sleeptimes = []
293          request._sleep = lambda x: sleeptimes.append(x)
294          request._rand = lambda: 10
295          request.execute(num_retries=3)
296          self.assertEqual([20, 40, 80, 20, 40, 80], sleeptimes)
297      def test_media_io_base_next_chunk_no_retry_403_not_configured(self):
298          fd = io.BytesIO(b&quot;i am png&quot;)
299          upload = MediaIoBaseUpload(
300              fd=fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
301          )
302          http = HttpMockSequence(
303              [({&quot;status&quot;: &quot;403&quot;}, NOT_CONFIGURED_RESPONSE), ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;)]
304          )
305          model = JsonModel()
306          uri = &quot;https://www.googleapis.com/someapi/v1/upload/?foo=bar&quot;
307          method = &quot;POST&quot;
308          request = HttpRequest(
309              http, model.response, uri, method=method, headers={}, resumable=upload
310          )
311          request._rand = lambda: 1.0
312          request._sleep = mock.MagicMock()
313          with self.assertRaises(HttpError):
314              request.execute(num_retries=3)
315          request._sleep.assert_not_called()
316      def test_media_io_base_empty_file(self):
317          fd = io.BytesIO()
318          upload = MediaIoBaseUpload(
319              fd=fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
320          )
321          http = HttpMockSequence(
322              [
323                  (
324                      {
325                          &quot;status&quot;: &quot;200&quot;,
326                          &quot;location&quot;: &quot;https://www.googleapis.com/someapi/v1/upload?foo=bar&quot;,
327                      },
328                      &quot;{}&quot;,
329                  ),
330                  (
331                      {
332                          &quot;status&quot;: &quot;200&quot;,
333                          &quot;location&quot;: &quot;https://www.googleapis.com/someapi/v1/upload?foo=bar&quot;,
334                      },
335                      &quot;{}&quot;,
336                  ),
337              ]
338          )
339          model = JsonModel()
340          uri = &quot;https://www.googleapis.com/someapi/v1/upload/?foo=bar&quot;
341          method = &quot;POST&quot;
342          request = HttpRequest(
343              http, model.response, uri, method=method, headers={}, resumable=upload
344          )
345          request.execute()
346          self.assertTrue(&quot;Content-Range&quot; not in http.request_sequence[-1][-1])
347          self.assertEqual(&quot;0&quot;, http.request_sequence[-1][-1][&quot;Content-Length&quot;])
348  class TestMediaIoBaseDownload(unittest.TestCase):
349      def setUp(self):
350          http = HttpMock(datafile(&quot;zoo.json&quot;), {&quot;status&quot;: &quot;200&quot;})
351          zoo = build(&quot;zoo&quot;, &quot;v1&quot;, http=http, static_discovery=False)
352          self.request = zoo.animals().get_media(name=&quot;Lion&quot;)
353          self.fd = io.BytesIO()
354      def test_media_io_base_download(self):
355          self.request.http = HttpMockSequence(
356              [
357                  ({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/5&quot;}, b&quot;123&quot;),
358                  ({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;3-4/5&quot;}, b&quot;45&quot;),
359              ]
360          )
361          self.assertEqual(True, self.request.http.follow_redirects)
362          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
363          self.assertEqual(self.fd, download._fd)
364          self.assertEqual(3, download._chunksize)
365          self.assertEqual(0, download._progress)
366          self.assertEqual(None, download._total_size)
367          self.assertEqual(False, download._done)
368          self.assertEqual(self.request.uri, download._uri)
369          status, done = download.next_chunk()
370          self.assertEqual(self.fd.getvalue(), b&quot;123&quot;)
371          self.assertEqual(False, done)
372          self.assertEqual(3, download._progress)
373          self.assertEqual(5, download._total_size)
374          self.assertEqual(3, status.resumable_progress)
375          status, done = download.next_chunk()
376          self.assertEqual(self.fd.getvalue(), b&quot;12345&quot;)
377          self.assertEqual(True, done)
378          self.assertEqual(5, download._progress)
379          self.assertEqual(5, download._total_size)
380      def test_media_io_base_download_range_request_header(self):
381          self.request.http = HttpMockSequence(
382              [
383                  (
384                      {&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/5&quot;},
385                      &quot;echo_request_headers_as_json&quot;,
386                  ),
387              ]
388          )
389          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
390          status, done = download.next_chunk()
391          result = json.loads(self.fd.getvalue().decode(&quot;utf-8&quot;))
392          self.assertEqual(result.get(&quot;range&quot;), &quot;bytes=0-2&quot;)
393      def test_media_io_base_download_custom_request_headers(self):
394          self.request.http = HttpMockSequence(
395              [
396                  (
397                      {&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/5&quot;},
398                      &quot;echo_request_headers_as_json&quot;,
399                  ),
400                  (
401                      {&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;3-4/5&quot;},
402                      &quot;echo_request_headers_as_json&quot;,
403                  ),
404              ]
405          )
406          self.assertEqual(True, self.request.http.follow_redirects)
407          self.request.headers[&quot;Cache-Control&quot;] = &quot;no-store&quot;
408          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
409          self.assertEqual(download._headers.get(&quot;Cache-Control&quot;), &quot;no-store&quot;)
410          status, done = download.next_chunk()
411          result = json.loads(self.fd.getvalue().decode(&quot;utf-8&quot;))
412          self.assertEqual(result.get(&quot;Cache-Control&quot;), &quot;no-store&quot;)
413          download._fd = self.fd = io.BytesIO()
414          status, done = download.next_chunk()
415          result = json.loads(self.fd.getvalue().decode(&quot;utf-8&quot;))
416          self.assertEqual(result.get(&quot;Cache-Control&quot;), &quot;no-store&quot;)
417      def test_media_io_base_download_handle_redirects(self):
418          self.request.http = HttpMockSequence(
419              [
420                  (
421                      {
422                          &quot;status&quot;: &quot;200&quot;,
423                          &quot;content-location&quot;: &quot;https://secure.example.net/lion&quot;,
424                      },
425                      b&quot;&quot;,
426                  ),
427                  ({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/5&quot;}, b&quot;abc&quot;),
428              ]
429          )
430          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
431          status, done = download.next_chunk()
432          self.assertEqual(&quot;https://secure.example.net/lion&quot;, download._uri)
433      def test_media_io_base_download_handle_4xx(self):
434          self.request.http = HttpMockSequence([({&quot;status&quot;: &quot;400&quot;}, &quot;&quot;)])
435          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
436          try:
437              status, done = download.next_chunk()
438              self.fail(&quot;Should raise an exception&quot;)
439          except HttpError:
440              pass
441          self.request.http = HttpMockSequence(
442              [({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/5&quot;}, b&quot;123&quot;)]
443          )
444          status, done = download.next_chunk()
445          self.assertEqual(self.fd.getvalue(), b&quot;123&quot;)
446      def test_media_io_base_download_retries_connection_errors(self):
447          self.request.http = HttpMockWithErrors(
448              5, {&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/3&quot;}, b&quot;123&quot;
449          )
450          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
451          download._sleep = lambda _x: 0  # do nothing
452          download._rand = lambda: 10
453          status, done = download.next_chunk(num_retries=5)
454          self.assertEqual(self.fd.getvalue(), b&quot;123&quot;)
455          self.assertEqual(True, done)
456      def test_media_io_base_download_retries_5xx(self):
457          self.request.http = HttpMockSequence(
458              [
459                  ({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;),
460                  ({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;),
461                  ({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;),
462                  ({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-2/5&quot;}, b&quot;123&quot;),
463                  ({&quot;status&quot;: &quot;503&quot;}, &quot;&quot;),
464                  ({&quot;status&quot;: &quot;503&quot;}, &quot;&quot;),
465                  ({&quot;status&quot;: &quot;503&quot;}, &quot;&quot;),
466                  ({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;3-4/5&quot;}, b&quot;45&quot;),
467              ]
468          )
469          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
470          self.assertEqual(self.fd, download._fd)
471          self.assertEqual(3, download._chunksize)
472          self.assertEqual(0, download._progress)
473          self.assertEqual(None, download._total_size)
474          self.assertEqual(False, download._done)
475          self.assertEqual(self.request.uri, download._uri)
476          sleeptimes = []
477          download._sleep = lambda x: sleeptimes.append(x)
478          download._rand = lambda: 10
479          status, done = download.next_chunk(num_retries=3)
480          self.assertEqual([20, 40, 80], sleeptimes)
481          self.assertEqual(self.fd.getvalue(), b&quot;123&quot;)
482          self.assertEqual(False, done)
483          self.assertEqual(3, download._progress)
484          self.assertEqual(5, download._total_size)
485          self.assertEqual(3, status.resumable_progress)
486          del sleeptimes[0 : len(sleeptimes)]
487          status, done = download.next_chunk(num_retries=3)
488          self.assertEqual([20, 40, 80], sleeptimes)
489          self.assertEqual(self.fd.getvalue(), b&quot;12345&quot;)
490          self.assertEqual(True, done)
491          self.assertEqual(5, download._progress)
492          self.assertEqual(5, download._total_size)
493      def test_media_io_base_download_empty_file(self):
494          self.request.http = HttpMockSequence(
495              [({&quot;status&quot;: &quot;200&quot;, &quot;content-range&quot;: &quot;0-0/0&quot;}, b&quot;&quot;)]
496          )
497          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
498          self.assertEqual(self.fd, download._fd)
499          self.assertEqual(0, download._progress)
500          self.assertEqual(None, download._total_size)
501          self.assertEqual(False, download._done)
502          self.assertEqual(self.request.uri, download._uri)
503          status, done = download.next_chunk()
504          self.assertEqual(True, done)
505          self.assertEqual(0, download._progress)
506          self.assertEqual(0, download._total_size)
507          self.assertEqual(0, status.progress())
508      def test_media_io_base_download_empty_file_416_response(self):
509          self.request.http = HttpMockSequence(
510              [({&quot;status&quot;: &quot;416&quot;, &quot;content-range&quot;: &quot;0-0/0&quot;}, b&quot;&quot;)]
511          )
512          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
513          self.assertEqual(self.fd, download._fd)
514          self.assertEqual(0, download._progress)
515          self.assertEqual(None, download._total_size)
516          self.assertEqual(False, download._done)
517          self.assertEqual(self.request.uri, download._uri)
518          status, done = download.next_chunk()
519          self.assertEqual(True, done)
520          self.assertEqual(0, download._progress)
521          self.assertEqual(0, download._total_size)
522          self.assertEqual(0, status.progress())
523      def test_media_io_base_download_unknown_media_size(self):
524          self.request.http = HttpMockSequence([({&quot;status&quot;: &quot;200&quot;}, b&quot;123&quot;)])
525          download = MediaIoBaseDownload(fd=self.fd, request=self.request, chunksize=3)
526          self.assertEqual(self.fd, download._fd)
527          self.assertEqual(0, download._progress)
528          self.assertEqual(None, download._total_size)
529          self.assertEqual(False, download._done)
530          self.assertEqual(self.request.uri, download._uri)
531          status, done = download.next_chunk()
532          self.assertEqual(self.fd.getvalue(), b&quot;123&quot;)
533          self.assertEqual(True, done)
534          self.assertEqual(3, download._progress)
535          self.assertEqual(None, download._total_size)
536          self.assertEqual(0, status.progress())
537  EXPECTED = 
538  NO_BODY_EXPECTED = 
539  NO_BODY_EXPECTED_GET = 
540  RESPONSE = 
541  BATCH_RESPONSE = b
542  BATCH_ERROR_RESPONSE = b
543  BATCH_RESPONSE_WITH_401 = b
544  BATCH_SINGLE_RESPONSE = b
545  USER_RATE_LIMIT_EXCEEDED_RESPONSE_NO_STATUS = 
546  USER_RATE_LIMIT_EXCEEDED_RESPONSE_WITH_STATUS = 
547  RATE_LIMIT_EXCEEDED_RESPONSE = 
548  NOT_CONFIGURED_RESPONSE = 
549  LIST_NOT_CONFIGURED_RESPONSE = 
550  class Callbacks(object):
551      def __init__(self):
552          self.responses = {}
553          self.exceptions = {}
554      def f(self, request_id, response, exception):
555          self.responses[request_id] = response
556          self.exceptions[request_id] = exception
557  class TestHttpRequest(unittest.TestCase):
558      def test_unicode(self):
559          http = HttpMock(datafile(&quot;zoo.json&quot;), headers={&quot;status&quot;: &quot;200&quot;})
560          model = JsonModel()
561          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
562          method = &quot;POST&quot;
563          request = HttpRequest(
564              http,
565              model.response,
566              uri,
567              method=method,
568              body=&quot;{}&quot;,
569              headers={&quot;content-type&quot;: &quot;application/json&quot;},
570          )
571          request.execute()
572          self.assertEqual(uri, http.uri)
573          self.assertEqual(str, type(http.uri))
574          self.assertEqual(method, http.method)
575          self.assertEqual(str, type(http.method))
576      def test_empty_content_type(self):
577          http = HttpMock(None, headers={&quot;status&quot;: 200})
578          uri = &quot;https://www.googleapis.com/someapi/v1/upload/?foo=bar&quot;
579          method = &quot;POST&quot;
580          request = HttpRequest(
581              http, _postproc_none, uri, method=method, headers={&quot;content-type&quot;: &quot;&quot;}
582          )
583          request.execute()
584          self.assertEqual(&quot;&quot;, http.headers.get(&quot;content-type&quot;))
585      def test_no_retry_connection_errors(self):
586          model = JsonModel()
587          request = HttpRequest(
588              HttpMockWithNonRetriableErrors(1, {&quot;status&quot;: &quot;200&quot;}, &#x27;{&quot;foo&quot;: &quot;bar&quot;}&#x27;),
589              model.response,
590              &quot;https://www.example.com/json_api_endpoint&quot;,
591          )
592          request._sleep = lambda _x: 0  # do nothing
593          request._rand = lambda: 10
594          with self.assertRaises(OSError):
595              response = request.execute(num_retries=3)
596      def test_retry_connection_errors_non_resumable(self):
597          model = JsonModel()
598          request = HttpRequest(
599              HttpMockWithErrors(5, {&quot;status&quot;: &quot;200&quot;}, &#x27;{&quot;foo&quot;: &quot;bar&quot;}&#x27;),
600              model.response,
601              &quot;https://www.example.com/json_api_endpoint&quot;,
602          )
603          request._sleep = lambda _x: 0  # do nothing
604          request._rand = lambda: 10
605          response = request.execute(num_retries=5)
606          self.assertEqual({&quot;foo&quot;: &quot;bar&quot;}, response)
607      def test_retry_connection_errors_resumable(self):
608          with open(datafile(&quot;small.png&quot;), &quot;rb&quot;) as small_png_file:
609              small_png_fd = io.BytesIO(small_png_file.read())
610          upload = MediaIoBaseUpload(
611              fd=small_png_fd, mimetype=&quot;image/png&quot;, chunksize=500, resumable=True
612          )
613          model = JsonModel()
614          request = HttpRequest(
615              HttpMockWithErrors(
616                  5, {&quot;status&quot;: &quot;200&quot;, &quot;location&quot;: &quot;location&quot;}, &#x27;{&quot;foo&quot;: &quot;bar&quot;}&#x27;
617              ),
618              model.response,
619              &quot;https://www.example.com/file_upload&quot;,
620              method=&quot;POST&quot;,
621              resumable=upload,
622          )
623          request._sleep = lambda _x: 0  # do nothing
624          request._rand = lambda: 10
625          response = request.execute(num_retries=5)
626          self.assertEqual({&quot;foo&quot;: &quot;bar&quot;}, response)
627      def test_retry(self):
628          num_retries = 6
629          resp_seq = [({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;)] * (num_retries - 4)
630          resp_seq.append(({&quot;status&quot;: &quot;403&quot;}, RATE_LIMIT_EXCEEDED_RESPONSE))
631          resp_seq.append(
632              ({&quot;status&quot;: &quot;403&quot;}, USER_RATE_LIMIT_EXCEEDED_RESPONSE_NO_STATUS)
633          )
634          resp_seq.append(
635              ({&quot;status&quot;: &quot;403&quot;}, USER_RATE_LIMIT_EXCEEDED_RESPONSE_WITH_STATUS)
636          )
637          resp_seq.append(({&quot;status&quot;: &quot;429&quot;}, &quot;&quot;))
638          resp_seq.append(({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;))
639          http = HttpMockSequence(resp_seq)
640          model = JsonModel()
641          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
642          method = &quot;POST&quot;
643          request = HttpRequest(
644              http,
645              model.response,
646              uri,
647              method=method,
648              body=&quot;{}&quot;,
649              headers={&quot;content-type&quot;: &quot;application/json&quot;},
650          )
651          sleeptimes = []
652          request._sleep = lambda x: sleeptimes.append(x)
653          request._rand = lambda: 10
654          request.execute(num_retries=num_retries)
655          self.assertEqual(num_retries, len(sleeptimes))
656          for retry_num in range(num_retries):
657              self.assertEqual(10 * 2 ** (retry_num + 1), sleeptimes[retry_num])
658      def test_no_retry_succeeds(self):
659          num_retries = 5
660          resp_seq = [({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;)] * (num_retries)
661          http = HttpMockSequence(resp_seq)
662          model = JsonModel()
663          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
664          method = &quot;POST&quot;
665          request = HttpRequest(
666              http,
667              model.response,
668              uri,
669              method=method,
670              body=&quot;{}&quot;,
671              headers={&quot;content-type&quot;: &quot;application/json&quot;},
672          )
673          sleeptimes = []
674          request._sleep = lambda x: sleeptimes.append(x)
675          request._rand = lambda: 10
676          request.execute(num_retries=num_retries)
677          self.assertEqual(0, len(sleeptimes))
678      def test_no_retry_fails_fast(self):
679          http = HttpMockSequence([({&quot;status&quot;: &quot;500&quot;}, &quot;&quot;), ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;)])
680          model = JsonModel()
681          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
682          method = &quot;POST&quot;
683          request = HttpRequest(
684              http,
685              model.response,
686              uri,
687              method=method,
688              body=&quot;{}&quot;,
689              headers={&quot;content-type&quot;: &quot;application/json&quot;},
690          )
691          request._rand = lambda: 1.0
692          request._sleep = mock.MagicMock()
693          with self.assertRaises(HttpError):
694              request.execute()
695          request._sleep.assert_not_called()
696      def test_no_retry_403_not_configured_fails_fast(self):
697          http = HttpMockSequence(
698              [({&quot;status&quot;: &quot;403&quot;}, NOT_CONFIGURED_RESPONSE), ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;)]
699          )
700          model = JsonModel()
701          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
702          method = &quot;POST&quot;
703          request = HttpRequest(
704              http,
705              model.response,
706              uri,
707              method=method,
708              body=&quot;{}&quot;,
709              headers={&quot;content-type&quot;: &quot;application/json&quot;},
710          )
711          request._rand = lambda: 1.0
712          request._sleep = mock.MagicMock()
713          with self.assertRaises(HttpError):
714              request.execute()
715          request._sleep.assert_not_called()
716      def test_no_retry_403_fails_fast(self):
717          http = HttpMockSequence([({&quot;status&quot;: &quot;403&quot;}, &quot;&quot;), ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;)])
718          model = JsonModel()
719          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
720          method = &quot;POST&quot;
721          request = HttpRequest(
722              http,
723              model.response,
724              uri,
725              method=method,
726              body=&quot;{}&quot;,
727              headers={&quot;content-type&quot;: &quot;application/json&quot;},
728          )
729          request._rand = lambda: 1.0
730          request._sleep = mock.MagicMock()
731          with self.assertRaises(HttpError):
732              request.execute()
733          request._sleep.assert_not_called()
734      def test_no_retry_401_fails_fast(self):
735          http = HttpMockSequence([({&quot;status&quot;: &quot;401&quot;}, &quot;&quot;), ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;)])
736          model = JsonModel()
737          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
738          method = &quot;POST&quot;
739          request = HttpRequest(
740              http,
741              model.response,
742              uri,
743              method=method,
744              body=&quot;{}&quot;,
745              headers={&quot;content-type&quot;: &quot;application/json&quot;},
746          )
747          request._rand = lambda: 1.0
748          request._sleep = mock.MagicMock()
749          with self.assertRaises(HttpError):
750              request.execute()
751          request._sleep.assert_not_called()
752      def test_no_retry_403_list_fails(self):
753          http = HttpMockSequence(
754              [
755                  ({&quot;status&quot;: &quot;403&quot;}, LIST_NOT_CONFIGURED_RESPONSE),
756                  ({&quot;status&quot;: &quot;200&quot;}, &quot;{}&quot;),
757              ]
758          )
759          model = JsonModel()
760          uri = &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;
761          method = &quot;POST&quot;
762          request = HttpRequest(
763              http,
764              model.response,
765              uri,
766              method=method,
767              body=&quot;{}&quot;,
768              headers={&quot;content-type&quot;: &quot;application/json&quot;},
769          )
770          request._rand = lambda: 1.0
771          request._sleep = mock.MagicMock()
772          with self.assertRaises(HttpError):
773              request.execute()
774          request._sleep.assert_not_called()
775      def test_null_postproc(self):
776          resp, content = HttpRequest.null_postproc(&quot;foo&quot;, &quot;bar&quot;)
777          self.assertEqual(resp, &quot;foo&quot;)
778          self.assertEqual(content, &quot;bar&quot;)
779  class TestBatch(unittest.TestCase):
780      def setUp(self):
781          model = JsonModel()
782          self.request1 = HttpRequest(
783              None,
784              model.response,
785              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
786              method=&quot;POST&quot;,
787              body=&quot;{}&quot;,
788              headers={&quot;content-type&quot;: &quot;application/json&quot;},
789          )
790          self.request2 = HttpRequest(
791              None,
792              model.response,
793              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
794              method=&quot;GET&quot;,
795              body=&quot;&quot;,
796              headers={&quot;content-type&quot;: &quot;application/json&quot;},
797          )
798      def test_id_to_from_content_id_header(self):
799          batch = BatchHttpRequest()
800          self.assertEqual(&quot;12&quot;, batch._header_to_id(batch._id_to_header(&quot;12&quot;)))
801      def test_invalid_content_id_header(self):
802          batch = BatchHttpRequest()
803          self.assertRaises(BatchError, batch._header_to_id, &quot;[foo+x]&quot;)
804          self.assertRaises(BatchError, batch._header_to_id, &quot;foo+1&quot;)
805          self.assertRaises(BatchError, batch._header_to_id, &quot;&lt;foo&gt;&quot;)
806      def test_serialize_request(self):
807          batch = BatchHttpRequest()
808          request = HttpRequest(
809              None,
810              None,
811              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
812              method=&quot;POST&quot;,
813              body=&quot;{}&quot;,
814              headers={&quot;content-type&quot;: &quot;application/json&quot;},
815              methodId=None,
816              resumable=None,
817          )
818          s = batch._serialize_request(request).splitlines()
819          self.assertEqual(EXPECTED.splitlines(), s)
820      def test_serialize_request_media_body(self):
821          batch = BatchHttpRequest()
822          f = open(datafile(&quot;small.png&quot;), &quot;rb&quot;)
823          body = f.read()
824          f.close()
825          request = HttpRequest(
826              None,
827              None,
828              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
829              method=&quot;POST&quot;,
830              body=body,
831              headers={&quot;content-type&quot;: &quot;application/json&quot;},
832              methodId=None,
833              resumable=None,
834          )
835          s = batch._serialize_request(request).splitlines()
836      def test_serialize_request_no_body(self):
837          batch = BatchHttpRequest()
838          request = HttpRequest(
839              None,
840              None,
841              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
842              method=&quot;POST&quot;,
843              body=b&quot;&quot;,
844              headers={&quot;content-type&quot;: &quot;application/json&quot;},
845              methodId=None,
846              resumable=None,
847          )
848          s = batch._serialize_request(request).splitlines()
849          self.assertEqual(NO_BODY_EXPECTED.splitlines(), s)
850      def test_serialize_get_request_no_body(self):
851          batch = BatchHttpRequest()
852          request = HttpRequest(
853              None,
854              None,
855              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
856              method=&quot;GET&quot;,
857              body=None,
858              headers={&quot;content-type&quot;: &quot;application/json&quot;},
859              methodId=None,
860              resumable=None,
861          )
862          s = batch._serialize_request(request).splitlines()
863          self.assertEqual(NO_BODY_EXPECTED_GET.splitlines(), s)
864      def test_deserialize_response(self):
865          batch = BatchHttpRequest()
866          resp, content = batch._deserialize_response(RESPONSE)
867          self.assertEqual(200, resp.status)
868          self.assertEqual(&quot;OK&quot;, resp.reason)
869          self.assertEqual(11, resp.version)
870          self.assertEqual(&#x27;{&quot;answer&quot;: 42}&#x27;, content)
871      def test_new_id(self):
872          batch = BatchHttpRequest()
873          id_ = batch._new_id()
874          self.assertEqual(&quot;1&quot;, id_)
875          id_ = batch._new_id()
876          self.assertEqual(&quot;2&quot;, id_)
877          batch.add(self.request1, request_id=&quot;3&quot;)
878          id_ = batch._new_id()
879          self.assertEqual(&quot;4&quot;, id_)
880      def test_add(self):
881          batch = BatchHttpRequest()
882          batch.add(self.request1, request_id=&quot;1&quot;)
883          self.assertRaises(KeyError, batch.add, self.request1, request_id=&quot;1&quot;)
884      def test_add_fail_for_over_limit(self):
885          from googleapiclient.http import MAX_BATCH_LIMIT
886          batch = BatchHttpRequest()
887          for i in range(0, MAX_BATCH_LIMIT):
888              batch.add(
889                  HttpRequest(
890                      None,
891                      None,
892                      &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
893                      method=&quot;POST&quot;,
894                      body=&quot;{}&quot;,
895                      headers={&quot;content-type&quot;: &quot;application/json&quot;},
896                  )
897              )
898          self.assertRaises(BatchError, batch.add, self.request1)
899      def test_add_fail_for_resumable(self):
900          batch = BatchHttpRequest()
901          upload = MediaFileUpload(datafile(&quot;small.png&quot;), chunksize=500, resumable=True)
902          self.request1.resumable = upload
903          with self.assertRaises(BatchError) as batch_error:
904              batch.add(self.request1, request_id=&quot;1&quot;)
905          str(batch_error.exception)
906      def test_execute_empty_batch_no_http(self):
907          batch = BatchHttpRequest()
908          ret = batch.execute()
909          self.assertEqual(None, ret)
910      def test_execute(self):
911          batch = BatchHttpRequest()
912          callbacks = Callbacks()
913          batch.add(self.request1, callback=callbacks.f)
914          batch.add(self.request2, callback=callbacks.f)
915          http = HttpMockSequence(
916              [
917                  (
918                      {
919                          &quot;status&quot;: &quot;200&quot;,
920                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
921                      },
922                      BATCH_RESPONSE,
923                  )
924              ]
925          )
926          batch.execute(http=http)
927          self.assertEqual({&quot;foo&quot;: 42}, callbacks.responses[&quot;1&quot;])
928          self.assertEqual(None, callbacks.exceptions[&quot;1&quot;])
929          self.assertEqual({&quot;baz&quot;: &quot;qux&quot;}, callbacks.responses[&quot;2&quot;])
930          self.assertEqual(None, callbacks.exceptions[&quot;2&quot;])
931      def test_execute_request_body(self):
932          batch = BatchHttpRequest()
933          batch.add(self.request1)
934          batch.add(self.request2)
935          http = HttpMockSequence(
936              [
937                  (
938                      {
939                          &quot;status&quot;: &quot;200&quot;,
940                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
941                      },
942                      &quot;echo_request_body&quot;,
943                  )
944              ]
945          )
946          try:
947              batch.execute(http=http)
948              self.fail(&quot;Should raise exception&quot;)
949          except BatchError as e:
950              boundary, _ = e.content.split(None, 1)
951              self.assertEqual(&quot;--&quot;, boundary[:2])
952              parts = e.content.split(boundary)
953              self.assertEqual(4, len(parts))
954              self.assertEqual(&quot;&quot;, parts[0])
955              self.assertEqual(&quot;--&quot;, parts[3].rstrip())
956              header = parts[1].splitlines()[1]
957              self.assertEqual(&quot;Content-Type: application/http&quot;, header)
958      def test_execute_request_body_with_custom_long_request_ids(self):
959          batch = BatchHttpRequest()
960          batch.add(self.request1, request_id=&quot;abc&quot; * 20)
961          batch.add(self.request2, request_id=&quot;def&quot; * 20)
962          http = HttpMockSequence(
963              [
964                  (
965                      {
966                          &quot;status&quot;: &quot;200&quot;,
967                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
968                      },
969                      &quot;echo_request_body&quot;,
970                  )
971              ]
972          )
973          try:
974              batch.execute(http=http)
975              self.fail(&quot;Should raise exception&quot;)
976          except BatchError as e:
977              boundary, _ = e.content.split(None, 1)
978              self.assertEqual(&quot;--&quot;, boundary[:2])
979              parts = e.content.split(boundary)
980              self.assertEqual(4, len(parts))
981              self.assertEqual(&quot;&quot;, parts[0])
982              self.assertEqual(&quot;--&quot;, parts[3].rstrip())
983              for partindex, request_id in ((1, &quot;abc&quot; * 20), (2, &quot;def&quot; * 20)):
984                  lines = parts[partindex].splitlines()
985                  for n, line in enumerate(lines):
986                      if line.startswith(&quot;Content-ID:&quot;):
987                          self.assertTrue(line.endswith(&quot;+&quot;), line)
988                          header_continuation = lines[n + 1]
989                          self.assertEqual(
990                              header_continuation,
991                              &quot; %s&gt;&quot; % request_id,
992                              header_continuation,
993                          )
994      def test_execute_initial_refresh_oauth2(self):
995          batch = BatchHttpRequest()
996          callbacks = Callbacks()
997          cred = MockCredentials(&quot;Foo&quot;, expired=True)
998          http = HttpMockSequence(
999              [
1000                  (
1001                      {
1002                          &quot;status&quot;: &quot;200&quot;,
1003                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1004                      },
1005                      BATCH_SINGLE_RESPONSE,
1006                  )
1007              ]
1008          )
1009          cred.authorize(http)
1010          batch.add(self.request1, callback=callbacks.f)
1011          batch.execute(http=http)
1012          self.assertEqual({&quot;foo&quot;: 42}, callbacks.responses[&quot;1&quot;])
1013          self.assertIsNone(callbacks.exceptions[&quot;1&quot;])
1014          self.assertEqual(1, cred._refreshed)
1015          self.assertEqual(1, cred._authorized)
1016          self.assertEqual(1, cred._applied)
1017      def test_execute_refresh_and_retry_on_401(self):
1018          batch = BatchHttpRequest()
1019          callbacks = Callbacks()
1020          cred_1 = MockCredentials(&quot;Foo&quot;)
1021          cred_2 = MockCredentials(&quot;Bar&quot;)
1022          http = HttpMockSequence(
1023              [
1024                  (
1025                      {
1026                          &quot;status&quot;: &quot;200&quot;,
1027                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1028                      },
1029                      BATCH_RESPONSE_WITH_401,
1030                  ),
1031                  (
1032                      {
1033                          &quot;status&quot;: &quot;200&quot;,
1034                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1035                      },
1036                      BATCH_SINGLE_RESPONSE,
1037                  ),
1038              ]
1039          )
1040          creds_http_1 = HttpMockSequence([])
1041          cred_1.authorize(creds_http_1)
1042          creds_http_2 = HttpMockSequence([])
1043          cred_2.authorize(creds_http_2)
1044          self.request1.http = creds_http_1
1045          self.request2.http = creds_http_2
1046          batch.add(self.request1, callback=callbacks.f)
1047          batch.add(self.request2, callback=callbacks.f)
1048          batch.execute(http=http)
1049          self.assertEqual({&quot;foo&quot;: 42}, callbacks.responses[&quot;1&quot;])
1050          self.assertEqual(None, callbacks.exceptions[&quot;1&quot;])
1051          self.assertEqual({&quot;baz&quot;: &quot;qux&quot;}, callbacks.responses[&quot;2&quot;])
1052          self.assertEqual(None, callbacks.exceptions[&quot;2&quot;])
1053          self.assertEqual(1, cred_1._refreshed)
1054          self.assertEqual(0, cred_2._refreshed)
1055          self.assertEqual(1, cred_1._authorized)
1056          self.assertEqual(1, cred_2._authorized)
1057          self.assertEqual(1, cred_2._applied)
1058          self.assertEqual(2, cred_1._applied)
1059      def test_http_errors_passed_to_callback(self):
1060          batch = BatchHttpRequest()
1061          callbacks = Callbacks()
1062          cred_1 = MockCredentials(&quot;Foo&quot;)
1063          cred_2 = MockCredentials(&quot;Bar&quot;)
1064          http = HttpMockSequence(
1065              [
1066                  (
1067                      {
1068                          &quot;status&quot;: &quot;200&quot;,
1069                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1070                      },
1071                      BATCH_RESPONSE_WITH_401,
1072                  ),
1073                  (
1074                      {
1075                          &quot;status&quot;: &quot;200&quot;,
1076                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1077                      },
1078                      BATCH_RESPONSE_WITH_401,
1079                  ),
1080              ]
1081          )
1082          creds_http_1 = HttpMockSequence([])
1083          cred_1.authorize(creds_http_1)
1084          creds_http_2 = HttpMockSequence([])
1085          cred_2.authorize(creds_http_2)
1086          self.request1.http = creds_http_1
1087          self.request2.http = creds_http_2
1088          batch.add(self.request1, callback=callbacks.f)
1089          batch.add(self.request2, callback=callbacks.f)
1090          batch.execute(http=http)
1091          self.assertEqual(None, callbacks.responses[&quot;1&quot;])
1092          self.assertEqual(401, callbacks.exceptions[&quot;1&quot;].resp.status)
1093          self.assertEqual(
1094              &quot;Authorization Required&quot;, callbacks.exceptions[&quot;1&quot;].resp.reason
1095          )
1096          self.assertEqual({&quot;baz&quot;: &quot;qux&quot;}, callbacks.responses[&quot;2&quot;])
1097          self.assertEqual(None, callbacks.exceptions[&quot;2&quot;])
1098      def test_execute_global_callback(self):
1099          callbacks = Callbacks()
1100          batch = BatchHttpRequest(callback=callbacks.f)
1101          batch.add(self.request1)
1102          batch.add(self.request2)
1103          http = HttpMockSequence(
1104              [
1105                  (
1106                      {
1107                          &quot;status&quot;: &quot;200&quot;,
1108                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1109                      },
1110                      BATCH_RESPONSE,
1111                  )
1112              ]
1113          )
1114          batch.execute(http=http)
1115          self.assertEqual({&quot;foo&quot;: 42}, callbacks.responses[&quot;1&quot;])
1116          self.assertEqual({&quot;baz&quot;: &quot;qux&quot;}, callbacks.responses[&quot;2&quot;])
1117      def test_execute_batch_http_error(self):
1118          callbacks = Callbacks()
1119          batch = BatchHttpRequest(callback=callbacks.f)
1120          batch.add(self.request1)
1121          batch.add(self.request2)
1122          http = HttpMockSequence(
1123              [
1124                  (
1125                      {
1126                          &quot;status&quot;: &quot;200&quot;,
1127                          &quot;content-type&quot;: &#x27;multipart/mixed; boundary=&quot;batch_foobarbaz&quot;&#x27;,
1128                      },
1129                      BATCH_ERROR_RESPONSE,
1130                  )
1131              ]
1132          )
1133          batch.execute(http=http)
1134          self.assertEqual({&quot;foo&quot;: 42}, callbacks.responses[&quot;1&quot;])
1135          expected = (
1136              &quot;&lt;HttpError 403 when requesting &quot;
1137              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar returned &quot;
1138              &#x27;&quot;Access Not Configured&quot;. &#x27;
1139              &quot;Details: \&quot;[{&#x27;domain&#x27;: &#x27;usageLimits&#x27;, &#x27;reason&#x27;: &#x27;accessNotConfigured&#x27;, &#x27;message&#x27;: &#x27;Access Not Configured&#x27;, &#x27;debugInfo&#x27;: &#x27;QuotaState: BLOCKED&#x27;}]\&quot;&gt;&quot;
1140          )
1141          self.assertEqual(expected, str(callbacks.exceptions[&quot;2&quot;]))
1142  class TestRequestUriTooLong(unittest.TestCase):
1143      def test_turn_get_into_post(self):
1144          def _postproc(resp, content):
1145              return content
1146          http = HttpMockSequence(
1147              [
1148                  ({&quot;status&quot;: &quot;200&quot;}, &quot;echo_request_body&quot;),
1149                  ({&quot;status&quot;: &quot;200&quot;}, &quot;echo_request_headers&quot;),
1150              ]
1151          )
1152          query = {&quot;q&quot;: &quot;a&quot; * MAX_URI_LENGTH + &quot;?&amp;&quot;}
1153          req = HttpRequest(
1154              http,
1155              _postproc,
1156              &quot;http://example.com?&quot; + urllib.parse.urlencode(query),
1157              method=&quot;GET&quot;,
1158              body=None,
1159              headers={},
1160              methodId=&quot;foo&quot;,
1161              resumable=None,
1162          )
1163          response = req.execute()
1164          self.assertEqual(b&quot;q=&quot; + b&quot;a&quot; * MAX_URI_LENGTH + b&quot;%3F%26&quot;, response)
1165          response = req.execute()
1166          self.assertEqual(&quot;GET&quot;, response[&quot;x-http-method-override&quot;])
1167          self.assertEqual(str(MAX_URI_LENGTH + 8), response[&quot;content-length&quot;])
1168          self.assertEqual(&quot;application/x-www-form-urlencoded&quot;, response[&quot;content-type&quot;])
1169  class TestStreamSlice(unittest.TestCase):
1170      def setUp(self):
1171          self.stream = io.BytesIO(b&quot;0123456789&quot;)
1172      def test_read(self):
1173          s = _StreamSlice(self.stream, 0, 4)
1174          self.assertEqual(b&quot;&quot;, s.read(0))
1175          self.assertEqual(b&quot;0&quot;, s.read(1))
1176          self.assertEqual(b&quot;123&quot;, s.read())
1177      def test_read_too_much(self):
1178          s = _StreamSlice(self.stream, 1, 4)
1179          self.assertEqual(b&quot;1234&quot;, s.read(6))
1180      def test_read_all(self):
1181          s = _StreamSlice(self.stream, 2, 1)
1182          self.assertEqual(b&quot;2&quot;, s.read(-1))
1183  class TestResponseCallback(unittest.TestCase):
1184      def test_ensure_response_callback(self):
1185          m = JsonModel()
1186          request = HttpRequest(
1187              None,
1188              m.response,
1189              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
1190              method=&quot;POST&quot;,
1191              body=&quot;{}&quot;,
1192              headers={&quot;content-type&quot;: &quot;application/json&quot;},
1193          )
1194          h = HttpMockSequence([({&quot;status&quot;: 200}, &quot;{}&quot;)])
1195          responses = []
1196          def _on_response(resp, responses=responses):
1197              responses.append(resp)
1198          request.add_response_callback(_on_response)
1199          request.execute(http=h)
1200          self.assertEqual(1, len(responses))
1201  class TestHttpMock(unittest.TestCase):
1202      def test_default_response_headers(self):
1203          http = HttpMock(datafile(&quot;zoo.json&quot;))
1204          resp, content = http.request(&quot;http://example.com&quot;)
1205          self.assertEqual(resp.status, 200)
1206      def test_error_response(self):
1207          http = HttpMock(datafile(&quot;bad_request.json&quot;), {&quot;status&quot;: &quot;400&quot;})
1208          model = JsonModel()
1209          request = HttpRequest(
1210              http,
1211              model.response,
1212              &quot;https://www.googleapis.com/someapi/v1/collection/?foo=bar&quot;,
1213              method=&quot;GET&quot;,
1214              headers={},
1215          )
1216          self.assertRaises(HttpError, request.execute)
1217  class TestHttpBuild(unittest.TestCase):
1218      original_socket_default_timeout = None
1219      @classmethod
1220      def setUpClass(cls):
1221          cls.original_socket_default_timeout = socket.getdefaulttimeout()
1222      @classmethod
1223      def tearDownClass(cls):
1224          socket.setdefaulttimeout(cls.original_socket_default_timeout)
1225      def test_build_http_sets_default_timeout_if_none_specified(self):
1226          socket.setdefaulttimeout(None)
1227          http = build_http()
1228          self.assertIsInstance(http.timeout, int)
1229          self.assertGreater(http.timeout, 0)
1230      def test_build_http_default_timeout_can_be_overridden(self):
1231          socket.setdefaulttimeout(1.5)
1232          http = build_http()
1233          self.assertAlmostEqual(http.timeout, 1.5, delta=0.001)
1234      def test_build_http_default_timeout_can_be_set_to_zero(self):
1235          socket.setdefaulttimeout(0)
1236          http = build_http()
1237          self.assertEqual(http.timeout, 0)
1238      def test_build_http_default_308_is_excluded_as_redirect(self):
1239          http = build_http()
1240          self.assertTrue(308 not in http.redirect_codes)
1241  if __name__ == &quot;__main__&quot;:
1242      logging.getLogger().setLevel(logging.ERROR)
1243      unittest.main()
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from google-api-python-client-MDEwOlJlcG9zaXRvcnkxNTc0OTI2OQ==-flat-test_http.py</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from google-api-python-client-MDEwOlJlcG9zaXRvcnkxNTc0OTI2OQ==-flat-test_http.py</div>
                </div>
                <div class="column column_space"><pre><code>170              chunksize=-2,
171              resumable=True,
172          )
173      def test_media_inmemory_upload(self):
174          media = MediaInMemoryUpload(
</pre></code></div>
                <div class="column column_space"><pre><code>258              chunksize=-2,
259              resumable=True,
260          )
261      def test_media_io_base_upload_streamable(self):
262          fd = io.BytesIO(b&quot;stuff&quot;)
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    