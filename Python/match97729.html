<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for test_vmware_1.py & test_virtualbox.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for test_vmware_1.py & test_virtualbox.py
      </h3>
      <h1 align="center">
        3.4%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>test_vmware_1.py (10.909091%)<TH>test_virtualbox.py (2.0725389%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match97729-0.html#0',2,'match97729-1.html#0',3)" NAME="0">(94-105)<TD><A HREF="javascript:ZweiFrames('match97729-0.html#0',2,'match97729-1.html#0',3)" NAME="0">(231-240)</A><TD ALIGN=center><FONT COLOR="#ff0000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_vmware_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Megan Wilhite &lt;mwilhite@saltstack.com&gt;
&quot;&quot;&quot;

import socket

from tests.integration.cloud.helpers.cloud_test_base import TIMEOUT, CloudTest


class VMWareTest(CloudTest):
    &quot;&quot;&quot;
    Integration tests for the vmware cloud provider in Salt-Cloud
    &quot;&quot;&quot;

    PROVIDER = &quot;vmware&quot;
    REQUIRED_PROVIDER_CONFIG_ITEMS = (&quot;password&quot;, &quot;user&quot;, &quot;url&quot;)

    def setUp(self):
        super().setUp()
        test_host = self.provider_config[&quot;url&quot;]
        try:
            socket.gethostbyname_ex(test_host)
        except OSError as exc:
            self.skipTest(
                &quot;The required vmware host at {} is not available: {}&quot;.format(
                    test_host, exc
                )
            )

    def test_instance(self):
        &quot;&quot;&quot;
        Tests creating and deleting an instance on vmware and installing salt
        &quot;&quot;&quot;
        # create the instance
        disk_datastore = self.config[&quot;vmware-test&quot;][&quot;devices&quot;][&quot;disk&quot;][&quot;Hard disk 2&quot;][
            &quot;datastore&quot;
        ]

        ret_val = self.run_cloud(
            &quot;-p vmware-test {}&quot;.format(self.instance_name), timeout=TIMEOUT
        )
        disk_datastore_str = &quot;                [{}] {}/Hard disk 2-flat.vmdk&quot;.format(
            disk_datastore, self.instance_name
        )

        # check if instance returned with salt installed
        self.assertInstanceExists(ret_val)
        self.assertIn(
            disk_datastore_str,
            ret_val,
            msg=&quot;Hard Disk 2 did not use the Datastore {} &quot;.format(disk_datastore),
        )

        self.assertDestroyInstance()

    def test_snapshot(self):
        &quot;&quot;&quot;
        Tests creating snapshot and creating vm with --no-deploy
        &quot;&quot;&quot;
        # create the instance
        ret_val = self.run_cloud(
            &quot;-p vmware-test {} --no-deploy&quot;.format(self.instance_name), timeout=TIMEOUT
        )

        # check if instance returned with salt installed
        self.assertInstanceExists(ret_val)

        create_snapshot = self.run_cloud(
            &quot;-a create_snapshot {} snapshot_name='Test Cloud' memdump=True -y&quot;.format(
                self.instance_name
            ),
            timeout=TIMEOUT,
        )
        s_ret_str = &quot;Snapshot created successfully&quot;

        self.assertIn(s_ret_str, str(create_snapshot))

        self.assertDestroyInstance()

    def test_verify_ssl_false(self):
        &quot;&quot;&quot;
        Tests creating and deleting an instance on vmware when using
        verify_ssl: False
        &quot;&quot;&quot;
        profile_name = &quot;vmware_verify_ssl&quot;
        self.add_profile_config(
            &quot;vmware-test&quot;, {&quot;verify_ssl&quot;: False}, &quot;vmware.conf&quot;, profile_name
        )
        # create the instance
        ret_val = self.run_cloud(
<A NAME="0"></A>            &quot;-p {} {}&quot;.format(profile_name, self.instance_name), timeout=TIMEOUT
        )
        # check if instance returned with salt installed
        self<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match97729-1.html#0',3,'match97729-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.assertInstanceExists(ret_val)
        self.assertDestroyInstance()

    def test_instant_clone(self):
        &quot;&quot;&quot;
        Tests creating Instant Clone VM
        &quot;&quot;&quot;
        # salt-cloud -p my-instant-clone IC3
        profile_name = &quot;vmware-test-instant-clone&quot;
        # create the instance
        ret_val = self.run_cloud(
            &quot;-p {} {}&quot;.format(</B></FONT>profile_name, self.instance_name), timeout=TIMEOUT
        )

        i_clone_str = &quot;Instant Clone created successfully&quot;

        self.assertIn(i_clone_str, str(ret_val))

        self.assertDestroyInstance()
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_virtualbox.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
# This code assumes vboxapi.py from VirtualBox distribution
# being in PYTHONPATH, or installed system-wide


import logging
import os
import socket

from salt.config import cloud_providers_config, vm_profiles_config
from salt.utils.virtualbox import (
    HAS_LIBS,
    XPCOM_ATTRIBUTES,
    machine_get_machinestate_str,
    vb_clone_vm,
    vb_create_machine,
    vb_destroy_machine,
    vb_get_box,
    vb_get_network_addresses,
    vb_machine_exists,
    vb_start_vm,
    vb_stop_vm,
    vb_wait_for_network_address,
    vb_xpcom_to_attribute_dict,
)
from tests.integration.cloud.helpers.virtualbox import (
    BASE_BOX_NAME,
    BOOTABLE_BASE_BOX_NAME,
    CONFIG_NAME,
    DEPLOY_PROFILE_NAME,
    INSTANCE_NAME,
    PROFILE_NAME,
    PROVIDER_NAME,
    VirtualboxCloudTestCase,
    VirtualboxTestCase,
)
from tests.support.runtests import RUNTIME_VARS
from tests.support.unit import TestCase, skipIf

log = logging.getLogger(__name__)

# As described in the documentation of list_nodes (this may change with time)
MINIMAL_MACHINE_ATTRIBUTES = [
    &quot;id&quot;,
    &quot;image&quot;,
    &quot;size&quot;,
    &quot;state&quot;,
    &quot;private_ips&quot;,
    &quot;public_ips&quot;,
]


class VirtualboxProviderTest(VirtualboxCloudTestCase):
    &quot;&quot;&quot;
    Integration tests for the Virtualbox cloud provider using the Virtualbox driver
    &quot;&quot;&quot;

    def run_cloud_destroy(self, machine_name):
        &quot;&quot;&quot;
        Calls salt-cloud to destroy a machine and returns the destroyed machine object (should be None)
        @param machine_name:
        @type str:
        @return:
        @rtype: dict
        &quot;&quot;&quot;
        output = self.run_cloud(
            &quot;-d {} --assume-yes --log-level=debug&quot;.format(machine_name)
        )
        return output.get(CONFIG_NAME, {}).get(PROVIDER_NAME, {})

    def setUp(self):
        &quot;&quot;&quot;
        Sets up the test requirements
        &quot;&quot;&quot;
        super().setUp()

        # check if appropriate cloud provider and profile files are present
        profile_str = &quot;virtualbox-config&quot;
        providers = self.run_cloud(&quot;--list-providers&quot;)
        log.debug(&quot;providers: %s&quot;, providers)

        if profile_str not in providers:
            self.skipTest(
                &quot;Configuration file for {0} was not found. Check {0}.conf files &quot;
                &quot;in tests/integration/files/conf/cloud.*.d/ to run these tests.&quot;.format(
                    PROVIDER_NAME
                )
            )

        # check if personal access token, ssh_key_file, and ssh_key_names are present
        config_path = os.path.join(
            RUNTIME_VARS.FILES, &quot;conf&quot;, &quot;cloud.providers.d&quot;, PROVIDER_NAME + &quot;.conf&quot;
        )
        log.debug(&quot;config_path: %s&quot;, config_path)
        providers = cloud_providers_config(config_path)
        log.debug(&quot;config: %s&quot;, providers)
        config_path = os.path.join(
            RUNTIME_VARS.FILES, &quot;conf&quot;, &quot;cloud.profiles.d&quot;, PROVIDER_NAME + &quot;.conf&quot;
        )
        profiles = vm_profiles_config(config_path, providers)
        profile = profiles.get(PROFILE_NAME)
        if not profile:
            self.skipTest(
                &quot;Profile {} was not found. Check {}.conf files &quot;
                &quot;in tests/integration/files/conf/cloud.profiles.d/ to run these tests.&quot;.format(
                    PROFILE_NAME, PROVIDER_NAME
                )
            )
        base_box_name = profile.get(&quot;clonefrom&quot;)

        if base_box_name != BASE_BOX_NAME:
            self.skipTest(
                &quot;Profile {} does not have a base box to clone from. Check {}.conf files&quot;
                &quot; in tests/integration/files/conf/cloud.profiles.d/ to run these&quot;
                ' tests.And add a &quot;clone_from: {}&quot; to the profile'.format(
                    PROFILE_NAME, PROVIDER_NAME, BASE_BOX_NAME
                )
            )

    @classmethod
    def setUpClass(cls):
        vb_create_machine(BASE_BOX_NAME)

    @classmethod
    def tearDownClass(cls):
        vb_destroy_machine(BASE_BOX_NAME)

    def test_cloud_create(self):
        &quot;&quot;&quot;
        Simply create a machine and make sure it was created
        &quot;&quot;&quot;
        machines = self.run_cloud(
            &quot;-p {} {} --log-level=debug&quot;.format(PROFILE_NAME, INSTANCE_NAME)
        )
        self.assertIn(INSTANCE_NAME, machines.keys())

    def test_cloud_list(self):
        &quot;&quot;&quot;
        List all machines in virtualbox and make sure the requested attributes are included
        &quot;&quot;&quot;
        machines = self.run_cloud_function(&quot;list_nodes&quot;)

        expected_attributes = MINIMAL_MACHINE_ATTRIBUTES
        names = machines.keys()
        self.assertGreaterEqual(len(names), 1, &quot;No machines found&quot;)
        for name, machine in machines.items():
            self.assertCountEqual(expected_attributes, machine.keys())

        self.assertIn(BASE_BOX_NAME, names)

    def test_cloud_list_full(self):
        &quot;&quot;&quot;
        List all machines and make sure full information in included
        &quot;&quot;&quot;
        machines = self.run_cloud_function(&quot;list_nodes_full&quot;)
        expected_minimal_attribute_count = len(MINIMAL_MACHINE_ATTRIBUTES)

        names = machines.keys()
        self.assertGreaterEqual(len(names), 1, &quot;No machines found&quot;)
        for name, machine in machines.items():
            self.assertGreaterEqual(
                len(machine.keys()), expected_minimal_attribute_count
            )

        self.assertIn(BASE_BOX_NAME, names)

    def test_cloud_list_select(self):
        &quot;&quot;&quot;
        List selected attributes of all machines
        &quot;&quot;&quot;
        machines = self.run_cloud_function(&quot;list_nodes_select&quot;)
        # TODO find out how to get query.selection from the  &quot;cloud&quot; config
        expected_attributes = [&quot;id&quot;]

        names = machines.keys()
        self.assertGreaterEqual(len(names), 1, &quot;No machines found&quot;)
        for name, machine in machines.items():
            self.assertCountEqual(expected_attributes, machine.keys())

        self.assertIn(BASE_BOX_NAME, names)

    def test_cloud_destroy(self):
        &quot;&quot;&quot;
        Test creating an instance on virtualbox with the virtualbox driver
        &quot;&quot;&quot;
        # check if instance with salt installed returned
        self.test_cloud_create()
        ret = self.run_cloud_destroy(INSTANCE_NAME)

        # destroy the instance
        self.assertIn(INSTANCE_NAME, ret.keys())

    def test_function_show_instance(self):
        kw_function_args = {&quot;image&quot;: BASE_BOX_NAME}
        machines = self.run_cloud_function(&quot;show_image&quot;, kw_function_args, timeout=30)
        expected_minimal_attribute_count = len(MINIMAL_MACHINE_ATTRIBUTES)
        self.assertIn(BASE_BOX_NAME, machines)
        machine = machines[BASE_BOX_NAME]
        self.assertGreaterEqual(len(machine.keys()), expected_minimal_attribute_count)

    def tearDown(self):
        &quot;&quot;&quot;
        Clean up after tests
        &quot;&quot;&quot;
        if vb_machine_exists(INSTANCE_NAME):
            vb_destroy_machine(INSTANCE_NAME)


@skipIf(
    HAS_LIBS and vb_machine_exists(BOOTABLE_BASE_BOX_NAME) is False,
    &quot;Bootable VM '{}' not found. Cannot run tests.&quot;.format(BOOTABLE_BASE_BOX_NAME),
)
class VirtualboxProviderHeavyTests(VirtualboxCloudTestCase):
    &quot;&quot;&quot;
    Tests that include actually booting a machine and doing operations on it that might be lengthy.
    &quot;&quot;&quot;

    def assertIsIpAddress(self, ip_str):
        &quot;&quot;&quot;
        Is it either a IPv4 or IPv6 address

        @param ip_str:
        @type ip_str: str
        @raise AssertionError
        &quot;&quot;&quot;
        try:
            socket.inet_aton(ip_str)
        except Exception:  # pylint: disable=broad-except
<A NAME="0"></A>            try:
                socket.inet_pton(socket.AF_INET6, ip_str)
            except Exception:  # pylint: disable=broad-except
                self<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match97729-0.html#0',2,'match97729-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.fail(&quot;{} is not a valid IP address&quot;.format(ip_str))

    def setUp(self):
        &quot;&quot;&quot;
        Sets up the test requirements
        &quot;&quot;&quot;
        # check if appropriate cloud provider and profile files are present
        provider_str = CONFIG_NAME
        providers = self.run_cloud(&quot;--list-providers&quot;)
        log.debug(</B></FONT>&quot;providers: %s&quot;, providers)

        if provider_str not in providers:
            self.skipTest(
                &quot;Configuration file for {0} was not found. Check {0}.conf files &quot;
                &quot;in tests/integration/files/conf/cloud.*.d/ to run these tests.&quot;.format(
                    PROVIDER_NAME
                )
            )

        # check if personal access token, ssh_key_file, and ssh_key_names are present
        config_path = os.path.join(
            RUNTIME_VARS.FILES, &quot;conf&quot;, &quot;cloud.providers.d&quot;, PROVIDER_NAME + &quot;.conf&quot;
        )
        log.debug(&quot;config_path: %s&quot;, config_path)
        providers = cloud_providers_config(config_path)
        log.debug(&quot;config: %s&quot;, providers)
        config_path = os.path.join(
            RUNTIME_VARS.FILES, &quot;conf&quot;, &quot;cloud.profiles.d&quot;, PROVIDER_NAME + &quot;.conf&quot;
        )
        profiles = vm_profiles_config(config_path, providers)
        profile = profiles.get(DEPLOY_PROFILE_NAME)
        if not profile:
            self.skipTest(
                &quot;Profile {} was not found. Check {}.conf files &quot;
                &quot;in tests/integration/files/conf/cloud.profiles.d/ to run these tests.&quot;.format(
                    DEPLOY_PROFILE_NAME, PROVIDER_NAME
                )
            )
        base_box_name = profile.get(&quot;clonefrom&quot;)

        if base_box_name != BOOTABLE_BASE_BOX_NAME:
            self.skipTest(
                &quot;Profile {} does not have a base box to clone from. Check {}.conf files&quot;
                &quot; in tests/integration/files/conf/cloud.profiles.d/ to run these&quot;
                ' tests.And add a &quot;clone_from: {}&quot; to the profile'.format(
                    PROFILE_NAME, PROVIDER_NAME, BOOTABLE_BASE_BOX_NAME
                )
            )

    def tearDown(self):
        try:
            vb_stop_vm(BOOTABLE_BASE_BOX_NAME)
        except Exception:  # pylint: disable=broad-except
            pass

        if vb_machine_exists(INSTANCE_NAME):
            try:
                vb_stop_vm(INSTANCE_NAME)
                vb_destroy_machine(INSTANCE_NAME)
            except Exception as e:  # pylint: disable=broad-except
                log.warning(&quot;Possibly dirty state after exception&quot;, exc_info=True)

    def test_deploy(self):
        machines = self.run_cloud(
            &quot;-p {} {} --log-level=debug&quot;.format(DEPLOY_PROFILE_NAME, INSTANCE_NAME)
        )
        self.assertIn(INSTANCE_NAME, machines.keys())
        machine = machines[INSTANCE_NAME]
        self.assertIn(&quot;deployed&quot;, machine)
        self.assertTrue(machine[&quot;deployed&quot;], &quot;Machine wasn't deployed :(&quot;)

    def test_start_stop_action(self):
        res = self.run_cloud_action(&quot;start&quot;, BOOTABLE_BASE_BOX_NAME, timeout=10)
        log.info(res)

        machine = res.get(BOOTABLE_BASE_BOX_NAME)
        self.assertIsNotNone(machine)
        expected_state = &quot;Running&quot;
        state = machine.get(&quot;state&quot;)
        self.assertEqual(state, expected_state)

        res = self.run_cloud_action(&quot;stop&quot;, BOOTABLE_BASE_BOX_NAME, timeout=10)
        log.info(res)

        machine = res.get(BOOTABLE_BASE_BOX_NAME)
        self.assertIsNotNone(machine)

        expected_state = &quot;PoweredOff&quot;
        state = machine.get(&quot;state&quot;)
        self.assertEqual(state, expected_state)

    def test_restart_action(self):
        pass

    def test_network_addresses(self):
        # Machine is off
        ip_addresses = vb_get_network_addresses(machine_name=BOOTABLE_BASE_BOX_NAME)

        network_count = len(ip_addresses)
        self.assertEqual(network_count, 0)

        # Machine is up again
        vb_start_vm(BOOTABLE_BASE_BOX_NAME)
        ip_addresses = vb_wait_for_network_address(
            20, machine_name=BOOTABLE_BASE_BOX_NAME
        )
        network_count = len(ip_addresses)
        self.assertGreater(network_count, 0)

        for ip_address in ip_addresses:
            self.assertIsIpAddress(ip_address)


@skipIf(HAS_LIBS is False, &quot;The 'vboxapi' library is not available&quot;)
class BaseVirtualboxTests(TestCase):
    def test_get_manager(self):
        self.assertIsNotNone(vb_get_box())


class CreationDestructionVirtualboxTests(VirtualboxTestCase):
    def test_vm_creation_and_destruction(self):
        vm_name = BASE_BOX_NAME
        vb_create_machine(vm_name)
        self.assertMachineExists(vm_name)

        vb_destroy_machine(vm_name)
        self.assertMachineDoesNotExist(vm_name)


class CloneVirtualboxTests(VirtualboxTestCase):
    def setUp(self):
        self.vbox = vb_get_box()

        self.name = &quot;SaltCloudVirtualboxTestVM&quot;
        vb_create_machine(self.name)
        self.assertMachineExists(self.name)

    def tearDown(self):
        vb_destroy_machine(self.name)
        self.assertMachineDoesNotExist(self.name)

    def test_create_machine(self):
        vb_name = &quot;NewTestMachine&quot;
        machine = vb_clone_vm(name=vb_name, clone_from=self.name)
        self.assertEqual(machine.get(&quot;name&quot;), vb_name)
        self.assertMachineExists(vb_name)

        vb_destroy_machine(vb_name)
        self.assertMachineDoesNotExist(vb_name)


@skipIf(
    HAS_LIBS and vb_machine_exists(BOOTABLE_BASE_BOX_NAME) is False,
    &quot;Bootable VM '{}' not found. Cannot run tests.&quot;.format(BOOTABLE_BASE_BOX_NAME),
)
class BootVirtualboxTests(VirtualboxTestCase):
    def test_start_stop(self):
        for i in range(2):
            machine = vb_start_vm(BOOTABLE_BASE_BOX_NAME, 20000)
            self.assertEqual(machine_get_machinestate_str(machine), &quot;Running&quot;)

            machine = vb_stop_vm(BOOTABLE_BASE_BOX_NAME)
            self.assertEqual(machine_get_machinestate_str(machine), &quot;PoweredOff&quot;)


class XpcomConversionTests(TestCase):
    @classmethod
    def _mock_xpcom_object(cls, interface_name=None, attributes=None):
        class XPCOM:
            def __str__(self):
                return &quot;&lt;XPCOM component '&lt;unknown&gt;' (implementing {})&gt;&quot;.format(
                    interface_name
                )

        o = XPCOM()

        if attributes and isinstance(attributes, dict):
            for key, value in attributes.items():
                setattr(o, key, value)
        return o

    def test_unknown_object(self):
        xpcom = XpcomConversionTests._mock_xpcom_object()

        ret = vb_xpcom_to_attribute_dict(xpcom)
        self.assertDictEqual(ret, dict())

    def test_imachine_object_default(self):

        interface = &quot;IMachine&quot;
        imachine = XpcomConversionTests._mock_xpcom_object(interface)

        ret = vb_xpcom_to_attribute_dict(imachine, interface_name=interface)
        expected_attributes = XPCOM_ATTRIBUTES[interface]

        self.assertIsNotNone(expected_attributes, &quot;%s is unknown&quot;)

        for key in ret:
            self.assertIn(key, expected_attributes)

    def test_override_attributes(self):

        expected_dict = {&quot;herp&quot;: &quot;derp&quot;, &quot;lol&quot;: &quot;rofl&quot;, &quot;something&quot;: 12345}

        xpc = XpcomConversionTests._mock_xpcom_object(attributes=expected_dict)

        ret = vb_xpcom_to_attribute_dict(xpc, attributes=expected_dict.keys())
        self.assertDictEqual(ret, expected_dict)

    def test_extra_attributes(self):

        interface = &quot;IMachine&quot;
        expected_extras = {
            &quot;extra&quot;: &quot;extra&quot;,
        }
        expected_machine = {
            attribute: attribute for attribute in XPCOM_ATTRIBUTES[interface]
        }
        expected_machine.update(expected_extras)

        imachine = XpcomConversionTests._mock_xpcom_object(
            interface, attributes=expected_machine
        )

        ret = vb_xpcom_to_attribute_dict(
            imachine, interface_name=interface, extra_attributes=expected_extras.keys()
        )
        self.assertDictEqual(ret, expected_machine)

        ret_keys = ret.keys()
        for key in expected_extras:
            self.assertIn(key, ret_keys)

    def test_extra_nonexistent_attributes(self):
        expected_extra_dict = {&quot;nonexistent&quot;: &quot;&quot;}
        xpcom = XpcomConversionTests._mock_xpcom_object()

        ret = vb_xpcom_to_attribute_dict(
            xpcom, extra_attributes=expected_extra_dict.keys()
        )
        self.assertDictEqual(ret, expected_extra_dict)

    def test_extra_nonexistent_attribute_with_default(self):
        expected_extras = [(&quot;nonexistent&quot;, list)]
        expected_extra_dict = {&quot;nonexistent&quot;: []}
        xpcom = XpcomConversionTests._mock_xpcom_object()

        ret = vb_xpcom_to_attribute_dict(xpcom, extra_attributes=expected_extras)
        self.assertDictEqual(ret, expected_extra_dict)
</PRE>
</div>
  </div>
</body>
</html>
