<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for test_crypt.py &amp; test_vsphere.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for test_crypt.py &amp; test_vsphere.py
      </h3>
<h1 align="center">
        0.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>test_crypt.py (24.137932%)<th>test_vsphere.py (0.31124943%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(6-21)<td><a href="#" name="0">(18-33)</a><td align="center"><font color="#ff0000">14</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_crypt.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 """
2 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import salt.utils.crypt
3 from tests.support.mock import patch
4 try:
5     import M2Crypto  # pylint: disable=unused-import
6     HAS_M2CRYPTO = True
7 except ImportError:
8     HAS_M2CRYPTO = False
9 try:
10     from Cryptodome import Random as CryptodomeRandom
11     HAS_CYPTODOME = True
12 except ImportError:
13     HAS_CYPTODOME =</b></font> False
14 try:
15     from Crypto import Random as CryptoRandom  # nosec
16     HAS_CRYPTO = True
17 except ImportError:
18     HAS_CRYPTO = False
19 def test_random():
20     if HAS_M2CRYPTO:
21         assert None is salt.utils.crypt.Random
22     elif HAS_CYPTODOME:
23         assert CryptodomeRandom is salt.utils.crypt.Random
24     elif HAS_CRYPTO:
25         assert CryptoRandom is salt.utils.crypt.Random
26 def test_reinit_crypto():
27     salt.utils.crypt.reinit_crypto()
28     with patch("salt.utils.crypt.HAS_M2CRYPTO", False):
29         with patch("salt.utils.crypt.HAS_CRYPTODOME", False):
30             with patch("salt.utils.crypt.HAS_CRYPTO", False):
31                 with patch("salt.utils.crypt.Random", None):
32                     salt.utils.crypt.reinit_crypto()
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_vsphere.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 """
2     :codeauthor: Nicole Thomas &lt;nicole@saltstack.com&gt;
3     :codeauthor: Alexandru Bleotu &lt;alexandru.bleotu@morganstanley.com&gt;
4     Tests for functions in salt.modules.vsphere
5 """
6 import salt.modules.vsphere as vsphere
7 import salt.utils.args
8 import salt.utils.vmware
9 from salt.exceptions import (
10     ArgumentValueError,
11     CommandExecutionError,
12     VMwareObjectRetrievalError,
13 )
14 from tests.support.mixins import LoaderModuleMockMixin
15 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>from tests.support.mock import MagicMock, Mock, call, patch
16 from tests.support.unit import TestCase, skipIf
17 try:
18     from pyVmomi import vim, vmodl  # pylint: disable=unused-import,no-name-in-module
19     HAS_PYVMOMI = True
20 except ImportError:
21     HAS_PYVMOMI = False
22 try:
23     from com.vmware.vapi.std_client import DynamicID  # pylint: disable=unused-import
24     HAS_VSPHERE_SDK = True
25 except ImportError:
26     HAS_VSPHERE_SDK =</b></font> False
27 HOST = "1.2.3.4"
28 USER = "root"
29 PASSWORD = "SuperSecret!"
30 ERROR = "Some Testing Error Message"
31 class VsphereTestCase(TestCase, LoaderModuleMockMixin):
32     """
33     Unit TestCase for the salt.modules.vsphere module.
34     """
35     def setup_loader_modules(self):
36         return {vsphere: {}}
37     def test_get_coredump_network_config_esxi_hosts_not_list(self):
38         """
39         Tests CommandExecutionError is raised when esxi_hosts is provided,
40         but is not a list.
41         """
42         self.assertRaises(
43             CommandExecutionError,
44             vsphere.get_coredump_network_config,
45             HOST,
46             USER,
47             PASSWORD,
48             esxi_hosts="foo",
49         )
50     def test_get_coredump_network_config_host_list_bad_retcode(self):
51         """
52         Tests error message returned with list of esxi_hosts.
53         """
54         with patch(
55             "salt.utils.vmware.esxcli",
56             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
57         ):
58             host_1 = "host_1.foo.com"
59             self.assertEqual(
60                 {host_1: {"Error": ERROR}},
61                 vsphere.get_coredump_network_config(
62                     HOST, USER, PASSWORD, esxi_hosts=[host_1]
63                 ),
64             )
65     def test_get_coredump_network_config_host_list_success(self):
66         """
67         Tests successful function return when an esxi_host is provided.
68         """
69         with patch(
70             "salt.utils.vmware.esxcli",
71             MagicMock(return_value={"retcode": 0, "stdout": ""}),
72         ):
73             with patch(
74                 "salt.modules.vsphere._format_coredump_stdout",
75                 MagicMock(return_value={}),
76             ):
77                 host_1 = "host_1.foo.com"
78                 self.assertEqual(
79                     {host_1: {"Coredump Config": {}}},
80                     vsphere.get_coredump_network_config(
81                         HOST, USER, PASSWORD, esxi_hosts=[host_1]
82                     ),
83                 )
84     def test_get_coredump_network_config_bad_retcode(self):
85         """
86         Tests error message given for a single ESXi host.
87         """
88         with patch(
89             "salt.utils.vmware.esxcli",
90             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
91         ):
92             self.assertEqual(
93                 {HOST: {"Error": ERROR}},
94                 vsphere.get_coredump_network_config(HOST, USER, PASSWORD),
95             )
96     def test_get_coredump_network_config_success(self):
97         """
98         Tests successful function return for a single ESXi host.
99         """
100         with patch(
101             "salt.utils.vmware.esxcli",
102             MagicMock(return_value={"retcode": 0, "stdout": ""}),
103         ):
104             with patch(
105                 "salt.modules.vsphere._format_coredump_stdout",
106                 MagicMock(return_value={}),
107             ):
108                 self.assertEqual(
109                     {HOST: {"Coredump Config": {}}},
110                     vsphere.get_coredump_network_config(HOST, USER, PASSWORD),
111                 )
112     def test_coredump_network_enable_esxi_hosts_not_list(self):
113         """
114         Tests CommandExecutionError is raised when esxi_hosts is provided,
115         but is not a list.
116         """
117         self.assertRaises(
118             CommandExecutionError,
119             vsphere.coredump_network_enable,
120             HOST,
121             USER,
122             PASSWORD,
123             True,
124             esxi_hosts="foo",
125         )
126     def test_coredump_network_enable_host_list_bad_retcode(self):
127         """
128         Tests error message returned with list of esxi_hosts.
129         """
130         with patch(
131             "salt.utils.vmware.esxcli",
132             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
133         ):
134             host_1 = "host_1.foo.com"
135             self.assertEqual(
136                 {host_1: {"Error": ERROR}},
137                 vsphere.coredump_network_enable(
138                     HOST, USER, PASSWORD, True, esxi_hosts=[host_1]
139                 ),
140             )
141     def test_coredump_network_enable_host_list_success(self):
142         """
143         Tests successful function return when an esxi_host is provided.
144         """
145         with patch(
146             "salt.utils.vmware.esxcli",
147             MagicMock(return_value={"retcode": 0, "stdout": ""}),
148         ):
149             with patch(
150                 "salt.modules.vsphere._format_coredump_stdout",
151                 MagicMock(return_value={}),
152             ):
153                 enabled = True
154                 host_1 = "host_1.foo.com"
155                 self.assertEqual(
156                     {host_1: {"Coredump Enabled": enabled}},
157                     vsphere.coredump_network_enable(
158                         HOST, USER, PASSWORD, enabled, esxi_hosts=[host_1]
159                     ),
160                 )
161     def test_coredump_network_enable_bad_retcode(self):
162         """
163         Tests error message given for a single ESXi host.
164         """
165         with patch(
166             "salt.utils.vmware.esxcli",
167             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
168         ):
169             self.assertEqual(
170                 {HOST: {"Error": ERROR}},
171                 vsphere.coredump_network_enable(HOST, USER, PASSWORD, True),
172             )
173     def test_coredump_network_enable_success(self):
174         """
175         Tests successful function return for a single ESXi host.
176         """
177         with patch(
178             "salt.utils.vmware.esxcli",
179             MagicMock(return_value={"retcode": 0, "stdout": ""}),
180         ):
181             with patch(
182                 "salt.modules.vsphere._format_coredump_stdout",
183                 MagicMock(return_value={}),
184             ):
185                 enabled = True
186                 self.assertEqual(
187                     {HOST: {"Coredump Enabled": enabled}},
188                     vsphere.coredump_network_enable(HOST, USER, PASSWORD, enabled),
189                 )
190     def test_set_coredump_network_config_esxi_hosts_not_list(self):
191         """
192         Tests CommandExecutionError is raised when esxi_hosts is provided,
193         but is not a list.
194         """
195         self.assertRaises(
196             CommandExecutionError,
197             vsphere.set_coredump_network_config,
198             HOST,
199             USER,
200             PASSWORD,
201             "loghost",
202             "foo",
203             esxi_hosts="bar",
204         )
205     def test_set_coredump_network_config_host_list_bad_retcode(self):
206         """
207         Tests error message returned with list of esxi_hosts.
208         """
209         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={"retcode": 1})):
210             host_1 = "host_1.foo.com"
211             self.assertEqual(
212                 {host_1: {"retcode": 1, "success": False}},
213                 vsphere.set_coredump_network_config(
214                     HOST, USER, PASSWORD, "dump-ip.test.com", esxi_hosts=[host_1]
215                 ),
216             )
217     def test_set_coredump_network_config_host_list_success(self):
218         """
219         Tests successful function return when an esxi_host is provided.
220         """
221         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={"retcode": 0})):
222             host_1 = "host_1.foo.com"
223             self.assertEqual(
224                 {host_1: {"retcode": 0, "success": True}},
225                 vsphere.set_coredump_network_config(
226                     HOST, USER, PASSWORD, "dump-ip.test.com", esxi_hosts=[host_1]
227                 ),
228             )
229     def test_set_coredump_network_config_bad_retcode(self):
230         """
231         Tests error message given for a single ESXi host.
232         """
233         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={"retcode": 1})):
234             self.assertEqual(
235                 {HOST: {"retcode": 1, "success": False}},
236                 vsphere.set_coredump_network_config(
237                     HOST, USER, PASSWORD, "dump-ip.test.com"
238                 ),
239             )
240     def test_set_coredump_network_config_success(self):
241         """
242         Tests successful function return for a single ESXi host.
243         """
244         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={"retcode": 0})):
245             self.assertEqual(
246                 {HOST: {"retcode": 0, "success": True}},
247                 vsphere.set_coredump_network_config(
248                     HOST, USER, PASSWORD, "dump-ip.test.com"
249                 ),
250             )
251     def test_get_firewall_status_esxi_hosts_not_list(self):
252         """
253         Tests CommandExecutionError is raised when esxi_hosts is provided,
254         but is not a list.
255         """
256         self.assertRaises(
257             CommandExecutionError,
258             vsphere.get_firewall_status,
259             HOST,
260             USER,
261             PASSWORD,
262             esxi_hosts="foo",
263         )
264     def test_get_firewall_status_host_list_bad_retcode(self):
265         """
266         Tests error message returned with list of esxi_hosts.
267         """
268         with patch(
269             "salt.utils.vmware.esxcli",
270             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
271         ):
272             host_1 = "host_1.foo.com"
273             self.assertEqual(
274                 {host_1: {"success": False, "Error": ERROR, "rulesets": None}},
275                 vsphere.get_firewall_status(HOST, USER, PASSWORD, esxi_hosts=[host_1]),
276             )
277     def test_get_firewall_status_host_list_success(self):
278         """
279         Tests successful function return when an esxi_host is provided.
280         """
281         with patch(
282             "salt.utils.vmware.esxcli",
283             MagicMock(return_value={"retcode": 0, "stdout": ""}),
284         ):
285             host_1 = "host_1.foo.com"
286             self.assertEqual(
287                 {host_1: {"rulesets": {}, "success": True}},
288                 vsphere.get_firewall_status(HOST, USER, PASSWORD, esxi_hosts=[host_1]),
289             )
290     def test_get_firewall_status_bad_retcode(self):
291         """
292         Tests error message given for a single ESXi host.
293         """
294         with patch(
295             "salt.utils.vmware.esxcli",
296             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
297         ):
298             self.assertEqual(
299                 {HOST: {"success": False, "Error": ERROR, "rulesets": None}},
300                 vsphere.get_firewall_status(HOST, USER, PASSWORD),
301             )
302     def test_get_firewall_status_success(self):
303         """
304         Tests successful function return for a single ESXi host.
305         """
306         with patch(
307             "salt.utils.vmware.esxcli",
308             MagicMock(return_value={"retcode": 0, "stdout": ""}),
309         ):
310             self.assertEqual(
311                 {HOST: {"rulesets": {}, "success": True}},
312                 vsphere.get_firewall_status(HOST, USER, PASSWORD),
313             )
314     def test_enable_firewall_ruleset_esxi_hosts_not_list(self):
315         """
316         Tests CommandExecutionError is raised when esxi_hosts is provided,
317         but is not a list.
318         """
319         self.assertRaises(
320             CommandExecutionError,
321             vsphere.enable_firewall_ruleset,
322             HOST,
323             USER,
324             PASSWORD,
325             "foo",
326             "bar",
327             esxi_hosts="baz",
328         )
329     def test_syslog_service_reload_esxi_hosts_not_list(self):
330         """
331         Tests CommandExecutionError is raised when esxi_hosts is provided,
332         but is not a list.
333         """
334         self.assertRaises(
335             CommandExecutionError,
336             vsphere.syslog_service_reload,
337             HOST,
338             USER,
339             PASSWORD,
340             esxi_hosts="foo",
341         )
342     def test_set_syslog_config_esxi_hosts_not_list(self):
343         """
344         Tests CommandExecutionError is raised when esxi_hosts is provided,
345         but is not a list, but we don't enter the 'loghost'/firewall loop.
346         """
347         self.assertRaises(
348             CommandExecutionError,
349             vsphere.set_syslog_config,
350             HOST,
351             USER,
352             PASSWORD,
353             "foo",
354             "bar",
355             esxi_hosts="baz",
356         )
357     def test_set_syslog_config_esxi_hosts_not_list_firewall(self):
358         """
359         Tests CommandExecutionError is raised when esxi_hosts is provided,
360         but is not a list, and we enter the 'loghost'/firewall loop.
361         """
362         self.assertRaises(
363             CommandExecutionError,
364             vsphere.set_syslog_config,
365             HOST,
366             USER,
367             PASSWORD,
368             "loghost",
369             "foo",
370             firewall=True,
371             esxi_hosts="bar",
372         )
373     def test_set_syslog_config_host_list_firewall_bad_retcode(self):
374         """
375         Tests error message returned with list of esxi_hosts with 'loghost' as syslog_config.
376         """
377         with patch(
378             "salt.modules.vsphere.enable_firewall_ruleset",
379             MagicMock(return_value={"host_1.foo.com": {"retcode": 1, "stdout": ERROR}}),
380         ):
381             with patch(
382                 "salt.modules.vsphere._set_syslog_config_helper",
383                 MagicMock(return_value={}),
384             ):
385                 host_1 = "host_1.foo.com"
386                 self.assertEqual(
387                     {host_1: {"enable_firewall": {"message": ERROR, "success": False}}},
388                     vsphere.set_syslog_config(
389                         HOST,
390                         USER,
391                         PASSWORD,
392                         "loghost",
393                         "foo",
394                         firewall=True,
395                         esxi_hosts=[host_1],
396                     ),
397                 )
398     def test_set_syslog_config_host_list_firewall_success(self):
399         """
400         Tests successful function return with list of esxi_hosts with 'loghost' as syslog_config.
401         """
402         with patch(
403             "salt.modules.vsphere.enable_firewall_ruleset",
404             MagicMock(return_value={"host_1.foo.com": {"retcode": 0}}),
405         ):
406             with patch(
407                 "salt.modules.vsphere._set_syslog_config_helper",
408                 MagicMock(return_value={}),
409             ):
410                 host_1 = "host_1.foo.com"
411                 self.assertEqual(
412                     {host_1: {"enable_firewall": {"success": True}}},
413                     vsphere.set_syslog_config(
414                         HOST,
415                         USER,
416                         PASSWORD,
417                         "loghost",
418                         "foo",
419                         firewall=True,
420                         esxi_hosts=[host_1],
421                     ),
422                 )
423     def test_set_syslog_config_firewall_bad_retcode(self):
424         """
425         Tests error message given for a single ESXi host with 'loghost' as syslog_config.
426         """
427         with patch(
428             "salt.modules.vsphere.enable_firewall_ruleset",
429             MagicMock(return_value={HOST: {"retcode": 1, "stdout": ERROR}}),
430         ):
431             with patch(
432                 "salt.modules.vsphere._set_syslog_config_helper",
433                 MagicMock(return_value={}),
434             ):
435                 self.assertEqual(
436                     {HOST: {"enable_firewall": {"message": ERROR, "success": False}}},
437                     vsphere.set_syslog_config(
438                         HOST, USER, PASSWORD, "loghost", "foo", firewall=True
439                     ),
440                 )
441     def test_set_syslog_config_firewall_success(self):
442         """
443         Tests successful function return for a single ESXi host with 'loghost' as syslog_config.
444         """
445         with patch(
446             "salt.modules.vsphere.enable_firewall_ruleset",
447             MagicMock(return_value={HOST: {"retcode": 0}}),
448         ):
449             with patch(
450                 "salt.modules.vsphere._set_syslog_config_helper",
451                 MagicMock(return_value={}),
452             ):
453                 self.assertEqual(
454                     {HOST: {"enable_firewall": {"success": True}}},
455                     vsphere.set_syslog_config(
456                         HOST, USER, PASSWORD, "loghost", "foo", firewall=True
457                     ),
458                 )
459     def test_get_syslog_config_esxi_hosts_not_list(self):
460         """
461         Tests CommandExecutionError is raised when esxi_hosts is provided,
462         but is not a list.
463         """
464         self.assertRaises(
465             CommandExecutionError,
466             vsphere.get_syslog_config,
467             HOST,
468             USER,
469             PASSWORD,
470             esxi_hosts="foo",
471         )
472     def test_get_syslog_config_host_list_bad_retcode(self):
473         """
474         Tests error message returned with list of esxi_hosts.
475         """
476         with patch(
477             "salt.utils.vmware.esxcli",
478             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
479         ):
480             host_1 = "host_1.foo.com"
481             self.assertEqual(
482                 {host_1: {"message": ERROR, "success": False}},
483                 vsphere.get_syslog_config(HOST, USER, PASSWORD, esxi_hosts=[host_1]),
484             )
485     def test_get_syslog_config_host_list_success(self):
486         """
487         Tests successful function return when an esxi_host is provided.
488         """
489         with patch(
490             "salt.utils.vmware.esxcli",
491             MagicMock(return_value={"retcode": 0, "stdout": ""}),
492         ):
493             host_1 = "host_1.foo.com"
494             self.assertEqual(
495                 {host_1: {"success": True}},
496                 vsphere.get_syslog_config(HOST, USER, PASSWORD, esxi_hosts=[host_1]),
497             )
498     def test_get_syslog_config_bad_retcode(self):
499         """
500         Tests error message given for a single ESXi host.
501         """
502         with patch(
503             "salt.utils.vmware.esxcli",
504             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
505         ):
506             self.assertEqual(
507                 {HOST: {"message": ERROR, "success": False}},
508                 vsphere.get_syslog_config(HOST, USER, PASSWORD),
509             )
510     def test_get_syslog_config_success(self):
511         """
512         Tests successful function return for a single ESXi host.
513         """
514         with patch(
515             "salt.utils.vmware.esxcli",
516             MagicMock(return_value={"retcode": 0, "stdout": ""}),
517         ):
518             self.assertEqual(
519                 {HOST: {"success": True}},
520                 vsphere.get_syslog_config(HOST, USER, PASSWORD),
521             )
522     def test_reset_syslog_config_no_syslog_config(self):
523         """
524         Tests CommandExecutionError is raised when a syslog_config parameter is missing.
525         """
526         self.assertRaises(
527             CommandExecutionError, vsphere.reset_syslog_config, HOST, USER, PASSWORD
528         )
529     def test_reset_syslog_config_esxi_hosts_not_list(self):
530         """
531         Tests CommandExecutionError is raised when esxi_hosts is provided,
532         but is not a list.
533         """
534         self.assertRaises(
535             CommandExecutionError,
536             vsphere.reset_syslog_config,
537             HOST,
538             USER,
539             PASSWORD,
540             syslog_config="test",
541             esxi_hosts="foo",
542         )
543     def test_reset_syslog_config_invalid_config_param(self):
544         """
545         Tests error message returned when an invalid syslog_config parameter is provided.
546         """
547         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={})):
548             error = "Invalid syslog configuration parameter"
549             self.assertEqual(
550                 {
551                     HOST: {
552                         "success": False,
553                         "test": {"message": error, "success": False},
554                     }
555                 },
556                 vsphere.reset_syslog_config(HOST, USER, PASSWORD, syslog_config="test"),
557             )
558     def test_reset_syslog_config_host_list_bad_retcode(self):
559         """
560         Tests error message returned with list of esxi_hosts.
561         """
562         with patch(
563             "salt.utils.vmware.esxcli",
564             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
565         ):
566             host_1 = "host_1.foo.com"
567             self.assertEqual(
568                 {
569                     host_1: {
570                         "success": False,
571                         "logdir": {"message": ERROR, "success": False},
572                     }
573                 },
574                 vsphere.reset_syslog_config(
575                     HOST, USER, PASSWORD, syslog_config="logdir", esxi_hosts=[host_1]
576                 ),
577             )
578     def test_reset_syslog_config_host_list_success(self):
579         """
580         Tests successful function return when an esxi_host is provided.
581         """
582         with patch(
583             "salt.utils.vmware.esxcli",
584             MagicMock(return_value={"retcode": 0, "stdout": ""}),
585         ):
586             host_1 = "host_1.foo.com"
587             self.assertEqual(
588                 {host_1: {"success": True, "loghost": {"success": True}}},
589                 vsphere.reset_syslog_config(
590                     HOST, USER, PASSWORD, syslog_config="loghost", esxi_hosts=[host_1]
591                 ),
592             )
593     def test_reset_syslog_config_bad_retcode(self):
594         """
595         Tests error message given for a single ESXi host.
596         """
597         with patch(
598             "salt.utils.vmware.esxcli",
599             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
600         ):
601             self.assertEqual(
602                 {
603                     HOST: {
604                         "success": False,
605                         "logdir-unique": {"message": ERROR, "success": False},
606                     }
607                 },
608                 vsphere.reset_syslog_config(
609                     HOST, USER, PASSWORD, syslog_config="logdir-unique"
610                 ),
611             )
612     def test_reset_syslog_config_success(self):
613         """
614         Tests successful function return for a single ESXi host.
615         """
616         with patch(
617             "salt.utils.vmware.esxcli",
618             MagicMock(return_value={"retcode": 0, "stdout": ""}),
619         ):
620             self.assertEqual(
621                 {HOST: {"success": True, "default-rotate": {"success": True}}},
622                 vsphere.reset_syslog_config(
623                     HOST, USER, PASSWORD, syslog_config="default-rotate"
624                 ),
625             )
626     def test_reset_syslog_config_success_multiple_configs(self):
627         """
628         Tests successful function return for a single ESXi host when passing in multiple syslog_config values.
629         """
630         with patch(
631             "salt.utils.vmware.esxcli",
632             MagicMock(return_value={"retcode": 0, "stdout": ""}),
633         ):
634             self.assertEqual(
635                 {
636                     HOST: {
637                         "success": True,
638                         "default-size": {"success": True},
639                         "default-timeout": {"success": True},
640                     }
641                 },
642                 vsphere.reset_syslog_config(
643                     HOST, USER, PASSWORD, syslog_config="default-size,default-timeout"
644                 ),
645             )
646     def test_reset_syslog_config_success_all_configs(self):
647         """
648         Tests successful function return for a single ESXi host when passing in multiple syslog_config values.
649         """
650         with patch(
651             "salt.utils.vmware.esxcli",
652             MagicMock(return_value={"retcode": 0, "stdout": ""}),
653         ):
654             self.assertEqual(
655                 {
656                     HOST: {
657                         "success": True,
658                         "logdir": {"success": True},
659                         "loghost": {"success": True},
660                         "default-rotate": {"success": True},
661                         "default-size": {"success": True},
662                         "default-timeout": {"success": True},
663                         "logdir-unique": {"success": True},
664                     }
665                 },
666                 vsphere.reset_syslog_config(HOST, USER, PASSWORD, syslog_config="all"),
667             )
668     def test_reset_syslog_config_params_no_valid_reset(self):
669         """
670         Tests function returns False when an invalid syslog config is passed.
671         """
672         valid_resets = ["hello", "world"]
673         config = "foo"
674         ret = {
675             "success": False,
676             config: {
677                 "success": False,
678                 "message": "Invalid syslog configuration parameter",
679             },
680         }
681         self.assertEqual(
682             ret,
683             vsphere._reset_syslog_config_params(
684                 HOST, USER, PASSWORD, "cmd", config, valid_resets
685             ),
686         )
687     def test_reset_syslog_config_params_error(self):
688         """
689         Tests function returns False when the esxxli function returns an unsuccessful retcode.
690         """
691         with patch(
692             "salt.utils.vmware.esxcli",
693             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
694         ):
695             valid_resets = ["hello", "world"]
696             error_dict = {"success": False, "message": ERROR}
697             ret = {"success": False, "hello": error_dict, "world": error_dict}
698             self.assertDictEqual(
699                 ret,
700                 vsphere._reset_syslog_config_params(
701                     HOST, USER, PASSWORD, "cmd", valid_resets, valid_resets
702                 ),
703             )
704     def test_reset_syslog_config_params_success(self):
705         """
706         Tests function returns True when the esxxli function returns a successful retcode.
707         """
708         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={"retcode": 0})):
709             valid_resets = ["hello", "world"]
710             ret = {
711                 "success": True,
712                 "hello": {"success": True},
713                 "world": {"success": True},
714             }
715             self.assertDictEqual(
716                 ret,
717                 vsphere._reset_syslog_config_params(
718                     HOST, USER, PASSWORD, "cmd", valid_resets, valid_resets
719                 ),
720             )
721     def test_set_syslog_config_helper_no_valid_reset(self):
722         """
723         Tests function returns False when an invalid syslog config is passed.
724         """
725         config = "foo"
726         ret = {
727             "success": False,
728             "message": "'{}' is not a valid config variable.".format(config),
729         }
730         self.assertEqual(
731             ret, vsphere._set_syslog_config_helper(HOST, USER, PASSWORD, config, "bar")
732         )
733     def test_set_syslog_config_helper_bad_retcode(self):
734         """
735         Tests function returns False when the esxcli function returns an unsuccessful retcode.
736         """
737         with patch(
738             "salt.utils.vmware.esxcli",
739             MagicMock(return_value={"retcode": 1, "stdout": ERROR}),
740         ):
741             config = "default-rotate"
742             self.assertEqual(
743                 {config: {"success": False, "message": ERROR}},
744                 vsphere._set_syslog_config_helper(HOST, USER, PASSWORD, config, "foo"),
745             )
746     def test_set_syslog_config_helper_success(self):
747         """
748         Tests successful function return.
749         """
750         with patch("salt.utils.vmware.esxcli", MagicMock(return_value={"retcode": 0})):
751             config = "logdir"
752             self.assertEqual(
753                 {config: {"success": True}},
754                 vsphere._set_syslog_config_helper(HOST, USER, PASSWORD, config, "foo"),
755             )
756 class GetProxyTypeTestCase(TestCase, LoaderModuleMockMixin):
757     """
758     Tests for salt.modules.vsphere.get_proxy_type
759     """
760     def setup_loader_modules(self):
761         return {vsphere: {}}
762     def test_output(self):
763         with patch.dict(
764             vsphere.__pillar__, {"proxy": {"proxytype": "fake_proxy_type"}}
765         ):
766             ret = vsphere.get_proxy_type()
767         self.assertEqual("fake_proxy_type", ret)
768 class SupportsProxiesTestCase(TestCase, LoaderModuleMockMixin):
769     """
770     Tests for salt.modules.vsphere._supports_proxies decorator
771     """
772     def setup_loader_modules(self):
773         return {vsphere: {}}
774     def test_supported_proxy(self):
775         @vsphere._supports_proxies("supported")
776         def mock_function():
777             return "fake_function"
778         with patch(
779             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="supported")
780         ):
781             ret = mock_function()
782         self.assertEqual("fake_function", ret)
783     def test_unsupported_proxy(self):
784         @vsphere._supports_proxies("supported")
785         def mock_function():
786             return "fake_function"
787         with patch(
788             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="unsupported")
789         ):
790             with self.assertRaises(CommandExecutionError) as excinfo:
791                 mock_function()
792         self.assertEqual(
793             "'unsupported' proxy is not supported by function mock_function",
794             excinfo.exception.strerror,
795         )
796 class _GetProxyConnectionDetailsTestCase(TestCase, LoaderModuleMockMixin):
797     """
798     Tests for salt.modules.vsphere._get_proxy_connection_details
799     """
800     def setup_loader_modules(self):
801         return {vsphere: {}}
802     def setUp(self):
803         self.esxi_host_details = {
804             "host": "fake_host",
805             "username": "fake_username",
806             "password": "fake_password",
807             "protocol": "fake_protocol",
808             "port": "fake_port",
809             "mechanism": "fake_mechanism",
810             "principal": "fake_principal",
811             "domain": "fake_domain",
812         }
813         self.esxi_vcenter_details = {
814             "vcenter": "fake_vcenter",
815             "username": "fake_username",
816             "password": "fake_password",
817             "protocol": "fake_protocol",
818             "port": "fake_port",
819             "mechanism": "fake_mechanism",
820             "principal": "fake_principal",
821             "domain": "fake_domain",
822         }
823         self.esxdatacenter_details = {
824             "vcenter": "fake_vcenter",
825             "datacenter": "fake_dc",
826             "username": "fake_username",
827             "password": "fake_password",
828             "protocol": "fake_protocol",
829             "port": "fake_port",
830             "mechanism": "fake_mechanism",
831             "principal": "fake_principal",
832             "domain": "fake_domain",
833         }
834         self.esxcluster_details = {
835             "vcenter": "fake_vcenter",
836             "datacenter": "fake_dc",
837             "cluster": "fake_cluster",
838             "username": "fake_username",
839             "password": "fake_password",
840             "protocol": "fake_protocol",
841             "port": "fake_port",
842             "mechanism": "fake_mechanism",
843             "principal": "fake_principal",
844             "domain": "fake_domain",
845         }
846         self.vcenter_details = {
847             "vcenter": "fake_vcenter",
848             "username": "fake_username",
849             "password": "fake_password",
850             "protocol": "fake_protocol",
851             "port": "fake_port",
852             "mechanism": "fake_mechanism",
853             "principal": "fake_principal",
854             "domain": "fake_domain",
855         }
856     def tearDown(self):
857         for attrname in (
858             "esxi_host_details",
859             "esxi_vcenter_details",
860             "esxdatacenter_details",
861             "esxcluster_details",
862         ):
863             try:
864                 delattr(self, attrname)
865             except AttributeError:
866                 continue
867     def test_esxi_proxy_host_details(self):
868         with patch(
869             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxi")
870         ):
871             with patch.dict(
872                 vsphere.__salt__,
873                 {"esxi.get_details": MagicMock(return_value=self.esxi_host_details)},
874             ):
875                 ret = vsphere._get_proxy_connection_details()
876         self.assertEqual(
877             (
878                 "fake_host",
879                 "fake_username",
880                 "fake_password",
881                 "fake_protocol",
882                 "fake_port",
883                 "fake_mechanism",
884                 "fake_principal",
885                 "fake_domain",
886             ),
887             ret,
888         )
889     def test_esxdatacenter_proxy_details(self):
890         with patch(
891             "salt.modules.vsphere.get_proxy_type",
892             MagicMock(return_value="esxdatacenter"),
893         ):
894             with patch.dict(
895                 vsphere.__salt__,
896                 {
897                     "esxdatacenter.get_details": MagicMock(
898                         return_value=self.esxdatacenter_details
899                     )
900                 },
901             ):
902                 ret = vsphere._get_proxy_connection_details()
903         self.assertEqual(
904             (
905                 "fake_vcenter",
906                 "fake_username",
907                 "fake_password",
908                 "fake_protocol",
909                 "fake_port",
910                 "fake_mechanism",
911                 "fake_principal",
912                 "fake_domain",
913             ),
914             ret,
915         )
916     def test_esxcluster_proxy_details(self):
917         with patch(
918             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxcluster")
919         ):
920             with patch.dict(
921                 vsphere.__salt__,
922                 {
923                     "esxcluster.get_details": MagicMock(
924                         return_value=self.esxcluster_details
925                     )
926                 },
927             ):
928                 ret = vsphere._get_proxy_connection_details()
929         self.assertEqual(
930             (
931                 "fake_vcenter",
932                 "fake_username",
933                 "fake_password",
934                 "fake_protocol",
935                 "fake_port",
936                 "fake_mechanism",
937                 "fake_principal",
938                 "fake_domain",
939             ),
940             ret,
941         )
942     def test_esxi_proxy_vcenter_details(self):
943         with patch(
944             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxi")
945         ):
946             with patch.dict(
947                 vsphere.__salt__,
948                 {"esxi.get_details": MagicMock(return_value=self.esxi_vcenter_details)},
949             ):
950                 ret = vsphere._get_proxy_connection_details()
951         self.assertEqual(
952             (
953                 "fake_vcenter",
954                 "fake_username",
955                 "fake_password",
956                 "fake_protocol",
957                 "fake_port",
958                 "fake_mechanism",
959                 "fake_principal",
960                 "fake_domain",
961             ),
962             ret,
963         )
964     def test_vcenter_proxy_details(self):
965         with patch(
966             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="vcenter")
967         ):
968             with patch.dict(
969                 vsphere.__salt__,
970                 {"vcenter.get_details": MagicMock(return_value=self.vcenter_details)},
971             ):
972                 ret = vsphere._get_proxy_connection_details()
973         self.assertEqual(
974             (
975                 "fake_vcenter",
976                 "fake_username",
977                 "fake_password",
978                 "fake_protocol",
979                 "fake_port",
980                 "fake_mechanism",
981                 "fake_principal",
982                 "fake_domain",
983             ),
984             ret,
985         )
986     def test_unsupported_proxy_details(self):
987         with patch(
988             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="unsupported")
989         ):
990             with self.assertRaises(CommandExecutionError) as excinfo:
991                 ret = vsphere._get_proxy_connection_details()
992         self.assertEqual(
993             "'unsupported' proxy is not supported", excinfo.exception.strerror
994         )
995     def test_vcenter_proxy_details_verify_ssl(self):
996         for verify_ssl in [True, False]:
997             details = self.vcenter_details.copy()
998             details["verify_ssl"] = verify_ssl
999             with patch(
1000                 "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="vcenter")
1001             ):
1002                 with patch.dict(
1003                     vsphere.__salt__,
1004                     {"vcenter.get_details": MagicMock(return_value=details)},
1005                 ):
1006                     ret = vsphere._get_proxy_connection_details()
1007             self.assertEqual(
1008                 (
1009                     "fake_vcenter",
1010                     "fake_username",
1011                     "fake_password",
1012                     "fake_protocol",
1013                     "fake_port",
1014                     "fake_mechanism",
1015                     "fake_principal",
1016                     "fake_domain",
1017                     verify_ssl,
1018                 ),
1019                 ret,
1020             )
1021 class GetsServiceInstanceViaProxyTestCase(TestCase, LoaderModuleMockMixin):
1022     """
1023     Tests for salt.modules.vsphere._gets_service_instance_via_proxy
1024     decorator
1025     """
1026     def setup_loader_modules(self):
1027         patcher = patch("salt.utils.vmware.get_service_instance", MagicMock())
1028         patcher.start()
1029         self.addCleanup(patcher.stop)
1030         patcher = patch("salt.utils.vmware.disconnect", MagicMock())
1031         patcher.start()
1032         self.addCleanup(patcher.stop)
1033         return {vsphere: {"_get_proxy_connection_details": MagicMock()}}
1034     def setUp(self):
1035         self.mock_si = MagicMock()
1036         self.mock_details1 = MagicMock()
1037         self.mock_details2 = MagicMock()
1038     def tearDown(self):
1039         for attrname in ("mock_si", "mock_details1", "mock_details2"):
1040             try:
1041                 delattr(self, attrname)
1042             except AttributeError:
1043                 continue
1044     def test_no_service_instance_or_kwargs_parameters(self):
1045         @vsphere._gets_service_instance_via_proxy
1046         def mock_function():
1047             return "fake_function"
1048         with self.assertRaises(CommandExecutionError) as excinfo:
1049             mock_function()
1050         self.assertEqual(
1051             "Function mock_function must have either a "
1052             "'service_instance', or a '**kwargs' type "
1053             "parameter",
1054             excinfo.exception.strerror,
1055         )
1056     def test___get_proxy_connection_details_call(self):
1057         mock__get_proxy_connection_details = MagicMock()
1058         @vsphere._gets_service_instance_via_proxy
1059         def mock_function(service_instance=None):
1060             return service_instance
1061         with patch(
1062             "salt.modules.vsphere._get_proxy_connection_details",
1063             mock__get_proxy_connection_details,
1064         ):
1065             mock_function()
1066         mock__get_proxy_connection_details.assert_called_once_with()
1067     def test_service_instance_named_parameter_no_value(self):
1068         mock_get_service_instance = MagicMock(return_value=self.mock_si)
1069         mock_disconnect = MagicMock()
1070         @vsphere._gets_service_instance_via_proxy
1071         def mock_function(service_instance=None):
1072             return service_instance
1073         with patch(
1074             "salt.modules.vsphere._get_proxy_connection_details",
1075             MagicMock(return_value=(self.mock_details1, self.mock_details2)),
1076         ):
1077             with patch(
1078                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
1079             ):
1080                 with patch("salt.utils.vmware.disconnect", mock_disconnect):
1081                     ret = mock_function()
1082         mock_get_service_instance.assert_called_once_with(
1083             self.mock_details1, self.mock_details2
1084         )
1085         mock_disconnect.assert_called_once_with(self.mock_si)
1086         self.assertEqual(ret, self.mock_si)
1087     def test_service_instance_kwargs_parameter_no_value(self):
1088         mock_get_service_instance = MagicMock(return_value=self.mock_si)
1089         mock_disconnect = MagicMock()
1090         @vsphere._gets_service_instance_via_proxy
1091         def mock_function(**kwargs):
1092             return kwargs["service_instance"]
1093         with patch(
1094             "salt.modules.vsphere._get_proxy_connection_details",
1095             MagicMock(return_value=(self.mock_details1, self.mock_details2)),
1096         ):
1097             with patch(
1098                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
1099             ):
1100                 with patch("salt.utils.vmware.disconnect", mock_disconnect):
1101                     ret = mock_function()
1102         mock_get_service_instance.assert_called_once_with(
1103             self.mock_details1, self.mock_details2
1104         )
1105         mock_disconnect.assert_called_once_with(self.mock_si)
1106         self.assertEqual(ret, self.mock_si)
1107     def test_service_instance_positional_parameter_no_default_value(self):
1108         mock_get_service_instance = MagicMock()
1109         mock_disconnect = MagicMock()
1110         @vsphere._gets_service_instance_via_proxy
1111         def mock_function(service_instance):
1112             return service_instance
1113         with patch(
1114             "salt.modules.vsphere._get_proxy_connection_details",
1115             MagicMock(return_value=(self.mock_details1, self.mock_details2)),
1116         ):
1117             with patch(
1118                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
1119             ):
1120                 with patch("salt.utils.vmware.disconnect", mock_disconnect):
1121                     ret = mock_function(self.mock_si)
1122         self.assertEqual(mock_get_service_instance.call_count, 0)
1123         self.assertEqual(mock_disconnect.call_count, 0)
1124         self.assertEqual(ret, self.mock_si)
1125     def test_service_instance_positional_parameter_with_default_value(self):
1126         mock_get_service_instance = MagicMock()
1127         mock_disconnect = MagicMock()
1128         @vsphere._gets_service_instance_via_proxy
1129         def mock_function(service_instance=None):
1130             return service_instance
1131         with patch(
1132             "salt.modules.vsphere._get_proxy_connection_details",
1133             MagicMock(return_value=(self.mock_details1, self.mock_details2)),
1134         ):
1135             with patch(
1136                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
1137             ):
1138                 with patch("salt.utils.vmware.disconnect", mock_disconnect):
1139                     ret = mock_function(self.mock_si)
1140         self.assertEqual(mock_get_service_instance.call_count, 0)
1141         self.assertEqual(mock_disconnect.call_count, 0)
1142         self.assertEqual(ret, self.mock_si)
1143     def test_service_instance_named_parameter_with_default_value(self):
1144         mock_get_service_instance = MagicMock()
1145         mock_disconnect = MagicMock()
1146         @vsphere._gets_service_instance_via_proxy
1147         def mock_function(service_instance=None):
1148             return service_instance
1149         with patch(
1150             "salt.modules.vsphere._get_proxy_connection_details",
1151             MagicMock(return_value=(self.mock_details1, self.mock_details2)),
1152         ):
1153             with patch(
1154                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
1155             ):
1156                 with patch("salt.utils.vmware.disconnect", mock_disconnect):
1157                     ret = mock_function(service_instance=self.mock_si)
1158         self.assertEqual(mock_get_service_instance.call_count, 0)
1159         self.assertEqual(mock_disconnect.call_count, 0)
1160         self.assertEqual(ret, self.mock_si)
1161     def test_service_instance_kwargs_parameter_passthrough(self):
1162         mock_get_service_instance = MagicMock()
1163         mock_disconnect = MagicMock()
1164         @vsphere._gets_service_instance_via_proxy
1165         def mock_function(**kwargs):
1166             return kwargs["service_instance"]
1167         with patch(
1168             "salt.modules.vsphere._get_proxy_connection_details",
1169             MagicMock(return_value=(self.mock_details1, self.mock_details2)),
1170         ):
1171             with patch(
1172                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
1173             ):
1174                 with patch("salt.utils.vmware.disconnect", mock_disconnect):
1175                     ret = mock_function(service_instance=self.mock_si)
1176         self.assertEqual(mock_get_service_instance.call_count, 0)
1177         self.assertEqual(mock_disconnect.call_count, 0)
1178         self.assertEqual(ret, self.mock_si)
1179 class GetServiceInstanceViaProxyTestCase(TestCase, LoaderModuleMockMixin):
1180     """
1181     Tests for salt.modules.vsphere.get_service_instance_via_proxy
1182     """
1183     def setup_loader_modules(self):
1184         patcher = patch("salt.utils.vmware.get_service_instance", MagicMock())
1185         patcher.start()
1186         self.addCleanup(patcher.stop)
1187         return {
1188             vsphere: {
1189                 "get_proxy_type": MagicMock(return_value="esxi"),
1190                 "_get_proxy_connection_details": MagicMock(),
1191             }
1192         }
1193     def test_supported_proxies(self):
1194         supported_proxies = ["esxi", "esxcluster", "esxdatacenter", "vcenter", "esxvm"]
1195         for proxy_type in supported_proxies:
1196             with patch(
1197                 "salt.modules.vsphere.get_proxy_type",
1198                 MagicMock(return_value=proxy_type),
1199             ):
1200                 vsphere.get_service_instance_via_proxy()
1201     def test_get_service_instance_call(self):
1202         mock_connection_details = [MagicMock(), MagicMock(), MagicMock()]
1203         mock_get_service_instance = MagicMock()
1204         with patch(
1205             "salt.modules.vsphere._get_proxy_connection_details",
1206             MagicMock(return_value=mock_connection_details),
1207         ):
1208             with patch(
1209                 "salt.utils.vmware.get_service_instance", mock_get_service_instance
1210             ):
1211                 vsphere.get_service_instance_via_proxy()
1212         mock_get_service_instance.assert_called_once_with(*mock_connection_details)
1213     def test_output(self):
1214         mock_si = MagicMock()
1215         with patch(
1216             "salt.utils.vmware.get_service_instance", MagicMock(return_value=mock_si)
1217         ):
1218             res = vsphere.get_service_instance_via_proxy()
1219         self.assertEqual(res, mock_si)
1220 class DisconnectTestCase(TestCase, LoaderModuleMockMixin):
1221     """
1222     Tests for salt.modules.vsphere.disconnect
1223     """
1224     def setup_loader_modules(self):
1225         self.mock_si = MagicMock()
1226         self.addCleanup(delattr, self, "mock_si")
1227         patcher = patch("salt.utils.vmware.disconnect", MagicMock())
1228         patcher.start()
1229         self.addCleanup(patcher.stop)
1230         return {
1231             vsphere: {
1232                 "_get_proxy_connection_details": MagicMock(),
1233                 "get_proxy_type": MagicMock(return_value="esxi"),
1234             }
1235         }
1236     def test_supported_proxies(self):
1237         supported_proxies = ["esxi", "esxcluster", "esxdatacenter", "vcenter", "esxvm"]
1238         for proxy_type in supported_proxies:
1239             with patch(
1240                 "salt.modules.vsphere.get_proxy_type",
1241                 MagicMock(return_value=proxy_type),
1242             ):
1243                 vsphere.disconnect(self.mock_si)
1244     def test_disconnect_call(self):
1245         mock_disconnect = MagicMock()
1246         with patch("salt.utils.vmware.disconnect", mock_disconnect):
1247             vsphere.disconnect(self.mock_si)
1248         mock_disconnect.assert_called_once_with(self.mock_si)
1249     def test_output(self):
1250         res = vsphere.disconnect(self.mock_si)
1251         self.assertEqual(res, True)
1252 class TestVcenterConnectionTestCase(TestCase, LoaderModuleMockMixin):
1253     """
1254     Tests for salt.modules.vsphere.test_vcenter_connection
1255     """
1256     def setup_loader_modules(self):
1257         self.mock_si = MagicMock()
1258         self.addCleanup(delattr, self, "mock_si")
1259         patcher = patch(
1260             "salt.utils.vmware.get_service_instance",
1261             MagicMock(return_value=self.mock_si),
1262         )
1263         patcher.start()
1264         self.addCleanup(patcher.stop)
1265         patcher = patch("salt.utils.vmware.disconnect", MagicMock())
1266         patcher.start()
1267         self.addCleanup(patcher.stop)
1268         patcher = patch("salt.utils.vmware.is_connection_to_a_vcenter", MagicMock())
1269         patcher.start()
1270         self.addCleanup(patcher.stop)
1271         return {
1272             vsphere: {
1273                 "_get_proxy_connection_details": MagicMock(),
1274                 "get_proxy_type": MagicMock(return_value="esxi"),
1275             }
1276         }
1277     def test_supported_proxies(self):
1278         supported_proxies = ["esxi", "esxcluster", "esxdatacenter", "vcenter", "esxvm"]
1279         for proxy_type in supported_proxies:
1280             with patch(
1281                 "salt.modules.vsphere.get_proxy_type",
1282                 MagicMock(return_value=proxy_type),
1283             ):
1284                 vsphere.test_vcenter_connection()
1285     def test_is_connection_to_a_vcenter_call_default_service_instance(self):
1286         mock_is_connection_to_a_vcenter = MagicMock()
1287         with patch(
1288             "salt.utils.vmware.is_connection_to_a_vcenter",
1289             mock_is_connection_to_a_vcenter,
1290         ):
1291             vsphere.test_vcenter_connection()
1292         mock_is_connection_to_a_vcenter.assert_called_once_with(self.mock_si)
1293     def test_is_connection_to_a_vcenter_call_explicit_service_instance(self):
1294         expl_mock_si = MagicMock()
1295         mock_is_connection_to_a_vcenter = MagicMock()
1296         with patch(
1297             "salt.utils.vmware.is_connection_to_a_vcenter",
1298             mock_is_connection_to_a_vcenter,
1299         ):
1300             vsphere.test_vcenter_connection(expl_mock_si)
1301         mock_is_connection_to_a_vcenter.assert_called_once_with(expl_mock_si)
1302     def test_is_connection_to_a_vcenter_raises_vmware_salt_error(self):
1303         exc = VMwareSaltError("VMwareSaltError")
1304         with patch(
1305             "salt.utils.vmware.is_connection_to_a_vcenter", MagicMock(side_effect=exc)
1306         ):
1307             res = vsphere.test_vcenter_connection()
1308         self.assertEqual(res, False)
1309     def test_is_connection_to_a_vcenter_raises_non_vmware_salt_error(self):
1310         exc = Exception("NonVMwareSaltError")
1311         with patch(
1312             "salt.utils.vmware.is_connection_to_a_vcenter", MagicMock(side_effect=exc)
1313         ):
1314             with self.assertRaises(Exception) as excinfo:
1315                 res = vsphere.test_vcenter_connection()
1316         self.assertEqual("NonVMwareSaltError", str(excinfo.exception))
1317     def test_output_true(self):
1318         with patch(
1319             "salt.utils.vmware.is_connection_to_a_vcenter", MagicMock(return_value=True)
1320         ):
1321             res = vsphere.test_vcenter_connection()
1322         self.assertEqual(res, True)
1323     def test_output_false(self):
1324         with patch(
1325             "salt.utils.vmware.is_connection_to_a_vcenter",
1326             MagicMock(return_value=False),
1327         ):
1328             res = vsphere.test_vcenter_connection()
1329         self.assertEqual(res, False)
1330 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1331 class ListDatacentersViaProxyTestCase(TestCase, LoaderModuleMockMixin):
1332     """
1333     Tests for salt.modules.vsphere.list_datacenters_via_proxy
1334     """
1335     def setup_loader_modules(self):
1336         self.mock_si = MagicMock()
1337         self.addCleanup(delattr, self, "mock_si")
1338         patcher = patch(
1339             "salt.utils.vmware.get_service_instance",
1340             MagicMock(return_value=self.mock_si),
1341         )
1342         patcher.start()
1343         self.addCleanup(patcher.stop)
1344         patcher = patch("salt.utils.vmware.get_datacenters", MagicMock())
1345         patcher.start()
1346         self.addCleanup(patcher.stop)
1347         patcher = patch("salt.utils.vmware.get_managed_object_name", MagicMock())
1348         patcher.start()
1349         self.addCleanup(patcher.stop)
1350         return {
1351             vsphere: {
1352                 "_get_proxy_connection_details": MagicMock(),
1353                 "get_proxy_type": MagicMock(return_value="esxdatacenter"),
1354             }
1355         }
1356     def test_supported_proxies(self):
1357         supported_proxies = ["esxcluster", "esxdatacenter", "vcenter", "esxvm"]
1358         for proxy_type in supported_proxies:
1359             with patch(
1360                 "salt.modules.vsphere.get_proxy_type",
1361                 MagicMock(return_value=proxy_type),
1362             ):
1363                 vsphere.list_datacenters_via_proxy()
1364     def test_default_params(self):
1365         mock_get_datacenters = MagicMock()
1366         with patch("salt.utils.vmware.get_datacenters", mock_get_datacenters):
1367             vsphere.list_datacenters_via_proxy()
1368         mock_get_datacenters.assert_called_once_with(
1369             self.mock_si, get_all_datacenters=True
1370         )
1371     def test_defined_service_instance(self):
1372         mock_si = MagicMock()
1373         mock_get_datacenters = MagicMock()
1374         with patch("salt.utils.vmware.get_datacenters", mock_get_datacenters):
1375             vsphere.list_datacenters_via_proxy(service_instance=mock_si)
1376         mock_get_datacenters.assert_called_once_with(mock_si, get_all_datacenters=True)
1377     def test_defined_datacenter_names(self):
1378         mock_datacenters = MagicMock()
1379         mock_get_datacenters = MagicMock()
1380         with patch("salt.utils.vmware.get_datacenters", mock_get_datacenters):
1381             vsphere.list_datacenters_via_proxy(mock_datacenters)
1382         mock_get_datacenters.assert_called_once_with(self.mock_si, mock_datacenters)
1383     def test_get_managed_object_name_calls(self):
1384         mock_get_managed_object_name = MagicMock()
1385         mock_dcs = [MagicMock(), MagicMock()]
1386         with patch(
1387             "salt.utils.vmware.get_datacenters", MagicMock(return_value=mock_dcs)
1388         ):
1389             with patch(
1390                 "salt.utils.vmware.get_managed_object_name",
1391                 mock_get_managed_object_name,
1392             ):
1393                 vsphere.list_datacenters_via_proxy()
1394         mock_get_managed_object_name.assert_has_calls(
1395             [call(mock_dcs[0]), call(mock_dcs[1])]
1396         )
1397     def test_returned_array(self):
1398         with patch(
1399             "salt.utils.vmware.get_datacenters",
1400             MagicMock(return_value=[MagicMock(), MagicMock()]),
1401         ):
1402             with patch(
1403                 "salt.utils.vmware.get_managed_object_name",
1404                 MagicMock(side_effect=["fake_dc1", "fake_dc2", "fake_dc3"]),
1405             ):
1406                 res = vsphere.list_datacenters_via_proxy()
1407         self.assertEqual(res, [{"name": "fake_dc1"}, {"name": "fake_dc2"}])
1408 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1409 class CreateDatacenterTestCase(TestCase, LoaderModuleMockMixin):
1410     """
1411     Tests for salt.modules.vsphere.create_datacenter
1412     """
1413     def setup_loader_modules(self):
1414         self.mock_si = MagicMock()
1415         self.addCleanup(delattr, self, "mock_si")
1416         patcher = patch(
1417             "salt.utils.vmware.get_service_instance",
1418             MagicMock(return_value=self.mock_si),
1419         )
1420         patcher.start()
1421         self.addCleanup(patcher.stop)
1422         patcher = patch("salt.utils.vmware.create_datacenter", MagicMock())
1423         patcher.start()
1424         self.addCleanup(patcher.stop)
1425         return {
1426             vsphere: {
1427                 "_get_proxy_connection_details": MagicMock(),
1428                 "get_proxy_type": MagicMock(return_value="esxdatacenter"),
1429             }
1430         }
1431     def test_supported_proxies(self):
1432         supported_proxies = ["esxdatacenter", "vcenter"]
1433         for proxy_type in supported_proxies:
1434             with patch(
1435                 "salt.modules.vsphere.get_proxy_type",
1436                 MagicMock(return_value=proxy_type),
1437             ):
1438                 vsphere.create_datacenter("fake_dc1")
1439     def test_default_service_instance(self):
1440         mock_create_datacenter = MagicMock()
1441         with patch("salt.utils.vmware.create_datacenter", mock_create_datacenter):
1442             vsphere.create_datacenter("fake_dc1")
1443         mock_create_datacenter.assert_called_once_with(self.mock_si, "fake_dc1")
1444     def test_defined_service_instance(self):
1445         mock_si = MagicMock()
1446         mock_create_datacenter = MagicMock()
1447         with patch("salt.utils.vmware.create_datacenter", mock_create_datacenter):
1448             vsphere.create_datacenter("fake_dc1", service_instance=mock_si)
1449         mock_create_datacenter.assert_called_once_with(mock_si, "fake_dc1")
1450     def test_returned_value(self):
1451         res = vsphere.create_datacenter("fake_dc1")
1452         self.assertEqual(res, {"create_datacenter": True})
1453 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1454 class EraseDiskPartitionsTestCase(TestCase, LoaderModuleMockMixin):
1455     """
1456     Tests for salt.modules.vsphere.erase_disk_partitions
1457     """
1458     def setup_loader_modules(self):
1459         return {
1460             vsphere: {
1461                 "_get_proxy_connection_details": MagicMock(),
1462                 "__proxy__": {
1463                     "esxi.get_details": MagicMock(
1464                         return_value={"esxi_host": "fake_host"}
1465                     )
1466                 },
1467             }
1468         }
1469     def setUp(self):
1470         attrs = (("mock_si", MagicMock()), ("mock_host", MagicMock()))
1471         for attr, mock_obj in attrs:
1472             setattr(self, attr, mock_obj)
1473             self.addCleanup(delattr, self, attr)
1474         attrs = (
1475             ("mock_proxy_target", MagicMock(return_value=self.mock_host)),
1476             ("mock_erase_disk_partitions", MagicMock()),
1477         )
1478         for attr, mock_obj in attrs:
1479             setattr(self, attr, mock_obj)
1480             self.addCleanup(delattr, self, attr)
1481         patches = (
1482             (
1483                 "salt.utils.vmware.get_service_instance",
1484                 MagicMock(return_value=self.mock_si),
1485             ),
1486             ("salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxi")),
1487             (
1488                 "salt.modules.vsphere._get_proxy_target",
1489                 MagicMock(return_value=self.mock_host),
1490             ),
1491             (
1492                 "salt.utils.vmware.erase_disk_partitions",
1493                 self.mock_erase_disk_partitions,
1494             ),
1495         )
1496         for module, mock_obj in patches:
1497             patcher = patch(module, mock_obj)
1498             patcher.start()
1499             self.addCleanup(patcher.stop)
1500     def test_supported_proxies(self):
1501         supported_proxies = ["esxi"]
1502         for proxy_type in supported_proxies:
1503             with patch(
1504                 "salt.modules.vsphere.get_proxy_type",
1505                 MagicMock(return_value=proxy_type),
1506             ):
1507                 vsphere.erase_disk_partitions(disk_id="fake_disk")
1508     def test_no_disk_id_or_scsi_address(self):
1509         with self.assertRaises(ArgumentValueError) as excinfo:
1510             vsphere.erase_disk_partitions()
1511         self.assertEqual(
1512             "Either 'disk_id' or 'scsi_address' needs to be specified",
1513             excinfo.exception.strerror,
1514         )
1515     def test_get_proxy_target(self):
1516         mock_test_proxy_target = MagicMock()
1517         with patch("salt.modules.vsphere._get_proxy_target", mock_test_proxy_target):
1518             vsphere.erase_disk_partitions(disk_id="fake_disk")
1519         mock_test_proxy_target.assert_called_once_with(self.mock_si)
1520     def test_scsi_address_not_found(self):
1521         mock = MagicMock(return_value={"bad_scsi_address": "bad_disk_id"})
1522         with patch("salt.utils.vmware.get_scsi_address_to_lun_map", mock):
1523             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
1524                 vsphere.erase_disk_partitions(scsi_address="fake_scsi_address")
1525         self.assertEqual(
1526             "Scsi lun with address 'fake_scsi_address' was "
1527             "not found on host 'fake_host'",
1528             excinfo.exception.strerror,
1529         )
1530     def test_scsi_address_to_disk_id_map(self):
1531         mock_disk_id = MagicMock(canonicalName="fake_scsi_disk_id")
1532         mock_get_scsi_addr_to_lun = MagicMock(
1533             return_value={"fake_scsi_address": mock_disk_id}
1534         )
1535         with patch(
1536             "salt.utils.vmware.get_scsi_address_to_lun_map", mock_get_scsi_addr_to_lun
1537         ):
1538             vsphere.erase_disk_partitions(scsi_address="fake_scsi_address")
1539         mock_get_scsi_addr_to_lun.assert_called_once_with(self.mock_host)
1540         self.mock_erase_disk_partitions.assert_called_once_with(
1541             self.mock_si, self.mock_host, "fake_scsi_disk_id", hostname="fake_host"
1542         )
1543     def test_erase_disk_partitions(self):
1544         vsphere.erase_disk_partitions(disk_id="fake_disk_id")
1545         self.mock_erase_disk_partitions.assert_called_once_with(
1546             self.mock_si, self.mock_host, "fake_disk_id", hostname="fake_host"
1547         )
1548 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1549 class RemoveDatastoreTestCase(TestCase, LoaderModuleMockMixin):
1550     """
1551     Tests for salt.modules.vsphere.remove_datastore
1552     """
1553     def setup_loader_modules(self):
1554         return {
1555             vsphere: {
1556                 "_get_proxy_connection_details": MagicMock(),
1557                 "get_proxy_type": MagicMock(return_value="esxdatacenter"),
1558             }
1559         }
1560     def setUp(self):
1561         attrs = (
1562             ("mock_si", MagicMock()),
1563             ("mock_target", MagicMock()),
1564             ("mock_ds", MagicMock()),
1565         )
1566         for attr, mock_obj in attrs:
1567             setattr(self, attr, mock_obj)
1568             self.addCleanup(delattr, self, attr)
1569         patches = (
1570             (
1571                 "salt.utils.vmware.get_service_instance",
1572                 MagicMock(return_value=self.mock_si),
1573             ),
1574             (
1575                 "salt.modules.vsphere.get_proxy_type",
1576                 MagicMock(return_value="esxdatacenter"),
1577             ),
1578             (
1579                 "salt.modules.vsphere._get_proxy_target",
1580                 MagicMock(return_value=self.mock_target),
1581             ),
1582             (
1583                 "salt.utils.vmware.get_datastores",
1584                 MagicMock(return_value=[self.mock_ds]),
1585             ),
1586             ("salt.utils.vmware.remove_datastore", MagicMock()),
1587         )
1588         for module, mock_obj in patches:
1589             patcher = patch(module, mock_obj)
1590             patcher.start()
1591             self.addCleanup(patcher.stop)
1592     def test_supported_proxes(self):
1593         supported_proxies = ["esxi", "esxcluster", "esxdatacenter"]
1594         for proxy_type in supported_proxies:
1595             with patch(
1596                 "salt.modules.vsphere.get_proxy_type",
1597                 MagicMock(return_value=proxy_type),
1598             ):
1599                 vsphere.remove_datastore(datastore="fake_ds_name")
1600     def test__get_proxy_target_call(self):
1601         mock__get_proxy_target = MagicMock(return_value=self.mock_target)
1602         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
1603             vsphere.remove_datastore(datastore="fake_ds_name")
1604         mock__get_proxy_target.assert_called_once_with(self.mock_si)
1605     def test_get_datastores_call(self):
1606         mock_get_datastores = MagicMock()
1607         with patch("salt.utils.vmware.get_datastores", mock_get_datastores):
1608             vsphere.remove_datastore(datastore="fake_ds")
1609         mock_get_datastores.assert_called_once_with(
1610             self.mock_si, reference=self.mock_target, datastore_names=["fake_ds"]
1611         )
1612     def test_datastore_not_found(self):
1613         with patch("salt.utils.vmware.get_datastores", MagicMock(return_value=[])):
1614             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
1615                 vsphere.remove_datastore(datastore="fake_ds")
1616         self.assertEqual(
1617             "Datastore 'fake_ds' was not found", excinfo.exception.strerror
1618         )
1619     def test_multiple_datastores_found(self):
1620         with patch(
1621             "salt.utils.vmware.get_datastores",
1622             MagicMock(return_value=[MagicMock(), MagicMock()]),
1623         ):
1624             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
1625                 vsphere.remove_datastore(datastore="fake_ds")
1626         self.assertEqual(
1627             "Multiple datastores 'fake_ds' were found", excinfo.exception.strerror
1628         )
1629     def test_remove_datastore_call(self):
1630         mock_remove_datastore = MagicMock()
1631         with patch("salt.utils.vmware.remove_datastore", mock_remove_datastore):
1632             vsphere.remove_datastore(datastore="fake_ds")
1633         mock_remove_datastore.assert_called_once_with(self.mock_si, self.mock_ds)
1634     def test_success_output(self):
1635         res = vsphere.remove_datastore(datastore="fake_ds")
1636         self.assertTrue(res)
1637 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1638 class RemoveDiskgroupTestCase(TestCase, LoaderModuleMockMixin):
1639     """
1640     Tests for salt.modules.vsphere.remove_diskgroup
1641     """
1642     def setup_loader_modules(self):
1643         return {
1644             vsphere: {
1645                 "_get_proxy_connection_details": MagicMock(),
1646                 "__proxy__": {
1647                     "esxi.get_details": MagicMock(
1648                         return_value={"esxi_host": "fake_host"}
1649                     )
1650                 },
1651             }
1652         }
1653     def setUp(self):
1654         attrs = (
1655             ("mock_si", MagicMock()),
1656             ("mock_host", MagicMock()),
1657             ("mock_diskgroup", MagicMock()),
1658         )
1659         for attr, mock_obj in attrs:
1660             setattr(self, attr, mock_obj)
1661             self.addCleanup(delattr, self, attr)
1662         patches = (
1663             (
1664                 "salt.utils.vmware.get_service_instance",
1665                 MagicMock(return_value=self.mock_si),
1666             ),
1667             ("salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxi")),
1668             (
1669                 "salt.modules.vsphere._get_proxy_target",
1670                 MagicMock(return_value=self.mock_host),
1671             ),
1672             (
1673                 "salt.utils.vmware.get_diskgroups",
1674                 MagicMock(return_value=[self.mock_diskgroup]),
1675             ),
1676             ("salt.utils.vsan.remove_diskgroup", MagicMock()),
1677         )
1678         for module, mock_obj in patches:
1679             patcher = patch(module, mock_obj)
1680             patcher.start()
1681             self.addCleanup(patcher.stop)
1682     def test_supported_proxes(self):
1683         supported_proxies = ["esxi"]
1684         for proxy_type in supported_proxies:
1685             with patch(
1686                 "salt.modules.vsphere.get_proxy_type",
1687                 MagicMock(return_value=proxy_type),
1688             ):
1689                 vsphere.remove_diskgroup(cache_disk_id="fake_disk_id")
1690     def test__get_proxy_target_call(self):
1691         mock__get_proxy_target = MagicMock(return_value=self.mock_host)
1692         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
1693             vsphere.remove_diskgroup(cache_disk_id="fake_disk_id")
1694         mock__get_proxy_target.assert_called_once_with(self.mock_si)
1695     def test_get_disk_groups(self):
1696         mock_get_diskgroups = MagicMock(return_value=[self.mock_diskgroup])
1697         with patch("salt.utils.vmware.get_diskgroups", mock_get_diskgroups):
1698             vsphere.remove_diskgroup(cache_disk_id="fake_disk_id")
1699         mock_get_diskgroups.assert_called_once_with(
1700             self.mock_host, cache_disk_ids=["fake_disk_id"]
1701         )
1702     def test_disk_group_not_found_safety_checks_set(self):
1703         with patch("salt.utils.vmware.get_diskgroups", MagicMock(return_value=[])):
1704             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
1705                 vsphere.remove_diskgroup(cache_disk_id="fake_disk_id")
1706         self.assertEqual(
1707             "No diskgroup with cache disk id "
1708             "'fake_disk_id' was found in ESXi host "
1709             "'fake_host'",
1710             excinfo.exception.strerror,
1711         )
1712     def test_remove_disk_group(self):
1713         mock_remove_diskgroup = MagicMock(return_value=None)
1714         with patch("salt.utils.vsan.remove_diskgroup", mock_remove_diskgroup):
1715             vsphere.remove_diskgroup(cache_disk_id="fake_disk_id")
1716         mock_remove_diskgroup.assert_called_once_with(
1717             self.mock_si, self.mock_host, self.mock_diskgroup, data_accessibility=True
1718         )
1719     def test_remove_disk_group_data_accessibility_false(self):
1720         mock_remove_diskgroup = MagicMock(return_value=None)
1721         with patch("salt.utils.vsan.remove_diskgroup", mock_remove_diskgroup):
1722             vsphere.remove_diskgroup(
1723                 cache_disk_id="fake_disk_id", data_accessibility=False
1724             )
1725         mock_remove_diskgroup.assert_called_once_with(
1726             self.mock_si, self.mock_host, self.mock_diskgroup, data_accessibility=False
1727         )
1728     def test_success_output(self):
1729         res = vsphere.remove_diskgroup(cache_disk_id="fake_disk_id")
1730         self.assertTrue(res)
1731 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1732 @skipIf(not vsphere.HAS_JSONSCHEMA, "The 'jsonschema' library is missing")
1733 class RemoveCapacityFromDiskgroupTestCase(TestCase, LoaderModuleMockMixin):
1734     """
1735     Tests for salt.modules.vsphere.remove_capacity_from_diskgroup
1736     """
1737     def setup_loader_modules(self):
1738         return {
1739             vsphere: {
1740                 "_get_proxy_connection_details": MagicMock(),
1741                 "__proxy__": {
1742                     "esxi.get_details": MagicMock(
1743                         return_value={"esxi_host": "fake_host"}
1744                     )
1745                 },
1746             }
1747         }
1748     def setUp(self):
1749         attrs = (
1750             ("mock_si", MagicMock()),
1751             ("mock_schema", MagicMock()),
1752             ("mock_host", MagicMock()),
1753             ("mock_disk1", MagicMock(canonicalName="fake_disk1")),
1754             ("mock_disk2", MagicMock(canonicalName="fake_disk2")),
1755             ("mock_disk3", MagicMock(canonicalName="fake_disk3")),
1756             ("mock_diskgroup", MagicMock()),
1757         )
1758         for attr, mock_obj in attrs:
1759             setattr(self, attr, mock_obj)
1760             self.addCleanup(delattr, self, attr)
1761         patches = (
1762             (
1763                 "salt.utils.vmware.get_service_instance",
1764                 MagicMock(return_value=self.mock_si),
1765             ),
1766             (
1767                 "salt.modules.vsphere.DiskGroupsDiskIdSchema.serialize",
1768                 MagicMock(return_value=self.mock_schema),
1769             ),
1770             ("salt.modules.vsphere.jsonschema.validate", MagicMock()),
1771             ("salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxi")),
1772             (
1773                 "salt.modules.vsphere._get_proxy_target",
1774                 MagicMock(return_value=self.mock_host),
1775             ),
1776             (
1777                 "salt.utils.vmware.get_disks",
1778                 MagicMock(
1779                     return_value=[self.mock_disk1, self.mock_disk2, self.mock_disk3]
1780                 ),
1781             ),
1782             (
1783                 "salt.utils.vmware.get_diskgroups",
1784                 MagicMock(return_value=[self.mock_diskgroup]),
1785             ),
1786             ("salt.utils.vsan.remove_capacity_from_diskgroup", MagicMock()),
1787         )
1788         for module, mock_obj in patches:
1789             patcher = patch(module, mock_obj)
1790             patcher.start()
1791             self.addCleanup(patcher.stop)
1792     def test_validate(self):
1793         mock_schema_validate = MagicMock()
1794         with patch("salt.modules.vsphere.jsonschema.validate", mock_schema_validate):
1795             vsphere.remove_capacity_from_diskgroup(
1796                 cache_disk_id="fake_cache_disk_id",
1797                 capacity_disk_ids=["fake_disk1", "fake_disk2"],
1798             )
1799         mock_schema_validate.assert_called_once_with(
1800             {
1801                 "diskgroups": [
1802                     {
1803                         "cache_id": "fake_cache_disk_id",
1804                         "capacity_ids": ["fake_disk1", "fake_disk2"],
1805                     }
1806                 ]
1807             },
1808             self.mock_schema,
1809         )
1810     def test_invalid_schema_validation(self):
1811         mock_schema_validate = MagicMock(
1812             side_effect=vsphere.jsonschema.exceptions.ValidationError("err")
1813         )
1814         with patch("salt.modules.vsphere.jsonschema.validate", mock_schema_validate):
1815             with self.assertRaises(ArgumentValueError) as excinfo:
1816                 vsphere.remove_capacity_from_diskgroup(
1817                     cache_disk_id="fake_cache_disk_id",
1818                     capacity_disk_ids=["fake_disk1", "fake_disk2"],
1819                 )
1820         self.assertEqual("err", excinfo.exception.strerror)
1821     def test_supported_proxes(self):
1822         supported_proxies = ["esxi"]
1823         for proxy_type in supported_proxies:
1824             with patch(
1825                 "salt.modules.vsphere.get_proxy_type",
1826                 MagicMock(return_value=proxy_type),
1827             ):
1828                 vsphere.remove_capacity_from_diskgroup(
1829                     cache_disk_id="fake_cache_disk_id",
1830                     capacity_disk_ids=["fake_disk1", "fake_disk2"],
1831                 )
1832     def test__get_proxy_target_call(self):
1833         mock__get_proxy_target = MagicMock(return_value=self.mock_host)
1834         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
1835             vsphere.remove_capacity_from_diskgroup(
1836                 cache_disk_id="fake_cache_disk_id",
1837                 capacity_disk_ids=["fake_disk1", "fake_disk2"],
1838             )
1839         mock__get_proxy_target.assert_called_once_with(self.mock_si)
1840     def test_get_disks(self):
1841         mock_get_disks = MagicMock(
1842             return_value=[self.mock_disk1, self.mock_disk2, self.mock_disk3]
1843         )
1844         with patch("salt.utils.vmware.get_disks", mock_get_disks):
1845             vsphere.remove_capacity_from_diskgroup(
1846                 cache_disk_id="fake_cache_disk_id",
1847                 capacity_disk_ids=["fake_disk1", "fake_disk2"],
1848             )
1849         mock_get_disks.assert_called_once_with(
1850             self.mock_host, disk_ids=["fake_disk1", "fake_disk2"]
1851         )
1852     def test_disk_not_found_safety_checks_set(self):
1853         mock_get_disks = MagicMock(
1854             return_value=[self.mock_disk1, self.mock_disk2, self.mock_disk3]
1855         )
1856         with patch("salt.utils.vmware.get_disks", mock_get_disks):
1857             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
1858                 vsphere.remove_capacity_from_diskgroup(
1859                     cache_disk_id="fake_cache_disk_id",
1860                     capacity_disk_ids=["fake_disk1", "fake_disk4"],
1861                     safety_checks=True,
1862                 )
1863         self.assertEqual(
1864             "No disk with id 'fake_disk4' was found in ESXi host 'fake_host'",
1865             excinfo.exception.strerror,
1866         )
1867     def test_get_diskgroups(self):
1868         mock_get_diskgroups = MagicMock(return_value=[self.mock_diskgroup])
1869         with patch("salt.utils.vmware.get_diskgroups", mock_get_diskgroups):
1870             vsphere.remove_capacity_from_diskgroup(
1871                 cache_disk_id="fake_cache_disk_id",
1872                 capacity_disk_ids=["fake_disk1", "fake_disk2"],
1873             )
1874         mock_get_diskgroups.assert_called_once_with(
1875             self.mock_host, cache_disk_ids=["fake_cache_disk_id"]
1876         )
1877     def test_diskgroup_not_found(self):
1878         with patch("salt.utils.vmware.get_diskgroups", MagicMock(return_value=[])):
1879             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
1880                 vsphere.remove_capacity_from_diskgroup(
1881                     cache_disk_id="fake_cache_disk_id",
1882                     capacity_disk_ids=["fake_disk1", "fake_disk2"],
1883                 )
1884         self.assertEqual(
1885             "No diskgroup with cache disk id "
1886             "'fake_cache_disk_id' was found in ESXi host "
1887             "'fake_host'",
1888             excinfo.exception.strerror,
1889         )
1890     def test_remove_capacity_from_diskgroup(self):
1891         mock_remove_capacity_from_diskgroup = MagicMock()
1892         with patch(
1893             "salt.utils.vsan.remove_capacity_from_diskgroup",
1894             mock_remove_capacity_from_diskgroup,
1895         ):
1896             vsphere.remove_capacity_from_diskgroup(
1897                 cache_disk_id="fake_cache_disk_id",
1898                 capacity_disk_ids=["fake_disk1", "fake_disk2"],
1899             )
1900         mock_remove_capacity_from_diskgroup.assert_called_once_with(
1901             self.mock_si,
1902             self.mock_host,
1903             self.mock_diskgroup,
1904             capacity_disks=[self.mock_disk1, self.mock_disk2],
1905             data_evacuation=True,
1906         )
1907     def test_remove_capacity_from_diskgroup_data_evacuation_false(self):
1908         mock_remove_capacity_from_diskgroup = MagicMock()
1909         with patch(
1910             "salt.utils.vsan.remove_capacity_from_diskgroup",
1911             mock_remove_capacity_from_diskgroup,
1912         ):
1913             vsphere.remove_capacity_from_diskgroup(
1914                 cache_disk_id="fake_cache_disk_id",
1915                 capacity_disk_ids=["fake_disk1", "fake_disk2"],
1916                 data_evacuation=False,
1917             )
1918         mock_remove_capacity_from_diskgroup.assert_called_once_with(
1919             self.mock_si,
1920             self.mock_host,
1921             self.mock_diskgroup,
1922             capacity_disks=[self.mock_disk1, self.mock_disk2],
1923             data_evacuation=False,
1924         )
1925     def test_success_output(self):
1926         res = vsphere.remove_capacity_from_diskgroup(
1927             cache_disk_id="fake_cache_disk_id",
1928             capacity_disk_ids=["fake_disk1", "fake_disk2"],
1929         )
1930         self.assertTrue(res)
1931 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
1932 class ListClusterTestCase(TestCase, LoaderModuleMockMixin):
1933     """
1934     Tests for salt.modules.vsphere.list_cluster
1935     """
1936     def setup_loader_modules(self):
1937         return {vsphere: {"_get_proxy_connection_details": MagicMock(), "__salt__": {}}}
1938     def setUp(self):
1939         attrs = (
1940             ("mock_si", MagicMock()),
1941             ("mock_dc", MagicMock()),
1942             ("mock_cl", MagicMock()),
1943             ("mock__get_cluster_dict", MagicMock()),
1944         )
1945         for attr, mock_obj in attrs:
1946             setattr(self, attr, mock_obj)
1947             self.addCleanup(delattr, self, attr)
1948         attrs = (("mock_get_cluster", MagicMock(return_value=self.mock_cl)),)
1949         for attr, mock_obj in attrs:
1950             setattr(self, attr, mock_obj)
1951             self.addCleanup(delattr, self, attr)
1952         patches = (
1953             (
1954                 "salt.utils.vmware.get_service_instance",
1955                 MagicMock(return_value=self.mock_si),
1956             ),
1957             (
1958                 "salt.modules.vsphere.get_proxy_type",
1959                 MagicMock(return_value="esxcluster"),
1960             ),
1961             (
1962                 "salt.modules.vsphere._get_proxy_target",
1963                 MagicMock(return_value=self.mock_cl),
1964             ),
1965             ("salt.utils.vmware.get_cluster", self.mock_get_cluster),
1966             ("salt.modules.vsphere._get_cluster_dict", self.mock__get_cluster_dict),
1967         )
1968         for module, mock_obj in patches:
1969             patcher = patch(module, mock_obj)
1970             patcher.start()
1971             self.addCleanup(patcher.stop)
1972         patcher = patch.dict(
1973             vsphere.__salt__,
1974             {"esxcluster.get_details": MagicMock(return_value={"cluster": "cl"})},
1975         )
1976         patcher.start()
1977         self.addCleanup(patcher.stop)
1978     def test_supported_proxies(self):
1979         supported_proxies = ["esxcluster", "esxdatacenter"]
1980         for proxy_type in supported_proxies:
1981             with patch(
1982                 "salt.modules.vsphere.get_proxy_type",
1983                 MagicMock(return_value=proxy_type),
1984             ):
1985                 vsphere.list_cluster(cluster="cl")
1986     def test_default_service_instance(self):
1987         mock__get_proxy_target = MagicMock()
1988         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
1989             vsphere.list_cluster()
1990         mock__get_proxy_target.assert_called_once_with(self.mock_si)
1991     def test_defined_service_instance(self):
1992         mock_si = MagicMock()
1993         mock__get_proxy_target = MagicMock()
1994         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
1995             vsphere.list_cluster(service_instance=mock_si)
1996         mock__get_proxy_target.assert_called_once_with(mock_si)
1997     def test_no_cluster_raises_argument_value_error(self):
1998         with patch(
1999             "salt.modules.vsphere.get_proxy_type",
2000             MagicMock(return_value="esxdatacenter"),
2001         ):
2002             with patch("salt.modules.vsphere._get_proxy_target", MagicMock()):
2003                 with self.assertRaises(ArgumentValueError) as excinfo:
2004                     vsphere.list_cluster()
2005         self.assertEqual(excinfo.exception.strerror, "'cluster' needs to be specified")
2006     def test_get_cluster_call(self):
2007         with patch(
2008             "salt.modules.vsphere.get_proxy_type",
2009             MagicMock(return_value="esxdatacenter"),
2010         ):
2011             with patch(
2012                 "salt.modules.vsphere._get_proxy_target",
2013                 MagicMock(return_value=self.mock_dc),
2014             ):
2015                 vsphere.list_cluster(cluster="cl")
2016         self.mock_get_cluster.assert_called_once_with(self.mock_dc, "cl")
2017     def test__get_cluster_dict_call(self):
2018         vsphere.list_cluster()
2019         self.mock__get_cluster_dict.assert_called_once_with("cl", self.mock_cl)
2020 @skipIf(not HAS_PYVMOMI, "The 'pyvmomi' library is missing")
2021 class RenameDatastoreTestCase(TestCase, LoaderModuleMockMixin):
2022     """
2023     Tests for salt.modules.vsphere.rename_datastore
2024     """
2025     def setup_loader_modules(self):
2026         return {
2027             vsphere: {
2028                 "_get_proxy_connection_details": MagicMock(),
2029                 "get_proxy_type": MagicMock(return_value="esxdatacenter"),
2030             }
2031         }
2032     def setUp(self):
2033         self.mock_si = MagicMock()
2034         self.mock_target = MagicMock()
2035         self.mock_ds_ref = MagicMock()
2036         self.mock_get_datastores = MagicMock(return_value=[self.mock_ds_ref])
2037         self.mock_rename_datastore = MagicMock()
2038         patches = (
2039             (
2040                 "salt.utils.vmware.get_service_instance",
2041                 MagicMock(return_value=self.mock_si),
2042             ),
2043             (
2044                 "salt.modules.vsphere._get_proxy_target",
2045                 MagicMock(return_value=self.mock_target),
2046             ),
2047             ("salt.utils.vmware.get_datastores", self.mock_get_datastores),
2048             ("salt.utils.vmware.rename_datastore", self.mock_rename_datastore),
2049         )
2050         for mod, mock in patches:
2051             patcher = patch(mod, mock)
2052             patcher.start()
2053             self.addCleanup(patcher.stop)
2054     def tearDown(self):
2055         for attr in (
2056             "mock_si",
2057             "mock_target",
2058             "mock_ds_ref",
2059             "mock_get_datastores",
2060             "mock_rename_datastore",
2061         ):
2062             delattr(self, attr)
2063     def test_supported_proxes(self):
2064         supported_proxies = ["esxi", "esxcluster", "esxdatacenter"]
2065         for proxy_type in supported_proxies:
2066             with patch(
2067                 "salt.modules.vsphere.get_proxy_type",
2068                 MagicMock(return_value=proxy_type),
2069             ):
2070                 vsphere.rename_datastore("current_ds_name", "new_ds_name")
2071     def test_default_service_instance(self):
2072         mock__get_proxy_target = MagicMock()
2073         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
2074             vsphere.rename_datastore("current_ds_name", "new_ds_name")
2075         mock__get_proxy_target.assert_called_once_with(self.mock_si)
2076     def test_defined_service_instance(self):
2077         mock_si = MagicMock()
2078         mock__get_proxy_target = MagicMock()
2079         with patch("salt.modules.vsphere._get_proxy_target", mock__get_proxy_target):
2080             vsphere.rename_datastore(
2081                 "current_ds_name", "new_ds_name", service_instance=mock_si
2082             )
2083         mock__get_proxy_target.assert_called_once_with(mock_si)
2084     def test_get_datastore_call(self):
2085         vsphere.rename_datastore("current_ds_name", "new_ds_name")
2086         self.mock_get_datastores.assert_called_once_with(
2087             self.mock_si, self.mock_target, datastore_names=["current_ds_name"]
2088         )
2089     def test_get_no_datastores(self):
2090         with patch("salt.utils.vmware.get_datastores", MagicMock(return_value=[])):
2091             with self.assertRaises(VMwareObjectRetrievalError) as excinfo:
2092                 vsphere.rename_datastore("current_ds_name", "new_ds_name")
2093         self.assertEqual(
2094             excinfo.exception.strerror, "Datastore 'current_ds_name' was not found"
2095         )
2096     def test_rename_datastore_call(self):
2097         vsphere.rename_datastore("current_ds_name", "new_ds_name")
2098         self.mock_rename_datastore.assert_called_once_with(
2099             self.mock_ds_ref, "new_ds_name"
2100         )
2101 class _GetProxyTargetTestCase(TestCase, LoaderModuleMockMixin):
2102     """
2103     Tests for salt.modules.vsphere._get_proxy_target
2104     """
2105     def setup_loader_modules(self):
2106         return {
2107             vsphere: {
2108                 "_get_proxy_connection_details": MagicMock(),
2109                 "get_proxy_type": MagicMock(return_value="esxdatacenter"),
2110             }
2111         }
2112     def setUp(self):
2113         attrs = (
2114             ("mock_si", MagicMock()),
2115             ("mock_dc", MagicMock()),
2116             ("mock_cl", MagicMock()),
2117             ("mock_root", MagicMock()),
2118         )
2119         for attr, mock_obj in attrs:
2120             setattr(self, attr, mock_obj)
2121             self.addCleanup(delattr, self, attr)
2122         attrs = (
2123             ("mock_get_datacenter", MagicMock(return_value=self.mock_dc)),
2124             ("mock_get_cluster", MagicMock(return_value=self.mock_cl)),
2125             ("mock_get_root_folder", MagicMock(return_value=self.mock_root)),
2126         )
2127         for attr, mock_obj in attrs:
2128             setattr(self, attr, mock_obj)
2129             self.addCleanup(delattr, self, attr)
2130         patches = (
2131             (
2132                 "salt.modules.vsphere.get_proxy_type",
2133                 MagicMock(return_value="esxcluster"),
2134             ),
2135             (
2136                 "salt.utils.vmware.is_connection_to_a_vcenter",
2137                 MagicMock(return_value=True),
2138             ),
2139             (
2140                 "salt.modules.vsphere._get_esxcluster_proxy_details",
2141                 MagicMock(
2142                     return_value=(
2143                         None,
2144                         None,
2145                         None,
2146                         None,
2147                         None,
2148                         None,
2149                         None,
2150                         None,
2151                         "datacenter",
2152                         "cluster",
2153                     )
2154                 ),
2155             ),
2156             (
2157                 "salt.modules.vsphere._get_esxdatacenter_proxy_details",
2158                 MagicMock(
2159                     return_value=(
2160                         None,
2161                         None,
2162                         None,
2163                         None,
2164                         None,
2165                         None,
2166                         None,
2167                         None,
2168                         "datacenter",
2169                     )
2170                 ),
2171             ),
2172             ("salt.utils.vmware.get_datacenter", self.mock_get_datacenter),
2173             ("salt.utils.vmware.get_cluster", self.mock_get_cluster),
2174             ("salt.utils.vmware.get_root_folder", self.mock_get_root_folder),
2175         )
2176         for module, mock_obj in patches:
2177             patcher = patch(module, mock_obj)
2178             patcher.start()
2179             self.addCleanup(patcher.stop)
2180     def test_supported_proxies(self):
2181         supported_proxies = ["esxcluster", "esxdatacenter"]
2182         for proxy_type in supported_proxies:
2183             with patch(
2184                 "salt.modules.vsphere.get_proxy_type",
2185                 MagicMock(return_value=proxy_type),
2186             ):
2187                 vsphere._get_proxy_target(self.mock_si)
2188     def test_connected_to_esxi(self):
2189         with patch(
2190             "salt.utils.vmware.is_connection_to_a_vcenter",
2191             MagicMock(return_value=False),
2192         ):
2193             with self.assertRaises(CommandExecutionError) as excinfo:
2194                 vsphere._get_proxy_target(self.mock_si)
2195             self.assertEqual(
2196                 excinfo.exception.strerror,
2197                 "'_get_proxy_target' not supported when connected via the ESXi host",
2198             )
2199     def test_get_cluster_call(self):
2200         vsphere._get_proxy_target(self.mock_si)
2201         self.mock_get_datacenter.assert_called_once_with(self.mock_si, "datacenter")
2202         self.mock_get_cluster.assert_called_once_with(self.mock_dc, "cluster")
2203     def test_esxcluster_proxy_return(self):
2204         with patch(
2205             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="esxcluster")
2206         ):
2207             ret = vsphere._get_proxy_target(self.mock_si)
2208         self.assertEqual(ret, self.mock_cl)
2209     def test_get_datacenter_call(self):
2210         with patch(
2211             "salt.modules.vsphere.get_proxy_type",
2212             MagicMock(return_value="esxdatacenter"),
2213         ):
2214             vsphere._get_proxy_target(self.mock_si)
2215         self.mock_get_datacenter.assert_called_once_with(self.mock_si, "datacenter")
2216         self.assertEqual(self.mock_get_cluster.call_count, 0)
2217     def test_esxdatacenter_proxy_return(self):
2218         with patch(
2219             "salt.modules.vsphere.get_proxy_type",
2220             MagicMock(return_value="esxdatacenter"),
2221         ):
2222             ret = vsphere._get_proxy_target(self.mock_si)
2223         self.assertEqual(ret, self.mock_dc)
2224     def test_vcenter_proxy_return(self):
2225         with patch(
2226             "salt.modules.vsphere.get_proxy_type", MagicMock(return_value="vcenter")
2227         ):
2228             ret = vsphere._get_proxy_target(self.mock_si)
2229         self.mock_get_root_folder.assert_called_once_with(self.mock_si)
2230         self.assertEqual(ret, self.mock_root)
2231 @skipIf(not HAS_VSPHERE_SDK, "The 'vsphere-automation-sdk' library is missing")
2232 class TestVSphereTagging(TestCase, LoaderModuleMockMixin):
2233     """
2234     Tests for:
2235      - salt.modules.vsphere.create_tag_category
2236      - salt.modules.vsphere.create_tag
2237      - salt.modules.vsphere.delete_tag_category
2238      - salt.modules.vsphere.delete_tag
2239      - salt.modules.vsphere.list_tag_categories
2240      - salt.modules.vsphere.list_tags
2241      - salt.modules.vsphere.attach_tags
2242      - salt.modules.vsphere.list_attached_tags
2243     """
2244     def setup_loader_modules(self):
2245         return {
2246             vsphere: {
2247                 "_get_proxy_connection_details": MagicMock(),
2248                 "get_proxy_type": MagicMock(return_value="vcenter"),
2249             }
2250         }
2251     details = {key: None for key in ["vcenter", "username", "password"]}
2252     func_attrs = {
2253         key: None
2254         for key in [
2255             "category_id",
2256             "object_id",
2257             "tag_id",
2258             "name",
2259             "description",
2260             "cardinality",
2261         ]
2262     }
2263     create_tag_category = {
2264         "Category created": (
2265             "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL"
2266         )
2267     }
2268     create_tag = {
2269         "Tag created": (
2270             "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL"
2271         )
2272     }
2273     delete_tag_category = {
2274         "Category deleted": (
2275             "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL"
2276         )
2277     }
2278     delete_tag = {
2279         "Tag deleted": (
2280             "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL"
2281         )
2282     }
2283     list_tag_categories_return = [
2284         "urn:vmomi:InventoryServiceCategory:"
2285         "b13f4959-a3f3-48d0-8080-15bb586b4355:GLOBAL",
2286         "urn:vmomi:InventoryServiceCategory:"
2287         "f4d41f02-c317-422d-9013-dcbebfcd54ad:GLOBAL",
2288         "urn:vmomi:InventoryServiceCategory:"
2289         "2db5b00b-f211-4bba-ba42-e2658ebbb283:GLOBAL",
2290         "urn:vmomi:InventoryServiceCategory:"
2291         "cd847c3c-687c-4bd9-8e5a-0eb536f0a01d:GLOBAL",
2292         "urn:vmomi:InventoryServiceCategory:"
2293         "d51c24f9-cffb-4ce0-af56-7f18b6e649af:GLOBAL",
2294     ]
2295     list_tags_return = [
2296         "urn:vmomi:InventoryServiceTag:a584a83b-3015-45ad-8057-a3630613052f:GLOBAL",
2297         "urn:vmomi:InventoryServiceTag:db08019c-15de-4bbf-be46-d81aaf8d25c0:GLOBAL",
2298         "urn:vmomi:InventoryServiceTag:b55ecc77-f4a5-49f8-ab52-38865467cfbe:GLOBAL",
2299         "urn:vmomi:InventoryServiceTag:f009ab1b-e1b5-4c40-b8f7-951d9d716b39:GLOBAL",
2300         "urn:vmomi:InventoryServiceTag:102bb4c5-9b76-4d6c-882a-76a91ee3edcc:GLOBAL",
2301         "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL",
2302         "urn:vmomi:InventoryServiceTag:71d30f2d-bb23-48e1-995f-630adfb0dc89:GLOBAL",
2303     ]
2304     list_attached_tags_return = [
2305         "urn:vmomi:InventoryServiceTag:b55ecc77-f4a5-49f8-ab52-38865467cfbe:GLOBAL",
2306         "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL",
2307     ]
2308     list_create_category_return = [
2309         "urn:vmomi:InventoryServiceCategory:0af54c2d-e8cd-4248-931e-2f5807d8c477:GLOBAL"
2310     ]
2311     list_create_tag_return = [
2312         "urn:vmomi:InventoryServiceCategory:0af54c2d-e8cd-4248-931e-2f5807d8c477:GLOBAL"
2313     ]
2314     attach_tags_return = {
2315         "Tag attached": (
2316             "urn:vmomi:InventoryServiceTag:bb0350b4-85db-46b0-a726-e7c5989fc857:GLOBAL"
2317         )
2318     }
2319     def test_create_tag_category_client_none(self):
2320         get_details = MagicMock(return_value=self.details)
2321         with patch.object(
2322             vsphere, "get_proxy_type", return_value="vcenter"
2323         ) as get_proxy_type:
2324             with patch.object(
2325                 vsphere, "_get_proxy_connection_details", return_value=[]
2326             ) as get_proxy_connection:
2327                 with patch.object(
2328                     salt.utils.vmware, "get_service_instance", return_value=None
2329                 ) as get_service_instance:
2330                     with patch.dict(
2331                         vsphere.__salt__,
2332                         {"vcenter.get_details": get_details},
2333                         clear=True,
2334                     ) as get_vcenter_details:
2335                         with patch.object(
2336                             salt.utils.vmware, "get_vsphere_client", return_value=None
2337                         ) as get_vsphere_client:
2338                             ret = vsphere.create_tag_category(
2339                                 self.func_attrs["name"],
2340                                 self.func_attrs["description"],
2341                                 self.func_attrs["cardinality"],
2342                             )
2343                             get_proxy_type.assert_called_once()
2344                             get_proxy_connection.assert_called_once()
2345                             get_service_instance.assert_called_once()
2346                             get_vsphere_client.assert_called_once()
2347                             self.assertEqual(ret, {"Category created": None})
2348     def test_create_tag_category_client(self):
2349         for verify_ssl in [True, False, None]:
2350             details = self.details.copy()
2351             if verify_ssl is None:
2352                 verify_ssl = True
2353             else:
2354                 details["verify_ssl"] = verify_ssl
2355             get_details = MagicMock(return_value=details)
2356             mock_client = Mock(
2357                 tagging=Mock(
2358                     Category=Mock(
2359                         CreateSpec=Mock(return_value=Mock()),
2360                         create=Mock(
2361                             return_value=self.create_tag_category["Category created"]
2362                         ),
2363                     )
2364                 )
2365             )
2366             with patch.object(
2367                 vsphere, "get_proxy_type", return_value="vcenter"
2368             ) as get_proxy_type:
2369                 with patch.object(
2370                     vsphere, "_get_proxy_connection_details", return_value=[]
2371                 ) as get_proxy_connection:
2372                     with patch.object(
2373                         salt.utils.vmware, "get_service_instance", return_value=None
2374                     ) as get_service_instance:
2375                         with patch.dict(
2376                             vsphere.__salt__,
2377                             {"vcenter.get_details": get_details},
2378                             clear=True,
2379                         ) as get_vcenter_details:
2380                             with patch.object(
2381                                 salt.utils.vmware,
2382                                 "get_vsphere_client",
2383                                 return_value=mock_client,
2384                             ) as get_vsphere_client:
2385                                 ret = vsphere.create_tag_category(
2386                                     self.func_attrs["name"],
2387                                     self.func_attrs["description"],
2388                                     self.func_attrs["cardinality"],
2389                                 )
2390                                 get_proxy_type.assert_called_once()
2391                                 get_proxy_connection.assert_called_once()
2392                                 get_service_instance.assert_called_once()
2393                                 get_vsphere_client.assert_called_once()
2394                                 self.assertEqual(ret, self.create_tag_category)
2395                                 self.assertEqual(
2396                                     get_vsphere_client.call_args_list,
2397                                     [
2398                                         call(
2399                                             ca_bundle=None,
2400                                             password=None,
2401                                             server=None,
2402                                             username=None,
2403                                             verify_ssl=verify_ssl,
2404                                         )
2405                                     ],
2406                                 )
2407     def test_create_tag_client_none(self):
2408         get_details = MagicMock(return_value=self.details)
2409         with patch.object(
2410             vsphere, "get_proxy_type", return_value="vcenter"
2411         ) as get_proxy_type:
2412             with patch.object(
2413                 vsphere, "_get_proxy_connection_details", return_value=[]
2414             ) as get_proxy_connection:
2415                 with patch.object(
2416                     salt.utils.vmware, "get_service_instance", return_value=None
2417                 ) as get_service_instance:
2418                     with patch.dict(
2419                         vsphere.__salt__,
2420                         {"vcenter.get_details": get_details},
2421                         clear=True,
2422                     ) as get_vcenter_details:
2423                         with patch.object(
2424                             salt.utils.vmware, "get_vsphere_client", return_value=None
2425                         ) as get_vsphere_client:
2426                             ret = vsphere.create_tag(
2427                                 self.func_attrs["name"],
2428                                 self.func_attrs["description"],
2429                                 self.func_attrs["cardinality"],
2430                             )
2431                             get_proxy_type.assert_called_once()
2432                             get_proxy_connection.assert_called_once()
2433                             get_service_instance.assert_called_once()
2434                             get_vsphere_client.assert_called_once()
2435                             self.assertEqual(ret, {"Tag created": None})
2436     def test_create_tag_client(self):
2437         get_details = MagicMock(return_value=self.details)
2438         mock_client = Mock(
2439             tagging=Mock(
2440                 Tag=Mock(
2441                     CreateSpec=Mock(return_value=Mock()),
2442                     create=Mock(return_value=self.create_tag["Tag created"]),
2443                 )
2444             )
2445         )
2446         with patch.object(
2447             vsphere, "get_proxy_type", return_value="vcenter"
2448         ) as get_proxy_type:
2449             with patch.object(
2450                 vsphere, "_get_proxy_connection_details", return_value=[]
2451             ) as get_proxy_connection:
2452                 with patch.object(
2453                     salt.utils.vmware, "get_service_instance", return_value=None
2454                 ) as get_service_instance:
2455                     with patch.dict(
2456                         vsphere.__salt__,
2457                         {"vcenter.get_details": get_details},
2458                         clear=True,
2459                     ) as get_vcenter_details:
2460                         with patch.object(
2461                             salt.utils.vmware,
2462                             "get_vsphere_client",
2463                             return_value=mock_client,
2464                         ) as get_vsphere_client:
2465                             ret = vsphere.create_tag(
2466                                 self.func_attrs["name"],
2467                                 self.func_attrs["description"],
2468                                 self.func_attrs["cardinality"],
2469                             )
2470                             get_proxy_type.assert_called_once()
2471                             get_proxy_connection.assert_called_once()
2472                             get_service_instance.assert_called_once()
2473                             get_vsphere_client.assert_called_once()
2474                             self.assertEqual(ret, self.create_tag)
2475     def test_delete_tag_category_client_none(self):
2476         get_details = MagicMock(return_value=self.details)
2477         with patch.object(
2478             vsphere, "get_proxy_type", return_value="vcenter"
2479         ) as get_proxy_type:
2480             with patch.object(
2481                 vsphere, "_get_proxy_connection_details", return_value=[]
2482             ) as get_proxy_connection:
2483                 with patch.object(
2484                     salt.utils.vmware, "get_service_instance", return_value=None
2485                 ) as get_service_instance:
2486                     with patch.dict(
2487                         vsphere.__salt__,
2488                         {"vcenter.get_details": get_details},
2489                         clear=True,
2490                     ) as get_vcenter_details:
2491                         with patch.object(
2492                             salt.utils.vmware, "get_vsphere_client", return_value=None
2493                         ) as get_vsphere_client:
2494                             ret = vsphere.delete_tag_category(
2495                                 self.func_attrs["category_id"]
2496                             )
2497                             get_proxy_type.assert_called_once()
2498                             get_proxy_connection.assert_called_once()
2499                             get_service_instance.assert_called_once()
2500                             get_vsphere_client.assert_called_once()
2501                             self.assertEqual(ret, {"Category deleted": None})
2502     def test_delete_tag_category_client(self):
2503         for verify_ssl in [True, False, None]:
2504             details = self.details.copy()
2505             if verify_ssl is None:
2506                 verify_ssl = True
2507             else:
2508                 details["verify_ssl"] = verify_ssl
2509             get_details = MagicMock(return_value=details)
2510             mock_client = Mock(
2511                 tagging=Mock(
2512                     Category=Mock(
2513                         delete=Mock(
2514                             return_value=self.delete_tag_category["Category deleted"]
2515                         )
2516                     )
2517                 )
2518             )
2519             with patch.object(
2520                 vsphere, "get_proxy_type", return_value="vcenter"
2521             ) as get_proxy_type:
2522                 with patch.object(
2523                     vsphere, "_get_proxy_connection_details", return_value=[]
2524                 ) as get_proxy_connection:
2525                     with patch.object(
2526                         salt.utils.vmware, "get_service_instance", return_value=None
2527                     ) as get_service_instance:
2528                         with patch.dict(
2529                             vsphere.__salt__,
2530                             {"vcenter.get_details": get_details},
2531                             clear=True,
2532                         ) as get_vcenter_details:
2533                             with patch.object(
2534                                 salt.utils.vmware,
2535                                 "get_vsphere_client",
2536                                 return_value=mock_client,
2537                             ) as get_vsphere_client:
2538                                 ret = vsphere.delete_tag_category(
2539                                     self.func_attrs["category_id"]
2540                                 )
2541                                 get_proxy_type.assert_called_once()
2542                                 get_proxy_connection.assert_called_once()
2543                                 get_service_instance.assert_called_once()
2544                                 get_vsphere_client.assert_called_once()
2545                                 self.assertEqual(ret, self.delete_tag_category)
2546                                 self.assertEqual(
2547                                     get_vsphere_client.call_args_list,
2548                                     [
2549                                         call(
2550                                             ca_bundle=None,
2551                                             password=None,
2552                                             server=None,
2553                                             username=None,
2554                                             verify_ssl=verify_ssl,
2555                                         )
2556                                     ],
2557                                 )
2558     def test_delete_tag_client_none(self):
2559         get_details = MagicMock(return_value=self.details)
2560         with patch.object(
2561             vsphere, "get_proxy_type", return_value="vcenter"
2562         ) as get_proxy_type:
2563             with patch.object(
2564                 vsphere, "_get_proxy_connection_details", return_value=[]
2565             ) as get_proxy_connection:
2566                 with patch.object(
2567                     salt.utils.vmware, "get_service_instance", return_value=None
2568                 ) as get_service_instance:
2569                     with patch.dict(
2570                         vsphere.__salt__,
2571                         {"vcenter.get_details": get_details},
2572                         clear=True,
2573                     ) as get_vcenter_details:
2574                         with patch.object(
2575                             salt.utils.vmware, "get_vsphere_client", return_value=None
2576                         ) as get_vsphere_client:
2577                             ret = vsphere.delete_tag(self.func_attrs["tag_id"])
2578                             get_proxy_type.assert_called_once()
2579                             get_proxy_connection.assert_called_once()
2580                             get_service_instance.assert_called_once()
2581                             get_vsphere_client.assert_called_once()
2582                             self.assertEqual(ret, {"Tag deleted": None})
2583     def test_delete_tag_client(self):
2584         get_details = MagicMock(return_value=self.details)
2585         mock_client = Mock(
2586             tagging=Mock(
2587                 Tag=Mock(delete=Mock(return_value=self.delete_tag["Tag deleted"]))
2588             )
2589         )
2590         with patch.object(
2591             vsphere, "get_proxy_type", return_value="vcenter"
2592         ) as get_proxy_type:
2593             with patch.object(
2594                 vsphere, "_get_proxy_connection_details", return_value=[]
2595             ) as get_proxy_connection:
2596                 with patch.object(
2597                     salt.utils.vmware, "get_service_instance", return_value=None
2598                 ) as get_service_instance:
2599                     with patch.dict(
2600                         vsphere.__salt__,
2601                         {"vcenter.get_details": get_details},
2602                         clear=True,
2603                     ) as get_vcenter_details:
2604                         with patch.object(
2605                             salt.utils.vmware,
2606                             "get_vsphere_client",
2607                             return_value=mock_client,
2608                         ) as get_vsphere_client:
2609                             ret = vsphere.delete_tag(self.func_attrs["tag_id"])
2610                             get_proxy_type.assert_called_once()
2611                             get_proxy_connection.assert_called_once()
2612                             get_service_instance.assert_called_once()
2613                             get_vsphere_client.assert_called_once()
2614                             self.assertEqual(ret, self.delete_tag)
2615     def test_list_tag_categories_client_none(self):
2616         get_details = MagicMock(return_value=self.details)
2617         with patch.object(
2618             vsphere, "get_proxy_type", return_value="vcenter"
2619         ) as get_proxy_type:
2620             with patch.object(
2621                 vsphere, "_get_proxy_connection_details", return_value=[]
2622             ) as get_proxy_connection:
2623                 with patch.object(
2624                     salt.utils.vmware, "get_service_instance", return_value=None
2625                 ) as get_service_instance:
2626                     with patch.dict(
2627                         vsphere.__salt__,
2628                         {"vcenter.get_details": get_details},
2629                         clear=True,
2630                     ) as get_vcenter_details:
2631                         with patch.object(
2632                             salt.utils.vmware, "get_vsphere_client", return_value=None
2633                         ) as get_vsphere_client:
2634                             ret = vsphere.list_tag_categories()
2635                             get_proxy_type.assert_called_once()
2636                             get_proxy_connection.assert_called_once()
2637                             get_service_instance.assert_called_once()
2638                             get_vsphere_client.assert_called_once()
2639                             self.assertEqual(ret, {"Categories": None})
2640     def test_list_tag_categories_client(self):
2641         for verify_ssl in [True, False, None]:
2642             details = self.details.copy()
2643             if verify_ssl is not None:
2644                 details["verify_ssl"] = verify_ssl
2645             else:
2646                 verify_ssl = True
2647             get_details = MagicMock(return_value=details)
2648             mock_client = Mock(
2649                 tagging=Mock(
2650                     Category=Mock(
2651                         list=Mock(return_value=self.list_tag_categories_return)
2652                     )
2653                 )
2654             )
2655             with patch.object(
2656                 vsphere, "get_proxy_type", return_value="vcenter"
2657             ) as get_proxy_type:
2658                 with patch.object(
2659                     vsphere, "_get_proxy_connection_details", return_value=[]
2660                 ) as get_proxy_connection:
2661                     with patch.object(
2662                         salt.utils.vmware, "get_service_instance", return_value=None
2663                     ) as get_service_instance:
2664                         with patch.dict(
2665                             vsphere.__salt__,
2666                             {"vcenter.get_details": get_details},
2667                             clear=True,
2668                         ) as get_vcenter_details:
2669                             with patch.object(
2670                                 salt.utils.vmware,
2671                                 "get_vsphere_client",
2672                                 return_value=mock_client,
2673                             ) as get_vsphere_client:
2674                                 ret = vsphere.list_tag_categories()
2675                                 get_proxy_type.assert_called_once()
2676                                 get_proxy_connection.assert_called_once()
2677                                 get_service_instance.assert_called_once()
2678                                 get_vsphere_client.assert_called_once()
2679                                 self.assertEqual(
2680                                     get_vsphere_client.call_args_list,
2681                                     [
2682                                         call(
2683                                             ca_bundle=None,
2684                                             password=None,
2685                                             server=None,
2686                                             username=None,
2687                                             verify_ssl=verify_ssl,
2688                                         )
2689                                     ],
2690                                 )
2691                                 self.assertEqual(
2692                                     ret, {"Categories": self.list_tag_categories_return}
2693                                 )
2694     def test_list_tags_client_none(self):
2695         get_details = MagicMock(return_value=self.details)
2696         with patch.object(
2697             vsphere, "get_proxy_type", return_value="vcenter"
2698         ) as get_proxy_type:
2699             with patch.object(
2700                 vsphere, "_get_proxy_connection_details", return_value=[]
2701             ) as get_proxy_connection:
2702                 with patch.object(
2703                     salt.utils.vmware, "get_service_instance", return_value=None
2704                 ) as get_service_instance:
2705                     with patch.dict(
2706                         vsphere.__salt__,
2707                         {"vcenter.get_details": get_details},
2708                         clear=True,
2709                     ) as get_vcenter_details:
2710                         with patch.object(
2711                             salt.utils.vmware, "get_vsphere_client", return_value=None
2712                         ) as get_vsphere_client:
2713                             ret = vsphere.list_tags()
2714                             get_proxy_type.assert_called_once()
2715                             get_proxy_connection.assert_called_once()
2716                             get_service_instance.assert_called_once()
2717                             get_vsphere_client.assert_called_once()
2718                             self.assertEqual(ret, {"Tags": None})
2719     def test_list_tags_client(self):
2720         get_details = MagicMock(return_value=self.details)
2721         mock_client = Mock(
2722             tagging=Mock(Tag=Mock(list=Mock(return_value=self.list_tags_return)))
2723         )
2724         with patch.object(
2725             vsphere, "get_proxy_type", return_value="vcenter"
2726         ) as get_proxy_type:
2727             with patch.object(
2728                 vsphere, "_get_proxy_connection_details", return_value=[]
2729             ) as get_proxy_connection:
2730                 with patch.object(
2731                     salt.utils.vmware, "get_service_instance", return_value=None
2732                 ) as get_service_instance:
2733                     with patch.dict(
2734                         vsphere.__salt__,
2735                         {"vcenter.get_details": get_details},
2736                         clear=True,
2737                     ) as get_vcenter_details:
2738                         with patch.object(
2739                             salt.utils.vmware,
2740                             "get_vsphere_client",
2741                             return_value=mock_client,
2742                         ) as get_vsphere_client:
2743                             ret = vsphere.list_tags()
2744                             get_proxy_type.assert_called_once()
2745                             get_proxy_connection.assert_called_once()
2746                             get_service_instance.assert_called_once()
2747                             get_vsphere_client.assert_called_once()
2748                             self.assertEqual(ret, {"Tags": self.list_tags_return})
2749     def test_list_tags_client_verify_ssl(self):
2750         for verify_ssl in [True, False]:
2751             details = self.details.copy()
2752             if verify_ssl is not None:
2753                 details["verify_ssl"] = verify_ssl
2754             else:
2755                 verify_ssl = True
2756             get_details = MagicMock(return_value=details)
2757             mock_client = Mock(
2758                 tagging=Mock(Tag=Mock(list=Mock(return_value=self.list_tags_return)))
2759             )
2760             with patch.object(
2761                 vsphere, "get_proxy_type", return_value="vcenter"
2762             ) as get_proxy_type:
2763                 with patch.object(
2764                     vsphere, "_get_proxy_connection_details", return_value=[]
2765                 ) as get_proxy_connection:
2766                     with patch.object(
2767                         salt.utils.vmware, "get_service_instance", return_value=None
2768                     ) as get_service_instance:
2769                         with patch.dict(
2770                             vsphere.__salt__,
2771                             {"vcenter.get_details": get_details},
2772                             clear=True,
2773                         ) as get_vcenter_details:
2774                             with patch.object(
2775                                 salt.utils.vmware,
2776                                 "get_vsphere_client",
2777                                 return_value=mock_client,
2778                             ) as get_vsphere_client:
2779                                 ret = vsphere.list_tags()
2780                                 self.assertEqual(ret, {"Tags": self.list_tags_return})
2781                                 self.assertEqual(
2782                                     get_vsphere_client.call_args_list,
2783                                     [
2784                                         call(
2785                                             ca_bundle=None,
2786                                             password=None,
2787                                             server=None,
2788                                             username=None,
2789                                             verify_ssl=verify_ssl,
2790                                         )
2791                                     ],
2792                                 )
2793     def test_list_attached_tags_client_none(self):
2794         get_details = MagicMock(return_value=self.details)
2795         with patch.object(
2796             vsphere, "get_proxy_type", return_value="vcenter"
2797         ) as get_proxy_type:
2798             with patch.object(
2799                 vsphere, "_get_proxy_connection_details", return_value=[]
2800             ) as get_proxy_connection:
2801                 with patch.object(
2802                     salt.utils.vmware, "get_service_instance", return_value=None
2803                 ) as get_service_instance:
2804                     with patch.dict(
2805                         vsphere.__salt__,
2806                         {"vcenter.get_details": get_details},
2807                         clear=True,
2808                     ) as get_vcenter_details:
2809                         with patch.object(
2810                             salt.utils.vmware, "get_vsphere_client", return_value=None
2811                         ) as get_vsphere_client:
2812                             with patch.object(vsphere, "DynamicID") as dynamic_id:
2813                                 ret = vsphere.list_attached_tags("object_id")
2814                                 get_proxy_type.assert_called_once()
2815                                 get_proxy_connection.assert_called_once()
2816                                 get_service_instance.assert_called_once()
2817                                 get_vsphere_client.assert_called_once()
2818                                 self.assertEqual(ret, {"Attached tags": None})
2819     def test_list_attached_tags_client(self):
2820         for verify_ssl in [True, False, None]:
2821             details = self.details.copy()
2822             if verify_ssl is None:
2823                 verify_ssl = True
2824             else:
2825                 details["verify_ssl"] = verify_ssl
2826             get_details = MagicMock(return_value=details)
2827             mock_client = Mock(
2828                 tagging=Mock(
2829                     TagAssociation=Mock(
2830                         list_attached_tags=Mock(
2831                             return_value=self.list_attached_tags_return
2832                         )
2833                     )
2834                 )
2835             )
2836             with patch.object(
2837                 vsphere, "get_proxy_type", return_value="vcenter"
2838             ) as get_proxy_type:
2839                 with patch.object(
2840                     vsphere, "_get_proxy_connection_details", return_value=[]
2841                 ) as get_proxy_connection:
2842                     with patch.object(
2843                         salt.utils.vmware, "get_service_instance", return_value=None
2844                     ) as get_service_instance:
2845                         with patch.dict(
2846                             vsphere.__salt__,
2847                             {"vcenter.get_details": get_details},
2848                             clear=True,
2849                         ) as get_vcenter_details:
2850                             with patch.object(
2851                                 salt.utils.vmware,
2852                                 "get_vsphere_client",
2853                                 return_value=mock_client,
2854                             ) as get_vsphere_client:
2855                                 with patch.object(vsphere, "DynamicID") as dynamic_id:
2856                                     ret = vsphere.list_attached_tags(
2857                                         self.func_attrs["object_id"]
2858                                     )
2859                                     get_proxy_type.assert_called_once()
2860                                     get_proxy_connection.assert_called_once()
2861                                     get_service_instance.assert_called_once()
2862                                     get_vsphere_client.assert_called_once()
2863                                     self.assertEqual(
2864                                         ret,
2865                                         {
2866                                             "Attached tags": self.list_attached_tags_return
2867                                         },
2868                                     )
2869                                     self.assertEqual(
2870                                         get_vsphere_client.call_args_list,
2871                                         [
2872                                             call(
2873                                                 ca_bundle=None,
2874                                                 password=None,
2875                                                 server=None,
2876                                                 username=None,
2877                                                 verify_ssl=verify_ssl,
2878                                             )
2879                                         ],
2880                                     )
2881     def test_attach_tags_client_none(self):
2882         get_details = MagicMock(return_value=self.details)
2883         with patch.object(
2884             vsphere, "get_proxy_type", return_value="vcenter"
2885         ) as get_proxy_type:
2886             with patch.object(
2887                 vsphere, "_get_proxy_connection_details", return_value=[]
2888             ) as get_proxy_connection:
2889                 with patch.object(
2890                     salt.utils.vmware, "get_service_instance", return_value=None
2891                 ) as get_service_instance:
2892                     with patch.dict(
2893                         vsphere.__salt__,
2894                         {"vcenter.get_details": get_details},
2895                         clear=True,
2896                     ) as get_vcenter_details:
2897                         with patch.object(
2898                             salt.utils.vmware, "get_vsphere_client", return_value=None
2899                         ) as get_vsphere_client:
2900                             ret = vsphere.attach_tag(
2901                                 object_id=self.func_attrs["object_id"],
2902                                 tag_id=self.func_attrs["tag_id"],
2903                             )
2904                             get_proxy_type.assert_called_once()
2905                             get_proxy_connection.assert_called_once()
2906                             get_service_instance.assert_called_once()
2907                             get_vsphere_client.assert_called_once()
2908                             self.assertEqual(ret, {"Tag attached": None})
2909     def test_attach_tags_client(self):
2910         for verify_ssl in [True, False, None]:
2911             details = self.details.copy()
2912             if verify_ssl is None:
2913                 verify_ssl = True
2914             else:
2915                 details["verify_ssl"] = verify_ssl
2916             get_details = MagicMock(return_value=details)
2917             mock_client = Mock(
2918                 tagging=Mock(
2919                     TagAssociation=Mock(
2920                         attach=Mock(return_value=self.list_attached_tags_return)
2921                     )
2922                 )
2923             )
2924             with patch.object(
2925                 vsphere, "get_proxy_type", return_value="vcenter"
2926             ) as get_proxy_type:
2927                 with patch.object(
2928                     vsphere, "_get_proxy_connection_details", return_value=[]
2929                 ) as get_proxy_connection:
2930                     with patch.object(
2931                         salt.utils.vmware, "get_service_instance", return_value=None
2932                     ) as get_service_instance:
2933                         with patch.dict(
2934                             vsphere.__salt__,
2935                             {"vcenter.get_details": get_details},
2936                             clear=True,
2937                         ) as get_vcenter_details:
2938                             with patch.object(
2939                                 salt.utils.vmware,
2940                                 "get_vsphere_client",
2941                                 return_value=mock_client,
2942                             ) as get_vsphere_client:
2943                                 with patch.object(vsphere, "DynamicID") as dynamic_id:
2944                                     ret = vsphere.attach_tag(
2945                                         object_id=self.func_attrs["object_id"],
2946                                         tag_id=self.func_attrs["tag_id"],
2947                                     )
2948                                     get_proxy_type.assert_called_once()
2949                                     get_proxy_connection.assert_called_once()
2950                                     get_service_instance.assert_called_once()
2951                                     get_vsphere_client.assert_called_once()
2952                                     self.assertEqual(
2953                                         get_vsphere_client.call_args_list,
2954                                         [
2955                                             call(
2956                                                 ca_bundle=None,
2957                                                 password=None,
2958                                                 server=None,
2959                                                 username=None,
2960                                                 verify_ssl=verify_ssl,
2961                                             )
2962                                         ],
2963                                     )
2964                                     self.assertEqual(
2965                                         ret,
2966                                         {
2967                                             "Tag attached": self.list_attached_tags_return
2968                                         },
2969                                     )
2970     def test_get_client(self):
2971         """
2972         test get_client when verify_ssl and ca_bundle are not passed
2973         """
2974         mock_client = MagicMock(return_value=None)
2975         patch_client = patch("salt.utils.vmware.get_vsphere_client", mock_client)
2976         cert_path = "/test/ca-certificates.crt"
2977         mock_ca = MagicMock(return_value=cert_path)
2978         patch_ca = patch("salt.utils.http.get_ca_bundle", mock_ca)
2979         mock_details = MagicMock(return_value=self.details)
2980         patch_details = patch.dict(
2981             vsphere.__salt__, {"vcenter.get_details": mock_details}
2982         )
2983         with patch_client, patch_ca, patch_details:
2984             vsphere._get_client(
2985                 server="localhost", username="testuser", password="testpassword"
2986             )
2987             self.assertEqual(
2988                 mock_client.call_args_list,
2989                 [
2990                     call(
2991                         ca_bundle=None,
2992                         password="testpassword",
2993                         server="localhost",
2994                         username="testuser",
2995                         verify_ssl=True,
2996                     )
2997                 ],
2998             )
2999             self.assertEqual(mock_details.assert_called_once(), None)
3000             self.assertEqual(mock_ca.assert_not_called(), None)
3001     def test_get_client_verify_ssl_false(self):
3002         """
3003         test get_client when verify_ssl=False is set
3004         """
3005         details = self.details.copy()
3006         details["verify_ssl"] = False
3007         mock_client = MagicMock(return_value=None)
3008         patch_client = patch("salt.utils.vmware.get_vsphere_client", mock_client)
3009         cert_path = "/test/ca-certificates.crt"
3010         mock_ca = MagicMock(return_value=cert_path)
3011         patch_ca = patch("salt.utils.http.get_ca_bundle", mock_ca)
3012         mock_details = MagicMock(return_value=details)
3013         patch_details = patch.dict(
3014             vsphere.__salt__, {"vcenter.get_details": mock_details}
3015         )
3016         with patch_client, patch_ca, patch_details:
3017             vsphere._get_client(
3018                 server="localhost", username="testuser", password="testpassword"
3019             )
3020             self.assertEqual(
3021                 mock_client.call_args_list,
3022                 [
3023                     call(
3024                         ca_bundle=None,
3025                         password="testpassword",
3026                         server="localhost",
3027                         username="testuser",
3028                         verify_ssl=False,
3029                     )
3030                 ],
3031             )
3032             self.assertEqual(mock_details.assert_called_once(), None)
3033             self.assertEqual(mock_ca.assert_not_called(), None)
3034     def test_get_client_verify_ssl_false_ca_bundle(self):
3035         """
3036         test get_client when verify_ssl=False and ca_bundle set
3037         """
3038         details = self.details.copy()
3039         details["verify_ssl"] = False
3040         details["ca_bundle"] = "/tmp/test"
3041         mock_client = MagicMock(return_value=None)
3042         patch_client = patch("salt.utils.vmware.get_vsphere_client", mock_client)
3043         cert_path = "/test/ca-certificates.crt"
3044         mock_ca = MagicMock(return_value=cert_path)
3045         patch_ca = patch("salt.utils.http.get_ca_bundle", mock_ca)
3046         mock_details = MagicMock(return_value=details)
3047         patch_details = patch.dict(
3048             vsphere.__salt__, {"vcenter.get_details": mock_details}
3049         )
3050         with patch_client, patch_ca, patch_details:
3051             self.assertFalse(
3052                 vsphere._get_client(
3053                     server="localhost", username="testuser", password="testpassword"
3054                 )
3055             )
3056             self.assertEqual(mock_details.assert_called_once(), None)
3057             self.assertEqual(mock_ca.assert_not_called(), None)
3058     def test_get_client_ca_bundle(self):
3059         """
3060         test get_client when verify_ssl=False and ca_bundle set
3061         """
3062         cert_path = "/test/ca-certificates.crt"
3063         details = self.details.copy()
3064         details["ca_bundle"] = cert_path
3065         mock_client = MagicMock(return_value=None)
3066         patch_client = patch("salt.utils.vmware.get_vsphere_client", mock_client)
3067         mock_ca = MagicMock(return_value=cert_path)
3068         patch_ca = patch("salt.utils.http.get_ca_bundle", mock_ca)
3069         mock_details = MagicMock(return_value=details)
3070         patch_details = patch.dict(
3071             vsphere.__salt__, {"vcenter.get_details": mock_details}
3072         )
3073         with patch_client, patch_ca, patch_details:
3074             vsphere._get_client(
3075                 server="localhost", username="testuser", password="testpassword"
3076             )
3077             self.assertEqual(
3078                 mock_client.call_args_list,
3079                 [
3080                     call(
3081                         ca_bundle=cert_path,
3082                         password="testpassword",
3083                         server="localhost",
3084                         username="testuser",
3085                         verify_ssl=True,
3086                     )
3087                 ],
3088             )
3089             self.assertEqual(mock_details.assert_called_once(), None)
3090             self.assertEqual(mock_ca.assert_called_once(), None)
3091             self.assertEqual(mock_ca.call_args_list, [call({"ca_bundle": cert_path})])
3092 class TestCertificateVerify(TestCase, LoaderModuleMockMixin):
3093     def setup_loader_modules(self):
3094         return {vsphere: {}}
3095     def test_upload_ssh_key(self):
3096         kwargs_values = [
3097             ("ssh_key", "TheSSHKeyFile"),
3098             ("ssh_key_file", "TheSSHKeyFile"),
3099         ]
3100         certificate_verify_values = (None, True, False)
3101         for kw_key, kw_value in kwargs_values:
3102             kwargs = {kw_key: kw_value}
3103             if kw_key == "ssh_key":
3104                 expected_kwargs = {"data": kw_value}
3105             else:
3106                 expected_kwargs = {"data_file": kw_value, "data_render": False}
3107             for certificate_verify_value in certificate_verify_values:
3108                 http_query_mock = MagicMock()
3109                 if certificate_verify_value is None:
3110                     certificate_verify_value = True
3111                 with patch("salt.utils.http.query", http_query_mock):
3112                     vsphere.upload_ssh_key(
3113                         HOST,
3114                         USER,
3115                         PASSWORD,
3116                         certificate_verify=certificate_verify_value,
3117                         **kwargs
3118                     )
3119                 http_query_mock.assert_called_once_with(
3120                     "https://1.2.3.4:443/host/ssh_root_authorized_keys",
3121                     method="PUT",
3122                     password="SuperSecret!",
3123                     status=True,
3124                     text=True,
3125                     username="root",
3126                     verify_ssl=certificate_verify_value,
3127                     **expected_kwargs
3128                 )
3129     def test_get_ssh_key(self):
3130         certificate_verify_values = (None, True, False)
3131         for certificate_verify_value in certificate_verify_values:
3132             http_query_mock = MagicMock()
3133             if certificate_verify_value is None:
3134                 certificate_verify_value = True
3135             with patch("salt.utils.http.query", http_query_mock):
3136                 vsphere.get_ssh_key(
3137                     HOST, USER, PASSWORD, certificate_verify=certificate_verify_value
3138                 )
3139             http_query_mock.assert_called_once_with(
3140                 "https://1.2.3.4:443/host/ssh_root_authorized_keys",
3141                 method="GET",
3142                 password="SuperSecret!",
3143                 status=True,
3144                 text=True,
3145                 username="root",
3146                 verify_ssl=certificate_verify_value,
3147             )
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
