<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for mongo_return.py &amp; test_cron_1.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for mongo_return.py &amp; test_cron_1.py
      </h3>
<h1 align="center">
        2.1%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>mongo_return.py (7.6555023%)<th>test_cron_1.py (1.254902%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(128-133)<td><a href="#" name="0">(774-781)</a><td align="center"><font color="#ff0000">16</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>mongo_return.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import salt.returners
3 import salt.utils.jid
4 from salt.utils.versions import LooseVersion as _LooseVersion
5 try:
6     import pymongo
7     PYMONGO_VERSION = _LooseVersion(pymongo.version)
8     HAS_PYMONGO = True
9 except ImportError:
10     HAS_PYMONGO = False
11 log = logging.getLogger(__name__)
12 __virtualname__ = "mongo"
13 def __virtual__():
14     if not HAS_PYMONGO:
15         return False, "Could not import mongo returner; pymongo is not installed."
16     return "mongo_return"
17 def _remove_dots(src):
18     output = {}
19     for key, val in src.items():
20         if isinstance(val, dict):
21             val = _remove_dots(val)
22         output[key.replace(".", "-")] = val
23     return output
24 def _get_options(ret):
25     attrs = {
26         "host": "host",
27         "port": "port",
28         "db": "db",
29         "user": "user",
30         "password": "password",
31         "indexes": "indexes",
32     }
33     _options = salt.returners.get_returner_options(
34         __virtualname__, ret, attrs, __salt__=__salt__, __opts__=__opts__
35     )
36     return _options
37 def _get_conn(ret):
38     """
39     host <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= _options.get("host")
40     port = _options.get("port")
41     db_ = _options.get("db")
42     user = _options.get("user")
43     password = _options.get("password")
44     indexes =</b></font> _options.get("indexes", False)
45     if PYMONGO_VERSION &gt; _LooseVersion("2.3"):
46         conn = pymongo.MongoClient(host, port)
47     else:
48         conn = pymongo.Connection(host, port)
49     mdb = conn[db_]
50     if user and password:
51         mdb.authenticate(user, password)
52     if indexes:
53         if PYMONGO_VERSION &gt; _LooseVersion("2.3"):
54             mdb.saltReturns.create_index("minion")
55             mdb.saltReturns.create_index("jid")
56             mdb.jobs.create_index("jid")
57         else:
58             mdb.saltReturns.ensure_index("minion")
59             mdb.saltReturns.ensure_index("jid")
60             mdb.jobs.ensure_index("jid")
61     return conn, mdb
62 def returner(ret):
63     """
64     Return data to a mongodb server
65     """
66     conn, mdb = _get_conn(ret)
67     col = mdb[ret["id"]]
68     if isinstance(ret["return"], dict):
69         back = _remove_dots(ret["return"])
70     else:
71         back = ret["return"]
72     if isinstance(ret, dict):
73         full_ret = _remove_dots(ret)
74     else:
75         full_ret = ret
76     log.debug(back)
77     sdata = {
78         "minion": ret["id"],
79         "jid": ret["jid"],
80         "return": back,
81         "fun": ret["fun"],
82         "full_ret": full_ret,
83     }
84     if "out" in ret:
85         sdata["out"] = ret["out"]
86     if PYMONGO_VERSION &gt; _LooseVersion("2.3"):
87         mdb.saltReturns.insert_one(sdata.copy())
88     else:
89         mdb.saltReturns.insert(sdata.copy())
90 def get_jid(jid):
91     """
92     Return the return information associated with a jid
93     """
94     conn, mdb = _get_conn(ret=None)
95     ret = {}
96     rdata = mdb.saltReturns.find({"jid": jid}, {"_id": 0})
97     if rdata:
98         for data in rdata:
99             minion = data["minion"]
100             ret[minion] = data["full_ret"]
101     return ret
102 def get_fun(fun):
103     """
104     Return the most recent jobs that have executed the named function
105     """
106     conn, mdb = _get_conn(ret=None)
107     ret = {}
108     rdata = mdb.saltReturns.find_one({"fun": fun}, {"_id": 0})
109     if rdata:
110         ret = rdata
111     return ret
112 def prep_jid(nocache=False, passed_jid=None):  # pylint: disable=unused-argument
113     """
114     Do any work necessary to prepare a JID, including sending a custom id
115     """
116     return passed_jid if passed_jid is not None else salt.utils.jid.gen_jid(__opts__)
117 def save_minions(jid, minions, syndic_id=None):  # pylint: disable=unused-argument
118     """
119     Included for API consistency
120     """
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_cron_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 """
2     :codeauthor: Mike Place &lt;mp@saltstack.com&gt;
3 """
4 import builtins
5 import io
6 import salt.modules.cron as cron
7 from tests.support.mixins import LoaderModuleMockMixin
8 from tests.support.mock import MagicMock, call, mock_open, patch
9 from tests.support.unit import TestCase
10 STUB_USER = "root"
11 STUB_PATH = "/tmp"
12 STUB_CRON_TIMESTAMP = {
13     "minute": "1",
14     "hour": "2",
15     "daymonth": "3",
16     "month": "4",
17     "dayweek": "5",
18 }
19 STUB_SIMPLE_RAW_CRON = "5 0 * * * /tmp/no_script.sh"
20 STUB_SIMPLE_CRON_DICT = {
21     "pre": ["5 0 * * * /tmp/no_script.sh"],
22     "crons": [],
23     "env": [],
24     "special": [],
25 }
26 STUB_CRON_SPACES = """
27 TEST_VAR="a string with plenty of spaces"
28 11 * * * * echo "must  be  double  spaced"
29 """
30 STUB_AT_SIGN = """
31 @daily echo "cron with @ sign"
32 @daily
33 """
34 L = "# Lines below here are managed by Salt, do not edit\n"
35 CRONTAB = io.StringIO()
36 def get_crontab(*args, **kw):
37     return CRONTAB.getvalue()
38 def set_crontab(val):
39     CRONTAB.seek(0)
40     CRONTAB.truncate(0)
41     CRONTAB.write(val)
42 def write_crontab(*args, **kw):
43     set_crontab("\n".join([a.strip() for a in args[1]]))
44     return MagicMock()
45 class CronTestCase(TestCase, LoaderModuleMockMixin):
46     def setup_loader_modules(self):
47         return {cron: {}}
48     def test__need_changes_new(self):
49         """
50         New behavior, identifier will get track of the managed lines!
51         """
52         with patch(
53             "salt.modules.cron.raw_cron", new=MagicMock(side_effect=get_crontab)
54         ), patch(
55             "salt.modules.cron._write_cron_lines",
56             new=MagicMock(side_effect=write_crontab),
57         ):
58             set_crontab(L + "# SALT_CRON_IDENTIFIER:booh\n* * * * * ls\n")
59             cron.set_job(
60                 user="root",
61                 minute="*",
62                 hour="*",
63                 daymonth="*",
64                 month="*",
65                 dayweek="*",
66                 cmd="ls",
67                 comment=None,
68                 identifier=None,
69             )
70             c1 = get_crontab()
71             set_crontab(L + "* * * * * ls\n")
72             self.assertEqual(
73                 c1,
74                 "# Lines below here are managed by Salt, do not edit\n"
75                 "# SALT_CRON_IDENTIFIER:booh\n"
76                 "* * * * * ls\n"
77                 "* * * * * ls",
78             )
79             set_crontab(L + "# SALT_CRON_IDENTIFIER:bar\n* * * * * ls\n")
80             cron.set_job(
81                 user="root",
82                 minute="*",
83                 hour="*",
84                 daymonth="*",
85                 month="*",
86                 dayweek="*",
87                 cmd="ls",
88                 comment=None,
89                 identifier="bar",
90             )
91             c5 = get_crontab()
92             set_crontab(L + "* * * * * ls\n")
93             self.assertEqual(
94                 c5,
95                 "# Lines below here are managed by Salt, do not edit\n"
96                 "# SALT_CRON_IDENTIFIER:bar\n"
97                 "* * * * * ls\n",
98             )
99             set_crontab(L + "# SALT_CRON_IDENTIFIER:bar\n* * * * * ls\n")
100             cron.set_job(
101                 user="root",
102                 minute="1",
103                 hour="2",
104                 daymonth="3",
105                 month="4",
106                 dayweek="5",
107                 cmd="foo",
108                 comment="moo",
109                 identifier="bar",
110             )
111             c6 = get_crontab()
112             self.assertEqual(
113                 c6,
114                 "# Lines below here are managed by Salt, do not edit\n"
115                 "# moo SALT_CRON_IDENTIFIER:bar\n"
116                 "1 2 3 4 5 foo",
117             )
118     def test__unicode_match(self):
119         with patch.object(builtins, "__salt_system_encoding__", "utf-8"):
120             self.assertTrue(cron._cron_matched({"identifier": "1"}, "foo", 1))
121             self.assertTrue(cron._cron_matched({"identifier": "é"}, "foo", "é"))
122             self.assertTrue(cron._cron_matched({"identifier": "é"}, "foo", "é"))
123             self.assertTrue(cron._cron_matched({"identifier": "é"}, "foo", "é"))
124             self.assertTrue(cron._cron_matched({"identifier": "é"}, "foo", "é"))
125     def test__need_changes_old(self):
126         """
127         old behavior; ID has no special action
128         - If an id is found, it will be added as a new crontab
129           even if there is a cmd that looks like this one
130         - no comment, delete the cmd and readd it
131         - comment: idem
132         """
133         with patch(
134             "salt.modules.cron.raw_cron", new=MagicMock(side_effect=get_crontab)
135         ), patch(
136             "salt.modules.cron._write_cron_lines",
137             new=MagicMock(side_effect=write_crontab),
138         ):
139             set_crontab(L + "* * * * * ls\n\n")
140             cron.set_job(
141                 user="root",
142                 minute="*",
143                 hour="*",
144                 daymonth="*",
145                 month="*",
146                 dayweek="*",
147                 cmd="ls",
148                 comment=None,
149                 identifier=cron.SALT_CRON_NO_IDENTIFIER,
150             )
151             c1 = get_crontab()
152             set_crontab(L + "* * * * * ls\n")
153             self.assertEqual(
154                 c1,
155                 "# Lines below here are managed by Salt, do not edit\n* * * * * ls\n\n",
156             )
157             cron.set_job(
158                 user="root",
159                 minute="*",
160                 hour="*",
161                 daymonth="*",
162                 month="*",
163                 dayweek="*",
164                 cmd="ls",
165                 comment="foo",
166                 identifier=cron.SALT_CRON_NO_IDENTIFIER,
167             )
168             c2 = get_crontab()
169             self.assertEqual(
170                 c2,
171                 "# Lines below here are managed by Salt, do not edit\n"
172                 "# foo\n* * * * * ls",
173             )
174             set_crontab(L + "* * * * * ls\n")
175             cron.set_job(
176                 user="root",
177                 minute="*",
178                 hour="*",
179                 daymonth="*",
180                 month="*",
181                 dayweek="*",
182                 cmd="lsa",
183                 comment="foo",
184                 identifier="bar",
185             )
186             c3 = get_crontab()
187             self.assertEqual(
188                 c3,
189                 "# Lines below here are managed by Salt, do not edit\n"
190                 "* * * * * ls\n"
191                 "# foo SALT_CRON_IDENTIFIER:bar\n"
192                 "* * * * * lsa",
193             )
194             set_crontab(L + "* * * * * ls\n")
195             cron.set_job(
196                 user="root",
197                 minute="*",
198                 hour="*",
199                 daymonth="*",
200                 month="*",
201                 dayweek="*",
202                 cmd="foo",
203                 comment="foo",
204                 identifier="bar",
205             )
206             c4 = get_crontab()
207             self.assertEqual(
208                 c4,
209                 "# Lines below here are managed by Salt, do not edit\n"
210                 "* * * * * ls\n"
211                 "# foo SALT_CRON_IDENTIFIER:bar\n"
212                 "* * * * * foo",
213             )
214             set_crontab(L + "* * * * * ls\n")
215             cron.set_job(
216                 user="root",
217                 minute="*",
218                 hour="*",
219                 daymonth="*",
220                 month="*",
221                 dayweek="*",
222                 cmd="ls",
223                 comment="foo",
224                 identifier="bbar",
225             )
226             c4 = get_crontab()
227             self.assertEqual(
228                 c4,
229                 "# Lines below here are managed by Salt, do not edit\n"
230                 "# foo SALT_CRON_IDENTIFIER:bbar\n"
231                 "* * * * * ls",
232             )
233     def test__issue10959(self):
234         """
235         handle multi old style crontabs
236         https://github.com/saltstack/salt/issues/10959
237         """
238         with patch(
239             "salt.modules.cron.raw_cron", new=MagicMock(side_effect=get_crontab)
240         ), patch(
241             "salt.modules.cron._write_cron_lines",
242             new=MagicMock(side_effect=write_crontab),
243         ):
244             set_crontab(
245                 "# Lines below here are managed by Salt, do not edit\n"
246                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
247                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
248                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
249                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
250                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
251                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
252                 "* * * * * samecmd\n"
253                 "* * * * * otheridcmd\n"
254                 "* * * * * otheridcmd\n"
255                 "# SALT_CRON_IDENTIFIER:NO ID SET\n0 * * * * samecmd1\n"
256                 "1 * * * * samecmd1\n"
257                 "0 * * * * otheridcmd1\n"
258                 "1 * * * * otheridcmd1\n"
259                 "# SALT_CRON_IDENTIFIER:1\n0 * * * * otheridcmd1\n"
260                 "# SALT_CRON_IDENTIFIER:2\n0 * * * * otheridcmd1\n"
261             )
262             crons1 = cron.list_tab("root")
263             self.assertEqual(
264                 crons1,
265                 {
266                     "crons": [
267                         {
268                             "cmd": "ls",
269                             "comment": "uoo",
270                             "daymonth": "*",
271                             "dayweek": "*",
272                             "hour": "*",
273                             "identifier": "NO ID SET",
274                             "minute": "*",
275                             "month": "*",
276                             "commented": False,
277                         },
278                         {
279                             "cmd": "too",
280                             "comment": "uuoo",
281                             "daymonth": "*",
282                             "dayweek": "*",
283                             "hour": "*",
284                             "identifier": "NO ID SET",
285                             "minute": "*",
286                             "month": "*",
287                             "commented": False,
288                         },
289                         {
290                             "cmd": "zoo",
291                             "comment": "uuuoo",
292                             "daymonth": "*",
293                             "dayweek": "*",
294                             "hour": "*",
295                             "identifier": "NO ID SET",
296                             "minute": "*",
297                             "month": "*",
298                             "commented": False,
299                         },
300                         {
301                             "cmd": "yoo",
302                             "comment": "",
303                             "daymonth": "*",
304                             "dayweek": "*",
305                             "hour": "*",
306                             "identifier": "NO ID SET",
307                             "minute": "*",
308                             "month": "*",
309                             "commented": False,
310                         },
311                         {
312                             "cmd": "xoo",
313                             "comment": "",
314                             "daymonth": "*",
315                             "dayweek": "*",
316                             "hour": "*",
317                             "identifier": "NO ID SET",
318                             "minute": "*",
319                             "month": "*",
320                             "commented": False,
321                         },
322                         {
323                             "cmd": "samecmd",
324                             "comment": "",
325                             "daymonth": "*",
326                             "dayweek": "*",
327                             "hour": "*",
328                             "identifier": "NO ID SET",
329                             "minute": "*",
330                             "month": "*",
331                             "commented": False,
332                         },
333                         {
334                             "cmd": "samecmd",
335                             "comment": None,
336                             "daymonth": "*",
337                             "dayweek": "*",
338                             "hour": "*",
339                             "identifier": None,
340                             "minute": "*",
341                             "month": "*",
342                             "commented": False,
343                         },
344                         {
345                             "cmd": "otheridcmd",
346                             "comment": None,
347                             "daymonth": "*",
348                             "dayweek": "*",
349                             "hour": "*",
350                             "identifier": None,
351                             "minute": "*",
352                             "month": "*",
353                             "commented": False,
354                         },
355                         {
356                             "cmd": "otheridcmd",
357                             "comment": None,
358                             "daymonth": "*",
359                             "dayweek": "*",
360                             "hour": "*",
361                             "identifier": None,
362                             "minute": "*",
363                             "month": "*",
364                             "commented": False,
365                         },
366                         {
367                             "cmd": "samecmd1",
368                             "comment": "",
369                             "daymonth": "*",
370                             "dayweek": "*",
371                             "hour": "*",
372                             "identifier": "NO ID SET",
373                             "minute": "0",
374                             "month": "*",
375                             "commented": False,
376                         },
377                         {
378                             "cmd": "samecmd1",
379                             "comment": None,
380                             "daymonth": "*",
381                             "dayweek": "*",
382                             "hour": "*",
383                             "identifier": None,
384                             "minute": "1",
385                             "month": "*",
386                             "commented": False,
387                         },
388                         {
389                             "cmd": "otheridcmd1",
390                             "comment": None,
391                             "daymonth": "*",
392                             "dayweek": "*",
393                             "hour": "*",
394                             "identifier": None,
395                             "minute": "0",
396                             "month": "*",
397                             "commented": False,
398                         },
399                         {
400                             "cmd": "otheridcmd1",
401                             "comment": None,
402                             "daymonth": "*",
403                             "dayweek": "*",
404                             "hour": "*",
405                             "identifier": None,
406                             "minute": "1",
407                             "month": "*",
408                             "commented": False,
409                         },
410                         {
411                             "cmd": "otheridcmd1",
412                             "comment": "",
413                             "daymonth": "*",
414                             "dayweek": "*",
415                             "hour": "*",
416                             "identifier": "1",
417                             "minute": "0",
418                             "month": "*",
419                             "commented": False,
420                         },
421                         {
422                             "cmd": "otheridcmd1",
423                             "comment": "",
424                             "daymonth": "*",
425                             "dayweek": "*",
426                             "hour": "*",
427                             "identifier": "2",
428                             "minute": "0",
429                             "month": "*",
430                             "commented": False,
431                         },
432                     ],
433                     "env": [],
434                     "pre": [],
435                     "special": [],
436                 },
437             )
438             inc_tests = [
439                 "# Lines below here are managed by Salt, do not edit\n"
440                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls",
441                 "# Lines below here are managed by Salt, do not edit\n"
442                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
443                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too",
444                 "# Lines below here are managed by Salt, do not edit\n"
445                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
446                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
447                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo",
448                 "# Lines below here are managed by Salt, do not edit\n"
449                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
450                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
451                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
452                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo",
453                 "# Lines below here are managed by Salt, do not edit\n"
454                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
455                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
456                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
457                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
458                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo",
459                 "# Lines below here are managed by Salt, do not edit\n"
460                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
461                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
462                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
463                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
464                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
465                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd",
466                 "# Lines below here are managed by Salt, do not edit\n"
467                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
468                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
469                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
470                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
471                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
472                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd",
473                 "# Lines below here are managed by Salt, do not edit\n"
474                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
475                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
476                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
477                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
478                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
479                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
480                 "* * * * * otheridcmd",
481                 "# Lines below here are managed by Salt, do not edit\n"
482                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
483                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
484                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
485                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
486                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
487                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
488                 "* * * * * otheridcmd",
489                 "# Lines below here are managed by Salt, do not edit\n"
490                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
491                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
492                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
493                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
494                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
495                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
496                 "* * * * * otheridcmd\n"
497                 "# SALT_CRON_IDENTIFIER:NO ID SET\n"
498                 "0 * * * * samecmd1",
499                 "# Lines below here are managed by Salt, do not edit\n"
500                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
501                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
502                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
503                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
504                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
505                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
506                 "* * * * * otheridcmd\n"
507                 "# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1",
508                 "# Lines below here are managed by Salt, do not edit\n"
509                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
510                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
511                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
512                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
513                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
514                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
515                 "* * * * * otheridcmd\n"
516                 "# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1\n"
517                 "0 * * * * otheridcmd1",
518                 "# Lines below here are managed by Salt, do not edit\n"
519                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
520                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
521                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
522                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
523                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
524                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
525                 "* * * * * otheridcmd\n"
526                 "# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1\n"
527                 "1 * * * * otheridcmd1",
528                 "# Lines below here are managed by Salt, do not edit\n"
529                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
530                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
531                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
532                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
533                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
534                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
535                 "* * * * * otheridcmd\n"
536                 "# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1\n"
537                 "# SALT_CRON_IDENTIFIER:1\n0 * * * * otheridcmd1",
538                 "# Lines below here are managed by Salt, do not edit\n"
539                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
540                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
541                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
542                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
543                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
544                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
545                 "* * * * * otheridcmd\n"
546                 "# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1\n"
547                 "# SALT_CRON_IDENTIFIER:1\n0 * * * * otheridcmd1\n"
548                 "# SALT_CRON_IDENTIFIER:2\n0 * * * * otheridcmd1",
549             ]
550             set_crontab("")
551             for idx, cr in enumerate(crons1["crons"]):
552                 cron.set_job("root", **cr)
553                 self.assertEqual(
554                     get_crontab(),
555                     inc_tests[idx],
556                     ("idx {0}\n'{1}'\n != \n'{2}'\n\n\n'{1}' != '{2}'").format(
557                         idx, get_crontab(), inc_tests[idx]
558                     ),
559                 )
560     def test_list_tab_commented_cron_jobs(self):
561         """
562         handle commented cron jobs
563         https://github.com/saltstack/salt/issues/29082
564         """
565         with patch(
566             "salt.modules.cron.raw_cron", MagicMock(side_effect=get_crontab)
567         ), patch(
568             "salt.modules.cron._write_cron_lines", MagicMock(side_effect=write_crontab)
569         ):
570             set_crontab(
571                 "# An unmanaged commented cron job\n"
572                 "#0 * * * * /bin/true\n"
573                 "# Lines below here are managed by Salt, do not edit\n"
574                 "# cron_1 SALT_CRON_IDENTIFIER:cron_1\n#DISABLED#0 * * * * my_cmd_1\n"
575                 "# cron_2 SALT_CRON_IDENTIFIER:cron_2\n#DISABLED#* * * * * my_cmd_2\n"
576                 "# cron_3 SALT_CRON_IDENTIFIER:cron_3\n"
577                 "#DISABLED#but it is a comment line"
578                 "#DISABLED#0 * * * * my_cmd_3\n"
579                 "# cron_4 SALT_CRON_IDENTIFIER:cron_4\n0 * * * * my_cmd_4\n"
580             )
581             crons1 = cron.list_tab("root")
582             self.assertEqual(
583                 crons1,
584                 {
585                     "crons": [
586                         {
587                             "cmd": "my_cmd_1",
588                             "comment": "cron_1",
589                             "daymonth": "*",
590                             "dayweek": "*",
591                             "hour": "*",
592                             "identifier": "cron_1",
593                             "minute": "0",
594                             "month": "*",
595                             "commented": True,
596                         },
597                         {
598                             "cmd": "my_cmd_2",
599                             "comment": "cron_2",
600                             "daymonth": "*",
601                             "dayweek": "*",
602                             "hour": "*",
603                             "identifier": "cron_2",
604                             "minute": "*",
605                             "month": "*",
606                             "commented": True,
607                         },
608                         {
609                             "cmd": "line#DISABLED#0 * * * * my_cmd_3",
610                             "comment": "cron_3",
611                             "daymonth": "is",
612                             "dayweek": "comment",
613                             "hour": "it",
614                             "identifier": "cron_3",
615                             "minute": "but",
616                             "month": "a",
617                             "commented": True,
618                         },
619                         {
620                             "cmd": "my_cmd_4",
621                             "comment": "cron_4",
622                             "daymonth": "*",
623                             "dayweek": "*",
624                             "hour": "*",
625                             "identifier": "cron_4",
626                             "minute": "0",
627                             "month": "*",
628                             "commented": False,
629                         },
630                     ],
631                     "env": [],
632                     "pre": [
633                         "# An unmanaged commented cron job",
634                         "#0 * * * * /bin/true",
635                     ],
636                     "special": [],
637                 },
638             )
639     def test_get_entry(self):
640         """
641         test get_entry function
642         """
643         list_tab_output = {
644             "crons": [
645                 {
646                     "cmd": "my_cmd_1",
647                     "comment": "cron_1",
648                     "daymonth": "*",
649                     "dayweek": "*",
650                     "hour": "*",
651                     "identifier": "cron_1",
652                     "minute": "0",
653                     "month": "*",
654                     "commented": True,
655                 },
656                 {
657                     "cmd": "my_cmd_2",
658                     "comment": "cron_2",
659                     "daymonth": "*",
660                     "dayweek": "*",
661                     "hour": "*",
662                     "identifier": "cron_2",
663                     "minute": "*",
664                     "month": "*",
665                     "commented": True,
666                 },
667                 {
668                     "cmd": "line#DISABLED#0 * * * * my_cmd_3",
669                     "comment": "cron_3",
670                     "daymonth": "is",
671                     "dayweek": "comment",
672                     "hour": "it",
673                     "identifier": "cron_3",
674                     "minute": "but",
675                     "month": "a",
676                     "commented": True,
677                 },
678                 {
679                     "cmd": "my_cmd_4",
680                     "comment": "cron_4",
681                     "daymonth": "*",
682                     "dayweek": "*",
683                     "hour": "*",
684                     "identifier": "cron_4",
685                     "minute": "0",
686                     "month": "*",
687                     "commented": False,
688                 },
689             ],
690             "env": [],
691             "pre": ["# An unmanaged commented cron job", "#0 * * * * /bin/true"],
692             "special": [],
693         }
694         get_entry_2 = {
695             "comment": "cron_2",
696             "cmd": "my_cmd_2",
697             "identifier": "cron_2",
698             "dayweek": "*",
699             "daymonth": "*",
700             "hour": "*",
701             "minute": "*",
702             "month": "*",
703             "commented": True,
704         }
705         get_entry_3 = {
706             "comment": "cron_3",
707             "identifier": "cron_3",
708             "dayweek": "comment",
709             "hour": "it",
710             "cmd": "line#DISABLED#0 * * * * my_cmd_3",
711             "daymonth": "is",
712             "commented": True,
713             "minute": "but",
714             "month": "a",
715         }
716         with patch(
717         ):
718             get_entry_output <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= cron.get_entry("root", identifier="cron_3")
719             self.assertDictEqual(get_entry_output, get_entry_3)
720             get_entry_output = cron.get_entry("root", cmd="my_cmd_2")
721             self.assertDictEqual(get_entry_output, get_entry_2)
722             get_entry_output = cron.get_entry(
723                 "root", identifier=</b></font>"cron_3", cmd="my_cmd_2"
724             )
725             self.assertDictEqual(get_entry_output, get_entry_3)
726     def test_cron_extra_spaces(self):
727         """
728         Issue #38449
729         """
730         with patch.dict(cron.__grains__, {"os": None}), patch(
731             "salt.modules.cron.raw_cron", MagicMock(return_value=STUB_CRON_SPACES)
732         ):
733             ret = cron.list_tab("root")
734             eret = {
735                 "crons": [
736                     {
737                         "cmd": 'echo "must  be  double  spaced"',
738                         "comment": "",
739                         "commented": False,
740                         "daymonth": "*",
741                         "dayweek": "*",
742                         "hour": "*",
743                         "identifier": 'echo "must  be  double  spaced"',
744                         "minute": "11",
745                         "month": "*",
746                     }
747                 ],
748                 "env": [
749                     {"name": "TEST_VAR", "value": '"a string with plenty of spaces"'}
750                 ],
751                 "pre": [""],
752                 "special": [],
753             }
754             self.assertEqual(eret, ret)
755     def test_cron_at_sign(self):
756         with patch.dict(cron.__grains__, {"os": None}), patch(
757             "salt.modules.cron.raw_cron", MagicMock(return_value=STUB_AT_SIGN)
758         ):
759             ret = cron.list_tab("root")
760             eret = {
761                 "crons": [],
762                 "env": [],
763                 "pre": [""],
764                 "special": [
765                     {
766                         "cmd": 'echo "cron with @ sign"',
767                         "comment": "",
768                         "commented": False,
769                         "identifier": 'echo "cron with @ sign"',
770                         "spec": "@daily",
771                     }
772                 ],
773             }
774             self.assertDictEqual(eret, ret)
775     def test__load_tab(self):
776         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch(
777             "salt.modules.cron.raw_cron",
778             new=MagicMock(
779                 side_effect=[
780                     (L + "\n"),
781                     (L + "* * * * * ls\nn"),
782                     (L + "# commented\n#DISABLED#* * * * * ls\n"),
783                     (L + "# foo\n* * * * * ls\n"),
784                     (
785                         L
786                         + "# foo {}:blah\n".format(cron.SALT_CRON_IDENTIFIER)
787                         + "* * * * * ls\n"
788                     ),
789                 ]
790             ),
791         ):
792             crons1 = cron.list_tab("root")
793             crons2 = cron.list_tab("root")
794             crons3 = cron.list_tab("root")
795             crons4 = cron.list_tab("root")
796             crons5 = cron.list_tab("root")
797             self.assertEqual(crons1, {"pre": [], "crons": [], "env": [], "special": []})
798             self.assertEqual(
799                 crons2["crons"][0],
800                 {
801                     "comment": None,
802                     "commented": False,
803                     "dayweek": "*",
804                     "hour": "*",
805                     "identifier": None,
806                     "cmd": "ls",
807                     "daymonth": "*",
808                     "minute": "*",
809                     "month": "*",
810                 },
811             )
812             self.assertEqual(
813                 crons3["crons"][0],
814                 {
815                     "comment": "commented",
816                     "commented": True,
817                     "dayweek": "*",
818                     "hour": "*",
819                     "identifier": None,
820                     "cmd": "ls",
821                     "daymonth": "*",
822                     "minute": "*",
823                     "month": "*",
824                 },
825             )
826             self.assertEqual(
827                 crons4["crons"][0],
828                 {
829                     "comment": "foo",
830                     "commented": False,
831                     "dayweek": "*",
832                     "hour": "*",
833                     "identifier": None,
834                     "cmd": "ls",
835                     "daymonth": "*",
836                     "minute": "*",
837                     "month": "*",
838                 },
839             )
840             self.assertEqual(
841                 crons5["crons"][0],
842                 {
843                     "comment": "foo",
844                     "commented": False,
845                     "dayweek": "*",
846                     "hour": "*",
847                     "identifier": "blah",
848                     "cmd": "ls",
849                     "daymonth": "*",
850                     "minute": "*",
851                     "month": "*",
852                 },
853             )
854     def test_write_cron_file_root_rh(self):
855         """
856         Assert that write_cron_file() is called with the correct cron command and user: RedHat
857           - If instance running uid matches crontab user uid, run without -u flag.
858         """
859         with patch.dict(cron.__grains__, {"os_family": "RedHat"}), patch.dict(
860             cron.__salt__, {"cmd.retcode": MagicMock()}
861         ), patch(
862             "salt.modules.cron._check_instance_uid_match",
863             new=MagicMock(return_value=True),
864         ):
865             cron.write_cron_file(STUB_USER, STUB_PATH)
866             cron.__salt__["cmd.retcode"].assert_called_with(
867                 "crontab /tmp", python_shell=False
868             )
869     def test_write_cron_file_foo_rh(self):
870         """
871         Assert that write_cron_file() is called with the correct cron command and user: RedHat
872           - If instance running with uid that doesn't match crontab user uid, runas foo
873         """
874         with patch.dict(cron.__grains__, {"os_family": "RedHat"}), patch.dict(
875             cron.__salt__, {"cmd.retcode": MagicMock()}
876         ), patch(
877             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=False)
878         ):
879             cron.write_cron_file("foo", STUB_PATH)
880             cron.__salt__["cmd.retcode"].assert_called_with(
881                 "crontab /tmp", runas="foo", python_shell=False
882             )
883     def test_write_cron_file_root_sol(self):
884         """
885         Assert that write_cron_file() is called with the correct cron command and user: Solaris
886           - Solaris should always run without a -u flag
887         """
888         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch.dict(
889             cron.__salt__, {"cmd.retcode": MagicMock()}
890         ):
891             cron.write_cron_file(STUB_USER, STUB_PATH)
892             cron.__salt__["cmd.retcode"].assert_called_with(
893                 "crontab /tmp", runas=STUB_USER, python_shell=False
894             )
895     def test_write_cron_file_foo_sol(self):
896         """
897         Assert that write_cron_file() is called with the correct cron command and user: Solaris
898           - Solaris should always run without a -u flag
899         """
900         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch.dict(
901             cron.__salt__, {"cmd.retcode": MagicMock()}
902         ):
903             cron.write_cron_file("foo", STUB_PATH)
904             cron.__salt__["cmd.retcode"].assert_called_with(
905                 "crontab /tmp", runas="foo", python_shell=False
906             )
907     def test_write_cron_file_root_aix(self):
908         """
909         Assert that write_cron_file() is called with the correct cron command and user: AIX
910           - AIX should always run without a -u flag
911         """
912         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
913             cron.__salt__, {"cmd.retcode": MagicMock()}
914         ):
915             cron.write_cron_file(STUB_USER, STUB_PATH)
916             cron.__salt__["cmd.retcode"].assert_called_with(
917                 "crontab /tmp", runas=STUB_USER, python_shell=False
918             )
919     def test_write_cron_file_foo_aix(self):
920         """
921         Assert that write_cron_file() is called with the correct cron command and user: AIX
922           - AIX should always run without a -u flag
923         """
924         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
925             cron.__salt__, {"cmd.retcode": MagicMock()}
926         ):
927             cron.write_cron_file("foo", STUB_PATH)
928             cron.__salt__["cmd.retcode"].assert_called_with(
929                 "crontab /tmp", runas="foo", python_shell=False
930             )
931     def test_write_cr_file_v_root_rh(self):
932         """
933         Assert that write_cron_file_verbose() is called with the correct cron command and user: RedHat
934           - If instance running uid matches crontab user uid, run without -u flag.
935         """
936         with patch.dict(cron.__grains__, {"os_family": "Redhat"}), patch.dict(
937             cron.__salt__, {"cmd.run_all": MagicMock()}
938         ), patch(
939             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=True)
940         ):
941             cron.write_cron_file_verbose(STUB_USER, STUB_PATH)
942             cron.__salt__["cmd.run_all"].assert_called_with(
943                 "crontab /tmp", python_shell=False
944             )
945     def test_write_cr_file_v_foo_rh(self):
946         """
947         Assert that write_cron_file_verbose() is called with the correct cron command and user: RedHat
948           - If instance running with uid that doesn't match crontab user uid, runas 'foo'
949         """
950         with patch.dict(cron.__grains__, {"os_family": "Redhat"}), patch.dict(
951             cron.__salt__, {"cmd.run_all": MagicMock()}
952         ), patch(
953             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=False)
954         ):
955             cron.write_cron_file_verbose("foo", STUB_PATH)
956             cron.__salt__["cmd.run_all"].assert_called_with(
957                 "crontab /tmp", runas="foo", python_shell=False
958             )
959     def test_write_cr_file_v_root_sol(self):
960         """
961         Assert that write_cron_file_verbose() is called with the correct cron command and user: Solaris
962           - Solaris should always run without a -u flag
963         """
964         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch.dict(
965             cron.__salt__, {"cmd.run_all": MagicMock()}
966         ):
967             cron.write_cron_file_verbose(STUB_USER, STUB_PATH)
968             cron.__salt__["cmd.run_all"].assert_called_with(
969                 "crontab /tmp", runas=STUB_USER, python_shell=False
970             )
971     def test_write_cr_file_v_foo_sol(self):
972         """
973         Assert that write_cron_file_verbose() is called with the correct cron command and user: Solaris
974           - Solaris should always run without a -u flag
975         """
976         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch.dict(
977             cron.__salt__, {"cmd.run_all": MagicMock()}
978         ):
979             cron.write_cron_file_verbose("foo", STUB_PATH)
980             cron.__salt__["cmd.run_all"].assert_called_with(
981                 "crontab /tmp", runas="foo", python_shell=False
982             )
983     def test_write_cr_file_v_root_aix(self):
984         """
985         Assert that write_cron_file_verbose() is called with the correct cron command and user: AIX
986           - AIX should always run without a -u flag
987         """
988         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
989             cron.__salt__, {"cmd.run_all": MagicMock()}
990         ):
991             cron.write_cron_file_verbose(STUB_USER, STUB_PATH)
992             cron.__salt__["cmd.run_all"].assert_called_with(
993                 "crontab /tmp", runas=STUB_USER, python_shell=False
994             )
995     def test_write_cr_file_v_foo_aix(self):
996         """
997         Assert that write_cron_file_verbose() is called with the correct cron command and user: AIX
998           - AIX should always run without a -u flag
999         """
1000         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
1001             cron.__salt__, {"cmd.run_all": MagicMock()}
1002         ):
1003             cron.write_cron_file_verbose("foo", STUB_PATH)
1004             cron.__salt__["cmd.run_all"].assert_called_with(
1005                 "crontab /tmp", runas="foo", python_shell=False
1006             )
1007     def test_raw_cron_root_redhat(self):
1008         """
1009         Assert that raw_cron() is called with the correct cron command and user: RedHat
1010           - If instance running uid matches crontab user uid, runas STUB_USER without -u flag.
1011         """
1012         with patch.dict(cron.__grains__, {"os_family": "Redhat"}), patch.dict(
1013             cron.__salt__, {"cmd.run_stdout": MagicMock()}
1014         ), patch(
1015             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=True)
1016         ):
1017             cron.raw_cron(STUB_USER)
1018             cron.__salt__["cmd.run_stdout"].assert_called_with(
1019                 "crontab -l", ignore_retcode=True, rstrip=False, python_shell=False
1020             )
1021     def test_raw_cron_foo_redhat(self):
1022         """
1023         Assert that raw_cron() is called with the correct cron command and user: RedHat
1024           - If instance running with uid that doesn't match crontab user uid, run with -u flag
1025         """
1026         with patch.dict(cron.__grains__, {"os_family": "Redhat"}), patch.dict(
1027             cron.__salt__, {"cmd.run_stdout": MagicMock()}
1028         ), patch(
1029             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=False)
1030         ):
1031             cron.raw_cron(STUB_USER)
1032             cron.__salt__["cmd.run_stdout"].assert_called_with(
1033                 "crontab -l",
1034                 runas=STUB_USER,
1035                 ignore_retcode=True,
1036                 rstrip=False,
1037                 python_shell=False,
1038             )
1039     def test_raw_cron_root_solaris(self):
1040         """
1041         Assert that raw_cron() is called with the correct cron command and user: Solaris
1042           - Solaris should always run without a -u flag
1043         """
1044         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch.dict(
1045             cron.__salt__, {"cmd.run_stdout": MagicMock()}
1046         ), patch(
1047             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=True)
1048         ):
1049             cron.raw_cron(STUB_USER)
1050             cron.__salt__["cmd.run_stdout"].assert_called_with(
1051                 "crontab -l",
1052                 runas=STUB_USER,
1053                 ignore_retcode=True,
1054                 rstrip=False,
1055                 python_shell=False,
1056             )
1057     def test_raw_cron_foo_solaris(self):
1058         """
1059         Assert that raw_cron() is called with the correct cron command and user: Solaris
1060           - Solaris should always run without a -u flag
1061         """
1062         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch.dict(
1063             cron.__salt__, {"cmd.run_stdout": MagicMock()}
1064         ), patch(
1065             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=False)
1066         ):
1067             cron.raw_cron(STUB_USER)
1068             cron.__salt__["cmd.run_stdout"].assert_called_with(
1069                 "crontab -l",
1070                 runas=STUB_USER,
1071                 ignore_retcode=True,
1072                 rstrip=False,
1073                 python_shell=False,
1074             )
1075     def test_raw_cron_root_aix(self):
1076         """
1077         Assert that raw_cron() is called with the correct cron command and user: AIX
1078           - AIX should always run without a -u flag
1079         """
1080         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
1081             cron.__salt__, {"cmd.run_stdout": MagicMock()}
1082         ), patch(
1083             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=True)
1084         ):
1085             cron.raw_cron(STUB_USER)
1086             cron.__salt__["cmd.run_stdout"].assert_called_with(
1087                 "crontab -l",
1088                 runas=STUB_USER,
1089                 ignore_retcode=True,
1090                 rstrip=False,
1091                 python_shell=False,
1092             )
1093     def test_raw_cron_foo_aix(self):
1094         """
1095         Assert that raw_cron() is called with the correct cron command and user: AIX
1096           - AIX should always run without a -u flag
1097         """
1098         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
1099             cron.__salt__, {"cmd.run_stdout": MagicMock()}
1100         ), patch(
1101             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=False)
1102         ):
1103             cron.raw_cron(STUB_USER)
1104             cron.__salt__["cmd.run_stdout"].assert_called_with(
1105                 "crontab -l",
1106                 runas=STUB_USER,
1107                 ignore_retcode=True,
1108                 rstrip=False,
1109                 python_shell=False,
1110             )
1111 class PsTestCase(TestCase, LoaderModuleMockMixin):
1112     def setup_loader_modules(self):
1113         return {cron: {}}
1114     def test__needs_change(self):
1115         self.assertTrue(cron._needs_change(True, False))
1116     def test__needs_change_random(self):
1117         """
1118         Assert that if the new var is 'random' and old is '* that we return True
1119         """
1120         self.assertTrue(cron._needs_change("*", "random"))
1121     def test__get_cron_cmdstr(self):
1122         self.assertEqual("crontab /tmp", cron._get_cron_cmdstr(STUB_PATH))
1123     def test__get_cron_cmdstr_user(self):
1124         """
1125         Passes if a user is added to crontab command
1126         """
1127         self.assertEqual(
1128             "crontab -u root /tmp", cron._get_cron_cmdstr(STUB_PATH, STUB_USER)
1129         )
1130     def test__date_time_match(self):
1131         """
1132         Passes if a match is found on all elements. Note the conversions to strings here!
1133         :return:
1134         """
1135         self.assertTrue(
1136             cron._date_time_match(
1137                 STUB_CRON_TIMESTAMP,
1138                 minute=STUB_CRON_TIMESTAMP["minute"],
1139                 hour=STUB_CRON_TIMESTAMP["hour"],
1140                 daymonth=STUB_CRON_TIMESTAMP["daymonth"],
1141                 dayweek=STUB_CRON_TIMESTAMP["dayweek"],
1142             )
1143         )
1144     def test_list_tab(self):
1145         with patch(
1146             "salt.modules.cron.raw_cron",
1147             new=MagicMock(return_value=STUB_SIMPLE_RAW_CRON),
1148         ):
1149             self.assertDictEqual(STUB_SIMPLE_CRON_DICT, cron.list_tab("DUMMY_USER"))
1150     def test_set_special(self):
1151         with patch(
1152             "salt.modules.cron._write_cron_lines"
1153         ) as write_cron_lines_mock, patch(
1154             "salt.modules.cron.list_tab",
1155             new=MagicMock(return_value=STUB_SIMPLE_CRON_DICT),
1156         ):
1157             expected_write_call = call(
1158                 "DUMMY_USER",
1159                 [
1160                     "5 0 * * * /tmp/no_script.sh\n",
1161                     "# Lines below here are managed by Salt, do not edit\n",
1162                     "@hourly echo Hi!\n",
1163                 ],
1164             )
1165             ret = cron.set_special("DUMMY_USER", "@hourly", "echo Hi!")
1166             write_cron_lines_mock.assert_has_calls(
1167                 (expected_write_call,), any_order=True
1168             )
1169     def test__get_cron_date_time(self):
1170         ret = cron._get_cron_date_time(
1171             minute=STUB_CRON_TIMESTAMP["minute"],
1172             hour=STUB_CRON_TIMESTAMP["hour"],
1173             daymonth=STUB_CRON_TIMESTAMP["daymonth"],
1174             dayweek=STUB_CRON_TIMESTAMP["dayweek"],
1175             month=STUB_CRON_TIMESTAMP["month"],
1176         )
1177         self.assertDictEqual(ret, STUB_CRON_TIMESTAMP)
1178     def test__get_cron_date_time_daymonth_max(self):
1179         ret = cron._get_cron_date_time(
1180             minute="random",
1181             hour="random",
1182             daymonth="random",
1183             dayweek="random",
1184             month="random",
1185         )
1186         self.assertTrue(int(ret["minute"]) in range(0, 60))
1187         self.assertTrue(int(ret["hour"]) in range(0, 24))
1188         self.assertTrue(int(ret["daymonth"]) in range(1, 32))
1189         self.assertTrue(int(ret["dayweek"]) in range(0, 8))
1190         self.assertTrue(int(ret["month"]) in range(1, 13))
1191     def test_set_job(self):
1192         with patch.dict(cron.__grains__, {"os": None}), patch(
1193             "salt.modules.cron._write_cron_lines",
1194             new=MagicMock(return_value={"retcode": False}),
1195         ), patch(
1196             "salt.modules.cron.raw_cron",
1197             new=MagicMock(return_value=STUB_SIMPLE_RAW_CRON),
1198         ):
1199             cron.set_job(
1200                 "DUMMY_USER",
1201                 1,
1202                 2,
1203                 3,
1204                 4,
1205                 5,
1206                 "/bin/echo NOT A DROID",
1207                 "WERE YOU LOOKING FOR ME?",
1208             )
1209             expected_call = call(
1210                 "DUMMY_USER",
1211                 [
1212                     "5 0 * * * /tmp/no_script.sh\n",
1213                     "# Lines below here are managed by Salt, do not edit\n",
1214                     "# WERE YOU LOOKING FOR ME?\n",
1215                     "1 2 3 4 5 /bin/echo NOT A DROID\n",
1216                 ],
1217             )
1218             cron._write_cron_lines.call_args.assert_called_with(expected_call)
1219     def test_rm_special(self):
1220         with patch.dict(cron.__grains__, {"os": None}), patch(
1221             "salt.modules.cron._write_cron_lines",
1222             new=MagicMock(return_value={"retcode": False}),
1223         ), patch(
1224             "salt.modules.cron.raw_cron", new=MagicMock(return_value=STUB_AT_SIGN)
1225         ):
1226             ret = cron.rm_special(
1227                 "root",
1228                 'echo "cron with @ sign"',
1229                 special="@daily",
1230                 identifier='echo "cron with @ sign"',
1231             )
1232             self.assertEqual("removed", ret)
1233     def test_rm_special_default_special(self):
1234         with patch.dict(cron.__grains__, {"os": None}), patch(
1235             "salt.modules.cron._write_cron_lines",
1236             new=MagicMock(return_value={"retcode": False}),
1237         ), patch(
1238             "salt.modules.cron.raw_cron", new=MagicMock(return_value=STUB_AT_SIGN)
1239         ):
1240             ret = cron.rm_special(
1241                 "root", 'echo "cron with @ sign"', identifier='echo "cron with @ sign"'
1242             )
1243             self.assertEqual("removed", ret)
1244     def test_rm_special_absent(self):
1245         with patch.dict(cron.__grains__, {"os": None}), patch(
1246             "salt.modules.cron._write_cron_lines",
1247             new=MagicMock(return_value={"retcode": False}),
1248         ), patch(
1249             "salt.modules.cron.raw_cron", new=MagicMock(return_value=STUB_AT_SIGN)
1250         ):
1251             ret = cron.rm_special(
1252                 "root", 'echo "there is no job"', identifier='echo "there is no job"'
1253             )
1254             self.assertEqual("absent", ret)
1255     def test_rm_job_is_absent(self):
1256         with patch.dict(cron.__grains__, {"os": None}), patch(
1257             "salt.modules.cron._write_cron_lines",
1258             new=MagicMock(return_value={"retcode": False}),
1259         ), patch(
1260             "salt.modules.cron.raw_cron",
1261             new=MagicMock(return_value=STUB_SIMPLE_RAW_CRON),
1262         ):
1263             ret = cron.rm_job("DUMMY_USER", "/bin/echo NOT A DROID", 1, 2, 3, 4, 5)
1264             self.assertEqual("absent", ret)
1265     def test_write_cron_lines_root_rh(self):
1266         """
1267         Assert that _write_cron_lines() is called with the correct cron command and user
1268         OS: RedHat. User: root. Expected to run with runas argument.
1269         """
1270         temp_path = "some_temp_path"
1271         crontab_cmd = "crontab {}".format(temp_path)
1272         with patch.dict(cron.__grains__, {"os_family": "RedHat"}), patch.dict(
1273             cron.__salt__, {"cmd.run_all": MagicMock()}
1274         ), patch(
1275             "salt.modules.cron._check_instance_uid_match",
1276             new=MagicMock(return_value=True),
1277         ), patch(
1278             "salt.utils.files.fpopen", mock_open()
1279         ), patch.dict(
1280             cron.__salt__, {"file.user_to_uid": MagicMock(return_value=1)}
1281         ), patch(
1282             "salt.utils.files.mkstemp", MagicMock(return_value=temp_path)
1283         ), patch(
1284             "os.remove", MagicMock()
1285         ):
1286             cron._write_cron_lines("root", "test 123")
1287             cron.__salt__["cmd.run_all"].assert_called_with(
1288                 crontab_cmd, python_shell=False, runas="root"
1289             )
1290     def test_write_cron_lines_non_root_rh(self):
1291         """
1292         Assert that _write_cron_lines() is called with the correct cron command and user
1293         OS: RedHat. User: non-root. Expected to run without runas argument.
1294         """
1295         temp_path = "some_temp_path"
1296         crontab_cmd = "crontab {}".format(temp_path)
1297         with patch.dict(cron.__grains__, {"os_family": "RedHat"}), patch.dict(
1298             cron.__salt__, {"cmd.run_all": MagicMock()}
1299         ), patch(
1300             "salt.modules.cron._check_instance_uid_match",
1301             new=MagicMock(return_value=False),
1302         ), patch(
1303             "salt.utils.files.fpopen", mock_open()
1304         ), patch.dict(
1305             cron.__salt__, {"file.user_to_uid": MagicMock(return_value=1)}
1306         ), patch(
1307             "salt.utils.files.mkstemp", MagicMock(return_value=temp_path)
1308         ), patch(
1309             "os.remove", MagicMock()
1310         ):
1311             cron._write_cron_lines("non-root", "test 123")
1312             cron.__salt__["cmd.run_all"].assert_called_with(
1313                 crontab_cmd, python_shell=False
1314             )
1315     def test_write_cron_lines_non_root_aix(self):
1316         """
1317         Assert that _write_cron_lines() is called with the correct cron command and user
1318         OS: AIX. User: non-root. Expected to run with runas argument.
1319         """
1320         temp_path = "some_temp_path"
1321         crontab_cmd = "crontab {}".format(temp_path)
1322         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
1323             cron.__salt__, {"cmd.run_all": MagicMock()}
1324         ), patch(
1325             "salt.modules.cron._check_instance_uid_match",
1326             new=MagicMock(return_value=False),
1327         ), patch(
1328             "salt.utils.files.fpopen", mock_open()
1329         ), patch.dict(
1330             cron.__salt__, {"file.user_to_uid": MagicMock(return_value=1)}
1331         ), patch(
1332             "salt.utils.files.mkstemp", MagicMock(return_value=temp_path)
1333         ), patch(
1334             "os.remove", MagicMock()
1335         ):
1336             cron._write_cron_lines("non-root", "test 123")
1337             cron.__salt__["cmd.run_all"].assert_called_with(
1338                 crontab_cmd, python_shell=False, runas="non-root"
1339             )
1340     def test_write_cron_lines_non_root_solaris(self):
1341         """
1342         Assert that _write_cron_lines() is called with the correct cron command and user
1343         OS: Solaris. User: non-root. Expected to run with runas argument.
1344         """
1345         temp_path = "some_temp_path"
1346         crontab_cmd = "crontab {}".format(temp_path)
1347         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
1348             cron.__salt__, {"cmd.run_all": MagicMock()}
1349         ), patch(
1350             "salt.modules.cron._check_instance_uid_match",
1351             new=MagicMock(return_value=False),
1352         ), patch(
1353             "salt.utils.files.fpopen", mock_open()
1354         ), patch.dict(
1355             cron.__salt__, {"file.user_to_uid": MagicMock(return_value=1)}
1356         ), patch(
1357             "salt.utils.files.mkstemp", MagicMock(return_value=temp_path)
1358         ), patch(
1359             "os.remove", MagicMock()
1360         ):
1361             cron._write_cron_lines("non-root", "test 123")
1362             cron.__salt__["cmd.run_all"].assert_called_with(
1363                 crontab_cmd, python_shell=False, runas="non-root"
1364             )
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
