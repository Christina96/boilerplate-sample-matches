<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for mongo_return.py & test_cron_1.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for mongo_return.py & test_cron_1.py
      </h3>
      <h1 align="center">
        2.1%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>mongo_return.py (7.6555023%)<TH>test_cron_1.py (1.254902%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match162270-0.html#0',2,'match162270-1.html#0',3)" NAME="0">(128-133)<TD><A HREF="javascript:ZweiFrames('match162270-0.html#0',2,'match162270-1.html#0',3)" NAME="0">(774-781)</A><TD ALIGN=center><FONT COLOR="#ff0000">16</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>mongo_return.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
Return data to a mongodb server

Required python modules: pymongo


This returner will send data from the minions to a MongoDB server. To
configure the settings for your MongoDB server, add the following lines
to the minion config files.

.. code-block:: yaml

    mongo.db: &lt;database name&gt;
    mongo.host: &lt;server ip address&gt;
    mongo.user: &lt;MongoDB username&gt;
    mongo.password: &lt;MongoDB user password&gt;
    mongo.port: 27017

Alternative configuration values can be used by prefacing the configuration.
Any values not found in the alternative configuration will be pulled from
the default location.

.. code-block:: yaml

    alternative.mongo.db: &lt;database name&gt;
    alternative.mongo.host: &lt;server ip address&gt;
    alternative.mongo.user: &lt;MongoDB username&gt;
    alternative.mongo.password: &lt;MongoDB user password&gt;
    alternative.mongo.port: 27017

To use the mongo returner, append '--return mongo' to the salt command.

.. code-block:: bash

    salt '*' test.ping --return mongo_return

To use the alternative configuration, append '--return_config alternative' to the salt command.

.. versionadded:: 2015.5.0

.. code-block:: bash

    salt '*' test.ping --return mongo_return --return_config alternative

To override individual configuration items, append --return_kwargs '{&quot;key:&quot;: &quot;value&quot;}' to the salt command.

.. versionadded:: 2016.3.0

.. code-block:: bash

    salt '*' test.ping --return mongo --return_kwargs '{&quot;db&quot;: &quot;another-salt&quot;}'

To override individual configuration items, append --return_kwargs '{&quot;key:&quot;: &quot;value&quot;}' to the salt command.

.. versionadded:: 2016.3.0

.. code-block:: bash

    salt '*' test.ping --return mongo --return_kwargs '{&quot;db&quot;: &quot;another-salt&quot;}'

&quot;&quot;&quot;

import logging

import salt.returners
import salt.utils.jid
from salt.utils.versions import LooseVersion as _LooseVersion

try:
    import pymongo

    PYMONGO_VERSION = _LooseVersion(pymongo.version)
    HAS_PYMONGO = True
except ImportError:
    HAS_PYMONGO = False


log = logging.getLogger(__name__)

# Define the module's virtual name
# currently only used iby _get_options
__virtualname__ = &quot;mongo&quot;


def __virtual__():
    if not HAS_PYMONGO:
        return False, &quot;Could not import mongo returner; pymongo is not installed.&quot;
    return &quot;mongo_return&quot;


def _remove_dots(src):
    &quot;&quot;&quot;
    Remove dots from the given data structure
    &quot;&quot;&quot;
    output = {}
    for key, val in src.items():
        if isinstance(val, dict):
            val = _remove_dots(val)
        output[key.replace(&quot;.&quot;, &quot;-&quot;)] = val
    return output


def _get_options(ret):
    &quot;&quot;&quot;
    Get the monogo_return options from salt.
    &quot;&quot;&quot;
    attrs = {
        &quot;host&quot;: &quot;host&quot;,
        &quot;port&quot;: &quot;port&quot;,
        &quot;db&quot;: &quot;db&quot;,
        &quot;user&quot;: &quot;user&quot;,
        &quot;password&quot;: &quot;password&quot;,
        &quot;indexes&quot;: &quot;indexes&quot;,
    }

    _options = salt.returners.get_returner_options(
        __virtualname__, ret, attrs, __salt__=__salt__, __opts__=__opts__
    )
    return _options


def _get_conn(ret):
    &quot;&quot;&quot;
    Return a mongodb connection object
<A NAME="0"></A>    &quot;&quot;&quot;
    _options = _get_options(ret)

    host <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match162270-1.html#0',3,'match162270-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= _options.get(&quot;host&quot;)
    port = _options.get(&quot;port&quot;)
    db_ = _options.get(&quot;db&quot;)
    user = _options.get(&quot;user&quot;)
    password = _options.get(&quot;password&quot;)
    indexes =</B></FONT> _options.get(&quot;indexes&quot;, False)

    # at some point we should remove support for
    # pymongo versions &lt; 2.3 until then there are
    # a bunch of these sections that need to be supported

    if PYMONGO_VERSION &gt; _LooseVersion(&quot;2.3&quot;):
        conn = pymongo.MongoClient(host, port)
    else:
        conn = pymongo.Connection(host, port)
    mdb = conn[db_]

    if user and password:
        mdb.authenticate(user, password)

    if indexes:
        if PYMONGO_VERSION &gt; _LooseVersion(&quot;2.3&quot;):
            mdb.saltReturns.create_index(&quot;minion&quot;)
            mdb.saltReturns.create_index(&quot;jid&quot;)

            mdb.jobs.create_index(&quot;jid&quot;)
        else:
            mdb.saltReturns.ensure_index(&quot;minion&quot;)
            mdb.saltReturns.ensure_index(&quot;jid&quot;)

            mdb.jobs.ensure_index(&quot;jid&quot;)

    return conn, mdb


def returner(ret):
    &quot;&quot;&quot;
    Return data to a mongodb server
    &quot;&quot;&quot;
    conn, mdb = _get_conn(ret)
    col = mdb[ret[&quot;id&quot;]]

    if isinstance(ret[&quot;return&quot;], dict):
        back = _remove_dots(ret[&quot;return&quot;])
    else:
        back = ret[&quot;return&quot;]

    if isinstance(ret, dict):
        full_ret = _remove_dots(ret)
    else:
        full_ret = ret

    log.debug(back)
    sdata = {
        &quot;minion&quot;: ret[&quot;id&quot;],
        &quot;jid&quot;: ret[&quot;jid&quot;],
        &quot;return&quot;: back,
        &quot;fun&quot;: ret[&quot;fun&quot;],
        &quot;full_ret&quot;: full_ret,
    }
    if &quot;out&quot; in ret:
        sdata[&quot;out&quot;] = ret[&quot;out&quot;]

    # save returns in the saltReturns collection in the json format:
    # { 'minion': &lt;minion_name&gt;, 'jid': &lt;job_id&gt;, 'return': &lt;return info with dots removed&gt;,
    #  'fun': &lt;function&gt;, 'full_ret': &lt;unformatted return with dots removed&gt;}

    # again we run into the issue with deprecated code from previous versions

    if PYMONGO_VERSION &gt; _LooseVersion(&quot;2.3&quot;):
        # using .copy() to ensure original data for load is unchanged
        mdb.saltReturns.insert_one(sdata.copy())
    else:
        mdb.saltReturns.insert(sdata.copy())


def get_jid(jid):
    &quot;&quot;&quot;
    Return the return information associated with a jid
    &quot;&quot;&quot;
    conn, mdb = _get_conn(ret=None)
    ret = {}
    rdata = mdb.saltReturns.find({&quot;jid&quot;: jid}, {&quot;_id&quot;: 0})
    if rdata:
        for data in rdata:
            minion = data[&quot;minion&quot;]
            # return data in the format {&lt;minion&gt;: { &lt;unformatted full return data&gt;}}
            ret[minion] = data[&quot;full_ret&quot;]
    return ret


def get_fun(fun):
    &quot;&quot;&quot;
    Return the most recent jobs that have executed the named function
    &quot;&quot;&quot;
    conn, mdb = _get_conn(ret=None)
    ret = {}
    rdata = mdb.saltReturns.find_one({&quot;fun&quot;: fun}, {&quot;_id&quot;: 0})
    if rdata:
        ret = rdata
    return ret


def prep_jid(nocache=False, passed_jid=None):  # pylint: disable=unused-argument
    &quot;&quot;&quot;
    Do any work necessary to prepare a JID, including sending a custom id
    &quot;&quot;&quot;
    return passed_jid if passed_jid is not None else salt.utils.jid.gen_jid(__opts__)


def save_minions(jid, minions, syndic_id=None):  # pylint: disable=unused-argument
    &quot;&quot;&quot;
    Included for API consistency
    &quot;&quot;&quot;
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_cron_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
    :codeauthor: Mike Place &lt;mp@saltstack.com&gt;
&quot;&quot;&quot;

import builtins
import io

import salt.modules.cron as cron
from tests.support.mixins import LoaderModuleMockMixin
from tests.support.mock import MagicMock, call, mock_open, patch
from tests.support.unit import TestCase

STUB_USER = &quot;root&quot;
STUB_PATH = &quot;/tmp&quot;

STUB_CRON_TIMESTAMP = {
    &quot;minute&quot;: &quot;1&quot;,
    &quot;hour&quot;: &quot;2&quot;,
    &quot;daymonth&quot;: &quot;3&quot;,
    &quot;month&quot;: &quot;4&quot;,
    &quot;dayweek&quot;: &quot;5&quot;,
}

STUB_SIMPLE_RAW_CRON = &quot;5 0 * * * /tmp/no_script.sh&quot;
STUB_SIMPLE_CRON_DICT = {
    &quot;pre&quot;: [&quot;5 0 * * * /tmp/no_script.sh&quot;],
    &quot;crons&quot;: [],
    &quot;env&quot;: [],
    &quot;special&quot;: [],
}
STUB_CRON_SPACES = &quot;&quot;&quot;
# Lines below here are managed by Salt, do not edit
TEST_VAR=&quot;a string with plenty of spaces&quot;
# SALT_CRON_IDENTIFIER:echo &quot;must  be  double  spaced&quot;
11 * * * * echo &quot;must  be  double  spaced&quot;
&quot;&quot;&quot;
STUB_AT_SIGN = &quot;&quot;&quot;
# Lines below here are managed by Salt, do not edit
# SALT_CRON_IDENTIFIER:echo &quot;cron with @ sign&quot;
@daily echo &quot;cron with @ sign&quot;
@daily
&quot;&quot;&quot;

L = &quot;# Lines below here are managed by Salt, do not edit\n&quot;

CRONTAB = io.StringIO()


def get_crontab(*args, **kw):
    return CRONTAB.getvalue()


def set_crontab(val):
    CRONTAB.seek(0)
    CRONTAB.truncate(0)
    CRONTAB.write(val)


def write_crontab(*args, **kw):
    set_crontab(&quot;\n&quot;.join([a.strip() for a in args[1]]))
    return MagicMock()


class CronTestCase(TestCase, LoaderModuleMockMixin):
    def setup_loader_modules(self):
        return {cron: {}}

    def test__need_changes_new(self):
        &quot;&quot;&quot;
        New behavior, identifier will get track of the managed lines!
        &quot;&quot;&quot;
        with patch(
            &quot;salt.modules.cron.raw_cron&quot;, new=MagicMock(side_effect=get_crontab)
        ), patch(
            &quot;salt.modules.cron._write_cron_lines&quot;,
            new=MagicMock(side_effect=write_crontab),
        ):
            # when there are no identifiers,
            # we do not touch it
            set_crontab(L + &quot;# SALT_CRON_IDENTIFIER:booh\n* * * * * ls\n&quot;)
            cron.set_job(
                user=&quot;root&quot;,
                minute=&quot;*&quot;,
                hour=&quot;*&quot;,
                daymonth=&quot;*&quot;,
                month=&quot;*&quot;,
                dayweek=&quot;*&quot;,
                cmd=&quot;ls&quot;,
                comment=None,
                identifier=None,
            )
            c1 = get_crontab()
            set_crontab(L + &quot;* * * * * ls\n&quot;)
            self.assertEqual(
                c1,
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:booh\n&quot;
                &quot;* * * * * ls\n&quot;
                &quot;* * * * * ls&quot;,
            )
            # whenever we have an identifier, hourray even without comment
            # we can match and edit the crontab in place
            # without cluttering the crontab with new cmds
            set_crontab(L + &quot;# SALT_CRON_IDENTIFIER:bar\n* * * * * ls\n&quot;)
            cron.set_job(
                user=&quot;root&quot;,
                minute=&quot;*&quot;,
                hour=&quot;*&quot;,
                daymonth=&quot;*&quot;,
                month=&quot;*&quot;,
                dayweek=&quot;*&quot;,
                cmd=&quot;ls&quot;,
                comment=None,
                identifier=&quot;bar&quot;,
            )
            c5 = get_crontab()
            set_crontab(L + &quot;* * * * * ls\n&quot;)
            self.assertEqual(
                c5,
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:bar\n&quot;
                &quot;* * * * * ls\n&quot;,
            )
            # we can even change the other parameters as well
            # thx to the id
            set_crontab(L + &quot;# SALT_CRON_IDENTIFIER:bar\n* * * * * ls\n&quot;)
            cron.set_job(
                user=&quot;root&quot;,
                minute=&quot;1&quot;,
                hour=&quot;2&quot;,
                daymonth=&quot;3&quot;,
                month=&quot;4&quot;,
                dayweek=&quot;5&quot;,
                cmd=&quot;foo&quot;,
                comment=&quot;moo&quot;,
                identifier=&quot;bar&quot;,
            )
            c6 = get_crontab()
            self.assertEqual(
                c6,
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# moo SALT_CRON_IDENTIFIER:bar\n&quot;
                &quot;1 2 3 4 5 foo&quot;,
            )

    def test__unicode_match(self):
        with patch.object(builtins, &quot;__salt_system_encoding__&quot;, &quot;utf-8&quot;):
            self.assertTrue(cron._cron_matched({&quot;identifier&quot;: &quot;1&quot;}, &quot;foo&quot;, 1))
            self.assertTrue(cron._cron_matched({&quot;identifier&quot;: &quot;é&quot;}, &quot;foo&quot;, &quot;é&quot;))
            self.assertTrue(cron._cron_matched({&quot;identifier&quot;: &quot;é&quot;}, &quot;foo&quot;, &quot;é&quot;))
            self.assertTrue(cron._cron_matched({&quot;identifier&quot;: &quot;é&quot;}, &quot;foo&quot;, &quot;é&quot;))
            self.assertTrue(cron._cron_matched({&quot;identifier&quot;: &quot;é&quot;}, &quot;foo&quot;, &quot;é&quot;))

    def test__need_changes_old(self):
        &quot;&quot;&quot;
        old behavior; ID has no special action
        - If an id is found, it will be added as a new crontab
          even if there is a cmd that looks like this one
        - no comment, delete the cmd and readd it
        - comment: idem
        &quot;&quot;&quot;
        with patch(
            &quot;salt.modules.cron.raw_cron&quot;, new=MagicMock(side_effect=get_crontab)
        ), patch(
            &quot;salt.modules.cron._write_cron_lines&quot;,
            new=MagicMock(side_effect=write_crontab),
        ):
            set_crontab(L + &quot;* * * * * ls\n\n&quot;)
            cron.set_job(
                user=&quot;root&quot;,
                minute=&quot;*&quot;,
                hour=&quot;*&quot;,
                daymonth=&quot;*&quot;,
                month=&quot;*&quot;,
                dayweek=&quot;*&quot;,
                cmd=&quot;ls&quot;,
                comment=None,
                identifier=cron.SALT_CRON_NO_IDENTIFIER,
            )
            c1 = get_crontab()
            set_crontab(L + &quot;* * * * * ls\n&quot;)
            self.assertEqual(
                c1,
                &quot;# Lines below here are managed by Salt, do not edit\n* * * * * ls\n\n&quot;,
            )
            cron.set_job(
                user=&quot;root&quot;,
                minute=&quot;*&quot;,
                hour=&quot;*&quot;,
                daymonth=&quot;*&quot;,
                month=&quot;*&quot;,
                dayweek=&quot;*&quot;,
                cmd=&quot;ls&quot;,
                comment=&quot;foo&quot;,
                identifier=cron.SALT_CRON_NO_IDENTIFIER,
            )
            c2 = get_crontab()
            self.assertEqual(
                c2,
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# foo\n* * * * * ls&quot;,
            )
            set_crontab(L + &quot;* * * * * ls\n&quot;)
            cron.set_job(
                user=&quot;root&quot;,
                minute=&quot;*&quot;,
                hour=&quot;*&quot;,
                daymonth=&quot;*&quot;,
                month=&quot;*&quot;,
                dayweek=&quot;*&quot;,
                cmd=&quot;lsa&quot;,
                comment=&quot;foo&quot;,
                identifier=&quot;bar&quot;,
            )
            c3 = get_crontab()
            self.assertEqual(
                c3,
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;* * * * * ls\n&quot;
                &quot;# foo SALT_CRON_IDENTIFIER:bar\n&quot;
                &quot;* * * * * lsa&quot;,
            )
            set_crontab(L + &quot;* * * * * ls\n&quot;)
            cron.set_job(
                user=&quot;root&quot;,
                minute=&quot;*&quot;,
                hour=&quot;*&quot;,
                daymonth=&quot;*&quot;,
                month=&quot;*&quot;,
                dayweek=&quot;*&quot;,
                cmd=&quot;foo&quot;,
                comment=&quot;foo&quot;,
                identifier=&quot;bar&quot;,
            )
            c4 = get_crontab()
            self.assertEqual(
                c4,
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;* * * * * ls\n&quot;
                &quot;# foo SALT_CRON_IDENTIFIER:bar\n&quot;
                &quot;* * * * * foo&quot;,
            )
            set_crontab(L + &quot;* * * * * ls\n&quot;)
            cron.set_job(
                user=&quot;root&quot;,
                minute=&quot;*&quot;,
                hour=&quot;*&quot;,
                daymonth=&quot;*&quot;,
                month=&quot;*&quot;,
                dayweek=&quot;*&quot;,
                cmd=&quot;ls&quot;,
                comment=&quot;foo&quot;,
                identifier=&quot;bbar&quot;,
            )
            c4 = get_crontab()
            self.assertEqual(
                c4,
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# foo SALT_CRON_IDENTIFIER:bbar\n&quot;
                &quot;* * * * * ls&quot;,
            )

    def test__issue10959(self):
        &quot;&quot;&quot;
        handle multi old style crontabs
        https://github.com/saltstack/salt/issues/10959
        &quot;&quot;&quot;
        with patch(
            &quot;salt.modules.cron.raw_cron&quot;, new=MagicMock(side_effect=get_crontab)
        ), patch(
            &quot;salt.modules.cron._write_cron_lines&quot;,
            new=MagicMock(side_effect=write_crontab),
        ):
            set_crontab(
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n&quot;
                # as managed per salt, the last lines will be merged together !
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n&quot;
                &quot;* * * * * samecmd\n&quot;
                &quot;* * * * * otheridcmd\n&quot;
                &quot;* * * * * otheridcmd\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n0 * * * * samecmd1\n&quot;
                &quot;1 * * * * samecmd1\n&quot;
                &quot;0 * * * * otheridcmd1\n&quot;
                &quot;1 * * * * otheridcmd1\n&quot;
                # special case here, none id managed line with same command
                # as a later id managed line will become managed
                &quot;# SALT_CRON_IDENTIFIER:1\n0 * * * * otheridcmd1\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:2\n0 * * * * otheridcmd1\n&quot;
            )
            crons1 = cron.list_tab(&quot;root&quot;)
            # the filtering is done on save, we reflect in listing
            # the same that we have in a file, no matter what we
            # have
            self.assertEqual(
                crons1,
                {
                    &quot;crons&quot;: [
                        {
                            &quot;cmd&quot;: &quot;ls&quot;,
                            &quot;comment&quot;: &quot;uoo&quot;,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: &quot;NO ID SET&quot;,
                            &quot;minute&quot;: &quot;*&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;too&quot;,
                            &quot;comment&quot;: &quot;uuoo&quot;,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: &quot;NO ID SET&quot;,
                            &quot;minute&quot;: &quot;*&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;zoo&quot;,
                            &quot;comment&quot;: &quot;uuuoo&quot;,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: &quot;NO ID SET&quot;,
                            &quot;minute&quot;: &quot;*&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;yoo&quot;,
                            &quot;comment&quot;: &quot;&quot;,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: &quot;NO ID SET&quot;,
                            &quot;minute&quot;: &quot;*&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;xoo&quot;,
                            &quot;comment&quot;: &quot;&quot;,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: &quot;NO ID SET&quot;,
                            &quot;minute&quot;: &quot;*&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;samecmd&quot;,
                            &quot;comment&quot;: &quot;&quot;,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: &quot;NO ID SET&quot;,
                            &quot;minute&quot;: &quot;*&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;samecmd&quot;,
                            &quot;comment&quot;: None,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: None,
                            &quot;minute&quot;: &quot;*&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;otheridcmd&quot;,
                            &quot;comment&quot;: None,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: None,
                            &quot;minute&quot;: &quot;*&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;otheridcmd&quot;,
                            &quot;comment&quot;: None,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: None,
                            &quot;minute&quot;: &quot;*&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;samecmd1&quot;,
                            &quot;comment&quot;: &quot;&quot;,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: &quot;NO ID SET&quot;,
                            &quot;minute&quot;: &quot;0&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;samecmd1&quot;,
                            &quot;comment&quot;: None,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: None,
                            &quot;minute&quot;: &quot;1&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;otheridcmd1&quot;,
                            &quot;comment&quot;: None,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: None,
                            &quot;minute&quot;: &quot;0&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;otheridcmd1&quot;,
                            &quot;comment&quot;: None,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: None,
                            &quot;minute&quot;: &quot;1&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;otheridcmd1&quot;,
                            &quot;comment&quot;: &quot;&quot;,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: &quot;1&quot;,
                            &quot;minute&quot;: &quot;0&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                        {
                            &quot;cmd&quot;: &quot;otheridcmd1&quot;,
                            &quot;comment&quot;: &quot;&quot;,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: &quot;2&quot;,
                            &quot;minute&quot;: &quot;0&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                    ],
                    &quot;env&quot;: [],
                    &quot;pre&quot;: [],
                    &quot;special&quot;: [],
                },
            )
            # so yood so far, no problem for now, trying to save the
            # multilines without id crons now
            inc_tests = [
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n&quot;
                &quot;* * * * * otheridcmd&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n&quot;
                &quot;* * * * * otheridcmd&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n&quot;
                &quot;* * * * * otheridcmd\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n&quot;
                &quot;0 * * * * samecmd1&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n&quot;
                &quot;* * * * * otheridcmd\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n&quot;
                &quot;* * * * * otheridcmd\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1\n&quot;
                &quot;0 * * * * otheridcmd1&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n&quot;
                &quot;* * * * * otheridcmd\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1\n&quot;
                &quot;1 * * * * otheridcmd1&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n&quot;
                &quot;* * * * * otheridcmd\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:1\n0 * * * * otheridcmd1&quot;,
                #
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n&quot;
                &quot;# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n&quot;
                &quot;# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n&quot;
                &quot;* * * * * otheridcmd\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:1\n0 * * * * otheridcmd1\n&quot;
                &quot;# SALT_CRON_IDENTIFIER:2\n0 * * * * otheridcmd1&quot;,
            ]
            set_crontab(&quot;&quot;)
            for idx, cr in enumerate(crons1[&quot;crons&quot;]):
                cron.set_job(&quot;root&quot;, **cr)
                self.assertEqual(
                    get_crontab(),
                    inc_tests[idx],
                    (&quot;idx {0}\n'{1}'\n != \n'{2}'\n\n\n'{1}' != '{2}'&quot;).format(
                        idx, get_crontab(), inc_tests[idx]
                    ),
                )

    def test_list_tab_commented_cron_jobs(self):
        &quot;&quot;&quot;
        handle commented cron jobs
        https://github.com/saltstack/salt/issues/29082
        &quot;&quot;&quot;
        with patch(
            &quot;salt.modules.cron.raw_cron&quot;, MagicMock(side_effect=get_crontab)
        ), patch(
            &quot;salt.modules.cron._write_cron_lines&quot;, MagicMock(side_effect=write_crontab)
        ):
            set_crontab(
                &quot;# An unmanaged commented cron job\n&quot;
                &quot;#0 * * * * /bin/true\n&quot;
                &quot;# Lines below here are managed by Salt, do not edit\n&quot;
                &quot;# cron_1 SALT_CRON_IDENTIFIER:cron_1\n#DISABLED#0 * * * * my_cmd_1\n&quot;
                &quot;# cron_2 SALT_CRON_IDENTIFIER:cron_2\n#DISABLED#* * * * * my_cmd_2\n&quot;
                &quot;# cron_3 SALT_CRON_IDENTIFIER:cron_3\n&quot;
                &quot;#DISABLED#but it is a comment line&quot;
                &quot;#DISABLED#0 * * * * my_cmd_3\n&quot;
                &quot;# cron_4 SALT_CRON_IDENTIFIER:cron_4\n0 * * * * my_cmd_4\n&quot;
            )
            crons1 = cron.list_tab(&quot;root&quot;)
            self.assertEqual(
                crons1,
                {
                    &quot;crons&quot;: [
                        {
                            &quot;cmd&quot;: &quot;my_cmd_1&quot;,
                            &quot;comment&quot;: &quot;cron_1&quot;,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: &quot;cron_1&quot;,
                            &quot;minute&quot;: &quot;0&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: True,
                        },
                        {
                            &quot;cmd&quot;: &quot;my_cmd_2&quot;,
                            &quot;comment&quot;: &quot;cron_2&quot;,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: &quot;cron_2&quot;,
                            &quot;minute&quot;: &quot;*&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: True,
                        },
                        {
                            &quot;cmd&quot;: &quot;line#DISABLED#0 * * * * my_cmd_3&quot;,
                            &quot;comment&quot;: &quot;cron_3&quot;,
                            &quot;daymonth&quot;: &quot;is&quot;,
                            &quot;dayweek&quot;: &quot;comment&quot;,
                            &quot;hour&quot;: &quot;it&quot;,
                            &quot;identifier&quot;: &quot;cron_3&quot;,
                            &quot;minute&quot;: &quot;but&quot;,
                            &quot;month&quot;: &quot;a&quot;,
                            &quot;commented&quot;: True,
                        },
                        {
                            &quot;cmd&quot;: &quot;my_cmd_4&quot;,
                            &quot;comment&quot;: &quot;cron_4&quot;,
                            &quot;daymonth&quot;: &quot;*&quot;,
                            &quot;dayweek&quot;: &quot;*&quot;,
                            &quot;hour&quot;: &quot;*&quot;,
                            &quot;identifier&quot;: &quot;cron_4&quot;,
                            &quot;minute&quot;: &quot;0&quot;,
                            &quot;month&quot;: &quot;*&quot;,
                            &quot;commented&quot;: False,
                        },
                    ],
                    &quot;env&quot;: [],
                    &quot;pre&quot;: [
                        &quot;# An unmanaged commented cron job&quot;,
                        &quot;#0 * * * * /bin/true&quot;,
                    ],
                    &quot;special&quot;: [],
                },
            )

    def test_get_entry(self):
        &quot;&quot;&quot;
        test get_entry function
        &quot;&quot;&quot;
        list_tab_output = {
            &quot;crons&quot;: [
                {
                    &quot;cmd&quot;: &quot;my_cmd_1&quot;,
                    &quot;comment&quot;: &quot;cron_1&quot;,
                    &quot;daymonth&quot;: &quot;*&quot;,
                    &quot;dayweek&quot;: &quot;*&quot;,
                    &quot;hour&quot;: &quot;*&quot;,
                    &quot;identifier&quot;: &quot;cron_1&quot;,
                    &quot;minute&quot;: &quot;0&quot;,
                    &quot;month&quot;: &quot;*&quot;,
                    &quot;commented&quot;: True,
                },
                {
                    &quot;cmd&quot;: &quot;my_cmd_2&quot;,
                    &quot;comment&quot;: &quot;cron_2&quot;,
                    &quot;daymonth&quot;: &quot;*&quot;,
                    &quot;dayweek&quot;: &quot;*&quot;,
                    &quot;hour&quot;: &quot;*&quot;,
                    &quot;identifier&quot;: &quot;cron_2&quot;,
                    &quot;minute&quot;: &quot;*&quot;,
                    &quot;month&quot;: &quot;*&quot;,
                    &quot;commented&quot;: True,
                },
                {
                    &quot;cmd&quot;: &quot;line#DISABLED#0 * * * * my_cmd_3&quot;,
                    &quot;comment&quot;: &quot;cron_3&quot;,
                    &quot;daymonth&quot;: &quot;is&quot;,
                    &quot;dayweek&quot;: &quot;comment&quot;,
                    &quot;hour&quot;: &quot;it&quot;,
                    &quot;identifier&quot;: &quot;cron_3&quot;,
                    &quot;minute&quot;: &quot;but&quot;,
                    &quot;month&quot;: &quot;a&quot;,
                    &quot;commented&quot;: True,
                },
                {
                    &quot;cmd&quot;: &quot;my_cmd_4&quot;,
                    &quot;comment&quot;: &quot;cron_4&quot;,
                    &quot;daymonth&quot;: &quot;*&quot;,
                    &quot;dayweek&quot;: &quot;*&quot;,
                    &quot;hour&quot;: &quot;*&quot;,
                    &quot;identifier&quot;: &quot;cron_4&quot;,
                    &quot;minute&quot;: &quot;0&quot;,
                    &quot;month&quot;: &quot;*&quot;,
                    &quot;commented&quot;: False,
                },
            ],
            &quot;env&quot;: [],
            &quot;pre&quot;: [&quot;# An unmanaged commented cron job&quot;, &quot;#0 * * * * /bin/true&quot;],
            &quot;special&quot;: [],
        }
        get_entry_2 = {
            &quot;comment&quot;: &quot;cron_2&quot;,
            &quot;cmd&quot;: &quot;my_cmd_2&quot;,
            &quot;identifier&quot;: &quot;cron_2&quot;,
            &quot;dayweek&quot;: &quot;*&quot;,
            &quot;daymonth&quot;: &quot;*&quot;,
            &quot;hour&quot;: &quot;*&quot;,
            &quot;minute&quot;: &quot;*&quot;,
            &quot;month&quot;: &quot;*&quot;,
            &quot;commented&quot;: True,
        }
        get_entry_3 = {
            &quot;comment&quot;: &quot;cron_3&quot;,
            &quot;identifier&quot;: &quot;cron_3&quot;,
            &quot;dayweek&quot;: &quot;comment&quot;,
            &quot;hour&quot;: &quot;it&quot;,
            &quot;cmd&quot;: &quot;line#DISABLED#0 * * * * my_cmd_3&quot;,
            &quot;daymonth&quot;: &quot;is&quot;,
            &quot;commented&quot;: True,
            &quot;minute&quot;: &quot;but&quot;,
            &quot;month&quot;: &quot;a&quot;,
        }
        with patch(
<A NAME="0"></A>            &quot;salt.modules.cron.list_tab&quot;, new=MagicMock(return_value=list_tab_output)
        ):
            # Test get_entry identifier
            get_entry_output <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match162270-0.html#0',2,'match162270-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= cron.get_entry(&quot;root&quot;, identifier=&quot;cron_3&quot;)
            self.assertDictEqual(get_entry_output, get_entry_3)
            # Test get_entry cmd
            get_entry_output = cron.get_entry(&quot;root&quot;, cmd=&quot;my_cmd_2&quot;)
            self.assertDictEqual(get_entry_output, get_entry_2)
            # Test identifier wins when both specified
            get_entry_output = cron.get_entry(
                &quot;root&quot;, identifier=</B></FONT>&quot;cron_3&quot;, cmd=&quot;my_cmd_2&quot;
            )
            self.assertDictEqual(get_entry_output, get_entry_3)

    def test_cron_extra_spaces(self):
        &quot;&quot;&quot;
        Issue #38449
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os&quot;: None}), patch(
            &quot;salt.modules.cron.raw_cron&quot;, MagicMock(return_value=STUB_CRON_SPACES)
        ):
            ret = cron.list_tab(&quot;root&quot;)
            eret = {
                &quot;crons&quot;: [
                    {
                        &quot;cmd&quot;: 'echo &quot;must  be  double  spaced&quot;',
                        &quot;comment&quot;: &quot;&quot;,
                        &quot;commented&quot;: False,
                        &quot;daymonth&quot;: &quot;*&quot;,
                        &quot;dayweek&quot;: &quot;*&quot;,
                        &quot;hour&quot;: &quot;*&quot;,
                        &quot;identifier&quot;: 'echo &quot;must  be  double  spaced&quot;',
                        &quot;minute&quot;: &quot;11&quot;,
                        &quot;month&quot;: &quot;*&quot;,
                    }
                ],
                &quot;env&quot;: [
                    {&quot;name&quot;: &quot;TEST_VAR&quot;, &quot;value&quot;: '&quot;a string with plenty of spaces&quot;'}
                ],
                &quot;pre&quot;: [&quot;&quot;],
                &quot;special&quot;: [],
            }
            self.assertEqual(eret, ret)

    def test_cron_at_sign(self):
        with patch.dict(cron.__grains__, {&quot;os&quot;: None}), patch(
            &quot;salt.modules.cron.raw_cron&quot;, MagicMock(return_value=STUB_AT_SIGN)
        ):
            ret = cron.list_tab(&quot;root&quot;)
            eret = {
                &quot;crons&quot;: [],
                &quot;env&quot;: [],
                &quot;pre&quot;: [&quot;&quot;],
                &quot;special&quot;: [
                    {
                        &quot;cmd&quot;: 'echo &quot;cron with @ sign&quot;',
                        &quot;comment&quot;: &quot;&quot;,
                        &quot;commented&quot;: False,
                        &quot;identifier&quot;: 'echo &quot;cron with @ sign&quot;',
                        &quot;spec&quot;: &quot;@daily&quot;,
                    }
                ],
            }
            self.assertDictEqual(eret, ret)

    def test__load_tab(self):
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;Solaris&quot;}), patch(
            &quot;salt.modules.cron.raw_cron&quot;,
            new=MagicMock(
                side_effect=[
                    (L + &quot;\n&quot;),
                    (L + &quot;* * * * * ls\nn&quot;),
                    (L + &quot;# commented\n#DISABLED#* * * * * ls\n&quot;),
                    (L + &quot;# foo\n* * * * * ls\n&quot;),
                    (
                        L
                        + &quot;# foo {}:blah\n&quot;.format(cron.SALT_CRON_IDENTIFIER)
                        + &quot;* * * * * ls\n&quot;
                    ),
                ]
            ),
        ):
            crons1 = cron.list_tab(&quot;root&quot;)
            crons2 = cron.list_tab(&quot;root&quot;)
            crons3 = cron.list_tab(&quot;root&quot;)
            crons4 = cron.list_tab(&quot;root&quot;)
            crons5 = cron.list_tab(&quot;root&quot;)
            self.assertEqual(crons1, {&quot;pre&quot;: [], &quot;crons&quot;: [], &quot;env&quot;: [], &quot;special&quot;: []})
            self.assertEqual(
                crons2[&quot;crons&quot;][0],
                {
                    &quot;comment&quot;: None,
                    &quot;commented&quot;: False,
                    &quot;dayweek&quot;: &quot;*&quot;,
                    &quot;hour&quot;: &quot;*&quot;,
                    &quot;identifier&quot;: None,
                    &quot;cmd&quot;: &quot;ls&quot;,
                    &quot;daymonth&quot;: &quot;*&quot;,
                    &quot;minute&quot;: &quot;*&quot;,
                    &quot;month&quot;: &quot;*&quot;,
                },
            )
            self.assertEqual(
                crons3[&quot;crons&quot;][0],
                {
                    &quot;comment&quot;: &quot;commented&quot;,
                    &quot;commented&quot;: True,
                    &quot;dayweek&quot;: &quot;*&quot;,
                    &quot;hour&quot;: &quot;*&quot;,
                    &quot;identifier&quot;: None,
                    &quot;cmd&quot;: &quot;ls&quot;,
                    &quot;daymonth&quot;: &quot;*&quot;,
                    &quot;minute&quot;: &quot;*&quot;,
                    &quot;month&quot;: &quot;*&quot;,
                },
            )
            self.assertEqual(
                crons4[&quot;crons&quot;][0],
                {
                    &quot;comment&quot;: &quot;foo&quot;,
                    &quot;commented&quot;: False,
                    &quot;dayweek&quot;: &quot;*&quot;,
                    &quot;hour&quot;: &quot;*&quot;,
                    &quot;identifier&quot;: None,
                    &quot;cmd&quot;: &quot;ls&quot;,
                    &quot;daymonth&quot;: &quot;*&quot;,
                    &quot;minute&quot;: &quot;*&quot;,
                    &quot;month&quot;: &quot;*&quot;,
                },
            )
            self.assertEqual(
                crons5[&quot;crons&quot;][0],
                {
                    &quot;comment&quot;: &quot;foo&quot;,
                    &quot;commented&quot;: False,
                    &quot;dayweek&quot;: &quot;*&quot;,
                    &quot;hour&quot;: &quot;*&quot;,
                    &quot;identifier&quot;: &quot;blah&quot;,
                    &quot;cmd&quot;: &quot;ls&quot;,
                    &quot;daymonth&quot;: &quot;*&quot;,
                    &quot;minute&quot;: &quot;*&quot;,
                    &quot;month&quot;: &quot;*&quot;,
                },
            )

    def test_write_cron_file_root_rh(self):
        &quot;&quot;&quot;
        Assert that write_cron_file() is called with the correct cron command and user: RedHat
          - If instance running uid matches crontab user uid, run without -u flag.
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;RedHat&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.retcode&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;,
            new=MagicMock(return_value=True),
        ):
            cron.write_cron_file(STUB_USER, STUB_PATH)
            cron.__salt__[&quot;cmd.retcode&quot;].assert_called_with(
                &quot;crontab /tmp&quot;, python_shell=False
            )

    def test_write_cron_file_foo_rh(self):
        &quot;&quot;&quot;
        Assert that write_cron_file() is called with the correct cron command and user: RedHat
          - If instance running with uid that doesn't match crontab user uid, runas foo
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;RedHat&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.retcode&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;, MagicMock(return_value=False)
        ):
            cron.write_cron_file(&quot;foo&quot;, STUB_PATH)
            cron.__salt__[&quot;cmd.retcode&quot;].assert_called_with(
                &quot;crontab /tmp&quot;, runas=&quot;foo&quot;, python_shell=False
            )

    def test_write_cron_file_root_sol(self):
        &quot;&quot;&quot;
        Assert that write_cron_file() is called with the correct cron command and user: Solaris
          - Solaris should always run without a -u flag
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;Solaris&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.retcode&quot;: MagicMock()}
        ):
            cron.write_cron_file(STUB_USER, STUB_PATH)
            cron.__salt__[&quot;cmd.retcode&quot;].assert_called_with(
                &quot;crontab /tmp&quot;, runas=STUB_USER, python_shell=False
            )

    def test_write_cron_file_foo_sol(self):
        &quot;&quot;&quot;
        Assert that write_cron_file() is called with the correct cron command and user: Solaris
          - Solaris should always run without a -u flag
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;Solaris&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.retcode&quot;: MagicMock()}
        ):
            cron.write_cron_file(&quot;foo&quot;, STUB_PATH)
            cron.__salt__[&quot;cmd.retcode&quot;].assert_called_with(
                &quot;crontab /tmp&quot;, runas=&quot;foo&quot;, python_shell=False
            )

    def test_write_cron_file_root_aix(self):
        &quot;&quot;&quot;
        Assert that write_cron_file() is called with the correct cron command and user: AIX
          - AIX should always run without a -u flag
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;AIX&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.retcode&quot;: MagicMock()}
        ):
            cron.write_cron_file(STUB_USER, STUB_PATH)
            cron.__salt__[&quot;cmd.retcode&quot;].assert_called_with(
                &quot;crontab /tmp&quot;, runas=STUB_USER, python_shell=False
            )

    def test_write_cron_file_foo_aix(self):
        &quot;&quot;&quot;
        Assert that write_cron_file() is called with the correct cron command and user: AIX
          - AIX should always run without a -u flag
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;AIX&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.retcode&quot;: MagicMock()}
        ):
            cron.write_cron_file(&quot;foo&quot;, STUB_PATH)
            cron.__salt__[&quot;cmd.retcode&quot;].assert_called_with(
                &quot;crontab /tmp&quot;, runas=&quot;foo&quot;, python_shell=False
            )

    def test_write_cr_file_v_root_rh(self):
        &quot;&quot;&quot;
        Assert that write_cron_file_verbose() is called with the correct cron command and user: RedHat
          - If instance running uid matches crontab user uid, run without -u flag.
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;Redhat&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_all&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;, MagicMock(return_value=True)
        ):
            cron.write_cron_file_verbose(STUB_USER, STUB_PATH)
            cron.__salt__[&quot;cmd.run_all&quot;].assert_called_with(
                &quot;crontab /tmp&quot;, python_shell=False
            )

    def test_write_cr_file_v_foo_rh(self):
        &quot;&quot;&quot;
        Assert that write_cron_file_verbose() is called with the correct cron command and user: RedHat
          - If instance running with uid that doesn't match crontab user uid, runas 'foo'
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;Redhat&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_all&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;, MagicMock(return_value=False)
        ):
            cron.write_cron_file_verbose(&quot;foo&quot;, STUB_PATH)
            cron.__salt__[&quot;cmd.run_all&quot;].assert_called_with(
                &quot;crontab /tmp&quot;, runas=&quot;foo&quot;, python_shell=False
            )

    def test_write_cr_file_v_root_sol(self):
        &quot;&quot;&quot;
        Assert that write_cron_file_verbose() is called with the correct cron command and user: Solaris
          - Solaris should always run without a -u flag
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;Solaris&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_all&quot;: MagicMock()}
        ):
            cron.write_cron_file_verbose(STUB_USER, STUB_PATH)
            cron.__salt__[&quot;cmd.run_all&quot;].assert_called_with(
                &quot;crontab /tmp&quot;, runas=STUB_USER, python_shell=False
            )

    def test_write_cr_file_v_foo_sol(self):
        &quot;&quot;&quot;
        Assert that write_cron_file_verbose() is called with the correct cron command and user: Solaris
          - Solaris should always run without a -u flag
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;Solaris&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_all&quot;: MagicMock()}
        ):
            cron.write_cron_file_verbose(&quot;foo&quot;, STUB_PATH)
            cron.__salt__[&quot;cmd.run_all&quot;].assert_called_with(
                &quot;crontab /tmp&quot;, runas=&quot;foo&quot;, python_shell=False
            )

    def test_write_cr_file_v_root_aix(self):
        &quot;&quot;&quot;
        Assert that write_cron_file_verbose() is called with the correct cron command and user: AIX
          - AIX should always run without a -u flag
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;AIX&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_all&quot;: MagicMock()}
        ):
            cron.write_cron_file_verbose(STUB_USER, STUB_PATH)
            cron.__salt__[&quot;cmd.run_all&quot;].assert_called_with(
                &quot;crontab /tmp&quot;, runas=STUB_USER, python_shell=False
            )

    def test_write_cr_file_v_foo_aix(self):
        &quot;&quot;&quot;
        Assert that write_cron_file_verbose() is called with the correct cron command and user: AIX
          - AIX should always run without a -u flag
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;AIX&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_all&quot;: MagicMock()}
        ):
            cron.write_cron_file_verbose(&quot;foo&quot;, STUB_PATH)
            cron.__salt__[&quot;cmd.run_all&quot;].assert_called_with(
                &quot;crontab /tmp&quot;, runas=&quot;foo&quot;, python_shell=False
            )

    def test_raw_cron_root_redhat(self):
        &quot;&quot;&quot;
        Assert that raw_cron() is called with the correct cron command and user: RedHat
          - If instance running uid matches crontab user uid, runas STUB_USER without -u flag.
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;Redhat&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_stdout&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;, MagicMock(return_value=True)
        ):
            cron.raw_cron(STUB_USER)
            cron.__salt__[&quot;cmd.run_stdout&quot;].assert_called_with(
                &quot;crontab -l&quot;, ignore_retcode=True, rstrip=False, python_shell=False
            )

    def test_raw_cron_foo_redhat(self):
        &quot;&quot;&quot;
        Assert that raw_cron() is called with the correct cron command and user: RedHat
          - If instance running with uid that doesn't match crontab user uid, run with -u flag
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;Redhat&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_stdout&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;, MagicMock(return_value=False)
        ):
            cron.raw_cron(STUB_USER)
            cron.__salt__[&quot;cmd.run_stdout&quot;].assert_called_with(
                &quot;crontab -l&quot;,
                runas=STUB_USER,
                ignore_retcode=True,
                rstrip=False,
                python_shell=False,
            )

    def test_raw_cron_root_solaris(self):
        &quot;&quot;&quot;
        Assert that raw_cron() is called with the correct cron command and user: Solaris
          - Solaris should always run without a -u flag
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;Solaris&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_stdout&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;, MagicMock(return_value=True)
        ):
            cron.raw_cron(STUB_USER)
            cron.__salt__[&quot;cmd.run_stdout&quot;].assert_called_with(
                &quot;crontab -l&quot;,
                runas=STUB_USER,
                ignore_retcode=True,
                rstrip=False,
                python_shell=False,
            )

    def test_raw_cron_foo_solaris(self):
        &quot;&quot;&quot;
        Assert that raw_cron() is called with the correct cron command and user: Solaris
          - Solaris should always run without a -u flag
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;Solaris&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_stdout&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;, MagicMock(return_value=False)
        ):
            cron.raw_cron(STUB_USER)
            cron.__salt__[&quot;cmd.run_stdout&quot;].assert_called_with(
                &quot;crontab -l&quot;,
                runas=STUB_USER,
                ignore_retcode=True,
                rstrip=False,
                python_shell=False,
            )

    def test_raw_cron_root_aix(self):
        &quot;&quot;&quot;
        Assert that raw_cron() is called with the correct cron command and user: AIX
          - AIX should always run without a -u flag
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;AIX&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_stdout&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;, MagicMock(return_value=True)
        ):
            cron.raw_cron(STUB_USER)
            cron.__salt__[&quot;cmd.run_stdout&quot;].assert_called_with(
                &quot;crontab -l&quot;,
                runas=STUB_USER,
                ignore_retcode=True,
                rstrip=False,
                python_shell=False,
            )

    def test_raw_cron_foo_aix(self):
        &quot;&quot;&quot;
        Assert that raw_cron() is called with the correct cron command and user: AIX
          - AIX should always run without a -u flag
        &quot;&quot;&quot;
        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;AIX&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_stdout&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;, MagicMock(return_value=False)
        ):
            cron.raw_cron(STUB_USER)
            cron.__salt__[&quot;cmd.run_stdout&quot;].assert_called_with(
                &quot;crontab -l&quot;,
                runas=STUB_USER,
                ignore_retcode=True,
                rstrip=False,
                python_shell=False,
            )


class PsTestCase(TestCase, LoaderModuleMockMixin):
    def setup_loader_modules(self):
        return {cron: {}}

    def test__needs_change(self):
        self.assertTrue(cron._needs_change(True, False))

    def test__needs_change_random(self):
        &quot;&quot;&quot;
        Assert that if the new var is 'random' and old is '* that we return True
        &quot;&quot;&quot;
        self.assertTrue(cron._needs_change(&quot;*&quot;, &quot;random&quot;))

    ## Still trying to figure this one out.
    # def test__render_tab(self):
    #     pass
    def test__get_cron_cmdstr(self):
        self.assertEqual(&quot;crontab /tmp&quot;, cron._get_cron_cmdstr(STUB_PATH))

    # Test get_cron_cmdstr() when user is added
    def test__get_cron_cmdstr_user(self):
        &quot;&quot;&quot;
        Passes if a user is added to crontab command
        &quot;&quot;&quot;
        self.assertEqual(
            &quot;crontab -u root /tmp&quot;, cron._get_cron_cmdstr(STUB_PATH, STUB_USER)
        )

    def test__date_time_match(self):
        &quot;&quot;&quot;
        Passes if a match is found on all elements. Note the conversions to strings here!
        :return:
        &quot;&quot;&quot;
        self.assertTrue(
            cron._date_time_match(
                STUB_CRON_TIMESTAMP,
                minute=STUB_CRON_TIMESTAMP[&quot;minute&quot;],
                hour=STUB_CRON_TIMESTAMP[&quot;hour&quot;],
                daymonth=STUB_CRON_TIMESTAMP[&quot;daymonth&quot;],
                dayweek=STUB_CRON_TIMESTAMP[&quot;dayweek&quot;],
            )
        )

    def test_list_tab(self):
        with patch(
            &quot;salt.modules.cron.raw_cron&quot;,
            new=MagicMock(return_value=STUB_SIMPLE_RAW_CRON),
        ):
            self.assertDictEqual(STUB_SIMPLE_CRON_DICT, cron.list_tab(&quot;DUMMY_USER&quot;))

    def test_set_special(self):
        with patch(
            &quot;salt.modules.cron._write_cron_lines&quot;
        ) as write_cron_lines_mock, patch(
            &quot;salt.modules.cron.list_tab&quot;,
            new=MagicMock(return_value=STUB_SIMPLE_CRON_DICT),
        ):
            expected_write_call = call(
                &quot;DUMMY_USER&quot;,
                [
                    &quot;5 0 * * * /tmp/no_script.sh\n&quot;,
                    &quot;# Lines below here are managed by Salt, do not edit\n&quot;,
                    &quot;@hourly echo Hi!\n&quot;,
                ],
            )
            ret = cron.set_special(&quot;DUMMY_USER&quot;, &quot;@hourly&quot;, &quot;echo Hi!&quot;)
            write_cron_lines_mock.assert_has_calls(
                (expected_write_call,), any_order=True
            )

    def test__get_cron_date_time(self):
        ret = cron._get_cron_date_time(
            minute=STUB_CRON_TIMESTAMP[&quot;minute&quot;],
            hour=STUB_CRON_TIMESTAMP[&quot;hour&quot;],
            daymonth=STUB_CRON_TIMESTAMP[&quot;daymonth&quot;],
            dayweek=STUB_CRON_TIMESTAMP[&quot;dayweek&quot;],
            month=STUB_CRON_TIMESTAMP[&quot;month&quot;],
        )
        self.assertDictEqual(ret, STUB_CRON_TIMESTAMP)

    def test__get_cron_date_time_daymonth_max(self):
        ret = cron._get_cron_date_time(
            minute=&quot;random&quot;,
            hour=&quot;random&quot;,
            daymonth=&quot;random&quot;,
            dayweek=&quot;random&quot;,
            month=&quot;random&quot;,
        )
        self.assertTrue(int(ret[&quot;minute&quot;]) in range(0, 60))
        self.assertTrue(int(ret[&quot;hour&quot;]) in range(0, 24))
        self.assertTrue(int(ret[&quot;daymonth&quot;]) in range(1, 32))
        self.assertTrue(int(ret[&quot;dayweek&quot;]) in range(0, 8))
        self.assertTrue(int(ret[&quot;month&quot;]) in range(1, 13))

    def test_set_job(self):
        with patch.dict(cron.__grains__, {&quot;os&quot;: None}), patch(
            &quot;salt.modules.cron._write_cron_lines&quot;,
            new=MagicMock(return_value={&quot;retcode&quot;: False}),
        ), patch(
            &quot;salt.modules.cron.raw_cron&quot;,
            new=MagicMock(return_value=STUB_SIMPLE_RAW_CRON),
        ):
            cron.set_job(
                &quot;DUMMY_USER&quot;,
                1,
                2,
                3,
                4,
                5,
                &quot;/bin/echo NOT A DROID&quot;,
                &quot;WERE YOU LOOKING FOR ME?&quot;,
            )
            expected_call = call(
                &quot;DUMMY_USER&quot;,
                [
                    &quot;5 0 * * * /tmp/no_script.sh\n&quot;,
                    &quot;# Lines below here are managed by Salt, do not edit\n&quot;,
                    &quot;# WERE YOU LOOKING FOR ME?\n&quot;,
                    &quot;1 2 3 4 5 /bin/echo NOT A DROID\n&quot;,
                ],
            )
            cron._write_cron_lines.call_args.assert_called_with(expected_call)

    def test_rm_special(self):
        with patch.dict(cron.__grains__, {&quot;os&quot;: None}), patch(
            &quot;salt.modules.cron._write_cron_lines&quot;,
            new=MagicMock(return_value={&quot;retcode&quot;: False}),
        ), patch(
            &quot;salt.modules.cron.raw_cron&quot;, new=MagicMock(return_value=STUB_AT_SIGN)
        ):
            ret = cron.rm_special(
                &quot;root&quot;,
                'echo &quot;cron with @ sign&quot;',
                special=&quot;@daily&quot;,
                identifier='echo &quot;cron with @ sign&quot;',
            )
            self.assertEqual(&quot;removed&quot;, ret)

    def test_rm_special_default_special(self):
        with patch.dict(cron.__grains__, {&quot;os&quot;: None}), patch(
            &quot;salt.modules.cron._write_cron_lines&quot;,
            new=MagicMock(return_value={&quot;retcode&quot;: False}),
        ), patch(
            &quot;salt.modules.cron.raw_cron&quot;, new=MagicMock(return_value=STUB_AT_SIGN)
        ):
            ret = cron.rm_special(
                &quot;root&quot;, 'echo &quot;cron with @ sign&quot;', identifier='echo &quot;cron with @ sign&quot;'
            )
            self.assertEqual(&quot;removed&quot;, ret)

    def test_rm_special_absent(self):
        with patch.dict(cron.__grains__, {&quot;os&quot;: None}), patch(
            &quot;salt.modules.cron._write_cron_lines&quot;,
            new=MagicMock(return_value={&quot;retcode&quot;: False}),
        ), patch(
            &quot;salt.modules.cron.raw_cron&quot;, new=MagicMock(return_value=STUB_AT_SIGN)
        ):
            ret = cron.rm_special(
                &quot;root&quot;, 'echo &quot;there is no job&quot;', identifier='echo &quot;there is no job&quot;'
            )
            self.assertEqual(&quot;absent&quot;, ret)

    def test_rm_job_is_absent(self):
        with patch.dict(cron.__grains__, {&quot;os&quot;: None}), patch(
            &quot;salt.modules.cron._write_cron_lines&quot;,
            new=MagicMock(return_value={&quot;retcode&quot;: False}),
        ), patch(
            &quot;salt.modules.cron.raw_cron&quot;,
            new=MagicMock(return_value=STUB_SIMPLE_RAW_CRON),
        ):
            ret = cron.rm_job(&quot;DUMMY_USER&quot;, &quot;/bin/echo NOT A DROID&quot;, 1, 2, 3, 4, 5)
            self.assertEqual(&quot;absent&quot;, ret)

    def test_write_cron_lines_root_rh(self):
        &quot;&quot;&quot;
        Assert that _write_cron_lines() is called with the correct cron command and user
        OS: RedHat. User: root. Expected to run with runas argument.
        &quot;&quot;&quot;
        temp_path = &quot;some_temp_path&quot;
        crontab_cmd = &quot;crontab {}&quot;.format(temp_path)

        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;RedHat&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_all&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;,
            new=MagicMock(return_value=True),
        ), patch(
            &quot;salt.utils.files.fpopen&quot;, mock_open()
        ), patch.dict(
            cron.__salt__, {&quot;file.user_to_uid&quot;: MagicMock(return_value=1)}
        ), patch(
            &quot;salt.utils.files.mkstemp&quot;, MagicMock(return_value=temp_path)
        ), patch(
            &quot;os.remove&quot;, MagicMock()
        ):
            cron._write_cron_lines(&quot;root&quot;, &quot;test 123&quot;)
            cron.__salt__[&quot;cmd.run_all&quot;].assert_called_with(
                crontab_cmd, python_shell=False, runas=&quot;root&quot;
            )

    def test_write_cron_lines_non_root_rh(self):
        &quot;&quot;&quot;
        Assert that _write_cron_lines() is called with the correct cron command and user
        OS: RedHat. User: non-root. Expected to run without runas argument.
        &quot;&quot;&quot;
        temp_path = &quot;some_temp_path&quot;
        crontab_cmd = &quot;crontab {}&quot;.format(temp_path)

        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;RedHat&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_all&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;,
            new=MagicMock(return_value=False),
        ), patch(
            &quot;salt.utils.files.fpopen&quot;, mock_open()
        ), patch.dict(
            cron.__salt__, {&quot;file.user_to_uid&quot;: MagicMock(return_value=1)}
        ), patch(
            &quot;salt.utils.files.mkstemp&quot;, MagicMock(return_value=temp_path)
        ), patch(
            &quot;os.remove&quot;, MagicMock()
        ):
            cron._write_cron_lines(&quot;non-root&quot;, &quot;test 123&quot;)
            cron.__salt__[&quot;cmd.run_all&quot;].assert_called_with(
                crontab_cmd, python_shell=False
            )

    def test_write_cron_lines_non_root_aix(self):
        &quot;&quot;&quot;
        Assert that _write_cron_lines() is called with the correct cron command and user
        OS: AIX. User: non-root. Expected to run with runas argument.
        &quot;&quot;&quot;
        temp_path = &quot;some_temp_path&quot;
        crontab_cmd = &quot;crontab {}&quot;.format(temp_path)

        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;AIX&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_all&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;,
            new=MagicMock(return_value=False),
        ), patch(
            &quot;salt.utils.files.fpopen&quot;, mock_open()
        ), patch.dict(
            cron.__salt__, {&quot;file.user_to_uid&quot;: MagicMock(return_value=1)}
        ), patch(
            &quot;salt.utils.files.mkstemp&quot;, MagicMock(return_value=temp_path)
        ), patch(
            &quot;os.remove&quot;, MagicMock()
        ):
            cron._write_cron_lines(&quot;non-root&quot;, &quot;test 123&quot;)
            cron.__salt__[&quot;cmd.run_all&quot;].assert_called_with(
                crontab_cmd, python_shell=False, runas=&quot;non-root&quot;
            )

    def test_write_cron_lines_non_root_solaris(self):
        &quot;&quot;&quot;
        Assert that _write_cron_lines() is called with the correct cron command and user
        OS: Solaris. User: non-root. Expected to run with runas argument.
        &quot;&quot;&quot;
        temp_path = &quot;some_temp_path&quot;
        crontab_cmd = &quot;crontab {}&quot;.format(temp_path)

        with patch.dict(cron.__grains__, {&quot;os_family&quot;: &quot;AIX&quot;}), patch.dict(
            cron.__salt__, {&quot;cmd.run_all&quot;: MagicMock()}
        ), patch(
            &quot;salt.modules.cron._check_instance_uid_match&quot;,
            new=MagicMock(return_value=False),
        ), patch(
            &quot;salt.utils.files.fpopen&quot;, mock_open()
        ), patch.dict(
            cron.__salt__, {&quot;file.user_to_uid&quot;: MagicMock(return_value=1)}
        ), patch(
            &quot;salt.utils.files.mkstemp&quot;, MagicMock(return_value=temp_path)
        ), patch(
            &quot;os.remove&quot;, MagicMock()
        ):
            cron._write_cron_lines(&quot;non-root&quot;, &quot;test 123&quot;)
            cron.__salt__[&quot;cmd.run_all&quot;].assert_called_with(
                crontab_cmd, python_shell=False, runas=&quot;non-root&quot;
            )
</PRE>
</div>
  </div>
</body>
</html>
