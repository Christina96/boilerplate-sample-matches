<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for mongo_return.py &amp; test_cron_1.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for mongo_return.py &amp; test_cron_1.py
      </h3>
<h1 align="center">
        2.1%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>mongo_return.py (7.6555023%)<th>test_cron_1.py (1.254902%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(128-133)<td><a href="#" name="0">(774-781)</a><td align="center"><font color="#ff0000">16</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>mongo_return.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import salt.returners
3 import salt.utils.jid
4 from salt.utils.versions import LooseVersion as _LooseVersion
5 try:
6     import pymongo
7     PYMONGO_VERSION = _LooseVersion(pymongo.version)
8     HAS_PYMONGO = True
9 except ImportError:
10     HAS_PYMONGO = False
11 log = logging.getLogger(__name__)
12 __virtualname__ = "mongo"
13 def __virtual__():
14     if not HAS_PYMONGO:
15         return False, "Could not import mongo returner; pymongo is not installed."
16     return "mongo_return"
17 def _remove_dots(src):
18     output = {}
19     for key, val in src.items():
20         if isinstance(val, dict):
21             val = _remove_dots(val)
22         output[key.replace(".", "-")] = val
23     return output
24 def _get_options(ret):
25     attrs = {
26         "host": "host",
27         "port": "port",
28         "db": "db",
29         "user": "user",
30         "password": "password",
31         "indexes": "indexes",
32     }
33     _options = salt.returners.get_returner_options(
34         __virtualname__, ret, attrs, __salt__=__salt__, __opts__=__opts__
35     )
36     return _options
37 def _get_conn(ret):
38     host <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= _options.get("host")
39     port = _options.get("port")
40     db_ = _options.get("db")
41     user = _options.get("user")
42     password = _options.get("password")
43     indexes =</b></font> _options.get("indexes", False)
44     if PYMONGO_VERSION &gt; _LooseVersion("2.3"):
45         conn = pymongo.MongoClient(host, port)
46     else:
47         conn = pymongo.Connection(host, port)
48     mdb = conn[db_]
49     if user and password:
50         mdb.authenticate(user, password)
51     if indexes:
52         if PYMONGO_VERSION &gt; _LooseVersion("2.3"):
53             mdb.saltReturns.create_index("minion")
54             mdb.saltReturns.create_index("jid")
55             mdb.jobs.create_index("jid")
56         else:
57             mdb.saltReturns.ensure_index("minion")
58             mdb.saltReturns.ensure_index("jid")
59             mdb.jobs.ensure_index("jid")
60     return conn, mdb
61 def returner(ret):
62     conn, mdb = _get_conn(ret)
63     col = mdb[ret["id"]]
64     if isinstance(ret["return"], dict):
65         back = _remove_dots(ret["return"])
66     else:
67         back = ret["return"]
68     if isinstance(ret, dict):
69         full_ret = _remove_dots(ret)
70     else:
71         full_ret = ret
72     log.debug(back)
73     sdata = {
74         "minion": ret["id"],
75         "jid": ret["jid"],
76         "return": back,
77         "fun": ret["fun"],
78         "full_ret": full_ret,
79     }
80     if "out" in ret:
81         sdata["out"] = ret["out"]
82     if PYMONGO_VERSION &gt; _LooseVersion("2.3"):
83         mdb.saltReturns.insert_one(sdata.copy())
84     else:
85         mdb.saltReturns.insert(sdata.copy())
86 def get_jid(jid):
87     conn, mdb = _get_conn(ret=None)
88     ret = {}
89     rdata = mdb.saltReturns.find({"jid": jid}, {"_id": 0})
90     if rdata:
91         for data in rdata:
92             minion = data["minion"]
93             ret[minion] = data["full_ret"]
94     return ret
95 def get_fun(fun):
96     conn, mdb = _get_conn(ret=None)
97     ret = {}
98     rdata = mdb.saltReturns.find_one({"fun": fun}, {"_id": 0})
99     if rdata:
100         ret = rdata
101     return ret
102 def prep_jid(nocache=False, passed_jid=None):  # pylint: disable=unused-argument
103     return passed_jid if passed_jid is not None else salt.utils.jid.gen_jid(__opts__)
104 def save_minions(jid, minions, syndic_id=None):  # pylint: disable=unused-argument
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>test_cron_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import builtins
2 import io
3 import salt.modules.cron as cron
4 from tests.support.mixins import LoaderModuleMockMixin
5 from tests.support.mock import MagicMock, call, mock_open, patch
6 from tests.support.unit import TestCase
7 STUB_USER = "root"
8 STUB_PATH = "/tmp"
9 STUB_CRON_TIMESTAMP = {
10     "minute": "1",
11     "hour": "2",
12     "daymonth": "3",
13     "month": "4",
14     "dayweek": "5",
15 }
16 STUB_SIMPLE_RAW_CRON = "5 0 * * * /tmp/no_script.sh"
17 STUB_SIMPLE_CRON_DICT = {
18     "pre": ["5 0 * * * /tmp/no_script.sh"],
19     "crons": [],
20     "env": [],
21     "special": [],
22 }
23 STUB_CRON_SPACES = """
24 TEST_VAR="a string with plenty of spaces"
25 11 * * * * echo "must  be  double  spaced"
26 L = "# Lines below here are managed by Salt, do not edit\n"
27 CRONTAB = io.StringIO()
28 def get_crontab(*args, **kw):
29     return CRONTAB.getvalue()
30 def set_crontab(val):
31     CRONTAB.seek(0)
32     CRONTAB.truncate(0)
33     CRONTAB.write(val)
34 def write_crontab(*args, **kw):
35     set_crontab("\n".join([a.strip() for a in args[1]]))
36     return MagicMock()
37 class CronTestCase(TestCase, LoaderModuleMockMixin):
38     def setup_loader_modules(self):
39         return {cron: {}}
40     def test__need_changes_new(self):
41         with patch(
42             "salt.modules.cron.raw_cron", new=MagicMock(side_effect=get_crontab)
43         ), patch(
44             "salt.modules.cron._write_cron_lines",
45             new=MagicMock(side_effect=write_crontab),
46         ):
47             set_crontab(L + "# SALT_CRON_IDENTIFIER:booh\n* * * * * ls\n")
48             cron.set_job(
49                 user="root",
50                 minute="*",
51                 hour="*",
52                 daymonth="*",
53                 month="*",
54                 dayweek="*",
55                 cmd="ls",
56                 comment=None,
57                 identifier=None,
58             )
59             c1 = get_crontab()
60             set_crontab(L + "* * * * * ls\n")
61             self.assertEqual(
62                 c1,
63                 "# Lines below here are managed by Salt, do not edit\n"
64                 "# SALT_CRON_IDENTIFIER:booh\n"
65                 "* * * * * ls\n"
66                 "* * * * * ls",
67             )
68             set_crontab(L + "# SALT_CRON_IDENTIFIER:bar\n* * * * * ls\n")
69             cron.set_job(
70                 user="root",
71                 minute="*",
72                 hour="*",
73                 daymonth="*",
74                 month="*",
75                 dayweek="*",
76                 cmd="ls",
77                 comment=None,
78                 identifier="bar",
79             )
80             c5 = get_crontab()
81             set_crontab(L + "* * * * * ls\n")
82             self.assertEqual(
83                 c5,
84                 "# Lines below here are managed by Salt, do not edit\n"
85                 "# SALT_CRON_IDENTIFIER:bar\n"
86                 "* * * * * ls\n",
87             )
88             set_crontab(L + "# SALT_CRON_IDENTIFIER:bar\n* * * * * ls\n")
89             cron.set_job(
90                 user="root",
91                 minute="1",
92                 hour="2",
93                 daymonth="3",
94                 month="4",
95                 dayweek="5",
96                 cmd="foo",
97                 comment="moo",
98                 identifier="bar",
99             )
100             c6 = get_crontab()
101             self.assertEqual(
102                 c6,
103                 "# Lines below here are managed by Salt, do not edit\n"
104                 "# moo SALT_CRON_IDENTIFIER:bar\n"
105                 "1 2 3 4 5 foo",
106             )
107     def test__unicode_match(self):
108         with patch.object(builtins, "__salt_system_encoding__", "utf-8"):
109             self.assertTrue(cron._cron_matched({"identifier": "1"}, "foo", 1))
110             self.assertTrue(cron._cron_matched({"identifier": "é"}, "foo", "é"))
111             self.assertTrue(cron._cron_matched({"identifier": "é"}, "foo", "é"))
112             self.assertTrue(cron._cron_matched({"identifier": "é"}, "foo", "é"))
113             self.assertTrue(cron._cron_matched({"identifier": "é"}, "foo", "é"))
114     def test__need_changes_old(self):
115         with patch(
116             "salt.modules.cron.raw_cron", new=MagicMock(side_effect=get_crontab)
117         ), patch(
118             "salt.modules.cron._write_cron_lines",
119             new=MagicMock(side_effect=write_crontab),
120         ):
121             set_crontab(L + "* * * * * ls\n\n")
122             cron.set_job(
123                 user="root",
124                 minute="*",
125                 hour="*",
126                 daymonth="*",
127                 month="*",
128                 dayweek="*",
129                 cmd="ls",
130                 comment=None,
131                 identifier=cron.SALT_CRON_NO_IDENTIFIER,
132             )
133             c1 = get_crontab()
134             set_crontab(L + "* * * * * ls\n")
135             self.assertEqual(
136                 c1,
137                 "# Lines below here are managed by Salt, do not edit\n* * * * * ls\n\n",
138             )
139             cron.set_job(
140                 user="root",
141                 minute="*",
142                 hour="*",
143                 daymonth="*",
144                 month="*",
145                 dayweek="*",
146                 cmd="ls",
147                 comment="foo",
148                 identifier=cron.SALT_CRON_NO_IDENTIFIER,
149             )
150             c2 = get_crontab()
151             self.assertEqual(
152                 c2,
153                 "# Lines below here are managed by Salt, do not edit\n"
154                 "# foo\n* * * * * ls",
155             )
156             set_crontab(L + "* * * * * ls\n")
157             cron.set_job(
158                 user="root",
159                 minute="*",
160                 hour="*",
161                 daymonth="*",
162                 month="*",
163                 dayweek="*",
164                 cmd="lsa",
165                 comment="foo",
166                 identifier="bar",
167             )
168             c3 = get_crontab()
169             self.assertEqual(
170                 c3,
171                 "# Lines below here are managed by Salt, do not edit\n"
172                 "* * * * * ls\n"
173                 "# foo SALT_CRON_IDENTIFIER:bar\n"
174                 "* * * * * lsa",
175             )
176             set_crontab(L + "* * * * * ls\n")
177             cron.set_job(
178                 user="root",
179                 minute="*",
180                 hour="*",
181                 daymonth="*",
182                 month="*",
183                 dayweek="*",
184                 cmd="foo",
185                 comment="foo",
186                 identifier="bar",
187             )
188             c4 = get_crontab()
189             self.assertEqual(
190                 c4,
191                 "# Lines below here are managed by Salt, do not edit\n"
192                 "* * * * * ls\n"
193                 "# foo SALT_CRON_IDENTIFIER:bar\n"
194                 "* * * * * foo",
195             )
196             set_crontab(L + "* * * * * ls\n")
197             cron.set_job(
198                 user="root",
199                 minute="*",
200                 hour="*",
201                 daymonth="*",
202                 month="*",
203                 dayweek="*",
204                 cmd="ls",
205                 comment="foo",
206                 identifier="bbar",
207             )
208             c4 = get_crontab()
209             self.assertEqual(
210                 c4,
211                 "# Lines below here are managed by Salt, do not edit\n"
212                 "# foo SALT_CRON_IDENTIFIER:bbar\n"
213                 "* * * * * ls",
214             )
215     def test__issue10959(self):
216         with patch(
217             "salt.modules.cron.raw_cron", new=MagicMock(side_effect=get_crontab)
218         ), patch(
219             "salt.modules.cron._write_cron_lines",
220             new=MagicMock(side_effect=write_crontab),
221         ):
222             set_crontab(
223                 "# Lines below here are managed by Salt, do not edit\n"
224                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
225                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
226                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
227                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
228                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
229                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
230                 "* * * * * samecmd\n"
231                 "* * * * * otheridcmd\n"
232                 "* * * * * otheridcmd\n"
233                 "# SALT_CRON_IDENTIFIER:NO ID SET\n0 * * * * samecmd1\n"
234                 "1 * * * * samecmd1\n"
235                 "0 * * * * otheridcmd1\n"
236                 "1 * * * * otheridcmd1\n"
237                 "# SALT_CRON_IDENTIFIER:1\n0 * * * * otheridcmd1\n"
238                 "# SALT_CRON_IDENTIFIER:2\n0 * * * * otheridcmd1\n"
239             )
240             crons1 = cron.list_tab("root")
241             self.assertEqual(
242                 crons1,
243                 {
244                     "crons": [
245                         {
246                             "cmd": "ls",
247                             "comment": "uoo",
248                             "daymonth": "*",
249                             "dayweek": "*",
250                             "hour": "*",
251                             "identifier": "NO ID SET",
252                             "minute": "*",
253                             "month": "*",
254                             "commented": False,
255                         },
256                         {
257                             "cmd": "too",
258                             "comment": "uuoo",
259                             "daymonth": "*",
260                             "dayweek": "*",
261                             "hour": "*",
262                             "identifier": "NO ID SET",
263                             "minute": "*",
264                             "month": "*",
265                             "commented": False,
266                         },
267                         {
268                             "cmd": "zoo",
269                             "comment": "uuuoo",
270                             "daymonth": "*",
271                             "dayweek": "*",
272                             "hour": "*",
273                             "identifier": "NO ID SET",
274                             "minute": "*",
275                             "month": "*",
276                             "commented": False,
277                         },
278                         {
279                             "cmd": "yoo",
280                             "comment": "",
281                             "daymonth": "*",
282                             "dayweek": "*",
283                             "hour": "*",
284                             "identifier": "NO ID SET",
285                             "minute": "*",
286                             "month": "*",
287                             "commented": False,
288                         },
289                         {
290                             "cmd": "xoo",
291                             "comment": "",
292                             "daymonth": "*",
293                             "dayweek": "*",
294                             "hour": "*",
295                             "identifier": "NO ID SET",
296                             "minute": "*",
297                             "month": "*",
298                             "commented": False,
299                         },
300                         {
301                             "cmd": "samecmd",
302                             "comment": "",
303                             "daymonth": "*",
304                             "dayweek": "*",
305                             "hour": "*",
306                             "identifier": "NO ID SET",
307                             "minute": "*",
308                             "month": "*",
309                             "commented": False,
310                         },
311                         {
312                             "cmd": "samecmd",
313                             "comment": None,
314                             "daymonth": "*",
315                             "dayweek": "*",
316                             "hour": "*",
317                             "identifier": None,
318                             "minute": "*",
319                             "month": "*",
320                             "commented": False,
321                         },
322                         {
323                             "cmd": "otheridcmd",
324                             "comment": None,
325                             "daymonth": "*",
326                             "dayweek": "*",
327                             "hour": "*",
328                             "identifier": None,
329                             "minute": "*",
330                             "month": "*",
331                             "commented": False,
332                         },
333                         {
334                             "cmd": "otheridcmd",
335                             "comment": None,
336                             "daymonth": "*",
337                             "dayweek": "*",
338                             "hour": "*",
339                             "identifier": None,
340                             "minute": "*",
341                             "month": "*",
342                             "commented": False,
343                         },
344                         {
345                             "cmd": "samecmd1",
346                             "comment": "",
347                             "daymonth": "*",
348                             "dayweek": "*",
349                             "hour": "*",
350                             "identifier": "NO ID SET",
351                             "minute": "0",
352                             "month": "*",
353                             "commented": False,
354                         },
355                         {
356                             "cmd": "samecmd1",
357                             "comment": None,
358                             "daymonth": "*",
359                             "dayweek": "*",
360                             "hour": "*",
361                             "identifier": None,
362                             "minute": "1",
363                             "month": "*",
364                             "commented": False,
365                         },
366                         {
367                             "cmd": "otheridcmd1",
368                             "comment": None,
369                             "daymonth": "*",
370                             "dayweek": "*",
371                             "hour": "*",
372                             "identifier": None,
373                             "minute": "0",
374                             "month": "*",
375                             "commented": False,
376                         },
377                         {
378                             "cmd": "otheridcmd1",
379                             "comment": None,
380                             "daymonth": "*",
381                             "dayweek": "*",
382                             "hour": "*",
383                             "identifier": None,
384                             "minute": "1",
385                             "month": "*",
386                             "commented": False,
387                         },
388                         {
389                             "cmd": "otheridcmd1",
390                             "comment": "",
391                             "daymonth": "*",
392                             "dayweek": "*",
393                             "hour": "*",
394                             "identifier": "1",
395                             "minute": "0",
396                             "month": "*",
397                             "commented": False,
398                         },
399                         {
400                             "cmd": "otheridcmd1",
401                             "comment": "",
402                             "daymonth": "*",
403                             "dayweek": "*",
404                             "hour": "*",
405                             "identifier": "2",
406                             "minute": "0",
407                             "month": "*",
408                             "commented": False,
409                         },
410                     ],
411                     "env": [],
412                     "pre": [],
413                     "special": [],
414                 },
415             )
416             inc_tests = [
417                 "# Lines below here are managed by Salt, do not edit\n"
418                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls",
419                 "# Lines below here are managed by Salt, do not edit\n"
420                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
421                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too",
422                 "# Lines below here are managed by Salt, do not edit\n"
423                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
424                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
425                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo",
426                 "# Lines below here are managed by Salt, do not edit\n"
427                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
428                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
429                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
430                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo",
431                 "# Lines below here are managed by Salt, do not edit\n"
432                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
433                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
434                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
435                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
436                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo",
437                 "# Lines below here are managed by Salt, do not edit\n"
438                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
439                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
440                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
441                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
442                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
443                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd",
444                 "# Lines below here are managed by Salt, do not edit\n"
445                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
446                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
447                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
448                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
449                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
450                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd",
451                 "# Lines below here are managed by Salt, do not edit\n"
452                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
453                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
454                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
455                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
456                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
457                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
458                 "* * * * * otheridcmd",
459                 "# Lines below here are managed by Salt, do not edit\n"
460                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
461                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
462                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
463                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
464                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
465                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
466                 "* * * * * otheridcmd",
467                 "# Lines below here are managed by Salt, do not edit\n"
468                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
469                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
470                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
471                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
472                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
473                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
474                 "* * * * * otheridcmd\n"
475                 "# SALT_CRON_IDENTIFIER:NO ID SET\n"
476                 "0 * * * * samecmd1",
477                 "# Lines below here are managed by Salt, do not edit\n"
478                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
479                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
480                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
481                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
482                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
483                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
484                 "* * * * * otheridcmd\n"
485                 "# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1",
486                 "# Lines below here are managed by Salt, do not edit\n"
487                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
488                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
489                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
490                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
491                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
492                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
493                 "* * * * * otheridcmd\n"
494                 "# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1\n"
495                 "0 * * * * otheridcmd1",
496                 "# Lines below here are managed by Salt, do not edit\n"
497                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
498                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
499                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
500                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
501                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
502                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
503                 "* * * * * otheridcmd\n"
504                 "# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1\n"
505                 "1 * * * * otheridcmd1",
506                 "# Lines below here are managed by Salt, do not edit\n"
507                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
508                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
509                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
510                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
511                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
512                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
513                 "* * * * * otheridcmd\n"
514                 "# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1\n"
515                 "# SALT_CRON_IDENTIFIER:1\n0 * * * * otheridcmd1",
516                 "# Lines below here are managed by Salt, do not edit\n"
517                 "# uoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * ls\n"
518                 "# uuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * too\n"
519                 "# uuuoo SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * zoo\n"
520                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * yoo\n"
521                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * xoo\n"
522                 "# SALT_CRON_IDENTIFIER:NO ID SET\n* * * * * samecmd\n"
523                 "* * * * * otheridcmd\n"
524                 "# SALT_CRON_IDENTIFIER:NO ID SET\n1 * * * * samecmd1\n"
525                 "# SALT_CRON_IDENTIFIER:1\n0 * * * * otheridcmd1\n"
526                 "# SALT_CRON_IDENTIFIER:2\n0 * * * * otheridcmd1",
527             ]
528             set_crontab("")
529             for idx, cr in enumerate(crons1["crons"]):
530                 cron.set_job("root", **cr)
531                 self.assertEqual(
532                     get_crontab(),
533                     inc_tests[idx],
534                     ("idx {0}\n'{1}'\n != \n'{2}'\n\n\n'{1}' != '{2}'").format(
535                         idx, get_crontab(), inc_tests[idx]
536                     ),
537                 )
538     def test_list_tab_commented_cron_jobs(self):
539         with patch(
540             "salt.modules.cron.raw_cron", MagicMock(side_effect=get_crontab)
541         ), patch(
542             "salt.modules.cron._write_cron_lines", MagicMock(side_effect=write_crontab)
543         ):
544             set_crontab(
545                 "# An unmanaged commented cron job\n"
546                 "#0 * * * * /bin/true\n"
547                 "# Lines below here are managed by Salt, do not edit\n"
548                 "# cron_1 SALT_CRON_IDENTIFIER:cron_1\n#DISABLED#0 * * * * my_cmd_1\n"
549                 "# cron_2 SALT_CRON_IDENTIFIER:cron_2\n#DISABLED#* * * * * my_cmd_2\n"
550                 "# cron_3 SALT_CRON_IDENTIFIER:cron_3\n"
551                 "#DISABLED#but it is a comment line"
552                 "#DISABLED#0 * * * * my_cmd_3\n"
553                 "# cron_4 SALT_CRON_IDENTIFIER:cron_4\n0 * * * * my_cmd_4\n"
554             )
555             crons1 = cron.list_tab("root")
556             self.assertEqual(
557                 crons1,
558                 {
559                     "crons": [
560                         {
561                             "cmd": "my_cmd_1",
562                             "comment": "cron_1",
563                             "daymonth": "*",
564                             "dayweek": "*",
565                             "hour": "*",
566                             "identifier": "cron_1",
567                             "minute": "0",
568                             "month": "*",
569                             "commented": True,
570                         },
571                         {
572                             "cmd": "my_cmd_2",
573                             "comment": "cron_2",
574                             "daymonth": "*",
575                             "dayweek": "*",
576                             "hour": "*",
577                             "identifier": "cron_2",
578                             "minute": "*",
579                             "month": "*",
580                             "commented": True,
581                         },
582                         {
583                             "cmd": "line#DISABLED#0 * * * * my_cmd_3",
584                             "comment": "cron_3",
585                             "daymonth": "is",
586                             "dayweek": "comment",
587                             "hour": "it",
588                             "identifier": "cron_3",
589                             "minute": "but",
590                             "month": "a",
591                             "commented": True,
592                         },
593                         {
594                             "cmd": "my_cmd_4",
595                             "comment": "cron_4",
596                             "daymonth": "*",
597                             "dayweek": "*",
598                             "hour": "*",
599                             "identifier": "cron_4",
600                             "minute": "0",
601                             "month": "*",
602                             "commented": False,
603                         },
604                     ],
605                     "env": [],
606                     "pre": [
607                         "# An unmanaged commented cron job",
608                         "#0 * * * * /bin/true",
609                     ],
610                     "special": [],
611                 },
612             )
613     def test_get_entry(self):
614         list_tab_output = {
615             "crons": [
616                 {
617                     "cmd": "my_cmd_1",
618                     "comment": "cron_1",
619                     "daymonth": "*",
620                     "dayweek": "*",
621                     "hour": "*",
622                     "identifier": "cron_1",
623                     "minute": "0",
624                     "month": "*",
625                     "commented": True,
626                 },
627                 {
628                     "cmd": "my_cmd_2",
629                     "comment": "cron_2",
630                     "daymonth": "*",
631                     "dayweek": "*",
632                     "hour": "*",
633                     "identifier": "cron_2",
634                     "minute": "*",
635                     "month": "*",
636                     "commented": True,
637                 },
638                 {
639                     "cmd": "line#DISABLED#0 * * * * my_cmd_3",
640                     "comment": "cron_3",
641                     "daymonth": "is",
642                     "dayweek": "comment",
643                     "hour": "it",
644                     "identifier": "cron_3",
645                     "minute": "but",
646                     "month": "a",
647                     "commented": True,
648                 },
649                 {
650                     "cmd": "my_cmd_4",
651                     "comment": "cron_4",
652                     "daymonth": "*",
653                     "dayweek": "*",
654                     "hour": "*",
655                     "identifier": "cron_4",
656                     "minute": "0",
657                     "month": "*",
658                     "commented": False,
659                 },
660             ],
661             "env": [],
662             "pre": ["# An unmanaged commented cron job", "#0 * * * * /bin/true"],
663             "special": [],
664         }
665         get_entry_2 = {
666             "comment": "cron_2",
667             "cmd": "my_cmd_2",
668             "identifier": "cron_2",
669             "dayweek": "*",
670             "daymonth": "*",
671             "hour": "*",
672             "minute": "*",
673             "month": "*",
674             "commented": True,
675         }
676         get_entry_3 = {
677             "comment": "cron_3",
678             "identifier": "cron_3",
679             "dayweek": "comment",
680             "hour": "it",
681             "cmd": "line#DISABLED#0 * * * * my_cmd_3",
682             "daymonth": "is",
683             "commented": True,
684             "minute": "but",
685             "month": "a",
686         }
687         with patch(
688 <a name="0"></a>            "salt.modules.cron.list_tab", new=MagicMock(return_value=list_tab_output)
689         ):
690             get_entry_output <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= cron.get_entry("root", identifier="cron_3")
691             self.assertDictEqual(get_entry_output, get_entry_3)
692             get_entry_output = cron.get_entry("root", cmd="my_cmd_2")
693             self.assertDictEqual(get_entry_output, get_entry_2)
694             get_entry_output = cron.get_entry(
695                 "root", identifier=</b></font>"cron_3", cmd="my_cmd_2"
696             )
697             self.assertDictEqual(get_entry_output, get_entry_3)
698     def test_cron_extra_spaces(self):
699         with patch.dict(cron.__grains__, {"os": None}), patch(
700             "salt.modules.cron.raw_cron", MagicMock(return_value=STUB_CRON_SPACES)
701         ):
702             ret = cron.list_tab("root")
703             eret = {
704                 "crons": [
705                     {
706                         "cmd": 'echo "must  be  double  spaced"',
707                         "comment": "",
708                         "commented": False,
709                         "daymonth": "*",
710                         "dayweek": "*",
711                         "hour": "*",
712                         "identifier": 'echo "must  be  double  spaced"',
713                         "minute": "11",
714                         "month": "*",
715                     }
716                 ],
717                 "env": [
718                     {"name": "TEST_VAR", "value": '"a string with plenty of spaces"'}
719                 ],
720                 "pre": [""],
721                 "special": [],
722             }
723             self.assertEqual(eret, ret)
724     def test_cron_at_sign(self):
725         with patch.dict(cron.__grains__, {"os": None}), patch(
726             "salt.modules.cron.raw_cron", MagicMock(return_value=STUB_AT_SIGN)
727         ):
728             ret = cron.list_tab("root")
729             eret = {
730                 "crons": [],
731                 "env": [],
732                 "pre": [""],
733                 "special": [
734                     {
735                         "cmd": 'echo "cron with @ sign"',
736                         "comment": "",
737                         "commented": False,
738                         "identifier": 'echo "cron with @ sign"',
739                         "spec": "@daily",
740                     }
741                 ],
742             }
743             self.assertDictEqual(eret, ret)
744     def test__load_tab(self):
745         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch(
746             "salt.modules.cron.raw_cron",
747             new=MagicMock(
748                 side_effect=[
749                     (L + "\n"),
750                     (L + "* * * * * ls\nn"),
751                     (L + "# commented\n#DISABLED#* * * * * ls\n"),
752                     (L + "# foo\n* * * * * ls\n"),
753                     (
754                         L
755                         + "# foo {}:blah\n".format(cron.SALT_CRON_IDENTIFIER)
756                         + "* * * * * ls\n"
757                     ),
758                 ]
759             ),
760         ):
761             crons1 = cron.list_tab("root")
762             crons2 = cron.list_tab("root")
763             crons3 = cron.list_tab("root")
764             crons4 = cron.list_tab("root")
765             crons5 = cron.list_tab("root")
766             self.assertEqual(crons1, {"pre": [], "crons": [], "env": [], "special": []})
767             self.assertEqual(
768                 crons2["crons"][0],
769                 {
770                     "comment": None,
771                     "commented": False,
772                     "dayweek": "*",
773                     "hour": "*",
774                     "identifier": None,
775                     "cmd": "ls",
776                     "daymonth": "*",
777                     "minute": "*",
778                     "month": "*",
779                 },
780             )
781             self.assertEqual(
782                 crons3["crons"][0],
783                 {
784                     "comment": "commented",
785                     "commented": True,
786                     "dayweek": "*",
787                     "hour": "*",
788                     "identifier": None,
789                     "cmd": "ls",
790                     "daymonth": "*",
791                     "minute": "*",
792                     "month": "*",
793                 },
794             )
795             self.assertEqual(
796                 crons4["crons"][0],
797                 {
798                     "comment": "foo",
799                     "commented": False,
800                     "dayweek": "*",
801                     "hour": "*",
802                     "identifier": None,
803                     "cmd": "ls",
804                     "daymonth": "*",
805                     "minute": "*",
806                     "month": "*",
807                 },
808             )
809             self.assertEqual(
810                 crons5["crons"][0],
811                 {
812                     "comment": "foo",
813                     "commented": False,
814                     "dayweek": "*",
815                     "hour": "*",
816                     "identifier": "blah",
817                     "cmd": "ls",
818                     "daymonth": "*",
819                     "minute": "*",
820                     "month": "*",
821                 },
822             )
823     def test_write_cron_file_root_rh(self):
824         with patch.dict(cron.__grains__, {"os_family": "RedHat"}), patch.dict(
825             cron.__salt__, {"cmd.retcode": MagicMock()}
826         ), patch(
827             "salt.modules.cron._check_instance_uid_match",
828             new=MagicMock(return_value=True),
829         ):
830             cron.write_cron_file(STUB_USER, STUB_PATH)
831             cron.__salt__["cmd.retcode"].assert_called_with(
832                 "crontab /tmp", python_shell=False
833             )
834     def test_write_cron_file_foo_rh(self):
835         with patch.dict(cron.__grains__, {"os_family": "RedHat"}), patch.dict(
836             cron.__salt__, {"cmd.retcode": MagicMock()}
837         ), patch(
838             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=False)
839         ):
840             cron.write_cron_file("foo", STUB_PATH)
841             cron.__salt__["cmd.retcode"].assert_called_with(
842                 "crontab /tmp", runas="foo", python_shell=False
843             )
844     def test_write_cron_file_root_sol(self):
845         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch.dict(
846             cron.__salt__, {"cmd.retcode": MagicMock()}
847         ):
848             cron.write_cron_file(STUB_USER, STUB_PATH)
849             cron.__salt__["cmd.retcode"].assert_called_with(
850                 "crontab /tmp", runas=STUB_USER, python_shell=False
851             )
852     def test_write_cron_file_foo_sol(self):
853         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch.dict(
854             cron.__salt__, {"cmd.retcode": MagicMock()}
855         ):
856             cron.write_cron_file("foo", STUB_PATH)
857             cron.__salt__["cmd.retcode"].assert_called_with(
858                 "crontab /tmp", runas="foo", python_shell=False
859             )
860     def test_write_cron_file_root_aix(self):
861         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
862             cron.__salt__, {"cmd.retcode": MagicMock()}
863         ):
864             cron.write_cron_file(STUB_USER, STUB_PATH)
865             cron.__salt__["cmd.retcode"].assert_called_with(
866                 "crontab /tmp", runas=STUB_USER, python_shell=False
867             )
868     def test_write_cron_file_foo_aix(self):
869         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
870             cron.__salt__, {"cmd.retcode": MagicMock()}
871         ):
872             cron.write_cron_file("foo", STUB_PATH)
873             cron.__salt__["cmd.retcode"].assert_called_with(
874                 "crontab /tmp", runas="foo", python_shell=False
875             )
876     def test_write_cr_file_v_root_rh(self):
877         with patch.dict(cron.__grains__, {"os_family": "Redhat"}), patch.dict(
878             cron.__salt__, {"cmd.run_all": MagicMock()}
879         ), patch(
880             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=True)
881         ):
882             cron.write_cron_file_verbose(STUB_USER, STUB_PATH)
883             cron.__salt__["cmd.run_all"].assert_called_with(
884                 "crontab /tmp", python_shell=False
885             )
886     def test_write_cr_file_v_foo_rh(self):
887         with patch.dict(cron.__grains__, {"os_family": "Redhat"}), patch.dict(
888             cron.__salt__, {"cmd.run_all": MagicMock()}
889         ), patch(
890             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=False)
891         ):
892             cron.write_cron_file_verbose("foo", STUB_PATH)
893             cron.__salt__["cmd.run_all"].assert_called_with(
894                 "crontab /tmp", runas="foo", python_shell=False
895             )
896     def test_write_cr_file_v_root_sol(self):
897         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch.dict(
898             cron.__salt__, {"cmd.run_all": MagicMock()}
899         ):
900             cron.write_cron_file_verbose(STUB_USER, STUB_PATH)
901             cron.__salt__["cmd.run_all"].assert_called_with(
902                 "crontab /tmp", runas=STUB_USER, python_shell=False
903             )
904     def test_write_cr_file_v_foo_sol(self):
905         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch.dict(
906             cron.__salt__, {"cmd.run_all": MagicMock()}
907         ):
908             cron.write_cron_file_verbose("foo", STUB_PATH)
909             cron.__salt__["cmd.run_all"].assert_called_with(
910                 "crontab /tmp", runas="foo", python_shell=False
911             )
912     def test_write_cr_file_v_root_aix(self):
913         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
914             cron.__salt__, {"cmd.run_all": MagicMock()}
915         ):
916             cron.write_cron_file_verbose(STUB_USER, STUB_PATH)
917             cron.__salt__["cmd.run_all"].assert_called_with(
918                 "crontab /tmp", runas=STUB_USER, python_shell=False
919             )
920     def test_write_cr_file_v_foo_aix(self):
921         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
922             cron.__salt__, {"cmd.run_all": MagicMock()}
923         ):
924             cron.write_cron_file_verbose("foo", STUB_PATH)
925             cron.__salt__["cmd.run_all"].assert_called_with(
926                 "crontab /tmp", runas="foo", python_shell=False
927             )
928     def test_raw_cron_root_redhat(self):
929         with patch.dict(cron.__grains__, {"os_family": "Redhat"}), patch.dict(
930             cron.__salt__, {"cmd.run_stdout": MagicMock()}
931         ), patch(
932             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=True)
933         ):
934             cron.raw_cron(STUB_USER)
935             cron.__salt__["cmd.run_stdout"].assert_called_with(
936                 "crontab -l", ignore_retcode=True, rstrip=False, python_shell=False
937             )
938     def test_raw_cron_foo_redhat(self):
939         with patch.dict(cron.__grains__, {"os_family": "Redhat"}), patch.dict(
940             cron.__salt__, {"cmd.run_stdout": MagicMock()}
941         ), patch(
942             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=False)
943         ):
944             cron.raw_cron(STUB_USER)
945             cron.__salt__["cmd.run_stdout"].assert_called_with(
946                 "crontab -l",
947                 runas=STUB_USER,
948                 ignore_retcode=True,
949                 rstrip=False,
950                 python_shell=False,
951             )
952     def test_raw_cron_root_solaris(self):
953         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch.dict(
954             cron.__salt__, {"cmd.run_stdout": MagicMock()}
955         ), patch(
956             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=True)
957         ):
958             cron.raw_cron(STUB_USER)
959             cron.__salt__["cmd.run_stdout"].assert_called_with(
960                 "crontab -l",
961                 runas=STUB_USER,
962                 ignore_retcode=True,
963                 rstrip=False,
964                 python_shell=False,
965             )
966     def test_raw_cron_foo_solaris(self):
967         with patch.dict(cron.__grains__, {"os_family": "Solaris"}), patch.dict(
968             cron.__salt__, {"cmd.run_stdout": MagicMock()}
969         ), patch(
970             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=False)
971         ):
972             cron.raw_cron(STUB_USER)
973             cron.__salt__["cmd.run_stdout"].assert_called_with(
974                 "crontab -l",
975                 runas=STUB_USER,
976                 ignore_retcode=True,
977                 rstrip=False,
978                 python_shell=False,
979             )
980     def test_raw_cron_root_aix(self):
981         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
982             cron.__salt__, {"cmd.run_stdout": MagicMock()}
983         ), patch(
984             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=True)
985         ):
986             cron.raw_cron(STUB_USER)
987             cron.__salt__["cmd.run_stdout"].assert_called_with(
988                 "crontab -l",
989                 runas=STUB_USER,
990                 ignore_retcode=True,
991                 rstrip=False,
992                 python_shell=False,
993             )
994     def test_raw_cron_foo_aix(self):
995         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
996             cron.__salt__, {"cmd.run_stdout": MagicMock()}
997         ), patch(
998             "salt.modules.cron._check_instance_uid_match", MagicMock(return_value=False)
999         ):
1000             cron.raw_cron(STUB_USER)
1001             cron.__salt__["cmd.run_stdout"].assert_called_with(
1002                 "crontab -l",
1003                 runas=STUB_USER,
1004                 ignore_retcode=True,
1005                 rstrip=False,
1006                 python_shell=False,
1007             )
1008 class PsTestCase(TestCase, LoaderModuleMockMixin):
1009     def setup_loader_modules(self):
1010         return {cron: {}}
1011     def test__needs_change(self):
1012         self.assertTrue(cron._needs_change(True, False))
1013     def test__needs_change_random(self):
1014         self.assertTrue(cron._needs_change("*", "random"))
1015     def test__get_cron_cmdstr(self):
1016         self.assertEqual("crontab /tmp", cron._get_cron_cmdstr(STUB_PATH))
1017     def test__get_cron_cmdstr_user(self):
1018         self.assertEqual(
1019             "crontab -u root /tmp", cron._get_cron_cmdstr(STUB_PATH, STUB_USER)
1020         )
1021     def test__date_time_match(self):
1022         self.assertTrue(
1023             cron._date_time_match(
1024                 STUB_CRON_TIMESTAMP,
1025                 minute=STUB_CRON_TIMESTAMP["minute"],
1026                 hour=STUB_CRON_TIMESTAMP["hour"],
1027                 daymonth=STUB_CRON_TIMESTAMP["daymonth"],
1028                 dayweek=STUB_CRON_TIMESTAMP["dayweek"],
1029             )
1030         )
1031     def test_list_tab(self):
1032         with patch(
1033             "salt.modules.cron.raw_cron",
1034             new=MagicMock(return_value=STUB_SIMPLE_RAW_CRON),
1035         ):
1036             self.assertDictEqual(STUB_SIMPLE_CRON_DICT, cron.list_tab("DUMMY_USER"))
1037     def test_set_special(self):
1038         with patch(
1039             "salt.modules.cron._write_cron_lines"
1040         ) as write_cron_lines_mock, patch(
1041             "salt.modules.cron.list_tab",
1042             new=MagicMock(return_value=STUB_SIMPLE_CRON_DICT),
1043         ):
1044             expected_write_call = call(
1045                 "DUMMY_USER",
1046                 [
1047                     "5 0 * * * /tmp/no_script.sh\n",
1048                     "# Lines below here are managed by Salt, do not edit\n",
1049                     "@hourly echo Hi!\n",
1050                 ],
1051             )
1052             ret = cron.set_special("DUMMY_USER", "@hourly", "echo Hi!")
1053             write_cron_lines_mock.assert_has_calls(
1054                 (expected_write_call,), any_order=True
1055             )
1056     def test__get_cron_date_time(self):
1057         ret = cron._get_cron_date_time(
1058             minute=STUB_CRON_TIMESTAMP["minute"],
1059             hour=STUB_CRON_TIMESTAMP["hour"],
1060             daymonth=STUB_CRON_TIMESTAMP["daymonth"],
1061             dayweek=STUB_CRON_TIMESTAMP["dayweek"],
1062             month=STUB_CRON_TIMESTAMP["month"],
1063         )
1064         self.assertDictEqual(ret, STUB_CRON_TIMESTAMP)
1065     def test__get_cron_date_time_daymonth_max(self):
1066         ret = cron._get_cron_date_time(
1067             minute="random",
1068             hour="random",
1069             daymonth="random",
1070             dayweek="random",
1071             month="random",
1072         )
1073         self.assertTrue(int(ret["minute"]) in range(0, 60))
1074         self.assertTrue(int(ret["hour"]) in range(0, 24))
1075         self.assertTrue(int(ret["daymonth"]) in range(1, 32))
1076         self.assertTrue(int(ret["dayweek"]) in range(0, 8))
1077         self.assertTrue(int(ret["month"]) in range(1, 13))
1078     def test_set_job(self):
1079         with patch.dict(cron.__grains__, {"os": None}), patch(
1080             "salt.modules.cron._write_cron_lines",
1081             new=MagicMock(return_value={"retcode": False}),
1082         ), patch(
1083             "salt.modules.cron.raw_cron",
1084             new=MagicMock(return_value=STUB_SIMPLE_RAW_CRON),
1085         ):
1086             cron.set_job(
1087                 "DUMMY_USER",
1088                 1,
1089                 2,
1090                 3,
1091                 4,
1092                 5,
1093                 "/bin/echo NOT A DROID",
1094                 "WERE YOU LOOKING FOR ME?",
1095             )
1096             expected_call = call(
1097                 "DUMMY_USER",
1098                 [
1099                     "5 0 * * * /tmp/no_script.sh\n",
1100                     "# Lines below here are managed by Salt, do not edit\n",
1101                     "# WERE YOU LOOKING FOR ME?\n",
1102                     "1 2 3 4 5 /bin/echo NOT A DROID\n",
1103                 ],
1104             )
1105             cron._write_cron_lines.call_args.assert_called_with(expected_call)
1106     def test_rm_special(self):
1107         with patch.dict(cron.__grains__, {"os": None}), patch(
1108             "salt.modules.cron._write_cron_lines",
1109             new=MagicMock(return_value={"retcode": False}),
1110         ), patch(
1111             "salt.modules.cron.raw_cron", new=MagicMock(return_value=STUB_AT_SIGN)
1112         ):
1113             ret = cron.rm_special(
1114                 "root",
1115                 'echo "cron with @ sign"',
1116                 special="@daily",
1117                 identifier='echo "cron with @ sign"',
1118             )
1119             self.assertEqual("removed", ret)
1120     def test_rm_special_default_special(self):
1121         with patch.dict(cron.__grains__, {"os": None}), patch(
1122             "salt.modules.cron._write_cron_lines",
1123             new=MagicMock(return_value={"retcode": False}),
1124         ), patch(
1125             "salt.modules.cron.raw_cron", new=MagicMock(return_value=STUB_AT_SIGN)
1126         ):
1127             ret = cron.rm_special(
1128                 "root", 'echo "cron with @ sign"', identifier='echo "cron with @ sign"'
1129             )
1130             self.assertEqual("removed", ret)
1131     def test_rm_special_absent(self):
1132         with patch.dict(cron.__grains__, {"os": None}), patch(
1133             "salt.modules.cron._write_cron_lines",
1134             new=MagicMock(return_value={"retcode": False}),
1135         ), patch(
1136             "salt.modules.cron.raw_cron", new=MagicMock(return_value=STUB_AT_SIGN)
1137         ):
1138             ret = cron.rm_special(
1139                 "root", 'echo "there is no job"', identifier='echo "there is no job"'
1140             )
1141             self.assertEqual("absent", ret)
1142     def test_rm_job_is_absent(self):
1143         with patch.dict(cron.__grains__, {"os": None}), patch(
1144             "salt.modules.cron._write_cron_lines",
1145             new=MagicMock(return_value={"retcode": False}),
1146         ), patch(
1147             "salt.modules.cron.raw_cron",
1148             new=MagicMock(return_value=STUB_SIMPLE_RAW_CRON),
1149         ):
1150             ret = cron.rm_job("DUMMY_USER", "/bin/echo NOT A DROID", 1, 2, 3, 4, 5)
1151             self.assertEqual("absent", ret)
1152     def test_write_cron_lines_root_rh(self):
1153         temp_path = "some_temp_path"
1154         crontab_cmd = "crontab {}".format(temp_path)
1155         with patch.dict(cron.__grains__, {"os_family": "RedHat"}), patch.dict(
1156             cron.__salt__, {"cmd.run_all": MagicMock()}
1157         ), patch(
1158             "salt.modules.cron._check_instance_uid_match",
1159             new=MagicMock(return_value=True),
1160         ), patch(
1161             "salt.utils.files.fpopen", mock_open()
1162         ), patch.dict(
1163             cron.__salt__, {"file.user_to_uid": MagicMock(return_value=1)}
1164         ), patch(
1165             "salt.utils.files.mkstemp", MagicMock(return_value=temp_path)
1166         ), patch(
1167             "os.remove", MagicMock()
1168         ):
1169             cron._write_cron_lines("root", "test 123")
1170             cron.__salt__["cmd.run_all"].assert_called_with(
1171                 crontab_cmd, python_shell=False, runas="root"
1172             )
1173     def test_write_cron_lines_non_root_rh(self):
1174         temp_path = "some_temp_path"
1175         crontab_cmd = "crontab {}".format(temp_path)
1176         with patch.dict(cron.__grains__, {"os_family": "RedHat"}), patch.dict(
1177             cron.__salt__, {"cmd.run_all": MagicMock()}
1178         ), patch(
1179             "salt.modules.cron._check_instance_uid_match",
1180             new=MagicMock(return_value=False),
1181         ), patch(
1182             "salt.utils.files.fpopen", mock_open()
1183         ), patch.dict(
1184             cron.__salt__, {"file.user_to_uid": MagicMock(return_value=1)}
1185         ), patch(
1186             "salt.utils.files.mkstemp", MagicMock(return_value=temp_path)
1187         ), patch(
1188             "os.remove", MagicMock()
1189         ):
1190             cron._write_cron_lines("non-root", "test 123")
1191             cron.__salt__["cmd.run_all"].assert_called_with(
1192                 crontab_cmd, python_shell=False
1193             )
1194     def test_write_cron_lines_non_root_aix(self):
1195         temp_path = "some_temp_path"
1196         crontab_cmd = "crontab {}".format(temp_path)
1197         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
1198             cron.__salt__, {"cmd.run_all": MagicMock()}
1199         ), patch(
1200             "salt.modules.cron._check_instance_uid_match",
1201             new=MagicMock(return_value=False),
1202         ), patch(
1203             "salt.utils.files.fpopen", mock_open()
1204         ), patch.dict(
1205             cron.__salt__, {"file.user_to_uid": MagicMock(return_value=1)}
1206         ), patch(
1207             "salt.utils.files.mkstemp", MagicMock(return_value=temp_path)
1208         ), patch(
1209             "os.remove", MagicMock()
1210         ):
1211             cron._write_cron_lines("non-root", "test 123")
1212             cron.__salt__["cmd.run_all"].assert_called_with(
1213                 crontab_cmd, python_shell=False, runas="non-root"
1214             )
1215     def test_write_cron_lines_non_root_solaris(self):
1216         temp_path = "some_temp_path"
1217         crontab_cmd = "crontab {}".format(temp_path)
1218         with patch.dict(cron.__grains__, {"os_family": "AIX"}), patch.dict(
1219             cron.__salt__, {"cmd.run_all": MagicMock()}
1220         ), patch(
1221             "salt.modules.cron._check_instance_uid_match",
1222             new=MagicMock(return_value=False),
1223         ), patch(
1224             "salt.utils.files.fpopen", mock_open()
1225         ), patch.dict(
1226             cron.__salt__, {"file.user_to_uid": MagicMock(return_value=1)}
1227         ), patch(
1228             "salt.utils.files.mkstemp", MagicMock(return_value=temp_path)
1229         ), patch(
1230             "os.remove", MagicMock()
1231         ):
1232             cron._write_cron_lines("non-root", "test 123")
1233             cron.__salt__["cmd.run_all"].assert_called_with(
1234                 crontab_cmd, python_shell=False, runas="non-root"
1235             )
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
