<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for opennebula.py &amp; vagrant_1.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for opennebula.py &amp; vagrant_1.py
      </h3>
<h1 align="center">
        3.5%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>opennebula.py (2.0712302%)<th>vagrant_1.py (13.12%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(3426-3431)<td><a href="#" name="0">(411-415)</a><td align="center"><font color="#ff0000">18</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(1805-1810)<td><a href="#" name="1">(163-166)</a><td align="center"><font color="#d40000">15</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(2197-2201)<td><a href="#" name="2">(521-524)</a><td align="center"><font color="#b80000">13</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(2583-2586)<td><a href="#" name="3">(501-502)</a><td align="center"><font color="#aa0000">12</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(2364-2367)<td><a href="#" name="4">(479-480)</a><td align="center"><font color="#aa0000">12</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(1254-1257)<td><a href="#" name="5">(461-462)</a><td align="center"><font color="#aa0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>opennebula.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import os
3 import pprint
4 import time
5 import salt.config as config
6 import salt.utils.data
7 import salt.utils.files
8 from salt.exceptions import (
9     SaltCloudConfigError,
10     SaltCloudExecutionFailure,
11     SaltCloudExecutionTimeout,
12     SaltCloudNotFound,
13     SaltCloudSystemExit,
14 )
15 try:
16     import xmlrpc.client
17     from lxml import etree
18     HAS_XML_LIBS = True
19 except ImportError:
20     HAS_XML_LIBS = False
21 log = logging.getLogger(__name__)
22 __virtualname__ = "opennebula"
23 def __virtual__():
24     if get_configured_provider() is False:
25         return False
26     if get_dependencies() is False:
27         return False
28     return __virtualname__
29 def _get_active_provider_name():
30     try:
31         return __active_provider_name__.value()
32     except AttributeError:
33         return __active_provider_name__
34 def get_configured_provider():
35     return config.is_provider_configured(
36         __opts__,
37         _get_active_provider_name() or __virtualname__,
38         ("xml_rpc", "user", "password"),
39     )
40 def get_dependencies():
41     return config.check_driver_dependencies(__virtualname__, {"lmxl": HAS_XML_LIBS})
42 def avail_images(call=None):
43     if call == "action":
44         raise SaltCloudSystemExit(
45             "The avail_images function must be called with "
46             "-f or --function, or with the --list-images option"
47         )
48     server, user, password = _get_xml_rpc()
49     auth = ":".join([user, password])
50     image_pool = server.one.imagepool.info(auth, -2, -1, -1)[1]
51     images = {}
52     for image in _get_xml(image_pool):
53         images[image.find("NAME").text] = _xml_to_dict(image)
54     return images
55 def avail_locations(call=None):
56     if call == "action":
57         raise SaltCloudSystemExit(
58             "The avail_locations function must be called with "
59             "-f or --function, or with the --list-locations option."
60         )
61     server, user, password = _get_xml_rpc()
62     auth = ":".join([user, password])
63     host_pool = server.one.hostpool.info(auth)[1]
64     locations = {}
65     for host in _get_xml(host_pool):
66         locations[host.find("NAME").text] = _xml_to_dict(host)
67     return locations
68 def avail_sizes(call=None):
69     if call == "action":
70         raise SaltCloudSystemExit(
71             "The avail_sizes function must be called with "
72             "-f or --function, or with the --list-sizes option."
73         )
74     log.warning(
75         "Because sizes are built into templates with OpenNebula, there are no sizes "
76         "to return."
77     )
78     return {}
79 def list_clusters(call=None):
80     if call == "action":
81         raise SaltCloudSystemExit(
82             "The list_clusters function must be called with -f or --function."
83         )
84     server, user, password = _get_xml_rpc()
85     auth = ":".join([user, password])
86     cluster_pool = server.one.clusterpool.info(auth)[1]
87     clusters = {}
88     for cluster in _get_xml(cluster_pool):
89         clusters[cluster.find("NAME").text] = _xml_to_dict(cluster)
90     return clusters
91 def list_datastores(call=None):
92     if call == "action":
93         raise SaltCloudSystemExit(
94             "The list_datastores function must be called with -f or --function."
95         )
96     server, user, password = _get_xml_rpc()
97     auth = ":".join([user, password])
98     datastore_pool = server.one.datastorepool.info(auth)[1]
99     datastores = {}
100     for datastore in _get_xml(datastore_pool):
101         datastores[datastore.find("NAME").text] = _xml_to_dict(datastore)
102     return datastores
103 def list_hosts(call=None):
104     if call == "action":
105         raise SaltCloudSystemExit(
106             "The list_hosts function must be called with -f or --function."
107         )
108     return avail_locations()
109 def list_nodes(call=None):
110     if call == "action":
111         raise SaltCloudSystemExit(
112             "The list_nodes function must be called with -f or --function."
113         )
114     return _list_nodes(full=False)
115 def list_nodes_full(call=None):
116     if call == "action":
117         raise SaltCloudSystemExit(
118             "The list_nodes_full function must be called with -f or --function."
119         )
120     return _list_nodes(full=True)
121 def list_nodes_select(call=None):
122     if call == "action":
123         raise SaltCloudSystemExit(
124             "The list_nodes_full function must be called with -f or --function."
125         )
126     return __utils__["cloud.list_nodes_select"](
127         list_nodes_full("function"),
128         __opts__["query.selection"],
129         call,
130     )
131 def list_security_groups(call=None):
132     if call == "action":
133         raise SaltCloudSystemExit(
134             "The list_security_groups function must be called with -f or --function."
135         )
136     server, user, password = _get_xml_rpc()
137     auth = ":".join([user, password])
138     secgroup_pool = server.one.secgrouppool.info(auth, -2, -1, -1)[1]
139     groups = {}
140     for group in _get_xml(secgroup_pool):
141         groups[group.find("NAME").text] = _xml_to_dict(group)
142     return groups
143 def list_templates(call=None):
144     if call == "action":
145         raise SaltCloudSystemExit(
146             "The list_templates function must be called with -f or --function."
147         )
148     server, user, password = _get_xml_rpc()
149     auth = ":".join([user, password])
150     template_pool = server.one.templatepool.info(auth, -2, -1, -1)[1]
151     templates = {}
152     for template in _get_xml(template_pool):
153         templates[template.find("NAME").text] = _xml_to_dict(template)
154     return templates
155 def list_vns(call=None):
156     if call == "action":
157         raise SaltCloudSystemExit(
158             "The list_vns function must be called with -f or --function."
159         )
160     server, user, password = _get_xml_rpc()
161     auth = ":".join([user, password])
162     vn_pool = server.one.vnpool.info(auth, -2, -1, -1)[1]
163     vns = {}
164     for v_network in _get_xml(vn_pool):
165         vns[v_network.find("NAME").text] = _xml_to_dict(v_network)
166     return vns
167 def reboot(name, call=None):
168     if call != "action":
169         raise SaltCloudSystemExit(
170             "The start action must be called with -a or --action."
171         )
172     log.info("Rebooting node %s", name)
173     return vm_action(name, kwargs={"action": "reboot"}, call=call)
174 def start(name, call=None):
175     if call != "action":
176         raise SaltCloudSystemExit(
177             "The start action must be called with -a or --action."
178         )
179     log.info("Starting node %s", name)
180     return vm_action(name, kwargs={"action": "resume"}, call=call)
181 def stop(name, call=None):
182     if call != "action":
183         raise SaltCloudSystemExit(
184             "The start action must be called with -a or --action."
185         )
186     log.info("Stopping node %s", name)
187     return vm_action(name, kwargs={"action": "stop"}, call=call)
188 def get_one_version(kwargs=None, call=None):
189     if call == "action":
190         raise SaltCloudSystemExit(
191             "The get_cluster_id function must be called with -f or --function."
192         )
193     if kwargs is None:
194         kwargs = {}
195     server, user, password = _get_xml_rpc()
196     auth = ":".join([user, password])
197     return server.one.system.version(auth)[1]
198 def get_cluster_id(kwargs=None, call=None):
199     if call == "action":
200         raise SaltCloudSystemExit(
201             "The get_cluster_id function must be called with -f or --function."
202         )
203     if kwargs is None:
204         kwargs = {}
205     name = kwargs.get("name", None)
206     if name is None:
207         raise SaltCloudSystemExit("The get_cluster_id function requires a name.")
208     try:
209         ret = list_clusters()[name]["id"]
210     except KeyError:
211         raise SaltCloudSystemExit("The cluster '{}' could not be found".format(name))
212     return ret
213 def get_datastore_id(kwargs=None, call=None):
214     if call == "action":
215         raise SaltCloudSystemExit(
216             "The get_datastore_id function must be called with -f or --function."
217         )
218     if kwargs is None:
219         kwargs = {}
220     name = kwargs.get("name", None)
221     if name is None:
222         raise SaltCloudSystemExit("The get_datastore_id function requires a name.")
223     try:
224         ret = list_datastores()[name]["id"]
225     except KeyError:
226         raise SaltCloudSystemExit("The datastore '{}' could not be found.".format(name))
227     return ret
228 def get_host_id(kwargs=None, call=None):
229     if call == "action":
230         raise SaltCloudSystemExit(
231             "The get_host_id function must be called with -f or --function."
232         )
233     if kwargs is None:
234         kwargs = {}
235     name = kwargs.get("name", None)
236     if name is None:
237         raise SaltCloudSystemExit("The get_host_id function requires a name.")
238     try:
239         ret = avail_locations()[name]["id"]
240     except KeyError:
241         raise SaltCloudSystemExit("The host '{}' could not be found".format(name))
242     return ret
243 def get_image(vm_):
244     r"""
245     Return the image object to use.
246     vm\_
247         The VM dictionary for which to obtain an image.
248     Returns an image's ID from the given image name.
249     .. versionadded:: 2016.3.0
250     CLI Example:
251     .. code-block:: bash
252         salt-cloud -f get_image_id opennebula name=my-image-name
253     locations = avail_locations()
254     vm_location = str(
255         config.get_cloud_config_value("location", vm_, __opts__, search_global=False)
256     )
257     if vm_location == "None":
258         return None
259     for location in locations:
260         if vm_location in (locations[location]["name"], locations[location]["id"]):
261             return locations[location]["id"]
262     raise SaltCloudNotFound(
263         "The specified location, '{}', could not be found.".format(vm_location)
264     )
265 def get_secgroup_id(kwargs=None, call=None):
266     if call == "action":
267         raise SaltCloudSystemExit(
268             "The get_secgroup_id function must be called with -f or --function."
269         )
270     if kwargs is None:
271         kwargs = {}
272     name = kwargs.get("name", None)
273     if name is None:
274         raise SaltCloudSystemExit("The get_secgroup_id function requires a 'name'.")
275     try:
276         ret = list_security_groups()[name]["id"]
277     except KeyError:
278         raise SaltCloudSystemExit(
279             "The security group '{}' could not be found.".format(name)
280         )
281     return ret
282 def get_template_image(kwargs=None, call=None):
283     if call == "action":
284         raise SaltCloudSystemExit(
285             "The get_template_image function must be called with -f or --function."
286         )
287     if kwargs is None:
288         kwargs = {}
289     name = kwargs.get("name", None)
290     if name is None:
291         raise SaltCloudSystemExit("The get_template_image function requires a 'name'.")
292     try:
293         ret = list_templates()[name]["template"]["disk"]["image"]
294     except KeyError:
295         raise SaltCloudSystemExit(
296             "The image for template '{}' could not be found.".format(name)
297         )
298     return ret
299 def get_template_id(kwargs=None, call=None):
300     if call == "action":
301         raise SaltCloudSystemExit(
302             "The get_template_id function must be called with -f or --function."
303         )
304     if kwargs is None:
305         kwargs = {}
306     name = kwargs.get("name", None)
307     if name is None:
308         raise SaltCloudSystemExit("The get_template_id function requires a 'name'.")
309     try:
310         ret = list_templates()[name]["id"]
311     except KeyError:
312         raise SaltCloudSystemExit("The template '{}' could not be found.".format(name))
313     return ret
314 def get_template(vm_):
315     r"""
316     Return the template id for a VM.
317     .. versionadded:: 2016.11.0
318     vm\_
319         The VM dictionary for which to obtain a template.
320     Returns a virtual machine's ID from the given virtual machine's name.
321     .. versionadded:: 2016.3.0
322     CLI Example:
323     .. code-block:: bash
324         salt-cloud -f get_vm_id opennebula name=my-vm
325     Returns a virtual network's ID from the given virtual network's name.
326     .. versionadded:: 2016.3.0
327     CLI Example:
328     .. code-block:: bash
329         salt-cloud -f get_vn_id opennebula name=my-vn-name
330     Returns the template format to create a disk in open nebula
331     .. versionadded:: 2018.3.0
332     try:
333         if (
334             vm_["profile"]
335             and config.is_profile_configured(
336                 __opts__, _get_active_provider_name() or "opennebula", vm_["profile"]
337             )
338             is False
339         ):
340             return False
341     except AttributeError:
342         pass
343     __utils__["cloud.fire_event"](
344         "event",
345         "starting create",
346         "salt/cloud/{}/creating".format(vm_["name"]),
347         args=__utils__["cloud.filter_event"](
348             "creating", vm_, ["name", "profile", "provider", "driver"]
349         ),
350         sock_dir=__opts__["sock_dir"],
351         transport=__opts__["transport"],
352     )
353     log.info("Creating Cloud VM %s", vm_["name"])
354     kwargs = {
355         "name": vm_["name"],
356         "template_id": get_template(vm_),
357         "region_id": get_location(vm_),
358     }
359     if "template" in vm_:
360         kwargs["image_id"] = get_template_id({"name": vm_["template"]})
361     private_networking = config.get_cloud_config_value(
362         "private_networking", vm_, __opts__, search_global=False, default=None
363     )
364     kwargs["private_networking"] = "true" if private_networking else "false"
365     __utils__["cloud.fire_event"](
366         "event",
367         "requesting instance",
368         "salt/cloud/{}/requesting".format(vm_["name"]),
369         args={
370             "kwargs": __utils__["cloud.filter_event"](
371                 "requesting", kwargs, list(kwargs)
372             ),
373         },
374         sock_dir=__opts__["sock_dir"],
375     )
376     template = []
377     if kwargs.get("region_id"):
378         template.append('SCHED_REQUIREMENTS="ID={}"'.format(kwargs.get("region_id")))
379     if vm_.get("memory"):
380         template.append("MEMORY={}".format(vm_.get("memory")))
381     if vm_.get("cpu"):
382         template.append("CPU={}".format(vm_.get("cpu")))
383     if vm_.get("vcpu"):
384         template.append("VCPU={}".format(vm_.get("vcpu")))
385     if vm_.get("disk"):
386         get_disks = vm_.get("disk")
387         template_name = vm_["image"]
388         for disk in get_disks:
389             template.append(
390                 _get_device_template(disk, get_disks[disk], template=template_name)
391             )
392         if "CLONE" not in str(template):
393             raise SaltCloudSystemExit(
394                 "Missing an image disk to clone. Must define a clone disk alongside all"
395                 " other disk definitions."
396             )
397     template_args = "\n".join(template)
398     try:
399         server, user, password = _get_xml_rpc()
400         auth = ":".join([user, password])
401         cret = server.one.template.instantiate(
402             auth, int(kwargs["template_id"]), kwargs["name"], False, template_args
403         )
404         if not cret[0]:
405             log.error(
406                 "Error creating %s on OpenNebula\n\n"
407                 "The following error was returned when trying to "
408                 "instantiate the template: %s",
409                 vm_["name"],
410                 cret[1],
411                 exc_info_on_loglevel=logging.DEBUG,
412             )
413             return False
414     except Exception as exc:  # pylint: disable=broad-except
415         log.error(
416             "Error creating %s on OpenNebula\n\n"
417             "The following exception was thrown when trying to "
418             "run the initial deployment: %s",
419             vm_["name"],
420             exc,
421             exc_info_on_loglevel=logging.DEBUG,
422         )
423         return False
424     fqdn = vm_.get("fqdn_base")
425     if fqdn is not None:
426         fqdn = "{}.{}".format(vm_["name"], fqdn)
427     def __query_node_data(vm_name):
428         node_data = show_instance(vm_name, call="action")
429         if not node_data:
430             return False
431         if node_data["state"] == "7":
432             return False
433         if node_data["lcm_state"] == "3":
434             return node_data
435     try:
436         data = __utils__["cloud.wait_for_ip"](
437             __query_node_data,
438             update_args=(vm_["name"],),
439             timeout=config.get_cloud_config_value(
440                 "wait_for_ip_timeout", vm_, __opts__, default=10 * 60
441             ),
442             interval=config.get_cloud_config_value(
443                 "wait_for_ip_interval", vm_, __opts__, default=2
444             ),
445         )
446     except (SaltCloudExecutionTimeout, SaltCloudExecutionFailure) as exc:
447         try:
448             destroy(vm_["name"])
449         except SaltCloudSystemExit:
450             pass
451         finally:
452             raise SaltCloudSystemExit(str(exc))
453     key_filename = config.get_cloud_config_value(
454         "private_key", vm_, __opts__, search_global=False, default=None
455     )
456     if key_filename is not None and not os.path.isfile(key_filename):
457         raise SaltCloudConfigError(
458             "The defined key_filename '{}' does not exist".format(key_filename)
459         )
460     if fqdn:
461         vm_["ssh_host"] = fqdn
462         private_ip = "0.0.0.0"
463     else:
464         try:
465             private_ip = data["private_ips"][0]
466         except KeyError:
467             try:
468                 private_ip = data["template"]["nic"]["ip"]
469             except KeyError:
470                 private_ip = data["template"]["nic"]["ip6_global"]
471             vm_["ssh_host"] = private_ip
472     ssh_username = config.get_cloud_config_value(
473         "ssh_username", vm_, __opts__, default="root"
474     )
475     vm_["username"] = ssh_username
476     vm_["key_filename"] = key_filename
477     ret = __utils__["cloud.bootstrap"](vm_, __opts__)
478     ret["id"] = data["id"]
479     ret["image"] = vm_["image"]
480     ret["name"] = vm_["name"]
481     ret["size"] = data["template"]["memory"]
482     ret["state"] = data["state"]
483     ret["private_ips"] = private_ip
484     ret["public_ips"] = []
485     log.info("Created Cloud VM '%s'", vm_["name"])
486     log.debug("'%s' VM creation details:\n%s", vm_["name"], pprint.pformat(data))
487     __utils__["cloud.fire_event"](
488         "event",
489         "created instance",
490         "salt/cloud/{}/created".format(vm_["name"]),
491         args=__utils__["cloud.filter_event"](
492             "created", vm_, ["name", "profile", "provider", "driver"]
493         ),
494         sock_dir=__opts__["sock_dir"],
495     )
496     return ret
497 def destroy(name, call=None):
498     if call == "function":
499         raise SaltCloudSystemExit(
500             "The destroy action must be called with -d, --destroy, -a or --action."
501         )
502     __utils__["cloud.fire_event"](
503         "event",
504         "destroying instance",
505         "salt/cloud/{}/destroying".format(name),
506         args={"name": name},
507         sock_dir=__opts__["sock_dir"],
508     )
509     server, user, password = _get_xml_rpc()
510     auth = ":".join([user, password])
511     data = show_instance(name, call="action")
512     node = server.one.vm.action(auth, "delete", int(data["id"]))
513     __utils__["cloud.fire_event"](
514         "event",
515         "destroyed instance",
516         "salt/cloud/{}/destroyed".format(name),
517         args={"name": name},
518         sock_dir=__opts__["sock_dir"],
519     )
520     if __opts__.get("update_cachedir", False) is True:
521         __utils__["cloud.delete_minion_cachedir"](
522             name, _get_active_provider_name().split(":")[0], __opts__
523         )
524     data = {
525         "action": "vm.delete",
526         "deleted": node[0],
527         "node_id": node[1],
528         "error_code": node[2],
529     }
530     return data
531 def image_allocate(call=None, kwargs=None):
532     if call != "function":
533         raise SaltCloudSystemExit(
534             "The image_allocate function must be called with -f or --function."
535         )
536         kwargs = {}
537     path <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= kwargs.get("path", None)
538     data = kwargs.get("data", None)
539     datastore_id = kwargs.get("datastore_id", None)
540     datastore_name = kwargs.get(</b></font>"datastore_name", None)
541     if datastore_id:
542         if datastore_name:
543             log.warning(
544                 "Both a 'datastore_id' and a 'datastore_name' were provided. "
545                 "'datastore_id' will take precedence."
546             )
547     elif datastore_name:
548         datastore_id = get_datastore_id(kwargs={"name": datastore_name})
549     else:
550         raise SaltCloudSystemExit(
551             "The image_allocate function requires either a 'datastore_id' or a "
552             "'datastore_name' to be provided."
553         )
554     if data:
555         if path:
556             log.warning(
557                 "Both the 'data' and 'path' arguments were provided. "
558                 "'data' will take precedence."
559             )
560     elif path:
561         with salt.utils.files.fopen(path, mode="r") as rfh:
562             data = rfh.read()
563     else:
564         raise SaltCloudSystemExit(
565             "The image_allocate function requires either a file 'path' or 'data' "
566             "to be provided."
567         )
568     server, user, password = _get_xml_rpc()
569     auth = ":".join([user, password])
570     response = server.one.image.allocate(auth, data, int(datastore_id))
571     ret = {
572         "action": "image.allocate",
573         "allocated": response[0],
574         "image_id": response[1],
575         "error_code": response[2],
576     }
577     return ret
578 def image_clone(call=None, kwargs=None):
579     if call != "function":
580         raise SaltCloudSystemExit(
581             "The image_clone function must be called with -f or --function."
582         )
583     if kwargs is None:
584         kwargs = {}
585     name = kwargs.get("name", None)
586     image_id = kwargs.get("image_id", None)
587     image_name = kwargs.get("image_name", None)
588     if name is None:
589         raise SaltCloudSystemExit(
590             "The image_clone function requires a 'name' to be provided."
591         )
592     if image_id:
593         if image_name:
594             log.warning(
595                 "Both the 'image_id' and 'image_name' arguments were provided. "
596                 "'image_id' will take precedence."
597             )
598     elif image_name:
599         image_id = get_image_id(kwargs={"name": image_name})
600     else:
601         raise SaltCloudSystemExit(
602             "The image_clone function requires either an 'image_id' or an "
603             "'image_name' to be provided."
604         )
605     server, user, password = _get_xml_rpc()
606     auth = ":".join([user, password])
607     response = server.one.image.clone(auth, int(image_id), name)
608     data = {
609         "action": "image.clone",
610         "cloned": response[0],
611         "cloned_image_id": response[1],
612         "cloned_image_name": name,
613         "error_code": response[2],
614     }
615     return data
616 def image_delete(call=None, kwargs=None):
617     if call != "function":
618         raise SaltCloudSystemExit(
619             "The image_delete function must be called with -f or --function."
620         )
621     if kwargs is None:
622         kwargs = {}
623     name = kwargs.get("name", None)
624     image_id = kwargs.get("image_id", None)
625     if image_id:
626         if name:
627             log.warning(
628                 "Both the 'image_id' and 'name' arguments were provided. "
629                 "'image_id' will take precedence."
630             )
631     elif name:
632         image_id = get_image_id(kwargs={"name": name})
633     else:
634         raise SaltCloudSystemExit(
635             "The image_delete function requires either an 'image_id' or a "
636             "'name' to be provided."
637         )
638     server, user, password = _get_xml_rpc()
639     auth = ":".join([user, password])
640     response = server.one.image.delete(auth, int(image_id))
641     data = {
642         "action": "image.delete",
643         "deleted": response[0],
644         "image_id": response[1],
645         "error_code": response[2],
646     }
647     return data
648 def image_info(call=None, kwargs=None):
649     if call != "function":
650         raise SaltCloudSystemExit(
651             "The image_info function must be called with -f or --function."
652         )
653     if kwargs is None:
654         kwargs = {}
655     name = kwargs.get("name", None)
656     image_id = kwargs.get("image_id", None)
657     if image_id:
658         if name:
659             log.warning(
660                 "Both the 'image_id' and 'name' arguments were provided. "
661                 "'image_id' will take precedence."
662             )
663     elif name:
664         image_id = get_image_id(kwargs={"name": name})
665     else:
666         raise SaltCloudSystemExit(
667             "The image_info function requires either a 'name or an 'image_id' "
668             "to be provided."
669         )
670     server, user, password = _get_xml_rpc()
671     auth = ":".join([user, password])
672     info = {}
673     response = server.one.image.info(auth, int(image_id))[1]
674     tree = _get_xml(response)
675     info[tree.find("NAME").text] = _xml_to_dict(tree)
676     return info
677 def image_persistent(call=None, kwargs=None):
678     if call != "function":
679         raise SaltCloudSystemExit(
680             "The image_persistent function must be called with -f or --function."
681         )
682     if kwargs is None:
683         kwargs = {}
684     name = kwargs.get("name", None)
685     persist = kwargs.get("persist", None)
686     image_id = kwargs.get("image_id", None)
687     if persist is None:
688         raise SaltCloudSystemExit(
689             "The image_persistent function requires 'persist' to be set to 'True' "
690             "or 'False'."
691         )
692     if image_id:
693         if name:
694             log.warning(
695                 "Both the 'image_id' and 'name' arguments were provided. "
696                 "'image_id' will take precedence."
697             )
698     elif name:
699         image_id = get_image_id(kwargs={"name": name})
700     else:
701         raise SaltCloudSystemExit(
702             "The image_persistent function requires either a 'name' or an "
703             "'image_id' to be provided."
704         )
705     server, user, password = _get_xml_rpc()
706     auth = ":".join([user, password])
707     response = server.one.image.persistent(
708         auth, int(image_id), salt.utils.data.is_true(persist)
709     )
710     data = {
711         "action": "image.persistent",
712         "response": response[0],
713         "image_id": response[1],
714         "error_code": response[2],
715     }
716     return data
717 def image_snapshot_delete(call=None, kwargs=None):
718     if call != "function":
719         raise SaltCloudSystemExit(
720             "The image_snapshot_delete function must be called with -f or --function."
721         )
722     if kwargs is None:
723         kwargs = {}
724     image_id = kwargs.get("image_id", None)
725     image_name = kwargs.get("image_name", None)
726     snapshot_id = kwargs.get("snapshot_id", None)
727     if snapshot_id is None:
728         raise SaltCloudSystemExit(
729             "The image_snapshot_delete function requires a 'snapshot_id' to be"
730             " provided."
731         )
732     if image_id:
733         if image_name:
734             log.warning(
735                 "Both the 'image_id' and 'image_name' arguments were provided. "
736                 "'image_id' will take precedence."
737             )
738     elif image_name:
739         image_id = get_image_id(kwargs={"name": image_name})
740     else:
741         raise SaltCloudSystemExit(
742             "The image_snapshot_delete function requires either an 'image_id' "
743             "or a 'image_name' to be provided."
744         )
745     server, user, password = _get_xml_rpc()
746     auth = ":".join([user, password])
747     response = server.one.image.snapshotdelete(auth, int(image_id), int(snapshot_id))
748     data = {
749         "action": "image.snapshotdelete",
750         "deleted": response[0],
751         "snapshot_id": response[1],
752         "error_code": response[2],
753     }
754     return data
755 def image_snapshot_revert(call=None, kwargs=None):
756     if call != "function":
757         raise SaltCloudSystemExit(
758             "The image_snapshot_revert function must be called with -f or --function."
759         )
760     if kwargs is None:
761         kwargs = {}
762     image_id = kwargs.get("image_id", None)
763     image_name = kwargs.get("image_name", None)
764     snapshot_id = kwargs.get("snapshot_id", None)
765     if snapshot_id is None:
766         raise SaltCloudSystemExit(
767             "The image_snapshot_revert function requires a 'snapshot_id' to be"
768             " provided."
769         )
770     if image_id:
771         if image_name:
772             log.warning(
773                 "Both the 'image_id' and 'image_name' arguments were provided. "
774                 "'image_id' will take precedence."
775             )
776     elif image_name:
777         image_id = get_image_id(kwargs={"name": image_name})
778     else:
779         raise SaltCloudSystemExit(
780             "The image_snapshot_revert function requires either an 'image_id' or "
781             "an 'image_name' to be provided."
782         )
783     server, user, password = _get_xml_rpc()
784     auth = ":".join([user, password])
785     response = server.one.image.snapshotrevert(auth, int(image_id), int(snapshot_id))
786     data = {
787         "action": "image.snapshotrevert",
788         "reverted": response[0],
789         "snapshot_id": response[1],
790         "error_code": response[2],
791     }
792     return data
793 def image_snapshot_flatten(call=None, kwargs=None):
794     if call != "function":
795         raise SaltCloudSystemExit(
796             "The image_snapshot_flatten function must be called with -f or --function."
797         )
798     if kwargs is None:
799         kwargs = {}
800     image_id = kwargs.get("image_id", None)
801     image_name = kwargs.get("image_name", None)
802     snapshot_id = kwargs.get("snapshot_id", None)
803     if snapshot_id is None:
804         raise SaltCloudSystemExit(
805             "The image_stanpshot_flatten function requires a 'snapshot_id' "
806             "to be provided."
807         )
808     if image_id:
809         if image_name:
810             log.warning(
811                 "Both the 'image_id' and 'image_name' arguments were provided. "
812                 "'image_id' will take precedence."
813             )
814     elif image_name:
815         image_id = get_image_id(kwargs={"name": image_name})
816     else:
817         raise SaltCloudSystemExit(
818             "The image_snapshot_flatten function requires either an "
819             "'image_id' or an 'image_name' to be provided."
820         )
821     server, user, password = _get_xml_rpc()
822     auth = ":".join([user, password])
823     response = server.one.image.snapshotflatten(auth, int(image_id), int(snapshot_id))
824     data = {
825         "action": "image.snapshotflatten",
826         "flattened": response[0],
827         "snapshot_id": response[1],
828         "error_code": response[2],
829     }
830     return data
831 def image_update(call=None, kwargs=None):
832     if call != "function":
833         raise SaltCloudSystemExit(
834             "The image_allocate function must be called with -f or --function."
835         )
836         kwargs = {}
837     image_id = kwargs<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.get("image_id", None)
838     image_name = kwargs.get("image_name", None)
839     path = kwargs.get("path", None)
840     data = kwargs.get("data", None)
841     update_type = kwargs.get("update_type", None)
842     update_args =</b></font> ["replace", "merge"]
843     if update_type is None:
844         raise SaltCloudSystemExit(
845             "The image_update function requires an 'update_type' to be provided."
846         )
847     if update_type == update_args[0]:
848         update_number = 0
849     elif update_type == update_args[1]:
850         update_number = 1
851     else:
852         raise SaltCloudSystemExit(
853             "The update_type argument must be either {} or {}.".format(
854                 update_args[0], update_args[1]
855             )
856         )
857     if image_id:
858         if image_name:
859             log.warning(
860                 "Both the 'image_id' and 'image_name' arguments were provided. "
861                 "'image_id' will take precedence."
862             )
863     elif image_name:
864         image_id = get_image_id(kwargs={"name": image_name})
865     else:
866         raise SaltCloudSystemExit(
867             "The image_update function requires either an 'image_id' or an "
868             "'image_name' to be provided."
869         )
870     if data:
871         if path:
872             log.warning(
873                 "Both the 'data' and 'path' arguments were provided. "
874                 "'data' will take precedence."
875             )
876     elif path:
877         with salt.utils.files.fopen(path, mode="r") as rfh:
878             data = rfh.read()
879     else:
880         raise SaltCloudSystemExit(
881             "The image_update function requires either 'data' or a file 'path' "
882             "to be provided."
883         )
884     server, user, password = _get_xml_rpc()
885     auth = ":".join([user, password])
886     response = server.one.image.update(auth, int(image_id), data, int(update_number))
887     ret = {
888         "action": "image.update",
889         "updated": response[0],
890         "image_id": response[1],
891         "error_code": response[2],
892     }
893     return ret
894 def show_instance(name, call=None):
895     if call != "action":
896         raise SaltCloudSystemExit(
897             "The show_instance action must be called with -a or --action."
898         )
899     node = _get_node(name)
900     __utils__["cloud.cache_node"](node, _get_active_provider_name(), __opts__)
901     return node
902 def secgroup_allocate(call=None, kwargs=None):
903     if call != "function":
904         raise SaltCloudSystemExit(
905             "The secgroup_allocate function must be called with -f or --function."
906         )
907     if kwargs is None:
908         kwargs = {}
909     path = kwargs.get("path", None)
910     data = kwargs.get("data", None)
911     if data:
912         if path:
913             log.warning(
914                 "Both the 'data' and 'path' arguments were provided. "
915                 "'data' will take precedence."
916             )
917     elif path:
918         with salt.utils.files.fopen(path, mode="r") as rfh:
919             data = rfh.read()
920     else:
921         raise SaltCloudSystemExit(
922             "The secgroup_allocate function requires either 'data' or a file "
923             "'path' to be provided."
924         )
925     server, user, password = _get_xml_rpc()
926     auth = ":".join([user, password])
927     response = server.one.secgroup.allocate(auth, data)
928     ret = {
929         "action": "secgroup.allocate",
930         "allocated": response[0],
931         "secgroup_id": response[1],
932         "error_code": response[2],
933     }
934     return ret
935 def secgroup_clone(call=None, kwargs=None):
936     if call != "function":
937         raise SaltCloudSystemExit(
938             "The secgroup_clone function must be called with -f or --function."
939         )
940     if kwargs is None:
941         kwargs = {}
942     name = kwargs.get("name", None)
943     secgroup_id = kwargs.get("secgroup_id", None)
944     secgroup_name = kwargs.get("secgroup_name", None)
945     if name is None:
946         raise SaltCloudSystemExit(
947             "The secgroup_clone function requires a 'name' to be provided."
948         )
949     if secgroup_id:
950         if secgroup_name:
951             log.warning(
952                 "Both the 'secgroup_id' and 'secgroup_name' arguments were provided. "
953                 "'secgroup_id' will take precedence."
954             )
955     elif secgroup_name:
956         secgroup_id = get_secgroup_id(kwargs={"name": secgroup_name})
957     else:
958         raise SaltCloudSystemExit(
959             "The secgroup_clone function requires either a 'secgroup_id' or a "
960             "'secgroup_name' to be provided."
961         )
962     server, user, password = _get_xml_rpc()
963     auth = ":".join([user, password])
964     response = server.one.secgroup.clone(auth, int(secgroup_id), name)
965     data = {
966         "action": "secgroup.clone",
967         "cloned": response[0],
968         "cloned_secgroup_id": response[1],
969         "cloned_secgroup_name": name,
970         "error_code": response[2],
971     }
972     return data
973 def secgroup_delete(call=None, kwargs=None):
974     if call != "function":
975         raise SaltCloudSystemExit(
976             "The secgroup_delete function must be called with -f or --function."
977         )
978     if kwargs is None:
979         kwargs = {}
980     name = kwargs.get("name", None)
981     secgroup_id = kwargs.get("secgroup_id", None)
982     if secgroup_id:
983         if name:
984             log.warning(
985                 "Both the 'secgroup_id' and 'name' arguments were provided. "
986                 "'secgroup_id' will take precedence."
987             )
988     elif name:
989         secgroup_id = get_secgroup_id(kwargs={"name": name})
990     else:
991         raise SaltCloudSystemExit(
992             "The secgroup_delete function requires either a 'name' or a "
993             "'secgroup_id' to be provided."
994         )
995     server, user, password = _get_xml_rpc()
996     auth = ":".join([user, password])
997     response = server.one.secgroup.delete(auth, int(secgroup_id))
998     data = {
999         "action": "secgroup.delete",
1000         "deleted": response[0],
1001         "secgroup_id": response[1],
1002         "error_code": response[2],
1003     }
1004     return data
1005 def secgroup_info(call=None, kwargs=None):
1006     if call != "function":
1007         raise SaltCloudSystemExit(
1008             "The secgroup_info function must be called with -f or --function."
1009         )
1010     if kwargs is None:
1011         kwargs = {}
1012     name = kwargs.get("name", None)
1013     secgroup_id = kwargs.get("secgroup_id", None)
1014     if secgroup_id:
1015         if name:
1016             log.warning(
1017                 "Both the 'secgroup_id' and 'name' arguments were provided. "
1018                 "'secgroup_id' will take precedence."
1019             )
1020     elif name:
1021         secgroup_id = get_secgroup_id(kwargs={"name": name})
1022     else:
1023         raise SaltCloudSystemExit(
1024             "The secgroup_info function requires either a name or a secgroup_id "
1025             "to be provided."
1026         )
1027     server, user, password = _get_xml_rpc()
1028     auth = ":".join([user, password])
1029     info = {}
1030     response = server.one.secgroup.info(auth, int(secgroup_id))[1]
1031     tree = _get_xml(response)
1032     info[tree.find("NAME").text] = _xml_to_dict(tree)
1033     return info
1034 def secgroup_update(call=None, kwargs=None):
1035     if call != "function":
1036         raise SaltCloudSystemExit(
1037             "The secgroup_allocate function must be called with -f or --function."
1038         )
1039         kwargs = {}
1040     secgroup_id <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= kwargs.get("secgroup_id", None)
1041     secgroup_name = kwargs.get("secgroup_name", None)
1042     path = kwargs.get("path", None)
1043     data = kwargs.get("data", None)
1044     update_type =</b></font> kwargs.get("update_type", None)
1045     update_args = ["replace", "merge"]
1046     if update_type is None:
1047         raise SaltCloudSystemExit(
1048             "The secgroup_update function requires an 'update_type' to be provided."
1049         )
1050     if update_type == update_args[0]:
1051         update_number = 0
1052     elif update_type == update_args[1]:
1053         update_number = 1
1054     else:
1055         raise SaltCloudSystemExit(
1056             "The update_type argument must be either {} or {}.".format(
1057                 update_args[0], update_args[1]
1058             )
1059         )
1060     if secgroup_id:
1061         if secgroup_name:
1062             log.warning(
1063                 "Both the 'secgroup_id' and 'secgroup_name' arguments were provided. "
1064                 "'secgroup_id' will take precedence."
1065             )
1066     elif secgroup_name:
1067         secgroup_id = get_secgroup_id(kwargs={"name": secgroup_name})
1068     else:
1069         raise SaltCloudSystemExit(
1070             "The secgroup_update function requires either a 'secgroup_id' or a "
1071             "'secgroup_name' to be provided."
1072         )
1073     if data:
1074         if path:
1075             log.warning(
1076                 "Both the 'data' and 'path' arguments were provided. "
1077                 "'data' will take precedence."
1078             )
1079     elif path:
1080         with salt.utils.files.fopen(path, mode="r") as rfh:
1081             data = rfh.read()
1082     else:
1083         raise SaltCloudSystemExit(
1084             "The secgroup_update function requires either 'data' or a file 'path' "
1085             "to be provided."
1086         )
1087     server, user, password = _get_xml_rpc()
1088     auth = ":".join([user, password])
1089     response = server.one.secgroup.update(
1090         auth, int(secgroup_id), data, int(update_number)
1091     )
1092     ret = {
1093         "action": "secgroup.update",
1094         "updated": response[0],
1095         "secgroup_id": response[1],
1096         "error_code": response[2],
1097     }
1098     return ret
1099 def template_allocate(call=None, kwargs=None):
1100     if call != "function":
1101         raise SaltCloudSystemExit(
1102             "The template_allocate function must be called with -f or --function."
1103         )
1104     if kwargs is None:
1105         kwargs = {}
1106     path = kwargs.get("path", None)
1107     data = kwargs.get("data", None)
1108     if data:
1109         if path:
1110             log.warning(
1111                 "Both the 'data' and 'path' arguments were provided. "
1112                 "'data' will take precedence."
1113             )
1114     elif path:
1115         with salt.utils.files.fopen(path, mode="r") as rfh:
1116             data = rfh.read()
1117     else:
1118         raise SaltCloudSystemExit(
1119             "The template_allocate function requires either 'data' or a file "
1120             "'path' to be provided."
1121         )
1122     server, user, password = _get_xml_rpc()
1123     auth = ":".join([user, password])
1124     response = server.one.template.allocate(auth, data)
1125     ret = {
1126         "action": "template.allocate",
1127         "allocated": response[0],
1128         "template_id": response[1],
1129         "error_code": response[2],
1130     }
1131     return ret
1132 def template_clone(call=None, kwargs=None):
1133     if call != "function":
1134         raise SaltCloudSystemExit(
1135             "The template_clone function must be called with -f or --function."
1136         )
1137         kwargs = {}
1138     name <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= kwargs.get("name", None)
1139     template_id = kwargs.get("template_id", None)
1140     template_name = kwargs.get("template_name", None)
1141     clone_images = kwargs.get(</b></font>"clone_images", False)
1142     if name is None:
1143         raise SaltCloudSystemExit(
1144             "The template_clone function requires a name to be provided."
1145         )
1146     if template_id:
1147         if template_name:
1148             log.warning(
1149                 "Both the 'template_id' and 'template_name' arguments were provided. "
1150                 "'template_id' will take precedence."
1151             )
1152     elif template_name:
1153         template_id = get_template_id(kwargs={"name": template_name})
1154     else:
1155         raise SaltCloudSystemExit(
1156             "The template_clone function requires either a 'template_id' "
1157             "or a 'template_name' to be provided."
1158         )
1159     server, user, password = _get_xml_rpc()
1160     auth = ":".join([user, password])
1161     response = server.one.template.clone(auth, int(template_id), name, clone_images)
1162     data = {
1163         "action": "template.clone",
1164         "cloned": response[0],
1165         "cloned_template_id": response[1],
1166         "cloned_template_name": name,
1167         "error_code": response[2],
1168     }
1169     return data
1170 def template_delete(call=None, kwargs=None):
1171     if call != "function":
1172         raise SaltCloudSystemExit(
1173             "The template_delete function must be called with -f or --function."
1174         )
1175     if kwargs is None:
1176         kwargs = {}
1177     name = kwargs.get("name", None)
1178     template_id = kwargs.get("template_id", None)
1179     if template_id:
1180         if name:
1181             log.warning(
1182                 "Both the 'template_id' and 'name' arguments were provided. "
1183                 "'template_id' will take precedence."
1184             )
1185     elif name:
1186         template_id = get_template_id(kwargs={"name": name})
1187     else:
1188         raise SaltCloudSystemExit(
1189             "The template_delete function requires either a 'name' or a 'template_id' "
1190             "to be provided."
1191         )
1192     server, user, password = _get_xml_rpc()
1193     auth = ":".join([user, password])
1194     response = server.one.template.delete(auth, int(template_id))
1195     data = {
1196         "action": "template.delete",
1197         "deleted": response[0],
1198         "template_id": response[1],
1199         "error_code": response[2],
1200     }
1201     return data
1202 def template_instantiate(call=None, kwargs=None):
1203     if call != "function":
1204         raise SaltCloudSystemExit(
1205             "The template_instantiate function must be called with -f or --function."
1206         )
1207     if kwargs is None:
1208         kwargs = {}
1209     vm_name = kwargs.get("vm_name", None)
1210     template_id = kwargs.get("template_id", None)
1211     template_name = kwargs.get("template_name", None)
1212     if vm_name is None:
1213         raise SaltCloudSystemExit(
1214             "The template_instantiate function requires a 'vm_name' to be provided."
1215         )
1216     if template_id:
1217         if template_name:
1218             log.warning(
1219                 "Both the 'template_id' and 'template_name' arguments were provided. "
1220                 "'template_id' will take precedence."
1221             )
1222     elif template_name:
1223         template_id = get_template_id(kwargs={"name": template_name})
1224     else:
1225         raise SaltCloudSystemExit(
1226             "The template_instantiate function requires either a 'template_id' "
1227             "or a 'template_name' to be provided."
1228         )
1229     server, user, password = _get_xml_rpc()
1230     auth = ":".join([user, password])
1231     response = server.one.template.instantiate(auth, int(template_id), vm_name)
1232     data = {
1233         "action": "template.instantiate",
1234         "instantiated": response[0],
1235         "instantiated_vm_id": response[1],
1236         "vm_name": vm_name,
1237         "error_code": response[2],
1238     }
1239     return data
1240 def template_update(call=None, kwargs=None):
1241     if call != "function":
1242         raise SaltCloudSystemExit(
1243             "The template_update function must be called with -f or --function."
1244         )
1245         kwargs = {}
1246     template_id <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= kwargs.get("template_id", None)
1247     template_name = kwargs.get("template_name", None)
1248     path = kwargs.get("path", None)
1249     data = kwargs.get(</b></font>"data", None)
1250     update_type = kwargs.get("update_type", None)
1251     update_args = ["replace", "merge"]
1252     if update_type is None:
1253         raise SaltCloudSystemExit(
1254             "The template_update function requires an 'update_type' to be provided."
1255         )
1256     if update_type == update_args[0]:
1257         update_number = 0
1258     elif update_type == update_args[1]:
1259         update_number = 1
1260     else:
1261         raise SaltCloudSystemExit(
1262             "The update_type argument must be either {} or {}.".format(
1263                 update_args[0], update_args[1]
1264             )
1265         )
1266     if template_id:
1267         if template_name:
1268             log.warning(
1269                 "Both the 'template_id' and 'template_name' arguments were provided. "
1270                 "'template_id' will take precedence."
1271             )
1272     elif template_name:
1273         template_id = get_template_id(kwargs={"name": template_name})
1274     else:
1275         raise SaltCloudSystemExit(
1276             "The template_update function requires either a 'template_id' "
1277             "or a 'template_name' to be provided."
1278         )
1279     if data:
1280         if path:
1281             log.warning(
1282                 "Both the 'data' and 'path' arguments were provided. "
1283                 "'data' will take precedence."
1284             )
1285     elif path:
1286         with salt.utils.files.fopen(path, mode="r") as rfh:
1287             data = rfh.read()
1288     else:
1289         raise SaltCloudSystemExit(
1290             "The template_update function requires either 'data' or a file "
1291             "'path' to be provided."
1292         )
1293     server, user, password = _get_xml_rpc()
1294     auth = ":".join([user, password])
1295     response = server.one.template.update(
1296         auth, int(template_id), data, int(update_number)
1297     )
1298     ret = {
1299         "action": "template.update",
1300         "updated": response[0],
1301         "template_id": response[1],
1302         "error_code": response[2],
1303     }
1304     return ret
1305 def vm_action(name, kwargs=None, call=None):
1306     if call != "action":
1307         raise SaltCloudSystemExit(
1308             "The vm_action function must be called with -a or --action."
1309         )
1310     if kwargs is None:
1311         kwargs = {}
1312     action = kwargs.get("action", None)
1313     if action is None:
1314         raise SaltCloudSystemExit(
1315             "The vm_action function must have an 'action' provided."
1316         )
1317     server, user, password = _get_xml_rpc()
1318     auth = ":".join([user, password])
1319     vm_id = int(get_vm_id(kwargs={"name": name}))
1320     response = server.one.vm.action(auth, action, vm_id)
1321     data = {
1322         "action": "vm.action." + str(action),
1323         "actioned": response[0],
1324         "vm_id": response[1],
1325         "error_code": response[2],
1326     }
1327     return data
1328 def vm_allocate(call=None, kwargs=None):
1329     if call != "function":
1330         raise SaltCloudSystemExit(
1331             "The vm_allocate function must be called with -f or --function."
1332         )
1333     if kwargs is None:
1334         kwargs = {}
1335     path = kwargs.get("path", None)
1336     data = kwargs.get("data", None)
1337     hold = kwargs.get("hold", False)
1338     if data:
1339         if path:
1340             log.warning(
1341                 "Both the 'data' and 'path' arguments were provided. "
1342                 "'data' will take precedence."
1343             )
1344     elif path:
1345         with salt.utils.files.fopen(path, mode="r") as rfh:
1346             data = rfh.read()
1347     else:
1348         raise SaltCloudSystemExit(
1349             "The vm_allocate function requires either 'data' or a file 'path' "
1350             "to be provided."
1351         )
1352     server, user, password = _get_xml_rpc()
1353     auth = ":".join([user, password])
1354     response = server.one.vm.allocate(auth, data, salt.utils.data.is_true(hold))
1355     ret = {
1356         "action": "vm.allocate",
1357         "allocated": response[0],
1358         "vm_id": response[1],
1359         "error_code": response[2],
1360     }
1361     return ret
1362 def vm_attach(name, kwargs=None, call=None):
1363     if call != "action":
1364         raise SaltCloudSystemExit(
1365             "The vm_attach action must be called with -a or --action."
1366         )
1367     if kwargs is None:
1368         kwargs = {}
1369     path = kwargs.get("path", None)
1370     data = kwargs.get("data", None)
1371     if data:
1372         if path:
1373             log.warning(
1374                 "Both the 'data' and 'path' arguments were provided. "
1375                 "'data' will take precedence."
1376             )
1377     elif path:
1378         with salt.utils.files.fopen(path, mode="r") as rfh:
1379             data = rfh.read()
1380     else:
1381         raise SaltCloudSystemExit(
1382             "The vm_attach function requires either 'data' or a file "
1383             "'path' to be provided."
1384         )
1385     server, user, password = _get_xml_rpc()
1386     auth = ":".join([user, password])
1387     vm_id = int(get_vm_id(kwargs={"name": name}))
1388     response = server.one.vm.attach(auth, vm_id, data)
1389     ret = {
1390         "action": "vm.attach",
1391         "attached": response[0],
1392         "vm_id": response[1],
1393         "error_code": response[2],
1394     }
1395     return ret
1396 def vm_attach_nic(name, kwargs=None, call=None):
1397     if call != "action":
1398         raise SaltCloudSystemExit(
1399             "The vm_attach_nic action must be called with -a or --action."
1400         )
1401     if kwargs is None:
1402         kwargs = {}
1403     path = kwargs.get("path", None)
1404     data = kwargs.get("data", None)
1405     if data:
1406         if path:
1407             log.warning(
1408                 "Both the 'data' and 'path' arguments were provided. "
1409                 "'data' will take precedence."
1410             )
1411     elif path:
1412         with salt.utils.files.fopen(path, mode="r") as rfh:
1413             data = rfh.read()
1414     else:
1415         raise SaltCloudSystemExit(
1416             "The vm_attach_nic function requires either 'data' or a file "
1417             "'path' to be provided."
1418         )
1419     server, user, password = _get_xml_rpc()
1420     auth = ":".join([user, password])
1421     vm_id = int(get_vm_id(kwargs={"name": name}))
1422     response = server.one.vm.attachnic(auth, vm_id, data)
1423     ret = {
1424         "action": "vm.attachnic",
1425         "nic_attached": response[0],
1426         "vm_id": response[1],
1427         "error_code": response[2],
1428     }
1429     return ret
1430 def vm_deploy(name, kwargs=None, call=None):
1431     if call != "action":
1432         raise SaltCloudSystemExit(
1433             "The vm_deploy action must be called with -a or --action."
1434         )
1435     if kwargs is None:
1436         kwargs = {}
1437     host_id = kwargs.get("host_id", None)
1438     host_name = kwargs.get("host_name", None)
1439     capacity_maintained = kwargs.get("capacity_maintained", True)
1440     datastore_id = kwargs.get("datastore_id", None)
1441     datastore_name = kwargs.get("datastore_name", None)
1442     if host_id:
1443         if host_name:
1444             log.warning(
1445                 "Both the 'host_id' and 'host_name' arguments were provided. "
1446                 "'host_id' will take precedence."
1447             )
1448     elif host_name:
1449         host_id = get_host_id(kwargs={"name": host_name})
1450     else:
1451         raise SaltCloudSystemExit(
1452             "The vm_deploy function requires a 'host_id' or a 'host_name' "
1453             "to be provided."
1454         )
1455     if datastore_id:
1456         if datastore_name:
1457             log.warning(
1458                 "Both the 'datastore_id' and 'datastore_name' arguments were provided. "
1459                 "'datastore_id' will take precedence."
1460             )
1461     elif datastore_name:
1462         datastore_id = get_datastore_id(kwargs={"name": datastore_name})
1463     else:
1464         datastore_id = "-1"
1465     server, user, password = _get_xml_rpc()
1466     auth = ":".join([user, password])
1467     vm_id = get_vm_id(kwargs={"name": name})
1468     response = server.one.vm.deploy(
1469         auth,
1470         int(vm_id),
1471         int(host_id),
1472         salt.utils.data.is_true(capacity_maintained),
1473         int(datastore_id),
1474     )
1475     data = {
1476         "action": "vm.deploy",
1477         "deployed": response[0],
1478         "vm_id": response[1],
1479         "error_code": response[2],
1480     }
1481     return data
1482 def vm_detach(name, kwargs=None, call=None):
1483     if call != "action":
1484         raise SaltCloudSystemExit(
1485             "The vm_detach action must be called with -a or --action."
1486         )
1487     if kwargs is None:
1488         kwargs = {}
1489     disk_id = kwargs.get("disk_id", None)
1490     if disk_id is None:
1491         raise SaltCloudSystemExit(
1492             "The vm_detach function requires a 'disk_id' to be provided."
1493         )
1494     server, user, password = _get_xml_rpc()
1495     auth = ":".join([user, password])
1496     vm_id = int(get_vm_id(kwargs={"name": name}))
1497     response = server.one.vm.detach(auth, vm_id, int(disk_id))
1498     data = {
1499         "action": "vm.detach",
1500         "detached": response[0],
1501         "vm_id": response[1],
1502         "error_code": response[2],
1503     }
1504     return data
1505 def vm_detach_nic(name, kwargs=None, call=None):
1506     if call != "action":
1507         raise SaltCloudSystemExit(
1508             "The vm_detach_nic action must be called with -a or --action."
1509         )
1510     if kwargs is None:
1511         kwargs = {}
1512     nic_id = kwargs.get("nic_id", None)
1513     if nic_id is None:
1514         raise SaltCloudSystemExit(
1515             "The vm_detach_nic function requires a 'nic_id' to be provided."
1516         )
1517     server, user, password = _get_xml_rpc()
1518     auth = ":".join([user, password])
1519     vm_id = int(get_vm_id(kwargs={"name": name}))
1520     response = server.one.vm.detachnic(auth, vm_id, int(nic_id))
1521     data = {
1522         "action": "vm.detachnic",
1523         "nic_detached": response[0],
1524         "vm_id": response[1],
1525         "error_code": response[2],
1526     }
1527     return data
1528 def vm_disk_save(name, kwargs=None, call=None):
1529     if call != "action":
1530         raise SaltCloudSystemExit(
1531             "The vm_disk_save action must be called with -a or --action."
1532         )
1533     if kwargs is None:
1534         kwargs = {}
1535     disk_id = kwargs.get("disk_id", None)
1536     image_name = kwargs.get("image_name", None)
1537     image_type = kwargs.get("image_type", "")
1538     snapshot_id = int(kwargs.get("snapshot_id", "-1"))
1539     if disk_id is None or image_name is None:
1540         raise SaltCloudSystemExit(
1541             "The vm_disk_save function requires a 'disk_id' and an 'image_name' "
1542             "to be provided."
1543         )
1544     server, user, password = _get_xml_rpc()
1545     auth = ":".join([user, password])
1546     vm_id = int(get_vm_id(kwargs={"name": name}))
1547     response = server.one.vm.disksave(
1548         auth, vm_id, int(disk_id), image_name, image_type, snapshot_id
1549     )
1550     data = {
1551         "action": "vm.disksave",
1552         "saved": response[0],
1553         "image_id": response[1],
1554         "error_code": response[2],
1555     }
1556     return data
1557 def vm_disk_snapshot_create(name, kwargs=None, call=None):
1558     if call != "action":
1559         raise SaltCloudSystemExit(
1560             "The vm_disk_snapshot_create action must be called with -a or --action."
1561         )
1562     if kwargs is None:
1563         kwargs = {}
1564     disk_id = kwargs.get("disk_id", None)
1565     description = kwargs.get("description", None)
1566     if disk_id is None or description is None:
1567         raise SaltCloudSystemExit(
1568             "The vm_disk_snapshot_create function requires a 'disk_id' and a"
1569             " 'description' to be provided."
1570         )
1571     server, user, password = _get_xml_rpc()
1572     auth = ":".join([user, password])
1573     vm_id = int(get_vm_id(kwargs={"name": name}))
1574     response = server.one.vm.disksnapshotcreate(auth, vm_id, int(disk_id), description)
1575     data = {
1576         "action": "vm.disksnapshotcreate",
1577         "created": response[0],
1578         "snapshot_id": response[1],
1579         "error_code": response[2],
1580     }
1581     return data
1582 def vm_disk_snapshot_delete(name, kwargs=None, call=None):
1583     if call != "action":
1584         raise SaltCloudSystemExit(
1585             "The vm_disk_snapshot_delete action must be called with -a or --action."
1586         )
1587     if kwargs is None:
1588         kwargs = {}
1589     disk_id = kwargs.get("disk_id", None)
1590     snapshot_id = kwargs.get("snapshot_id", None)
1591     if disk_id is None or snapshot_id is None:
1592         raise SaltCloudSystemExit(
1593             "The vm_disk_snapshot_create function requires a 'disk_id' and a"
1594             " 'snapshot_id' to be provided."
1595         )
1596     server, user, password = _get_xml_rpc()
1597     auth = ":".join([user, password])
1598     vm_id = int(get_vm_id(kwargs={"name": name}))
1599     response = server.one.vm.disksnapshotdelete(
1600         auth, vm_id, int(disk_id), int(snapshot_id)
1601     )
1602     data = {
1603         "action": "vm.disksnapshotdelete",
1604         "deleted": response[0],
1605         "snapshot_id": response[1],
1606         "error_code": response[2],
1607     }
1608     return data
1609 def vm_disk_snapshot_revert(name, kwargs=None, call=None):
1610     if call != "action":
1611         raise SaltCloudSystemExit(
1612             "The vm_disk_snapshot_revert action must be called with -a or --action."
1613         )
1614     if kwargs is None:
1615         kwargs = {}
1616     disk_id = kwargs.get("disk_id", None)
1617     snapshot_id = kwargs.get("snapshot_id", None)
1618     if disk_id is None or snapshot_id is None:
1619         raise SaltCloudSystemExit(
1620             "The vm_disk_snapshot_revert function requires a 'disk_id' and a"
1621             " 'snapshot_id' to be provided."
1622         )
1623     server, user, password = _get_xml_rpc()
1624     auth = ":".join([user, password])
1625     vm_id = int(get_vm_id(kwargs={"name": name}))
1626     response = server.one.vm.disksnapshotrevert(
1627         auth, vm_id, int(disk_id), int(snapshot_id)
1628     )
1629     data = {
1630         "action": "vm.disksnapshotrevert",
1631         "deleted": response[0],
1632         "snapshot_id": response[1],
1633         "error_code": response[2],
1634     }
1635     return data
1636 def vm_info(name, call=None):
1637     if call != "action":
1638         raise SaltCloudSystemExit(
1639             "The vm_info action must be called with -a or --action."
1640         )
1641     server, user, password = _get_xml_rpc()
1642     auth = ":".join([user, password])
1643     vm_id = int(get_vm_id(kwargs={"name": name}))
1644     response = server.one.vm.info(auth, vm_id)
1645     if response[0] is False:
1646         return response[1]
1647     else:
1648         info = {}
1649         tree = _get_xml(response[1])
1650         info[tree.find("NAME").text] = _xml_to_dict(tree)
1651         return info
1652 def vm_migrate(name, kwargs=None, call=None):
1653     if call != "action":
1654         raise SaltCloudSystemExit(
1655             "The vm_migrate action must be called with -a or --action."
1656         )
1657         kwargs = {}
1658     host_id <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= kwargs.get("host_id", None)
1659     host_name = kwargs.get("host_name", None)
1660     live_migration = kwargs.get("live_migration", False)
1661     capacity_maintained = kwargs.get("capacity_maintained", True)
1662     datastore_id = kwargs.get("datastore_id", None)
1663     datastore_name = kwargs.get(</b></font>"datastore_name", None)
1664     if datastore_id:
1665         if datastore_name:
1666             log.warning(
1667                 "Both the 'datastore_id' and 'datastore_name' arguments were provided. "
1668                 "'datastore_id' will take precedence."
1669             )
1670     elif datastore_name:
1671         datastore_id = get_datastore_id(kwargs={"name": datastore_name})
1672     else:
1673         raise SaltCloudSystemExit(
1674             "The vm_migrate function requires either a 'datastore_id' or a "
1675             "'datastore_name' to be provided."
1676         )
1677     if host_id:
1678         if host_name:
1679             log.warning(
1680                 "Both the 'host_id' and 'host_name' arguments were provided. "
1681                 "'host_id' will take precedence."
1682             )
1683     elif host_name:
1684         host_id = get_host_id(kwargs={"name": host_name})
1685     else:
1686         raise SaltCloudSystemExit(
1687             "The vm_migrate function requires either a 'host_id' "
1688             "or a 'host_name' to be provided."
1689         )
1690     server, user, password = _get_xml_rpc()
1691     auth = ":".join([user, password])
1692     vm_id = int(get_vm_id(kwargs={"name": name}))
1693     response = server.one.vm.migrate(
1694         auth,
1695         vm_id,
1696         int(host_id),
1697         salt.utils.data.is_true(live_migration),
1698         salt.utils.data.is_true(capacity_maintained),
1699         int(datastore_id),
1700     )
1701     data = {
1702         "action": "vm.migrate",
1703         "migrated": response[0],
1704         "vm_id": response[1],
1705         "error_code": response[2],
1706     }
1707     return data
1708 def vm_monitoring(name, call=None):
1709     if call != "action":
1710         raise SaltCloudSystemExit(
1711             "The vm_monitoring action must be called with -a or --action."
1712         )
1713     server, user, password = _get_xml_rpc()
1714     auth = ":".join([user, password])
1715     vm_id = int(get_vm_id(kwargs={"name": name}))
1716     response = server.one.vm.monitoring(auth, vm_id)
1717     if response[0] is False:
1718         log.error(
1719             "There was an error retrieving the specified VM's monitoring information."
1720         )
1721         return {}
1722     else:
1723         info = {}
1724         for vm_ in _get_xml(response[1]):
1725             info[vm_.find("ID").text] = _xml_to_dict(vm_)
1726         return info
1727 def vm_resize(name, kwargs=None, call=None):
1728     if call != "action":
1729         raise SaltCloudSystemExit(
1730             "The vm_resize action must be called with -a or --action."
1731         )
1732     if kwargs is None:
1733         kwargs = {}
1734     path = kwargs.get("path", None)
1735     data = kwargs.get("data", None)
1736     capacity_maintained = kwargs.get("capacity_maintained", True)
1737     if data:
1738         if path:
1739             log.warning(
1740                 "Both the 'data' and 'path' arguments were provided. "
1741                 "'data' will take precedence."
1742             )
1743     elif path:
1744         with salt.utils.files.fopen(path, mode="r") as rfh:
1745             data = rfh.read()
1746     else:
1747         raise SaltCloudSystemExit(
1748             "The vm_resize function requires either 'data' or a file 'path' "
1749             "to be provided."
1750         )
1751     server, user, password = _get_xml_rpc()
1752     auth = ":".join([user, password])
1753     vm_id = int(get_vm_id(kwargs={"name": name}))
1754     response = server.one.vm.resize(
1755         auth, vm_id, data, salt.utils.data.is_true(capacity_maintained)
1756     )
1757     ret = {
1758         "action": "vm.resize",
1759         "resized": response[0],
1760         "vm_id": response[1],
1761         "error_code": response[2],
1762     }
1763     return ret
1764 def vm_snapshot_create(vm_name, kwargs=None, call=None):
1765     if call != "action":
1766         raise SaltCloudSystemExit(
1767             "The vm_snapshot_create action must be called with -a or --action."
1768         )
1769     if kwargs is None:
1770         kwargs = {}
1771     snapshot_name = kwargs.get("snapshot_name", None)
1772     if snapshot_name is None:
1773         raise SaltCloudSystemExit(
1774             "The vm_snapshot_create function requires a 'snapshot_name' to be provided."
1775         )
1776     server, user, password = _get_xml_rpc()
1777     auth = ":".join([user, password])
1778     vm_id = int(get_vm_id(kwargs={"name": vm_name}))
1779     response = server.one.vm.snapshotcreate(auth, vm_id, snapshot_name)
1780     data = {
1781         "action": "vm.snapshotcreate",
1782         "snapshot_created": response[0],
1783         "snapshot_id": response[1],
1784         "error_code": response[2],
1785     }
1786     return data
1787 def vm_snapshot_delete(vm_name, kwargs=None, call=None):
1788     if call != "action":
1789         raise SaltCloudSystemExit(
1790             "The vm_snapshot_delete action must be called with -a or --action."
1791         )
1792     if kwargs is None:
1793         kwargs = {}
1794     snapshot_id = kwargs.get("snapshot_id", None)
1795     if snapshot_id is None:
1796         raise SaltCloudSystemExit(
1797             "The vm_snapshot_delete function requires a 'snapshot_id' to be provided."
1798         )
1799     server, user, password = _get_xml_rpc()
1800     auth = ":".join([user, password])
1801     vm_id = int(get_vm_id(kwargs={"name": vm_name}))
1802     response = server.one.vm.snapshotdelete(auth, vm_id, int(snapshot_id))
1803     data = {
1804         "action": "vm.snapshotdelete",
1805         "snapshot_deleted": response[0],
1806         "vm_id": response[1],
1807         "error_code": response[2],
1808     }
1809     return data
1810 def vm_snapshot_revert(vm_name, kwargs=None, call=None):
1811     if call != "action":
1812         raise SaltCloudSystemExit(
1813             "The vm_snapshot_revert action must be called with -a or --action."
1814         )
1815     if kwargs is None:
1816         kwargs = {}
1817     snapshot_id = kwargs.get("snapshot_id", None)
1818     if snapshot_id is None:
1819         raise SaltCloudSystemExit(
1820             "The vm_snapshot_revert function requires a 'snapshot_id' to be provided."
1821         )
1822     server, user, password = _get_xml_rpc()
1823     auth = ":".join([user, password])
1824     vm_id = int(get_vm_id(kwargs={"name": vm_name}))
1825     response = server.one.vm.snapshotrevert(auth, vm_id, int(snapshot_id))
1826     data = {
1827         "action": "vm.snapshotrevert",
1828         "snapshot_reverted": response[0],
1829         "vm_id": response[1],
1830         "error_code": response[2],
1831     }
1832     return data
1833 def vm_update(name, kwargs=None, call=None):
1834     if call != "action":
1835         raise SaltCloudSystemExit(
1836             "The vm_update action must be called with -a or --action."
1837         )
1838     if kwargs is None:
1839         kwargs = {}
1840     path = kwargs.get("path", None)
1841     data = kwargs.get("data", None)
1842     update_type = kwargs.get("update_type", None)
1843     update_args = ["replace", "merge"]
1844     if update_type is None:
1845         raise SaltCloudSystemExit(
1846             "The vm_update function requires an 'update_type' to be provided."
1847         )
1848     if update_type == update_args[0]:
1849         update_number = 0
1850     elif update_type == update_args[1]:
1851         update_number = 1
1852     else:
1853         raise SaltCloudSystemExit(
1854             "The update_type argument must be either {} or {}.".format(
1855                 update_args[0], update_args[1]
1856             )
1857         )
1858     if data:
1859         if path:
1860             log.warning(
1861                 "Both the 'data' and 'path' arguments were provided. "
1862                 "'data' will take precedence."
1863             )
1864     elif path:
1865         with salt.utils.files.fopen(path, mode="r") as rfh:
1866             data = rfh.read()
1867     else:
1868         raise SaltCloudSystemExit(
1869             "The vm_update function requires either 'data' or a file 'path' "
1870             "to be provided."
1871         )
1872     server, user, password = _get_xml_rpc()
1873     auth = ":".join([user, password])
1874     vm_id = int(get_vm_id(kwargs={"name": name}))
1875     response = server.one.vm.update(auth, vm_id, data, int(update_number))
1876     ret = {
1877         "action": "vm.update",
1878         "updated": response[0],
1879         "resource_id": response[1],
1880         "error_code": response[2],
1881     }
1882     return ret
1883 def vn_add_ar(call=None, kwargs=None):
1884     if call != "function":
1885         raise SaltCloudSystemExit(
1886             "The vn_add_ar function must be called with -f or --function."
1887         )
1888     if kwargs is None:
1889         kwargs = {}
1890     vn_id = kwargs.get("vn_id", None)
1891     vn_name = kwargs.get("vn_name", None)
1892     path = kwargs.get("path", None)
1893     data = kwargs.get("data", None)
1894     if vn_id:
1895         if vn_name:
1896             log.warning(
1897                 "Both the 'vn_id' and 'vn_name' arguments were provided. "
1898                 "'vn_id' will take precedence."
1899             )
1900     elif vn_name:
1901         vn_id = get_vn_id(kwargs={"name": vn_name})
1902     else:
1903         raise SaltCloudSystemExit(
1904             "The vn_add_ar function requires a 'vn_id' and a 'vn_name' to be provided."
1905         )
1906     if data:
1907         if path:
1908             log.warning(
1909                 "Both the 'data' and 'path' arguments were provided. "
1910                 "'data' will take precedence."
1911             )
1912     elif path:
1913         with salt.utils.files.fopen(path, mode="r") as rfh:
1914             data = rfh.read()
1915     else:
1916         raise SaltCloudSystemExit(
1917             "The vn_add_ar function requires either 'data' or a file 'path' "
1918             "to be provided."
1919         )
1920     server, user, password = _get_xml_rpc()
1921     auth = ":".join([user, password])
1922     response = server.one.vn.add_ar(auth, int(vn_id), data)
1923     ret = {
1924         "action": "vn.add_ar",
1925         "address_range_added": response[0],
1926         "resource_id": response[1],
1927         "error_code": response[2],
1928     }
1929     return ret
1930 def vn_allocate(call=None, kwargs=None):
1931     if call != "function":
1932         raise SaltCloudSystemExit(
1933             "The vn_allocate function must be called with -f or --function."
1934         )
1935     if kwargs is None:
1936         kwargs = {}
1937     cluster_id = kwargs.get("cluster_id", None)
1938     cluster_name = kwargs.get("cluster_name", None)
1939     path = kwargs.get("path", None)
1940     data = kwargs.get("data", None)
1941     if data:
1942         if path:
1943             log.warning(
1944                 "Both the 'data' and 'path' arguments were provided. "
1945                 "'data' will take precedence."
1946             )
1947     elif path:
1948         with salt.utils.files.fopen(path, mode="r") as rfh:
1949             data = rfh.read()
1950     else:
1951         raise SaltCloudSystemExit(
1952             "The vn_allocate function requires either 'data' or a file 'path' "
1953             "to be provided."
1954         )
1955     if cluster_id:
1956         if cluster_name:
1957             log.warning(
1958                 "Both the 'cluster_id' and 'cluster_name' arguments were provided. "
1959                 "'cluster_id' will take precedence."
1960             )
1961     elif cluster_name:
1962         cluster_id = get_cluster_id(kwargs={"name": cluster_name})
1963     else:
1964         cluster_id = "-1"
1965     server, user, password = _get_xml_rpc()
1966     auth = ":".join([user, password])
1967     response = server.one.vn.allocate(auth, data, int(cluster_id))
1968     ret = {
1969         "action": "vn.allocate",
1970         "allocated": response[0],
1971         "vn_id": response[1],
1972         "error_code": response[2],
1973     }
1974     return ret
1975 def vn_delete(call=None, kwargs=None):
1976     if call != "function":
1977         raise SaltCloudSystemExit(
1978             "The vn_delete function must be called with -f or --function."
1979         )
1980     if kwargs is None:
1981         kwargs = {}
1982     name = kwargs.get("name", None)
1983     vn_id = kwargs.get("vn_id", None)
1984     if vn_id:
1985         if name:
1986             log.warning(
1987                 "Both the 'vn_id' and 'name' arguments were provided. "
1988                 "'vn_id' will take precedence."
1989             )
1990     elif name:
1991         vn_id = get_vn_id(kwargs={"name": name})
1992     else:
1993         raise SaltCloudSystemExit(
1994             "The vn_delete function requires a 'name' or a 'vn_id' to be provided."
1995         )
1996     server, user, password = _get_xml_rpc()
1997     auth = ":".join([user, password])
1998     response = server.one.vn.delete(auth, int(vn_id))
1999     data = {
2000         "action": "vn.delete",
2001         "deleted": response[0],
2002         "vn_id": response[1],
2003         "error_code": response[2],
2004     }
2005     return data
2006 def vn_free_ar(call=None, kwargs=None):
2007     if call != "function":
2008         raise SaltCloudSystemExit(
2009             "The vn_free_ar function must be called with -f or --function."
2010         )
2011     if kwargs is None:
2012         kwargs = {}
2013     vn_id = kwargs.get("vn_id", None)
2014     vn_name = kwargs.get("vn_name", None)
2015     ar_id = kwargs.get("ar_id", None)
2016     if ar_id is None:
2017         raise SaltCloudSystemExit(
2018             "The vn_free_ar function requires an 'rn_id' to be provided."
2019         )
2020     if vn_id:
2021         if vn_name:
2022             log.warning(
2023                 "Both the 'vn_id' and 'vn_name' arguments were provided. "
2024                 "'vn_id' will take precedence."
2025             )
2026     elif vn_name:
2027         vn_id = get_vn_id(kwargs={"name": vn_name})
2028     else:
2029         raise SaltCloudSystemExit(
2030             "The vn_free_ar function requires a 'vn_id' or a 'vn_name' to be provided."
2031         )
2032     server, user, password = _get_xml_rpc()
2033     auth = ":".join([user, password])
2034     response = server.one.vn.free_ar(auth, int(vn_id), int(ar_id))
2035     data = {
2036         "action": "vn.free_ar",
2037         "ar_freed": response[0],
2038         "resource_id": response[1],
2039         "error_code": response[2],
2040     }
2041     return data
2042 def vn_hold(call=None, kwargs=None):
2043     if call != "function":
2044         raise SaltCloudSystemExit(
2045             "The vn_hold function must be called with -f or --function."
2046         )
2047     if kwargs is None:
2048         kwargs = {}
2049     vn_id = kwargs.get("vn_id", None)
2050     vn_name = kwargs.get("vn_name", None)
2051     path = kwargs.get("path", None)
2052     data = kwargs.get("data", None)
2053     if vn_id:
2054         if vn_name:
2055             log.warning(
2056                 "Both the 'vn_id' and 'vn_name' arguments were provided. "
2057                 "'vn_id' will take precedence."
2058             )
2059     elif vn_name:
2060         vn_id = get_vn_id(kwargs={"name": vn_name})
2061     else:
2062         raise SaltCloudSystemExit(
2063             "The vn_hold function requires a 'vn_id' or a 'vn_name' to be provided."
2064         )
2065     if data:
2066         if path:
2067             log.warning(
2068                 "Both the 'data' and 'path' arguments were provided. "
2069                 "'data' will take precedence."
2070             )
2071     elif path:
2072         with salt.utils.files.fopen(path, mode="r") as rfh:
2073             data = rfh.read()
2074     else:
2075         raise SaltCloudSystemExit(
2076             "The vn_hold function requires either 'data' or a 'path' to be provided."
2077         )
2078     server, user, password = _get_xml_rpc()
2079     auth = ":".join([user, password])
2080     response = server.one.vn.hold(auth, int(vn_id), data)
2081     ret = {
2082         "action": "vn.hold",
2083         "held": response[0],
2084         "resource_id": response[1],
2085         "error_code": response[2],
2086     }
2087     return ret
2088 def vn_info(call=None, kwargs=None):
2089     if call != "function":
2090         raise SaltCloudSystemExit(
2091             "The vn_info function must be called with -f or --function."
2092         )
2093     if kwargs is None:
2094         kwargs = {}
2095     name = kwargs.get("name", None)
2096     vn_id = kwargs.get("vn_id", None)
2097     if vn_id:
2098         if name:
2099             log.warning(
2100                 "Both the 'vn_id' and 'name' arguments were provided. "
2101                 "'vn_id' will take precedence."
2102             )
2103     elif name:
2104         vn_id = get_vn_id(kwargs={"name": name})
2105     else:
2106         raise SaltCloudSystemExit(
2107             "The vn_info function requires either a 'name' or a 'vn_id' to be provided."
2108         )
2109     server, user, password = _get_xml_rpc()
2110     auth = ":".join([user, password])
2111     response = server.one.vn.info(auth, int(vn_id))
2112     if response[0] is False:
2113         return response[1]
2114     else:
2115         info = {}
2116         tree = _get_xml(response[1])
2117         info[tree.find("NAME").text] = _xml_to_dict(tree)
2118         return info
2119 def vn_release(call=None, kwargs=None):
2120     if call != "function":
2121         raise SaltCloudSystemExit(
2122             "The vn_reserve function must be called with -f or --function."
2123         )
2124     if kwargs is None:
2125         kwargs = {}
2126     vn_id = kwargs.get("vn_id", None)
2127     vn_name = kwargs.get("vn_name", None)
2128     path = kwargs.get("path", None)
2129     data = kwargs.get("data", None)
2130     if vn_id:
2131         if vn_name:
2132             log.warning(
2133                 "Both the 'vn_id' and 'vn_name' arguments were provided. "
2134                 "'vn_id' will take precedence."
2135             )
2136     elif vn_name:
2137         vn_id = get_vn_id(kwargs={"name": vn_name})
2138     else:
2139         raise SaltCloudSystemExit(
2140             "The vn_release function requires a 'vn_id' or a 'vn_name' to be provided."
2141         )
2142     if data:
2143         if path:
2144             log.warning(
2145                 "Both the 'data' and 'path' arguments were provided. "
2146                 "'data' will take precedence."
2147             )
2148     elif path:
2149         with salt.utils.files.fopen(path, mode="r") as rfh:
2150             data = rfh.read()
2151     else:
2152         raise SaltCloudSystemExit(
2153             "The vn_release function requires either 'data' or a 'path' to be provided."
2154         )
2155     server, user, password = _get_xml_rpc()
2156     auth = ":".join([user, password])
2157     response = server.one.vn.release(auth, int(vn_id), data)
2158     ret = {
2159         "action": "vn.release",
2160         "released": response[0],
2161         "resource_id": response[1],
2162         "error_code": response[2],
2163     }
2164     return ret
2165 def vn_reserve(call=None, kwargs=None):
2166     if call != "function":
2167         raise SaltCloudSystemExit(
2168             "The vn_reserve function must be called with -f or --function."
2169         )
2170     if kwargs is None:
2171         kwargs = {}
2172     vn_id = kwargs.get("vn_id", None)
2173     vn_name = kwargs.get("vn_name", None)
2174     path = kwargs.get("path", None)
2175     data = kwargs.get("data", None)
2176     if vn_id:
2177         if vn_name:
2178             log.warning(
2179                 "Both the 'vn_id' and 'vn_name' arguments were provided. "
2180                 "'vn_id' will take precedence."
2181             )
2182     elif vn_name:
2183         vn_id = get_vn_id(kwargs={"name": vn_name})
2184     else:
2185         raise SaltCloudSystemExit(
2186             "The vn_reserve function requires a 'vn_id' or a 'vn_name' to be provided."
2187         )
2188     if data:
2189         if path:
2190             log.warning(
2191                 "Both the 'data' and 'path' arguments were provided. "
2192                 "'data' will take precedence."
2193             )
2194     elif path:
2195         with salt.utils.files.fopen(path, mode="r") as rfh:
2196             data = rfh.read()
2197     else:
2198         raise SaltCloudSystemExit(
2199             "The vn_reserve function requires a 'path' to be provided."
2200         )
2201     server, user, password = _get_xml_rpc()
2202     auth = ":".join([user, password])
2203     response = server.one.vn.reserve(auth, int(vn_id), data)
2204     ret = {
2205         "action": "vn.reserve",
2206         "reserved": response[0],
2207         "resource_id": response[1],
2208         "error_code": response[2],
2209     }
2210     return ret
2211 def _get_node(name):
2212     attempts = 10
2213     while attempts &gt;= 0:
2214         try:
2215             return list_nodes_full()[name]
2216         except KeyError:
2217             attempts -= 1
2218             log.debug(
2219                 "Failed to get the data for node '%s'. Remaining attempts: %s",
2220                 name,
2221                 attempts,
2222             )
2223             time.sleep(0.5)
2224     return {}
2225 def _get_xml(xml_str):
2226     try:
2227         xml_data = etree.XML(xml_str)
2228     except etree.XMLSyntaxError as err:
2229         raise SaltCloudSystemExit("opennebula returned: {}".format(xml_str))
2230     return xml_data
2231 def _get_xml_rpc():
2232     vm_ = get_configured_provider()
2233     xml_rpc = config.get_cloud_config_value(
2234         "xml_rpc", vm_, __opts__, search_global=False
2235     )
2236     user = config.get_cloud_config_value("user", vm_, __opts__, search_global=False)
2237     password = config.get_cloud_config_value(
2238         "password", vm_, __opts__, search_global=False
2239     )
2240     server = xmlrpc.client.ServerProxy(xml_rpc)
2241     return server, user, password
2242 def _list_nodes(full=False):
2243     server, user, password = _get_xml_rpc()
2244     auth = ":".join([user, password])
2245     vm_pool = server.one.vmpool.info(auth, -2, -1, -1, -1)[1]
2246     vms = {}
2247     for vm in _get_xml(vm_pool):
2248         name = vm.find("NAME").text
2249         vms[name] = {}
2250         cpu_size = vm.find("TEMPLATE").find("CPU").text
2251         memory_size = vm.find("TEMPLATE").find("MEMORY").text
2252         private_ips = []
2253         for nic in vm.find("TEMPLATE").findall("NIC"):
2254             try:
2255                 private_ips.append(nic.find("IP").text)
2256             except Exception:  # pylint: disable=broad-except
2257                 pass
2258         vms[name]["id"] = vm.find("ID").text
2259         if "TEMPLATE_ID" in vm.find("TEMPLATE"):
2260             vms[name]["image"] = vm.find("TEMPLATE").find("TEMPLATE_ID").text
2261         vms[name]["name"] = name
2262         vms[name]["size"] = {"cpu": cpu_size, "memory": memory_size}
2263         vms[name]["state"] = vm.find("STATE").text
2264         vms[name]["private_ips"] = private_ips
2265         vms[name]["public_ips"] = []
2266         if full:
2267             vms[vm.find("NAME").text] = _xml_to_dict(vm)
2268     return vms
2269 def _xml_to_dict(xml):
2270     dicts = {}
2271     for item in xml:
2272         key = item.tag.lower()
2273         idx = 1
2274         while key in dicts:
2275             key += str(idx)
2276             idx += 1
2277         if item.text is None:
2278             dicts[key] = _xml_to_dict(item)
2279         else:
2280             dicts[key] = item.text
2281     return dicts
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>vagrant_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import os
3 import salt.utils.files
4 import salt.utils.path
5 import salt.utils.stringutils
6 from salt._compat import ipaddress
7 from salt.exceptions import CommandExecutionError, SaltInvocationError
8 log = logging.getLogger(__name__)
9 __virtualname__ = "vagrant"
10 VAGRANT_SDB_URL = "sdb://vagrant_sdb_data/"
11 def __virtual__():
12     if salt.utils.path.which("vagrant") is None:
13         return (
14             False,
15             "The vagrant module could not be loaded: vagrant command not found",
16         )
17     return __virtualname__
18 def _build_sdb_uri(key):
19     return "{}{}".format(VAGRANT_SDB_URL, key)
20 def _build_machine_uri(machine, cwd):
21     key = "{}?{}".format(machine, os.path.abspath(cwd))
22     return _build_sdb_uri(key)
23 def _update_vm_info(name, vm_):
24     __utils__["sdb.sdb_set"](_build_sdb_uri(name), vm_, __opts__)
25     if vm_["machine"]:
26         __utils__["sdb.sdb_set"](
27             _build_machine_uri(vm_["machine"], vm_.get("cwd", ".")), name, __opts__
28         )
29 def get_vm_info(name):
30     try:
31         vm_ = __utils__["sdb.sdb_get"](_build_sdb_uri(name), __opts__)
32     except KeyError:
33         raise SaltInvocationError(
34             "Probable sdb driver not found. Check your configuration."
35         )
36     if vm_ is None or "machine" not in vm_:
37         raise SaltInvocationError(
38             "No Vagrant machine defined for Salt_id {}".format(name)
39         )
40     return vm_
41 def get_machine_id(machine, cwd):
42     name = __utils__["sdb.sdb_get"](_build_machine_uri(machine, cwd), __opts__)
43     return name
44 def _erase_vm_info(name):
45     try:
46         vm_ = get_vm_info(name)
47         if vm_["machine"]:
48             key = _build_machine_uri(vm_["machine"], vm_.get("cwd", "."))
49             try:
50                 __utils__["sdb.sdb_delete"](key, __opts__)
51             except KeyError:
52                 __utils__["sdb.sdb_set"](key, None, __opts__)
53     except Exception:  # pylint: disable=broad-except
54         pass
55     uri = _build_sdb_uri(name)
56     try:
57         __utils__["sdb.sdb_delete"](uri, __opts__)
58     except KeyError:
59         __utils__["sdb.sdb_set"](uri, {}, __opts__)
60     except Exception:  # pylint: disable=broad-except
61         pass
62 def _vagrant_ssh_config(vm_):
63     machine = vm_["machine"]
64     log<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.info("requesting vagrant ssh-config for VM %s", machine or "(default)")
65     cmd = "vagrant ssh-config {}".format(machine)
66     reply = __salt__["cmd.shell"](
67         cmd, runas=vm_.get("runas"), cwd=vm_.get("cwd"), ignore_retcode=</b></font>True
68     )
69     ssh_config = {}
70     for line in reply.split("\n"):  # build a dictionary of the text reply
71         tokens = line.strip().split()
72         if len(tokens) == 2:  # each two-token line becomes a key:value pair
73             ssh_config[tokens[0]] = tokens[1]
74     log.debug("ssh_config=%s", repr(ssh_config))
75     return ssh_config
76 def version():
77     cmd = "vagrant -v"
78     return __salt__["cmd.shell"](cmd)
79 def list_domains():
80     vms = []
81     cmd = "vagrant global-status"
82     reply = __salt__["cmd.shell"](cmd)
83     log.debug("---&gt;\n%s", reply)
84     for line in reply.split("\n"):  # build a list of the text reply
85         tokens = line.strip().split()
86         try:
87             _ = int(tokens[0], 16)  # valid id numbers are hexadecimal
88         except (ValueError, IndexError):
89             continue  # skip lines without valid id numbers
90         machine = tokens[1]
91         cwd = tokens[-1]
92         name = get_machine_id(machine, cwd)
93         if name:
94             vms.append(name)
95     return vms
96 def list_active_vms(cwd=None):
97     vms = []
98     cmd = "vagrant status"
99     reply = __salt__["cmd.shell"](cmd, cwd=cwd)
100     log.info("---&gt;\n%s", reply)
101     for line in reply.split("\n"):  # build a list of the text reply
102         tokens = line.strip().split()
103         if len(tokens) &gt; 1:
104             if tokens[1] == "running":
105                 vms.append(tokens[0])
106     return vms
107 def list_inactive_vms(cwd=None):
108     vms = []
109     cmd = "vagrant status"
110     reply = __salt__["cmd.shell"](cmd, cwd=cwd)
111     log.info("---&gt;\n%s", reply)
112     for line in reply.split("\n"):  # build a list of the text reply
113         tokens = line.strip().split()
114         if len(tokens) &gt; 1 and tokens[-1].endswith(")"):
115             if tokens[1] != "running":
116                 vms.append(tokens[0])
117     return vms
118 def vm_state(name="", cwd=None):
119     if name:
120         vm_ = get_vm_info(name)
121         machine = vm_["machine"]
122         cwd = vm_["cwd"] or cwd  # usually ignore passed-in cwd
123     else:
124         if not cwd:
125             raise SaltInvocationError(
126                 "Path to Vagranfile must be defined, but cwd={}".format(cwd)
127             )
128         machine = ""
129     info = []
130     cmd = "vagrant status {}".format(machine)
131     reply = __salt__["cmd.shell"](cmd, cwd)
132     log.info("---&gt;\n%s", reply)
133     for line in reply.split("\n"):  # build a list of the text reply
134         tokens = line.strip().split()
135         if len(tokens) &gt; 1 and tokens[-1].endswith(")"):
136             try:
137                 datum = {
138                     "machine": tokens[0],
139                     "state": " ".join(tokens[1:-1]),
140                     "provider": tokens[-1].lstrip("(").rstrip(")"),
141                     "name": get_machine_id(tokens[0], cwd),
142                 }
143                 info.append(datum)
144             except IndexError:
145                 pass
146     return info
147 def init(
148     name,  # Salt_id for created VM
149     cwd=None,  # path to find Vagrantfile
150     machine="",  # name of machine in Vagrantfile
151     runas=None,  # username who owns Vagrant box
152     start=False,  # start the machine when initialized
153     vagrant_provider="",  # vagrant provider (default=virtualbox)
154     vm=None,  # a dictionary of VM configuration settings
155 ):
156     vm_ = {} if vm is None else vm.copy()  # passed configuration data
157     vm_["name"] = name
158     vm_["cwd"] = cwd or vm_.get("cwd")
159     if not vm_["cwd"]:
160         raise SaltInvocationError(
161             'Path to Vagrantfile must be defined by "cwd" argument'
162         )
163     vm_["machine"] = machine or vm_.get("machine", machine)
164     vm_["runas"] = runas or vm_.get("runas", runas)
165     vm_["vagrant_provider"] = vagrant_provider or vm_.get("vagrant_provider", "")
166     _update_vm_info(name, vm_)
167     if start:
168         log.debug("Starting VM %s", name)
169         ret = _start(name, vm_)
170     else:
171         ret = "Name {} defined using VM {}".format(name, vm_["machine"] or "(default)")
172     return ret
173 def start(name):
174     vm_ = get_vm_info(name)
175     return _start(name, vm_)
176 def _start(
177     name, vm_
178 ):  # internal call name, because "start" is a keyword argument to vagrant.init
179     try:
180         machine = vm_["machine"]
181     except KeyError:
182         raise SaltInvocationError(
183         )
184     vagrant_provider <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= vm_.get("vagrant_provider", "")
185     provider_ = "--provider={}".format(vagrant_provider) if vagrant_provider else ""
186     cmd = "vagrant up {} {}".format(machine, provider_)
187     ret = __salt__["cmd.run_all"](
188         cmd, runas=vm_.get("runas"), cwd=vm_.get(</b></font>"cwd"), output_loglevel="info"
189     )
190     if machine == "":  # we were called using the default machine
191         for line in ret["stdout"].split("\n"):  # find its actual Vagrant name
192             if line.startswith("==&gt;"):
193                 machine = line.split()[1].rstrip(":")
194                 vm_["machine"] = machine
195                 _update_vm_info(name, vm_)  # and remember the true name
196                 break
197     if ret["retcode"] == 0:
198         return 'Started "{}" using Vagrant machine "{}".'.format(name, machine)
199     return False
200 def shutdown(name):
201     return stop(name)
202 def stop(name):
203     machine = vm_["machine"]
204     cmd <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "vagrant halt {}".format(machine)
205     ret = __salt__["cmd.retcode"](cmd, runas=vm_.get("runas"), cwd=vm_.get(</b></font>"cwd"))
206     return ret == 0
207 def pause(name):
208     machine = vm_["machine"]
209     cmd <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "vagrant suspend {}".format(machine)
210     ret = __salt__["cmd.retcode"](cmd, runas=vm_.get("runas"), cwd=vm_.get(</b></font>"cwd"))
211     return ret == 0
212 def reboot(name, provision=False):
213     vm_ = get_vm_info(name)
214     prov = "--provision" if provision else ""
215     cmd <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "vagrant reload {} {}".format(machine, prov)
216     ret = __salt__["cmd.retcode"](cmd, runas=vm_.get("runas"), cwd=vm_.get(</b></font>"cwd"))
217     return ret == 0
218 def destroy(name):
219     machine = vm_["machine"]
220     cmd <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "vagrant destroy -f {}".format(machine)
221     ret = __salt__["cmd.run_all"](
222         cmd, runas=vm_.get("runas"), cwd=vm_.get("cwd"), output_loglevel=</b></font>"info"
223     )
224     if ret["retcode"] == 0:
225         _erase_vm_info(name)
226         return "Destroyed VM {}".format(name)
227     return False
228 def get_ssh_config(name, network_mask="", get_private_key=False):
229     r"""
230     Retrieve hints of how you might connect to a Vagrant VM.
231     :param name: the salt_id of the machine
232     :param network_mask: a CIDR mask to search for the VM's address
233     :param get_private_key: (default: False) return the key used for ssh login
234     :return: a dict of ssh login information for the VM
235     CLI Example:
236     .. code-block:: bash
237         salt &lt;host&gt; vagrant.get_ssh_config &lt;salt_id&gt;
238         salt my_laptop vagrant.get_ssh_config quail1 network_mask=10.0.0.0/8 get_private_key=True
239     The returned dictionary contains:
240     - key_filename:  the name of the private key file on the VM host computer
241     - ssh_username:  the username to be used to log in to the VM
242     - ssh_host:  the IP address used to log in to the VM.  (This will usually be `127.0.0.1`)
243     - ssh_port:  the TCP port used to log in to the VM.  (This will often be `2222`)
244     - \[ip_address:\]  (if `network_mask` is defined. see below)
245     - \[private_key:\]  (if `get_private_key` is True) the private key for ssh_username
246     About `network_mask`:
247     Vagrant usually uses a redirected TCP port on its host computer to log in to a VM using ssh.
248     This redirected port and its IP address are "ssh_port" and "ssh_host".  The ssh_host is
249     usually the localhost (127.0.0.1).
250     This makes it impossible for a third machine (such as a salt-cloud master) to contact the VM
251     unless the VM has another network interface defined.  You will usually want a bridged network
252     defined by having a `config.vm.network "public_network"` statement in your `Vagrantfile`.
253     The IP address of the bridged adapter will typically be assigned by DHCP and unknown to you,
254     but you should be able to determine what IP network the address will be chosen from.
255     If you enter a CIDR network mask, Salt will attempt to find the VM's address for you.
256     The host machine will send an "ifconfig" command to the VM (using ssh to `ssh_host`:`ssh_port`)
257     and return the IP address of the first interface it can find which matches your mask.
258     """
259     vm_ = get_vm_info(name)
260     ssh_config = _vagrant_ssh_config(vm_)
261     try:
262         ans = {
263             "key_filename": ssh_config["IdentityFile"],
264             "ssh_username": ssh_config["User"],
265             "ssh_host": ssh_config["HostName"],
266             "ssh_port": ssh_config["Port"],
267         }
268     except KeyError:
269         raise CommandExecutionError(
270             "Insufficient SSH information to contact VM {}. Is it running?".format(
271                 vm_.get("machine", "(default)")
272             )
273         )
274     if network_mask:
275         command = (
276             "ssh -i {IdentityFile} -p {Port} "
277             "-oStrictHostKeyChecking={StrictHostKeyChecking} "
278             "-oUserKnownHostsFile={UserKnownHostsFile} "
279             "-oControlPath=none "
280             "{User}@{HostName} ifconfig".format(**ssh_config)
281         )
282         log.info("Trying ssh -p %(Port)s %(User)s@%(HostName)s ifconfig", ssh_config)
283         reply = __salt__["cmd.shell"](command)
284         log.info("---&gt;\n%s", reply)
285         target_network_range = ipaddress.ip_network(network_mask, strict=False)
286         for line in reply.split("\n"):
287             try:  # try to find a bridged network address
288                 tokens = line.replace(
289                     "addr:", "", 1
290                 ).split()  # remove "addr:" if it exists, then split
291                 found_address = None
292                 if "inet" in tokens:
293                     nxt = tokens.index("inet") + 1
294                     found_address = ipaddress.ip_address(tokens[nxt])
295                 elif "inet6" in tokens:
296                     nxt = tokens.index("inet6") + 1
297                     found_address = ipaddress.ip_address(tokens[nxt].split("/")[0])
298                 if found_address in target_network_range:
299                     ans["ip_address"] = str(found_address)
300                     break  # we have located a good matching address
301             except (IndexError, AttributeError, TypeError):
302                 pass  # all syntax and type errors loop here
303         log.info(
304             "Network IP address in %s detected as: %s",
305             target_network_range,
306             ans.get("ip_address", "(not found)"),
307         )
308     if get_private_key:
309         try:
310             with salt.utils.files.fopen(ssh_config["IdentityFile"]) as pks:
311                 ans["private_key"] = salt.utils.stringutils.to_unicode(pks.read())
312         except OSError as e:
313             raise CommandExecutionError(
314                 "Error processing Vagrant private key file: {}".format(e)
315             )
316     return ans
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
