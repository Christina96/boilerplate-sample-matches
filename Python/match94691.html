<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for opennebula.py &amp; vagrant_1.py</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for opennebula.py &amp; vagrant_1.py
      </h3>
<h1 align="center">
        3.5%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>opennebula.py (2.0712302%)<th>vagrant_1.py (13.12%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(3426-3431)<td><a href="#" name="0">(411-415)</a><td align="center"><font color="#ff0000">18</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(1805-1810)<td><a href="#" name="1">(163-166)</a><td align="center"><font color="#d40000">15</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(2197-2201)<td><a href="#" name="2">(521-524)</a><td align="center"><font color="#b80000">13</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(2583-2586)<td><a href="#" name="3">(501-502)</a><td align="center"><font color="#aa0000">12</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(2364-2367)<td><a href="#" name="4">(479-480)</a><td align="center"><font color="#aa0000">12</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(1254-1257)<td><a href="#" name="5">(461-462)</a><td align="center"><font color="#aa0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>opennebula.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import os
3 import pprint
4 import time
5 import salt.config as config
6 import salt.utils.data
7 import salt.utils.files
8 from salt.exceptions import (
9     SaltCloudConfigError,
10     SaltCloudExecutionFailure,
11     SaltCloudExecutionTimeout,
12     SaltCloudNotFound,
13     SaltCloudSystemExit,
14 )
15 try:
16     import xmlrpc.client
17     from lxml import etree
18     HAS_XML_LIBS = True
19 except ImportError:
20     HAS_XML_LIBS = False
21 log = logging.getLogger(__name__)
22 __virtualname__ = "opennebula"
23 def __virtual__():
24     if get_configured_provider() is False:
25         return False
26     if get_dependencies() is False:
27         return False
28     return __virtualname__
29 def _get_active_provider_name():
30     try:
31         return __active_provider_name__.value()
32     except AttributeError:
33         return __active_provider_name__
34 def get_configured_provider():
35     return config.is_provider_configured(
36         __opts__,
37         _get_active_provider_name() or __virtualname__,
38         ("xml_rpc", "user", "password"),
39     )
40 def get_dependencies():
41     return config.check_driver_dependencies(__virtualname__, {"lmxl": HAS_XML_LIBS})
42 def avail_images(call=None):
43     if call == "action":
44         raise SaltCloudSystemExit(
45             "The avail_images function must be called with "
46             "-f or --function, or with the --list-images option"
47         )
48     server, user, password = _get_xml_rpc()
49     auth = ":".join([user, password])
50     image_pool = server.one.imagepool.info(auth, -2, -1, -1)[1]
51     images = {}
52     for image in _get_xml(image_pool):
53         images[image.find("NAME").text] = _xml_to_dict(image)
54     return images
55 def avail_locations(call=None):
56     if call == "action":
57         raise SaltCloudSystemExit(
58             "The avail_locations function must be called with "
59             "-f or --function, or with the --list-locations option."
60         )
61     server, user, password = _get_xml_rpc()
62     auth = ":".join([user, password])
63     host_pool = server.one.hostpool.info(auth)[1]
64     locations = {}
65     for host in _get_xml(host_pool):
66         locations[host.find("NAME").text] = _xml_to_dict(host)
67     return locations
68 def avail_sizes(call=None):
69     if call == "action":
70         raise SaltCloudSystemExit(
71             "The avail_sizes function must be called with "
72             "-f or --function, or with the --list-sizes option."
73         )
74     log.warning(
75         "Because sizes are built into templates with OpenNebula, there are no sizes "
76         "to return."
77     )
78     return {}
79 def list_clusters(call=None):
80     if call == "action":
81         raise SaltCloudSystemExit(
82             "The list_clusters function must be called with -f or --function."
83         )
84     server, user, password = _get_xml_rpc()
85     auth = ":".join([user, password])
86     cluster_pool = server.one.clusterpool.info(auth)[1]
87     clusters = {}
88     for cluster in _get_xml(cluster_pool):
89         clusters[cluster.find("NAME").text] = _xml_to_dict(cluster)
90     return clusters
91 def list_datastores(call=None):
92     if call == "action":
93         raise SaltCloudSystemExit(
94             "The list_datastores function must be called with -f or --function."
95         )
96     server, user, password = _get_xml_rpc()
97     auth = ":".join([user, password])
98     datastore_pool = server.one.datastorepool.info(auth)[1]
99     datastores = {}
100     for datastore in _get_xml(datastore_pool):
101         datastores[datastore.find("NAME").text] = _xml_to_dict(datastore)
102     return datastores
103 def list_hosts(call=None):
104     if call == "action":
105         raise SaltCloudSystemExit(
106             "The list_hosts function must be called with -f or --function."
107         )
108     return avail_locations()
109 def list_nodes(call=None):
110     if call == "action":
111         raise SaltCloudSystemExit(
112             "The list_nodes function must be called with -f or --function."
113         )
114     return _list_nodes(full=False)
115 def list_nodes_full(call=None):
116     if call == "action":
117         raise SaltCloudSystemExit(
118             "The list_nodes_full function must be called with -f or --function."
119         )
120     return _list_nodes(full=True)
121 def list_nodes_select(call=None):
122     if call == "action":
123         raise SaltCloudSystemExit(
124             "The list_nodes_full function must be called with -f or --function."
125         )
126     return __utils__["cloud.list_nodes_select"](
127         list_nodes_full("function"),
128         __opts__["query.selection"],
129         call,
130     )
131 def list_security_groups(call=None):
132     if call == "action":
133         raise SaltCloudSystemExit(
134             "The list_security_groups function must be called with -f or --function."
135         )
136     server, user, password = _get_xml_rpc()
137     auth = ":".join([user, password])
138     secgroup_pool = server.one.secgrouppool.info(auth, -2, -1, -1)[1]
139     groups = {}
140     for group in _get_xml(secgroup_pool):
141         groups[group.find("NAME").text] = _xml_to_dict(group)
142     return groups
143 def list_templates(call=None):
144     if call == "action":
145         raise SaltCloudSystemExit(
146             "The list_templates function must be called with -f or --function."
147         )
148     server, user, password = _get_xml_rpc()
149     auth = ":".join([user, password])
150     template_pool = server.one.templatepool.info(auth, -2, -1, -1)[1]
151     templates = {}
152     for template in _get_xml(template_pool):
153         templates[template.find("NAME").text] = _xml_to_dict(template)
154     return templates
155 def list_vns(call=None):
156     if call == "action":
157         raise SaltCloudSystemExit(
158             "The list_vns function must be called with -f or --function."
159         )
160     server, user, password = _get_xml_rpc()
161     auth = ":".join([user, password])
162     vn_pool = server.one.vnpool.info(auth, -2, -1, -1)[1]
163     vns = {}
164     for v_network in _get_xml(vn_pool):
165         vns[v_network.find("NAME").text] = _xml_to_dict(v_network)
166     return vns
167 def reboot(name, call=None):
168     if call != "action":
169         raise SaltCloudSystemExit(
170             "The start action must be called with -a or --action."
171         )
172     log.info("Rebooting node %s", name)
173     return vm_action(name, kwargs={"action": "reboot"}, call=call)
174 def start(name, call=None):
175     if call != "action":
176         raise SaltCloudSystemExit(
177             "The start action must be called with -a or --action."
178         )
179     log.info("Starting node %s", name)
180     return vm_action(name, kwargs={"action": "resume"}, call=call)
181 def stop(name, call=None):
182     if call != "action":
183         raise SaltCloudSystemExit(
184             "The start action must be called with -a or --action."
185         )
186     log.info("Stopping node %s", name)
187     return vm_action(name, kwargs={"action": "stop"}, call=call)
188 def get_one_version(kwargs=None, call=None):
189     if call == "action":
190         raise SaltCloudSystemExit(
191             "The get_cluster_id function must be called with -f or --function."
192         )
193     if kwargs is None:
194         kwargs = {}
195     server, user, password = _get_xml_rpc()
196     auth = ":".join([user, password])
197     return server.one.system.version(auth)[1]
198 def get_cluster_id(kwargs=None, call=None):
199     if call == "action":
200         raise SaltCloudSystemExit(
201             "The get_cluster_id function must be called with -f or --function."
202         )
203     if kwargs is None:
204         kwargs = {}
205     name = kwargs.get("name", None)
206     if name is None:
207         raise SaltCloudSystemExit("The get_cluster_id function requires a name.")
208     try:
209         ret = list_clusters()[name]["id"]
210     except KeyError:
211         raise SaltCloudSystemExit("The cluster '{}' could not be found".format(name))
212     return ret
213 def get_datastore_id(kwargs=None, call=None):
214     if call == "action":
215         raise SaltCloudSystemExit(
216             "The get_datastore_id function must be called with -f or --function."
217         )
218     if kwargs is None:
219         kwargs = {}
220     name = kwargs.get("name", None)
221     if name is None:
222         raise SaltCloudSystemExit("The get_datastore_id function requires a name.")
223     try:
224         ret = list_datastores()[name]["id"]
225     except KeyError:
226         raise SaltCloudSystemExit("The datastore '{}' could not be found.".format(name))
227     return ret
228 def get_host_id(kwargs=None, call=None):
229     if call == "action":
230         raise SaltCloudSystemExit(
231             "The get_host_id function must be called with -f or --function."
232         )
233     if kwargs is None:
234         kwargs = {}
235     name = kwargs.get("name", None)
236     if name is None:
237         raise SaltCloudSystemExit("The get_host_id function requires a name.")
238     try:
239         ret = avail_locations()[name]["id"]
240     except KeyError:
241         raise SaltCloudSystemExit("The host '{}' could not be found".format(name))
242     return ret
243 def get_image(vm_):
244     r"""
245     Return the image object to use.
246     vm\_
247         The VM dictionary for which to obtain an image.
248     Returns an image's ID from the given image name.
249     .. versionadded:: 2016.3.0
250     CLI Example:
251     .. code-block:: bash
252         salt-cloud -f get_image_id opennebula name=my-image-name
253     locations = avail_locations()
254     vm_location = str(
255         config.get_cloud_config_value("location", vm_, __opts__, search_global=False)
256     )
257     if vm_location == "None":
258         return None
259     for location in locations:
260         if vm_location in (locations[location]["name"], locations[location]["id"]):
261             return locations[location]["id"]
262     raise SaltCloudNotFound(
263         "The specified location, '{}', could not be found.".format(vm_location)
264     )
265 def get_secgroup_id(kwargs=None, call=None):
266     if call == "action":
267         raise SaltCloudSystemExit(
268             "The get_secgroup_id function must be called with -f or --function."
269         )
270     if kwargs is None:
271         kwargs = {}
272     name = kwargs.get("name", None)
273     if name is None:
274         raise SaltCloudSystemExit("The get_secgroup_id function requires a 'name'.")
275     try:
276         ret = list_security_groups()[name]["id"]
277     except KeyError:
278         raise SaltCloudSystemExit(
279             "The security group '{}' could not be found.".format(name)
280         )
281     return ret
282 def get_template_image(kwargs=None, call=None):
283     if call == "action":
284         raise SaltCloudSystemExit(
285             "The get_template_image function must be called with -f or --function."
286         )
287     if kwargs is None:
288         kwargs = {}
289     name = kwargs.get("name", None)
290     if name is None:
291         raise SaltCloudSystemExit("The get_template_image function requires a 'name'.")
292     try:
293         ret = list_templates()[name]["template"]["disk"]["image"]
294     except KeyError:
295         raise SaltCloudSystemExit(
296             "The image for template '{}' could not be found.".format(name)
297         )
298     return ret
299 def get_template_id(kwargs=None, call=None):
300     if call == "action":
301         raise SaltCloudSystemExit(
302             "The get_template_id function must be called with -f or --function."
303         )
304     if kwargs is None:
305         kwargs = {}
306     name = kwargs.get("name", None)
307     if name is None:
308         raise SaltCloudSystemExit("The get_template_id function requires a 'name'.")
309     try:
310         ret = list_templates()[name]["id"]
311     except KeyError:
312         raise SaltCloudSystemExit("The template '{}' could not be found.".format(name))
313     return ret
314 def get_template(vm_):
315     r"""
316     Return the template id for a VM.
317     .. versionadded:: 2016.11.0
318     vm\_
319         The VM dictionary for which to obtain a template.
320     Returns a virtual machine's ID from the given virtual machine's name.
321     .. versionadded:: 2016.3.0
322     CLI Example:
323     .. code-block:: bash
324         salt-cloud -f get_vm_id opennebula name=my-vm
325     Returns a virtual network's ID from the given virtual network's name.
326     .. versionadded:: 2016.3.0
327     CLI Example:
328     .. code-block:: bash
329         salt-cloud -f get_vn_id opennebula name=my-vn-name
330     Returns the template format to create a disk in open nebula
331     .. versionadded:: 2018.3.0
332     try:
333         if (
334             vm_["profile"]
335             and config.is_profile_configured(
336                 __opts__, _get_active_provider_name() or "opennebula", vm_["profile"]
337             )
338             is False
339         ):
340             return False
341     except AttributeError:
342         pass
343     __utils__["cloud.fire_event"](
344         "event",
345         "starting create",
346         "salt/cloud/{}/creating".format(vm_["name"]),
347         args=__utils__["cloud.filter_event"](
348             "creating", vm_, ["name", "profile", "provider", "driver"]
349         ),
350         sock_dir=__opts__["sock_dir"],
351         transport=__opts__["transport"],
352     )
353     log.info("Creating Cloud VM %s", vm_["name"])
354     kwargs = {
355         "name": vm_["name"],
356         "template_id": get_template(vm_),
357         "region_id": get_location(vm_),
358     }
359     if "template" in vm_:
360         kwargs["image_id"] = get_template_id({"name": vm_["template"]})
361     private_networking = config.get_cloud_config_value(
362         "private_networking", vm_, __opts__, search_global=False, default=None
363     )
364     kwargs["private_networking"] = "true" if private_networking else "false"
365     __utils__["cloud.fire_event"](
366         "event",
367         "requesting instance",
368         "salt/cloud/{}/requesting".format(vm_["name"]),
369         args={
370             "kwargs": __utils__["cloud.filter_event"](
371                 "requesting", kwargs, list(kwargs)
372             ),
373         },
374         sock_dir=__opts__["sock_dir"],
375     )
376     template = []
377     if kwargs.get("region_id"):
378         template.append('SCHED_REQUIREMENTS="ID={}"'.format(kwargs.get("region_id")))
379     if vm_.get("memory"):
380         template.append("MEMORY={}".format(vm_.get("memory")))
381     if vm_.get("cpu"):
382         template.append("CPU={}".format(vm_.get("cpu")))
383     if vm_.get("vcpu"):
384         template.append("VCPU={}".format(vm_.get("vcpu")))
385     if vm_.get("disk"):
386         get_disks = vm_.get("disk")
387         template_name = vm_["image"]
388         for disk in get_disks:
389             template.append(
390                 _get_device_template(disk, get_disks[disk], template=template_name)
391             )
392         if "CLONE" not in str(template):
393             raise SaltCloudSystemExit(
394                 "Missing an image disk to clone. Must define a clone disk alongside all"
395                 " other disk definitions."
396             )
397     template_args = "\n".join(template)
398     try:
399         server, user, password = _get_xml_rpc()
400         auth = ":".join([user, password])
401         cret = server.one.template.instantiate(
402             auth, int(kwargs["template_id"]), kwargs["name"], False, template_args
403         )
404         if not cret[0]:
405             log.error(
406                 "Error creating %s on OpenNebula\n\n"
407                 "The following error was returned when trying to "
408                 "instantiate the template: %s",
409                 vm_["name"],
410                 cret[1],
411                 exc_info_on_loglevel=logging.DEBUG,
412             )
413             return False
414     except Exception as exc:  # pylint: disable=broad-except
415         log.error(
416             "Error creating %s on OpenNebula\n\n"
417             "The following exception was thrown when trying to "
418             "run the initial deployment: %s",
419             vm_["name"],
420             exc,
421             exc_info_on_loglevel=logging.DEBUG,
422         )
423         return False
424     fqdn = vm_.get("fqdn_base")
425     if fqdn is not None:
426         fqdn = "{}.{}".format(vm_["name"], fqdn)
427     def __query_node_data(vm_name):
428         node_data = show_instance(vm_name, call="action")
429         if not node_data:
430             return False
431         if node_data["state"] == "7":
432             return False
433         if node_data["lcm_state"] == "3":
434             return node_data
435     try:
436         data = __utils__["cloud.wait_for_ip"](
437             __query_node_data,
438             update_args=(vm_["name"],),
439             timeout=config.get_cloud_config_value(
440                 "wait_for_ip_timeout", vm_, __opts__, default=10 * 60
441             ),
442             interval=config.get_cloud_config_value(
443                 "wait_for_ip_interval", vm_, __opts__, default=2
444             ),
445         )
446     except (SaltCloudExecutionTimeout, SaltCloudExecutionFailure) as exc:
447         try:
448             destroy(vm_["name"])
449         except SaltCloudSystemExit:
450             pass
451         finally:
452             raise SaltCloudSystemExit(str(exc))
453     key_filename = config.get_cloud_config_value(
454         "private_key", vm_, __opts__, search_global=False, default=None
455     )
456     if key_filename is not None and not os.path.isfile(key_filename):
457         raise SaltCloudConfigError(
458             "The defined key_filename '{}' does not exist".format(key_filename)
459         )
460     if fqdn:
461         vm_["ssh_host"] = fqdn
462         private_ip = "0.0.0.0"
463     else:
464         try:
465             private_ip = data["private_ips"][0]
466         except KeyError:
467             try:
468                 private_ip = data["template"]["nic"]["ip"]
469             except KeyError:
470                 private_ip = data["template"]["nic"]["ip6_global"]
471             vm_["ssh_host"] = private_ip
472     ssh_username = config.get_cloud_config_value(
473         "ssh_username", vm_, __opts__, default="root"
474     )
475     vm_["username"] = ssh_username
476     vm_["key_filename"] = key_filename
477     ret = __utils__["cloud.bootstrap"](vm_, __opts__)
478     ret["id"] = data["id"]
479     ret["image"] = vm_["image"]
480     ret["name"] = vm_["name"]
481     ret["size"] = data["template"]["memory"]
482     ret["state"] = data["state"]
483     ret["private_ips"] = private_ip
484     ret["public_ips"] = []
485     log.info("Created Cloud VM '%s'", vm_["name"])
486     log.debug("'%s' VM creation details:\n%s", vm_["name"], pprint.pformat(data))
487     __utils__["cloud.fire_event"](
488         "event",
489         "created instance",
490         "salt/cloud/{}/created".format(vm_["name"]),
491         args=__utils__["cloud.filter_event"](
492             "created", vm_, ["name", "profile", "provider", "driver"]
493         ),
494         sock_dir=__opts__["sock_dir"],
495     )
496     return ret
497 def destroy(name, call=None):
498     if call == "function":
499         raise SaltCloudSystemExit(
500             "The destroy action must be called with -d, --destroy, -a or --action."
501         )
502     __utils__["cloud.fire_event"](
503         "event",
504         "destroying instance",
505         "salt/cloud/{}/destroying".format(name),
506         args={"name": name},
507         sock_dir=__opts__["sock_dir"],
508     )
509     server, user, password = _get_xml_rpc()
510     auth = ":".join([user, password])
511     data = show_instance(name, call="action")
512     node = server.one.vm.action(auth, "delete", int(data["id"]))
513     __utils__["cloud.fire_event"](
514         "event",
515         "destroyed instance",
516         "salt/cloud/{}/destroyed".format(name),
517         args={"name": name},
518         sock_dir=__opts__["sock_dir"],
519     )
520     if __opts__.get("update_cachedir", False) is True:
521         __utils__["cloud.delete_minion_cachedir"](
522             name, _get_active_provider_name().split(":")[0], __opts__
523         )
524     data = {
525         "action": "vm.delete",
526         "deleted": node[0],
527         "node_id": node[1],
528         "error_code": node[2],
529     }
530     return data
531 def image_allocate(call=None, kwargs=None):
532     if call != "function":
533         raise SaltCloudSystemExit(
534             "The image_allocate function must be called with -f or --function."
535         )
536 <a name="5"></a>    if kwargs is None:
537         kwargs = {}
538     path <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= kwargs.get("path", None)
539     data = kwargs.get("data", None)
540     datastore_id = kwargs.get("datastore_id", None)
541     datastore_name = kwargs.get(</b></font>"datastore_name", None)
542     if datastore_id:
543         if datastore_name:
544             log.warning(
545                 "Both a 'datastore_id' and a 'datastore_name' were provided. "
546                 "'datastore_id' will take precedence."
547             )
548     elif datastore_name:
549         datastore_id = get_datastore_id(kwargs={"name": datastore_name})
550     else:
551         raise SaltCloudSystemExit(
552             "The image_allocate function requires either a 'datastore_id' or a "
553             "'datastore_name' to be provided."
554         )
555     if data:
556         if path:
557             log.warning(
558                 "Both the 'data' and 'path' arguments were provided. "
559                 "'data' will take precedence."
560             )
561     elif path:
562         with salt.utils.files.fopen(path, mode="r") as rfh:
563             data = rfh.read()
564     else:
565         raise SaltCloudSystemExit(
566             "The image_allocate function requires either a file 'path' or 'data' "
567             "to be provided."
568         )
569     server, user, password = _get_xml_rpc()
570     auth = ":".join([user, password])
571     response = server.one.image.allocate(auth, data, int(datastore_id))
572     ret = {
573         "action": "image.allocate",
574         "allocated": response[0],
575         "image_id": response[1],
576         "error_code": response[2],
577     }
578     return ret
579 def image_clone(call=None, kwargs=None):
580     if call != "function":
581         raise SaltCloudSystemExit(
582             "The image_clone function must be called with -f or --function."
583         )
584     if kwargs is None:
585         kwargs = {}
586     name = kwargs.get("name", None)
587     image_id = kwargs.get("image_id", None)
588     image_name = kwargs.get("image_name", None)
589     if name is None:
590         raise SaltCloudSystemExit(
591             "The image_clone function requires a 'name' to be provided."
592         )
593     if image_id:
594         if image_name:
595             log.warning(
596                 "Both the 'image_id' and 'image_name' arguments were provided. "
597                 "'image_id' will take precedence."
598             )
599     elif image_name:
600         image_id = get_image_id(kwargs={"name": image_name})
601     else:
602         raise SaltCloudSystemExit(
603             "The image_clone function requires either an 'image_id' or an "
604             "'image_name' to be provided."
605         )
606     server, user, password = _get_xml_rpc()
607     auth = ":".join([user, password])
608     response = server.one.image.clone(auth, int(image_id), name)
609     data = {
610         "action": "image.clone",
611         "cloned": response[0],
612         "cloned_image_id": response[1],
613         "cloned_image_name": name,
614         "error_code": response[2],
615     }
616     return data
617 def image_delete(call=None, kwargs=None):
618     if call != "function":
619         raise SaltCloudSystemExit(
620             "The image_delete function must be called with -f or --function."
621         )
622     if kwargs is None:
623         kwargs = {}
624     name = kwargs.get("name", None)
625     image_id = kwargs.get("image_id", None)
626     if image_id:
627         if name:
628             log.warning(
629                 "Both the 'image_id' and 'name' arguments were provided. "
630                 "'image_id' will take precedence."
631             )
632     elif name:
633         image_id = get_image_id(kwargs={"name": name})
634     else:
635         raise SaltCloudSystemExit(
636             "The image_delete function requires either an 'image_id' or a "
637             "'name' to be provided."
638         )
639     server, user, password = _get_xml_rpc()
640     auth = ":".join([user, password])
641     response = server.one.image.delete(auth, int(image_id))
642     data = {
643         "action": "image.delete",
644         "deleted": response[0],
645         "image_id": response[1],
646         "error_code": response[2],
647     }
648     return data
649 def image_info(call=None, kwargs=None):
650     if call != "function":
651         raise SaltCloudSystemExit(
652             "The image_info function must be called with -f or --function."
653         )
654     if kwargs is None:
655         kwargs = {}
656     name = kwargs.get("name", None)
657     image_id = kwargs.get("image_id", None)
658     if image_id:
659         if name:
660             log.warning(
661                 "Both the 'image_id' and 'name' arguments were provided. "
662                 "'image_id' will take precedence."
663             )
664     elif name:
665         image_id = get_image_id(kwargs={"name": name})
666     else:
667         raise SaltCloudSystemExit(
668             "The image_info function requires either a 'name or an 'image_id' "
669             "to be provided."
670         )
671     server, user, password = _get_xml_rpc()
672     auth = ":".join([user, password])
673     info = {}
674     response = server.one.image.info(auth, int(image_id))[1]
675     tree = _get_xml(response)
676     info[tree.find("NAME").text] = _xml_to_dict(tree)
677     return info
678 def image_persistent(call=None, kwargs=None):
679     if call != "function":
680         raise SaltCloudSystemExit(
681             "The image_persistent function must be called with -f or --function."
682         )
683     if kwargs is None:
684         kwargs = {}
685     name = kwargs.get("name", None)
686     persist = kwargs.get("persist", None)
687     image_id = kwargs.get("image_id", None)
688     if persist is None:
689         raise SaltCloudSystemExit(
690             "The image_persistent function requires 'persist' to be set to 'True' "
691             "or 'False'."
692         )
693     if image_id:
694         if name:
695             log.warning(
696                 "Both the 'image_id' and 'name' arguments were provided. "
697                 "'image_id' will take precedence."
698             )
699     elif name:
700         image_id = get_image_id(kwargs={"name": name})
701     else:
702         raise SaltCloudSystemExit(
703             "The image_persistent function requires either a 'name' or an "
704             "'image_id' to be provided."
705         )
706     server, user, password = _get_xml_rpc()
707     auth = ":".join([user, password])
708     response = server.one.image.persistent(
709         auth, int(image_id), salt.utils.data.is_true(persist)
710     )
711     data = {
712         "action": "image.persistent",
713         "response": response[0],
714         "image_id": response[1],
715         "error_code": response[2],
716     }
717     return data
718 def image_snapshot_delete(call=None, kwargs=None):
719     if call != "function":
720         raise SaltCloudSystemExit(
721             "The image_snapshot_delete function must be called with -f or --function."
722         )
723     if kwargs is None:
724         kwargs = {}
725     image_id = kwargs.get("image_id", None)
726     image_name = kwargs.get("image_name", None)
727     snapshot_id = kwargs.get("snapshot_id", None)
728     if snapshot_id is None:
729         raise SaltCloudSystemExit(
730             "The image_snapshot_delete function requires a 'snapshot_id' to be"
731             " provided."
732         )
733     if image_id:
734         if image_name:
735             log.warning(
736                 "Both the 'image_id' and 'image_name' arguments were provided. "
737                 "'image_id' will take precedence."
738             )
739     elif image_name:
740         image_id = get_image_id(kwargs={"name": image_name})
741     else:
742         raise SaltCloudSystemExit(
743             "The image_snapshot_delete function requires either an 'image_id' "
744             "or a 'image_name' to be provided."
745         )
746     server, user, password = _get_xml_rpc()
747     auth = ":".join([user, password])
748     response = server.one.image.snapshotdelete(auth, int(image_id), int(snapshot_id))
749     data = {
750         "action": "image.snapshotdelete",
751         "deleted": response[0],
752         "snapshot_id": response[1],
753         "error_code": response[2],
754     }
755     return data
756 def image_snapshot_revert(call=None, kwargs=None):
757     if call != "function":
758         raise SaltCloudSystemExit(
759             "The image_snapshot_revert function must be called with -f or --function."
760         )
761     if kwargs is None:
762         kwargs = {}
763     image_id = kwargs.get("image_id", None)
764     image_name = kwargs.get("image_name", None)
765     snapshot_id = kwargs.get("snapshot_id", None)
766     if snapshot_id is None:
767         raise SaltCloudSystemExit(
768             "The image_snapshot_revert function requires a 'snapshot_id' to be"
769             " provided."
770         )
771     if image_id:
772         if image_name:
773             log.warning(
774                 "Both the 'image_id' and 'image_name' arguments were provided. "
775                 "'image_id' will take precedence."
776             )
777     elif image_name:
778         image_id = get_image_id(kwargs={"name": image_name})
779     else:
780         raise SaltCloudSystemExit(
781             "The image_snapshot_revert function requires either an 'image_id' or "
782             "an 'image_name' to be provided."
783         )
784     server, user, password = _get_xml_rpc()
785     auth = ":".join([user, password])
786     response = server.one.image.snapshotrevert(auth, int(image_id), int(snapshot_id))
787     data = {
788         "action": "image.snapshotrevert",
789         "reverted": response[0],
790         "snapshot_id": response[1],
791         "error_code": response[2],
792     }
793     return data
794 def image_snapshot_flatten(call=None, kwargs=None):
795     if call != "function":
796         raise SaltCloudSystemExit(
797             "The image_snapshot_flatten function must be called with -f or --function."
798         )
799     if kwargs is None:
800         kwargs = {}
801     image_id = kwargs.get("image_id", None)
802     image_name = kwargs.get("image_name", None)
803     snapshot_id = kwargs.get("snapshot_id", None)
804     if snapshot_id is None:
805         raise SaltCloudSystemExit(
806             "The image_stanpshot_flatten function requires a 'snapshot_id' "
807             "to be provided."
808         )
809     if image_id:
810         if image_name:
811             log.warning(
812                 "Both the 'image_id' and 'image_name' arguments were provided. "
813                 "'image_id' will take precedence."
814             )
815     elif image_name:
816         image_id = get_image_id(kwargs={"name": image_name})
817     else:
818         raise SaltCloudSystemExit(
819             "The image_snapshot_flatten function requires either an "
820             "'image_id' or an 'image_name' to be provided."
821         )
822     server, user, password = _get_xml_rpc()
823     auth = ":".join([user, password])
824     response = server.one.image.snapshotflatten(auth, int(image_id), int(snapshot_id))
825     data = {
826         "action": "image.snapshotflatten",
827         "flattened": response[0],
828         "snapshot_id": response[1],
829         "error_code": response[2],
830     }
831     return data
832 def image_update(call=None, kwargs=None):
833     if call != "function":
834         raise SaltCloudSystemExit(
835             "The image_allocate function must be called with -f or --function."
836         )
837 <a name="1"></a>    if kwargs is None:
838         kwargs = {}
839     image_id = kwargs<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>.get("image_id", None)
840     image_name = kwargs.get("image_name", None)
841     path = kwargs.get("path", None)
842     data = kwargs.get("data", None)
843     update_type = kwargs.get("update_type", None)
844     update_args =</b></font> ["replace", "merge"]
845     if update_type is None:
846         raise SaltCloudSystemExit(
847             "The image_update function requires an 'update_type' to be provided."
848         )
849     if update_type == update_args[0]:
850         update_number = 0
851     elif update_type == update_args[1]:
852         update_number = 1
853     else:
854         raise SaltCloudSystemExit(
855             "The update_type argument must be either {} or {}.".format(
856                 update_args[0], update_args[1]
857             )
858         )
859     if image_id:
860         if image_name:
861             log.warning(
862                 "Both the 'image_id' and 'image_name' arguments were provided. "
863                 "'image_id' will take precedence."
864             )
865     elif image_name:
866         image_id = get_image_id(kwargs={"name": image_name})
867     else:
868         raise SaltCloudSystemExit(
869             "The image_update function requires either an 'image_id' or an "
870             "'image_name' to be provided."
871         )
872     if data:
873         if path:
874             log.warning(
875                 "Both the 'data' and 'path' arguments were provided. "
876                 "'data' will take precedence."
877             )
878     elif path:
879         with salt.utils.files.fopen(path, mode="r") as rfh:
880             data = rfh.read()
881     else:
882         raise SaltCloudSystemExit(
883             "The image_update function requires either 'data' or a file 'path' "
884             "to be provided."
885         )
886     server, user, password = _get_xml_rpc()
887     auth = ":".join([user, password])
888     response = server.one.image.update(auth, int(image_id), data, int(update_number))
889     ret = {
890         "action": "image.update",
891         "updated": response[0],
892         "image_id": response[1],
893         "error_code": response[2],
894     }
895     return ret
896 def show_instance(name, call=None):
897     if call != "action":
898         raise SaltCloudSystemExit(
899             "The show_instance action must be called with -a or --action."
900         )
901     node = _get_node(name)
902     __utils__["cloud.cache_node"](node, _get_active_provider_name(), __opts__)
903     return node
904 def secgroup_allocate(call=None, kwargs=None):
905     if call != "function":
906         raise SaltCloudSystemExit(
907             "The secgroup_allocate function must be called with -f or --function."
908         )
909     if kwargs is None:
910         kwargs = {}
911     path = kwargs.get("path", None)
912     data = kwargs.get("data", None)
913     if data:
914         if path:
915             log.warning(
916                 "Both the 'data' and 'path' arguments were provided. "
917                 "'data' will take precedence."
918             )
919     elif path:
920         with salt.utils.files.fopen(path, mode="r") as rfh:
921             data = rfh.read()
922     else:
923         raise SaltCloudSystemExit(
924             "The secgroup_allocate function requires either 'data' or a file "
925             "'path' to be provided."
926         )
927     server, user, password = _get_xml_rpc()
928     auth = ":".join([user, password])
929     response = server.one.secgroup.allocate(auth, data)
930     ret = {
931         "action": "secgroup.allocate",
932         "allocated": response[0],
933         "secgroup_id": response[1],
934         "error_code": response[2],
935     }
936     return ret
937 def secgroup_clone(call=None, kwargs=None):
938     if call != "function":
939         raise SaltCloudSystemExit(
940             "The secgroup_clone function must be called with -f or --function."
941         )
942     if kwargs is None:
943         kwargs = {}
944     name = kwargs.get("name", None)
945     secgroup_id = kwargs.get("secgroup_id", None)
946     secgroup_name = kwargs.get("secgroup_name", None)
947     if name is None:
948         raise SaltCloudSystemExit(
949             "The secgroup_clone function requires a 'name' to be provided."
950         )
951     if secgroup_id:
952         if secgroup_name:
953             log.warning(
954                 "Both the 'secgroup_id' and 'secgroup_name' arguments were provided. "
955                 "'secgroup_id' will take precedence."
956             )
957     elif secgroup_name:
958         secgroup_id = get_secgroup_id(kwargs={"name": secgroup_name})
959     else:
960         raise SaltCloudSystemExit(
961             "The secgroup_clone function requires either a 'secgroup_id' or a "
962             "'secgroup_name' to be provided."
963         )
964     server, user, password = _get_xml_rpc()
965     auth = ":".join([user, password])
966     response = server.one.secgroup.clone(auth, int(secgroup_id), name)
967     data = {
968         "action": "secgroup.clone",
969         "cloned": response[0],
970         "cloned_secgroup_id": response[1],
971         "cloned_secgroup_name": name,
972         "error_code": response[2],
973     }
974     return data
975 def secgroup_delete(call=None, kwargs=None):
976     if call != "function":
977         raise SaltCloudSystemExit(
978             "The secgroup_delete function must be called with -f or --function."
979         )
980     if kwargs is None:
981         kwargs = {}
982     name = kwargs.get("name", None)
983     secgroup_id = kwargs.get("secgroup_id", None)
984     if secgroup_id:
985         if name:
986             log.warning(
987                 "Both the 'secgroup_id' and 'name' arguments were provided. "
988                 "'secgroup_id' will take precedence."
989             )
990     elif name:
991         secgroup_id = get_secgroup_id(kwargs={"name": name})
992     else:
993         raise SaltCloudSystemExit(
994             "The secgroup_delete function requires either a 'name' or a "
995             "'secgroup_id' to be provided."
996         )
997     server, user, password = _get_xml_rpc()
998     auth = ":".join([user, password])
999     response = server.one.secgroup.delete(auth, int(secgroup_id))
1000     data = {
1001         "action": "secgroup.delete",
1002         "deleted": response[0],
1003         "secgroup_id": response[1],
1004         "error_code": response[2],
1005     }
1006     return data
1007 def secgroup_info(call=None, kwargs=None):
1008     if call != "function":
1009         raise SaltCloudSystemExit(
1010             "The secgroup_info function must be called with -f or --function."
1011         )
1012     if kwargs is None:
1013         kwargs = {}
1014     name = kwargs.get("name", None)
1015     secgroup_id = kwargs.get("secgroup_id", None)
1016     if secgroup_id:
1017         if name:
1018             log.warning(
1019                 "Both the 'secgroup_id' and 'name' arguments were provided. "
1020                 "'secgroup_id' will take precedence."
1021             )
1022     elif name:
1023         secgroup_id = get_secgroup_id(kwargs={"name": name})
1024     else:
1025         raise SaltCloudSystemExit(
1026             "The secgroup_info function requires either a name or a secgroup_id "
1027             "to be provided."
1028         )
1029     server, user, password = _get_xml_rpc()
1030     auth = ":".join([user, password])
1031     info = {}
1032     response = server.one.secgroup.info(auth, int(secgroup_id))[1]
1033     tree = _get_xml(response)
1034     info[tree.find("NAME").text] = _xml_to_dict(tree)
1035     return info
1036 def secgroup_update(call=None, kwargs=None):
1037     if call != "function":
1038         raise SaltCloudSystemExit(
1039             "The secgroup_allocate function must be called with -f or --function."
1040         )
1041 <a name="2"></a>    if kwargs is None:
1042         kwargs = {}
1043     secgroup_id <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= kwargs.get("secgroup_id", None)
1044     secgroup_name = kwargs.get("secgroup_name", None)
1045     path = kwargs.get("path", None)
1046     data = kwargs.get("data", None)
1047     update_type =</b></font> kwargs.get("update_type", None)
1048     update_args = ["replace", "merge"]
1049     if update_type is None:
1050         raise SaltCloudSystemExit(
1051             "The secgroup_update function requires an 'update_type' to be provided."
1052         )
1053     if update_type == update_args[0]:
1054         update_number = 0
1055     elif update_type == update_args[1]:
1056         update_number = 1
1057     else:
1058         raise SaltCloudSystemExit(
1059             "The update_type argument must be either {} or {}.".format(
1060                 update_args[0], update_args[1]
1061             )
1062         )
1063     if secgroup_id:
1064         if secgroup_name:
1065             log.warning(
1066                 "Both the 'secgroup_id' and 'secgroup_name' arguments were provided. "
1067                 "'secgroup_id' will take precedence."
1068             )
1069     elif secgroup_name:
1070         secgroup_id = get_secgroup_id(kwargs={"name": secgroup_name})
1071     else:
1072         raise SaltCloudSystemExit(
1073             "The secgroup_update function requires either a 'secgroup_id' or a "
1074             "'secgroup_name' to be provided."
1075         )
1076     if data:
1077         if path:
1078             log.warning(
1079                 "Both the 'data' and 'path' arguments were provided. "
1080                 "'data' will take precedence."
1081             )
1082     elif path:
1083         with salt.utils.files.fopen(path, mode="r") as rfh:
1084             data = rfh.read()
1085     else:
1086         raise SaltCloudSystemExit(
1087             "The secgroup_update function requires either 'data' or a file 'path' "
1088             "to be provided."
1089         )
1090     server, user, password = _get_xml_rpc()
1091     auth = ":".join([user, password])
1092     response = server.one.secgroup.update(
1093         auth, int(secgroup_id), data, int(update_number)
1094     )
1095     ret = {
1096         "action": "secgroup.update",
1097         "updated": response[0],
1098         "secgroup_id": response[1],
1099         "error_code": response[2],
1100     }
1101     return ret
1102 def template_allocate(call=None, kwargs=None):
1103     if call != "function":
1104         raise SaltCloudSystemExit(
1105             "The template_allocate function must be called with -f or --function."
1106         )
1107     if kwargs is None:
1108         kwargs = {}
1109     path = kwargs.get("path", None)
1110     data = kwargs.get("data", None)
1111     if data:
1112         if path:
1113             log.warning(
1114                 "Both the 'data' and 'path' arguments were provided. "
1115                 "'data' will take precedence."
1116             )
1117     elif path:
1118         with salt.utils.files.fopen(path, mode="r") as rfh:
1119             data = rfh.read()
1120     else:
1121         raise SaltCloudSystemExit(
1122             "The template_allocate function requires either 'data' or a file "
1123             "'path' to be provided."
1124         )
1125     server, user, password = _get_xml_rpc()
1126     auth = ":".join([user, password])
1127     response = server.one.template.allocate(auth, data)
1128     ret = {
1129         "action": "template.allocate",
1130         "allocated": response[0],
1131         "template_id": response[1],
1132         "error_code": response[2],
1133     }
1134     return ret
1135 def template_clone(call=None, kwargs=None):
1136     if call != "function":
1137         raise SaltCloudSystemExit(
1138             "The template_clone function must be called with -f or --function."
1139         )
1140 <a name="4"></a>    if kwargs is None:
1141         kwargs = {}
1142     name <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= kwargs.get("name", None)
1143     template_id = kwargs.get("template_id", None)
1144     template_name = kwargs.get("template_name", None)
1145     clone_images = kwargs.get(</b></font>"clone_images", False)
1146     if name is None:
1147         raise SaltCloudSystemExit(
1148             "The template_clone function requires a name to be provided."
1149         )
1150     if template_id:
1151         if template_name:
1152             log.warning(
1153                 "Both the 'template_id' and 'template_name' arguments were provided. "
1154                 "'template_id' will take precedence."
1155             )
1156     elif template_name:
1157         template_id = get_template_id(kwargs={"name": template_name})
1158     else:
1159         raise SaltCloudSystemExit(
1160             "The template_clone function requires either a 'template_id' "
1161             "or a 'template_name' to be provided."
1162         )
1163     server, user, password = _get_xml_rpc()
1164     auth = ":".join([user, password])
1165     response = server.one.template.clone(auth, int(template_id), name, clone_images)
1166     data = {
1167         "action": "template.clone",
1168         "cloned": response[0],
1169         "cloned_template_id": response[1],
1170         "cloned_template_name": name,
1171         "error_code": response[2],
1172     }
1173     return data
1174 def template_delete(call=None, kwargs=None):
1175     if call != "function":
1176         raise SaltCloudSystemExit(
1177             "The template_delete function must be called with -f or --function."
1178         )
1179     if kwargs is None:
1180         kwargs = {}
1181     name = kwargs.get("name", None)
1182     template_id = kwargs.get("template_id", None)
1183     if template_id:
1184         if name:
1185             log.warning(
1186                 "Both the 'template_id' and 'name' arguments were provided. "
1187                 "'template_id' will take precedence."
1188             )
1189     elif name:
1190         template_id = get_template_id(kwargs={"name": name})
1191     else:
1192         raise SaltCloudSystemExit(
1193             "The template_delete function requires either a 'name' or a 'template_id' "
1194             "to be provided."
1195         )
1196     server, user, password = _get_xml_rpc()
1197     auth = ":".join([user, password])
1198     response = server.one.template.delete(auth, int(template_id))
1199     data = {
1200         "action": "template.delete",
1201         "deleted": response[0],
1202         "template_id": response[1],
1203         "error_code": response[2],
1204     }
1205     return data
1206 def template_instantiate(call=None, kwargs=None):
1207     if call != "function":
1208         raise SaltCloudSystemExit(
1209             "The template_instantiate function must be called with -f or --function."
1210         )
1211     if kwargs is None:
1212         kwargs = {}
1213     vm_name = kwargs.get("vm_name", None)
1214     template_id = kwargs.get("template_id", None)
1215     template_name = kwargs.get("template_name", None)
1216     if vm_name is None:
1217         raise SaltCloudSystemExit(
1218             "The template_instantiate function requires a 'vm_name' to be provided."
1219         )
1220     if template_id:
1221         if template_name:
1222             log.warning(
1223                 "Both the 'template_id' and 'template_name' arguments were provided. "
1224                 "'template_id' will take precedence."
1225             )
1226     elif template_name:
1227         template_id = get_template_id(kwargs={"name": template_name})
1228     else:
1229         raise SaltCloudSystemExit(
1230             "The template_instantiate function requires either a 'template_id' "
1231             "or a 'template_name' to be provided."
1232         )
1233     server, user, password = _get_xml_rpc()
1234     auth = ":".join([user, password])
1235     response = server.one.template.instantiate(auth, int(template_id), vm_name)
1236     data = {
1237         "action": "template.instantiate",
1238         "instantiated": response[0],
1239         "instantiated_vm_id": response[1],
1240         "vm_name": vm_name,
1241         "error_code": response[2],
1242     }
1243     return data
1244 def template_update(call=None, kwargs=None):
1245     if call != "function":
1246         raise SaltCloudSystemExit(
1247             "The template_update function must be called with -f or --function."
1248         )
1249 <a name="3"></a>    if kwargs is None:
1250         kwargs = {}
1251     template_id <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= kwargs.get("template_id", None)
1252     template_name = kwargs.get("template_name", None)
1253     path = kwargs.get("path", None)
1254     data = kwargs.get(</b></font>"data", None)
1255     update_type = kwargs.get("update_type", None)
1256     update_args = ["replace", "merge"]
1257     if update_type is None:
1258         raise SaltCloudSystemExit(
1259             "The template_update function requires an 'update_type' to be provided."
1260         )
1261     if update_type == update_args[0]:
1262         update_number = 0
1263     elif update_type == update_args[1]:
1264         update_number = 1
1265     else:
1266         raise SaltCloudSystemExit(
1267             "The update_type argument must be either {} or {}.".format(
1268                 update_args[0], update_args[1]
1269             )
1270         )
1271     if template_id:
1272         if template_name:
1273             log.warning(
1274                 "Both the 'template_id' and 'template_name' arguments were provided. "
1275                 "'template_id' will take precedence."
1276             )
1277     elif template_name:
1278         template_id = get_template_id(kwargs={"name": template_name})
1279     else:
1280         raise SaltCloudSystemExit(
1281             "The template_update function requires either a 'template_id' "
1282             "or a 'template_name' to be provided."
1283         )
1284     if data:
1285         if path:
1286             log.warning(
1287                 "Both the 'data' and 'path' arguments were provided. "
1288                 "'data' will take precedence."
1289             )
1290     elif path:
1291         with salt.utils.files.fopen(path, mode="r") as rfh:
1292             data = rfh.read()
1293     else:
1294         raise SaltCloudSystemExit(
1295             "The template_update function requires either 'data' or a file "
1296             "'path' to be provided."
1297         )
1298     server, user, password = _get_xml_rpc()
1299     auth = ":".join([user, password])
1300     response = server.one.template.update(
1301         auth, int(template_id), data, int(update_number)
1302     )
1303     ret = {
1304         "action": "template.update",
1305         "updated": response[0],
1306         "template_id": response[1],
1307         "error_code": response[2],
1308     }
1309     return ret
1310 def vm_action(name, kwargs=None, call=None):
1311     if call != "action":
1312         raise SaltCloudSystemExit(
1313             "The vm_action function must be called with -a or --action."
1314         )
1315     if kwargs is None:
1316         kwargs = {}
1317     action = kwargs.get("action", None)
1318     if action is None:
1319         raise SaltCloudSystemExit(
1320             "The vm_action function must have an 'action' provided."
1321         )
1322     server, user, password = _get_xml_rpc()
1323     auth = ":".join([user, password])
1324     vm_id = int(get_vm_id(kwargs={"name": name}))
1325     response = server.one.vm.action(auth, action, vm_id)
1326     data = {
1327         "action": "vm.action." + str(action),
1328         "actioned": response[0],
1329         "vm_id": response[1],
1330         "error_code": response[2],
1331     }
1332     return data
1333 def vm_allocate(call=None, kwargs=None):
1334     if call != "function":
1335         raise SaltCloudSystemExit(
1336             "The vm_allocate function must be called with -f or --function."
1337         )
1338     if kwargs is None:
1339         kwargs = {}
1340     path = kwargs.get("path", None)
1341     data = kwargs.get("data", None)
1342     hold = kwargs.get("hold", False)
1343     if data:
1344         if path:
1345             log.warning(
1346                 "Both the 'data' and 'path' arguments were provided. "
1347                 "'data' will take precedence."
1348             )
1349     elif path:
1350         with salt.utils.files.fopen(path, mode="r") as rfh:
1351             data = rfh.read()
1352     else:
1353         raise SaltCloudSystemExit(
1354             "The vm_allocate function requires either 'data' or a file 'path' "
1355             "to be provided."
1356         )
1357     server, user, password = _get_xml_rpc()
1358     auth = ":".join([user, password])
1359     response = server.one.vm.allocate(auth, data, salt.utils.data.is_true(hold))
1360     ret = {
1361         "action": "vm.allocate",
1362         "allocated": response[0],
1363         "vm_id": response[1],
1364         "error_code": response[2],
1365     }
1366     return ret
1367 def vm_attach(name, kwargs=None, call=None):
1368     if call != "action":
1369         raise SaltCloudSystemExit(
1370             "The vm_attach action must be called with -a or --action."
1371         )
1372     if kwargs is None:
1373         kwargs = {}
1374     path = kwargs.get("path", None)
1375     data = kwargs.get("data", None)
1376     if data:
1377         if path:
1378             log.warning(
1379                 "Both the 'data' and 'path' arguments were provided. "
1380                 "'data' will take precedence."
1381             )
1382     elif path:
1383         with salt.utils.files.fopen(path, mode="r") as rfh:
1384             data = rfh.read()
1385     else:
1386         raise SaltCloudSystemExit(
1387             "The vm_attach function requires either 'data' or a file "
1388             "'path' to be provided."
1389         )
1390     server, user, password = _get_xml_rpc()
1391     auth = ":".join([user, password])
1392     vm_id = int(get_vm_id(kwargs={"name": name}))
1393     response = server.one.vm.attach(auth, vm_id, data)
1394     ret = {
1395         "action": "vm.attach",
1396         "attached": response[0],
1397         "vm_id": response[1],
1398         "error_code": response[2],
1399     }
1400     return ret
1401 def vm_attach_nic(name, kwargs=None, call=None):
1402     if call != "action":
1403         raise SaltCloudSystemExit(
1404             "The vm_attach_nic action must be called with -a or --action."
1405         )
1406     if kwargs is None:
1407         kwargs = {}
1408     path = kwargs.get("path", None)
1409     data = kwargs.get("data", None)
1410     if data:
1411         if path:
1412             log.warning(
1413                 "Both the 'data' and 'path' arguments were provided. "
1414                 "'data' will take precedence."
1415             )
1416     elif path:
1417         with salt.utils.files.fopen(path, mode="r") as rfh:
1418             data = rfh.read()
1419     else:
1420         raise SaltCloudSystemExit(
1421             "The vm_attach_nic function requires either 'data' or a file "
1422             "'path' to be provided."
1423         )
1424     server, user, password = _get_xml_rpc()
1425     auth = ":".join([user, password])
1426     vm_id = int(get_vm_id(kwargs={"name": name}))
1427     response = server.one.vm.attachnic(auth, vm_id, data)
1428     ret = {
1429         "action": "vm.attachnic",
1430         "nic_attached": response[0],
1431         "vm_id": response[1],
1432         "error_code": response[2],
1433     }
1434     return ret
1435 def vm_deploy(name, kwargs=None, call=None):
1436     if call != "action":
1437         raise SaltCloudSystemExit(
1438             "The vm_deploy action must be called with -a or --action."
1439         )
1440     if kwargs is None:
1441         kwargs = {}
1442     host_id = kwargs.get("host_id", None)
1443     host_name = kwargs.get("host_name", None)
1444     capacity_maintained = kwargs.get("capacity_maintained", True)
1445     datastore_id = kwargs.get("datastore_id", None)
1446     datastore_name = kwargs.get("datastore_name", None)
1447     if host_id:
1448         if host_name:
1449             log.warning(
1450                 "Both the 'host_id' and 'host_name' arguments were provided. "
1451                 "'host_id' will take precedence."
1452             )
1453     elif host_name:
1454         host_id = get_host_id(kwargs={"name": host_name})
1455     else:
1456         raise SaltCloudSystemExit(
1457             "The vm_deploy function requires a 'host_id' or a 'host_name' "
1458             "to be provided."
1459         )
1460     if datastore_id:
1461         if datastore_name:
1462             log.warning(
1463                 "Both the 'datastore_id' and 'datastore_name' arguments were provided. "
1464                 "'datastore_id' will take precedence."
1465             )
1466     elif datastore_name:
1467         datastore_id = get_datastore_id(kwargs={"name": datastore_name})
1468     else:
1469         datastore_id = "-1"
1470     server, user, password = _get_xml_rpc()
1471     auth = ":".join([user, password])
1472     vm_id = get_vm_id(kwargs={"name": name})
1473     response = server.one.vm.deploy(
1474         auth,
1475         int(vm_id),
1476         int(host_id),
1477         salt.utils.data.is_true(capacity_maintained),
1478         int(datastore_id),
1479     )
1480     data = {
1481         "action": "vm.deploy",
1482         "deployed": response[0],
1483         "vm_id": response[1],
1484         "error_code": response[2],
1485     }
1486     return data
1487 def vm_detach(name, kwargs=None, call=None):
1488     if call != "action":
1489         raise SaltCloudSystemExit(
1490             "The vm_detach action must be called with -a or --action."
1491         )
1492     if kwargs is None:
1493         kwargs = {}
1494     disk_id = kwargs.get("disk_id", None)
1495     if disk_id is None:
1496         raise SaltCloudSystemExit(
1497             "The vm_detach function requires a 'disk_id' to be provided."
1498         )
1499     server, user, password = _get_xml_rpc()
1500     auth = ":".join([user, password])
1501     vm_id = int(get_vm_id(kwargs={"name": name}))
1502     response = server.one.vm.detach(auth, vm_id, int(disk_id))
1503     data = {
1504         "action": "vm.detach",
1505         "detached": response[0],
1506         "vm_id": response[1],
1507         "error_code": response[2],
1508     }
1509     return data
1510 def vm_detach_nic(name, kwargs=None, call=None):
1511     if call != "action":
1512         raise SaltCloudSystemExit(
1513             "The vm_detach_nic action must be called with -a or --action."
1514         )
1515     if kwargs is None:
1516         kwargs = {}
1517     nic_id = kwargs.get("nic_id", None)
1518     if nic_id is None:
1519         raise SaltCloudSystemExit(
1520             "The vm_detach_nic function requires a 'nic_id' to be provided."
1521         )
1522     server, user, password = _get_xml_rpc()
1523     auth = ":".join([user, password])
1524     vm_id = int(get_vm_id(kwargs={"name": name}))
1525     response = server.one.vm.detachnic(auth, vm_id, int(nic_id))
1526     data = {
1527         "action": "vm.detachnic",
1528         "nic_detached": response[0],
1529         "vm_id": response[1],
1530         "error_code": response[2],
1531     }
1532     return data
1533 def vm_disk_save(name, kwargs=None, call=None):
1534     if call != "action":
1535         raise SaltCloudSystemExit(
1536             "The vm_disk_save action must be called with -a or --action."
1537         )
1538     if kwargs is None:
1539         kwargs = {}
1540     disk_id = kwargs.get("disk_id", None)
1541     image_name = kwargs.get("image_name", None)
1542     image_type = kwargs.get("image_type", "")
1543     snapshot_id = int(kwargs.get("snapshot_id", "-1"))
1544     if disk_id is None or image_name is None:
1545         raise SaltCloudSystemExit(
1546             "The vm_disk_save function requires a 'disk_id' and an 'image_name' "
1547             "to be provided."
1548         )
1549     server, user, password = _get_xml_rpc()
1550     auth = ":".join([user, password])
1551     vm_id = int(get_vm_id(kwargs={"name": name}))
1552     response = server.one.vm.disksave(
1553         auth, vm_id, int(disk_id), image_name, image_type, snapshot_id
1554     )
1555     data = {
1556         "action": "vm.disksave",
1557         "saved": response[0],
1558         "image_id": response[1],
1559         "error_code": response[2],
1560     }
1561     return data
1562 def vm_disk_snapshot_create(name, kwargs=None, call=None):
1563     if call != "action":
1564         raise SaltCloudSystemExit(
1565             "The vm_disk_snapshot_create action must be called with -a or --action."
1566         )
1567     if kwargs is None:
1568         kwargs = {}
1569     disk_id = kwargs.get("disk_id", None)
1570     description = kwargs.get("description", None)
1571     if disk_id is None or description is None:
1572         raise SaltCloudSystemExit(
1573             "The vm_disk_snapshot_create function requires a 'disk_id' and a"
1574             " 'description' to be provided."
1575         )
1576     server, user, password = _get_xml_rpc()
1577     auth = ":".join([user, password])
1578     vm_id = int(get_vm_id(kwargs={"name": name}))
1579     response = server.one.vm.disksnapshotcreate(auth, vm_id, int(disk_id), description)
1580     data = {
1581         "action": "vm.disksnapshotcreate",
1582         "created": response[0],
1583         "snapshot_id": response[1],
1584         "error_code": response[2],
1585     }
1586     return data
1587 def vm_disk_snapshot_delete(name, kwargs=None, call=None):
1588     if call != "action":
1589         raise SaltCloudSystemExit(
1590             "The vm_disk_snapshot_delete action must be called with -a or --action."
1591         )
1592     if kwargs is None:
1593         kwargs = {}
1594     disk_id = kwargs.get("disk_id", None)
1595     snapshot_id = kwargs.get("snapshot_id", None)
1596     if disk_id is None or snapshot_id is None:
1597         raise SaltCloudSystemExit(
1598             "The vm_disk_snapshot_create function requires a 'disk_id' and a"
1599             " 'snapshot_id' to be provided."
1600         )
1601     server, user, password = _get_xml_rpc()
1602     auth = ":".join([user, password])
1603     vm_id = int(get_vm_id(kwargs={"name": name}))
1604     response = server.one.vm.disksnapshotdelete(
1605         auth, vm_id, int(disk_id), int(snapshot_id)
1606     )
1607     data = {
1608         "action": "vm.disksnapshotdelete",
1609         "deleted": response[0],
1610         "snapshot_id": response[1],
1611         "error_code": response[2],
1612     }
1613     return data
1614 def vm_disk_snapshot_revert(name, kwargs=None, call=None):
1615     if call != "action":
1616         raise SaltCloudSystemExit(
1617             "The vm_disk_snapshot_revert action must be called with -a or --action."
1618         )
1619     if kwargs is None:
1620         kwargs = {}
1621     disk_id = kwargs.get("disk_id", None)
1622     snapshot_id = kwargs.get("snapshot_id", None)
1623     if disk_id is None or snapshot_id is None:
1624         raise SaltCloudSystemExit(
1625             "The vm_disk_snapshot_revert function requires a 'disk_id' and a"
1626             " 'snapshot_id' to be provided."
1627         )
1628     server, user, password = _get_xml_rpc()
1629     auth = ":".join([user, password])
1630     vm_id = int(get_vm_id(kwargs={"name": name}))
1631     response = server.one.vm.disksnapshotrevert(
1632         auth, vm_id, int(disk_id), int(snapshot_id)
1633     )
1634     data = {
1635         "action": "vm.disksnapshotrevert",
1636         "deleted": response[0],
1637         "snapshot_id": response[1],
1638         "error_code": response[2],
1639     }
1640     return data
1641 def vm_info(name, call=None):
1642     if call != "action":
1643         raise SaltCloudSystemExit(
1644             "The vm_info action must be called with -a or --action."
1645         )
1646     server, user, password = _get_xml_rpc()
1647     auth = ":".join([user, password])
1648     vm_id = int(get_vm_id(kwargs={"name": name}))
1649     response = server.one.vm.info(auth, vm_id)
1650     if response[0] is False:
1651         return response[1]
1652     else:
1653         info = {}
1654         tree = _get_xml(response[1])
1655         info[tree.find("NAME").text] = _xml_to_dict(tree)
1656         return info
1657 def vm_migrate(name, kwargs=None, call=None):
1658     if call != "action":
1659         raise SaltCloudSystemExit(
1660             "The vm_migrate action must be called with -a or --action."
1661         )
1662 <a name="0"></a>    if kwargs is None:
1663         kwargs = {}
1664     host_id <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>= kwargs.get("host_id", None)
1665     host_name = kwargs.get("host_name", None)
1666     live_migration = kwargs.get("live_migration", False)
1667     capacity_maintained = kwargs.get("capacity_maintained", True)
1668     datastore_id = kwargs.get("datastore_id", None)
1669     datastore_name = kwargs.get(</b></font>"datastore_name", None)
1670     if datastore_id:
1671         if datastore_name:
1672             log.warning(
1673                 "Both the 'datastore_id' and 'datastore_name' arguments were provided. "
1674                 "'datastore_id' will take precedence."
1675             )
1676     elif datastore_name:
1677         datastore_id = get_datastore_id(kwargs={"name": datastore_name})
1678     else:
1679         raise SaltCloudSystemExit(
1680             "The vm_migrate function requires either a 'datastore_id' or a "
1681             "'datastore_name' to be provided."
1682         )
1683     if host_id:
1684         if host_name:
1685             log.warning(
1686                 "Both the 'host_id' and 'host_name' arguments were provided. "
1687                 "'host_id' will take precedence."
1688             )
1689     elif host_name:
1690         host_id = get_host_id(kwargs={"name": host_name})
1691     else:
1692         raise SaltCloudSystemExit(
1693             "The vm_migrate function requires either a 'host_id' "
1694             "or a 'host_name' to be provided."
1695         )
1696     server, user, password = _get_xml_rpc()
1697     auth = ":".join([user, password])
1698     vm_id = int(get_vm_id(kwargs={"name": name}))
1699     response = server.one.vm.migrate(
1700         auth,
1701         vm_id,
1702         int(host_id),
1703         salt.utils.data.is_true(live_migration),
1704         salt.utils.data.is_true(capacity_maintained),
1705         int(datastore_id),
1706     )
1707     data = {
1708         "action": "vm.migrate",
1709         "migrated": response[0],
1710         "vm_id": response[1],
1711         "error_code": response[2],
1712     }
1713     return data
1714 def vm_monitoring(name, call=None):
1715     if call != "action":
1716         raise SaltCloudSystemExit(
1717             "The vm_monitoring action must be called with -a or --action."
1718         )
1719     server, user, password = _get_xml_rpc()
1720     auth = ":".join([user, password])
1721     vm_id = int(get_vm_id(kwargs={"name": name}))
1722     response = server.one.vm.monitoring(auth, vm_id)
1723     if response[0] is False:
1724         log.error(
1725             "There was an error retrieving the specified VM's monitoring information."
1726         )
1727         return {}
1728     else:
1729         info = {}
1730         for vm_ in _get_xml(response[1]):
1731             info[vm_.find("ID").text] = _xml_to_dict(vm_)
1732         return info
1733 def vm_resize(name, kwargs=None, call=None):
1734     if call != "action":
1735         raise SaltCloudSystemExit(
1736             "The vm_resize action must be called with -a or --action."
1737         )
1738     if kwargs is None:
1739         kwargs = {}
1740     path = kwargs.get("path", None)
1741     data = kwargs.get("data", None)
1742     capacity_maintained = kwargs.get("capacity_maintained", True)
1743     if data:
1744         if path:
1745             log.warning(
1746                 "Both the 'data' and 'path' arguments were provided. "
1747                 "'data' will take precedence."
1748             )
1749     elif path:
1750         with salt.utils.files.fopen(path, mode="r") as rfh:
1751             data = rfh.read()
1752     else:
1753         raise SaltCloudSystemExit(
1754             "The vm_resize function requires either 'data' or a file 'path' "
1755             "to be provided."
1756         )
1757     server, user, password = _get_xml_rpc()
1758     auth = ":".join([user, password])
1759     vm_id = int(get_vm_id(kwargs={"name": name}))
1760     response = server.one.vm.resize(
1761         auth, vm_id, data, salt.utils.data.is_true(capacity_maintained)
1762     )
1763     ret = {
1764         "action": "vm.resize",
1765         "resized": response[0],
1766         "vm_id": response[1],
1767         "error_code": response[2],
1768     }
1769     return ret
1770 def vm_snapshot_create(vm_name, kwargs=None, call=None):
1771     if call != "action":
1772         raise SaltCloudSystemExit(
1773             "The vm_snapshot_create action must be called with -a or --action."
1774         )
1775     if kwargs is None:
1776         kwargs = {}
1777     snapshot_name = kwargs.get("snapshot_name", None)
1778     if snapshot_name is None:
1779         raise SaltCloudSystemExit(
1780             "The vm_snapshot_create function requires a 'snapshot_name' to be provided."
1781         )
1782     server, user, password = _get_xml_rpc()
1783     auth = ":".join([user, password])
1784     vm_id = int(get_vm_id(kwargs={"name": vm_name}))
1785     response = server.one.vm.snapshotcreate(auth, vm_id, snapshot_name)
1786     data = {
1787         "action": "vm.snapshotcreate",
1788         "snapshot_created": response[0],
1789         "snapshot_id": response[1],
1790         "error_code": response[2],
1791     }
1792     return data
1793 def vm_snapshot_delete(vm_name, kwargs=None, call=None):
1794     if call != "action":
1795         raise SaltCloudSystemExit(
1796             "The vm_snapshot_delete action must be called with -a or --action."
1797         )
1798     if kwargs is None:
1799         kwargs = {}
1800     snapshot_id = kwargs.get("snapshot_id", None)
1801     if snapshot_id is None:
1802         raise SaltCloudSystemExit(
1803             "The vm_snapshot_delete function requires a 'snapshot_id' to be provided."
1804         )
1805     server, user, password = _get_xml_rpc()
1806     auth = ":".join([user, password])
1807     vm_id = int(get_vm_id(kwargs={"name": vm_name}))
1808     response = server.one.vm.snapshotdelete(auth, vm_id, int(snapshot_id))
1809     data = {
1810         "action": "vm.snapshotdelete",
1811         "snapshot_deleted": response[0],
1812         "vm_id": response[1],
1813         "error_code": response[2],
1814     }
1815     return data
1816 def vm_snapshot_revert(vm_name, kwargs=None, call=None):
1817     if call != "action":
1818         raise SaltCloudSystemExit(
1819             "The vm_snapshot_revert action must be called with -a or --action."
1820         )
1821     if kwargs is None:
1822         kwargs = {}
1823     snapshot_id = kwargs.get("snapshot_id", None)
1824     if snapshot_id is None:
1825         raise SaltCloudSystemExit(
1826             "The vm_snapshot_revert function requires a 'snapshot_id' to be provided."
1827         )
1828     server, user, password = _get_xml_rpc()
1829     auth = ":".join([user, password])
1830     vm_id = int(get_vm_id(kwargs={"name": vm_name}))
1831     response = server.one.vm.snapshotrevert(auth, vm_id, int(snapshot_id))
1832     data = {
1833         "action": "vm.snapshotrevert",
1834         "snapshot_reverted": response[0],
1835         "vm_id": response[1],
1836         "error_code": response[2],
1837     }
1838     return data
1839 def vm_update(name, kwargs=None, call=None):
1840     if call != "action":
1841         raise SaltCloudSystemExit(
1842             "The vm_update action must be called with -a or --action."
1843         )
1844     if kwargs is None:
1845         kwargs = {}
1846     path = kwargs.get("path", None)
1847     data = kwargs.get("data", None)
1848     update_type = kwargs.get("update_type", None)
1849     update_args = ["replace", "merge"]
1850     if update_type is None:
1851         raise SaltCloudSystemExit(
1852             "The vm_update function requires an 'update_type' to be provided."
1853         )
1854     if update_type == update_args[0]:
1855         update_number = 0
1856     elif update_type == update_args[1]:
1857         update_number = 1
1858     else:
1859         raise SaltCloudSystemExit(
1860             "The update_type argument must be either {} or {}.".format(
1861                 update_args[0], update_args[1]
1862             )
1863         )
1864     if data:
1865         if path:
1866             log.warning(
1867                 "Both the 'data' and 'path' arguments were provided. "
1868                 "'data' will take precedence."
1869             )
1870     elif path:
1871         with salt.utils.files.fopen(path, mode="r") as rfh:
1872             data = rfh.read()
1873     else:
1874         raise SaltCloudSystemExit(
1875             "The vm_update function requires either 'data' or a file 'path' "
1876             "to be provided."
1877         )
1878     server, user, password = _get_xml_rpc()
1879     auth = ":".join([user, password])
1880     vm_id = int(get_vm_id(kwargs={"name": name}))
1881     response = server.one.vm.update(auth, vm_id, data, int(update_number))
1882     ret = {
1883         "action": "vm.update",
1884         "updated": response[0],
1885         "resource_id": response[1],
1886         "error_code": response[2],
1887     }
1888     return ret
1889 def vn_add_ar(call=None, kwargs=None):
1890     if call != "function":
1891         raise SaltCloudSystemExit(
1892             "The vn_add_ar function must be called with -f or --function."
1893         )
1894     if kwargs is None:
1895         kwargs = {}
1896     vn_id = kwargs.get("vn_id", None)
1897     vn_name = kwargs.get("vn_name", None)
1898     path = kwargs.get("path", None)
1899     data = kwargs.get("data", None)
1900     if vn_id:
1901         if vn_name:
1902             log.warning(
1903                 "Both the 'vn_id' and 'vn_name' arguments were provided. "
1904                 "'vn_id' will take precedence."
1905             )
1906     elif vn_name:
1907         vn_id = get_vn_id(kwargs={"name": vn_name})
1908     else:
1909         raise SaltCloudSystemExit(
1910             "The vn_add_ar function requires a 'vn_id' and a 'vn_name' to be provided."
1911         )
1912     if data:
1913         if path:
1914             log.warning(
1915                 "Both the 'data' and 'path' arguments were provided. "
1916                 "'data' will take precedence."
1917             )
1918     elif path:
1919         with salt.utils.files.fopen(path, mode="r") as rfh:
1920             data = rfh.read()
1921     else:
1922         raise SaltCloudSystemExit(
1923             "The vn_add_ar function requires either 'data' or a file 'path' "
1924             "to be provided."
1925         )
1926     server, user, password = _get_xml_rpc()
1927     auth = ":".join([user, password])
1928     response = server.one.vn.add_ar(auth, int(vn_id), data)
1929     ret = {
1930         "action": "vn.add_ar",
1931         "address_range_added": response[0],
1932         "resource_id": response[1],
1933         "error_code": response[2],
1934     }
1935     return ret
1936 def vn_allocate(call=None, kwargs=None):
1937     if call != "function":
1938         raise SaltCloudSystemExit(
1939             "The vn_allocate function must be called with -f or --function."
1940         )
1941     if kwargs is None:
1942         kwargs = {}
1943     cluster_id = kwargs.get("cluster_id", None)
1944     cluster_name = kwargs.get("cluster_name", None)
1945     path = kwargs.get("path", None)
1946     data = kwargs.get("data", None)
1947     if data:
1948         if path:
1949             log.warning(
1950                 "Both the 'data' and 'path' arguments were provided. "
1951                 "'data' will take precedence."
1952             )
1953     elif path:
1954         with salt.utils.files.fopen(path, mode="r") as rfh:
1955             data = rfh.read()
1956     else:
1957         raise SaltCloudSystemExit(
1958             "The vn_allocate function requires either 'data' or a file 'path' "
1959             "to be provided."
1960         )
1961     if cluster_id:
1962         if cluster_name:
1963             log.warning(
1964                 "Both the 'cluster_id' and 'cluster_name' arguments were provided. "
1965                 "'cluster_id' will take precedence."
1966             )
1967     elif cluster_name:
1968         cluster_id = get_cluster_id(kwargs={"name": cluster_name})
1969     else:
1970         cluster_id = "-1"
1971     server, user, password = _get_xml_rpc()
1972     auth = ":".join([user, password])
1973     response = server.one.vn.allocate(auth, data, int(cluster_id))
1974     ret = {
1975         "action": "vn.allocate",
1976         "allocated": response[0],
1977         "vn_id": response[1],
1978         "error_code": response[2],
1979     }
1980     return ret
1981 def vn_delete(call=None, kwargs=None):
1982     if call != "function":
1983         raise SaltCloudSystemExit(
1984             "The vn_delete function must be called with -f or --function."
1985         )
1986     if kwargs is None:
1987         kwargs = {}
1988     name = kwargs.get("name", None)
1989     vn_id = kwargs.get("vn_id", None)
1990     if vn_id:
1991         if name:
1992             log.warning(
1993                 "Both the 'vn_id' and 'name' arguments were provided. "
1994                 "'vn_id' will take precedence."
1995             )
1996     elif name:
1997         vn_id = get_vn_id(kwargs={"name": name})
1998     else:
1999         raise SaltCloudSystemExit(
2000             "The vn_delete function requires a 'name' or a 'vn_id' to be provided."
2001         )
2002     server, user, password = _get_xml_rpc()
2003     auth = ":".join([user, password])
2004     response = server.one.vn.delete(auth, int(vn_id))
2005     data = {
2006         "action": "vn.delete",
2007         "deleted": response[0],
2008         "vn_id": response[1],
2009         "error_code": response[2],
2010     }
2011     return data
2012 def vn_free_ar(call=None, kwargs=None):
2013     if call != "function":
2014         raise SaltCloudSystemExit(
2015             "The vn_free_ar function must be called with -f or --function."
2016         )
2017     if kwargs is None:
2018         kwargs = {}
2019     vn_id = kwargs.get("vn_id", None)
2020     vn_name = kwargs.get("vn_name", None)
2021     ar_id = kwargs.get("ar_id", None)
2022     if ar_id is None:
2023         raise SaltCloudSystemExit(
2024             "The vn_free_ar function requires an 'rn_id' to be provided."
2025         )
2026     if vn_id:
2027         if vn_name:
2028             log.warning(
2029                 "Both the 'vn_id' and 'vn_name' arguments were provided. "
2030                 "'vn_id' will take precedence."
2031             )
2032     elif vn_name:
2033         vn_id = get_vn_id(kwargs={"name": vn_name})
2034     else:
2035         raise SaltCloudSystemExit(
2036             "The vn_free_ar function requires a 'vn_id' or a 'vn_name' to be provided."
2037         )
2038     server, user, password = _get_xml_rpc()
2039     auth = ":".join([user, password])
2040     response = server.one.vn.free_ar(auth, int(vn_id), int(ar_id))
2041     data = {
2042         "action": "vn.free_ar",
2043         "ar_freed": response[0],
2044         "resource_id": response[1],
2045         "error_code": response[2],
2046     }
2047     return data
2048 def vn_hold(call=None, kwargs=None):
2049     if call != "function":
2050         raise SaltCloudSystemExit(
2051             "The vn_hold function must be called with -f or --function."
2052         )
2053     if kwargs is None:
2054         kwargs = {}
2055     vn_id = kwargs.get("vn_id", None)
2056     vn_name = kwargs.get("vn_name", None)
2057     path = kwargs.get("path", None)
2058     data = kwargs.get("data", None)
2059     if vn_id:
2060         if vn_name:
2061             log.warning(
2062                 "Both the 'vn_id' and 'vn_name' arguments were provided. "
2063                 "'vn_id' will take precedence."
2064             )
2065     elif vn_name:
2066         vn_id = get_vn_id(kwargs={"name": vn_name})
2067     else:
2068         raise SaltCloudSystemExit(
2069             "The vn_hold function requires a 'vn_id' or a 'vn_name' to be provided."
2070         )
2071     if data:
2072         if path:
2073             log.warning(
2074                 "Both the 'data' and 'path' arguments were provided. "
2075                 "'data' will take precedence."
2076             )
2077     elif path:
2078         with salt.utils.files.fopen(path, mode="r") as rfh:
2079             data = rfh.read()
2080     else:
2081         raise SaltCloudSystemExit(
2082             "The vn_hold function requires either 'data' or a 'path' to be provided."
2083         )
2084     server, user, password = _get_xml_rpc()
2085     auth = ":".join([user, password])
2086     response = server.one.vn.hold(auth, int(vn_id), data)
2087     ret = {
2088         "action": "vn.hold",
2089         "held": response[0],
2090         "resource_id": response[1],
2091         "error_code": response[2],
2092     }
2093     return ret
2094 def vn_info(call=None, kwargs=None):
2095     if call != "function":
2096         raise SaltCloudSystemExit(
2097             "The vn_info function must be called with -f or --function."
2098         )
2099     if kwargs is None:
2100         kwargs = {}
2101     name = kwargs.get("name", None)
2102     vn_id = kwargs.get("vn_id", None)
2103     if vn_id:
2104         if name:
2105             log.warning(
2106                 "Both the 'vn_id' and 'name' arguments were provided. "
2107                 "'vn_id' will take precedence."
2108             )
2109     elif name:
2110         vn_id = get_vn_id(kwargs={"name": name})
2111     else:
2112         raise SaltCloudSystemExit(
2113             "The vn_info function requires either a 'name' or a 'vn_id' to be provided."
2114         )
2115     server, user, password = _get_xml_rpc()
2116     auth = ":".join([user, password])
2117     response = server.one.vn.info(auth, int(vn_id))
2118     if response[0] is False:
2119         return response[1]
2120     else:
2121         info = {}
2122         tree = _get_xml(response[1])
2123         info[tree.find("NAME").text] = _xml_to_dict(tree)
2124         return info
2125 def vn_release(call=None, kwargs=None):
2126     if call != "function":
2127         raise SaltCloudSystemExit(
2128             "The vn_reserve function must be called with -f or --function."
2129         )
2130     if kwargs is None:
2131         kwargs = {}
2132     vn_id = kwargs.get("vn_id", None)
2133     vn_name = kwargs.get("vn_name", None)
2134     path = kwargs.get("path", None)
2135     data = kwargs.get("data", None)
2136     if vn_id:
2137         if vn_name:
2138             log.warning(
2139                 "Both the 'vn_id' and 'vn_name' arguments were provided. "
2140                 "'vn_id' will take precedence."
2141             )
2142     elif vn_name:
2143         vn_id = get_vn_id(kwargs={"name": vn_name})
2144     else:
2145         raise SaltCloudSystemExit(
2146             "The vn_release function requires a 'vn_id' or a 'vn_name' to be provided."
2147         )
2148     if data:
2149         if path:
2150             log.warning(
2151                 "Both the 'data' and 'path' arguments were provided. "
2152                 "'data' will take precedence."
2153             )
2154     elif path:
2155         with salt.utils.files.fopen(path, mode="r") as rfh:
2156             data = rfh.read()
2157     else:
2158         raise SaltCloudSystemExit(
2159             "The vn_release function requires either 'data' or a 'path' to be provided."
2160         )
2161     server, user, password = _get_xml_rpc()
2162     auth = ":".join([user, password])
2163     response = server.one.vn.release(auth, int(vn_id), data)
2164     ret = {
2165         "action": "vn.release",
2166         "released": response[0],
2167         "resource_id": response[1],
2168         "error_code": response[2],
2169     }
2170     return ret
2171 def vn_reserve(call=None, kwargs=None):
2172     if call != "function":
2173         raise SaltCloudSystemExit(
2174             "The vn_reserve function must be called with -f or --function."
2175         )
2176     if kwargs is None:
2177         kwargs = {}
2178     vn_id = kwargs.get("vn_id", None)
2179     vn_name = kwargs.get("vn_name", None)
2180     path = kwargs.get("path", None)
2181     data = kwargs.get("data", None)
2182     if vn_id:
2183         if vn_name:
2184             log.warning(
2185                 "Both the 'vn_id' and 'vn_name' arguments were provided. "
2186                 "'vn_id' will take precedence."
2187             )
2188     elif vn_name:
2189         vn_id = get_vn_id(kwargs={"name": vn_name})
2190     else:
2191         raise SaltCloudSystemExit(
2192             "The vn_reserve function requires a 'vn_id' or a 'vn_name' to be provided."
2193         )
2194     if data:
2195         if path:
2196             log.warning(
2197                 "Both the 'data' and 'path' arguments were provided. "
2198                 "'data' will take precedence."
2199             )
2200     elif path:
2201         with salt.utils.files.fopen(path, mode="r") as rfh:
2202             data = rfh.read()
2203     else:
2204         raise SaltCloudSystemExit(
2205             "The vn_reserve function requires a 'path' to be provided."
2206         )
2207     server, user, password = _get_xml_rpc()
2208     auth = ":".join([user, password])
2209     response = server.one.vn.reserve(auth, int(vn_id), data)
2210     ret = {
2211         "action": "vn.reserve",
2212         "reserved": response[0],
2213         "resource_id": response[1],
2214         "error_code": response[2],
2215     }
2216     return ret
2217 def _get_node(name):
2218     attempts = 10
2219     while attempts &gt;= 0:
2220         try:
2221             return list_nodes_full()[name]
2222         except KeyError:
2223             attempts -= 1
2224             log.debug(
2225                 "Failed to get the data for node '%s'. Remaining attempts: %s",
2226                 name,
2227                 attempts,
2228             )
2229             time.sleep(0.5)
2230     return {}
2231 def _get_xml(xml_str):
2232     try:
2233         xml_data = etree.XML(xml_str)
2234     except etree.XMLSyntaxError as err:
2235         raise SaltCloudSystemExit("opennebula returned: {}".format(xml_str))
2236     return xml_data
2237 def _get_xml_rpc():
2238     vm_ = get_configured_provider()
2239     xml_rpc = config.get_cloud_config_value(
2240         "xml_rpc", vm_, __opts__, search_global=False
2241     )
2242     user = config.get_cloud_config_value("user", vm_, __opts__, search_global=False)
2243     password = config.get_cloud_config_value(
2244         "password", vm_, __opts__, search_global=False
2245     )
2246     server = xmlrpc.client.ServerProxy(xml_rpc)
2247     return server, user, password
2248 def _list_nodes(full=False):
2249     server, user, password = _get_xml_rpc()
2250     auth = ":".join([user, password])
2251     vm_pool = server.one.vmpool.info(auth, -2, -1, -1, -1)[1]
2252     vms = {}
2253     for vm in _get_xml(vm_pool):
2254         name = vm.find("NAME").text
2255         vms[name] = {}
2256         cpu_size = vm.find("TEMPLATE").find("CPU").text
2257         memory_size = vm.find("TEMPLATE").find("MEMORY").text
2258         private_ips = []
2259         for nic in vm.find("TEMPLATE").findall("NIC"):
2260             try:
2261                 private_ips.append(nic.find("IP").text)
2262             except Exception:  # pylint: disable=broad-except
2263                 pass
2264         vms[name]["id"] = vm.find("ID").text
2265         if "TEMPLATE_ID" in vm.find("TEMPLATE"):
2266             vms[name]["image"] = vm.find("TEMPLATE").find("TEMPLATE_ID").text
2267         vms[name]["name"] = name
2268         vms[name]["size"] = {"cpu": cpu_size, "memory": memory_size}
2269         vms[name]["state"] = vm.find("STATE").text
2270         vms[name]["private_ips"] = private_ips
2271         vms[name]["public_ips"] = []
2272         if full:
2273             vms[vm.find("NAME").text] = _xml_to_dict(vm)
2274     return vms
2275 def _xml_to_dict(xml):
2276     dicts = {}
2277     for item in xml:
2278         key = item.tag.lower()
2279         idx = 1
2280         while key in dicts:
2281             key += str(idx)
2282             idx += 1
2283         if item.text is None:
2284             dicts[key] = _xml_to_dict(item)
2285         else:
2286             dicts[key] = item.text
2287     return dicts
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>vagrant_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 import logging
2 import os
3 import salt.utils.files
4 import salt.utils.path
5 import salt.utils.stringutils
6 from salt._compat import ipaddress
7 from salt.exceptions import CommandExecutionError, SaltInvocationError
8 log = logging.getLogger(__name__)
9 __virtualname__ = "vagrant"
10 VAGRANT_SDB_URL = "sdb://vagrant_sdb_data/"
11 def __virtual__():
12     if salt.utils.path.which("vagrant") is None:
13         return (
14             False,
15             "The vagrant module could not be loaded: vagrant command not found",
16         )
17     return __virtualname__
18 def _build_sdb_uri(key):
19     return "{}{}".format(VAGRANT_SDB_URL, key)
20 def _build_machine_uri(machine, cwd):
21     key = "{}?{}".format(machine, os.path.abspath(cwd))
22     return _build_sdb_uri(key)
23 def _update_vm_info(name, vm_):
24     __utils__["sdb.sdb_set"](_build_sdb_uri(name), vm_, __opts__)
25     if vm_["machine"]:
26         __utils__["sdb.sdb_set"](
27             _build_machine_uri(vm_["machine"], vm_.get("cwd", ".")), name, __opts__
28         )
29 def get_vm_info(name):
30     try:
31         vm_ = __utils__["sdb.sdb_get"](_build_sdb_uri(name), __opts__)
32     except KeyError:
33         raise SaltInvocationError(
34             "Probable sdb driver not found. Check your configuration."
35         )
36     if vm_ is None or "machine" not in vm_:
37         raise SaltInvocationError(
38             "No Vagrant machine defined for Salt_id {}".format(name)
39         )
40     return vm_
41 def get_machine_id(machine, cwd):
42     name = __utils__["sdb.sdb_get"](_build_machine_uri(machine, cwd), __opts__)
43     return name
44 def _erase_vm_info(name):
45     try:
46         vm_ = get_vm_info(name)
47         if vm_["machine"]:
48             key = _build_machine_uri(vm_["machine"], vm_.get("cwd", "."))
49             try:
50                 __utils__["sdb.sdb_delete"](key, __opts__)
51             except KeyError:
52                 __utils__["sdb.sdb_set"](key, None, __opts__)
53     except Exception:  # pylint: disable=broad-except
54         pass
55     uri = _build_sdb_uri(name)
56     try:
57         __utils__["sdb.sdb_delete"](uri, __opts__)
58     except KeyError:
59         __utils__["sdb.sdb_set"](uri, {}, __opts__)
60     except Exception:  # pylint: disable=broad-except
61         pass
62 def _vagrant_ssh_config(vm_):
63     machine = vm_["machine"]
64     log<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>.info("requesting vagrant ssh-config for VM %s", machine or "(default)")
65     cmd = "vagrant ssh-config {}".format(machine)
66     reply = __salt__["cmd.shell"](
67         cmd, runas=vm_.get("runas"), cwd=vm_.get("cwd"), ignore_retcode=</b></font>True
68     )
69     ssh_config = {}
70     for line in reply.split("\n"):  # build a dictionary of the text reply
71         tokens = line.strip().split()
72         if len(tokens) == 2:  # each two-token line becomes a key:value pair
73             ssh_config[tokens[0]] = tokens[1]
74     log.debug("ssh_config=%s", repr(ssh_config))
75     return ssh_config
76 def version():
77     cmd = "vagrant -v"
78     return __salt__["cmd.shell"](cmd)
79 def list_domains():
80     vms = []
81     cmd = "vagrant global-status"
82     reply = __salt__["cmd.shell"](cmd)
83     log.debug("---&gt;\n%s", reply)
84     for line in reply.split("\n"):  # build a list of the text reply
85         tokens = line.strip().split()
86         try:
87             _ = int(tokens[0], 16)  # valid id numbers are hexadecimal
88         except (ValueError, IndexError):
89             continue  # skip lines without valid id numbers
90         machine = tokens[1]
91         cwd = tokens[-1]
92         name = get_machine_id(machine, cwd)
93         if name:
94             vms.append(name)
95     return vms
96 def list_active_vms(cwd=None):
97     vms = []
98     cmd = "vagrant status"
99     reply = __salt__["cmd.shell"](cmd, cwd=cwd)
100     log.info("---&gt;\n%s", reply)
101     for line in reply.split("\n"):  # build a list of the text reply
102         tokens = line.strip().split()
103         if len(tokens) &gt; 1:
104             if tokens[1] == "running":
105                 vms.append(tokens[0])
106     return vms
107 def list_inactive_vms(cwd=None):
108     vms = []
109     cmd = "vagrant status"
110     reply = __salt__["cmd.shell"](cmd, cwd=cwd)
111     log.info("---&gt;\n%s", reply)
112     for line in reply.split("\n"):  # build a list of the text reply
113         tokens = line.strip().split()
114         if len(tokens) &gt; 1 and tokens[-1].endswith(")"):
115             if tokens[1] != "running":
116                 vms.append(tokens[0])
117     return vms
118 def vm_state(name="", cwd=None):
119     if name:
120         vm_ = get_vm_info(name)
121         machine = vm_["machine"]
122         cwd = vm_["cwd"] or cwd  # usually ignore passed-in cwd
123     else:
124         if not cwd:
125             raise SaltInvocationError(
126                 "Path to Vagranfile must be defined, but cwd={}".format(cwd)
127             )
128         machine = ""
129     info = []
130     cmd = "vagrant status {}".format(machine)
131     reply = __salt__["cmd.shell"](cmd, cwd)
132     log.info("---&gt;\n%s", reply)
133     for line in reply.split("\n"):  # build a list of the text reply
134         tokens = line.strip().split()
135         if len(tokens) &gt; 1 and tokens[-1].endswith(")"):
136             try:
137                 datum = {
138                     "machine": tokens[0],
139                     "state": " ".join(tokens[1:-1]),
140                     "provider": tokens[-1].lstrip("(").rstrip(")"),
141                     "name": get_machine_id(tokens[0], cwd),
142                 }
143                 info.append(datum)
144             except IndexError:
145                 pass
146     return info
147 def init(
148     name,  # Salt_id for created VM
149     cwd=None,  # path to find Vagrantfile
150     machine="",  # name of machine in Vagrantfile
151     runas=None,  # username who owns Vagrant box
152     start=False,  # start the machine when initialized
153     vagrant_provider="",  # vagrant provider (default=virtualbox)
154     vm=None,  # a dictionary of VM configuration settings
155 ):
156     vm_ = {} if vm is None else vm.copy()  # passed configuration data
157     vm_["name"] = name
158     vm_["cwd"] = cwd or vm_.get("cwd")
159     if not vm_["cwd"]:
160         raise SaltInvocationError(
161             'Path to Vagrantfile must be defined by "cwd" argument'
162         )
163     vm_["machine"] = machine or vm_.get("machine", machine)
164     vm_["runas"] = runas or vm_.get("runas", runas)
165     vm_["vagrant_provider"] = vagrant_provider or vm_.get("vagrant_provider", "")
166     _update_vm_info(name, vm_)
167     if start:
168         log.debug("Starting VM %s", name)
169         ret = _start(name, vm_)
170     else:
171         ret = "Name {} defined using VM {}".format(name, vm_["machine"] or "(default)")
172     return ret
173 def start(name):
174     vm_ = get_vm_info(name)
175     return _start(name, vm_)
176 def _start(
177     name, vm_
178 ):  # internal call name, because "start" is a keyword argument to vagrant.init
179     try:
180         machine = vm_["machine"]
181     except KeyError:
182         raise SaltInvocationError(
183 <a name="0"></a>            "No Vagrant machine defined for Salt_id {}".format(name)
184         )
185     vagrant_provider <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= vm_.get("vagrant_provider", "")
186     provider_ = "--provider={}".format(vagrant_provider) if vagrant_provider else ""
187     cmd = "vagrant up {} {}".format(machine, provider_)
188     ret = __salt__["cmd.run_all"](
189         cmd, runas=vm_.get("runas"), cwd=vm_.get(</b></font>"cwd"), output_loglevel="info"
190     )
191     if machine == "":  # we were called using the default machine
192         for line in ret["stdout"].split("\n"):  # find its actual Vagrant name
193             if line.startswith("==&gt;"):
194                 machine = line.split()[1].rstrip(":")
195                 vm_["machine"] = machine
196                 _update_vm_info(name, vm_)  # and remember the true name
197                 break
198     if ret["retcode"] == 0:
199         return 'Started "{}" using Vagrant machine "{}".'.format(name, machine)
200     return False
201 def shutdown(name):
202     return stop(name)
203 def stop(name):
204 <a name="5"></a>    vm_ = get_vm_info(name)
205     machine = vm_["machine"]
206     cmd <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "vagrant halt {}".format(machine)
207     ret = __salt__["cmd.retcode"](cmd, runas=vm_.get("runas"), cwd=vm_.get(</b></font>"cwd"))
208     return ret == 0
209 def pause(name):
210 <a name="4"></a>    vm_ = get_vm_info(name)
211     machine = vm_["machine"]
212     cmd <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "vagrant suspend {}".format(machine)
213     ret = __salt__["cmd.retcode"](cmd, runas=vm_.get("runas"), cwd=vm_.get(</b></font>"cwd"))
214     return ret == 0
215 def reboot(name, provision=False):
216     vm_ = get_vm_info(name)
217 <a name="3"></a>    machine = vm_["machine"]
218     prov = "--provision" if provision else ""
219     cmd <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "vagrant reload {} {}".format(machine, prov)
220     ret = __salt__["cmd.retcode"](cmd, runas=vm_.get("runas"), cwd=vm_.get(</b></font>"cwd"))
221     return ret == 0
222 def destroy(name):
223 <a name="2"></a>    vm_ = get_vm_info(name)
224     machine = vm_["machine"]
225     cmd <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>= "vagrant destroy -f {}".format(machine)
226     ret = __salt__["cmd.run_all"](
227         cmd, runas=vm_.get("runas"), cwd=vm_.get("cwd"), output_loglevel=</b></font>"info"
228     )
229     if ret["retcode"] == 0:
230         _erase_vm_info(name)
231         return "Destroyed VM {}".format(name)
232     return False
233 def get_ssh_config(name, network_mask="", get_private_key=False):
234     r"""
235     Retrieve hints of how you might connect to a Vagrant VM.
236     :param name: the salt_id of the machine
237     :param network_mask: a CIDR mask to search for the VM's address
238     :param get_private_key: (default: False) return the key used for ssh login
239     :return: a dict of ssh login information for the VM
240     CLI Example:
241     .. code-block:: bash
242         salt &lt;host&gt; vagrant.get_ssh_config &lt;salt_id&gt;
243         salt my_laptop vagrant.get_ssh_config quail1 network_mask=10.0.0.0/8 get_private_key=True
244     The returned dictionary contains:
245     - key_filename:  the name of the private key file on the VM host computer
246     - ssh_username:  the username to be used to log in to the VM
247     - ssh_host:  the IP address used to log in to the VM.  (This will usually be `127.0.0.1`)
248     - ssh_port:  the TCP port used to log in to the VM.  (This will often be `2222`)
249     - \[ip_address:\]  (if `network_mask` is defined. see below)
250     - \[private_key:\]  (if `get_private_key` is True) the private key for ssh_username
251     About `network_mask`:
252     Vagrant usually uses a redirected TCP port on its host computer to log in to a VM using ssh.
253     This redirected port and its IP address are "ssh_port" and "ssh_host".  The ssh_host is
254     usually the localhost (127.0.0.1).
255     This makes it impossible for a third machine (such as a salt-cloud master) to contact the VM
256     unless the VM has another network interface defined.  You will usually want a bridged network
257     defined by having a `config.vm.network "public_network"` statement in your `Vagrantfile`.
258     The IP address of the bridged adapter will typically be assigned by DHCP and unknown to you,
259     but you should be able to determine what IP network the address will be chosen from.
260     If you enter a CIDR network mask, Salt will attempt to find the VM's address for you.
261     The host machine will send an "ifconfig" command to the VM (using ssh to `ssh_host`:`ssh_port`)
262     and return the IP address of the first interface it can find which matches your mask.
263     """
264     vm_ = get_vm_info(name)
265     ssh_config = _vagrant_ssh_config(vm_)
266     try:
267         ans = {
268             "key_filename": ssh_config["IdentityFile"],
269             "ssh_username": ssh_config["User"],
270             "ssh_host": ssh_config["HostName"],
271             "ssh_port": ssh_config["Port"],
272         }
273     except KeyError:
274         raise CommandExecutionError(
275             "Insufficient SSH information to contact VM {}. Is it running?".format(
276                 vm_.get("machine", "(default)")
277             )
278         )
279     if network_mask:
280         command = (
281             "ssh -i {IdentityFile} -p {Port} "
282             "-oStrictHostKeyChecking={StrictHostKeyChecking} "
283             "-oUserKnownHostsFile={UserKnownHostsFile} "
284             "-oControlPath=none "
285             "{User}@{HostName} ifconfig".format(**ssh_config)
286         )
287         log.info("Trying ssh -p %(Port)s %(User)s@%(HostName)s ifconfig", ssh_config)
288         reply = __salt__["cmd.shell"](command)
289         log.info("---&gt;\n%s", reply)
290         target_network_range = ipaddress.ip_network(network_mask, strict=False)
291         for line in reply.split("\n"):
292             try:  # try to find a bridged network address
293                 tokens = line.replace(
294                     "addr:", "", 1
295                 ).split()  # remove "addr:" if it exists, then split
296                 found_address = None
297                 if "inet" in tokens:
298                     nxt = tokens.index("inet") + 1
299                     found_address = ipaddress.ip_address(tokens[nxt])
300                 elif "inet6" in tokens:
301                     nxt = tokens.index("inet6") + 1
302                     found_address = ipaddress.ip_address(tokens[nxt].split("/")[0])
303                 if found_address in target_network_range:
304                     ans["ip_address"] = str(found_address)
305                     break  # we have located a good matching address
306             except (IndexError, AttributeError, TypeError):
307                 pass  # all syntax and type errors loop here
308         log.info(
309             "Network IP address in %s detected as: %s",
310             target_network_range,
311             ans.get("ip_address", "(not found)"),
312         )
313     if get_private_key:
314         try:
315             with salt.utils.files.fopen(ssh_config["IdentityFile"]) as pks:
316                 ans["private_key"] = salt.utils.stringutils.to_unicode(pks.read())
317         except OSError as e:
318             raise CommandExecutionError(
319                 "Error processing Vagrant private key file: {}".format(e)
320             )
321     return ans
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
