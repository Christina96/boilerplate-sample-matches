<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for opennebula.py & vagrant_1.py</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for opennebula.py & vagrant_1.py
      </h3>
      <h1 align="center">
        3.5%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>opennebula.py (2.0712302%)<TH>vagrant_1.py (13.12%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match94691-0.html#0',2,'match94691-1.html#0',3)" NAME="0">(3426-3431)<TD><A HREF="javascript:ZweiFrames('match94691-0.html#0',2,'match94691-1.html#0',3)" NAME="0">(411-415)</A><TD ALIGN=center><FONT COLOR="#ff0000">18</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match94691-0.html#1',2,'match94691-1.html#1',3)" NAME="1">(1805-1810)<TD><A HREF="javascript:ZweiFrames('match94691-0.html#1',2,'match94691-1.html#1',3)" NAME="1">(163-166)</A><TD ALIGN=center><FONT COLOR="#d40000">15</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match94691-0.html#2',2,'match94691-1.html#2',3)" NAME="2">(2197-2201)<TD><A HREF="javascript:ZweiFrames('match94691-0.html#2',2,'match94691-1.html#2',3)" NAME="2">(521-524)</A><TD ALIGN=center><FONT COLOR="#b80000">13</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match94691-0.html#3',2,'match94691-1.html#3',3)" NAME="3">(2583-2586)<TD><A HREF="javascript:ZweiFrames('match94691-0.html#3',2,'match94691-1.html#3',3)" NAME="3">(501-502)</A><TD ALIGN=center><FONT COLOR="#aa0000">12</FONT>
<TR><TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match94691-0.html#4',2,'match94691-1.html#4',3)" NAME="4">(2364-2367)<TD><A HREF="javascript:ZweiFrames('match94691-0.html#4',2,'match94691-1.html#4',3)" NAME="4">(479-480)</A><TD ALIGN=center><FONT COLOR="#aa0000">12</FONT>
<TR><TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT><TD><A HREF="javascript:ZweiFrames('match94691-0.html#5',2,'match94691-1.html#5',3)" NAME="5">(1254-1257)<TD><A HREF="javascript:ZweiFrames('match94691-0.html#5',2,'match94691-1.html#5',3)" NAME="5">(461-462)</A><TD ALIGN=center><FONT COLOR="#aa0000">12</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>opennebula.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
OpenNebula Cloud Module
=======================

The OpenNebula cloud module is used to control access to an OpenNebula cloud.

.. versionadded:: 2014.7.0

:depends: lxml
:depends: OpenNebula installation running version ``4.14`` or later.

Use of this module requires the ``xml_rpc``, ``user``, and ``password``
parameters to be set.

Set up the cloud configuration at ``/etc/salt/cloud.providers`` or
``/etc/salt/cloud.providers.d/opennebula.conf``:

.. code-block:: yaml

    my-opennebula-config:
      xml_rpc: http://localhost:2633/RPC2
      user: oneadmin
      password: JHGhgsayu32jsa
      driver: opennebula

This driver supports accessing new VM instances via DNS entry instead
of IP address.  To enable this feature, in the provider or profile file
add `fqdn_base` with a value matching the base of your fully-qualified
domain name.  Example:

.. code-block:: yaml

    my-opennebula-config:
      [...]
      fqdn_base: &lt;my.basedomain.com&gt;
      [...]

The driver will prepend the hostname to the fqdn_base and do a DNS lookup
to find the IP of the new VM.

.. note:

    Whenever ``data`` is provided as a kwarg to a function and the
    attribute=value syntax is used, the entire ``data`` value must be
    wrapped in single or double quotes. If the value given in the
    attribute=value data string contains multiple words, double quotes
    *must* be used for the value while the entire data string should
    be encapsulated in single quotes. Failing to do so will result in
    an error. Example:

.. code-block:: bash

    salt-cloud -f image_allocate opennebula datastore_name=default \\
        data='NAME=&quot;My New Image&quot; DESCRIPTION=&quot;Description of the image.&quot; \\
        PATH=/home/one_user/images/image_name.img'
    salt-cloud -f secgroup_allocate opennebula \\
        data=&quot;Name = test RULE = [PROTOCOL = TCP, RULE_TYPE = inbound, \\
        RANGE = 1000:2000]&quot;

&quot;&quot;&quot;

import logging
import os
import pprint
import time

import salt.config as config
import salt.utils.data
import salt.utils.files
from salt.exceptions import (
    SaltCloudConfigError,
    SaltCloudExecutionFailure,
    SaltCloudExecutionTimeout,
    SaltCloudNotFound,
    SaltCloudSystemExit,
)

try:
    import xmlrpc.client
    from lxml import etree

    HAS_XML_LIBS = True
except ImportError:
    HAS_XML_LIBS = False


# Get Logging Started
log = logging.getLogger(__name__)

__virtualname__ = &quot;opennebula&quot;


def __virtual__():
    &quot;&quot;&quot;
    Check for OpenNebula configs.
    &quot;&quot;&quot;
    if get_configured_provider() is False:
        return False

    if get_dependencies() is False:
        return False

    return __virtualname__


def _get_active_provider_name():
    try:
        return __active_provider_name__.value()
    except AttributeError:
        return __active_provider_name__


def get_configured_provider():
    &quot;&quot;&quot;
    Return the first configured instance.
    &quot;&quot;&quot;
    return config.is_provider_configured(
        __opts__,
        _get_active_provider_name() or __virtualname__,
        (&quot;xml_rpc&quot;, &quot;user&quot;, &quot;password&quot;),
    )


def get_dependencies():
    &quot;&quot;&quot;
    Warn if dependencies aren't met.
    &quot;&quot;&quot;
    return config.check_driver_dependencies(__virtualname__, {&quot;lmxl&quot;: HAS_XML_LIBS})


def avail_images(call=None):
    &quot;&quot;&quot;
    Return available OpenNebula images.

    CLI Example:

    .. code-block:: bash

        salt-cloud --list-images opennebula
        salt-cloud --function avail_images opennebula
        salt-cloud -f avail_images opennebula

    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The avail_images function must be called with &quot;
            &quot;-f or --function, or with the --list-images option&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])

    image_pool = server.one.imagepool.info(auth, -2, -1, -1)[1]

    images = {}
    for image in _get_xml(image_pool):
        images[image.find(&quot;NAME&quot;).text] = _xml_to_dict(image)

    return images


def avail_locations(call=None):
    &quot;&quot;&quot;
    Return available OpenNebula locations.

    CLI Example:

    .. code-block:: bash

        salt-cloud --list-locations opennebula
        salt-cloud --function avail_locations opennebula
        salt-cloud -f avail_locations opennebula

    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The avail_locations function must be called with &quot;
            &quot;-f or --function, or with the --list-locations option.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    host_pool = server.one.hostpool.info(auth)[1]

    locations = {}
    for host in _get_xml(host_pool):
        locations[host.find(&quot;NAME&quot;).text] = _xml_to_dict(host)

    return locations


def avail_sizes(call=None):
    &quot;&quot;&quot;
    Because sizes are built into templates with OpenNebula, there will be no sizes to
    return here.
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The avail_sizes function must be called with &quot;
            &quot;-f or --function, or with the --list-sizes option.&quot;
        )

    log.warning(
        &quot;Because sizes are built into templates with OpenNebula, there are no sizes &quot;
        &quot;to return.&quot;
    )

    return {}


def list_clusters(call=None):
    &quot;&quot;&quot;
    Returns a list of clusters in OpenNebula.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f list_clusters opennebula
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The list_clusters function must be called with -f or --function.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    cluster_pool = server.one.clusterpool.info(auth)[1]

    clusters = {}
    for cluster in _get_xml(cluster_pool):
        clusters[cluster.find(&quot;NAME&quot;).text] = _xml_to_dict(cluster)

    return clusters


def list_datastores(call=None):
    &quot;&quot;&quot;
    Returns a list of data stores on OpenNebula.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f list_datastores opennebula
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The list_datastores function must be called with -f or --function.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    datastore_pool = server.one.datastorepool.info(auth)[1]

    datastores = {}
    for datastore in _get_xml(datastore_pool):
        datastores[datastore.find(&quot;NAME&quot;).text] = _xml_to_dict(datastore)

    return datastores


def list_hosts(call=None):
    &quot;&quot;&quot;
    Returns a list of hosts on OpenNebula.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f list_hosts opennebula
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The list_hosts function must be called with -f or --function.&quot;
        )

    return avail_locations()


def list_nodes(call=None):
    &quot;&quot;&quot;
    Return a list of VMs on OpenNebula.

    CLI Example:

    .. code-block:: bash

        salt-cloud -Q
        salt-cloud --query
        salt-cloud --function list_nodes opennebula
        salt-cloud -f list_nodes opennebula

    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The list_nodes function must be called with -f or --function.&quot;
        )

    return _list_nodes(full=False)


def list_nodes_full(call=None):
    &quot;&quot;&quot;
    Return a list of the VMs on OpenNebula.

    CLI Example:

    .. code-block:: bash

        salt-cloud -F
        salt-cloud --full-query
        salt-cloud --function list_nodes_full opennebula
        salt-cloud -f list_nodes_full opennebula

    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The list_nodes_full function must be called with -f or --function.&quot;
        )

    return _list_nodes(full=True)


def list_nodes_select(call=None):
    &quot;&quot;&quot;
    Return a list of the VMs that are on the provider, with select fields.
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The list_nodes_full function must be called with -f or --function.&quot;
        )

    return __utils__[&quot;cloud.list_nodes_select&quot;](
        list_nodes_full(&quot;function&quot;),
        __opts__[&quot;query.selection&quot;],
        call,
    )


def list_security_groups(call=None):
    &quot;&quot;&quot;
    Lists all security groups available to the user and the user's groups.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f list_security_groups opennebula
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The list_security_groups function must be called with -f or --function.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    secgroup_pool = server.one.secgrouppool.info(auth, -2, -1, -1)[1]

    groups = {}
    for group in _get_xml(secgroup_pool):
        groups[group.find(&quot;NAME&quot;).text] = _xml_to_dict(group)

    return groups


def list_templates(call=None):
    &quot;&quot;&quot;
    Lists all templates available to the user and the user's groups.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f list_templates opennebula
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The list_templates function must be called with -f or --function.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    template_pool = server.one.templatepool.info(auth, -2, -1, -1)[1]

    templates = {}
    for template in _get_xml(template_pool):
        templates[template.find(&quot;NAME&quot;).text] = _xml_to_dict(template)

    return templates


def list_vns(call=None):
    &quot;&quot;&quot;
    Lists all virtual networks available to the user and the user's groups.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f list_vns opennebula
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The list_vns function must be called with -f or --function.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vn_pool = server.one.vnpool.info(auth, -2, -1, -1)[1]

    vns = {}
    for v_network in _get_xml(vn_pool):
        vns[v_network.find(&quot;NAME&quot;).text] = _xml_to_dict(v_network)

    return vns


def reboot(name, call=None):
    &quot;&quot;&quot;
    Reboot a VM.

    .. versionadded:: 2016.3.0

    name
        The name of the VM to reboot.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a reboot my-vm
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The start action must be called with -a or --action.&quot;
        )

    log.info(&quot;Rebooting node %s&quot;, name)

    return vm_action(name, kwargs={&quot;action&quot;: &quot;reboot&quot;}, call=call)


def start(name, call=None):
    &quot;&quot;&quot;
    Start a VM.

    .. versionadded:: 2016.3.0

    name
        The name of the VM to start.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a start my-vm
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The start action must be called with -a or --action.&quot;
        )

    log.info(&quot;Starting node %s&quot;, name)

    return vm_action(name, kwargs={&quot;action&quot;: &quot;resume&quot;}, call=call)


def stop(name, call=None):
    &quot;&quot;&quot;
    Stop a VM.

    .. versionadded:: 2016.3.0

    name
        The name of the VM to stop.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a stop my-vm
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The start action must be called with -a or --action.&quot;
        )

    log.info(&quot;Stopping node %s&quot;, name)

    return vm_action(name, kwargs={&quot;action&quot;: &quot;stop&quot;}, call=call)


def get_one_version(kwargs=None, call=None):
    &quot;&quot;&quot;
    Returns the OpenNebula version.

    .. versionadded:: 2016.3.5

    CLI Example:

    .. code-block:: bash

        salt-cloud -f get_one_version one_provider_name
    &quot;&quot;&quot;

    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The get_cluster_id function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])

    return server.one.system.version(auth)[1]


def get_cluster_id(kwargs=None, call=None):
    &quot;&quot;&quot;
    Returns a cluster's ID from the given cluster name.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f get_cluster_id opennebula name=my-cluster-name
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The get_cluster_id function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    if name is None:
        raise SaltCloudSystemExit(&quot;The get_cluster_id function requires a name.&quot;)

    try:
        ret = list_clusters()[name][&quot;id&quot;]
    except KeyError:
        raise SaltCloudSystemExit(&quot;The cluster '{}' could not be found&quot;.format(name))

    return ret


def get_datastore_id(kwargs=None, call=None):
    &quot;&quot;&quot;
    Returns a data store's ID from the given data store name.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f get_datastore_id opennebula name=my-datastore-name
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The get_datastore_id function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    if name is None:
        raise SaltCloudSystemExit(&quot;The get_datastore_id function requires a name.&quot;)

    try:
        ret = list_datastores()[name][&quot;id&quot;]
    except KeyError:
        raise SaltCloudSystemExit(&quot;The datastore '{}' could not be found.&quot;.format(name))

    return ret


def get_host_id(kwargs=None, call=None):
    &quot;&quot;&quot;
    Returns a host's ID from the given host name.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f get_host_id opennebula name=my-host-name
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The get_host_id function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    if name is None:
        raise SaltCloudSystemExit(&quot;The get_host_id function requires a name.&quot;)

    try:
        ret = avail_locations()[name][&quot;id&quot;]
    except KeyError:
        raise SaltCloudSystemExit(&quot;The host '{}' could not be found&quot;.format(name))

    return ret


def get_image(vm_):
    r&quot;&quot;&quot;
    Return the image object to use.

    vm\_
        The VM dictionary for which to obtain an image.
    &quot;&quot;&quot;
    images = avail_images()
    vm_image = str(
        config.get_cloud_config_value(&quot;image&quot;, vm_, __opts__, search_global=False)
    )
    for image in images:
        if vm_image in (images[image][&quot;name&quot;], images[image][&quot;id&quot;]):
            return images[image][&quot;id&quot;]
    raise SaltCloudNotFound(
        &quot;The specified image, '{}', could not be found.&quot;.format(vm_image)
    )


def get_image_id(kwargs=None, call=None):
    &quot;&quot;&quot;
    Returns an image's ID from the given image name.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f get_image_id opennebula name=my-image-name
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The get_image_id function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    if name is None:
        raise SaltCloudSystemExit(&quot;The get_image_id function requires a name.&quot;)

    try:
        ret = avail_images()[name][&quot;id&quot;]
    except KeyError:
        raise SaltCloudSystemExit(&quot;The image '{}' could not be found&quot;.format(name))

    return ret


def get_location(vm_):
    r&quot;&quot;&quot;
    Return the VM's location.

    vm\_
        The VM dictionary for which to obtain a location.
    &quot;&quot;&quot;
    locations = avail_locations()
    vm_location = str(
        config.get_cloud_config_value(&quot;location&quot;, vm_, __opts__, search_global=False)
    )

    if vm_location == &quot;None&quot;:
        return None

    for location in locations:
        if vm_location in (locations[location][&quot;name&quot;], locations[location][&quot;id&quot;]):
            return locations[location][&quot;id&quot;]
    raise SaltCloudNotFound(
        &quot;The specified location, '{}', could not be found.&quot;.format(vm_location)
    )


def get_secgroup_id(kwargs=None, call=None):
    &quot;&quot;&quot;
    Returns a security group's ID from the given security group name.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f get_secgroup_id opennebula name=my-secgroup-name
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The get_secgroup_id function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    if name is None:
        raise SaltCloudSystemExit(&quot;The get_secgroup_id function requires a 'name'.&quot;)

    try:
        ret = list_security_groups()[name][&quot;id&quot;]
    except KeyError:
        raise SaltCloudSystemExit(
            &quot;The security group '{}' could not be found.&quot;.format(name)
        )

    return ret


def get_template_image(kwargs=None, call=None):
    &quot;&quot;&quot;
    Returns a template's image from the given template name.

    .. versionadded:: 2018.3.0

    .. code-block:: bash

        salt-cloud -f get_template_image opennebula name=my-template-name
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The get_template_image function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    if name is None:
        raise SaltCloudSystemExit(&quot;The get_template_image function requires a 'name'.&quot;)

    try:
        ret = list_templates()[name][&quot;template&quot;][&quot;disk&quot;][&quot;image&quot;]
    except KeyError:
        raise SaltCloudSystemExit(
            &quot;The image for template '{}' could not be found.&quot;.format(name)
        )

    return ret


def get_template_id(kwargs=None, call=None):
    &quot;&quot;&quot;
    Returns a template's ID from the given template name.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f get_template_id opennebula name=my-template-name
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The get_template_id function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    if name is None:
        raise SaltCloudSystemExit(&quot;The get_template_id function requires a 'name'.&quot;)

    try:
        ret = list_templates()[name][&quot;id&quot;]
    except KeyError:
        raise SaltCloudSystemExit(&quot;The template '{}' could not be found.&quot;.format(name))

    return ret


def get_template(vm_):
    r&quot;&quot;&quot;
    Return the template id for a VM.

    .. versionadded:: 2016.11.0

    vm\_
        The VM dictionary for which to obtain a template.
    &quot;&quot;&quot;

    vm_template = str(
        config.get_cloud_config_value(&quot;template&quot;, vm_, __opts__, search_global=False)
    )
    try:
        return list_templates()[vm_template][&quot;id&quot;]
    except KeyError:
        raise SaltCloudNotFound(
            &quot;The specified template, '{}', could not be found.&quot;.format(vm_template)
        )


def get_vm_id(kwargs=None, call=None):
    &quot;&quot;&quot;
    Returns a virtual machine's ID from the given virtual machine's name.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f get_vm_id opennebula name=my-vm
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The get_vm_id function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    if name is None:
        raise SaltCloudSystemExit(&quot;The get_vm_id function requires a name.&quot;)

    try:
        ret = list_nodes()[name][&quot;id&quot;]
    except KeyError:
        raise SaltCloudSystemExit(&quot;The VM '{}' could not be found.&quot;.format(name))

    return ret


def get_vn_id(kwargs=None, call=None):
    &quot;&quot;&quot;
    Returns a virtual network's ID from the given virtual network's name.

    .. versionadded:: 2016.3.0

    CLI Example:

    .. code-block:: bash

        salt-cloud -f get_vn_id opennebula name=my-vn-name
    &quot;&quot;&quot;
    if call == &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The get_vn_id function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    if name is None:
        raise SaltCloudSystemExit(&quot;The get_vn_id function requires a name.&quot;)

    try:
        ret = list_vns()[name][&quot;id&quot;]
    except KeyError:
        raise SaltCloudSystemExit(&quot;The VN '{}' could not be found.&quot;.format(name))

    return ret


def _get_device_template(disk, disk_info, template=None):
    &quot;&quot;&quot;
    Returns the template format to create a disk in open nebula

    .. versionadded:: 2018.3.0

    &quot;&quot;&quot;

    def _require_disk_opts(*args):
        for arg in args:
            if arg not in disk_info:
                raise SaltCloudSystemExit(
                    &quot;The disk {} requires a {} argument&quot;.format(disk, arg)
                )

    _require_disk_opts(&quot;disk_type&quot;, &quot;size&quot;)

    size = disk_info[&quot;size&quot;]
    disk_type = disk_info[&quot;disk_type&quot;]

    if disk_type == &quot;clone&quot;:
        if &quot;image&quot; in disk_info:
            clone_image = disk_info[&quot;image&quot;]
        else:
            clone_image = get_template_image(kwargs={&quot;name&quot;: template})

        clone_image_id = get_image_id(kwargs={&quot;name&quot;: clone_image})
        temp = &quot;DISK=[IMAGE={}, IMAGE_ID={}, CLONE=YES, SIZE={}]&quot;.format(
            clone_image, clone_image_id, size
        )
        return temp

    if disk_type == &quot;volatile&quot;:
        _require_disk_opts(&quot;type&quot;)
        v_type = disk_info[&quot;type&quot;]
        temp = &quot;DISK=[TYPE={}, SIZE={}]&quot;.format(v_type, size)

        if v_type == &quot;fs&quot;:
            _require_disk_opts(&quot;format&quot;)
            format = disk_info[&quot;format&quot;]
            temp = &quot;DISK=[TYPE={}, SIZE={}, FORMAT={}]&quot;.format(v_type, size, format)
        return temp
    # TODO add persistant disk_type


def create(vm_):
    r&quot;&quot;&quot;
    Create a single VM from a data dict.

    vm\_
        The dictionary use to create a VM.

    Optional vm\_ dict options for overwriting template:

    region_id
        Optional - OpenNebula Zone ID

    memory
        Optional - In MB

    cpu
        Optional - Percent of host CPU to allocate

    vcpu
        Optional - Amount of vCPUs to allocate

     CLI Example:

     .. code-block:: bash

         salt-cloud -p my-opennebula-profile vm_name

        salt-cloud -p my-opennebula-profile vm_name memory=16384 cpu=2.5 vcpu=16

    &quot;&quot;&quot;
    try:
        # Check for required profile parameters before sending any API calls.
        if (
            vm_[&quot;profile&quot;]
            and config.is_profile_configured(
                __opts__, _get_active_provider_name() or &quot;opennebula&quot;, vm_[&quot;profile&quot;]
            )
            is False
        ):
            return False
    except AttributeError:
        pass

    __utils__[&quot;cloud.fire_event&quot;](
        &quot;event&quot;,
        &quot;starting create&quot;,
        &quot;salt/cloud/{}/creating&quot;.format(vm_[&quot;name&quot;]),
        args=__utils__[&quot;cloud.filter_event&quot;](
            &quot;creating&quot;, vm_, [&quot;name&quot;, &quot;profile&quot;, &quot;provider&quot;, &quot;driver&quot;]
        ),
        sock_dir=__opts__[&quot;sock_dir&quot;],
        transport=__opts__[&quot;transport&quot;],
    )

    log.info(&quot;Creating Cloud VM %s&quot;, vm_[&quot;name&quot;])
    kwargs = {
        &quot;name&quot;: vm_[&quot;name&quot;],
        &quot;template_id&quot;: get_template(vm_),
        &quot;region_id&quot;: get_location(vm_),
    }
    if &quot;template&quot; in vm_:
        kwargs[&quot;image_id&quot;] = get_template_id({&quot;name&quot;: vm_[&quot;template&quot;]})

    private_networking = config.get_cloud_config_value(
        &quot;private_networking&quot;, vm_, __opts__, search_global=False, default=None
    )
    kwargs[&quot;private_networking&quot;] = &quot;true&quot; if private_networking else &quot;false&quot;

    __utils__[&quot;cloud.fire_event&quot;](
        &quot;event&quot;,
        &quot;requesting instance&quot;,
        &quot;salt/cloud/{}/requesting&quot;.format(vm_[&quot;name&quot;]),
        args={
            &quot;kwargs&quot;: __utils__[&quot;cloud.filter_event&quot;](
                &quot;requesting&quot;, kwargs, list(kwargs)
            ),
        },
        sock_dir=__opts__[&quot;sock_dir&quot;],
    )

    template = []
    if kwargs.get(&quot;region_id&quot;):
        template.append('SCHED_REQUIREMENTS=&quot;ID={}&quot;'.format(kwargs.get(&quot;region_id&quot;)))
    if vm_.get(&quot;memory&quot;):
        template.append(&quot;MEMORY={}&quot;.format(vm_.get(&quot;memory&quot;)))
    if vm_.get(&quot;cpu&quot;):
        template.append(&quot;CPU={}&quot;.format(vm_.get(&quot;cpu&quot;)))
    if vm_.get(&quot;vcpu&quot;):
        template.append(&quot;VCPU={}&quot;.format(vm_.get(&quot;vcpu&quot;)))
    if vm_.get(&quot;disk&quot;):
        get_disks = vm_.get(&quot;disk&quot;)
        template_name = vm_[&quot;image&quot;]
        for disk in get_disks:
            template.append(
                _get_device_template(disk, get_disks[disk], template=template_name)
            )
        if &quot;CLONE&quot; not in str(template):
            raise SaltCloudSystemExit(
                &quot;Missing an image disk to clone. Must define a clone disk alongside all&quot;
                &quot; other disk definitions.&quot;
            )

    template_args = &quot;\n&quot;.join(template)

    try:
        server, user, password = _get_xml_rpc()
        auth = &quot;:&quot;.join([user, password])
        cret = server.one.template.instantiate(
            auth, int(kwargs[&quot;template_id&quot;]), kwargs[&quot;name&quot;], False, template_args
        )
        if not cret[0]:
            log.error(
                &quot;Error creating %s on OpenNebula\n\n&quot;
                &quot;The following error was returned when trying to &quot;
                &quot;instantiate the template: %s&quot;,
                vm_[&quot;name&quot;],
                cret[1],
                # Show the traceback if the debug logging level is enabled
                exc_info_on_loglevel=logging.DEBUG,
            )
            return False
    except Exception as exc:  # pylint: disable=broad-except
        log.error(
            &quot;Error creating %s on OpenNebula\n\n&quot;
            &quot;The following exception was thrown when trying to &quot;
            &quot;run the initial deployment: %s&quot;,
            vm_[&quot;name&quot;],
            exc,
            # Show the traceback if the debug logging level is enabled
            exc_info_on_loglevel=logging.DEBUG,
        )
        return False

    fqdn = vm_.get(&quot;fqdn_base&quot;)
    if fqdn is not None:
        fqdn = &quot;{}.{}&quot;.format(vm_[&quot;name&quot;], fqdn)

    def __query_node_data(vm_name):
        node_data = show_instance(vm_name, call=&quot;action&quot;)
        if not node_data:
            # Trigger an error in the wait_for_ip function
            return False
        if node_data[&quot;state&quot;] == &quot;7&quot;:
            return False
        if node_data[&quot;lcm_state&quot;] == &quot;3&quot;:
            return node_data

    try:
        data = __utils__[&quot;cloud.wait_for_ip&quot;](
            __query_node_data,
            update_args=(vm_[&quot;name&quot;],),
            timeout=config.get_cloud_config_value(
                &quot;wait_for_ip_timeout&quot;, vm_, __opts__, default=10 * 60
            ),
            interval=config.get_cloud_config_value(
                &quot;wait_for_ip_interval&quot;, vm_, __opts__, default=2
            ),
        )
    except (SaltCloudExecutionTimeout, SaltCloudExecutionFailure) as exc:
        try:
            # It might be already up, let's destroy it!
            destroy(vm_[&quot;name&quot;])
        except SaltCloudSystemExit:
            pass
        finally:
            raise SaltCloudSystemExit(str(exc))

    key_filename = config.get_cloud_config_value(
        &quot;private_key&quot;, vm_, __opts__, search_global=False, default=None
    )
    if key_filename is not None and not os.path.isfile(key_filename):
        raise SaltCloudConfigError(
            &quot;The defined key_filename '{}' does not exist&quot;.format(key_filename)
        )

    if fqdn:
        vm_[&quot;ssh_host&quot;] = fqdn
        private_ip = &quot;0.0.0.0&quot;
    else:
        try:
            private_ip = data[&quot;private_ips&quot;][0]
        except KeyError:
            try:
                private_ip = data[&quot;template&quot;][&quot;nic&quot;][&quot;ip&quot;]
            except KeyError:
                # if IPv6 is used try this as last resort
                # OpenNebula does not yet show ULA address here so take global
                private_ip = data[&quot;template&quot;][&quot;nic&quot;][&quot;ip6_global&quot;]

            vm_[&quot;ssh_host&quot;] = private_ip

    ssh_username = config.get_cloud_config_value(
        &quot;ssh_username&quot;, vm_, __opts__, default=&quot;root&quot;
    )

    vm_[&quot;username&quot;] = ssh_username
    vm_[&quot;key_filename&quot;] = key_filename

    ret = __utils__[&quot;cloud.bootstrap&quot;](vm_, __opts__)

    ret[&quot;id&quot;] = data[&quot;id&quot;]
    ret[&quot;image&quot;] = vm_[&quot;image&quot;]
    ret[&quot;name&quot;] = vm_[&quot;name&quot;]
    ret[&quot;size&quot;] = data[&quot;template&quot;][&quot;memory&quot;]
    ret[&quot;state&quot;] = data[&quot;state&quot;]
    ret[&quot;private_ips&quot;] = private_ip
    ret[&quot;public_ips&quot;] = []

    log.info(&quot;Created Cloud VM '%s'&quot;, vm_[&quot;name&quot;])
    log.debug(&quot;'%s' VM creation details:\n%s&quot;, vm_[&quot;name&quot;], pprint.pformat(data))

    __utils__[&quot;cloud.fire_event&quot;](
        &quot;event&quot;,
        &quot;created instance&quot;,
        &quot;salt/cloud/{}/created&quot;.format(vm_[&quot;name&quot;]),
        args=__utils__[&quot;cloud.filter_event&quot;](
            &quot;created&quot;, vm_, [&quot;name&quot;, &quot;profile&quot;, &quot;provider&quot;, &quot;driver&quot;]
        ),
        sock_dir=__opts__[&quot;sock_dir&quot;],
    )

    return ret


def destroy(name, call=None):
    &quot;&quot;&quot;
    Destroy a node. Will check termination protection and warn if enabled.

    name
        The name of the vm to be destroyed.

    CLI Example:

    .. code-block:: bash

        salt-cloud --destroy vm_name
        salt-cloud -d vm_name
        salt-cloud --action destroy vm_name
        salt-cloud -a destroy vm_name

    &quot;&quot;&quot;
    if call == &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The destroy action must be called with -d, --destroy, -a or --action.&quot;
        )

    __utils__[&quot;cloud.fire_event&quot;](
        &quot;event&quot;,
        &quot;destroying instance&quot;,
        &quot;salt/cloud/{}/destroying&quot;.format(name),
        args={&quot;name&quot;: name},
        sock_dir=__opts__[&quot;sock_dir&quot;],
    )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])

    data = show_instance(name, call=&quot;action&quot;)
    node = server.one.vm.action(auth, &quot;delete&quot;, int(data[&quot;id&quot;]))

    __utils__[&quot;cloud.fire_event&quot;](
        &quot;event&quot;,
        &quot;destroyed instance&quot;,
        &quot;salt/cloud/{}/destroyed&quot;.format(name),
        args={&quot;name&quot;: name},
        sock_dir=__opts__[&quot;sock_dir&quot;],
    )

    if __opts__.get(&quot;update_cachedir&quot;, False) is True:
        __utils__[&quot;cloud.delete_minion_cachedir&quot;](
            name, _get_active_provider_name().split(&quot;:&quot;)[0], __opts__
        )

    data = {
        &quot;action&quot;: &quot;vm.delete&quot;,
        &quot;deleted&quot;: node[0],
        &quot;node_id&quot;: node[1],
        &quot;error_code&quot;: node[2],
    }

    return data


def image_allocate(call=None, kwargs=None):
    &quot;&quot;&quot;
    Allocates a new image in OpenNebula.

    .. versionadded:: 2016.3.0

    path
        The path to a file containing the template of the image to allocate.
        Syntax within the file can be the usual attribute=value or XML. Can be
        used instead of ``data``.

    data
        The data containing the template of the image to allocate. Syntax can be the
        usual attribute=value or XML. Can be used instead of ``path``.

    datastore_id
        The ID of the data-store to be used for the new image. Can be used instead
        of ``datastore_name``.

    datastore_name
        The name of the data-store to be used for the new image. Can be used instead of
        ``datastore_id``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f image_allocate opennebula path=/path/to/image_file.txt datastore_id=1
        salt-cloud -f image_allocate opennebula datastore_name=default \\
            data='NAME=&quot;Ubuntu 14.04&quot; PATH=&quot;/home/one_user/images/ubuntu_desktop.img&quot; \\
            DESCRIPTION=&quot;Ubuntu 14.04 for development.&quot;'
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The image_allocate function must be called with -f or --function.&quot;
        )

<A NAME="5"></A>    if kwargs is None:
        kwargs = {}

    path <FONT color="#151b8d"><A HREF="javascript:ZweiFrames('match94691-1.html#5',3,'match94691-top.html#5',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)
    datastore_id = kwargs.get(&quot;datastore_id&quot;, None)
    datastore_name = kwargs.get(</B></FONT>&quot;datastore_name&quot;, None)

    if datastore_id:
        if datastore_name:
            log.warning(
                &quot;Both a 'datastore_id' and a 'datastore_name' were provided. &quot;
                &quot;'datastore_id' will take precedence.&quot;
            )
    elif datastore_name:
        datastore_id = get_datastore_id(kwargs={&quot;name&quot;: datastore_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The image_allocate function requires either a 'datastore_id' or a &quot;
            &quot;'datastore_name' to be provided.&quot;
        )

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The image_allocate function requires either a file 'path' or 'data' &quot;
            &quot;to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.image.allocate(auth, data, int(datastore_id))

    ret = {
        &quot;action&quot;: &quot;image.allocate&quot;,
        &quot;allocated&quot;: response[0],
        &quot;image_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def image_clone(call=None, kwargs=None):
    &quot;&quot;&quot;
    Clones an existing image.

    .. versionadded:: 2016.3.0

    name
        The name of the new image.

    image_id
        The ID of the image to be cloned. Can be used instead of ``image_name``.

    image_name
        The name of the image to be cloned. Can be used instead of ``image_id``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f image_clone opennebula name=my-new-image image_id=10
        salt-cloud -f image_clone opennebula name=my-new-image image_name=my-image-to-clone
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The image_clone function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    image_id = kwargs.get(&quot;image_id&quot;, None)
    image_name = kwargs.get(&quot;image_name&quot;, None)

    if name is None:
        raise SaltCloudSystemExit(
            &quot;The image_clone function requires a 'name' to be provided.&quot;
        )

    if image_id:
        if image_name:
            log.warning(
                &quot;Both the 'image_id' and 'image_name' arguments were provided. &quot;
                &quot;'image_id' will take precedence.&quot;
            )
    elif image_name:
        image_id = get_image_id(kwargs={&quot;name&quot;: image_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The image_clone function requires either an 'image_id' or an &quot;
            &quot;'image_name' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.image.clone(auth, int(image_id), name)

    data = {
        &quot;action&quot;: &quot;image.clone&quot;,
        &quot;cloned&quot;: response[0],
        &quot;cloned_image_id&quot;: response[1],
        &quot;cloned_image_name&quot;: name,
        &quot;error_code&quot;: response[2],
    }

    return data


def image_delete(call=None, kwargs=None):
    &quot;&quot;&quot;
    Deletes the given image from OpenNebula. Either a name or an image_id must
    be supplied.

    .. versionadded:: 2016.3.0

    name
        The name of the image to delete. Can be used instead of ``image_id``.

    image_id
        The ID of the image to delete. Can be used instead of ``name``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f image_delete opennebula name=my-image
        salt-cloud --function image_delete opennebula image_id=100
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The image_delete function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    image_id = kwargs.get(&quot;image_id&quot;, None)

    if image_id:
        if name:
            log.warning(
                &quot;Both the 'image_id' and 'name' arguments were provided. &quot;
                &quot;'image_id' will take precedence.&quot;
            )
    elif name:
        image_id = get_image_id(kwargs={&quot;name&quot;: name})
    else:
        raise SaltCloudSystemExit(
            &quot;The image_delete function requires either an 'image_id' or a &quot;
            &quot;'name' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.image.delete(auth, int(image_id))

    data = {
        &quot;action&quot;: &quot;image.delete&quot;,
        &quot;deleted&quot;: response[0],
        &quot;image_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def image_info(call=None, kwargs=None):
    &quot;&quot;&quot;
    Retrieves information for a given image. Either a name or an image_id must be
    supplied.

    .. versionadded:: 2016.3.0

    name
        The name of the image for which to gather information. Can be used instead
        of ``image_id``.

    image_id
        The ID of the image for which to gather information. Can be used instead of
        ``name``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f image_info opennebula name=my-image
        salt-cloud --function image_info opennebula image_id=5
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The image_info function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    image_id = kwargs.get(&quot;image_id&quot;, None)

    if image_id:
        if name:
            log.warning(
                &quot;Both the 'image_id' and 'name' arguments were provided. &quot;
                &quot;'image_id' will take precedence.&quot;
            )
    elif name:
        image_id = get_image_id(kwargs={&quot;name&quot;: name})
    else:
        raise SaltCloudSystemExit(
            &quot;The image_info function requires either a 'name or an 'image_id' &quot;
            &quot;to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])

    info = {}
    response = server.one.image.info(auth, int(image_id))[1]
    tree = _get_xml(response)
    info[tree.find(&quot;NAME&quot;).text] = _xml_to_dict(tree)

    return info


def image_persistent(call=None, kwargs=None):
    &quot;&quot;&quot;
    Sets the Image as persistent or not persistent.

    .. versionadded:: 2016.3.0

    name
        The name of the image to set. Can be used instead of ``image_id``.

    image_id
        The ID of the image to set. Can be used instead of ``name``.

    persist
        A boolean value to set the image as persistent or not. Set to true
        for persistent, false for non-persistent.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f image_persistent opennebula name=my-image persist=True
        salt-cloud --function image_persistent opennebula image_id=5 persist=False
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The image_persistent function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    persist = kwargs.get(&quot;persist&quot;, None)
    image_id = kwargs.get(&quot;image_id&quot;, None)

    if persist is None:
        raise SaltCloudSystemExit(
            &quot;The image_persistent function requires 'persist' to be set to 'True' &quot;
            &quot;or 'False'.&quot;
        )

    if image_id:
        if name:
            log.warning(
                &quot;Both the 'image_id' and 'name' arguments were provided. &quot;
                &quot;'image_id' will take precedence.&quot;
            )
    elif name:
        image_id = get_image_id(kwargs={&quot;name&quot;: name})
    else:
        raise SaltCloudSystemExit(
            &quot;The image_persistent function requires either a 'name' or an &quot;
            &quot;'image_id' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.image.persistent(
        auth, int(image_id), salt.utils.data.is_true(persist)
    )

    data = {
        &quot;action&quot;: &quot;image.persistent&quot;,
        &quot;response&quot;: response[0],
        &quot;image_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def image_snapshot_delete(call=None, kwargs=None):
    &quot;&quot;&quot;
    Deletes a snapshot from the image.

    .. versionadded:: 2016.3.0

    image_id
        The ID of the image from which to delete the snapshot. Can be used instead of
        ``image_name``.

    image_name
        The name of the image from which to delete the snapshot. Can be used instead
        of ``image_id``.

    snapshot_id
        The ID of the snapshot to delete.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f image_snapshot_delete vm_id=106 snapshot_id=45
        salt-cloud -f image_snapshot_delete vm_name=my-vm snapshot_id=111
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The image_snapshot_delete function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    image_id = kwargs.get(&quot;image_id&quot;, None)
    image_name = kwargs.get(&quot;image_name&quot;, None)
    snapshot_id = kwargs.get(&quot;snapshot_id&quot;, None)

    if snapshot_id is None:
        raise SaltCloudSystemExit(
            &quot;The image_snapshot_delete function requires a 'snapshot_id' to be&quot;
            &quot; provided.&quot;
        )

    if image_id:
        if image_name:
            log.warning(
                &quot;Both the 'image_id' and 'image_name' arguments were provided. &quot;
                &quot;'image_id' will take precedence.&quot;
            )
    elif image_name:
        image_id = get_image_id(kwargs={&quot;name&quot;: image_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The image_snapshot_delete function requires either an 'image_id' &quot;
            &quot;or a 'image_name' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.image.snapshotdelete(auth, int(image_id), int(snapshot_id))

    data = {
        &quot;action&quot;: &quot;image.snapshotdelete&quot;,
        &quot;deleted&quot;: response[0],
        &quot;snapshot_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def image_snapshot_revert(call=None, kwargs=None):
    &quot;&quot;&quot;
    Reverts an image state to a previous snapshot.

    .. versionadded:: 2016.3.0

    image_id
        The ID of the image to revert. Can be used instead of ``image_name``.

    image_name
        The name of the image to revert. Can be used instead of ``image_id``.

    snapshot_id
        The ID of the snapshot to which the image will be reverted.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f image_snapshot_revert vm_id=106 snapshot_id=45
        salt-cloud -f image_snapshot_revert vm_name=my-vm snapshot_id=120
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The image_snapshot_revert function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    image_id = kwargs.get(&quot;image_id&quot;, None)
    image_name = kwargs.get(&quot;image_name&quot;, None)
    snapshot_id = kwargs.get(&quot;snapshot_id&quot;, None)

    if snapshot_id is None:
        raise SaltCloudSystemExit(
            &quot;The image_snapshot_revert function requires a 'snapshot_id' to be&quot;
            &quot; provided.&quot;
        )

    if image_id:
        if image_name:
            log.warning(
                &quot;Both the 'image_id' and 'image_name' arguments were provided. &quot;
                &quot;'image_id' will take precedence.&quot;
            )
    elif image_name:
        image_id = get_image_id(kwargs={&quot;name&quot;: image_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The image_snapshot_revert function requires either an 'image_id' or &quot;
            &quot;an 'image_name' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.image.snapshotrevert(auth, int(image_id), int(snapshot_id))

    data = {
        &quot;action&quot;: &quot;image.snapshotrevert&quot;,
        &quot;reverted&quot;: response[0],
        &quot;snapshot_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def image_snapshot_flatten(call=None, kwargs=None):
    &quot;&quot;&quot;
    Flattens the snapshot of an image and discards others.

    .. versionadded:: 2016.3.0

    image_id
        The ID of the image. Can be used instead of ``image_name``.

    image_name
        The name of the image. Can be used instead of ``image_id``.

    snapshot_id
        The ID of the snapshot to flatten.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f image_snapshot_flatten vm_id=106 snapshot_id=45
        salt-cloud -f image_snapshot_flatten vm_name=my-vm snapshot_id=45
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The image_snapshot_flatten function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    image_id = kwargs.get(&quot;image_id&quot;, None)
    image_name = kwargs.get(&quot;image_name&quot;, None)
    snapshot_id = kwargs.get(&quot;snapshot_id&quot;, None)

    if snapshot_id is None:
        raise SaltCloudSystemExit(
            &quot;The image_stanpshot_flatten function requires a 'snapshot_id' &quot;
            &quot;to be provided.&quot;
        )

    if image_id:
        if image_name:
            log.warning(
                &quot;Both the 'image_id' and 'image_name' arguments were provided. &quot;
                &quot;'image_id' will take precedence.&quot;
            )
    elif image_name:
        image_id = get_image_id(kwargs={&quot;name&quot;: image_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The image_snapshot_flatten function requires either an &quot;
            &quot;'image_id' or an 'image_name' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.image.snapshotflatten(auth, int(image_id), int(snapshot_id))

    data = {
        &quot;action&quot;: &quot;image.snapshotflatten&quot;,
        &quot;flattened&quot;: response[0],
        &quot;snapshot_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def image_update(call=None, kwargs=None):
    &quot;&quot;&quot;
    Replaces the image template contents.

    .. versionadded:: 2016.3.0

    image_id
        The ID of the image to update. Can be used instead of ``image_name``.

    image_name
        The name of the image to update. Can be used instead of ``image_id``.

    path
        The path to a file containing the template of the image. Syntax within the
        file can be the usual attribute=value or XML. Can be used instead of ``data``.

    data
        Contains the template of the image. Syntax can be the usual attribute=value
        or XML. Can be used instead of ``path``.

    update_type
        There are two ways to update an image: ``replace`` the whole template
        or ``merge`` the new template with the existing one.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f image_update opennebula image_id=0 file=/path/to/image_update_file.txt update_type=replace
        salt-cloud -f image_update opennebula image_name=&quot;Ubuntu 14.04&quot; update_type=merge \\
            data='NAME=&quot;Ubuntu Dev&quot; PATH=&quot;/home/one_user/images/ubuntu_desktop.img&quot; \\
            DESCRIPTION = &quot;Ubuntu 14.04 for development.&quot;'
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The image_allocate function must be called with -f or --function.&quot;
        )

<A NAME="1"></A>    if kwargs is None:
        kwargs = {}

    image_id = kwargs<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match94691-1.html#1',3,'match94691-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>.get(&quot;image_id&quot;, None)
    image_name = kwargs.get(&quot;image_name&quot;, None)
    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)
    update_type = kwargs.get(&quot;update_type&quot;, None)
    update_args =</B></FONT> [&quot;replace&quot;, &quot;merge&quot;]

    if update_type is None:
        raise SaltCloudSystemExit(
            &quot;The image_update function requires an 'update_type' to be provided.&quot;
        )

    if update_type == update_args[0]:
        update_number = 0
    elif update_type == update_args[1]:
        update_number = 1
    else:
        raise SaltCloudSystemExit(
            &quot;The update_type argument must be either {} or {}.&quot;.format(
                update_args[0], update_args[1]
            )
        )

    if image_id:
        if image_name:
            log.warning(
                &quot;Both the 'image_id' and 'image_name' arguments were provided. &quot;
                &quot;'image_id' will take precedence.&quot;
            )
    elif image_name:
        image_id = get_image_id(kwargs={&quot;name&quot;: image_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The image_update function requires either an 'image_id' or an &quot;
            &quot;'image_name' to be provided.&quot;
        )

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The image_update function requires either 'data' or a file 'path' &quot;
            &quot;to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.image.update(auth, int(image_id), data, int(update_number))

    ret = {
        &quot;action&quot;: &quot;image.update&quot;,
        &quot;updated&quot;: response[0],
        &quot;image_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def show_instance(name, call=None):
    &quot;&quot;&quot;
    Show the details from OpenNebula concerning a named VM.

    name
        The name of the VM for which to display details.

    call
        Type of call to use with this function such as ``function``.

    CLI Example:

    .. code-block:: bash

        salt-cloud --action show_instance vm_name
        salt-cloud -a show_instance vm_name

    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The show_instance action must be called with -a or --action.&quot;
        )

    node = _get_node(name)
    __utils__[&quot;cloud.cache_node&quot;](node, _get_active_provider_name(), __opts__)

    return node


def secgroup_allocate(call=None, kwargs=None):
    &quot;&quot;&quot;
    Allocates a new security group in OpenNebula.

    .. versionadded:: 2016.3.0

    path
        The path to a file containing the template of the security group. Syntax
        within the file can be the usual attribute=value or XML. Can be used
        instead of ``data``.

    data
        The template data of the security group. Syntax can be the usual
        attribute=value or XML. Can be used instead of ``path``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f secgroup_allocate opennebula path=/path/to/secgroup_file.txt
        salt-cloud -f secgroup_allocate opennebula \\
            data=&quot;NAME = test RULE = [PROTOCOL = TCP, RULE_TYPE = inbound, \\
            RANGE = 1000:2000]&quot;
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The secgroup_allocate function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The secgroup_allocate function requires either 'data' or a file &quot;
            &quot;'path' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.secgroup.allocate(auth, data)

    ret = {
        &quot;action&quot;: &quot;secgroup.allocate&quot;,
        &quot;allocated&quot;: response[0],
        &quot;secgroup_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def secgroup_clone(call=None, kwargs=None):
    &quot;&quot;&quot;
    Clones an existing security group.

    .. versionadded:: 2016.3.0

    name
        The name of the new template.

    secgroup_id
        The ID of the security group to be cloned. Can be used instead of
        ``secgroup_name``.

    secgroup_name
        The name of the security group to be cloned. Can be used instead of
        ``secgroup_id``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f secgroup_clone opennebula name=my-cloned-secgroup secgroup_id=0
        salt-cloud -f secgroup_clone opennebula name=my-cloned-secgroup secgroup_name=my-secgroup
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The secgroup_clone function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    secgroup_id = kwargs.get(&quot;secgroup_id&quot;, None)
    secgroup_name = kwargs.get(&quot;secgroup_name&quot;, None)

    if name is None:
        raise SaltCloudSystemExit(
            &quot;The secgroup_clone function requires a 'name' to be provided.&quot;
        )

    if secgroup_id:
        if secgroup_name:
            log.warning(
                &quot;Both the 'secgroup_id' and 'secgroup_name' arguments were provided. &quot;
                &quot;'secgroup_id' will take precedence.&quot;
            )
    elif secgroup_name:
        secgroup_id = get_secgroup_id(kwargs={&quot;name&quot;: secgroup_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The secgroup_clone function requires either a 'secgroup_id' or a &quot;
            &quot;'secgroup_name' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.secgroup.clone(auth, int(secgroup_id), name)

    data = {
        &quot;action&quot;: &quot;secgroup.clone&quot;,
        &quot;cloned&quot;: response[0],
        &quot;cloned_secgroup_id&quot;: response[1],
        &quot;cloned_secgroup_name&quot;: name,
        &quot;error_code&quot;: response[2],
    }

    return data


def secgroup_delete(call=None, kwargs=None):
    &quot;&quot;&quot;
    Deletes the given security group from OpenNebula. Either a name or a secgroup_id
    must be supplied.

    .. versionadded:: 2016.3.0

    name
        The name of the security group to delete. Can be used instead of
        ``secgroup_id``.

    secgroup_id
        The ID of the security group to delete. Can be used instead of ``name``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f secgroup_delete opennebula name=my-secgroup
        salt-cloud --function secgroup_delete opennebula secgroup_id=100
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The secgroup_delete function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    secgroup_id = kwargs.get(&quot;secgroup_id&quot;, None)

    if secgroup_id:
        if name:
            log.warning(
                &quot;Both the 'secgroup_id' and 'name' arguments were provided. &quot;
                &quot;'secgroup_id' will take precedence.&quot;
            )
    elif name:
        secgroup_id = get_secgroup_id(kwargs={&quot;name&quot;: name})
    else:
        raise SaltCloudSystemExit(
            &quot;The secgroup_delete function requires either a 'name' or a &quot;
            &quot;'secgroup_id' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.secgroup.delete(auth, int(secgroup_id))

    data = {
        &quot;action&quot;: &quot;secgroup.delete&quot;,
        &quot;deleted&quot;: response[0],
        &quot;secgroup_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def secgroup_info(call=None, kwargs=None):
    &quot;&quot;&quot;
    Retrieves information for the given security group. Either a name or a
    secgroup_id must be supplied.

    .. versionadded:: 2016.3.0

    name
        The name of the security group for which to gather information. Can be
        used instead of ``secgroup_id``.

    secgroup_id
        The ID of the security group for which to gather information. Can be
        used instead of ``name``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f secgroup_info opennebula name=my-secgroup
        salt-cloud --function secgroup_info opennebula secgroup_id=5
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The secgroup_info function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    secgroup_id = kwargs.get(&quot;secgroup_id&quot;, None)

    if secgroup_id:
        if name:
            log.warning(
                &quot;Both the 'secgroup_id' and 'name' arguments were provided. &quot;
                &quot;'secgroup_id' will take precedence.&quot;
            )
    elif name:
        secgroup_id = get_secgroup_id(kwargs={&quot;name&quot;: name})
    else:
        raise SaltCloudSystemExit(
            &quot;The secgroup_info function requires either a name or a secgroup_id &quot;
            &quot;to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])

    info = {}
    response = server.one.secgroup.info(auth, int(secgroup_id))[1]
    tree = _get_xml(response)
    info[tree.find(&quot;NAME&quot;).text] = _xml_to_dict(tree)

    return info


def secgroup_update(call=None, kwargs=None):
    &quot;&quot;&quot;
    Replaces the security group template contents.

    .. versionadded:: 2016.3.0

    secgroup_id
        The ID of the security group to update. Can be used instead of
        ``secgroup_name``.

    secgroup_name
        The name of the security group to update. Can be used instead of
        ``secgroup_id``.

    path
        The path to a file containing the template of the security group. Syntax
        within the file can be the usual attribute=value or XML. Can be used instead
        of ``data``.

    data
        The template data of the security group. Syntax can be the usual attribute=value
        or XML. Can be used instead of ``path``.

    update_type
        There are two ways to update a security group: ``replace`` the whole template
        or ``merge`` the new template with the existing one.

    CLI Example:

    .. code-block:: bash

        salt-cloud --function secgroup_update opennebula secgroup_id=100 \\
            path=/path/to/secgroup_update_file.txt \\
            update_type=replace
        salt-cloud -f secgroup_update opennebula secgroup_name=my-secgroup update_type=merge \\
            data=&quot;Name = test RULE = [PROTOCOL = TCP, RULE_TYPE = inbound, RANGE = 1000:2000]&quot;
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The secgroup_allocate function must be called with -f or --function.&quot;
        )

<A NAME="2"></A>    if kwargs is None:
        kwargs = {}

    secgroup_id <FONT color="#980517"><A HREF="javascript:ZweiFrames('match94691-1.html#2',3,'match94691-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= kwargs.get(&quot;secgroup_id&quot;, None)
    secgroup_name = kwargs.get(&quot;secgroup_name&quot;, None)
    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)
    update_type =</B></FONT> kwargs.get(&quot;update_type&quot;, None)
    update_args = [&quot;replace&quot;, &quot;merge&quot;]

    if update_type is None:
        raise SaltCloudSystemExit(
            &quot;The secgroup_update function requires an 'update_type' to be provided.&quot;
        )

    if update_type == update_args[0]:
        update_number = 0
    elif update_type == update_args[1]:
        update_number = 1
    else:
        raise SaltCloudSystemExit(
            &quot;The update_type argument must be either {} or {}.&quot;.format(
                update_args[0], update_args[1]
            )
        )

    if secgroup_id:
        if secgroup_name:
            log.warning(
                &quot;Both the 'secgroup_id' and 'secgroup_name' arguments were provided. &quot;
                &quot;'secgroup_id' will take precedence.&quot;
            )
    elif secgroup_name:
        secgroup_id = get_secgroup_id(kwargs={&quot;name&quot;: secgroup_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The secgroup_update function requires either a 'secgroup_id' or a &quot;
            &quot;'secgroup_name' to be provided.&quot;
        )

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The secgroup_update function requires either 'data' or a file 'path' &quot;
            &quot;to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.secgroup.update(
        auth, int(secgroup_id), data, int(update_number)
    )

    ret = {
        &quot;action&quot;: &quot;secgroup.update&quot;,
        &quot;updated&quot;: response[0],
        &quot;secgroup_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def template_allocate(call=None, kwargs=None):
    &quot;&quot;&quot;
    Allocates a new template in OpenNebula.

    .. versionadded:: 2016.3.0

    path
        The path to a file containing the elements of the template to be allocated.
        Syntax within the file can be the usual attribute=value or XML. Can be used
        instead of ``data``.

    data
        Contains the elements of the template to be allocated. Syntax can be the usual
        attribute=value or XML. Can be used instead of ``path``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f template_allocate opennebula path=/path/to/template_file.txt
        salt-cloud -f template_allocate opennebula \\
            data='CPU=&quot;1.0&quot; DISK=[IMAGE=&quot;Ubuntu-14.04&quot;] GRAPHICS=[LISTEN=&quot;0.0.0.0&quot;,TYPE=&quot;vnc&quot;] \\
            MEMORY=&quot;1024&quot; NETWORK=&quot;yes&quot; NIC=[NETWORK=&quot;192net&quot;,NETWORK_UNAME=&quot;oneadmin&quot;] \\
            OS=[ARCH=&quot;x86_64&quot;] SUNSTONE_CAPACITY_SELECT=&quot;YES&quot; SUNSTONE_NETWORK_SELECT=&quot;YES&quot; \\
            VCPU=&quot;1&quot;'
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The template_allocate function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The template_allocate function requires either 'data' or a file &quot;
            &quot;'path' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.template.allocate(auth, data)

    ret = {
        &quot;action&quot;: &quot;template.allocate&quot;,
        &quot;allocated&quot;: response[0],
        &quot;template_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def template_clone(call=None, kwargs=None):
    &quot;&quot;&quot;
    Clones an existing virtual machine template.

    .. versionadded:: 2016.3.0

    name
        The name of the new template.

    template_id
        The ID of the template to be cloned. Can be used instead of ``template_name``.

    template_name
        The name of the template to be cloned. Can be used instead of ``template_id``.

    clone_images
        Optional, defaults to False. Indicates if the images attached to the template should be cloned as well.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f template_clone opennebula name=my-new-template template_id=0
        salt-cloud -f template_clone opennebula name=my-new-template template_name=my-template
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The template_clone function must be called with -f or --function.&quot;
        )

<A NAME="4"></A>    if kwargs is None:
        kwargs = {}

    name <FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match94691-1.html#4',3,'match94691-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= kwargs.get(&quot;name&quot;, None)
    template_id = kwargs.get(&quot;template_id&quot;, None)
    template_name = kwargs.get(&quot;template_name&quot;, None)
    clone_images = kwargs.get(</B></FONT>&quot;clone_images&quot;, False)

    if name is None:
        raise SaltCloudSystemExit(
            &quot;The template_clone function requires a name to be provided.&quot;
        )

    if template_id:
        if template_name:
            log.warning(
                &quot;Both the 'template_id' and 'template_name' arguments were provided. &quot;
                &quot;'template_id' will take precedence.&quot;
            )
    elif template_name:
        template_id = get_template_id(kwargs={&quot;name&quot;: template_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The template_clone function requires either a 'template_id' &quot;
            &quot;or a 'template_name' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])

    response = server.one.template.clone(auth, int(template_id), name, clone_images)

    data = {
        &quot;action&quot;: &quot;template.clone&quot;,
        &quot;cloned&quot;: response[0],
        &quot;cloned_template_id&quot;: response[1],
        &quot;cloned_template_name&quot;: name,
        &quot;error_code&quot;: response[2],
    }

    return data


def template_delete(call=None, kwargs=None):
    &quot;&quot;&quot;
    Deletes the given template from OpenNebula. Either a name or a template_id must
    be supplied.

    .. versionadded:: 2016.3.0

    name
        The name of the template to delete. Can be used instead of ``template_id``.

    template_id
        The ID of the template to delete. Can be used instead of ``name``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f template_delete opennebula name=my-template
        salt-cloud --function template_delete opennebula template_id=5
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The template_delete function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    template_id = kwargs.get(&quot;template_id&quot;, None)

    if template_id:
        if name:
            log.warning(
                &quot;Both the 'template_id' and 'name' arguments were provided. &quot;
                &quot;'template_id' will take precedence.&quot;
            )
    elif name:
        template_id = get_template_id(kwargs={&quot;name&quot;: name})
    else:
        raise SaltCloudSystemExit(
            &quot;The template_delete function requires either a 'name' or a 'template_id' &quot;
            &quot;to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.template.delete(auth, int(template_id))

    data = {
        &quot;action&quot;: &quot;template.delete&quot;,
        &quot;deleted&quot;: response[0],
        &quot;template_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def template_instantiate(call=None, kwargs=None):
    &quot;&quot;&quot;
    Instantiates a new virtual machine from a template.

    .. versionadded:: 2016.3.0

    .. note::
        ``template_instantiate`` creates a VM on OpenNebula from a template, but it
        does not install Salt on the new VM. Use the ``create`` function for that
        functionality: ``salt-cloud -p opennebula-profile vm-name``.

    vm_name
        Name for the new VM instance.

    template_id
        The ID of the template from which the VM will be created. Can be used instead
        of ``template_name``.

    template_name
        The name of the template from which the VM will be created. Can be used instead
        of ``template_id``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f template_instantiate opennebula vm_name=my-new-vm template_id=0

    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The template_instantiate function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    vm_name = kwargs.get(&quot;vm_name&quot;, None)
    template_id = kwargs.get(&quot;template_id&quot;, None)
    template_name = kwargs.get(&quot;template_name&quot;, None)

    if vm_name is None:
        raise SaltCloudSystemExit(
            &quot;The template_instantiate function requires a 'vm_name' to be provided.&quot;
        )

    if template_id:
        if template_name:
            log.warning(
                &quot;Both the 'template_id' and 'template_name' arguments were provided. &quot;
                &quot;'template_id' will take precedence.&quot;
            )
    elif template_name:
        template_id = get_template_id(kwargs={&quot;name&quot;: template_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The template_instantiate function requires either a 'template_id' &quot;
            &quot;or a 'template_name' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.template.instantiate(auth, int(template_id), vm_name)

    data = {
        &quot;action&quot;: &quot;template.instantiate&quot;,
        &quot;instantiated&quot;: response[0],
        &quot;instantiated_vm_id&quot;: response[1],
        &quot;vm_name&quot;: vm_name,
        &quot;error_code&quot;: response[2],
    }

    return data


def template_update(call=None, kwargs=None):
    &quot;&quot;&quot;
    Replaces the template contents.

    .. versionadded:: 2016.3.0

    template_id
        The ID of the template to update. Can be used instead of ``template_name``.

    template_name
        The name of the template to update. Can be used instead of ``template_id``.

    path
        The path to a file containing the elements of the template to be updated.
        Syntax within the file can be the usual attribute=value or XML. Can be
        used instead of ``data``.

    data
        Contains the elements of the template to be updated. Syntax can be the
        usual attribute=value or XML. Can be used instead of ``path``.

    update_type
        There are two ways to update a template: ``replace`` the whole template
        or ``merge`` the new template with the existing one.

    CLI Example:

    .. code-block:: bash

        salt-cloud --function template_update opennebula template_id=1 update_type=replace \\
            path=/path/to/template_update_file.txt
        salt-cloud -f template_update opennebula template_name=my-template update_type=merge \\
            data='CPU=&quot;1.0&quot; DISK=[IMAGE=&quot;Ubuntu-14.04&quot;] GRAPHICS=[LISTEN=&quot;0.0.0.0&quot;,TYPE=&quot;vnc&quot;] \\
            MEMORY=&quot;1024&quot; NETWORK=&quot;yes&quot; NIC=[NETWORK=&quot;192net&quot;,NETWORK_UNAME=&quot;oneadmin&quot;] \\
            OS=[ARCH=&quot;x86_64&quot;] SUNSTONE_CAPACITY_SELECT=&quot;YES&quot; SUNSTONE_NETWORK_SELECT=&quot;YES&quot; \\
            VCPU=&quot;1&quot;'
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The template_update function must be called with -f or --function.&quot;
        )

<A NAME="3"></A>    if kwargs is None:
        kwargs = {}

    template_id <FONT color="#53858b"><A HREF="javascript:ZweiFrames('match94691-1.html#3',3,'match94691-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= kwargs.get(&quot;template_id&quot;, None)
    template_name = kwargs.get(&quot;template_name&quot;, None)
    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(</B></FONT>&quot;data&quot;, None)
    update_type = kwargs.get(&quot;update_type&quot;, None)
    update_args = [&quot;replace&quot;, &quot;merge&quot;]

    if update_type is None:
        raise SaltCloudSystemExit(
            &quot;The template_update function requires an 'update_type' to be provided.&quot;
        )

    if update_type == update_args[0]:
        update_number = 0
    elif update_type == update_args[1]:
        update_number = 1
    else:
        raise SaltCloudSystemExit(
            &quot;The update_type argument must be either {} or {}.&quot;.format(
                update_args[0], update_args[1]
            )
        )

    if template_id:
        if template_name:
            log.warning(
                &quot;Both the 'template_id' and 'template_name' arguments were provided. &quot;
                &quot;'template_id' will take precedence.&quot;
            )
    elif template_name:
        template_id = get_template_id(kwargs={&quot;name&quot;: template_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The template_update function requires either a 'template_id' &quot;
            &quot;or a 'template_name' to be provided.&quot;
        )

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The template_update function requires either 'data' or a file &quot;
            &quot;'path' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.template.update(
        auth, int(template_id), data, int(update_number)
    )

    ret = {
        &quot;action&quot;: &quot;template.update&quot;,
        &quot;updated&quot;: response[0],
        &quot;template_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def vm_action(name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Submits an action to be performed on a given virtual machine.

    .. versionadded:: 2016.3.0

    name
        The name of the VM to action.

    action
        The action to be performed on the VM. Available options include:
          - boot
          - delete
          - delete-recreate
          - hold
          - poweroff
          - poweroff-hard
          - reboot
          - reboot-hard
          - release
          - resched
          - resume
          - shutdown
          - shutdown-hard
          - stop
          - suspend
          - undeploy
          - undeploy-hard
          - unresched

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_action my-vm action='release'
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_action function must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    action = kwargs.get(&quot;action&quot;, None)
    if action is None:
        raise SaltCloudSystemExit(
            &quot;The vm_action function must have an 'action' provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.action(auth, action, vm_id)

    data = {
        &quot;action&quot;: &quot;vm.action.&quot; + str(action),
        &quot;actioned&quot;: response[0],
        &quot;vm_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vm_allocate(call=None, kwargs=None):
    &quot;&quot;&quot;
    Allocates a new virtual machine in OpenNebula.

    .. versionadded:: 2016.3.0

    path
        The path to a file defining the template of the VM to allocate.
        Syntax within the file can be the usual attribute=value or XML.
        Can be used instead of ``data``.

    data
        Contains the template definitions of the VM to allocate. Syntax can
        be the usual attribute=value or XML. Can be used instead of ``path``.

    hold
        If this parameter is set to ``True``, the VM will be created in
        the ``HOLD`` state. If not set, the VM is created in the ``PENDING``
        state. Default is ``False``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f vm_allocate path=/path/to/vm_template.txt
        salt-cloud --function vm_allocate path=/path/to/vm_template.txt hold=True
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_allocate function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)
    hold = kwargs.get(&quot;hold&quot;, False)

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The vm_allocate function requires either 'data' or a file 'path' &quot;
            &quot;to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.vm.allocate(auth, data, salt.utils.data.is_true(hold))

    ret = {
        &quot;action&quot;: &quot;vm.allocate&quot;,
        &quot;allocated&quot;: response[0],
        &quot;vm_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def vm_attach(name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Attaches a new disk to the given virtual machine.

    .. versionadded:: 2016.3.0

    name
        The name of the VM for which to attach the new disk.

    path
        The path to a file containing a single disk vector attribute.
        Syntax within the file can be the usual attribute=value or XML.
        Can be used instead of ``data``.

    data
        Contains the data needed to attach a single disk vector attribute.
        Syntax can be the usual attribute=value or XML. Can be used instead
        of ``path``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_attach my-vm path=/path/to/disk_file.txt
        salt-cloud -a vm_attach my-vm data=&quot;DISK=[DISK_ID=1]&quot;
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_attach action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The vm_attach function requires either 'data' or a file &quot;
            &quot;'path' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.attach(auth, vm_id, data)

    ret = {
        &quot;action&quot;: &quot;vm.attach&quot;,
        &quot;attached&quot;: response[0],
        &quot;vm_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def vm_attach_nic(name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Attaches a new network interface to the given virtual machine.

    .. versionadded:: 2016.3.0

    name
        The name of the VM for which to attach the new network interface.

    path
        The path to a file containing a single NIC vector attribute.
        Syntax within the file can be the usual attribute=value or XML. Can
        be used instead of ``data``.

    data
        Contains the single NIC vector attribute to attach to the VM.
        Syntax can be the usual attribute=value or XML. Can be used instead
        of ``path``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_attach_nic my-vm path=/path/to/nic_file.txt
        salt-cloud -a vm_attach_nic my-vm data=&quot;NIC=[NETWORK_ID=1]&quot;
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_attach_nic action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The vm_attach_nic function requires either 'data' or a file &quot;
            &quot;'path' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.attachnic(auth, vm_id, data)

    ret = {
        &quot;action&quot;: &quot;vm.attachnic&quot;,
        &quot;nic_attached&quot;: response[0],
        &quot;vm_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def vm_deploy(name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Initiates the instance of the given VM on the target host.

    .. versionadded:: 2016.3.0

    name
        The name of the VM to deploy.

    host_id
        The ID of the target host where the VM will be deployed. Can be used instead
        of ``host_name``.

    host_name
        The name of the target host where the VM will be deployed. Can be used instead
        of ``host_id``.

    capacity_maintained
        True to enforce the Host capacity is not over-committed. This parameter is only
        acknowledged for users in the ``oneadmin`` group. Host capacity will be always
        enforced for regular users.

    datastore_id
        The ID of the target system data-store where the VM will be deployed. Optional
        and can be used instead of ``datastore_name``. If neither ``datastore_id`` nor
        ``datastore_name`` are set, OpenNebula will choose the data-store.

    datastore_name
        The name of the target system data-store where the VM will be deployed. Optional,
        and can be used instead of ``datastore_id``. If neither ``datastore_id`` nor
        ``datastore_name`` are set, OpenNebula will choose the data-store.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_deploy my-vm host_id=0
        salt-cloud -a vm_deploy my-vm host_id=1 capacity_maintained=False
        salt-cloud -a vm_deploy my-vm host_name=host01 datastore_id=1
        salt-cloud -a vm_deploy my-vm host_name=host01 datastore_name=default
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_deploy action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    host_id = kwargs.get(&quot;host_id&quot;, None)
    host_name = kwargs.get(&quot;host_name&quot;, None)
    capacity_maintained = kwargs.get(&quot;capacity_maintained&quot;, True)
    datastore_id = kwargs.get(&quot;datastore_id&quot;, None)
    datastore_name = kwargs.get(&quot;datastore_name&quot;, None)

    if host_id:
        if host_name:
            log.warning(
                &quot;Both the 'host_id' and 'host_name' arguments were provided. &quot;
                &quot;'host_id' will take precedence.&quot;
            )
    elif host_name:
        host_id = get_host_id(kwargs={&quot;name&quot;: host_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The vm_deploy function requires a 'host_id' or a 'host_name' &quot;
            &quot;to be provided.&quot;
        )

    if datastore_id:
        if datastore_name:
            log.warning(
                &quot;Both the 'datastore_id' and 'datastore_name' arguments were provided. &quot;
                &quot;'datastore_id' will take precedence.&quot;
            )
    elif datastore_name:
        datastore_id = get_datastore_id(kwargs={&quot;name&quot;: datastore_name})
    else:
        datastore_id = &quot;-1&quot;

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = get_vm_id(kwargs={&quot;name&quot;: name})
    response = server.one.vm.deploy(
        auth,
        int(vm_id),
        int(host_id),
        salt.utils.data.is_true(capacity_maintained),
        int(datastore_id),
    )

    data = {
        &quot;action&quot;: &quot;vm.deploy&quot;,
        &quot;deployed&quot;: response[0],
        &quot;vm_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vm_detach(name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Detaches a disk from a virtual machine.

    .. versionadded:: 2016.3.0

    name
        The name of the VM from which to detach the disk.

    disk_id
        The ID of the disk to detach.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_detach my-vm disk_id=1
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_detach action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    disk_id = kwargs.get(&quot;disk_id&quot;, None)
    if disk_id is None:
        raise SaltCloudSystemExit(
            &quot;The vm_detach function requires a 'disk_id' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.detach(auth, vm_id, int(disk_id))

    data = {
        &quot;action&quot;: &quot;vm.detach&quot;,
        &quot;detached&quot;: response[0],
        &quot;vm_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vm_detach_nic(name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Detaches a disk from a virtual machine.

    .. versionadded:: 2016.3.0

    name
        The name of the VM from which to detach the network interface.

    nic_id
        The ID of the nic to detach.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_detach_nic my-vm nic_id=1
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_detach_nic action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    nic_id = kwargs.get(&quot;nic_id&quot;, None)
    if nic_id is None:
        raise SaltCloudSystemExit(
            &quot;The vm_detach_nic function requires a 'nic_id' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.detachnic(auth, vm_id, int(nic_id))

    data = {
        &quot;action&quot;: &quot;vm.detachnic&quot;,
        &quot;nic_detached&quot;: response[0],
        &quot;vm_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vm_disk_save(name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Sets the disk to be saved in the given image.

    .. versionadded:: 2016.3.0

    name
        The name of the VM containing the disk to save.

    disk_id
        The ID of the disk to save.

    image_name
        The name of the new image where the disk will be saved.

    image_type
        The type for the new image. If not set, then the default ``ONED`` Configuration
        will be used. Other valid types include: OS, CDROM, DATABLOCK, KERNEL, RAMDISK,
        and CONTEXT.

    snapshot_id
        The ID of the snapshot to export. If not set, the current image state will be
        used.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_disk_save my-vm disk_id=1 image_name=my-new-image
        salt-cloud -a vm_disk_save my-vm disk_id=1 image_name=my-new-image image_type=CONTEXT snapshot_id=10
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_disk_save action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    disk_id = kwargs.get(&quot;disk_id&quot;, None)
    image_name = kwargs.get(&quot;image_name&quot;, None)
    image_type = kwargs.get(&quot;image_type&quot;, &quot;&quot;)
    snapshot_id = int(kwargs.get(&quot;snapshot_id&quot;, &quot;-1&quot;))

    if disk_id is None or image_name is None:
        raise SaltCloudSystemExit(
            &quot;The vm_disk_save function requires a 'disk_id' and an 'image_name' &quot;
            &quot;to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.disksave(
        auth, vm_id, int(disk_id), image_name, image_type, snapshot_id
    )

    data = {
        &quot;action&quot;: &quot;vm.disksave&quot;,
        &quot;saved&quot;: response[0],
        &quot;image_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vm_disk_snapshot_create(name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Takes a new snapshot of the disk image.

    .. versionadded:: 2016.3.0

    name
        The name of the VM of which to take the snapshot.

    disk_id
        The ID of the disk to save.

    description
        The description for the snapshot.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_disk_snapshot_create my-vm disk_id=0 description=&quot;My Snapshot Description&quot;
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_disk_snapshot_create action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    disk_id = kwargs.get(&quot;disk_id&quot;, None)
    description = kwargs.get(&quot;description&quot;, None)

    if disk_id is None or description is None:
        raise SaltCloudSystemExit(
            &quot;The vm_disk_snapshot_create function requires a 'disk_id' and a&quot;
            &quot; 'description' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.disksnapshotcreate(auth, vm_id, int(disk_id), description)

    data = {
        &quot;action&quot;: &quot;vm.disksnapshotcreate&quot;,
        &quot;created&quot;: response[0],
        &quot;snapshot_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vm_disk_snapshot_delete(name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Deletes a disk snapshot based on the given VM and the disk_id.

    .. versionadded:: 2016.3.0

    name
        The name of the VM containing the snapshot to delete.

    disk_id
        The ID of the disk to save.

    snapshot_id
        The ID of the snapshot to be deleted.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_disk_snapshot_delete my-vm disk_id=0 snapshot_id=6
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_disk_snapshot_delete action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    disk_id = kwargs.get(&quot;disk_id&quot;, None)
    snapshot_id = kwargs.get(&quot;snapshot_id&quot;, None)

    if disk_id is None or snapshot_id is None:
        raise SaltCloudSystemExit(
            &quot;The vm_disk_snapshot_create function requires a 'disk_id' and a&quot;
            &quot; 'snapshot_id' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.disksnapshotdelete(
        auth, vm_id, int(disk_id), int(snapshot_id)
    )

    data = {
        &quot;action&quot;: &quot;vm.disksnapshotdelete&quot;,
        &quot;deleted&quot;: response[0],
        &quot;snapshot_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vm_disk_snapshot_revert(name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Reverts a disk state to a previously taken snapshot.

    .. versionadded:: 2016.3.0

    name
        The name of the VM containing the snapshot.

    disk_id
        The ID of the disk to revert its state.

    snapshot_id
        The ID of the snapshot to which the snapshot should be reverted.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_disk_snapshot_revert my-vm disk_id=0 snapshot_id=6
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_disk_snapshot_revert action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    disk_id = kwargs.get(&quot;disk_id&quot;, None)
    snapshot_id = kwargs.get(&quot;snapshot_id&quot;, None)

    if disk_id is None or snapshot_id is None:
        raise SaltCloudSystemExit(
            &quot;The vm_disk_snapshot_revert function requires a 'disk_id' and a&quot;
            &quot; 'snapshot_id' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.disksnapshotrevert(
        auth, vm_id, int(disk_id), int(snapshot_id)
    )

    data = {
        &quot;action&quot;: &quot;vm.disksnapshotrevert&quot;,
        &quot;deleted&quot;: response[0],
        &quot;snapshot_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vm_info(name, call=None):
    &quot;&quot;&quot;
    Retrieves information for a given virtual machine. A VM name must be supplied.

    .. versionadded:: 2016.3.0

    name
        The name of the VM for which to gather information.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_info my-vm
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_info action must be called with -a or --action.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.info(auth, vm_id)

    if response[0] is False:
        return response[1]
    else:
        info = {}
        tree = _get_xml(response[1])
        info[tree.find(&quot;NAME&quot;).text] = _xml_to_dict(tree)
        return info


def vm_migrate(name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Migrates the specified virtual machine to the specified target host.

    .. versionadded:: 2016.3.0

    name
        The name of the VM to migrate.

    host_id
        The ID of the host to which the VM will be migrated. Can be used instead
        of ``host_name``.

    host_name
        The name of the host to which the VM will be migrated. Can be used instead
        of ``host_id``.

    live_migration
        If set to ``True``, a live-migration will be performed. Default is ``False``.

    capacity_maintained
        True to enforce the Host capacity is not over-committed. This parameter is only
        acknowledged for users in the ``oneadmin`` group. Host capacity will be always
        enforced for regular users.

    datastore_id
        The target system data-store ID where the VM will be migrated. Can be used
        instead of ``datastore_name``.

    datastore_name
        The name of the data-store target system where the VM will be migrated. Can be
        used instead of ``datastore_id``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_migrate my-vm host_id=0 datastore_id=1
        salt-cloud -a vm_migrate my-vm host_id=0 datastore_id=1 live_migration=True
        salt-cloud -a vm_migrate my-vm host_name=host01 datastore_name=default
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_migrate action must be called with -a or --action.&quot;
        )

<A NAME="0"></A>    if kwargs is None:
        kwargs = {}

    host_id <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match94691-1.html#0',3,'match94691-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>= kwargs.get(&quot;host_id&quot;, None)
    host_name = kwargs.get(&quot;host_name&quot;, None)
    live_migration = kwargs.get(&quot;live_migration&quot;, False)
    capacity_maintained = kwargs.get(&quot;capacity_maintained&quot;, True)
    datastore_id = kwargs.get(&quot;datastore_id&quot;, None)
    datastore_name = kwargs.get(</B></FONT>&quot;datastore_name&quot;, None)

    if datastore_id:
        if datastore_name:
            log.warning(
                &quot;Both the 'datastore_id' and 'datastore_name' arguments were provided. &quot;
                &quot;'datastore_id' will take precedence.&quot;
            )
    elif datastore_name:
        datastore_id = get_datastore_id(kwargs={&quot;name&quot;: datastore_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The vm_migrate function requires either a 'datastore_id' or a &quot;
            &quot;'datastore_name' to be provided.&quot;
        )

    if host_id:
        if host_name:
            log.warning(
                &quot;Both the 'host_id' and 'host_name' arguments were provided. &quot;
                &quot;'host_id' will take precedence.&quot;
            )
    elif host_name:
        host_id = get_host_id(kwargs={&quot;name&quot;: host_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The vm_migrate function requires either a 'host_id' &quot;
            &quot;or a 'host_name' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.migrate(
        auth,
        vm_id,
        int(host_id),
        salt.utils.data.is_true(live_migration),
        salt.utils.data.is_true(capacity_maintained),
        int(datastore_id),
    )

    data = {
        &quot;action&quot;: &quot;vm.migrate&quot;,
        &quot;migrated&quot;: response[0],
        &quot;vm_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vm_monitoring(name, call=None):
    &quot;&quot;&quot;
    Returns the monitoring records for a given virtual machine. A VM name must be
    supplied.

    The monitoring information returned is a list of VM elements. Each VM element
    contains the complete dictionary of the VM with the updated information returned
    by the poll action.

    .. versionadded:: 2016.3.0

    name
        The name of the VM for which to gather monitoring records.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_monitoring my-vm
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_monitoring action must be called with -a or --action.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.monitoring(auth, vm_id)

    if response[0] is False:
        log.error(
            &quot;There was an error retrieving the specified VM's monitoring information.&quot;
        )
        return {}
    else:
        info = {}
        for vm_ in _get_xml(response[1]):
            info[vm_.find(&quot;ID&quot;).text] = _xml_to_dict(vm_)
        return info


def vm_resize(name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Changes the capacity of the virtual machine.

    .. versionadded:: 2016.3.0

    name
        The name of the VM to resize.

    path
        The path to a file containing new capacity elements CPU, VCPU, MEMORY. If one
        of them is not present, or its value is 0, the VM will not be re-sized. Syntax
        within the file can be the usual attribute=value or XML. Can be used instead
        of ``data``.

    data
        Contains the new capacity elements CPU, VCPU, and MEMORY. If one of them is not
        present, or its value is 0, the VM will not be re-sized. Can be used instead of
        ``path``.

    capacity_maintained
        True to enforce the Host capacity is not over-committed. This parameter is only
        acknowledged for users in the ``oneadmin`` group. Host capacity will be always
        enforced for regular users.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_resize my-vm path=/path/to/capacity_template.txt
        salt-cloud -a vm_resize my-vm path=/path/to/capacity_template.txt capacity_maintained=False
        salt-cloud -a vm_resize my-vm data=&quot;CPU=1 VCPU=1 MEMORY=1024&quot;
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_resize action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)
    capacity_maintained = kwargs.get(&quot;capacity_maintained&quot;, True)

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The vm_resize function requires either 'data' or a file 'path' &quot;
            &quot;to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.resize(
        auth, vm_id, data, salt.utils.data.is_true(capacity_maintained)
    )

    ret = {
        &quot;action&quot;: &quot;vm.resize&quot;,
        &quot;resized&quot;: response[0],
        &quot;vm_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def vm_snapshot_create(vm_name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Creates a new virtual machine snapshot from the provided VM.

    .. versionadded:: 2016.3.0

    vm_name
        The name of the VM from which to create the snapshot.

    snapshot_name
        The name of the snapshot to be created.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_snapshot_create my-vm snapshot_name=my-new-snapshot
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_snapshot_create action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    snapshot_name = kwargs.get(&quot;snapshot_name&quot;, None)
    if snapshot_name is None:
        raise SaltCloudSystemExit(
            &quot;The vm_snapshot_create function requires a 'snapshot_name' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: vm_name}))
    response = server.one.vm.snapshotcreate(auth, vm_id, snapshot_name)

    data = {
        &quot;action&quot;: &quot;vm.snapshotcreate&quot;,
        &quot;snapshot_created&quot;: response[0],
        &quot;snapshot_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vm_snapshot_delete(vm_name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Deletes a virtual machine snapshot from the provided VM.

    .. versionadded:: 2016.3.0

    vm_name
        The name of the VM from which to delete the snapshot.

    snapshot_id
        The ID of the snapshot to be deleted.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_snapshot_delete my-vm snapshot_id=8
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_snapshot_delete action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    snapshot_id = kwargs.get(&quot;snapshot_id&quot;, None)
    if snapshot_id is None:
        raise SaltCloudSystemExit(
            &quot;The vm_snapshot_delete function requires a 'snapshot_id' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: vm_name}))
    response = server.one.vm.snapshotdelete(auth, vm_id, int(snapshot_id))

    data = {
        &quot;action&quot;: &quot;vm.snapshotdelete&quot;,
        &quot;snapshot_deleted&quot;: response[0],
        &quot;vm_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vm_snapshot_revert(vm_name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Reverts a virtual machine to a snapshot

    .. versionadded:: 2016.3.0

    vm_name
        The name of the VM to revert.

    snapshot_id
        The snapshot ID.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_snapshot_revert my-vm snapshot_id=42
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_snapshot_revert action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    snapshot_id = kwargs.get(&quot;snapshot_id&quot;, None)
    if snapshot_id is None:
        raise SaltCloudSystemExit(
            &quot;The vm_snapshot_revert function requires a 'snapshot_id' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: vm_name}))
    response = server.one.vm.snapshotrevert(auth, vm_id, int(snapshot_id))

    data = {
        &quot;action&quot;: &quot;vm.snapshotrevert&quot;,
        &quot;snapshot_reverted&quot;: response[0],
        &quot;vm_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vm_update(name, kwargs=None, call=None):
    &quot;&quot;&quot;
    Replaces the user template contents.

    .. versionadded:: 2016.3.0

    name
        The name of the VM to update.

    path
        The path to a file containing new user template contents. Syntax within the
        file can be the usual attribute=value or XML. Can be used instead of ``data``.

    data
        Contains the new user template contents. Syntax can be the usual attribute=value
        or XML. Can be used instead of ``path``.

    update_type
        There are two ways to update a VM: ``replace`` the whole template
        or ``merge`` the new template with the existing one.

    CLI Example:

    .. code-block:: bash

        salt-cloud -a vm_update my-vm path=/path/to/user_template_file.txt update_type='replace'
    &quot;&quot;&quot;
    if call != &quot;action&quot;:
        raise SaltCloudSystemExit(
            &quot;The vm_update action must be called with -a or --action.&quot;
        )

    if kwargs is None:
        kwargs = {}

    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)
    update_type = kwargs.get(&quot;update_type&quot;, None)
    update_args = [&quot;replace&quot;, &quot;merge&quot;]

    if update_type is None:
        raise SaltCloudSystemExit(
            &quot;The vm_update function requires an 'update_type' to be provided.&quot;
        )

    if update_type == update_args[0]:
        update_number = 0
    elif update_type == update_args[1]:
        update_number = 1
    else:
        raise SaltCloudSystemExit(
            &quot;The update_type argument must be either {} or {}.&quot;.format(
                update_args[0], update_args[1]
            )
        )

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The vm_update function requires either 'data' or a file 'path' &quot;
            &quot;to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    vm_id = int(get_vm_id(kwargs={&quot;name&quot;: name}))
    response = server.one.vm.update(auth, vm_id, data, int(update_number))

    ret = {
        &quot;action&quot;: &quot;vm.update&quot;,
        &quot;updated&quot;: response[0],
        &quot;resource_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def vn_add_ar(call=None, kwargs=None):
    &quot;&quot;&quot;
    Adds address ranges to a given virtual network.

    .. versionadded:: 2016.3.0

    vn_id
        The ID of the virtual network to add the address range. Can be used
        instead of ``vn_name``.

    vn_name
        The name of the virtual network to add the address range. Can be used
        instead of ``vn_id``.

    path
        The path to a file containing the template of the address range to add.
        Syntax within the file can be the usual attribute=value or XML. Can be
        used instead of ``data``.

    data
        Contains the template of the address range to add. Syntax can be the
        usual attribute=value or XML. Can be used instead of ``path``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f vn_add_ar opennebula vn_id=3 path=/path/to/address_range.txt
        salt-cloud -f vn_add_ar opennebula vn_name=my-vn \\
            data=&quot;AR=[TYPE=IP4, IP=192.168.0.5, SIZE=10]&quot;
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The vn_add_ar function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    vn_id = kwargs.get(&quot;vn_id&quot;, None)
    vn_name = kwargs.get(&quot;vn_name&quot;, None)
    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)

    if vn_id:
        if vn_name:
            log.warning(
                &quot;Both the 'vn_id' and 'vn_name' arguments were provided. &quot;
                &quot;'vn_id' will take precedence.&quot;
            )
    elif vn_name:
        vn_id = get_vn_id(kwargs={&quot;name&quot;: vn_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The vn_add_ar function requires a 'vn_id' and a 'vn_name' to be provided.&quot;
        )

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The vn_add_ar function requires either 'data' or a file 'path' &quot;
            &quot;to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.vn.add_ar(auth, int(vn_id), data)

    ret = {
        &quot;action&quot;: &quot;vn.add_ar&quot;,
        &quot;address_range_added&quot;: response[0],
        &quot;resource_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def vn_allocate(call=None, kwargs=None):
    &quot;&quot;&quot;
    Allocates a new virtual network in OpenNebula.

    .. versionadded:: 2016.3.0

    path
        The path to a file containing the template of the virtual network to allocate.
        Syntax within the file can be the usual attribute=value or XML. Can be used
        instead of ``data``.

    data
        Contains the template of the virtual network to allocate. Syntax can be the
        usual attribute=value or XML. Can be used instead of ``path``.

    cluster_id
        The ID of the cluster for which to add the new virtual network. Can be used
        instead of ``cluster_name``. If neither ``cluster_id`` nor ``cluster_name``
        are provided, the virtual network wont be added to any cluster.

    cluster_name
        The name of the cluster for which to add the new virtual network. Can be used
        instead of ``cluster_id``. If neither ``cluster_name`` nor ``cluster_id`` are
        provided, the virtual network won't be added to any cluster.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f vn_allocate opennebula path=/path/to/vn_file.txt
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The vn_allocate function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    cluster_id = kwargs.get(&quot;cluster_id&quot;, None)
    cluster_name = kwargs.get(&quot;cluster_name&quot;, None)
    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The vn_allocate function requires either 'data' or a file 'path' &quot;
            &quot;to be provided.&quot;
        )

    if cluster_id:
        if cluster_name:
            log.warning(
                &quot;Both the 'cluster_id' and 'cluster_name' arguments were provided. &quot;
                &quot;'cluster_id' will take precedence.&quot;
            )
    elif cluster_name:
        cluster_id = get_cluster_id(kwargs={&quot;name&quot;: cluster_name})
    else:
        cluster_id = &quot;-1&quot;

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.vn.allocate(auth, data, int(cluster_id))

    ret = {
        &quot;action&quot;: &quot;vn.allocate&quot;,
        &quot;allocated&quot;: response[0],
        &quot;vn_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def vn_delete(call=None, kwargs=None):
    &quot;&quot;&quot;
    Deletes the given virtual network from OpenNebula. Either a name or a vn_id must
    be supplied.

    .. versionadded:: 2016.3.0

    name
        The name of the virtual network to delete. Can be used instead of ``vn_id``.

    vn_id
        The ID of the virtual network to delete. Can be used instead of ``name``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f vn_delete opennebula name=my-virtual-network
        salt-cloud --function vn_delete opennebula vn_id=3
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The vn_delete function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    vn_id = kwargs.get(&quot;vn_id&quot;, None)

    if vn_id:
        if name:
            log.warning(
                &quot;Both the 'vn_id' and 'name' arguments were provided. &quot;
                &quot;'vn_id' will take precedence.&quot;
            )
    elif name:
        vn_id = get_vn_id(kwargs={&quot;name&quot;: name})
    else:
        raise SaltCloudSystemExit(
            &quot;The vn_delete function requires a 'name' or a 'vn_id' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.vn.delete(auth, int(vn_id))

    data = {
        &quot;action&quot;: &quot;vn.delete&quot;,
        &quot;deleted&quot;: response[0],
        &quot;vn_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vn_free_ar(call=None, kwargs=None):
    &quot;&quot;&quot;
    Frees a reserved address range from a virtual network.

    .. versionadded:: 2016.3.0

    vn_id
        The ID of the virtual network from which to free an address range.
        Can be used instead of ``vn_name``.

    vn_name
        The name of the virtual network from which to free an address range.
        Can be used instead of ``vn_id``.

    ar_id
        The ID of the address range to free.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f vn_free_ar opennebula vn_id=3 ar_id=1
        salt-cloud -f vn_free_ar opennebula vn_name=my-vn ar_id=1
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The vn_free_ar function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    vn_id = kwargs.get(&quot;vn_id&quot;, None)
    vn_name = kwargs.get(&quot;vn_name&quot;, None)
    ar_id = kwargs.get(&quot;ar_id&quot;, None)

    if ar_id is None:
        raise SaltCloudSystemExit(
            &quot;The vn_free_ar function requires an 'rn_id' to be provided.&quot;
        )

    if vn_id:
        if vn_name:
            log.warning(
                &quot;Both the 'vn_id' and 'vn_name' arguments were provided. &quot;
                &quot;'vn_id' will take precedence.&quot;
            )
    elif vn_name:
        vn_id = get_vn_id(kwargs={&quot;name&quot;: vn_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The vn_free_ar function requires a 'vn_id' or a 'vn_name' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.vn.free_ar(auth, int(vn_id), int(ar_id))

    data = {
        &quot;action&quot;: &quot;vn.free_ar&quot;,
        &quot;ar_freed&quot;: response[0],
        &quot;resource_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return data


def vn_hold(call=None, kwargs=None):
    &quot;&quot;&quot;
    Holds a virtual network lease as used.

    .. versionadded:: 2016.3.0

    vn_id
        The ID of the virtual network from which to hold the lease. Can be used
        instead of ``vn_name``.

    vn_name
        The name of the virtual network from which to hold the lease. Can be used
        instead of ``vn_id``.

    path
        The path to a file defining the template of the lease to hold.
        Syntax within the file can be the usual attribute=value or XML. Can be
        used instead of ``data``.

    data
        Contains the template of the lease to hold. Syntax can be the usual
        attribute=value or XML. Can be used instead of ``path``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f vn_hold opennebula vn_id=3 path=/path/to/vn_hold_file.txt
        salt-cloud -f vn_hold opennebula vn_name=my-vn data=&quot;LEASES=[IP=192.168.0.5]&quot;
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The vn_hold function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    vn_id = kwargs.get(&quot;vn_id&quot;, None)
    vn_name = kwargs.get(&quot;vn_name&quot;, None)
    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)

    if vn_id:
        if vn_name:
            log.warning(
                &quot;Both the 'vn_id' and 'vn_name' arguments were provided. &quot;
                &quot;'vn_id' will take precedence.&quot;
            )
    elif vn_name:
        vn_id = get_vn_id(kwargs={&quot;name&quot;: vn_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The vn_hold function requires a 'vn_id' or a 'vn_name' to be provided.&quot;
        )

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The vn_hold function requires either 'data' or a 'path' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.vn.hold(auth, int(vn_id), data)

    ret = {
        &quot;action&quot;: &quot;vn.hold&quot;,
        &quot;held&quot;: response[0],
        &quot;resource_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def vn_info(call=None, kwargs=None):
    &quot;&quot;&quot;
    Retrieves information for the virtual network.

    .. versionadded:: 2016.3.0

    name
        The name of the virtual network for which to gather information. Can be
        used instead of ``vn_id``.

    vn_id
        The ID of the virtual network for which to gather information. Can be
        used instead of ``name``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f vn_info opennebula vn_id=3
        salt-cloud --function vn_info opennebula name=public
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The vn_info function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    name = kwargs.get(&quot;name&quot;, None)
    vn_id = kwargs.get(&quot;vn_id&quot;, None)

    if vn_id:
        if name:
            log.warning(
                &quot;Both the 'vn_id' and 'name' arguments were provided. &quot;
                &quot;'vn_id' will take precedence.&quot;
            )
    elif name:
        vn_id = get_vn_id(kwargs={&quot;name&quot;: name})
    else:
        raise SaltCloudSystemExit(
            &quot;The vn_info function requires either a 'name' or a 'vn_id' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.vn.info(auth, int(vn_id))

    if response[0] is False:
        return response[1]
    else:
        info = {}
        tree = _get_xml(response[1])
        info[tree.find(&quot;NAME&quot;).text] = _xml_to_dict(tree)
        return info


def vn_release(call=None, kwargs=None):
    &quot;&quot;&quot;
    Releases a virtual network lease that was previously on hold.

    .. versionadded:: 2016.3.0

    vn_id
        The ID of the virtual network from which to release the lease. Can be
        used instead of ``vn_name``.

    vn_name
        The name of the virtual network from which to release the lease.
        Can be used instead of ``vn_id``.

    path
        The path to a file defining the template of the lease to release.
        Syntax within the file can be the usual attribute=value or XML. Can be
        used instead of ``data``.

    data
        Contains the template defining the lease to release. Syntax can be the
        usual attribute=value or XML. Can be used instead of ``path``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f vn_release opennebula vn_id=3 path=/path/to/vn_release_file.txt
        salt-cloud =f vn_release opennebula vn_name=my-vn data=&quot;LEASES=[IP=192.168.0.5]&quot;
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The vn_reserve function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    vn_id = kwargs.get(&quot;vn_id&quot;, None)
    vn_name = kwargs.get(&quot;vn_name&quot;, None)
    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)

    if vn_id:
        if vn_name:
            log.warning(
                &quot;Both the 'vn_id' and 'vn_name' arguments were provided. &quot;
                &quot;'vn_id' will take precedence.&quot;
            )
    elif vn_name:
        vn_id = get_vn_id(kwargs={&quot;name&quot;: vn_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The vn_release function requires a 'vn_id' or a 'vn_name' to be provided.&quot;
        )

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The vn_release function requires either 'data' or a 'path' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.vn.release(auth, int(vn_id), data)

    ret = {
        &quot;action&quot;: &quot;vn.release&quot;,
        &quot;released&quot;: response[0],
        &quot;resource_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


def vn_reserve(call=None, kwargs=None):
    &quot;&quot;&quot;
    Reserve network addresses.

    .. versionadded:: 2016.3.0

    vn_id
        The ID of the virtual network from which to reserve addresses. Can be used
        instead of vn_name.

    vn_name
        The name of the virtual network from which to reserve addresses. Can be
        used instead of vn_id.

    path
        The path to a file defining the template of the address reservation.
        Syntax within the file can be the usual attribute=value or XML. Can be used
        instead of ``data``.

    data
        Contains the template defining the address reservation. Syntax can be the
        usual attribute=value or XML. Data provided must be wrapped in double
        quotes. Can be used instead of ``path``.

    CLI Example:

    .. code-block:: bash

        salt-cloud -f vn_reserve opennebula vn_id=3 path=/path/to/vn_reserve_file.txt
        salt-cloud -f vn_reserve opennebula vn_name=my-vn data=&quot;SIZE=10 AR_ID=8 NETWORK_ID=1&quot;
    &quot;&quot;&quot;
    if call != &quot;function&quot;:
        raise SaltCloudSystemExit(
            &quot;The vn_reserve function must be called with -f or --function.&quot;
        )

    if kwargs is None:
        kwargs = {}

    vn_id = kwargs.get(&quot;vn_id&quot;, None)
    vn_name = kwargs.get(&quot;vn_name&quot;, None)
    path = kwargs.get(&quot;path&quot;, None)
    data = kwargs.get(&quot;data&quot;, None)

    if vn_id:
        if vn_name:
            log.warning(
                &quot;Both the 'vn_id' and 'vn_name' arguments were provided. &quot;
                &quot;'vn_id' will take precedence.&quot;
            )
    elif vn_name:
        vn_id = get_vn_id(kwargs={&quot;name&quot;: vn_name})
    else:
        raise SaltCloudSystemExit(
            &quot;The vn_reserve function requires a 'vn_id' or a 'vn_name' to be provided.&quot;
        )

    if data:
        if path:
            log.warning(
                &quot;Both the 'data' and 'path' arguments were provided. &quot;
                &quot;'data' will take precedence.&quot;
            )
    elif path:
        with salt.utils.files.fopen(path, mode=&quot;r&quot;) as rfh:
            data = rfh.read()
    else:
        raise SaltCloudSystemExit(
            &quot;The vn_reserve function requires a 'path' to be provided.&quot;
        )

    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])
    response = server.one.vn.reserve(auth, int(vn_id), data)

    ret = {
        &quot;action&quot;: &quot;vn.reserve&quot;,
        &quot;reserved&quot;: response[0],
        &quot;resource_id&quot;: response[1],
        &quot;error_code&quot;: response[2],
    }

    return ret


# Helper Functions


def _get_node(name):
    &quot;&quot;&quot;
    Helper function that returns all information about a named node.

    name
        The name of the node for which to get information.
    &quot;&quot;&quot;
    attempts = 10

    while attempts &gt;= 0:
        try:
            return list_nodes_full()[name]
        except KeyError:
            attempts -= 1
            log.debug(
                &quot;Failed to get the data for node '%s'. Remaining attempts: %s&quot;,
                name,
                attempts,
            )

            # Just a little delay between attempts...
            time.sleep(0.5)

    return {}


def _get_xml(xml_str):
    &quot;&quot;&quot;
    Intrepret the data coming from opennebula and raise if it's not XML.
    &quot;&quot;&quot;
    try:
        xml_data = etree.XML(xml_str)
    # XMLSyntaxError seems to be only available from lxml, but that is the xml
    # library loaded by this module
    except etree.XMLSyntaxError as err:
        # opennebula returned invalid XML, which could be an error message, so
        # log it
        raise SaltCloudSystemExit(&quot;opennebula returned: {}&quot;.format(xml_str))
    return xml_data


def _get_xml_rpc():
    &quot;&quot;&quot;
    Uses the OpenNebula cloud provider configurations to connect to the
    OpenNebula API.

    Returns the server connection created as well as the user and password
    values from the cloud provider config file used to make the connection.
    &quot;&quot;&quot;
    vm_ = get_configured_provider()

    xml_rpc = config.get_cloud_config_value(
        &quot;xml_rpc&quot;, vm_, __opts__, search_global=False
    )

    user = config.get_cloud_config_value(&quot;user&quot;, vm_, __opts__, search_global=False)

    password = config.get_cloud_config_value(
        &quot;password&quot;, vm_, __opts__, search_global=False
    )

    server = xmlrpc.client.ServerProxy(xml_rpc)

    return server, user, password


def _list_nodes(full=False):
    &quot;&quot;&quot;
    Helper function for the list_* query functions - Constructs the
    appropriate dictionaries to return from the API query.

    full
        If performing a full query, such as in list_nodes_full, change
        this parameter to ``True``.
    &quot;&quot;&quot;
    server, user, password = _get_xml_rpc()
    auth = &quot;:&quot;.join([user, password])

    vm_pool = server.one.vmpool.info(auth, -2, -1, -1, -1)[1]

    vms = {}
    for vm in _get_xml(vm_pool):
        name = vm.find(&quot;NAME&quot;).text
        vms[name] = {}

        cpu_size = vm.find(&quot;TEMPLATE&quot;).find(&quot;CPU&quot;).text
        memory_size = vm.find(&quot;TEMPLATE&quot;).find(&quot;MEMORY&quot;).text

        private_ips = []
        for nic in vm.find(&quot;TEMPLATE&quot;).findall(&quot;NIC&quot;):
            try:
                private_ips.append(nic.find(&quot;IP&quot;).text)
            except Exception:  # pylint: disable=broad-except
                pass

        vms[name][&quot;id&quot;] = vm.find(&quot;ID&quot;).text
        if &quot;TEMPLATE_ID&quot; in vm.find(&quot;TEMPLATE&quot;):
            vms[name][&quot;image&quot;] = vm.find(&quot;TEMPLATE&quot;).find(&quot;TEMPLATE_ID&quot;).text
        vms[name][&quot;name&quot;] = name
        vms[name][&quot;size&quot;] = {&quot;cpu&quot;: cpu_size, &quot;memory&quot;: memory_size}
        vms[name][&quot;state&quot;] = vm.find(&quot;STATE&quot;).text
        vms[name][&quot;private_ips&quot;] = private_ips
        vms[name][&quot;public_ips&quot;] = []

        if full:
            vms[vm.find(&quot;NAME&quot;).text] = _xml_to_dict(vm)

    return vms


def _xml_to_dict(xml):
    &quot;&quot;&quot;
    Helper function to covert xml into a data dictionary.

    xml
        The xml data to convert.
    &quot;&quot;&quot;
    dicts = {}
    for item in xml:
        key = item.tag.lower()
        idx = 1
        while key in dicts:
            key += str(idx)
            idx += 1
        if item.text is None:
            dicts[key] = _xml_to_dict(item)
        else:
            dicts[key] = item.text

    return dicts
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>vagrant_1.py</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
&quot;&quot;&quot;
Work with virtual machines managed by Vagrant.

.. versionadded:: 2018.3.0

Mapping between a Salt node id and the Vagrant machine name
(and the path to the Vagrantfile where it is defined)
is stored in a Salt sdb database on the Vagrant host (minion) machine.
In order to use this module, sdb must be configured. An SQLite
database is the recommended storage method.  The URI used for
the sdb lookup is &quot;sdb://vagrant_sdb_data&quot;.

requirements:
   - the VM host machine must have salt-minion, Vagrant and a vm provider installed.
   - the VM host must have a valid definition for `sdb://vagrant_sdb_data`

    Configuration example:

    .. code-block:: yaml

        # file /etc/salt/minion.d/vagrant_sdb.conf
        vagrant_sdb_data:
          driver: sqlite3
          database: /var/cache/salt/vagrant.sqlite
          table: sdb
          create_table: True

&quot;&quot;&quot;

import logging
import os

import salt.utils.files
import salt.utils.path
import salt.utils.stringutils
from salt._compat import ipaddress
from salt.exceptions import CommandExecutionError, SaltInvocationError

log = logging.getLogger(__name__)

__virtualname__ = &quot;vagrant&quot;

VAGRANT_SDB_URL = &quot;sdb://vagrant_sdb_data/&quot;


def __virtual__():
    &quot;&quot;&quot;
    run Vagrant commands if possible
    &quot;&quot;&quot;
    if salt.utils.path.which(&quot;vagrant&quot;) is None:
        return (
            False,
            &quot;The vagrant module could not be loaded: vagrant command not found&quot;,
        )
    return __virtualname__


def _build_sdb_uri(key):
    &quot;&quot;&quot;
    returns string used to fetch data for &quot;key&quot; from the sdb store.

    Salt node id's are used as the key for vm_ dicts.

    &quot;&quot;&quot;
    return &quot;{}{}&quot;.format(VAGRANT_SDB_URL, key)


def _build_machine_uri(machine, cwd):
    &quot;&quot;&quot;
    returns string used to fetch id names from the sdb store.

    the cwd and machine name are concatenated with '?' which should
    never collide with a Salt node id -- which is important since we
    will be storing both in the same table.
    &quot;&quot;&quot;
    key = &quot;{}?{}&quot;.format(machine, os.path.abspath(cwd))
    return _build_sdb_uri(key)


def _update_vm_info(name, vm_):
    &quot;&quot;&quot;store the vm_ information keyed by name&quot;&quot;&quot;
    __utils__[&quot;sdb.sdb_set&quot;](_build_sdb_uri(name), vm_, __opts__)

    # store machine-to-name mapping, too
    if vm_[&quot;machine&quot;]:
        __utils__[&quot;sdb.sdb_set&quot;](
            _build_machine_uri(vm_[&quot;machine&quot;], vm_.get(&quot;cwd&quot;, &quot;.&quot;)), name, __opts__
        )


def get_vm_info(name):
    &quot;&quot;&quot;
    get the information for a VM.

    :param name: salt_id name
    :return: dictionary of {'machine': x, 'cwd': y, ...}.
    &quot;&quot;&quot;
    try:
        vm_ = __utils__[&quot;sdb.sdb_get&quot;](_build_sdb_uri(name), __opts__)
    except KeyError:
        raise SaltInvocationError(
            &quot;Probable sdb driver not found. Check your configuration.&quot;
        )
    if vm_ is None or &quot;machine&quot; not in vm_:
        raise SaltInvocationError(
            &quot;No Vagrant machine defined for Salt_id {}&quot;.format(name)
        )
    return vm_


def get_machine_id(machine, cwd):
    &quot;&quot;&quot;
    returns the salt_id name of the Vagrant VM

    :param machine: the Vagrant machine name
    :param cwd: the path to Vagrantfile
    :return: salt_id name
    &quot;&quot;&quot;
    name = __utils__[&quot;sdb.sdb_get&quot;](_build_machine_uri(machine, cwd), __opts__)
    return name


def _erase_vm_info(name):
    &quot;&quot;&quot;
    erase the information for a VM the we are destroying.

    some sdb drivers (such as the SQLite driver we expect to use)
    do not have a `delete` method, so if the delete fails, we have
    to replace the with a blank entry.
    &quot;&quot;&quot;
    try:
        # delete the machine record
        vm_ = get_vm_info(name)
        if vm_[&quot;machine&quot;]:
            key = _build_machine_uri(vm_[&quot;machine&quot;], vm_.get(&quot;cwd&quot;, &quot;.&quot;))
            try:
                __utils__[&quot;sdb.sdb_delete&quot;](key, __opts__)
            except KeyError:
                # no delete method found -- load a blank value
                __utils__[&quot;sdb.sdb_set&quot;](key, None, __opts__)
    except Exception:  # pylint: disable=broad-except
        pass

    uri = _build_sdb_uri(name)
    try:
        # delete the name record
        __utils__[&quot;sdb.sdb_delete&quot;](uri, __opts__)
    except KeyError:
        # no delete method found -- load an empty dictionary
        __utils__[&quot;sdb.sdb_set&quot;](uri, {}, __opts__)
    except Exception:  # pylint: disable=broad-except
        pass


def _vagrant_ssh_config(vm_):
    &quot;&quot;&quot;
    get the information for ssh communication from the new VM

    :param vm_: the VM's info as we have it now
<A NAME="1"></A>    :return: dictionary of ssh stuff
    &quot;&quot;&quot;
    machine = vm_[&quot;machine&quot;]
    log<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match94691-0.html#1',2,'match94691-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>.info(&quot;requesting vagrant ssh-config for VM %s&quot;, machine or &quot;(default)&quot;)
    cmd = &quot;vagrant ssh-config {}&quot;.format(machine)
    reply = __salt__[&quot;cmd.shell&quot;](
        cmd, runas=vm_.get(&quot;runas&quot;), cwd=vm_.get(&quot;cwd&quot;), ignore_retcode=</B></FONT>True
    )
    ssh_config = {}
    for line in reply.split(&quot;\n&quot;):  # build a dictionary of the text reply
        tokens = line.strip().split()
        if len(tokens) == 2:  # each two-token line becomes a key:value pair
            ssh_config[tokens[0]] = tokens[1]
    log.debug(&quot;ssh_config=%s&quot;, repr(ssh_config))
    return ssh_config


def version():
    &quot;&quot;&quot;
    Return the version of Vagrant on the minion

    CLI Example:

    .. code-block:: bash

        salt '*' vagrant.version
    &quot;&quot;&quot;
    cmd = &quot;vagrant -v&quot;
    return __salt__[&quot;cmd.shell&quot;](cmd)


def list_domains():
    &quot;&quot;&quot;
    Return a list of the salt_id names of all available Vagrant VMs on
    this host without regard to the path where they are defined.

    CLI Example:

    .. code-block:: bash

        salt '*' vagrant.list_domains --log-level=info

    The log shows information about all known Vagrant environments
    on this machine. This data is cached and may not be completely
    up-to-date.
    &quot;&quot;&quot;
    vms = []
    cmd = &quot;vagrant global-status&quot;
    reply = __salt__[&quot;cmd.shell&quot;](cmd)
    log.debug(&quot;---&gt;\n%s&quot;, reply)
    for line in reply.split(&quot;\n&quot;):  # build a list of the text reply
        tokens = line.strip().split()
        try:
            _ = int(tokens[0], 16)  # valid id numbers are hexadecimal
        except (ValueError, IndexError):
            continue  # skip lines without valid id numbers
        machine = tokens[1]
        cwd = tokens[-1]
        name = get_machine_id(machine, cwd)
        if name:
            vms.append(name)
    return vms


def list_active_vms(cwd=None):
    &quot;&quot;&quot;
    Return a list of machine names for active virtual machine on the host,
    which are defined in the Vagrantfile at the indicated path.

    CLI Example:

    .. code-block:: bash

        salt '*' vagrant.list_active_vms  cwd=/projects/project_1
    &quot;&quot;&quot;
    vms = []
    cmd = &quot;vagrant status&quot;
    reply = __salt__[&quot;cmd.shell&quot;](cmd, cwd=cwd)
    log.info(&quot;---&gt;\n%s&quot;, reply)
    for line in reply.split(&quot;\n&quot;):  # build a list of the text reply
        tokens = line.strip().split()
        if len(tokens) &gt; 1:
            if tokens[1] == &quot;running&quot;:
                vms.append(tokens[0])
    return vms


def list_inactive_vms(cwd=None):
    &quot;&quot;&quot;
    Return a list of machine names for inactive virtual machine on the host,
    which are defined in the Vagrantfile at the indicated path.

    CLI Example:

    .. code-block:: bash

        salt '*' virt.list_inactive_vms cwd=/projects/project_1
    &quot;&quot;&quot;
    vms = []
    cmd = &quot;vagrant status&quot;
    reply = __salt__[&quot;cmd.shell&quot;](cmd, cwd=cwd)
    log.info(&quot;---&gt;\n%s&quot;, reply)
    for line in reply.split(&quot;\n&quot;):  # build a list of the text reply
        tokens = line.strip().split()
        if len(tokens) &gt; 1 and tokens[-1].endswith(&quot;)&quot;):
            if tokens[1] != &quot;running&quot;:
                vms.append(tokens[0])
    return vms


def vm_state(name=&quot;&quot;, cwd=None):
    &quot;&quot;&quot;
    Return list of information for all the vms indicating their state.

    If you pass a VM name in as an argument then it will return info
    for just the named VM, otherwise it will return all VMs defined by
    the Vagrantfile in the `cwd` directory.

    CLI Example:

    .. code-block:: bash

        salt '*' vagrant.vm_state &lt;name&gt;  cwd=/projects/project_1

    returns a list of dictionaries with machine name, state, provider,
    and salt_id name.

    .. code-block:: python

        datum = {'machine': _, # Vagrant machine name,
                 'state': _, # string indicating machine state, like 'running'
                 'provider': _, # the Vagrant VM provider
                 'name': _} # salt_id name

    Known bug: if there are multiple machines in your Vagrantfile, and you request
    the status of the ``primary`` machine, which you defined by leaving the ``machine``
    parameter blank, then you may receive the status of all of them.
    Please specify the actual machine name for each VM if there are more than one.

    &quot;&quot;&quot;

    if name:
        vm_ = get_vm_info(name)
        machine = vm_[&quot;machine&quot;]
        cwd = vm_[&quot;cwd&quot;] or cwd  # usually ignore passed-in cwd
    else:
        if not cwd:
            raise SaltInvocationError(
                &quot;Path to Vagranfile must be defined, but cwd={}&quot;.format(cwd)
            )
        machine = &quot;&quot;

    info = []
    cmd = &quot;vagrant status {}&quot;.format(machine)
    reply = __salt__[&quot;cmd.shell&quot;](cmd, cwd)
    log.info(&quot;---&gt;\n%s&quot;, reply)
    for line in reply.split(&quot;\n&quot;):  # build a list of the text reply
        tokens = line.strip().split()
        if len(tokens) &gt; 1 and tokens[-1].endswith(&quot;)&quot;):
            try:
                datum = {
                    &quot;machine&quot;: tokens[0],
                    &quot;state&quot;: &quot; &quot;.join(tokens[1:-1]),
                    &quot;provider&quot;: tokens[-1].lstrip(&quot;(&quot;).rstrip(&quot;)&quot;),
                    &quot;name&quot;: get_machine_id(tokens[0], cwd),
                }
                info.append(datum)
            except IndexError:
                pass
    return info


def init(
    name,  # Salt_id for created VM
    cwd=None,  # path to find Vagrantfile
    machine=&quot;&quot;,  # name of machine in Vagrantfile
    runas=None,  # username who owns Vagrant box
    start=False,  # start the machine when initialized
    vagrant_provider=&quot;&quot;,  # vagrant provider (default=virtualbox)
    vm=None,  # a dictionary of VM configuration settings
):
    &quot;&quot;&quot;
    Initialize a new Vagrant VM.

    This inputs all the information needed to start a Vagrant VM.  These settings are stored in
    a Salt sdb database on the Vagrant host minion and used to start, control, and query the
    guest VMs. The salt_id assigned here is the key field for that database and must be unique.

    :param name: The salt_id name you will use to control this VM
    :param cwd: The path to the directory where the Vagrantfile is located
    :param machine: The machine name in the Vagrantfile. If blank, the primary machine will be used.
    :param runas: The username on the host who owns the Vagrant work files.
    :param start: (default: False) Start the virtual machine now.
    :param vagrant_provider: The name of a Vagrant VM provider (if not the default).
    :param vm: Optionally, all the above information may be supplied in this dictionary.
    :return: A string indicating success, or False.

    CLI Example:

    .. code-block:: bash

        salt &lt;host&gt; vagrant.init &lt;salt_id&gt; /path/to/Vagrantfile
        salt my_laptop vagrant.init x1 /projects/bevy_master machine=quail1
    &quot;&quot;&quot;
    vm_ = {} if vm is None else vm.copy()  # passed configuration data
    vm_[&quot;name&quot;] = name
    # passed-in keyword arguments overwrite vm dictionary values
    vm_[&quot;cwd&quot;] = cwd or vm_.get(&quot;cwd&quot;)
    if not vm_[&quot;cwd&quot;]:
        raise SaltInvocationError(
            'Path to Vagrantfile must be defined by &quot;cwd&quot; argument'
        )
    vm_[&quot;machine&quot;] = machine or vm_.get(&quot;machine&quot;, machine)
    vm_[&quot;runas&quot;] = runas or vm_.get(&quot;runas&quot;, runas)
    vm_[&quot;vagrant_provider&quot;] = vagrant_provider or vm_.get(&quot;vagrant_provider&quot;, &quot;&quot;)
    _update_vm_info(name, vm_)

    if start:
        log.debug(&quot;Starting VM %s&quot;, name)
        ret = _start(name, vm_)
    else:
        ret = &quot;Name {} defined using VM {}&quot;.format(name, vm_[&quot;machine&quot;] or &quot;(default)&quot;)
    return ret


def start(name):
    &quot;&quot;&quot;
    Start (vagrant up) a virtual machine defined by salt_id name.
    The machine must have been previously defined using &quot;vagrant.init&quot;.

    CLI Example:

    .. code-block:: bash

        salt &lt;host&gt; vagrant.start &lt;salt_id&gt;
    &quot;&quot;&quot;
    vm_ = get_vm_info(name)
    return _start(name, vm_)


def _start(
    name, vm_
):  # internal call name, because &quot;start&quot; is a keyword argument to vagrant.init

    try:
        machine = vm_[&quot;machine&quot;]
    except KeyError:
        raise SaltInvocationError(
<A NAME="0"></A>            &quot;No Vagrant machine defined for Salt_id {}&quot;.format(name)
        )

    vagrant_provider <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match94691-0.html#0',2,'match94691-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= vm_.get(&quot;vagrant_provider&quot;, &quot;&quot;)
    provider_ = &quot;--provider={}&quot;.format(vagrant_provider) if vagrant_provider else &quot;&quot;
    cmd = &quot;vagrant up {} {}&quot;.format(machine, provider_)
    ret = __salt__[&quot;cmd.run_all&quot;](
        cmd, runas=vm_.get(&quot;runas&quot;), cwd=vm_.get(</B></FONT>&quot;cwd&quot;), output_loglevel=&quot;info&quot;
    )

    if machine == &quot;&quot;:  # we were called using the default machine
        for line in ret[&quot;stdout&quot;].split(&quot;\n&quot;):  # find its actual Vagrant name
            if line.startswith(&quot;==&gt;&quot;):
                machine = line.split()[1].rstrip(&quot;:&quot;)
                vm_[&quot;machine&quot;] = machine
                _update_vm_info(name, vm_)  # and remember the true name
                break

    if ret[&quot;retcode&quot;] == 0:
        return 'Started &quot;{}&quot; using Vagrant machine &quot;{}&quot;.'.format(name, machine)
    return False


def shutdown(name):
    &quot;&quot;&quot;
    Send a soft shutdown (vagrant halt) signal to the named vm.

    This does the same thing as vagrant.stop. Other-VM control
    modules use &quot;stop&quot; and &quot;shutdown&quot; to differentiate between
    hard and soft shutdowns.

    CLI Example:

    .. code-block:: bash

        salt &lt;host&gt; vagrant.shutdown &lt;salt_id&gt;
    &quot;&quot;&quot;
    return stop(name)


def stop(name):
    &quot;&quot;&quot;
    Hard shutdown the virtual machine. (vagrant halt)

    CLI Example:

    .. code-block:: bash

        salt &lt;host&gt; vagrant.stop &lt;salt_id&gt;
    &quot;&quot;&quot;
<A NAME="5"></A>    vm_ = get_vm_info(name)
    machine = vm_[&quot;machine&quot;]

    cmd <FONT color="#151b8d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match94691-0.html#5',2,'match94691-top.html#5',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= &quot;vagrant halt {}&quot;.format(machine)
    ret = __salt__[&quot;cmd.retcode&quot;](cmd, runas=vm_.get(&quot;runas&quot;), cwd=vm_.get(</B></FONT>&quot;cwd&quot;))
    return ret == 0


def pause(name):
    &quot;&quot;&quot;
    Pause (vagrant suspend) the named VM.

    CLI Example:

    .. code-block:: bash

        salt &lt;host&gt; vagrant.pause &lt;salt_id&gt;
    &quot;&quot;&quot;
<A NAME="4"></A>    vm_ = get_vm_info(name)
    machine = vm_[&quot;machine&quot;]

    cmd <FONT color="#6cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match94691-0.html#4',2,'match94691-top.html#4',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= &quot;vagrant suspend {}&quot;.format(machine)
    ret = __salt__[&quot;cmd.retcode&quot;](cmd, runas=vm_.get(&quot;runas&quot;), cwd=vm_.get(</B></FONT>&quot;cwd&quot;))
    return ret == 0


def reboot(name, provision=False):
    &quot;&quot;&quot;
    Reboot a VM. (vagrant reload)

    CLI Example:

    .. code-block:: bash

        salt &lt;host&gt; vagrant.reboot &lt;salt_id&gt; provision=True

    :param name: The salt_id name you will use to control this VM
    :param provision: (False) also re-run the Vagrant provisioning scripts.
    &quot;&quot;&quot;
    vm_ = get_vm_info(name)
<A NAME="3"></A>    machine = vm_[&quot;machine&quot;]
    prov = &quot;--provision&quot; if provision else &quot;&quot;

    cmd <FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match94691-0.html#3',2,'match94691-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= &quot;vagrant reload {} {}&quot;.format(machine, prov)
    ret = __salt__[&quot;cmd.retcode&quot;](cmd, runas=vm_.get(&quot;runas&quot;), cwd=vm_.get(</B></FONT>&quot;cwd&quot;))
    return ret == 0


def destroy(name):
    &quot;&quot;&quot;
    Destroy and delete a virtual machine. (vagrant destroy -f)

    This also removes the salt_id name defined by vagrant.init.

    CLI Example:

    .. code-block:: bash

        salt &lt;host&gt; vagrant.destroy &lt;salt_id&gt;
    &quot;&quot;&quot;
<A NAME="2"></A>    vm_ = get_vm_info(name)
    machine = vm_[&quot;machine&quot;]

    cmd <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match94691-0.html#2',2,'match94691-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>= &quot;vagrant destroy -f {}&quot;.format(machine)

    ret = __salt__[&quot;cmd.run_all&quot;](
        cmd, runas=vm_.get(&quot;runas&quot;), cwd=vm_.get(&quot;cwd&quot;), output_loglevel=</B></FONT>&quot;info&quot;
    )
    if ret[&quot;retcode&quot;] == 0:
        _erase_vm_info(name)
        return &quot;Destroyed VM {}&quot;.format(name)
    return False


def get_ssh_config(name, network_mask=&quot;&quot;, get_private_key=False):
    r&quot;&quot;&quot;
    Retrieve hints of how you might connect to a Vagrant VM.

    :param name: the salt_id of the machine
    :param network_mask: a CIDR mask to search for the VM's address
    :param get_private_key: (default: False) return the key used for ssh login
    :return: a dict of ssh login information for the VM

    CLI Example:

    .. code-block:: bash

        salt &lt;host&gt; vagrant.get_ssh_config &lt;salt_id&gt;
        salt my_laptop vagrant.get_ssh_config quail1 network_mask=10.0.0.0/8 get_private_key=True

    The returned dictionary contains:

    - key_filename:  the name of the private key file on the VM host computer
    - ssh_username:  the username to be used to log in to the VM
    - ssh_host:  the IP address used to log in to the VM.  (This will usually be `127.0.0.1`)
    - ssh_port:  the TCP port used to log in to the VM.  (This will often be `2222`)
    - \[ip_address:\]  (if `network_mask` is defined. see below)
    - \[private_key:\]  (if `get_private_key` is True) the private key for ssh_username

    About `network_mask`:

    Vagrant usually uses a redirected TCP port on its host computer to log in to a VM using ssh.
    This redirected port and its IP address are &quot;ssh_port&quot; and &quot;ssh_host&quot;.  The ssh_host is
    usually the localhost (127.0.0.1).
    This makes it impossible for a third machine (such as a salt-cloud master) to contact the VM
    unless the VM has another network interface defined.  You will usually want a bridged network
    defined by having a `config.vm.network &quot;public_network&quot;` statement in your `Vagrantfile`.

    The IP address of the bridged adapter will typically be assigned by DHCP and unknown to you,
    but you should be able to determine what IP network the address will be chosen from.
    If you enter a CIDR network mask, Salt will attempt to find the VM's address for you.
    The host machine will send an &quot;ifconfig&quot; command to the VM (using ssh to `ssh_host`:`ssh_port`)
    and return the IP address of the first interface it can find which matches your mask.
    &quot;&quot;&quot;
    vm_ = get_vm_info(name)

    ssh_config = _vagrant_ssh_config(vm_)

    try:
        ans = {
            &quot;key_filename&quot;: ssh_config[&quot;IdentityFile&quot;],
            &quot;ssh_username&quot;: ssh_config[&quot;User&quot;],
            &quot;ssh_host&quot;: ssh_config[&quot;HostName&quot;],
            &quot;ssh_port&quot;: ssh_config[&quot;Port&quot;],
        }

    except KeyError:
        raise CommandExecutionError(
            &quot;Insufficient SSH information to contact VM {}. Is it running?&quot;.format(
                vm_.get(&quot;machine&quot;, &quot;(default)&quot;)
            )
        )

    if network_mask:
        #  ask the new VM to report its network address
        command = (
            &quot;ssh -i {IdentityFile} -p {Port} &quot;
            &quot;-oStrictHostKeyChecking={StrictHostKeyChecking} &quot;
            &quot;-oUserKnownHostsFile={UserKnownHostsFile} &quot;
            &quot;-oControlPath=none &quot;
            &quot;{User}@{HostName} ifconfig&quot;.format(**ssh_config)
        )

        log.info(&quot;Trying ssh -p %(Port)s %(User)s@%(HostName)s ifconfig&quot;, ssh_config)
        reply = __salt__[&quot;cmd.shell&quot;](command)
        log.info(&quot;---&gt;\n%s&quot;, reply)
        target_network_range = ipaddress.ip_network(network_mask, strict=False)

        for line in reply.split(&quot;\n&quot;):
            try:  # try to find a bridged network address
                # the lines we are looking for appear like:
                #    &quot;inet addr:10.124.31.185  Bcast:10.124.31.255  Mask:255.255.248.0&quot;
                # or &quot;inet6 addr: fe80::a00:27ff:fe04:7aac/64 Scope:Link&quot;
                tokens = line.replace(
                    &quot;addr:&quot;, &quot;&quot;, 1
                ).split()  # remove &quot;addr:&quot; if it exists, then split
                found_address = None
                if &quot;inet&quot; in tokens:
                    nxt = tokens.index(&quot;inet&quot;) + 1
                    found_address = ipaddress.ip_address(tokens[nxt])
                elif &quot;inet6&quot; in tokens:
                    nxt = tokens.index(&quot;inet6&quot;) + 1
                    found_address = ipaddress.ip_address(tokens[nxt].split(&quot;/&quot;)[0])
                if found_address in target_network_range:
                    ans[&quot;ip_address&quot;] = str(found_address)
                    break  # we have located a good matching address
            except (IndexError, AttributeError, TypeError):
                pass  # all syntax and type errors loop here
                # falling out if the loop leaves us remembering the last candidate
        log.info(
            &quot;Network IP address in %s detected as: %s&quot;,
            target_network_range,
            ans.get(&quot;ip_address&quot;, &quot;(not found)&quot;),
        )

    if get_private_key:
        # retrieve the Vagrant private key from the host
        try:
            with salt.utils.files.fopen(ssh_config[&quot;IdentityFile&quot;]) as pks:
                ans[&quot;private_key&quot;] = salt.utils.stringutils.to_unicode(pks.read())
        except OSError as e:
            raise CommandExecutionError(
                &quot;Error processing Vagrant private key file: {}&quot;.format(e)
            )
    return ans
</PRE>
</div>
  </div>
</body>
</html>
