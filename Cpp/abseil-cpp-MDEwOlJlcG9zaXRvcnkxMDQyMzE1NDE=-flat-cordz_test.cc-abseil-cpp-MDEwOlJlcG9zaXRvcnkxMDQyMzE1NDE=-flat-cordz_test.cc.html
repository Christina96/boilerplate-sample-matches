
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 189, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-cordz_test.cc</h3>
            <pre><code>1  #include <cstdint>
2  #include <string>
3  #include "gmock/gmock.h"
4  #include "gtest/gtest.h"
5  #include "absl/base/config.h"
6  #include "absl/base/internal/raw_logging.h"
7  #include "absl/base/macros.h"
8  #include "absl/strings/cord.h"
9  #include "absl/strings/cord_test_helpers.h"
10  #include "absl/strings/cordz_test_helpers.h"
11  #include "absl/strings/internal/cordz_functions.h"
12  #include "absl/strings/internal/cordz_info.h"
13  #include "absl/strings/internal/cordz_sample_token.h"
14  #include "absl/strings/internal/cordz_statistics.h"
15  #include "absl/strings/internal/cordz_update_tracker.h"
16  #include "absl/strings/str_cat.h"
17  #include "absl/strings/string_view.h"
18  #ifdef ABSL_INTERNAL_CORDZ_ENABLED
19  using testing::Eq;
20  using testing::AnyOf;
21  namespace absl {
22  ABSL_NAMESPACE_BEGIN
23  using cord_internal::CordzInfo;
24  using cord_internal::CordzSampleToken;
25  using cord_internal::CordzStatistics;
26  using cord_internal::CordzUpdateTracker;
27  using Method = CordzUpdateTracker::MethodIdentifier;
28  inline void PrintTo(const Cord& cord, std::ostream* s) {
29    if (s) *s << "Cord[" << cord.size() << "]";
30  }
31  namespace {
32  auto constexpr kMaxInline = cord_internal::kMaxInline;
33  absl::string_view MakeString(size_t size) {
34    thread_local std::string str;
35    str = std::string(size, '.');
36    return str;
37  }
38  absl::string_view MakeString(TestCordSize size) {
39    return MakeString(Length(size));
40  }
41  absl::Cord MakeAppendStringCord(TestCordSize size) {
42    CordzSamplingIntervalHelper always(1);
43    absl::Cord cord;
44    cord.Append(MakeString(size));
45    return cord;
46  }
47  std::string TestParamToString(::testing::TestParamInfo<TestCordSize> size) {
48    return absl::StrCat("On", ToString(size.param), "Cord");
49  }
50  class CordzUpdateTest : public testing::TestWithParam<TestCordSize> {
51   public:
52    Cord& cord() { return cord_; }
53    Method InitialOr(Method method) const {
54      return (GetParam() > TestCordSize::kInlined) ? Method::kConstructorString
55                                                   : method;
56    }
57   private:
58    CordzSamplingIntervalHelper sample_every_{1};
59    Cord cord_{MakeString(GetParam())};
60  };
61  template <typename T>
62  std::string ParamToString(::testing::TestParamInfo<T> param) {
63    return std::string(ToString(param.param));
64  }
65  INSTANTIATE_TEST_SUITE_P(WithParam, CordzUpdateTest,
66                           testing::Values(TestCordSize::kEmpty,
67                                           TestCordSize::kInlined,
68                                           TestCordSize::kLarge),
69                           TestParamToString);
70  class CordzStringTest : public testing::TestWithParam<TestCordSize> {
71   private:
72    CordzSamplingIntervalHelper sample_every_{1};
73  };
74  INSTANTIATE_TEST_SUITE_P(WithParam, CordzStringTest,
75                           testing::Values(TestCordSize::kInlined,
76                                           TestCordSize::kStringSso1,
77                                           TestCordSize::kStringSso2,
78                                           TestCordSize::kSmall,
79                                           TestCordSize::kLarge),
80                           ParamToString<TestCordSize>);
81  TEST(CordzTest, ConstructSmallArray) {
82    CordzSamplingIntervalHelper sample_every{1};
83    Cord cord(MakeString(TestCordSize::kSmall));
84    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
85  }
86  TEST(CordzTest, ConstructLargeArray) {
87    CordzSamplingIntervalHelper sample_every{1};
88    Cord cord(MakeString(TestCordSize::kLarge));
89    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
90  }
91  TEST_P(CordzStringTest, ConstructString) {
92    CordzSamplingIntervalHelper sample_every{1};
93    Cord cord(std::string(Length(GetParam()), '.'));
94    if (Length(GetParam()) > kMaxInline) {
95      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
96    }
97  }
98  TEST(CordzTest, CopyConstructFromUnsampled) {
99    CordzSamplingIntervalHelper sample_every{1};
100    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
101    Cord cord(src);
102    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
103  }
104  TEST(CordzTest, CopyConstructFromSampled) {
105    CordzSamplingIntervalHelper sample_never{99999};
106    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
107    Cord cord(src);
108    ASSERT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorCord));
109    CordzStatistics stats = GetCordzInfoForTesting(cord)->GetCordzStatistics();
110    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
111    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
112  }
113  TEST(CordzTest, MoveConstruct) {
114    CordzSamplingIntervalHelper sample_every{1};
115    Cord src(MakeString(TestCordSize::kLarge));
116    Cord cord(std::move(src));
117    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
118  }
119  TEST_P(CordzUpdateTest, AssignUnsampledCord) {
120    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
121    const CordzInfo* info = GetCordzInfoForTesting(cord());
122    cord() = src;
123    EXPECT_THAT(GetCordzInfoForTesting(cord()), Eq(nullptr));
124    EXPECT_FALSE(CordzInfoIsListed(info));
125  }
126  TEST_P(CordzUpdateTest, AssignSampledCord) {
127    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
128    cord() = src;
129    ASSERT_THAT(cord(), HasValidCordzInfoOf(Method::kAssignCord));
130    CordzStatistics stats = GetCordzInfoForTesting(cord())->GetCordzStatistics();
131    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
132    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
133    EXPECT_THAT(stats.update_tracker.Value(Method::kConstructorString), Eq(0));
134  }
135  TEST(CordzUpdateTest, AssignSampledCordToInlined) {
136    CordzSamplingIntervalHelper sample_never{99999};
137    Cord cord;
138    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
139    cord = src;
140    ASSERT_THAT(cord, HasValidCordzInfoOf(Method::kAssignCord));
141    CordzStatistics stats = GetCordzInfoForTesting(cord)->GetCordzStatistics();
142    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
143    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
144    EXPECT_THAT(stats.update_tracker.Value(Method::kConstructorString), Eq(0));
145  }
146  TEST(CordzUpdateTest, AssignSampledCordToUnsampledCord) {
147    CordzSamplingIntervalHelper sample_never{99999};
148    Cord cord = UnsampledCord(MakeString(TestCordSize::kLarge));
149    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
150    cord = src;
151    ASSERT_THAT(cord, HasValidCordzInfoOf(Method::kAssignCord));
152    CordzStatistics stats = GetCordzInfoForTesting(cord)->GetCordzStatistics();
153    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
154    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
155    EXPECT_THAT(stats.update_tracker.Value(Method::kConstructorString), Eq(0));
156  }
157  TEST(CordzUpdateTest, AssignUnsampledCordToSampledCordWithoutSampling) {
158    CordzSamplingIntervalHelper sample_never{99999};
159    Cord cord = MakeAppendStringCord(TestCordSize::kLarge);
160    const CordzInfo* info = GetCordzInfoForTesting(cord);
161    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
162    cord = src;
163    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
164    EXPECT_FALSE(CordzInfoIsListed(info));
165  }
166  TEST(CordzUpdateTest, AssignUnsampledCordToSampledCordWithSampling) {
167    CordzSamplingIntervalHelper sample_every{1};
168    Cord cord = MakeAppendStringCord(TestCordSize::kLarge);
169    const CordzInfo* info = GetCordzInfoForTesting(cord);
170    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
171    cord = src;
172    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
173    EXPECT_FALSE(CordzInfoIsListed(info));
174  }
175  TEST(CordzUpdateTest, AssignSampledCordToSampledCord) {
176    CordzSamplingIntervalHelper sample_every{1};
177    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
178    Cord cord(MakeString(TestCordSize::kLarge));
179    cord = src;
180    ASSERT_THAT(cord, HasValidCordzInfoOf(Method::kAssignCord));
181    CordzStatistics stats = GetCordzInfoForTesting(cord)->GetCordzStatistics();
182    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
183    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
184    EXPECT_THAT(stats.update_tracker.Value(Method::kConstructorString), Eq(0));
185  }
186  TEST(CordzUpdateTest, AssignUnsampledCordToSampledCord) {
187    CordzSamplingIntervalHelper sample_every{1};
188    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
189    Cord cord(MakeString(TestCordSize::kLarge));
190    cord = src;
191    ASSERT_THAT(cord, HasValidCordzInfoOf(Method::kAssignCord));
192    CordzStatistics stats = GetCordzInfoForTesting(cord)->GetCordzStatistics();
193    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
194    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
195    EXPECT_THAT(stats.update_tracker.Value(Method::kConstructorString), Eq(0));
196  }
197  TEST(CordzTest, AssignInlinedCordToSampledCord) {
198    CordzSampleToken token;
199    CordzSamplingIntervalHelper sample_every{1};
200    Cord cord(MakeString(TestCordSize::kLarge));
201    const CordzInfo* info = GetCordzInfoForTesting(cord);
202    Cord src = UnsampledCord(MakeString(TestCordSize::kInlined));
203    cord = src;
204    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
205    EXPECT_FALSE(CordzInfoIsListed(info));
206  }
207  TEST(CordzUpdateTest, MoveAssignCord) {
208    CordzSamplingIntervalHelper sample_every{1};
209    Cord cord;
210    Cord src(MakeString(TestCordSize::kLarge));
211    cord = std::move(src);
212    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
213  }
214  TEST_P(CordzUpdateTest, AssignLargeArray) {
215    cord() = MakeString(TestCordSize::kSmall);
216    EXPECT_THAT(cord(), HasValidCordzInfoOf(Method::kAssignString));
217  }
218  TEST_P(CordzUpdateTest, AssignSmallArray) {
219    cord() = MakeString(TestCordSize::kSmall);
220    EXPECT_THAT(cord(), HasValidCordzInfoOf(Method::kAssignString));
221  }
222  TEST_P(CordzUpdateTest, AssignInlinedArray) {
223    cord() = MakeString(TestCordSize::kInlined);
224    EXPECT_THAT(GetCordzInfoForTesting(cord()), Eq(nullptr));
225  }
226  TEST_P(CordzStringTest, AssignStringToInlined) {
227    Cord cord;
228    cord = std::string(Length(GetParam()), '.');
229    if (Length(GetParam()) > kMaxInline) {
230      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kAssignString));
231    }
232  }
233  TEST_P(CordzStringTest, AssignStringToCord) {
234    Cord cord(MakeString(TestCordSize::kLarge));
235    cord = std::string(Length(GetParam()), '.');
236    if (Length(GetParam()) > kMaxInline) {
237      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
238      EXPECT_THAT(cord, CordzMethodCountEq(Method::kAssignString, 1));
239    }
240  }
241  TEST_P(CordzUpdateTest, AssignInlinedString) {
242    cord() = std::string(Length(TestCordSize::kInlined), '.');
243    EXPECT_THAT(GetCordzInfoForTesting(cord()), Eq(nullptr));
244  }
245  TEST_P(CordzUpdateTest, AppendCord) {
246    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
247    cord().Append(src);
248    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kAppendCord)));
249  }
250  TEST_P(CordzUpdateTest, MoveAppendCord) {
251    cord().Append(UnsampledCord(MakeString(TestCordSize::kLarge)));
252    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kAppendCord)));
253  }
254  TEST_P(CordzUpdateTest, AppendSmallArray) {
255    cord().Append(MakeString(TestCordSize::kSmall));
256    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kAppendString)));
257  }
258  TEST_P(CordzUpdateTest, AppendLargeArray) {
259    cord().Append(MakeString(TestCordSize::kLarge));
260    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kAppendString)));
261  }
262  TEST_P(CordzStringTest, AppendStringToEmpty) {
<span onclick='openModal()' class='match'>263    Cord cord;
264    cord.Append(std::string(Length(GetParam()), '.'));
265    if (Length(GetParam()) > kMaxInline) {
266      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kAppendString));
267    }
268  }
269  TEST_P(CordzStringTest, AppendStringToInlined) {
270    Cord cord(MakeString(TestCordSize::kInlined));
271    cord.Append(std::string(Length(GetParam()), '.'));
272    if (Length(TestCordSize::kInlined) + Length(GetParam()) > kMaxInline) {
273      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kAppendString));
274    }
275  }
276  TEST_P(CordzStringTest, AppendStringToCord) {
277    Cord cord(MakeString(TestCordSize::kLarge));
278    cord.Append(std::string(Length(GetParam()), '.'));
279    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
280    EXPECT_THAT(cord, CordzMethodCountEq(Method::kAppendString, 1));
281  }
282  TEST(CordzTest, MakeCordFromExternal) {
283    CordzSamplingIntervalHelper sample_every{1};
</span>284    Cord cord = MakeCordFromExternal("Hello world", [](absl::string_view) {});
285    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kMakeCordFromExternal));
286  }
287  TEST(CordzTest, MakeCordFromEmptyExternal) {
288    CordzSamplingIntervalHelper sample_every{1};
289    Cord cord = MakeCordFromExternal({}, [](absl::string_view) {});
290    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
291  }
292  TEST_P(CordzUpdateTest, PrependCord) {
293    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
294    cord().Prepend(src);
295    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kPrependCord)));
296  }
297  TEST_P(CordzUpdateTest, PrependSmallArray) {
298    cord().Prepend(MakeString(TestCordSize::kSmall));
299    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kPrependString)));
300  }
301  TEST_P(CordzUpdateTest, PrependLargeArray) {
302    cord().Prepend(MakeString(TestCordSize::kLarge));
303    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kPrependString)));
304  }
305  TEST_P(CordzStringTest, PrependStringToEmpty) {
306    Cord cord;
307    cord.Prepend(std::string(Length(GetParam()), '.'));
308    if (Length(GetParam()) > kMaxInline) {
309      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kPrependString));
310    }
311  }
312  TEST_P(CordzStringTest, PrependStringToInlined) {
313    Cord cord(MakeString(TestCordSize::kInlined));
314    cord.Prepend(std::string(Length(GetParam()), '.'));
315    if (Length(TestCordSize::kInlined) + Length(GetParam()) > kMaxInline) {
316      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kPrependString));
317    }
318  }
319  TEST_P(CordzStringTest, PrependStringToCord) {
320    Cord cord(MakeString(TestCordSize::kLarge));
321    cord.Prepend(std::string(Length(GetParam()), '.'));
322    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
323    EXPECT_THAT(cord, CordzMethodCountEq(Method::kPrependString, 1));
324  }
325  TEST(CordzTest, RemovePrefix) {
326    CordzSamplingIntervalHelper sample_every(1);
327    Cord cord(MakeString(TestCordSize::kLarge));
328    cord.RemovePrefix(cord.size() / 2);
329    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
330    EXPECT_THAT(cord, CordzMethodCountEq(Method::kRemovePrefix, 1));
331    cord.RemovePrefix(cord.size() - kMaxInline);
332    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
333    EXPECT_THAT(cord, CordzMethodCountEq(Method::kRemovePrefix, 2));
334    cord.RemovePrefix(cord.size());
335    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
336  }
337  TEST(CordzTest, RemoveSuffix) {
338    CordzSamplingIntervalHelper sample_every(1);
339    Cord cord(MakeString(TestCordSize::kLarge));
340    cord.RemoveSuffix(cord.size() / 2);
341    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
342    EXPECT_THAT(cord, CordzMethodCountEq(Method::kRemoveSuffix, 1));
343    cord.RemoveSuffix(cord.size() - kMaxInline);
344    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
345    EXPECT_THAT(cord, CordzMethodCountEq(Method::kRemoveSuffix, 2));
346    cord.RemoveSuffix(cord.size());
347    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
348  }
349  TEST(CordzTest, SubCordFromUnsampledCord) {
350    CordzSamplingIntervalHelper sample_every{1};
351    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
352    Cord cord = src.Subcord(10, src.size() / 2);
353    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
354  }
355  TEST(CordzTest, SubCordFromSampledCord) {
356    CordzSamplingIntervalHelper sample_never{99999};
357    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
358    Cord cord = src.Subcord(10, src.size() / 2);
359    ASSERT_THAT(cord, HasValidCordzInfoOf(Method::kSubCord));
360    CordzStatistics stats = GetCordzInfoForTesting(cord)->GetCordzStatistics();
361    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
362    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
363  }
364  TEST(CordzTest, SmallSubCord) {
365    CordzSamplingIntervalHelper sample_never{99999};
366    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
367    Cord cord = src.Subcord(10, kMaxInline + 1);
368    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kSubCord));
369  }
370  }  
371  ABSL_NAMESPACE_END
372  }  
373  #endif  
</code></pre>
        </div>
        <div class="column">
            <h3>abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-cordz_test.cc</h3>
            <pre><code>1  #include <cstdint>
2  #include <string>
3  #include "gmock/gmock.h"
4  #include "gtest/gtest.h"
5  #include "absl/base/config.h"
6  #include "absl/base/internal/raw_logging.h"
7  #include "absl/base/macros.h"
8  #include "absl/strings/cord.h"
9  #include "absl/strings/cord_test_helpers.h"
10  #include "absl/strings/cordz_test_helpers.h"
11  #include "absl/strings/internal/cordz_functions.h"
12  #include "absl/strings/internal/cordz_info.h"
13  #include "absl/strings/internal/cordz_sample_token.h"
14  #include "absl/strings/internal/cordz_statistics.h"
15  #include "absl/strings/internal/cordz_update_tracker.h"
16  #include "absl/strings/str_cat.h"
17  #include "absl/strings/string_view.h"
18  #ifdef ABSL_INTERNAL_CORDZ_ENABLED
19  using testing::Eq;
20  using testing::AnyOf;
21  namespace absl {
22  ABSL_NAMESPACE_BEGIN
23  using cord_internal::CordzInfo;
24  using cord_internal::CordzSampleToken;
25  using cord_internal::CordzStatistics;
26  using cord_internal::CordzUpdateTracker;
27  using Method = CordzUpdateTracker::MethodIdentifier;
28  inline void PrintTo(const Cord& cord, std::ostream* s) {
29    if (s) *s << "Cord[" << cord.size() << "]";
30  }
31  namespace {
32  auto constexpr kMaxInline = cord_internal::kMaxInline;
33  absl::string_view MakeString(size_t size) {
34    thread_local std::string str;
35    str = std::string(size, '.');
36    return str;
37  }
38  absl::string_view MakeString(TestCordSize size) {
39    return MakeString(Length(size));
40  }
41  absl::Cord MakeAppendStringCord(TestCordSize size) {
42    CordzSamplingIntervalHelper always(1);
43    absl::Cord cord;
44    cord.Append(MakeString(size));
45    return cord;
46  }
47  std::string TestParamToString(::testing::TestParamInfo<TestCordSize> size) {
48    return absl::StrCat("On", ToString(size.param), "Cord");
49  }
50  class CordzUpdateTest : public testing::TestWithParam<TestCordSize> {
51   public:
52    Cord& cord() { return cord_; }
53    Method InitialOr(Method method) const {
54      return (GetParam() > TestCordSize::kInlined) ? Method::kConstructorString
55                                                   : method;
56    }
57   private:
58    CordzSamplingIntervalHelper sample_every_{1};
59    Cord cord_{MakeString(GetParam())};
60  };
61  template <typename T>
62  std::string ParamToString(::testing::TestParamInfo<T> param) {
63    return std::string(ToString(param.param));
64  }
65  INSTANTIATE_TEST_SUITE_P(WithParam, CordzUpdateTest,
66                           testing::Values(TestCordSize::kEmpty,
67                                           TestCordSize::kInlined,
68                                           TestCordSize::kLarge),
69                           TestParamToString);
70  class CordzStringTest : public testing::TestWithParam<TestCordSize> {
71   private:
72    CordzSamplingIntervalHelper sample_every_{1};
73  };
74  INSTANTIATE_TEST_SUITE_P(WithParam, CordzStringTest,
75                           testing::Values(TestCordSize::kInlined,
76                                           TestCordSize::kStringSso1,
77                                           TestCordSize::kStringSso2,
78                                           TestCordSize::kSmall,
79                                           TestCordSize::kLarge),
80                           ParamToString<TestCordSize>);
81  TEST(CordzTest, ConstructSmallArray) {
82    CordzSamplingIntervalHelper sample_every{1};
83    Cord cord(MakeString(TestCordSize::kSmall));
84    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
85  }
86  TEST(CordzTest, ConstructLargeArray) {
87    CordzSamplingIntervalHelper sample_every{1};
88    Cord cord(MakeString(TestCordSize::kLarge));
89    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
90  }
91  TEST_P(CordzStringTest, ConstructString) {
92    CordzSamplingIntervalHelper sample_every{1};
93    Cord cord(std::string(Length(GetParam()), '.'));
94    if (Length(GetParam()) > kMaxInline) {
95      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
96    }
97  }
98  TEST(CordzTest, CopyConstructFromUnsampled) {
99    CordzSamplingIntervalHelper sample_every{1};
100    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
101    Cord cord(src);
102    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
103  }
104  TEST(CordzTest, CopyConstructFromSampled) {
105    CordzSamplingIntervalHelper sample_never{99999};
106    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
107    Cord cord(src);
108    ASSERT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorCord));
109    CordzStatistics stats = GetCordzInfoForTesting(cord)->GetCordzStatistics();
110    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
111    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
112  }
113  TEST(CordzTest, MoveConstruct) {
114    CordzSamplingIntervalHelper sample_every{1};
115    Cord src(MakeString(TestCordSize::kLarge));
116    Cord cord(std::move(src));
117    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
118  }
119  TEST_P(CordzUpdateTest, AssignUnsampledCord) {
120    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
121    const CordzInfo* info = GetCordzInfoForTesting(cord());
122    cord() = src;
123    EXPECT_THAT(GetCordzInfoForTesting(cord()), Eq(nullptr));
124    EXPECT_FALSE(CordzInfoIsListed(info));
125  }
126  TEST_P(CordzUpdateTest, AssignSampledCord) {
127    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
128    cord() = src;
129    ASSERT_THAT(cord(), HasValidCordzInfoOf(Method::kAssignCord));
130    CordzStatistics stats = GetCordzInfoForTesting(cord())->GetCordzStatistics();
131    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
132    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
133    EXPECT_THAT(stats.update_tracker.Value(Method::kConstructorString), Eq(0));
134  }
135  TEST(CordzUpdateTest, AssignSampledCordToInlined) {
136    CordzSamplingIntervalHelper sample_never{99999};
137    Cord cord;
138    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
139    cord = src;
140    ASSERT_THAT(cord, HasValidCordzInfoOf(Method::kAssignCord));
141    CordzStatistics stats = GetCordzInfoForTesting(cord)->GetCordzStatistics();
142    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
143    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
144    EXPECT_THAT(stats.update_tracker.Value(Method::kConstructorString), Eq(0));
145  }
146  TEST(CordzUpdateTest, AssignSampledCordToUnsampledCord) {
147    CordzSamplingIntervalHelper sample_never{99999};
148    Cord cord = UnsampledCord(MakeString(TestCordSize::kLarge));
149    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
150    cord = src;
151    ASSERT_THAT(cord, HasValidCordzInfoOf(Method::kAssignCord));
152    CordzStatistics stats = GetCordzInfoForTesting(cord)->GetCordzStatistics();
153    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
154    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
155    EXPECT_THAT(stats.update_tracker.Value(Method::kConstructorString), Eq(0));
156  }
157  TEST(CordzUpdateTest, AssignUnsampledCordToSampledCordWithoutSampling) {
158    CordzSamplingIntervalHelper sample_never{99999};
159    Cord cord = MakeAppendStringCord(TestCordSize::kLarge);
160    const CordzInfo* info = GetCordzInfoForTesting(cord);
161    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
162    cord = src;
163    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
164    EXPECT_FALSE(CordzInfoIsListed(info));
165  }
166  TEST(CordzUpdateTest, AssignUnsampledCordToSampledCordWithSampling) {
167    CordzSamplingIntervalHelper sample_every{1};
168    Cord cord = MakeAppendStringCord(TestCordSize::kLarge);
169    const CordzInfo* info = GetCordzInfoForTesting(cord);
170    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
171    cord = src;
172    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
173    EXPECT_FALSE(CordzInfoIsListed(info));
174  }
175  TEST(CordzUpdateTest, AssignSampledCordToSampledCord) {
176    CordzSamplingIntervalHelper sample_every{1};
177    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
178    Cord cord(MakeString(TestCordSize::kLarge));
179    cord = src;
180    ASSERT_THAT(cord, HasValidCordzInfoOf(Method::kAssignCord));
181    CordzStatistics stats = GetCordzInfoForTesting(cord)->GetCordzStatistics();
182    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
183    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
184    EXPECT_THAT(stats.update_tracker.Value(Method::kConstructorString), Eq(0));
185  }
186  TEST(CordzUpdateTest, AssignUnsampledCordToSampledCord) {
187    CordzSamplingIntervalHelper sample_every{1};
188    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
189    Cord cord(MakeString(TestCordSize::kLarge));
190    cord = src;
191    ASSERT_THAT(cord, HasValidCordzInfoOf(Method::kAssignCord));
192    CordzStatistics stats = GetCordzInfoForTesting(cord)->GetCordzStatistics();
193    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
194    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
195    EXPECT_THAT(stats.update_tracker.Value(Method::kConstructorString), Eq(0));
196  }
197  TEST(CordzTest, AssignInlinedCordToSampledCord) {
198    CordzSampleToken token;
199    CordzSamplingIntervalHelper sample_every{1};
200    Cord cord(MakeString(TestCordSize::kLarge));
201    const CordzInfo* info = GetCordzInfoForTesting(cord);
202    Cord src = UnsampledCord(MakeString(TestCordSize::kInlined));
203    cord = src;
204    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
205    EXPECT_FALSE(CordzInfoIsListed(info));
206  }
207  TEST(CordzUpdateTest, MoveAssignCord) {
208    CordzSamplingIntervalHelper sample_every{1};
209    Cord cord;
210    Cord src(MakeString(TestCordSize::kLarge));
211    cord = std::move(src);
212    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
213  }
214  TEST_P(CordzUpdateTest, AssignLargeArray) {
215    cord() = MakeString(TestCordSize::kSmall);
216    EXPECT_THAT(cord(), HasValidCordzInfoOf(Method::kAssignString));
217  }
218  TEST_P(CordzUpdateTest, AssignSmallArray) {
219    cord() = MakeString(TestCordSize::kSmall);
220    EXPECT_THAT(cord(), HasValidCordzInfoOf(Method::kAssignString));
221  }
222  TEST_P(CordzUpdateTest, AssignInlinedArray) {
223    cord() = MakeString(TestCordSize::kInlined);
224    EXPECT_THAT(GetCordzInfoForTesting(cord()), Eq(nullptr));
225  }
226  TEST_P(CordzStringTest, AssignStringToInlined) {
227    Cord cord;
228    cord = std::string(Length(GetParam()), '.');
229    if (Length(GetParam()) > kMaxInline) {
230      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kAssignString));
231    }
232  }
233  TEST_P(CordzStringTest, AssignStringToCord) {
234    Cord cord(MakeString(TestCordSize::kLarge));
235    cord = std::string(Length(GetParam()), '.');
236    if (Length(GetParam()) > kMaxInline) {
237      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
238      EXPECT_THAT(cord, CordzMethodCountEq(Method::kAssignString, 1));
239    }
240  }
241  TEST_P(CordzUpdateTest, AssignInlinedString) {
242    cord() = std::string(Length(TestCordSize::kInlined), '.');
243    EXPECT_THAT(GetCordzInfoForTesting(cord()), Eq(nullptr));
244  }
245  TEST_P(CordzUpdateTest, AppendCord) {
246    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
247    cord().Append(src);
248    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kAppendCord)));
249  }
250  TEST_P(CordzUpdateTest, MoveAppendCord) {
251    cord().Append(UnsampledCord(MakeString(TestCordSize::kLarge)));
252    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kAppendCord)));
253  }
254  TEST_P(CordzUpdateTest, AppendSmallArray) {
255    cord().Append(MakeString(TestCordSize::kSmall));
256    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kAppendString)));
257  }
258  TEST_P(CordzUpdateTest, AppendLargeArray) {
259    cord().Append(MakeString(TestCordSize::kLarge));
260    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kAppendString)));
261  }
262  TEST_P(CordzStringTest, AppendStringToEmpty) {
263    Cord cord;
264    cord.Append(std::string(Length(GetParam()), '.'));
265    if (Length(GetParam()) > kMaxInline) {
266      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kAppendString));
267    }
268  }
269  TEST_P(CordzStringTest, AppendStringToInlined) {
270    Cord cord(MakeString(TestCordSize::kInlined));
271    cord.Append(std::string(Length(GetParam()), '.'));
272    if (Length(TestCordSize::kInlined) + Length(GetParam()) > kMaxInline) {
273      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kAppendString));
274    }
275  }
276  TEST_P(CordzStringTest, AppendStringToCord) {
277    Cord cord(MakeString(TestCordSize::kLarge));
278    cord.Append(std::string(Length(GetParam()), '.'));
279    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
280    EXPECT_THAT(cord, CordzMethodCountEq(Method::kAppendString, 1));
281  }
282  TEST(CordzTest, MakeCordFromExternal) {
283    CordzSamplingIntervalHelper sample_every{1};
284    Cord cord = MakeCordFromExternal("Hello world", [](absl::string_view) {});
285    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kMakeCordFromExternal));
286  }
287  TEST(CordzTest, MakeCordFromEmptyExternal) {
288    CordzSamplingIntervalHelper sample_every{1};
289    Cord cord = MakeCordFromExternal({}, [](absl::string_view) {});
290    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
291  }
292  TEST_P(CordzUpdateTest, PrependCord) {
293    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
294    cord().Prepend(src);
295    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kPrependCord)));
296  }
297  TEST_P(CordzUpdateTest, PrependSmallArray) {
298    cord().Prepend(MakeString(TestCordSize::kSmall));
299    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kPrependString)));
300  }
301  TEST_P(CordzUpdateTest, PrependLargeArray) {
302    cord().Prepend(MakeString(TestCordSize::kLarge));
303    EXPECT_THAT(cord(), HasValidCordzInfoOf(InitialOr(Method::kPrependString)));
304  }
305  TEST_P(CordzStringTest, PrependStringToEmpty) {
<span onclick='openModal()' class='match'>306    Cord cord;
307    cord.Prepend(std::string(Length(GetParam()), '.'));
308    if (Length(GetParam()) > kMaxInline) {
309      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kPrependString));
310    }
311  }
312  TEST_P(CordzStringTest, PrependStringToInlined) {
313    Cord cord(MakeString(TestCordSize::kInlined));
314    cord.Prepend(std::string(Length(GetParam()), '.'));
315    if (Length(TestCordSize::kInlined) + Length(GetParam()) > kMaxInline) {
316      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kPrependString));
317    }
318  }
319  TEST_P(CordzStringTest, PrependStringToCord) {
320    Cord cord(MakeString(TestCordSize::kLarge));
321    cord.Prepend(std::string(Length(GetParam()), '.'));
322    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
323    EXPECT_THAT(cord, CordzMethodCountEq(Method::kPrependString, 1));
324  }
325  TEST(CordzTest, RemovePrefix) {
326    CordzSamplingIntervalHelper sample_every(1);
</span>327    Cord cord(MakeString(TestCordSize::kLarge));
328    cord.RemovePrefix(cord.size() / 2);
329    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
330    EXPECT_THAT(cord, CordzMethodCountEq(Method::kRemovePrefix, 1));
331    cord.RemovePrefix(cord.size() - kMaxInline);
332    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
333    EXPECT_THAT(cord, CordzMethodCountEq(Method::kRemovePrefix, 2));
334    cord.RemovePrefix(cord.size());
335    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
336  }
337  TEST(CordzTest, RemoveSuffix) {
338    CordzSamplingIntervalHelper sample_every(1);
339    Cord cord(MakeString(TestCordSize::kLarge));
340    cord.RemoveSuffix(cord.size() / 2);
341    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
342    EXPECT_THAT(cord, CordzMethodCountEq(Method::kRemoveSuffix, 1));
343    cord.RemoveSuffix(cord.size() - kMaxInline);
344    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
345    EXPECT_THAT(cord, CordzMethodCountEq(Method::kRemoveSuffix, 2));
346    cord.RemoveSuffix(cord.size());
347    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
348  }
349  TEST(CordzTest, SubCordFromUnsampledCord) {
350    CordzSamplingIntervalHelper sample_every{1};
351    Cord src = UnsampledCord(MakeString(TestCordSize::kLarge));
352    Cord cord = src.Subcord(10, src.size() / 2);
353    EXPECT_THAT(GetCordzInfoForTesting(cord), Eq(nullptr));
354  }
355  TEST(CordzTest, SubCordFromSampledCord) {
356    CordzSamplingIntervalHelper sample_never{99999};
357    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
358    Cord cord = src.Subcord(10, src.size() / 2);
359    ASSERT_THAT(cord, HasValidCordzInfoOf(Method::kSubCord));
360    CordzStatistics stats = GetCordzInfoForTesting(cord)->GetCordzStatistics();
361    EXPECT_THAT(stats.parent_method, Eq(Method::kAppendString));
362    EXPECT_THAT(stats.update_tracker.Value(Method::kAppendString), Eq(1));
363  }
364  TEST(CordzTest, SmallSubCord) {
365    CordzSamplingIntervalHelper sample_never{99999};
366    Cord src = MakeAppendStringCord(TestCordSize::kLarge);
367    Cord cord = src.Subcord(10, kMaxInline + 1);
368    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kSubCord));
369  }
370  }  
371  ABSL_NAMESPACE_END
372  }  
373  #endif  
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-cordz_test.cc</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-cordz_test.cc</div>
                </div>
                <div class="column column_space"><pre><code>263    Cord cord;
264    cord.Append(std::string(Length(GetParam()), '.'));
265    if (Length(GetParam()) > kMaxInline) {
266      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kAppendString));
267    }
268  }
269  TEST_P(CordzStringTest, AppendStringToInlined) {
270    Cord cord(MakeString(TestCordSize::kInlined));
271    cord.Append(std::string(Length(GetParam()), '.'));
272    if (Length(TestCordSize::kInlined) + Length(GetParam()) > kMaxInline) {
273      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kAppendString));
274    }
275  }
276  TEST_P(CordzStringTest, AppendStringToCord) {
277    Cord cord(MakeString(TestCordSize::kLarge));
278    cord.Append(std::string(Length(GetParam()), '.'));
279    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
280    EXPECT_THAT(cord, CordzMethodCountEq(Method::kAppendString, 1));
281  }
282  TEST(CordzTest, MakeCordFromExternal) {
283    CordzSamplingIntervalHelper sample_every{1};
</pre></code></div>
                <div class="column column_space"><pre><code>306    Cord cord;
307    cord.Prepend(std::string(Length(GetParam()), '.'));
308    if (Length(GetParam()) > kMaxInline) {
309      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kPrependString));
310    }
311  }
312  TEST_P(CordzStringTest, PrependStringToInlined) {
313    Cord cord(MakeString(TestCordSize::kInlined));
314    cord.Prepend(std::string(Length(GetParam()), '.'));
315    if (Length(TestCordSize::kInlined) + Length(GetParam()) > kMaxInline) {
316      EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kPrependString));
317    }
318  }
319  TEST_P(CordzStringTest, PrependStringToCord) {
320    Cord cord(MakeString(TestCordSize::kLarge));
321    cord.Prepend(std::string(Length(GetParam()), '.'));
322    EXPECT_THAT(cord, HasValidCordzInfoOf(Method::kConstructorString));
323    EXPECT_THAT(cord, CordzMethodCountEq(Method::kPrependString, 1));
324  }
325  TEST(CordzTest, RemovePrefix) {
326    CordzSamplingIntervalHelper sample_every(1);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    