
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 20, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-layout_test.cc</h3>
            <pre><code>1  #include &quot;absl/container/internal/layout.h&quot;
2  #include &lt;stddef.h&gt;
3  #include &lt;cstdint&gt;
4  #include &lt;memory&gt;
5  #include &lt;sstream&gt;
6  #include &lt;type_traits&gt;
7  #include &quot;gmock/gmock.h&quot;
8  #include &quot;gtest/gtest.h&quot;
9  #include &quot;absl/base/config.h&quot;
10  #include &quot;absl/log/check.h&quot;
11  #include &quot;absl/types/span.h&quot;
12  namespace absl {
13  ABSL_NAMESPACE_BEGIN
14  namespace container_internal {
15  namespace {
16  using ::absl::Span;
17  using ::testing::ElementsAre;
18  size_t Distance(const void* from, const void* to) {
19    CHECK_LE(from, to) &lt;&lt; &quot;Distance must be non-negative&quot;;
20    return static_cast&lt;const char*&gt;(to) - static_cast&lt;const char*&gt;(from);
21  }
22  template &lt;class Expected, class Actual&gt;
23  Expected Type(Actual val) {
24    static_assert(std::is_same&lt;Expected, Actual&gt;(), &quot;&quot;);
25    return val;
26  }
27  struct alignas(8) Int128 {
28    uint64_t a, b;
29    friend bool operator==(Int128 lhs, Int128 rhs) {
30      return std::tie(lhs.a, lhs.b) == std::tie(rhs.a, rhs.b);
31    }
32    static std::string Name() {
33      return internal_layout::adl_barrier::TypeName&lt;Int128&gt;();
34    }
35  };
36  struct alignas(8) Int64 {
37    int64_t a;
38    friend bool operator==(Int64 lhs, Int64 rhs) {
39      return lhs.a == rhs.a;
40    }
41  };
42  static_assert(sizeof(int8_t) == 1, &quot;&quot;);
43  static_assert(alignof(int8_t) == 1, &quot;&quot;);
44  static_assert(sizeof(int16_t) == 2, &quot;&quot;);
45  static_assert(alignof(int16_t) == 2, &quot;&quot;);
46  static_assert(sizeof(int32_t) == 4, &quot;&quot;);
47  static_assert(alignof(int32_t) == 4, &quot;&quot;);
48  static_assert(sizeof(Int64) == 8, &quot;&quot;);
49  static_assert(alignof(Int64) == 8, &quot;&quot;);
50  static_assert(sizeof(Int128) == 16, &quot;&quot;);
51  static_assert(alignof(Int128) == 8, &quot;&quot;);
52  template &lt;class Expected, class Actual&gt;
53  void SameType() {
54    static_assert(std::is_same&lt;Expected, Actual&gt;(), &quot;&quot;);
55  }
56  TEST(Layout, ElementType) {
57    {
58      using L = Layout&lt;int32_t&gt;;
59      SameType&lt;int32_t, L::ElementType&lt;0&gt;&gt;();
60      SameType&lt;int32_t, decltype(L::Partial())::ElementType&lt;0&gt;&gt;();
61      SameType&lt;int32_t, decltype(L::Partial(0))::ElementType&lt;0&gt;&gt;();
62    }
63    {
64      using L = Layout&lt;int32_t, int32_t&gt;;
65      SameType&lt;int32_t, L::ElementType&lt;0&gt;&gt;();
66      SameType&lt;int32_t, L::ElementType&lt;1&gt;&gt;();
67      SameType&lt;int32_t, decltype(L::Partial())::ElementType&lt;0&gt;&gt;();
68      SameType&lt;int32_t, decltype(L::Partial())::ElementType&lt;1&gt;&gt;();
69      SameType&lt;int32_t, decltype(L::Partial(0))::ElementType&lt;0&gt;&gt;();
70      SameType&lt;int32_t, decltype(L::Partial(0))::ElementType&lt;1&gt;&gt;();
71    }
72    {
73      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
74      SameType&lt;int8_t, L::ElementType&lt;0&gt;&gt;();
75      SameType&lt;int32_t, L::ElementType&lt;1&gt;&gt;();
76      SameType&lt;Int128, L::ElementType&lt;2&gt;&gt;();
77      SameType&lt;int8_t, decltype(L::Partial())::ElementType&lt;0&gt;&gt;();
78      SameType&lt;int8_t, decltype(L::Partial(0))::ElementType&lt;0&gt;&gt;();
79      SameType&lt;int32_t, decltype(L::Partial(0))::ElementType&lt;1&gt;&gt;();
80      SameType&lt;int8_t, decltype(L::Partial(0, 0))::ElementType&lt;0&gt;&gt;();
81      SameType&lt;int32_t, decltype(L::Partial(0, 0))::ElementType&lt;1&gt;&gt;();
82      SameType&lt;Int128, decltype(L::Partial(0, 0))::ElementType&lt;2&gt;&gt;();
83      SameType&lt;int8_t, decltype(L::Partial(0, 0, 0))::ElementType&lt;0&gt;&gt;();
84      SameType&lt;int32_t, decltype(L::Partial(0, 0, 0))::ElementType&lt;1&gt;&gt;();
85      SameType&lt;Int128, decltype(L::Partial(0, 0, 0))::ElementType&lt;2&gt;&gt;();
86    }
87  }
88  TEST(Layout, ElementTypes) {
89    {
90      using L = Layout&lt;int32_t&gt;;
91      SameType&lt;std::tuple&lt;int32_t&gt;, L::ElementTypes&gt;();
92      SameType&lt;std::tuple&lt;int32_t&gt;, decltype(L::Partial())::ElementTypes&gt;();
93      SameType&lt;std::tuple&lt;int32_t&gt;, decltype(L::Partial(0))::ElementTypes&gt;();
94    }
95    {
96      using L = Layout&lt;int32_t, int32_t&gt;;
97      SameType&lt;std::tuple&lt;int32_t, int32_t&gt;, L::ElementTypes&gt;();
98      SameType&lt;std::tuple&lt;int32_t, int32_t&gt;,
99               decltype(L::Partial())::ElementTypes&gt;();
100      SameType&lt;std::tuple&lt;int32_t, int32_t&gt;,
101               decltype(L::Partial(0))::ElementTypes&gt;();
102    }
103    {
104      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
105      SameType&lt;std::tuple&lt;int8_t, int32_t, Int128&gt;, L::ElementTypes&gt;();
106      SameType&lt;std::tuple&lt;int8_t, int32_t, Int128&gt;,
107               decltype(L::Partial())::ElementTypes&gt;();
108      SameType&lt;std::tuple&lt;int8_t, int32_t, Int128&gt;,
109               decltype(L::Partial(0))::ElementTypes&gt;();
110      SameType&lt;std::tuple&lt;int8_t, int32_t, Int128&gt;,
111               decltype(L::Partial(0, 0))::ElementTypes&gt;();
112      SameType&lt;std::tuple&lt;int8_t, int32_t, Int128&gt;,
113               decltype(L::Partial(0, 0, 0))::ElementTypes&gt;();
114    }
115  }
116  TEST(Layout, OffsetByIndex) {
117    {
118      using L = Layout&lt;int32_t&gt;;
119      EXPECT_EQ(0, L::Partial().Offset&lt;0&gt;());
120      EXPECT_EQ(0, L::Partial(3).Offset&lt;0&gt;());
121      EXPECT_EQ(0, L(3).Offset&lt;0&gt;());
122    }
123    {
124      using L = Layout&lt;int32_t, int32_t&gt;;
125      EXPECT_EQ(0, L::Partial().Offset&lt;0&gt;());
126      EXPECT_EQ(0, L::Partial(3).Offset&lt;0&gt;());
127      EXPECT_EQ(12, L::Partial(3).Offset&lt;1&gt;());
128      EXPECT_EQ(0, L::Partial(3, 5).Offset&lt;0&gt;());
129      EXPECT_EQ(12, L::Partial(3, 5).Offset&lt;1&gt;());
130      EXPECT_EQ(0, L(3, 5).Offset&lt;0&gt;());
131      EXPECT_EQ(12, L(3, 5).Offset&lt;1&gt;());
132    }
133    {
134      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
135      EXPECT_EQ(0, L::Partial().Offset&lt;0&gt;());
136      EXPECT_EQ(0, L::Partial(0).Offset&lt;0&gt;());
137      EXPECT_EQ(0, L::Partial(0).Offset&lt;1&gt;());
138      EXPECT_EQ(0, L::Partial(1).Offset&lt;0&gt;());
139      EXPECT_EQ(4, L::Partial(1).Offset&lt;1&gt;());
140      EXPECT_EQ(0, L::Partial(5).Offset&lt;0&gt;());
141      EXPECT_EQ(8, L::Partial(5).Offset&lt;1&gt;());
142      EXPECT_EQ(0, L::Partial(0, 0).Offset&lt;0&gt;());
143      EXPECT_EQ(0, L::Partial(0, 0).Offset&lt;1&gt;());
144      EXPECT_EQ(0, L::Partial(0, 0).Offset&lt;2&gt;());
145      EXPECT_EQ(0, L::Partial(1, 0).Offset&lt;0&gt;());
146      EXPECT_EQ(4, L::Partial(1, 0).Offset&lt;1&gt;());
147      EXPECT_EQ(8, L::Partial(1, 0).Offset&lt;2&gt;());
148      EXPECT_EQ(0, L::Partial(5, 3).Offset&lt;0&gt;());
149      EXPECT_EQ(8, L::Partial(5, 3).Offset&lt;1&gt;());
150      EXPECT_EQ(24, L::Partial(5, 3).Offset&lt;2&gt;());
151      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset&lt;0&gt;());
152      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset&lt;1&gt;());
153      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset&lt;2&gt;());
154      EXPECT_EQ(0, L::Partial(1, 0, 0).Offset&lt;0&gt;());
155      EXPECT_EQ(4, L::Partial(1, 0, 0).Offset&lt;1&gt;());
156      EXPECT_EQ(8, L::Partial(1, 0, 0).Offset&lt;2&gt;());
157      EXPECT_EQ(0, L::Partial(5, 3, 1).Offset&lt;0&gt;());
158      EXPECT_EQ(24, L::Partial(5, 3, 1).Offset&lt;2&gt;());
159      EXPECT_EQ(8, L::Partial(5, 3, 1).Offset&lt;1&gt;());
160      EXPECT_EQ(0, L(5, 3, 1).Offset&lt;0&gt;());
161      EXPECT_EQ(24, L(5, 3, 1).Offset&lt;2&gt;());
162      EXPECT_EQ(8, L(5, 3, 1).Offset&lt;1&gt;());
163    }
164  }
165  TEST(Layout, OffsetByType) {
166    {
167      using L = Layout&lt;int32_t&gt;;
168      EXPECT_EQ(0, L::Partial().Offset&lt;int32_t&gt;());
169      EXPECT_EQ(0, L::Partial(3).Offset&lt;int32_t&gt;());
170      EXPECT_EQ(0, L(3).Offset&lt;int32_t&gt;());
171    }
172    {
173      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
174      EXPECT_EQ(0, L::Partial().Offset&lt;int8_t&gt;());
175      EXPECT_EQ(0, L::Partial(0).Offset&lt;int8_t&gt;());
176      EXPECT_EQ(0, L::Partial(0).Offset&lt;int32_t&gt;());
177      EXPECT_EQ(0, L::Partial(1).Offset&lt;int8_t&gt;());
178      EXPECT_EQ(4, L::Partial(1).Offset&lt;int32_t&gt;());
179      EXPECT_EQ(0, L::Partial(5).Offset&lt;int8_t&gt;());
180      EXPECT_EQ(8, L::Partial(5).Offset&lt;int32_t&gt;());
181      EXPECT_EQ(0, L::Partial(0, 0).Offset&lt;int8_t&gt;());
182      EXPECT_EQ(0, L::Partial(0, 0).Offset&lt;int32_t&gt;());
183      EXPECT_EQ(0, L::Partial(0, 0).Offset&lt;Int128&gt;());
184      EXPECT_EQ(0, L::Partial(1, 0).Offset&lt;int8_t&gt;());
185      EXPECT_EQ(4, L::Partial(1, 0).Offset&lt;int32_t&gt;());
186      EXPECT_EQ(8, L::Partial(1, 0).Offset&lt;Int128&gt;());
187      EXPECT_EQ(0, L::Partial(5, 3).Offset&lt;int8_t&gt;());
188      EXPECT_EQ(8, L::Partial(5, 3).Offset&lt;int32_t&gt;());
189      EXPECT_EQ(24, L::Partial(5, 3).Offset&lt;Int128&gt;());
190      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset&lt;int8_t&gt;());
191      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset&lt;int32_t&gt;());
192      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset&lt;Int128&gt;());
193      EXPECT_EQ(0, L::Partial(1, 0, 0).Offset&lt;int8_t&gt;());
194      EXPECT_EQ(4, L::Partial(1, 0, 0).Offset&lt;int32_t&gt;());
195      EXPECT_EQ(8, L::Partial(1, 0, 0).Offset&lt;Int128&gt;());
196      EXPECT_EQ(0, L::Partial(5, 3, 1).Offset&lt;int8_t&gt;());
197      EXPECT_EQ(24, L::Partial(5, 3, 1).Offset&lt;Int128&gt;());
198      EXPECT_EQ(8, L::Partial(5, 3, 1).Offset&lt;int32_t&gt;());
199      EXPECT_EQ(0, L(5, 3, 1).Offset&lt;int8_t&gt;());
200      EXPECT_EQ(24, L(5, 3, 1).Offset&lt;Int128&gt;());
201      EXPECT_EQ(8, L(5, 3, 1).Offset&lt;int32_t&gt;());
202    }
203  }
204  TEST(Layout, Offsets) {
205    {
206      using L = Layout&lt;int32_t&gt;;
207      EXPECT_THAT(L::Partial().Offsets(), ElementsAre(0));
208      EXPECT_THAT(L::Partial(3).Offsets(), ElementsAre(0));
209      EXPECT_THAT(L(3).Offsets(), ElementsAre(0));
210    }
211    {
212      using L = Layout&lt;int32_t, int32_t&gt;;
213      EXPECT_THAT(L::Partial().Offsets(), ElementsAre(0));
214      EXPECT_THAT(L::Partial(3).Offsets(), ElementsAre(0, 12));
215      EXPECT_THAT(L::Partial(3, 5).Offsets(), ElementsAre(0, 12));
216      EXPECT_THAT(L(3, 5).Offsets(), ElementsAre(0, 12));
217    }
218    {
219      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
220      EXPECT_THAT(L::Partial().Offsets(), ElementsAre(0));
221      EXPECT_THAT(L::Partial(1).Offsets(), ElementsAre(0, 4));
222      EXPECT_THAT(L::Partial(5).Offsets(), ElementsAre(0, 8));
223      EXPECT_THAT(L::Partial(0, 0).Offsets(), ElementsAre(0, 0, 0));
224      EXPECT_THAT(L::Partial(1, 0).Offsets(), ElementsAre(0, 4, 8));
225      EXPECT_THAT(L::Partial(5, 3).Offsets(), ElementsAre(0, 8, 24));
226      EXPECT_THAT(L::Partial(0, 0, 0).Offsets(), ElementsAre(0, 0, 0));
227      EXPECT_THAT(L::Partial(1, 0, 0).Offsets(), ElementsAre(0, 4, 8));
228      EXPECT_THAT(L::Partial(5, 3, 1).Offsets(), ElementsAre(0, 8, 24));
229      EXPECT_THAT(L(5, 3, 1).Offsets(), ElementsAre(0, 8, 24));
230    }
231  }
232  TEST(Layout, AllocSize) {
233    {
234      using L = Layout&lt;int32_t&gt;;
235      EXPECT_EQ(0, L::Partial(0).AllocSize());
236      EXPECT_EQ(12, L::Partial(3).AllocSize());
237      EXPECT_EQ(12, L(3).AllocSize());
238    }
239    {
240      using L = Layout&lt;int32_t, int32_t&gt;;
241      EXPECT_EQ(32, L::Partial(3, 5).AllocSize());
242      EXPECT_EQ(32, L(3, 5).AllocSize());
243    }
244    {
245      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
246      EXPECT_EQ(0, L::Partial(0, 0, 0).AllocSize());
247      EXPECT_EQ(8, L::Partial(1, 0, 0).AllocSize());
248      EXPECT_EQ(8, L::Partial(0, 1, 0).AllocSize());
249      EXPECT_EQ(16, L::Partial(0, 0, 1).AllocSize());
250      EXPECT_EQ(24, L::Partial(1, 1, 1).AllocSize());
251      EXPECT_EQ(136, L::Partial(3, 5, 7).AllocSize());
252      EXPECT_EQ(136, L(3, 5, 7).AllocSize());
253    }
254  }
255  TEST(Layout, SizeByIndex) {
256    {
257      using L = Layout&lt;int32_t&gt;;
258      EXPECT_EQ(0, L::Partial(0).Size&lt;0&gt;());
259      EXPECT_EQ(3, L::Partial(3).Size&lt;0&gt;());
260      EXPECT_EQ(3, L(3).Size&lt;0&gt;());
261    }
262    {
263      using L = Layout&lt;int32_t, int32_t&gt;;
264      EXPECT_EQ(0, L::Partial(0).Size&lt;0&gt;());
265      EXPECT_EQ(3, L::Partial(3).Size&lt;0&gt;());
266      EXPECT_EQ(3, L::Partial(3, 5).Size&lt;0&gt;());
267      EXPECT_EQ(5, L::Partial(3, 5).Size&lt;1&gt;());
268      EXPECT_EQ(3, L(3, 5).Size&lt;0&gt;());
269      EXPECT_EQ(5, L(3, 5).Size&lt;1&gt;());
270    }
271    {
272      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
273      EXPECT_EQ(3, L::Partial(3).Size&lt;0&gt;());
274      EXPECT_EQ(3, L::Partial(3, 5).Size&lt;0&gt;());
275      EXPECT_EQ(5, L::Partial(3, 5).Size&lt;1&gt;());
276      EXPECT_EQ(3, L::Partial(3, 5, 7).Size&lt;0&gt;());
277      EXPECT_EQ(5, L::Partial(3, 5, 7).Size&lt;1&gt;());
278      EXPECT_EQ(7, L::Partial(3, 5, 7).Size&lt;2&gt;());
279      EXPECT_EQ(3, L(3, 5, 7).Size&lt;0&gt;());
280      EXPECT_EQ(5, L(3, 5, 7).Size&lt;1&gt;());
281      EXPECT_EQ(7, L(3, 5, 7).Size&lt;2&gt;());
282    }
283  }
284  TEST(Layout, SizeByType) {
285    {
286      using L = Layout&lt;int32_t&gt;;
287      EXPECT_EQ(0, L::Partial(0).Size&lt;int32_t&gt;());
288      EXPECT_EQ(3, L::Partial(3).Size&lt;int32_t&gt;());
289      EXPECT_EQ(3, L(3).Size&lt;int32_t&gt;());
290    }
291    {
292      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
293      EXPECT_EQ(3, L::Partial(3).Size&lt;int8_t&gt;());
294      EXPECT_EQ(3, L::Partial(3, 5).Size&lt;int8_t&gt;());
295      EXPECT_EQ(5, L::Partial(3, 5).Size&lt;int32_t&gt;());
296      EXPECT_EQ(3, L::Partial(3, 5, 7).Size&lt;int8_t&gt;());
297      EXPECT_EQ(5, L::Partial(3, 5, 7).Size&lt;int32_t&gt;());
298      EXPECT_EQ(7, L::Partial(3, 5, 7).Size&lt;Int128&gt;());
299      EXPECT_EQ(3, L(3, 5, 7).Size&lt;int8_t&gt;());
300      EXPECT_EQ(5, L(3, 5, 7).Size&lt;int32_t&gt;());
301      EXPECT_EQ(7, L(3, 5, 7).Size&lt;Int128&gt;());
302    }
303  }
304  TEST(Layout, Sizes) {
305    {
306      using L = Layout&lt;int32_t&gt;;
307      EXPECT_THAT(L::Partial().Sizes(), ElementsAre());
308      EXPECT_THAT(L::Partial(3).Sizes(), ElementsAre(3));
309      EXPECT_THAT(L(3).Sizes(), ElementsAre(3));
310    }
311    {
312      using L = Layout&lt;int32_t, int32_t&gt;;
313      EXPECT_THAT(L::Partial().Sizes(), ElementsAre());
314      EXPECT_THAT(L::Partial(3).Sizes(), ElementsAre(3));
315      EXPECT_THAT(L::Partial(3, 5).Sizes(), ElementsAre(3, 5));
316      EXPECT_THAT(L(3, 5).Sizes(), ElementsAre(3, 5));
317    }
318    {
319      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
320      EXPECT_THAT(L::Partial().Sizes(), ElementsAre());
321      EXPECT_THAT(L::Partial(3).Sizes(), ElementsAre(3));
322      EXPECT_THAT(L::Partial(3, 5).Sizes(), ElementsAre(3, 5));
323      EXPECT_THAT(L::Partial(3, 5, 7).Sizes(), ElementsAre(3, 5, 7));
324      EXPECT_THAT(L(3, 5, 7).Sizes(), ElementsAre(3, 5, 7));
325    }
326  }
327  TEST(Layout, PointerByIndex) {
328    alignas(max_align_t) const unsigned char p[100] = {0};
329    {
330      using L = Layout&lt;int32_t&gt;;
331      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(L::Partial().Pointer&lt;0&gt;(p))));
332      EXPECT_EQ(0,
333                Distance(p, Type&lt;const int32_t*&gt;(L::Partial(3).Pointer&lt;0&gt;(p))));
334      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(L(3).Pointer&lt;0&gt;(p))));
335    }
336    {
337      using L = Layout&lt;int32_t, int32_t&gt;;
338      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(L::Partial().Pointer&lt;0&gt;(p))));
339      EXPECT_EQ(0,
340                Distance(p, Type&lt;const int32_t*&gt;(L::Partial(3).Pointer&lt;0&gt;(p))));
341      EXPECT_EQ(12,
342                Distance(p, Type&lt;const int32_t*&gt;(L::Partial(3).Pointer&lt;1&gt;(p))));
343      EXPECT_EQ(
344          0, Distance(p, Type&lt;const int32_t*&gt;(L::Partial(3, 5).Pointer&lt;0&gt;(p))));
345      EXPECT_EQ(
346          12, Distance(p, Type&lt;const int32_t*&gt;(L::Partial(3, 5).Pointer&lt;1&gt;(p))));
347      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(L(3, 5).Pointer&lt;0&gt;(p))));
348      EXPECT_EQ(12, Distance(p, Type&lt;const int32_t*&gt;(L(3, 5).Pointer&lt;1&gt;(p))));
349    }
350    {
351      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
352      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial().Pointer&lt;0&gt;(p))));
353      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(0).Pointer&lt;0&gt;(p))));
354      EXPECT_EQ(0,
355                Distance(p, Type&lt;const int32_t*&gt;(L::Partial(0).Pointer&lt;1&gt;(p))));
356      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(1).Pointer&lt;0&gt;(p))));
357      EXPECT_EQ(4,
358                Distance(p, Type&lt;const int32_t*&gt;(L::Partial(1).Pointer&lt;1&gt;(p))));
359      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(5).Pointer&lt;0&gt;(p))));
360      EXPECT_EQ(8,
361                Distance(p, Type&lt;const int32_t*&gt;(L::Partial(5).Pointer&lt;1&gt;(p))));
362      EXPECT_EQ(0,
363                Distance(p, Type&lt;const int8_t*&gt;(L::Partial(0, 0).Pointer&lt;0&gt;(p))));
364      EXPECT_EQ(
365          0, Distance(p, Type&lt;const int32_t*&gt;(L::Partial(0, 0).Pointer&lt;1&gt;(p))));
366      EXPECT_EQ(0,
367                Distance(p, Type&lt;const Int128*&gt;(L::Partial(0, 0).Pointer&lt;2&gt;(p))));
368      EXPECT_EQ(0,
369                Distance(p, Type&lt;const int8_t*&gt;(L::Partial(1, 0).Pointer&lt;0&gt;(p))));
370      EXPECT_EQ(
371          4, Distance(p, Type&lt;const int32_t*&gt;(L::Partial(1, 0).Pointer&lt;1&gt;(p))));
372      EXPECT_EQ(8,
373                Distance(p, Type&lt;const Int128*&gt;(L::Partial(1, 0).Pointer&lt;2&gt;(p))));
374      EXPECT_EQ(0,
375                Distance(p, Type&lt;const int8_t*&gt;(L::Partial(5, 3).Pointer&lt;0&gt;(p))));
376      EXPECT_EQ(
377          8, Distance(p, Type&lt;const int32_t*&gt;(L::Partial(5, 3).Pointer&lt;1&gt;(p))));
378      EXPECT_EQ(24,
379                Distance(p, Type&lt;const Int128*&gt;(L::Partial(5, 3).Pointer&lt;2&gt;(p))));
380      EXPECT_EQ(
381          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(0, 0, 0).Pointer&lt;0&gt;(p))));
382      EXPECT_EQ(
383          0,
384          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(0, 0, 0).Pointer&lt;1&gt;(p))));
385      EXPECT_EQ(
386          0, Distance(p, Type&lt;const Int128*&gt;(L::Partial(0, 0, 0).Pointer&lt;2&gt;(p))));
387      EXPECT_EQ(
388          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(1, 0, 0).Pointer&lt;0&gt;(p))));
389      EXPECT_EQ(
390          4,
391          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(1, 0, 0).Pointer&lt;1&gt;(p))));
392      EXPECT_EQ(
393          8, Distance(p, Type&lt;const Int128*&gt;(L::Partial(1, 0, 0).Pointer&lt;2&gt;(p))));
394      EXPECT_EQ(
395          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(5, 3, 1).Pointer&lt;0&gt;(p))));
396      EXPECT_EQ(
397          24,
398          Distance(p, Type&lt;const Int128*&gt;(L::Partial(5, 3, 1).Pointer&lt;2&gt;(p))));
399      EXPECT_EQ(
400          8,
401          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(5, 3, 1).Pointer&lt;1&gt;(p))));
402      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(L(5, 3, 1).Pointer&lt;0&gt;(p))));
403      EXPECT_EQ(24, Distance(p, Type&lt;const Int128*&gt;(L(5, 3, 1).Pointer&lt;2&gt;(p))));
404      EXPECT_EQ(8, Distance(p, Type&lt;const int32_t*&gt;(L(5, 3, 1).Pointer&lt;1&gt;(p))));
405    }
406  }
407  TEST(Layout, PointerByType) {
408    alignas(max_align_t) const unsigned char p[100] = {0};
409    {
410      using L = Layout&lt;int32_t&gt;;
411      EXPECT_EQ(
412          0, Distance(p, Type&lt;const int32_t*&gt;(L::Partial().Pointer&lt;int32_t&gt;(p))));
413      EXPECT_EQ(
414          0,
415          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(3).Pointer&lt;int32_t&gt;(p))));
416      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(L(3).Pointer&lt;int32_t&gt;(p))));
417    }
418    {
419      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
420      EXPECT_EQ(
421          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial().Pointer&lt;int8_t&gt;(p))));
422      EXPECT_EQ(
423          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(0).Pointer&lt;int8_t&gt;(p))));
424      EXPECT_EQ(
425          0,
426          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(0).Pointer&lt;int32_t&gt;(p))));
427      EXPECT_EQ(
428          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(1).Pointer&lt;int8_t&gt;(p))));
429      EXPECT_EQ(
430          4,
431          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(1).Pointer&lt;int32_t&gt;(p))));
432      EXPECT_EQ(
433          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(5).Pointer&lt;int8_t&gt;(p))));
434      EXPECT_EQ(
435          8,
436          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(5).Pointer&lt;int32_t&gt;(p))));
437      EXPECT_EQ(
438          0,
439          Distance(p, Type&lt;const int8_t*&gt;(L::Partial(0, 0).Pointer&lt;int8_t&gt;(p))));
440      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(
441                                   L::Partial(0, 0).Pointer&lt;int32_t&gt;(p))));
442      EXPECT_EQ(
443          0,
444          Distance(p, Type&lt;const Int128*&gt;(L::Partial(0, 0).Pointer&lt;Int128&gt;(p))));
445      EXPECT_EQ(
446          0,
447          Distance(p, Type&lt;const int8_t*&gt;(L::Partial(1, 0).Pointer&lt;int8_t&gt;(p))));
448      EXPECT_EQ(4, Distance(p, Type&lt;const int32_t*&gt;(
449                                   L::Partial(1, 0).Pointer&lt;int32_t&gt;(p))));
450      EXPECT_EQ(
451          8,
452          Distance(p, Type&lt;const Int128*&gt;(L::Partial(1, 0).Pointer&lt;Int128&gt;(p))));
453      EXPECT_EQ(
454          0,
455          Distance(p, Type&lt;const int8_t*&gt;(L::Partial(5, 3).Pointer&lt;int8_t&gt;(p))));
456      EXPECT_EQ(8, Distance(p, Type&lt;const int32_t*&gt;(
457                                   L::Partial(5, 3).Pointer&lt;int32_t&gt;(p))));
458      EXPECT_EQ(
459          24,
460          Distance(p, Type&lt;const Int128*&gt;(L::Partial(5, 3).Pointer&lt;Int128&gt;(p))));
461      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(
462                                   L::Partial(0, 0, 0).Pointer&lt;int8_t&gt;(p))));
463      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(
464                                   L::Partial(0, 0, 0).Pointer&lt;int32_t&gt;(p))));
465      EXPECT_EQ(0, Distance(p, Type&lt;const Int128*&gt;(
466                                   L::Partial(0, 0, 0).Pointer&lt;Int128&gt;(p))));
467      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(
468                                   L::Partial(1, 0, 0).Pointer&lt;int8_t&gt;(p))));
469      EXPECT_EQ(4, Distance(p, Type&lt;const int32_t*&gt;(
470                                   L::Partial(1, 0, 0).Pointer&lt;int32_t&gt;(p))));
471      EXPECT_EQ(8, Distance(p, Type&lt;const Int128*&gt;(
472                                   L::Partial(1, 0, 0).Pointer&lt;Int128&gt;(p))));
473      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(
474                                   L::Partial(5, 3, 1).Pointer&lt;int8_t&gt;(p))));
475      EXPECT_EQ(24, Distance(p, Type&lt;const Int128*&gt;(
476                                    L::Partial(5, 3, 1).Pointer&lt;Int128&gt;(p))));
477      EXPECT_EQ(8, Distance(p, Type&lt;const int32_t*&gt;(
478                                   L::Partial(5, 3, 1).Pointer&lt;int32_t&gt;(p))));
479      EXPECT_EQ(24,
480                Distance(p, Type&lt;const Int128*&gt;(L(5, 3, 1).Pointer&lt;Int128&gt;(p))));
481      EXPECT_EQ(
482          8, Distance(p, Type&lt;const int32_t*&gt;(L(5, 3, 1).Pointer&lt;int32_t&gt;(p))));
483    }
484  }
485  TEST(Layout, MutablePointerByIndex) {
486    alignas(max_align_t) unsigned char p[100] = {0};
487    {
488      using L = Layout&lt;int32_t&gt;;
489      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial().Pointer&lt;0&gt;(p))));
490      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial(3).Pointer&lt;0&gt;(p))));
491      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L(3).Pointer&lt;0&gt;(p))));
492    }
493    {
494      using L = Layout&lt;int32_t, int32_t&gt;;
495      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial().Pointer&lt;0&gt;(p))));
496      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial(3).Pointer&lt;0&gt;(p))));
497      EXPECT_EQ(12, Distance(p, Type&lt;int32_t*&gt;(L::Partial(3).Pointer&lt;1&gt;(p))));
498      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial(3, 5).Pointer&lt;0&gt;(p))));
499      EXPECT_EQ(12, Distance(p, Type&lt;int32_t*&gt;(L::Partial(3, 5).Pointer&lt;1&gt;(p))));
500      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L(3, 5).Pointer&lt;0&gt;(p))));
501      EXPECT_EQ(12, Distance(p, Type&lt;int32_t*&gt;(L(3, 5).Pointer&lt;1&gt;(p))));
502    }
503    {
504      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
505      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial().Pointer&lt;0&gt;(p))));
506      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(0).Pointer&lt;0&gt;(p))));
507      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial(0).Pointer&lt;1&gt;(p))));
508      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(1).Pointer&lt;0&gt;(p))));
509      EXPECT_EQ(4, Distance(p, Type&lt;int32_t*&gt;(L::Partial(1).Pointer&lt;1&gt;(p))));
510      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(5).Pointer&lt;0&gt;(p))));
511      EXPECT_EQ(8, Distance(p, Type&lt;int32_t*&gt;(L::Partial(5).Pointer&lt;1&gt;(p))));
512      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(0, 0).Pointer&lt;0&gt;(p))));
513      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial(0, 0).Pointer&lt;1&gt;(p))));
514      EXPECT_EQ(0, Distance(p, Type&lt;Int128*&gt;(L::Partial(0, 0).Pointer&lt;2&gt;(p))));
515      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(1, 0).Pointer&lt;0&gt;(p))));
516      EXPECT_EQ(4, Distance(p, Type&lt;int32_t*&gt;(L::Partial(1, 0).Pointer&lt;1&gt;(p))));
517      EXPECT_EQ(8, Distance(p, Type&lt;Int128*&gt;(L::Partial(1, 0).Pointer&lt;2&gt;(p))));
518      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(5, 3).Pointer&lt;0&gt;(p))));
519      EXPECT_EQ(8, Distance(p, Type&lt;int32_t*&gt;(L::Partial(5, 3).Pointer&lt;1&gt;(p))));
520      EXPECT_EQ(24, Distance(p, Type&lt;Int128*&gt;(L::Partial(5, 3).Pointer&lt;2&gt;(p))));
521      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(0, 0, 0).Pointer&lt;0&gt;(p))));
522      EXPECT_EQ(0,
523                Distance(p, Type&lt;int32_t*&gt;(L::Partial(0, 0, 0).Pointer&lt;1&gt;(p))));
524      EXPECT_EQ(0, Distance(p, Type&lt;Int128*&gt;(L::Partial(0, 0, 0).Pointer&lt;2&gt;(p))));
525      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(1, 0, 0).Pointer&lt;0&gt;(p))));
526      EXPECT_EQ(4,
527                Distance(p, Type&lt;int32_t*&gt;(L::Partial(1, 0, 0).Pointer&lt;1&gt;(p))));
528      EXPECT_EQ(8, Distance(p, Type&lt;Int128*&gt;(L::Partial(1, 0, 0).Pointer&lt;2&gt;(p))));
529      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(5, 3, 1).Pointer&lt;0&gt;(p))));
530      EXPECT_EQ(24,
531                Distance(p, Type&lt;Int128*&gt;(L::Partial(5, 3, 1).Pointer&lt;2&gt;(p))));
532      EXPECT_EQ(8,
533                Distance(p, Type&lt;int32_t*&gt;(L::Partial(5, 3, 1).Pointer&lt;1&gt;(p))));
534      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L(5, 3, 1).Pointer&lt;0&gt;(p))));
535      EXPECT_EQ(24, Distance(p, Type&lt;Int128*&gt;(L(5, 3, 1).Pointer&lt;2&gt;(p))));
536      EXPECT_EQ(8, Distance(p, Type&lt;int32_t*&gt;(L(5, 3, 1).Pointer&lt;1&gt;(p))));
537    }
538  }
539  TEST(Layout, MutablePointerByType) {
540    alignas(max_align_t) unsigned char p[100] = {0};
541    {
542      using L = Layout&lt;int32_t&gt;;
543      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial().Pointer&lt;int32_t&gt;(p))));
544      EXPECT_EQ(0,
545                Distance(p, Type&lt;int32_t*&gt;(L::Partial(3).Pointer&lt;int32_t&gt;(p))));
546      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L(3).Pointer&lt;int32_t&gt;(p))));
547    }
548    {
549      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
550      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial().Pointer&lt;int8_t&gt;(p))));
551      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(0).Pointer&lt;int8_t&gt;(p))));
552      EXPECT_EQ(0,
553                Distance(p, Type&lt;int32_t*&gt;(L::Partial(0).Pointer&lt;int32_t&gt;(p))));
554      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(1).Pointer&lt;int8_t&gt;(p))));
555      EXPECT_EQ(4,
556                Distance(p, Type&lt;int32_t*&gt;(L::Partial(1).Pointer&lt;int32_t&gt;(p))));
557      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(5).Pointer&lt;int8_t&gt;(p))));
558      EXPECT_EQ(8,
559                Distance(p, Type&lt;int32_t*&gt;(L::Partial(5).Pointer&lt;int32_t&gt;(p))));
560      EXPECT_EQ(0,
561                Distance(p, Type&lt;int8_t*&gt;(L::Partial(0, 0).Pointer&lt;int8_t&gt;(p))));
562      EXPECT_EQ(
563          0, Distance(p, Type&lt;int32_t*&gt;(L::Partial(0, 0).Pointer&lt;int32_t&gt;(p))));
564      EXPECT_EQ(0,
565                Distance(p, Type&lt;Int128*&gt;(L::Partial(0, 0).Pointer&lt;Int128&gt;(p))));
566      EXPECT_EQ(0,
567                Distance(p, Type&lt;int8_t*&gt;(L::Partial(1, 0).Pointer&lt;int8_t&gt;(p))));
568      EXPECT_EQ(
569          4, Distance(p, Type&lt;int32_t*&gt;(L::Partial(1, 0).Pointer&lt;int32_t&gt;(p))));
570      EXPECT_EQ(8,
571                Distance(p, Type&lt;Int128*&gt;(L::Partial(1, 0).Pointer&lt;Int128&gt;(p))));
572      EXPECT_EQ(0,
573                Distance(p, Type&lt;int8_t*&gt;(L::Partial(5, 3).Pointer&lt;int8_t&gt;(p))));
574      EXPECT_EQ(
575          8, Distance(p, Type&lt;int32_t*&gt;(L::Partial(5, 3).Pointer&lt;int32_t&gt;(p))));
576      EXPECT_EQ(24,
577                Distance(p, Type&lt;Int128*&gt;(L::Partial(5, 3).Pointer&lt;Int128&gt;(p))));
578      EXPECT_EQ(
579          0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(0, 0, 0).Pointer&lt;int8_t&gt;(p))));
580      EXPECT_EQ(
581          0,
582          Distance(p, Type&lt;int32_t*&gt;(L::Partial(0, 0, 0).Pointer&lt;int32_t&gt;(p))));
583      EXPECT_EQ(
584          0, Distance(p, Type&lt;Int128*&gt;(L::Partial(0, 0, 0).Pointer&lt;Int128&gt;(p))));
585      EXPECT_EQ(
586          0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(1, 0, 0).Pointer&lt;int8_t&gt;(p))));
587      EXPECT_EQ(
588          4,
589          Distance(p, Type&lt;int32_t*&gt;(L::Partial(1, 0, 0).Pointer&lt;int32_t&gt;(p))));
590      EXPECT_EQ(
591          8, Distance(p, Type&lt;Int128*&gt;(L::Partial(1, 0, 0).Pointer&lt;Int128&gt;(p))));
592      EXPECT_EQ(
593          0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(5, 3, 1).Pointer&lt;int8_t&gt;(p))));
594      EXPECT_EQ(
595          24, Distance(p, Type&lt;Int128*&gt;(L::Partial(5, 3, 1).Pointer&lt;Int128&gt;(p))));
596      EXPECT_EQ(
597          8,
598          Distance(p, Type&lt;int32_t*&gt;(L::Partial(5, 3, 1).Pointer&lt;int32_t&gt;(p))));
599      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L(5, 3, 1).Pointer&lt;int8_t&gt;(p))));
600      EXPECT_EQ(24, Distance(p, Type&lt;Int128*&gt;(L(5, 3, 1).Pointer&lt;Int128&gt;(p))));
601      EXPECT_EQ(8, Distance(p, Type&lt;int32_t*&gt;(L(5, 3, 1).Pointer&lt;int32_t&gt;(p))));
602    }
603  }
604  TEST(Layout, Pointers) {
605    alignas(max_align_t) const unsigned char p[100] = {0};
606    using L = Layout&lt;int8_t, int8_t, Int128&gt;;
607    {
608      const auto x = L::Partial();
609      EXPECT_EQ(std::make_tuple(x.Pointer&lt;0&gt;(p)),
610                Type&lt;std::tuple&lt;const int8_t*&gt;&gt;(x.Pointers(p)));
611    }
612    {
613      const auto x = L::Partial(1);
614      EXPECT_EQ(std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p)),
615                (Type&lt;std::tuple&lt;const int8_t*, const int8_t*&gt;&gt;(x.Pointers(p))));
616    }
617    {
618      const auto x = L::Partial(1, 2);
619      EXPECT_EQ(
620          std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p), x.Pointer&lt;2&gt;(p)),
621          (Type&lt;std::tuple&lt;const int8_t*, const int8_t*, const Int128*&gt;&gt;(
622              x.Pointers(p))));
623    }
624    {
625      const auto x = L::Partial(1, 2, 3);
626      EXPECT_EQ(
627          std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p), x.Pointer&lt;2&gt;(p)),
628          (Type&lt;std::tuple&lt;const int8_t*, const int8_t*, const Int128*&gt;&gt;(
629              x.Pointers(p))));
630    }
631    {
632      const L x(1, 2, 3);
633      EXPECT_EQ(
634          std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p), x.Pointer&lt;2&gt;(p)),
635          (Type&lt;std::tuple&lt;const int8_t*, const int8_t*, const Int128*&gt;&gt;(
636              x.Pointers(p))));
637    }
638  }
639  TEST(Layout, MutablePointers) {
640    alignas(max_align_t) unsigned char p[100] = {0};
641    using L = Layout&lt;int8_t, int8_t, Int128&gt;;
642    {
643      const auto x = L::Partial();
644      EXPECT_EQ(std::make_tuple(x.Pointer&lt;0&gt;(p)),
645                Type&lt;std::tuple&lt;int8_t*&gt;&gt;(x.Pointers(p)));
646    }
647    {
648      const auto x = L::Partial(1);
649      EXPECT_EQ(std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p)),
650                (Type&lt;std::tuple&lt;int8_t*, int8_t*&gt;&gt;(x.Pointers(p))));
651    }
652    {
653      const auto x = L::Partial(1, 2);
654      EXPECT_EQ(
655          std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p), x.Pointer&lt;2&gt;(p)),
656          (Type&lt;std::tuple&lt;int8_t*, int8_t*, Int128*&gt;&gt;(x.Pointers(p))));
657    }
658    {
659      const auto x = L::Partial(1, 2, 3);
660      EXPECT_EQ(
661          std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p), x.Pointer&lt;2&gt;(p)),
662          (Type&lt;std::tuple&lt;int8_t*, int8_t*, Int128*&gt;&gt;(x.Pointers(p))));
663    }
664    {
665      const L x(1, 2, 3);
666      EXPECT_EQ(
667          std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p), x.Pointer&lt;2&gt;(p)),
668          (Type&lt;std::tuple&lt;int8_t*, int8_t*, Int128*&gt;&gt;(x.Pointers(p))));
669    }
670  }
671  TEST(Layout, SliceByIndexSize) {
672    alignas(max_align_t) const unsigned char p[100] = {0};
673    {
674      using L = Layout&lt;int32_t&gt;;
675      EXPECT_EQ(0, L::Partial(0).Slice&lt;0&gt;(p).size());
676      EXPECT_EQ(3, L::Partial(3).Slice&lt;0&gt;(p).size());
677      EXPECT_EQ(3, L(3).Slice&lt;0&gt;(p).size());
678    }
679    {
680      using L = Layout&lt;int32_t, int32_t&gt;;
681      EXPECT_EQ(3, L::Partial(3).Slice&lt;0&gt;(p).size());
682      EXPECT_EQ(5, L::Partial(3, 5).Slice&lt;1&gt;(p).size());
683      EXPECT_EQ(5, L(3, 5).Slice&lt;1&gt;(p).size());
684    }
685    {
686      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
687      EXPECT_EQ(3, L::Partial(3).Slice&lt;0&gt;(p).size());
688      EXPECT_EQ(3, L::Partial(3, 5).Slice&lt;0&gt;(p).size());
689      EXPECT_EQ(5, L::Partial(3, 5).Slice&lt;1&gt;(p).size());
690      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice&lt;0&gt;(p).size());
691      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice&lt;1&gt;(p).size());
692      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice&lt;2&gt;(p).size());
693      EXPECT_EQ(3, L(3, 5, 7).Slice&lt;0&gt;(p).size());
694      EXPECT_EQ(5, L(3, 5, 7).Slice&lt;1&gt;(p).size());
695      EXPECT_EQ(7, L(3, 5, 7).Slice&lt;2&gt;(p).size());
696    }
697  }
698  TEST(Layout, SliceByTypeSize) {
699    alignas(max_align_t) const unsigned char p[100] = {0};
700    {
701      using L = Layout&lt;int32_t&gt;;
702      EXPECT_EQ(0, L::Partial(0).Slice&lt;int32_t&gt;(p).size());
703      EXPECT_EQ(3, L::Partial(3).Slice&lt;int32_t&gt;(p).size());
704      EXPECT_EQ(3, L(3).Slice&lt;int32_t&gt;(p).size());
705    }
706    {
707      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
708      EXPECT_EQ(3, L::Partial(3).Slice&lt;int8_t&gt;(p).size());
709      EXPECT_EQ(3, L::Partial(3, 5).Slice&lt;int8_t&gt;(p).size());
710      EXPECT_EQ(5, L::Partial(3, 5).Slice&lt;int32_t&gt;(p).size());
711      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice&lt;int8_t&gt;(p).size());
712      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice&lt;int32_t&gt;(p).size());
713      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice&lt;Int128&gt;(p).size());
714      EXPECT_EQ(3, L(3, 5, 7).Slice&lt;int8_t&gt;(p).size());
715      EXPECT_EQ(5, L(3, 5, 7).Slice&lt;int32_t&gt;(p).size());
716      EXPECT_EQ(7, L(3, 5, 7).Slice&lt;Int128&gt;(p).size());
717    }
718  }
719  TEST(Layout, MutableSliceByIndexSize) {
720    alignas(max_align_t) unsigned char p[100] = {0};
721    {
722      using L = Layout&lt;int32_t&gt;;
723      EXPECT_EQ(0, L::Partial(0).Slice&lt;0&gt;(p).size());
724      EXPECT_EQ(3, L::Partial(3).Slice&lt;0&gt;(p).size());
725      EXPECT_EQ(3, L(3).Slice&lt;0&gt;(p).size());
726    }
727    {
728      using L = Layout&lt;int32_t, int32_t&gt;;
729      EXPECT_EQ(3, L::Partial(3).Slice&lt;0&gt;(p).size());
730      EXPECT_EQ(5, L::Partial(3, 5).Slice&lt;1&gt;(p).size());
731      EXPECT_EQ(5, L(3, 5).Slice&lt;1&gt;(p).size());
732    }
733    {
734      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
735      EXPECT_EQ(3, L::Partial(3).Slice&lt;0&gt;(p).size());
736      EXPECT_EQ(3, L::Partial(3, 5).Slice&lt;0&gt;(p).size());
737      EXPECT_EQ(5, L::Partial(3, 5).Slice&lt;1&gt;(p).size());
738      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice&lt;0&gt;(p).size());
739      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice&lt;1&gt;(p).size());
740      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice&lt;2&gt;(p).size());
741      EXPECT_EQ(3, L(3, 5, 7).Slice&lt;0&gt;(p).size());
742      EXPECT_EQ(5, L(3, 5, 7).Slice&lt;1&gt;(p).size());
743      EXPECT_EQ(7, L(3, 5, 7).Slice&lt;2&gt;(p).size());
744    }
745  }
746  TEST(Layout, MutableSliceByTypeSize) {
747    alignas(max_align_t) unsigned char p[100] = {0};
748    {
749      using L = Layout&lt;int32_t&gt;;
750      EXPECT_EQ(0, L::Partial(0).Slice&lt;int32_t&gt;(p).size());
751      EXPECT_EQ(3, L::Partial(3).Slice&lt;int32_t&gt;(p).size());
752      EXPECT_EQ(3, L(3).Slice&lt;int32_t&gt;(p).size());
753    }
754    {
755      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
756      EXPECT_EQ(3, L::Partial(3).Slice&lt;int8_t&gt;(p).size());
757      EXPECT_EQ(3, L::Partial(3, 5).Slice&lt;int8_t&gt;(p).size());
758      EXPECT_EQ(5, L::Partial(3, 5).Slice&lt;int32_t&gt;(p).size());
759      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice&lt;int8_t&gt;(p).size());
760      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice&lt;int32_t&gt;(p).size());
761      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice&lt;Int128&gt;(p).size());
762      EXPECT_EQ(3, L(3, 5, 7).Slice&lt;int8_t&gt;(p).size());
763      EXPECT_EQ(5, L(3, 5, 7).Slice&lt;int32_t&gt;(p).size());
764      EXPECT_EQ(7, L(3, 5, 7).Slice&lt;Int128&gt;(p).size());
765    }
766  }
767  TEST(Layout, SliceByIndexData) {
768    alignas(max_align_t) const unsigned char p[100] = {0};
769    {
770      using L = Layout&lt;int32_t&gt;;
771      EXPECT_EQ(
772          0, Distance(
773                 p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(0).Slice&lt;0&gt;(p)).data()));
774      EXPECT_EQ(
775          0, Distance(
776                 p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(3).Slice&lt;0&gt;(p)).data()));
777      EXPECT_EQ(0,
778                Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(L(3).Slice&lt;0&gt;(p)).data()));
779    }
780    {
781      using L = Layout&lt;int32_t, int32_t&gt;;
782      EXPECT_EQ(
783          0, Distance(
784                 p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(3).Slice&lt;0&gt;(p)).data()));
785      EXPECT_EQ(
786          0,
787          Distance(
788              p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(3, 5).Slice&lt;0&gt;(p)).data()));
789      EXPECT_EQ(
790          12,
791          Distance(
792              p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(3, 5).Slice&lt;1&gt;(p)).data()));
793      EXPECT_EQ(
794          0, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(L(3, 5).Slice&lt;0&gt;(p)).data()));
795      EXPECT_EQ(
796          12, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(L(3, 5).Slice&lt;1&gt;(p)).data()));
797    }
798    {
799      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
800      EXPECT_EQ(
801          0, Distance(
802                 p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(0).Slice&lt;0&gt;(p)).data()));
803      EXPECT_EQ(
804          0, Distance(
805                 p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(1).Slice&lt;0&gt;(p)).data()));
806      EXPECT_EQ(
807          0, Distance(
808                 p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(5).Slice&lt;0&gt;(p)).data()));
809      EXPECT_EQ(
810          0,
811          Distance(
812              p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(0, 0).Slice&lt;0&gt;(p)).data()));
813      EXPECT_EQ(
814          0,
815          Distance(
816              p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(0, 0).Slice&lt;1&gt;(p)).data()));
817      EXPECT_EQ(
818          0,
819          Distance(
820              p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(1, 0).Slice&lt;0&gt;(p)).data()));
821      EXPECT_EQ(
822          4,
823          Distance(
824              p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(1, 0).Slice&lt;1&gt;(p)).data()));
825      EXPECT_EQ(
826          0,
827          Distance(
828              p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(5, 3).Slice&lt;0&gt;(p)).data()));
829      EXPECT_EQ(
830          8,
831          Distance(
832              p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(5, 3).Slice&lt;1&gt;(p)).data()));
833      EXPECT_EQ(
834          0,
835          Distance(
836              p,
837              Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;0&gt;(p)).data()));
838      EXPECT_EQ(
839          0,
840          Distance(
841              p,
842              Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;1&gt;(p)).data()));
843      EXPECT_EQ(
844          0,
845          Distance(
846              p,
847              Type&lt;Span&lt;const Int128&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;2&gt;(p)).data()));
848      EXPECT_EQ(
849          0,
850          Distance(
851              p,
852              Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;0&gt;(p)).data()));
853      EXPECT_EQ(
854          4,
855          Distance(
856              p,
857              Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;1&gt;(p)).data()));
858      EXPECT_EQ(
859          8,
860          Distance(
861              p,
862              Type&lt;Span&lt;const Int128&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;2&gt;(p)).data()));
863      EXPECT_EQ(
864          0,
865          Distance(
866              p,
867              Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;0&gt;(p)).data()));
868      EXPECT_EQ(
869          24,
870          Distance(
871              p,
872              Type&lt;Span&lt;const Int128&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;2&gt;(p)).data()));
873      EXPECT_EQ(
874          8,
875          Distance(
876              p,
877              Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;1&gt;(p)).data()));
878      EXPECT_EQ(
879          0,
880          Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(L(5, 3, 1).Slice&lt;0&gt;(p)).data()));
881      EXPECT_EQ(
882          24,
883          Distance(p, Type&lt;Span&lt;const Int128&gt;&gt;(L(5, 3, 1).Slice&lt;2&gt;(p)).data()));
884      EXPECT_EQ(
885          8,
886          Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(L(5, 3, 1).Slice&lt;1&gt;(p)).data()));
887    }
888  }
889  TEST(Layout, SliceByTypeData) {
890    alignas(max_align_t) const unsigned char p[100] = {0};
891    {
892      using L = Layout&lt;int32_t&gt;;
893      EXPECT_EQ(
894          0,
895          Distance(
896              p,
897              Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(0).Slice&lt;int32_t&gt;(p)).data()));
898      EXPECT_EQ(
899          0,
900          Distance(
901              p,
902              Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(3).Slice&lt;int32_t&gt;(p)).data()));
903      EXPECT_EQ(
904          0,
905          Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(L(3).Slice&lt;int32_t&gt;(p)).data()));
906    }
907    {
908      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
909      EXPECT_EQ(
910          0,
911          Distance(
912              p,
913              Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(0).Slice&lt;int8_t&gt;(p)).data()));
914      EXPECT_EQ(
915          0,
916          Distance(
917              p,
918              Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(1).Slice&lt;int8_t&gt;(p)).data()));
919      EXPECT_EQ(
920          0,
921          Distance(
922              p,
923              Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(5).Slice&lt;int8_t&gt;(p)).data()));
924      EXPECT_EQ(
925          0,
926          Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(0, 0).Slice&lt;int8_t&gt;(p))
927                          .data()));
928      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(
929                                   L::Partial(0, 0).Slice&lt;int32_t&gt;(p))
930                                   .data()));
931      EXPECT_EQ(
932          0,
933          Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(1, 0).Slice&lt;int8_t&gt;(p))
934                          .data()));
935      EXPECT_EQ(4, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(
936                                   L::Partial(1, 0).Slice&lt;int32_t&gt;(p))
937                                   .data()));
938      EXPECT_EQ(
939          0,
940          Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(5, 3).Slice&lt;int8_t&gt;(p))
941                          .data()));
942      EXPECT_EQ(8, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(
943                                   L::Partial(5, 3).Slice&lt;int32_t&gt;(p))
944                                   .data()));
945      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(
946                                   L::Partial(0, 0, 0).Slice&lt;int8_t&gt;(p))
947                                   .data()));
948      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(
949                                   L::Partial(0, 0, 0).Slice&lt;int32_t&gt;(p))
950                                   .data()));
951      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;const Int128&gt;&gt;(
952                                   L::Partial(0, 0, 0).Slice&lt;Int128&gt;(p))
953                                   .data()));
954      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(
955                                   L::Partial(1, 0, 0).Slice&lt;int8_t&gt;(p))
956                                   .data()));
957      EXPECT_EQ(4, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(
958                                   L::Partial(1, 0, 0).Slice&lt;int32_t&gt;(p))
959                                   .data()));
960      EXPECT_EQ(8, Distance(p, Type&lt;Span&lt;const Int128&gt;&gt;(
961                                   L::Partial(1, 0, 0).Slice&lt;Int128&gt;(p))
962                                   .data()));
963      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(
964                                   L::Partial(5, 3, 1).Slice&lt;int8_t&gt;(p))
965                                   .data()));
966      EXPECT_EQ(24, Distance(p, Type&lt;Span&lt;const Int128&gt;&gt;(
967                                    L::Partial(5, 3, 1).Slice&lt;Int128&gt;(p))
968                                    .data()));
969      EXPECT_EQ(8, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(
970                                   L::Partial(5, 3, 1).Slice&lt;int32_t&gt;(p))
971                                   .data()));
972      EXPECT_EQ(
973          0,
974          Distance(p,
975                   Type&lt;Span&lt;const int8_t&gt;&gt;(L(5, 3, 1).Slice&lt;int8_t&gt;(p)).data()));
976      EXPECT_EQ(
977          24,
978          Distance(p,
979                   Type&lt;Span&lt;const Int128&gt;&gt;(L(5, 3, 1).Slice&lt;Int128&gt;(p)).data()));
980      EXPECT_EQ(
981          8,
982          Distance(
983              p, Type&lt;Span&lt;const int32_t&gt;&gt;(L(5, 3, 1).Slice&lt;int32_t&gt;(p)).data()));
984    }
985  }
986  TEST(Layout, MutableSliceByIndexData) {
987    alignas(max_align_t) unsigned char p[100] = {0};
988    {
989      using L = Layout&lt;int32_t&gt;;
990      EXPECT_EQ(
991          0, Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(0).Slice&lt;0&gt;(p)).data()));
992      EXPECT_EQ(
993          0, Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(3).Slice&lt;0&gt;(p)).data()));
994      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L(3).Slice&lt;0&gt;(p)).data()));
995    }
996    {
997      using L = Layout&lt;int32_t, int32_t&gt;;
998      EXPECT_EQ(
999          0, Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(3).Slice&lt;0&gt;(p)).data()));
1000      EXPECT_EQ(
1001          0,
1002          Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(3, 5).Slice&lt;0&gt;(p)).data()));
1003      EXPECT_EQ(
1004          12,
1005          Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(3, 5).Slice&lt;1&gt;(p)).data()));
1006      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L(3, 5).Slice&lt;0&gt;(p)).data()));
1007      EXPECT_EQ(12, Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L(3, 5).Slice&lt;1&gt;(p)).data()));
1008    }
1009    {
1010      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
1011      EXPECT_EQ(
1012          0, Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(0).Slice&lt;0&gt;(p)).data()));
1013      EXPECT_EQ(
1014          0, Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(1).Slice&lt;0&gt;(p)).data()));
1015      EXPECT_EQ(
1016          0, Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(5).Slice&lt;0&gt;(p)).data()));
1017      EXPECT_EQ(
1018          0,
1019          Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(0, 0).Slice&lt;0&gt;(p)).data()));
1020      EXPECT_EQ(
1021          0,
1022          Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(0, 0).Slice&lt;1&gt;(p)).data()));
1023      EXPECT_EQ(
1024          0,
1025          Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(1, 0).Slice&lt;0&gt;(p)).data()));
1026      EXPECT_EQ(
1027          4,
1028          Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(1, 0).Slice&lt;1&gt;(p)).data()));
1029      EXPECT_EQ(
1030          0,
1031          Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(5, 3).Slice&lt;0&gt;(p)).data()));
1032      EXPECT_EQ(
1033          8,
1034          Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(5, 3).Slice&lt;1&gt;(p)).data()));
1035      EXPECT_EQ(
1036          0, Distance(
1037                 p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;0&gt;(p)).data()));
1038      EXPECT_EQ(
1039          0, Distance(
1040                 p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;1&gt;(p)).data()));
1041      EXPECT_EQ(
1042          0, Distance(
1043                 p, Type&lt;Span&lt;Int128&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;2&gt;(p)).data()));
1044      EXPECT_EQ(
1045          0, Distance(
1046                 p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;0&gt;(p)).data()));
1047      EXPECT_EQ(
1048          4, Distance(
1049                 p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;1&gt;(p)).data()));
1050      EXPECT_EQ(
1051          8, Distance(
1052                 p, Type&lt;Span&lt;Int128&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;2&gt;(p)).data()));
1053      EXPECT_EQ(
1054          0, Distance(
1055                 p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;0&gt;(p)).data()));
1056      EXPECT_EQ(
1057          24, Distance(
1058                  p, Type&lt;Span&lt;Int128&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;2&gt;(p)).data()));
1059      EXPECT_EQ(
1060          8, Distance(
1061                 p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;1&gt;(p)).data()));
1062      EXPECT_EQ(0,
1063                Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L(5, 3, 1).Slice&lt;0&gt;(p)).data()));
1064      EXPECT_EQ(24,
1065                Distance(p, Type&lt;Span&lt;Int128&gt;&gt;(L(5, 3, 1).Slice&lt;2&gt;(p)).data()));
1066      EXPECT_EQ(8,
1067                Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L(5, 3, 1).Slice&lt;1&gt;(p)).data()));
1068    }
1069  }
1070  TEST(Layout, MutableSliceByTypeData) {
1071    alignas(max_align_t) unsigned char p[100] = {0};
1072    {
1073      using L = Layout&lt;int32_t&gt;;
1074      EXPECT_EQ(
1075          0, Distance(
1076                 p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(0).Slice&lt;int32_t&gt;(p)).data()));
1077      EXPECT_EQ(
1078          0, Distance(
1079                 p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(3).Slice&lt;int32_t&gt;(p)).data()));
1080      EXPECT_EQ(0,
1081                Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L(3).Slice&lt;int32_t&gt;(p)).data()));
1082    }
1083    {
1084      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
1085      EXPECT_EQ(
1086          0,
1087          Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(0).Slice&lt;int8_t&gt;(p)).data()));
1088      EXPECT_EQ(
1089          0,
1090          Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(1).Slice&lt;int8_t&gt;(p)).data()));
1091      EXPECT_EQ(
1092          0,
1093          Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(5).Slice&lt;int8_t&gt;(p)).data()));
1094      EXPECT_EQ(
1095          0,
1096          Distance(p,
1097                   Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(0, 0).Slice&lt;int8_t&gt;(p)).data()));
1098      EXPECT_EQ(
1099          0,
1100          Distance(
1101              p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(0, 0).Slice&lt;int32_t&gt;(p)).data()));
1102      EXPECT_EQ(
1103          0,
1104          Distance(p,
1105                   Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(1, 0).Slice&lt;int8_t&gt;(p)).data()));
1106      EXPECT_EQ(
1107          4,
1108          Distance(
1109              p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(1, 0).Slice&lt;int32_t&gt;(p)).data()));
1110      EXPECT_EQ(
1111          0,
1112          Distance(p,
1113                   Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(5, 3).Slice&lt;int8_t&gt;(p)).data()));
1114      EXPECT_EQ(
1115          8,
1116          Distance(
1117              p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(5, 3).Slice&lt;int32_t&gt;(p)).data()));
1118      EXPECT_EQ(
1119          0,
1120          Distance(
1121              p,
1122              Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;int8_t&gt;(p)).data()));
1123      EXPECT_EQ(
1124          0,
1125          Distance(
1126              p,
1127              Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;int32_t&gt;(p)).data()));
1128      EXPECT_EQ(
1129          0,
1130          Distance(
1131              p,
1132              Type&lt;Span&lt;Int128&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;Int128&gt;(p)).data()));
1133      EXPECT_EQ(
1134          0,
1135          Distance(
1136              p,
1137              Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;int8_t&gt;(p)).data()));
1138      EXPECT_EQ(
1139          4,
1140          Distance(
1141              p,
1142              Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;int32_t&gt;(p)).data()));
1143      EXPECT_EQ(
1144          8,
1145          Distance(
1146              p,
1147              Type&lt;Span&lt;Int128&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;Int128&gt;(p)).data()));
1148      EXPECT_EQ(
1149          0,
1150          Distance(
1151              p,
1152              Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;int8_t&gt;(p)).data()));
1153      EXPECT_EQ(
1154          24,
1155          Distance(
1156              p,
1157              Type&lt;Span&lt;Int128&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;Int128&gt;(p)).data()));
1158      EXPECT_EQ(
1159          8,
1160          Distance(
1161              p,
1162              Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;int32_t&gt;(p)).data()));
1163      EXPECT_EQ(
1164          0, Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L(5, 3, 1).Slice&lt;int8_t&gt;(p)).data()));
1165      EXPECT_EQ(
1166          24,
1167          Distance(p, Type&lt;Span&lt;Int128&gt;&gt;(L(5, 3, 1).Slice&lt;Int128&gt;(p)).data()));
1168      EXPECT_EQ(
1169          8,
1170          Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L(5, 3, 1).Slice&lt;int32_t&gt;(p)).data()));
1171    }
1172  }
1173  MATCHER_P(IsSameSlice, slice, &quot;&quot;) {
1174    return arg.size() == slice.size() &amp;&amp; arg.data() == slice.data();
1175  }
1176  template &lt;typename... M&gt;
1177  class TupleMatcher {
1178   public:
1179    explicit TupleMatcher(M... matchers) : matchers_(std::move(matchers)...) {}
1180    template &lt;typename Tuple&gt;
1181    bool MatchAndExplain(const Tuple&amp; p,
1182                         testing::MatchResultListener* &amp;bsol;* listener */) const {
1183      static_assert(std::tuple_size&lt;Tuple&gt;::value == sizeof...(M), &quot;&quot;);
1184      return MatchAndExplainImpl(
1185          p, absl::make_index_sequence&lt;std::tuple_size&lt;Tuple&gt;::value&gt;{});
1186    }
1187    void DescribeTo(::std::ostream* os) const {}
1188    void DescribeNegationTo(::std::ostream* os) const {}
1189   private:
1190    template &lt;typename Tuple, size_t... Is&gt;
1191    bool MatchAndExplainImpl(const Tuple&amp; p, absl::index_sequence&lt;Is...&gt;) const {
1192      return std::min(
1193          {true, testing::SafeMatcherCast&lt;
1194                     const typename std::tuple_element&lt;Is, Tuple&gt;::type&amp;&gt;(
1195                     std::get&lt;Is&gt;(matchers_))
1196                     .Matches(std::get&lt;Is&gt;(p))...});
1197    }
1198    std::tuple&lt;M...&gt; matchers_;
1199  };
1200  template &lt;typename... M&gt;
1201  testing::PolymorphicMatcher&lt;TupleMatcher&lt;M...&gt;&gt; Tuple(M... matchers) {
1202    return testing::MakePolymorphicMatcher(
1203        TupleMatcher&lt;M...&gt;(std::move(matchers)...));
1204  }
1205  TEST(Layout, Slices) {
1206    alignas(max_align_t) const unsigned char p[100] = {0};
1207    using L = Layout&lt;int8_t, int8_t, Int128&gt;;
1208    {
1209      const auto x = L::Partial();
1210      EXPECT_THAT(Type&lt;std::tuple&lt;&gt;&gt;(x.Slices(p)), Tuple());
1211    }
1212    {
1213      const auto x = L::Partial(1);
1214      EXPECT_THAT(Type&lt;std::tuple&lt;Span&lt;const int8_t&gt;&gt;&gt;(x.Slices(p)),
1215                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p))));
1216    }
1217    {
1218      const auto x = L::Partial(1, 2);
1219      EXPECT_THAT(
1220          (Type&lt;std::tuple&lt;Span&lt;const int8_t&gt;, Span&lt;const int8_t&gt;&gt;&gt;(x.Slices(p))),
1221          Tuple(IsSameSlice(x.Slice&lt;0&gt;(p)), IsSameSlice(x.Slice&lt;1&gt;(p))));
1222    }
1223    {
1224      const auto x = L::Partial(1, 2, 3);
1225      EXPECT_THAT((Type&lt;std::tuple&lt;Span&lt;const int8_t&gt;, Span&lt;const int8_t&gt;,
1226                                   Span&lt;const Int128&gt;&gt;&gt;(x.Slices(p))),
1227                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p)), IsSameSlice(x.Slice&lt;1&gt;(p)),
1228                        IsSameSlice(x.Slice&lt;2&gt;(p))));
1229    }
1230    {
1231      const L x(1, 2, 3);
1232      EXPECT_THAT((Type&lt;std::tuple&lt;Span&lt;const int8_t&gt;, Span&lt;const int8_t&gt;,
1233                                   Span&lt;const Int128&gt;&gt;&gt;(x.Slices(p))),
1234                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p)), IsSameSlice(x.Slice&lt;1&gt;(p)),
1235                        IsSameSlice(x.Slice&lt;2&gt;(p))));
1236    }
1237  }
1238  TEST(Layout, MutableSlices) {
1239    alignas(max_align_t) unsigned char p[100] = {0};
1240    using L = Layout&lt;int8_t, int8_t, Int128&gt;;
1241    {
1242      const auto x = L::Partial();
1243      EXPECT_THAT(Type&lt;std::tuple&lt;&gt;&gt;(x.Slices(p)), Tuple());
1244    }
1245    {
1246      const auto x = L::Partial(1);
1247      EXPECT_THAT(Type&lt;std::tuple&lt;Span&lt;int8_t&gt;&gt;&gt;(x.Slices(p)),
1248                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p))));
1249    }
1250    {
1251      const auto x = L::Partial(1, 2);
1252      EXPECT_THAT((Type&lt;std::tuple&lt;Span&lt;int8_t&gt;, Span&lt;int8_t&gt;&gt;&gt;(x.Slices(p))),
1253                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p)), IsSameSlice(x.Slice&lt;1&gt;(p))));
1254    }
1255    {
1256      const auto x = L::Partial(1, 2, 3);
1257      EXPECT_THAT((Type&lt;std::tuple&lt;Span&lt;int8_t&gt;, Span&lt;int8_t&gt;, Span&lt;Int128&gt;&gt;&gt;(
1258                      x.Slices(p))),
1259                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p)), IsSameSlice(x.Slice&lt;1&gt;(p)),
1260                        IsSameSlice(x.Slice&lt;2&gt;(p))));
1261    }
1262    {
1263      const L x(1, 2, 3);
1264      EXPECT_THAT((Type&lt;std::tuple&lt;Span&lt;int8_t&gt;, Span&lt;int8_t&gt;, Span&lt;Int128&gt;&gt;&gt;(
1265                      x.Slices(p))),
1266                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p)), IsSameSlice(x.Slice&lt;1&gt;(p)),
1267                        IsSameSlice(x.Slice&lt;2&gt;(p))));
1268    }
1269  }
1270  TEST(Layout, UnalignedTypes) {
1271    constexpr Layout&lt;unsigned char, unsigned char, unsigned char&gt; x(1, 2, 3);
1272    alignas(max_align_t) unsigned char p[x.AllocSize() + 1];
1273    EXPECT_THAT(x.Pointers(p + 1), Tuple(p + 1, p + 2, p + 4));
1274  }
1275  TEST(Layout, CustomAlignment) {
1276    constexpr Layout&lt;unsigned char, Aligned&lt;unsigned char, 8&gt;&gt; x(1, 2);
1277    alignas(max_align_t) unsigned char p[x.AllocSize()];
1278    EXPECT_EQ(10, x.AllocSize());
1279    EXPECT_THAT(x.Pointers(p), Tuple(p + 0, p + 8));
1280  }
1281  TEST(Layout, OverAligned) {
1282    constexpr size_t M = alignof(max_align_t);
1283    constexpr Layout&lt;unsigned char, Aligned&lt;unsigned char, 2 * M&gt;&gt; x(1, 3);
1284  #ifdef __GNUC__
1285    __attribute__((aligned(2 * M))) unsigned char p[x.AllocSize()];
1286  #else
1287    alignas(2 * M) unsigned char p[x.AllocSize()];
1288  #endif
1289    EXPECT_EQ(2 * M + 3, x.AllocSize());
1290    EXPECT_THAT(x.Pointers(p), Tuple(p + 0, p + 2 * M));
1291  }
1292  TEST(Layout, Alignment) {
1293    static_assert(Layout&lt;int8_t&gt;::Alignment() == 1, &quot;&quot;);
1294    static_assert(Layout&lt;int32_t&gt;::Alignment() == 4, &quot;&quot;);
1295    static_assert(Layout&lt;Int64&gt;::Alignment() == 8, &quot;&quot;);
1296    static_assert(Layout&lt;Aligned&lt;int8_t, 64&gt;&gt;::Alignment() == 64, &quot;&quot;);
1297    static_assert(Layout&lt;int8_t, int32_t, Int64&gt;::Alignment() == 8, &quot;&quot;);
1298    static_assert(Layout&lt;int8_t, Int64, int32_t&gt;::Alignment() == 8, &quot;&quot;);
1299    static_assert(Layout&lt;int32_t, int8_t, Int64&gt;::Alignment() == 8, &quot;&quot;);
1300    static_assert(Layout&lt;int32_t, Int64, int8_t&gt;::Alignment() == 8, &quot;&quot;);
1301    static_assert(Layout&lt;Int64, int8_t, int32_t&gt;::Alignment() == 8, &quot;&quot;);
1302    static_assert(Layout&lt;Int64, int32_t, int8_t&gt;::Alignment() == 8, &quot;&quot;);
1303  }
1304  TEST(Layout, ConstexprPartial) {
1305    constexpr size_t M = alignof(max_align_t);
1306    constexpr Layout&lt;unsigned char, Aligned&lt;unsigned char, 2 * M&gt;&gt; x(1, 3);
1307    static_assert(x.Partial(1).template Offset&lt;1&gt;() == 2 * M, &quot;&quot;);
1308  }
1309  struct Region {
1310    size_t from;
1311    size_t to;
1312  };
1313  void ExpectRegionPoisoned(const unsigned char* p, size_t n, bool poisoned) {
1314  #ifdef ABSL_HAVE_ADDRESS_SANITIZER
1315    for (size_t i = 0; i != n; ++i) {
1316      EXPECT_EQ(poisoned, __asan_address_is_poisoned(p + i));
1317    }
1318  #endif
1319  }
1320  template &lt;size_t N&gt;
1321  void ExpectPoisoned(const unsigned char (&amp;buf)[N],
1322                      std::initializer_list&lt;Region&gt; reg) {
1323    size_t prev = 0;
1324    for (const Region&amp; r : reg) {
1325      ExpectRegionPoisoned(buf + prev, r.from - prev, false);
1326      ExpectRegionPoisoned(buf + r.from, r.to - r.from, true);
1327      prev = r.to;
1328    }
1329    ExpectRegionPoisoned(buf + prev, N - prev, false);
1330  }
1331  TEST(Layout, PoisonPadding) {
1332    using L = Layout&lt;int8_t, Int64, int32_t, Int128&gt;;
1333    constexpr size_t n = L::Partial(1, 2, 3, 4).AllocSize();
1334    {
1335      constexpr auto x = L::Partial();
1336      alignas(max_align_t) const unsigned char c[n] = {};
1337      x.PoisonPadding(c);
1338      EXPECT_EQ(x.Slices(c), x.Slices(c));
1339      ExpectPoisoned(c, {});
1340    }
1341    {
1342      constexpr auto x = L::Partial(1);
1343      alignas(max_align_t) const unsigned char c[n] = {};
1344      x.PoisonPadding(c);
1345      EXPECT_EQ(x.Slices(c), x.Slices(c));
1346      ExpectPoisoned(c, {{1, 8}});
1347    }
1348    {
1349      constexpr auto x = L::Partial(1, 2);
1350      alignas(max_align_t) const unsigned char c[n] = {};
1351      x.PoisonPadding(c);
1352      EXPECT_EQ(x.Slices(c), x.Slices(c));
1353      ExpectPoisoned(c, {{1, 8}});
1354    }
1355    {
1356      constexpr auto x = L::Partial(1, 2, 3);
1357      alignas(max_align_t) const unsigned char c[n] = {};
1358      x.PoisonPadding(c);
1359      EXPECT_EQ(x.Slices(c), x.Slices(c));
1360      ExpectPoisoned(c, {{1, 8}, {36, 40}});
1361    }
1362    {
1363      constexpr auto x = L::Partial(1, 2, 3, 4);
1364      alignas(max_align_t) const unsigned char c[n] = {};
1365      x.PoisonPadding(c);
1366      EXPECT_EQ(x.Slices(c), x.Slices(c));
1367      ExpectPoisoned(c, {{1, 8}, {36, 40}});
1368    }
1369    {
1370      constexpr L x(1, 2, 3, 4);
1371      alignas(max_align_t) const unsigned char c[n] = {};
1372      x.PoisonPadding(c);
1373      EXPECT_EQ(x.Slices(c), x.Slices(c));
1374      ExpectPoisoned(c, {{1, 8}, {36, 40}});
1375    }
1376  }
1377  TEST(Layout, DebugString) {
1378    {
1379      constexpr auto x = Layout&lt;int8_t, int32_t, int8_t, Int128&gt;::Partial();
1380      EXPECT_EQ(&quot;@0&lt;signed char&gt;(1)&quot;, x.DebugString());
1381    }
1382    {
1383      constexpr auto x = Layout&lt;int8_t, int32_t, int8_t, Int128&gt;::Partial(1);
1384      EXPECT_EQ(&quot;@0&lt;signed char&gt;(1)[1]; @4&lt;int&gt;(4)&quot;, x.DebugString());
1385    }
1386    {
1387      constexpr auto x = Layout&lt;int8_t, int32_t, int8_t, Int128&gt;::Partial(1, 2);
1388      EXPECT_EQ(&quot;@0&lt;signed char&gt;(1)[1]; @4&lt;int&gt;(4)[2]; @12&lt;signed char&gt;(1)&quot;,
1389                x.DebugString());
1390    }
1391    {
1392      constexpr auto x =
1393          Layout&lt;int8_t, int32_t, int8_t, Int128&gt;::Partial(1, 2, 3);
1394      EXPECT_EQ(
1395          &quot;@0&lt;signed char&gt;(1)[1]; @4&lt;int&gt;(4)[2]; @12&lt;signed char&gt;(1)[3]; &quot;
1396          &quot;@16&quot; +
1397              Int128::Name() + &quot;(16)&quot;,
1398          x.DebugString());
1399    }
1400    {
1401      constexpr auto x =
1402          Layout&lt;int8_t, int32_t, int8_t, Int128&gt;::Partial(1, 2, 3, 4);
1403      EXPECT_EQ(
1404          &quot;@0&lt;signed char&gt;(1)[1]; @4&lt;int&gt;(4)[2]; @12&lt;signed char&gt;(1)[3]; &quot;
1405          &quot;@16&quot; +
1406              Int128::Name() + &quot;(16)[4]&quot;,
1407          x.DebugString());
1408    }
1409    {
1410      constexpr Layout&lt;int8_t, int32_t, int8_t, Int128&gt; x(1, 2, 3, 4);
1411      EXPECT_EQ(
1412          &quot;@0&lt;signed char&gt;(1)[1]; @4&lt;int&gt;(4)[2]; @12&lt;signed char&gt;(1)[3]; &quot;
1413          &quot;@16&quot; +
1414              Int128::Name() + &quot;(16)[4]&quot;,
1415          x.DebugString());
1416    }
1417  }
1418  TEST(Layout, CharTypes) {
1419    constexpr Layout&lt;int32_t&gt; x(1);
1420    alignas(max_align_t) char c[x.AllocSize()] = {};
1421    alignas(max_align_t) unsigned char uc[x.AllocSize()] = {};
1422    alignas(max_align_t) signed char sc[x.AllocSize()] = {};
1423    alignas(max_align_t) const char cc[x.AllocSize()] = {};
1424    alignas(max_align_t) const unsigned char cuc[x.AllocSize()] = {};
1425    alignas(max_align_t) const signed char csc[x.AllocSize()] = {};
1426    Type&lt;int32_t*&gt;(x.Pointer&lt;0&gt;(c));
1427    Type&lt;int32_t*&gt;(x.Pointer&lt;0&gt;(uc));
1428    Type&lt;int32_t*&gt;(x.Pointer&lt;0&gt;(sc));
1429    Type&lt;const int32_t*&gt;(x.Pointer&lt;0&gt;(cc));
1430    Type&lt;const int32_t*&gt;(x.Pointer&lt;0&gt;(cuc));
1431    Type&lt;const int32_t*&gt;(x.Pointer&lt;0&gt;(csc));
1432    Type&lt;int32_t*&gt;(x.Pointer&lt;int32_t&gt;(c));
1433    Type&lt;int32_t*&gt;(x.Pointer&lt;int32_t&gt;(uc));
1434    Type&lt;int32_t*&gt;(x.Pointer&lt;int32_t&gt;(sc));
1435    Type&lt;const int32_t*&gt;(x.Pointer&lt;int32_t&gt;(cc));
1436    Type&lt;const int32_t*&gt;(x.Pointer&lt;int32_t&gt;(cuc));
1437    Type&lt;const int32_t*&gt;(x.Pointer&lt;int32_t&gt;(csc));
1438    Type&lt;std::tuple&lt;int32_t*&gt;&gt;(x.Pointers(c));
1439    Type&lt;std::tuple&lt;int32_t*&gt;&gt;(x.Pointers(uc));
1440    Type&lt;std::tuple&lt;int32_t*&gt;&gt;(x.Pointers(sc));
1441    Type&lt;std::tuple&lt;const int32_t*&gt;&gt;(x.Pointers(cc));
1442    Type&lt;std::tuple&lt;const int32_t*&gt;&gt;(x.Pointers(cuc));
1443    Type&lt;std::tuple&lt;const int32_t*&gt;&gt;(x.Pointers(csc));
1444    Type&lt;Span&lt;int32_t&gt;&gt;(x.Slice&lt;0&gt;(c));
1445    Type&lt;Span&lt;int32_t&gt;&gt;(x.Slice&lt;0&gt;(uc));
1446    Type&lt;Span&lt;int32_t&gt;&gt;(x.Slice&lt;0&gt;(sc));
1447    Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;0&gt;(cc));
1448    Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;0&gt;(cuc));
1449    Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;0&gt;(csc));
1450    Type&lt;std::tuple&lt;Span&lt;int32_t&gt;&gt;&gt;(x.Slices(c));
1451    Type&lt;std::tuple&lt;Span&lt;int32_t&gt;&gt;&gt;(x.Slices(uc));
<span onclick='openModal()' class='match'>1452    Type&lt;std::tuple&lt;Span&lt;int32_t&gt;&gt;&gt;(x.Slices(sc));
1453    Type&lt;std::tuple&lt;Span&lt;const int32_t&gt;&gt;&gt;(x.Slices(cc));
</span>1454    Type&lt;std::tuple&lt;Span&lt;const int32_t&gt;&gt;&gt;(x.Slices(cuc));
1455    Type&lt;std::tuple&lt;Span&lt;const int32_t&gt;&gt;&gt;(x.Slices(csc));
1456  }
1457  TEST(Layout, ConstElementType) {
1458    constexpr Layout&lt;const int32_t&gt; x(1);
1459    alignas(int32_t) char c[x.AllocSize()] = {};
1460    const char* cc = c;
1461    const int32_t* p = reinterpret_cast&lt;const int32_t*&gt;(cc);
1462    EXPECT_EQ(alignof(int32_t), x.Alignment());
1463    EXPECT_EQ(0, x.Offset&lt;0&gt;());
1464    EXPECT_EQ(0, x.Offset&lt;const int32_t&gt;());
1465    EXPECT_THAT(x.Offsets(), ElementsAre(0));
1466    EXPECT_EQ(1, x.Size&lt;0&gt;());
1467    EXPECT_EQ(1, x.Size&lt;const int32_t&gt;());
1468    EXPECT_THAT(x.Sizes(), ElementsAre(1));
1469    EXPECT_EQ(sizeof(int32_t), x.AllocSize());
1470    EXPECT_EQ(p, Type&lt;const int32_t*&gt;(x.Pointer&lt;0&gt;(c)));
1471    EXPECT_EQ(p, Type&lt;const int32_t*&gt;(x.Pointer&lt;0&gt;(cc)));
1472    EXPECT_EQ(p, Type&lt;const int32_t*&gt;(x.Pointer&lt;const int32_t&gt;(c)));
1473    EXPECT_EQ(p, Type&lt;const int32_t*&gt;(x.Pointer&lt;const int32_t&gt;(cc)));
1474    EXPECT_THAT(Type&lt;std::tuple&lt;const int32_t*&gt;&gt;(x.Pointers(c)), Tuple(p));
1475    EXPECT_THAT(Type&lt;std::tuple&lt;const int32_t*&gt;&gt;(x.Pointers(cc)), Tuple(p));
1476    EXPECT_THAT(Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;0&gt;(c)),
1477                IsSameSlice(Span&lt;const int32_t&gt;(p, 1)));
1478    EXPECT_THAT(Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;0&gt;(cc)),
1479                IsSameSlice(Span&lt;const int32_t&gt;(p, 1)));
1480    EXPECT_THAT(Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;const int32_t&gt;(c)),
1481                IsSameSlice(Span&lt;const int32_t&gt;(p, 1)));
1482    EXPECT_THAT(Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;const int32_t&gt;(cc)),
1483                IsSameSlice(Span&lt;const int32_t&gt;(p, 1)));
1484    EXPECT_THAT(Type&lt;std::tuple&lt;Span&lt;const int32_t&gt;&gt;&gt;(x.Slices(c)),
1485                Tuple(IsSameSlice(Span&lt;const int32_t&gt;(p, 1))));
1486    EXPECT_THAT(Type&lt;std::tuple&lt;Span&lt;const int32_t&gt;&gt;&gt;(x.Slices(cc)),
1487                Tuple(IsSameSlice(Span&lt;const int32_t&gt;(p, 1))));
1488  }
1489  namespace example {
1490  class CompactString {
1491   public:
1492    CompactString(const char* s = &quot;&quot;) {  
1493      const size_t size = strlen(s);
1494      const L layout(1, size + 1);
1495      p_.reset(new unsigned char[layout.AllocSize()]);
1496      layout.PoisonPadding(p_.get());
1497      *layout.Pointer&lt;size_t&gt;(p_.get()) = size;
1498      memcpy(layout.Pointer&lt;char&gt;(p_.get()), s, size + 1);
1499    }
1500    size_t size() const {
1501      return *L::Partial().Pointer&lt;size_t&gt;(p_.get());
1502    }
1503    const char* c_str() const {
1504      return L::Partial(1).Pointer&lt;char&gt;(p_.get());
1505    }
1506   private:
1507    using L = Layout&lt;size_t, char&gt;;
1508    std::unique_ptr&lt;unsigned char[]&gt; p_;
1509  };
1510  TEST(CompactString, Works) {
1511    CompactString s = &quot;hello&quot;;
1512    EXPECT_EQ(5, s.size());
1513    EXPECT_STREQ(&quot;hello&quot;, s.c_str());
1514  }
1515  }  
1516  }  
1517  }  
1518  ABSL_NAMESPACE_END
1519  }  
</code></pre>
        </div>
        <div class="column">
            <h3>abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-layout_test.cc</h3>
            <pre><code>1  #include &quot;absl/container/internal/layout.h&quot;
2  #include &lt;stddef.h&gt;
3  #include &lt;cstdint&gt;
4  #include &lt;memory&gt;
5  #include &lt;sstream&gt;
6  #include &lt;type_traits&gt;
7  #include &quot;gmock/gmock.h&quot;
8  #include &quot;gtest/gtest.h&quot;
9  #include &quot;absl/base/config.h&quot;
10  #include &quot;absl/log/check.h&quot;
11  #include &quot;absl/types/span.h&quot;
12  namespace absl {
13  ABSL_NAMESPACE_BEGIN
14  namespace container_internal {
15  namespace {
16  using ::absl::Span;
17  using ::testing::ElementsAre;
18  size_t Distance(const void* from, const void* to) {
19    CHECK_LE(from, to) &lt;&lt; &quot;Distance must be non-negative&quot;;
20    return static_cast&lt;const char*&gt;(to) - static_cast&lt;const char*&gt;(from);
21  }
22  template &lt;class Expected, class Actual&gt;
23  Expected Type(Actual val) {
24    static_assert(std::is_same&lt;Expected, Actual&gt;(), &quot;&quot;);
25    return val;
26  }
27  struct alignas(8) Int128 {
28    uint64_t a, b;
29    friend bool operator==(Int128 lhs, Int128 rhs) {
30      return std::tie(lhs.a, lhs.b) == std::tie(rhs.a, rhs.b);
31    }
32    static std::string Name() {
33      return internal_layout::adl_barrier::TypeName&lt;Int128&gt;();
34    }
35  };
36  struct alignas(8) Int64 {
37    int64_t a;
38    friend bool operator==(Int64 lhs, Int64 rhs) {
39      return lhs.a == rhs.a;
40    }
41  };
42  static_assert(sizeof(int8_t) == 1, &quot;&quot;);
43  static_assert(alignof(int8_t) == 1, &quot;&quot;);
44  static_assert(sizeof(int16_t) == 2, &quot;&quot;);
45  static_assert(alignof(int16_t) == 2, &quot;&quot;);
46  static_assert(sizeof(int32_t) == 4, &quot;&quot;);
47  static_assert(alignof(int32_t) == 4, &quot;&quot;);
48  static_assert(sizeof(Int64) == 8, &quot;&quot;);
49  static_assert(alignof(Int64) == 8, &quot;&quot;);
50  static_assert(sizeof(Int128) == 16, &quot;&quot;);
51  static_assert(alignof(Int128) == 8, &quot;&quot;);
52  template &lt;class Expected, class Actual&gt;
53  void SameType() {
54    static_assert(std::is_same&lt;Expected, Actual&gt;(), &quot;&quot;);
55  }
56  TEST(Layout, ElementType) {
57    {
58      using L = Layout&lt;int32_t&gt;;
59      SameType&lt;int32_t, L::ElementType&lt;0&gt;&gt;();
60      SameType&lt;int32_t, decltype(L::Partial())::ElementType&lt;0&gt;&gt;();
61      SameType&lt;int32_t, decltype(L::Partial(0))::ElementType&lt;0&gt;&gt;();
62    }
63    {
64      using L = Layout&lt;int32_t, int32_t&gt;;
65      SameType&lt;int32_t, L::ElementType&lt;0&gt;&gt;();
66      SameType&lt;int32_t, L::ElementType&lt;1&gt;&gt;();
67      SameType&lt;int32_t, decltype(L::Partial())::ElementType&lt;0&gt;&gt;();
68      SameType&lt;int32_t, decltype(L::Partial())::ElementType&lt;1&gt;&gt;();
69      SameType&lt;int32_t, decltype(L::Partial(0))::ElementType&lt;0&gt;&gt;();
70      SameType&lt;int32_t, decltype(L::Partial(0))::ElementType&lt;1&gt;&gt;();
71    }
72    {
73      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
74      SameType&lt;int8_t, L::ElementType&lt;0&gt;&gt;();
75      SameType&lt;int32_t, L::ElementType&lt;1&gt;&gt;();
76      SameType&lt;Int128, L::ElementType&lt;2&gt;&gt;();
77      SameType&lt;int8_t, decltype(L::Partial())::ElementType&lt;0&gt;&gt;();
78      SameType&lt;int8_t, decltype(L::Partial(0))::ElementType&lt;0&gt;&gt;();
79      SameType&lt;int32_t, decltype(L::Partial(0))::ElementType&lt;1&gt;&gt;();
80      SameType&lt;int8_t, decltype(L::Partial(0, 0))::ElementType&lt;0&gt;&gt;();
81      SameType&lt;int32_t, decltype(L::Partial(0, 0))::ElementType&lt;1&gt;&gt;();
82      SameType&lt;Int128, decltype(L::Partial(0, 0))::ElementType&lt;2&gt;&gt;();
83      SameType&lt;int8_t, decltype(L::Partial(0, 0, 0))::ElementType&lt;0&gt;&gt;();
84      SameType&lt;int32_t, decltype(L::Partial(0, 0, 0))::ElementType&lt;1&gt;&gt;();
85      SameType&lt;Int128, decltype(L::Partial(0, 0, 0))::ElementType&lt;2&gt;&gt;();
86    }
87  }
88  TEST(Layout, ElementTypes) {
89    {
90      using L = Layout&lt;int32_t&gt;;
91      SameType&lt;std::tuple&lt;int32_t&gt;, L::ElementTypes&gt;();
92      SameType&lt;std::tuple&lt;int32_t&gt;, decltype(L::Partial())::ElementTypes&gt;();
93      SameType&lt;std::tuple&lt;int32_t&gt;, decltype(L::Partial(0))::ElementTypes&gt;();
94    }
95    {
96      using L = Layout&lt;int32_t, int32_t&gt;;
97      SameType&lt;std::tuple&lt;int32_t, int32_t&gt;, L::ElementTypes&gt;();
98      SameType&lt;std::tuple&lt;int32_t, int32_t&gt;,
99               decltype(L::Partial())::ElementTypes&gt;();
100      SameType&lt;std::tuple&lt;int32_t, int32_t&gt;,
101               decltype(L::Partial(0))::ElementTypes&gt;();
102    }
103    {
104      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
105      SameType&lt;std::tuple&lt;int8_t, int32_t, Int128&gt;, L::ElementTypes&gt;();
106      SameType&lt;std::tuple&lt;int8_t, int32_t, Int128&gt;,
107               decltype(L::Partial())::ElementTypes&gt;();
108      SameType&lt;std::tuple&lt;int8_t, int32_t, Int128&gt;,
109               decltype(L::Partial(0))::ElementTypes&gt;();
110      SameType&lt;std::tuple&lt;int8_t, int32_t, Int128&gt;,
111               decltype(L::Partial(0, 0))::ElementTypes&gt;();
112      SameType&lt;std::tuple&lt;int8_t, int32_t, Int128&gt;,
113               decltype(L::Partial(0, 0, 0))::ElementTypes&gt;();
114    }
115  }
116  TEST(Layout, OffsetByIndex) {
117    {
118      using L = Layout&lt;int32_t&gt;;
119      EXPECT_EQ(0, L::Partial().Offset&lt;0&gt;());
120      EXPECT_EQ(0, L::Partial(3).Offset&lt;0&gt;());
121      EXPECT_EQ(0, L(3).Offset&lt;0&gt;());
122    }
123    {
124      using L = Layout&lt;int32_t, int32_t&gt;;
125      EXPECT_EQ(0, L::Partial().Offset&lt;0&gt;());
126      EXPECT_EQ(0, L::Partial(3).Offset&lt;0&gt;());
127      EXPECT_EQ(12, L::Partial(3).Offset&lt;1&gt;());
128      EXPECT_EQ(0, L::Partial(3, 5).Offset&lt;0&gt;());
129      EXPECT_EQ(12, L::Partial(3, 5).Offset&lt;1&gt;());
130      EXPECT_EQ(0, L(3, 5).Offset&lt;0&gt;());
131      EXPECT_EQ(12, L(3, 5).Offset&lt;1&gt;());
132    }
133    {
134      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
135      EXPECT_EQ(0, L::Partial().Offset&lt;0&gt;());
136      EXPECT_EQ(0, L::Partial(0).Offset&lt;0&gt;());
137      EXPECT_EQ(0, L::Partial(0).Offset&lt;1&gt;());
138      EXPECT_EQ(0, L::Partial(1).Offset&lt;0&gt;());
139      EXPECT_EQ(4, L::Partial(1).Offset&lt;1&gt;());
140      EXPECT_EQ(0, L::Partial(5).Offset&lt;0&gt;());
141      EXPECT_EQ(8, L::Partial(5).Offset&lt;1&gt;());
142      EXPECT_EQ(0, L::Partial(0, 0).Offset&lt;0&gt;());
143      EXPECT_EQ(0, L::Partial(0, 0).Offset&lt;1&gt;());
144      EXPECT_EQ(0, L::Partial(0, 0).Offset&lt;2&gt;());
145      EXPECT_EQ(0, L::Partial(1, 0).Offset&lt;0&gt;());
146      EXPECT_EQ(4, L::Partial(1, 0).Offset&lt;1&gt;());
147      EXPECT_EQ(8, L::Partial(1, 0).Offset&lt;2&gt;());
148      EXPECT_EQ(0, L::Partial(5, 3).Offset&lt;0&gt;());
149      EXPECT_EQ(8, L::Partial(5, 3).Offset&lt;1&gt;());
150      EXPECT_EQ(24, L::Partial(5, 3).Offset&lt;2&gt;());
151      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset&lt;0&gt;());
152      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset&lt;1&gt;());
153      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset&lt;2&gt;());
154      EXPECT_EQ(0, L::Partial(1, 0, 0).Offset&lt;0&gt;());
155      EXPECT_EQ(4, L::Partial(1, 0, 0).Offset&lt;1&gt;());
156      EXPECT_EQ(8, L::Partial(1, 0, 0).Offset&lt;2&gt;());
157      EXPECT_EQ(0, L::Partial(5, 3, 1).Offset&lt;0&gt;());
158      EXPECT_EQ(24, L::Partial(5, 3, 1).Offset&lt;2&gt;());
159      EXPECT_EQ(8, L::Partial(5, 3, 1).Offset&lt;1&gt;());
160      EXPECT_EQ(0, L(5, 3, 1).Offset&lt;0&gt;());
161      EXPECT_EQ(24, L(5, 3, 1).Offset&lt;2&gt;());
162      EXPECT_EQ(8, L(5, 3, 1).Offset&lt;1&gt;());
163    }
164  }
165  TEST(Layout, OffsetByType) {
166    {
167      using L = Layout&lt;int32_t&gt;;
168      EXPECT_EQ(0, L::Partial().Offset&lt;int32_t&gt;());
169      EXPECT_EQ(0, L::Partial(3).Offset&lt;int32_t&gt;());
170      EXPECT_EQ(0, L(3).Offset&lt;int32_t&gt;());
171    }
172    {
173      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
174      EXPECT_EQ(0, L::Partial().Offset&lt;int8_t&gt;());
175      EXPECT_EQ(0, L::Partial(0).Offset&lt;int8_t&gt;());
176      EXPECT_EQ(0, L::Partial(0).Offset&lt;int32_t&gt;());
177      EXPECT_EQ(0, L::Partial(1).Offset&lt;int8_t&gt;());
178      EXPECT_EQ(4, L::Partial(1).Offset&lt;int32_t&gt;());
179      EXPECT_EQ(0, L::Partial(5).Offset&lt;int8_t&gt;());
180      EXPECT_EQ(8, L::Partial(5).Offset&lt;int32_t&gt;());
181      EXPECT_EQ(0, L::Partial(0, 0).Offset&lt;int8_t&gt;());
182      EXPECT_EQ(0, L::Partial(0, 0).Offset&lt;int32_t&gt;());
183      EXPECT_EQ(0, L::Partial(0, 0).Offset&lt;Int128&gt;());
184      EXPECT_EQ(0, L::Partial(1, 0).Offset&lt;int8_t&gt;());
185      EXPECT_EQ(4, L::Partial(1, 0).Offset&lt;int32_t&gt;());
186      EXPECT_EQ(8, L::Partial(1, 0).Offset&lt;Int128&gt;());
187      EXPECT_EQ(0, L::Partial(5, 3).Offset&lt;int8_t&gt;());
188      EXPECT_EQ(8, L::Partial(5, 3).Offset&lt;int32_t&gt;());
189      EXPECT_EQ(24, L::Partial(5, 3).Offset&lt;Int128&gt;());
190      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset&lt;int8_t&gt;());
191      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset&lt;int32_t&gt;());
192      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset&lt;Int128&gt;());
193      EXPECT_EQ(0, L::Partial(1, 0, 0).Offset&lt;int8_t&gt;());
194      EXPECT_EQ(4, L::Partial(1, 0, 0).Offset&lt;int32_t&gt;());
195      EXPECT_EQ(8, L::Partial(1, 0, 0).Offset&lt;Int128&gt;());
196      EXPECT_EQ(0, L::Partial(5, 3, 1).Offset&lt;int8_t&gt;());
197      EXPECT_EQ(24, L::Partial(5, 3, 1).Offset&lt;Int128&gt;());
198      EXPECT_EQ(8, L::Partial(5, 3, 1).Offset&lt;int32_t&gt;());
199      EXPECT_EQ(0, L(5, 3, 1).Offset&lt;int8_t&gt;());
200      EXPECT_EQ(24, L(5, 3, 1).Offset&lt;Int128&gt;());
201      EXPECT_EQ(8, L(5, 3, 1).Offset&lt;int32_t&gt;());
202    }
203  }
204  TEST(Layout, Offsets) {
205    {
206      using L = Layout&lt;int32_t&gt;;
207      EXPECT_THAT(L::Partial().Offsets(), ElementsAre(0));
208      EXPECT_THAT(L::Partial(3).Offsets(), ElementsAre(0));
209      EXPECT_THAT(L(3).Offsets(), ElementsAre(0));
210    }
211    {
212      using L = Layout&lt;int32_t, int32_t&gt;;
213      EXPECT_THAT(L::Partial().Offsets(), ElementsAre(0));
214      EXPECT_THAT(L::Partial(3).Offsets(), ElementsAre(0, 12));
215      EXPECT_THAT(L::Partial(3, 5).Offsets(), ElementsAre(0, 12));
216      EXPECT_THAT(L(3, 5).Offsets(), ElementsAre(0, 12));
217    }
218    {
219      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
220      EXPECT_THAT(L::Partial().Offsets(), ElementsAre(0));
221      EXPECT_THAT(L::Partial(1).Offsets(), ElementsAre(0, 4));
222      EXPECT_THAT(L::Partial(5).Offsets(), ElementsAre(0, 8));
223      EXPECT_THAT(L::Partial(0, 0).Offsets(), ElementsAre(0, 0, 0));
224      EXPECT_THAT(L::Partial(1, 0).Offsets(), ElementsAre(0, 4, 8));
225      EXPECT_THAT(L::Partial(5, 3).Offsets(), ElementsAre(0, 8, 24));
226      EXPECT_THAT(L::Partial(0, 0, 0).Offsets(), ElementsAre(0, 0, 0));
227      EXPECT_THAT(L::Partial(1, 0, 0).Offsets(), ElementsAre(0, 4, 8));
228      EXPECT_THAT(L::Partial(5, 3, 1).Offsets(), ElementsAre(0, 8, 24));
229      EXPECT_THAT(L(5, 3, 1).Offsets(), ElementsAre(0, 8, 24));
230    }
231  }
232  TEST(Layout, AllocSize) {
233    {
234      using L = Layout&lt;int32_t&gt;;
235      EXPECT_EQ(0, L::Partial(0).AllocSize());
236      EXPECT_EQ(12, L::Partial(3).AllocSize());
237      EXPECT_EQ(12, L(3).AllocSize());
238    }
239    {
240      using L = Layout&lt;int32_t, int32_t&gt;;
241      EXPECT_EQ(32, L::Partial(3, 5).AllocSize());
242      EXPECT_EQ(32, L(3, 5).AllocSize());
243    }
244    {
245      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
246      EXPECT_EQ(0, L::Partial(0, 0, 0).AllocSize());
247      EXPECT_EQ(8, L::Partial(1, 0, 0).AllocSize());
248      EXPECT_EQ(8, L::Partial(0, 1, 0).AllocSize());
249      EXPECT_EQ(16, L::Partial(0, 0, 1).AllocSize());
250      EXPECT_EQ(24, L::Partial(1, 1, 1).AllocSize());
251      EXPECT_EQ(136, L::Partial(3, 5, 7).AllocSize());
252      EXPECT_EQ(136, L(3, 5, 7).AllocSize());
253    }
254  }
255  TEST(Layout, SizeByIndex) {
256    {
257      using L = Layout&lt;int32_t&gt;;
258      EXPECT_EQ(0, L::Partial(0).Size&lt;0&gt;());
259      EXPECT_EQ(3, L::Partial(3).Size&lt;0&gt;());
260      EXPECT_EQ(3, L(3).Size&lt;0&gt;());
261    }
262    {
263      using L = Layout&lt;int32_t, int32_t&gt;;
264      EXPECT_EQ(0, L::Partial(0).Size&lt;0&gt;());
265      EXPECT_EQ(3, L::Partial(3).Size&lt;0&gt;());
266      EXPECT_EQ(3, L::Partial(3, 5).Size&lt;0&gt;());
267      EXPECT_EQ(5, L::Partial(3, 5).Size&lt;1&gt;());
268      EXPECT_EQ(3, L(3, 5).Size&lt;0&gt;());
269      EXPECT_EQ(5, L(3, 5).Size&lt;1&gt;());
270    }
271    {
272      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
273      EXPECT_EQ(3, L::Partial(3).Size&lt;0&gt;());
274      EXPECT_EQ(3, L::Partial(3, 5).Size&lt;0&gt;());
275      EXPECT_EQ(5, L::Partial(3, 5).Size&lt;1&gt;());
276      EXPECT_EQ(3, L::Partial(3, 5, 7).Size&lt;0&gt;());
277      EXPECT_EQ(5, L::Partial(3, 5, 7).Size&lt;1&gt;());
278      EXPECT_EQ(7, L::Partial(3, 5, 7).Size&lt;2&gt;());
279      EXPECT_EQ(3, L(3, 5, 7).Size&lt;0&gt;());
280      EXPECT_EQ(5, L(3, 5, 7).Size&lt;1&gt;());
281      EXPECT_EQ(7, L(3, 5, 7).Size&lt;2&gt;());
282    }
283  }
284  TEST(Layout, SizeByType) {
285    {
286      using L = Layout&lt;int32_t&gt;;
287      EXPECT_EQ(0, L::Partial(0).Size&lt;int32_t&gt;());
288      EXPECT_EQ(3, L::Partial(3).Size&lt;int32_t&gt;());
289      EXPECT_EQ(3, L(3).Size&lt;int32_t&gt;());
290    }
291    {
292      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
293      EXPECT_EQ(3, L::Partial(3).Size&lt;int8_t&gt;());
294      EXPECT_EQ(3, L::Partial(3, 5).Size&lt;int8_t&gt;());
295      EXPECT_EQ(5, L::Partial(3, 5).Size&lt;int32_t&gt;());
296      EXPECT_EQ(3, L::Partial(3, 5, 7).Size&lt;int8_t&gt;());
297      EXPECT_EQ(5, L::Partial(3, 5, 7).Size&lt;int32_t&gt;());
298      EXPECT_EQ(7, L::Partial(3, 5, 7).Size&lt;Int128&gt;());
299      EXPECT_EQ(3, L(3, 5, 7).Size&lt;int8_t&gt;());
300      EXPECT_EQ(5, L(3, 5, 7).Size&lt;int32_t&gt;());
301      EXPECT_EQ(7, L(3, 5, 7).Size&lt;Int128&gt;());
302    }
303  }
304  TEST(Layout, Sizes) {
305    {
306      using L = Layout&lt;int32_t&gt;;
307      EXPECT_THAT(L::Partial().Sizes(), ElementsAre());
308      EXPECT_THAT(L::Partial(3).Sizes(), ElementsAre(3));
309      EXPECT_THAT(L(3).Sizes(), ElementsAre(3));
310    }
311    {
312      using L = Layout&lt;int32_t, int32_t&gt;;
313      EXPECT_THAT(L::Partial().Sizes(), ElementsAre());
314      EXPECT_THAT(L::Partial(3).Sizes(), ElementsAre(3));
315      EXPECT_THAT(L::Partial(3, 5).Sizes(), ElementsAre(3, 5));
316      EXPECT_THAT(L(3, 5).Sizes(), ElementsAre(3, 5));
317    }
318    {
319      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
320      EXPECT_THAT(L::Partial().Sizes(), ElementsAre());
321      EXPECT_THAT(L::Partial(3).Sizes(), ElementsAre(3));
322      EXPECT_THAT(L::Partial(3, 5).Sizes(), ElementsAre(3, 5));
323      EXPECT_THAT(L::Partial(3, 5, 7).Sizes(), ElementsAre(3, 5, 7));
324      EXPECT_THAT(L(3, 5, 7).Sizes(), ElementsAre(3, 5, 7));
325    }
326  }
327  TEST(Layout, PointerByIndex) {
328    alignas(max_align_t) const unsigned char p[100] = {0};
329    {
330      using L = Layout&lt;int32_t&gt;;
331      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(L::Partial().Pointer&lt;0&gt;(p))));
332      EXPECT_EQ(0,
333                Distance(p, Type&lt;const int32_t*&gt;(L::Partial(3).Pointer&lt;0&gt;(p))));
334      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(L(3).Pointer&lt;0&gt;(p))));
335    }
336    {
337      using L = Layout&lt;int32_t, int32_t&gt;;
338      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(L::Partial().Pointer&lt;0&gt;(p))));
339      EXPECT_EQ(0,
340                Distance(p, Type&lt;const int32_t*&gt;(L::Partial(3).Pointer&lt;0&gt;(p))));
341      EXPECT_EQ(12,
342                Distance(p, Type&lt;const int32_t*&gt;(L::Partial(3).Pointer&lt;1&gt;(p))));
343      EXPECT_EQ(
344          0, Distance(p, Type&lt;const int32_t*&gt;(L::Partial(3, 5).Pointer&lt;0&gt;(p))));
345      EXPECT_EQ(
346          12, Distance(p, Type&lt;const int32_t*&gt;(L::Partial(3, 5).Pointer&lt;1&gt;(p))));
347      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(L(3, 5).Pointer&lt;0&gt;(p))));
348      EXPECT_EQ(12, Distance(p, Type&lt;const int32_t*&gt;(L(3, 5).Pointer&lt;1&gt;(p))));
349    }
350    {
351      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
352      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial().Pointer&lt;0&gt;(p))));
353      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(0).Pointer&lt;0&gt;(p))));
354      EXPECT_EQ(0,
355                Distance(p, Type&lt;const int32_t*&gt;(L::Partial(0).Pointer&lt;1&gt;(p))));
356      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(1).Pointer&lt;0&gt;(p))));
357      EXPECT_EQ(4,
358                Distance(p, Type&lt;const int32_t*&gt;(L::Partial(1).Pointer&lt;1&gt;(p))));
359      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(5).Pointer&lt;0&gt;(p))));
360      EXPECT_EQ(8,
361                Distance(p, Type&lt;const int32_t*&gt;(L::Partial(5).Pointer&lt;1&gt;(p))));
362      EXPECT_EQ(0,
363                Distance(p, Type&lt;const int8_t*&gt;(L::Partial(0, 0).Pointer&lt;0&gt;(p))));
364      EXPECT_EQ(
365          0, Distance(p, Type&lt;const int32_t*&gt;(L::Partial(0, 0).Pointer&lt;1&gt;(p))));
366      EXPECT_EQ(0,
367                Distance(p, Type&lt;const Int128*&gt;(L::Partial(0, 0).Pointer&lt;2&gt;(p))));
368      EXPECT_EQ(0,
369                Distance(p, Type&lt;const int8_t*&gt;(L::Partial(1, 0).Pointer&lt;0&gt;(p))));
370      EXPECT_EQ(
371          4, Distance(p, Type&lt;const int32_t*&gt;(L::Partial(1, 0).Pointer&lt;1&gt;(p))));
372      EXPECT_EQ(8,
373                Distance(p, Type&lt;const Int128*&gt;(L::Partial(1, 0).Pointer&lt;2&gt;(p))));
374      EXPECT_EQ(0,
375                Distance(p, Type&lt;const int8_t*&gt;(L::Partial(5, 3).Pointer&lt;0&gt;(p))));
376      EXPECT_EQ(
377          8, Distance(p, Type&lt;const int32_t*&gt;(L::Partial(5, 3).Pointer&lt;1&gt;(p))));
378      EXPECT_EQ(24,
379                Distance(p, Type&lt;const Int128*&gt;(L::Partial(5, 3).Pointer&lt;2&gt;(p))));
380      EXPECT_EQ(
381          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(0, 0, 0).Pointer&lt;0&gt;(p))));
382      EXPECT_EQ(
383          0,
384          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(0, 0, 0).Pointer&lt;1&gt;(p))));
385      EXPECT_EQ(
386          0, Distance(p, Type&lt;const Int128*&gt;(L::Partial(0, 0, 0).Pointer&lt;2&gt;(p))));
387      EXPECT_EQ(
388          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(1, 0, 0).Pointer&lt;0&gt;(p))));
389      EXPECT_EQ(
390          4,
391          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(1, 0, 0).Pointer&lt;1&gt;(p))));
392      EXPECT_EQ(
393          8, Distance(p, Type&lt;const Int128*&gt;(L::Partial(1, 0, 0).Pointer&lt;2&gt;(p))));
394      EXPECT_EQ(
395          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(5, 3, 1).Pointer&lt;0&gt;(p))));
396      EXPECT_EQ(
397          24,
398          Distance(p, Type&lt;const Int128*&gt;(L::Partial(5, 3, 1).Pointer&lt;2&gt;(p))));
399      EXPECT_EQ(
400          8,
401          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(5, 3, 1).Pointer&lt;1&gt;(p))));
402      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(L(5, 3, 1).Pointer&lt;0&gt;(p))));
403      EXPECT_EQ(24, Distance(p, Type&lt;const Int128*&gt;(L(5, 3, 1).Pointer&lt;2&gt;(p))));
404      EXPECT_EQ(8, Distance(p, Type&lt;const int32_t*&gt;(L(5, 3, 1).Pointer&lt;1&gt;(p))));
405    }
406  }
407  TEST(Layout, PointerByType) {
408    alignas(max_align_t) const unsigned char p[100] = {0};
409    {
410      using L = Layout&lt;int32_t&gt;;
411      EXPECT_EQ(
412          0, Distance(p, Type&lt;const int32_t*&gt;(L::Partial().Pointer&lt;int32_t&gt;(p))));
413      EXPECT_EQ(
414          0,
415          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(3).Pointer&lt;int32_t&gt;(p))));
416      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(L(3).Pointer&lt;int32_t&gt;(p))));
417    }
418    {
419      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
420      EXPECT_EQ(
421          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial().Pointer&lt;int8_t&gt;(p))));
422      EXPECT_EQ(
423          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(0).Pointer&lt;int8_t&gt;(p))));
424      EXPECT_EQ(
425          0,
426          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(0).Pointer&lt;int32_t&gt;(p))));
427      EXPECT_EQ(
428          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(1).Pointer&lt;int8_t&gt;(p))));
429      EXPECT_EQ(
430          4,
431          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(1).Pointer&lt;int32_t&gt;(p))));
432      EXPECT_EQ(
433          0, Distance(p, Type&lt;const int8_t*&gt;(L::Partial(5).Pointer&lt;int8_t&gt;(p))));
434      EXPECT_EQ(
435          8,
436          Distance(p, Type&lt;const int32_t*&gt;(L::Partial(5).Pointer&lt;int32_t&gt;(p))));
437      EXPECT_EQ(
438          0,
439          Distance(p, Type&lt;const int8_t*&gt;(L::Partial(0, 0).Pointer&lt;int8_t&gt;(p))));
440      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(
441                                   L::Partial(0, 0).Pointer&lt;int32_t&gt;(p))));
442      EXPECT_EQ(
443          0,
444          Distance(p, Type&lt;const Int128*&gt;(L::Partial(0, 0).Pointer&lt;Int128&gt;(p))));
445      EXPECT_EQ(
446          0,
447          Distance(p, Type&lt;const int8_t*&gt;(L::Partial(1, 0).Pointer&lt;int8_t&gt;(p))));
448      EXPECT_EQ(4, Distance(p, Type&lt;const int32_t*&gt;(
449                                   L::Partial(1, 0).Pointer&lt;int32_t&gt;(p))));
450      EXPECT_EQ(
451          8,
452          Distance(p, Type&lt;const Int128*&gt;(L::Partial(1, 0).Pointer&lt;Int128&gt;(p))));
453      EXPECT_EQ(
454          0,
455          Distance(p, Type&lt;const int8_t*&gt;(L::Partial(5, 3).Pointer&lt;int8_t&gt;(p))));
456      EXPECT_EQ(8, Distance(p, Type&lt;const int32_t*&gt;(
457                                   L::Partial(5, 3).Pointer&lt;int32_t&gt;(p))));
458      EXPECT_EQ(
459          24,
460          Distance(p, Type&lt;const Int128*&gt;(L::Partial(5, 3).Pointer&lt;Int128&gt;(p))));
461      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(
462                                   L::Partial(0, 0, 0).Pointer&lt;int8_t&gt;(p))));
463      EXPECT_EQ(0, Distance(p, Type&lt;const int32_t*&gt;(
464                                   L::Partial(0, 0, 0).Pointer&lt;int32_t&gt;(p))));
465      EXPECT_EQ(0, Distance(p, Type&lt;const Int128*&gt;(
466                                   L::Partial(0, 0, 0).Pointer&lt;Int128&gt;(p))));
467      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(
468                                   L::Partial(1, 0, 0).Pointer&lt;int8_t&gt;(p))));
469      EXPECT_EQ(4, Distance(p, Type&lt;const int32_t*&gt;(
470                                   L::Partial(1, 0, 0).Pointer&lt;int32_t&gt;(p))));
471      EXPECT_EQ(8, Distance(p, Type&lt;const Int128*&gt;(
472                                   L::Partial(1, 0, 0).Pointer&lt;Int128&gt;(p))));
473      EXPECT_EQ(0, Distance(p, Type&lt;const int8_t*&gt;(
474                                   L::Partial(5, 3, 1).Pointer&lt;int8_t&gt;(p))));
475      EXPECT_EQ(24, Distance(p, Type&lt;const Int128*&gt;(
476                                    L::Partial(5, 3, 1).Pointer&lt;Int128&gt;(p))));
477      EXPECT_EQ(8, Distance(p, Type&lt;const int32_t*&gt;(
478                                   L::Partial(5, 3, 1).Pointer&lt;int32_t&gt;(p))));
479      EXPECT_EQ(24,
480                Distance(p, Type&lt;const Int128*&gt;(L(5, 3, 1).Pointer&lt;Int128&gt;(p))));
481      EXPECT_EQ(
482          8, Distance(p, Type&lt;const int32_t*&gt;(L(5, 3, 1).Pointer&lt;int32_t&gt;(p))));
483    }
484  }
485  TEST(Layout, MutablePointerByIndex) {
486    alignas(max_align_t) unsigned char p[100] = {0};
487    {
488      using L = Layout&lt;int32_t&gt;;
489      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial().Pointer&lt;0&gt;(p))));
490      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial(3).Pointer&lt;0&gt;(p))));
491      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L(3).Pointer&lt;0&gt;(p))));
492    }
493    {
494      using L = Layout&lt;int32_t, int32_t&gt;;
495      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial().Pointer&lt;0&gt;(p))));
496      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial(3).Pointer&lt;0&gt;(p))));
497      EXPECT_EQ(12, Distance(p, Type&lt;int32_t*&gt;(L::Partial(3).Pointer&lt;1&gt;(p))));
498      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial(3, 5).Pointer&lt;0&gt;(p))));
499      EXPECT_EQ(12, Distance(p, Type&lt;int32_t*&gt;(L::Partial(3, 5).Pointer&lt;1&gt;(p))));
500      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L(3, 5).Pointer&lt;0&gt;(p))));
501      EXPECT_EQ(12, Distance(p, Type&lt;int32_t*&gt;(L(3, 5).Pointer&lt;1&gt;(p))));
502    }
503    {
504      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
505      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial().Pointer&lt;0&gt;(p))));
506      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(0).Pointer&lt;0&gt;(p))));
507      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial(0).Pointer&lt;1&gt;(p))));
508      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(1).Pointer&lt;0&gt;(p))));
509      EXPECT_EQ(4, Distance(p, Type&lt;int32_t*&gt;(L::Partial(1).Pointer&lt;1&gt;(p))));
510      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(5).Pointer&lt;0&gt;(p))));
511      EXPECT_EQ(8, Distance(p, Type&lt;int32_t*&gt;(L::Partial(5).Pointer&lt;1&gt;(p))));
512      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(0, 0).Pointer&lt;0&gt;(p))));
513      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial(0, 0).Pointer&lt;1&gt;(p))));
514      EXPECT_EQ(0, Distance(p, Type&lt;Int128*&gt;(L::Partial(0, 0).Pointer&lt;2&gt;(p))));
515      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(1, 0).Pointer&lt;0&gt;(p))));
516      EXPECT_EQ(4, Distance(p, Type&lt;int32_t*&gt;(L::Partial(1, 0).Pointer&lt;1&gt;(p))));
517      EXPECT_EQ(8, Distance(p, Type&lt;Int128*&gt;(L::Partial(1, 0).Pointer&lt;2&gt;(p))));
518      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(5, 3).Pointer&lt;0&gt;(p))));
519      EXPECT_EQ(8, Distance(p, Type&lt;int32_t*&gt;(L::Partial(5, 3).Pointer&lt;1&gt;(p))));
520      EXPECT_EQ(24, Distance(p, Type&lt;Int128*&gt;(L::Partial(5, 3).Pointer&lt;2&gt;(p))));
521      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(0, 0, 0).Pointer&lt;0&gt;(p))));
522      EXPECT_EQ(0,
523                Distance(p, Type&lt;int32_t*&gt;(L::Partial(0, 0, 0).Pointer&lt;1&gt;(p))));
524      EXPECT_EQ(0, Distance(p, Type&lt;Int128*&gt;(L::Partial(0, 0, 0).Pointer&lt;2&gt;(p))));
525      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(1, 0, 0).Pointer&lt;0&gt;(p))));
526      EXPECT_EQ(4,
527                Distance(p, Type&lt;int32_t*&gt;(L::Partial(1, 0, 0).Pointer&lt;1&gt;(p))));
528      EXPECT_EQ(8, Distance(p, Type&lt;Int128*&gt;(L::Partial(1, 0, 0).Pointer&lt;2&gt;(p))));
529      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(5, 3, 1).Pointer&lt;0&gt;(p))));
530      EXPECT_EQ(24,
531                Distance(p, Type&lt;Int128*&gt;(L::Partial(5, 3, 1).Pointer&lt;2&gt;(p))));
532      EXPECT_EQ(8,
533                Distance(p, Type&lt;int32_t*&gt;(L::Partial(5, 3, 1).Pointer&lt;1&gt;(p))));
534      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L(5, 3, 1).Pointer&lt;0&gt;(p))));
535      EXPECT_EQ(24, Distance(p, Type&lt;Int128*&gt;(L(5, 3, 1).Pointer&lt;2&gt;(p))));
536      EXPECT_EQ(8, Distance(p, Type&lt;int32_t*&gt;(L(5, 3, 1).Pointer&lt;1&gt;(p))));
537    }
538  }
539  TEST(Layout, MutablePointerByType) {
540    alignas(max_align_t) unsigned char p[100] = {0};
541    {
542      using L = Layout&lt;int32_t&gt;;
543      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L::Partial().Pointer&lt;int32_t&gt;(p))));
544      EXPECT_EQ(0,
545                Distance(p, Type&lt;int32_t*&gt;(L::Partial(3).Pointer&lt;int32_t&gt;(p))));
546      EXPECT_EQ(0, Distance(p, Type&lt;int32_t*&gt;(L(3).Pointer&lt;int32_t&gt;(p))));
547    }
548    {
549      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
550      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial().Pointer&lt;int8_t&gt;(p))));
551      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(0).Pointer&lt;int8_t&gt;(p))));
552      EXPECT_EQ(0,
553                Distance(p, Type&lt;int32_t*&gt;(L::Partial(0).Pointer&lt;int32_t&gt;(p))));
554      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(1).Pointer&lt;int8_t&gt;(p))));
555      EXPECT_EQ(4,
556                Distance(p, Type&lt;int32_t*&gt;(L::Partial(1).Pointer&lt;int32_t&gt;(p))));
557      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(5).Pointer&lt;int8_t&gt;(p))));
558      EXPECT_EQ(8,
559                Distance(p, Type&lt;int32_t*&gt;(L::Partial(5).Pointer&lt;int32_t&gt;(p))));
560      EXPECT_EQ(0,
561                Distance(p, Type&lt;int8_t*&gt;(L::Partial(0, 0).Pointer&lt;int8_t&gt;(p))));
562      EXPECT_EQ(
563          0, Distance(p, Type&lt;int32_t*&gt;(L::Partial(0, 0).Pointer&lt;int32_t&gt;(p))));
564      EXPECT_EQ(0,
565                Distance(p, Type&lt;Int128*&gt;(L::Partial(0, 0).Pointer&lt;Int128&gt;(p))));
566      EXPECT_EQ(0,
567                Distance(p, Type&lt;int8_t*&gt;(L::Partial(1, 0).Pointer&lt;int8_t&gt;(p))));
568      EXPECT_EQ(
569          4, Distance(p, Type&lt;int32_t*&gt;(L::Partial(1, 0).Pointer&lt;int32_t&gt;(p))));
570      EXPECT_EQ(8,
571                Distance(p, Type&lt;Int128*&gt;(L::Partial(1, 0).Pointer&lt;Int128&gt;(p))));
572      EXPECT_EQ(0,
573                Distance(p, Type&lt;int8_t*&gt;(L::Partial(5, 3).Pointer&lt;int8_t&gt;(p))));
574      EXPECT_EQ(
575          8, Distance(p, Type&lt;int32_t*&gt;(L::Partial(5, 3).Pointer&lt;int32_t&gt;(p))));
576      EXPECT_EQ(24,
577                Distance(p, Type&lt;Int128*&gt;(L::Partial(5, 3).Pointer&lt;Int128&gt;(p))));
578      EXPECT_EQ(
579          0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(0, 0, 0).Pointer&lt;int8_t&gt;(p))));
580      EXPECT_EQ(
581          0,
582          Distance(p, Type&lt;int32_t*&gt;(L::Partial(0, 0, 0).Pointer&lt;int32_t&gt;(p))));
583      EXPECT_EQ(
584          0, Distance(p, Type&lt;Int128*&gt;(L::Partial(0, 0, 0).Pointer&lt;Int128&gt;(p))));
585      EXPECT_EQ(
586          0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(1, 0, 0).Pointer&lt;int8_t&gt;(p))));
587      EXPECT_EQ(
588          4,
589          Distance(p, Type&lt;int32_t*&gt;(L::Partial(1, 0, 0).Pointer&lt;int32_t&gt;(p))));
590      EXPECT_EQ(
591          8, Distance(p, Type&lt;Int128*&gt;(L::Partial(1, 0, 0).Pointer&lt;Int128&gt;(p))));
592      EXPECT_EQ(
593          0, Distance(p, Type&lt;int8_t*&gt;(L::Partial(5, 3, 1).Pointer&lt;int8_t&gt;(p))));
594      EXPECT_EQ(
595          24, Distance(p, Type&lt;Int128*&gt;(L::Partial(5, 3, 1).Pointer&lt;Int128&gt;(p))));
596      EXPECT_EQ(
597          8,
598          Distance(p, Type&lt;int32_t*&gt;(L::Partial(5, 3, 1).Pointer&lt;int32_t&gt;(p))));
599      EXPECT_EQ(0, Distance(p, Type&lt;int8_t*&gt;(L(5, 3, 1).Pointer&lt;int8_t&gt;(p))));
600      EXPECT_EQ(24, Distance(p, Type&lt;Int128*&gt;(L(5, 3, 1).Pointer&lt;Int128&gt;(p))));
601      EXPECT_EQ(8, Distance(p, Type&lt;int32_t*&gt;(L(5, 3, 1).Pointer&lt;int32_t&gt;(p))));
602    }
603  }
604  TEST(Layout, Pointers) {
605    alignas(max_align_t) const unsigned char p[100] = {0};
606    using L = Layout&lt;int8_t, int8_t, Int128&gt;;
607    {
608      const auto x = L::Partial();
609      EXPECT_EQ(std::make_tuple(x.Pointer&lt;0&gt;(p)),
610                Type&lt;std::tuple&lt;const int8_t*&gt;&gt;(x.Pointers(p)));
611    }
612    {
613      const auto x = L::Partial(1);
614      EXPECT_EQ(std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p)),
615                (Type&lt;std::tuple&lt;const int8_t*, const int8_t*&gt;&gt;(x.Pointers(p))));
616    }
617    {
618      const auto x = L::Partial(1, 2);
619      EXPECT_EQ(
620          std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p), x.Pointer&lt;2&gt;(p)),
621          (Type&lt;std::tuple&lt;const int8_t*, const int8_t*, const Int128*&gt;&gt;(
622              x.Pointers(p))));
623    }
624    {
625      const auto x = L::Partial(1, 2, 3);
626      EXPECT_EQ(
627          std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p), x.Pointer&lt;2&gt;(p)),
628          (Type&lt;std::tuple&lt;const int8_t*, const int8_t*, const Int128*&gt;&gt;(
629              x.Pointers(p))));
630    }
631    {
632      const L x(1, 2, 3);
633      EXPECT_EQ(
634          std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p), x.Pointer&lt;2&gt;(p)),
635          (Type&lt;std::tuple&lt;const int8_t*, const int8_t*, const Int128*&gt;&gt;(
636              x.Pointers(p))));
637    }
638  }
639  TEST(Layout, MutablePointers) {
640    alignas(max_align_t) unsigned char p[100] = {0};
641    using L = Layout&lt;int8_t, int8_t, Int128&gt;;
642    {
643      const auto x = L::Partial();
644      EXPECT_EQ(std::make_tuple(x.Pointer&lt;0&gt;(p)),
645                Type&lt;std::tuple&lt;int8_t*&gt;&gt;(x.Pointers(p)));
646    }
647    {
648      const auto x = L::Partial(1);
649      EXPECT_EQ(std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p)),
650                (Type&lt;std::tuple&lt;int8_t*, int8_t*&gt;&gt;(x.Pointers(p))));
651    }
652    {
653      const auto x = L::Partial(1, 2);
654      EXPECT_EQ(
655          std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p), x.Pointer&lt;2&gt;(p)),
656          (Type&lt;std::tuple&lt;int8_t*, int8_t*, Int128*&gt;&gt;(x.Pointers(p))));
657    }
658    {
659      const auto x = L::Partial(1, 2, 3);
660      EXPECT_EQ(
661          std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p), x.Pointer&lt;2&gt;(p)),
662          (Type&lt;std::tuple&lt;int8_t*, int8_t*, Int128*&gt;&gt;(x.Pointers(p))));
663    }
664    {
665      const L x(1, 2, 3);
666      EXPECT_EQ(
667          std::make_tuple(x.Pointer&lt;0&gt;(p), x.Pointer&lt;1&gt;(p), x.Pointer&lt;2&gt;(p)),
668          (Type&lt;std::tuple&lt;int8_t*, int8_t*, Int128*&gt;&gt;(x.Pointers(p))));
669    }
670  }
671  TEST(Layout, SliceByIndexSize) {
672    alignas(max_align_t) const unsigned char p[100] = {0};
673    {
674      using L = Layout&lt;int32_t&gt;;
675      EXPECT_EQ(0, L::Partial(0).Slice&lt;0&gt;(p).size());
676      EXPECT_EQ(3, L::Partial(3).Slice&lt;0&gt;(p).size());
677      EXPECT_EQ(3, L(3).Slice&lt;0&gt;(p).size());
678    }
679    {
680      using L = Layout&lt;int32_t, int32_t&gt;;
681      EXPECT_EQ(3, L::Partial(3).Slice&lt;0&gt;(p).size());
682      EXPECT_EQ(5, L::Partial(3, 5).Slice&lt;1&gt;(p).size());
683      EXPECT_EQ(5, L(3, 5).Slice&lt;1&gt;(p).size());
684    }
685    {
686      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
687      EXPECT_EQ(3, L::Partial(3).Slice&lt;0&gt;(p).size());
688      EXPECT_EQ(3, L::Partial(3, 5).Slice&lt;0&gt;(p).size());
689      EXPECT_EQ(5, L::Partial(3, 5).Slice&lt;1&gt;(p).size());
690      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice&lt;0&gt;(p).size());
691      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice&lt;1&gt;(p).size());
692      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice&lt;2&gt;(p).size());
693      EXPECT_EQ(3, L(3, 5, 7).Slice&lt;0&gt;(p).size());
694      EXPECT_EQ(5, L(3, 5, 7).Slice&lt;1&gt;(p).size());
695      EXPECT_EQ(7, L(3, 5, 7).Slice&lt;2&gt;(p).size());
696    }
697  }
698  TEST(Layout, SliceByTypeSize) {
699    alignas(max_align_t) const unsigned char p[100] = {0};
700    {
701      using L = Layout&lt;int32_t&gt;;
702      EXPECT_EQ(0, L::Partial(0).Slice&lt;int32_t&gt;(p).size());
703      EXPECT_EQ(3, L::Partial(3).Slice&lt;int32_t&gt;(p).size());
704      EXPECT_EQ(3, L(3).Slice&lt;int32_t&gt;(p).size());
705    }
706    {
707      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
708      EXPECT_EQ(3, L::Partial(3).Slice&lt;int8_t&gt;(p).size());
709      EXPECT_EQ(3, L::Partial(3, 5).Slice&lt;int8_t&gt;(p).size());
710      EXPECT_EQ(5, L::Partial(3, 5).Slice&lt;int32_t&gt;(p).size());
711      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice&lt;int8_t&gt;(p).size());
712      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice&lt;int32_t&gt;(p).size());
713      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice&lt;Int128&gt;(p).size());
714      EXPECT_EQ(3, L(3, 5, 7).Slice&lt;int8_t&gt;(p).size());
715      EXPECT_EQ(5, L(3, 5, 7).Slice&lt;int32_t&gt;(p).size());
716      EXPECT_EQ(7, L(3, 5, 7).Slice&lt;Int128&gt;(p).size());
717    }
718  }
719  TEST(Layout, MutableSliceByIndexSize) {
720    alignas(max_align_t) unsigned char p[100] = {0};
721    {
722      using L = Layout&lt;int32_t&gt;;
723      EXPECT_EQ(0, L::Partial(0).Slice&lt;0&gt;(p).size());
724      EXPECT_EQ(3, L::Partial(3).Slice&lt;0&gt;(p).size());
725      EXPECT_EQ(3, L(3).Slice&lt;0&gt;(p).size());
726    }
727    {
728      using L = Layout&lt;int32_t, int32_t&gt;;
729      EXPECT_EQ(3, L::Partial(3).Slice&lt;0&gt;(p).size());
730      EXPECT_EQ(5, L::Partial(3, 5).Slice&lt;1&gt;(p).size());
731      EXPECT_EQ(5, L(3, 5).Slice&lt;1&gt;(p).size());
732    }
733    {
734      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
735      EXPECT_EQ(3, L::Partial(3).Slice&lt;0&gt;(p).size());
736      EXPECT_EQ(3, L::Partial(3, 5).Slice&lt;0&gt;(p).size());
737      EXPECT_EQ(5, L::Partial(3, 5).Slice&lt;1&gt;(p).size());
738      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice&lt;0&gt;(p).size());
739      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice&lt;1&gt;(p).size());
740      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice&lt;2&gt;(p).size());
741      EXPECT_EQ(3, L(3, 5, 7).Slice&lt;0&gt;(p).size());
742      EXPECT_EQ(5, L(3, 5, 7).Slice&lt;1&gt;(p).size());
743      EXPECT_EQ(7, L(3, 5, 7).Slice&lt;2&gt;(p).size());
744    }
745  }
746  TEST(Layout, MutableSliceByTypeSize) {
747    alignas(max_align_t) unsigned char p[100] = {0};
748    {
749      using L = Layout&lt;int32_t&gt;;
750      EXPECT_EQ(0, L::Partial(0).Slice&lt;int32_t&gt;(p).size());
751      EXPECT_EQ(3, L::Partial(3).Slice&lt;int32_t&gt;(p).size());
752      EXPECT_EQ(3, L(3).Slice&lt;int32_t&gt;(p).size());
753    }
754    {
755      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
756      EXPECT_EQ(3, L::Partial(3).Slice&lt;int8_t&gt;(p).size());
757      EXPECT_EQ(3, L::Partial(3, 5).Slice&lt;int8_t&gt;(p).size());
758      EXPECT_EQ(5, L::Partial(3, 5).Slice&lt;int32_t&gt;(p).size());
759      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice&lt;int8_t&gt;(p).size());
760      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice&lt;int32_t&gt;(p).size());
761      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice&lt;Int128&gt;(p).size());
762      EXPECT_EQ(3, L(3, 5, 7).Slice&lt;int8_t&gt;(p).size());
763      EXPECT_EQ(5, L(3, 5, 7).Slice&lt;int32_t&gt;(p).size());
764      EXPECT_EQ(7, L(3, 5, 7).Slice&lt;Int128&gt;(p).size());
765    }
766  }
767  TEST(Layout, SliceByIndexData) {
768    alignas(max_align_t) const unsigned char p[100] = {0};
769    {
770      using L = Layout&lt;int32_t&gt;;
771      EXPECT_EQ(
772          0, Distance(
773                 p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(0).Slice&lt;0&gt;(p)).data()));
774      EXPECT_EQ(
775          0, Distance(
776                 p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(3).Slice&lt;0&gt;(p)).data()));
777      EXPECT_EQ(0,
778                Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(L(3).Slice&lt;0&gt;(p)).data()));
779    }
780    {
781      using L = Layout&lt;int32_t, int32_t&gt;;
782      EXPECT_EQ(
783          0, Distance(
784                 p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(3).Slice&lt;0&gt;(p)).data()));
785      EXPECT_EQ(
786          0,
787          Distance(
788              p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(3, 5).Slice&lt;0&gt;(p)).data()));
789      EXPECT_EQ(
790          12,
791          Distance(
792              p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(3, 5).Slice&lt;1&gt;(p)).data()));
793      EXPECT_EQ(
794          0, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(L(3, 5).Slice&lt;0&gt;(p)).data()));
795      EXPECT_EQ(
796          12, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(L(3, 5).Slice&lt;1&gt;(p)).data()));
797    }
798    {
799      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
800      EXPECT_EQ(
801          0, Distance(
802                 p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(0).Slice&lt;0&gt;(p)).data()));
803      EXPECT_EQ(
804          0, Distance(
805                 p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(1).Slice&lt;0&gt;(p)).data()));
806      EXPECT_EQ(
807          0, Distance(
808                 p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(5).Slice&lt;0&gt;(p)).data()));
809      EXPECT_EQ(
810          0,
811          Distance(
812              p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(0, 0).Slice&lt;0&gt;(p)).data()));
813      EXPECT_EQ(
814          0,
815          Distance(
816              p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(0, 0).Slice&lt;1&gt;(p)).data()));
817      EXPECT_EQ(
818          0,
819          Distance(
820              p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(1, 0).Slice&lt;0&gt;(p)).data()));
821      EXPECT_EQ(
822          4,
823          Distance(
824              p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(1, 0).Slice&lt;1&gt;(p)).data()));
825      EXPECT_EQ(
826          0,
827          Distance(
828              p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(5, 3).Slice&lt;0&gt;(p)).data()));
829      EXPECT_EQ(
830          8,
831          Distance(
832              p, Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(5, 3).Slice&lt;1&gt;(p)).data()));
833      EXPECT_EQ(
834          0,
835          Distance(
836              p,
837              Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;0&gt;(p)).data()));
838      EXPECT_EQ(
839          0,
840          Distance(
841              p,
842              Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;1&gt;(p)).data()));
843      EXPECT_EQ(
844          0,
845          Distance(
846              p,
847              Type&lt;Span&lt;const Int128&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;2&gt;(p)).data()));
848      EXPECT_EQ(
849          0,
850          Distance(
851              p,
852              Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;0&gt;(p)).data()));
853      EXPECT_EQ(
854          4,
855          Distance(
856              p,
857              Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;1&gt;(p)).data()));
858      EXPECT_EQ(
859          8,
860          Distance(
861              p,
862              Type&lt;Span&lt;const Int128&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;2&gt;(p)).data()));
863      EXPECT_EQ(
864          0,
865          Distance(
866              p,
867              Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;0&gt;(p)).data()));
868      EXPECT_EQ(
869          24,
870          Distance(
871              p,
872              Type&lt;Span&lt;const Int128&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;2&gt;(p)).data()));
873      EXPECT_EQ(
874          8,
875          Distance(
876              p,
877              Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;1&gt;(p)).data()));
878      EXPECT_EQ(
879          0,
880          Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(L(5, 3, 1).Slice&lt;0&gt;(p)).data()));
881      EXPECT_EQ(
882          24,
883          Distance(p, Type&lt;Span&lt;const Int128&gt;&gt;(L(5, 3, 1).Slice&lt;2&gt;(p)).data()));
884      EXPECT_EQ(
885          8,
886          Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(L(5, 3, 1).Slice&lt;1&gt;(p)).data()));
887    }
888  }
889  TEST(Layout, SliceByTypeData) {
890    alignas(max_align_t) const unsigned char p[100] = {0};
891    {
892      using L = Layout&lt;int32_t&gt;;
893      EXPECT_EQ(
894          0,
895          Distance(
896              p,
897              Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(0).Slice&lt;int32_t&gt;(p)).data()));
898      EXPECT_EQ(
899          0,
900          Distance(
901              p,
902              Type&lt;Span&lt;const int32_t&gt;&gt;(L::Partial(3).Slice&lt;int32_t&gt;(p)).data()));
903      EXPECT_EQ(
904          0,
905          Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(L(3).Slice&lt;int32_t&gt;(p)).data()));
906    }
907    {
908      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
909      EXPECT_EQ(
910          0,
911          Distance(
912              p,
913              Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(0).Slice&lt;int8_t&gt;(p)).data()));
914      EXPECT_EQ(
915          0,
916          Distance(
917              p,
918              Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(1).Slice&lt;int8_t&gt;(p)).data()));
919      EXPECT_EQ(
920          0,
921          Distance(
922              p,
923              Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(5).Slice&lt;int8_t&gt;(p)).data()));
924      EXPECT_EQ(
925          0,
926          Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(0, 0).Slice&lt;int8_t&gt;(p))
927                          .data()));
928      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(
929                                   L::Partial(0, 0).Slice&lt;int32_t&gt;(p))
930                                   .data()));
931      EXPECT_EQ(
932          0,
933          Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(1, 0).Slice&lt;int8_t&gt;(p))
934                          .data()));
935      EXPECT_EQ(4, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(
936                                   L::Partial(1, 0).Slice&lt;int32_t&gt;(p))
937                                   .data()));
938      EXPECT_EQ(
939          0,
940          Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(L::Partial(5, 3).Slice&lt;int8_t&gt;(p))
941                          .data()));
942      EXPECT_EQ(8, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(
943                                   L::Partial(5, 3).Slice&lt;int32_t&gt;(p))
944                                   .data()));
945      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(
946                                   L::Partial(0, 0, 0).Slice&lt;int8_t&gt;(p))
947                                   .data()));
948      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(
949                                   L::Partial(0, 0, 0).Slice&lt;int32_t&gt;(p))
950                                   .data()));
951      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;const Int128&gt;&gt;(
952                                   L::Partial(0, 0, 0).Slice&lt;Int128&gt;(p))
953                                   .data()));
954      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(
955                                   L::Partial(1, 0, 0).Slice&lt;int8_t&gt;(p))
956                                   .data()));
957      EXPECT_EQ(4, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(
958                                   L::Partial(1, 0, 0).Slice&lt;int32_t&gt;(p))
959                                   .data()));
960      EXPECT_EQ(8, Distance(p, Type&lt;Span&lt;const Int128&gt;&gt;(
961                                   L::Partial(1, 0, 0).Slice&lt;Int128&gt;(p))
962                                   .data()));
963      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;const int8_t&gt;&gt;(
964                                   L::Partial(5, 3, 1).Slice&lt;int8_t&gt;(p))
965                                   .data()));
966      EXPECT_EQ(24, Distance(p, Type&lt;Span&lt;const Int128&gt;&gt;(
967                                    L::Partial(5, 3, 1).Slice&lt;Int128&gt;(p))
968                                    .data()));
969      EXPECT_EQ(8, Distance(p, Type&lt;Span&lt;const int32_t&gt;&gt;(
970                                   L::Partial(5, 3, 1).Slice&lt;int32_t&gt;(p))
971                                   .data()));
972      EXPECT_EQ(
973          0,
974          Distance(p,
975                   Type&lt;Span&lt;const int8_t&gt;&gt;(L(5, 3, 1).Slice&lt;int8_t&gt;(p)).data()));
976      EXPECT_EQ(
977          24,
978          Distance(p,
979                   Type&lt;Span&lt;const Int128&gt;&gt;(L(5, 3, 1).Slice&lt;Int128&gt;(p)).data()));
980      EXPECT_EQ(
981          8,
982          Distance(
983              p, Type&lt;Span&lt;const int32_t&gt;&gt;(L(5, 3, 1).Slice&lt;int32_t&gt;(p)).data()));
984    }
985  }
986  TEST(Layout, MutableSliceByIndexData) {
987    alignas(max_align_t) unsigned char p[100] = {0};
988    {
989      using L = Layout&lt;int32_t&gt;;
990      EXPECT_EQ(
991          0, Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(0).Slice&lt;0&gt;(p)).data()));
992      EXPECT_EQ(
993          0, Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(3).Slice&lt;0&gt;(p)).data()));
994      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L(3).Slice&lt;0&gt;(p)).data()));
995    }
996    {
997      using L = Layout&lt;int32_t, int32_t&gt;;
998      EXPECT_EQ(
999          0, Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(3).Slice&lt;0&gt;(p)).data()));
1000      EXPECT_EQ(
1001          0,
1002          Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(3, 5).Slice&lt;0&gt;(p)).data()));
1003      EXPECT_EQ(
1004          12,
1005          Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(3, 5).Slice&lt;1&gt;(p)).data()));
1006      EXPECT_EQ(0, Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L(3, 5).Slice&lt;0&gt;(p)).data()));
1007      EXPECT_EQ(12, Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L(3, 5).Slice&lt;1&gt;(p)).data()));
1008    }
1009    {
1010      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
1011      EXPECT_EQ(
1012          0, Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(0).Slice&lt;0&gt;(p)).data()));
1013      EXPECT_EQ(
1014          0, Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(1).Slice&lt;0&gt;(p)).data()));
1015      EXPECT_EQ(
1016          0, Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(5).Slice&lt;0&gt;(p)).data()));
1017      EXPECT_EQ(
1018          0,
1019          Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(0, 0).Slice&lt;0&gt;(p)).data()));
1020      EXPECT_EQ(
1021          0,
1022          Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(0, 0).Slice&lt;1&gt;(p)).data()));
1023      EXPECT_EQ(
1024          0,
1025          Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(1, 0).Slice&lt;0&gt;(p)).data()));
1026      EXPECT_EQ(
1027          4,
1028          Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(1, 0).Slice&lt;1&gt;(p)).data()));
1029      EXPECT_EQ(
1030          0,
1031          Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(5, 3).Slice&lt;0&gt;(p)).data()));
1032      EXPECT_EQ(
1033          8,
1034          Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(5, 3).Slice&lt;1&gt;(p)).data()));
1035      EXPECT_EQ(
1036          0, Distance(
1037                 p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;0&gt;(p)).data()));
1038      EXPECT_EQ(
1039          0, Distance(
1040                 p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;1&gt;(p)).data()));
1041      EXPECT_EQ(
1042          0, Distance(
1043                 p, Type&lt;Span&lt;Int128&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;2&gt;(p)).data()));
1044      EXPECT_EQ(
1045          0, Distance(
1046                 p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;0&gt;(p)).data()));
1047      EXPECT_EQ(
1048          4, Distance(
1049                 p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;1&gt;(p)).data()));
1050      EXPECT_EQ(
1051          8, Distance(
1052                 p, Type&lt;Span&lt;Int128&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;2&gt;(p)).data()));
1053      EXPECT_EQ(
1054          0, Distance(
1055                 p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;0&gt;(p)).data()));
1056      EXPECT_EQ(
1057          24, Distance(
1058                  p, Type&lt;Span&lt;Int128&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;2&gt;(p)).data()));
1059      EXPECT_EQ(
1060          8, Distance(
1061                 p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;1&gt;(p)).data()));
1062      EXPECT_EQ(0,
1063                Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L(5, 3, 1).Slice&lt;0&gt;(p)).data()));
1064      EXPECT_EQ(24,
1065                Distance(p, Type&lt;Span&lt;Int128&gt;&gt;(L(5, 3, 1).Slice&lt;2&gt;(p)).data()));
1066      EXPECT_EQ(8,
1067                Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L(5, 3, 1).Slice&lt;1&gt;(p)).data()));
1068    }
1069  }
1070  TEST(Layout, MutableSliceByTypeData) {
1071    alignas(max_align_t) unsigned char p[100] = {0};
1072    {
1073      using L = Layout&lt;int32_t&gt;;
1074      EXPECT_EQ(
1075          0, Distance(
1076                 p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(0).Slice&lt;int32_t&gt;(p)).data()));
1077      EXPECT_EQ(
1078          0, Distance(
1079                 p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(3).Slice&lt;int32_t&gt;(p)).data()));
1080      EXPECT_EQ(0,
1081                Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L(3).Slice&lt;int32_t&gt;(p)).data()));
1082    }
1083    {
1084      using L = Layout&lt;int8_t, int32_t, Int128&gt;;
1085      EXPECT_EQ(
1086          0,
1087          Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(0).Slice&lt;int8_t&gt;(p)).data()));
1088      EXPECT_EQ(
1089          0,
1090          Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(1).Slice&lt;int8_t&gt;(p)).data()));
1091      EXPECT_EQ(
1092          0,
1093          Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(5).Slice&lt;int8_t&gt;(p)).data()));
1094      EXPECT_EQ(
1095          0,
1096          Distance(p,
1097                   Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(0, 0).Slice&lt;int8_t&gt;(p)).data()));
1098      EXPECT_EQ(
1099          0,
1100          Distance(
1101              p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(0, 0).Slice&lt;int32_t&gt;(p)).data()));
1102      EXPECT_EQ(
1103          0,
1104          Distance(p,
1105                   Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(1, 0).Slice&lt;int8_t&gt;(p)).data()));
1106      EXPECT_EQ(
1107          4,
1108          Distance(
1109              p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(1, 0).Slice&lt;int32_t&gt;(p)).data()));
1110      EXPECT_EQ(
1111          0,
1112          Distance(p,
1113                   Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(5, 3).Slice&lt;int8_t&gt;(p)).data()));
1114      EXPECT_EQ(
1115          8,
1116          Distance(
1117              p, Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(5, 3).Slice&lt;int32_t&gt;(p)).data()));
1118      EXPECT_EQ(
1119          0,
1120          Distance(
1121              p,
1122              Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;int8_t&gt;(p)).data()));
1123      EXPECT_EQ(
1124          0,
1125          Distance(
1126              p,
1127              Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;int32_t&gt;(p)).data()));
1128      EXPECT_EQ(
1129          0,
1130          Distance(
1131              p,
1132              Type&lt;Span&lt;Int128&gt;&gt;(L::Partial(0, 0, 0).Slice&lt;Int128&gt;(p)).data()));
1133      EXPECT_EQ(
1134          0,
1135          Distance(
1136              p,
1137              Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;int8_t&gt;(p)).data()));
1138      EXPECT_EQ(
1139          4,
1140          Distance(
1141              p,
1142              Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;int32_t&gt;(p)).data()));
1143      EXPECT_EQ(
1144          8,
1145          Distance(
1146              p,
1147              Type&lt;Span&lt;Int128&gt;&gt;(L::Partial(1, 0, 0).Slice&lt;Int128&gt;(p)).data()));
1148      EXPECT_EQ(
1149          0,
1150          Distance(
1151              p,
1152              Type&lt;Span&lt;int8_t&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;int8_t&gt;(p)).data()));
1153      EXPECT_EQ(
1154          24,
1155          Distance(
1156              p,
1157              Type&lt;Span&lt;Int128&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;Int128&gt;(p)).data()));
1158      EXPECT_EQ(
1159          8,
1160          Distance(
1161              p,
1162              Type&lt;Span&lt;int32_t&gt;&gt;(L::Partial(5, 3, 1).Slice&lt;int32_t&gt;(p)).data()));
1163      EXPECT_EQ(
1164          0, Distance(p, Type&lt;Span&lt;int8_t&gt;&gt;(L(5, 3, 1).Slice&lt;int8_t&gt;(p)).data()));
1165      EXPECT_EQ(
1166          24,
1167          Distance(p, Type&lt;Span&lt;Int128&gt;&gt;(L(5, 3, 1).Slice&lt;Int128&gt;(p)).data()));
1168      EXPECT_EQ(
1169          8,
1170          Distance(p, Type&lt;Span&lt;int32_t&gt;&gt;(L(5, 3, 1).Slice&lt;int32_t&gt;(p)).data()));
1171    }
1172  }
1173  MATCHER_P(IsSameSlice, slice, &quot;&quot;) {
1174    return arg.size() == slice.size() &amp;&amp; arg.data() == slice.data();
1175  }
1176  template &lt;typename... M&gt;
1177  class TupleMatcher {
1178   public:
1179    explicit TupleMatcher(M... matchers) : matchers_(std::move(matchers)...) {}
1180    template &lt;typename Tuple&gt;
1181    bool MatchAndExplain(const Tuple&amp; p,
1182                         testing::MatchResultListener* &amp;bsol;* listener */) const {
1183      static_assert(std::tuple_size&lt;Tuple&gt;::value == sizeof...(M), &quot;&quot;);
1184      return MatchAndExplainImpl(
1185          p, absl::make_index_sequence&lt;std::tuple_size&lt;Tuple&gt;::value&gt;{});
1186    }
1187    void DescribeTo(::std::ostream* os) const {}
1188    void DescribeNegationTo(::std::ostream* os) const {}
1189   private:
1190    template &lt;typename Tuple, size_t... Is&gt;
1191    bool MatchAndExplainImpl(const Tuple&amp; p, absl::index_sequence&lt;Is...&gt;) const {
1192      return std::min(
1193          {true, testing::SafeMatcherCast&lt;
1194                     const typename std::tuple_element&lt;Is, Tuple&gt;::type&amp;&gt;(
1195                     std::get&lt;Is&gt;(matchers_))
1196                     .Matches(std::get&lt;Is&gt;(p))...});
1197    }
1198    std::tuple&lt;M...&gt; matchers_;
1199  };
1200  template &lt;typename... M&gt;
1201  testing::PolymorphicMatcher&lt;TupleMatcher&lt;M...&gt;&gt; Tuple(M... matchers) {
1202    return testing::MakePolymorphicMatcher(
1203        TupleMatcher&lt;M...&gt;(std::move(matchers)...));
1204  }
1205  TEST(Layout, Slices) {
1206    alignas(max_align_t) const unsigned char p[100] = {0};
1207    using L = Layout&lt;int8_t, int8_t, Int128&gt;;
1208    {
1209      const auto x = L::Partial();
1210      EXPECT_THAT(Type&lt;std::tuple&lt;&gt;&gt;(x.Slices(p)), Tuple());
1211    }
1212    {
1213      const auto x = L::Partial(1);
1214      EXPECT_THAT(Type&lt;std::tuple&lt;Span&lt;const int8_t&gt;&gt;&gt;(x.Slices(p)),
1215                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p))));
1216    }
1217    {
1218      const auto x = L::Partial(1, 2);
1219      EXPECT_THAT(
1220          (Type&lt;std::tuple&lt;Span&lt;const int8_t&gt;, Span&lt;const int8_t&gt;&gt;&gt;(x.Slices(p))),
1221          Tuple(IsSameSlice(x.Slice&lt;0&gt;(p)), IsSameSlice(x.Slice&lt;1&gt;(p))));
1222    }
1223    {
1224      const auto x = L::Partial(1, 2, 3);
1225      EXPECT_THAT((Type&lt;std::tuple&lt;Span&lt;const int8_t&gt;, Span&lt;const int8_t&gt;,
1226                                   Span&lt;const Int128&gt;&gt;&gt;(x.Slices(p))),
1227                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p)), IsSameSlice(x.Slice&lt;1&gt;(p)),
1228                        IsSameSlice(x.Slice&lt;2&gt;(p))));
1229    }
1230    {
1231      const L x(1, 2, 3);
1232      EXPECT_THAT((Type&lt;std::tuple&lt;Span&lt;const int8_t&gt;, Span&lt;const int8_t&gt;,
1233                                   Span&lt;const Int128&gt;&gt;&gt;(x.Slices(p))),
1234                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p)), IsSameSlice(x.Slice&lt;1&gt;(p)),
1235                        IsSameSlice(x.Slice&lt;2&gt;(p))));
1236    }
1237  }
1238  TEST(Layout, MutableSlices) {
1239    alignas(max_align_t) unsigned char p[100] = {0};
1240    using L = Layout&lt;int8_t, int8_t, Int128&gt;;
1241    {
1242      const auto x = L::Partial();
1243      EXPECT_THAT(Type&lt;std::tuple&lt;&gt;&gt;(x.Slices(p)), Tuple());
1244    }
1245    {
1246      const auto x = L::Partial(1);
1247      EXPECT_THAT(Type&lt;std::tuple&lt;Span&lt;int8_t&gt;&gt;&gt;(x.Slices(p)),
1248                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p))));
1249    }
1250    {
1251      const auto x = L::Partial(1, 2);
1252      EXPECT_THAT((Type&lt;std::tuple&lt;Span&lt;int8_t&gt;, Span&lt;int8_t&gt;&gt;&gt;(x.Slices(p))),
1253                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p)), IsSameSlice(x.Slice&lt;1&gt;(p))));
1254    }
1255    {
1256      const auto x = L::Partial(1, 2, 3);
1257      EXPECT_THAT((Type&lt;std::tuple&lt;Span&lt;int8_t&gt;, Span&lt;int8_t&gt;, Span&lt;Int128&gt;&gt;&gt;(
1258                      x.Slices(p))),
1259                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p)), IsSameSlice(x.Slice&lt;1&gt;(p)),
1260                        IsSameSlice(x.Slice&lt;2&gt;(p))));
1261    }
1262    {
1263      const L x(1, 2, 3);
1264      EXPECT_THAT((Type&lt;std::tuple&lt;Span&lt;int8_t&gt;, Span&lt;int8_t&gt;, Span&lt;Int128&gt;&gt;&gt;(
1265                      x.Slices(p))),
1266                  Tuple(IsSameSlice(x.Slice&lt;0&gt;(p)), IsSameSlice(x.Slice&lt;1&gt;(p)),
1267                        IsSameSlice(x.Slice&lt;2&gt;(p))));
1268    }
1269  }
1270  TEST(Layout, UnalignedTypes) {
1271    constexpr Layout&lt;unsigned char, unsigned char, unsigned char&gt; x(1, 2, 3);
1272    alignas(max_align_t) unsigned char p[x.AllocSize() + 1];
1273    EXPECT_THAT(x.Pointers(p + 1), Tuple(p + 1, p + 2, p + 4));
1274  }
1275  TEST(Layout, CustomAlignment) {
1276    constexpr Layout&lt;unsigned char, Aligned&lt;unsigned char, 8&gt;&gt; x(1, 2);
1277    alignas(max_align_t) unsigned char p[x.AllocSize()];
1278    EXPECT_EQ(10, x.AllocSize());
1279    EXPECT_THAT(x.Pointers(p), Tuple(p + 0, p + 8));
1280  }
1281  TEST(Layout, OverAligned) {
1282    constexpr size_t M = alignof(max_align_t);
1283    constexpr Layout&lt;unsigned char, Aligned&lt;unsigned char, 2 * M&gt;&gt; x(1, 3);
1284  #ifdef __GNUC__
1285    __attribute__((aligned(2 * M))) unsigned char p[x.AllocSize()];
1286  #else
1287    alignas(2 * M) unsigned char p[x.AllocSize()];
1288  #endif
1289    EXPECT_EQ(2 * M + 3, x.AllocSize());
1290    EXPECT_THAT(x.Pointers(p), Tuple(p + 0, p + 2 * M));
1291  }
1292  TEST(Layout, Alignment) {
1293    static_assert(Layout&lt;int8_t&gt;::Alignment() == 1, &quot;&quot;);
1294    static_assert(Layout&lt;int32_t&gt;::Alignment() == 4, &quot;&quot;);
1295    static_assert(Layout&lt;Int64&gt;::Alignment() == 8, &quot;&quot;);
1296    static_assert(Layout&lt;Aligned&lt;int8_t, 64&gt;&gt;::Alignment() == 64, &quot;&quot;);
1297    static_assert(Layout&lt;int8_t, int32_t, Int64&gt;::Alignment() == 8, &quot;&quot;);
1298    static_assert(Layout&lt;int8_t, Int64, int32_t&gt;::Alignment() == 8, &quot;&quot;);
1299    static_assert(Layout&lt;int32_t, int8_t, Int64&gt;::Alignment() == 8, &quot;&quot;);
1300    static_assert(Layout&lt;int32_t, Int64, int8_t&gt;::Alignment() == 8, &quot;&quot;);
1301    static_assert(Layout&lt;Int64, int8_t, int32_t&gt;::Alignment() == 8, &quot;&quot;);
1302    static_assert(Layout&lt;Int64, int32_t, int8_t&gt;::Alignment() == 8, &quot;&quot;);
1303  }
1304  TEST(Layout, ConstexprPartial) {
1305    constexpr size_t M = alignof(max_align_t);
1306    constexpr Layout&lt;unsigned char, Aligned&lt;unsigned char, 2 * M&gt;&gt; x(1, 3);
1307    static_assert(x.Partial(1).template Offset&lt;1&gt;() == 2 * M, &quot;&quot;);
1308  }
1309  struct Region {
1310    size_t from;
1311    size_t to;
1312  };
1313  void ExpectRegionPoisoned(const unsigned char* p, size_t n, bool poisoned) {
1314  #ifdef ABSL_HAVE_ADDRESS_SANITIZER
1315    for (size_t i = 0; i != n; ++i) {
1316      EXPECT_EQ(poisoned, __asan_address_is_poisoned(p + i));
1317    }
1318  #endif
1319  }
1320  template &lt;size_t N&gt;
1321  void ExpectPoisoned(const unsigned char (&amp;buf)[N],
1322                      std::initializer_list&lt;Region&gt; reg) {
1323    size_t prev = 0;
1324    for (const Region&amp; r : reg) {
1325      ExpectRegionPoisoned(buf + prev, r.from - prev, false);
1326      ExpectRegionPoisoned(buf + r.from, r.to - r.from, true);
1327      prev = r.to;
1328    }
1329    ExpectRegionPoisoned(buf + prev, N - prev, false);
1330  }
1331  TEST(Layout, PoisonPadding) {
1332    using L = Layout&lt;int8_t, Int64, int32_t, Int128&gt;;
1333    constexpr size_t n = L::Partial(1, 2, 3, 4).AllocSize();
1334    {
1335      constexpr auto x = L::Partial();
1336      alignas(max_align_t) const unsigned char c[n] = {};
1337      x.PoisonPadding(c);
1338      EXPECT_EQ(x.Slices(c), x.Slices(c));
1339      ExpectPoisoned(c, {});
1340    }
1341    {
1342      constexpr auto x = L::Partial(1);
1343      alignas(max_align_t) const unsigned char c[n] = {};
1344      x.PoisonPadding(c);
1345      EXPECT_EQ(x.Slices(c), x.Slices(c));
1346      ExpectPoisoned(c, {{1, 8}});
1347    }
1348    {
1349      constexpr auto x = L::Partial(1, 2);
1350      alignas(max_align_t) const unsigned char c[n] = {};
1351      x.PoisonPadding(c);
1352      EXPECT_EQ(x.Slices(c), x.Slices(c));
1353      ExpectPoisoned(c, {{1, 8}});
1354    }
1355    {
1356      constexpr auto x = L::Partial(1, 2, 3);
1357      alignas(max_align_t) const unsigned char c[n] = {};
1358      x.PoisonPadding(c);
1359      EXPECT_EQ(x.Slices(c), x.Slices(c));
1360      ExpectPoisoned(c, {{1, 8}, {36, 40}});
1361    }
1362    {
1363      constexpr auto x = L::Partial(1, 2, 3, 4);
1364      alignas(max_align_t) const unsigned char c[n] = {};
1365      x.PoisonPadding(c);
1366      EXPECT_EQ(x.Slices(c), x.Slices(c));
1367      ExpectPoisoned(c, {{1, 8}, {36, 40}});
1368    }
1369    {
1370      constexpr L x(1, 2, 3, 4);
1371      alignas(max_align_t) const unsigned char c[n] = {};
1372      x.PoisonPadding(c);
1373      EXPECT_EQ(x.Slices(c), x.Slices(c));
1374      ExpectPoisoned(c, {{1, 8}, {36, 40}});
1375    }
1376  }
1377  TEST(Layout, DebugString) {
1378    {
1379      constexpr auto x = Layout&lt;int8_t, int32_t, int8_t, Int128&gt;::Partial();
1380      EXPECT_EQ(&quot;@0&lt;signed char&gt;(1)&quot;, x.DebugString());
1381    }
1382    {
1383      constexpr auto x = Layout&lt;int8_t, int32_t, int8_t, Int128&gt;::Partial(1);
1384      EXPECT_EQ(&quot;@0&lt;signed char&gt;(1)[1]; @4&lt;int&gt;(4)&quot;, x.DebugString());
1385    }
1386    {
1387      constexpr auto x = Layout&lt;int8_t, int32_t, int8_t, Int128&gt;::Partial(1, 2);
1388      EXPECT_EQ(&quot;@0&lt;signed char&gt;(1)[1]; @4&lt;int&gt;(4)[2]; @12&lt;signed char&gt;(1)&quot;,
1389                x.DebugString());
1390    }
1391    {
1392      constexpr auto x =
1393          Layout&lt;int8_t, int32_t, int8_t, Int128&gt;::Partial(1, 2, 3);
1394      EXPECT_EQ(
1395          &quot;@0&lt;signed char&gt;(1)[1]; @4&lt;int&gt;(4)[2]; @12&lt;signed char&gt;(1)[3]; &quot;
1396          &quot;@16&quot; +
1397              Int128::Name() + &quot;(16)&quot;,
1398          x.DebugString());
1399    }
1400    {
1401      constexpr auto x =
1402          Layout&lt;int8_t, int32_t, int8_t, Int128&gt;::Partial(1, 2, 3, 4);
1403      EXPECT_EQ(
1404          &quot;@0&lt;signed char&gt;(1)[1]; @4&lt;int&gt;(4)[2]; @12&lt;signed char&gt;(1)[3]; &quot;
1405          &quot;@16&quot; +
1406              Int128::Name() + &quot;(16)[4]&quot;,
1407          x.DebugString());
1408    }
1409    {
1410      constexpr Layout&lt;int8_t, int32_t, int8_t, Int128&gt; x(1, 2, 3, 4);
1411      EXPECT_EQ(
1412          &quot;@0&lt;signed char&gt;(1)[1]; @4&lt;int&gt;(4)[2]; @12&lt;signed char&gt;(1)[3]; &quot;
1413          &quot;@16&quot; +
1414              Int128::Name() + &quot;(16)[4]&quot;,
1415          x.DebugString());
1416    }
1417  }
1418  TEST(Layout, CharTypes) {
1419    constexpr Layout&lt;int32_t&gt; x(1);
1420    alignas(max_align_t) char c[x.AllocSize()] = {};
1421    alignas(max_align_t) unsigned char uc[x.AllocSize()] = {};
1422    alignas(max_align_t) signed char sc[x.AllocSize()] = {};
1423    alignas(max_align_t) const char cc[x.AllocSize()] = {};
1424    alignas(max_align_t) const unsigned char cuc[x.AllocSize()] = {};
1425    alignas(max_align_t) const signed char csc[x.AllocSize()] = {};
1426    Type&lt;int32_t*&gt;(x.Pointer&lt;0&gt;(c));
1427    Type&lt;int32_t*&gt;(x.Pointer&lt;0&gt;(uc));
1428    Type&lt;int32_t*&gt;(x.Pointer&lt;0&gt;(sc));
1429    Type&lt;const int32_t*&gt;(x.Pointer&lt;0&gt;(cc));
1430    Type&lt;const int32_t*&gt;(x.Pointer&lt;0&gt;(cuc));
1431    Type&lt;const int32_t*&gt;(x.Pointer&lt;0&gt;(csc));
1432    Type&lt;int32_t*&gt;(x.Pointer&lt;int32_t&gt;(c));
1433    Type&lt;int32_t*&gt;(x.Pointer&lt;int32_t&gt;(uc));
1434    Type&lt;int32_t*&gt;(x.Pointer&lt;int32_t&gt;(sc));
1435    Type&lt;const int32_t*&gt;(x.Pointer&lt;int32_t&gt;(cc));
1436    Type&lt;const int32_t*&gt;(x.Pointer&lt;int32_t&gt;(cuc));
1437    Type&lt;const int32_t*&gt;(x.Pointer&lt;int32_t&gt;(csc));
1438    Type&lt;std::tuple&lt;int32_t*&gt;&gt;(x.Pointers(c));
1439    Type&lt;std::tuple&lt;int32_t*&gt;&gt;(x.Pointers(uc));
1440    Type&lt;std::tuple&lt;int32_t*&gt;&gt;(x.Pointers(sc));
1441    Type&lt;std::tuple&lt;const int32_t*&gt;&gt;(x.Pointers(cc));
1442    Type&lt;std::tuple&lt;const int32_t*&gt;&gt;(x.Pointers(cuc));
1443    Type&lt;std::tuple&lt;const int32_t*&gt;&gt;(x.Pointers(csc));
1444    Type&lt;Span&lt;int32_t&gt;&gt;(x.Slice&lt;0&gt;(c));
1445    Type&lt;Span&lt;int32_t&gt;&gt;(x.Slice&lt;0&gt;(uc));
1446    Type&lt;Span&lt;int32_t&gt;&gt;(x.Slice&lt;0&gt;(sc));
1447    Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;0&gt;(cc));
1448    Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;0&gt;(cuc));
1449    Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;0&gt;(csc));
1450    Type&lt;std::tuple&lt;Span&lt;int32_t&gt;&gt;&gt;(x.Slices(c));
<span onclick='openModal()' class='match'>1451    Type&lt;std::tuple&lt;Span&lt;int32_t&gt;&gt;&gt;(x.Slices(uc));
1452    Type&lt;std::tuple&lt;Span&lt;int32_t&gt;&gt;&gt;(x.Slices(sc));
</span>1453    Type&lt;std::tuple&lt;Span&lt;const int32_t&gt;&gt;&gt;(x.Slices(cc));
1454    Type&lt;std::tuple&lt;Span&lt;const int32_t&gt;&gt;&gt;(x.Slices(cuc));
1455    Type&lt;std::tuple&lt;Span&lt;const int32_t&gt;&gt;&gt;(x.Slices(csc));
1456  }
1457  TEST(Layout, ConstElementType) {
1458    constexpr Layout&lt;const int32_t&gt; x(1);
1459    alignas(int32_t) char c[x.AllocSize()] = {};
1460    const char* cc = c;
1461    const int32_t* p = reinterpret_cast&lt;const int32_t*&gt;(cc);
1462    EXPECT_EQ(alignof(int32_t), x.Alignment());
1463    EXPECT_EQ(0, x.Offset&lt;0&gt;());
1464    EXPECT_EQ(0, x.Offset&lt;const int32_t&gt;());
1465    EXPECT_THAT(x.Offsets(), ElementsAre(0));
1466    EXPECT_EQ(1, x.Size&lt;0&gt;());
1467    EXPECT_EQ(1, x.Size&lt;const int32_t&gt;());
1468    EXPECT_THAT(x.Sizes(), ElementsAre(1));
1469    EXPECT_EQ(sizeof(int32_t), x.AllocSize());
1470    EXPECT_EQ(p, Type&lt;const int32_t*&gt;(x.Pointer&lt;0&gt;(c)));
1471    EXPECT_EQ(p, Type&lt;const int32_t*&gt;(x.Pointer&lt;0&gt;(cc)));
1472    EXPECT_EQ(p, Type&lt;const int32_t*&gt;(x.Pointer&lt;const int32_t&gt;(c)));
1473    EXPECT_EQ(p, Type&lt;const int32_t*&gt;(x.Pointer&lt;const int32_t&gt;(cc)));
1474    EXPECT_THAT(Type&lt;std::tuple&lt;const int32_t*&gt;&gt;(x.Pointers(c)), Tuple(p));
1475    EXPECT_THAT(Type&lt;std::tuple&lt;const int32_t*&gt;&gt;(x.Pointers(cc)), Tuple(p));
1476    EXPECT_THAT(Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;0&gt;(c)),
1477                IsSameSlice(Span&lt;const int32_t&gt;(p, 1)));
1478    EXPECT_THAT(Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;0&gt;(cc)),
1479                IsSameSlice(Span&lt;const int32_t&gt;(p, 1)));
1480    EXPECT_THAT(Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;const int32_t&gt;(c)),
1481                IsSameSlice(Span&lt;const int32_t&gt;(p, 1)));
1482    EXPECT_THAT(Type&lt;Span&lt;const int32_t&gt;&gt;(x.Slice&lt;const int32_t&gt;(cc)),
1483                IsSameSlice(Span&lt;const int32_t&gt;(p, 1)));
1484    EXPECT_THAT(Type&lt;std::tuple&lt;Span&lt;const int32_t&gt;&gt;&gt;(x.Slices(c)),
1485                Tuple(IsSameSlice(Span&lt;const int32_t&gt;(p, 1))));
1486    EXPECT_THAT(Type&lt;std::tuple&lt;Span&lt;const int32_t&gt;&gt;&gt;(x.Slices(cc)),
1487                Tuple(IsSameSlice(Span&lt;const int32_t&gt;(p, 1))));
1488  }
1489  namespace example {
1490  class CompactString {
1491   public:
1492    CompactString(const char* s = &quot;&quot;) {  
1493      const size_t size = strlen(s);
1494      const L layout(1, size + 1);
1495      p_.reset(new unsigned char[layout.AllocSize()]);
1496      layout.PoisonPadding(p_.get());
1497      *layout.Pointer&lt;size_t&gt;(p_.get()) = size;
1498      memcpy(layout.Pointer&lt;char&gt;(p_.get()), s, size + 1);
1499    }
1500    size_t size() const {
1501      return *L::Partial().Pointer&lt;size_t&gt;(p_.get());
1502    }
1503    const char* c_str() const {
1504      return L::Partial(1).Pointer&lt;char&gt;(p_.get());
1505    }
1506   private:
1507    using L = Layout&lt;size_t, char&gt;;
1508    std::unique_ptr&lt;unsigned char[]&gt; p_;
1509  };
1510  TEST(CompactString, Works) {
1511    CompactString s = &quot;hello&quot;;
1512    EXPECT_EQ(5, s.size());
1513    EXPECT_STREQ(&quot;hello&quot;, s.c_str());
1514  }
1515  }  
1516  }  
1517  }  
1518  ABSL_NAMESPACE_END
1519  }  
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-layout_test.cc</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-layout_test.cc</div>
                </div>
                <div class="column column_space"><pre><code>1452    Type&lt;std::tuple&lt;Span&lt;int32_t&gt;&gt;&gt;(x.Slices(sc));
1453    Type&lt;std::tuple&lt;Span&lt;const int32_t&gt;&gt;&gt;(x.Slices(cc));
</pre></code></div>
                <div class="column column_space"><pre><code>1451    Type&lt;std::tuple&lt;Span&lt;int32_t&gt;&gt;&gt;(x.Slices(uc));
1452    Type&lt;std::tuple&lt;Span&lt;int32_t&gt;&gt;&gt;(x.Slices(sc));
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    