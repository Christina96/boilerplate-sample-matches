
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 33, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-ultra.cpp</h3>
            <pre><code>1  #include &quot;ultra.h&quot;
2  TGasDef::TGasDef(const bool&amp; DbP):
3    FldNmTyUseTrV(){
4    if (DbP){
5      LocIdFldN=FldNmTyUseTrV.Add(TStrTr(&quot;LocationID&quot;, &quot;int&quot;, &quot;meta&quot;));
6      ProdIdFldN=FldNmTyUseTrV.Add(TStrTr(&quot;ProductID&quot;, &quot;int&quot;, &quot;meta&quot;));
7      DateFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Date&quot;, &quot;date&quot;, &quot;active&quot;));
8      DayNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Day&quot;, &quot;int&quot;, &quot;active&quot;));
9      MonthNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Month&quot;, &quot;int&quot;, &quot;active&quot;));
10      YearNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Year&quot;, &quot;int&quot;, &quot;active&quot;));
11      HourNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;HourStart&quot;, &quot;int&quot;, &quot;active&quot;));
12      FldNmTyUseTrV.Add(TStrTr(&quot;HourEnd&quot;, &quot;int&quot;, &quot;active&quot;));
13      DowNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;DayOfWeek&quot;, &quot;dow&quot;, &quot;active&quot;));
14      IsHolidayFldN=FldNmTyUseTrV.Add(TStrTr(&quot;ISHoliday&quot;, &quot;int&quot;, &quot;active&quot;));
15      IsHolidayStartFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsHolidayStart&quot;, &quot;int&quot;, &quot;active&quot;));
16      IsHolidayEndFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsHolidayEnd&quot;, &quot;int&quot;, &quot;active&quot;));
17      IsDayBeforeHolidayFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsDayBeforeHoliday&quot;, &quot;int&quot;, &quot;active&quot;));
18      IsDayAfterHolidayFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsDayAfterHoliday&quot;, &quot;int&quot;, &quot;active&quot;));
19      VolFldN=FldNmTyUseTrV.Add(TStrTr(&quot;VolumeStart&quot;, &quot;int&quot;, &quot;active&quot;));
20      CsptFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Cnsmptn&quot;, &quot;int&quot;, &quot;active&quot;));
21      FldNmTyUseTrV.Add(TStrTr(&quot;Interpolation&quot;, &quot;int&quot;, &quot;active&quot;));
22      CsptLast1WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast1W&quot;, &quot;int&quot;, &quot;active&quot;));
23      CsptLast2WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast2W&quot;, &quot;int&quot;, &quot;active&quot;));
24      CsptLast3WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast3W&quot;, &quot;int&quot;, &quot;active&quot;));
25      SumCsptLast1WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast1W&quot;, &quot;int&quot;, &quot;active&quot;));
26      SumCsptLast2WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast2W&quot;, &quot;int&quot;, &quot;active&quot;));
27      SumCsptLast3WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast3W&quot;, &quot;int&quot;, &quot;active&quot;));
28      CsptLast1DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast1D&quot;, &quot;int&quot;, &quot;active&quot;));
29      CsptLast2DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast2D&quot;, &quot;int&quot;, &quot;active&quot;));
30      CsptLast3DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast3D&quot;, &quot;int&quot;, &quot;active&quot;));
31      CsptLast4DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast4D&quot;, &quot;int&quot;, &quot;active&quot;));
32      CsptLast5DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast5D&quot;, &quot;int&quot;, &quot;active&quot;));
33      CsptLast6DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast6D&quot;, &quot;int&quot;, &quot;active&quot;));
34      SumCsptLast1DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast1D&quot;, &quot;int&quot;, &quot;active&quot;));
35      SumCsptLast2DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast2D&quot;, &quot;int&quot;, &quot;active&quot;));
36      SumCsptLast3DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast3D&quot;, &quot;int&quot;, &quot;active&quot;));
37      SumCsptLast4DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast4D&quot;, &quot;int&quot;, &quot;active&quot;));
38      SumCsptLast5DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast5D&quot;, &quot;int&quot;, &quot;active&quot;));
39      SumCsptLast6DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast6D&quot;, &quot;int&quot;, &quot;active&quot;));
40      PriceChangeFldN=FldNmTyUseTrV.Add(TStrTr(&quot;PriceChange&quot;, &quot;int&quot;, &quot;active&quot;));
41      DaysBeforePriceChangeFldN=FldNmTyUseTrV.Add(TStrTr(&quot;DaysBeforePriceChange&quot;, &quot;int&quot;, &quot;active&quot;));
42    } else {
43      LocIdFldN=FldNmTyUseTrV.Add(TStrTr(&quot;LocationID&quot;, &quot;int&quot;, &quot;meta&quot;));
44      TankIdFldN=FldNmTyUseTrV.Add(TStrTr(&quot;TankID&quot;, &quot;int&quot;, &quot;meta&quot;));
45      ProdIdFldN=FldNmTyUseTrV.Add(TStrTr(&quot;ProductID&quot;, &quot;int&quot;, &quot;meta&quot;));
46      DateFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Date&quot;, &quot;date&quot;, &quot;active&quot;));
47      HourNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;HourStart&quot;, &quot;int&quot;, &quot;active&quot;));
48      FldNmTyUseTrV.Add(TStrTr(&quot;HourEnd&quot;, &quot;int&quot;, &quot;active&quot;));
49      CsptFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Cnsmptn&quot;, &quot;int&quot;, &quot;active&quot;));
50      VolFldN=FldNmTyUseTrV.Add(TStrTr(&quot;VolumeStart&quot;, &quot;int&quot;, &quot;active&quot;));
51      FldNmTyUseTrV.Add(TStrTr(&quot;Interpolation&quot;, &quot;int&quot;, &quot;active&quot;));
52      CsptLast1WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast1W&quot;, &quot;int&quot;, &quot;active&quot;));
53      CsptLast2WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast2W&quot;, &quot;int&quot;, &quot;active&quot;));
54      CsptLast3WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast3W&quot;, &quot;int&quot;, &quot;active&quot;));
55      SumCsptLast1WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast1W&quot;, &quot;int&quot;, &quot;active&quot;));
56      SumCsptLast2WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast2W&quot;, &quot;int&quot;, &quot;active&quot;));
57      SumCsptLast3WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast3W&quot;, &quot;int&quot;, &quot;active&quot;));
58      CsptLast1DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast1D&quot;, &quot;int&quot;, &quot;active&quot;));
59      CsptLast2DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast2D&quot;, &quot;int&quot;, &quot;active&quot;));
60      CsptLast3DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast3D&quot;, &quot;int&quot;, &quot;active&quot;));
61      CsptLast4DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast4D&quot;, &quot;int&quot;, &quot;active&quot;));
62      CsptLast5DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast5D&quot;, &quot;int&quot;, &quot;active&quot;));
63      CsptLast6DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast6D&quot;, &quot;int&quot;, &quot;active&quot;));
64      SumCsptLast1DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast1D&quot;, &quot;int&quot;, &quot;active&quot;));
65      SumCsptLast2DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast2D&quot;, &quot;int&quot;, &quot;active&quot;));
66      SumCsptLast3DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast3D&quot;, &quot;int&quot;, &quot;active&quot;));
67      SumCsptLast4DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast4D&quot;, &quot;int&quot;, &quot;active&quot;));
68      SumCsptLast5DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast5D&quot;, &quot;int&quot;, &quot;active&quot;));
69      SumCsptLast6DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast6D&quot;, &quot;int&quot;, &quot;active&quot;));
70      DayNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Day&quot;, &quot;int&quot;, &quot;active&quot;));
71      MonthNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Month&quot;, &quot;int&quot;, &quot;active&quot;));
72      YearNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Year&quot;, &quot;int&quot;, &quot;active&quot;));
73      DowNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;DayOfWeek&quot;, &quot;dow&quot;, &quot;active&quot;));
74      IsHolidayFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsHoliday&quot;, &quot;int&quot;, &quot;active&quot;));
75      IsHolidayStartFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsHolidayStart&quot;, &quot;int&quot;, &quot;active&quot;));
76      IsHolidayEndFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsHolidayEnd&quot;, &quot;int&quot;, &quot;active&quot;));
77      IsDayBeforeHolidayFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsDayBeforeHoliday&quot;, &quot;int&quot;, &quot;active&quot;));
78      IsDayAfterHolidayFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsDayAfterHoliday&quot;, &quot;int&quot;, &quot;active&quot;));
79      PriceChangeFldN=FldNmTyUseTrV.Add(TStrTr(&quot;PriceChange&quot;, &quot;int&quot;, &quot;active&quot;));
80      DaysBeforePriceChangeFldN=FldNmTyUseTrV.Add(TStrTr(&quot;DaysBeforePriceChange&quot;, &quot;int&quot;, &quot;active&quot;));
81      ProdNmFldN=FldNmTyUseTrV.Add(TStrTr(&quot;ProductName&quot;, &quot;int&quot;, &quot;ignore&quot;));
82      LocNmFldN=FldNmTyUseTrV.Add(TStrTr(&quot;LocationName&quot;, &quot;int&quot;, &quot;ignore&quot;));
83    }
84  }
85  bool TGasDef::IsFldNmVOk(const TStrV&amp; FldNmV) const {
86    if (GetFlds()!=FldNmV.Len()){return false;}
87    for (int FldN=0; FldN&lt;FldNmV.Len(); FldN++){
88      if (FldNmTyUseTrV[FldN].Val1!=FldNmV[FldN]){
89        printf(&quot;&#x27;%s&#x27;!=&#x27;%s&#x27;&quot;, FldNmTyUseTrV[FldN].Val1.CStr(), FldNmV[FldN].CStr());
90        return false;
91      }
92    }
93    return true;
94  }
95  void TGasDef::GetFldIntValV(const TStrV&amp; FldStrValV, TIntV&amp; FldIntValV) const {
96    int Flds=GetFlds();
97    EAssertR(Flds==FldStrValV.Len(), &quot;Number of data fields doesn&#x27;t fit.&quot;);
98    FldIntValV.Gen(Flds);
99    for (int FldN=0; FldN&lt;Flds; FldN++){
100      TStrTr&amp; FldNmTyUseTr=FldNmTyUseTrV[FldN];
101      if (FldNmTyUseTr.Val3!=&quot;ignore&quot;){
102        if (FldNmTyUseTr.Val2==&quot;int&quot;){
103          if (FldStrValV[FldN]==&quot;True&quot;){FldIntValV[FldN]=1;}
104          else if (FldStrValV[FldN]==&quot;False&quot;){FldIntValV[FldN]=0;}
105          else {FldIntValV[FldN]=FldStrValV[FldN].GetInt();}
106        } else
107        if (FldNmTyUseTr.Val2==&quot;date&quot;){
108          TSecTm Date=TSecTm::GetDtTmFromDmyStr(FldStrValV[FldN]);
109          FldIntValV[FldN]=Date.GetAbsSecs();
110        } else
111        if (FldNmTyUseTr.Val2==&quot;dow&quot;){
112          TStr DowNm=FldStrValV[FldN];
113          if (!DowNm.Empty()){DowNm.PutCh(0, TCh::GetUc(DowNm[0]));}
114          int DowN=TTmInfo::GetDayOfWeekN(DowNm, lSi);
115          FldIntValV[FldN]=DowN;
116        }
117      }
118    }
119  }
120  TSecTm TGasDef::GetTm(const TIntV&amp; FldIntValV) const {
121    int HourN=FldIntValV[HourNFldN];
122    int DayN=FldIntValV[DayNFldN];
123    int MonthN=FldIntValV[MonthNFldN];
124    int YearN=FldIntValV[YearNFldN];
125    TSecTm Tm=TSecTm::GetDtTm(YearN, MonthN, DayN);
126    Tm.AddHours(HourN);
127    return Tm;
128  }
129  void TGasDef::GetHdm(
130   const TIntV&amp; FldIntValV, int&amp; HourN, int&amp; DowN, int&amp; MonthN) const {
131    HourN=FldIntValV[HourNFldN];
132    DowN=FldIntValV[DowNFldN]-1;
133    MonthN=FldIntValV[MonthNFldN]-1;
134  }
135  TSecTm TGasLtpBs::GetMnDate() const {
136    TSecTm MnDate;
137    int Recs=GetRecs();
138    for (int RecN=0; RecN&lt;Recs; RecN++){
139      TSecTm Date=GetDate(RecN);
140      if ((RecN==0)||(Date&lt;MnDate)){MnDate=Date;}
141    }
142    return MnDate;
143  }
144  TSecTm TGasLtpBs::GetMxDate() const {
145    TSecTm MxDate;
146    int Recs=GetRecs();
147    for (int RecN=0; RecN&lt;Recs; RecN++){
148      TSecTm Date=GetDate(RecN);
149      if ((RecN==0)||(Date&gt;MxDate)){MxDate=Date;}
150    }
151    return MxDate;
152  }
153  void TGasLtpBs::GenStat(){
154    TMom::NewV(HourMomV, 24);
155    TMom::NewV(DowMomV, 7);
156    TMom::NewV(MonthMomV, 12);
157    TMom::NewVV(DowHourMomVV, 7, 24);
158    int Recs=GetRecs();
159    for (int RecN=0; RecN&lt;Recs; RecN++){
160      int HourN; int DowN; int MonthN;
161      GasDef-&gt;GetHdm(GetRec(RecN), HourN, DowN, MonthN);
162      int Cspt=GasDef-&gt;GetCspt(GetRec(RecN));
163      HourMomV[HourN]-&gt;Add(Cspt);
164      DowMomV[DowN]-&gt;Add(Cspt);
165      MonthMomV[MonthN]-&gt;Add(Cspt);
166      DowHourMomVV.At(DowN, HourN)-&gt;Add(Cspt);
167    }
168    TMom::DefV(HourMomV);
169    TMom::DefV(DowMomV);
170    TMom::DefV(MonthMomV);
171    TMom::DefVV(DowHourMomVV);
172  }
173  bool TGasLtpBs::IsDowHourMomUsable() const {
174    return
175     TMom::IsUsableV(HourMomV)&amp;&amp;
176     TMom::IsUsableV(DowMomV)&amp;&amp;
177     TMom::IsUsableVV(DowHourMomVV);
178  }
179  void TGasLtpBs::RepairUnknowns(){
180    if (!IsDowHourMomUsable()){
181      printf(&quot;*** Error: day-of-week &amp; hour statistics cannot be generated (not enough data)!\n&quot;);
182      printf(&quot;*** Can not repair data!\n&quot;);
183      return;
184    }
185    int Recs=GetRecs();
186    for (int RecN=0; RecN&lt;Recs; RecN++){
187      int RecHourN; int RecDowN; int RecMonthN;
188      GetHdm(RecN, RecHourN, RecDowN, RecMonthN);
189      TSecTm RecTm=GetTm(RecN);
190      TSecTm RecDate=GetDate(RecN);
191      TStr Str=RecTm.GetStr();
192      if (RecN&gt;0){
193        int DSecs=TSecTm::GetDSecs(GetTm(RecN-1), RecTm);
194        if (DSecs!=3600){
195          printf(&quot;*** Error - records not at hour interval (%s - %s)!\n&quot;,
196           GetTm(RecN-1).GetStr().CStr(), RecTm.GetStr().CStr());
197        }
198      }
199      if (GetCspt(RecN)&lt;0){
200        printf(&quot;*** Error: consumption is negative (%d)!\n&quot;, GetCspt(RecN));
201        printf(&quot;*** Can not repair data!\n&quot;);
202        return;
203      }
204      if (GetCsptLast1D(RecN)==-1){
205        GetCsptLast1D(RecN)=DowHourMomVV.At((RecDowN+7-1)%7, RecHourN)-&gt;GetMedian();}
206      if (GetCsptLast2D(RecN)==-1){
207        GetCsptLast2D(RecN)=DowHourMomVV.At((RecDowN+7-2)%7, RecHourN)-&gt;GetMedian();}
208      if (GetCsptLast3D(RecN)==-1){
209        GetCsptLast3D(RecN)=DowHourMomVV.At((RecDowN+7-3)%7, RecHourN)-&gt;GetMedian();}
210      if (GetCsptLast4D(RecN)==-1){
211        GetCsptLast4D(RecN)=DowHourMomVV.At((RecDowN+7-4)%7, RecHourN)-&gt;GetMedian();}
212      if (GetCsptLast5D(RecN)==-1){
213        GetCsptLast5D(RecN)=DowHourMomVV.At((RecDowN+7-5)%7, RecHourN)-&gt;GetMedian();}
214      if (GetCsptLast6D(RecN)==-1){
215        GetCsptLast6D(RecN)=DowHourMomVV.At((RecDowN+7-6)%7, RecHourN)-&gt;GetMedian();}
216      if (GetSumCsptLast1D(RecN)==-1){
217        GetSumCsptLast1D(RecN)=DowMomV[(RecDowN+7-1)%7]-&gt;GetMedian();}
218      if (GetSumCsptLast2D(RecN)==-1){
219        GetSumCsptLast2D(RecN)=DowMomV[(RecDowN+7-2)%7]-&gt;GetMedian();}
220      if (GetSumCsptLast3D(RecN)==-1){
221        GetSumCsptLast3D(RecN)=DowMomV[(RecDowN+7-1)%7]-&gt;GetMedian();}
222      if (GetSumCsptLast4D(RecN)==-1){
223        GetSumCsptLast4D(RecN)=DowMomV[(RecDowN+7-4)%7]-&gt;GetMedian();}
224      if (GetSumCsptLast5D(RecN)==-1){
225        GetSumCsptLast5D(RecN)=DowMomV[(RecDowN+7-5)%7]-&gt;GetMedian();}
226      if (GetSumCsptLast6D(RecN)==-1){
227        GetSumCsptLast6D(RecN)=DowMomV[(RecDowN+7-6)%7]-&gt;GetMedian();}
228      if (GetCsptLast1W(RecN)==-1){
229        GetCsptLast1W(RecN)=DowHourMomVV.At(RecDowN, RecHourN)-&gt;GetMedian();}
230      if (GetCsptLast2W(RecN)==-1){
231        GetCsptLast2W(RecN)=DowHourMomVV.At(RecDowN, RecHourN)-&gt;GetMedian();}
232      if (GetCsptLast3W(RecN)==-1){
233        GetCsptLast3W(RecN)=DowHourMomVV.At(RecDowN, RecHourN)-&gt;GetMedian();}
234      if (GetSumCsptLast1W(RecN)==-1){
235        GetSumCsptLast1W(RecN)=DowMomV[RecDowN]-&gt;GetMedian();}
236      if (GetSumCsptLast2W(RecN)==-1){
237        GetSumCsptLast2W(RecN)=DowMomV[RecDowN]-&gt;GetMedian();}
238      if (GetSumCsptLast3W(RecN)==-1){
239        GetSumCsptLast3W(RecN)=DowMomV[RecDowN]-&gt;GetMedian();}
240    }
241  }
242  void TGasLtpBs::SaveStatTxt(const PSOut&amp; SOut) const {
243    SOut-&gt;PutStr(&quot;==========================================================&quot;);
244    SOut-&gt;PutLn();
245    SOut-&gt;PutStr(LtpNm); SOut-&gt;PutStr(&quot;  /  &quot;);
246    SOut-&gt;PutStr(LocNm); SOut-&gt;PutStr(&quot;  /  &quot;);
247    SOut-&gt;PutStr(ProdNm); SOut-&gt;PutLn();
248    SOut-&gt;PutStr(&quot;Consumption per Hour&quot;);
249    SOut-&gt;PutLn();
250    for (int HourN=0; HourN&lt;24; HourN++){
251      SOut-&gt;PutInt(HourN); SOut-&gt;PutStr(&quot;: &quot;);
252      SOut-&gt;PutStr(HourMomV[HourN]-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true));
253      SOut-&gt;PutLn();
254    }
255    SOut-&gt;PutStr(&quot;Consumption per Day-Of-Week&quot;);
256    SOut-&gt;PutLn();
257    for (int DowN=0; DowN&lt;7; DowN++){
258      SOut-&gt;PutStr(TTmInfo::GetDayOfWeekNm(DowN+1)); SOut-&gt;PutStr(&quot;: &quot;);
259      SOut-&gt;PutStr(DowMomV[DowN]-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true));
260      SOut-&gt;PutLn();
261    }
262    SOut-&gt;PutStr(&quot;Consumption per Month&quot;);
263    SOut-&gt;PutLn();
264    for (int MonthN=0; MonthN&lt;12; MonthN++){
265      SOut-&gt;PutStr(TTmInfo::GetMonthNm(MonthN+1)); SOut-&gt;PutStr(&quot;: &quot;);
266      SOut-&gt;PutStr(MonthMomV[MonthN]-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true));
267      SOut-&gt;PutLn();
268    }
269    SOut-&gt;PutStr(&quot;Consumption per Day-Of-Week&amp;Hour&quot;);
270    SOut-&gt;PutLn();
271    {for (int DowN=0; DowN&lt;7; DowN++){
272      for (int HourN=0; HourN&lt;24; HourN++){
273        SOut-&gt;PutStr(TTmInfo::GetDayOfWeekNm(DowN+1)); SOut-&gt;PutStr(&quot;/&quot;);
274        SOut-&gt;PutInt(HourN); SOut-&gt;PutStr(&quot;: &quot;);
275        SOut-&gt;PutStr(DowHourMomVV.At(DowN, HourN)-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true));
276        SOut-&gt;PutLn();
277      }
278    }}
279    SOut-&gt;Flush();
280  }
281  void TGasLtpBs::SaveStatBin(const PSOut&amp; SOut) const {
282    PGasLtpBs StatLtpBs=TGasLtpBs::New(LtpNm, LocNm, ProdNm);
283    StatLtpBs-&gt;HourMomV=HourMomV;
284    StatLtpBs-&gt;DowMomV=DowMomV;
285    StatLtpBs-&gt;MonthMomV=MonthMomV;
286    StatLtpBs-&gt;DowHourMomVV=DowHourMomVV;
287    StatLtpBs-&gt;Save(*SOut);
288    SOut-&gt;Flush();
289  }
290  void TGasLtpBs::LoadStatV(const TStr&amp; FNm, TGasLtpBsV&amp; GasLtpBsV){
291    GasLtpBsV.Clr();
292    if (TFile::Exists(FNm)){
293      PSIn SIn=TFIn::New(FNm);
294      while (!SIn-&gt;Eof()){
295        PGasLtpBs GasLtpBs=TGasLtpBs::Load(*SIn);
296        GasLtpBsV.Add(GasLtpBs);
297      }
298    }
299  }
300  void TGasLtpBs::ConvTabToLtp(const TStr&amp; InTabFNmWc, const TStr&amp; OutLtpFPath,
301   const bool&amp; RepairUnknownsP){
302    PGasDef GasDef=TGasDef::New();
303    TStr OutLtpNrFPath=TStr::GetNrFPath(OutLtpFPath);
304    PGasLtpBs GasLtpBs; TStr LtpNm; TSecTm PrevLtpTm;
305    PSOut LtpStatTxtSOut=TFOut::New(OutLtpNrFPath+LtpStatTxtFNm);
306    PSOut LtpStatBinSOut=TFOut::New(OutLtpNrFPath+LtpStatBinFNm);
307    TFFile FFile(InTabFNmWc, false); TStr FNm; int Recs=0;
308    while (FFile.Next(FNm)){
309      printf(&quot;Processing file &#x27;%s&#x27;\n&quot;, FNm.CStr());
310      PSIn SIn=TFIn::New(FNm);
311      char PrevCh=&#x27; &#x27;; TStrV FldNmV;
312      TSs::LoadTxtFldV(ssfTabSep, SIn, PrevCh, FldNmV);
313      EAssertR(GasDef-&gt;IsFldNmVOk(FldNmV), TStr(&quot;Field names don&#x27;t fit in &quot;)+FNm);
314      int LnN=0;
315      while (!SIn-&gt;Eof()){
316        char PrevCh=&#x27; &#x27;; TStrV FldStrValV;
317        TSs::LoadTxtFldV(ssfTabSep, SIn, PrevCh, FldStrValV); LnN++;
318        if (LtpNm!=GasDef-&gt;GetLtpNm(FldStrValV)){
319          if (!GasLtpBs.Empty()){
320            GasLtpBs-&gt;GenStat();
321            if (RepairUnknownsP){GasLtpBs-&gt;RepairUnknowns();}
322            GasLtpBs-&gt;SaveStatTxt(LtpStatTxtSOut);
323            GasLtpBs-&gt;SaveStatBin(LtpStatBinSOut);
324            TStr LtpFNm=OutLtpNrFPath+GasDef-&gt;GetLtpFNm(LtpNm);
325            {TFOut LtpSOut(LtpFNm); GasLtpBs-&gt;Save(LtpSOut);}
326            PGasLtpBs NewGasLtpBs=TGasLtpBs::Load(LtpFNm);
327          }
328          LtpNm=GasDef-&gt;GetLtpNm(FldStrValV);
329          TStr LocNm=GasDef-&gt;GetLocNm(FldStrValV);
330          TStr ProdNm=GasDef-&gt;GetProdNm(FldStrValV);
331          GasLtpBs=TGasLtpBs::New(LtpNm, LocNm, ProdNm, GasDef);
332          PrevLtpTm.Undef();
333          printf(&quot;Processing Ltp: &#x27;%s&#x27; &#x27;%s&#x27; &#x27;%s&#x27;\n&quot;,
334           LtpNm.CStr(), LocNm.CStr(), ProdNm.CStr());
335        }
336        TIntV&amp; FldIntValV=GasLtpBs-&gt;AddRec();
337        GasDef-&gt;GetFldIntValV(FldStrValV, FldIntValV);
338        TSecTm LtpTm=GasDef-&gt;GetTm(FldIntValV);
339        if (PrevLtpTm.IsDef()){
340          if (PrevLtpTm&gt;=LtpTm){
341            printf(&quot;Time is not increasing [Line:%d PrevTime:%s CurTime:%s]\n&quot;,
342             LnN, PrevLtpTm.GetStr().CStr(), LtpTm.GetStr().CStr());
343          }
344          if (TSecTm::GetDSecs(PrevLtpTm, LtpTm)!=3600){
345            printf(&quot;Not one hour difference between subsequent records &quot;
346             &quot;[Line:%d PrevTime:%s CurTime:%s]\n&quot;,
347             LnN, PrevLtpTm.GetStr().CStr(), LtpTm.GetStr().CStr());
348          }
349          EAssertR(PrevLtpTm&lt;LtpTm, &quot;Records not in increased time sequence.&quot;);
350        }
351        PrevLtpTm=LtpTm;
352        Recs++; if (Recs%1000==0){printf(&quot;%d\r&quot;, Recs);}
353      }
354    }
355    if (!GasLtpBs.Empty()){
356      GasLtpBs-&gt;GenStat();
357      if (RepairUnknownsP){GasLtpBs-&gt;RepairUnknowns();}
358      GasLtpBs-&gt;SaveStatTxt(LtpStatTxtSOut);
359      GasLtpBs-&gt;SaveStatBin(LtpStatBinSOut);
360      TStr LtpFNm=OutLtpNrFPath+GasDef-&gt;GetLtpFNm(LtpNm);
361      {TFOut LtpSOut(LtpFNm); GasLtpBs-&gt;Save(LtpSOut);}
362      PGasLtpBs NewGasLtpBs=TGasLtpBs::Load(LtpFNm);
363    }
364  }
365  const TStr TGasLtpBs::LtpStatTxtFNm=&quot;LtpStat.Txt&quot;;
366  const TStr TGasLtpBs::LtpStatBinFNm=&quot;LtpStat.Dat&quot;;
367  int TGasDm::AddVar(const TStr&amp; VarNm, const TStr&amp; VarTy){
368    IAssert((!VarNmTyKdV.IsIn(TStrKd(VarNm)))&amp;&amp;(VarValVV.Empty()));
369    int VarN=VarNmTyKdV.Add(TStrKd(VarNm, VarTy));
370    if (VarTy==&quot;class&quot;){IAssert(ClassVarN==-1); ClassVarN=VarN;}
371    if (VarTy==&quot;date&quot;){IAssert(DateVarN==-1); DateVarN=VarN;}
372    if (VarTy==&quot;volume&quot;){IAssert(VolVarN==-1); VolVarN=VarN;}
373    if (VarTy==&quot;attr&quot;){Attrs++;}
374    return VarN;
375  }
376  void TGasDm::GetAttrNmV(TStrV&amp; AttrNmV) const {
377    AttrNmV.Gen(Attrs, 0);
378    for (int VarN=0; VarN&lt;GetVars(); VarN++){
379      if (GetVarTy(VarN)==&quot;attr&quot;){
380        AttrNmV.Add(GetVarNm(VarN));
381      }
382    }
383  }
384  int TGasDm::GetAttrN(const TStr&amp; AttrNm) const {
385    TStrV AttrNmV; GetAttrNmV(AttrNmV);
386    return AttrNmV.SearchForw(AttrNm);
387  }
388  TStr TGasDm::GetClassNm() const {
389    for (int VarN=0; VarN&lt;GetVars(); VarN++){
390      if (GetVarTy(VarN)==&quot;class&quot;){
391        return GetVarNm(VarN);
392      }
393    }
394    Fail;
395    return TStr();
396  }
397  void TGasDm::GetRecNV(
398   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
399   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt, TIntV&amp; RecNV){
400    if ((StartDate.IsDef()&amp;&amp;EndDate.IsDef())){
401      IAssert((StartRecN==-1)&amp;&amp;(EndRecN==-1));
402      RecNV.Clr(); int Recs=GetRecs();
403      for (int RecN=0; RecN&lt;Recs; RecN++){
404        TSecTm RecDate=GetDateVal(RecN);
405        if ((StartDate.IsDef()&amp;&amp;(RecDate&lt;StartDate))||
406         (EndDate.IsDef()&amp;&amp;(EndDate&lt;RecDate))){continue;}
407        if ((MnCspt!=-1)&amp;&amp;(GetClassVal(RecN)&lt;MnCspt)){continue;}
408        RecNV.Add(RecN);
409      }
410    } else
411    if ((StartRecN!=-1)&amp;&amp;(EndRecN!=-1)){
412      IAssert((!StartDate.IsDef())&amp;&amp;(!EndDate.IsDef()));
413      RecNV.Clr();
414      for (int RecN=StartRecN; RecN&lt;=EndRecN; RecN++){
415        RecNV.Add(RecN);
416      }
417    } else {
418      Fail;
419    }
420  }
421  void TGasDm::GetAttrValV(const int&amp; RecN, TFltV&amp; AttrValV) const {
422    AttrValV.Gen(Attrs, 0);
423    for (int VarN=0; VarN&lt;GetVars(); VarN++){
424      if (GetVarTy(VarN)==&quot;attr&quot;){
425        AttrValV.Add(VarValVV[RecN][VarN]);
426      }
427    }
428  }
429  double TGasDm::GetAttrVal(
430   const int&amp; RecN, const int&amp; AttrN, const double&amp; DfVal) const {
431    TFltV AttrValV; GetAttrValV(RecN, AttrValV);
432    if (AttrN==-1){return DfVal;}
433    else {return AttrValV[AttrN];}
434  }
435  double TGasDm::GetAttrVal(
436   const int&amp; RecN, const TStr&amp; AttrNm, const double&amp; DfVal) const {
437    TFltV AttrValV; GetAttrValV(RecN, AttrValV);
438    int AttrN=GetAttrN(AttrNm);
439    if (AttrN==-1){return DfVal;}
440    else {return AttrValV[AttrN];}
441  }
442  TStr TGasDm::GetBitsStr(const int&amp; RecN) const {
443    double IsHolidayVal=GetAttrVal(RecN, &quot;IsHoliday&quot;, 0);
444    double IsHolidayStartVal=GetAttrVal(RecN, &quot;IsHolidayStart&quot;, 0);
445    double IsHolidayEndVal=GetAttrVal(RecN, &quot;IsHolidayEnd&quot;, 0);
446    double IsDayBeforeHolidayVal=GetAttrVal(RecN, &quot;IsDayBeforeHoliday&quot;, 0);
447    double IsDayAfterHolidayVal=GetAttrVal(RecN, &quot;IsDayAfterHoliday&quot;, 0);
448    double PriceChangeVal=GetAttrVal(RecN, &quot;PriceChange&quot;, 0);
449    double DaysBeforePriceChangeVal=GetAttrVal(RecN, &quot;DaysBeforePriceChange&quot;, 0);
450    TChA ChA;
451    if (IsHolidayVal!=0){ChA+=&quot; IsHoliday&quot;;}
452    if (IsHolidayStartVal!=0){ChA+=&quot; IsHolidayStart&quot;;}
453    if (IsHolidayEndVal!=0){ChA+=&quot; IsHolidayEnd&quot;;}
454    if (IsDayBeforeHolidayVal!=0){ChA+=&quot; IsDayBeforeHoliday&quot;;}
455    if (IsDayAfterHolidayVal!=0){ChA+=&quot; IsDayAfterHoliday&quot;;}
456    if (PriceChangeVal!=0){ChA+=&quot; PriceChange:&quot;; ChA+=TFlt::GetStr(PriceChangeVal);}
457    if (DaysBeforePriceChangeVal!=0){
458      ChA+=&quot; DaysBeforePriceChange:&quot;; ChA+=TFlt::GetStr(DaysBeforePriceChangeVal);
459      if (RecN+1&lt;GetRecs()){
460        ChA+=TFlt::GetStr(GetAttrVal(RecN+1, &quot;PriceChange&quot;, 0), &quot;(%g%%)&quot;);}
461    }
462    return ChA;
463  }
464  PGasDm TGasDm::GetWeekGasDm(const PGasLtpBs&amp; GasLtpBs){
465    TIntIntH DayNToCsptH;
466    for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
467      int DayN=GasLtpBs-&gt;GetDateInt(RecN);
468      DayNToCsptH.AddDat(DayN)+=GasLtpBs-&gt;GetCspt(RecN);
469    }
470    TSecTm MnLtpDate=GasLtpBs-&gt;GetMnDate();
471    TSecTm MxLtpDate=GasLtpBs-&gt;GetMxDate();
472    typedef TKeyDat&lt;TSecTm, TInt&gt; TDateCsptKd;
473    TVec&lt;TDateCsptKd&gt; DateCsptKdV;
474    for (TSecTm LtpDate=MnLtpDate; LtpDate&lt;MxLtpDate; LtpDate.AddDays(1)){
475      int DayN=LtpDate.GetAbsSecs();
476      if (!DayNToCsptH.IsKey(DayN)){continue;}
477      int Cspt=DayNToCsptH.GetDat(DayN);
478      if (LtpDate.GetDayOfWeekN()==TTmInfo::SunN){
479        DateCsptKdV.Add(TDateCsptKd(LtpDate, 0));}
480      if (DateCsptKdV.Len()&gt;0){
481        DateCsptKdV.Last().Dat+=Cspt;}
482    }
483    PGasDm GasDm=TGasDm::New(&quot;Week&quot;);
484    GasDm-&gt;PutLtpNm(GasLtpBs-&gt;GetLtpNm());
485    GasDm-&gt;PutLocNm(GasLtpBs-&gt;GetLocNm());
486    GasDm-&gt;PutProdNm(GasLtpBs-&gt;GetProdNm());
487    GasDm-&gt;AddVar(&quot;Date&quot;, &quot;date&quot;);
488    GasDm-&gt;AddVar(&quot;Cspt&quot;, &quot;class&quot;);
489    GasDm-&gt;AddVar(&quot;Const&quot;, &quot;attr&quot;);
490    GasDm-&gt;AddVar(&quot;Month&quot;, &quot;attr&quot;);
491    GasDm-&gt;AddVar(&quot;SumCsptLast1W&quot;, &quot;attr&quot;);
492    GasDm-&gt;AddVar(&quot;SumCsptLast2W&quot;, &quot;attr&quot;);
493    GasDm-&gt;AddVar(&quot;SumCsptLast3W&quot;, &quot;attr&quot;);
494    GasDm-&gt;AddVar(&quot;SumCsptLast1D&quot;, &quot;attr&quot;);
495    GasDm-&gt;AddVar(&quot;SumCsptLast2D&quot;, &quot;attr&quot;);
496    GasDm-&gt;AddVar(&quot;SumCsptLast3D&quot;, &quot;attr&quot;);
497    GasDm-&gt;AddVar(&quot;SumCsptLast4D&quot;, &quot;attr&quot;);
498    GasDm-&gt;AddVar(&quot;SumCsptLast5D&quot;, &quot;attr&quot;);
499    GasDm-&gt;AddVar(&quot;SumCsptLast6D&quot;, &quot;attr&quot;);
500    GasDm-&gt;AddVar(&quot;Volume&quot;, &quot;volume&quot;);
501    {for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
502      TSecTm Date=TSecTm(GasLtpBs-&gt;GetDateInt(RecN));
503      int DateCsptKdN=DateCsptKdV.SearchForw(TDateCsptKd(Date));
504      if (DateCsptKdN==-1){continue;}
505      double Cspt=DateCsptKdV[DateCsptKdN].Dat;
506      if (Cspt==-1){continue;}
507      else {DateCsptKdV[DateCsptKdN].Dat=-1;}
508      TFltV VarValV(GasDm-&gt;GetVars(), 0);
509      VarValV.Add(GasLtpBs-&gt;GetDateInt(RecN));
510      VarValV.Add(Cspt);
511      VarValV.Add(1);
512      VarValV.Add(GasLtpBs-&gt;GetMonthN(RecN));
513      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast1W(RecN)));
514      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast2W(RecN)));
515      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast3W(RecN)));
516      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast1D(RecN)));
517      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast2D(RecN)));
518      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast3D(RecN)));
519      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast4D(RecN)));
520      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast5D(RecN)));
521      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast6D(RecN)));
522      if (VarValV.IsIn(-1)){
523        printf(&quot;Ignoring %s\n&quot;, GasLtpBs-&gt;GetTm(RecN).GetStr().CStr()); continue;}
524      VarValV.Add(GasLtpBs-&gt;GetVol(RecN));
525      GasDm-&gt;AddRec(VarValV);
526    }}
527    return GasDm;
528  }
529  PGasDm TGasDm::GetDayGasDm(const PGasLtpBs&amp; GasLtpBs){
530    TIntIntH DayNToCsptH;
531    for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
532      int DayN=GasLtpBs-&gt;GetDateInt(RecN);
533      DayNToCsptH.AddDat(DayN)+=GasLtpBs-&gt;GetCspt(RecN);
534    }
535    PGasDm GasDm=TGasDm::New(&quot;Day&quot;);
536    GasDm-&gt;PutLtpNm(GasLtpBs-&gt;GetLtpNm());
537    GasDm-&gt;PutLocNm(GasLtpBs-&gt;GetLocNm());
538    GasDm-&gt;PutProdNm(GasLtpBs-&gt;GetProdNm());
539    GasDm-&gt;AddVar(&quot;Date&quot;, &quot;date&quot;);
540    GasDm-&gt;AddVar(&quot;Cspt&quot;, &quot;class&quot;);
541    GasDm-&gt;AddVar(&quot;Const&quot;, &quot;attr&quot;);
542    GasDm-&gt;AddVar(&quot;Dow&quot;, &quot;attr&quot;);
543    GasDm-&gt;AddVar(&quot;Month&quot;, &quot;attr&quot;);
544    GasDm-&gt;AddVar(&quot;SumCsptLast1W&quot;, &quot;attr&quot;);
545    GasDm-&gt;AddVar(&quot;SumCsptLast2W&quot;, &quot;attr&quot;);
546    GasDm-&gt;AddVar(&quot;SumCsptLast3W&quot;, &quot;attr&quot;);
547    GasDm-&gt;AddVar(&quot;SumCsptLast1D&quot;, &quot;attr&quot;);
548    GasDm-&gt;AddVar(&quot;SumCsptLast2D&quot;, &quot;attr&quot;);
549    GasDm-&gt;AddVar(&quot;SumCsptLast3D&quot;, &quot;attr&quot;);
550    GasDm-&gt;AddVar(&quot;SumCsptLast4D&quot;, &quot;attr&quot;);
551    GasDm-&gt;AddVar(&quot;SumCsptLast5D&quot;, &quot;attr&quot;);
552    GasDm-&gt;AddVar(&quot;SumCsptLast6D&quot;, &quot;attr&quot;);
553    GasDm-&gt;AddVar(&quot;IsHoliday&quot;, &quot;attr&quot;);
554    GasDm-&gt;AddVar(&quot;IsHolidayStart&quot;, &quot;attr&quot;);
555    GasDm-&gt;AddVar(&quot;IsHolidayEnd&quot;, &quot;attr&quot;);
556    GasDm-&gt;AddVar(&quot;IsDayBeforeHoliday&quot;, &quot;attr&quot;);
557    GasDm-&gt;AddVar(&quot;IsDayAfterHoliday&quot;, &quot;attr&quot;);
558    GasDm-&gt;AddVar(&quot;PriceChange&quot;, &quot;attr&quot;);
559    GasDm-&gt;AddVar(&quot;DaysBeforePriceChange&quot;, &quot;attr&quot;);
560    GasDm-&gt;AddVar(&quot;Volume&quot;, &quot;volume&quot;);
561    {for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
562      double Cspt=DayNToCsptH.GetDat(GasLtpBs-&gt;GetDateInt(RecN));
563      if (Cspt==-1){continue;}
564      else {DayNToCsptH.GetDat(GasLtpBs-&gt;GetDateInt(RecN))=-1;}
565      TFltV VarValV(GasDm-&gt;GetVars(), 0);
566      VarValV.Add(GasLtpBs-&gt;GetDateInt(RecN));
567      VarValV.Add(Cspt);
568      VarValV.Add(1);
569      VarValV.Add(GasLtpBs-&gt;GetDowN(RecN));
570      VarValV.Add(GasLtpBs-&gt;GetMonthN(RecN));
571      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast1W(RecN)));
572      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast2W(RecN)));
573      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast3W(RecN)));
574      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast1D(RecN)));
575      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast2D(RecN)));
576      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast3D(RecN)));
577      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast4D(RecN)));
578      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast5D(RecN)));
579      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast6D(RecN)));
580      if (VarValV.IsIn(-1)){
581        printf(&quot;Ignoring %s\n&quot;, GasLtpBs-&gt;GetTm(RecN).GetStr().CStr()); continue;}
582      VarValV.Add(GasLtpBs-&gt;GetIsHoliday(RecN));
583      VarValV.Add(GasLtpBs-&gt;GetIsHolidayStart(RecN));
584      VarValV.Add(GasLtpBs-&gt;GetIsHolidayEnd(RecN));
585      VarValV.Add(GasLtpBs-&gt;GetIsDayBeforeHoliday(RecN));
586      VarValV.Add(GasLtpBs-&gt;GetIsDayAfterHoliday(RecN));
587      VarValV.Add(GasLtpBs-&gt;GetPriceChange(RecN));
588      VarValV.Add(GasLtpBs-&gt;GetDaysBeforePriceChange(RecN));
589      VarValV.Add(GasLtpBs-&gt;GetVol(RecN));
590      GasDm-&gt;AddRec(VarValV);
591    }}
592    return GasDm;
593  }
594  void TGasDm::AddCsptBlock(
595   TIntIntH&amp; HourNToCsptH, const int&amp; BlockN, const int&amp; Cspt){
596    if ((!HourNToCsptH.IsKey(BlockN))||(HourNToCsptH.GetDat(BlockN)!=-1)){
597      if (Cspt==-1){
598        HourNToCsptH.AddDat(BlockN)=-1;
599      } else {
600        HourNToCsptH.AddDat(BlockN)=Cspt;
601      }
602    }
603  }
604  PGasDm TGasDm::GetHourBlockGasDm(const PGasLtpBs&amp; GasLtpBs, const int&amp; HourBlockLen){
605    EAssertRA(24%HourBlockLen==0, &quot;Hour resulution not divisible by 24&quot;, TInt::GetStr(HourBlockLen));
606    TIntIntH BlockNToCsptH;
607    TIntIntH BlockNToCsptLast1WH;
608    TIntIntH BlockNToCsptLast2WH;
609    TIntIntH BlockNToCsptLast3WH;
610    TIntIntH BlockNToCsptLast1DH;
611    TIntIntH BlockNToCsptLast2DH;
612    TIntIntH BlockNToCsptLast3DH;
613    TIntIntH BlockNToCsptLast4DH;
614    TIntIntH BlockNToCsptLast5DH;
615    TIntIntH BlockNToCsptLast6DH;
616    for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
617      int DayN=GasLtpBs-&gt;GetDateInt(RecN); IAssert(DayN%100==0);
618      int HourN=GasLtpBs-&gt;GetHourN(RecN);
619      IAssert((0&lt;=HourN)&amp;&amp;(HourN&lt;24));
620      int BlockN=DayN+(HourN/HourBlockLen)*HourBlockLen;
621      BlockNToCsptH.AddDat(BlockN)+=GasLtpBs-&gt;GetCspt(RecN);
622      AddCsptBlock(BlockNToCsptLast1WH, BlockN, GasLtpBs-&gt;GetCsptLast1W(RecN));
623      AddCsptBlock(BlockNToCsptLast2WH, BlockN, GasLtpBs-&gt;GetCsptLast2W(RecN));
624      AddCsptBlock(BlockNToCsptLast3WH, BlockN, GasLtpBs-&gt;GetCsptLast3W(RecN));
625      AddCsptBlock(BlockNToCsptLast1DH, BlockN, GasLtpBs-&gt;GetCsptLast1D(RecN));
626      AddCsptBlock(BlockNToCsptLast2DH, BlockN, GasLtpBs-&gt;GetCsptLast2D(RecN));
627      AddCsptBlock(BlockNToCsptLast3DH, BlockN, GasLtpBs-&gt;GetCsptLast3D(RecN));
628      AddCsptBlock(BlockNToCsptLast4DH, BlockN, GasLtpBs-&gt;GetCsptLast4D(RecN));
629      AddCsptBlock(BlockNToCsptLast5DH, BlockN, GasLtpBs-&gt;GetCsptLast5D(RecN));
630      AddCsptBlock(BlockNToCsptLast6DH, BlockN, GasLtpBs-&gt;GetCsptLast6D(RecN));
631    }
632    PGasDm GasDm=TGasDm::New(TStr(&quot;Hour&quot;)+TInt::GetStr(HourBlockLen));
633    GasDm-&gt;PutLtpNm(GasLtpBs-&gt;GetLtpNm());
634    GasDm-&gt;PutLocNm(GasLtpBs-&gt;GetLocNm());
635    GasDm-&gt;PutProdNm(GasLtpBs-&gt;GetProdNm());
636    GasDm-&gt;AddVar(&quot;Date&quot;, &quot;date&quot;); 
637    GasDm-&gt;AddVar(&quot;Cspt&quot;, &quot;class&quot;); 
638    GasDm-&gt;AddVar(&quot;Const&quot;, &quot;attr&quot;); 
639    GasDm-&gt;AddVar(&quot;Hour&quot;, &quot;attr&quot;); 
640    GasDm-&gt;AddVar(&quot;Dow&quot;, &quot;attr&quot;); 
641    GasDm-&gt;AddVar(&quot;Month&quot;, &quot;attr&quot;); 
642    GasDm-&gt;AddVar(&quot;CsptLast1W&quot;, &quot;attr&quot;);
643    GasDm-&gt;AddVar(&quot;CsptLast2W&quot;, &quot;attr&quot;);
644    GasDm-&gt;AddVar(&quot;CsptLast3W&quot;, &quot;attr&quot;);
645    GasDm-&gt;AddVar(&quot;CsptLast1D&quot;, &quot;attr&quot;);
646    GasDm-&gt;AddVar(&quot;CsptLast2D&quot;, &quot;attr&quot;);
647    GasDm-&gt;AddVar(&quot;CsptLast3D&quot;, &quot;attr&quot;);
648    GasDm-&gt;AddVar(&quot;CsptLast4D&quot;, &quot;attr&quot;);
649    GasDm-&gt;AddVar(&quot;CsptLast5D&quot;, &quot;attr&quot;);
650    GasDm-&gt;AddVar(&quot;CsptLast6D&quot;, &quot;attr&quot;);
651    GasDm-&gt;AddVar(&quot;IsHoliday&quot;, &quot;attr&quot;);
652    GasDm-&gt;AddVar(&quot;Volume&quot;, &quot;volume&quot;);
653    {for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
654      int DayN=GasLtpBs-&gt;GetDateInt(RecN); IAssert(DayN%100==0);
655      int HourN=GasLtpBs-&gt;GetHourN(RecN);
656      IAssert((0&lt;=HourN)&amp;&amp;(HourN&lt;24));
657      int BlockN=DayN+(HourN/HourBlockLen)*HourBlockLen;
658      int BlockHourN=BlockN%100;
659      double Cspt=BlockNToCsptH.GetDat(BlockN);
660      if (Cspt==-1){continue;}
661      else {BlockNToCsptH.GetDat(BlockN)=-1;}
662      TFltV VarValV(GasDm-&gt;GetVars(), 0);
663      VarValV.Add(GasLtpBs-&gt;GetDateInt(RecN)); 
664      VarValV.Add(Cspt); 
665      VarValV.Add(1); 
666      VarValV.Add(BlockHourN); 
667      VarValV.Add(GasLtpBs-&gt;GetDowN(RecN)); 
668      VarValV.Add(GasLtpBs-&gt;GetMonthN(RecN)); 
669      VarValV.Add(int(BlockNToCsptLast1WH.GetDat(BlockN))); 
670      VarValV.Add(int(BlockNToCsptLast2WH.GetDat(BlockN))); 
671      VarValV.Add(int(BlockNToCsptLast3WH.GetDat(BlockN))); 
672      VarValV.Add(int(BlockNToCsptLast1DH.GetDat(BlockN))); 
673      VarValV.Add(int(BlockNToCsptLast2DH.GetDat(BlockN))); 
674      VarValV.Add(int(BlockNToCsptLast3DH.GetDat(BlockN))); 
675      VarValV.Add(int(BlockNToCsptLast4DH.GetDat(BlockN))); 
676      VarValV.Add(int(BlockNToCsptLast5DH.GetDat(BlockN))); 
677      VarValV.Add(int(BlockNToCsptLast6DH.GetDat(BlockN))); 
678      VarValV.Add(GasLtpBs-&gt;GetIsHoliday(RecN));
679      if (VarValV.IsIn(-1)){
680        printf(&quot;Ignoring %s\n&quot;, GasLtpBs-&gt;GetTm(RecN).GetStr().CStr()); continue;}
681      VarValV.Add(GasLtpBs-&gt;GetVol(RecN));
682      GasDm-&gt;AddRec(VarValV);
683    }}
684    return GasDm;
685  }
686  PGasDm TGasDm::GetHourGasDm(const PGasLtpBs&amp; GasLtpBs){
687    PGasDm GasDm=TGasDm::New();
688    GasDm-&gt;PutLtpNm(GasLtpBs-&gt;GetLtpNm());
689    GasDm-&gt;PutLocNm(GasLtpBs-&gt;GetLocNm());
690    GasDm-&gt;PutProdNm(GasLtpBs-&gt;GetProdNm());
691    GasDm-&gt;AddVar(&quot;Date&quot;, &quot;date&quot;); 
692    GasDm-&gt;AddVar(&quot;Cspt&quot;, &quot;class&quot;); 
693    GasDm-&gt;AddVar(&quot;Const&quot;, &quot;attr&quot;); 
694    GasDm-&gt;AddVar(&quot;Hour&quot;, &quot;attr&quot;); 
695    GasDm-&gt;AddVar(&quot;Dow&quot;, &quot;attr&quot;); 
696    GasDm-&gt;AddVar(&quot;Month&quot;, &quot;attr&quot;); 
697    GasDm-&gt;AddVar(&quot;CsptLast1W&quot;, &quot;attr&quot;);
698    GasDm-&gt;AddVar(&quot;CsptLast2W&quot;, &quot;attr&quot;);
699    GasDm-&gt;AddVar(&quot;CsptLast3W&quot;, &quot;attr&quot;);
700    GasDm-&gt;AddVar(&quot;CsptLast1D&quot;, &quot;attr&quot;);
701    GasDm-&gt;AddVar(&quot;CsptLast2D&quot;, &quot;attr&quot;);
702    GasDm-&gt;AddVar(&quot;CsptLast3D&quot;, &quot;attr&quot;);
703    GasDm-&gt;AddVar(&quot;IsHoliday&quot;, &quot;attr&quot;);
704    GasDm-&gt;AddVar(&quot;Volume&quot;, &quot;volume&quot;);
705    for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
706      TFltV VarValV(GasDm-&gt;GetVars(), 0);
707      VarValV.Add(GasLtpBs-&gt;GetDateInt(RecN)); 
708      VarValV.Add(GasLtpBs-&gt;GetCspt(RecN)); 
709      VarValV.Add(1); 
710      VarValV.Add(GasLtpBs-&gt;GetHourN(RecN)); 
711      VarValV.Add(GasLtpBs-&gt;GetDowN(RecN)); 
712      VarValV.Add(GasLtpBs-&gt;GetMonthN(RecN)); 
713      VarValV.Add(TFlt(GasLtpBs-&gt;GetCsptLast1W(RecN)));
714      VarValV.Add(TFlt(GasLtpBs-&gt;GetCsptLast2W(RecN)));
715      VarValV.Add(TFlt(GasLtpBs-&gt;GetCsptLast3W(RecN)));
716      VarValV.Add(TFlt(GasLtpBs-&gt;GetCsptLast1D(RecN)));
717      VarValV.Add(TFlt(GasLtpBs-&gt;GetCsptLast2D(RecN)));
718      VarValV.Add(TFlt(GasLtpBs-&gt;GetCsptLast3D(RecN)));
719      VarValV.Add(GasLtpBs-&gt;GetIsHoliday(RecN));
720      if (VarValV.IsIn(-1)){
721        printf(&quot;Ignoring %s\n&quot;, GasLtpBs-&gt;GetTm(RecN).GetStr().CStr()); continue;}
722      VarValV.Add(GasLtpBs-&gt;GetVol(RecN));
723      GasDm-&gt;AddRec(VarValV);
724    }
725    return GasDm;
726  }
727  int TGasDm::AddWeekRec(const double&amp; Cspt){
728    IAssert(TypeNm==&quot;Week&quot;);
729    TSecTm PrevDt=GetDateVal(GetRecs()-1);
730    TSecTm TodayDt=TSecTm(PrevDt).AddDays(+7);
731    int TodayRecN=AddRec();
732    if (TodayRecN&lt;=21){
733      TExcept::Throw(&quot;Not enough past data - cannot calculate future records.&quot;);}
734    PutVarVal(TodayRecN, &quot;Date&quot;, TodayDt.GetAbsSecs());
735    PutVarVal(TodayRecN, &quot;Cspt&quot;, Cspt);
736    PutVarVal(TodayRecN, &quot;Const&quot;, 1);
737    PutVarVal(TodayRecN, &quot;Month&quot;, TodayDt.GetMonthN());
738    PutVarVal(TodayRecN, &quot;SumCsptLast1W&quot;, GetVarVal(TodayRecN-7, &quot;Cspt&quot;));
739    PutVarVal(TodayRecN, &quot;SumCsptLast2W&quot;, GetVarVal(TodayRecN-14, &quot;Cspt&quot;));
740    PutVarVal(TodayRecN, &quot;SumCsptLast3W&quot;, GetVarVal(TodayRecN-21, &quot;Cspt&quot;));
741    PutVarVal(TodayRecN, &quot;SumCsptLast1D&quot;, GetVarVal(TodayRecN-1, &quot;Cspt&quot;));
742    PutVarVal(TodayRecN, &quot;SumCsptLast2D&quot;, GetVarVal(TodayRecN-2, &quot;Cspt&quot;));
743    PutVarVal(TodayRecN, &quot;SumCsptLast3D&quot;, GetVarVal(TodayRecN-3, &quot;Cspt&quot;));
744    PutVarVal(TodayRecN, &quot;SumCsptLast4D&quot;, GetVarVal(TodayRecN-4, &quot;Cspt&quot;));
745    PutVarVal(TodayRecN, &quot;SumCsptLast5D&quot;, GetVarVal(TodayRecN-5, &quot;Cspt&quot;));
746    PutVarVal(TodayRecN, &quot;SumCsptLast6D&quot;, GetVarVal(TodayRecN-6, &quot;Cspt&quot;));
747    PutVarVal(TodayRecN, &quot;Volume&quot;, -1);
748    return TodayRecN;
749  }
750  int TGasDm::AddDayRec(const double&amp; Cspt){
751    IAssert(TypeNm==&quot;Day&quot;);
752    TSecTm PrevDt=GetDateVal(GetRecs()-1);
753    TSecTm TodayDt=TSecTm(PrevDt).AddDays(+1);
754    int TodayRecN=AddRec();
755    if (TodayRecN&lt;=21){
756      TExcept::Throw(&quot;Not enough past data - cannot calculate future records.&quot;);}
757    PutVarVal(TodayRecN, &quot;Date&quot;, TodayDt.GetAbsSecs());
758    PutVarVal(TodayRecN, &quot;Cspt&quot;, Cspt);
759    PutVarVal(TodayRecN, &quot;Const&quot;, 1);
760    PutVarVal(TodayRecN, &quot;Dow&quot;, TodayDt.GetDayOfWeekN());
761    PutVarVal(TodayRecN, &quot;Month&quot;, TodayDt.GetMonthN());
762    PutVarVal(TodayRecN, &quot;SumCsptLast1W&quot;, GetVarVal(TodayRecN-7, &quot;Cspt&quot;));
763    PutVarVal(TodayRecN, &quot;SumCsptLast2W&quot;, GetVarVal(TodayRecN-14, &quot;Cspt&quot;));
764    PutVarVal(TodayRecN, &quot;SumCsptLast3W&quot;, GetVarVal(TodayRecN-21, &quot;Cspt&quot;));
765    PutVarVal(TodayRecN, &quot;SumCsptLast1D&quot;, GetVarVal(TodayRecN-1, &quot;Cspt&quot;));
766    PutVarVal(TodayRecN, &quot;SumCsptLast2D&quot;, GetVarVal(TodayRecN-2, &quot;Cspt&quot;));
767    PutVarVal(TodayRecN, &quot;SumCsptLast3D&quot;, GetVarVal(TodayRecN-3, &quot;Cspt&quot;));
768    PutVarVal(TodayRecN, &quot;SumCsptLast4D&quot;, GetVarVal(TodayRecN-4, &quot;Cspt&quot;));
769    PutVarVal(TodayRecN, &quot;SumCsptLast5D&quot;, GetVarVal(TodayRecN-5, &quot;Cspt&quot;));
770    PutVarVal(TodayRecN, &quot;SumCsptLast6D&quot;, GetVarVal(TodayRecN-6, &quot;Cspt&quot;));
771    PutVarVal(TodayRecN, &quot;IsHoliday&quot;, 0);
772    PutVarVal(TodayRecN, &quot;IsHolidayStart&quot;, 0);
773    PutVarVal(TodayRecN, &quot;IsHolidayEnd&quot;, 0);
774    PutVarVal(TodayRecN, &quot;IsDayBeforeHoliday&quot;, 0);
775    PutVarVal(TodayRecN, &quot;IsDayAfterHoliday&quot;, 0);
776    PutVarVal(TodayRecN, &quot;PriceChange&quot;, 0);
777    PutVarVal(TodayRecN, &quot;DaysBeforePriceChange&quot;, 0);
778    PutVarVal(TodayRecN, &quot;Volume&quot;, -1);
779    return TodayRecN;
780  }
781  int TGasDm::AddHourBlockRec(const double&amp; Cspt){
782    IAssert(TypeNm.IsPrefix(&quot;Hour&quot;));
783    TStr HoursResStr=TypeNm.GetSubStr(TStr(&quot;Hour&quot;).Len(), 999);
784    int HoursRes=HoursResStr.GetInt(1);
785    int RecsPerDay=24/HoursRes;
786    int RecsPerWeek=(7*24)/HoursRes;
787    TSecTm PrevTm=GetDateVal(GetRecs()-1);
788    TSecTm NowTm=TSecTm(PrevTm).AddHours(HoursRes);
789    int NowRecN=AddRec();
790    if (NowRecN&lt;=3*RecsPerWeek){
791      TExcept::Throw(&quot;Not enough past data - cannot calculate future records.&quot;);}
792    PutVarVal(NowRecN, &quot;Date&quot;, NowTm.GetAbsSecs());
793    PutVarVal(NowRecN, &quot;Cspt&quot;, Cspt);
794    PutVarVal(NowRecN, &quot;Const&quot;, 1);
795    PutVarVal(NowRecN, &quot;Hour&quot;, NowTm.GetHourN());
796    PutVarVal(NowRecN, &quot;Dow&quot;, NowTm.GetDayOfWeekN());
797    PutVarVal(NowRecN, &quot;Month&quot;, NowTm.GetMonthN());
798    PutVarVal(NowRecN, &quot;CsptLast1W&quot;, GetVarVal(NowRecN-1*RecsPerWeek, &quot;Cspt&quot;));
799    PutVarVal(NowRecN, &quot;CsptLast2W&quot;, GetVarVal(NowRecN-2*RecsPerWeek, &quot;Cspt&quot;));
800    PutVarVal(NowRecN, &quot;CsptLast3W&quot;, GetVarVal(NowRecN-3*RecsPerWeek, &quot;Cspt&quot;));
801    PutVarVal(NowRecN, &quot;CsptLast1D&quot;, GetVarVal(NowRecN-1*RecsPerDay, &quot;Cspt&quot;));
802    PutVarVal(NowRecN, &quot;CsptLast2D&quot;, GetVarVal(NowRecN-2*RecsPerDay, &quot;Cspt&quot;));
803    PutVarVal(NowRecN, &quot;CsptLast3D&quot;, GetVarVal(NowRecN-3*RecsPerDay, &quot;Cspt&quot;));
804    PutVarVal(NowRecN, &quot;CsptLast4D&quot;, GetVarVal(NowRecN-4*RecsPerDay, &quot;Cspt&quot;));
805    PutVarVal(NowRecN, &quot;CsptLast5D&quot;, GetVarVal(NowRecN-5*RecsPerDay, &quot;Cspt&quot;));
806    PutVarVal(NowRecN, &quot;CsptLast6D&quot;, GetVarVal(NowRecN-6*RecsPerDay, &quot;Cspt&quot;));
807    PutVarVal(NowRecN, &quot;IsHoliday&quot;, 0);
808    PutVarVal(NowRecN, &quot;Volume&quot;, -1);
809    return NowRecN;
810  }
811  int TGasDm::AddTmResRec(const double&amp; Cspt){
812    if (TypeNm==&quot;Week&quot;){return AddWeekRec(Cspt);}
813    if (TypeNm==&quot;Day&quot;){return AddDayRec(Cspt);}
814    if (TypeNm.IsPrefix(&quot;Hour&quot;)){return AddHourBlockRec(Cspt);}
815    else {Fail; return -1;}
816  }
817  void TGasDm::DumpRec(const int&amp; RecN) const {
818    printf(&quot;Record[%d]:&quot;, RecN);
819    for (int VarN=0; VarN&lt;GetVars(); VarN++){
820      if (GetVarNm(VarN)==&quot;Date&quot;){
821        printf(&quot; [%s:%s]&quot;, GetVarNm(VarN).CStr(),
822         TSecTm(int(GetVarVal(RecN, VarN))).GetStr().CStr());
823      } else {
824        printf(&quot; [%s:%g]&quot;, GetVarNm(VarN).CStr(), GetVarVal(RecN, VarN));
825      }
826    }
827    printf(&quot;\n\n&quot;);
828  }
829  void TGasDmHd::GetAttrNmV(TStrV&amp; AttrNmV) const {
830    AttrNmV.Clr();
831    for (int VarN=0; VarN&lt;GetVars(); VarN++){
832      if (GetVarTy(VarN)==&quot;attr&quot;){
833        AttrNmV.Add(GetVarNm(VarN));
834      }
835    }
836  }
837  TStr TGasDmHd::GetClassNm() const {
838    for (int VarN=0; VarN&lt;GetVars(); VarN++){
839      if (GetVarTy(VarN)==&quot;class&quot;){
840        return GetVarNm(VarN);
841      }
842    }
843    Fail;
844    return TStr();
845  }
846  TStr TGasMdMType::GetDescStr() const {
847    if (GetMdTypes()==1){
848      TGasMdType GasMdType=GetMdType(0);
849      return TGasMd::GetGasMdTypeBriefNm(GasMdType);
850    } else {
851      TChA ChA;
852      ChA+=&quot;Ensemble(&quot;;
853      for (int MdTypeN=0; MdTypeN&lt;GetMdTypes(); MdTypeN++){
854        if (MdTypeN&gt;0){ChA+=&#x27; &#x27;;}
855        TGasMdType GasMdType=GetMdType(MdTypeN);
856        double Wgt=GetMdWgt(MdTypeN);
857        ChA+=TGasMd::GetGasMdTypeBriefNm(GasMdType);
858        ChA+=&quot;:&quot;;
859        ChA+=TFlt::GetStr(Wgt, &quot;%.2f&quot;);
860      }
861      ChA+=&quot;)&quot;;
862      return ChA;
863    }
864  }
865  void TGasMdMType::AddMdTypeWgt(const TGasMdType&amp; MdType, const double&amp; MdWgt){
866    if (MdWgt&lt;=0){return;}
867    MdTypeWgtPrV.Add(TIntFltPr(int(MdType), MdWgt));
868  }
869  void TGasMdMType::NrmMdWgt(){
870    double SumMdWgt=0;
871    for (int MdTypeN=0; MdTypeN&lt;GetMdTypes(); MdTypeN++){
872      SumMdWgt+=GetMdWgt(MdTypeN);}
873    {for (int MdTypeN=0; MdTypeN&lt;GetMdTypes(); MdTypeN++){
874      MdTypeWgtPrV[MdTypeN].Val2=MdTypeWgtPrV[MdTypeN].Val2/SumMdWgt;}}
875  }
876  double TGasMd::GetCorPredClassVal(
877   const PGasDm&amp; GasDm, const int&amp; RecN, const double&amp; CorFact) const {
878    double ClassVal=GetPredClassVal(GasDm, RecN);
879    if (GasDm-&gt;GetAttrVal(RecN, &quot;DaysBeforePriceChange&quot;, 0)==1){
880      ClassVal*=CorFact;}
881    if (ClassVal&lt;0){
882      ClassVal=0;}
883    return ClassVal;
884  }
885  PGasMd TGasMd::New(
886   const TGasMdType&amp; GasMdType,
887   const PGasMdMType&amp; GasMdMType, const TStr&amp; GasMdParamStr,
888   const PGasDm&amp; GasDm,
889   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
890   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
891    switch (GasMdType){
892      case gmtCTb: return TGasMdCTb::New(GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
893      case gmtLr: return TGasMdSvd::New(GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
894      case gmtNNbr: return TGasMdNNbr::New(GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
895      case gmtSvm: return TGasMdSvm::New(GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
896      case gmtCubist: return TGasMdCubist::New(GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
897      case gmtRegTree: return TGasMdRegTree::New(GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
898      case gmtEnsemble: return TGasMdEnsemble::New(GasMdMType, GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
899      default: Fail; return NULL;
900    }
901  }
902  TStr TGasMd::GetGasMdTypeNm(const TGasMdType&amp; GasMdType){
903    switch (GasMdType){
904      case gmtCTb: return &quot;Contingency-Table&quot;;
905      case gmtLr: return &quot;Singular-Value-Decomposition&quot;;
906      case gmtNNbr: return &quot;Nearest-Neigbour&quot;;
907      case gmtSvm: return &quot;Support-Vector-Machine&quot;;
908      case gmtCubist: return &quot;Cubist&quot;;
909      case gmtRegTree: return &quot;Regression-Tree&quot;;
910      case gmtEnsemble: return &quot;Ensemble&quot;;
911      default: Fail; return TStr();
912    }
913  }
914  TStr TGasMd::GetGasMdTypeBriefNm(const TGasMdType&amp; GasMdType){
915    switch (GasMdType){
916      case gmtCTb: return &quot;ContTb&quot;;
917      case gmtLr: return &quot;SVD&quot;;
918      case gmtNNbr: return &quot;NNbr&quot;;
919      case gmtSvm: return &quot;SVM&quot;;
920      case gmtCubist: return &quot;Cubist&quot;;
921      case gmtRegTree: return &quot;RTree&quot;;
922      case gmtEnsemble: return &quot;Ensemble&quot;;
923      default: Fail; return TStr();
924    }
925  }
926  TStr TGasMd::GetMdParamStr(){
927    return
928     &quot;&lt;Model&gt;&quot;
929     &quot;  &lt;ContTable&gt;&lt;Moment&gt;Median&lt;/Moment&gt;&lt;/ContTable&gt;&quot;
930     &quot;  &lt;NNbr&gt;&lt;K&gt;5&lt;/K&gt;&lt;/NNbr&gt;&quot;
931     &quot;  &lt;Cubist&gt;&lt;FileId&gt;CubistData&lt;/FileId&gt;&lt;/Cubist&gt;&quot;
932     &quot;  &lt;Svm&gt;&lt;FileId&gt;SvmData&lt;/FileId&gt;&lt;/Svm&gt;&quot;
933     &quot;  &lt;RegTree&gt;&lt;MnLeafExs&gt;5&lt;/MnLeafExs&gt;&lt;/RegTree&gt;&quot;
934     &quot;&lt;/Model&gt;&quot;;
935  }
936  PGasMd TGasMdEnsemble::New(
937   const PGasMdMType&amp; GasMdMType, const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
938   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
939   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
940    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
941    TGasMdEnsemble* GasMdEnsemble=new TGasMdEnsemble(GasDmHd, GasMdMType);
942    PGasMd GasMd(GasMdEnsemble);
943    for (int MdTypeN=0; MdTypeN&lt;GasMdMType-&gt;GetMdTypes(); MdTypeN++){
944      TGasMdType GasMdType=GasMdMType-&gt;GetMdType(MdTypeN);
945      PGasMd SubGasMd=TGasMd::New(GasMdType, NULL, ParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
946      GasMdEnsemble-&gt;GasMdV.Add(SubGasMd);
947    }
948    return GasMd;
949  }
950  double TGasMdEnsemble::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
951    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
952    double PredClassVal=0;
953    for (int MdTypeN=0; MdTypeN&lt;GasMdMType-&gt;GetMdTypes(); MdTypeN++){
954      double GasMdWgt=GasMdMType-&gt;GetMdWgt(MdTypeN);
955      PGasMd SubGasMd=GasMdV[MdTypeN];
956      PredClassVal+=GasMdWgt*SubGasMd-&gt;GetPredClassVal(GasDm, RecN);
957    }
958    return PredClassVal;
959  }
960  PMom TGasMdEnsemble::GetClassValMom() const {
961    return GasMdV[0]-&gt;GetClassValMom();
962  }
963  void TGasMdEnsemble::Print() const {
964    if (GasMdMType-&gt;GetMdTypes()==1){
965      GasMdV[0]-&gt;Print();
966    } else {
967      printf(&quot;==========================================================\n&quot;);
968      printf(&quot;ClassVal: %s\n&quot;, GetClassValMom()-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
969      printf(&quot;ClassVal =\n&quot;);
970      for (int MdTypeN=0; MdTypeN&lt;GasMdMType-&gt;GetMdTypes(); MdTypeN++){
971        TGasMdType GasMdType=GasMdMType-&gt;GetMdType(MdTypeN);
972        double GasMdWgt=GasMdMType-&gt;GetMdWgt(MdTypeN);
973        printf(&quot;    + %g * %s\n&quot;, GasMdWgt, TGasMd::GetGasMdTypeNm(GasMdType).CStr());
974      }
975      printf(&quot;\n&quot;);
976    }
977  }
978  PGasMd TGasMdCTb::New(const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
979   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
980   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
981    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
982    TGasMdCTb* GasMdCTb=new TGasMdCTb(GasDmHd); PGasMd GasMd(GasMdCTb);
983    PSIn ParamXmlSIn=TStrIn::New(ParamStr);
984    PXmlDoc ParamXmlDoc=TXmlDoc::LoadTxt(ParamXmlSIn);
985    GasMdCTb-&gt;MomNm=ParamXmlDoc-&gt;GetTagTokStr(&quot;Model|ContTable|Moment&quot;);
986    TIntV RecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, StartRecN, EndRecN, MnCspt, RecNV);
987    int Recs=RecNV.Len();
988    GasMdCTb-&gt;HourAttrN=GasDm-&gt;GetAttrN(&quot;Hour&quot;);
989    GasMdCTb-&gt;DowAttrN=GasDm-&gt;GetAttrN(&quot;Dow&quot;);
990    GasMdCTb-&gt;MonthAttrN=GasDm-&gt;GetAttrN(&quot;Month&quot;);
991    GasMdCTb-&gt;ClassValMom=TMom::New();
992    TMom::NewV(GasMdCTb-&gt;HourMomV, 24);
993    TMom::NewV(GasMdCTb-&gt;DowMomV, 7);
994    TMom::NewV(GasMdCTb-&gt;MonthMomV, 12);
995    TMom::NewVV(GasMdCTb-&gt;DowHourMomVV, 7, 24);
996    for (int RecNN=0; RecNN&lt;Recs; RecNN++){
997      int RecN=RecNV[RecNN];
998      double ClassVal=GasDm-&gt;GetClassVal(RecN);
999      int HourN, DowN, MonthN;
1000      if (GasMdCTb-&gt;HourAttrN!=-1){HourN=GasDm-&gt;GetAttrVal(RecN, GasMdCTb-&gt;HourAttrN, 0);}
1001      if (GasMdCTb-&gt;DowAttrN!=-1){DowN=GasDm-&gt;GetAttrVal(RecN, GasMdCTb-&gt;DowAttrN, 0)-1;}
1002      if (GasMdCTb-&gt;MonthAttrN!=-1){MonthN=GasDm-&gt;GetAttrVal(RecN, GasMdCTb-&gt;MonthAttrN, 0)-1;}
1003      GasMdCTb-&gt;ClassValMom-&gt;Add(ClassVal);
1004      if (GasMdCTb-&gt;HourAttrN!=-1){
1005        GasMdCTb-&gt;HourMomV[HourN]-&gt;Add(ClassVal);}
1006      if (GasMdCTb-&gt;DowAttrN!=-1){
1007        GasMdCTb-&gt;DowMomV[DowN]-&gt;Add(ClassVal);}
1008      if (GasMdCTb-&gt;MonthAttrN!=-1){
1009        GasMdCTb-&gt;MonthMomV[MonthN]-&gt;Add(ClassVal);}
1010      if ((GasMdCTb-&gt;DowAttrN!=-1)&amp;&amp;(GasMdCTb-&gt;HourAttrN!=-1)){
1011        GasMdCTb-&gt;DowHourMomVV.At(DowN, HourN)-&gt;Add(ClassVal);}
1012    }
1013    GasMdCTb-&gt;ClassValMom-&gt;Def();
1014    TMom::DefV(GasMdCTb-&gt;HourMomV);
1015    TMom::DefV(GasMdCTb-&gt;DowMomV);
1016    TMom::DefV(GasMdCTb-&gt;MonthMomV);
1017    TMom::DefVV(GasMdCTb-&gt;DowHourMomVV);
1018    return GasMd;
1019  }
1020  double TGasMdCTb::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1021    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1022    int HourN, DowN, MonthN;
1023    if (HourAttrN!=-1){HourN=GasDm-&gt;GetAttrVal(RecN, HourAttrN, 0);}
1024    if (DowAttrN!=-1){DowN=GasDm-&gt;GetAttrVal(RecN, DowAttrN, 0)-1;}
1025    if (MonthAttrN!=-1){MonthN=GasDm-&gt;GetAttrVal(RecN, MonthAttrN, 0)-1;}
1026    PMom Mom1; PMom Mom2;
1027    if ((HourAttrN!=-1)&amp;&amp;(DowAttrN!=-1)){
1028      Mom1=DowHourMomVV.At(DowN, HourN);
1029    } else
1030    if ((DowAttrN!=-1)&amp;&amp;(MonthAttrN!=-1)){
1031      Mom1=DowMomV[DowN];
1032    } else
1033    if (HourAttrN!=-1){
1034      Mom1=HourMomV[HourN];
1035    } else
1036    if (DowAttrN!=-1){
1037      Mom1=DowMomV[DowN];
1038    } else
1039    if (MonthAttrN!=-1){
1040      Mom1=MonthMomV[MonthN];
1041    } else {
1042      Mom1=ClassValMom;
1043    }
1044    double PredClassVal=0;
1045    if (Mom1-&gt;IsUsable()){
1046      PredClassVal=Mom1-&gt;GetByNm(MomNm);
1047    }
1048    if ((!Mom2.Empty())&amp;&amp;(Mom2-&gt;IsUsable())){
1049      PredClassVal=0.5*PredClassVal+0.5*Mom2-&gt;GetByNm(MomNm);
1050    }
1051    return PredClassVal;
1052  }
1053  void TGasMdCTb::Print() const {
1054    printf(&quot;==========================================================\n&quot;);
1055    printf(&quot;ClassVal: %s\n&quot;, ClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1056    printf(&quot;per Hour:&quot;);
1057    for (int HourN=0; HourN&lt;24; HourN++){
1058      printf(&quot; [%d:%s]&quot;, HourN, HourMomV[HourN]-&gt;GetStrByNm(MomNm).CStr());}
1059    printf(&quot;\n&quot;);
1060    printf(&quot;per Day-Of-Week:&quot;);
1061    for (int DowN=0; DowN&lt;7; DowN++){
1062      printf(&quot; [%s:%s]&quot;, TTmInfo::GetDayOfWeekNm(DowN+1).CStr(),
1063       DowMomV[DowN]-&gt;GetStrByNm(MomNm).CStr());
1064    }
1065    printf(&quot;\n&quot;);
1066    printf(&quot;per Month:&quot;);
1067    for (int MonthN=0; MonthN&lt;12; MonthN++){
1068      printf(&quot; [%s:%s]&quot;, TTmInfo::GetMonthNm(MonthN+1).CStr(),
1069       MonthMomV[MonthN]-&gt;GetStrByNm(MomNm).CStr());
1070    }
1071    printf(&quot;\n&quot;);
1072  }
1073  PGasMd TGasMdSvd::New(const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
1074   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
1075   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
1076    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
1077    TGasMdSvd* GasMdSvd=new TGasMdSvd(GasDmHd); PGasMd GasMd(GasMdSvd);
1078    TIntV RecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, StartRecN, EndRecN, MnCspt, RecNV);
1079    int Attrs=GasDm-&gt;GetAttrs(); int Recs=RecNV.Len();
1080    TFltVV XVV(Recs, Attrs); TFltV YV(Recs); GasMdSvd-&gt;ClassValMom=TMom::New();
1081    for (int RecNN=0; RecNN&lt;Recs; RecNN++){
1082      int RecN=RecNV[RecNN];
1083      double ClassVal=GasDm-&gt;GetClassVal(RecN);
1084      TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1085      for (int AttrN=0; AttrN&lt;AttrValV.Len(); AttrN++){
1086        XVV.At(RecNN, AttrN)=AttrValV[AttrN];
1087      }
1088      YV[RecNN]=ClassVal;
1089      GasMdSvd-&gt;ClassValMom-&gt;Add(ClassVal);
1090    }
1091    GasMdSvd-&gt;ClassValMom-&gt;Def();
1092    PSvd Svd=TSvd::New(XVV, YV);
1093    Svd-&gt;GetCfV(GasMdSvd-&gt;CfV);
1094    Svd-&gt;GetCfUncerV(GasMdSvd-&gt;CfUncerV);
1095    GasMdSvd-&gt;ChiSq=Svd-&gt;GetChiSq();
1096    return GasMd;
1097  }
1098  double TGasMdSvd::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1099    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1100    double PredClassVal=0;
1101    TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1102    IAssert(AttrValV.Len()==CfV.Len());
1103    for (int AttrN=0; AttrN&lt;AttrValV.Len(); AttrN++){
1104      PredClassVal+=CfV[AttrN]*AttrValV[AttrN];
1105    }
1106    return PredClassVal;
1107  }
1108  void TGasMdSvd::Print() const {
1109    printf(&quot;==========================================================\n&quot;);
1110    PGasDmHd GasDmHd=GetGasDmHd();
1111    TStrV AttrNmV; GasDmHd-&gt;GetAttrNmV(AttrNmV);
1112    TStr ClassNm=GasDmHd-&gt;GetClassNm();
1113    printf(&quot;%s = &quot;, ClassNm.CStr());
1114    IAssert((AttrNmV.Len()==CfV.Len())&amp;&amp;(AttrNmV.Len()==CfUncerV.Len()));
1115    for (int AttrN=0; AttrN&lt;AttrNmV.Len(); AttrN++){
1116      printf(&quot;\t%+g * %s\n&quot;, CfV[AttrN](), AttrNmV[AttrN].CStr());
1117    }
1118    printf(&quot;\n&quot;);
1119    printf(&quot;ClassVal: %s\n&quot;, ClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1120  }
1121  PGasMd TGasMdNNbr::New(const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
1122   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
1123   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
1124    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
1125    TGasMdNNbr* GasMdNNbr=new TGasMdNNbr(GasDmHd); PGasMd GasMd(GasMdNNbr);
1126    PSIn ParamXmlSIn=TStrIn::New(ParamStr);
1127    PXmlDoc ParamXmlDoc=TXmlDoc::LoadTxt(ParamXmlSIn);
1128    GasMdNNbr-&gt;NNbrs=ParamXmlDoc-&gt;GetTagTokStr(&quot;Model|NNbr|K&quot;).GetInt();
1129    IAssert(GasMdNNbr-&gt;NNbrs&gt;0);
1130    TIntV RecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, StartRecN, EndRecN, MnCspt, RecNV);
1131    int Attrs=GasDm-&gt;GetAttrs(); int Recs=RecNV.Len();
1132    GasMdNNbr-&gt;AttrValVV.Gen(Recs); TMom::NewV(GasMdNNbr-&gt;AttrValMomV, Attrs);
1133    GasMdNNbr-&gt;ClassValV.Gen(Recs); GasMdNNbr-&gt;ClassValMom=TMom::New();
1134    for (int RecNN=0; RecNN&lt;Recs; RecNN++){
1135      int RecN=RecNV[RecNN];
1136      TFltV&amp; AttrValV=GasMdNNbr-&gt;AttrValVV[RecNN];
1137      GasDm-&gt;GetAttrValV(RecN, AttrValV);
1138      for (int AttrN=0; AttrN&lt;Attrs; AttrN++){
1139        GasMdNNbr-&gt;AttrValMomV[AttrN]-&gt;Add(AttrValV[AttrN]);}
1140      double ClassVal=GasDm-&gt;GetClassVal(RecN);
1141      GasMdNNbr-&gt;ClassValV[RecNN]=ClassVal;
1142      GasMdNNbr-&gt;ClassValMom-&gt;Add(ClassVal);
1143    }
1144    TMom::DefV(GasMdNNbr-&gt;AttrValMomV);
1145    GasMdNNbr-&gt;ClassValMom-&gt;Def();
1146    return GasMd;
1147  }
1148  double TGasMdNNbr::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1149    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1150    TFltIntKdV DistRecNKdV;
1151    TFltV PredAttrValV; GasDm-&gt;GetAttrValV(RecN, PredAttrValV);
1152    for (int AttrValVN=0; AttrValVN&lt;AttrValVV.Len(); AttrValVN++){
1153      TFltV&amp; DmAttrValV=AttrValVV[AttrValVN];
1154      double Dist=0;
1155      for (int AttrN=0; AttrN&lt;PredAttrValV.Len(); AttrN++){
1156        double AttrValDist=PredAttrValV[AttrN]-DmAttrValV[AttrN];
1157        double AttrNrmVal=AttrValMomV[AttrN]-&gt;GetMedian();
1158        if (AttrNrmVal!=0){AttrValDist=AttrValDist/AttrNrmVal;}
1159        Dist+=TMath::Sqr(AttrValDist);
1160      }
1161      Dist=sqrt(Dist);
1162      TFltIntKd DistRecNKd(Dist, AttrValVN);
1163      DistRecNKdV.AddSorted(DistRecNKd, true, NNbrs);
1164    }
1165    double PredClassVal=0;
1166    for (int DistRecNKdN=0; DistRecNKdN&lt;DistRecNKdV.Len(); DistRecNKdN++){
1167      int RecN=DistRecNKdV[DistRecNKdN].Dat;
1168      double ClassVal=ClassValV[RecN];
1169      PredClassVal+=ClassVal;
1170    }
1171    if (DistRecNKdV.Len()&gt;0){
1172      PredClassVal=PredClassVal/DistRecNKdV.Len();}
1173    return PredClassVal;
1174  }
1175  TStr TGasMdNNbr::GetPredExpl(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1176    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1177    TFltIntKdV DistRecNKdV;
1178    TFltV PredAttrValV; GasDm-&gt;GetAttrValV(RecN, PredAttrValV);
1179    for (int AttrValVN=0; AttrValVN&lt;AttrValVV.Len(); AttrValVN++){
1180      TFltV&amp; DmAttrValV=AttrValVV[AttrValVN];
1181      double Dist=0;
1182      for (int AttrN=0; AttrN&lt;PredAttrValV.Len(); AttrN++){
1183        double AttrValDist=PredAttrValV[AttrN]-DmAttrValV[AttrN];
1184        double AttrNrmVal=AttrValMomV[AttrN]-&gt;GetMedian();
1185        if (AttrNrmVal!=0){AttrValDist=AttrValDist/AttrNrmVal;}
1186        Dist+=TMath::Sqr(AttrValDist);
1187      }
1188      Dist=sqrt(Dist);
1189      TFltIntKd DistRecNKd(Dist, AttrValVN);
1190      DistRecNKdV.AddSorted(DistRecNKd, true, NNbrs);
1191    }
1192    TChA PredExplChA;
1193    return PredExplChA;
1194  }
1195  void TGasMdNNbr::Print() const {
1196    printf(&quot;==========================================================\n&quot;);
1197    printf(&quot;Nearest-Neigbours Window-Size: %d\n&quot;, NNbrs);
1198    printf(&quot;Records: %d\n&quot;, AttrValVV.Len());
1199    printf(&quot;ClassVal: %s\n&quot;, ClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1200  }
1201  PGasMd TGasMdCubist::New(
1202   const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
1203   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
1204   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
1205    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
1206    TGasMdCubist* GasMdCubist=new TGasMdCubist(GasDmHd); PGasMd GasMd(GasMdCubist);
1207    PSIn ParamXmlSIn=TStrIn::New(ParamStr);
1208    PXmlDoc ParamXmlDoc=TXmlDoc::LoadTxt(ParamXmlSIn);
1209    GasMdCubist-&gt;IdFNm=ParamXmlDoc-&gt;GetTagTokStr(&quot;Model|Cubist|FileId&quot;);
1210    TStr IdFNm=GasMdCubist-&gt;IdFNm;
1211    PSOut NamesSOut=TFOut::New(IdFNm+&quot;.names&quot;);
1212    NamesSOut-&gt;PutStr(GasDm-&gt;GetClassNm()); NamesSOut-&gt;PutStr(&quot;.\n\n&quot;);
1213    NamesSOut-&gt;PutStr(GasDm-&gt;GetClassNm()); NamesSOut-&gt;PutStr(&quot;: &quot;);
1214    NamesSOut-&gt;PutStr(&quot;continuous&quot;);
1215    NamesSOut-&gt;PutStr(&quot;.\n&quot;);
1216    TStrV AttrNmV; GasDm-&gt;GetAttrNmV(AttrNmV);
1217    for (int AttrN=0; AttrN&lt;AttrNmV.Len(); AttrN++){
1218      NamesSOut-&gt;PutStr(AttrNmV[AttrN]); NamesSOut-&gt;PutStr(&quot;: &quot;);
1219      if (AttrNmV[AttrN]==&quot;Dow&quot;){
1220        for (int DowN=0; DowN&lt;7; DowN++){
1221          if (DowN&gt;0){NamesSOut-&gt;PutStr(&quot;,&quot;);}
1222          NamesSOut-&gt;PutStr(TTmInfo::GetDayOfWeekNm(DowN+1));
1223        }
1224      } else
1225      if (AttrNmV[AttrN]==&quot;Month&quot;){
1226        for (int MonthN=0; MonthN&lt;12; MonthN++){
1227          if (MonthN&gt;0){NamesSOut-&gt;PutStr(&quot;,&quot;);}
1228          NamesSOut-&gt;PutStr(TTmInfo::GetMonthNm(MonthN+1));
1229        }
1230      } else {
1231        NamesSOut-&gt;PutStr(&quot;continuous&quot;);
1232      }
1233      NamesSOut-&gt;PutStr(&quot;.\n&quot;);
1234    }
1235    NamesSOut=NULL;
1236    TIntV RecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, StartRecN, EndRecN, MnCspt, RecNV);
1237    int Recs=RecNV.Len();
1238    PSOut DataSOut=TFOut::New(IdFNm+&quot;.data&quot;);
1239    GasMdCubist-&gt;ClassValMom=TMom::New();
1240    for (int RecNN=0; RecNN&lt;Recs; RecNN++){
1241      int RecN=RecNV[RecNN];
1242      double ClassVal=GasDm-&gt;GetClassVal(RecN);
1243      TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1244      GasMdCubist-&gt;ClassValMom-&gt;Add(ClassVal);
1245      DataSOut-&gt;PutFlt(ClassVal);
1246      for (int AttrN=0; AttrN&lt;AttrValV.Len(); AttrN++){
1247        DataSOut-&gt;PutStr(&quot;,&quot;);
1248        if (AttrNmV[AttrN]==&quot;Dow&quot;){
1249          DataSOut-&gt;PutStr(TTmInfo::GetDayOfWeekNm(AttrValV[AttrN]));
1250        } else
1251        if (AttrNmV[AttrN]==&quot;Month&quot;){
1252          DataSOut-&gt;PutStr(TTmInfo::GetMonthNm(AttrValV[AttrN]));
1253        } else {
1254          DataSOut-&gt;PutFlt(AttrValV[AttrN]);
1255        }
1256      }
1257      DataSOut-&gt;PutStr(&quot;\n&quot;);
1258    }
1259    GasMdCubist-&gt;ClassValMom-&gt;Def();
1260    DataSOut=NULL;
1261    TFile::Del(IdFNm+&quot;.model&quot;, false);
1262    TStr CubistCmLn=TStr(&quot;CubistX.exe -f &quot;)+IdFNm&amp;bsol;*+&quot; &quot;+OptStr*/;
1263    system(CubistCmLn.CStr());
1264    {PSIn NamesSIn=TFIn::New(IdFNm+&quot;.names&quot;);
<span onclick='openModal()' class='match'>1265    GasMdCubist-&gt;NamesFileStr=TStr(NamesSIn);}
1266    {PSIn DataSIn=TFIn::New(IdFNm+&quot;.data&quot;);
1267    GasMdCubist-&gt;DataFileStr=TStr(DataSIn);}
1268    {PSIn ModelSIn=TFIn::New(IdFNm+&quot;.model&quot;);
</span>1269    GasMdCubist-&gt;ModelFileStr=TStr(ModelSIn);}
1270    TFile::Del(IdFNm+&quot;.names&quot;, false);
1271    TFile::Del(IdFNm+&quot;.data&quot;, false);
1272    TFile::Del(IdFNm+&quot;.model&quot;, false);
1273    return GasMd;
1274  }
1275  double TGasMdCubist::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1276    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1277    {PSOut NamesSOut=TFOut::New(IdFNm+&quot;.names&quot;);
1278    NamesSOut-&gt;PutStr(NamesFileStr);}
1279    {PSOut DataSOut=TFOut::New(IdFNm+&quot;.data&quot;);
1280    DataSOut-&gt;PutStr(DataFileStr);}
1281    {PSOut ModelSOut=TFOut::New(IdFNm+&quot;.model&quot;);
1282    ModelSOut-&gt;PutStr(ModelFileStr);}
1283    PSOut CasesSOut=TFOut::New(IdFNm+&quot;.cases&quot;);
1284    TStrV AttrNmV; GasDm-&gt;GetAttrNmV(AttrNmV);
1285    double ClassVal=GasDm-&gt;GetClassVal(RecN);
1286    TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1287    CasesSOut-&gt;PutFlt(ClassVal);
1288    for (int AttrN=0; AttrN&lt;AttrValV.Len(); AttrN++){
1289      CasesSOut-&gt;PutStr(&quot;,&quot;);
1290      if (AttrNmV[AttrN]==&quot;Dow&quot;){
1291        CasesSOut-&gt;PutStr(TTmInfo::GetDayOfWeekNm(AttrValV[AttrN]));
1292      } else
1293      if (AttrNmV[AttrN]==&quot;Month&quot;){
1294        CasesSOut-&gt;PutStr(TTmInfo::GetMonthNm(AttrValV[AttrN]));
1295      } else {
1296        CasesSOut-&gt;PutFlt(AttrValV[AttrN]);
1297      }
1298    }
1299    CasesSOut-&gt;PutStr(&quot;\n&quot;);
1300    CasesSOut=NULL;
1301    TFile::Del(IdFNm+&quot;.xml&quot;, false);
1302    TStr CubistCmLn=TStr(&quot;CubistC.exe -f &quot;)+IdFNm;
1303    system(CubistCmLn.CStr());
1304    PXmlDoc XmlDoc=TXmlDoc::LoadTxt(IdFNm+&quot;.xml&quot;);
1305    TStr PredClassValStr=XmlDoc-&gt;GetTagTokStr(&quot;Prediction|Predicted&quot;);
1306    double PredClassVal=PredClassValStr.GetFlt();
1307    TFile::Del(IdFNm+&quot;.names&quot;, false);
1308    TFile::Del(IdFNm+&quot;.data&quot;, false);
1309    TFile::Del(IdFNm+&quot;.model&quot;, false);
1310    TFile::Del(IdFNm+&quot;.cases&quot;, false);
1311    TFile::Del(IdFNm+&quot;.xml&quot;, false);
1312    return PredClassVal;
1313  }
1314  void TGasMdCubist::Print() const {
1315    printf(&quot;==========================================================\n&quot;);
1316    printf(&quot;ClassVal: %s\n&quot;, ClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1317  }
1318  PGasMd TGasMdSvm::New(const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
1319   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
1320   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
1321    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
1322    TGasMdSvm* GasMdSvm=new TGasMdSvm(GasDmHd); PGasMd GasMd(GasMdSvm);
1323    PSIn ParamXmlSIn=TStrIn::New(ParamStr);
1324    PXmlDoc ParamXmlDoc=TXmlDoc::LoadTxt(ParamXmlSIn);
1325    GasMdSvm-&gt;IdFNm=ParamXmlDoc-&gt;GetTagTokStr(&quot;Model|Svm|FileId&quot;);
1326    TStr IdFNm=GasMdSvm-&gt;IdFNm;
1327    TIntV RecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, StartRecN, EndRecN, MnCspt, RecNV);
1328    int Recs=RecNV.Len();
1329    PSOut TrainSOut=TFOut::New(IdFNm+&quot;.train&quot;);
1330    TrainSOut-&gt;PutStr(&quot;# &quot;);
1331    TStrV AttrNmV; GasDm-&gt;GetAttrNmV(AttrNmV);
1332    for (int AttrN=0; AttrN&lt;AttrNmV.Len(); AttrN++){
1333      TrainSOut-&gt;PutStr(AttrNmV[AttrN]); TrainSOut-&gt;PutStr(&quot; &quot;);}
1334    TrainSOut-&gt;PutStr(GasDm-&gt;GetClassNm());
1335    TrainSOut-&gt;PutStr(&quot;\n&quot;);
1336    TrainSOut-&gt;PutStr(&quot;@examples\n&quot;);
1337    TrainSOut-&gt;PutStr(&quot;dimension &quot;); TrainSOut-&gt;PutInt(AttrNmV.Len()); TrainSOut-&gt;PutStr(&quot;\n&quot;);
1338    TrainSOut-&gt;PutStr(&quot;format xy\n&quot;);
1339    GasMdSvm-&gt;ClassValMom=TMom::New();
1340    for (int RecNN=0; RecNN&lt;Recs; RecNN++){
1341      int RecN=RecNV[RecNN];
1342      double ClassVal=GasDm-&gt;GetClassVal(RecN);
1343      TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1344      GasMdSvm-&gt;ClassValMom-&gt;Add(ClassVal);
1345      for (int AttrN=0; AttrN&lt;AttrValV.Len(); AttrN++){
1346        TrainSOut-&gt;PutFlt(AttrValV[AttrN]);
1347        TrainSOut-&gt;PutStr(&quot; &quot;);
1348      }
1349      TrainSOut-&gt;PutFlt(ClassVal);
1350      TrainSOut-&gt;PutStr(&quot;\n&quot;);
1351    }
1352    GasMdSvm-&gt;ClassValMom-&gt;Def();
1353    TrainSOut=NULL;
1354    PSOut ParamSOut=TFOut::New(IdFNm+&quot;.param&quot;);
1355    ParamSOut-&gt;PutStr(&quot;@kernel\n&quot;);
1356    ParamSOut-&gt;PutStr(&quot;type dot\n&quot;);
1357    ParamSOut-&gt;PutStr(&quot;@parameters\n&quot;);
1358    ParamSOut-&gt;PutStr(&quot;C 1000\n&quot;);
1359    ParamSOut-&gt;PutStr(&quot;epsilon 0.1\n&quot;);
1360    ParamSOut=NULL;
1361    TFile::Del(IdFNm+&quot;.train.svm&quot;, false);
1362    TStr SvmCmLn=TStr(&quot;MySvmLearn.exe &quot;)+IdFNm+&quot;.train &quot;+IdFNm+&quot;.param&quot;;
1363    system(SvmCmLn.CStr());
1364    {PSIn ModelSIn=TFIn::New(IdFNm+&quot;.train.svm&quot;);
1365    GasMdSvm-&gt;ModelFileStr=TStr(ModelSIn);}
1366    TFile::Del(IdFNm+&quot;.train&quot;, false);
1367    TFile::Del(IdFNm+&quot;.param&quot;, false);
1368    TFile::Del(IdFNm+&quot;.train.svm&quot;, false);
1369    return GasMd;
1370  }
1371  double TGasMdSvm::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1372    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1373    {PSOut ModelSOut=TFOut::New(IdFNm+&quot;.train.svm&quot;);
1374    ModelSOut-&gt;PutStr(ModelFileStr);}
1375    PSOut TestSOut=TFOut::New(IdFNm+&quot;.test&quot;);
1376    TestSOut-&gt;PutStr(&quot;# &quot;);
1377    TStrV AttrNmV; GasDm-&gt;GetAttrNmV(AttrNmV);
1378    for (int AttrN=0; AttrN&lt;AttrNmV.Len(); AttrN++){
1379      TestSOut-&gt;PutStr(AttrNmV[AttrN]); TestSOut-&gt;PutStr(&quot; &quot;);}
1380    TestSOut-&gt;PutStr(GasDm-&gt;GetClassNm());
1381    TestSOut-&gt;PutStr(&quot;\n&quot;);
1382    TestSOut-&gt;PutStr(&quot;@examples\n&quot;);
1383    TestSOut-&gt;PutStr(&quot;dimension &quot;); TestSOut-&gt;PutInt(AttrNmV.Len()); TestSOut-&gt;PutStr(&quot;\n&quot;);
1384    TestSOut-&gt;PutStr(&quot;format xy\n&quot;);
1385    double ClassVal=GasDm-&gt;GetClassVal(RecN);
1386    TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1387    {for (int AttrN=0; AttrN&lt;AttrValV.Len(); AttrN++){
1388      TestSOut-&gt;PutFlt(AttrValV[AttrN]);
1389      TestSOut-&gt;PutStr(&quot; &quot;);
1390    }}
1391    TestSOut-&gt;PutFlt(ClassVal);
1392    TestSOut-&gt;PutStr(&quot;\n&quot;);
1393    TestSOut=NULL;
1394    PSOut ParamSOut=TFOut::New(IdFNm+&quot;.param&quot;);
1395    ParamSOut-&gt;PutStr(&quot;@kernel\n&quot;);
1396    ParamSOut-&gt;PutStr(&quot;type dot\n&quot;);
1397    ParamSOut-&gt;PutStr(&quot;@parameters\n&quot;);
1398    ParamSOut-&gt;PutStr(&quot;C 1000\n&quot;);
1399    ParamSOut-&gt;PutStr(&quot;epsilon 0.1\n&quot;);
1400    ParamSOut=NULL;
1401    TFile::Del(IdFNm+&quot;test.pred&quot;, false);
1402    TStr SvmCmLn=TStr(&quot;MySvmPredict.exe &quot;)+
1403     IdFNm+&quot;.train.svm &quot;+IdFNm+&quot;.test &quot;+IdFNm+&quot;.param&quot;;
1404    system(SvmCmLn.CStr());
1405    PSIn PredSIn=TFIn::New(IdFNm+&quot;.test.pred&quot;);
1406    TILx PredLx(PredSIn, TFSet()|iloRetEoln|iloSigNum);
1407    PredLx.GetSym(syLn);
1408    double PredClassVal=PredLx.GetFlt();
1409    TFile::Del(IdFNm+&quot;.train.svm&quot;, false);
1410    TFile::Del(IdFNm+&quot;.test&quot;, false);
1411    TFile::Del(IdFNm+&quot;.param&quot;, false);
1412    TFile::Del(IdFNm+&quot;.test.pred&quot;, false);
1413    return PredClassVal;
1414  }
1415  void TGasMdSvm::Print() const {
1416    printf(&quot;==========================================================\n&quot;);
1417    printf(&quot;ClassVal: %s\n&quot;, ClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1418  }
1419  PGasRegNd TGasRegNd::New(const int&amp; MnLeafExs,
1420   const TVec&lt;TFltV&gt;&amp; AttrValVV, const TFltV&amp; ClassValV, const TIntV&amp; ExNV){
1421    IAssert(ExNV.Len()&gt;0);
1422    PGasRegNd RegNd=PGasRegNd(new TGasRegNd());
1423    RegNd-&gt;ClassValMom=TMom::New();
1424    for (int ExNN=0; ExNN&lt;ExNV.Len(); ExNN++){
1425      RegNd-&gt;ClassValMom-&gt;Add(ClassValV[ExNV[ExNN]]);}
1426    RegNd-&gt;ClassValMom-&gt;Def();
1427    if (ExNV.Len()&lt;MnLeafExs){
1428      return RegNd;}
1429    int MnSubRegNdExs=TInt::GetMx(ExNV.Len()/10, MnLeafExs);
1430    double BestSplitQual=-1;
1431    int BestSplitAttrN=-1; double BestSplitAttrVal=0;
1432    TIntV BestLExNV; TIntV BestRExNV;
1433    int Attrs=AttrValVV[0].Len();
1434    for (int SplitAttrN=0; SplitAttrN&lt;Attrs; SplitAttrN++){
1435      TFltV SplitValV; PMom SplitValMom=TMom::New();
1436      for (int ExNN=0; ExNN&lt;ExNV.Len(); ExNN++){
1437        double AttrVal=AttrValVV[ExNV[ExNN]][SplitAttrN];
1438        SplitValV.Add(AttrVal); SplitValMom-&gt;Add(AttrVal);
1439      }
1440      SplitValV.Sort(); SplitValMom-&gt;Def();
1441      double MnSplitValResol=
1442       (SplitValMom-&gt;GetQuart3()-SplitValMom-&gt;GetQuart1())/100;
1443      double PrevSplitVal;
1444      for (int SplitValN=1; SplitValN&lt;SplitValV.Len()-1; SplitValN++){
1445        double SplitVal=SplitValV[SplitValN];
1446        if ((SplitValN&gt;1)&amp;&amp;(SplitVal-PrevSplitVal&lt;=MnSplitValResol)){continue;}
1447        PrevSplitVal=SplitVal;
1448        PMom LClassValMom=TMom::New(); TIntV LExNV;
1449        PMom RClassValMom=TMom::New(); TIntV RExNV;
1450        for (int ExNN=0; ExNN&lt;ExNV.Len(); ExNN++){
1451          int ExN=ExNV[ExNN];
1452          double AttrVal=AttrValVV[ExN][SplitAttrN];
1453          if (AttrVal&lt;SplitVal){
1454            LClassValMom-&gt;Add(ClassValV[ExN]); LExNV.Add(ExN);
1455          } else {
1456            RClassValMom-&gt;Add(ClassValV[ExN]); RExNV.Add(ExN);
1457          }
1458        }
1459        LClassValMom-&gt;Def(); RClassValMom-&gt;Def();
1460        if ((LClassValMom-&gt;IsUsable()&amp;&amp;RClassValMom-&gt;IsUsable())&amp;&amp;
1461         (LExNV.Len()&gt;MnSubRegNdExs)&amp;&amp;(RExNV.Len()&gt;MnSubRegNdExs)){
1462          double SplitQual=
1463           TMath::Sqr(LClassValMom-&gt;GetSDev()*LExNV.Len())+
1464           TMath::Sqr(RClassValMom-&gt;GetSDev()*RExNV.Len());
1465          if ((BestSplitQual==-1)||(SplitQual&lt;BestSplitQual)){
1466            BestSplitQual=SplitQual;
1467            BestSplitAttrN=SplitAttrN; BestSplitAttrVal=SplitVal;
1468            BestLExNV=LExNV; BestRExNV=RExNV;
1469          }
1470        }
1471      }
1472    }
1473    if (BestSplitQual!=-1){
1474      RegNd-&gt;SplitQual=BestSplitQual;
1475      RegNd-&gt;SplitAttrN=BestSplitAttrN;
1476      RegNd-&gt;SplitAttrVal=BestSplitAttrVal;
1477      if ((BestLExNV.Len()&gt;0)&amp;&amp;(BestRExNV.Len()&gt;0)){
1478        RegNd-&gt;LRegNd=TGasRegNd::New(MnLeafExs, AttrValVV, ClassValV, BestLExNV);
1479        RegNd-&gt;RRegNd=TGasRegNd::New(MnLeafExs, AttrValVV, ClassValV, BestRExNV);
1480      }
1481    }
1482    printf(&quot;.&quot;);
1483    return RegNd;
1484  }
1485  double TGasRegNd::GetPredClassVal(const TFltV&amp; AttrValV) const {
1486    if (IsLeaf()){
1487      return ClassValMom-&gt;GetMedian();
1488    } else {
1489      if (AttrValV[SplitAttrN]&lt;SplitAttrVal){
1490        return LRegNd-&gt;GetPredClassVal(AttrValV);
1491      } else {
1492        return RRegNd-&gt;GetPredClassVal(AttrValV);
1493      }
1494    }
1495  }
1496  void TGasRegNd::Print(const PGasDmHd&amp; GasDmHd, const int&amp; Levs) const {
1497    if (IsLeaf()){
1498      for (int LevN=0; LevN&lt;Levs; LevN++){printf(&quot;   &quot;);}
1499      printf(&quot;%s=%g(%g) [%d Exs.]\n&quot;,
1500       GasDmHd-&gt;GetClassNm().CStr(),
1501       ClassValMom-&gt;GetMean(), ClassValMom-&gt;GetSDev(), ClassValMom-&gt;GetVals());
1502    } else {
1503      for (int LevN=0; LevN&lt;Levs; LevN++){printf(&quot;   &quot;);}
1504      printf(&quot;%s &lt;  %g [%s=%g(%g)] [%d Exs.]\n&quot;,
1505       GasDmHd-&gt;GetAttrNm(SplitAttrN).CStr(), SplitAttrVal,
1506       GasDmHd-&gt;GetClassNm().CStr(),
1507       ClassValMom-&gt;GetMean(), ClassValMom-&gt;GetSDev(), ClassValMom-&gt;GetVals());
1508      LRegNd-&gt;Print(GasDmHd, Levs+1);
1509      {for (int LevN=0; LevN&lt;Levs; LevN++){printf(&quot;   &quot;);}}
1510      printf(&quot;%s &gt;= %g [%s=%g(%g)] [%d Exs.]\n&quot;,
1511       GasDmHd-&gt;GetAttrNm(SplitAttrN).CStr(), SplitAttrVal,
1512       GasDmHd-&gt;GetClassNm().CStr(),
1513       ClassValMom-&gt;GetMean(), ClassValMom-&gt;GetSDev(), ClassValMom-&gt;GetVals());
1514      RRegNd-&gt;Print(GasDmHd, Levs+1);
1515    }
1516  }
1517  PGasMd TGasMdRegTree::New(const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
1518   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
1519   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
1520    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
1521    TGasMdRegTree* GasMdRegTree=new TGasMdRegTree(GasDmHd); PGasMd GasMd(GasMdRegTree);
1522    PSIn ParamXmlSIn=TStrIn::New(ParamStr);
1523    PXmlDoc ParamXmlDoc=TXmlDoc::LoadTxt(ParamXmlSIn);
1524    int MnLeafExs=ParamXmlDoc-&gt;GetTagTokStr(&quot;Model|RegTree|MnLeafExs&quot;).GetInt();
1525    TIntV RecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, StartRecN, EndRecN, MnCspt, RecNV);
1526     int Recs=RecNV.Len();
1527    TVec&lt;TFltV&gt; AttrValVV(Recs);
1528    TFltV ClassValV(Recs); GasMdRegTree-&gt;ClassValMom=TMom::New();
1529    for (int RecNN=0; RecNN&lt;Recs; RecNN++){
1530      int RecN=RecNV[RecNN];
1531      TFltV&amp; AttrValV=AttrValVV[RecNN];
1532      GasDm-&gt;GetAttrValV(RecN, AttrValV);
1533      double ClassVal=GasDm-&gt;GetClassVal(RecN);
1534      ClassValV[RecNN]=ClassVal;
1535      GasMdRegTree-&gt;ClassValMom-&gt;Add(ClassVal);
1536    }
1537    GasMdRegTree-&gt;ClassValMom-&gt;Def();
1538    int AllExs=AttrValVV.Len();
1539    TIntV AllExNV(AllExs); for (int ExN=0; ExN&lt;AllExs; ExN++){AllExNV[ExN]=ExN;}
1540    GasMdRegTree-&gt;RegNd=TGasRegNd::New(MnLeafExs, AttrValVV, ClassValV, AllExNV);
1541    return GasMd;
1542  }
1543  double TGasMdRegTree::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1544    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1545    TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1546    double PredClassVal=RegNd-&gt;GetPredClassVal(AttrValV);
1547    return PredClassVal;
1548  }
1549  void TGasMdRegTree::Print() const {
1550    printf(&quot;==========================================================\n&quot;);
1551    printf(&quot;ClassVal: %s\n&quot;, ClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1552    RegNd-&gt;Print(GasDmHd);
1553  }
1554  TGasMdCor::TGasMdCor(const TStr&amp; LtpFPath):
1555    DateProdNmToCorFactMomH(){
1556    TFFile FFile(LtpFPath, &quot;.Ltp&quot;, false); TStr FNm;
1557    while (FFile.Next(FNm)){
1558      printf(&quot;.&quot;);
1559      PGasLtpBs GasLtpBs=TGasLtpBs::Load(FNm);
1560      TStr ProdNm=GasLtpBs-&gt;ProdNm;
1561      PGasDm GasDm=TGasDm::GetDayGasDm(GasLtpBs);
1562      TSecTm MnDate=GasLtpBs-&gt;GetMnDate();
1563      TSecTm MxDate=GasLtpBs-&gt;GetMxDate();
1564      PGasMd GasMd=TGasMd::New(
1565       gmtCTb, NULL, TGasMd::GetMdParamStr(), GasDm, MnDate, MxDate, -1, -1, 100);
1566      for (int RecN=0; RecN&lt;GasDm-&gt;GetRecs(); RecN++){
1567        double Cspt=GasDm-&gt;GetClassVal(RecN);
1568        double PredCspt=GasMd-&gt;GetPredClassVal(GasDm, RecN);
1569        if (PredCspt==0){continue;}
1570        double CorFact=Cspt/PredCspt;
1571        TSecTm Date=GasDm-&gt;GetDateVal(RecN);
1572        TDateProdNmPr DateProdNmPr(Date, ProdNm);
1573        if (!DateProdNmToCorFactMomH.IsKey(DateProdNmPr)){
1574          DateProdNmToCorFactMomH.AddDat(DateProdNmPr, TMom::New());}
1575        DateProdNmToCorFactMomH.GetDat(DateProdNmPr)-&gt;Add(CorFact);
1576      }
1577    }
1578    for (int DateProdNmP=0; DateProdNmP&lt;DateProdNmToCorFactMomH.Len(); DateProdNmP++){
1579      DateProdNmToCorFactMomH[DateProdNmP]-&gt;Def();}
1580  }
1581  double TGasMdCor::GetCorFact(const TSecTm&amp; Date, const TStr&amp; ProdNm) const {
1582    TDateProdNmPr DateProdNmPr(Date, ProdNm);
1583    int DateProdNmP;
1584    if (DateProdNmToCorFactMomH.IsKey(DateProdNmPr, DateProdNmP)){
1585      PMom CorFactMom=DateProdNmToCorFactMomH[DateProdNmP];
1586      if (CorFactMom-&gt;IsUsable()){
1587        return CorFactMom-&gt;GetMean();
1588      } else {
1589        return 1;
1590      }
1591    } else {
1592      return 1;
1593    }
1594  }
1595  void TGasMdCor::SaveTxt(const TStr&amp; FNm) const {
1596    typedef TTriple&lt;TSecTm, TStr, TInt&gt; TDateProdNmIdTr;
1597    TVec&lt;TDateProdNmIdTr&gt; DateProdNmIdTrV;
1598    for (int DateProdNmP=0; DateProdNmP&lt;DateProdNmToCorFactMomH.Len(); DateProdNmP++){
1599      TSecTm Date=DateProdNmToCorFactMomH.GetKey(DateProdNmP).Val1;
1600      TStr ProdNm=DateProdNmToCorFactMomH.GetKey(DateProdNmP).Val2;
1601      TDateProdNmIdTr DateProdNmIdTr(Date, ProdNm, DateProdNmP);
1602      DateProdNmIdTrV.Add(DateProdNmIdTr);
1603    }
1604    DateProdNmIdTrV.Sort();
1605    TFOut LogFOut(FNm); FILE* fLog=LogFOut.GetFileId();
1606    for (int DpiN=0; DpiN&lt;DateProdNmIdTrV.Len(); DpiN++){
1607      TSecTm Date=DateProdNmIdTrV[DpiN].Val1;
1608      TStr ProdNm=DateProdNmIdTrV[DpiN].Val2;
1609      int DateProdNmP=DateProdNmIdTrV[DpiN].Val3;
1610      PMom CorFactMom=DateProdNmToCorFactMomH[DateProdNmP];
1611      fprintf(fLog, &quot;%s - %-25s - %s\n&quot;,
1612       Date.GetDtStr().CStr(), ProdNm.CStr(),
1613       CorFactMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1614    }
1615  }
1616  double TGasOrder::GetQuantity(const TSecTm&amp; Dt, TGasOrderV&amp; GasOrderV){
1617    double Quantity=0;
1618    for (int GasOrderN=0; GasOrderN&lt;GasOrderV.Len(); GasOrderN++){
1619      if (GasOrderV[GasOrderN]-&gt;ReceiveDt==Dt){
1620        Quantity+=GasOrderV[GasOrderN]-&gt;Quantity;}
1621    }
1622    return Quantity;
1623  }
1624  double TGasOrder::GetQuantity(
1625   const TSecTm&amp; MnTm, const TSecTm&amp; MxTm, TGasOrderV&amp; GasOrderV){
1626    double Quantity=0;
1627    for (int GasOrderN=0; GasOrderN&lt;GasOrderV.Len(); GasOrderN++){
1628      TSecTm ReceiveDt=GasOrderV[GasOrderN]-&gt;ReceiveDt;
1629      if ((MnTm&lt;=ReceiveDt)&amp;&amp;(ReceiveDt&lt;MxTm)){
1630        Quantity+=GasOrderV[GasOrderN]-&gt;Quantity;}
1631    }
1632    return Quantity;
1633  }
1634  void TGasOrder::DelOrders(const TSecTm&amp; Dt, TGasOrderV&amp; GasOrderV){
1635    PGasOrder GasOrder=TGasOrder::New(Dt, Dt, 0, false);
1636    GasOrderV.DelAll(GasOrder);
1637  }
1638  void TGasOrder::DelOrders(
1639   const TSecTm&amp; MnTm, const TSecTm&amp; MxTm, TGasOrderV&amp; GasOrderV){
1640    for (int GasOrderN=GasOrderV.Len()-1; GasOrderN&gt;=0; GasOrderN--){
1641      TSecTm ReceiveDt=GasOrderV[GasOrderN]-&gt;ReceiveDt;
1642      if ((MnTm&lt;=ReceiveDt)&amp;&amp;(ReceiveDt&lt;MxTm)){
1643        GasOrderV.Del(GasOrderN);
1644      }
1645    }
1646  }
1647  void TGasOrder::DelUnapprovedOrders(
1648   const TSecTm&amp; MnTm, TGasOrderV&amp; GasOrderV, TStrV&amp; MsgStrV){
1649    MsgStrV.Clr();
1650    for (int GasOrderN=GasOrderV.Len()-1; GasOrderN&gt;=0; GasOrderN--){
1651      if (!GasOrderV[GasOrderN]-&gt;ApprovedP){
1652        TSecTm ReceiveDt=GasOrderV[GasOrderN]-&gt;ReceiveDt;
1653        if (MnTm&lt;=ReceiveDt){
1654          MsgStrV.Add(GasOrderV[GasOrderN]-&gt;GetStr());
1655          GasOrderV.Del(GasOrderN);
1656        }
1657      }
1658    }
1659  }
1660  PGasOrder TGasOrder::LoadXml(const PXmlTok&amp; XmlTok){
1661    TStr IssueDtStr=XmlTok-&gt;GetTagTokStr(&quot;IssueDate&quot;);
1662    TSecTm IssueDt=TSecTm::GetDtTmFromDmyStr(IssueDtStr);
1663    TStr ReceiveDtStr=XmlTok-&gt;GetTagTokStr(&quot;ReceiveDate&quot;);
1664    TSecTm ReceiveDt=TSecTm::GetDtTmFromDmyStr(ReceiveDtStr);
1665    TStr QuantityStr=XmlTok-&gt;GetTagTokStr(&quot;Quantity&quot;);
1666    double Quantity=QuantityStr.GetFlt(-1);
1667    PGasOrder GasOrder=TGasOrder::New(IssueDt, ReceiveDt, Quantity, true);
1668    return GasOrder;
1669  }
1670  void TGasOrder::SaveXml(const PSOut&amp; SOut, const TStr&amp; IndentStr) const {
1671    SOut-&gt;PutStr(IndentStr); SOut-&gt;PutStr(&quot;&lt;GasOrder&gt;\n&quot;);
1672    SOut-&gt;PutStr(IndentStr);
1673    SOut-&gt;PutStr(TStr::GetStr(IssueDt.GetDtMdyStr(), &quot;  &lt;IssueDate&gt;%s&lt;/IssueDate&gt;\n&quot;));
1674    SOut-&gt;PutStr(IndentStr);
1675    SOut-&gt;PutStr(TStr::GetStr(ReceiveDt.GetDtMdyStr(), &quot;  &lt;ReceiveDate&gt;%s&lt;/ReceiveDate&gt;\n&quot;));
1676    SOut-&gt;PutStr(IndentStr);
1677    SOut-&gt;PutStr(TFlt::GetStr(Quantity, &quot;  &lt;Quantity&gt;%g&lt;/Quantity&gt;\n&quot;));
1678    SOut-&gt;PutStr(IndentStr); SOut-&gt;PutStr(&quot;&lt;/GasOrder&gt;\n&quot;);
1679  }
1680  PGasStation TGasStation::LoadXml(const PXmlTok&amp; XmlTok){
1681    PGasStation GasStation=TGasStation::New();
1682    GasStation-&gt;DescStr=XmlTok-&gt;GetTagTokStr(&quot;Description&quot;);
1683    GasStation-&gt;ProdNm=XmlTok-&gt;GetTagTokStr(&quot;Product&quot;);
1684    GasStation-&gt;FullVolumeVal=XmlTok-&gt;GetTagTokStr(&quot;FullVolume&quot;).GetFlt(-1);
1685    GasStation-&gt;SafetyVolumeVal=XmlTok-&gt;GetTagTokStr(&quot;SafetyVolume&quot;).GetFlt(-1);
1686    GasStation-&gt;DeliveryDays=XmlTok-&gt;GetTagTokStr(&quot;DeliveryDays&quot;).GetFlt(-1);
1687    GasStation-&gt;StockDurationDays=XmlTok-&gt;GetTagTokStr(&quot;StockDurationDays&quot;).GetFlt(-1);
1688    GasStation-&gt;OrderQuantityCorFact=XmlTok-&gt;GetTagTokStr(&quot;OrderQuantityCorrection&quot;).GetFlt(-1);
1689    GasStation-&gt;ExceptPredCorFact=XmlTok-&gt;GetTagTokStr(&quot;ExceptionPredictionCorrection&quot;).GetFlt(-1);
1690    GasStation-&gt;HistWnDays=XmlTok-&gt;GetTagTokStr(&quot;HistoryWindowDays&quot;).GetFlt(-1);
1691    GasStation-&gt;TmGridHours=XmlTok-&gt;GetTagTokStr(&quot;TimeGridHours&quot;).GetFlt(-1);
1692    GasStation-&gt;VolumeVal=XmlTok-&gt;GetTagTokStr(&quot;Volume&quot;).GetFlt(-1);
1693    TXmlTokV GasOrderXmlTokV;
1694    XmlTok-&gt;GetTagTokV(&quot;GasOrderList|GasOrder&quot;, GasOrderXmlTokV);
1695    GasStation-&gt;GasOrderV.Clr();
1696    for (int GasOrderN=0; GasOrderN&lt;GasOrderXmlTokV.Len(); GasOrderN++){
1697      PGasOrder GasOrder=TGasOrder::LoadXml(GasOrderXmlTokV[GasOrderN]);
1698      GasStation-&gt;GasOrderV.Add(GasOrder);
1699    }
1700    return GasStation;
1701  }
1702  PGasStation TGasStation::LoadXml(const TStr&amp; FNm){
1703    PSIn SIn=TFIn::New(FNm);
1704    PXmlDoc XmlDoc=TXmlDoc::LoadTxt(SIn);
1705    if (!XmlDoc-&gt;IsOk()){
1706      TExcept::Throw(&quot;Invalid Xml File&quot;, SIn-&gt;GetSNm());}
1707    return LoadXml(XmlDoc-&gt;GetTok());
1708  }
1709  void TGasStation::SaveXml(const PSOut&amp; SOut) const {
1710    SOut-&gt;PutStr(&quot;&lt;GasStation&gt;\n&quot;);
1711    SOut-&gt;PutStr(TStr::GetStr(DescStr, &quot;  &lt;Description&gt;%s&lt;/Description&gt;\n&quot;));
1712    SOut-&gt;PutStr(TStr::GetStr(ProdNm, &quot;  &lt;Product&gt;%s&lt;/Product&gt;\n&quot;));
1713    SOut-&gt;PutStr(TFlt::GetStr(FullVolumeVal, &quot;  &lt;FullVolume&gt;%g&lt;/FullVolume&gt;\n&quot;));
1714    SOut-&gt;PutStr(TFlt::GetStr(SafetyVolumeVal, &quot;  &lt;SafetyVolume&gt;%g&lt;/SafetyVolume&gt;\n&quot;));
1715    SOut-&gt;PutStr(TInt::GetStr(DeliveryDays, &quot;  &lt;DeliveryDays&gt;%d&lt;/DeliveryDays&gt;\n&quot;));
1716    SOut-&gt;PutStr(TInt::GetStr(StockDurationDays, &quot;  &lt;StockDurationDays&gt;%d&lt;/StockDurationDays&gt;\n&quot;));
1717    SOut-&gt;PutStr(TFlt::GetStr(OrderQuantityCorFact, &quot;  &lt;OrderQuantityCorrection&gt;%g&lt;/OrderQuantityCorrection&gt;\n&quot;));
1718    SOut-&gt;PutStr(TFlt::GetStr(ExceptPredCorFact, &quot;  &lt;ExceptionPredictionCorrection&gt;%g&lt;/ExceptionPredictionCorrection&gt;\n&quot;));
1719    SOut-&gt;PutStr(TInt::GetStr(HistWnDays, &quot;  &lt;HistoryWindowDays&gt;%d&lt;/HistoryWindowDays&gt;\n&quot;));
1720    SOut-&gt;PutStr(TInt::GetStr(TmGridHours, &quot;  &lt;TimeGridHours&gt;%d&lt;/TimeGridHours&gt;\n&quot;));
1721    SOut-&gt;PutStr(TFlt::GetStr(VolumeVal, &quot;  &lt;Volume&gt;%g&lt;/Volume&gt;\n&quot;));
1722    SOut-&gt;PutStr(&quot;  &lt;NewGasOrderList&gt;\n&quot;);
1723    for (int GasOrderN=0; GasOrderN&lt;NewGasOrderV.Len(); GasOrderN++){
1724      NewGasOrderV[GasOrderN]-&gt;SaveXml(SOut, &quot;    &quot;);
1725    }
1726    SOut-&gt;PutStr(&quot;  &lt;/NewGasOrderList&gt;\n&quot;);
1727    SOut-&gt;PutStr(&quot;&lt;/GasStation&gt;\n&quot;);
1728  }
1729  void TGasStation::DumpDef(FILE* fOut) const {
1730    fprintf(fOut, &quot;===GasStation-Start========\n&quot;);
1731    fprintf(fOut, &quot;DescStr: %s\n&quot;, DescStr.CStr());
1732    fprintf(fOut, &quot;ProdStr: %s\n&quot;, ProdNm.CStr());
1733    fprintf(fOut, &quot;FullVolumeVal: %g\n&quot;, FullVolumeVal);
1734    fprintf(fOut, &quot;SafetyVolumeVal: %g\n&quot;, SafetyVolumeVal);
1735    fprintf(fOut, &quot;DeliveryDays: %d\n&quot;, DeliveryDays);
1736    fprintf(fOut, &quot;StockDurationDays: %d\n&quot;, StockDurationDays);
1737    fprintf(fOut, &quot;OrderQuantityCorFact: %g\n&quot;, OrderQuantityCorFact);
1738    fprintf(fOut, &quot;ExceptPredCorFact: %g\n&quot;, ExceptPredCorFact);
1739    fprintf(fOut, &quot;HistWnDays: %d\n&quot;, HistWnDays);
1740    fprintf(fOut, &quot;TmGridHours: %d\n&quot;, TmGridHours);
1741    fprintf(fOut, &quot;VolumeVal: %d\n&quot;, VolumeVal);
1742    fprintf(fOut, &quot;GasOrderV: (%d)\n&quot;, GasOrderV.Len());
1743    for (int GasOrderN=0; GasOrderN&lt;GasOrderV.Len(); GasOrderN++){
1744      fprintf(fOut, &quot;  %s\n&quot;, GasOrderV[GasOrderN]-&gt;GetStr().CStr());}
1745    fprintf(fOut, &quot;NewGasOrderV: (%d)\n&quot;, NewGasOrderV.Len());
1746    {for (int GasOrderN=0; GasOrderN&lt;NewGasOrderV.Len(); GasOrderN++){
1747      fprintf(fOut, &quot;  %s\n&quot;, NewGasOrderV[GasOrderN]-&gt;GetStr().CStr());}}
1748    fprintf(fOut, &quot;===GasStation-End==========\n&quot;);
1749  }
1750  void TGasExe::GenPredEval(
1751   const PGasMdMType&amp; GasMdMType, const TStr&amp; GasMdParamStr,
1752   const PGasMdCor&amp; GasMdCor, const bool&amp; UseMdCorP,
1753   const PGasDm&amp; GasDm,
1754   const TSecTm&amp; MnDate, const TSecTm&amp; MxDate,
1755   const int&amp; TrainWnLen, const int&amp; TestWnLen, const int&amp; WnStepLen,
1756   const double&amp; MnCspt, const double&amp; MnOutlierRelErr,
1757   const TStr&amp; LogFNm, const int&amp; LogVerbLev, const bool&amp; AppendToLog,
1758   const TStr&amp; TabLogFNm, const bool&amp; AppendToTabLog,
1759   FILE* fOlap, const TStr&amp; OlapPfxLn,
1760   TGasPredV&amp; GasPredV,
1761   PMom&amp; AllPredAbsErrMom, PMom&amp; AllPredRelErrMom,
1762   const bool&amp; PrintToScrP){
1763    TFOut LogFOut(LogFNm, AppendToLog); FILE* fLog=LogFOut.GetFileId();
1764    TFOut TabLogFOut(TabLogFNm, AppendToTabLog); FILE* fTabLog=TabLogFOut.GetFileId();
1765    TSecTm EvalStampTm=TSecTm::GetCurTm();
1766    fprintf(fLog, &quot;===Start-Evaluation======================\n&quot;);
1767    fprintf(fLog, &quot;Evaluation (%s)\n&quot;, EvalStampTm.GetStr().CStr());
1768    if (GasMdMType-&gt;GetMdTypes()==1){
1769      TGasMdType GasMdType=GasMdMType-&gt;GetMdType(0);
1770      fprintf(fLog, &quot;Training algorithm &#x27;%s&#x27;\n&quot;, TGasMd::GetGasMdTypeNm(GasMdType).CStr());
1771    } else {
1772      for (int MdTypeN=0; MdTypeN&lt;GasMdMType-&gt;GetMdTypes(); MdTypeN++){
1773        TGasMdType GasMdType=GasMdMType-&gt;GetMdType(MdTypeN);
1774        double GasMdWgt=GasMdMType-&gt;GetMdWgt(MdTypeN);
1775        fprintf(fLog, &quot;Training algorithm &#x27;%s&#x27;(%g)\n&quot;, TGasMd::GetGasMdTypeNm(GasMdType).CStr(), GasMdWgt);
1776      }
1777    }
1778    fprintf(fLog, &quot;Location/Tank/Product: %s\n&quot;, GasDm-&gt;GetDescStr().CStr());
1779    fprintf(fLog, &quot;Min. Date: %s   Max. Date: %s\n&quot;, MnDate.GetDtStr().CStr(), MxDate.GetDtStr().CStr());
1780    fprintf(fLog, &quot;Train Window: %d   Test Window: %d   Window Step: %d\n&quot;, TrainWnLen, TestWnLen, WnStepLen);
1781    fprintf(fLog, &quot;Min. Consumption: %g\n&quot;, MnCspt);
1782    if (LogVerbLev&gt;0){
1783      fprintf(fLog, &quot;=========================================\n&quot;);}
1784    GasPredV.Clr();
1785    AllPredAbsErrMom=TMom::New();
1786    AllPredRelErrMom=TMom::New();
1787    TStrV OutlierStrV;
1788    for (TSecTm Date=MnDate; Date&lt;MxDate; Date.AddDays(WnStepLen)){
1789      TSecTm StartDate=Date;
1790      TSecTm EndDate=TSecTm(Date).AddDays(TrainWnLen);
1791      TSecTm StartPredDate=TSecTm(Date).AddDays(TrainWnLen+1);
1792      TSecTm EndPredDate=TSecTm(Date).AddDays(TrainWnLen+1+TestWnLen-1);
1793      if (EndPredDate&gt;=MxDate){continue;}
1794      TIntV TrainRecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, -1, -1, MnCspt, TrainRecNV);
1795      int TrainRecs=TrainRecNV.Len();
1796      if (LogVerbLev&gt;0){
1797        fprintf(fLog, &quot;---Start-Window--------------------------\n&quot;);
1798        fprintf(fLog, &quot;Training From %s   To %s (%d records)\n&quot;,
1799         StartDate.GetDtStr().CStr(), EndDate.GetDtStr().CStr(), TrainRecs);
1800        fprintf(fLog, &quot;Testing  From %s   To %s\n&quot;,
1801         StartPredDate.GetDtStr().CStr(), EndPredDate.GetDtStr().CStr());
1802      }
1803      if (double(TrainRecs)&lt;double(TrainWnLen)*0.5){continue;}
1804      PGasMd GasMd=TGasMd::New(gmtEnsemble, GasMdMType, GasMdParamStr, GasDm, StartDate, EndDate, -1, -1, MnCspt);
1805      if (PrintToScrP){GasMd-&gt;Print();}
1806      if (LogVerbLev&gt;1){
1807        fprintf(fLog, &quot;.........................................\n&quot;);}
1808      PMom PredAbsErrMom=TMom::New();
1809      PMom PredRelErrMom=TMom::New();
1810      PMom TestClassValMom=TMom::New();
1811      TIntV PredRecNV;
1812      GasDm-&gt;GetRecNV(StartPredDate, EndPredDate, -1, -1, MnCspt, PredRecNV);
1813      for (int PredRecNN=0; PredRecNN&lt;PredRecNV.Len(); PredRecNN++){
1814        int RecN=PredRecNV[PredRecNN];
1815        TSecTm Date=GasDm-&gt;GetDateVal(RecN);
1816        TStr DateStr=Date.GetDtStr();
1817        int HourN=GasDm-&gt;GetAttrVal(RecN, &quot;Hour&quot;, -1);
1818        double ClassVal=GasDm-&gt;GetClassVal(RecN);
1819        double PredClassVal=GasMd-&gt;GetCorPredClassVal(GasDm, RecN, 1.5);
1820        if (UseMdCorP){
1821          double CorFact=GasMdCor-&gt;GetCorFact(Date, GasDm-&gt;GetProdNm());
1822          PredClassVal=CorFact*PredClassVal;
1823        }
1824        double RawPredAbsErr=ClassVal-PredClassVal;
1825        double PredAbsErr=fabs(ClassVal-PredClassVal);
1826        double PredRelErr=0; double RawPredRelErr=0;
1827        if (ClassVal!=0){
1828          RawPredRelErr=(ClassVal-PredClassVal)/ClassVal;
1829          PredRelErr=fabs(RawPredRelErr);
1830        }
1831        PredAbsErrMom-&gt;Add(PredAbsErr); AllPredAbsErrMom-&gt;Add(PredAbsErr);
1832        PredRelErrMom-&gt;Add(PredRelErr); AllPredRelErrMom-&gt;Add(PredRelErr);
1833        TestClassValMom-&gt;Add(ClassVal);
1834        PGasPred GasPred=TGasPred::New();
1835        GasPred-&gt;CorrVal=ClassVal;
1836        GasPred-&gt;PredVal=PredClassVal;
1837        GasPred-&gt;AbsErr=RawPredAbsErr;
1838        GasPred-&gt;RelErr=RawPredRelErr;
1839        GasPred-&gt;Tm=GasDm-&gt;GetDateVal(RecN);
1840        GasPred-&gt;OutlierP=(PredRelErr&gt;MnOutlierRelErr);
1841        GasPred-&gt;DescStr=GasDm-&gt;GetBitsStr(RecN);
1842        GasPredV.Add(GasPred);
1843        if (LogVerbLev&gt;1){
1844          fprintf(fLog,
1845           &quot;Correct: %g   Predicted: %g   Abs-Error: %g   Rel-Error: %g   Date: %s   Hour: %d&quot;,
1846           ClassVal, PredClassVal, RawPredAbsErr, PredRelErr, DateStr.CStr(), HourN);
1847          fprintf(fLog, &quot;   Desc: {%s}&quot;, GasDm-&gt;GetBitsStr(RecN).CStr());
1848          if (PredRelErr&gt;MnOutlierRelErr){fprintf(fLog, &quot;   Outlier&quot;);}
1849          fprintf(fLog, &quot;\n&quot;);
1850        }
1851        if (fOlap!=NULL){
1852          fprintf(fOlap, &quot;%s%s\t%s\t%s\t%s\t%s\t%s\t%s\n&quot;,
1853           OlapPfxLn.CStr(),
1854           Date.GetDtMdyStr().CStr(),
1855           TTmInfo::GetMonthNm(Date.GetMonthN()).CStr(),
1856           TTmInfo::GetDayOfWeekNm(Date.GetDayOfWeekN()).CStr(),
1857           TFlt::GetStr(ClassVal).CStr(),
1858           TFlt::GetStr(PredClassVal).CStr(),
1859           TFlt::GetStr(RawPredAbsErr).CStr(),
1860           TFlt::GetStr(PredRelErr).CStr());
1861        }
1862      }
1863      PredAbsErrMom-&gt;Def();
1864      PredRelErrMom-&gt;Def();
1865      TestClassValMom-&gt;Def();
1866      if (LogVerbLev&gt;1){
1867        fprintf(fLog, &quot;.........................................\n&quot;);}
1868      if (LogVerbLev&gt;0){
1869        fprintf(fLog, &quot;Train Class Stat.: %s\n&quot;, GasMd-&gt;GetClassValMom()-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1870        fprintf(fLog, &quot;Test Class Stat.: %s\n&quot;, TestClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1871        fprintf(fLog, &quot;.........................................\n&quot;);
1872        fprintf(fLog, &quot;Abs-Error: %s\n&quot;, PredAbsErrMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1873        fprintf(fLog, &quot;Rel-Error: %s\n&quot;, PredRelErrMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1874        fprintf(fLog, &quot;---End-Window----------------------------\n&quot;);
1875      }
1876      if (PrintToScrP){
1877        printf(&quot;PredAbsErr: %s\n&quot;, PredAbsErrMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1878        printf(&quot;PredRelErr: %s\n&quot;, PredRelErrMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1879        printf(&quot;Model for: %s - %s ; Predict for: %s - %s\n&quot;,
1880         StartDate.GetDtStr().CStr(), EndDate.GetDtStr().CStr(),
1881         StartPredDate.GetDtStr().CStr(), EndPredDate.GetDtStr().CStr());
1882      }
1883    }
1884    AllPredAbsErrMom-&gt;Def();
1885    AllPredRelErrMom-&gt;Def();
1886    if (LogVerbLev&gt;0){
1887      fprintf(fLog, &quot;=========================================\n&quot;);}
1888    fprintf(fLog, &quot;Abs-Error: %s\n&quot;, AllPredAbsErrMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1889    fprintf(fLog, &quot;Rel-Error: %s\n&quot;, AllPredRelErrMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1890    fprintf(fLog, &quot;Evaluation (%s)\n&quot;, EvalStampTm.GetStr().CStr());
1891    fprintf(fLog, &quot;===End-Evaluation========================\n&quot;);
1892    fprintf(fTabLog, &quot;%s\t&quot;, GasDm-&gt;GetLtpNm().CStr());
1893    fprintf(fTabLog, &quot;%s\t&quot;, GasDm-&gt;GetLocNm().CStr());
1894    fprintf(fTabLog, &quot;%s\t&quot;, GasDm-&gt;GetProdNm().CStr());
1895    fprintf(fTabLog, &quot;%s\t&quot;, GasDm-&gt;GetTypeNm().CStr());
1896    fprintf(fTabLog, &quot;%d\t&quot;, TrainWnLen);
1897    fprintf(fTabLog, &quot;%d\t&quot;, TestWnLen);
1898    fprintf(fTabLog, &quot;%s\t&quot;, GasMdMType-&gt;GetDescStr().CStr());
1899    fprintf(fTabLog, &quot;%s\t&quot;, AllPredAbsErrMom-&gt;TMom::GetValVStr().CStr());
1900    fprintf(fTabLog, &quot;%s\n&quot;, AllPredRelErrMom-&gt;TMom::GetValVStr().CStr());
1901  }
1902  void TGasExe::GenDayOrder(
1903   const TStr&amp; LogFNm,
1904   const PGasStation&amp; GasStation, const TStr&amp; OutGasStationFNm,
1905   const TSecTm&amp; StartDt, const int&amp; ProcessDays,
1906   const PGasDm&amp; GasDm,
1907   const PGasMdMType&amp; GasMdMType, const TStr&amp; GasMdParamStr,
1908   TGasSimRecV&amp; GasSimRecV){
1909    PMom TodayPredVolMom=TMom::New();
1910    PMom TodayRealVolMom=TMom::New();
1911    int UnderSafetyLevWarns=0;
1912    int ReschOrdDtWarns=0;
1913    TFOut LogSOut(LogFNm); FILE* fLog=LogSOut.GetFileId();
1914    GasStation-&gt;DumpDef(fLog);
1915    if (!StartDt.IsDef()){
1916      TExcept::Throw(&quot;Invalid start date.&quot;);}
1917    int FirstRecN=0;
1918    while (FirstRecN&lt;GasDm-&gt;GetRecs()){
1919      TSecTm CurRecDt=GasDm-&gt;GetDateVal(FirstRecN);
1920      if (CurRecDt==StartDt){break;}
1921      FirstRecN++;
1922    }
1923    if (FirstRecN==GasDm-&gt;GetRecs()){
1924      TSecTm CurRecDt=GasDm-&gt;GetDateVal(GasDm-&gt;GetRecs()-1);
1925      CurRecDt.AddDays(1);
1926      if (CurRecDt!=StartDt){
1927        TExcept::Throw(&quot;Invalid start date.&quot;, StartDt.GetDtStr());}
1928    }
1929    GasSimRecV.Clr();
1930    for (int TodayRecN=FirstRecN; TodayRecN&lt;FirstRecN+ProcessDays-1; TodayRecN++){
1931      GasDm-&gt;AssureDayRec(TodayRecN);
1932      TSecTm TodayDt=GasDm-&gt;GetDateVal(TodayRecN);
1933      TStr TodayDtStr=TodayDt.GetDtStr();
1934      fprintf(fLog, &quot;Start day at record [%d] for date [%s]\n&quot;, TodayRecN, TodayDtStr.CStr());
1935      fprintf(fLog, &quot;\tDay-Info: [%s]\n&quot;, GasDm-&gt;GetBitsStr(TodayRecN).CStr());
1936      if (TodayRecN&gt;FirstRecN){
1937        TSecTm PrevDt=GasDm-&gt;GetDateVal(TodayRecN-1);
1938        EAssertRA(TodayDt==TSecTm(PrevDt).AddDays(1),
1939         &quot;Invalid time grid&quot;, TodayDtStr);
1940      }
1941      PGasSimRec GasSimRec=TGasSimRec::New(GasStation, TodayDtStr);
1942      int MnMdRecN=TodayRecN-GasStation-&gt;HistWnDays;
1943      int MxMdRecN=TodayRecN-1;
1944      PGasMd GasMd=TGasMd::New(
1945       gmtEnsemble, GasMdMType, GasMdParamStr,
1946       GasDm,
1947       GasDm-&gt;GetDateVal(MnMdRecN), GasDm-&gt;GetDateVal(MxMdRecN), -1, -1,
1948       100);
1949      fprintf(fLog, &quot;\tCreate Model for %d records (from %d to %d)\n&quot;,
1950       MxMdRecN-MnMdRecN+1, MnMdRecN, MxMdRecN);
1951      double OrderQuantity=TGasOrder::GetQuantity(TodayDt, GasStation-&gt;GasOrderV);
1952      fprintf(fLog, &quot;\tExecuted Orders for Quantity: %.0f\n&quot;, OrderQuantity);
1953      double TodayPredCspt=GasMd-&gt;GetPredClassVal(GasDm, TodayRecN);
1954      GasDm-&gt;PutCsptIfEmpty(TodayRecN, TodayPredCspt);
1955      fprintf(fLog, &quot;\tPredicted consumption: %.0f\n&quot;, TodayPredCspt);
1956      double TodayRealCspt=GasDm-&gt;GetClassVal(TodayRecN);
1957      fprintf(fLog, &quot;\tReal consumption: %.0f\n&quot;, TodayRealCspt);
1958      double TodayPredOpenVol=GasStation-&gt;VolumeVal+OrderQuantity;
1959      double TodayPredCloseVol=TodayPredOpenVol-TodayRealCspt;
1960      if ((TodayPredOpenVol!=-1)&amp;&amp;(TodayPredCloseVol!=-1)){
1961        TodayPredVolMom-&gt;Add((TodayPredOpenVol+TodayPredCloseVol)/2);}
1962      double TodayOpenRealVol=GasDm-&gt;GetVolVal(TodayRecN);
1963      double TodayCloseRealVol=-1;
1964      if (TodayRecN+1&lt;GasDm-&gt;GetRecs()){
1965        TodayCloseRealVol=GasDm-&gt;GetVolVal(TodayRecN+1);}
1966      if ((TodayOpenRealVol!=-1)&amp;&amp;(TodayCloseRealVol!=-1)){
1967        TodayRealVolMom-&gt;Add((TodayOpenRealVol+TodayCloseRealVol)/2);}
1968      double SimVolumeVal=GasStation-&gt;VolumeVal;
1969      int SimTodayRecN=TodayRecN;
1970      int SimDays=GasStation-&gt;StockDurationDays+GasStation-&gt;DeliveryDays;
1971      fprintf(fLog, &quot;\tSimulation to generate orders for %d (%d+%d) days.\n&quot;,
1972       SimDays, GasStation-&gt;StockDurationDays, GasStation-&gt;DeliveryDays);
1973      GasSimRec-&gt;PutReal(TodayPredOpenVol, TodayRealCspt, OrderQuantity);
1974      while (SimTodayRecN-TodayRecN&lt;SimDays){
1975        GasDm-&gt;AssureDayRec(SimTodayRecN);
1976        TSecTm SimTodayDt=GasDm-&gt;GetDateVal(SimTodayRecN);
1977        TStr SimTodayDtStr=SimTodayDt.GetDtStr();
1978        double SimOrderQuantity=
1979         TGasOrder::GetQuantity(SimTodayDt, GasStation-&gt;GasOrderV);
1980        double SimPredCspt=GasMd-&gt;GetCorPredClassVal(
1981         GasDm, SimTodayRecN, GasStation-&gt;ExceptPredCorFact);
1982        GasDm-&gt;PutCsptIfEmpty(SimTodayRecN, SimPredCspt);
1983        GasSimRec-&gt;AddSimStep(SimTodayDtStr,
1984         SimVolumeVal-SimPredCspt+SimOrderQuantity,
1985         SimVolumeVal, SimPredCspt, SimOrderQuantity);
1986        fprintf(fLog, &quot;\t\tSimVolume: %.0f = (v)%.0f - (c)%.0f + (o)%.0f (Date:%s) (Day:%d)\n&quot;,
1987         SimVolumeVal-SimPredCspt+SimOrderQuantity,
1988         SimVolumeVal, SimPredCspt, SimOrderQuantity,
1989         SimTodayDtStr.CStr(), SimTodayRecN-TodayRecN);
1990        if (SimVolumeVal-SimPredCspt+SimOrderQuantity&gt;=GasStation-&gt;SafetyVolumeVal){
1991          SimVolumeVal=SimVolumeVal+SimOrderQuantity-SimPredCspt;
1992          SimTodayRecN++;
1993        } else {
1994          fprintf(fLog, &quot;\t\tUnder safety level - calculate order quantity for %d days\n&quot;,
1995           GasStation-&gt;StockDurationDays);
1996          double SubOrderQuantity=0;
1997          for (int DurDayN=0; DurDayN&lt;GasStation-&gt;StockDurationDays; DurDayN++){
1998            GasDm-&gt;AssureDayRec(SimTodayRecN+DurDayN);
1999            double SubSimPredCspt=0;
2000            if (DurDayN==0){
2001              SubSimPredCspt=GasStation-&gt;SafetyVolumeVal-
2002               (SimVolumeVal-SimPredCspt+SimOrderQuantity);
2003            } else {
2004              SubSimPredCspt=GasMd-&gt;GetCorPredClassVal(
2005               GasDm, SimTodayRecN+DurDayN, GasStation-&gt;ExceptPredCorFact);
2006            }
2007            GasDm-&gt;PutCsptIfEmpty(SimTodayRecN+DurDayN, SubSimPredCspt);
2008            GasSimRec-&gt;AddOrdStep(
2009             GasDm-&gt;GetDateVal(SimTodayRecN+DurDayN).GetDtStr(),
2010             SubOrderQuantity+SubSimPredCspt, SubOrderQuantity, SubSimPredCspt);
2011            fprintf(fLog, &quot;\t\t\tOrderQuantity: %.0f = (o)%.0f + (c)%.0f (Date:%s) (Day:%d)\n&quot;,
2012             SubOrderQuantity+SubSimPredCspt, SubOrderQuantity, SubSimPredCspt,
2013             GasDm-&gt;GetDateVal(SimTodayRecN+DurDayN).GetDtStr().CStr(), DurDayN);
2014            SubOrderQuantity+=SubSimPredCspt;
2015          }
2016          GasSimRec-&gt;PutCorrQuant(
2017           SubOrderQuantity*GasStation-&gt;OrderQuantityCorFact);
2018          fprintf(fLog, &quot;\t\t\tOrderQuantity: %.0f = %.0f * %.2f (Correction)\n&quot;,
2019           SubOrderQuantity*GasStation-&gt;OrderQuantityCorFact,
2020           SubOrderQuantity, GasStation-&gt;OrderQuantityCorFact);
2021          SubOrderQuantity*=GasStation-&gt;OrderQuantityCorFact;
2022          int OrderIssueDayRecN=SimTodayRecN-GasStation-&gt;DeliveryDays;
2023          if (OrderIssueDayRecN&lt;0){OrderIssueDayRecN=0;}
2024          if (OrderIssueDayRecN&lt;TodayRecN){
2025            fprintf(fLog, &quot;\t\tReschedule Order: [%s] to [%s] !!!\n&quot;,
2026             GasDm-&gt;GetDateVal(OrderIssueDayRecN).GetDtStr().CStr(),
2027             GasDm-&gt;GetDateVal(TodayRecN).GetDtStr().CStr());
2028            OrderIssueDayRecN=TodayRecN;
2029            ReschOrdDtWarns++;
2030          }
2031          TSecTm OrderIssueDt=GasDm-&gt;GetDateVal(OrderIssueDayRecN);
2032          TSecTm OrderReceiveDt=
2033           GasDm-&gt;GetDateVal(OrderIssueDayRecN+GasStation-&gt;DeliveryDays);
2034          TStrV MsgStrV;
2035          TGasOrder::DelUnapprovedOrders(OrderReceiveDt, GasStation-&gt;GasOrderV, MsgStrV);
2036          TGasOrder::DelUnapprovedOrders(OrderReceiveDt, GasStation-&gt;NewGasOrderV, MsgStrV);
2037          for (int MsgStrN=0; MsgStrN&lt;MsgStrV.Len(); MsgStrN++){
2038            fprintf(fLog, &quot;\t\tDelete-Order: %s\n&quot;, MsgStrV[MsgStrN].CStr());}
2039          PGasOrder GasOrder=
2040           TGasOrder::New(OrderIssueDt, OrderReceiveDt, SubOrderQuantity, false);
2041          GasStation-&gt;GasOrderV.AddSorted(GasOrder);
2042          GasStation-&gt;NewGasOrderV.AddSorted(GasOrder);
2043          fprintf(fLog, &quot;\t\tCreate-Order: %s\n&quot;, GasOrder-&gt;GetStr().CStr());
2044          break;
2045        }
2046      }
2047      fprintf(fLog, &quot;\tNewVolume: %.0f = (v)%.0f + (o)%.0f - (c)%.0f\n&quot;,
2048       GasStation-&gt;VolumeVal+OrderQuantity-TodayRealCspt,
2049       GasStation-&gt;VolumeVal, OrderQuantity, TodayRealCspt);
2050      GasStation-&gt;VolumeVal=GasStation-&gt;VolumeVal+OrderQuantity-TodayRealCspt;
2051      if (GasStation-&gt;VolumeVal&lt;GasStation-&gt;SafetyVolumeVal){
2052        UnderSafetyLevWarns++;
2053        fprintf(fLog, &quot;\tUnder safety level: %.0f&lt;%.0f !!!\n&quot;,
2054         GasStation-&gt;VolumeVal, GasStation-&gt;SafetyVolumeVal);
2055      }
2056      TGasOrder::DelOrders(TodayDt, GasStation-&gt;GasOrderV);
2057      GasSimRecV.Add(GasSimRec);
2058      fprintf(fLog, &quot;Close day at record [%d] for date [%s]\n&quot;, TodayRecN, TodayDtStr.CStr());
2059    }
2060    GasStation-&gt;SaveXml(OutGasStationFNm);
2061    GasStation-&gt;DumpDef(fLog);
2062    TodayPredVolMom-&gt;Def(); TodayRealVolMom-&gt;Def();
2063    fprintf(fLog, &quot;===Statistics-Start======================\n&quot;);
2064    fprintf(fLog, &quot;Predicted-Volume-Statistics: %s\n&quot;, TodayPredVolMom-&gt;GetStr().CStr());
2065    fprintf(fLog, &quot;     Real-Volume-Statistics: %s\n&quot;, TodayRealVolMom-&gt;GetStr().CStr());
2066    fprintf(fLog, &quot;Under-Safety-Level-Warnings: %d\n&quot;, UnderSafetyLevWarns);
2067    fprintf(fLog, &quot;  Reschedule-Order-Warnings: %d\n&quot;, ReschOrdDtWarns);
2068    fprintf(fLog, &quot;===Statistics-End========================\n&quot;);
2069  }
2070  void TGasExe::GenHourBlockOrder(
2071   const TStr&amp; LogFNm,
2072   const PGasStation&amp; GasStation, const TStr&amp; OutGasStationFNm,
2073   const TSecTm&amp; StartDt, const int&amp; ProcessDays,
2074   const PGasDm&amp; GasDm,
2075   const PGasMdMType&amp; GasMdMType, const TStr&amp; GasMdParamStr,
2076   TGasSimRecV&amp; GasSimRecV){
2077    int TmGridHours=GasStation-&gt;TmGridHours;
2078    PMom NowPredVolMom=TMom::New();
2079    PMom NowRealVolMom=TMom::New();
2080    int UnderSafetyLevWarns=0;
2081    int ReschOrdDtWarns=0;
2082    TFOut LogSOut(LogFNm); FILE* fLog=LogSOut.GetFileId();
2083    GasStation-&gt;DumpDef(fLog);
2084    if (!StartDt.IsDef()){
2085      TExcept::Throw(&quot;Invalid start date.&quot;);}
2086    int FirstRecN=0;
2087    while (FirstRecN&lt;GasDm-&gt;GetRecs()){
2088      TSecTm CurRecDt=GasDm-&gt;GetDateVal(FirstRecN);
2089      if (CurRecDt==StartDt){break;}
2090      FirstRecN++;
2091    }
2092    if (FirstRecN==GasDm-&gt;GetRecs()){
2093      TSecTm CurRecDt=GasDm-&gt;GetDateVal(GasDm-&gt;GetRecs()-1);
2094      CurRecDt.AddDays(1);
2095      if (CurRecDt!=StartDt){
2096        TExcept::Throw(&quot;Invalid start date.&quot;, StartDt.GetDtStr());}
2097    }
2098    GasSimRecV.Clr();
2099    int DayRecs=24/TmGridHours;
2100    int ProcessRecs=ProcessDays*DayRecs;
2101    for (int NowRecN=FirstRecN; NowRecN&lt;FirstRecN+ProcessRecs; NowRecN++){
2102      GasDm-&gt;AssureDayRec(NowRecN);
2103      TSecTm NowDt=GasDm-&gt;GetDateVal(NowRecN);
2104      int NowHourN=GasDm-&gt;GetHourN(NowRecN);
2105      TStr NowDtTmStr=NowDt.GetDtStr()+&quot;/&quot;+TInt::GetStr(NowHourN);
2106      TSecTm NowStartTm=TSecTm(NowDt).AddHours(NowHourN);
2107      TSecTm NowEndTm=TSecTm(NowStartTm).AddHours(TmGridHours);
2108      fprintf(fLog, &quot;Start day at record [%d] for date/hour [%s]\n&quot;, NowRecN, NowDtTmStr.CStr());
2109      fprintf(fLog, &quot;\tFrom [%s] To [%s]\n&quot;, NowStartTm.GetStr().CStr(), NowEndTm.GetStr().CStr());
2110      fprintf(fLog, &quot;\tDay-Info: [%s]\n&quot;, GasDm-&gt;GetBitsStr(NowRecN).CStr());
2111      if (NowRecN&gt;FirstRecN){
2112        TSecTm PrevDt=GasDm-&gt;GetDateVal(NowRecN-1);
2113        int PrevHourN=GasDm-&gt;GetHourN(NowRecN-1);
2114        if (NowDt==PrevDt){
2115          EAssertRA(NowHourN-PrevHourN==TmGridHours, &quot;Invalid time grid&quot;, NowDtTmStr);
2116        } else
2117        if (NowDt==TSecTm(PrevDt).AddDays(1)){
2118          EAssertRA(NowHourN==0, &quot;Invalid time grid&quot;, NowDtTmStr);
2119        }
2120      }
2121      PGasSimRec GasSimRec=TGasSimRec::New(GasStation, NowDtTmStr);
2122      int MnMdRecN=NowRecN-GasStation-&gt;HistWnDays*DayRecs;
2123      int MxMdRecN=NowRecN-1;
2124      PGasMd GasMd=TGasMd::New(
2125       gmtEnsemble, GasMdMType, GasMdParamStr,
2126       GasDm,
2127       TSecTm(), TSecTm(), MnMdRecN, MxMdRecN,
2128       100);
2129      fprintf(fLog, &quot;\tCreate Model for %d records (from %d to %d)\n&quot;,
2130       MxMdRecN-MnMdRecN+1, MnMdRecN, MxMdRecN);
2131      double OrderQuantity=
2132       TGasOrder::GetQuantity(NowStartTm, NowEndTm, GasStation-&gt;GasOrderV);
2133      fprintf(fLog, &quot;\tExecuted Orders for Quantity: %.0f\n&quot;, OrderQuantity);
2134      double NowPredCspt=GasMd-&gt;GetPredClassVal(GasDm, NowRecN);
2135      if (NowPredCspt&lt;0){NowPredCspt=0;}
2136      GasDm-&gt;PutCsptIfEmpty(NowRecN, NowPredCspt);
2137      fprintf(fLog, &quot;\tPredicted consumption: %.0f\n&quot;, NowPredCspt);
2138      double NowRealCspt=GasDm-&gt;GetClassVal(NowRecN);
2139      fprintf(fLog, &quot;\tReal consumption: %.0f\n&quot;, NowRealCspt);
2140      double NowPredOpenVol=GasStation-&gt;VolumeVal+OrderQuantity;
2141      double NowPredCloseVol=NowPredOpenVol-NowRealCspt;
2142      if ((NowPredOpenVol!=-1)&amp;&amp;(NowPredCloseVol!=-1)){
2143        NowPredVolMom-&gt;Add((NowPredOpenVol+NowPredCloseVol)/2);}
2144      double NowOpenRealVol=GasDm-&gt;GetVolVal(NowRecN);
2145      double NowCloseRealVol=-1;
2146      if (NowRecN+1&lt;GasDm-&gt;GetRecs()){
2147        NowCloseRealVol=GasDm-&gt;GetVolVal(NowRecN+1);}
2148      if ((NowOpenRealVol!=-1)&amp;&amp;(NowCloseRealVol!=-1)){
2149        NowRealVolMom-&gt;Add((NowOpenRealVol+NowCloseRealVol)/2);}
2150      double SimVolumeVal=GasStation-&gt;VolumeVal;
2151      int SimNowRecN=NowRecN;
2152      int SimDays=GasStation-&gt;StockDurationDays+GasStation-&gt;DeliveryDays;
2153      int SimRecs=SimDays*DayRecs;
2154      fprintf(fLog, &quot;\tSimulation to generate orders for %d (%d+%d) days (%d records).\n&quot;,
2155       SimDays, GasStation-&gt;StockDurationDays, GasStation-&gt;DeliveryDays, SimRecs);
2156      GasSimRec-&gt;PutReal(NowPredOpenVol, NowRealCspt, OrderQuantity);
2157      while (SimNowRecN-NowRecN&lt;SimRecs){
2158        GasDm-&gt;AssureDayRec(SimNowRecN);
2159        TSecTm SimNowDt=GasDm-&gt;GetDateVal(SimNowRecN);
2160        int SimNowHourN=GasDm-&gt;GetHourN(SimNowRecN);
2161        TStr SimNowDtTmStr=SimNowDt.GetDtStr()+&quot;/&quot;+TInt::GetStr(SimNowHourN);
2162        TSecTm SimNowStartTm=TSecTm(SimNowDt).AddHours(SimNowHourN);
2163        TSecTm SimNowEndTm=TSecTm(SimNowStartTm).AddHours(TmGridHours);
2164        double SimOrderQuantity=
2165         TGasOrder::GetQuantity(SimNowStartTm, SimNowEndTm, GasStation-&gt;GasOrderV);
2166        double SimPredCspt=GasMd-&gt;GetCorPredClassVal(
2167         GasDm, SimNowRecN, GasStation-&gt;ExceptPredCorFact);
2168        GasDm-&gt;PutCsptIfEmpty(SimNowRecN, SimPredCspt);
2169        GasSimRec-&gt;AddSimStep(SimNowDtTmStr,
2170         SimVolumeVal-SimPredCspt+SimOrderQuantity,
2171         SimVolumeVal, SimPredCspt, SimOrderQuantity);
2172        fprintf(fLog, &quot;\t\tSimVolume: %.0f = (v)%.0f - (c)%.0f + (o)%.0f (Date/Hour:%s) (Step:%d)\n&quot;,
2173         SimVolumeVal-SimPredCspt+SimOrderQuantity,
2174         SimVolumeVal, SimPredCspt, SimOrderQuantity,
2175         SimNowDtTmStr.CStr(), SimNowRecN-NowRecN);
2176        if (SimVolumeVal-SimPredCspt+SimOrderQuantity&gt;=GasStation-&gt;SafetyVolumeVal){
2177          SimVolumeVal=SimVolumeVal+SimOrderQuantity-SimPredCspt;
2178          SimNowRecN++;
2179        } else {
2180          fprintf(fLog, &quot;\t\tUnder safety level - calculate order quantity for %d days\n&quot;,
2181           GasStation-&gt;StockDurationDays);
2182          double SubOrderQuantity=0;
2183          int DurRecs=GasStation-&gt;StockDurationDays*DayRecs;
2184          for (int DurRecN=0; DurRecN&lt;DurRecs; DurRecN++){
2185            GasDm-&gt;AssureDayRec(SimNowRecN+DurRecN);
2186            TSecTm DurDt=GasDm-&gt;GetDateVal(SimNowRecN+DurRecN);
2187            int DurHourN=GasDm-&gt;GetHourN(SimNowRecN+DurRecN);
2188            TStr DurDtTmStr=DurDt.GetDtStr()+&quot;/&quot;+TInt::GetStr(DurHourN);
2189            double SubSimPredCspt=0;
2190            if (DurRecN==0){
2191              SubSimPredCspt=GasStation-&gt;SafetyVolumeVal-
2192               (SimVolumeVal-SimPredCspt+SimOrderQuantity);
2193            } else {
2194              SubSimPredCspt=GasMd-&gt;GetCorPredClassVal(
2195               GasDm, SimNowRecN+DurRecN, GasStation-&gt;ExceptPredCorFact);
2196            }
2197            GasDm-&gt;PutCsptIfEmpty(SimNowRecN+DurRecN, SubSimPredCspt);
2198            GasSimRec-&gt;AddOrdStep(
2199             DurDtTmStr,
2200             SubOrderQuantity+SubSimPredCspt, SubOrderQuantity, SubSimPredCspt);
2201            fprintf(fLog, &quot;\t\t\tOrderQuantity: %.0f = (o)%.0f + (c)%.0f (Date:%s) (Rec:%d)\n&quot;,
2202             SubOrderQuantity+SubSimPredCspt, SubOrderQuantity, SubSimPredCspt,
2203             DurDtTmStr.CStr(), DurRecN);
2204            SubOrderQuantity+=SubSimPredCspt;
2205          }
2206          GasSimRec-&gt;PutCorrQuant(
2207           SubOrderQuantity*GasStation-&gt;OrderQuantityCorFact);
2208          fprintf(fLog, &quot;\t\t\tOrderQuantity: %.0f = %.0f * %.2f (Correction)\n&quot;,
2209           SubOrderQuantity*GasStation-&gt;OrderQuantityCorFact,
2210           SubOrderQuantity, GasStation-&gt;OrderQuantityCorFact);
2211          SubOrderQuantity*=GasStation-&gt;OrderQuantityCorFact;
2212          int OrderIssueRecN=SimNowRecN-GasStation-&gt;DeliveryDays*DayRecs;
2213          if (OrderIssueRecN&lt;0){OrderIssueRecN=0;}
2214          if (OrderIssueRecN&lt;NowRecN){
2215            fprintf(fLog, &quot;\t\tReschedule Order: [%s] to [%s] !!!\n&quot;,
2216             GasDm-&gt;GetDateVal(OrderIssueRecN).GetDtStr().CStr(),
2217             GasDm-&gt;GetDateVal(NowRecN).GetDtStr().CStr());
2218            OrderIssueRecN=NowRecN;
2219            ReschOrdDtWarns++;
2220          }
2221          TSecTm OrderIssueTm=GasDm-&gt;GetDateVal(OrderIssueRecN);
2222          int OrderIssueHourN=GasDm-&gt;GetHourN(OrderIssueRecN);
2223          OrderIssueTm.AddHours(OrderIssueHourN);
2224          int DeliveryRecs=GasStation-&gt;DeliveryDays*DayRecs;
2225          TSecTm OrderReceiveTm=GasDm-&gt;GetDateVal(OrderIssueRecN+DeliveryRecs);
2226          int OrderReceiveHourN=GasDm-&gt;GetHourN(OrderIssueRecN+DeliveryRecs);
2227          OrderReceiveTm.AddHours(OrderReceiveHourN);
2228          TStrV MsgStrV;
2229          TGasOrder::DelUnapprovedOrders(OrderReceiveTm, GasStation-&gt;GasOrderV, MsgStrV);
2230          TGasOrder::DelUnapprovedOrders(OrderReceiveTm, GasStation-&gt;NewGasOrderV, MsgStrV);
2231          for (int MsgStrN=0; MsgStrN&lt;MsgStrV.Len(); MsgStrN++){
2232            fprintf(fLog, &quot;\t\tDelete-Order: %s\n&quot;, MsgStrV[MsgStrN].CStr());}
2233          PGasOrder GasOrder=
2234           TGasOrder::New(OrderIssueTm, OrderReceiveTm, SubOrderQuantity, false);
2235          GasStation-&gt;GasOrderV.AddSorted(GasOrder);
2236          GasStation-&gt;NewGasOrderV.AddSorted(GasOrder);
2237          fprintf(fLog, &quot;\t\tCreate-Order: %s\n&quot;, GasOrder-&gt;GetStr().CStr());
2238          break;
2239        }
2240      }
2241      fprintf(fLog, &quot;\tNewVolume: %.0f = (v)%.0f + (o)%.0f - (c)%.0f\n&quot;,
2242       GasStation-&gt;VolumeVal+OrderQuantity-NowRealCspt,
2243       GasStation-&gt;VolumeVal, OrderQuantity, NowRealCspt);
2244      GasStation-&gt;VolumeVal=GasStation-&gt;VolumeVal+OrderQuantity-NowRealCspt;
2245      if (GasStation-&gt;VolumeVal&lt;GasStation-&gt;SafetyVolumeVal){
2246        UnderSafetyLevWarns++;
2247        fprintf(fLog, &quot;\tUnder safety level: %.0f&lt;%.0f !!!\n&quot;,
2248         GasStation-&gt;VolumeVal, GasStation-&gt;SafetyVolumeVal);
2249      }
2250      TGasOrder::DelOrders(NowStartTm, NowEndTm, GasStation-&gt;GasOrderV);
2251      GasSimRecV.Add(GasSimRec);
2252      fprintf(fLog, &quot;Close day at record [%d] for date/hour [%s]\n&quot;, NowRecN, NowDtTmStr.CStr());
2253    }
2254    GasStation-&gt;SaveXml(OutGasStationFNm);
2255    GasStation-&gt;DumpDef(fLog);
2256    NowPredVolMom-&gt;Def(); NowRealVolMom-&gt;Def();
2257    fprintf(fLog, &quot;===Statistics-Start======================\n&quot;);
2258    fprintf(fLog, &quot;Predicted-Volume-Statistics: %s\n&quot;, NowPredVolMom-&gt;GetStr().CStr());
2259    fprintf(fLog, &quot;     Real-Volume-Statistics: %s\n&quot;, NowRealVolMom-&gt;GetStr().CStr());
2260    fprintf(fLog, &quot;Under-Safety-Level-Warnings: %d\n&quot;, UnderSafetyLevWarns);
2261    fprintf(fLog, &quot;  Reschedule-Order-Warnings: %d\n&quot;, ReschOrdDtWarns);
2262    fprintf(fLog, &quot;===Statistics-End========================\n&quot;);
2263  }
2264  int TGasExe::GenPrediction(
2265   const TStr&amp; TabFNm,
2266   const TStr&amp; _LtpFNm,
2267   const TStr&amp; LtpFPath,
2268   const bool&amp; RepairP,
2269   const TStr&amp; OutLogFNm,
2270   const TStr&amp; OutXmlFNm,
2271   const TStr&amp; MdNm,
2272   const TStr&amp; TmResNm,
2273   const TStr&amp; PredDateStr,
2274   const int&amp; PredDays,
2275   const int&amp; TrainDays,
2276   const double&amp; MnCspt,
2277   const double&amp; ExceptPredCorFact){
2278    Try;
2279    TStr LtpFNm=_LtpFNm;
2280    if ((!TabFNm.Empty())&amp;&amp;(LtpFNm.Empty())){
2281      LtpFNm=TStr::PutFExt(TabFNm, &quot;.Ltp&quot;);}
2282    TSecTm PredDate=TSecTm::GetDtTmFromDmyStr(PredDateStr);
2283    TFOut LogFOut(OutLogFNm); FILE* fLog=LogFOut.GetFileId();
2284    if (!TabFNm.Empty()){
2285      TGasLtpBs::ConvTabToLtp(TabFNm, LtpFPath, RepairP);}
2286    PGasLtpBs GasLtpBs=TGasLtpBs::Load(LtpFNm);
2287    PGasMdMType GasMdMType;
2288    if (MdNm==&quot;ctb&quot;){GasMdMType=TGasMdMType::New(gmtCTb);}
2289    else if (MdNm==&quot;svd&quot;){GasMdMType=TGasMdMType::New(gmtLr);}
2290    else if (MdNm==&quot;nnbr&quot;){GasMdMType=TGasMdMType::New(gmtNNbr);}
2291    else if (MdNm==&quot;svm&quot;){GasMdMType=TGasMdMType::New(gmtSvm);}
2292    else if (MdNm==&quot;cubist&quot;){GasMdMType=TGasMdMType::New(gmtCubist);}
2293    else if (MdNm==&quot;rtree&quot;){GasMdMType=TGasMdMType::New(gmtRegTree);}
2294    else if (MdNm==&quot;ens&quot;){
2295      GasMdMType=TGasMdMType::New();
2296      GasMdMType-&gt;AddMdTypeWgt(gmtLr, 40);
2297      GasMdMType-&gt;AddMdTypeWgt(gmtNNbr, 30);
2298      GasMdMType-&gt;AddMdTypeWgt(gmtCTb, 30);
2299      GasMdMType-&gt;NrmMdWgt();
2300    } else {
2301      TExcept::Throw(&quot;Invalid model type&quot;, MdNm);
2302    }
2303    PGasDm GasDm;
2304    if (TmResNm==&quot;w&quot;){GasDm=TGasDm::GetWeekGasDm(GasLtpBs);}
2305    else if (TmResNm==&quot;d&quot;){GasDm=TGasDm::GetDayGasDm(GasLtpBs);}
2306    else if (TmResNm==&quot;24h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 24);}
2307    else if (TmResNm==&quot;12h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 12);}
2308    else if (TmResNm==&quot;6h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 6);}
2309    else if (TmResNm==&quot;4h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 4);}
2310    else if (TmResNm==&quot;3h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 3);}
2311    else if (TmResNm==&quot;2h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 2);}
2312    else if (TmResNm==&quot;1h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 1);}
2313    else {TExcept::Throw(&quot;Invalid time resolution&quot;, TmResNm);}
2314    TSecTm MnLtpDate=GasLtpBs-&gt;GetMnDate();
2315    TSecTm MxLtpDate=GasLtpBs-&gt;GetMxDate();
2316    fprintf(fLog, &quot;Minimal-Possible-Train-Date: %s\n&quot;, MnLtpDate.GetDtStr().CStr());
2317    fprintf(fLog, &quot;Maximal-Possible-Train-Date: %s\n&quot;, MxLtpDate.GetDtStr().CStr());
2318    if (PredDateStr.Empty()){
2319      PredDate=TSecTm(MxLtpDate).AddDays(1);}
2320    TSecTm StartPredDate=PredDate;
2321    TSecTm EndPredDate=TSecTm(StartPredDate).AddDays(PredDays-1);
2322    TSecTm StartTrainDate=TSecTm(StartPredDate).AddDays(-TrainDays);
2323    TSecTm EndTrainDate=TSecTm(StartPredDate).AddDays(-1);
2324    fprintf(fLog, &quot;Start-Train-Date: %s\n&quot;, StartTrainDate.GetDtStr().CStr());
2325    fprintf(fLog, &quot;End-Train-Date: %s\n&quot;, EndTrainDate.GetDtStr().CStr());
2326    fprintf(fLog, &quot;Start-Prediction-Date: %s\n&quot;, StartPredDate.GetDtStr().CStr());
2327    fprintf(fLog, &quot;End-Prediction-Date: %s\n&quot;, EndPredDate.GetDtStr().CStr());
2328    if ((StartTrainDate&lt;MnLtpDate)||(MxLtpDate&lt;StartTrainDate)){
2329      TExcept::Throw(&quot;Bad Start-Train-Date&quot;, StartTrainDate.GetStr());}
2330    if ((EndTrainDate&lt;MnLtpDate)||(MxLtpDate&lt;EndTrainDate)){
2331      TExcept::Throw(&quot;Bad End-Train-Date&quot;, EndTrainDate.GetStr());}
2332    TIntV TrainRecNV; TIntV SimPredRecNV;
2333    GasDm-&gt;GetRecNV(StartTrainDate, EndTrainDate, -1, -1, MnCspt, TrainRecNV);
2334    GasDm-&gt;GetRecNV(StartPredDate, EndPredDate, -1, -1, MnCspt, SimPredRecNV);
2335    int TrainRecs=TrainRecNV.Len(); int SimPredRecs=SimPredRecNV.Len();
2336    if (TrainRecs==0){
2337      TExcept::Throw(&quot;Empty Train Set&quot;);
2338    } else {
2339      fprintf(fLog, &quot;Train Records: %d (from %d to %d)\n&quot;,
2340       TrainRecs, TrainRecNV[0], TrainRecNV.Last());
2341    }
2342    fprintf(fLog, &quot;Simulated Prediction Records: %d\n&quot;, SimPredRecs);
2343    PGasMd GasMd=TGasMd::New(
2344     gmtEnsemble, GasMdMType,
2345     TGasMd::GetMdParamStr(),
2346     GasDm,
2347     StartTrainDate, EndTrainDate, -1, -1,
2348     MnCspt);
2349    {TFOut SOut(OutXmlFNm); FILE* fOut=SOut.GetFileId();
2350    fprintf(fOut, &quot;&lt;Predictions&gt;\n&quot;);
2351    fprintf(fOut, &quot;  &lt;Location&gt;%s&lt;/Location&gt;\n&quot;,
2352     TXmlLx::GetXmlStrFromPlainStr(GasLtpBs-&gt;GetLocNm()).CStr());
2353    fprintf(fOut, &quot;  &lt;Product&gt;%s&lt;/Product&gt;\n&quot;,
2354     TXmlLx::GetXmlStrFromPlainStr(GasLtpBs-&gt;GetProdNm()).CStr());
2355    fprintf(fOut, &quot;  &lt;LtpCode&gt;%s&lt;/LtpCode&gt;\n&quot;,
2356     TXmlLx::GetXmlStrFromPlainStr(GasLtpBs-&gt;GetLtpNm()).CStr());
2357    TSecTm CurPredDate=StartPredDate;
2358    for (int SimPredRecNN=0; SimPredRecNN&lt;SimPredRecs; SimPredRecNN++){
2359      int PredRecN=SimPredRecNV[SimPredRecNN];
2360      CurPredDate=TSecTm::GetDtTm(GasDm-&gt;GetDateVal(PredRecN));
2361      TStr PredDateStr=GasDm-&gt;GetDateVal(PredRecN).GetDtStr();
2362      int HourN=GasDm-&gt;GetAttrVal(PredRecN, &quot;Hour&quot;, -1);
2363      TStr PredTmStr;
2364      if (HourN==-1){
2365        fprintf(fLog, &quot;Prediction date: %s (record %d)\n&quot;,
2366         PredDateStr.CStr(), PredRecN);
2367         PredTmStr=PredDateStr;
2368      } else {
2369        fprintf(fLog, &quot;Prediction date: %s %d:00 (record %d)\n&quot;,
2370         PredDateStr.CStr(), HourN, PredRecN);
2371        PredTmStr=PredDateStr+&quot; &quot;+TInt::GetStr(HourN)+&quot;:00&quot;;
2372      }
2373      double PredClassVal=GasMd-&gt;GetCorPredClassVal(GasDm, PredRecN, ExceptPredCorFact);
2374      double RealClassVal=GasDm-&gt;GetClassVal(PredRecN);
2375      fprintf(fLog, &quot;Predicted Consumption: %.0f\n&quot;, PredClassVal);
2376      fprintf(fLog, &quot;Real Consumption: %.0f\n&quot;, RealClassVal);
2377      fprintf(fOut, &quot;  &lt;Prediction Mode=\&quot;Simulation\&quot;&gt;\n&quot;);
2378      fprintf(fOut, &quot;    &lt;Time&gt;%s&lt;/Time&gt;\n&quot;, PredTmStr.CStr());
2379      fprintf(fOut, &quot;    &lt;Predicted&gt;%.0f&lt;/Predicted&gt;\n&quot;, PredClassVal);
2380      if (RealClassVal!=-1){
2381        fprintf(fOut, &quot;    &lt;Real&gt;%.0f&lt;/Real&gt;\n&quot;, RealClassVal);}
2382      fprintf(fOut, &quot;  &lt;/Prediction&gt;\n&quot;);
2383    }
2384    while (CurPredDate&lt;=EndPredDate){
2385      int PredRecN=GasDm-&gt;AddTmResRec();
2386      CurPredDate=TSecTm::GetDtTm(GasDm-&gt;GetDateVal(PredRecN));
2387      TStr PredDateStr=GasDm-&gt;GetDateVal(PredRecN).GetDtStr();
2388      int HourN=GasDm-&gt;GetAttrVal(PredRecN, &quot;Hour&quot;, -1);
2389      TStr PredTmStr;
2390      if (HourN==-1){
2391        fprintf(fLog, &quot;Prediction date: %s (record %d)\n&quot;,
2392         PredDateStr.CStr(), PredRecN);
2393         PredTmStr=PredDateStr;
2394      } else {
2395        fprintf(fLog, &quot;Prediction date: %s %d:00 (record %d)\n&quot;,
2396         PredDateStr.CStr(), HourN, PredRecN);
2397        PredTmStr=PredDateStr+&quot; &quot;+TInt::GetStr(HourN)+&quot;:00&quot;;
2398      }
2399      double PredClassVal=GasMd-&gt;GetCorPredClassVal(GasDm, PredRecN, ExceptPredCorFact);
2400      GasDm-&gt;PutCsptIfEmpty(PredRecN, PredClassVal);
2401      fprintf(fLog, &quot;Predicted Consumption: %.0f\n&quot;, PredClassVal);
2402      fprintf(fOut, &quot;  &lt;Prediction Mode=\&quot;Future\&quot;&gt;\n&quot;);
2403      fprintf(fOut, &quot;    &lt;Time&gt;%s&lt;/Time&gt;\n&quot;, PredTmStr.CStr());
2404      fprintf(fOut, &quot;    &lt;Predicted&gt;%.0f&lt;/Predicted&gt;\n&quot;, PredClassVal);
2405      fprintf(fOut, &quot;  &lt;/Prediction&gt;\n&quot;);
2406    }
2407    fprintf(fOut, &quot;&lt;/Predictions&gt;\n&quot;);}
2408    return 0;
2409    Catch;
2410    return 1;
2411  }
2412  int TGasExe::GenOrder(
2413   const TStr&amp; TabFNm,
2414   const TStr&amp; _LtpFNm,
2415   const TStr&amp; InGasStationFNm,
2416   const TStr&amp; OutGasStationFNm,
2417   const TStr&amp; OutLogFNm,
2418   const TStr&amp; OutSimFNm,
2419   const TStr&amp; StartDateStr,
2420   const int&amp; ProcessDays){
2421    Try;
2422    TStr LtpFNm=_LtpFNm;
2423    if ((!TabFNm.Empty())&amp;&amp;(LtpFNm.Empty())){
2424      LtpFNm=TStr::PutFExt(TabFNm, &quot;.Ltp&quot;);}
2425    TStr LtpFPath=LtpFNm.GetFPath();
2426    TSecTm StartDt=TSecTm::GetDtTmFromDmyStr(StartDateStr);
2427    PGasMdMType GasMdMType=TGasMdMType::New();
2428    GasMdMType-&gt;AddMdTypeWgt(gmtLr, 40);
2429    GasMdMType-&gt;AddMdTypeWgt(gmtNNbr, 30);
2430    GasMdMType-&gt;AddMdTypeWgt(gmtCTb, 30);
2431    GasMdMType-&gt;NrmMdWgt();
2432    if (!TabFNm.Empty()){
2433      TGasLtpBs::ConvTabToLtp(TabFNm, LtpFPath);}
2434    PGasLtpBs GasLtpBs=TGasLtpBs::Load(LtpFNm);
2435    PGasStation GasStation=TGasStation::LoadXml(InGasStationFNm);
2436    if (GasStation-&gt;TmGridHours==24){
2437      PGasDm GasDm=TGasDm::GetDayGasDm(GasLtpBs);
2438      TGasSimRecV GasSimRecV;
2439      TGasExe::GenDayOrder(
2440       OutLogFNm,
2441       GasStation, OutGasStationFNm,
2442       StartDt, ProcessDays,
2443       GasDm,
2444       GasMdMType, TGasMd::GetMdParamStr(),
2445       GasSimRecV);
2446      if (!OutSimFNm.Empty()){
2447        TGasSimRec::SaveBin(OutSimFNm, GasSimRecV);}
2448    } else
2449    if ((0&lt;GasStation-&gt;TmGridHours)&amp;&amp;(GasStation-&gt;TmGridHours&lt;24)){
2450      PGasDm GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, GasStation-&gt;TmGridHours);
2451      TGasSimRecV GasSimRecV;
2452      TGasExe::GenHourBlockOrder(
2453       OutLogFNm,
2454       GasStation, OutGasStationFNm,
2455       StartDt, ProcessDays,
2456       GasDm,
2457       GasMdMType, TGasMd::GetMdParamStr(),
2458       GasSimRecV);
2459      if (!OutSimFNm.Empty()){
2460        TGasSimRec::SaveBin(OutSimFNm, GasSimRecV);}
2461    } else {
2462      TExcept::Throw(
2463       &quot;Time-Grid should be 0&lt;tg&lt;=24&quot;, TInt::GetStr(GasStation-&gt;TmGridHours));
2464    }
2465    return 0;
2466    Catch;
2467    return 1;
2468  }
</code></pre>
        </div>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-ultra.cpp</h3>
            <pre><code>1  #include &quot;ultra.h&quot;
2  TGasDef::TGasDef(const bool&amp; DbP):
3    FldNmTyUseTrV(){
4    if (DbP){
5      LocIdFldN=FldNmTyUseTrV.Add(TStrTr(&quot;LocationID&quot;, &quot;int&quot;, &quot;meta&quot;));
6      ProdIdFldN=FldNmTyUseTrV.Add(TStrTr(&quot;ProductID&quot;, &quot;int&quot;, &quot;meta&quot;));
7      DateFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Date&quot;, &quot;date&quot;, &quot;active&quot;));
8      DayNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Day&quot;, &quot;int&quot;, &quot;active&quot;));
9      MonthNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Month&quot;, &quot;int&quot;, &quot;active&quot;));
10      YearNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Year&quot;, &quot;int&quot;, &quot;active&quot;));
11      HourNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;HourStart&quot;, &quot;int&quot;, &quot;active&quot;));
12      FldNmTyUseTrV.Add(TStrTr(&quot;HourEnd&quot;, &quot;int&quot;, &quot;active&quot;));
13      DowNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;DayOfWeek&quot;, &quot;dow&quot;, &quot;active&quot;));
14      IsHolidayFldN=FldNmTyUseTrV.Add(TStrTr(&quot;ISHoliday&quot;, &quot;int&quot;, &quot;active&quot;));
15      IsHolidayStartFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsHolidayStart&quot;, &quot;int&quot;, &quot;active&quot;));
16      IsHolidayEndFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsHolidayEnd&quot;, &quot;int&quot;, &quot;active&quot;));
17      IsDayBeforeHolidayFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsDayBeforeHoliday&quot;, &quot;int&quot;, &quot;active&quot;));
18      IsDayAfterHolidayFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsDayAfterHoliday&quot;, &quot;int&quot;, &quot;active&quot;));
19      VolFldN=FldNmTyUseTrV.Add(TStrTr(&quot;VolumeStart&quot;, &quot;int&quot;, &quot;active&quot;));
20      CsptFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Cnsmptn&quot;, &quot;int&quot;, &quot;active&quot;));
21      FldNmTyUseTrV.Add(TStrTr(&quot;Interpolation&quot;, &quot;int&quot;, &quot;active&quot;));
22      CsptLast1WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast1W&quot;, &quot;int&quot;, &quot;active&quot;));
23      CsptLast2WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast2W&quot;, &quot;int&quot;, &quot;active&quot;));
24      CsptLast3WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast3W&quot;, &quot;int&quot;, &quot;active&quot;));
25      SumCsptLast1WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast1W&quot;, &quot;int&quot;, &quot;active&quot;));
26      SumCsptLast2WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast2W&quot;, &quot;int&quot;, &quot;active&quot;));
27      SumCsptLast3WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast3W&quot;, &quot;int&quot;, &quot;active&quot;));
28      CsptLast1DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast1D&quot;, &quot;int&quot;, &quot;active&quot;));
29      CsptLast2DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast2D&quot;, &quot;int&quot;, &quot;active&quot;));
30      CsptLast3DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast3D&quot;, &quot;int&quot;, &quot;active&quot;));
31      CsptLast4DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast4D&quot;, &quot;int&quot;, &quot;active&quot;));
32      CsptLast5DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast5D&quot;, &quot;int&quot;, &quot;active&quot;));
33      CsptLast6DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast6D&quot;, &quot;int&quot;, &quot;active&quot;));
34      SumCsptLast1DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast1D&quot;, &quot;int&quot;, &quot;active&quot;));
35      SumCsptLast2DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast2D&quot;, &quot;int&quot;, &quot;active&quot;));
36      SumCsptLast3DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast3D&quot;, &quot;int&quot;, &quot;active&quot;));
37      SumCsptLast4DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast4D&quot;, &quot;int&quot;, &quot;active&quot;));
38      SumCsptLast5DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast5D&quot;, &quot;int&quot;, &quot;active&quot;));
39      SumCsptLast6DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast6D&quot;, &quot;int&quot;, &quot;active&quot;));
40      PriceChangeFldN=FldNmTyUseTrV.Add(TStrTr(&quot;PriceChange&quot;, &quot;int&quot;, &quot;active&quot;));
41      DaysBeforePriceChangeFldN=FldNmTyUseTrV.Add(TStrTr(&quot;DaysBeforePriceChange&quot;, &quot;int&quot;, &quot;active&quot;));
42    } else {
43      LocIdFldN=FldNmTyUseTrV.Add(TStrTr(&quot;LocationID&quot;, &quot;int&quot;, &quot;meta&quot;));
44      TankIdFldN=FldNmTyUseTrV.Add(TStrTr(&quot;TankID&quot;, &quot;int&quot;, &quot;meta&quot;));
45      ProdIdFldN=FldNmTyUseTrV.Add(TStrTr(&quot;ProductID&quot;, &quot;int&quot;, &quot;meta&quot;));
46      DateFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Date&quot;, &quot;date&quot;, &quot;active&quot;));
47      HourNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;HourStart&quot;, &quot;int&quot;, &quot;active&quot;));
48      FldNmTyUseTrV.Add(TStrTr(&quot;HourEnd&quot;, &quot;int&quot;, &quot;active&quot;));
49      CsptFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Cnsmptn&quot;, &quot;int&quot;, &quot;active&quot;));
50      VolFldN=FldNmTyUseTrV.Add(TStrTr(&quot;VolumeStart&quot;, &quot;int&quot;, &quot;active&quot;));
51      FldNmTyUseTrV.Add(TStrTr(&quot;Interpolation&quot;, &quot;int&quot;, &quot;active&quot;));
52      CsptLast1WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast1W&quot;, &quot;int&quot;, &quot;active&quot;));
53      CsptLast2WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast2W&quot;, &quot;int&quot;, &quot;active&quot;));
54      CsptLast3WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast3W&quot;, &quot;int&quot;, &quot;active&quot;));
55      SumCsptLast1WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast1W&quot;, &quot;int&quot;, &quot;active&quot;));
56      SumCsptLast2WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast2W&quot;, &quot;int&quot;, &quot;active&quot;));
57      SumCsptLast3WFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast3W&quot;, &quot;int&quot;, &quot;active&quot;));
58      CsptLast1DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast1D&quot;, &quot;int&quot;, &quot;active&quot;));
59      CsptLast2DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast2D&quot;, &quot;int&quot;, &quot;active&quot;));
60      CsptLast3DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast3D&quot;, &quot;int&quot;, &quot;active&quot;));
61      CsptLast4DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast4D&quot;, &quot;int&quot;, &quot;active&quot;));
62      CsptLast5DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast5D&quot;, &quot;int&quot;, &quot;active&quot;));
63      CsptLast6DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;CnsmptnLast6D&quot;, &quot;int&quot;, &quot;active&quot;));
64      SumCsptLast1DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast1D&quot;, &quot;int&quot;, &quot;active&quot;));
65      SumCsptLast2DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast2D&quot;, &quot;int&quot;, &quot;active&quot;));
66      SumCsptLast3DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast3D&quot;, &quot;int&quot;, &quot;active&quot;));
67      SumCsptLast4DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast4D&quot;, &quot;int&quot;, &quot;active&quot;));
68      SumCsptLast5DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast5D&quot;, &quot;int&quot;, &quot;active&quot;));
69      SumCsptLast6DFldN=FldNmTyUseTrV.Add(TStrTr(&quot;SumCnsmptnLast6D&quot;, &quot;int&quot;, &quot;active&quot;));
70      DayNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Day&quot;, &quot;int&quot;, &quot;active&quot;));
71      MonthNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Month&quot;, &quot;int&quot;, &quot;active&quot;));
72      YearNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;Year&quot;, &quot;int&quot;, &quot;active&quot;));
73      DowNFldN=FldNmTyUseTrV.Add(TStrTr(&quot;DayOfWeek&quot;, &quot;dow&quot;, &quot;active&quot;));
74      IsHolidayFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsHoliday&quot;, &quot;int&quot;, &quot;active&quot;));
75      IsHolidayStartFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsHolidayStart&quot;, &quot;int&quot;, &quot;active&quot;));
76      IsHolidayEndFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsHolidayEnd&quot;, &quot;int&quot;, &quot;active&quot;));
77      IsDayBeforeHolidayFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsDayBeforeHoliday&quot;, &quot;int&quot;, &quot;active&quot;));
78      IsDayAfterHolidayFldN=FldNmTyUseTrV.Add(TStrTr(&quot;IsDayAfterHoliday&quot;, &quot;int&quot;, &quot;active&quot;));
79      PriceChangeFldN=FldNmTyUseTrV.Add(TStrTr(&quot;PriceChange&quot;, &quot;int&quot;, &quot;active&quot;));
80      DaysBeforePriceChangeFldN=FldNmTyUseTrV.Add(TStrTr(&quot;DaysBeforePriceChange&quot;, &quot;int&quot;, &quot;active&quot;));
81      ProdNmFldN=FldNmTyUseTrV.Add(TStrTr(&quot;ProductName&quot;, &quot;int&quot;, &quot;ignore&quot;));
82      LocNmFldN=FldNmTyUseTrV.Add(TStrTr(&quot;LocationName&quot;, &quot;int&quot;, &quot;ignore&quot;));
83    }
84  }
85  bool TGasDef::IsFldNmVOk(const TStrV&amp; FldNmV) const {
86    if (GetFlds()!=FldNmV.Len()){return false;}
87    for (int FldN=0; FldN&lt;FldNmV.Len(); FldN++){
88      if (FldNmTyUseTrV[FldN].Val1!=FldNmV[FldN]){
89        printf(&quot;&#x27;%s&#x27;!=&#x27;%s&#x27;&quot;, FldNmTyUseTrV[FldN].Val1.CStr(), FldNmV[FldN].CStr());
90        return false;
91      }
92    }
93    return true;
94  }
95  void TGasDef::GetFldIntValV(const TStrV&amp; FldStrValV, TIntV&amp; FldIntValV) const {
96    int Flds=GetFlds();
97    EAssertR(Flds==FldStrValV.Len(), &quot;Number of data fields doesn&#x27;t fit.&quot;);
98    FldIntValV.Gen(Flds);
99    for (int FldN=0; FldN&lt;Flds; FldN++){
100      TStrTr&amp; FldNmTyUseTr=FldNmTyUseTrV[FldN];
101      if (FldNmTyUseTr.Val3!=&quot;ignore&quot;){
102        if (FldNmTyUseTr.Val2==&quot;int&quot;){
103          if (FldStrValV[FldN]==&quot;True&quot;){FldIntValV[FldN]=1;}
104          else if (FldStrValV[FldN]==&quot;False&quot;){FldIntValV[FldN]=0;}
105          else {FldIntValV[FldN]=FldStrValV[FldN].GetInt();}
106        } else
107        if (FldNmTyUseTr.Val2==&quot;date&quot;){
108          TSecTm Date=TSecTm::GetDtTmFromDmyStr(FldStrValV[FldN]);
109          FldIntValV[FldN]=Date.GetAbsSecs();
110        } else
111        if (FldNmTyUseTr.Val2==&quot;dow&quot;){
112          TStr DowNm=FldStrValV[FldN];
113          if (!DowNm.Empty()){DowNm.PutCh(0, TCh::GetUc(DowNm[0]));}
114          int DowN=TTmInfo::GetDayOfWeekN(DowNm, lSi);
115          FldIntValV[FldN]=DowN;
116        }
117      }
118    }
119  }
120  TSecTm TGasDef::GetTm(const TIntV&amp; FldIntValV) const {
121    int HourN=FldIntValV[HourNFldN];
122    int DayN=FldIntValV[DayNFldN];
123    int MonthN=FldIntValV[MonthNFldN];
124    int YearN=FldIntValV[YearNFldN];
125    TSecTm Tm=TSecTm::GetDtTm(YearN, MonthN, DayN);
126    Tm.AddHours(HourN);
127    return Tm;
128  }
129  void TGasDef::GetHdm(
130   const TIntV&amp; FldIntValV, int&amp; HourN, int&amp; DowN, int&amp; MonthN) const {
131    HourN=FldIntValV[HourNFldN];
132    DowN=FldIntValV[DowNFldN]-1;
133    MonthN=FldIntValV[MonthNFldN]-1;
134  }
135  TSecTm TGasLtpBs::GetMnDate() const {
136    TSecTm MnDate;
137    int Recs=GetRecs();
138    for (int RecN=0; RecN&lt;Recs; RecN++){
139      TSecTm Date=GetDate(RecN);
140      if ((RecN==0)||(Date&lt;MnDate)){MnDate=Date;}
141    }
142    return MnDate;
143  }
144  TSecTm TGasLtpBs::GetMxDate() const {
145    TSecTm MxDate;
146    int Recs=GetRecs();
147    for (int RecN=0; RecN&lt;Recs; RecN++){
148      TSecTm Date=GetDate(RecN);
149      if ((RecN==0)||(Date&gt;MxDate)){MxDate=Date;}
150    }
151    return MxDate;
152  }
153  void TGasLtpBs::GenStat(){
154    TMom::NewV(HourMomV, 24);
155    TMom::NewV(DowMomV, 7);
156    TMom::NewV(MonthMomV, 12);
157    TMom::NewVV(DowHourMomVV, 7, 24);
158    int Recs=GetRecs();
159    for (int RecN=0; RecN&lt;Recs; RecN++){
160      int HourN; int DowN; int MonthN;
161      GasDef-&gt;GetHdm(GetRec(RecN), HourN, DowN, MonthN);
162      int Cspt=GasDef-&gt;GetCspt(GetRec(RecN));
163      HourMomV[HourN]-&gt;Add(Cspt);
164      DowMomV[DowN]-&gt;Add(Cspt);
165      MonthMomV[MonthN]-&gt;Add(Cspt);
166      DowHourMomVV.At(DowN, HourN)-&gt;Add(Cspt);
167    }
168    TMom::DefV(HourMomV);
169    TMom::DefV(DowMomV);
170    TMom::DefV(MonthMomV);
171    TMom::DefVV(DowHourMomVV);
172  }
173  bool TGasLtpBs::IsDowHourMomUsable() const {
174    return
175     TMom::IsUsableV(HourMomV)&amp;&amp;
176     TMom::IsUsableV(DowMomV)&amp;&amp;
177     TMom::IsUsableVV(DowHourMomVV);
178  }
179  void TGasLtpBs::RepairUnknowns(){
180    if (!IsDowHourMomUsable()){
181      printf(&quot;*** Error: day-of-week &amp; hour statistics cannot be generated (not enough data)!\n&quot;);
182      printf(&quot;*** Can not repair data!\n&quot;);
183      return;
184    }
185    int Recs=GetRecs();
186    for (int RecN=0; RecN&lt;Recs; RecN++){
187      int RecHourN; int RecDowN; int RecMonthN;
188      GetHdm(RecN, RecHourN, RecDowN, RecMonthN);
189      TSecTm RecTm=GetTm(RecN);
190      TSecTm RecDate=GetDate(RecN);
191      TStr Str=RecTm.GetStr();
192      if (RecN&gt;0){
193        int DSecs=TSecTm::GetDSecs(GetTm(RecN-1), RecTm);
194        if (DSecs!=3600){
195          printf(&quot;*** Error - records not at hour interval (%s - %s)!\n&quot;,
196           GetTm(RecN-1).GetStr().CStr(), RecTm.GetStr().CStr());
197        }
198      }
199      if (GetCspt(RecN)&lt;0){
200        printf(&quot;*** Error: consumption is negative (%d)!\n&quot;, GetCspt(RecN));
201        printf(&quot;*** Can not repair data!\n&quot;);
202        return;
203      }
204      if (GetCsptLast1D(RecN)==-1){
205        GetCsptLast1D(RecN)=DowHourMomVV.At((RecDowN+7-1)%7, RecHourN)-&gt;GetMedian();}
206      if (GetCsptLast2D(RecN)==-1){
207        GetCsptLast2D(RecN)=DowHourMomVV.At((RecDowN+7-2)%7, RecHourN)-&gt;GetMedian();}
208      if (GetCsptLast3D(RecN)==-1){
209        GetCsptLast3D(RecN)=DowHourMomVV.At((RecDowN+7-3)%7, RecHourN)-&gt;GetMedian();}
210      if (GetCsptLast4D(RecN)==-1){
211        GetCsptLast4D(RecN)=DowHourMomVV.At((RecDowN+7-4)%7, RecHourN)-&gt;GetMedian();}
212      if (GetCsptLast5D(RecN)==-1){
213        GetCsptLast5D(RecN)=DowHourMomVV.At((RecDowN+7-5)%7, RecHourN)-&gt;GetMedian();}
214      if (GetCsptLast6D(RecN)==-1){
215        GetCsptLast6D(RecN)=DowHourMomVV.At((RecDowN+7-6)%7, RecHourN)-&gt;GetMedian();}
216      if (GetSumCsptLast1D(RecN)==-1){
217        GetSumCsptLast1D(RecN)=DowMomV[(RecDowN+7-1)%7]-&gt;GetMedian();}
218      if (GetSumCsptLast2D(RecN)==-1){
219        GetSumCsptLast2D(RecN)=DowMomV[(RecDowN+7-2)%7]-&gt;GetMedian();}
220      if (GetSumCsptLast3D(RecN)==-1){
221        GetSumCsptLast3D(RecN)=DowMomV[(RecDowN+7-1)%7]-&gt;GetMedian();}
222      if (GetSumCsptLast4D(RecN)==-1){
223        GetSumCsptLast4D(RecN)=DowMomV[(RecDowN+7-4)%7]-&gt;GetMedian();}
224      if (GetSumCsptLast5D(RecN)==-1){
225        GetSumCsptLast5D(RecN)=DowMomV[(RecDowN+7-5)%7]-&gt;GetMedian();}
226      if (GetSumCsptLast6D(RecN)==-1){
227        GetSumCsptLast6D(RecN)=DowMomV[(RecDowN+7-6)%7]-&gt;GetMedian();}
228      if (GetCsptLast1W(RecN)==-1){
229        GetCsptLast1W(RecN)=DowHourMomVV.At(RecDowN, RecHourN)-&gt;GetMedian();}
230      if (GetCsptLast2W(RecN)==-1){
231        GetCsptLast2W(RecN)=DowHourMomVV.At(RecDowN, RecHourN)-&gt;GetMedian();}
232      if (GetCsptLast3W(RecN)==-1){
233        GetCsptLast3W(RecN)=DowHourMomVV.At(RecDowN, RecHourN)-&gt;GetMedian();}
234      if (GetSumCsptLast1W(RecN)==-1){
235        GetSumCsptLast1W(RecN)=DowMomV[RecDowN]-&gt;GetMedian();}
236      if (GetSumCsptLast2W(RecN)==-1){
237        GetSumCsptLast2W(RecN)=DowMomV[RecDowN]-&gt;GetMedian();}
238      if (GetSumCsptLast3W(RecN)==-1){
239        GetSumCsptLast3W(RecN)=DowMomV[RecDowN]-&gt;GetMedian();}
240    }
241  }
242  void TGasLtpBs::SaveStatTxt(const PSOut&amp; SOut) const {
243    SOut-&gt;PutStr(&quot;==========================================================&quot;);
244    SOut-&gt;PutLn();
245    SOut-&gt;PutStr(LtpNm); SOut-&gt;PutStr(&quot;  /  &quot;);
246    SOut-&gt;PutStr(LocNm); SOut-&gt;PutStr(&quot;  /  &quot;);
247    SOut-&gt;PutStr(ProdNm); SOut-&gt;PutLn();
248    SOut-&gt;PutStr(&quot;Consumption per Hour&quot;);
249    SOut-&gt;PutLn();
250    for (int HourN=0; HourN&lt;24; HourN++){
251      SOut-&gt;PutInt(HourN); SOut-&gt;PutStr(&quot;: &quot;);
252      SOut-&gt;PutStr(HourMomV[HourN]-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true));
253      SOut-&gt;PutLn();
254    }
255    SOut-&gt;PutStr(&quot;Consumption per Day-Of-Week&quot;);
256    SOut-&gt;PutLn();
257    for (int DowN=0; DowN&lt;7; DowN++){
258      SOut-&gt;PutStr(TTmInfo::GetDayOfWeekNm(DowN+1)); SOut-&gt;PutStr(&quot;: &quot;);
259      SOut-&gt;PutStr(DowMomV[DowN]-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true));
260      SOut-&gt;PutLn();
261    }
262    SOut-&gt;PutStr(&quot;Consumption per Month&quot;);
263    SOut-&gt;PutLn();
264    for (int MonthN=0; MonthN&lt;12; MonthN++){
265      SOut-&gt;PutStr(TTmInfo::GetMonthNm(MonthN+1)); SOut-&gt;PutStr(&quot;: &quot;);
266      SOut-&gt;PutStr(MonthMomV[MonthN]-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true));
267      SOut-&gt;PutLn();
268    }
269    SOut-&gt;PutStr(&quot;Consumption per Day-Of-Week&amp;Hour&quot;);
270    SOut-&gt;PutLn();
271    {for (int DowN=0; DowN&lt;7; DowN++){
272      for (int HourN=0; HourN&lt;24; HourN++){
273        SOut-&gt;PutStr(TTmInfo::GetDayOfWeekNm(DowN+1)); SOut-&gt;PutStr(&quot;/&quot;);
274        SOut-&gt;PutInt(HourN); SOut-&gt;PutStr(&quot;: &quot;);
275        SOut-&gt;PutStr(DowHourMomVV.At(DowN, HourN)-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true));
276        SOut-&gt;PutLn();
277      }
278    }}
279    SOut-&gt;Flush();
280  }
281  void TGasLtpBs::SaveStatBin(const PSOut&amp; SOut) const {
282    PGasLtpBs StatLtpBs=TGasLtpBs::New(LtpNm, LocNm, ProdNm);
283    StatLtpBs-&gt;HourMomV=HourMomV;
284    StatLtpBs-&gt;DowMomV=DowMomV;
285    StatLtpBs-&gt;MonthMomV=MonthMomV;
286    StatLtpBs-&gt;DowHourMomVV=DowHourMomVV;
287    StatLtpBs-&gt;Save(*SOut);
288    SOut-&gt;Flush();
289  }
290  void TGasLtpBs::LoadStatV(const TStr&amp; FNm, TGasLtpBsV&amp; GasLtpBsV){
291    GasLtpBsV.Clr();
292    if (TFile::Exists(FNm)){
293      PSIn SIn=TFIn::New(FNm);
294      while (!SIn-&gt;Eof()){
295        PGasLtpBs GasLtpBs=TGasLtpBs::Load(*SIn);
296        GasLtpBsV.Add(GasLtpBs);
297      }
298    }
299  }
300  void TGasLtpBs::ConvTabToLtp(const TStr&amp; InTabFNmWc, const TStr&amp; OutLtpFPath,
301   const bool&amp; RepairUnknownsP){
302    PGasDef GasDef=TGasDef::New();
303    TStr OutLtpNrFPath=TStr::GetNrFPath(OutLtpFPath);
304    PGasLtpBs GasLtpBs; TStr LtpNm; TSecTm PrevLtpTm;
305    PSOut LtpStatTxtSOut=TFOut::New(OutLtpNrFPath+LtpStatTxtFNm);
306    PSOut LtpStatBinSOut=TFOut::New(OutLtpNrFPath+LtpStatBinFNm);
307    TFFile FFile(InTabFNmWc, false); TStr FNm; int Recs=0;
308    while (FFile.Next(FNm)){
309      printf(&quot;Processing file &#x27;%s&#x27;\n&quot;, FNm.CStr());
310      PSIn SIn=TFIn::New(FNm);
311      char PrevCh=&#x27; &#x27;; TStrV FldNmV;
312      TSs::LoadTxtFldV(ssfTabSep, SIn, PrevCh, FldNmV);
313      EAssertR(GasDef-&gt;IsFldNmVOk(FldNmV), TStr(&quot;Field names don&#x27;t fit in &quot;)+FNm);
314      int LnN=0;
315      while (!SIn-&gt;Eof()){
316        char PrevCh=&#x27; &#x27;; TStrV FldStrValV;
317        TSs::LoadTxtFldV(ssfTabSep, SIn, PrevCh, FldStrValV); LnN++;
318        if (LtpNm!=GasDef-&gt;GetLtpNm(FldStrValV)){
319          if (!GasLtpBs.Empty()){
320            GasLtpBs-&gt;GenStat();
321            if (RepairUnknownsP){GasLtpBs-&gt;RepairUnknowns();}
322            GasLtpBs-&gt;SaveStatTxt(LtpStatTxtSOut);
323            GasLtpBs-&gt;SaveStatBin(LtpStatBinSOut);
324            TStr LtpFNm=OutLtpNrFPath+GasDef-&gt;GetLtpFNm(LtpNm);
325            {TFOut LtpSOut(LtpFNm); GasLtpBs-&gt;Save(LtpSOut);}
326            PGasLtpBs NewGasLtpBs=TGasLtpBs::Load(LtpFNm);
327          }
328          LtpNm=GasDef-&gt;GetLtpNm(FldStrValV);
329          TStr LocNm=GasDef-&gt;GetLocNm(FldStrValV);
330          TStr ProdNm=GasDef-&gt;GetProdNm(FldStrValV);
331          GasLtpBs=TGasLtpBs::New(LtpNm, LocNm, ProdNm, GasDef);
332          PrevLtpTm.Undef();
333          printf(&quot;Processing Ltp: &#x27;%s&#x27; &#x27;%s&#x27; &#x27;%s&#x27;\n&quot;,
334           LtpNm.CStr(), LocNm.CStr(), ProdNm.CStr());
335        }
336        TIntV&amp; FldIntValV=GasLtpBs-&gt;AddRec();
337        GasDef-&gt;GetFldIntValV(FldStrValV, FldIntValV);
338        TSecTm LtpTm=GasDef-&gt;GetTm(FldIntValV);
339        if (PrevLtpTm.IsDef()){
340          if (PrevLtpTm&gt;=LtpTm){
341            printf(&quot;Time is not increasing [Line:%d PrevTime:%s CurTime:%s]\n&quot;,
342             LnN, PrevLtpTm.GetStr().CStr(), LtpTm.GetStr().CStr());
343          }
344          if (TSecTm::GetDSecs(PrevLtpTm, LtpTm)!=3600){
345            printf(&quot;Not one hour difference between subsequent records &quot;
346             &quot;[Line:%d PrevTime:%s CurTime:%s]\n&quot;,
347             LnN, PrevLtpTm.GetStr().CStr(), LtpTm.GetStr().CStr());
348          }
349          EAssertR(PrevLtpTm&lt;LtpTm, &quot;Records not in increased time sequence.&quot;);
350        }
351        PrevLtpTm=LtpTm;
352        Recs++; if (Recs%1000==0){printf(&quot;%d\r&quot;, Recs);}
353      }
354    }
355    if (!GasLtpBs.Empty()){
356      GasLtpBs-&gt;GenStat();
357      if (RepairUnknownsP){GasLtpBs-&gt;RepairUnknowns();}
358      GasLtpBs-&gt;SaveStatTxt(LtpStatTxtSOut);
359      GasLtpBs-&gt;SaveStatBin(LtpStatBinSOut);
360      TStr LtpFNm=OutLtpNrFPath+GasDef-&gt;GetLtpFNm(LtpNm);
361      {TFOut LtpSOut(LtpFNm); GasLtpBs-&gt;Save(LtpSOut);}
362      PGasLtpBs NewGasLtpBs=TGasLtpBs::Load(LtpFNm);
363    }
364  }
365  const TStr TGasLtpBs::LtpStatTxtFNm=&quot;LtpStat.Txt&quot;;
366  const TStr TGasLtpBs::LtpStatBinFNm=&quot;LtpStat.Dat&quot;;
367  int TGasDm::AddVar(const TStr&amp; VarNm, const TStr&amp; VarTy){
368    IAssert((!VarNmTyKdV.IsIn(TStrKd(VarNm)))&amp;&amp;(VarValVV.Empty()));
369    int VarN=VarNmTyKdV.Add(TStrKd(VarNm, VarTy));
370    if (VarTy==&quot;class&quot;){IAssert(ClassVarN==-1); ClassVarN=VarN;}
371    if (VarTy==&quot;date&quot;){IAssert(DateVarN==-1); DateVarN=VarN;}
372    if (VarTy==&quot;volume&quot;){IAssert(VolVarN==-1); VolVarN=VarN;}
373    if (VarTy==&quot;attr&quot;){Attrs++;}
374    return VarN;
375  }
376  void TGasDm::GetAttrNmV(TStrV&amp; AttrNmV) const {
377    AttrNmV.Gen(Attrs, 0);
378    for (int VarN=0; VarN&lt;GetVars(); VarN++){
379      if (GetVarTy(VarN)==&quot;attr&quot;){
380        AttrNmV.Add(GetVarNm(VarN));
381      }
382    }
383  }
384  int TGasDm::GetAttrN(const TStr&amp; AttrNm) const {
385    TStrV AttrNmV; GetAttrNmV(AttrNmV);
386    return AttrNmV.SearchForw(AttrNm);
387  }
388  TStr TGasDm::GetClassNm() const {
389    for (int VarN=0; VarN&lt;GetVars(); VarN++){
390      if (GetVarTy(VarN)==&quot;class&quot;){
391        return GetVarNm(VarN);
392      }
393    }
394    Fail;
395    return TStr();
396  }
397  void TGasDm::GetRecNV(
398   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
399   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt, TIntV&amp; RecNV){
400    if ((StartDate.IsDef()&amp;&amp;EndDate.IsDef())){
401      IAssert((StartRecN==-1)&amp;&amp;(EndRecN==-1));
402      RecNV.Clr(); int Recs=GetRecs();
403      for (int RecN=0; RecN&lt;Recs; RecN++){
404        TSecTm RecDate=GetDateVal(RecN);
405        if ((StartDate.IsDef()&amp;&amp;(RecDate&lt;StartDate))||
406         (EndDate.IsDef()&amp;&amp;(EndDate&lt;RecDate))){continue;}
407        if ((MnCspt!=-1)&amp;&amp;(GetClassVal(RecN)&lt;MnCspt)){continue;}
408        RecNV.Add(RecN);
409      }
410    } else
411    if ((StartRecN!=-1)&amp;&amp;(EndRecN!=-1)){
412      IAssert((!StartDate.IsDef())&amp;&amp;(!EndDate.IsDef()));
413      RecNV.Clr();
414      for (int RecN=StartRecN; RecN&lt;=EndRecN; RecN++){
415        RecNV.Add(RecN);
416      }
417    } else {
418      Fail;
419    }
420  }
421  void TGasDm::GetAttrValV(const int&amp; RecN, TFltV&amp; AttrValV) const {
422    AttrValV.Gen(Attrs, 0);
423    for (int VarN=0; VarN&lt;GetVars(); VarN++){
424      if (GetVarTy(VarN)==&quot;attr&quot;){
425        AttrValV.Add(VarValVV[RecN][VarN]);
426      }
427    }
428  }
429  double TGasDm::GetAttrVal(
430   const int&amp; RecN, const int&amp; AttrN, const double&amp; DfVal) const {
431    TFltV AttrValV; GetAttrValV(RecN, AttrValV);
432    if (AttrN==-1){return DfVal;}
433    else {return AttrValV[AttrN];}
434  }
435  double TGasDm::GetAttrVal(
436   const int&amp; RecN, const TStr&amp; AttrNm, const double&amp; DfVal) const {
437    TFltV AttrValV; GetAttrValV(RecN, AttrValV);
438    int AttrN=GetAttrN(AttrNm);
439    if (AttrN==-1){return DfVal;}
440    else {return AttrValV[AttrN];}
441  }
442  TStr TGasDm::GetBitsStr(const int&amp; RecN) const {
443    double IsHolidayVal=GetAttrVal(RecN, &quot;IsHoliday&quot;, 0);
444    double IsHolidayStartVal=GetAttrVal(RecN, &quot;IsHolidayStart&quot;, 0);
445    double IsHolidayEndVal=GetAttrVal(RecN, &quot;IsHolidayEnd&quot;, 0);
446    double IsDayBeforeHolidayVal=GetAttrVal(RecN, &quot;IsDayBeforeHoliday&quot;, 0);
447    double IsDayAfterHolidayVal=GetAttrVal(RecN, &quot;IsDayAfterHoliday&quot;, 0);
448    double PriceChangeVal=GetAttrVal(RecN, &quot;PriceChange&quot;, 0);
449    double DaysBeforePriceChangeVal=GetAttrVal(RecN, &quot;DaysBeforePriceChange&quot;, 0);
450    TChA ChA;
451    if (IsHolidayVal!=0){ChA+=&quot; IsHoliday&quot;;}
452    if (IsHolidayStartVal!=0){ChA+=&quot; IsHolidayStart&quot;;}
453    if (IsHolidayEndVal!=0){ChA+=&quot; IsHolidayEnd&quot;;}
454    if (IsDayBeforeHolidayVal!=0){ChA+=&quot; IsDayBeforeHoliday&quot;;}
455    if (IsDayAfterHolidayVal!=0){ChA+=&quot; IsDayAfterHoliday&quot;;}
456    if (PriceChangeVal!=0){ChA+=&quot; PriceChange:&quot;; ChA+=TFlt::GetStr(PriceChangeVal);}
457    if (DaysBeforePriceChangeVal!=0){
458      ChA+=&quot; DaysBeforePriceChange:&quot;; ChA+=TFlt::GetStr(DaysBeforePriceChangeVal);
459      if (RecN+1&lt;GetRecs()){
460        ChA+=TFlt::GetStr(GetAttrVal(RecN+1, &quot;PriceChange&quot;, 0), &quot;(%g%%)&quot;);}
461    }
462    return ChA;
463  }
464  PGasDm TGasDm::GetWeekGasDm(const PGasLtpBs&amp; GasLtpBs){
465    TIntIntH DayNToCsptH;
466    for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
467      int DayN=GasLtpBs-&gt;GetDateInt(RecN);
468      DayNToCsptH.AddDat(DayN)+=GasLtpBs-&gt;GetCspt(RecN);
469    }
470    TSecTm MnLtpDate=GasLtpBs-&gt;GetMnDate();
471    TSecTm MxLtpDate=GasLtpBs-&gt;GetMxDate();
472    typedef TKeyDat&lt;TSecTm, TInt&gt; TDateCsptKd;
473    TVec&lt;TDateCsptKd&gt; DateCsptKdV;
474    for (TSecTm LtpDate=MnLtpDate; LtpDate&lt;MxLtpDate; LtpDate.AddDays(1)){
475      int DayN=LtpDate.GetAbsSecs();
476      if (!DayNToCsptH.IsKey(DayN)){continue;}
477      int Cspt=DayNToCsptH.GetDat(DayN);
478      if (LtpDate.GetDayOfWeekN()==TTmInfo::SunN){
479        DateCsptKdV.Add(TDateCsptKd(LtpDate, 0));}
480      if (DateCsptKdV.Len()&gt;0){
481        DateCsptKdV.Last().Dat+=Cspt;}
482    }
483    PGasDm GasDm=TGasDm::New(&quot;Week&quot;);
484    GasDm-&gt;PutLtpNm(GasLtpBs-&gt;GetLtpNm());
485    GasDm-&gt;PutLocNm(GasLtpBs-&gt;GetLocNm());
486    GasDm-&gt;PutProdNm(GasLtpBs-&gt;GetProdNm());
487    GasDm-&gt;AddVar(&quot;Date&quot;, &quot;date&quot;);
488    GasDm-&gt;AddVar(&quot;Cspt&quot;, &quot;class&quot;);
489    GasDm-&gt;AddVar(&quot;Const&quot;, &quot;attr&quot;);
490    GasDm-&gt;AddVar(&quot;Month&quot;, &quot;attr&quot;);
491    GasDm-&gt;AddVar(&quot;SumCsptLast1W&quot;, &quot;attr&quot;);
492    GasDm-&gt;AddVar(&quot;SumCsptLast2W&quot;, &quot;attr&quot;);
493    GasDm-&gt;AddVar(&quot;SumCsptLast3W&quot;, &quot;attr&quot;);
494    GasDm-&gt;AddVar(&quot;SumCsptLast1D&quot;, &quot;attr&quot;);
495    GasDm-&gt;AddVar(&quot;SumCsptLast2D&quot;, &quot;attr&quot;);
496    GasDm-&gt;AddVar(&quot;SumCsptLast3D&quot;, &quot;attr&quot;);
497    GasDm-&gt;AddVar(&quot;SumCsptLast4D&quot;, &quot;attr&quot;);
498    GasDm-&gt;AddVar(&quot;SumCsptLast5D&quot;, &quot;attr&quot;);
499    GasDm-&gt;AddVar(&quot;SumCsptLast6D&quot;, &quot;attr&quot;);
500    GasDm-&gt;AddVar(&quot;Volume&quot;, &quot;volume&quot;);
501    {for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
502      TSecTm Date=TSecTm(GasLtpBs-&gt;GetDateInt(RecN));
503      int DateCsptKdN=DateCsptKdV.SearchForw(TDateCsptKd(Date));
504      if (DateCsptKdN==-1){continue;}
505      double Cspt=DateCsptKdV[DateCsptKdN].Dat;
506      if (Cspt==-1){continue;}
507      else {DateCsptKdV[DateCsptKdN].Dat=-1;}
508      TFltV VarValV(GasDm-&gt;GetVars(), 0);
509      VarValV.Add(GasLtpBs-&gt;GetDateInt(RecN));
510      VarValV.Add(Cspt);
511      VarValV.Add(1);
512      VarValV.Add(GasLtpBs-&gt;GetMonthN(RecN));
513      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast1W(RecN)));
514      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast2W(RecN)));
515      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast3W(RecN)));
516      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast1D(RecN)));
517      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast2D(RecN)));
518      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast3D(RecN)));
519      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast4D(RecN)));
520      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast5D(RecN)));
521      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast6D(RecN)));
522      if (VarValV.IsIn(-1)){
523        printf(&quot;Ignoring %s\n&quot;, GasLtpBs-&gt;GetTm(RecN).GetStr().CStr()); continue;}
524      VarValV.Add(GasLtpBs-&gt;GetVol(RecN));
525      GasDm-&gt;AddRec(VarValV);
526    }}
527    return GasDm;
528  }
529  PGasDm TGasDm::GetDayGasDm(const PGasLtpBs&amp; GasLtpBs){
530    TIntIntH DayNToCsptH;
531    for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
532      int DayN=GasLtpBs-&gt;GetDateInt(RecN);
533      DayNToCsptH.AddDat(DayN)+=GasLtpBs-&gt;GetCspt(RecN);
534    }
535    PGasDm GasDm=TGasDm::New(&quot;Day&quot;);
536    GasDm-&gt;PutLtpNm(GasLtpBs-&gt;GetLtpNm());
537    GasDm-&gt;PutLocNm(GasLtpBs-&gt;GetLocNm());
538    GasDm-&gt;PutProdNm(GasLtpBs-&gt;GetProdNm());
539    GasDm-&gt;AddVar(&quot;Date&quot;, &quot;date&quot;);
540    GasDm-&gt;AddVar(&quot;Cspt&quot;, &quot;class&quot;);
541    GasDm-&gt;AddVar(&quot;Const&quot;, &quot;attr&quot;);
542    GasDm-&gt;AddVar(&quot;Dow&quot;, &quot;attr&quot;);
543    GasDm-&gt;AddVar(&quot;Month&quot;, &quot;attr&quot;);
544    GasDm-&gt;AddVar(&quot;SumCsptLast1W&quot;, &quot;attr&quot;);
545    GasDm-&gt;AddVar(&quot;SumCsptLast2W&quot;, &quot;attr&quot;);
546    GasDm-&gt;AddVar(&quot;SumCsptLast3W&quot;, &quot;attr&quot;);
547    GasDm-&gt;AddVar(&quot;SumCsptLast1D&quot;, &quot;attr&quot;);
548    GasDm-&gt;AddVar(&quot;SumCsptLast2D&quot;, &quot;attr&quot;);
549    GasDm-&gt;AddVar(&quot;SumCsptLast3D&quot;, &quot;attr&quot;);
550    GasDm-&gt;AddVar(&quot;SumCsptLast4D&quot;, &quot;attr&quot;);
551    GasDm-&gt;AddVar(&quot;SumCsptLast5D&quot;, &quot;attr&quot;);
552    GasDm-&gt;AddVar(&quot;SumCsptLast6D&quot;, &quot;attr&quot;);
553    GasDm-&gt;AddVar(&quot;IsHoliday&quot;, &quot;attr&quot;);
554    GasDm-&gt;AddVar(&quot;IsHolidayStart&quot;, &quot;attr&quot;);
555    GasDm-&gt;AddVar(&quot;IsHolidayEnd&quot;, &quot;attr&quot;);
556    GasDm-&gt;AddVar(&quot;IsDayBeforeHoliday&quot;, &quot;attr&quot;);
557    GasDm-&gt;AddVar(&quot;IsDayAfterHoliday&quot;, &quot;attr&quot;);
558    GasDm-&gt;AddVar(&quot;PriceChange&quot;, &quot;attr&quot;);
559    GasDm-&gt;AddVar(&quot;DaysBeforePriceChange&quot;, &quot;attr&quot;);
560    GasDm-&gt;AddVar(&quot;Volume&quot;, &quot;volume&quot;);
561    {for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
562      double Cspt=DayNToCsptH.GetDat(GasLtpBs-&gt;GetDateInt(RecN));
563      if (Cspt==-1){continue;}
564      else {DayNToCsptH.GetDat(GasLtpBs-&gt;GetDateInt(RecN))=-1;}
565      TFltV VarValV(GasDm-&gt;GetVars(), 0);
566      VarValV.Add(GasLtpBs-&gt;GetDateInt(RecN));
567      VarValV.Add(Cspt);
568      VarValV.Add(1);
569      VarValV.Add(GasLtpBs-&gt;GetDowN(RecN));
570      VarValV.Add(GasLtpBs-&gt;GetMonthN(RecN));
571      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast1W(RecN)));
572      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast2W(RecN)));
573      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast3W(RecN)));
574      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast1D(RecN)));
575      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast2D(RecN)));
576      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast3D(RecN)));
577      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast4D(RecN)));
578      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast5D(RecN)));
579      VarValV.Add(TFlt(GasLtpBs-&gt;GetSumCsptLast6D(RecN)));
580      if (VarValV.IsIn(-1)){
581        printf(&quot;Ignoring %s\n&quot;, GasLtpBs-&gt;GetTm(RecN).GetStr().CStr()); continue;}
582      VarValV.Add(GasLtpBs-&gt;GetIsHoliday(RecN));
583      VarValV.Add(GasLtpBs-&gt;GetIsHolidayStart(RecN));
584      VarValV.Add(GasLtpBs-&gt;GetIsHolidayEnd(RecN));
585      VarValV.Add(GasLtpBs-&gt;GetIsDayBeforeHoliday(RecN));
586      VarValV.Add(GasLtpBs-&gt;GetIsDayAfterHoliday(RecN));
587      VarValV.Add(GasLtpBs-&gt;GetPriceChange(RecN));
588      VarValV.Add(GasLtpBs-&gt;GetDaysBeforePriceChange(RecN));
589      VarValV.Add(GasLtpBs-&gt;GetVol(RecN));
590      GasDm-&gt;AddRec(VarValV);
591    }}
592    return GasDm;
593  }
594  void TGasDm::AddCsptBlock(
595   TIntIntH&amp; HourNToCsptH, const int&amp; BlockN, const int&amp; Cspt){
596    if ((!HourNToCsptH.IsKey(BlockN))||(HourNToCsptH.GetDat(BlockN)!=-1)){
597      if (Cspt==-1){
598        HourNToCsptH.AddDat(BlockN)=-1;
599      } else {
600        HourNToCsptH.AddDat(BlockN)=Cspt;
601      }
602    }
603  }
604  PGasDm TGasDm::GetHourBlockGasDm(const PGasLtpBs&amp; GasLtpBs, const int&amp; HourBlockLen){
605    EAssertRA(24%HourBlockLen==0, &quot;Hour resulution not divisible by 24&quot;, TInt::GetStr(HourBlockLen));
606    TIntIntH BlockNToCsptH;
607    TIntIntH BlockNToCsptLast1WH;
608    TIntIntH BlockNToCsptLast2WH;
609    TIntIntH BlockNToCsptLast3WH;
610    TIntIntH BlockNToCsptLast1DH;
611    TIntIntH BlockNToCsptLast2DH;
612    TIntIntH BlockNToCsptLast3DH;
613    TIntIntH BlockNToCsptLast4DH;
614    TIntIntH BlockNToCsptLast5DH;
615    TIntIntH BlockNToCsptLast6DH;
616    for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
617      int DayN=GasLtpBs-&gt;GetDateInt(RecN); IAssert(DayN%100==0);
618      int HourN=GasLtpBs-&gt;GetHourN(RecN);
619      IAssert((0&lt;=HourN)&amp;&amp;(HourN&lt;24));
620      int BlockN=DayN+(HourN/HourBlockLen)*HourBlockLen;
621      BlockNToCsptH.AddDat(BlockN)+=GasLtpBs-&gt;GetCspt(RecN);
622      AddCsptBlock(BlockNToCsptLast1WH, BlockN, GasLtpBs-&gt;GetCsptLast1W(RecN));
623      AddCsptBlock(BlockNToCsptLast2WH, BlockN, GasLtpBs-&gt;GetCsptLast2W(RecN));
624      AddCsptBlock(BlockNToCsptLast3WH, BlockN, GasLtpBs-&gt;GetCsptLast3W(RecN));
625      AddCsptBlock(BlockNToCsptLast1DH, BlockN, GasLtpBs-&gt;GetCsptLast1D(RecN));
626      AddCsptBlock(BlockNToCsptLast2DH, BlockN, GasLtpBs-&gt;GetCsptLast2D(RecN));
627      AddCsptBlock(BlockNToCsptLast3DH, BlockN, GasLtpBs-&gt;GetCsptLast3D(RecN));
628      AddCsptBlock(BlockNToCsptLast4DH, BlockN, GasLtpBs-&gt;GetCsptLast4D(RecN));
629      AddCsptBlock(BlockNToCsptLast5DH, BlockN, GasLtpBs-&gt;GetCsptLast5D(RecN));
630      AddCsptBlock(BlockNToCsptLast6DH, BlockN, GasLtpBs-&gt;GetCsptLast6D(RecN));
631    }
632    PGasDm GasDm=TGasDm::New(TStr(&quot;Hour&quot;)+TInt::GetStr(HourBlockLen));
633    GasDm-&gt;PutLtpNm(GasLtpBs-&gt;GetLtpNm());
634    GasDm-&gt;PutLocNm(GasLtpBs-&gt;GetLocNm());
635    GasDm-&gt;PutProdNm(GasLtpBs-&gt;GetProdNm());
636    GasDm-&gt;AddVar(&quot;Date&quot;, &quot;date&quot;); 
637    GasDm-&gt;AddVar(&quot;Cspt&quot;, &quot;class&quot;); 
638    GasDm-&gt;AddVar(&quot;Const&quot;, &quot;attr&quot;); 
639    GasDm-&gt;AddVar(&quot;Hour&quot;, &quot;attr&quot;); 
640    GasDm-&gt;AddVar(&quot;Dow&quot;, &quot;attr&quot;); 
641    GasDm-&gt;AddVar(&quot;Month&quot;, &quot;attr&quot;); 
642    GasDm-&gt;AddVar(&quot;CsptLast1W&quot;, &quot;attr&quot;);
643    GasDm-&gt;AddVar(&quot;CsptLast2W&quot;, &quot;attr&quot;);
644    GasDm-&gt;AddVar(&quot;CsptLast3W&quot;, &quot;attr&quot;);
645    GasDm-&gt;AddVar(&quot;CsptLast1D&quot;, &quot;attr&quot;);
646    GasDm-&gt;AddVar(&quot;CsptLast2D&quot;, &quot;attr&quot;);
647    GasDm-&gt;AddVar(&quot;CsptLast3D&quot;, &quot;attr&quot;);
648    GasDm-&gt;AddVar(&quot;CsptLast4D&quot;, &quot;attr&quot;);
649    GasDm-&gt;AddVar(&quot;CsptLast5D&quot;, &quot;attr&quot;);
650    GasDm-&gt;AddVar(&quot;CsptLast6D&quot;, &quot;attr&quot;);
651    GasDm-&gt;AddVar(&quot;IsHoliday&quot;, &quot;attr&quot;);
652    GasDm-&gt;AddVar(&quot;Volume&quot;, &quot;volume&quot;);
653    {for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
654      int DayN=GasLtpBs-&gt;GetDateInt(RecN); IAssert(DayN%100==0);
655      int HourN=GasLtpBs-&gt;GetHourN(RecN);
656      IAssert((0&lt;=HourN)&amp;&amp;(HourN&lt;24));
657      int BlockN=DayN+(HourN/HourBlockLen)*HourBlockLen;
658      int BlockHourN=BlockN%100;
659      double Cspt=BlockNToCsptH.GetDat(BlockN);
660      if (Cspt==-1){continue;}
661      else {BlockNToCsptH.GetDat(BlockN)=-1;}
662      TFltV VarValV(GasDm-&gt;GetVars(), 0);
663      VarValV.Add(GasLtpBs-&gt;GetDateInt(RecN)); 
664      VarValV.Add(Cspt); 
665      VarValV.Add(1); 
666      VarValV.Add(BlockHourN); 
667      VarValV.Add(GasLtpBs-&gt;GetDowN(RecN)); 
668      VarValV.Add(GasLtpBs-&gt;GetMonthN(RecN)); 
669      VarValV.Add(int(BlockNToCsptLast1WH.GetDat(BlockN))); 
670      VarValV.Add(int(BlockNToCsptLast2WH.GetDat(BlockN))); 
671      VarValV.Add(int(BlockNToCsptLast3WH.GetDat(BlockN))); 
672      VarValV.Add(int(BlockNToCsptLast1DH.GetDat(BlockN))); 
673      VarValV.Add(int(BlockNToCsptLast2DH.GetDat(BlockN))); 
674      VarValV.Add(int(BlockNToCsptLast3DH.GetDat(BlockN))); 
675      VarValV.Add(int(BlockNToCsptLast4DH.GetDat(BlockN))); 
676      VarValV.Add(int(BlockNToCsptLast5DH.GetDat(BlockN))); 
677      VarValV.Add(int(BlockNToCsptLast6DH.GetDat(BlockN))); 
678      VarValV.Add(GasLtpBs-&gt;GetIsHoliday(RecN));
679      if (VarValV.IsIn(-1)){
680        printf(&quot;Ignoring %s\n&quot;, GasLtpBs-&gt;GetTm(RecN).GetStr().CStr()); continue;}
681      VarValV.Add(GasLtpBs-&gt;GetVol(RecN));
682      GasDm-&gt;AddRec(VarValV);
683    }}
684    return GasDm;
685  }
686  PGasDm TGasDm::GetHourGasDm(const PGasLtpBs&amp; GasLtpBs){
687    PGasDm GasDm=TGasDm::New();
688    GasDm-&gt;PutLtpNm(GasLtpBs-&gt;GetLtpNm());
689    GasDm-&gt;PutLocNm(GasLtpBs-&gt;GetLocNm());
690    GasDm-&gt;PutProdNm(GasLtpBs-&gt;GetProdNm());
691    GasDm-&gt;AddVar(&quot;Date&quot;, &quot;date&quot;); 
692    GasDm-&gt;AddVar(&quot;Cspt&quot;, &quot;class&quot;); 
693    GasDm-&gt;AddVar(&quot;Const&quot;, &quot;attr&quot;); 
694    GasDm-&gt;AddVar(&quot;Hour&quot;, &quot;attr&quot;); 
695    GasDm-&gt;AddVar(&quot;Dow&quot;, &quot;attr&quot;); 
696    GasDm-&gt;AddVar(&quot;Month&quot;, &quot;attr&quot;); 
697    GasDm-&gt;AddVar(&quot;CsptLast1W&quot;, &quot;attr&quot;);
698    GasDm-&gt;AddVar(&quot;CsptLast2W&quot;, &quot;attr&quot;);
699    GasDm-&gt;AddVar(&quot;CsptLast3W&quot;, &quot;attr&quot;);
700    GasDm-&gt;AddVar(&quot;CsptLast1D&quot;, &quot;attr&quot;);
701    GasDm-&gt;AddVar(&quot;CsptLast2D&quot;, &quot;attr&quot;);
702    GasDm-&gt;AddVar(&quot;CsptLast3D&quot;, &quot;attr&quot;);
703    GasDm-&gt;AddVar(&quot;IsHoliday&quot;, &quot;attr&quot;);
704    GasDm-&gt;AddVar(&quot;Volume&quot;, &quot;volume&quot;);
705    for (int RecN=0; RecN&lt;GasLtpBs-&gt;GetRecs(); RecN++){
706      TFltV VarValV(GasDm-&gt;GetVars(), 0);
707      VarValV.Add(GasLtpBs-&gt;GetDateInt(RecN)); 
708      VarValV.Add(GasLtpBs-&gt;GetCspt(RecN)); 
709      VarValV.Add(1); 
710      VarValV.Add(GasLtpBs-&gt;GetHourN(RecN)); 
711      VarValV.Add(GasLtpBs-&gt;GetDowN(RecN)); 
712      VarValV.Add(GasLtpBs-&gt;GetMonthN(RecN)); 
713      VarValV.Add(TFlt(GasLtpBs-&gt;GetCsptLast1W(RecN)));
714      VarValV.Add(TFlt(GasLtpBs-&gt;GetCsptLast2W(RecN)));
715      VarValV.Add(TFlt(GasLtpBs-&gt;GetCsptLast3W(RecN)));
716      VarValV.Add(TFlt(GasLtpBs-&gt;GetCsptLast1D(RecN)));
717      VarValV.Add(TFlt(GasLtpBs-&gt;GetCsptLast2D(RecN)));
718      VarValV.Add(TFlt(GasLtpBs-&gt;GetCsptLast3D(RecN)));
719      VarValV.Add(GasLtpBs-&gt;GetIsHoliday(RecN));
720      if (VarValV.IsIn(-1)){
721        printf(&quot;Ignoring %s\n&quot;, GasLtpBs-&gt;GetTm(RecN).GetStr().CStr()); continue;}
722      VarValV.Add(GasLtpBs-&gt;GetVol(RecN));
723      GasDm-&gt;AddRec(VarValV);
724    }
725    return GasDm;
726  }
727  int TGasDm::AddWeekRec(const double&amp; Cspt){
728    IAssert(TypeNm==&quot;Week&quot;);
729    TSecTm PrevDt=GetDateVal(GetRecs()-1);
730    TSecTm TodayDt=TSecTm(PrevDt).AddDays(+7);
731    int TodayRecN=AddRec();
732    if (TodayRecN&lt;=21){
733      TExcept::Throw(&quot;Not enough past data - cannot calculate future records.&quot;);}
734    PutVarVal(TodayRecN, &quot;Date&quot;, TodayDt.GetAbsSecs());
735    PutVarVal(TodayRecN, &quot;Cspt&quot;, Cspt);
736    PutVarVal(TodayRecN, &quot;Const&quot;, 1);
737    PutVarVal(TodayRecN, &quot;Month&quot;, TodayDt.GetMonthN());
738    PutVarVal(TodayRecN, &quot;SumCsptLast1W&quot;, GetVarVal(TodayRecN-7, &quot;Cspt&quot;));
739    PutVarVal(TodayRecN, &quot;SumCsptLast2W&quot;, GetVarVal(TodayRecN-14, &quot;Cspt&quot;));
740    PutVarVal(TodayRecN, &quot;SumCsptLast3W&quot;, GetVarVal(TodayRecN-21, &quot;Cspt&quot;));
741    PutVarVal(TodayRecN, &quot;SumCsptLast1D&quot;, GetVarVal(TodayRecN-1, &quot;Cspt&quot;));
742    PutVarVal(TodayRecN, &quot;SumCsptLast2D&quot;, GetVarVal(TodayRecN-2, &quot;Cspt&quot;));
743    PutVarVal(TodayRecN, &quot;SumCsptLast3D&quot;, GetVarVal(TodayRecN-3, &quot;Cspt&quot;));
744    PutVarVal(TodayRecN, &quot;SumCsptLast4D&quot;, GetVarVal(TodayRecN-4, &quot;Cspt&quot;));
745    PutVarVal(TodayRecN, &quot;SumCsptLast5D&quot;, GetVarVal(TodayRecN-5, &quot;Cspt&quot;));
746    PutVarVal(TodayRecN, &quot;SumCsptLast6D&quot;, GetVarVal(TodayRecN-6, &quot;Cspt&quot;));
747    PutVarVal(TodayRecN, &quot;Volume&quot;, -1);
748    return TodayRecN;
749  }
750  int TGasDm::AddDayRec(const double&amp; Cspt){
751    IAssert(TypeNm==&quot;Day&quot;);
752    TSecTm PrevDt=GetDateVal(GetRecs()-1);
753    TSecTm TodayDt=TSecTm(PrevDt).AddDays(+1);
754    int TodayRecN=AddRec();
755    if (TodayRecN&lt;=21){
756      TExcept::Throw(&quot;Not enough past data - cannot calculate future records.&quot;);}
757    PutVarVal(TodayRecN, &quot;Date&quot;, TodayDt.GetAbsSecs());
758    PutVarVal(TodayRecN, &quot;Cspt&quot;, Cspt);
759    PutVarVal(TodayRecN, &quot;Const&quot;, 1);
760    PutVarVal(TodayRecN, &quot;Dow&quot;, TodayDt.GetDayOfWeekN());
761    PutVarVal(TodayRecN, &quot;Month&quot;, TodayDt.GetMonthN());
762    PutVarVal(TodayRecN, &quot;SumCsptLast1W&quot;, GetVarVal(TodayRecN-7, &quot;Cspt&quot;));
763    PutVarVal(TodayRecN, &quot;SumCsptLast2W&quot;, GetVarVal(TodayRecN-14, &quot;Cspt&quot;));
764    PutVarVal(TodayRecN, &quot;SumCsptLast3W&quot;, GetVarVal(TodayRecN-21, &quot;Cspt&quot;));
765    PutVarVal(TodayRecN, &quot;SumCsptLast1D&quot;, GetVarVal(TodayRecN-1, &quot;Cspt&quot;));
766    PutVarVal(TodayRecN, &quot;SumCsptLast2D&quot;, GetVarVal(TodayRecN-2, &quot;Cspt&quot;));
767    PutVarVal(TodayRecN, &quot;SumCsptLast3D&quot;, GetVarVal(TodayRecN-3, &quot;Cspt&quot;));
768    PutVarVal(TodayRecN, &quot;SumCsptLast4D&quot;, GetVarVal(TodayRecN-4, &quot;Cspt&quot;));
769    PutVarVal(TodayRecN, &quot;SumCsptLast5D&quot;, GetVarVal(TodayRecN-5, &quot;Cspt&quot;));
770    PutVarVal(TodayRecN, &quot;SumCsptLast6D&quot;, GetVarVal(TodayRecN-6, &quot;Cspt&quot;));
771    PutVarVal(TodayRecN, &quot;IsHoliday&quot;, 0);
772    PutVarVal(TodayRecN, &quot;IsHolidayStart&quot;, 0);
773    PutVarVal(TodayRecN, &quot;IsHolidayEnd&quot;, 0);
774    PutVarVal(TodayRecN, &quot;IsDayBeforeHoliday&quot;, 0);
775    PutVarVal(TodayRecN, &quot;IsDayAfterHoliday&quot;, 0);
776    PutVarVal(TodayRecN, &quot;PriceChange&quot;, 0);
777    PutVarVal(TodayRecN, &quot;DaysBeforePriceChange&quot;, 0);
778    PutVarVal(TodayRecN, &quot;Volume&quot;, -1);
779    return TodayRecN;
780  }
781  int TGasDm::AddHourBlockRec(const double&amp; Cspt){
782    IAssert(TypeNm.IsPrefix(&quot;Hour&quot;));
783    TStr HoursResStr=TypeNm.GetSubStr(TStr(&quot;Hour&quot;).Len(), 999);
784    int HoursRes=HoursResStr.GetInt(1);
785    int RecsPerDay=24/HoursRes;
786    int RecsPerWeek=(7*24)/HoursRes;
787    TSecTm PrevTm=GetDateVal(GetRecs()-1);
788    TSecTm NowTm=TSecTm(PrevTm).AddHours(HoursRes);
789    int NowRecN=AddRec();
790    if (NowRecN&lt;=3*RecsPerWeek){
791      TExcept::Throw(&quot;Not enough past data - cannot calculate future records.&quot;);}
792    PutVarVal(NowRecN, &quot;Date&quot;, NowTm.GetAbsSecs());
793    PutVarVal(NowRecN, &quot;Cspt&quot;, Cspt);
794    PutVarVal(NowRecN, &quot;Const&quot;, 1);
795    PutVarVal(NowRecN, &quot;Hour&quot;, NowTm.GetHourN());
796    PutVarVal(NowRecN, &quot;Dow&quot;, NowTm.GetDayOfWeekN());
797    PutVarVal(NowRecN, &quot;Month&quot;, NowTm.GetMonthN());
798    PutVarVal(NowRecN, &quot;CsptLast1W&quot;, GetVarVal(NowRecN-1*RecsPerWeek, &quot;Cspt&quot;));
799    PutVarVal(NowRecN, &quot;CsptLast2W&quot;, GetVarVal(NowRecN-2*RecsPerWeek, &quot;Cspt&quot;));
800    PutVarVal(NowRecN, &quot;CsptLast3W&quot;, GetVarVal(NowRecN-3*RecsPerWeek, &quot;Cspt&quot;));
801    PutVarVal(NowRecN, &quot;CsptLast1D&quot;, GetVarVal(NowRecN-1*RecsPerDay, &quot;Cspt&quot;));
802    PutVarVal(NowRecN, &quot;CsptLast2D&quot;, GetVarVal(NowRecN-2*RecsPerDay, &quot;Cspt&quot;));
803    PutVarVal(NowRecN, &quot;CsptLast3D&quot;, GetVarVal(NowRecN-3*RecsPerDay, &quot;Cspt&quot;));
804    PutVarVal(NowRecN, &quot;CsptLast4D&quot;, GetVarVal(NowRecN-4*RecsPerDay, &quot;Cspt&quot;));
805    PutVarVal(NowRecN, &quot;CsptLast5D&quot;, GetVarVal(NowRecN-5*RecsPerDay, &quot;Cspt&quot;));
806    PutVarVal(NowRecN, &quot;CsptLast6D&quot;, GetVarVal(NowRecN-6*RecsPerDay, &quot;Cspt&quot;));
807    PutVarVal(NowRecN, &quot;IsHoliday&quot;, 0);
808    PutVarVal(NowRecN, &quot;Volume&quot;, -1);
809    return NowRecN;
810  }
811  int TGasDm::AddTmResRec(const double&amp; Cspt){
812    if (TypeNm==&quot;Week&quot;){return AddWeekRec(Cspt);}
813    if (TypeNm==&quot;Day&quot;){return AddDayRec(Cspt);}
814    if (TypeNm.IsPrefix(&quot;Hour&quot;)){return AddHourBlockRec(Cspt);}
815    else {Fail; return -1;}
816  }
817  void TGasDm::DumpRec(const int&amp; RecN) const {
818    printf(&quot;Record[%d]:&quot;, RecN);
819    for (int VarN=0; VarN&lt;GetVars(); VarN++){
820      if (GetVarNm(VarN)==&quot;Date&quot;){
821        printf(&quot; [%s:%s]&quot;, GetVarNm(VarN).CStr(),
822         TSecTm(int(GetVarVal(RecN, VarN))).GetStr().CStr());
823      } else {
824        printf(&quot; [%s:%g]&quot;, GetVarNm(VarN).CStr(), GetVarVal(RecN, VarN));
825      }
826    }
827    printf(&quot;\n\n&quot;);
828  }
829  void TGasDmHd::GetAttrNmV(TStrV&amp; AttrNmV) const {
830    AttrNmV.Clr();
831    for (int VarN=0; VarN&lt;GetVars(); VarN++){
832      if (GetVarTy(VarN)==&quot;attr&quot;){
833        AttrNmV.Add(GetVarNm(VarN));
834      }
835    }
836  }
837  TStr TGasDmHd::GetClassNm() const {
838    for (int VarN=0; VarN&lt;GetVars(); VarN++){
839      if (GetVarTy(VarN)==&quot;class&quot;){
840        return GetVarNm(VarN);
841      }
842    }
843    Fail;
844    return TStr();
845  }
846  TStr TGasMdMType::GetDescStr() const {
847    if (GetMdTypes()==1){
848      TGasMdType GasMdType=GetMdType(0);
849      return TGasMd::GetGasMdTypeBriefNm(GasMdType);
850    } else {
851      TChA ChA;
852      ChA+=&quot;Ensemble(&quot;;
853      for (int MdTypeN=0; MdTypeN&lt;GetMdTypes(); MdTypeN++){
854        if (MdTypeN&gt;0){ChA+=&#x27; &#x27;;}
855        TGasMdType GasMdType=GetMdType(MdTypeN);
856        double Wgt=GetMdWgt(MdTypeN);
857        ChA+=TGasMd::GetGasMdTypeBriefNm(GasMdType);
858        ChA+=&quot;:&quot;;
859        ChA+=TFlt::GetStr(Wgt, &quot;%.2f&quot;);
860      }
861      ChA+=&quot;)&quot;;
862      return ChA;
863    }
864  }
865  void TGasMdMType::AddMdTypeWgt(const TGasMdType&amp; MdType, const double&amp; MdWgt){
866    if (MdWgt&lt;=0){return;}
867    MdTypeWgtPrV.Add(TIntFltPr(int(MdType), MdWgt));
868  }
869  void TGasMdMType::NrmMdWgt(){
870    double SumMdWgt=0;
871    for (int MdTypeN=0; MdTypeN&lt;GetMdTypes(); MdTypeN++){
872      SumMdWgt+=GetMdWgt(MdTypeN);}
873    {for (int MdTypeN=0; MdTypeN&lt;GetMdTypes(); MdTypeN++){
874      MdTypeWgtPrV[MdTypeN].Val2=MdTypeWgtPrV[MdTypeN].Val2/SumMdWgt;}}
875  }
876  double TGasMd::GetCorPredClassVal(
877   const PGasDm&amp; GasDm, const int&amp; RecN, const double&amp; CorFact) const {
878    double ClassVal=GetPredClassVal(GasDm, RecN);
879    if (GasDm-&gt;GetAttrVal(RecN, &quot;DaysBeforePriceChange&quot;, 0)==1){
880      ClassVal*=CorFact;}
881    if (ClassVal&lt;0){
882      ClassVal=0;}
883    return ClassVal;
884  }
885  PGasMd TGasMd::New(
886   const TGasMdType&amp; GasMdType,
887   const PGasMdMType&amp; GasMdMType, const TStr&amp; GasMdParamStr,
888   const PGasDm&amp; GasDm,
889   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
890   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
891    switch (GasMdType){
892      case gmtCTb: return TGasMdCTb::New(GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
893      case gmtLr: return TGasMdSvd::New(GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
894      case gmtNNbr: return TGasMdNNbr::New(GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
895      case gmtSvm: return TGasMdSvm::New(GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
896      case gmtCubist: return TGasMdCubist::New(GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
897      case gmtRegTree: return TGasMdRegTree::New(GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
898      case gmtEnsemble: return TGasMdEnsemble::New(GasMdMType, GasMdParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
899      default: Fail; return NULL;
900    }
901  }
902  TStr TGasMd::GetGasMdTypeNm(const TGasMdType&amp; GasMdType){
903    switch (GasMdType){
904      case gmtCTb: return &quot;Contingency-Table&quot;;
905      case gmtLr: return &quot;Singular-Value-Decomposition&quot;;
906      case gmtNNbr: return &quot;Nearest-Neigbour&quot;;
907      case gmtSvm: return &quot;Support-Vector-Machine&quot;;
908      case gmtCubist: return &quot;Cubist&quot;;
909      case gmtRegTree: return &quot;Regression-Tree&quot;;
910      case gmtEnsemble: return &quot;Ensemble&quot;;
911      default: Fail; return TStr();
912    }
913  }
914  TStr TGasMd::GetGasMdTypeBriefNm(const TGasMdType&amp; GasMdType){
915    switch (GasMdType){
916      case gmtCTb: return &quot;ContTb&quot;;
917      case gmtLr: return &quot;SVD&quot;;
918      case gmtNNbr: return &quot;NNbr&quot;;
919      case gmtSvm: return &quot;SVM&quot;;
920      case gmtCubist: return &quot;Cubist&quot;;
921      case gmtRegTree: return &quot;RTree&quot;;
922      case gmtEnsemble: return &quot;Ensemble&quot;;
923      default: Fail; return TStr();
924    }
925  }
926  TStr TGasMd::GetMdParamStr(){
927    return
928     &quot;&lt;Model&gt;&quot;
929     &quot;  &lt;ContTable&gt;&lt;Moment&gt;Median&lt;/Moment&gt;&lt;/ContTable&gt;&quot;
930     &quot;  &lt;NNbr&gt;&lt;K&gt;5&lt;/K&gt;&lt;/NNbr&gt;&quot;
931     &quot;  &lt;Cubist&gt;&lt;FileId&gt;CubistData&lt;/FileId&gt;&lt;/Cubist&gt;&quot;
932     &quot;  &lt;Svm&gt;&lt;FileId&gt;SvmData&lt;/FileId&gt;&lt;/Svm&gt;&quot;
933     &quot;  &lt;RegTree&gt;&lt;MnLeafExs&gt;5&lt;/MnLeafExs&gt;&lt;/RegTree&gt;&quot;
934     &quot;&lt;/Model&gt;&quot;;
935  }
936  PGasMd TGasMdEnsemble::New(
937   const PGasMdMType&amp; GasMdMType, const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
938   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
939   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
940    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
941    TGasMdEnsemble* GasMdEnsemble=new TGasMdEnsemble(GasDmHd, GasMdMType);
942    PGasMd GasMd(GasMdEnsemble);
943    for (int MdTypeN=0; MdTypeN&lt;GasMdMType-&gt;GetMdTypes(); MdTypeN++){
944      TGasMdType GasMdType=GasMdMType-&gt;GetMdType(MdTypeN);
945      PGasMd SubGasMd=TGasMd::New(GasMdType, NULL, ParamStr, GasDm, StartDate, EndDate, StartRecN, EndRecN, MnCspt);
946      GasMdEnsemble-&gt;GasMdV.Add(SubGasMd);
947    }
948    return GasMd;
949  }
950  double TGasMdEnsemble::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
951    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
952    double PredClassVal=0;
953    for (int MdTypeN=0; MdTypeN&lt;GasMdMType-&gt;GetMdTypes(); MdTypeN++){
954      double GasMdWgt=GasMdMType-&gt;GetMdWgt(MdTypeN);
955      PGasMd SubGasMd=GasMdV[MdTypeN];
956      PredClassVal+=GasMdWgt*SubGasMd-&gt;GetPredClassVal(GasDm, RecN);
957    }
958    return PredClassVal;
959  }
960  PMom TGasMdEnsemble::GetClassValMom() const {
961    return GasMdV[0]-&gt;GetClassValMom();
962  }
963  void TGasMdEnsemble::Print() const {
964    if (GasMdMType-&gt;GetMdTypes()==1){
965      GasMdV[0]-&gt;Print();
966    } else {
967      printf(&quot;==========================================================\n&quot;);
968      printf(&quot;ClassVal: %s\n&quot;, GetClassValMom()-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
969      printf(&quot;ClassVal =\n&quot;);
970      for (int MdTypeN=0; MdTypeN&lt;GasMdMType-&gt;GetMdTypes(); MdTypeN++){
971        TGasMdType GasMdType=GasMdMType-&gt;GetMdType(MdTypeN);
972        double GasMdWgt=GasMdMType-&gt;GetMdWgt(MdTypeN);
973        printf(&quot;    + %g * %s\n&quot;, GasMdWgt, TGasMd::GetGasMdTypeNm(GasMdType).CStr());
974      }
975      printf(&quot;\n&quot;);
976    }
977  }
978  PGasMd TGasMdCTb::New(const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
979   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
980   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
981    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
982    TGasMdCTb* GasMdCTb=new TGasMdCTb(GasDmHd); PGasMd GasMd(GasMdCTb);
983    PSIn ParamXmlSIn=TStrIn::New(ParamStr);
984    PXmlDoc ParamXmlDoc=TXmlDoc::LoadTxt(ParamXmlSIn);
985    GasMdCTb-&gt;MomNm=ParamXmlDoc-&gt;GetTagTokStr(&quot;Model|ContTable|Moment&quot;);
986    TIntV RecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, StartRecN, EndRecN, MnCspt, RecNV);
987    int Recs=RecNV.Len();
988    GasMdCTb-&gt;HourAttrN=GasDm-&gt;GetAttrN(&quot;Hour&quot;);
989    GasMdCTb-&gt;DowAttrN=GasDm-&gt;GetAttrN(&quot;Dow&quot;);
990    GasMdCTb-&gt;MonthAttrN=GasDm-&gt;GetAttrN(&quot;Month&quot;);
991    GasMdCTb-&gt;ClassValMom=TMom::New();
992    TMom::NewV(GasMdCTb-&gt;HourMomV, 24);
993    TMom::NewV(GasMdCTb-&gt;DowMomV, 7);
994    TMom::NewV(GasMdCTb-&gt;MonthMomV, 12);
995    TMom::NewVV(GasMdCTb-&gt;DowHourMomVV, 7, 24);
996    for (int RecNN=0; RecNN&lt;Recs; RecNN++){
997      int RecN=RecNV[RecNN];
998      double ClassVal=GasDm-&gt;GetClassVal(RecN);
999      int HourN, DowN, MonthN;
1000      if (GasMdCTb-&gt;HourAttrN!=-1){HourN=GasDm-&gt;GetAttrVal(RecN, GasMdCTb-&gt;HourAttrN, 0);}
1001      if (GasMdCTb-&gt;DowAttrN!=-1){DowN=GasDm-&gt;GetAttrVal(RecN, GasMdCTb-&gt;DowAttrN, 0)-1;}
1002      if (GasMdCTb-&gt;MonthAttrN!=-1){MonthN=GasDm-&gt;GetAttrVal(RecN, GasMdCTb-&gt;MonthAttrN, 0)-1;}
1003      GasMdCTb-&gt;ClassValMom-&gt;Add(ClassVal);
1004      if (GasMdCTb-&gt;HourAttrN!=-1){
1005        GasMdCTb-&gt;HourMomV[HourN]-&gt;Add(ClassVal);}
1006      if (GasMdCTb-&gt;DowAttrN!=-1){
1007        GasMdCTb-&gt;DowMomV[DowN]-&gt;Add(ClassVal);}
1008      if (GasMdCTb-&gt;MonthAttrN!=-1){
1009        GasMdCTb-&gt;MonthMomV[MonthN]-&gt;Add(ClassVal);}
1010      if ((GasMdCTb-&gt;DowAttrN!=-1)&amp;&amp;(GasMdCTb-&gt;HourAttrN!=-1)){
1011        GasMdCTb-&gt;DowHourMomVV.At(DowN, HourN)-&gt;Add(ClassVal);}
1012    }
1013    GasMdCTb-&gt;ClassValMom-&gt;Def();
1014    TMom::DefV(GasMdCTb-&gt;HourMomV);
1015    TMom::DefV(GasMdCTb-&gt;DowMomV);
1016    TMom::DefV(GasMdCTb-&gt;MonthMomV);
1017    TMom::DefVV(GasMdCTb-&gt;DowHourMomVV);
1018    return GasMd;
1019  }
1020  double TGasMdCTb::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1021    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1022    int HourN, DowN, MonthN;
1023    if (HourAttrN!=-1){HourN=GasDm-&gt;GetAttrVal(RecN, HourAttrN, 0);}
1024    if (DowAttrN!=-1){DowN=GasDm-&gt;GetAttrVal(RecN, DowAttrN, 0)-1;}
1025    if (MonthAttrN!=-1){MonthN=GasDm-&gt;GetAttrVal(RecN, MonthAttrN, 0)-1;}
1026    PMom Mom1; PMom Mom2;
1027    if ((HourAttrN!=-1)&amp;&amp;(DowAttrN!=-1)){
1028      Mom1=DowHourMomVV.At(DowN, HourN);
1029    } else
1030    if ((DowAttrN!=-1)&amp;&amp;(MonthAttrN!=-1)){
1031      Mom1=DowMomV[DowN];
1032    } else
1033    if (HourAttrN!=-1){
1034      Mom1=HourMomV[HourN];
1035    } else
1036    if (DowAttrN!=-1){
1037      Mom1=DowMomV[DowN];
1038    } else
1039    if (MonthAttrN!=-1){
1040      Mom1=MonthMomV[MonthN];
1041    } else {
1042      Mom1=ClassValMom;
1043    }
1044    double PredClassVal=0;
1045    if (Mom1-&gt;IsUsable()){
1046      PredClassVal=Mom1-&gt;GetByNm(MomNm);
1047    }
1048    if ((!Mom2.Empty())&amp;&amp;(Mom2-&gt;IsUsable())){
1049      PredClassVal=0.5*PredClassVal+0.5*Mom2-&gt;GetByNm(MomNm);
1050    }
1051    return PredClassVal;
1052  }
1053  void TGasMdCTb::Print() const {
1054    printf(&quot;==========================================================\n&quot;);
1055    printf(&quot;ClassVal: %s\n&quot;, ClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1056    printf(&quot;per Hour:&quot;);
1057    for (int HourN=0; HourN&lt;24; HourN++){
1058      printf(&quot; [%d:%s]&quot;, HourN, HourMomV[HourN]-&gt;GetStrByNm(MomNm).CStr());}
1059    printf(&quot;\n&quot;);
1060    printf(&quot;per Day-Of-Week:&quot;);
1061    for (int DowN=0; DowN&lt;7; DowN++){
1062      printf(&quot; [%s:%s]&quot;, TTmInfo::GetDayOfWeekNm(DowN+1).CStr(),
1063       DowMomV[DowN]-&gt;GetStrByNm(MomNm).CStr());
1064    }
1065    printf(&quot;\n&quot;);
1066    printf(&quot;per Month:&quot;);
1067    for (int MonthN=0; MonthN&lt;12; MonthN++){
1068      printf(&quot; [%s:%s]&quot;, TTmInfo::GetMonthNm(MonthN+1).CStr(),
1069       MonthMomV[MonthN]-&gt;GetStrByNm(MomNm).CStr());
1070    }
1071    printf(&quot;\n&quot;);
1072  }
1073  PGasMd TGasMdSvd::New(const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
1074   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
1075   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
1076    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
1077    TGasMdSvd* GasMdSvd=new TGasMdSvd(GasDmHd); PGasMd GasMd(GasMdSvd);
1078    TIntV RecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, StartRecN, EndRecN, MnCspt, RecNV);
1079    int Attrs=GasDm-&gt;GetAttrs(); int Recs=RecNV.Len();
1080    TFltVV XVV(Recs, Attrs); TFltV YV(Recs); GasMdSvd-&gt;ClassValMom=TMom::New();
1081    for (int RecNN=0; RecNN&lt;Recs; RecNN++){
1082      int RecN=RecNV[RecNN];
1083      double ClassVal=GasDm-&gt;GetClassVal(RecN);
1084      TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1085      for (int AttrN=0; AttrN&lt;AttrValV.Len(); AttrN++){
1086        XVV.At(RecNN, AttrN)=AttrValV[AttrN];
1087      }
1088      YV[RecNN]=ClassVal;
1089      GasMdSvd-&gt;ClassValMom-&gt;Add(ClassVal);
1090    }
1091    GasMdSvd-&gt;ClassValMom-&gt;Def();
1092    PSvd Svd=TSvd::New(XVV, YV);
1093    Svd-&gt;GetCfV(GasMdSvd-&gt;CfV);
1094    Svd-&gt;GetCfUncerV(GasMdSvd-&gt;CfUncerV);
1095    GasMdSvd-&gt;ChiSq=Svd-&gt;GetChiSq();
1096    return GasMd;
1097  }
1098  double TGasMdSvd::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1099    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1100    double PredClassVal=0;
1101    TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1102    IAssert(AttrValV.Len()==CfV.Len());
1103    for (int AttrN=0; AttrN&lt;AttrValV.Len(); AttrN++){
1104      PredClassVal+=CfV[AttrN]*AttrValV[AttrN];
1105    }
1106    return PredClassVal;
1107  }
1108  void TGasMdSvd::Print() const {
1109    printf(&quot;==========================================================\n&quot;);
1110    PGasDmHd GasDmHd=GetGasDmHd();
1111    TStrV AttrNmV; GasDmHd-&gt;GetAttrNmV(AttrNmV);
1112    TStr ClassNm=GasDmHd-&gt;GetClassNm();
1113    printf(&quot;%s = &quot;, ClassNm.CStr());
1114    IAssert((AttrNmV.Len()==CfV.Len())&amp;&amp;(AttrNmV.Len()==CfUncerV.Len()));
1115    for (int AttrN=0; AttrN&lt;AttrNmV.Len(); AttrN++){
1116      printf(&quot;\t%+g * %s\n&quot;, CfV[AttrN](), AttrNmV[AttrN].CStr());
1117    }
1118    printf(&quot;\n&quot;);
1119    printf(&quot;ClassVal: %s\n&quot;, ClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1120  }
1121  PGasMd TGasMdNNbr::New(const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
1122   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
1123   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
1124    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
1125    TGasMdNNbr* GasMdNNbr=new TGasMdNNbr(GasDmHd); PGasMd GasMd(GasMdNNbr);
1126    PSIn ParamXmlSIn=TStrIn::New(ParamStr);
1127    PXmlDoc ParamXmlDoc=TXmlDoc::LoadTxt(ParamXmlSIn);
1128    GasMdNNbr-&gt;NNbrs=ParamXmlDoc-&gt;GetTagTokStr(&quot;Model|NNbr|K&quot;).GetInt();
1129    IAssert(GasMdNNbr-&gt;NNbrs&gt;0);
1130    TIntV RecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, StartRecN, EndRecN, MnCspt, RecNV);
1131    int Attrs=GasDm-&gt;GetAttrs(); int Recs=RecNV.Len();
1132    GasMdNNbr-&gt;AttrValVV.Gen(Recs); TMom::NewV(GasMdNNbr-&gt;AttrValMomV, Attrs);
1133    GasMdNNbr-&gt;ClassValV.Gen(Recs); GasMdNNbr-&gt;ClassValMom=TMom::New();
1134    for (int RecNN=0; RecNN&lt;Recs; RecNN++){
1135      int RecN=RecNV[RecNN];
1136      TFltV&amp; AttrValV=GasMdNNbr-&gt;AttrValVV[RecNN];
1137      GasDm-&gt;GetAttrValV(RecN, AttrValV);
1138      for (int AttrN=0; AttrN&lt;Attrs; AttrN++){
1139        GasMdNNbr-&gt;AttrValMomV[AttrN]-&gt;Add(AttrValV[AttrN]);}
1140      double ClassVal=GasDm-&gt;GetClassVal(RecN);
1141      GasMdNNbr-&gt;ClassValV[RecNN]=ClassVal;
1142      GasMdNNbr-&gt;ClassValMom-&gt;Add(ClassVal);
1143    }
1144    TMom::DefV(GasMdNNbr-&gt;AttrValMomV);
1145    GasMdNNbr-&gt;ClassValMom-&gt;Def();
1146    return GasMd;
1147  }
1148  double TGasMdNNbr::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1149    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1150    TFltIntKdV DistRecNKdV;
1151    TFltV PredAttrValV; GasDm-&gt;GetAttrValV(RecN, PredAttrValV);
1152    for (int AttrValVN=0; AttrValVN&lt;AttrValVV.Len(); AttrValVN++){
1153      TFltV&amp; DmAttrValV=AttrValVV[AttrValVN];
1154      double Dist=0;
1155      for (int AttrN=0; AttrN&lt;PredAttrValV.Len(); AttrN++){
1156        double AttrValDist=PredAttrValV[AttrN]-DmAttrValV[AttrN];
1157        double AttrNrmVal=AttrValMomV[AttrN]-&gt;GetMedian();
1158        if (AttrNrmVal!=0){AttrValDist=AttrValDist/AttrNrmVal;}
1159        Dist+=TMath::Sqr(AttrValDist);
1160      }
1161      Dist=sqrt(Dist);
1162      TFltIntKd DistRecNKd(Dist, AttrValVN);
1163      DistRecNKdV.AddSorted(DistRecNKd, true, NNbrs);
1164    }
1165    double PredClassVal=0;
1166    for (int DistRecNKdN=0; DistRecNKdN&lt;DistRecNKdV.Len(); DistRecNKdN++){
1167      int RecN=DistRecNKdV[DistRecNKdN].Dat;
1168      double ClassVal=ClassValV[RecN];
1169      PredClassVal+=ClassVal;
1170    }
1171    if (DistRecNKdV.Len()&gt;0){
1172      PredClassVal=PredClassVal/DistRecNKdV.Len();}
1173    return PredClassVal;
1174  }
1175  TStr TGasMdNNbr::GetPredExpl(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1176    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1177    TFltIntKdV DistRecNKdV;
1178    TFltV PredAttrValV; GasDm-&gt;GetAttrValV(RecN, PredAttrValV);
1179    for (int AttrValVN=0; AttrValVN&lt;AttrValVV.Len(); AttrValVN++){
1180      TFltV&amp; DmAttrValV=AttrValVV[AttrValVN];
1181      double Dist=0;
1182      for (int AttrN=0; AttrN&lt;PredAttrValV.Len(); AttrN++){
1183        double AttrValDist=PredAttrValV[AttrN]-DmAttrValV[AttrN];
1184        double AttrNrmVal=AttrValMomV[AttrN]-&gt;GetMedian();
1185        if (AttrNrmVal!=0){AttrValDist=AttrValDist/AttrNrmVal;}
1186        Dist+=TMath::Sqr(AttrValDist);
1187      }
1188      Dist=sqrt(Dist);
1189      TFltIntKd DistRecNKd(Dist, AttrValVN);
1190      DistRecNKdV.AddSorted(DistRecNKd, true, NNbrs);
1191    }
1192    TChA PredExplChA;
1193    return PredExplChA;
1194  }
1195  void TGasMdNNbr::Print() const {
1196    printf(&quot;==========================================================\n&quot;);
1197    printf(&quot;Nearest-Neigbours Window-Size: %d\n&quot;, NNbrs);
1198    printf(&quot;Records: %d\n&quot;, AttrValVV.Len());
1199    printf(&quot;ClassVal: %s\n&quot;, ClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1200  }
1201  PGasMd TGasMdCubist::New(
1202   const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
1203   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
1204   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
1205    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
1206    TGasMdCubist* GasMdCubist=new TGasMdCubist(GasDmHd); PGasMd GasMd(GasMdCubist);
1207    PSIn ParamXmlSIn=TStrIn::New(ParamStr);
1208    PXmlDoc ParamXmlDoc=TXmlDoc::LoadTxt(ParamXmlSIn);
1209    GasMdCubist-&gt;IdFNm=ParamXmlDoc-&gt;GetTagTokStr(&quot;Model|Cubist|FileId&quot;);
1210    TStr IdFNm=GasMdCubist-&gt;IdFNm;
1211    PSOut NamesSOut=TFOut::New(IdFNm+&quot;.names&quot;);
1212    NamesSOut-&gt;PutStr(GasDm-&gt;GetClassNm()); NamesSOut-&gt;PutStr(&quot;.\n\n&quot;);
1213    NamesSOut-&gt;PutStr(GasDm-&gt;GetClassNm()); NamesSOut-&gt;PutStr(&quot;: &quot;);
1214    NamesSOut-&gt;PutStr(&quot;continuous&quot;);
1215    NamesSOut-&gt;PutStr(&quot;.\n&quot;);
1216    TStrV AttrNmV; GasDm-&gt;GetAttrNmV(AttrNmV);
1217    for (int AttrN=0; AttrN&lt;AttrNmV.Len(); AttrN++){
1218      NamesSOut-&gt;PutStr(AttrNmV[AttrN]); NamesSOut-&gt;PutStr(&quot;: &quot;);
1219      if (AttrNmV[AttrN]==&quot;Dow&quot;){
1220        for (int DowN=0; DowN&lt;7; DowN++){
1221          if (DowN&gt;0){NamesSOut-&gt;PutStr(&quot;,&quot;);}
1222          NamesSOut-&gt;PutStr(TTmInfo::GetDayOfWeekNm(DowN+1));
1223        }
1224      } else
1225      if (AttrNmV[AttrN]==&quot;Month&quot;){
1226        for (int MonthN=0; MonthN&lt;12; MonthN++){
1227          if (MonthN&gt;0){NamesSOut-&gt;PutStr(&quot;,&quot;);}
1228          NamesSOut-&gt;PutStr(TTmInfo::GetMonthNm(MonthN+1));
1229        }
1230      } else {
1231        NamesSOut-&gt;PutStr(&quot;continuous&quot;);
1232      }
1233      NamesSOut-&gt;PutStr(&quot;.\n&quot;);
1234    }
1235    NamesSOut=NULL;
1236    TIntV RecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, StartRecN, EndRecN, MnCspt, RecNV);
1237    int Recs=RecNV.Len();
1238    PSOut DataSOut=TFOut::New(IdFNm+&quot;.data&quot;);
1239    GasMdCubist-&gt;ClassValMom=TMom::New();
1240    for (int RecNN=0; RecNN&lt;Recs; RecNN++){
1241      int RecN=RecNV[RecNN];
1242      double ClassVal=GasDm-&gt;GetClassVal(RecN);
1243      TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1244      GasMdCubist-&gt;ClassValMom-&gt;Add(ClassVal);
1245      DataSOut-&gt;PutFlt(ClassVal);
1246      for (int AttrN=0; AttrN&lt;AttrValV.Len(); AttrN++){
1247        DataSOut-&gt;PutStr(&quot;,&quot;);
1248        if (AttrNmV[AttrN]==&quot;Dow&quot;){
1249          DataSOut-&gt;PutStr(TTmInfo::GetDayOfWeekNm(AttrValV[AttrN]));
1250        } else
1251        if (AttrNmV[AttrN]==&quot;Month&quot;){
1252          DataSOut-&gt;PutStr(TTmInfo::GetMonthNm(AttrValV[AttrN]));
1253        } else {
1254          DataSOut-&gt;PutFlt(AttrValV[AttrN]);
1255        }
1256      }
1257      DataSOut-&gt;PutStr(&quot;\n&quot;);
1258    }
1259    GasMdCubist-&gt;ClassValMom-&gt;Def();
1260    DataSOut=NULL;
1261    TFile::Del(IdFNm+&quot;.model&quot;, false);
1262    TStr CubistCmLn=TStr(&quot;CubistX.exe -f &quot;)+IdFNm&amp;bsol;*+&quot; &quot;+OptStr*/;
1263    system(CubistCmLn.CStr());
1264    {PSIn NamesSIn=TFIn::New(IdFNm+&quot;.names&quot;);
1265    GasMdCubist-&gt;NamesFileStr=TStr(NamesSIn);}
1266    {PSIn DataSIn=TFIn::New(IdFNm+&quot;.data&quot;);
<span onclick='openModal()' class='match'>1267    GasMdCubist-&gt;DataFileStr=TStr(DataSIn);}
1268    {PSIn ModelSIn=TFIn::New(IdFNm+&quot;.model&quot;);
1269    GasMdCubist-&gt;ModelFileStr=TStr(ModelSIn);}
1270    TFile::Del(IdFNm+&quot;.names&quot;, false);
</span>1271    TFile::Del(IdFNm+&quot;.data&quot;, false);
1272    TFile::Del(IdFNm+&quot;.model&quot;, false);
1273    return GasMd;
1274  }
1275  double TGasMdCubist::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1276    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1277    {PSOut NamesSOut=TFOut::New(IdFNm+&quot;.names&quot;);
1278    NamesSOut-&gt;PutStr(NamesFileStr);}
1279    {PSOut DataSOut=TFOut::New(IdFNm+&quot;.data&quot;);
1280    DataSOut-&gt;PutStr(DataFileStr);}
1281    {PSOut ModelSOut=TFOut::New(IdFNm+&quot;.model&quot;);
1282    ModelSOut-&gt;PutStr(ModelFileStr);}
1283    PSOut CasesSOut=TFOut::New(IdFNm+&quot;.cases&quot;);
1284    TStrV AttrNmV; GasDm-&gt;GetAttrNmV(AttrNmV);
1285    double ClassVal=GasDm-&gt;GetClassVal(RecN);
1286    TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1287    CasesSOut-&gt;PutFlt(ClassVal);
1288    for (int AttrN=0; AttrN&lt;AttrValV.Len(); AttrN++){
1289      CasesSOut-&gt;PutStr(&quot;,&quot;);
1290      if (AttrNmV[AttrN]==&quot;Dow&quot;){
1291        CasesSOut-&gt;PutStr(TTmInfo::GetDayOfWeekNm(AttrValV[AttrN]));
1292      } else
1293      if (AttrNmV[AttrN]==&quot;Month&quot;){
1294        CasesSOut-&gt;PutStr(TTmInfo::GetMonthNm(AttrValV[AttrN]));
1295      } else {
1296        CasesSOut-&gt;PutFlt(AttrValV[AttrN]);
1297      }
1298    }
1299    CasesSOut-&gt;PutStr(&quot;\n&quot;);
1300    CasesSOut=NULL;
1301    TFile::Del(IdFNm+&quot;.xml&quot;, false);
1302    TStr CubistCmLn=TStr(&quot;CubistC.exe -f &quot;)+IdFNm;
1303    system(CubistCmLn.CStr());
1304    PXmlDoc XmlDoc=TXmlDoc::LoadTxt(IdFNm+&quot;.xml&quot;);
1305    TStr PredClassValStr=XmlDoc-&gt;GetTagTokStr(&quot;Prediction|Predicted&quot;);
1306    double PredClassVal=PredClassValStr.GetFlt();
1307    TFile::Del(IdFNm+&quot;.names&quot;, false);
1308    TFile::Del(IdFNm+&quot;.data&quot;, false);
1309    TFile::Del(IdFNm+&quot;.model&quot;, false);
1310    TFile::Del(IdFNm+&quot;.cases&quot;, false);
1311    TFile::Del(IdFNm+&quot;.xml&quot;, false);
1312    return PredClassVal;
1313  }
1314  void TGasMdCubist::Print() const {
1315    printf(&quot;==========================================================\n&quot;);
1316    printf(&quot;ClassVal: %s\n&quot;, ClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1317  }
1318  PGasMd TGasMdSvm::New(const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
1319   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
1320   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
1321    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
1322    TGasMdSvm* GasMdSvm=new TGasMdSvm(GasDmHd); PGasMd GasMd(GasMdSvm);
1323    PSIn ParamXmlSIn=TStrIn::New(ParamStr);
1324    PXmlDoc ParamXmlDoc=TXmlDoc::LoadTxt(ParamXmlSIn);
1325    GasMdSvm-&gt;IdFNm=ParamXmlDoc-&gt;GetTagTokStr(&quot;Model|Svm|FileId&quot;);
1326    TStr IdFNm=GasMdSvm-&gt;IdFNm;
1327    TIntV RecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, StartRecN, EndRecN, MnCspt, RecNV);
1328    int Recs=RecNV.Len();
1329    PSOut TrainSOut=TFOut::New(IdFNm+&quot;.train&quot;);
1330    TrainSOut-&gt;PutStr(&quot;# &quot;);
1331    TStrV AttrNmV; GasDm-&gt;GetAttrNmV(AttrNmV);
1332    for (int AttrN=0; AttrN&lt;AttrNmV.Len(); AttrN++){
1333      TrainSOut-&gt;PutStr(AttrNmV[AttrN]); TrainSOut-&gt;PutStr(&quot; &quot;);}
1334    TrainSOut-&gt;PutStr(GasDm-&gt;GetClassNm());
1335    TrainSOut-&gt;PutStr(&quot;\n&quot;);
1336    TrainSOut-&gt;PutStr(&quot;@examples\n&quot;);
1337    TrainSOut-&gt;PutStr(&quot;dimension &quot;); TrainSOut-&gt;PutInt(AttrNmV.Len()); TrainSOut-&gt;PutStr(&quot;\n&quot;);
1338    TrainSOut-&gt;PutStr(&quot;format xy\n&quot;);
1339    GasMdSvm-&gt;ClassValMom=TMom::New();
1340    for (int RecNN=0; RecNN&lt;Recs; RecNN++){
1341      int RecN=RecNV[RecNN];
1342      double ClassVal=GasDm-&gt;GetClassVal(RecN);
1343      TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1344      GasMdSvm-&gt;ClassValMom-&gt;Add(ClassVal);
1345      for (int AttrN=0; AttrN&lt;AttrValV.Len(); AttrN++){
1346        TrainSOut-&gt;PutFlt(AttrValV[AttrN]);
1347        TrainSOut-&gt;PutStr(&quot; &quot;);
1348      }
1349      TrainSOut-&gt;PutFlt(ClassVal);
1350      TrainSOut-&gt;PutStr(&quot;\n&quot;);
1351    }
1352    GasMdSvm-&gt;ClassValMom-&gt;Def();
1353    TrainSOut=NULL;
1354    PSOut ParamSOut=TFOut::New(IdFNm+&quot;.param&quot;);
1355    ParamSOut-&gt;PutStr(&quot;@kernel\n&quot;);
1356    ParamSOut-&gt;PutStr(&quot;type dot\n&quot;);
1357    ParamSOut-&gt;PutStr(&quot;@parameters\n&quot;);
1358    ParamSOut-&gt;PutStr(&quot;C 1000\n&quot;);
1359    ParamSOut-&gt;PutStr(&quot;epsilon 0.1\n&quot;);
1360    ParamSOut=NULL;
1361    TFile::Del(IdFNm+&quot;.train.svm&quot;, false);
1362    TStr SvmCmLn=TStr(&quot;MySvmLearn.exe &quot;)+IdFNm+&quot;.train &quot;+IdFNm+&quot;.param&quot;;
1363    system(SvmCmLn.CStr());
1364    {PSIn ModelSIn=TFIn::New(IdFNm+&quot;.train.svm&quot;);
1365    GasMdSvm-&gt;ModelFileStr=TStr(ModelSIn);}
1366    TFile::Del(IdFNm+&quot;.train&quot;, false);
1367    TFile::Del(IdFNm+&quot;.param&quot;, false);
1368    TFile::Del(IdFNm+&quot;.train.svm&quot;, false);
1369    return GasMd;
1370  }
1371  double TGasMdSvm::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1372    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1373    {PSOut ModelSOut=TFOut::New(IdFNm+&quot;.train.svm&quot;);
1374    ModelSOut-&gt;PutStr(ModelFileStr);}
1375    PSOut TestSOut=TFOut::New(IdFNm+&quot;.test&quot;);
1376    TestSOut-&gt;PutStr(&quot;# &quot;);
1377    TStrV AttrNmV; GasDm-&gt;GetAttrNmV(AttrNmV);
1378    for (int AttrN=0; AttrN&lt;AttrNmV.Len(); AttrN++){
1379      TestSOut-&gt;PutStr(AttrNmV[AttrN]); TestSOut-&gt;PutStr(&quot; &quot;);}
1380    TestSOut-&gt;PutStr(GasDm-&gt;GetClassNm());
1381    TestSOut-&gt;PutStr(&quot;\n&quot;);
1382    TestSOut-&gt;PutStr(&quot;@examples\n&quot;);
1383    TestSOut-&gt;PutStr(&quot;dimension &quot;); TestSOut-&gt;PutInt(AttrNmV.Len()); TestSOut-&gt;PutStr(&quot;\n&quot;);
1384    TestSOut-&gt;PutStr(&quot;format xy\n&quot;);
1385    double ClassVal=GasDm-&gt;GetClassVal(RecN);
1386    TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1387    {for (int AttrN=0; AttrN&lt;AttrValV.Len(); AttrN++){
1388      TestSOut-&gt;PutFlt(AttrValV[AttrN]);
1389      TestSOut-&gt;PutStr(&quot; &quot;);
1390    }}
1391    TestSOut-&gt;PutFlt(ClassVal);
1392    TestSOut-&gt;PutStr(&quot;\n&quot;);
1393    TestSOut=NULL;
1394    PSOut ParamSOut=TFOut::New(IdFNm+&quot;.param&quot;);
1395    ParamSOut-&gt;PutStr(&quot;@kernel\n&quot;);
1396    ParamSOut-&gt;PutStr(&quot;type dot\n&quot;);
1397    ParamSOut-&gt;PutStr(&quot;@parameters\n&quot;);
1398    ParamSOut-&gt;PutStr(&quot;C 1000\n&quot;);
1399    ParamSOut-&gt;PutStr(&quot;epsilon 0.1\n&quot;);
1400    ParamSOut=NULL;
1401    TFile::Del(IdFNm+&quot;test.pred&quot;, false);
1402    TStr SvmCmLn=TStr(&quot;MySvmPredict.exe &quot;)+
1403     IdFNm+&quot;.train.svm &quot;+IdFNm+&quot;.test &quot;+IdFNm+&quot;.param&quot;;
1404    system(SvmCmLn.CStr());
1405    PSIn PredSIn=TFIn::New(IdFNm+&quot;.test.pred&quot;);
1406    TILx PredLx(PredSIn, TFSet()|iloRetEoln|iloSigNum);
1407    PredLx.GetSym(syLn);
1408    double PredClassVal=PredLx.GetFlt();
1409    TFile::Del(IdFNm+&quot;.train.svm&quot;, false);
1410    TFile::Del(IdFNm+&quot;.test&quot;, false);
1411    TFile::Del(IdFNm+&quot;.param&quot;, false);
1412    TFile::Del(IdFNm+&quot;.test.pred&quot;, false);
1413    return PredClassVal;
1414  }
1415  void TGasMdSvm::Print() const {
1416    printf(&quot;==========================================================\n&quot;);
1417    printf(&quot;ClassVal: %s\n&quot;, ClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1418  }
1419  PGasRegNd TGasRegNd::New(const int&amp; MnLeafExs,
1420   const TVec&lt;TFltV&gt;&amp; AttrValVV, const TFltV&amp; ClassValV, const TIntV&amp; ExNV){
1421    IAssert(ExNV.Len()&gt;0);
1422    PGasRegNd RegNd=PGasRegNd(new TGasRegNd());
1423    RegNd-&gt;ClassValMom=TMom::New();
1424    for (int ExNN=0; ExNN&lt;ExNV.Len(); ExNN++){
1425      RegNd-&gt;ClassValMom-&gt;Add(ClassValV[ExNV[ExNN]]);}
1426    RegNd-&gt;ClassValMom-&gt;Def();
1427    if (ExNV.Len()&lt;MnLeafExs){
1428      return RegNd;}
1429    int MnSubRegNdExs=TInt::GetMx(ExNV.Len()/10, MnLeafExs);
1430    double BestSplitQual=-1;
1431    int BestSplitAttrN=-1; double BestSplitAttrVal=0;
1432    TIntV BestLExNV; TIntV BestRExNV;
1433    int Attrs=AttrValVV[0].Len();
1434    for (int SplitAttrN=0; SplitAttrN&lt;Attrs; SplitAttrN++){
1435      TFltV SplitValV; PMom SplitValMom=TMom::New();
1436      for (int ExNN=0; ExNN&lt;ExNV.Len(); ExNN++){
1437        double AttrVal=AttrValVV[ExNV[ExNN]][SplitAttrN];
1438        SplitValV.Add(AttrVal); SplitValMom-&gt;Add(AttrVal);
1439      }
1440      SplitValV.Sort(); SplitValMom-&gt;Def();
1441      double MnSplitValResol=
1442       (SplitValMom-&gt;GetQuart3()-SplitValMom-&gt;GetQuart1())/100;
1443      double PrevSplitVal;
1444      for (int SplitValN=1; SplitValN&lt;SplitValV.Len()-1; SplitValN++){
1445        double SplitVal=SplitValV[SplitValN];
1446        if ((SplitValN&gt;1)&amp;&amp;(SplitVal-PrevSplitVal&lt;=MnSplitValResol)){continue;}
1447        PrevSplitVal=SplitVal;
1448        PMom LClassValMom=TMom::New(); TIntV LExNV;
1449        PMom RClassValMom=TMom::New(); TIntV RExNV;
1450        for (int ExNN=0; ExNN&lt;ExNV.Len(); ExNN++){
1451          int ExN=ExNV[ExNN];
1452          double AttrVal=AttrValVV[ExN][SplitAttrN];
1453          if (AttrVal&lt;SplitVal){
1454            LClassValMom-&gt;Add(ClassValV[ExN]); LExNV.Add(ExN);
1455          } else {
1456            RClassValMom-&gt;Add(ClassValV[ExN]); RExNV.Add(ExN);
1457          }
1458        }
1459        LClassValMom-&gt;Def(); RClassValMom-&gt;Def();
1460        if ((LClassValMom-&gt;IsUsable()&amp;&amp;RClassValMom-&gt;IsUsable())&amp;&amp;
1461         (LExNV.Len()&gt;MnSubRegNdExs)&amp;&amp;(RExNV.Len()&gt;MnSubRegNdExs)){
1462          double SplitQual=
1463           TMath::Sqr(LClassValMom-&gt;GetSDev()*LExNV.Len())+
1464           TMath::Sqr(RClassValMom-&gt;GetSDev()*RExNV.Len());
1465          if ((BestSplitQual==-1)||(SplitQual&lt;BestSplitQual)){
1466            BestSplitQual=SplitQual;
1467            BestSplitAttrN=SplitAttrN; BestSplitAttrVal=SplitVal;
1468            BestLExNV=LExNV; BestRExNV=RExNV;
1469          }
1470        }
1471      }
1472    }
1473    if (BestSplitQual!=-1){
1474      RegNd-&gt;SplitQual=BestSplitQual;
1475      RegNd-&gt;SplitAttrN=BestSplitAttrN;
1476      RegNd-&gt;SplitAttrVal=BestSplitAttrVal;
1477      if ((BestLExNV.Len()&gt;0)&amp;&amp;(BestRExNV.Len()&gt;0)){
1478        RegNd-&gt;LRegNd=TGasRegNd::New(MnLeafExs, AttrValVV, ClassValV, BestLExNV);
1479        RegNd-&gt;RRegNd=TGasRegNd::New(MnLeafExs, AttrValVV, ClassValV, BestRExNV);
1480      }
1481    }
1482    printf(&quot;.&quot;);
1483    return RegNd;
1484  }
1485  double TGasRegNd::GetPredClassVal(const TFltV&amp; AttrValV) const {
1486    if (IsLeaf()){
1487      return ClassValMom-&gt;GetMedian();
1488    } else {
1489      if (AttrValV[SplitAttrN]&lt;SplitAttrVal){
1490        return LRegNd-&gt;GetPredClassVal(AttrValV);
1491      } else {
1492        return RRegNd-&gt;GetPredClassVal(AttrValV);
1493      }
1494    }
1495  }
1496  void TGasRegNd::Print(const PGasDmHd&amp; GasDmHd, const int&amp; Levs) const {
1497    if (IsLeaf()){
1498      for (int LevN=0; LevN&lt;Levs; LevN++){printf(&quot;   &quot;);}
1499      printf(&quot;%s=%g(%g) [%d Exs.]\n&quot;,
1500       GasDmHd-&gt;GetClassNm().CStr(),
1501       ClassValMom-&gt;GetMean(), ClassValMom-&gt;GetSDev(), ClassValMom-&gt;GetVals());
1502    } else {
1503      for (int LevN=0; LevN&lt;Levs; LevN++){printf(&quot;   &quot;);}
1504      printf(&quot;%s &lt;  %g [%s=%g(%g)] [%d Exs.]\n&quot;,
1505       GasDmHd-&gt;GetAttrNm(SplitAttrN).CStr(), SplitAttrVal,
1506       GasDmHd-&gt;GetClassNm().CStr(),
1507       ClassValMom-&gt;GetMean(), ClassValMom-&gt;GetSDev(), ClassValMom-&gt;GetVals());
1508      LRegNd-&gt;Print(GasDmHd, Levs+1);
1509      {for (int LevN=0; LevN&lt;Levs; LevN++){printf(&quot;   &quot;);}}
1510      printf(&quot;%s &gt;= %g [%s=%g(%g)] [%d Exs.]\n&quot;,
1511       GasDmHd-&gt;GetAttrNm(SplitAttrN).CStr(), SplitAttrVal,
1512       GasDmHd-&gt;GetClassNm().CStr(),
1513       ClassValMom-&gt;GetMean(), ClassValMom-&gt;GetSDev(), ClassValMom-&gt;GetVals());
1514      RRegNd-&gt;Print(GasDmHd, Levs+1);
1515    }
1516  }
1517  PGasMd TGasMdRegTree::New(const TStr&amp; ParamStr, const PGasDm&amp; GasDm,
1518   const TSecTm&amp; StartDate, const TSecTm&amp; EndDate,
1519   const int&amp; StartRecN, const int&amp; EndRecN, const double&amp; MnCspt){
1520    PGasDmHd GasDmHd=TGasDmHd::New(GasDm);
1521    TGasMdRegTree* GasMdRegTree=new TGasMdRegTree(GasDmHd); PGasMd GasMd(GasMdRegTree);
1522    PSIn ParamXmlSIn=TStrIn::New(ParamStr);
1523    PXmlDoc ParamXmlDoc=TXmlDoc::LoadTxt(ParamXmlSIn);
1524    int MnLeafExs=ParamXmlDoc-&gt;GetTagTokStr(&quot;Model|RegTree|MnLeafExs&quot;).GetInt();
1525    TIntV RecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, StartRecN, EndRecN, MnCspt, RecNV);
1526     int Recs=RecNV.Len();
1527    TVec&lt;TFltV&gt; AttrValVV(Recs);
1528    TFltV ClassValV(Recs); GasMdRegTree-&gt;ClassValMom=TMom::New();
1529    for (int RecNN=0; RecNN&lt;Recs; RecNN++){
1530      int RecN=RecNV[RecNN];
1531      TFltV&amp; AttrValV=AttrValVV[RecNN];
1532      GasDm-&gt;GetAttrValV(RecN, AttrValV);
1533      double ClassVal=GasDm-&gt;GetClassVal(RecN);
1534      ClassValV[RecNN]=ClassVal;
1535      GasMdRegTree-&gt;ClassValMom-&gt;Add(ClassVal);
1536    }
1537    GasMdRegTree-&gt;ClassValMom-&gt;Def();
1538    int AllExs=AttrValVV.Len();
1539    TIntV AllExNV(AllExs); for (int ExN=0; ExN&lt;AllExs; ExN++){AllExNV[ExN]=ExN;}
1540    GasMdRegTree-&gt;RegNd=TGasRegNd::New(MnLeafExs, AttrValVV, ClassValV, AllExNV);
1541    return GasMd;
1542  }
1543  double TGasMdRegTree::GetPredClassVal(const PGasDm&amp; GasDm, const int&amp; RecN) const {
1544    IAssert(GetGasDmHd()-&gt;IsCompatible(GasDm));
1545    TFltV AttrValV; GasDm-&gt;GetAttrValV(RecN, AttrValV);
1546    double PredClassVal=RegNd-&gt;GetPredClassVal(AttrValV);
1547    return PredClassVal;
1548  }
1549  void TGasMdRegTree::Print() const {
1550    printf(&quot;==========================================================\n&quot;);
1551    printf(&quot;ClassVal: %s\n&quot;, ClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1552    RegNd-&gt;Print(GasDmHd);
1553  }
1554  TGasMdCor::TGasMdCor(const TStr&amp; LtpFPath):
1555    DateProdNmToCorFactMomH(){
1556    TFFile FFile(LtpFPath, &quot;.Ltp&quot;, false); TStr FNm;
1557    while (FFile.Next(FNm)){
1558      printf(&quot;.&quot;);
1559      PGasLtpBs GasLtpBs=TGasLtpBs::Load(FNm);
1560      TStr ProdNm=GasLtpBs-&gt;ProdNm;
1561      PGasDm GasDm=TGasDm::GetDayGasDm(GasLtpBs);
1562      TSecTm MnDate=GasLtpBs-&gt;GetMnDate();
1563      TSecTm MxDate=GasLtpBs-&gt;GetMxDate();
1564      PGasMd GasMd=TGasMd::New(
1565       gmtCTb, NULL, TGasMd::GetMdParamStr(), GasDm, MnDate, MxDate, -1, -1, 100);
1566      for (int RecN=0; RecN&lt;GasDm-&gt;GetRecs(); RecN++){
1567        double Cspt=GasDm-&gt;GetClassVal(RecN);
1568        double PredCspt=GasMd-&gt;GetPredClassVal(GasDm, RecN);
1569        if (PredCspt==0){continue;}
1570        double CorFact=Cspt/PredCspt;
1571        TSecTm Date=GasDm-&gt;GetDateVal(RecN);
1572        TDateProdNmPr DateProdNmPr(Date, ProdNm);
1573        if (!DateProdNmToCorFactMomH.IsKey(DateProdNmPr)){
1574          DateProdNmToCorFactMomH.AddDat(DateProdNmPr, TMom::New());}
1575        DateProdNmToCorFactMomH.GetDat(DateProdNmPr)-&gt;Add(CorFact);
1576      }
1577    }
1578    for (int DateProdNmP=0; DateProdNmP&lt;DateProdNmToCorFactMomH.Len(); DateProdNmP++){
1579      DateProdNmToCorFactMomH[DateProdNmP]-&gt;Def();}
1580  }
1581  double TGasMdCor::GetCorFact(const TSecTm&amp; Date, const TStr&amp; ProdNm) const {
1582    TDateProdNmPr DateProdNmPr(Date, ProdNm);
1583    int DateProdNmP;
1584    if (DateProdNmToCorFactMomH.IsKey(DateProdNmPr, DateProdNmP)){
1585      PMom CorFactMom=DateProdNmToCorFactMomH[DateProdNmP];
1586      if (CorFactMom-&gt;IsUsable()){
1587        return CorFactMom-&gt;GetMean();
1588      } else {
1589        return 1;
1590      }
1591    } else {
1592      return 1;
1593    }
1594  }
1595  void TGasMdCor::SaveTxt(const TStr&amp; FNm) const {
1596    typedef TTriple&lt;TSecTm, TStr, TInt&gt; TDateProdNmIdTr;
1597    TVec&lt;TDateProdNmIdTr&gt; DateProdNmIdTrV;
1598    for (int DateProdNmP=0; DateProdNmP&lt;DateProdNmToCorFactMomH.Len(); DateProdNmP++){
1599      TSecTm Date=DateProdNmToCorFactMomH.GetKey(DateProdNmP).Val1;
1600      TStr ProdNm=DateProdNmToCorFactMomH.GetKey(DateProdNmP).Val2;
1601      TDateProdNmIdTr DateProdNmIdTr(Date, ProdNm, DateProdNmP);
1602      DateProdNmIdTrV.Add(DateProdNmIdTr);
1603    }
1604    DateProdNmIdTrV.Sort();
1605    TFOut LogFOut(FNm); FILE* fLog=LogFOut.GetFileId();
1606    for (int DpiN=0; DpiN&lt;DateProdNmIdTrV.Len(); DpiN++){
1607      TSecTm Date=DateProdNmIdTrV[DpiN].Val1;
1608      TStr ProdNm=DateProdNmIdTrV[DpiN].Val2;
1609      int DateProdNmP=DateProdNmIdTrV[DpiN].Val3;
1610      PMom CorFactMom=DateProdNmToCorFactMomH[DateProdNmP];
1611      fprintf(fLog, &quot;%s - %-25s - %s\n&quot;,
1612       Date.GetDtStr().CStr(), ProdNm.CStr(),
1613       CorFactMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1614    }
1615  }
1616  double TGasOrder::GetQuantity(const TSecTm&amp; Dt, TGasOrderV&amp; GasOrderV){
1617    double Quantity=0;
1618    for (int GasOrderN=0; GasOrderN&lt;GasOrderV.Len(); GasOrderN++){
1619      if (GasOrderV[GasOrderN]-&gt;ReceiveDt==Dt){
1620        Quantity+=GasOrderV[GasOrderN]-&gt;Quantity;}
1621    }
1622    return Quantity;
1623  }
1624  double TGasOrder::GetQuantity(
1625   const TSecTm&amp; MnTm, const TSecTm&amp; MxTm, TGasOrderV&amp; GasOrderV){
1626    double Quantity=0;
1627    for (int GasOrderN=0; GasOrderN&lt;GasOrderV.Len(); GasOrderN++){
1628      TSecTm ReceiveDt=GasOrderV[GasOrderN]-&gt;ReceiveDt;
1629      if ((MnTm&lt;=ReceiveDt)&amp;&amp;(ReceiveDt&lt;MxTm)){
1630        Quantity+=GasOrderV[GasOrderN]-&gt;Quantity;}
1631    }
1632    return Quantity;
1633  }
1634  void TGasOrder::DelOrders(const TSecTm&amp; Dt, TGasOrderV&amp; GasOrderV){
1635    PGasOrder GasOrder=TGasOrder::New(Dt, Dt, 0, false);
1636    GasOrderV.DelAll(GasOrder);
1637  }
1638  void TGasOrder::DelOrders(
1639   const TSecTm&amp; MnTm, const TSecTm&amp; MxTm, TGasOrderV&amp; GasOrderV){
1640    for (int GasOrderN=GasOrderV.Len()-1; GasOrderN&gt;=0; GasOrderN--){
1641      TSecTm ReceiveDt=GasOrderV[GasOrderN]-&gt;ReceiveDt;
1642      if ((MnTm&lt;=ReceiveDt)&amp;&amp;(ReceiveDt&lt;MxTm)){
1643        GasOrderV.Del(GasOrderN);
1644      }
1645    }
1646  }
1647  void TGasOrder::DelUnapprovedOrders(
1648   const TSecTm&amp; MnTm, TGasOrderV&amp; GasOrderV, TStrV&amp; MsgStrV){
1649    MsgStrV.Clr();
1650    for (int GasOrderN=GasOrderV.Len()-1; GasOrderN&gt;=0; GasOrderN--){
1651      if (!GasOrderV[GasOrderN]-&gt;ApprovedP){
1652        TSecTm ReceiveDt=GasOrderV[GasOrderN]-&gt;ReceiveDt;
1653        if (MnTm&lt;=ReceiveDt){
1654          MsgStrV.Add(GasOrderV[GasOrderN]-&gt;GetStr());
1655          GasOrderV.Del(GasOrderN);
1656        }
1657      }
1658    }
1659  }
1660  PGasOrder TGasOrder::LoadXml(const PXmlTok&amp; XmlTok){
1661    TStr IssueDtStr=XmlTok-&gt;GetTagTokStr(&quot;IssueDate&quot;);
1662    TSecTm IssueDt=TSecTm::GetDtTmFromDmyStr(IssueDtStr);
1663    TStr ReceiveDtStr=XmlTok-&gt;GetTagTokStr(&quot;ReceiveDate&quot;);
1664    TSecTm ReceiveDt=TSecTm::GetDtTmFromDmyStr(ReceiveDtStr);
1665    TStr QuantityStr=XmlTok-&gt;GetTagTokStr(&quot;Quantity&quot;);
1666    double Quantity=QuantityStr.GetFlt(-1);
1667    PGasOrder GasOrder=TGasOrder::New(IssueDt, ReceiveDt, Quantity, true);
1668    return GasOrder;
1669  }
1670  void TGasOrder::SaveXml(const PSOut&amp; SOut, const TStr&amp; IndentStr) const {
1671    SOut-&gt;PutStr(IndentStr); SOut-&gt;PutStr(&quot;&lt;GasOrder&gt;\n&quot;);
1672    SOut-&gt;PutStr(IndentStr);
1673    SOut-&gt;PutStr(TStr::GetStr(IssueDt.GetDtMdyStr(), &quot;  &lt;IssueDate&gt;%s&lt;/IssueDate&gt;\n&quot;));
1674    SOut-&gt;PutStr(IndentStr);
1675    SOut-&gt;PutStr(TStr::GetStr(ReceiveDt.GetDtMdyStr(), &quot;  &lt;ReceiveDate&gt;%s&lt;/ReceiveDate&gt;\n&quot;));
1676    SOut-&gt;PutStr(IndentStr);
1677    SOut-&gt;PutStr(TFlt::GetStr(Quantity, &quot;  &lt;Quantity&gt;%g&lt;/Quantity&gt;\n&quot;));
1678    SOut-&gt;PutStr(IndentStr); SOut-&gt;PutStr(&quot;&lt;/GasOrder&gt;\n&quot;);
1679  }
1680  PGasStation TGasStation::LoadXml(const PXmlTok&amp; XmlTok){
1681    PGasStation GasStation=TGasStation::New();
1682    GasStation-&gt;DescStr=XmlTok-&gt;GetTagTokStr(&quot;Description&quot;);
1683    GasStation-&gt;ProdNm=XmlTok-&gt;GetTagTokStr(&quot;Product&quot;);
1684    GasStation-&gt;FullVolumeVal=XmlTok-&gt;GetTagTokStr(&quot;FullVolume&quot;).GetFlt(-1);
1685    GasStation-&gt;SafetyVolumeVal=XmlTok-&gt;GetTagTokStr(&quot;SafetyVolume&quot;).GetFlt(-1);
1686    GasStation-&gt;DeliveryDays=XmlTok-&gt;GetTagTokStr(&quot;DeliveryDays&quot;).GetFlt(-1);
1687    GasStation-&gt;StockDurationDays=XmlTok-&gt;GetTagTokStr(&quot;StockDurationDays&quot;).GetFlt(-1);
1688    GasStation-&gt;OrderQuantityCorFact=XmlTok-&gt;GetTagTokStr(&quot;OrderQuantityCorrection&quot;).GetFlt(-1);
1689    GasStation-&gt;ExceptPredCorFact=XmlTok-&gt;GetTagTokStr(&quot;ExceptionPredictionCorrection&quot;).GetFlt(-1);
1690    GasStation-&gt;HistWnDays=XmlTok-&gt;GetTagTokStr(&quot;HistoryWindowDays&quot;).GetFlt(-1);
1691    GasStation-&gt;TmGridHours=XmlTok-&gt;GetTagTokStr(&quot;TimeGridHours&quot;).GetFlt(-1);
1692    GasStation-&gt;VolumeVal=XmlTok-&gt;GetTagTokStr(&quot;Volume&quot;).GetFlt(-1);
1693    TXmlTokV GasOrderXmlTokV;
1694    XmlTok-&gt;GetTagTokV(&quot;GasOrderList|GasOrder&quot;, GasOrderXmlTokV);
1695    GasStation-&gt;GasOrderV.Clr();
1696    for (int GasOrderN=0; GasOrderN&lt;GasOrderXmlTokV.Len(); GasOrderN++){
1697      PGasOrder GasOrder=TGasOrder::LoadXml(GasOrderXmlTokV[GasOrderN]);
1698      GasStation-&gt;GasOrderV.Add(GasOrder);
1699    }
1700    return GasStation;
1701  }
1702  PGasStation TGasStation::LoadXml(const TStr&amp; FNm){
1703    PSIn SIn=TFIn::New(FNm);
1704    PXmlDoc XmlDoc=TXmlDoc::LoadTxt(SIn);
1705    if (!XmlDoc-&gt;IsOk()){
1706      TExcept::Throw(&quot;Invalid Xml File&quot;, SIn-&gt;GetSNm());}
1707    return LoadXml(XmlDoc-&gt;GetTok());
1708  }
1709  void TGasStation::SaveXml(const PSOut&amp; SOut) const {
1710    SOut-&gt;PutStr(&quot;&lt;GasStation&gt;\n&quot;);
1711    SOut-&gt;PutStr(TStr::GetStr(DescStr, &quot;  &lt;Description&gt;%s&lt;/Description&gt;\n&quot;));
1712    SOut-&gt;PutStr(TStr::GetStr(ProdNm, &quot;  &lt;Product&gt;%s&lt;/Product&gt;\n&quot;));
1713    SOut-&gt;PutStr(TFlt::GetStr(FullVolumeVal, &quot;  &lt;FullVolume&gt;%g&lt;/FullVolume&gt;\n&quot;));
1714    SOut-&gt;PutStr(TFlt::GetStr(SafetyVolumeVal, &quot;  &lt;SafetyVolume&gt;%g&lt;/SafetyVolume&gt;\n&quot;));
1715    SOut-&gt;PutStr(TInt::GetStr(DeliveryDays, &quot;  &lt;DeliveryDays&gt;%d&lt;/DeliveryDays&gt;\n&quot;));
1716    SOut-&gt;PutStr(TInt::GetStr(StockDurationDays, &quot;  &lt;StockDurationDays&gt;%d&lt;/StockDurationDays&gt;\n&quot;));
1717    SOut-&gt;PutStr(TFlt::GetStr(OrderQuantityCorFact, &quot;  &lt;OrderQuantityCorrection&gt;%g&lt;/OrderQuantityCorrection&gt;\n&quot;));
1718    SOut-&gt;PutStr(TFlt::GetStr(ExceptPredCorFact, &quot;  &lt;ExceptionPredictionCorrection&gt;%g&lt;/ExceptionPredictionCorrection&gt;\n&quot;));
1719    SOut-&gt;PutStr(TInt::GetStr(HistWnDays, &quot;  &lt;HistoryWindowDays&gt;%d&lt;/HistoryWindowDays&gt;\n&quot;));
1720    SOut-&gt;PutStr(TInt::GetStr(TmGridHours, &quot;  &lt;TimeGridHours&gt;%d&lt;/TimeGridHours&gt;\n&quot;));
1721    SOut-&gt;PutStr(TFlt::GetStr(VolumeVal, &quot;  &lt;Volume&gt;%g&lt;/Volume&gt;\n&quot;));
1722    SOut-&gt;PutStr(&quot;  &lt;NewGasOrderList&gt;\n&quot;);
1723    for (int GasOrderN=0; GasOrderN&lt;NewGasOrderV.Len(); GasOrderN++){
1724      NewGasOrderV[GasOrderN]-&gt;SaveXml(SOut, &quot;    &quot;);
1725    }
1726    SOut-&gt;PutStr(&quot;  &lt;/NewGasOrderList&gt;\n&quot;);
1727    SOut-&gt;PutStr(&quot;&lt;/GasStation&gt;\n&quot;);
1728  }
1729  void TGasStation::DumpDef(FILE* fOut) const {
1730    fprintf(fOut, &quot;===GasStation-Start========\n&quot;);
1731    fprintf(fOut, &quot;DescStr: %s\n&quot;, DescStr.CStr());
1732    fprintf(fOut, &quot;ProdStr: %s\n&quot;, ProdNm.CStr());
1733    fprintf(fOut, &quot;FullVolumeVal: %g\n&quot;, FullVolumeVal);
1734    fprintf(fOut, &quot;SafetyVolumeVal: %g\n&quot;, SafetyVolumeVal);
1735    fprintf(fOut, &quot;DeliveryDays: %d\n&quot;, DeliveryDays);
1736    fprintf(fOut, &quot;StockDurationDays: %d\n&quot;, StockDurationDays);
1737    fprintf(fOut, &quot;OrderQuantityCorFact: %g\n&quot;, OrderQuantityCorFact);
1738    fprintf(fOut, &quot;ExceptPredCorFact: %g\n&quot;, ExceptPredCorFact);
1739    fprintf(fOut, &quot;HistWnDays: %d\n&quot;, HistWnDays);
1740    fprintf(fOut, &quot;TmGridHours: %d\n&quot;, TmGridHours);
1741    fprintf(fOut, &quot;VolumeVal: %d\n&quot;, VolumeVal);
1742    fprintf(fOut, &quot;GasOrderV: (%d)\n&quot;, GasOrderV.Len());
1743    for (int GasOrderN=0; GasOrderN&lt;GasOrderV.Len(); GasOrderN++){
1744      fprintf(fOut, &quot;  %s\n&quot;, GasOrderV[GasOrderN]-&gt;GetStr().CStr());}
1745    fprintf(fOut, &quot;NewGasOrderV: (%d)\n&quot;, NewGasOrderV.Len());
1746    {for (int GasOrderN=0; GasOrderN&lt;NewGasOrderV.Len(); GasOrderN++){
1747      fprintf(fOut, &quot;  %s\n&quot;, NewGasOrderV[GasOrderN]-&gt;GetStr().CStr());}}
1748    fprintf(fOut, &quot;===GasStation-End==========\n&quot;);
1749  }
1750  void TGasExe::GenPredEval(
1751   const PGasMdMType&amp; GasMdMType, const TStr&amp; GasMdParamStr,
1752   const PGasMdCor&amp; GasMdCor, const bool&amp; UseMdCorP,
1753   const PGasDm&amp; GasDm,
1754   const TSecTm&amp; MnDate, const TSecTm&amp; MxDate,
1755   const int&amp; TrainWnLen, const int&amp; TestWnLen, const int&amp; WnStepLen,
1756   const double&amp; MnCspt, const double&amp; MnOutlierRelErr,
1757   const TStr&amp; LogFNm, const int&amp; LogVerbLev, const bool&amp; AppendToLog,
1758   const TStr&amp; TabLogFNm, const bool&amp; AppendToTabLog,
1759   FILE* fOlap, const TStr&amp; OlapPfxLn,
1760   TGasPredV&amp; GasPredV,
1761   PMom&amp; AllPredAbsErrMom, PMom&amp; AllPredRelErrMom,
1762   const bool&amp; PrintToScrP){
1763    TFOut LogFOut(LogFNm, AppendToLog); FILE* fLog=LogFOut.GetFileId();
1764    TFOut TabLogFOut(TabLogFNm, AppendToTabLog); FILE* fTabLog=TabLogFOut.GetFileId();
1765    TSecTm EvalStampTm=TSecTm::GetCurTm();
1766    fprintf(fLog, &quot;===Start-Evaluation======================\n&quot;);
1767    fprintf(fLog, &quot;Evaluation (%s)\n&quot;, EvalStampTm.GetStr().CStr());
1768    if (GasMdMType-&gt;GetMdTypes()==1){
1769      TGasMdType GasMdType=GasMdMType-&gt;GetMdType(0);
1770      fprintf(fLog, &quot;Training algorithm &#x27;%s&#x27;\n&quot;, TGasMd::GetGasMdTypeNm(GasMdType).CStr());
1771    } else {
1772      for (int MdTypeN=0; MdTypeN&lt;GasMdMType-&gt;GetMdTypes(); MdTypeN++){
1773        TGasMdType GasMdType=GasMdMType-&gt;GetMdType(MdTypeN);
1774        double GasMdWgt=GasMdMType-&gt;GetMdWgt(MdTypeN);
1775        fprintf(fLog, &quot;Training algorithm &#x27;%s&#x27;(%g)\n&quot;, TGasMd::GetGasMdTypeNm(GasMdType).CStr(), GasMdWgt);
1776      }
1777    }
1778    fprintf(fLog, &quot;Location/Tank/Product: %s\n&quot;, GasDm-&gt;GetDescStr().CStr());
1779    fprintf(fLog, &quot;Min. Date: %s   Max. Date: %s\n&quot;, MnDate.GetDtStr().CStr(), MxDate.GetDtStr().CStr());
1780    fprintf(fLog, &quot;Train Window: %d   Test Window: %d   Window Step: %d\n&quot;, TrainWnLen, TestWnLen, WnStepLen);
1781    fprintf(fLog, &quot;Min. Consumption: %g\n&quot;, MnCspt);
1782    if (LogVerbLev&gt;0){
1783      fprintf(fLog, &quot;=========================================\n&quot;);}
1784    GasPredV.Clr();
1785    AllPredAbsErrMom=TMom::New();
1786    AllPredRelErrMom=TMom::New();
1787    TStrV OutlierStrV;
1788    for (TSecTm Date=MnDate; Date&lt;MxDate; Date.AddDays(WnStepLen)){
1789      TSecTm StartDate=Date;
1790      TSecTm EndDate=TSecTm(Date).AddDays(TrainWnLen);
1791      TSecTm StartPredDate=TSecTm(Date).AddDays(TrainWnLen+1);
1792      TSecTm EndPredDate=TSecTm(Date).AddDays(TrainWnLen+1+TestWnLen-1);
1793      if (EndPredDate&gt;=MxDate){continue;}
1794      TIntV TrainRecNV; GasDm-&gt;GetRecNV(StartDate, EndDate, -1, -1, MnCspt, TrainRecNV);
1795      int TrainRecs=TrainRecNV.Len();
1796      if (LogVerbLev&gt;0){
1797        fprintf(fLog, &quot;---Start-Window--------------------------\n&quot;);
1798        fprintf(fLog, &quot;Training From %s   To %s (%d records)\n&quot;,
1799         StartDate.GetDtStr().CStr(), EndDate.GetDtStr().CStr(), TrainRecs);
1800        fprintf(fLog, &quot;Testing  From %s   To %s\n&quot;,
1801         StartPredDate.GetDtStr().CStr(), EndPredDate.GetDtStr().CStr());
1802      }
1803      if (double(TrainRecs)&lt;double(TrainWnLen)*0.5){continue;}
1804      PGasMd GasMd=TGasMd::New(gmtEnsemble, GasMdMType, GasMdParamStr, GasDm, StartDate, EndDate, -1, -1, MnCspt);
1805      if (PrintToScrP){GasMd-&gt;Print();}
1806      if (LogVerbLev&gt;1){
1807        fprintf(fLog, &quot;.........................................\n&quot;);}
1808      PMom PredAbsErrMom=TMom::New();
1809      PMom PredRelErrMom=TMom::New();
1810      PMom TestClassValMom=TMom::New();
1811      TIntV PredRecNV;
1812      GasDm-&gt;GetRecNV(StartPredDate, EndPredDate, -1, -1, MnCspt, PredRecNV);
1813      for (int PredRecNN=0; PredRecNN&lt;PredRecNV.Len(); PredRecNN++){
1814        int RecN=PredRecNV[PredRecNN];
1815        TSecTm Date=GasDm-&gt;GetDateVal(RecN);
1816        TStr DateStr=Date.GetDtStr();
1817        int HourN=GasDm-&gt;GetAttrVal(RecN, &quot;Hour&quot;, -1);
1818        double ClassVal=GasDm-&gt;GetClassVal(RecN);
1819        double PredClassVal=GasMd-&gt;GetCorPredClassVal(GasDm, RecN, 1.5);
1820        if (UseMdCorP){
1821          double CorFact=GasMdCor-&gt;GetCorFact(Date, GasDm-&gt;GetProdNm());
1822          PredClassVal=CorFact*PredClassVal;
1823        }
1824        double RawPredAbsErr=ClassVal-PredClassVal;
1825        double PredAbsErr=fabs(ClassVal-PredClassVal);
1826        double PredRelErr=0; double RawPredRelErr=0;
1827        if (ClassVal!=0){
1828          RawPredRelErr=(ClassVal-PredClassVal)/ClassVal;
1829          PredRelErr=fabs(RawPredRelErr);
1830        }
1831        PredAbsErrMom-&gt;Add(PredAbsErr); AllPredAbsErrMom-&gt;Add(PredAbsErr);
1832        PredRelErrMom-&gt;Add(PredRelErr); AllPredRelErrMom-&gt;Add(PredRelErr);
1833        TestClassValMom-&gt;Add(ClassVal);
1834        PGasPred GasPred=TGasPred::New();
1835        GasPred-&gt;CorrVal=ClassVal;
1836        GasPred-&gt;PredVal=PredClassVal;
1837        GasPred-&gt;AbsErr=RawPredAbsErr;
1838        GasPred-&gt;RelErr=RawPredRelErr;
1839        GasPred-&gt;Tm=GasDm-&gt;GetDateVal(RecN);
1840        GasPred-&gt;OutlierP=(PredRelErr&gt;MnOutlierRelErr);
1841        GasPred-&gt;DescStr=GasDm-&gt;GetBitsStr(RecN);
1842        GasPredV.Add(GasPred);
1843        if (LogVerbLev&gt;1){
1844          fprintf(fLog,
1845           &quot;Correct: %g   Predicted: %g   Abs-Error: %g   Rel-Error: %g   Date: %s   Hour: %d&quot;,
1846           ClassVal, PredClassVal, RawPredAbsErr, PredRelErr, DateStr.CStr(), HourN);
1847          fprintf(fLog, &quot;   Desc: {%s}&quot;, GasDm-&gt;GetBitsStr(RecN).CStr());
1848          if (PredRelErr&gt;MnOutlierRelErr){fprintf(fLog, &quot;   Outlier&quot;);}
1849          fprintf(fLog, &quot;\n&quot;);
1850        }
1851        if (fOlap!=NULL){
1852          fprintf(fOlap, &quot;%s%s\t%s\t%s\t%s\t%s\t%s\t%s\n&quot;,
1853           OlapPfxLn.CStr(),
1854           Date.GetDtMdyStr().CStr(),
1855           TTmInfo::GetMonthNm(Date.GetMonthN()).CStr(),
1856           TTmInfo::GetDayOfWeekNm(Date.GetDayOfWeekN()).CStr(),
1857           TFlt::GetStr(ClassVal).CStr(),
1858           TFlt::GetStr(PredClassVal).CStr(),
1859           TFlt::GetStr(RawPredAbsErr).CStr(),
1860           TFlt::GetStr(PredRelErr).CStr());
1861        }
1862      }
1863      PredAbsErrMom-&gt;Def();
1864      PredRelErrMom-&gt;Def();
1865      TestClassValMom-&gt;Def();
1866      if (LogVerbLev&gt;1){
1867        fprintf(fLog, &quot;.........................................\n&quot;);}
1868      if (LogVerbLev&gt;0){
1869        fprintf(fLog, &quot;Train Class Stat.: %s\n&quot;, GasMd-&gt;GetClassValMom()-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1870        fprintf(fLog, &quot;Test Class Stat.: %s\n&quot;, TestClassValMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1871        fprintf(fLog, &quot;.........................................\n&quot;);
1872        fprintf(fLog, &quot;Abs-Error: %s\n&quot;, PredAbsErrMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1873        fprintf(fLog, &quot;Rel-Error: %s\n&quot;, PredRelErrMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1874        fprintf(fLog, &quot;---End-Window----------------------------\n&quot;);
1875      }
1876      if (PrintToScrP){
1877        printf(&quot;PredAbsErr: %s\n&quot;, PredAbsErrMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1878        printf(&quot;PredRelErr: %s\n&quot;, PredRelErrMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1879        printf(&quot;Model for: %s - %s ; Predict for: %s - %s\n&quot;,
1880         StartDate.GetDtStr().CStr(), EndDate.GetDtStr().CStr(),
1881         StartPredDate.GetDtStr().CStr(), EndPredDate.GetDtStr().CStr());
1882      }
1883    }
1884    AllPredAbsErrMom-&gt;Def();
1885    AllPredRelErrMom-&gt;Def();
1886    if (LogVerbLev&gt;0){
1887      fprintf(fLog, &quot;=========================================\n&quot;);}
1888    fprintf(fLog, &quot;Abs-Error: %s\n&quot;, AllPredAbsErrMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1889    fprintf(fLog, &quot;Rel-Error: %s\n&quot;, AllPredRelErrMom-&gt;GetStr(&#x27; &#x27;, &#x27;:&#x27;, true).CStr());
1890    fprintf(fLog, &quot;Evaluation (%s)\n&quot;, EvalStampTm.GetStr().CStr());
1891    fprintf(fLog, &quot;===End-Evaluation========================\n&quot;);
1892    fprintf(fTabLog, &quot;%s\t&quot;, GasDm-&gt;GetLtpNm().CStr());
1893    fprintf(fTabLog, &quot;%s\t&quot;, GasDm-&gt;GetLocNm().CStr());
1894    fprintf(fTabLog, &quot;%s\t&quot;, GasDm-&gt;GetProdNm().CStr());
1895    fprintf(fTabLog, &quot;%s\t&quot;, GasDm-&gt;GetTypeNm().CStr());
1896    fprintf(fTabLog, &quot;%d\t&quot;, TrainWnLen);
1897    fprintf(fTabLog, &quot;%d\t&quot;, TestWnLen);
1898    fprintf(fTabLog, &quot;%s\t&quot;, GasMdMType-&gt;GetDescStr().CStr());
1899    fprintf(fTabLog, &quot;%s\t&quot;, AllPredAbsErrMom-&gt;TMom::GetValVStr().CStr());
1900    fprintf(fTabLog, &quot;%s\n&quot;, AllPredRelErrMom-&gt;TMom::GetValVStr().CStr());
1901  }
1902  void TGasExe::GenDayOrder(
1903   const TStr&amp; LogFNm,
1904   const PGasStation&amp; GasStation, const TStr&amp; OutGasStationFNm,
1905   const TSecTm&amp; StartDt, const int&amp; ProcessDays,
1906   const PGasDm&amp; GasDm,
1907   const PGasMdMType&amp; GasMdMType, const TStr&amp; GasMdParamStr,
1908   TGasSimRecV&amp; GasSimRecV){
1909    PMom TodayPredVolMom=TMom::New();
1910    PMom TodayRealVolMom=TMom::New();
1911    int UnderSafetyLevWarns=0;
1912    int ReschOrdDtWarns=0;
1913    TFOut LogSOut(LogFNm); FILE* fLog=LogSOut.GetFileId();
1914    GasStation-&gt;DumpDef(fLog);
1915    if (!StartDt.IsDef()){
1916      TExcept::Throw(&quot;Invalid start date.&quot;);}
1917    int FirstRecN=0;
1918    while (FirstRecN&lt;GasDm-&gt;GetRecs()){
1919      TSecTm CurRecDt=GasDm-&gt;GetDateVal(FirstRecN);
1920      if (CurRecDt==StartDt){break;}
1921      FirstRecN++;
1922    }
1923    if (FirstRecN==GasDm-&gt;GetRecs()){
1924      TSecTm CurRecDt=GasDm-&gt;GetDateVal(GasDm-&gt;GetRecs()-1);
1925      CurRecDt.AddDays(1);
1926      if (CurRecDt!=StartDt){
1927        TExcept::Throw(&quot;Invalid start date.&quot;, StartDt.GetDtStr());}
1928    }
1929    GasSimRecV.Clr();
1930    for (int TodayRecN=FirstRecN; TodayRecN&lt;FirstRecN+ProcessDays-1; TodayRecN++){
1931      GasDm-&gt;AssureDayRec(TodayRecN);
1932      TSecTm TodayDt=GasDm-&gt;GetDateVal(TodayRecN);
1933      TStr TodayDtStr=TodayDt.GetDtStr();
1934      fprintf(fLog, &quot;Start day at record [%d] for date [%s]\n&quot;, TodayRecN, TodayDtStr.CStr());
1935      fprintf(fLog, &quot;\tDay-Info: [%s]\n&quot;, GasDm-&gt;GetBitsStr(TodayRecN).CStr());
1936      if (TodayRecN&gt;FirstRecN){
1937        TSecTm PrevDt=GasDm-&gt;GetDateVal(TodayRecN-1);
1938        EAssertRA(TodayDt==TSecTm(PrevDt).AddDays(1),
1939         &quot;Invalid time grid&quot;, TodayDtStr);
1940      }
1941      PGasSimRec GasSimRec=TGasSimRec::New(GasStation, TodayDtStr);
1942      int MnMdRecN=TodayRecN-GasStation-&gt;HistWnDays;
1943      int MxMdRecN=TodayRecN-1;
1944      PGasMd GasMd=TGasMd::New(
1945       gmtEnsemble, GasMdMType, GasMdParamStr,
1946       GasDm,
1947       GasDm-&gt;GetDateVal(MnMdRecN), GasDm-&gt;GetDateVal(MxMdRecN), -1, -1,
1948       100);
1949      fprintf(fLog, &quot;\tCreate Model for %d records (from %d to %d)\n&quot;,
1950       MxMdRecN-MnMdRecN+1, MnMdRecN, MxMdRecN);
1951      double OrderQuantity=TGasOrder::GetQuantity(TodayDt, GasStation-&gt;GasOrderV);
1952      fprintf(fLog, &quot;\tExecuted Orders for Quantity: %.0f\n&quot;, OrderQuantity);
1953      double TodayPredCspt=GasMd-&gt;GetPredClassVal(GasDm, TodayRecN);
1954      GasDm-&gt;PutCsptIfEmpty(TodayRecN, TodayPredCspt);
1955      fprintf(fLog, &quot;\tPredicted consumption: %.0f\n&quot;, TodayPredCspt);
1956      double TodayRealCspt=GasDm-&gt;GetClassVal(TodayRecN);
1957      fprintf(fLog, &quot;\tReal consumption: %.0f\n&quot;, TodayRealCspt);
1958      double TodayPredOpenVol=GasStation-&gt;VolumeVal+OrderQuantity;
1959      double TodayPredCloseVol=TodayPredOpenVol-TodayRealCspt;
1960      if ((TodayPredOpenVol!=-1)&amp;&amp;(TodayPredCloseVol!=-1)){
1961        TodayPredVolMom-&gt;Add((TodayPredOpenVol+TodayPredCloseVol)/2);}
1962      double TodayOpenRealVol=GasDm-&gt;GetVolVal(TodayRecN);
1963      double TodayCloseRealVol=-1;
1964      if (TodayRecN+1&lt;GasDm-&gt;GetRecs()){
1965        TodayCloseRealVol=GasDm-&gt;GetVolVal(TodayRecN+1);}
1966      if ((TodayOpenRealVol!=-1)&amp;&amp;(TodayCloseRealVol!=-1)){
1967        TodayRealVolMom-&gt;Add((TodayOpenRealVol+TodayCloseRealVol)/2);}
1968      double SimVolumeVal=GasStation-&gt;VolumeVal;
1969      int SimTodayRecN=TodayRecN;
1970      int SimDays=GasStation-&gt;StockDurationDays+GasStation-&gt;DeliveryDays;
1971      fprintf(fLog, &quot;\tSimulation to generate orders for %d (%d+%d) days.\n&quot;,
1972       SimDays, GasStation-&gt;StockDurationDays, GasStation-&gt;DeliveryDays);
1973      GasSimRec-&gt;PutReal(TodayPredOpenVol, TodayRealCspt, OrderQuantity);
1974      while (SimTodayRecN-TodayRecN&lt;SimDays){
1975        GasDm-&gt;AssureDayRec(SimTodayRecN);
1976        TSecTm SimTodayDt=GasDm-&gt;GetDateVal(SimTodayRecN);
1977        TStr SimTodayDtStr=SimTodayDt.GetDtStr();
1978        double SimOrderQuantity=
1979         TGasOrder::GetQuantity(SimTodayDt, GasStation-&gt;GasOrderV);
1980        double SimPredCspt=GasMd-&gt;GetCorPredClassVal(
1981         GasDm, SimTodayRecN, GasStation-&gt;ExceptPredCorFact);
1982        GasDm-&gt;PutCsptIfEmpty(SimTodayRecN, SimPredCspt);
1983        GasSimRec-&gt;AddSimStep(SimTodayDtStr,
1984         SimVolumeVal-SimPredCspt+SimOrderQuantity,
1985         SimVolumeVal, SimPredCspt, SimOrderQuantity);
1986        fprintf(fLog, &quot;\t\tSimVolume: %.0f = (v)%.0f - (c)%.0f + (o)%.0f (Date:%s) (Day:%d)\n&quot;,
1987         SimVolumeVal-SimPredCspt+SimOrderQuantity,
1988         SimVolumeVal, SimPredCspt, SimOrderQuantity,
1989         SimTodayDtStr.CStr(), SimTodayRecN-TodayRecN);
1990        if (SimVolumeVal-SimPredCspt+SimOrderQuantity&gt;=GasStation-&gt;SafetyVolumeVal){
1991          SimVolumeVal=SimVolumeVal+SimOrderQuantity-SimPredCspt;
1992          SimTodayRecN++;
1993        } else {
1994          fprintf(fLog, &quot;\t\tUnder safety level - calculate order quantity for %d days\n&quot;,
1995           GasStation-&gt;StockDurationDays);
1996          double SubOrderQuantity=0;
1997          for (int DurDayN=0; DurDayN&lt;GasStation-&gt;StockDurationDays; DurDayN++){
1998            GasDm-&gt;AssureDayRec(SimTodayRecN+DurDayN);
1999            double SubSimPredCspt=0;
2000            if (DurDayN==0){
2001              SubSimPredCspt=GasStation-&gt;SafetyVolumeVal-
2002               (SimVolumeVal-SimPredCspt+SimOrderQuantity);
2003            } else {
2004              SubSimPredCspt=GasMd-&gt;GetCorPredClassVal(
2005               GasDm, SimTodayRecN+DurDayN, GasStation-&gt;ExceptPredCorFact);
2006            }
2007            GasDm-&gt;PutCsptIfEmpty(SimTodayRecN+DurDayN, SubSimPredCspt);
2008            GasSimRec-&gt;AddOrdStep(
2009             GasDm-&gt;GetDateVal(SimTodayRecN+DurDayN).GetDtStr(),
2010             SubOrderQuantity+SubSimPredCspt, SubOrderQuantity, SubSimPredCspt);
2011            fprintf(fLog, &quot;\t\t\tOrderQuantity: %.0f = (o)%.0f + (c)%.0f (Date:%s) (Day:%d)\n&quot;,
2012             SubOrderQuantity+SubSimPredCspt, SubOrderQuantity, SubSimPredCspt,
2013             GasDm-&gt;GetDateVal(SimTodayRecN+DurDayN).GetDtStr().CStr(), DurDayN);
2014            SubOrderQuantity+=SubSimPredCspt;
2015          }
2016          GasSimRec-&gt;PutCorrQuant(
2017           SubOrderQuantity*GasStation-&gt;OrderQuantityCorFact);
2018          fprintf(fLog, &quot;\t\t\tOrderQuantity: %.0f = %.0f * %.2f (Correction)\n&quot;,
2019           SubOrderQuantity*GasStation-&gt;OrderQuantityCorFact,
2020           SubOrderQuantity, GasStation-&gt;OrderQuantityCorFact);
2021          SubOrderQuantity*=GasStation-&gt;OrderQuantityCorFact;
2022          int OrderIssueDayRecN=SimTodayRecN-GasStation-&gt;DeliveryDays;
2023          if (OrderIssueDayRecN&lt;0){OrderIssueDayRecN=0;}
2024          if (OrderIssueDayRecN&lt;TodayRecN){
2025            fprintf(fLog, &quot;\t\tReschedule Order: [%s] to [%s] !!!\n&quot;,
2026             GasDm-&gt;GetDateVal(OrderIssueDayRecN).GetDtStr().CStr(),
2027             GasDm-&gt;GetDateVal(TodayRecN).GetDtStr().CStr());
2028            OrderIssueDayRecN=TodayRecN;
2029            ReschOrdDtWarns++;
2030          }
2031          TSecTm OrderIssueDt=GasDm-&gt;GetDateVal(OrderIssueDayRecN);
2032          TSecTm OrderReceiveDt=
2033           GasDm-&gt;GetDateVal(OrderIssueDayRecN+GasStation-&gt;DeliveryDays);
2034          TStrV MsgStrV;
2035          TGasOrder::DelUnapprovedOrders(OrderReceiveDt, GasStation-&gt;GasOrderV, MsgStrV);
2036          TGasOrder::DelUnapprovedOrders(OrderReceiveDt, GasStation-&gt;NewGasOrderV, MsgStrV);
2037          for (int MsgStrN=0; MsgStrN&lt;MsgStrV.Len(); MsgStrN++){
2038            fprintf(fLog, &quot;\t\tDelete-Order: %s\n&quot;, MsgStrV[MsgStrN].CStr());}
2039          PGasOrder GasOrder=
2040           TGasOrder::New(OrderIssueDt, OrderReceiveDt, SubOrderQuantity, false);
2041          GasStation-&gt;GasOrderV.AddSorted(GasOrder);
2042          GasStation-&gt;NewGasOrderV.AddSorted(GasOrder);
2043          fprintf(fLog, &quot;\t\tCreate-Order: %s\n&quot;, GasOrder-&gt;GetStr().CStr());
2044          break;
2045        }
2046      }
2047      fprintf(fLog, &quot;\tNewVolume: %.0f = (v)%.0f + (o)%.0f - (c)%.0f\n&quot;,
2048       GasStation-&gt;VolumeVal+OrderQuantity-TodayRealCspt,
2049       GasStation-&gt;VolumeVal, OrderQuantity, TodayRealCspt);
2050      GasStation-&gt;VolumeVal=GasStation-&gt;VolumeVal+OrderQuantity-TodayRealCspt;
2051      if (GasStation-&gt;VolumeVal&lt;GasStation-&gt;SafetyVolumeVal){
2052        UnderSafetyLevWarns++;
2053        fprintf(fLog, &quot;\tUnder safety level: %.0f&lt;%.0f !!!\n&quot;,
2054         GasStation-&gt;VolumeVal, GasStation-&gt;SafetyVolumeVal);
2055      }
2056      TGasOrder::DelOrders(TodayDt, GasStation-&gt;GasOrderV);
2057      GasSimRecV.Add(GasSimRec);
2058      fprintf(fLog, &quot;Close day at record [%d] for date [%s]\n&quot;, TodayRecN, TodayDtStr.CStr());
2059    }
2060    GasStation-&gt;SaveXml(OutGasStationFNm);
2061    GasStation-&gt;DumpDef(fLog);
2062    TodayPredVolMom-&gt;Def(); TodayRealVolMom-&gt;Def();
2063    fprintf(fLog, &quot;===Statistics-Start======================\n&quot;);
2064    fprintf(fLog, &quot;Predicted-Volume-Statistics: %s\n&quot;, TodayPredVolMom-&gt;GetStr().CStr());
2065    fprintf(fLog, &quot;     Real-Volume-Statistics: %s\n&quot;, TodayRealVolMom-&gt;GetStr().CStr());
2066    fprintf(fLog, &quot;Under-Safety-Level-Warnings: %d\n&quot;, UnderSafetyLevWarns);
2067    fprintf(fLog, &quot;  Reschedule-Order-Warnings: %d\n&quot;, ReschOrdDtWarns);
2068    fprintf(fLog, &quot;===Statistics-End========================\n&quot;);
2069  }
2070  void TGasExe::GenHourBlockOrder(
2071   const TStr&amp; LogFNm,
2072   const PGasStation&amp; GasStation, const TStr&amp; OutGasStationFNm,
2073   const TSecTm&amp; StartDt, const int&amp; ProcessDays,
2074   const PGasDm&amp; GasDm,
2075   const PGasMdMType&amp; GasMdMType, const TStr&amp; GasMdParamStr,
2076   TGasSimRecV&amp; GasSimRecV){
2077    int TmGridHours=GasStation-&gt;TmGridHours;
2078    PMom NowPredVolMom=TMom::New();
2079    PMom NowRealVolMom=TMom::New();
2080    int UnderSafetyLevWarns=0;
2081    int ReschOrdDtWarns=0;
2082    TFOut LogSOut(LogFNm); FILE* fLog=LogSOut.GetFileId();
2083    GasStation-&gt;DumpDef(fLog);
2084    if (!StartDt.IsDef()){
2085      TExcept::Throw(&quot;Invalid start date.&quot;);}
2086    int FirstRecN=0;
2087    while (FirstRecN&lt;GasDm-&gt;GetRecs()){
2088      TSecTm CurRecDt=GasDm-&gt;GetDateVal(FirstRecN);
2089      if (CurRecDt==StartDt){break;}
2090      FirstRecN++;
2091    }
2092    if (FirstRecN==GasDm-&gt;GetRecs()){
2093      TSecTm CurRecDt=GasDm-&gt;GetDateVal(GasDm-&gt;GetRecs()-1);
2094      CurRecDt.AddDays(1);
2095      if (CurRecDt!=StartDt){
2096        TExcept::Throw(&quot;Invalid start date.&quot;, StartDt.GetDtStr());}
2097    }
2098    GasSimRecV.Clr();
2099    int DayRecs=24/TmGridHours;
2100    int ProcessRecs=ProcessDays*DayRecs;
2101    for (int NowRecN=FirstRecN; NowRecN&lt;FirstRecN+ProcessRecs; NowRecN++){
2102      GasDm-&gt;AssureDayRec(NowRecN);
2103      TSecTm NowDt=GasDm-&gt;GetDateVal(NowRecN);
2104      int NowHourN=GasDm-&gt;GetHourN(NowRecN);
2105      TStr NowDtTmStr=NowDt.GetDtStr()+&quot;/&quot;+TInt::GetStr(NowHourN);
2106      TSecTm NowStartTm=TSecTm(NowDt).AddHours(NowHourN);
2107      TSecTm NowEndTm=TSecTm(NowStartTm).AddHours(TmGridHours);
2108      fprintf(fLog, &quot;Start day at record [%d] for date/hour [%s]\n&quot;, NowRecN, NowDtTmStr.CStr());
2109      fprintf(fLog, &quot;\tFrom [%s] To [%s]\n&quot;, NowStartTm.GetStr().CStr(), NowEndTm.GetStr().CStr());
2110      fprintf(fLog, &quot;\tDay-Info: [%s]\n&quot;, GasDm-&gt;GetBitsStr(NowRecN).CStr());
2111      if (NowRecN&gt;FirstRecN){
2112        TSecTm PrevDt=GasDm-&gt;GetDateVal(NowRecN-1);
2113        int PrevHourN=GasDm-&gt;GetHourN(NowRecN-1);
2114        if (NowDt==PrevDt){
2115          EAssertRA(NowHourN-PrevHourN==TmGridHours, &quot;Invalid time grid&quot;, NowDtTmStr);
2116        } else
2117        if (NowDt==TSecTm(PrevDt).AddDays(1)){
2118          EAssertRA(NowHourN==0, &quot;Invalid time grid&quot;, NowDtTmStr);
2119        }
2120      }
2121      PGasSimRec GasSimRec=TGasSimRec::New(GasStation, NowDtTmStr);
2122      int MnMdRecN=NowRecN-GasStation-&gt;HistWnDays*DayRecs;
2123      int MxMdRecN=NowRecN-1;
2124      PGasMd GasMd=TGasMd::New(
2125       gmtEnsemble, GasMdMType, GasMdParamStr,
2126       GasDm,
2127       TSecTm(), TSecTm(), MnMdRecN, MxMdRecN,
2128       100);
2129      fprintf(fLog, &quot;\tCreate Model for %d records (from %d to %d)\n&quot;,
2130       MxMdRecN-MnMdRecN+1, MnMdRecN, MxMdRecN);
2131      double OrderQuantity=
2132       TGasOrder::GetQuantity(NowStartTm, NowEndTm, GasStation-&gt;GasOrderV);
2133      fprintf(fLog, &quot;\tExecuted Orders for Quantity: %.0f\n&quot;, OrderQuantity);
2134      double NowPredCspt=GasMd-&gt;GetPredClassVal(GasDm, NowRecN);
2135      if (NowPredCspt&lt;0){NowPredCspt=0;}
2136      GasDm-&gt;PutCsptIfEmpty(NowRecN, NowPredCspt);
2137      fprintf(fLog, &quot;\tPredicted consumption: %.0f\n&quot;, NowPredCspt);
2138      double NowRealCspt=GasDm-&gt;GetClassVal(NowRecN);
2139      fprintf(fLog, &quot;\tReal consumption: %.0f\n&quot;, NowRealCspt);
2140      double NowPredOpenVol=GasStation-&gt;VolumeVal+OrderQuantity;
2141      double NowPredCloseVol=NowPredOpenVol-NowRealCspt;
2142      if ((NowPredOpenVol!=-1)&amp;&amp;(NowPredCloseVol!=-1)){
2143        NowPredVolMom-&gt;Add((NowPredOpenVol+NowPredCloseVol)/2);}
2144      double NowOpenRealVol=GasDm-&gt;GetVolVal(NowRecN);
2145      double NowCloseRealVol=-1;
2146      if (NowRecN+1&lt;GasDm-&gt;GetRecs()){
2147        NowCloseRealVol=GasDm-&gt;GetVolVal(NowRecN+1);}
2148      if ((NowOpenRealVol!=-1)&amp;&amp;(NowCloseRealVol!=-1)){
2149        NowRealVolMom-&gt;Add((NowOpenRealVol+NowCloseRealVol)/2);}
2150      double SimVolumeVal=GasStation-&gt;VolumeVal;
2151      int SimNowRecN=NowRecN;
2152      int SimDays=GasStation-&gt;StockDurationDays+GasStation-&gt;DeliveryDays;
2153      int SimRecs=SimDays*DayRecs;
2154      fprintf(fLog, &quot;\tSimulation to generate orders for %d (%d+%d) days (%d records).\n&quot;,
2155       SimDays, GasStation-&gt;StockDurationDays, GasStation-&gt;DeliveryDays, SimRecs);
2156      GasSimRec-&gt;PutReal(NowPredOpenVol, NowRealCspt, OrderQuantity);
2157      while (SimNowRecN-NowRecN&lt;SimRecs){
2158        GasDm-&gt;AssureDayRec(SimNowRecN);
2159        TSecTm SimNowDt=GasDm-&gt;GetDateVal(SimNowRecN);
2160        int SimNowHourN=GasDm-&gt;GetHourN(SimNowRecN);
2161        TStr SimNowDtTmStr=SimNowDt.GetDtStr()+&quot;/&quot;+TInt::GetStr(SimNowHourN);
2162        TSecTm SimNowStartTm=TSecTm(SimNowDt).AddHours(SimNowHourN);
2163        TSecTm SimNowEndTm=TSecTm(SimNowStartTm).AddHours(TmGridHours);
2164        double SimOrderQuantity=
2165         TGasOrder::GetQuantity(SimNowStartTm, SimNowEndTm, GasStation-&gt;GasOrderV);
2166        double SimPredCspt=GasMd-&gt;GetCorPredClassVal(
2167         GasDm, SimNowRecN, GasStation-&gt;ExceptPredCorFact);
2168        GasDm-&gt;PutCsptIfEmpty(SimNowRecN, SimPredCspt);
2169        GasSimRec-&gt;AddSimStep(SimNowDtTmStr,
2170         SimVolumeVal-SimPredCspt+SimOrderQuantity,
2171         SimVolumeVal, SimPredCspt, SimOrderQuantity);
2172        fprintf(fLog, &quot;\t\tSimVolume: %.0f = (v)%.0f - (c)%.0f + (o)%.0f (Date/Hour:%s) (Step:%d)\n&quot;,
2173         SimVolumeVal-SimPredCspt+SimOrderQuantity,
2174         SimVolumeVal, SimPredCspt, SimOrderQuantity,
2175         SimNowDtTmStr.CStr(), SimNowRecN-NowRecN);
2176        if (SimVolumeVal-SimPredCspt+SimOrderQuantity&gt;=GasStation-&gt;SafetyVolumeVal){
2177          SimVolumeVal=SimVolumeVal+SimOrderQuantity-SimPredCspt;
2178          SimNowRecN++;
2179        } else {
2180          fprintf(fLog, &quot;\t\tUnder safety level - calculate order quantity for %d days\n&quot;,
2181           GasStation-&gt;StockDurationDays);
2182          double SubOrderQuantity=0;
2183          int DurRecs=GasStation-&gt;StockDurationDays*DayRecs;
2184          for (int DurRecN=0; DurRecN&lt;DurRecs; DurRecN++){
2185            GasDm-&gt;AssureDayRec(SimNowRecN+DurRecN);
2186            TSecTm DurDt=GasDm-&gt;GetDateVal(SimNowRecN+DurRecN);
2187            int DurHourN=GasDm-&gt;GetHourN(SimNowRecN+DurRecN);
2188            TStr DurDtTmStr=DurDt.GetDtStr()+&quot;/&quot;+TInt::GetStr(DurHourN);
2189            double SubSimPredCspt=0;
2190            if (DurRecN==0){
2191              SubSimPredCspt=GasStation-&gt;SafetyVolumeVal-
2192               (SimVolumeVal-SimPredCspt+SimOrderQuantity);
2193            } else {
2194              SubSimPredCspt=GasMd-&gt;GetCorPredClassVal(
2195               GasDm, SimNowRecN+DurRecN, GasStation-&gt;ExceptPredCorFact);
2196            }
2197            GasDm-&gt;PutCsptIfEmpty(SimNowRecN+DurRecN, SubSimPredCspt);
2198            GasSimRec-&gt;AddOrdStep(
2199             DurDtTmStr,
2200             SubOrderQuantity+SubSimPredCspt, SubOrderQuantity, SubSimPredCspt);
2201            fprintf(fLog, &quot;\t\t\tOrderQuantity: %.0f = (o)%.0f + (c)%.0f (Date:%s) (Rec:%d)\n&quot;,
2202             SubOrderQuantity+SubSimPredCspt, SubOrderQuantity, SubSimPredCspt,
2203             DurDtTmStr.CStr(), DurRecN);
2204            SubOrderQuantity+=SubSimPredCspt;
2205          }
2206          GasSimRec-&gt;PutCorrQuant(
2207           SubOrderQuantity*GasStation-&gt;OrderQuantityCorFact);
2208          fprintf(fLog, &quot;\t\t\tOrderQuantity: %.0f = %.0f * %.2f (Correction)\n&quot;,
2209           SubOrderQuantity*GasStation-&gt;OrderQuantityCorFact,
2210           SubOrderQuantity, GasStation-&gt;OrderQuantityCorFact);
2211          SubOrderQuantity*=GasStation-&gt;OrderQuantityCorFact;
2212          int OrderIssueRecN=SimNowRecN-GasStation-&gt;DeliveryDays*DayRecs;
2213          if (OrderIssueRecN&lt;0){OrderIssueRecN=0;}
2214          if (OrderIssueRecN&lt;NowRecN){
2215            fprintf(fLog, &quot;\t\tReschedule Order: [%s] to [%s] !!!\n&quot;,
2216             GasDm-&gt;GetDateVal(OrderIssueRecN).GetDtStr().CStr(),
2217             GasDm-&gt;GetDateVal(NowRecN).GetDtStr().CStr());
2218            OrderIssueRecN=NowRecN;
2219            ReschOrdDtWarns++;
2220          }
2221          TSecTm OrderIssueTm=GasDm-&gt;GetDateVal(OrderIssueRecN);
2222          int OrderIssueHourN=GasDm-&gt;GetHourN(OrderIssueRecN);
2223          OrderIssueTm.AddHours(OrderIssueHourN);
2224          int DeliveryRecs=GasStation-&gt;DeliveryDays*DayRecs;
2225          TSecTm OrderReceiveTm=GasDm-&gt;GetDateVal(OrderIssueRecN+DeliveryRecs);
2226          int OrderReceiveHourN=GasDm-&gt;GetHourN(OrderIssueRecN+DeliveryRecs);
2227          OrderReceiveTm.AddHours(OrderReceiveHourN);
2228          TStrV MsgStrV;
2229          TGasOrder::DelUnapprovedOrders(OrderReceiveTm, GasStation-&gt;GasOrderV, MsgStrV);
2230          TGasOrder::DelUnapprovedOrders(OrderReceiveTm, GasStation-&gt;NewGasOrderV, MsgStrV);
2231          for (int MsgStrN=0; MsgStrN&lt;MsgStrV.Len(); MsgStrN++){
2232            fprintf(fLog, &quot;\t\tDelete-Order: %s\n&quot;, MsgStrV[MsgStrN].CStr());}
2233          PGasOrder GasOrder=
2234           TGasOrder::New(OrderIssueTm, OrderReceiveTm, SubOrderQuantity, false);
2235          GasStation-&gt;GasOrderV.AddSorted(GasOrder);
2236          GasStation-&gt;NewGasOrderV.AddSorted(GasOrder);
2237          fprintf(fLog, &quot;\t\tCreate-Order: %s\n&quot;, GasOrder-&gt;GetStr().CStr());
2238          break;
2239        }
2240      }
2241      fprintf(fLog, &quot;\tNewVolume: %.0f = (v)%.0f + (o)%.0f - (c)%.0f\n&quot;,
2242       GasStation-&gt;VolumeVal+OrderQuantity-NowRealCspt,
2243       GasStation-&gt;VolumeVal, OrderQuantity, NowRealCspt);
2244      GasStation-&gt;VolumeVal=GasStation-&gt;VolumeVal+OrderQuantity-NowRealCspt;
2245      if (GasStation-&gt;VolumeVal&lt;GasStation-&gt;SafetyVolumeVal){
2246        UnderSafetyLevWarns++;
2247        fprintf(fLog, &quot;\tUnder safety level: %.0f&lt;%.0f !!!\n&quot;,
2248         GasStation-&gt;VolumeVal, GasStation-&gt;SafetyVolumeVal);
2249      }
2250      TGasOrder::DelOrders(NowStartTm, NowEndTm, GasStation-&gt;GasOrderV);
2251      GasSimRecV.Add(GasSimRec);
2252      fprintf(fLog, &quot;Close day at record [%d] for date/hour [%s]\n&quot;, NowRecN, NowDtTmStr.CStr());
2253    }
2254    GasStation-&gt;SaveXml(OutGasStationFNm);
2255    GasStation-&gt;DumpDef(fLog);
2256    NowPredVolMom-&gt;Def(); NowRealVolMom-&gt;Def();
2257    fprintf(fLog, &quot;===Statistics-Start======================\n&quot;);
2258    fprintf(fLog, &quot;Predicted-Volume-Statistics: %s\n&quot;, NowPredVolMom-&gt;GetStr().CStr());
2259    fprintf(fLog, &quot;     Real-Volume-Statistics: %s\n&quot;, NowRealVolMom-&gt;GetStr().CStr());
2260    fprintf(fLog, &quot;Under-Safety-Level-Warnings: %d\n&quot;, UnderSafetyLevWarns);
2261    fprintf(fLog, &quot;  Reschedule-Order-Warnings: %d\n&quot;, ReschOrdDtWarns);
2262    fprintf(fLog, &quot;===Statistics-End========================\n&quot;);
2263  }
2264  int TGasExe::GenPrediction(
2265   const TStr&amp; TabFNm,
2266   const TStr&amp; _LtpFNm,
2267   const TStr&amp; LtpFPath,
2268   const bool&amp; RepairP,
2269   const TStr&amp; OutLogFNm,
2270   const TStr&amp; OutXmlFNm,
2271   const TStr&amp; MdNm,
2272   const TStr&amp; TmResNm,
2273   const TStr&amp; PredDateStr,
2274   const int&amp; PredDays,
2275   const int&amp; TrainDays,
2276   const double&amp; MnCspt,
2277   const double&amp; ExceptPredCorFact){
2278    Try;
2279    TStr LtpFNm=_LtpFNm;
2280    if ((!TabFNm.Empty())&amp;&amp;(LtpFNm.Empty())){
2281      LtpFNm=TStr::PutFExt(TabFNm, &quot;.Ltp&quot;);}
2282    TSecTm PredDate=TSecTm::GetDtTmFromDmyStr(PredDateStr);
2283    TFOut LogFOut(OutLogFNm); FILE* fLog=LogFOut.GetFileId();
2284    if (!TabFNm.Empty()){
2285      TGasLtpBs::ConvTabToLtp(TabFNm, LtpFPath, RepairP);}
2286    PGasLtpBs GasLtpBs=TGasLtpBs::Load(LtpFNm);
2287    PGasMdMType GasMdMType;
2288    if (MdNm==&quot;ctb&quot;){GasMdMType=TGasMdMType::New(gmtCTb);}
2289    else if (MdNm==&quot;svd&quot;){GasMdMType=TGasMdMType::New(gmtLr);}
2290    else if (MdNm==&quot;nnbr&quot;){GasMdMType=TGasMdMType::New(gmtNNbr);}
2291    else if (MdNm==&quot;svm&quot;){GasMdMType=TGasMdMType::New(gmtSvm);}
2292    else if (MdNm==&quot;cubist&quot;){GasMdMType=TGasMdMType::New(gmtCubist);}
2293    else if (MdNm==&quot;rtree&quot;){GasMdMType=TGasMdMType::New(gmtRegTree);}
2294    else if (MdNm==&quot;ens&quot;){
2295      GasMdMType=TGasMdMType::New();
2296      GasMdMType-&gt;AddMdTypeWgt(gmtLr, 40);
2297      GasMdMType-&gt;AddMdTypeWgt(gmtNNbr, 30);
2298      GasMdMType-&gt;AddMdTypeWgt(gmtCTb, 30);
2299      GasMdMType-&gt;NrmMdWgt();
2300    } else {
2301      TExcept::Throw(&quot;Invalid model type&quot;, MdNm);
2302    }
2303    PGasDm GasDm;
2304    if (TmResNm==&quot;w&quot;){GasDm=TGasDm::GetWeekGasDm(GasLtpBs);}
2305    else if (TmResNm==&quot;d&quot;){GasDm=TGasDm::GetDayGasDm(GasLtpBs);}
2306    else if (TmResNm==&quot;24h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 24);}
2307    else if (TmResNm==&quot;12h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 12);}
2308    else if (TmResNm==&quot;6h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 6);}
2309    else if (TmResNm==&quot;4h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 4);}
2310    else if (TmResNm==&quot;3h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 3);}
2311    else if (TmResNm==&quot;2h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 2);}
2312    else if (TmResNm==&quot;1h&quot;){GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, 1);}
2313    else {TExcept::Throw(&quot;Invalid time resolution&quot;, TmResNm);}
2314    TSecTm MnLtpDate=GasLtpBs-&gt;GetMnDate();
2315    TSecTm MxLtpDate=GasLtpBs-&gt;GetMxDate();
2316    fprintf(fLog, &quot;Minimal-Possible-Train-Date: %s\n&quot;, MnLtpDate.GetDtStr().CStr());
2317    fprintf(fLog, &quot;Maximal-Possible-Train-Date: %s\n&quot;, MxLtpDate.GetDtStr().CStr());
2318    if (PredDateStr.Empty()){
2319      PredDate=TSecTm(MxLtpDate).AddDays(1);}
2320    TSecTm StartPredDate=PredDate;
2321    TSecTm EndPredDate=TSecTm(StartPredDate).AddDays(PredDays-1);
2322    TSecTm StartTrainDate=TSecTm(StartPredDate).AddDays(-TrainDays);
2323    TSecTm EndTrainDate=TSecTm(StartPredDate).AddDays(-1);
2324    fprintf(fLog, &quot;Start-Train-Date: %s\n&quot;, StartTrainDate.GetDtStr().CStr());
2325    fprintf(fLog, &quot;End-Train-Date: %s\n&quot;, EndTrainDate.GetDtStr().CStr());
2326    fprintf(fLog, &quot;Start-Prediction-Date: %s\n&quot;, StartPredDate.GetDtStr().CStr());
2327    fprintf(fLog, &quot;End-Prediction-Date: %s\n&quot;, EndPredDate.GetDtStr().CStr());
2328    if ((StartTrainDate&lt;MnLtpDate)||(MxLtpDate&lt;StartTrainDate)){
2329      TExcept::Throw(&quot;Bad Start-Train-Date&quot;, StartTrainDate.GetStr());}
2330    if ((EndTrainDate&lt;MnLtpDate)||(MxLtpDate&lt;EndTrainDate)){
2331      TExcept::Throw(&quot;Bad End-Train-Date&quot;, EndTrainDate.GetStr());}
2332    TIntV TrainRecNV; TIntV SimPredRecNV;
2333    GasDm-&gt;GetRecNV(StartTrainDate, EndTrainDate, -1, -1, MnCspt, TrainRecNV);
2334    GasDm-&gt;GetRecNV(StartPredDate, EndPredDate, -1, -1, MnCspt, SimPredRecNV);
2335    int TrainRecs=TrainRecNV.Len(); int SimPredRecs=SimPredRecNV.Len();
2336    if (TrainRecs==0){
2337      TExcept::Throw(&quot;Empty Train Set&quot;);
2338    } else {
2339      fprintf(fLog, &quot;Train Records: %d (from %d to %d)\n&quot;,
2340       TrainRecs, TrainRecNV[0], TrainRecNV.Last());
2341    }
2342    fprintf(fLog, &quot;Simulated Prediction Records: %d\n&quot;, SimPredRecs);
2343    PGasMd GasMd=TGasMd::New(
2344     gmtEnsemble, GasMdMType,
2345     TGasMd::GetMdParamStr(),
2346     GasDm,
2347     StartTrainDate, EndTrainDate, -1, -1,
2348     MnCspt);
2349    {TFOut SOut(OutXmlFNm); FILE* fOut=SOut.GetFileId();
2350    fprintf(fOut, &quot;&lt;Predictions&gt;\n&quot;);
2351    fprintf(fOut, &quot;  &lt;Location&gt;%s&lt;/Location&gt;\n&quot;,
2352     TXmlLx::GetXmlStrFromPlainStr(GasLtpBs-&gt;GetLocNm()).CStr());
2353    fprintf(fOut, &quot;  &lt;Product&gt;%s&lt;/Product&gt;\n&quot;,
2354     TXmlLx::GetXmlStrFromPlainStr(GasLtpBs-&gt;GetProdNm()).CStr());
2355    fprintf(fOut, &quot;  &lt;LtpCode&gt;%s&lt;/LtpCode&gt;\n&quot;,
2356     TXmlLx::GetXmlStrFromPlainStr(GasLtpBs-&gt;GetLtpNm()).CStr());
2357    TSecTm CurPredDate=StartPredDate;
2358    for (int SimPredRecNN=0; SimPredRecNN&lt;SimPredRecs; SimPredRecNN++){
2359      int PredRecN=SimPredRecNV[SimPredRecNN];
2360      CurPredDate=TSecTm::GetDtTm(GasDm-&gt;GetDateVal(PredRecN));
2361      TStr PredDateStr=GasDm-&gt;GetDateVal(PredRecN).GetDtStr();
2362      int HourN=GasDm-&gt;GetAttrVal(PredRecN, &quot;Hour&quot;, -1);
2363      TStr PredTmStr;
2364      if (HourN==-1){
2365        fprintf(fLog, &quot;Prediction date: %s (record %d)\n&quot;,
2366         PredDateStr.CStr(), PredRecN);
2367         PredTmStr=PredDateStr;
2368      } else {
2369        fprintf(fLog, &quot;Prediction date: %s %d:00 (record %d)\n&quot;,
2370         PredDateStr.CStr(), HourN, PredRecN);
2371        PredTmStr=PredDateStr+&quot; &quot;+TInt::GetStr(HourN)+&quot;:00&quot;;
2372      }
2373      double PredClassVal=GasMd-&gt;GetCorPredClassVal(GasDm, PredRecN, ExceptPredCorFact);
2374      double RealClassVal=GasDm-&gt;GetClassVal(PredRecN);
2375      fprintf(fLog, &quot;Predicted Consumption: %.0f\n&quot;, PredClassVal);
2376      fprintf(fLog, &quot;Real Consumption: %.0f\n&quot;, RealClassVal);
2377      fprintf(fOut, &quot;  &lt;Prediction Mode=\&quot;Simulation\&quot;&gt;\n&quot;);
2378      fprintf(fOut, &quot;    &lt;Time&gt;%s&lt;/Time&gt;\n&quot;, PredTmStr.CStr());
2379      fprintf(fOut, &quot;    &lt;Predicted&gt;%.0f&lt;/Predicted&gt;\n&quot;, PredClassVal);
2380      if (RealClassVal!=-1){
2381        fprintf(fOut, &quot;    &lt;Real&gt;%.0f&lt;/Real&gt;\n&quot;, RealClassVal);}
2382      fprintf(fOut, &quot;  &lt;/Prediction&gt;\n&quot;);
2383    }
2384    while (CurPredDate&lt;=EndPredDate){
2385      int PredRecN=GasDm-&gt;AddTmResRec();
2386      CurPredDate=TSecTm::GetDtTm(GasDm-&gt;GetDateVal(PredRecN));
2387      TStr PredDateStr=GasDm-&gt;GetDateVal(PredRecN).GetDtStr();
2388      int HourN=GasDm-&gt;GetAttrVal(PredRecN, &quot;Hour&quot;, -1);
2389      TStr PredTmStr;
2390      if (HourN==-1){
2391        fprintf(fLog, &quot;Prediction date: %s (record %d)\n&quot;,
2392         PredDateStr.CStr(), PredRecN);
2393         PredTmStr=PredDateStr;
2394      } else {
2395        fprintf(fLog, &quot;Prediction date: %s %d:00 (record %d)\n&quot;,
2396         PredDateStr.CStr(), HourN, PredRecN);
2397        PredTmStr=PredDateStr+&quot; &quot;+TInt::GetStr(HourN)+&quot;:00&quot;;
2398      }
2399      double PredClassVal=GasMd-&gt;GetCorPredClassVal(GasDm, PredRecN, ExceptPredCorFact);
2400      GasDm-&gt;PutCsptIfEmpty(PredRecN, PredClassVal);
2401      fprintf(fLog, &quot;Predicted Consumption: %.0f\n&quot;, PredClassVal);
2402      fprintf(fOut, &quot;  &lt;Prediction Mode=\&quot;Future\&quot;&gt;\n&quot;);
2403      fprintf(fOut, &quot;    &lt;Time&gt;%s&lt;/Time&gt;\n&quot;, PredTmStr.CStr());
2404      fprintf(fOut, &quot;    &lt;Predicted&gt;%.0f&lt;/Predicted&gt;\n&quot;, PredClassVal);
2405      fprintf(fOut, &quot;  &lt;/Prediction&gt;\n&quot;);
2406    }
2407    fprintf(fOut, &quot;&lt;/Predictions&gt;\n&quot;);}
2408    return 0;
2409    Catch;
2410    return 1;
2411  }
2412  int TGasExe::GenOrder(
2413   const TStr&amp; TabFNm,
2414   const TStr&amp; _LtpFNm,
2415   const TStr&amp; InGasStationFNm,
2416   const TStr&amp; OutGasStationFNm,
2417   const TStr&amp; OutLogFNm,
2418   const TStr&amp; OutSimFNm,
2419   const TStr&amp; StartDateStr,
2420   const int&amp; ProcessDays){
2421    Try;
2422    TStr LtpFNm=_LtpFNm;
2423    if ((!TabFNm.Empty())&amp;&amp;(LtpFNm.Empty())){
2424      LtpFNm=TStr::PutFExt(TabFNm, &quot;.Ltp&quot;);}
2425    TStr LtpFPath=LtpFNm.GetFPath();
2426    TSecTm StartDt=TSecTm::GetDtTmFromDmyStr(StartDateStr);
2427    PGasMdMType GasMdMType=TGasMdMType::New();
2428    GasMdMType-&gt;AddMdTypeWgt(gmtLr, 40);
2429    GasMdMType-&gt;AddMdTypeWgt(gmtNNbr, 30);
2430    GasMdMType-&gt;AddMdTypeWgt(gmtCTb, 30);
2431    GasMdMType-&gt;NrmMdWgt();
2432    if (!TabFNm.Empty()){
2433      TGasLtpBs::ConvTabToLtp(TabFNm, LtpFPath);}
2434    PGasLtpBs GasLtpBs=TGasLtpBs::Load(LtpFNm);
2435    PGasStation GasStation=TGasStation::LoadXml(InGasStationFNm);
2436    if (GasStation-&gt;TmGridHours==24){
2437      PGasDm GasDm=TGasDm::GetDayGasDm(GasLtpBs);
2438      TGasSimRecV GasSimRecV;
2439      TGasExe::GenDayOrder(
2440       OutLogFNm,
2441       GasStation, OutGasStationFNm,
2442       StartDt, ProcessDays,
2443       GasDm,
2444       GasMdMType, TGasMd::GetMdParamStr(),
2445       GasSimRecV);
2446      if (!OutSimFNm.Empty()){
2447        TGasSimRec::SaveBin(OutSimFNm, GasSimRecV);}
2448    } else
2449    if ((0&lt;GasStation-&gt;TmGridHours)&amp;&amp;(GasStation-&gt;TmGridHours&lt;24)){
2450      PGasDm GasDm=TGasDm::GetHourBlockGasDm(GasLtpBs, GasStation-&gt;TmGridHours);
2451      TGasSimRecV GasSimRecV;
2452      TGasExe::GenHourBlockOrder(
2453       OutLogFNm,
2454       GasStation, OutGasStationFNm,
2455       StartDt, ProcessDays,
2456       GasDm,
2457       GasMdMType, TGasMd::GetMdParamStr(),
2458       GasSimRecV);
2459      if (!OutSimFNm.Empty()){
2460        TGasSimRec::SaveBin(OutSimFNm, GasSimRecV);}
2461    } else {
2462      TExcept::Throw(
2463       &quot;Time-Grid should be 0&lt;tg&lt;=24&quot;, TInt::GetStr(GasStation-&gt;TmGridHours));
2464    }
2465    return 0;
2466    Catch;
2467    return 1;
2468  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-ultra.cpp</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-ultra.cpp</div>
                </div>
                <div class="column column_space"><pre><code>1265    GasMdCubist-&gt;NamesFileStr=TStr(NamesSIn);}
1266    {PSIn DataSIn=TFIn::New(IdFNm+&quot;.data&quot;);
1267    GasMdCubist-&gt;DataFileStr=TStr(DataSIn);}
1268    {PSIn ModelSIn=TFIn::New(IdFNm+&quot;.model&quot;);
</pre></code></div>
                <div class="column column_space"><pre><code>1267    GasMdCubist-&gt;DataFileStr=TStr(DataSIn);}
1268    {PSIn ModelSIn=TFIn::New(IdFNm+&quot;.model&quot;);
1269    GasMdCubist-&gt;ModelFileStr=TStr(ModelSIn);}
1270    TFile::Del(IdFNm+&quot;.names&quot;, false);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    