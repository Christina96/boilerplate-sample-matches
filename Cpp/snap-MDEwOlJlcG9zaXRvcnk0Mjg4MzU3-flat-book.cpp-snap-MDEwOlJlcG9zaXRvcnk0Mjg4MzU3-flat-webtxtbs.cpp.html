
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 3.7037037037037033%, Tokens: 9, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-book.cpp</h3>
            <pre><code>1  #include "StdAfx.h"
2  #include "book.h"
3  THash<TStr, TBook::TBookLoadF> TBook::TypeToLoadFH(100);
4  PBook TBook::Load(TSIn& SIn){
5    TStr TypeNm(SIn);
6    TBookLoadF LoadF=TypeToLoadFH.GetDat(TypeNm);
7    return (*LoadF())(SIn);
8  }
9  bool TBook::Reg(const TStr& TypeNm, const TBookLoadF& LoadF){
10    IAssert(!TypeToLoadFH.IsKey(TypeNm));
11    TypeToLoadFH.AddDat(TypeNm, LoadF);
12    return true;
13  }
14  bool TBible::IsReg=TBible::MkReg();
15  void TBible::AddPsalm(
16   const TStr& ChpNm, const int& SecN, const int& SSecN, const TStr& SSecStr){
17    TBiblePsalm Psalm(ChpNm, SecN, SSecN, SSecStr);
18    int SecId=PsalmV.Add(Psalm);
19    TStr TitleStr=ChpNm+"|"+TInt::GetStr(SecN)+":"+TInt::GetStr(SSecN);
20    Bix->AddSec(SecId, TitleStr+" "+SSecStr);
21  }
22  TBible::TBible(const TStr& FNm):
23    TBook("Bible", "King James Version", "Religious"),
24    ChpNmSecIdKdV(), PsalmV(), Bix(TBix::New()){
25    PSIn SIn=TFIn::New(FNm);
26    TILx Lx(SIn, TFSet());
27    bool InPsalm=false; TStr ChpNm; TChA SecNChA; int SecN;
28    TChA SSecNChA; int SSecN; TStr SSecStr;
29    while (Lx.GetSym(syLn, syEof)!=syEof){
30      TChA& Ln=Lx.Str;
31      int VBarChN=Ln.SearchCh('|');
32      if ((VBarChN!=-1)&&(0<VBarChN)&&(VBarChN<Lx.Str.Len())&&
33       TCh::IsAlNum(Ln[VBarChN-1])&&TCh::IsNum(Ln[VBarChN+1])){
34        if (InPsalm){AddPsalm(ChpNm, SecN, SSecN, SSecStr);}
35        InPsalm=true;
36        ChpNm=Ln.GetSubStr(0, VBarChN-1).GetTrunc();
37        if (ChpNmSecIdKdV.Empty()||ChpNmSecIdKdV.Last().Key!=ChpNm){
38          ChpNmSecIdKdV.Add(TStrIntKd(ChpNm, PsalmV.Len()));}
39        SecNChA.Clr(); int ChN=VBarChN+1;
40        while (TCh::IsNum(Ln[ChN])){SecNChA+=Ln[ChN]; ChN++;}
41        SecN=TStr(SecNChA).GetInt();
42        IAssert(Ln[ChN]==':');
43        SSecNChA.Clr(); ChN++;
44        while (TCh::IsNum(Ln[ChN])){SSecNChA+=Ln[ChN]; ChN++;}
45        SSecN=TStr(SSecNChA).GetInt();
46        SSecStr=Ln.GetSubStr(ChN, Ln.Len()-1).GetTrunc();
47      } else
<span onclick='openModal()' class='match'>48      if (InPsalm){
49        SSecStr=(SSecStr+' '+Ln).GetTrunc();
50      }
51    }
52    if (InPsalm){AddPsalm(ChpNm, SecN, SSecN, SSecStr);}
53  }
</span>54  PBookToc TBible::GetBookToc() const {
55    PBookToc BookToc=TBookToc::New();
56    BookToc->AddLevNm("Chapter");
57    for (int ChpN=0; ChpN<ChpNmSecIdKdV.Len(); ChpN++){
58      TStr TitleNm=ChpNmSecIdKdV[ChpN].Key;
59      int SecId=ChpNmSecIdKdV[ChpN].Dat;
60      BookToc->AddItem(0, TitleNm, SecId);
61    }
62    return BookToc;
63  }
64  void TBible::GetSecInfo(
65   const int& SecId, TStr& SecIdStr, TStr& TitleStr, TStr& SecStr) const {
66    TBiblePsalm& Psalm=PsalmV[SecId];
67    SecIdStr=TInt::GetStr(SecId);
68    TitleStr=Psalm.GetChpNm()+"|"+
69     TInt::GetStr(Psalm.GetSecN())+":"+TInt::GetStr(Psalm.GetSSecN());
70    SecStr=Psalm.GetSSecStr();
71  }
</code></pre>
        </div>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-webtxtbs.cpp</h3>
            <pre><code>1  #include "webtxtbs.h"
2  void TWebTxtBsTrmSrv::PutWebTxtBsPp(const TStr& PpNm, const TStr& PpVal) const {
3    WebTxtBs->GetPp()->PutValStr(PpNm, PpVal);
4  }
5  void TWebTxtBsTrmSrv::GetWebTxtBsPp_FPath(TStr& FPath) const {
6    FPath=WebTxtBs->GetPp()->GetValStr(TWebTxtBs::PpNm_WebTxtBsFPath);
7    FPath=TStr::GetNrFPath(FPath);
8  }
9  void TWebTxtBsTrmSrv::GetWebTxtBsPp_FPath_Nm(TStr& FPath, TStr& Nm) const {
10    GetWebTxtBsPp_FPath(FPath);
11    Nm=WebTxtBs->GetPp()->GetValStr(TWebTxtBs::PpNm_WebTxtBsNm);
12  }
13  void TWebTxtBsTrmSrv::GetWebTxtBsPp_WebFilterFNm(TStr& FNm) const {
14    FNm=WebTxtBs->GetPp()->GetValStr(TWebTxtBs::PpNm_WebFilterFNm);
15  }
16  TStr TWebTxtBsTrmSrv::GetHelpStr() const {
17    return
18     "TRALALA - the well known Tralala command\r\n"
19     "SYSECHO [ACCEPT|CLOSE|String] - write welcome/nothing/String\r\n"
20     "ECHO String - write String\r\n"
21     "HELP - this help\r\n"
22     "MEM - show memory status\r\n"
23     "QUIT - quit the session\r\n"
24     "SET [field [value]] - set/show the value of field(s)\r\n"
25     "NEW - create new web-base from settings and make it active\r\n"
26     "OPEN - open existing web-base from settings and make it active\r\n"
27     "CLOSE - close active web-base\r\n"
28     "DEL - delete web-base from settings\r\n"
29     "START - start fetching of active web-base\r\n"
30     "STOP - stop fetching of active web-base\r\n"
31     "CONT - continue fetching of active web-base\r\n"
32     "GO FilterName - create web-base and start fetching\r\n"
33     "FETCH \"Domain\" [Segments] - create filter and web-base and start fetching Domain\r\n"
34     "STAT - show status of active web-base and fetching\r\n"
35     "SOCKS - show status of active sockets\r\n"
36     "HOSTS - show active hosts\r\n"
37     "QUEUE [length] - show waiting hosts\r\n"
38     "SEARCH Query - activates Query on the active web-base and write results\r\n";
39  }
40  void TWebTxtBsTrmSrv::ParseAndExeCmLn(
41   const int& CltSockId, TILx& Lx, bool& SendMsgToClt, TChA& MsgChA){
42    SendMsgToClt=true;
43    if (Lx.UcStr=="TRALALA"){
44      MsgChA+=TStr("Hopsasa")+Lx.GetStrToEoln()+"!\r\n";
45    } else
46    if (Lx.UcStr=="SYSECHO"){
47      TStr SysMsgStr=Lx.GetStrToEoln(true).GetUc();
48      if (SysMsgStr=="ACCEPT"){
49        MsgChA+="\r\n";
50        MsgChA+=TStr("      Welcome at WebBird/WebFly Index Engine (V1.0)!\r\n");
51        MsgChA+=TStr("          Time:")+TSecTm::GetCurTm().GetStr()+"\r\n";
52        MsgChA+="\r\n";
53      } else
54      if (SysMsgStr=="CLOSE"){
55        SendMsgToClt=false;
56      } else {
57        MsgChA+=SysMsgStr; MsgChA+="\r\n";
58      }
59    } else
60    if (Lx.UcStr=="ECHO"){
61      MsgChA+=Lx.GetStrToEoln(true);
62    } else
63    if (Lx.UcStr=="HELP"){
64      Lx.GetSym(syEof);
65      MsgChA+=GetHelpStr();
66    } else
67    if (Lx.UcStr=="MEM"){
68      Lx.GetSym(syEof);
69      PSysMemStat MemStat=PSysMemStat(new TSysMemStat());
70      MsgChA+=MemStat->GetInfoStr();
71    } else
72    if (Lx.UcStr=="QUIT"){
73      Lx.GetSym(syEof);
74      CloseClt(CltSockId);
75      SendMsgToClt=false;
76    } else
77    if (Lx.UcStr=="SET"){
78      PPp WebTxtBsPp=WebTxtBs->GetPp();
79      Lx.GetSym(syIdStr, syEof);
80      if (Lx.Sym==syIdStr){
81        TStr PpNm=Lx.UcStr; PPp Pp;
82        if (WebTxtBsPp->IsPp(PpNm, Pp)){
83          Lx.GetSym(syIdStr, syQStr, syInt, syEof);
84          if (Lx.Sym==syEof){
85            MsgChA+=Pp->GetStr();
86          } else
87          if (((Lx.Sym==syIdStr)||(Lx.Sym==syQStr))&&(Pp->GetTag()==ptStr)){
88            Pp->PutValStr(Lx.Str);
89          } else
90          if ((Lx.Sym==syInt)&&(Pp->GetTag()==ptInt)){
91            Pp->PutValInt(Lx.Int);
92          } else {
93            MsgChA+="Error: Bad value type.\r\n";
94          }
95        } else {
96          MsgChA+=TStr("Error: Property '")+PpNm+"' not defined.\r\n";
97        }
98      } else
99      if (Lx.Sym==syEof){
100        MsgChA+=WebTxtBsPp->GetStr();
101      } else {
102        Fail;
103      }
104    } else
105    if (Lx.UcStr=="NEW"){
106      Lx.GetSym(syEof);
107      TStr FPath; TStr Nm; GetWebTxtBsPp_FPath_Nm(FPath, Nm);
108      WebTxtBs->TxtBsNew(Nm, FPath);
109    } else
110    if (Lx.UcStr=="OPEN"){
111      Lx.GetSym(syEof);
112      TStr FPath; TStr Nm; GetWebTxtBsPp_FPath_Nm(FPath, Nm);
113      WebTxtBs->TxtBsOpenForUpdate(Nm, FPath);
114    } else
115    if (Lx.UcStr=="CLOSE"){
116      Lx.GetSym(syEof);
117      WebTxtBs->TxtBsClose();
118    } else
119    if (Lx.UcStr=="DEL"){
120      Lx.GetSym(syEof);
121      TStr FPath; TStr Nm; GetWebTxtBsPp_FPath_Nm(FPath, Nm);
122      WebTxtBs->TxtBsDel(Nm, FPath);
123    } else
124    if (Lx.UcStr=="START"){
125      Lx.GetSym(syEof);
126      TStr FPath; TStr Nm; GetWebTxtBsPp_FPath_Nm(FPath, Nm);
127      TStr WebFilterFNm; GetWebTxtBsPp_WebFilterFNm(WebFilterFNm);
128      WebTxtBs->FetchStart(Nm, FPath, WebFilterFNm);
129    } else
130    if (Lx.UcStr=="STOP"){
131      Lx.GetSym(syEof);
132      WebTxtBs->FetchStop();
133    } else
134    if (Lx.UcStr=="CONT"){
135      Lx.GetSym(syEof);
136      TStr FPath; TStr Nm; GetWebTxtBsPp_FPath_Nm(FPath, Nm);
137      WebTxtBs->FetchContinue(Nm, FPath);
138    } else
139    if (Lx.UcStr=="GO"){
140      TStr WebFilterFNm=Lx.GetStrToEoln(true);
141      WebFilterFNm=TStr::PutFExtIfEmpty(WebFilterFNm, TWebFilter::FExt);
142      TStr WebTxtBsFPath=TStr::GetNrFPath(WebFilterFNm.GetFPath());
143      TStr WebTxtBsNm=TStr::GetNrFMid(WebFilterFNm.GetFMid());
144      WebTxtBs->TxtBsNew(WebTxtBsNm, WebTxtBsFPath);
145      WebTxtBs->FetchStart(WebTxtBsNm, WebTxtBsFPath, WebFilterFNm);
146    } else
147    if (Lx.UcStr=="FETCH"){
148      Lx.GetSym(syQStr); TStr ShortcutUrlStr=Lx.Str;
149      Lx.GetSym(syInt, syEof); int MxDmSegs=-1;
150      if (Lx.Sym==syInt){MxDmSegs=Lx.Int;}
151      else {Lx.GetSym(syEof);}
152      PUrl StartUrl=TUrl::GetUrlFromShortcut(ShortcutUrlStr, "www", "si");
153      if (StartUrl->IsOk(usHttp)){
154        PWebFilter WebFilter=PWebFilter(new TWebFilter());
155        WebFilter->AddStartUrl(StartUrl->GetUrlStr());
156        TStr DmConstrStr=StartUrl->GetDmNm(MxDmSegs);
157        WebFilter->AddDmConstr(DmConstrStr);
158        TStr WebTxtBsFPath; GetWebTxtBsPp_FPath(WebTxtBsFPath);
159        TStr WebTxtBsNm(DmConstrStr);
160        WebTxtBsNm.ChangeStrAll(".", "-");
161        PutWebTxtBsPp(TWebTxtBs::PpNm_WebTxtBsNm, WebTxtBsNm);
162        TStr WebFilterFPath; GetWebTxtBsPp_FPath(WebFilterFPath);
163        TStr WebFilterFNm=WebFilterFPath+WebTxtBsNm+TWebFilter::FExt;
164        WebFilter->SaveTxt(WebFilterFNm);
165        PutWebTxtBsPp(TWebTxtBs::PpNm_WebFilterFNm, WebFilterFNm);
166        WebTxtBs->TxtBsNew(WebTxtBsNm, WebTxtBsFPath);
167        WebTxtBs->FetchStart(WebTxtBsNm, WebTxtBsFPath, WebFilterFNm);
168      } else {
169        MsgChA+=TStr("Error: Invalid url shortcut '")+ShortcutUrlStr+"'.\r\n";
170      }
171    } else
172    if (Lx.UcStr=="STAT"){
173      Lx.GetSym(syEof);
174      WebTxtBs->ReportStatus();
175    } else
176    if (Lx.UcStr=="SOCKS"){
177      Lx.GetSym(syEof);
178      WebTxtBs->ReportSocks();
179    } else
180    if (Lx.UcStr=="HOSTS"){
181      Lx.GetSym(syEof);
182      WebTxtBs->ReportHosts();
183    } else
184    if (Lx.UcStr=="QUEUE"){
185      Lx.GetSym(syInt, syEof); int ShowLen=10;
186      if (Lx.Sym==syInt){ShowLen=Lx.Int;}
187      else {Lx.GetSym(syEof);}
188      WebTxtBs->ReportQueue(ShowLen);
189    } else
190    if (Lx.UcStr=="SEARCH"){
191      TStr QueryStr=Lx.GetStrToEoln(true);
192      WebTxtBs->ReportSearch(QueryStr);
193    } else {
194      MsgChA+="Error: Bad command keyword ("+Lx.UcStr+").\r\n";
195    }
196  }
197  void TWebTxtBsTrmSrv::OnLn(const int& CltSockId, const TStr& Ln){
198    TChA InNotifyChA;
199    InNotifyChA+=TStr("[")+TInt::GetStr(CltSockId)+"] ";
200    InNotifyChA+=TStr("[")+TSecTm::GetCurTm().GetStr()+"] ";
201    InNotifyChA+=Ln;
202    TNotify::OnNotify(WebTxtBs->GetNotify(), ntInfo, InNotifyChA);
203    PSIn SIn=TMIn::New(Ln);
204    TILx Lx(SIn, TFSet()|iloExcept);
205    TChA MsgChA; bool SendMsgToClt=true;
206    Lx.GetSym();
207    if (Lx.Sym==syIdStr){
208      try {
209        ParseAndExeCmLn(CltSockId, Lx, SendMsgToClt, MsgChA);
210      }
211      catch (PExcept Except){
212        MsgChA=TStr("Error: ")+Except->GetMsgStr()+"\r\n";
213      }
214    } else {
<span onclick='openModal()' class='match'>215      if (Lx.Sym!=syEof){
216        MsgChA="Error: No command keyword.\r\n";}
217    }
218    if (SendMsgToClt){
219      SendTxtToClt(CltSockId, MsgChA);
220      SendTxtToClt(CltSockId, ">");
221    }
222  }
</span>223  TStr TWebTxtBs::PpNm_WebTxtBs="WebTxtBs";
224  TStr TWebTxtBs::PpNm_WebTxtBsFPath="BPath";
225  TStr TWebTxtBs::PpNm_WebTxtBsNm="BName";
226  TStr TWebTxtBs::PpNm_WebFilterFNm="Filter";
227  void TWebTxtBs::SendToNotifyAndTrm(const TStr& MsgStr, const bool& LnAtTrm){
228    TNotify::OnNotify(Notify, ntInfo, MsgStr);
229    if (LnAtTrm){TNotify::OnLn(TrmSrv->GetBcstNotify(), MsgStr);}
230    else {TNotify::OnTxt(TrmSrv->GetBcstNotify(), MsgStr);}
231  }
232  void TWebTxtBs::SendToStatusAndTrm(const TStr& MsgStr, const bool& LnAtTrm){
233    TNotify::OnStatus(Notify, MsgStr);
234    if (LnAtTrm){TNotify::OnLn(TrmSrv->GetBcstNotify(), MsgStr);}
235    else {TNotify::OnTxt(TrmSrv->GetBcstNotify(), MsgStr);}
236  }
237  TWebTxtBs::TWebTxtBs(const PNotify& _Notify):
238    Notify(_Notify), TrmSrv(), Pp(), TxtBs(), WebBsFetch(){
239    TrmSrv=PTrmSrv(new TWebTxtBsTrmSrv(this));
240    Pp=PPp(new TPp(PpNm_WebTxtBs, "Web-Text-Base", ptSet));
241    Pp->AddPpStr(PpNm_WebTxtBsFPath, "Web-Text-Base File-Path", "../WebBs/");
242    Pp->AddPpStr(PpNm_WebTxtBsNm, "Web-Text-Base Name", "si");
243    Pp->AddPpStr(PpNm_WebFilterFNm, "Web-Filter File-Name", "../WebBs/si.wbf");
244  }
245  void TWebTxtBs::TxtBsNew(const TStr& Nm, const TStr& FPath){
246    TxtBsClose(true);
247    TxtBs=PTxtBs(new TTxtBs(Nm, FPath, faCreate));
248    SendToStatusAndTrm(TStr("Web-Base '")+Nm+"' created at '"+FPath+"'.");
249  }
250  void TWebTxtBs::TxtBsOpenForUpdate(const TStr& Nm, const TStr& FPath){
251    TxtBsClose(true);
252    TxtBs=PTxtBs(new TTxtBs(Nm, FPath, faUpdate));
253    SendToStatusAndTrm(TStr("Web-Base '")+Nm+"' opened for update at '"+FPath+"'.");
254  }
255  void TWebTxtBs::TxtBsOpenForRdOnly(const TStr& Nm, const TStr& FPath){
256    TxtBsClose(true);
257    TxtBs=PTxtBs(new TTxtBs(Nm, FPath, faRdOnly));
258    SendToStatusAndTrm(TStr("Web-Base '")+Nm+"' opened for reading at '"+FPath+"'.");
259  }
260  void TWebTxtBs::TxtBsDel(const TStr& Nm, const TStr& FPath){
261    TxtBsClose(true);
262    TTxtBs::Del(Nm, FPath);
263    SendToStatusAndTrm(TStr("Web-Base '")+Nm+"' deleted at '"+FPath+"'.");
264  }
265  void TWebTxtBs::TxtBsClose(const bool& IsClr){
266    if (IsTxtBsActive()){
267      FetchStop(IsClr);
268      SendToStatusAndTrm("Closing Web-Base...", false);
269      TxtBs=NULL;
270      SendToStatusAndTrm("Web-Base closed.");
271    } else {
272      if (!IsClr){
273        SendToStatusAndTrm("Web-Base already closed.");
274      }
275    }
276  }
277  bool TWebTxtBs::IsFetchEnd() const {
278    if (IsFetchActive()){
279      return (WebBsFetch->GetConns()==0)&&(WebBsFetch->GetUrlQLen()==0);
280    } else {
281      return true;
282    }
283  }
284  void TWebTxtBs::FetchStart(
285   const TStr& Nm, const TStr& FPath,
286   const TStr& WebFilterFNm, const bool& IndexTxtBsP){
287    if (IsTxtBsActive()){
288      if (IsFetchActive()){
289        SendToStatusAndTrm("Web-Fetch already active.");
290      } else {
291        PWebFilter WebFilter=TWebFilter::LoadTxt(WebFilterFNm);
292        if (WebFilter.Empty()){
293          SendToStatusAndTrm(TStr("Web-Filter '")+WebFilterFNm+"' does not exist.");
294        } else {
295          WebBsFetch=PWebBsFetch(new
296           TWebBsFetch(Nm, FPath, faCreate, this, WebFilter, IndexTxtBsP));
297          WebBsFetch->GoFetch();
298        }
299      }
300    } else {
301      SendToStatusAndTrm("Web-Base not active.");
302    }
303  }
304  void TWebTxtBs::FetchContinue(const TStr& Nm, const TStr& FPath){
305    if (IsTxtBsActive()){
306      if (IsFetchActive()){
307        SendToStatusAndTrm("Web-Fetch already active.");
308      } else {
309        WebBsFetch=PWebBsFetch(new TWebBsFetch(Nm, FPath, faUpdate, this));
310        WebBsFetch->GoFetch();
311      }
312    } else {
313      SendToStatusAndTrm("Web-Base not active.");
314    }
315  }
316  void TWebTxtBs::FetchStop(const bool& IsClr){
317    if (IsTxtBsActive()){
318      if (IsFetchActive()){
319        SendToStatusAndTrm("Stopping fetching...", false);
320        WebBsFetch=NULL;
321        SendToStatusAndTrm("Fetching stopped.");
322      } else {
323        if (!IsClr){
324          SendToStatusAndTrm("Web-Fetch not active.");
325        }
326      }
327    } else {
328      SendToStatusAndTrm("Web-Base not active.");
329    }
330  }
331  TStr TWebTxtBs::GetFetchStatusStr(){
332    static const TStr ActiveStr="Active:";
333    static const TStr QueueStr=" Queue:";
334    static const TStr PgsStr=" Pages:";
335    return
336     ActiveStr+TInt::GetStr(WebBsFetch->GetConns())+
337     QueueStr+TInt::GetStr(WebBsFetch->GetUrlQLen())+
338     PgsStr+TInt::GetStr(TxtBs->GetDocs());
339  }
340  TStr TWebTxtBs::GetStatusStr(){
341    TChA StatusChA;
342    if (IsTxtBsActive()){
343      StatusChA+="Web-Base '"; StatusChA+=GetNrNm(); StatusChA+="' active.\r\n";
344      if (IsFetchActive()){
345        StatusChA+="Web-Fetch active.\r\n";
346        StatusChA+=GetFetchStatusStr(); StatusChA+="\r\n";
347      } else {
348        StatusChA+="Web-Fetch not active.\r\n";
349        StatusChA+="Pages: ";
350        StatusChA+=TInt::GetStr(TxtBs->GetDocs()); StatusChA+="\r\n";
351      }
352    } else {
353      StatusChA+="Web-Base not active.\r\n";
354    }
355    return StatusChA;
356  }
357  void TWebTxtBs::ReportStatus(){
358    SendToNotifyAndTrm(GetStatusStr());
359  }
360  void TWebTxtBs::ReportSocks(){
361    SendToNotifyAndTrm(TSock::GetSockSysStatusStr());
362  }
363  void TWebTxtBs::ReportHosts(){
364    SendToNotifyAndTrm(WebBsFetch->GetHostNmConnsPrVStr());
365  }
366  void TWebTxtBs::ReportQueue(const int& ShowLen){
367    SendToNotifyAndTrm(WebBsFetch->GetHostNmQueuedPrVStr(ShowLen));
368  }
369  void TWebTxtBs::ReportSearch(const TStr& QueryStr){
370    if (IsTxtBsActive()){
371      PTxtBsRes TxtBsRes=TxtBs->Search(QueryStr);
372      if (TxtBsRes->IsOk()){
373        SendToNotifyAndTrm(TStr("Results for query: ")+TxtBsRes->GetWixExpStr());
374        for (int DocN=0; DocN<TInt::GetMn(10, TxtBsRes->GetDocs()); DocN++){
375          TStr DocNm; TStr DocTitleStr; TStr DocStr; TStr DocCtxStr;
376          TxtBsRes->GetDocInfo(
377           DocN, 65, 200, DocNm, DocTitleStr, DocStr, DocCtxStr);
378          SendToNotifyAndTrm("-------------------------");
379          SendToNotifyAndTrm(TInt::GetStr(DocN+1)+". "+DocTitleStr);
380          SendToNotifyAndTrm(DocCtxStr);
381          SendToNotifyAndTrm(DocNm);
382        }
383        if (TxtBsRes->GetDocs()>0){
384          SendToNotifyAndTrm("---End-------------------");}
385      } else {
386        SendToNotifyAndTrm(TStr("Error: ")+TxtBsRes->GetErrMsg());
387      }
388    } else {
389      SendToStatusAndTrm("Web-Base not active.");
390    }
391  }
392  void TWebTxtBs::OnFetch(const int& &bsol;*FId*/, const PWebPg& WebPg){
393    if (!IsUrlStr(WebPg->GetUrlStr())){
394      TMem HttpRespMem; WebPg->GetHttpResp()->GetAsMem(HttpRespMem);
395      TxtBs->AddDocMem(WebPg->GetUrlStr(), HttpRespMem, WebBsFetch->IsIndexTxtBs());
396      if (WebPg->IsTxt()){
397        PWebFilter WebFilter=WebBsFetch->GetWebFilter();
398        PSIn HtmlDocSIn=TStrIn::New(WebPg->GetHttpBodyAsStr());
399        PHtmlDoc HtmlDoc=THtmlDoc::New(HtmlDocSIn, hdtHRef);
400        TStr BaseUrlStr=WebPg->GetUrlStr(); TStr RelUrlStr;
401        for (int TokN=0; TokN<HtmlDoc->GetToks(); TokN++){
402          if (WebFilter->IsUrlTok(HtmlDoc->GetTok(TokN), RelUrlStr)){
403            PUrl Url=TUrl::New(RelUrlStr, BaseUrlStr);
404            if (Url->IsOk(usHttp)){
405              WebBsFetch->SetUrlAsFinal(Url);
406              if (WebFilter->IsUrlOk(Url)&&
407               (!WebBsFetch->IsUrlEnqueued(Url))&&
408               (!IsUrlStr(Url->GetAsFinalUrlStr()))){
409                WebBsFetch->AddFetchUrl(Url);
410              }
411            }
412          }
413        }
414        WebBsFetch->GoFetch();
415      }
416    }
417  }
418  void TWebTxtBs::SaveTxt(const PSOut& SOut){
419    TxtBs->SaveTxt(SOut);
420  }
421  const TStr TWebTxtBsSrv::HostNmMacro="$localhost$";
422  const TStr TWebTxtBsSrv::PortMacro="$port$";
423  const TStr TWebTxtBsSrv::QueryMacro="$query$";
424  const TStr TWebTxtBsSrv::HitsMacro="$hits$";
425  const TStr TWebTxtBsSrv::HitNumMacro="$hit_num$";
426  const TStr TWebTxtBsSrv::DocAddrMacro="$doc_addr$";
427  const TStr TWebTxtBsSrv::DocTitleMacro="$doc_title$";
428  const TStr TWebTxtBsSrv::DocCtxMacro="$doc_context$";
429  const TStr TWebTxtBsSrv::UrlMacro="$url$";
430  const TStr TWebTxtBsSrv::NmMacro="$name$";
431  const TStr TWebTxtBsSrv::QueryUrlFldNm="Query";
432  const TStr TWebTxtBsSrv::HitSetUrlFldNm="HitSet";
433  const TStr TWebTxtBsSrv::AcceptUrlFldNm="Accept";
434  const TStr TWebTxtBsSrv::TplFExt=".tpl";
435  const TStr TWebTxtBsSrv::QueryLogFExt=".log";
436  const TStr TWebTxtBsSrv::DfTplFNm="default.tpl";
437  TStr TWebTxtBsSrv::GetRqContType(const PHttpRq& HttpRq) const {
438    TStr AcceptValStr=HttpRq->GetFldVal(THttp::AcceptFldNm);
439    if (AcceptValStr.IsStrIn(THttp::TextWmlFldVal)){
440      return THttp::TextWmlFldVal;
441    } else {
442      return THttp::TextHtmlFldVal;
443    }
444  }
445  TStr TWebTxtBsSrv::GetDfTplSetStr() const {
446    TChA ChA;
447    ChA+=".Remark 
448    ChA+=".Remark 
449    ChA+=".Variable ContentType=\"text/html\" HitSetDocs=\"10\"\r\n";
450    ChA+=".Variable ContentType=\"text/html\" StrHitSets=\"10\"\r\n";
451    ChA+=".Variable ContentType=\"text/html\" MxDocTitleLen=\"65\"\r\n";
452    ChA+=".Variable ContentType=\"text/html\" MxDocCtxLen=\"200\"\r\n";
453    ChA+="\r\n";
454    ChA+=".Template ContentType=\"text/html\" Category=\"Header\"\r\n";
455    ChA+="<HTML>\r\n";
456    ChA+="<HEAD>\r\n";
457    ChA+="  <META http-equiv=\"Content-Type\" content=\"text/html; charset=windows-1250\">\r\n";
458    ChA+="  <TITLE>Web-Prophet</TITLE>\r\n";
459    ChA+="</HEAD>\r\n";
460    ChA+="<BODY>\r\n";
461    ChA+="<CENTER>\r\n";
462    ChA+="  <FORM NAME=\"Search\" ACTION=\"http:&bsol;&bsol;$localhost$:$port$/\" METHOD=\"GET\">\r\n";
463    ChA+="    <TABLE BORDER=0 BGCOLOR=\"Orange\" CELLPADDING=0 CELLSPACING=0 WIDTH=600>\r\n";
464    ChA+="      <TR>\r\n";
465    ChA+="        <TD WIDTH=100 ALIGN=MIDDLE ROWSPAN=3>\r\n";
466    ChA+="          <A HREF=\"/\">\r\n";
467    ChA+="            <!--<IMG SRC=\"http:&bsol;&bsol;$localhost$:$port$/Prophet.gif\" VSPACE=0 WIDTH=80 HEIGHT=60 ALIGN=MIDDLE BORDER=0>-->\r\n";
468    ChA+="          </A>\r\n";
469    ChA+="        </TD>\r\n";
470    ChA+="        <TD WIDTH=300 ALIGN=LEFT VALIGN=MIDDLE ROWSPAN=3>\r\n";
471    ChA+="          <B><FONT size=-1 color=\"Yellow\" FACE=\"VERDANA,HELVETICA,ARIAL\">Search for:</FONT></B><BR>\r\n";
472    ChA+="          &nbsp;&nbsp;&nbsp;&nbsp;\r\n";
473    ChA+="          <INPUT TYPE=text NAME=Query VALUE=\"$query$\" SIZE=32>\r\n";
474    ChA+="          <!-- <INPUT TYPE=Image SRC=\"http:&bsol;&bsol;$localhost$:$port$/Go.gif\" BORDER=0>-->\r\n";
475    ChA+="        </TD>\r\n";
476    ChA+="        <TD WIDTH=100 ALIGN=LEFT VALIGN=MIDDLE ROWSPAN=3>\r\n";
477    ChA+="          <FONT FACE=\"VERDANA,HELVETICA,ARIAL\" SIZE=-1 COLOR=\"Yellow\">\r\n";
478    ChA+="            <A HREF=\"Help.html\">Help</A><BR>\r\n";
479    ChA+="            <A HREF=\"Advanced.html\">Advanced</A><BR>\r\n";
480    ChA+="            <A HREF=\"Feedback.html\">Feedback</A>\r\n";
481    ChA+="          </FONT>\r\n";
482    ChA+="        </TD>\r\n";
483    ChA+="      </TR>\r\n";
484    ChA+="    </TABLE>\r\n";
485    ChA+="\r\n";
486    ChA+="    <TABLE WIDTH=600 BGCOLOR=\"Lavender\" CELLSPACING=1 CELLPADDING=1 BORDER=0>\r\n";
487    ChA+="      <TR>\r\n";
488    ChA+="        <TD>\r\n";
489    ChA+="          <FONT FACE=Verdana,Helvetica,Arial SIZE=-2>\r\n";
490    ChA+="          <A HREF=\"Network.html\"><FONT COLOR=\"Black\">Network</FONT></A>:\r\n";
491    ChA+="          <A HREF=\"http:&bsol;&bsol;www.yahoo.com\"><FONT COLOR=\"Blue\">Yahoo!</FONT></A> |\r\n";
492    ChA+="          <A HREF=\"http:&bsol;&bsol;www.google.com\"><FONT COLOR=\"Blue\">Google</FONT></A> |\r\n";
493    ChA+="        </TD>\r\n";
494    ChA+="        <TD>\r\n";
495    ChA+="          <FONT FACE=Verdana,Helvetica,Arial SIZE=-2>\r\n";
496    ChA+="          <A HREF=\"Network.html\"><FONT COLOR=\"Blue\">All Sites...</FONT></A></FONT>\r\n";
497    ChA+="        </TD>\r\n";
498    ChA+="      </TR>\r\n";
499    ChA+="    </TABLE>\r\n";
500    ChA+="  </FORM>\r\n";
501    ChA+="</CENTER>\r\n";
502    ChA+=".End\r\n";
503    ChA+="\r\n";
504    ChA+=".Template ContentType=\"text/html\" Category=\"Footer\"\r\n";
505    ChA+="<BR>\r\n";
506    ChA+="<BR>\r\n";
507    ChA+="<CENTER>\r\n";
508    ChA+="  <FONT FACE=\"VERDANA,HELVETICA,ARIAL\" COLOR=\"Black\" SIZE=\"-2\">\r\n";
509    ChA+="    <A HREF=\"Copyright.html\">Copyright &copy</A>; 1999 <BR>\r\n";
510    ChA+="    <BR>\r\n";
511    ChA+="    All Rights Reserved.\r\n";
512    ChA+="    <BR>\r\n";
513    ChA+="  </FONT>\r\n";
514    ChA+="</CENTER>\r\n";
515    ChA+="\r\n";
516    ChA+="</BODY>\r\n";
517    ChA+="</HTML>\r\n";
518    ChA+=".End\r\n";
519    ChA+="\r\n";
520    ChA+=".Template ContentType=\"text/html\" Category=\"ResultHd\"\r\n";
521    ChA+="<b>$hits$ hits for query:</b> <i>$query$</i><br>\r\n";
522    ChA+=".End\r\n";
523    ChA+="\r\n";
524    ChA+=".Template ContentType=\"text/html\" Category=\"ResultRec\"\r\n";
525    ChA+="<br><b>$hit_num$. </b><a href=\"$doc_addr$\">$doc_title$</a><br>\r\n";
526    ChA+="$doc_context$<br>\r\n";
527    ChA+="<a href=\"$doc_addr$\">$doc_addr$</a><br>\r\n";
528    ChA+=".End\r\n";
529    ChA+="\r\n";
530    ChA+=".Template ContentType=\"text/html\" Category=\"ResultFt\"\r\n";
531    ChA+="<br><br>\r\n";
532    ChA+=".End\r\n";
533    ChA+="\r\n";
534    ChA+=".Template ContentType=\"text/html\" Category=\"HitSetHd\"\r\n";
535    ChA+="<CENTER><B>Result Pages:&nbsp;\r\n";
536    ChA+=".End\r\n";
537    ChA+="\r\n";
538    ChA+=".Template ContentType=\"text/html\" Category=\"HitSetPrev\"\r\n";
539    ChA+="<a href=\"$url$\">[&lt;&lt; Prev]</a>&nbsp;\r\n";
540    ChA+=".End\r\n";
541    ChA+="\r\n";
542    ChA+=".Template ContentType=\"text/html\" Category=\"HitSetRecLinkedNm\"\r\n";
543    ChA+="<a href=\"$url$\">$name$</a>&nbsp;\r\n";
544    ChA+=".End\r\n";
545    ChA+="\r\n";
546    ChA+=".Template ContentType=\"text/html\" Category=\"HitSetRecNm\"\r\n";
547    ChA+="$name$&nbsp;\r\n";
548    ChA+=".End\r\n";
549    ChA+="\r\n";
550    ChA+=".Template ContentType=\"text/html\" Category=\"HitSetNext\"\r\n";
551    ChA+="<a href=\"$url$\">[Next &gt;&gt;]</a>&nbsp;\r\n";
552    ChA+=".End\r\n";
553    ChA+="\r\n";
554    ChA+=".Template ContentType=\"text/html\" Category=\"HitSetFt\"\r\n";
555    ChA+="</B></CENTER>\r\n";
556    ChA+=".End\r\n";
557    ChA+="\r\n";
558    ChA+=".Template ContentType=\"text/html\" Category=\"BadQuery\"\r\n";
559    ChA+="<p><b>Invalid query:</b><i>$query$</i></p>\r\n";
560    ChA+=".End\r\n";
561    ChA+="\r\n";
562    ChA+=".Template ContentType=\"text/html\" Category=\"BadHttpRq\"\r\n";
563    ChA+="<p><b>Bad Http Request.</b></p>\r\n";
564    ChA+=".End\r\n";
565    return ChA;
566  }
567  void TWebTxtBsSrv::PrepTplSet(const TStr& FNm, const TStr& DfFNm){
568    PSIn SIn;
569    bool FExists=false; SIn=TFIn::New(FNm, FExists);
570    if (!FExists){SIn=TFIn::New(DfFNm, FExists);}
571    if (!FExists){SIn=TStrIn::New(GetDfTplSetStr());}
572    TILx Lx(SIn, TFSet()|iloRetEoln|iloSigNum|iloUniStr);
573    Lx.GetStrToEolnAndCh('.');
574    do {
575      TStr SecNm=Lx.GetStr();
576      if (SecNm=="End"){Lx.GetStrToEolnAndCh('.');}
577      else if (SecNm=="Stop"){break;}
578      else if (SecNm=="Template"){
579        Lx.GetStr("ContentType"); Lx.GetSym(syEq); TStr ContTypeStr=Lx.GetStr();
580        Lx.GetStr("Category"); Lx.GetSym(syEq); TStr CatStr=Lx.GetStr();
581        Lx.GetEoln();
582        TStr Tpl=Lx.GetStrToEolnAndCh('.');
583        Tpl.ChangeStrAll(HostNmMacro, HostNm);
584        Tpl.ChangeStrAll(PortMacro, PortNStr);
585        AddTpl(ContTypeStr, CatStr, Tpl);
586      } else if (SecNm=="Variable"){
587        Lx.GetStr("ContentType"); Lx.GetSym(syEq); TStr ContTypeStr=Lx.GetStr();
588        TStr VarNm=Lx.GetStr(); Lx.GetSym(syEq); TStr VarVal=Lx.GetStr();
589        Lx.GetEoln();
590        AddVar(ContTypeStr, VarNm, VarVal);
591        Lx.GetStrToEolnAndCh('.');
592      } else if (SecNm=="Remark"){
593        Lx.GetStrToEolnAndCh('.');
594      } else {
595        Fail;
596      }
597    } while (!Lx.IsEof());
598  }
599  TWebTxtBsSrv::TWebTxtBsSrv(const PWebTxtBs& _WebTxtBs,
600   const int& PortN, const PNotify& _Notify):
601    TWebSrv(PortN, true, _Notify),
602    Notify(_Notify),
603    WebTxtBs(_WebTxtBs),
604    HostNm(), PortNStr(TInt::GetStr(PortN)),
605    TplNmToValH(100), VarNmToValH(100),
606    SLog(){
607    TStr TplFNm; TStr QueryLogFNm;
608    GetFNms(WebTxtBs->GetNrNm(), WebTxtBs->GetNrFPath(), TplFNm, QueryLogFNm);
609    PSockHost LocalSockHost=TSockHost::GetLocalSockHost();
610    HostNm=LocalSockHost->GetHostNm();
611    PrepTplSet(TplFNm, DfTplFNm);
612    SLog=TFOut::New(QueryLogFNm, true);
613  }
614  void TWebTxtBsSrv::AddHitSetChA(
615   const PTxtBsRes& TxtBsRes, const TStr& RqContTypeStr,
616   const int& HitSetN, const int& HitSetDocs, const int& StrHitSets,
617   const PUrlEnv& UrlEnv, TChA& OutChA){
618    TStr PrevUrlStr; TStrPrV NmUrlStrPrV; TStr NextUrlStr;
619    TxtBsRes->GetHitSet(
620     HitSetN, HitSetDocs, StrHitSets, HitSetUrlFldNm, UrlEnv,
621     PrevUrlStr, NmUrlStrPrV, NextUrlStr);
622    TStr HitSetHdTpl=GetTplVal(RqContTypeStr, "HitSetHd");
623    OutChA+=HitSetHdTpl;
624    if (!PrevUrlStr.Empty()){
625      TStr HitSetPrevTpl=GetTplVal(RqContTypeStr, "HitSetPrev");
626      HitSetPrevTpl.ChangeStrAll(UrlMacro, PrevUrlStr);
627      OutChA+=HitSetPrevTpl;
628    }
629    for (int NmN=0; NmN<NmUrlStrPrV.Len(); NmN++){
630      TStr Nm=NmUrlStrPrV[NmN].Val1;
631      TStr UrlStr=NmUrlStrPrV[NmN].Val2;
632      if (UrlStr.Empty()){
633        TStr HitSetRecTpl=GetTplVal(RqContTypeStr, "HitSetRecNm");
634        HitSetRecTpl.ChangeStrAll(NmMacro, Nm);
635        OutChA+=HitSetRecTpl;
636      } else {
637        TStr HitSetRecTpl=GetTplVal(RqContTypeStr, "HitSetRecLinkedNm");
638        HitSetRecTpl.ChangeStrAll(NmMacro, Nm);
639        HitSetRecTpl.ChangeStrAll(UrlMacro, UrlStr);
640        OutChA+=HitSetRecTpl;
641      }
642    }
643    if (!NextUrlStr.Empty()){
644      TStr HitSetNextTpl=GetTplVal(RqContTypeStr, "HitSetNext");
645      HitSetNextTpl.ChangeStrAll(UrlMacro, NextUrlStr);
646      OutChA+=HitSetNextTpl;
647    }
648    TStr HitSetFtTpl=GetTplVal(RqContTypeStr, "HitSetFt");
649    OutChA+=HitSetFtTpl;
650  }
651  void TWebTxtBsSrv::OnHttpRq(const int& SockId, const PHttpRq& HttpRq){
652    TStr RqContTypeStr=THttp::TextHtmlFldVal;
653    PUrlEnv UrlEnv;
654    TStr QueryStr; TStr EQueryStr;
655    TStr HitSetStr; TStr AcceptStr;
656    if (HttpRq->IsOk()){
657      PUrl Url=HttpRq->GetUrl();
658      UrlEnv=HttpRq->GetUrlEnv();
659      if (UrlEnv->Empty()&&
660       (Url->GetPathSegs()>0)&&(!Url->GetPathSeg(0).Empty())){
661        TStr DocNm=Url->GetPathSeg(Url->GetPathSegs()-1);
662        if (WebTxtBs->GetTxtBs()->IsDoc(DocNm)){
663          TStr DocStr=WebTxtBs->GetTxtBs()->GetDocStr(DocNm);
664          PSIn HttpBodySIn=TMIn::New(DocStr);
665          PHttpResp HttpResp=
666           THttpResp::New(THttp::OkStatusCd, RqContTypeStr, false, HttpBodySIn);
667          SendHttpResp(SockId, HttpResp);
668        } else {
669          TWebSrv::OnHttpRq(SockId, HttpRq);
670        }
671        return;
672      }
673      QueryStr=UrlEnv->GetVal(QueryUrlFldNm).GetTrunc();
674      EQueryStr=THtmlLx::GetEscapedStr(QueryStr);
675      HitSetStr=UrlEnv->GetVal(HitSetUrlFldNm).GetTrunc();
676      AcceptStr=UrlEnv->GetVal(AcceptUrlFldNm).GetTrunc();
677      if (AcceptStr.Empty()){RqContTypeStr=GetRqContType(HttpRq);}
678      else {RqContTypeStr=AcceptStr;}
679    }
680    int HitSetN=1;
681    HitSetStr.IsInt(true, 1, TInt::Mx, HitSetN);
682    int HitSetDocs=GetVarVal(RqContTypeStr, "HitSetDocs").GetInt();
683    int StrHitSets=GetVarVal(RqContTypeStr, "StrHitSets").GetInt();
684    TChA OutChA(10000);
685    TStr HdTpl=GetTplVal(RqContTypeStr, "Header");
686    HdTpl.ChangeStrAll(QueryMacro, EQueryStr);
687    OutChA+=HdTpl;
688    if (HttpRq->IsOk()){
689      if (!QueryStr.Empty()){
690        PTxtBsRes TxtBsRes=WebTxtBs->Search(QueryStr);
691        TStr EWixExpStr=THtmlLx::GetEscapedStr(TxtBsRes->GetWixExpStr());
692        TChA QueryInfoChA;
693        QueryInfoChA+="Query: "+QueryStr;
694        QueryInfoChA+=" ["+TSecTm::GetCurTm().GetStr()+"]";
695        TNotify::OnNotify(Notify, ntInfo, QueryInfoChA);
696        SLog->PutStr(QueryInfoChA); SLog->PutLn(); SLog->Flush();
697        if (TxtBsRes->IsOk()){
698          TStr ResultHdTpl=GetTplVal(RqContTypeStr, "ResultHd");
699          ResultHdTpl.ChangeStrAll(QueryMacro, EWixExpStr);
700          ResultHdTpl.ChangeStrAll(HitsMacro, TInt::GetStr(TxtBsRes->GetDocs()));
701          OutChA+=ResultHdTpl;
702          int MnDocN; int MxDocN;
703          TxtBsRes->GetHitSetMnMxDocN(HitSetN, HitSetDocs, MnDocN, MxDocN);
704          for (int DocN=MnDocN; DocN<=MxDocN; DocN++){
705            int MxDocTitleLen=GetVarVal(RqContTypeStr, "MxDocTitleLen").GetInt();
706            int MxDocCtxLen=GetVarVal(RqContTypeStr, "MxDocCtxLen").GetInt();
707            TStr DocNm; TStr DocTitleStr; TStr DocStr; TStr DocCtxStr;
708            TxtBsRes->GetDocInfo(DocN, MxDocTitleLen, MxDocCtxLen,
709             DocNm, DocTitleStr, DocStr, DocCtxStr);
710            if (DocTitleStr.Empty()){DocTitleStr=DocNm;}
711            TStr ResultRecTpl=GetTplVal(RqContTypeStr, "ResultRec");
712            ResultRecTpl.ChangeStrAll(HitNumMacro, TInt::GetStr(DocN+1));
713            ResultRecTpl.ChangeStrAll(DocAddrMacro, DocNm);
714            ResultRecTpl.ChangeStrAll(DocTitleMacro, DocTitleStr);
715            ResultRecTpl.ChangeStrAll(DocCtxMacro, DocCtxStr);
716            OutChA+=ResultRecTpl;
717          }
718          TStr ResultFtTpl=GetTplVal(RqContTypeStr, "ResultFt");
719          OutChA+=ResultFtTpl;
720          AddHitSetChA(TxtBsRes, RqContTypeStr, HitSetN, HitSetDocs, StrHitSets,
721           UrlEnv, OutChA);
722        } else {
723          TStr BadQueryTpl=GetTplVal(RqContTypeStr, "BadQuery");
724          BadQueryTpl.ChangeStrAll(QueryMacro, EWixExpStr);
725          OutChA+=BadQueryTpl;
726        }
727      }
728    } else {
729      TStr BadHttpRqTpl=GetTplVal(RqContTypeStr, "BadHttpRq");
730      OutChA+=BadHttpRqTpl;
731    }
732    TStr FtTpl=GetTplVal(RqContTypeStr, "Footer");
733    FtTpl.ChangeStrAll(QueryMacro, EQueryStr);
734    OutChA+=FtTpl;
735    PSIn HttpBodySIn=TMIn::New(OutChA);
736    PHttpResp HttpResp=
737     THttpResp::New(THttp::OkStatusCd, RqContTypeStr, false, HttpBodySIn);
738    SendHttpResp(SockId, HttpResp);
739  }
740  void TWebTxtBsSrv::GetFNms(
741   const TStr& Nm, const TStr& FPath, TStr& TplFNm, TStr& QueryLogFNm){
742    TStr NrFPath=TStr::GetNrFPath(FPath);
743    TStr NrNm=TStr::GetNrFMid(Nm);
744    TplFNm=NrFPath+NrNm+TplFExt;
745    QueryLogFNm=NrFPath+NrNm+QueryLogFExt;
746  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-book.cpp</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-webtxtbs.cpp</div>
                </div>
                <div class="column column_space"><pre><code>48      if (InPsalm){
49        SSecStr=(SSecStr+' '+Ln).GetTrunc();
50      }
51    }
52    if (InPsalm){AddPsalm(ChpNm, SecN, SSecN, SSecStr);}
53  }
</pre></code></div>
                <div class="column column_space"><pre><code>215      if (Lx.Sym!=syEof){
216        MsgChA="Error: No command keyword.\r\n";}
217    }
218    if (SendMsgToClt){
219      SendTxtToClt(CltSockId, MsgChA);
220      SendTxtToClt(CltSockId, ">");
221    }
222  }
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    