
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 25, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>notepad-plus-plus-MDEwOlJlcG9zaXRvcnkzMzAxNDgxMQ==-flat-BabyGridWrapper.h</h3>
            <pre><code>1  #pragma once
2  #include "Parameters.h"
3  #include "BabyGrid.h"
4  #include "Window.h"
5  class BabyGridWrapper : public Window
6  {
7  public:
8  	BabyGridWrapper() = default;
9  	~BabyGridWrapper() = default;
10  	virtual void init(HINSTANCE hInst, HWND parent, int16_t id);
11  	virtual void destroy() {
12  		::DestroyWindow(_hSelf);
13  	};
14  	void setLineColNumber(size_t nbRow, size_t nbCol) {
15  		::SendMessage(_hSelf, BGM_SETGRIDDIM, nbRow, nbCol);
16  	};
17  	void setCursorColour(COLORREF coulour) {
18  		::SendMessage(_hSelf, BGM_SETCURSORCOLOR, coulour, 0);
19  	};
20  	void hideCursor() {
21  		setCursorColour(RGB(0, 0, 0));
22  	};
23  	void setColsNumbered(bool isNumbered = true) {
24  		::SendMessage(_hSelf, BGM_SETCOLSNUMBERED, isNumbered ? TRUE : FALSE, 0);
25  	}
26  	void setText(size_t row, size_t col, const TCHAR* text) {
27  		_BGCELL cell;
28  		cell.row = int(row);
29  		cell.col = int(col);
30  		::SendMessage(_hSelf, BGM_SETCELLDATA, reinterpret_cast<WPARAM>(&cell), reinterpret_cast<LPARAM>(text));
31  	};
32  	void makeColAutoWidth(bool autoWidth = true) {
33  		::SendMessage(_hSelf, BGM_SETCOLAUTOWIDTH, autoWidth ? TRUE : FALSE, 0);
34  	};
35  	int getSelectedRow() {
36  		return (int)::SendMessage(_hSelf, BGM_GETROW, 0, 0);
37  	};
38  	void deleteCell(int row, int col) {
39  		_BGCELL cell;
40  		cell.row = row;
<span onclick='openModal()' class='match'>41  		cell.col = col;
42  		::SendMessage(_hSelf, BGM_DELETECELL, reinterpret_cast<WPARAM>(&cell), 0);
43  	};
</span>44  	void setColWidth(unsigned int col, unsigned int width) {
45  		::SendMessage(_hSelf, BGM_SETCOLWIDTH, col, width);
46  	};
47  	void clear() {
48  		::SendMessage(_hSelf, BGM_CLEARGRID, 0, 0);
49  	};
50  	int getNumberRows() const {
51  		return (int)::SendMessage(_hSelf, BGM_GETROWS, 0, 0);
52  	};
53  	int getHomeRow() const {
54  		return (int)::SendMessage(_hSelf, BGM_GETHOMEROW, 0, 0);
55  	};
56  	void setLastView(const size_t homeRow, const size_t cursorRow) const {
57  		::SendMessage(_hSelf, BGM_SETLASTVIEW, homeRow, cursorRow);
58  	};
59  	void updateView() const {
60  		::SendMessage(_hSelf, WM_PAINT, 0, 0);
61  	};
62  	void setTextColor(const COLORREF color) const {
63  		::SendMessage(_hSelf, BGM_SETTEXTCOLOR, color, 0);
64  	}
65  	void setBackgroundColor(const COLORREF color) const {
66  		::SendMessage(_hSelf, BGM_SETBACKGROUNDCOLOR, color, 0);
67  	}
68  	void setUnprotectColor(const COLORREF color) const {
69  		::SendMessage(_hSelf, BGM_SETUNPROTECTCOLOR, color, 0);
70  	}
71  	void setTitleTextColor(const COLORREF color) const {
72  		::SendMessage(_hSelf, BGM_SETTITLETEXTCOLOR, color, 0);
73  	}
74  	void setTitleColor(const COLORREF color) const {
75  		::SendMessage(_hSelf, BGM_SETTITLECOLOR, color, 0);
76  	}
77  	void setTitleGridlinesColor(const COLORREF color) const {
78  		::SendMessage(_hSelf, BGM_SETTITLEGRIDLINECOLOR, color, 0);
79  	}
80  	void setHighlightTextColor(const COLORREF color) const {
81  		::SendMessage(_hSelf, BGM_SETHILIGHTTEXTCOLOR, color, 0);
82  	}
83  	void setHighlightColor(const COLORREF color) const {
84  		::SendMessage(_hSelf, BGM_SETHILIGHTCOLOR, color, 0);
85  	}
86  	void setHighlightColorNoFocus(const COLORREF color) const {
87  		::SendMessage(_hSelf, BGM_SETHILIGHTCOLOR_NOFOCUS, color, 0);
88  	}
89  	void setProtectColor(const COLORREF color) const {
90  		::SendMessage(_hSelf, BGM_SETPROTECTCOLOR, color, 0);
91  	}
92  	void setHighlightColorProtect(const COLORREF color) const {
93  		::SendMessage(_hSelf, BGM_SETHILIGHTCOLOR_PROTECT, color, 0);
94  	}
95  	void setHighlightColorProtectNoFocus(const COLORREF color) const {
96  		::SendMessage(_hSelf, BGM_SETHILIGHTCOLOR_PROTECT_NOFOCUS, color, 0);
97  	}
98  	void setGridlinesColor(const COLORREF color) const {
99  		::SendMessage(_hSelf, BGM_SETGRIDLINECOLOR, color, 0);
100  	}
101  	bool setMarker(const bool isMarker) const {
102  		::SendMessage(_hSelf, BGM_SETPROTECT, isMarker, 0);
103  		return isMarker;
104  	};
105  	void setAutoRow(const bool isAutoRow) const {
106  		::SendMessage(_hSelf, BGM_AUTOROW, isAutoRow, 0);
107  	};
108  	void setInitialContent(const bool isInitialContent) const {
109  		::SendMessage(_hSelf, BGM_SETINITIALCONTENT, isInitialContent, 0);
110  	};
111  	void setHeaderFont(const HFONT& hFont) const {
112  		::SendMessage(_hSelf, BGM_SETHEADINGFONT, reinterpret_cast<WPARAM>(hFont), 0);
113  	};
114  	void setRowFont(const HFONT& hFont) const {
115  		::SendMessage(_hSelf, WM_SETFONT, reinterpret_cast<WPARAM>(hFont), 0);
116  	};
117  	void setHeaderHeight(const size_t headerHeight) const {
118  		::SendMessage(_hSelf, BGM_SETHEADERROWHEIGHT, headerHeight, 0);
119  	};
120  	void setRowHeight(const size_t rowHeight) const {
121  		::SendMessage(_hSelf, BGM_SETROWHEIGHT, rowHeight, 0);
122  	};
123  private:
124  	static bool _isRegistered;
125  };
</code></pre>
        </div>
        <div class="column">
            <h3>notepad-plus-plus-MDEwOlJlcG9zaXRvcnkzMzAxNDgxMQ==-flat-FindReplaceDlg.cpp</h3>
            <pre><code>1  #include <shlwapi.h>
2  #include "FindReplaceDlg.h"
3  #include "ScintillaEditView.h"
4  #include "Notepad_plus_msgs.h"
5  #include "localization.h"
6  #include "Common.h"
7  #include "Utf8.h"
8  using namespace std;
9  FindOption * FindReplaceDlg::_env;
10  FindOption FindReplaceDlg::_options;
11  #define SHIFTED 0x8000
12  void addText2Combo(const TCHAR * txt2add, HWND hCombo)
13  {
14  	if (!hCombo) return;
15  	if (!lstrcmp(txt2add, TEXT(""))) return;
16  	auto i = ::SendMessage(hCombo, CB_FINDSTRINGEXACT, static_cast<WPARAM>(-1), reinterpret_cast<LPARAM>(txt2add));
17  	if (i != CB_ERR) 
18  	{
19  		::SendMessage(hCombo, CB_DELETESTRING, i, 0);
20  	}
21  	i = ::SendMessage(hCombo, CB_INSERTSTRING, 0, reinterpret_cast<LPARAM>(txt2add));
22  	::SendMessage(hCombo, CB_SETCURSEL, i, 0);
23  }
24  generic_string getTextFromCombo(HWND hCombo)
25  {
26  	TCHAR str[FINDREPLACE_MAXLENGTH] = { '\0' };
27  	::SendMessage(hCombo, WM_GETTEXT, FINDREPLACE_MAXLENGTH - 1, reinterpret_cast<LPARAM>(str));
28  	return generic_string(str);
29  }
30  void delLeftWordInEdit(HWND hEdit)
31  {
32  	TCHAR str[FINDREPLACE_MAXLENGTH] = { '\0' };
33  	::SendMessage(hEdit, WM_GETTEXT, FINDREPLACE_MAXLENGTH - 1, reinterpret_cast<LPARAM>(str));
34  	WORD cursor = 0;
35  	::SendMessage(hEdit, EM_GETSEL, (WPARAM)&cursor, 0);
36  	WORD wordstart = cursor;
37  	while (wordstart > 0) {
38  		TCHAR c = str[wordstart - 1];
39  		if (c != ' ' && c != '\t')
40  			break;
41  		--wordstart;
42  	}
43  	while (wordstart > 0) {
44  		TCHAR c = str[wordstart - 1];
45  		if (c == ' ' || c == '\t')
46  			break;
47  		--wordstart;
48  	}
49  	if (wordstart < cursor) {
50  		::SendMessage(hEdit, EM_SETSEL, (WPARAM)wordstart, (LPARAM)cursor);
51  		::SendMessage(hEdit, EM_REPLACESEL, (WPARAM)TRUE, reinterpret_cast<LPARAM>(L""));
52  	}
53  }
54  LRESULT run_swapButtonProc(WNDPROC oldEditProc, HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)
55  {
56  	switch (message)
57  	{
58  		case WM_RBUTTONUP:
59  		{
60  			::SendMessage(GetParent(hwnd), message, wParam, lParam);
61  			break;
62  		}
63  		default:
64  			break;
65  	}
66  	return ::CallWindowProc(oldEditProc, hwnd, message, wParam, lParam);
67  }
68  int Searching::convertExtendedToString(const TCHAR * query, TCHAR * result, int length)
69  {	
70  	int i = 0, j = 0;
71  	int charLeft = length;
72  	TCHAR current;
73  	while (i < length)
74  	{	
75  		current = query[i];
76  		--charLeft;
77  		if (current == '\\' && charLeft)
78  		{	
79  			++i;
80  			--charLeft;
81  			current = query[i];
82  			switch(current)
83  			{
84  				case 'r':
85  					result[j] = '\r';
86  					break;
87  				case 'n':
88  					result[j] = '\n';
89  					break;
90  				case '0':
91  					result[j] = '\0';
92  					break;
93  				case 't':
94  					result[j] = '\t';
95  					break;
96  				case '\\':
97  					result[j] = '\\';
98  					break;
99  				case 'b':
100  				case 'd':
101  				case 'o':
102  				case 'x':
103  				case 'u':
104  				{
105  					int size = 0, base = 0;
106  					if (current == 'b')
107  					{	
108  						size = 8, base = 2;
109  					}
110  					else if (current == 'o')
111  					{	
112  						size = 3, base = 8;
113  					}
114  					else if (current == 'd')
115  					{	
116  						size = 3, base = 10;
117  					}
118  					else if (current == 'x')
119  					{	
120  						size = 2, base = 16;
121  					}
122  					else if (current == 'u')
123  					{	
124  						size = 4, base = 16;
125  					}
126  					if (charLeft >= size)
127  					{
128  						int res = 0;
129  						if (Searching::readBase(query+(i+1), &res, base, size))
130  						{
131  							result[j] = static_cast<TCHAR>(res);
132  							i += size;
133  							break;
134  						}
135  					}
136  					[[fallthrough]];
137  				}
138  				default:
139  				{	
140  					result[j] = '\\';
141  					++j;
142  					result[j] = current;
143  					break;
144  				}
145  			}
146  		}
147  		else
148  		{
149  			result[j] = query[i];
150  		}
151  		++i;
152  		++j;
153  	}
154  	result[j] = 0;
155  	return j;
156  }
157  bool Searching::readBase(const TCHAR * str, int * value, int base, int size)
158  {
159  	int i = 0, temp = 0;
160  	*value = 0;
161  	TCHAR max = '0' + static_cast<TCHAR>(base) - 1;
162  	TCHAR current;
163  	while (i < size)
164  	{
165  		current = str[i];
166  		if (current >= 'A')
167  		{
168  			current &= 0xdf;
169  			current -= ('A' - '0' - 10);
170  		}
171  		else if (current > '9')
172  			return false;
173  		if (current >= '0' && current <= max)
174  		{
175  			temp *= base;
176  			temp += (current - '0');
177  		}
178  		else
179  		{
180  			return false;
181  		}
182  		++i;
183  	}
184  	*value = temp;
185  	return true;
186  }
187  void Searching::displaySectionCentered(size_t posStart, size_t posEnd, ScintillaEditView * pEditView, bool isDownwards)
188  {
189  	pEditView->execute(SCI_ENSUREVISIBLE, pEditView->execute(SCI_LINEFROMPOSITION, posStart));
190  	pEditView->execute(SCI_ENSUREVISIBLE, pEditView->execute(SCI_LINEFROMPOSITION, posEnd));
191  	pEditView->execute(SCI_SETVISIBLEPOLICY, CARET_JUMPS | CARET_EVEN);
192  	pEditView->execute(SCI_ENSUREVISIBLEENFORCEPOLICY, pEditView->execute(SCI_LINEFROMPOSITION, isDownwards ? posEnd : posStart));
193  	pEditView->execute(SCI_GOTOPOS, isDownwards ? posEnd : posStart);
194  	pEditView->execute(SCI_SETVISIBLEPOLICY, CARET_EVEN);
195  	pEditView->execute(SCI_ENSUREVISIBLEENFORCEPOLICY, pEditView->execute(SCI_LINEFROMPOSITION, isDownwards ? posEnd : posStart));
196  	pEditView->execute(SCI_SCROLLRANGE, posStart, posEnd);
197  	pEditView->execute(SCI_GOTOPOS, posEnd);
198  	pEditView->execute(SCI_SETANCHOR, posStart);
199  	pEditView->execute(SCI_CHOOSECARETX);
200  }
201  WNDPROC FindReplaceDlg::originalFinderProc = nullptr;
202  WNDPROC FindReplaceDlg::originalComboEditProc = nullptr;
203  const int STYLING_MASK = 255;
204  FindReplaceDlg::~FindReplaceDlg()
205  {
206  	_tab.destroy();
207  	delete _pFinder;
208  	for (int n = static_cast<int32_t>(_findersOfFinder.size()) - 1; n >= 0; n--)
209  	{
210  		delete _findersOfFinder[n];
211  		_findersOfFinder.erase(_findersOfFinder.begin() + n);
212  	}
213  	if (_shiftTrickUpTip)
214  		::DestroyWindow(_shiftTrickUpTip);
215  	if (_2ButtonsTip)
216  		::DestroyWindow(_2ButtonsTip);
217  	if (_filterTip)
218  		::DestroyWindow(_filterTip);
219  	if (_hMonospaceFont)
220  		::DeleteObject(_hMonospaceFont);
221  	if (_hLargerBolderFont)
222  		::DeleteObject(_hLargerBolderFont);
223  	if (_hCourrierNewFont)
224  		::DeleteObject(_hCourrierNewFont);
225  	delete[] _uniFileName;
226  }
227  void FindReplaceDlg::create(int dialogID, bool isRTL, bool msgDestParent, bool toShow)
228  {
229  	StaticDialog::create(dialogID, isRTL, msgDestParent);
230  	fillFindHistory();
231  	_currentStatus = REPLACE_DLG;
232  	initOptionsFromDlg();
233  	_statusBar.init(GetModuleHandle(NULL), _hSelf, 0);
234  	_statusBar.display();
235  	DPIManager& dpiManager = NppParameters::getInstance()._dpiManager;
236  	RECT rect{};
237  	getClientRect(rect);
238  	_tab.init(_hInst, _hSelf, false, true);
239  	NppDarkMode::subclassTabControl(_tab.getHSelf());
240  	int tabDpiDynamicalHeight = dpiManager.scaleY(13);
241  	_tab.setFont(TEXT("Tahoma"), tabDpiDynamicalHeight);
242  	const TCHAR *find = TEXT("Find");
243  	const TCHAR *replace = TEXT("Replace");
244  	const TCHAR *findInFiles = TEXT("Find in Files");
245  	const TCHAR *findInProjects = TEXT("Find in Projects");
246  	const TCHAR *mark = TEXT("Mark");
247  	_tab.insertAtEnd(find);
248  	_tab.insertAtEnd(replace);
249  	_tab.insertAtEnd(findInFiles);
250  	_tab.insertAtEnd(findInProjects);
251  	_tab.insertAtEnd(mark);
252  	_tab.reSizeTo(rect);
253  	_tab.display();
254  	_initialClientWidth = rect.right - rect.left;
255  	getWindowRect(_initialWindowRect);
256  	_initialWindowRect.right = _initialWindowRect.right - _initialWindowRect.left + dpiManager.scaleX(10);
257  	_initialWindowRect.left = 0;
258  	_initialWindowRect.bottom = _initialWindowRect.bottom - _initialWindowRect.top;
259  	_initialWindowRect.top = 0;
260  	RECT dlgRc{};
261  	getWindowRect(dlgRc);
262  	RECT countRc{};
263  	::GetWindowRect(::GetDlgItem(_hSelf, IDCCOUNTALL), &countRc);
264  	NppParameters& nppParam = NppParameters::getInstance();
265  	NppGUI& nppGUI = nppParam.getNppGUI();
266  	const UINT swpFlags = toShow ? SWP_SHOWWINDOW : SWP_HIDEWINDOW;
267  	if (nppGUI._findWindowPos.bottom - nppGUI._findWindowPos.top != 0)  
268  	{
269  		RECT rc = getViewablePositionRect(nppGUI._findWindowPos);
270  		::SetWindowPos(_hSelf, HWND_TOP, rc.left, rc.top, rc.right - rc.left, rc.bottom - rc.top, swpFlags);
271  	}
272  	else
273  	{
274  		goToCenter(swpFlags);
275  	}
276  	RECT rcStatusBar{};
277  	::GetClientRect(_statusBar.getHSelf(), &rcStatusBar);
278  	_lesssModeHeight = (countRc.bottom - dlgRc.top) + (rcStatusBar.bottom - rcStatusBar.top) + dpiManager.scaleY(10);
279  	if (nppGUI._findWindowLessMode)
280  	{
281  		nppGUI._findWindowLessMode = false;
282  		::SendMessage(_hSelf, WM_COMMAND, IDD_RESIZE_TOGGLE_BUTTON, 0);
283  	}
284  }
285  void FindReplaceDlg::fillFindHistory()
286  {
287  	NppParameters& nppParams = NppParameters::getInstance();
288  	FindHistory & findHistory = nppParams.getFindHistory();
289  	fillComboHistory(IDFINDWHAT, findHistory._findHistoryFinds);
290  	fillComboHistory(IDREPLACEWITH, findHistory._findHistoryReplaces);
291  	fillComboHistory(IDD_FINDINFILES_FILTERS_COMBO, findHistory._findHistoryFilters);
292  	fillComboHistory(IDD_FINDINFILES_DIR_COMBO, findHistory._findHistoryPaths);
293  	::SendDlgItemMessage(_hSelf, IDWRAP, BM_SETCHECK, findHistory._isWrap, 0);
294  	::SendDlgItemMessage(_hSelf, IDWHOLEWORD, BM_SETCHECK, findHistory._isMatchWord, 0);
295  	::SendDlgItemMessage(_hSelf, IDMATCHCASE, BM_SETCHECK, findHistory._isMatchCase, 0);
296  	::SendDlgItemMessage(_hSelf, IDC_BACKWARDDIRECTION, BM_SETCHECK, !findHistory._isDirectionDown, 0);
297  	::SendDlgItemMessage(_hSelf, IDD_FINDINFILES_INHIDDENDIR_CHECK, BM_SETCHECK, findHistory._isFifInHiddenFolder, 0);
298  	::SendDlgItemMessage(_hSelf, IDD_FINDINFILES_RECURSIVE_CHECK, BM_SETCHECK, findHistory._isFifRecuisive, 0);
299  	::SendDlgItemMessage(_hSelf, IDD_FINDINFILES_FOLDERFOLLOWSDOC_CHECK, BM_SETCHECK, findHistory._isFolderFollowDoc, 0);
300  	::SendDlgItemMessage(_hSelf, IDD_FINDINFILES_PROJECT1_CHECK, BM_SETCHECK, findHistory._isFifProjectPanel_1, 0);
301  	::SendDlgItemMessage(_hSelf, IDD_FINDINFILES_PROJECT2_CHECK, BM_SETCHECK, findHistory._isFifProjectPanel_2, 0);
302  	::SendDlgItemMessage(_hSelf, IDD_FINDINFILES_PROJECT3_CHECK, BM_SETCHECK, findHistory._isFifProjectPanel_3, 0);
303  	::SendDlgItemMessage(_hSelf, IDNORMAL, BM_SETCHECK, findHistory._searchMode == FindHistory::normal, 0);
304  	::SendDlgItemMessage(_hSelf, IDEXTENDED, BM_SETCHECK, findHistory._searchMode == FindHistory::extended, 0);
305  	::SendDlgItemMessage(_hSelf, IDREGEXP, BM_SETCHECK, findHistory._searchMode == FindHistory::regExpr, 0);
306  	::SendDlgItemMessage(_hSelf, IDREDOTMATCHNL, BM_SETCHECK, findHistory._dotMatchesNewline, 0);
307  	::SendDlgItemMessage(_hSelf, IDC_MARKLINE_CHECK, BM_SETCHECK, findHistory._isBookmarkLine, 0);
308  	::SendDlgItemMessage(_hSelf, IDC_PURGE_CHECK, BM_SETCHECK, findHistory._isPurge, 0);
309  	::SendDlgItemMessage(_hSelf, IDC_2_BUTTONS_MODE, BM_SETCHECK, findHistory._isSearch2ButtonsMode, 0);
310  	if (findHistory._searchMode == FindHistory::regExpr)
311  	{
312  		::SendDlgItemMessage(_hSelf, IDWHOLEWORD, BM_SETCHECK, BST_UNCHECKED, 0);
313  		enableFindDlgItem(IDWHOLEWORD, false);
314  		::SendDlgItemMessage(_hSelf, IDC_BACKWARDDIRECTION, BM_SETCHECK, BST_UNCHECKED, 0);
315  		enableFindDlgItem(IDC_BACKWARDDIRECTION, nppParams.regexBackward4PowerUser());
316  		enableFindDlgItem(IDC_FINDPREV, nppParams.regexBackward4PowerUser());
317  		enableFindDlgItem(IDREDOTMATCHNL);
318  	}
319  	if (nppParams.isTransparentAvailable())
320  	{
321  		showFindDlgItem(IDC_TRANSPARENT_CHECK);
322  		showFindDlgItem(IDC_TRANSPARENT_GRPBOX);
323  		showFindDlgItem(IDC_TRANSPARENT_LOSSFOCUS_RADIO);
324  		showFindDlgItem(IDC_TRANSPARENT_ALWAYS_RADIO);
325  		showFindDlgItem(IDC_PERCENTAGE_SLIDER);
326  		::SendDlgItemMessage(_hSelf, IDC_PERCENTAGE_SLIDER, TBM_SETRANGE, FALSE, MAKELONG(20, 200));
327  		::SendDlgItemMessage(_hSelf, IDC_PERCENTAGE_SLIDER, TBM_SETPOS, TRUE, findHistory._transparency);
328  		if (findHistory._transparencyMode == FindHistory::none)
329  		{
330  			enableFindDlgItem(IDC_TRANSPARENT_LOSSFOCUS_RADIO, false);
331  			enableFindDlgItem(IDC_TRANSPARENT_ALWAYS_RADIO, false);
332  			enableFindDlgItem(IDC_PERCENTAGE_SLIDER, false);
333  		}
334  		else
335  		{
336  			::SendDlgItemMessage(_hSelf, IDC_TRANSPARENT_CHECK, BM_SETCHECK, TRUE, 0);
337  			int id;
338  			if (findHistory._transparencyMode == FindHistory::onLossingFocus)
339  			{
340  				id = IDC_TRANSPARENT_LOSSFOCUS_RADIO;
341  			}
342  			else
343  			{
344  				id = IDC_TRANSPARENT_ALWAYS_RADIO;
345  				(NppParameters::getInstance()).SetTransparent(_hSelf, findHistory._transparency);
346  			}
347  			::SendDlgItemMessage(_hSelf, id, BM_SETCHECK, TRUE, 0);
348  		}
349  	}
350  }
351  void FindReplaceDlg::fillComboHistory(int id, const vector<generic_string> & strings)
352  {
353  	HWND hCombo = ::GetDlgItem(_hSelf, id);
354  	for (vector<generic_string>::const_reverse_iterator i = strings.rbegin() ; i != strings.rend(); ++i)
355  	{
356  		addText2Combo(i->c_str(), hCombo);
357  	}
358  	if (!strings.empty() && strings.begin()->empty())
359  	{
360  		SetWindowText(hCombo, _T(""));
361  		return;
362  	}
363  	::SendMessage(hCombo, CB_SETCURSEL, 0, 0); 
364  }
365  void FindReplaceDlg::saveFindHistory()
366  {
367  	if (! isCreated()) return;
368  	FindHistory& findHistory = (NppParameters::getInstance()).getFindHistory();
369  	saveComboHistory(IDD_FINDINFILES_DIR_COMBO, findHistory._nbMaxFindHistoryPath, findHistory._findHistoryPaths, false);
370  	saveComboHistory(IDD_FINDINFILES_FILTERS_COMBO, findHistory._nbMaxFindHistoryFilter, findHistory._findHistoryFilters, true);
371  	saveComboHistory(IDFINDWHAT,                    findHistory._nbMaxFindHistoryFind, findHistory._findHistoryFinds, false);
372  	saveComboHistory(IDREPLACEWITH,                 findHistory._nbMaxFindHistoryReplace, findHistory._findHistoryReplaces, true);
373  }
374  int FindReplaceDlg::saveComboHistory(int id, int maxcount, vector<generic_string> & strings, bool saveEmpty)
375  {
376  	TCHAR text[FINDREPLACE_MAXLENGTH] = { '\0' };
377  	HWND hCombo = ::GetDlgItem(_hSelf, id);
378  	int count = static_cast<int32_t>(::SendMessage(hCombo, CB_GETCOUNT, 0, 0));
379  	count = std::min<int>(count, maxcount);
380  	if (count == CB_ERR) return 0;
381  	strings.clear();
382  	if (saveEmpty)
383  	{
384  		if (::GetWindowTextLength(hCombo) == 0)
385  		{
386  			strings.push_back(generic_string());
387  		}
388  	}
389  	for (int i = 0 ; i < count ; ++i)
390  	{
391  		auto cbTextLen = ::SendMessage(hCombo, CB_GETLBTEXTLEN, i, 0);
392  		if (cbTextLen <= FINDREPLACE_MAXLENGTH - 1)
393  		{
394  			::SendMessage(hCombo, CB_GETLBTEXT, i, reinterpret_cast<LPARAM>(text));
395  			strings.push_back(generic_string(text));
396  		}
397  	}
398  	return count;
399  }
400  void FindReplaceDlg::updateCombos()
401  {
402  	updateCombo(IDREPLACEWITH);
403  	updateCombo(IDFINDWHAT);
404  }
405  void FindReplaceDlg::updateCombo(int comboID)
406  {
407  	HWND hCombo = ::GetDlgItem(_hSelf, comboID);
408  	addText2Combo(getTextFromCombo(hCombo).c_str(), hCombo);
409  }
410  FoundInfo Finder::EmptyFoundInfo(0, 0, 0, TEXT(""));
411  SearchResultMarkingLine Finder::EmptySearchResultMarking;
412  bool Finder::notify(SCNotification *notification)
413  {
414  	static bool isDoubleClicked = false;
415  	switch (notification->nmhdr.code)
416  	{
417  		case SCN_MARGINCLICK:
418  			if (notification->margin == ScintillaEditView::_SC_MARGE_FOLDER)
419  			{
420  				_scintView.marginClick(notification->position, notification->modifiers);
421  			}
422  			break;
423  		case SCN_DOUBLECLICK:
424  		{
425  			isDoubleClicked = true;
426  			::SendMessage(_scintView.getHSelf(), WM_LBUTTONUP, 0, 0);
427  			size_t pos = notification->position;
428  			if (static_cast<intptr_t>(pos) == INVALID_POSITION)
429  				pos = _scintView.execute(SCI_GETLINEENDPOSITION, notification->line);
430  			_scintView.execute(SCI_SETSEL, pos, pos);
431  			std::pair<intptr_t, intptr_t> newPos = gotoFoundLine();
432  			auto lineStartAbsPos = _scintView.execute(SCI_POSITIONFROMLINE, notification->line);
433  			intptr_t lineEndAbsPos = _scintView.execute(SCI_GETLINEENDPOSITION, notification->line);
434  			intptr_t begin = newPos.first + lineStartAbsPos;
435  			intptr_t end = newPos.second + lineStartAbsPos;
436  			if (end > lineEndAbsPos)
437  				end = lineEndAbsPos;
438  			_scintView.execute(SCI_SETSEL, begin, end);
439  			_scintView.execute(SCI_SCROLLRANGE, begin, end);
440  		}
441  		break;
442  		case SCN_PAINTED :
443  			if (isDoubleClicked)
444  			{
445  				(*_ppEditView)->getFocus();
446  				isDoubleClicked = false;
447  			}
448  			break;
449  	}
450  	return false;
451  }
452  std::pair<intptr_t, intptr_t> Finder::gotoFoundLine(size_t nOccurrence)
453  {
454  	std::pair<intptr_t, intptr_t> emptyResult(0, 0);
455  	auto currentPos = _scintView.execute(SCI_GETCURRENTPOS);
456  	auto lno = _scintView.execute(SCI_LINEFROMPOSITION, currentPos);
457  	auto start = _scintView.execute(SCI_POSITIONFROMLINE, lno);
458  	auto end = _scintView.execute(SCI_GETLINEENDPOSITION, lno);
459  	if (start + 2 >= end) return emptyResult; 
460  	if (_scintView.execute(SCI_GETFOLDLEVEL, lno) & SC_FOLDLEVELHEADERFLAG)
461  	{
462  		_scintView.execute(SCI_TOGGLEFOLD, lno);
463  		return  emptyResult;
464  	}
465  	const FoundInfo& fInfo = *(_pMainFoundInfos->begin() + lno);
466  	const SearchResultMarkingLine& markingLine = *(_pMainMarkings->begin() + lno);
467  	if (!::SendMessage(_hParent, WM_DOOPEN, 0, reinterpret_cast<LPARAM>(fInfo._fullPath.c_str()))) return emptyResult;
468  	(*_ppEditView)->_positionRestoreNeeded = false;
469  	size_t index = 0;
470  	if (nOccurrence > 0)
471  	{
472  		index = nOccurrence - 1;
473  	}
474  	else 
475  	{
476  		intptr_t currentPosInLine = currentPos - start;
477  		for (std::pair<intptr_t, intptr_t> range : markingLine._segmentPostions)
478  		{
479  			if (range.first <= currentPosInLine && currentPosInLine <= range.second)
480  				break;
481  			++index;
482  		}
483  	}
484  	if (index >= fInfo._ranges.size())
485  		index = 0;
486  	Searching::displaySectionCentered(fInfo._ranges[index].first, fInfo._ranges[index].second, *_ppEditView);
487  	return markingLine._segmentPostions[index];
488  }
489  void Finder::deleteResult()
490  {
491  	auto currentPos = _scintView.execute(SCI_GETCURRENTPOS); 
492  	auto lno = _scintView.execute(SCI_LINEFROMPOSITION, currentPos);
493  	auto start = _scintView.execute(SCI_POSITIONFROMLINE, lno);
494  	auto end = _scintView.execute(SCI_GETLINEENDPOSITION, lno);
495  	if (start + 2 >= end) return; 
496  	if (_scintView.execute(SCI_GETLEXER) == SCLEX_NULL)
497  	{
498  		_scintView.setLexer(L_SEARCHRESULT, LIST_NONE); 
499  	}
500  	if (_scintView.execute(SCI_GETFOLDLEVEL, lno) & SC_FOLDLEVELHEADERFLAG)  
501  	{
502  		auto endline = _scintView.execute(SCI_GETLASTCHILD, lno, -1) + 1;
503  		assert((size_t) endline <= _pMainFoundInfos->size());
504  		_pMainFoundInfos->erase(_pMainFoundInfos->begin() + lno, _pMainFoundInfos->begin() + endline); 
505  		_pMainMarkings->erase(_pMainMarkings->begin() + lno, _pMainMarkings->begin() + endline);
506  		auto end2 = _scintView.execute(SCI_POSITIONFROMLINE, endline);
507  		_scintView.execute(SCI_SETSEL, start, end2);
508  		setFinderReadOnly(false);
509  		_scintView.execute(SCI_CLEAR);
510  		setFinderReadOnly(true);
511  	}
512  	else 
513  	{
514  		assert((size_t) lno < _pMainFoundInfos->size());
515  		_pMainFoundInfos->erase(_pMainFoundInfos->begin() + lno); 
516  		_pMainMarkings->erase(_pMainMarkings->begin() + lno);
517  		setFinderReadOnly(false);
518  		_scintView.execute(SCI_LINEDELETE);
519  		setFinderReadOnly(true);
520  	}
521  	_markingsStruct._length = static_cast<long>(_pMainMarkings->size());
522  	assert(_pMainFoundInfos->size() == _pMainMarkings->size());
523  	assert(size_t(_scintView.execute(SCI_GETLINECOUNT)) == _pMainFoundInfos->size() + 1);
524  }
525  vector<generic_string> Finder::getResultFilePaths() const
526  {
527  	vector<generic_string> paths;
528  	size_t len = _pMainFoundInfos->size();
529  	for (size_t i = 0; i < len; ++i)
530  	{
531  		generic_string & path2add = (*_pMainFoundInfos)[i]._fullPath;
532  		bool found = path2add.empty();
533  		for (size_t j = 0; j < paths.size() && !found; ++j)
534  		{
535  			if (paths[j] == path2add)
536  				found = true;
537  		}
538  		if (!found)
539  			paths.push_back(path2add);
540  	}
541  	return paths;
542  }
543  bool Finder::canFind(const TCHAR *fileName, size_t lineNumber, size_t* indexToStartFrom) const
544  {
545  	size_t len = _pMainFoundInfos->size();
546  	for (size_t i = *indexToStartFrom; i < len; ++i)
547  	{
548  		if ((*_pMainFoundInfos)[i]._fullPath == fileName)
549  		{
550  			if (lineNumber == (*_pMainFoundInfos)[i]._lineNumber)
551  			{
552  				*indexToStartFrom = i;
553  				return true;
554  			}
555  		}
556  	}
557  	return false;
558  }
559  Finder::CurrentPosInLineInfo Finder::getCurrentPosInLineInfo(intptr_t currentPosInLine, const SearchResultMarkingLine& markingLine) const
560  {
561  	CurrentPosInLineInfo cpili;
562  	size_t count = 0;
563  	intptr_t lastEnd = 0;
564  	auto selStart = _scintView.execute(SCI_GETSELECTIONSTART);
565  	auto selEnd = _scintView.execute(SCI_GETSELECTIONEND);
566  	bool hasSel = (selEnd - selStart) != 0;
567  	for (std::pair<intptr_t, intptr_t> range : markingLine._segmentPostions)
568  	{
569  		++count;
570  		if (lastEnd <= currentPosInLine && currentPosInLine < range.first)
571  		{
572  			if (count == 1)
573  			{
574  				cpili._status = pos_infront;
575  				break;
576  			}
577  			else
578  			{
579  				cpili._status = pos_between;
580  				cpili.auxiliaryInfo = count - 1;
581  				break;
582  			}
583  		}
584  		if (range.first <= currentPosInLine && currentPosInLine <= range.second)
585  		{
586  			if (currentPosInLine == range.first && !hasSel)
587  			{
588  				cpili._status = pos_between;
589  				cpili.auxiliaryInfo = count - 1; 
590  			}
591  			else if (currentPosInLine == range.second && !hasSel)
592  			{
593  				cpili._status = pos_between;
594  				cpili.auxiliaryInfo = count;     
595  			}
596  			else
597  			{
598  				cpili._status = pos_inside;
599  				cpili.auxiliaryInfo = count;
600  			}
601  			break;
602  		}
603  		if (range.second < currentPosInLine)
604  		{
605  			if (markingLine._segmentPostions.size() == count)
606  			{
607  				cpili._status = pos_behind;
608  				cpili.auxiliaryInfo = count;
609  				break;
610  			}
611  		}
612  		lastEnd = range.second;
613  	}
614  	return cpili;
615  }
616  void Finder::anchorWithNoHeaderLines(intptr_t& currentL, intptr_t initL, intptr_t minL, intptr_t maxL, int direction)
617  {
618  	if (currentL > maxL && direction == 0)
619  		currentL = minL;
620  	while (_scintView.execute(SCI_GETFOLDLEVEL, currentL) & SC_FOLDLEVELHEADERFLAG)
621  	{
622  		currentL += direction == -1 ? -1 : 1;
623  		if (currentL > maxL)
624  			currentL = minL;
625  		else if (currentL < minL)
626  			currentL = maxL;
627  		if (currentL == initL)
628  			break;
629  	}
630  	auto extremityAbsoltePos = _scintView.execute(direction == -1 ? SCI_GETLINEENDPOSITION : SCI_POSITIONFROMLINE, currentL);
631  	_scintView.execute(SCI_SETSEL, extremityAbsoltePos, extremityAbsoltePos);
632  }
633  void Finder::gotoNextFoundResult(int direction)
634  {
635  	auto currentPos = _scintView.execute(SCI_GETCURRENTPOS);
636  	intptr_t lno = _scintView.execute(SCI_LINEFROMPOSITION, currentPos);
637  	auto total_lines = _scintView.execute(SCI_GETLINECOUNT);
638  	if (total_lines <= 1) return;
639  	auto lineStartAbsPos = _scintView.execute(SCI_POSITIONFROMLINE, lno);
640  	intptr_t currentPosInLine = currentPos - lineStartAbsPos;
641  	auto init_lno = lno;
642  	auto max_lno = _scintView.execute(SCI_GETLASTCHILD, lno, searchHeaderLevel);
643  	assert(max_lno <= total_lines - 2);
644  	int level = _scintView.execute(SCI_GETFOLDLEVEL, lno) & SC_FOLDLEVELNUMBERMASK;
645  	auto min_lno = lno;
646  	while (level-- >= fileHeaderLevel)
647  	{
648  		min_lno = _scintView.execute(SCI_GETFOLDPARENT, min_lno);
649  		assert(min_lno >= 0);
650  	}
651  	if (min_lno < 0) min_lno = lno; 
652  	assert(min_lno <= max_lno);
653  	if (lno > max_lno && direction == 0) lno = min_lno;
654  	else if (lno < min_lno) lno = max_lno;
655  	while (_scintView.execute(SCI_GETFOLDLEVEL, lno) & SC_FOLDLEVELHEADERFLAG)
656  	{
657  		lno += direction == -1 ? -1 : 1;
658  		if (lno > max_lno)
659  			lno = min_lno;
660  		else if (lno < min_lno)
661  			lno = max_lno;
662  		if (lno == init_lno)
663  			break;
664  	}
665  	if (lno != init_lno)
666  	{
667  		auto extremityAbsoltePos = _scintView.execute(direction == -1 ? SCI_GETLINEENDPOSITION : SCI_POSITIONFROMLINE, lno);
668  		_scintView.execute(SCI_SETSEL, extremityAbsoltePos, extremityAbsoltePos);
669  		currentPos = extremityAbsoltePos;
670  		auto start = _scintView.execute(SCI_POSITIONFROMLINE, lno);
671  		currentPosInLine = currentPos - start;
672  	}
673  	size_t n = 0;
674  	const SearchResultMarkingLine& markingLine = *(_pMainMarkings->begin() + lno);
675  	CurrentPosInLineInfo cpili  = getCurrentPosInLineInfo(currentPosInLine, markingLine);
676  	if (direction == 0) 
677  	{
678  		switch (cpili._status)
679  		{
680  			case pos_infront:
681  			{
682  				n = 1;
683  			}
684  			break;
685  			case pos_between:
686  			case pos_inside:
687  			{
688  				n = cpili.auxiliaryInfo + 1;
689  				if (n > markingLine._segmentPostions.size())
690  				{
691  					lno++;
692  					anchorWithNoHeaderLines(lno, init_lno, min_lno, max_lno, direction);
693  					n = 1;
694  				}
695  			}
696  			break;
697  			case pos_behind:
698  			{
699  				lno++;
700  				anchorWithNoHeaderLines(lno, init_lno, min_lno, max_lno, direction);
701  				n = 1;
702  			}
703  			break;
704  		}
705  	}
706  	else if (direction == -1) 
707  	{
708  		switch (cpili._status)
709  		{
710  			case pos_infront:
711  			{
712  				lno--;
713  				anchorWithNoHeaderLines(lno, init_lno, min_lno, max_lno, direction);
714  				const SearchResultMarkingLine& newMarkingLine = *(_pMainMarkings->begin() + lno);
715  				n = newMarkingLine._segmentPostions.size();
716  			}
717  			break;
718  			case pos_between:
719  			{
720  				n = cpili.auxiliaryInfo;
721  			}
722  			break;
723  			case pos_inside:
724  			{
725  				if (cpili.auxiliaryInfo > 1)
726  					n = cpili.auxiliaryInfo - 1;
727  				else
728  				{
729  					lno--;
730  					anchorWithNoHeaderLines(lno, init_lno, min_lno, max_lno, direction);
731  					const SearchResultMarkingLine& newMarkingLine = *(_pMainMarkings->begin() + lno);
732  					n = newMarkingLine._segmentPostions.size();
733  				}
734  			}
735  			break;
736  			case pos_behind:
737  			{
738  				n = cpili.auxiliaryInfo;
739  			}
740  			break;
741  		}
742  	}
743  	else 
744  	{
745  		return;
746  	}
747  	_scintView.execute(SCI_ENSUREVISIBLE, lno);
748  	std::pair<intptr_t, intptr_t> newPos = gotoFoundLine(n);
749  	lineStartAbsPos = _scintView.execute(SCI_POSITIONFROMLINE, lno);
750  	intptr_t lineEndAbsPos = _scintView.execute(SCI_GETLINEENDPOSITION, lno);
751  	intptr_t begin = newPos.first + lineStartAbsPos;
752  	intptr_t end = newPos.second + lineStartAbsPos;
753  	if (end > lineEndAbsPos)
754  		end = lineEndAbsPos;
755  	_scintView.execute(SCI_SETSEL, begin, end);
756  	_scintView.execute(SCI_SCROLLRANGE, begin, end);
757  }
758  void FindInFinderDlg::initFromOptions()
759  {
760  	HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT_FIFOLDER);
761  	addText2Combo(_options._str2Search.c_str(), hFindCombo);
762  	setChecked(IDC_MATCHLINENUM_CHECK_FIFOLDER, _options._isMatchLineNumber);
763  	setChecked(IDWHOLEWORD_FIFOLDER, _options._searchType != FindRegex && _options._isWholeWord);
764  	::EnableWindow(::GetDlgItem(_hSelf, IDWHOLEWORD_FIFOLDER), _options._searchType != FindRegex);
765  	setChecked(IDMATCHCASE_FIFOLDER, _options._isMatchCase);
766  	setChecked(IDNORMAL_FIFOLDER, _options._searchType == FindNormal);
767  	setChecked(IDEXTENDED_FIFOLDER, _options._searchType == FindExtended);
768  	setChecked(IDREGEXP_FIFOLDER, _options._searchType == FindRegex);
769  	setChecked(IDREDOTMATCHNL_FIFOLDER, _options._dotMatchesNewline);
770  	::EnableWindow(::GetDlgItem(_hSelf, IDREDOTMATCHNL_FIFOLDER), _options._searchType == FindRegex);
771  }
772  void FindInFinderDlg::writeOptions()
773  {
774  	HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT_FIFOLDER);
775  	_options._str2Search = getTextFromCombo(hFindCombo);
776  	_options._isMatchLineNumber = isCheckedOrNot(IDC_MATCHLINENUM_CHECK_FIFOLDER);
777  	_options._isWholeWord = isCheckedOrNot(IDWHOLEWORD_FIFOLDER);
778  	_options._isMatchCase = isCheckedOrNot(IDMATCHCASE_FIFOLDER);
779  	_options._searchType = isCheckedOrNot(IDREGEXP_FIFOLDER) ? FindRegex : isCheckedOrNot(IDEXTENDED_FIFOLDER) ? FindExtended : FindNormal;
780  	_options._dotMatchesNewline = isCheckedOrNot(IDREDOTMATCHNL_FIFOLDER);
781  }
782  intptr_t CALLBACK FindInFinderDlg::run_dlgProc(UINT message, WPARAM wParam, LPARAM &bsol;*lParam*/)
783  {
784  	switch (message)
785  	{
786  		case WM_INITDIALOG:
787  		{
788  			NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
789  			pNativeSpeaker->changeDlgLang(_hSelf, "FindInFinder");
790  			NppDarkMode::autoSubclassAndThemeChildControls(_hSelf);
791  			initFromOptions();
792  			goToCenter(SWP_SHOWWINDOW | SWP_NOSIZE);
793  		}
794  		return TRUE;
795  		case WM_CTLCOLOREDIT:
796  		{
797  			return NppDarkMode::onCtlColorSofter(reinterpret_cast<HDC>(wParam));
798  		}
799  		case WM_CTLCOLORLISTBOX:
800  		{
801  			return NppDarkMode::onCtlColor(reinterpret_cast<HDC>(wParam));
802  		}
803  		case WM_CTLCOLORDLG:
804  		case WM_CTLCOLORSTATIC:
805  		{
806  			return NppDarkMode::onCtlColorDarker(reinterpret_cast<HDC>(wParam));
807  		}
808  		case WM_PRINTCLIENT:
809  		{
810  			if (NppDarkMode::isEnabled())
811  			{
812  				return TRUE;
813  			}
814  			break;
815  		}
816  		case WM_ERASEBKGND:
817  		{
818  			if (NppDarkMode::isEnabled())
819  			{
820  				RECT rc{};
821  				getClientRect(rc);
822  				::FillRect(reinterpret_cast<HDC>(wParam), &rc, NppDarkMode::getDarkerBackgroundBrush());
823  				return TRUE;
824  			}
825  			break;
826  		}
827  		case NPPM_INTERNAL_REFRESHDARKMODE:
828  		{
829  			NppDarkMode::autoThemeChildControls(_hSelf);
830  			return TRUE;
831  		}
832  		case WM_COMMAND:
833  		{
834  			switch (LOWORD(wParam))
835  			{
836  				case IDCANCEL:
837  				{
838  					::EndDialog(_hSelf, -1);
839  					return TRUE;
840  				}
841  				case IDOK:
842  				{
843  					writeOptions();
844  					::EndDialog(_hSelf, -1);
845  					FindersInfo findersInfo;
846  					findersInfo._pSourceFinder = _pFinder2Search;
<span onclick='openModal()' class='match'>847  					findersInfo._findOption = _options;
848  					::SendMessage(_hParent, WM_FINDALL_INCURRENTFINDER, reinterpret_cast<WPARAM>(&findersInfo), 0);
849  					return TRUE;
</span>850  				}
851  				case IDNORMAL_FIFOLDER:
852  				case IDEXTENDED_FIFOLDER:
853  				case IDREGEXP_FIFOLDER:
854  				{
855  					if (isCheckedOrNot(IDREGEXP_FIFOLDER))
856  					{
857  						::EnableWindow(::GetDlgItem(_hSelf, IDWHOLEWORD_FIFOLDER), false);
858  						setChecked(IDWHOLEWORD_FIFOLDER, false);
859  						::EnableWindow(GetDlgItem(_hSelf, IDREDOTMATCHNL_FIFOLDER), true);
860  					}
861  					else if (isCheckedOrNot(IDEXTENDED_FIFOLDER))
862  					{
863  						::EnableWindow(::GetDlgItem(_hSelf, IDWHOLEWORD_FIFOLDER), true);
864  						::EnableWindow(GetDlgItem(_hSelf, IDREDOTMATCHNL_FIFOLDER), false);
865  					}
866  					else
867  					{
868  						::EnableWindow(::GetDlgItem(_hSelf, IDWHOLEWORD_FIFOLDER), true);
869  						::EnableWindow(GetDlgItem(_hSelf, IDREDOTMATCHNL_FIFOLDER), false);
870  					}
871  					return TRUE;
872  				}
873  			}
874  			return FALSE;
875  		}
876  		default:
877  			return FALSE;
878  	}
879  	return FALSE;
880  }
881  void FindReplaceDlg::resizeDialogElements(LONG newWidth)
882  {
883  	const auto resizeWindowIDs = { IDFINDWHAT, IDREPLACEWITH, IDD_FINDINFILES_FILTERS_COMBO, IDD_FINDINFILES_DIR_COMBO };
884  	const auto moveWindowIDs = {
885  		IDD_FINDINFILES_FOLDERFOLLOWSDOC_CHECK,IDD_FINDINFILES_RECURSIVE_CHECK, IDD_FINDINFILES_INHIDDENDIR_CHECK,
886  		IDD_FINDINFILES_PROJECT1_CHECK, IDD_FINDINFILES_PROJECT2_CHECK, IDD_FINDINFILES_PROJECT3_CHECK,
887  		IDC_TRANSPARENT_GRPBOX, IDC_TRANSPARENT_CHECK, IDC_TRANSPARENT_LOSSFOCUS_RADIO, IDC_TRANSPARENT_ALWAYS_RADIO,
888  		IDC_PERCENTAGE_SLIDER , IDC_REPLACEINSELECTION , IDC_IN_SELECTION_CHECK,
889  		IDD_FINDINFILES_BROWSE_BUTTON, IDCMARKALL, IDC_CLEAR_ALL, IDCCOUNTALL, IDC_FINDALL_OPENEDFILES, IDC_FINDALL_CURRENTFILE,
890  		IDREPLACE, IDREPLACEALL, IDD_FINDREPLACE_SWAP_BUTTON, IDC_REPLACE_OPENEDFILES, IDD_FINDINFILES_FIND_BUTTON, IDD_FINDINFILES_REPLACEINFILES, IDOK, IDCANCEL,
891  		IDC_FINDPREV, IDC_FINDNEXT, IDC_2_BUTTONS_MODE, IDC_COPY_MARKED_TEXT, IDD_FINDINFILES_REPLACEINPROJECTS, IDD_RESIZE_TOGGLE_BUTTON
892  	};
893  	const UINT flags = SWP_NOZORDER | SWP_NOOWNERZORDER | SWP_NOACTIVATE | SWP_NOCOPYBITS;
894  	auto newDeltaWidth = newWidth - _initialClientWidth;
895  	auto addWidth = newDeltaWidth - _deltaWidth;
896  	_deltaWidth = newDeltaWidth;
897  	RECT rc;
898  	for (int id : resizeWindowIDs)
899  	{
900  		HWND resizeHwnd = ::GetDlgItem(_hSelf, id);
901  		::GetClientRect(resizeHwnd, &rc);
902  		DWORD endSelection = 0;
903  		SendMessage(resizeHwnd, CB_GETEDITSEL, 0, (LPARAM)&endSelection);
904  		::SetWindowPos(resizeHwnd, NULL, 0, 0, rc.right + addWidth, rc.bottom, SWP_NOMOVE | flags);
905  		if (endSelection == 0)
906  		{
907  			SendMessage(resizeHwnd, CB_SETEDITSEL, 0, 0);
908  		}
909  	}
910  	for (int moveWndID : moveWindowIDs)
911  	{
912  		HWND moveHwnd = GetDlgItem(_hSelf, moveWndID);
913  		::GetWindowRect(moveHwnd, &rc);
914  		::MapWindowPoints(NULL, _hSelf, (LPPOINT)&rc, 2);
915  		::SetWindowPos(moveHwnd, NULL, rc.left + addWidth, rc.top, 0, 0, SWP_NOSIZE | flags);
916  	}
917  	auto additionalWindowHwndsToResize = { _tab.getHSelf() , _statusBar.getHSelf() };
918  	for (HWND resizeHwnd : additionalWindowHwndsToResize)
919  	{
920  		::GetClientRect(resizeHwnd, &rc);
921  		::SetWindowPos(resizeHwnd, NULL, 0, 0, rc.right + addWidth, rc.bottom, SWP_NOMOVE | flags);
922  	}
923  }
924  std::mutex findOps_mutex;
925  intptr_t CALLBACK FindReplaceDlg::run_dlgProc(UINT message, WPARAM wParam, LPARAM lParam)
926  {
927  	switch (message)
928  	{
929  		case WM_GETMINMAXINFO:
930  		{
931  			bool isLessModeOn = NppParameters::getInstance().getNppGUI()._findWindowLessMode;
932  			MINMAXINFO* mmi = reinterpret_cast<MINMAXINFO*>(lParam);
933  			mmi->ptMinTrackSize.y = isLessModeOn ? _lesssModeHeight : _initialWindowRect.bottom;
934  			mmi->ptMinTrackSize.x = _initialWindowRect.right;
935  			mmi->ptMaxTrackSize.y = isLessModeOn ? _lesssModeHeight : _initialWindowRect.bottom;
936  			return 0;
937  		}
938  		case WM_SIZE:
939  		{
940  			resizeDialogElements(LOWORD(lParam));
941  			return TRUE;
942  		}
943  		case WM_CTLCOLOREDIT:
944  		{
945  			return NppDarkMode::onCtlColorSofter(reinterpret_cast<HDC>(wParam));
946  		}
947  		case WM_CTLCOLORLISTBOX:
948  		{
949  			return NppDarkMode::onCtlColor(reinterpret_cast<HDC>(wParam));
950  		}
951  		case WM_CTLCOLORDLG:
952  		case WM_CTLCOLORSTATIC:
953  		{
954  			return NppDarkMode::onCtlColorDarker(reinterpret_cast<HDC>(wParam));
955  		}
956  		case WM_PRINTCLIENT:
957  		{
958  			if (NppDarkMode::isEnabled())
959  			{
960  				return TRUE;
961  			}
962  			break;
963  		}
964  		case WM_ERASEBKGND:
965  		{
966  			if (NppDarkMode::isEnabled())
967  			{
968  				RECT rc{};
969  				getClientRect(rc);
970  				::FillRect(reinterpret_cast<HDC>(wParam), &rc, NppDarkMode::getDarkerBackgroundBrush());
971  				return TRUE;
972  			}
973  			break;
974  		}
975  		case NPPM_INTERNAL_REFRESHDARKMODE:
976  		{
977  			NppDarkMode::setDarkTooltips(_shiftTrickUpTip, NppDarkMode::ToolTipsType::tooltip);
978  			NppDarkMode::setDarkTooltips(_2ButtonsTip, NppDarkMode::ToolTipsType::tooltip);
979  			NppDarkMode::setDarkTooltips(_filterTip, NppDarkMode::ToolTipsType::tooltip);
980  			if (_statusbarTooltipWnd)
981  			{
982  				NppDarkMode::setDarkTooltips(_statusbarTooltipWnd, NppDarkMode::ToolTipsType::tooltip);
983  			}
984  			HWND finder = getHFindResults();
985  			if (finder)
986  			{
987  				NppDarkMode::setDarkScrollBar(finder);
988  			}
989  			NppDarkMode::autoThemeChildControls(_hSelf);
990  			return TRUE;
991  		}
992  		case WM_INITDIALOG :
993  		{
994  			NppDarkMode::autoSubclassAndThemeChildControls(_hSelf);
995  			HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
996  			HWND hReplaceCombo = ::GetDlgItem(_hSelf, IDREPLACEWITH);
997  			HWND hFiltersCombo = ::GetDlgItem(_hSelf, IDD_FINDINFILES_FILTERS_COMBO);
998  			HWND hDirCombo = ::GetDlgItem(_hSelf, IDD_FINDINFILES_DIR_COMBO);
999  			COMBOBOXINFO cbinfo{};
1000  			cbinfo.cbSize = sizeof(COMBOBOXINFO);
1001  			GetComboBoxInfo(hFindCombo, &cbinfo);
1002  			if (!cbinfo.hwndItem) return FALSE;
1003  			originalComboEditProc = reinterpret_cast<WNDPROC>(SetWindowLongPtr(cbinfo.hwndItem, GWLP_WNDPROC, reinterpret_cast<LONG_PTR>(comboEditProc)));
1004  			SetWindowLongPtr(cbinfo.hwndItem, GWLP_USERDATA, reinterpret_cast<LONG_PTR>(cbinfo.hwndCombo));
1005  			GetComboBoxInfo(hReplaceCombo, &cbinfo);
1006  			SetWindowLongPtr(cbinfo.hwndItem, GWLP_WNDPROC, reinterpret_cast<LONG_PTR>(comboEditProc));
1007  			SetWindowLongPtr(cbinfo.hwndItem, GWLP_USERDATA, reinterpret_cast<LONG_PTR>(cbinfo.hwndCombo));
1008  			GetComboBoxInfo(hFiltersCombo, &cbinfo);
1009  			SetWindowLongPtr(cbinfo.hwndItem, GWLP_WNDPROC, reinterpret_cast<LONG_PTR>(comboEditProc));
1010  			SetWindowLongPtr(cbinfo.hwndItem, GWLP_USERDATA, reinterpret_cast<LONG_PTR>(cbinfo.hwndCombo));
1011  			GetComboBoxInfo(hDirCombo, &cbinfo);
1012  			SetWindowLongPtr(cbinfo.hwndItem, GWLP_WNDPROC, reinterpret_cast<LONG_PTR>(comboEditProc));
1013  			SetWindowLongPtr(cbinfo.hwndItem, GWLP_USERDATA, reinterpret_cast<LONG_PTR>(cbinfo.hwndCombo));
1014  			if ((NppParameters::getInstance()).getNppGUI()._monospacedFontFindDlg)
1015  			{
1016  				_hMonospaceFont = createFont(TEXT("Courier New"), 8, false, _hSelf);
1017  				SendMessage(hFindCombo, WM_SETFONT, (WPARAM)_hMonospaceFont, MAKELPARAM(true, 0));
1018  				SendMessage(hReplaceCombo, WM_SETFONT, (WPARAM)_hMonospaceFont, MAKELPARAM(true, 0));
1019  				SendMessage(hFiltersCombo, WM_SETFONT, (WPARAM)_hMonospaceFont, MAKELPARAM(true, 0));
1020  				SendMessage(hDirCombo, WM_SETFONT, (WPARAM)_hMonospaceFont, MAKELPARAM(true, 0));
1021  			}
1022  			DPIManager& dpiManager = NppParameters::getInstance()._dpiManager;
1023  			for (HWND hComboBox : { hFindCombo, hReplaceCombo, hFiltersCombo, hDirCombo })
1024  			{
1025  				LOGFONT lf = {};
1026  				HFONT font = reinterpret_cast<HFONT>(SendMessage(hComboBox, WM_GETFONT, 0, 0));
1027  				::GetObject(font, sizeof(lf), &lf);
1028  				lf.lfHeight = (dpiManager.scaleY(16) - 5) * -1;
1029  				SendMessage(hComboBox, WM_SETFONT, (WPARAM)CreateFontIndirect(&lf), MAKELPARAM(true, 0));
1030  			}
1031  			RECT arc{};
1032  			::GetWindowRect(::GetDlgItem(_hSelf, IDCANCEL), &arc);
1033  			_markClosePos.bottom = _findInFilesClosePos.bottom = _replaceClosePos.bottom = _findClosePos.bottom = arc.bottom - arc.top;
1034  			_markClosePos.right = _findInFilesClosePos.right = _replaceClosePos.right = _findClosePos.right = arc.right - arc.left;
1035  			POINT p{};
1036  			p.x = arc.left;
1037  			p.y = arc.top;
1038  			::ScreenToClient(_hSelf, &p);
1039  			p = getTopPoint(::GetDlgItem(_hSelf, IDCANCEL), !_isRTL);
1040  			_replaceClosePos.left = p.x;
1041  			_replaceClosePos.top = p.y;
1042  			 p = getTopPoint(::GetDlgItem(_hSelf, IDREPLACEALL), !_isRTL);
1043  			 _findInFilesClosePos.left = p.x;
1044  			 _findInFilesClosePos.top = p.y;
1045  			 p = getTopPoint(::GetDlgItem(_hSelf, IDC_REPLACE_OPENEDFILES), !_isRTL);
1046  			 _markClosePos.left = p.x;
1047  			 _markClosePos.top = p.y;
1048  			 p = getTopPoint(::GetDlgItem(_hSelf, IDCANCEL), !_isRTL);
1049  			 _findClosePos.left = p.x;
1050  			 _findClosePos.top = p.y + 10;
1051  			 ::GetWindowRect(::GetDlgItem(_hSelf, IDD_RESIZE_TOGGLE_BUTTON), &arc);
1052  			 long resizeButtonW = arc.right - arc.left;
1053  			 long resizeButtonH = arc.bottom - arc.top;
1054  			 _collapseButtonPos.bottom = _uncollapseButtonPos.bottom = resizeButtonW;
1055  			 _collapseButtonPos.right = _uncollapseButtonPos.right = resizeButtonH;
1056  			 ::GetWindowRect(::GetDlgItem(_hSelf, IDC_TRANSPARENT_GRPBOX), &arc);
1057  			 p = getTopPoint(::GetDlgItem(_hSelf, IDC_TRANSPARENT_GRPBOX), !_isRTL);
1058  			 _collapseButtonPos.left = p.x + (arc.right - arc.left) + dpiManager.scaleX(10);
1059  			 _collapseButtonPos.top = p.y + (arc.bottom - arc.top) - resizeButtonH + dpiManager.scaleX(10);
1060  			 ::GetWindowRect(::GetDlgItem(_hSelf, IDCCOUNTALL), &arc);
1061  			 p = getTopPoint(::GetDlgItem(_hSelf, IDCCOUNTALL), !_isRTL);
1062  			 _uncollapseButtonPos.left = p.x + (arc.right - arc.left) + dpiManager.scaleX(8);
1063  			 _uncollapseButtonPos.top = p.y + dpiManager.scaleY(2);
1064  			 RECT checkRect;
1065  			 ::GetWindowRect(::GetDlgItem(_hSelf, IDC_IN_SELECTION_CHECK), &checkRect);
1066  			 _countInSelCheckPos.bottom = _replaceInSelCheckPos.bottom = checkRect.bottom - checkRect.top;
1067  			 _countInSelCheckPos.right = _replaceInSelCheckPos.right = checkRect.right - checkRect.left;
1068  			 p = getTopPoint(::GetDlgItem(_hSelf, IDC_IN_SELECTION_CHECK), !_isRTL);
1069  			 _countInSelCheckPos.left = _replaceInSelCheckPos.left = p.x;
1070  			 _countInSelCheckPos.top = _replaceInSelCheckPos.top = p.y;
1071  			 POINT countP = getTopPoint(::GetDlgItem(_hSelf, IDCCOUNTALL), !_isRTL);
1072  			 RECT frameRect;
1073  			 ::GetWindowRect(::GetDlgItem(_hSelf, IDC_REPLACEINSELECTION), &frameRect);
1074  			 _countInSelFramePos.bottom = _replaceInSelFramePos.bottom = frameRect.bottom - frameRect.top;
1075  			 _countInSelFramePos.right = _replaceInSelFramePos.right = frameRect.right - frameRect.left;
1076  			 p = getTopPoint(::GetDlgItem(_hSelf, IDC_REPLACEINSELECTION), !_isRTL);
1077  			 _countInSelFramePos.left = _replaceInSelFramePos.left = p.x;
1078  			 _countInSelFramePos.top = _replaceInSelFramePos.top = p.y;
1079  			 _countInSelFramePos.top = countP.y - dpiManager.scaleY(10);
1080  			 _countInSelFramePos.bottom = dpiManager.scaleY(80 - 3);
1081  			 NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
1082  			 generic_string searchButtonTip = pNativeSpeaker->getLocalizedStrFromID("shift-change-direction-tip", TEXT("Use Shift+Enter to search in the opposite direction."));
1083  			 _shiftTrickUpTip = CreateToolTip(IDOK, _hSelf, _hInst, const_cast<PTSTR>(searchButtonTip.c_str()), _isRTL);
1084  			 generic_string checkboxTip = pNativeSpeaker->getLocalizedStrFromID("two-find-buttons-tip", TEXT("2 find buttons mode"));
1085  			 _2ButtonsTip = CreateToolTip(IDC_2_BUTTONS_MODE, _hSelf, _hInst, const_cast<PTSTR>(checkboxTip.c_str()), _isRTL);
1086  			 generic_string findInFilesFilterTip = pNativeSpeaker->getLocalizedStrFromID("find-in-files-filter-tip", TEXT("Find in cpp, cxx, h, hxx && hpp:\r*.cpp *.cxx *.h *.hxx *.hpp\r\rFind in all files except exe, obj && log:\r*.* !*.exe !*.obj !*.log\r\rFind in all files but exclude folders tests, bin && bin64:\r*.* !\\tests !\\bin*\r\rFind in all files but exclude all folders log or logs recursively:\r*.* !+\\log*"));
1087  			 _filterTip = CreateToolTip(IDD_FINDINFILES_FILTERS_STATIC, _hSelf, _hInst, const_cast<PTSTR>(findInFilesFilterTip.c_str()), _isRTL);
1088  			::SetWindowTextW(::GetDlgItem(_hSelf, IDC_FINDPREV), TEXT(""));
1089  			::SetWindowTextW(::GetDlgItem(_hSelf, IDC_FINDNEXT), TEXT(" Find Next"));
1090  			_hSwapButton = ::GetDlgItem(_hSelf, IDD_FINDREPLACE_SWAP_BUTTON);
1091  			::SetWindowLongPtr(_hSwapButton, GWLP_USERDATA, reinterpret_cast<LONG_PTR>(this));
1092  			_oldSwapButtonProc = reinterpret_cast<WNDPROC>(::SetWindowLongPtr(_hSwapButton, GWLP_WNDPROC, reinterpret_cast<LONG_PTR>(swapButtonProc)));
1093  			::SetWindowTextW(_hSwapButton, TEXT(""));
1094  			::SetWindowTextW(::GetDlgItem(_hSelf, IDD_RESIZE_TOGGLE_BUTTON), TEXT(""));
1095  			_hLargerBolderFont = createFont(TEXT("Courier New"), 14, true, _hSelf);
1096  			SendMessage(_hSwapButton, WM_SETFONT, (WPARAM)_hLargerBolderFont, MAKELPARAM(true, 0));
1097  			_hCourrierNewFont = createFont(TEXT("Courier New"), 12, false, _hSelf);
1098  			SendMessage(::GetDlgItem(_hSelf, IDD_RESIZE_TOGGLE_BUTTON), WM_SETFONT, (WPARAM)_hCourrierNewFont, MAKELPARAM(true, 0));
1099  			return TRUE;
1100  		}
1101  		case WM_DRAWITEM :
1102  		{
1103  			drawItem((DRAWITEMSTRUCT *)lParam);
1104  			return TRUE;
1105  		}
1106  		case WM_HSCROLL :
1107  		{
1108  			if (reinterpret_cast<HWND>(lParam) == ::GetDlgItem(_hSelf, IDC_PERCENTAGE_SLIDER))
1109  			{
1110  				int percent = static_cast<int32_t>(::SendDlgItemMessage(_hSelf, IDC_PERCENTAGE_SLIDER, TBM_GETPOS, 0, 0));
1111  				FindHistory & findHistory = (NppParameters::getInstance()).getFindHistory();
1112  				findHistory._transparency = percent;
1113  				if (isCheckedOrNot(IDC_TRANSPARENT_ALWAYS_RADIO))
1114  				{
1115  					(NppParameters::getInstance()).SetTransparent(_hSelf, percent);
1116  				}
1117  			}
1118  			return TRUE;
1119  		}
1120  		case WM_NOTIFY:
1121  		{
1122  			auto lpnmhdr = reinterpret_cast<LPNMHDR>(lParam);
1123  			switch (lpnmhdr->code)
1124  			{
1125  				case TCN_SELCHANGE:
1126  				{
1127  					const HWND tabHandle = _tab.getHSelf();
1128  					if (lpnmhdr->hwndFrom == tabHandle)
1129  					{
1130  						const auto indexClicked = static_cast<int>(::SendMessage(tabHandle, TCM_GETCURSEL, 0, 0));
1131  						doDialog(static_cast<DIALOG_TYPE>(indexClicked));
1132  						return TRUE;
1133  					}
1134  					break;
1135  				}
1136  				case BCN_DROPDOWN:
1137  				{
1138  					if (lpnmhdr->hwndFrom == _hSwapButton)
1139  					{
1140  						if (!_swapPopupMenu.isCreated())
1141  						{
1142  							vector<MenuItemUnit> itemUnitArray;
1143  							itemUnitArray.push_back(MenuItemUnit(IDC_SWAP_FIND_REPLACE, TEXT(" Swap Find with Replace")));
1144  							itemUnitArray.push_back(MenuItemUnit(IDC_COPY_FIND2REPLACE, TEXT(" Copy from Find to Replace")));
1145  							itemUnitArray.push_back(MenuItemUnit(IDC_COPY_REPLACE2FIND, TEXT(" Copy from Replace to Find")));
1146  							NativeLangSpeaker* pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
1147  							for (auto&& i : itemUnitArray)
1148  							{
1149  								i._itemName = pNativeSpeaker->getDlgLangMenuStr("Dialog", "Find", i._cmdID, i._itemName.c_str());
1150  							}
1151  							_swapPopupMenu.create(_hSelf, itemUnitArray);
1152  						}
1153  						RECT rc{};
1154  						::GetClientRect(_hSwapButton, &rc);
1155  						POINT p{};
1156  						::ClientToScreen(_hSwapButton, &p);
1157  						p.y += rc.bottom;
1158  						_swapPopupMenu.display(p);
1159  						return TRUE;
1160  					}
1161  					break;
1162  				}
1163  			}
1164  			return FALSE;
1165  		}
1166  		case WM_ACTIVATE :
1167  		{
1168  			if (LOWORD(wParam) == WA_ACTIVE || LOWORD(wParam) == WA_CLICKACTIVE)
1169  			{
1170  				Sci_CharacterRangeFull cr = (*_ppEditView)->getSelection();
1171  				intptr_t nbSelected = cr.cpMax - cr.cpMin;
1172  				_options._isInSelection = isCheckedOrNot(IDC_IN_SELECTION_CHECK)?1:0;
1173  				int checkVal = _options._isInSelection?BST_CHECKED:BST_UNCHECKED;
1174  				if (!_options._isInSelection)
1175  				{
1176  					if (nbSelected <= FINDREPLACE_INSEL_TEXTSIZE_THRESHOLD)
1177  					{
1178  						checkVal = BST_UNCHECKED;
1179  						_options._isInSelection = false;
1180  					}
1181  					else
1182  					{
1183  						checkVal = BST_CHECKED;
1184  						_options._isInSelection = true;
1185  					}
1186  				}
1187  				if (((*_ppEditView)->execute(SCI_GETSELECTIONMODE) == SC_SEL_RECTANGLE) || ((*_ppEditView)->execute(SCI_GETSELECTIONS) > 1))
1188  				{
1189  					checkVal = BST_UNCHECKED;
1190  					_options._isInSelection = false;
1191  					nbSelected = 0;
1192  				}
1193  				enableFindDlgItem(IDC_IN_SELECTION_CHECK, nbSelected != 0);
1194  				if (!nbSelected)
1195  				{
1196  					checkVal = BST_UNCHECKED;
1197  					_options._isInSelection = false;
1198  				}
1199  				::SendDlgItemMessage(_hSelf, IDC_IN_SELECTION_CHECK, BM_SETCHECK, checkVal, 0);
1200  			}
1201  			if (isCheckedOrNot(IDC_TRANSPARENT_LOSSFOCUS_RADIO))
1202  			{
1203  				if (LOWORD(wParam) == WA_INACTIVE && isVisible())
1204  				{
1205  					int percent = static_cast<int32_t>(::SendDlgItemMessage(_hSelf, IDC_PERCENTAGE_SLIDER, TBM_GETPOS, 0, 0));
1206  					(NppParameters::getInstance()).SetTransparent(_hSelf, percent);
1207  				}
1208  				else
1209  				{
1210  					(NppParameters::getInstance()).removeTransparent(_hSelf);
1211  				}
1212  			}
1213  			if (isCheckedOrNot(IDREGEXP))
1214  			{
1215  				enableFindDlgItem(IDREDOTMATCHNL);
1216  			}
1217  			else
1218  			{
1219  				enableFindDlgItem(IDREDOTMATCHNL, false);
1220  			}
1221  			enableProjectCheckmarks();
1222  			return TRUE;
1223  		}
1224  		case NPPM_MODELESSDIALOG :
1225  			return ::SendMessage(_hParent, NPPM_MODELESSDIALOG, wParam, lParam);
1226  		case WM_COMMAND :
1227  		{
1228  			bool isMacroRecording = (static_cast<MacroStatus>(::SendMessage(_hParent, NPPM_GETCURRENTMACROSTATUS,0,0)) == MacroStatus::RecordInProgress);
1229  			NppParameters& nppParamInst = NppParameters::getInstance();
1230  			FindHistory & findHistory = nppParamInst.getFindHistory();
1231  			switch (LOWORD(wParam))
1232  			{
1233  				case IDC_2_BUTTONS_MODE:
1234  				{
1235  					bool is2ButtonsMode = isCheckedOrNot(IDC_2_BUTTONS_MODE);
1236  					findHistory._isSearch2ButtonsMode = is2ButtonsMode;
1237  					showFindDlgItem(IDC_FINDPREV, is2ButtonsMode);
1238  					showFindDlgItem(IDC_FINDNEXT, is2ButtonsMode);
1239  					showFindDlgItem(IDOK, !is2ButtonsMode);
1240  				}
1241  				break;
1242  				case IDCANCEL:
1243  					(*_ppEditView)->execute(SCI_CALLTIPCANCEL);
1244  					setStatusbarMessage(generic_string(), FSNoMessage);
1245  					display(false);
1246  					break;
1247  				case IDC_FINDPREV:
1248  				case IDC_FINDNEXT:
1249  				case IDOK : 
1250  				{
1251  					setStatusbarMessage(generic_string(), FSNoMessage);
1252  					HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
1253  					_options._str2Search = getTextFromCombo(hFindCombo);
1254  					updateCombo(IDFINDWHAT);
1255  					nppParamInst._isFindReplacing = true;
1256  					bool direction_bak = _options._whichDirection;
1257  					if (LOWORD(wParam) == IDC_FINDPREV)
1258  					{
1259  						_options._whichDirection = DIR_UP;
1260  					}
1261  					else if (LOWORD(wParam) == IDC_FINDNEXT)
1262  					{
1263  						_options._whichDirection = DIR_DOWN;
1264  					}
1265  					else 
1266  					{
1267  						SHORT shift = GetKeyState(VK_SHIFT);
1268  						if (shift & SHIFTED)
1269  						{
1270  							_options._whichDirection = !_options._whichDirection;
1271  						}
1272  					}
1273  					if ((_options._whichDirection == DIR_UP) && (_options._searchType == FindRegex) && !nppParamInst.regexBackward4PowerUser())
1274  					{
1275  					}
1276  					else
1277  					{
1278  						if (isMacroRecording)
1279  							saveInMacro(IDOK, FR_OP_FIND);
1280  						FindStatus findStatus = FSFound;
1281  						processFindNext(_options._str2Search.c_str(), _env, &findStatus);
1282  						NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
1283  						if (findStatus == FSEndReached)
1284  						{
1285  							generic_string msg = pNativeSpeaker->getLocalizedStrFromID("find-status-end-reached", TEXT("Find: Found the 1st occurrence from the top. The end of the document has been reached."));
1286  							setStatusbarMessage(msg, FSEndReached);
1287  						}
1288  						else if (findStatus == FSTopReached)
1289  						{
1290  							generic_string msg = pNativeSpeaker->getLocalizedStrFromID("find-status-top-reached", TEXT("Find: Found the 1st occurrence from the bottom. The beginning of the document has been reached."));
1291  							setStatusbarMessage(msg, FSTopReached);
1292  						}
1293  					}
1294  					_options._whichDirection = direction_bak;
1295  					nppParamInst._isFindReplacing = false;
1296  				}
1297  				return TRUE;
1298  				case IDC_SWAP_FIND_REPLACE:
1299  				{
1300  					if (_swapButtonStatus != swap)
1301  					{
1302  						_swapButtonStatus = swap;
1303  						::SetWindowTextW(_hSwapButton, L"");
1304  						SendMessage(_hSwapButton, WM_SETFONT, (WPARAM)_hLargerBolderFont, MAKELPARAM(true, 0));
1305  					}
1306  					::SendMessage(_hSelf, WM_COMMAND, IDD_FINDREPLACE_SWAP_BUTTON, 0);
1307  					return TRUE;
1308  				}
1309  				case IDC_COPY_FIND2REPLACE:
1310  				{
1311  					if (_swapButtonStatus != down)
1312  					{
1313  						_swapButtonStatus = down;
1314  						::SetWindowTextW(_hSwapButton, L"");
1315  						SendMessage(_hSwapButton, WM_SETFONT, (WPARAM)_hLargerBolderFont, MAKELPARAM(true, 0));
1316  					}
1317  					::SendMessage(_hSelf, WM_COMMAND, IDD_FINDREPLACE_SWAP_BUTTON, 0);
1318  					return TRUE;
1319  				}
1320  				case IDC_COPY_REPLACE2FIND:
1321  				{
1322  					if (_swapButtonStatus != up)
1323  					{
1324  						_swapButtonStatus = up;
1325  						::SetWindowTextW(_hSwapButton, L"");
1326  						SendMessage(_hSwapButton, WM_SETFONT, (WPARAM)_hLargerBolderFont, MAKELPARAM(true, 0));
1327  					}
1328  					::SendMessage(_hSelf, WM_COMMAND, IDD_FINDREPLACE_SWAP_BUTTON, 0);
1329  					return TRUE;
1330  				}
1331  				case IDD_FINDREPLACE_SWAP_BUTTON:
1332  				{
1333  					HWND hFindWhat = ::GetDlgItem(_hSelf, IDFINDWHAT);
1334  					generic_string findWhatText = getTextFromCombo(hFindWhat);
1335  					HWND hPlaceWith = ::GetDlgItem(_hSelf, IDREPLACEWITH);
1336  					generic_string replaceWithText = getTextFromCombo(hPlaceWith);
1337  					if (_swapButtonStatus == swap)
1338  					{
1339  						if ((!findWhatText.empty() || !replaceWithText.empty()) && (findWhatText != replaceWithText))
1340  						{
1341  							::SendMessage(hFindWhat, WM_SETTEXT, 0, reinterpret_cast<LPARAM>(replaceWithText.c_str()));
1342  							::SendMessage(hPlaceWith, WM_SETTEXT, 0, reinterpret_cast<LPARAM>(findWhatText.c_str()));
1343  						}
1344  					}
1345  					else if (_swapButtonStatus == down)
1346  					{
1347  						if (!findWhatText.empty() && (findWhatText != replaceWithText))
1348  						{
1349  							::SendMessage(hPlaceWith, WM_SETTEXT, 0, reinterpret_cast<LPARAM>(findWhatText.c_str()));
1350  						}
1351  					}
1352  					else 
1353  					{
1354  						if (!replaceWithText.empty() && (findWhatText != replaceWithText))
1355  						{
1356  							::SendMessage(hFindWhat, WM_SETTEXT, 0, reinterpret_cast<LPARAM>(replaceWithText.c_str()));
1357  						}
1358  					}
1359  				}
1360  				return TRUE;
1361  				case IDM_SEARCH_FIND:
1362  					if (_currentStatus == FIND_DLG)
1363  						goToCenter();
1364  					else
1365  						enableReplaceFunc(false);
1366  					return TRUE;
1367  				case IDM_SEARCH_REPLACE:
1368  					if (_currentStatus == REPLACE_DLG)
1369  						goToCenter();
1370  					else
1371  						enableReplaceFunc(true);
1372  					return TRUE;
1373  				case IDM_SEARCH_FINDINFILES:
1374  					if (_currentStatus == FINDINFILES_DLG)
1375  						goToCenter();
1376  					else
1377  						enableFindInFilesFunc();
1378  					return TRUE;
1379  				case IDM_SEARCH_MARK:
1380  					if (_currentStatus == MARK_DLG)
1381  						goToCenter();
1382  					else
1383  						enableMarkFunc();
1384  					return TRUE;
1385  				case IDREPLACE:
1386  				{
1387  					std::lock_guard<std::mutex> lock(findOps_mutex);
1388  					if (_currentStatus == REPLACE_DLG)
1389  					{
1390  						setStatusbarMessage(TEXT(""), FSNoMessage);
1391  						HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
1392  						HWND hReplaceCombo = ::GetDlgItem(_hSelf, IDREPLACEWITH);
1393  						_options._str2Search = getTextFromCombo(hFindCombo);
1394  						_options._str4Replace = getTextFromCombo(hReplaceCombo);
1395  						updateCombos();
1396  						nppParamInst._isFindReplacing = true;
1397  						if (isMacroRecording) saveInMacro(wParam, FR_OP_REPLACE);
1398  						processReplace(_options._str2Search.c_str(), _options._str4Replace.c_str());
1399  						nppParamInst._isFindReplacing = false;
1400  					}
1401  				}
1402  				return TRUE;
1403  				case IDC_FINDALL_OPENEDFILES :
1404  				{
1405  					if (_currentStatus == FIND_DLG)
1406  					{
1407  						setStatusbarMessage(TEXT(""), FSNoMessage);
1408  						HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
1409  						combo2ExtendedMode(IDFINDWHAT);
1410  						_options._str2Search = getTextFromCombo(hFindCombo);
1411  						updateCombo(IDFINDWHAT);
1412  						nppParamInst._isFindReplacing = true;
1413  						if (isMacroRecording) saveInMacro(wParam, FR_OP_FIND + FR_OP_GLOBAL);
1414  						findAllIn(ALL_OPEN_DOCS);
1415  						nppParamInst._isFindReplacing = false;
1416  					}
1417  				}
1418  				return TRUE;
1419  				case IDC_FINDALL_CURRENTFILE :
1420  				{
1421  					setStatusbarMessage(TEXT(""), FSNoMessage);
1422  					HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
1423  					combo2ExtendedMode(IDFINDWHAT);
1424  					_options._str2Search = getTextFromCombo(hFindCombo);
1425  					updateCombo(IDFINDWHAT);
1426  					nppParamInst._isFindReplacing = true;
1427  					if (isMacroRecording) saveInMacro(wParam, FR_OP_FIND + FR_OP_GLOBAL);
1428  					findAllIn(_options._isInSelection ? CURR_DOC_SELECTION : CURRENT_DOC);
1429  					nppParamInst._isFindReplacing = false;
1430  				}
1431  				return TRUE;
1432  				case IDD_FINDINFILES_FIND_BUTTON:
1433  				{
1434  					setStatusbarMessage(TEXT(""), FSNoMessage);
1435  					constexpr int filterSize = 512;
1436  					TCHAR filters[filterSize + 1] = { '\0' };
1437  					filters[filterSize] = '\0';
1438  					TCHAR directory[MAX_PATH]{};
1439  					::GetDlgItemText(_hSelf, IDD_FINDINFILES_FILTERS_COMBO, filters, filterSize);
1440  					addText2Combo(filters, ::GetDlgItem(_hSelf, IDD_FINDINFILES_FILTERS_COMBO));
1441  					_options._filters = filters;
1442  					HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
1443  					combo2ExtendedMode(IDFINDWHAT);
1444  					_options._str2Search = getTextFromCombo(hFindCombo);
1445  					updateCombo(IDFINDWHAT);
1446  					if (_currentStatus == FINDINFILES_DLG)
1447  					{
1448  						::GetDlgItemText(_hSelf, IDD_FINDINFILES_DIR_COMBO, directory, MAX_PATH);
1449  						_options._directory = directory;
1450  						trim(_options._directory);
1451  						if (!_options._directory.empty())
1452  						{
1453  							addText2Combo(_options._directory.c_str(), ::GetDlgItem(_hSelf, IDD_FINDINFILES_DIR_COMBO));
1454  							if (_options._directory.back() != L'\\')
1455  							{
1456  								_options._directory += TEXT("\\");
1457  							}
1458  							nppParamInst._isFindReplacing = true;
1459  							if (isMacroRecording) saveInMacro(wParam, FR_OP_FIND + FR_OP_FIF);
1460  							findAllIn(FILES_IN_DIR);
1461  							nppParamInst._isFindReplacing = false;
1462  						}
1463  					}
1464  					else if (_currentStatus == FINDINPROJECTS_DLG)
1465  					{
1466  						if (_options._isProjectPanel_1 || _options._isProjectPanel_2 || _options._isProjectPanel_3)
1467  						{
1468  							nppParamInst._isFindReplacing = true;
1469  							if (isMacroRecording) saveInMacro(IDD_FINDINFILES_FINDINPROJECTS, FR_OP_FIND + FR_OP_FIP);
1470  							findAllIn(FILES_IN_PROJECTS);
1471  							nppParamInst._isFindReplacing = false;
1472  						}
1473  					}
1474  				}
1475  				return TRUE;
1476  				case IDD_FINDINFILES_REPLACEINFILES:
1477  				{
1478  					std::lock_guard<std::mutex> lock(findOps_mutex);
1479  					setStatusbarMessage(TEXT(""), FSNoMessage);
1480  					constexpr int filterSize = 512;
1481  					TCHAR filters[filterSize]{};
1482  					TCHAR directory[MAX_PATH]{};
1483  					::GetDlgItemText(_hSelf, IDD_FINDINFILES_FILTERS_COMBO, filters, filterSize);
1484  					addText2Combo(filters, ::GetDlgItem(_hSelf, IDD_FINDINFILES_FILTERS_COMBO));
1485  					_options._filters = filters;
1486  					::GetDlgItemText(_hSelf, IDD_FINDINFILES_DIR_COMBO, directory, MAX_PATH);
1487  					_options._directory = directory;
1488  					trim(_options._directory);
1489  					if (!_options._directory.empty())
1490  					{
1491  						if (replaceInFilesConfirmCheck(_options._directory, _options._filters))
1492  						{
1493  							addText2Combo(_options._directory.c_str(), ::GetDlgItem(_hSelf, IDD_FINDINFILES_DIR_COMBO));
1494  							if (_options._directory.back() != L'\\')
1495  							{
1496  								_options._directory += TEXT("\\");
1497  							}
1498  							HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
1499  							_options._str2Search = getTextFromCombo(hFindCombo);
1500  							HWND hReplaceCombo = ::GetDlgItem(_hSelf, IDREPLACEWITH);
1501  							_options._str4Replace = getTextFromCombo(hReplaceCombo);
1502  							updateCombo(IDFINDWHAT);
1503  							updateCombo(IDREPLACEWITH);
1504  							nppParamInst._isFindReplacing = true;
1505  							if (isMacroRecording) saveInMacro(wParam, FR_OP_REPLACE + FR_OP_FIF);
1506  							::SendMessage(_hParent, WM_REPLACEINFILES, 0, 0);
1507  							nppParamInst._isFindReplacing = false;
1508  						}
1509  					}
1510  				}
1511  				return TRUE;
1512  				case IDD_FINDINFILES_REPLACEINPROJECTS:
1513  				{
1514  					std::lock_guard<std::mutex> lock(findOps_mutex);
1515  					setStatusbarMessage(TEXT(""), FSNoMessage);
1516  					constexpr int filterSize = 512;
1517  					TCHAR filters[filterSize]{};
1518  					::GetDlgItemText(_hSelf, IDD_FINDINFILES_FILTERS_COMBO, filters, filterSize);
1519  					addText2Combo(filters, ::GetDlgItem(_hSelf, IDD_FINDINFILES_FILTERS_COMBO));
1520  					_options._filters = filters;
1521  					if (replaceInProjectsConfirmCheck())
1522  					{
1523  						HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
1524  						_options._str2Search = getTextFromCombo(hFindCombo);
1525  						HWND hReplaceCombo = ::GetDlgItem(_hSelf, IDREPLACEWITH);
1526  						_options._str4Replace = getTextFromCombo(hReplaceCombo);
1527  						updateCombo(IDFINDWHAT);
1528  						updateCombo(IDREPLACEWITH);
1529  						nppParamInst._isFindReplacing = true;
1530  						if (isMacroRecording) saveInMacro(wParam, FR_OP_REPLACE + FR_OP_FIP);
1531  						::SendMessage(_hParent, WM_REPLACEINPROJECTS, 0, 0);
1532  						nppParamInst._isFindReplacing = false;
1533  					}
1534  				}
1535  				return TRUE;
1536  				case IDC_REPLACE_OPENEDFILES :
1537  				{
1538  					std::lock_guard<std::mutex> lock(findOps_mutex);
1539  					if (_currentStatus == REPLACE_DLG)
1540  					{
1541  						NppParameters& nppParam = NppParameters::getInstance();
1542  						const NppGUI& nppGui = nppParam.getNppGUI();
1543  						if (!nppGui._confirmReplaceInAllOpenDocs || replaceInOpenDocsConfirmCheck())
1544  						{
1545  							setStatusbarMessage(TEXT(""), FSNoMessage);
1546  							HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
1547  							_options._str2Search = getTextFromCombo(hFindCombo);
1548  							HWND hReplaceCombo = ::GetDlgItem(_hSelf, IDREPLACEWITH);
1549  							_options._str4Replace = getTextFromCombo(hReplaceCombo);
1550  							updateCombos();
1551  							nppParamInst._isFindReplacing = true;
1552  							if (isMacroRecording) saveInMacro(wParam, FR_OP_REPLACE + FR_OP_GLOBAL);
1553  							replaceAllInOpenedDocs();
1554  							nppParamInst._isFindReplacing = false;
1555  						}
1556  					}
1557  				}
1558  				return TRUE;
1559  				case IDREPLACEALL :
1560  				{
1561  					std::lock_guard<std::mutex> lock(findOps_mutex);
1562  					if (_currentStatus == REPLACE_DLG)
1563  					{
1564  						setStatusbarMessage(TEXT(""), FSNoMessage);
1565  						if ((*_ppEditView)->getCurrentBuffer()->isReadOnly())
1566  						{
1567  							NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
1568  							generic_string msg = pNativeSpeaker->getLocalizedStrFromID("find-status-replace-readonly", TEXT("Replace: Cannot replace text. The current document is read only."));
1569  							setStatusbarMessage(msg, FSNotFound);
1570  							return TRUE;
1571  						}
1572  						HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
1573  						_options._str2Search = getTextFromCombo(hFindCombo);
1574  						HWND hReplaceCombo = ::GetDlgItem(_hSelf, IDREPLACEWITH);
1575  						_options._str4Replace = getTextFromCombo(hReplaceCombo);
1576  						updateCombos();
1577  						nppParamInst._isFindReplacing = true;
1578  						if (isMacroRecording) saveInMacro(wParam, FR_OP_REPLACE);
1579  						(*_ppEditView)->execute(SCI_BEGINUNDOACTION);
1580  						int nbReplaced = processAll(ProcessReplaceAll, &_options);
1581  						(*_ppEditView)->execute(SCI_ENDUNDOACTION);
1582  						nppParamInst._isFindReplacing = false;
1583  						generic_string result;
1584  						NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
1585  						if (nbReplaced < 0)
1586  						{
1587  							result = pNativeSpeaker->getLocalizedStrFromID("find-status-replaceall-re-malformed", TEXT("Replace All: The regular expression is malformed."));
1588  						}
1589  						else
1590  						{
1591  							if (nbReplaced == 1)
1592  							{
1593  								result = pNativeSpeaker->getLocalizedStrFromID("find-status-replaceall-1-replaced", TEXT("Replace All: 1 occurrence was replaced"));
1594  							}
1595  							else
1596  							{
1597  								result = pNativeSpeaker->getLocalizedStrFromID("find-status-replaceall-nb-replaced", TEXT("Replace All: $INT_REPLACE$ occurrences were replaced"));
1598  								result = stringReplace(result, TEXT("$INT_REPLACE$"), std::to_wstring(nbReplaced));
1599  							}
1600  							result += TEXT(" ");
1601  							result += getScopeInfoForStatusBar(&_options);
1602  						}
1603  						setStatusbarMessage(result, FSMessage);
1604  						getFocus();
1605  					}
1606  				}
1607  				return TRUE;
1608  				case IDCCOUNTALL :
1609  				{
1610  					if (_currentStatus == FIND_DLG)
1611  					{
1612  						setStatusbarMessage(TEXT(""), FSNoMessage);
1613  						HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
1614  						updateCombo(IDFINDWHAT);
1615  						_options._str2Search = getTextFromCombo(hFindCombo);
1616  						int nbCounted = processAll(ProcessCountAll, &_options);
1617  						generic_string result;
1618  						NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
1619  						if (nbCounted < 0)
1620  						{
1621  							result = pNativeSpeaker->getLocalizedStrFromID("find-status-count-re-malformed", TEXT("Count: The regular expression to search is malformed."));
1622  						}
1623  						else
1624  						{
1625  							if (nbCounted == 1)
1626  							{
1627  								result = pNativeSpeaker->getLocalizedStrFromID("find-status-count-1-match", TEXT("Count: 1 match"));
1628  							}
1629  							else
1630  							{
1631  								result = pNativeSpeaker->getLocalizedStrFromID("find-status-count-nb-matches", TEXT("Count: $INT_REPLACE$ matches"));
1632  								result = stringReplace(result, TEXT("$INT_REPLACE$"), std::to_wstring(nbCounted));
1633  							}
1634  							result += TEXT(" ");
1635  							result += getScopeInfoForStatusBar(&_options);
1636  						}
1637  						if (isMacroRecording) saveInMacro(wParam, FR_OP_FIND);
1638  						setStatusbarMessage(result, FSMessage);
1639  						getFocus();
1640  					}
1641  				}
1642  				return TRUE;
1643  				case IDCMARKALL :
1644  				{
1645  					if (_currentStatus == MARK_DLG)
1646  					{
1647  						setStatusbarMessage(TEXT(""), FSNoMessage);
1648  						HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
1649  						_options._str2Search = getTextFromCombo(hFindCombo);
1650  						updateCombo(IDFINDWHAT);
1651  						if (isMacroRecording) saveInMacro(wParam, FR_OP_FIND);
1652  						nppParamInst._isFindReplacing = true;
1653  						int nbMarked = processAll(ProcessMarkAll, &_options);
1654  						nppParamInst._isFindReplacing = false;
1655  						generic_string result;
1656  						NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
1657  						if (nbMarked < 0)
1658  						{
1659  							result = pNativeSpeaker->getLocalizedStrFromID("find-status-mark-re-malformed", TEXT("Mark: The regular expression to search is malformed."));
1660  						}
1661  						else
1662  						{
1663  							if (nbMarked == 1)
1664  							{
1665  								result = pNativeSpeaker->getLocalizedStrFromID("find-status-mark-1-match", TEXT("Mark: 1 match"));
1666  							}
1667  							else
1668  							{
1669  								result = pNativeSpeaker->getLocalizedStrFromID("find-status-mark-nb-matches", TEXT("Mark: $INT_REPLACE$ matches"));
1670  								result = stringReplace(result, TEXT("$INT_REPLACE$"), std::to_wstring(nbMarked));
1671  							}
1672  							result += TEXT(" ");
1673  							result += getScopeInfoForStatusBar(&_options);
1674  						}
1675  						setStatusbarMessage(result, FSMessage);
1676  						getFocus();
1677  					}
1678  				}
1679  				return TRUE;
1680  				case IDC_CLEAR_ALL :
1681  				{
1682  					if (_currentStatus == MARK_DLG)
1683  					{
1684  						if (isMacroRecording) saveInMacro(wParam, FR_OP_FIND);
1685  						clearMarks(_options);
1686  					}
1687  				}
1688  				return TRUE;
1689  				case IDC_COPY_MARKED_TEXT:
1690  				{
1691  					::SendMessage(_hParent, WM_COMMAND, IDM_SEARCH_MARKEDTOCLIP, 0);
1692  				}
1693  				return TRUE;
1694  				case IDREDOTMATCHNL:
1695  					findHistory._dotMatchesNewline = _options._dotMatchesNewline = isCheckedOrNot(IDREDOTMATCHNL);
1696  					return TRUE;
1697  				case IDWHOLEWORD :
1698  					findHistory._isMatchWord = _options._isWholeWord = isCheckedOrNot(IDWHOLEWORD);
1699  					return TRUE;
1700  				case IDMATCHCASE :
1701  					findHistory._isMatchCase = _options._isMatchCase = isCheckedOrNot(IDMATCHCASE);
1702  					return TRUE;
1703  				case IDNORMAL:
1704  				case IDEXTENDED:
1705  				case IDREGEXP :
1706  				{
1707  					if (isCheckedOrNot(IDREGEXP))
1708  					{
1709  						_options._searchType = FindRegex;
1710  						findHistory._searchMode = FindHistory::regExpr;
1711  						enableFindDlgItem(IDREDOTMATCHNL);
1712  					}
1713  					else if (isCheckedOrNot(IDEXTENDED))
1714  					{
1715  						_options._searchType = FindExtended;
1716  						findHistory._searchMode = FindHistory::extended;
1717  						enableFindDlgItem(IDREDOTMATCHNL, false);
1718  					}
1719  					else
1720  					{
1721  						_options._searchType = FindNormal;
1722  						findHistory._searchMode = FindHistory::normal;
1723  						enableFindDlgItem(IDREDOTMATCHNL, false);
1724  					}
1725  					bool isRegex = (_options._searchType == FindRegex);
1726  					if (isRegex)
1727  					{
1728  						_options._isWholeWord = false;
1729  						::SendDlgItemMessage(_hSelf, IDWHOLEWORD, BM_SETCHECK, _options._isWholeWord?BST_CHECKED:BST_UNCHECKED, 0);
1730  						if (!nppParamInst.regexBackward4PowerUser())
1731  						{
1732  							::SendDlgItemMessage(_hSelf, IDC_BACKWARDDIRECTION, BM_SETCHECK, BST_UNCHECKED, 0);
1733  							_options._whichDirection = DIR_DOWN;
1734  						}
1735  					}
1736  					enableFindDlgItem(IDWHOLEWORD, !isRegex);
1737  					bool doEnable = true;
1738  					if (isRegex && !nppParamInst.regexBackward4PowerUser())
1739  					{
1740  						doEnable = false;
1741  					}
1742  					enableFindDlgItem(IDC_BACKWARDDIRECTION, doEnable);
1743  					enableFindDlgItem(IDC_FINDPREV, doEnable);
1744  					return TRUE;
1745  				}
1746  				case IDWRAP :
1747  					findHistory._isWrap = _options._isWrapAround = isCheckedOrNot(IDWRAP);
1748  					return TRUE;
1749  				case IDC_BACKWARDDIRECTION:
1750  					_options._whichDirection = isCheckedOrNot(IDC_BACKWARDDIRECTION) ? DIR_UP : DIR_DOWN;
1751  					findHistory._isDirectionDown = _options._whichDirection == DIR_DOWN;
1752  					return TRUE;
1753  				case IDC_PURGE_CHECK :
1754  				{
1755  					if (_currentStatus == MARK_DLG)
1756  						findHistory._isPurge = _options._doPurge = isCheckedOrNot(IDC_PURGE_CHECK);
1757  				}
1758  				return TRUE;
1759  				case IDC_MARKLINE_CHECK :
1760  				{
1761  					if (_currentStatus == MARK_DLG)
1762  						findHistory._isBookmarkLine = _options._doMarkLine = isCheckedOrNot(IDC_MARKLINE_CHECK);
1763  				}
1764  				return TRUE;
1765  				case IDC_IN_SELECTION_CHECK :
1766  				{
1767  					if ((_currentStatus == FIND_DLG) || (_currentStatus == REPLACE_DLG) || (_currentStatus == MARK_DLG))
1768  						_options._isInSelection = isCheckedOrNot(IDC_IN_SELECTION_CHECK);
1769  				}
1770  				return TRUE;
1771  				case IDC_TRANSPARENT_CHECK :
1772  				{
1773  					bool isChecked = isCheckedOrNot(IDC_TRANSPARENT_CHECK);
1774  					enableFindDlgItem(IDC_TRANSPARENT_LOSSFOCUS_RADIO, isChecked);
1775  					enableFindDlgItem(IDC_TRANSPARENT_ALWAYS_RADIO, isChecked);
1776  					enableFindDlgItem(IDC_PERCENTAGE_SLIDER, isChecked);
1777  					if (isChecked)
1778  					{
1779  						::SendDlgItemMessage(_hSelf, IDC_TRANSPARENT_LOSSFOCUS_RADIO, BM_SETCHECK, BST_CHECKED, 0);
1780  						findHistory._transparencyMode = FindHistory::onLossingFocus;
1781  					}
1782  					else
1783  					{
1784  						::SendDlgItemMessage(_hSelf, IDC_TRANSPARENT_LOSSFOCUS_RADIO, BM_SETCHECK, BST_UNCHECKED, 0);
1785  						::SendDlgItemMessage(_hSelf, IDC_TRANSPARENT_ALWAYS_RADIO, BM_SETCHECK, BST_UNCHECKED, 0);
1786  						(NppParameters::getInstance()).removeTransparent(_hSelf);
1787  						findHistory._transparencyMode = FindHistory::none;
1788  					}
1789  					return TRUE;
1790  				}
1791  				case IDC_TRANSPARENT_ALWAYS_RADIO :
1792  				{
1793  					int percent = static_cast<int32_t>(::SendDlgItemMessage(_hSelf, IDC_PERCENTAGE_SLIDER, TBM_GETPOS, 0, 0));
1794  					(NppParameters::getInstance()).SetTransparent(_hSelf, percent);
1795  					findHistory._transparencyMode = FindHistory::persistant;
1796  				}
1797  				return TRUE;
1798  				case IDC_TRANSPARENT_LOSSFOCUS_RADIO :
1799  				{
1800  					(NppParameters::getInstance()).removeTransparent(_hSelf);
1801  					findHistory._transparencyMode = FindHistory::onLossingFocus;
1802  				}
1803  				return TRUE;
1804  				case IDD_FINDINFILES_RECURSIVE_CHECK :
1805  				{
1806  					if (_currentStatus == FINDINFILES_DLG)
1807  						findHistory._isFifRecuisive = _options._isRecursive = isCheckedOrNot(IDD_FINDINFILES_RECURSIVE_CHECK);
1808  				}
1809  				return TRUE;
1810  				case IDD_FINDINFILES_INHIDDENDIR_CHECK :
1811  				{
1812  					if (_currentStatus == FINDINFILES_DLG)
1813  						findHistory._isFifInHiddenFolder = _options._isInHiddenDir = isCheckedOrNot(IDD_FINDINFILES_INHIDDENDIR_CHECK);
1814  				}
1815  				return TRUE;
1816  				case IDD_FINDINFILES_PROJECT1_CHECK:
1817  				case IDD_FINDINFILES_PROJECT2_CHECK:
1818  				case IDD_FINDINFILES_PROJECT3_CHECK:
1819  				{
1820  					if (_currentStatus == FINDINPROJECTS_DLG)
1821  					{
1822  						switch (LOWORD(wParam))
1823  						{
1824  							case IDD_FINDINFILES_PROJECT1_CHECK:
1825  								findHistory._isFifProjectPanel_1 = _options._isProjectPanel_1 = isCheckedOrNot(IDD_FINDINFILES_PROJECT1_CHECK);
1826  								break;
1827  							case IDD_FINDINFILES_PROJECT2_CHECK:
1828  								findHistory._isFifProjectPanel_2 = _options._isProjectPanel_2 = isCheckedOrNot(IDD_FINDINFILES_PROJECT2_CHECK);
1829  								break;
1830  							case IDD_FINDINFILES_PROJECT3_CHECK:
1831  								findHistory._isFifProjectPanel_3 = _options._isProjectPanel_3 = isCheckedOrNot(IDD_FINDINFILES_PROJECT3_CHECK);
1832  								break;
1833  						}
1834  						bool enable = _options._isProjectPanel_1 || _options._isProjectPanel_2 || _options._isProjectPanel_3;
1835  						enableFindDlgItem(IDD_FINDINFILES_FIND_BUTTON, enable);
1836  						enableFindDlgItem(IDD_FINDINFILES_REPLACEINPROJECTS, enable);
1837  					}
1838  				}
1839  				return TRUE;
1840  				case IDD_FINDINFILES_FOLDERFOLLOWSDOC_CHECK :
1841  				{
1842  					if (_currentStatus == FINDINFILES_DLG)
1843  						findHistory._isFolderFollowDoc = isCheckedOrNot(IDD_FINDINFILES_FOLDERFOLLOWSDOC_CHECK);
1844  					if (findHistory._isFolderFollowDoc)
1845  					{
1846  						generic_string currPath;
1847  						const Buffer* buf = (*_ppEditView)->getCurrentBuffer();
1848  						if (!(buf->getStatus() & (DOC_UNNAMED | DOC_DELETED)))
1849  						{
1850  							currPath = buf->getFullPathName();
1851  							PathRemoveFileSpec(currPath);
1852  						}
1853  						if (currPath.empty() || !PathIsDirectory(currPath.c_str()))
1854  							currPath = NppParameters::getInstance().getWorkingDir();
1855  						::SetDlgItemText(_hSelf, IDD_FINDINFILES_DIR_COMBO, currPath.c_str());
1856  					}
1857  				}
1858  				return TRUE;
1859  				case IDD_FINDINFILES_BROWSE_BUTTON :
1860  				{
1861  					if (_currentStatus == FINDINFILES_DLG)
1862  					{
1863  						NativeLangSpeaker* pNativeSpeaker = NppParameters::getInstance().getNativeLangSpeaker();
1864  						const generic_string title = pNativeSpeaker->getLocalizedStrFromID("find-in-files-select-folder", TEXT("Select a folder to search from"));
1865  						folderBrowser(_hSelf, title, IDD_FINDINFILES_DIR_COMBO, _options._directory.c_str());
1866  					}
1867  				}
1868  				return TRUE;
1869  				case IDD_RESIZE_TOGGLE_BUTTON:
1870  				{
1871  					RECT rc = { 0, 0, 0, 0};
1872  					getWindowRect(rc);
1873  					int w = rc.right - rc.left;
1874  					POINT p{};
1875  					p.x = rc.left;
1876  					p.y = rc.top;
1877  					bool& isLessModeOn = NppParameters::getInstance().getNppGUI()._findWindowLessMode;
1878  					isLessModeOn = !isLessModeOn;
1879  					long dlgH = isLessModeOn ? _lesssModeHeight : _initialWindowRect.bottom;
1880  					RECT& buttonRc = isLessModeOn ? _uncollapseButtonPos : _collapseButtonPos;
1881  					if (w == _initialWindowRect.right)
1882  						w += 1;
1883  					::MoveWindow(_hSelf, p.x, p.y, w, dlgH, FALSE); 
1884  					::MoveWindow(::GetDlgItem(_hSelf, IDD_RESIZE_TOGGLE_BUTTON), buttonRc.left + _deltaWidth, buttonRc.top, buttonRc.right, buttonRc.bottom, TRUE);
1885  					const UINT flags = SWP_NOMOVE | SWP_NOZORDER | SWP_NOOWNERZORDER | SWP_NOCOPYBITS | SWP_DRAWFRAME;
1886  					::GetClientRect(_statusBar.getHSelf(), &rc);
1887  					::SetWindowPos(_statusBar.getHSelf(), 0, 0, 0, rc.right + _deltaWidth, rc.bottom, flags);
1888  					DIALOG_TYPE dlgT = getCurrentStatus();
1889  					hideOrShowCtrl4reduceOrNormalMode(dlgT);
1890  					::SetDlgItemText(_hSelf, IDD_RESIZE_TOGGLE_BUTTON, isLessModeOn ? L"" : L"");
1891  					redraw();
1892  				}
1893  				return TRUE;
1894  				default :
1895  					break;
1896  			}
1897  			break;
1898  		}
1899  	}
1900  	return FALSE;
1901  }
1902  bool FindReplaceDlg::processFindNext(const TCHAR *txt2find, const FindOption *options, FindStatus *oFindStatus, FindNextType findNextType &bsol;* = FINDNEXTTYPE_FINDNEXT */)
1903  {
1904  	if (oFindStatus)
1905  		*oFindStatus = FSFound;
1906  	if (!txt2find || !txt2find[0])
1907  		return false;
1908  	const FindOption *pOptions = options?options:_env;
1909  	(*_ppEditView)->execute(SCI_CALLTIPCANCEL);
1910  	int stringSizeFind = lstrlen(txt2find);
1911  	TCHAR *pText = new TCHAR[stringSizeFind + 1];
1912  	wcscpy_s(pText, stringSizeFind + 1, txt2find);
1913  	if (pOptions->_searchType == FindExtended)
1914  	{
1915  		stringSizeFind = Searching::convertExtendedToString(txt2find, pText, stringSizeFind);
1916  	}
1917  	intptr_t docLength = (*_ppEditView)->execute(SCI_GETLENGTH);
1918  	Sci_CharacterRangeFull cr = (*_ppEditView)->getSelection();
1919  	intptr_t startPosition = cr.cpMax;
1920  	intptr_t endPosition = docLength;
1921  	if (pOptions->_whichDirection == DIR_UP)
1922  	{
1923  		startPosition = cr.cpMax - 1;
1924  		endPosition = 0;
1925  	}
1926  	if (FirstIncremental==pOptions->_incrementalType)
1927  	{
1928  		startPosition = cr.cpMin;
1929  		endPosition = docLength;
1930  		if (pOptions->_whichDirection == DIR_UP)
1931  		{
1932  			startPosition = cr.cpMax;
1933  			endPosition = 0;
1934  		}
1935  	}
1936  	else if (NextIncremental==pOptions->_incrementalType)
1937  	{
1938  		startPosition = cr.cpMin + 1;
1939  		endPosition = docLength;
1940  		if (pOptions->_whichDirection == DIR_UP)
1941  		{
1942  			startPosition = cr.cpMax - 1;
1943  			endPosition = 0;
1944  		}
1945  	}
1946  	int flags = Searching::buildSearchFlags(pOptions);
1947  	switch (findNextType)
1948  	{
1949  		case FINDNEXTTYPE_FINDNEXT:
1950  			flags |= SCFIND_REGEXP_EMPTYMATCH_ALL | SCFIND_REGEXP_SKIPCRLFASONE;
1951  		break;
1952  		case FINDNEXTTYPE_REPLACENEXT:
1953  			flags |= SCFIND_REGEXP_EMPTYMATCH_NOTAFTERMATCH | SCFIND_REGEXP_SKIPCRLFASONE;
1954  			break;
1955  		case FINDNEXTTYPE_FINDNEXTFORREPLACE:
1956  			flags |= SCFIND_REGEXP_EMPTYMATCH_ALL | SCFIND_REGEXP_EMPTYMATCH_ALLOWATSTART | SCFIND_REGEXP_SKIPCRLFASONE;
1957  			break;
1958  	}
1959  	intptr_t start, end;
1960  	intptr_t posFind;
1961  	if ((*_ppEditView)->execute(SCI_GETCHARAT, startPosition - 1) == '\r'
1962  		&& (*_ppEditView)->execute(SCI_GETCHARAT, startPosition) == '\n')
1963  	{
1964  		flags = (flags & ~SCFIND_REGEXP_EMPTYMATCH_MASK) | SCFIND_REGEXP_EMPTYMATCH_NONE;
1965  	}
1966  	(*_ppEditView)->execute(SCI_SETSEARCHFLAGS, flags);
1967  	posFind = (*_ppEditView)->searchInTarget(pText, stringSizeFind, startPosition, endPosition);
1968  	if (posFind == -1) 
1969  	{
1970  		if (pOptions->_isWrapAround)
1971  		{
1972  			if (pOptions->_whichDirection == DIR_DOWN)
1973  			{
1974  				startPosition = 0;
1975  				endPosition = docLength;
1976  				if (oFindStatus)
1977  					*oFindStatus = FSEndReached;
1978  			}
1979  			else
1980  			{
1981  				startPosition = docLength;
1982  				endPosition = 0;
1983  				if (oFindStatus)
1984  					*oFindStatus = FSTopReached;
1985  			}
1986  			posFind = (*_ppEditView)->searchInTarget(pText, stringSizeFind, startPosition, endPosition);
1987  		}
1988  		if (posFind == -1)
1989  		{ 
1990  			if (oFindStatus)
1991  				*oFindStatus = FSNotFound;
1992  			if (NotIncremental == pOptions->_incrementalType) 
1993  			{
1994  				generic_string newTxt2find = stringReplace(txt2find, TEXT("&"), TEXT("&&"));
1995  				NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
1996  				generic_string msg = pNativeSpeaker->getLocalizedStrFromID("find-status-cannot-find", TEXT("Find: Can't find the text \"$STR_REPLACE$\""));
1997  				msg = stringReplace(msg, TEXT("$STR_REPLACE$"), newTxt2find);
1998  				setStatusbarMessage(msg, FSNotFound);
1999  				if (!::IsWindowVisible(_hSelf))
2000  				{
2001  					(*_ppEditView)->getFocus();
2002  				}
2003  				else
2004  				{
2005  					::SetFocus(::GetDlgItem(_hSelf, IDFINDWHAT));
2006  				}
2007  			}
2008  			delete [] pText;
2009  			return false;
2010  		}
2011  	}
2012  	else if (posFind < -1)
2013  	{ 
2014  		NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
2015  		generic_string  msgGeneral;
2016  		if (posFind == -2)
2017  		{
2018  			 msgGeneral = pNativeSpeaker->getLocalizedStrFromID("find-status-invalid-re", TEXT("Find: Invalid regular expression"));
2019  		}
2020  		else
2021  		{
2022  			msgGeneral = pNativeSpeaker->getLocalizedStrFromID("find-status-search-failed", TEXT("Find: Search failed"));
2023  		}
2024  		char szMsg [511] = "";
2025  		(*_ppEditView)->execute (SCI_GETBOOSTREGEXERRMSG, _countof (szMsg), reinterpret_cast<LPARAM>(szMsg));
2026  		setStatusbarMessage(msgGeneral, FSNotFound, szMsg);
2027  		return false;
2028  	}
2029  	start =	posFind;
2030  	end = (*_ppEditView)->execute(SCI_GETTARGETEND);
2031  	setStatusbarMessage(TEXT(""), FSNoMessage);
2032  	(*_ppEditView)->execute(SCI_STOPRECORD);
2033  	Searching::displaySectionCentered(start, end, *_ppEditView, pOptions->_whichDirection == DIR_DOWN);
2034  	if (start == end)
2035  	{
2036  		NativeLangSpeaker* pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
2037  		generic_string msg = pNativeSpeaker->getLocalizedStrFromID("find-regex-zero-length-match", TEXT("zero length match"));
2038  		msg = TEXT("^ ") + msg;
2039  		(*_ppEditView)->showCallTip(start, msg.c_str());
2040  	}
2041  	if (static_cast<MacroStatus>(::SendMessage(_hParent, NPPM_GETCURRENTMACROSTATUS,0,0)) == MacroStatus::RecordInProgress)
2042  		(*_ppEditView)->execute(SCI_STARTRECORD);
2043  	delete [] pText;
2044  	return true;
2045  }
2046  bool FindReplaceDlg::processReplace(const TCHAR *txt2find, const TCHAR *txt2replace, const FindOption *options)
2047  {
2048  	bool moreMatches;
2049  	if (!txt2find || !txt2find[0] || !txt2replace)
2050  		return false;
2051  	if ((*_ppEditView)->getCurrentBuffer()->isReadOnly())
2052  	{
2053  		NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
2054  		generic_string msg = pNativeSpeaker->getLocalizedStrFromID("find-status-replace-readonly", TEXT("Replace: Cannot replace text. The current document is read only."));
2055  		setStatusbarMessage(msg, FSNotFound);
2056  		return false;
2057  	}
2058  	FindOption replaceOptions = options ? *options : *_env;
2059  	replaceOptions._incrementalType = FirstIncremental;
2060  	Sci_CharacterRangeFull currentSelection = (*_ppEditView)->getSelection();
2061  	FindStatus status;
2062  	moreMatches = processFindNext(txt2find, &replaceOptions, &status, FINDNEXTTYPE_FINDNEXTFORREPLACE);
2063  	if (moreMatches)
2064  	{
2065  		Sci_CharacterRangeFull nextFind = (*_ppEditView)->getSelection();
2066  		if (nextFind.cpMin == currentSelection.cpMin && nextFind.cpMax == currentSelection.cpMax)
2067  		{
2068  			bool isRegExp = replaceOptions._searchType == FindRegex;
2069  			intptr_t start = currentSelection.cpMin;
2070  			intptr_t replacedLen = 0;
2071  			if (isRegExp)
2072  			{
2073  				replacedLen = (*_ppEditView)->replaceTargetRegExMode(txt2replace);
2074  			}
2075  			else
2076  			{
2077  				if (replaceOptions._searchType == FindExtended)
2078  				{
2079  					int stringSizeReplace = lstrlen(txt2replace);
2080  					TCHAR *pText2ReplaceExtended = new TCHAR[stringSizeReplace + 1];
2081  					Searching::convertExtendedToString(txt2replace, pText2ReplaceExtended, stringSizeReplace);
2082  					replacedLen = (*_ppEditView)->replaceTarget(pText2ReplaceExtended);
2083  					delete[] pText2ReplaceExtended;
2084  				}
2085  				else
2086  				{
2087  					replacedLen = (*_ppEditView)->replaceTarget(txt2replace);
2088  				}
2089  			}
2090  			(*_ppEditView)->execute(SCI_SETSEL, start + replacedLen, start + replacedLen);
2091  			NativeLangSpeaker* pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
2092  			NppParameters& nppParam = NppParameters::getInstance();
2093  			const NppGUI& nppGui = nppParam.getNppGUI();
2094  			if (nppGui._replaceStopsWithoutFindingNext)
2095  			{
2096  				generic_string msg = pNativeSpeaker->getLocalizedStrFromID("find-status-replaced-without-continuing", TEXT("Replace: 1 occurrence was replaced."));
2097  				setStatusbarMessage(msg, FSMessage);
2098  			}
2099  			else
2100  			{
2101  				moreMatches = processFindNext(txt2find, &replaceOptions, &status, FINDNEXTTYPE_REPLACENEXT);
2102  				if (status == FSEndReached)
2103  				{
2104  					generic_string msg = pNativeSpeaker->getLocalizedStrFromID("find-status-replace-end-reached", TEXT("Replace: Replaced the 1st occurrence from the top. The end of document has been reached."));
2105  					setStatusbarMessage(msg, FSEndReached);
2106  				}
2107  				else if (status == FSTopReached)
2108  				{
2109  					generic_string msg = pNativeSpeaker->getLocalizedStrFromID("find-status-replace-top-reached", TEXT("Replace: Replaced the 1st occurrence from the bottom. The begin of document has been reached."));
2110  					setStatusbarMessage(msg, FSTopReached);
2111  				}
2112  				else
2113  				{
2114  					generic_string msg;
2115  					if (moreMatches)
2116  						msg = pNativeSpeaker->getLocalizedStrFromID("find-status-replaced-next-found", TEXT("Replace: 1 occurrence was replaced. The next occurrence found."));
2117  					else
2118  						msg = pNativeSpeaker->getLocalizedStrFromID("find-status-replaced-next-not-found", TEXT("Replace: 1 occurrence was replaced. No more occurrences were found."));
2119  					setStatusbarMessage(msg, FSMessage);
2120  				}
2121  			}
2122  		}
2123  	}
2124  	else
2125  	{
2126  		NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
2127  		generic_string msg = pNativeSpeaker->getLocalizedStrFromID("find-status-replace-not-found", TEXT("Replace: no occurrence was found."));
2128  		setStatusbarMessage(msg, FSNotFound);
2129  	}
2130  	return moreMatches;
2131  }
2132  int FindReplaceDlg::markAll(const TCHAR *txt2find, int styleID)
2133  {
2134  	const NppGUI& nppGUI = NppParameters::getInstance().getNppGUI();
2135  	FindOption markAllOpt;
2136  	markAllOpt._isMatchCase = nppGUI._markAllCaseSensitive;
2137  	markAllOpt._isWholeWord = nppGUI._markAllWordOnly;
2138  	markAllOpt._str2Search = txt2find;
2139  	int nbFound = processAll(ProcessMarkAllExt, &markAllOpt, true, NULL, styleID);
2140  	return nbFound;
2141  }
2142  int FindReplaceDlg::markAllInc(const FindOption *opt)
2143  {
2144  	int nbFound = processAll(ProcessMarkAll_IncSearch, opt,  true);
2145  	return nbFound;
2146  }
2147  int FindReplaceDlg::processAll(ProcessOperation op, const FindOption *opt, bool isEntire, const FindersInfo *pFindersInfo, int colourStyleID)
2148  {
2149  	if (op == ProcessReplaceAll && (*_ppEditView)->getCurrentBuffer()->isReadOnly())
2150  	{
2151  		NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
2152  		generic_string msg = pNativeSpeaker->getLocalizedStrFromID("find-status-replaceall-readonly", TEXT("Replace All: Cannot replace text. The current document is read only."));
2153  		setStatusbarMessage(msg, FSNotFound);
2154  		return 0;
2155  	}
2156  	const FindOption *pOptions = opt?opt:_env;
2157  	const TCHAR *txt2find = pOptions->_str2Search.c_str();
2158  	const TCHAR *txt2replace = pOptions->_str4Replace.c_str();
2159  	Sci_CharacterRangeFull cr = (*_ppEditView)->getSelection();
2160  	size_t docLength = (*_ppEditView)->execute(SCI_GETLENGTH);
2161  	size_t startPosition = 0;
2162  	size_t endPosition = docLength;
2163  	bool direction = pOptions->_whichDirection;
2164  	if (direction == DIR_UP)
2165  	{
2166  		startPosition = 0;
2167  		endPosition = cr.cpMax;
2168  	}
2169  	else
2170  	{
2171  		startPosition = cr.cpMin;
2172  		endPosition = docLength;
2173  	}
2174  	if (op == ProcessCountAll && pOptions->_isInSelection)
2175  	{
2176  		startPosition = cr.cpMin;
2177  		endPosition = cr.cpMax;
2178  	}
2179  	else if (pOptions->_isWrapAround || isEntire)	
2180  	{
2181  		startPosition = 0;
2182  		endPosition = docLength;
2183  	}
2184  	if ((pOptions->_isInSelection) && ((op == ProcessMarkAll) || ((op == ProcessReplaceAll || op == ProcessFindAll) && (!isEntire))))
2185  	{
2186  		startPosition = cr.cpMin;
2187  		endPosition = cr.cpMax;
2188  	}
2189  	if ((op == ProcessMarkAllExt) && (colourStyleID != -1))
2190  	{
2191  		startPosition = 0;
2192  		endPosition = docLength;
2193  	}
2194  	FindReplaceInfo findReplaceInfo;
2195  	findReplaceInfo._txt2find = txt2find;
2196  	findReplaceInfo._txt2replace = txt2replace;
2197  	findReplaceInfo._startRange = startPosition;
2198  	findReplaceInfo._endRange = endPosition;
2199  	int nbProcessed = processRange(op, findReplaceInfo, pFindersInfo, pOptions, colourStyleID);
2200  	if (nbProcessed > 0 && op == ProcessReplaceAll && pOptions->_isInSelection)
2201  	{
2202  		size_t newDocLength = (*_ppEditView)->execute(SCI_GETLENGTH);
2203  		endPosition += newDocLength - docLength;
2204  		(*_ppEditView)->execute(SCI_SETSELECTION, endPosition, startPosition);
2205  		(*_ppEditView)->execute(SCI_SCROLLRANGE, startPosition, endPosition);
2206  		if (startPosition == endPosition)
2207  		{
2208  			setChecked(IDC_IN_SELECTION_CHECK, false);
2209  			enableFindDlgItem(IDC_IN_SELECTION_CHECK, false);
2210  		}
2211  	}
2212  	return nbProcessed;
2213  }
2214  int FindReplaceDlg::processRange(ProcessOperation op, FindReplaceInfo & findReplaceInfo, const FindersInfo * pFindersInfo, const FindOption *opt, int colourStyleID, ScintillaEditView *view2Process)
2215  {
2216  	int nbProcessed = 0;
2217  	if (!isCreated() && !findReplaceInfo._txt2find)
2218  		return 0;
2219  	if (!_ppEditView)
2220  		return 0;
2221  	ScintillaEditView *pEditView = *_ppEditView;
2222  	if (view2Process)
2223  		pEditView = view2Process;
2224  	if ((op == ProcessReplaceAll) && pEditView->getCurrentBuffer()->isReadOnly())
2225  		return nbProcessed;
2226  	if (findReplaceInfo._startRange == findReplaceInfo._endRange)
2227  		return nbProcessed;
2228  	const FindOption *pOptions = opt ? opt : _env;
2229  	LRESULT stringSizeFind = 0;
2230  	LRESULT stringSizeReplace = 0;
2231  	TCHAR *pTextFind = NULL;
2232  	if (!findReplaceInfo._txt2find)
2233  	{
2234  		HWND hFindCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
2235  		generic_string str2Search = getTextFromCombo(hFindCombo);
2236  		stringSizeFind = str2Search.length();
2237  		pTextFind = new TCHAR[stringSizeFind + 1];
2238  		wcscpy_s(pTextFind, stringSizeFind + 1, str2Search.c_str());
2239  	}
2240  	else
2241  	{
2242  		stringSizeFind = lstrlen(findReplaceInfo._txt2find);
2243  		pTextFind = new TCHAR[stringSizeFind + 1];
2244  		wcscpy_s(pTextFind, stringSizeFind + 1, findReplaceInfo._txt2find);
2245  	}
2246  	if (!pTextFind[0])
2247  	{
2248  		delete [] pTextFind;
2249  		return nbProcessed;
2250  	}
2251  	TCHAR *pTextReplace = NULL;
2252  	if (op == ProcessReplaceAll)
2253  	{
2254  		if (!findReplaceInfo._txt2replace)
2255  		{
2256  			HWND hReplaceCombo = ::GetDlgItem(_hSelf, IDREPLACEWITH);
2257  			generic_string str2Replace = getTextFromCombo(hReplaceCombo);
2258  			stringSizeReplace = str2Replace.length();
2259  			pTextReplace = new TCHAR[stringSizeReplace + 1];
2260  			wcscpy_s(pTextReplace, stringSizeReplace + 1, str2Replace.c_str());
2261  		}
2262  		else
2263  		{
2264  			stringSizeReplace = lstrlen(findReplaceInfo._txt2replace);
2265  			pTextReplace = new TCHAR[stringSizeReplace + 1];
2266  			wcscpy_s(pTextReplace, stringSizeReplace + 1, findReplaceInfo._txt2replace);
2267  		}
2268  	}
2269  	if (pOptions->_searchType == FindExtended)
2270  	{
2271  		stringSizeFind = Searching::convertExtendedToString(pTextFind, pTextFind, static_cast<int32_t>(stringSizeFind));
2272  		if (op == ProcessReplaceAll)
2273  			stringSizeReplace = Searching::convertExtendedToString(pTextReplace, pTextReplace, static_cast<int32_t>(stringSizeReplace));
2274  	}
2275  	bool isRegExp = pOptions->_searchType == FindRegex;
2276  	int flags = Searching::buildSearchFlags(pOptions) | SCFIND_REGEXP_SKIPCRLFASONE;
2277  	if (op == ProcessReplaceAll || op == ProcessFindAll)
2278  		flags |= SCFIND_REGEXP_EMPTYMATCH_NOTAFTERMATCH;
2279  	if (op == ProcessMarkAll && colourStyleID == -1)	
2280  	{
2281  		if (_env->_doPurge)
2282  		{
2283  			clearMarks(*_env);
2284  		}
2285  	}
2286  	intptr_t targetStart = 0;
2287  	intptr_t targetEnd = 0;
2288  	pEditView->execute(SCI_SETSEARCHFLAGS, flags);
2289  	bool findAllFileNameAdded = false;
2290  	std::unique_ptr<std::string> text2AddUtf8(new std::string());
2291  	size_t indexBuffer = 0;
2292  	while (targetStart >= 0)
2293  	{
2294  		targetStart = pEditView->searchInTarget(pTextFind, stringSizeFind, findReplaceInfo._startRange, findReplaceInfo._endRange);
2295  		if (targetStart == -1 || targetStart == -2)
2296  			break;
2297  		targetEnd = pEditView->execute(SCI_GETTARGETEND);
2298  		if (targetEnd > findReplaceInfo._endRange)
2299  		{
2300  			break;
2301  		}
2302  		intptr_t foundTextLen = targetEnd - targetStart;
2303  		intptr_t replaceDelta = 0;
2304  		bool processed = true;
2305  		switch (op)
2306  		{
2307  			case ProcessFindAll:
2308  			{
2309  				const TCHAR *pFileName = TEXT("");
2310  				if (pFindersInfo && pFindersInfo->_pFileName)
2311  					pFileName = pFindersInfo->_pFileName;
2312  				if (!findAllFileNameAdded)	
2313  				{
2314  					_pFinder->addFileNameTitle(pFileName);
2315  					findAllFileNameAdded = true;
2316  				}
2317  				auto totalLineNumber = pEditView->execute(SCI_GETLINECOUNT);
2318  				auto lineNumber = pEditView->execute(SCI_LINEFROMPOSITION, targetStart);
2319  				intptr_t lend = pEditView->execute(SCI_GETLINEENDPOSITION, lineNumber);
2320  				intptr_t lstart = pEditView->execute(SCI_POSITIONFROMLINE, lineNumber);
2321  				intptr_t nbChar = lend - lstart;
2322  				TCHAR lineBuf[SC_SEARCHRESULT_LINEBUFFERMAXLENGTH]{};
2323  				if (nbChar > SC_SEARCHRESULT_LINEBUFFERMAXLENGTH - 3)
2324  					lend = lstart + SC_SEARCHRESULT_LINEBUFFERMAXLENGTH - 4;
2325  				intptr_t start_mark = targetStart - lstart;
2326  				intptr_t end_mark = targetEnd - lstart;
2327  				pEditView->getGenericText(lineBuf, SC_SEARCHRESULT_LINEBUFFERMAXLENGTH, lstart, lend, &start_mark, &end_mark);
2328  				generic_string line = lineBuf;
2329  				line += TEXT("\r\n");
2330  				SearchResultMarkingLine srml;
2331  				srml._segmentPostions.push_back(std::pair<intptr_t, intptr_t>(start_mark, end_mark));
2332  				text2AddUtf8->append(_pFinder->foundLine(FoundInfo(targetStart, targetEnd, lineNumber + 1, pFileName), srml, line.c_str(), totalLineNumber));
2333  				if (text2AddUtf8->length() > FINDTEMPSTRING_MAXSIZE)
2334  				{
2335  					_pFinder->setFinderReadOnly(false);
2336  					_pFinder->_scintView.execute(SCI_ADDTEXT, text2AddUtf8->length(), reinterpret_cast<LPARAM>(text2AddUtf8->c_str()));
2337  					_pFinder->setFinderReadOnly(true);
2338  					text2AddUtf8->clear();
2339  				}
2340  				break;
2341  			}
2342  			case ProcessFindInFinder:
2343  			{
2344  				if (!pFindersInfo || !pFindersInfo->_pSourceFinder || !pFindersInfo->_pDestFinder)
2345  					break;
2346  				const TCHAR *pFileName = pFindersInfo->_pFileName ? pFindersInfo->_pFileName : TEXT("");
2347  				auto totalLineNumber = pEditView->execute(SCI_GETLINECOUNT);
2348  				auto lineNumber = pEditView->execute(SCI_LINEFROMPOSITION, targetStart);
2349  				intptr_t lend = pEditView->execute(SCI_GETLINEENDPOSITION, lineNumber);
2350  				intptr_t lstart = pEditView->execute(SCI_POSITIONFROMLINE, lineNumber);
2351  				intptr_t nbChar = lend - lstart;
2352  				TCHAR lineBuf[SC_SEARCHRESULT_LINEBUFFERMAXLENGTH]{};
2353  				if (nbChar > SC_SEARCHRESULT_LINEBUFFERMAXLENGTH - 3)
2354  					lend = lstart + SC_SEARCHRESULT_LINEBUFFERMAXLENGTH - 4;
2355  				intptr_t start_mark = targetStart - lstart;
2356  				intptr_t end_mark = targetEnd - lstart;
2357  				pEditView->getGenericText(lineBuf, SC_SEARCHRESULT_LINEBUFFERMAXLENGTH, lstart, lend, &start_mark, &end_mark);
2358  				generic_string line = lineBuf;
2359  				line += TEXT("\r\n");
2360  				SearchResultMarkingLine srml;
2361  				srml._segmentPostions.push_back(std::pair<intptr_t, intptr_t>(start_mark, end_mark));
2362  				processed = (!pOptions->_isMatchLineNumber) || (pFindersInfo->_pSourceFinder->canFind(pFileName, lineNumber + 1, &indexBuffer));
2363  				if (processed)
2364  				{
2365  					if (!findAllFileNameAdded)	
2366  					{
2367  						pFindersInfo->_pDestFinder->addFileNameTitle(pFileName);
2368  						findAllFileNameAdded = true;
2369  					}
2370  					text2AddUtf8->append(pFindersInfo->_pDestFinder->foundLine(FoundInfo(targetStart, targetEnd, lineNumber + 1, pFileName), srml, line.c_str(), totalLineNumber));
2371  					if (text2AddUtf8->length() > FINDTEMPSTRING_MAXSIZE)
2372  					{
2373  						pFindersInfo->_pDestFinder->setFinderReadOnly(false);
2374  						pFindersInfo->_pDestFinder->_scintView.execute(SCI_ADDTEXT, text2AddUtf8->length(), reinterpret_cast<LPARAM>(text2AddUtf8->c_str()));
2375  						pFindersInfo->_pDestFinder->setFinderReadOnly(true);
2376  						text2AddUtf8->clear();
2377  					}
2378  				}
2379  				break;
2380  			}
2381  			case ProcessReplaceAll:
2382  			{
2383  				intptr_t replacedLength;
2384  				if (isRegExp)
2385  					replacedLength = pEditView->replaceTargetRegExMode(pTextReplace);
2386  				else
2387  					replacedLength = pEditView->replaceTarget(pTextReplace);
2388  				replaceDelta = replacedLength - foundTextLen;
2389  				break;
2390  			}
2391  			case ProcessMarkAll:
2392  			{
2393  				if (foundTextLen > 0)
2394  				{
2395  					pEditView->execute(SCI_SETINDICATORCURRENT, SCE_UNIVERSAL_FOUND_STYLE);
2396  					pEditView->execute(SCI_INDICATORFILLRANGE,  targetStart, foundTextLen);
2397  				}
2398  				if (_env->_doMarkLine)
2399  				{
2400  					auto lineNumber = pEditView->execute(SCI_LINEFROMPOSITION, targetStart);
2401  					auto lineNumberEnd = pEditView->execute(SCI_LINEFROMPOSITION, targetEnd - 1);
2402  					for (auto i = lineNumber; i <= lineNumberEnd; ++i)
2403  					{
2404  						auto state = pEditView->execute(SCI_MARKERGET, i);
2405  						if (!(state & (1 << MARK_BOOKMARK)))
2406  							pEditView->execute(SCI_MARKERADD, i, MARK_BOOKMARK);
2407  					}
2408  				}
2409  				break;
2410  			}
2411  			case ProcessMarkAllExt:
2412  			{
2413  				if (foundTextLen > 0)
2414  				{
2415  					pEditView->execute(SCI_SETINDICATORCURRENT,  colourStyleID);
2416  					pEditView->execute(SCI_INDICATORFILLRANGE,  targetStart, foundTextLen);
2417  				}
2418  				break;
2419  			}
2420  			case ProcessMarkAll_2:
2421  			{
2422  				if (foundTextLen > 0)
2423  				{
2424  					pEditView->execute(SCI_SETINDICATORCURRENT,  SCE_UNIVERSAL_FOUND_STYLE_SMART);
2425  					pEditView->execute(SCI_INDICATORFILLRANGE,  targetStart, foundTextLen);
2426  				}
2427  				break;
2428  			}
2429  			case ProcessMarkAll_IncSearch:
2430  			{
2431  				if (foundTextLen > 0)
2432  				{
2433  					pEditView->execute(SCI_SETINDICATORCURRENT,  SCE_UNIVERSAL_FOUND_STYLE_INC);
2434  					pEditView->execute(SCI_INDICATORFILLRANGE,  targetStart, foundTextLen);
2435  				}
2436  				break;
2437  			}
2438  			case ProcessCountAll:
2439  			{
2440  				break;
2441  			}
2442  			default:
2443  			{
2444  				delete [] pTextFind;
2445  				delete [] pTextReplace;
2446  				return nbProcessed;
2447  			}
2448  		}
2449  		if (processed) ++nbProcessed;
2450  		if (targetStart + foundTextLen == findReplaceInfo._endRange)
2451  			break;
2452  		findReplaceInfo._startRange = targetStart + foundTextLen + replaceDelta;		
2453  		findReplaceInfo._endRange += replaceDelta;									
2454  	}
2455  	delete [] pTextFind;
2456  	delete [] pTextReplace;
2457  	if (nbProcessed > 0)
2458  	{
2459  		Finder *pFinder = nullptr;
2460  		if (op == ProcessFindAll)
2461  		{
2462  			_pFinder->setFinderReadOnly(false);
2463  			_pFinder->_scintView.execute(SCI_ADDTEXT, text2AddUtf8->length(), reinterpret_cast<LPARAM>(text2AddUtf8->c_str()));
2464  			_pFinder->setFinderReadOnly(true);
2465  			text2AddUtf8->clear();
2466  			pFinder = _pFinder;
2467  		}
2468  		else if (op == ProcessFindInFinder)
2469  		{
2470  			if (pFindersInfo && pFindersInfo->_pDestFinder)
2471  			{
2472  				pFindersInfo->_pDestFinder->setFinderReadOnly(false);
2473  				pFindersInfo->_pDestFinder->_scintView.execute(SCI_ADDTEXT, text2AddUtf8->length(), reinterpret_cast<LPARAM>(text2AddUtf8->c_str()));
2474  				pFindersInfo->_pDestFinder->setFinderReadOnly(true);
2475  				text2AddUtf8->clear();
2476  				pFinder = pFindersInfo->_pDestFinder;
2477  			}
2478  			else
2479  				pFinder = _pFinder;
2480  		}
2481  		if (pFinder != nullptr)
2482  			pFinder->addFileHitCount(nbProcessed);
2483  	}
2484  	return nbProcessed;
2485  }
2486  void FindReplaceDlg::replaceAllInOpenedDocs()
2487  {
2488  	::SendMessage(_hParent, WM_REPLACEALL_INOPENEDDOC, 0, 0);
2489  }
2490  void FindReplaceDlg::findAllIn(InWhat op)
2491  {
2492  	bool justCreated = false;
2493  	if (!_pFinder)
2494  	{
2495  		_pFinder = new Finder();
2496  		_pFinder->init(_hInst, (*_ppEditView)->getHParent(), _ppEditView);
2497  		_pFinder->setVolatiled(false);
2498  		tTbData	data = {};
2499  		_pFinder->create(&data);
2500  		::SendMessage(_hParent, NPPM_MODELESSDIALOG, MODELESSDIALOGREMOVE, reinterpret_cast<LPARAM>(_pFinder->getHSelf()));
2501  		data.uMask = DWS_DF_CONT_BOTTOM | DWS_ICONTAB | DWS_ADDINFO | DWS_USEOWNDARKMODE;
2502  		data.hIconTab = (HICON)::LoadImage(_hInst, MAKEINTRESOURCE(IDI_FIND_RESULT_ICON), IMAGE_ICON, 0, 0, LR_LOADMAP3DCOLORS | LR_LOADTRANSPARENT);
2503  		data.pszAddInfo = _findAllResultStr;
2504  		data.pszModuleName = NPP_INTERNAL_FUCTION_STR;
2505  		data.dlgID = 0;
2506  		NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
2507  		generic_string text = pNativeSpeaker->getLocalizedStrFromID("find-result-caption", TEXT(""));
2508  		if (!text.empty())
2509  		{
2510  			_findResTitle = text;
2511  			data.pszName = _findResTitle.c_str();
2512  		}
2513  		::SendMessage(_hParent, NPPM_DMMREGASDCKDLG, 0, reinterpret_cast<LPARAM>(&data));
2514  		_pFinder->_scintView.init(_hInst, _pFinder->getHSelf());
2515  		originalFinderProc = reinterpret_cast<WNDPROC>(SetWindowLongPtr(_pFinder->_scintView.getHSelf(), GWLP_WNDPROC, reinterpret_cast<LONG_PTR>(finderProc)));
2516  		_pFinder->setFinderReadOnly(true);
2517  		_pFinder->_scintView.execute(SCI_SETCODEPAGE, SC_CP_UTF8);
2518  		_pFinder->_scintView.execute(SCI_USEPOPUP, FALSE);
2519  		_pFinder->_scintView.execute(SCI_SETUNDOCOLLECTION, false);	
2520  		_pFinder->_scintView.execute(SCI_SETCARETWIDTH, 1);
2521  		_pFinder->_scintView.showMargin(ScintillaEditView::_SC_MARGE_FOLDER, true);
2522  		_pFinder->_scintView.execute(SCI_SETUSETABS, true);
2523  		_pFinder->_scintView.execute(SCI_SETTABWIDTH, 4);
2524  		NppParameters& nppParam = NppParameters::getInstance();
2525  		NppGUI& nppGUI = nppParam.getNppGUI();
2526  		_pFinder->_longLinesAreWrapped = nppGUI._finderLinesAreCurrentlyWrapped;
2527  		_pFinder->_scintView.wrap(_pFinder->_longLinesAreWrapped);
2528  		_pFinder->_scintView.setWrapMode(LINEWRAP_INDENT);
2529  		_pFinder->_scintView.showWrapSymbol(true);
2530  		_pFinder->_purgeBeforeEverySearch = nppGUI._finderPurgeBeforeEverySearch;
2531  		_pFinder->_scintView.execute(SCI_SETMOUSESELECTIONRECTANGULARSWITCH, true);
2532  		RECT findRect;
2533  		::GetWindowRect(_pFinder->getHSelf(), &findRect);
2534  		_pFinder->_scintView.showMargin(ScintillaEditView::_SC_MARGE_SYMBOL, false);
2535  		_pFinder->_scintView.setMakerStyle(FOLDER_STYLE_SIMPLE);
2536  		NppDarkMode::setBorder(_pFinder->_scintView.getHSelf());
2537  		_pFinder->_scintView.display();
2538  		_pFinder->setFinderStyle();
2539  		_pFinder->setFinderStyleForNpc();
2540  		_pFinder->display(false);
2541  		::UpdateWindow(_hParent);
2542  		justCreated = true;
2543  	}
2544  	if (_pFinder->_purgeBeforeEverySearch)
2545  	{
2546  		_pFinder->removeAll();
2547  	}
2548  	if (justCreated)
2549  	{
2550  		char ptrword[sizeof(void*) * 2 + 1];
2551  		sprintf(ptrword, "%p", static_cast<void*>(&_pFinder->_markingsStruct));
2552  		_pFinder->_scintView.execute(SCI_SETPROPERTY, reinterpret_cast<WPARAM>("@MarkingsStruct"), reinterpret_cast<LPARAM>(ptrword));
2553  		::EnableMenuItem(::GetMenu(_hParent), IDM_FOCUS_ON_FOUND_RESULTS, MF_ENABLED | MF_BYCOMMAND);
2554  	}
2555  	::SendMessage(_pFinder->getHSelf(), WM_SIZE, 0, 0);
2556  	bool toRTL = (*_ppEditView)->isTextDirectionRTL();
2557  	bool isRTL = _pFinder->_scintView.isTextDirectionRTL();
2558  	if ((toRTL && !isRTL) || (!toRTL && isRTL))
2559  		_pFinder->_scintView.changeTextDirection(toRTL);
2560  	int cmdid = 0;
2561  	if (op == ALL_OPEN_DOCS)
2562  		cmdid = WM_FINDALL_INOPENEDDOC;
2563  	else if (op == FILES_IN_DIR)
2564  		cmdid = WM_FINDINFILES;
2565  	else if (op == FILES_IN_PROJECTS)
2566  		cmdid = WM_FINDINPROJECTS;
2567  	else if ((op == CURRENT_DOC) || (op == CURR_DOC_SELECTION))
2568  		cmdid = WM_FINDALL_INCURRENTDOC;
2569  	if (!cmdid) return;
2570  	bool limitSearchScopeToSelection = op == CURR_DOC_SELECTION;
2571  	if (::SendMessage(_hParent, cmdid, static_cast<WPARAM>(limitSearchScopeToSelection ? 1 : 0), 0))
2572  	{
2573  		generic_string text = _pFinder->getHitsString(_findAllResult);
2574  		wsprintf(_findAllResultStr, text.c_str());
2575  		if (_findAllResult)
2576  		{
2577  			focusOnFinder();
2578  		}
2579  		else
2580  		{
2581  			_pFinder->display();
2582  			getFocus(); 
2583  		}
2584  	}
2585  	else 
2586  		::SendMessage(_hSelf, WM_NEXTDLGCTL, reinterpret_cast<WPARAM>(::GetDlgItem(_hSelf, IDD_FINDINFILES_DIR_COMBO)), TRUE);
2587  }
2588  Finder * FindReplaceDlg::createFinder()
2589  {
2590  	Finder *pFinder = new Finder();
2591  	pFinder->init(_hInst, (*_ppEditView)->getHParent(), _ppEditView);
2592  	tTbData	data = {};
2593  	bool isRTL = _pFinder->_scintView.isTextDirectionRTL();
2594  	pFinder->create(&data, isRTL);
2595  	::SendMessage(_hParent, NPPM_MODELESSDIALOG, MODELESSDIALOGREMOVE, reinterpret_cast<WPARAM>(pFinder->getHSelf()));
2596  	data.uMask = DWS_DF_CONT_BOTTOM | DWS_ICONTAB | DWS_ADDINFO | DWS_USEOWNDARKMODE;
2597  	data.hIconTab = (HICON)::LoadImage(_hInst, MAKEINTRESOURCE(IDI_FIND_RESULT_ICON), IMAGE_ICON, 0, 0, LR_LOADMAP3DCOLORS | LR_LOADTRANSPARENT);
2598  	data.pszAddInfo = _findAllResultStr;
2599  	data.pszModuleName = NPP_INTERNAL_FUCTION_STR;
2600  	data.dlgID = 0;
2601  	NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
2602  	generic_string text = pNativeSpeaker->getLocalizedStrFromID("find-result-caption", TEXT(""));
2603  	if (!text.empty())
2604  	{
2605  		_findResTitle = text;
2606  		data.pszName = _findResTitle.c_str();
2607  	}
2608  	::SendMessage(_hParent, NPPM_DMMREGASDCKDLG, 0, reinterpret_cast<LPARAM>(&data));
2609  	pFinder->_scintView.init(_hInst, pFinder->getHSelf());
2610  	if (isRTL)
2611  		pFinder->_scintView.changeTextDirection(true);
2612  	originalFinderProc = reinterpret_cast<WNDPROC>(SetWindowLongPtr(pFinder->_scintView.getHSelf(), GWLP_WNDPROC, reinterpret_cast<LONG_PTR>(finderProc)));
2613  	pFinder->setFinderReadOnly(true);
2614  	pFinder->_scintView.execute(SCI_SETCODEPAGE, SC_CP_UTF8);
2615  	pFinder->_scintView.execute(SCI_USEPOPUP, FALSE);
2616  	pFinder->_scintView.execute(SCI_SETUNDOCOLLECTION, false);	
2617  	pFinder->_scintView.execute(SCI_SETCARETWIDTH, 1);
2618  	pFinder->_scintView.showMargin(ScintillaEditView::_SC_MARGE_FOLDER, true);
2619  	pFinder->_scintView.execute(SCI_SETUSETABS, true);
2620  	pFinder->_scintView.execute(SCI_SETTABWIDTH, 4);
2621  	pFinder->_longLinesAreWrapped = _pFinder->_longLinesAreWrapped;
2622  	pFinder->_scintView.wrap(pFinder->_longLinesAreWrapped);
2623  	pFinder->_scintView.setWrapMode(LINEWRAP_INDENT);
2624  	pFinder->_scintView.showWrapSymbol(true);
2625  	pFinder->_scintView.execute(SCI_SETMOUSESELECTIONRECTANGULARSWITCH, true);
2626  	RECT findRect;
2627  	::GetWindowRect(pFinder->getHSelf(), &findRect);
2628  	pFinder->_scintView.showMargin(ScintillaEditView::_SC_MARGE_SYMBOL, false);
2629  	pFinder->_scintView.setMakerStyle(FOLDER_STYLE_SIMPLE);
2630  	pFinder->_scintView.display();
2631  	::UpdateWindow(_hParent);
2632  	NppDarkMode::setBorder(pFinder->_scintView.getHSelf());
2633  	pFinder->setFinderStyle();
2634  	pFinder->setFinderStyleForNpc();
2635  	char ptrword[sizeof(void*) * 2 + 1];
2636  	sprintf(ptrword, "%p", static_cast<void*>(&pFinder->_markingsStruct));
2637  	pFinder->_scintView.execute(SCI_SETPROPERTY, reinterpret_cast<WPARAM>("@MarkingsStruct"), reinterpret_cast<LPARAM>(ptrword));
2638  	_findersOfFinder.push_back(pFinder);
2639  	::SendMessage(pFinder->getHSelf(), WM_SIZE, 0, 0);
2640  	pFinder->display();
2641  	pFinder->_scintView.getFocus();
2642  	return pFinder;
2643  }
2644  bool FindReplaceDlg::removeFinder(Finder *finder2remove)
2645  {
2646  	for (vector<Finder *>::iterator i = _findersOfFinder.begin(); i != _findersOfFinder.end(); ++i)
2647  	{
2648  		if (*i == finder2remove)
2649  		{
2650  			delete finder2remove;
2651  			_findersOfFinder.erase(i);
2652  			return true;
2653  		}
2654  	}
2655  	return false;
2656  }
2657  void FindReplaceDlg::setSearchText(TCHAR * txt2find)
2658  {
2659  	HWND hCombo = ::GetDlgItem(_hSelf, IDFINDWHAT);
2660  	if (txt2find && txt2find[0])
2661  	{
2662  		::SendMessage(hCombo, CB_SETCURSEL, static_cast<WPARAM>(-1), 0); 
2663  		::SetDlgItemText(_hSelf, IDFINDWHAT, txt2find);
2664  	}
2665  	::SendMessage(hCombo, CB_SETEDITSEL, 0, MAKELPARAM(0, -1)); 
2666  }
2667  void FindReplaceDlg::enableFindDlgItem(int dlgItemID, bool isEnable &bsol;* = true*/)
2668  {
2669  	HWND h = ::GetDlgItem(_hSelf, dlgItemID);
2670  	if (!h) return;
2671  	::EnableWindow(h, isEnable ? TRUE : FALSE);
2672  	_controlEnableMap[dlgItemID] = isEnable;
2673  }
2674  void FindReplaceDlg::showFindDlgItem(int dlgItemID, bool isShow &bsol;* = true*/)
2675  {
2676  	HWND h = ::GetDlgItem(_hSelf, dlgItemID);
2677  	if (!h) return;
2678  	::ShowWindow(h, isShow ? SW_SHOW : SW_HIDE);
2679  	if (dlgItemID == IDOK)
2680  	{
2681  		return;
2682  	}
2683  	int enable = isShow ? TRUE : FALSE;
2684  	if (isShow)
2685  	{
2686  		const auto iter = _controlEnableMap.find(dlgItemID);
2687  		if (iter == _controlEnableMap.end())
2688  		{
2689  			enable = TRUE;
2690  			_controlEnableMap[dlgItemID] = true;
2691  		}
2692  		else
2693  		{
2694  			enable = iter->second ? TRUE : FALSE;
2695  		}
2696  	}
2697  	::EnableWindow(h, enable);
2698  }
2699  void FindReplaceDlg::enableReplaceFunc(bool isEnable)
2700  {
2701  	_currentStatus = isEnable?REPLACE_DLG:FIND_DLG;
2702  	RECT *pClosePos = isEnable ? &_replaceClosePos : &_findClosePos;
2703  	RECT *pInSelectionFramePos = isEnable ? &_replaceInSelFramePos : &_countInSelFramePos;
2704  	RECT *pInSectionCheckPos = isEnable ? &_replaceInSelCheckPos : &_countInSelCheckPos;
2705  	enableFindInFilesControls(false, false);
2706  	enableMarkAllControls(false);
2707  	showFindDlgItem(ID_STATICTEXT_REPLACE, isEnable);
2708  	showFindDlgItem(IDREPLACE, isEnable);
2709  	showFindDlgItem(IDREPLACEWITH, isEnable);
2710  	showFindDlgItem(IDD_FINDREPLACE_SWAP_BUTTON, isEnable);
2711  	showFindDlgItem(IDREPLACEALL, isEnable);
2712  	showFindDlgItem(IDC_REPLACE_OPENEDFILES, isEnable);
2713  	showFindDlgItem(IDC_REPLACEINSELECTION);
2714  	showFindDlgItem(IDC_IN_SELECTION_CHECK);
2715  	showFindDlgItem(IDC_2_BUTTONS_MODE);
2716  	bool is2ButtonMode = isCheckedOrNot(IDC_2_BUTTONS_MODE);
2717  	showFindDlgItem(IDOK, !is2ButtonMode);
2718  	showFindDlgItem(IDC_FINDPREV, is2ButtonMode);
2719  	showFindDlgItem(IDC_FINDNEXT, is2ButtonMode);
2720  	showFindDlgItem(IDC_FINDALL_OPENEDFILES, !isEnable);
2721  	showFindDlgItem(IDCCOUNTALL, !isEnable);
2722  	showFindDlgItem(IDC_FINDALL_CURRENTFILE, !isEnable);
2723  	gotoCorrectTab();
2724  	::MoveWindow(::GetDlgItem(_hSelf, IDCANCEL), pClosePos->left + _deltaWidth, pClosePos->top, pClosePos->right, pClosePos->bottom, TRUE);
2725  	::MoveWindow(::GetDlgItem(_hSelf, IDC_IN_SELECTION_CHECK), pInSectionCheckPos->left + _deltaWidth, pInSectionCheckPos->top, pInSectionCheckPos->right, pInSectionCheckPos->bottom, TRUE);
2726  	::MoveWindow(::GetDlgItem(_hSelf, IDC_REPLACEINSELECTION), pInSelectionFramePos->left + _deltaWidth, pInSelectionFramePos->top, pInSelectionFramePos->right, pInSelectionFramePos->bottom, TRUE);
2727  	TCHAR label[MAX_PATH] = { '\0' };
2728  	_tab.getCurrentTitle(label, MAX_PATH);
2729  	::SetWindowText(_hSelf, label);
2730  	setDefaultButton(IDOK);
2731  	hideOrShowCtrl4reduceOrNormalMode(_currentStatus);
2732  }
2733  void FindReplaceDlg::enableMarkAllControls(bool isEnable)
2734  {
2735  	showFindDlgItem(IDCMARKALL, isEnable);
2736  	showFindDlgItem(IDC_MARKLINE_CHECK, isEnable);
2737  	showFindDlgItem(IDC_PURGE_CHECK, isEnable);
2738  	showFindDlgItem(IDC_CLEAR_ALL, isEnable);
2739  	showFindDlgItem(IDC_IN_SELECTION_CHECK, isEnable);
2740  	showFindDlgItem(IDC_COPY_MARKED_TEXT, isEnable);
2741  }
2742  void FindReplaceDlg::enableFindInFilesControls(bool isEnable, bool projectPanels)
2743  {
2744  	showFindDlgItem(IDC_BACKWARDDIRECTION, !isEnable);
2745  	showFindDlgItem(IDWRAP, !isEnable);
2746  	showFindDlgItem(IDCCOUNTALL, !isEnable);
2747  	showFindDlgItem(IDC_FINDALL_OPENEDFILES, !isEnable);
2748  	showFindDlgItem(IDC_FINDALL_CURRENTFILE, !isEnable);
2749  	if (isEnable)
2750  	{
2751  		showFindDlgItem(IDC_2_BUTTONS_MODE, false);
2752  		showFindDlgItem(IDOK, false);
2753  		showFindDlgItem(IDC_FINDPREV, false);
2754  		showFindDlgItem(IDC_FINDNEXT, false);
2755  	}
2756  	else
2757  	{
2758  		showFindDlgItem(IDC_2_BUTTONS_MODE);
2759  		bool is2ButtonMode = isCheckedOrNot(IDC_2_BUTTONS_MODE);
2760  		showFindDlgItem(IDOK, !is2ButtonMode);
2761  		showFindDlgItem(IDC_FINDPREV, is2ButtonMode);
2762  		showFindDlgItem(IDC_FINDNEXT, is2ButtonMode);
2763  	}
2764  	showFindDlgItem(IDC_MARKLINE_CHECK, !isEnable);
2765  	showFindDlgItem(IDC_PURGE_CHECK, !isEnable);
2766  	showFindDlgItem(IDC_IN_SELECTION_CHECK, !isEnable);
2767  	showFindDlgItem(IDC_CLEAR_ALL, !isEnable);
2768  	showFindDlgItem(IDCMARKALL, !isEnable);
2769  	showFindDlgItem(IDC_COPY_MARKED_TEXT, !isEnable);
2770  	showFindDlgItem(IDREPLACE, !isEnable);
2771  	showFindDlgItem(IDC_REPLACEINSELECTION, !isEnable);
2772  	showFindDlgItem(IDREPLACEALL, !isEnable);
2773  	showFindDlgItem(IDC_REPLACE_OPENEDFILES, !isEnable);
2774  	if (isEnable)
2775  	{
2776  		showFindDlgItem(ID_STATICTEXT_REPLACE);
2777  		showFindDlgItem(IDREPLACEWITH);
2778  		showFindDlgItem(IDD_FINDREPLACE_SWAP_BUTTON);
2779  	}
2780  	showFindDlgItem(IDD_FINDINFILES_REPLACEINFILES, isEnable && (!projectPanels));
2781  	showFindDlgItem(IDD_FINDINFILES_REPLACEINPROJECTS, isEnable && projectPanels);
2782  	showFindDlgItem(IDD_FINDINFILES_FILTERS_STATIC, isEnable);
2783  	showFindDlgItem(IDD_FINDINFILES_FILTERS_COMBO, isEnable);
2784  	showFindDlgItem(IDD_FINDINFILES_DIR_STATIC, isEnable && (!projectPanels));
2785  	showFindDlgItem(IDD_FINDINFILES_DIR_COMBO, isEnable && (!projectPanels));
2786  	showFindDlgItem(IDD_FINDINFILES_BROWSE_BUTTON, isEnable && (!projectPanels));
2787  	showFindDlgItem(IDD_FINDINFILES_FIND_BUTTON, isEnable);
2788  	showFindDlgItem(IDD_FINDINFILES_RECURSIVE_CHECK, isEnable && (!projectPanels));
2789  	showFindDlgItem(IDD_FINDINFILES_INHIDDENDIR_CHECK, isEnable && (!projectPanels));
2790  	showFindDlgItem(IDD_FINDINFILES_PROJECT1_CHECK, isEnable && projectPanels);
2791  	showFindDlgItem(IDD_FINDINFILES_PROJECT2_CHECK, isEnable && projectPanels);
2792  	showFindDlgItem(IDD_FINDINFILES_PROJECT3_CHECK, isEnable && projectPanels);
2793  	showFindDlgItem(IDD_FINDINFILES_FOLDERFOLLOWSDOC_CHECK, isEnable && (!projectPanels));
2794  }
2795  void FindReplaceDlg::getPatterns(vector<generic_string> & patternVect)
2796  {
2797  	cutString(_env->_filters.c_str(), patternVect);
2798  }
2799  void FindReplaceDlg::getAndValidatePatterns(vector<generic_string> & patternVect)
2800  {
2801  	getPatterns(patternVect);
2802  	if (patternVect.size() == 0)
2803  	{
2804  		setFindInFilesDirFilter(NULL, TEXT("*.*"));
2805  		getPatterns(patternVect);
2806  	}
2807  	else if (allPatternsAreExclusion(patternVect))
2808  	{
2809  		patternVect.insert(patternVect.begin(), TEXT("*.*"));
2810  	}
2811  }
2812  void FindReplaceDlg::saveInMacro(size_t cmd, int cmdType)
2813  {
2814  	int booleans = 0;
2815  	::SendMessage(_hParent, WM_FRSAVE_INT, IDC_FRCOMMAND_INIT, 0);
2816  	::SendMessage(_hParent, WM_FRSAVE_STR, IDFINDWHAT,  reinterpret_cast<LPARAM>(cmd == IDC_CLEAR_ALL ? "" : wstring2string(_options._str2Search, CP_UTF8).c_str()));
2817  	booleans |= _options._isWholeWord?IDF_WHOLEWORD:0;
2818  	booleans |= _options._isMatchCase?IDF_MATCHCASE:0;
2819  	booleans |= _options._dotMatchesNewline?IDF_REDOTMATCHNL:0;
2820  	::SendMessage(_hParent, WM_FRSAVE_INT, IDNORMAL, _options._searchType);
2821  	if (cmd == IDCMARKALL)
2822  	{
2823  		booleans |= _options._doPurge?IDF_PURGE_CHECK:0;
2824  		booleans |= _options._doMarkLine?IDF_MARKLINE_CHECK:0;
2825  	}
2826  	if (cmdType & FR_OP_REPLACE)
2827  		::SendMessage(_hParent, WM_FRSAVE_STR, IDREPLACEWITH, reinterpret_cast<LPARAM>(wstring2string(_options._str4Replace, CP_UTF8).c_str()));
2828  	if (cmdType & FR_OP_FIF)
2829  	{
2830  		::SendMessage(_hParent, WM_FRSAVE_STR, IDD_FINDINFILES_DIR_COMBO, reinterpret_cast<LPARAM>(wstring2string(_options._directory, CP_UTF8).c_str()));
2831  		::SendMessage(_hParent, WM_FRSAVE_STR, IDD_FINDINFILES_FILTERS_COMBO, reinterpret_cast<LPARAM>(wstring2string(_options._filters, CP_UTF8).c_str()));
2832  		booleans |= _options._isRecursive?IDF_FINDINFILES_RECURSIVE_CHECK:0;
2833  		booleans |= _options._isInHiddenDir?IDF_FINDINFILES_INHIDDENDIR_CHECK:0;
2834  	}
2835  	if (cmdType & FR_OP_FIP)
2836  	{
2837  		::SendMessage(_hParent, WM_FRSAVE_STR, IDD_FINDINFILES_FILTERS_COMBO, reinterpret_cast<LPARAM>(wstring2string(_options._filters, CP_UTF8).c_str()));
2838  		booleans |= _options._isProjectPanel_1?IDF_FINDINFILES_PROJECT1_CHECK:0;
2839  		booleans |= _options._isProjectPanel_2?IDF_FINDINFILES_PROJECT2_CHECK:0;
2840  		booleans |= _options._isProjectPanel_3?IDF_FINDINFILES_PROJECT3_CHECK:0;
2841  	}
2842  	else if (!(cmdType & FR_OP_GLOBAL))
2843  	{
2844  		booleans |= _options._isInSelection?IDF_IN_SELECTION_CHECK:0;
2845  		booleans |= _options._isWrapAround?IDF_WRAP:0;
2846  		booleans |= _options._whichDirection?IDF_WHICH_DIRECTION:0;
2847  	}
2848  	else if (cmdType == FR_OP_FIND + FR_OP_GLOBAL)
2849  	{
2850  		booleans |= _options._isInSelection ? IDF_IN_SELECTION_CHECK : 0;
2851  	}
2852  	if (cmd == IDC_CLEAR_ALL)
2853  	{
2854  		booleans = _options._doMarkLine ? IDF_MARKLINE_CHECK : 0;
2855  		booleans |= _options._isInSelection ? IDF_IN_SELECTION_CHECK : 0;
2856  	}
2857  	::SendMessage(_hParent, WM_FRSAVE_INT, IDC_FRCOMMAND_BOOLEANS, booleans);
2858  	::SendMessage(_hParent, WM_FRSAVE_INT, IDC_FRCOMMAND_EXEC, cmd);
2859  }
2860  void FindReplaceDlg::setStatusbarMessage(const generic_string & msg, FindStatus staus, char const *pTooltipMsg)
2861  {
2862  	if (_statusbarTooltipWnd)
2863  	{
2864  		::DestroyWindow(_statusbarTooltipWnd);
2865  		_statusbarTooltipWnd = nullptr;
2866  	}
2867  	_statusbarTooltipMsg = (pTooltipMsg && (*pTooltipMsg)) ? s2ws(pTooltipMsg) : TEXT("");
2868  	if (staus == FSNotFound)
2869  	{
2870  		if (!NppParameters::getInstance().getNppGUI()._muteSounds)
2871  			::MessageBeep(0xFFFFFFFF);
2872  		FLASHWINFO flashInfo{};
2873  		flashInfo.cbSize = sizeof(FLASHWINFO);
2874  		flashInfo.hwnd = isVisible()?_hSelf:GetParent(_hSelf);
2875  		flashInfo.uCount = 3;
2876  		flashInfo.dwTimeout = 100;
2877  		flashInfo.dwFlags = FLASHW_ALL;
2878  		FlashWindowEx(&flashInfo);
2879  	}
2880  	else if (staus == FSTopReached || staus == FSEndReached)
2881  	{
2882  		if (!isVisible())
2883  		{
2884  			FLASHWINFO flashInfo{};
2885  			flashInfo.cbSize = sizeof(FLASHWINFO);
2886  			flashInfo.hwnd = GetParent(_hSelf);
2887  			flashInfo.uCount = 2;
2888  			flashInfo.dwTimeout = 100;
2889  			flashInfo.dwFlags = FLASHW_ALL;
2890  			FlashWindowEx(&flashInfo);
2891  		}
2892  	}
2893  	if (isVisible())
2894  	{
2895  		_statusbarFindStatus = staus;
2896  		_statusBar.setOwnerDrawText(msg.c_str());
2897  	}
2898  }
2899  generic_string FindReplaceDlg::getScopeInfoForStatusBar(FindOption const *pFindOpt) const
2900  {
2901  	generic_string scope;
2902  	NativeLangSpeaker* pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
2903  	if (pFindOpt->_isInSelection)
2904  	{
2905  		scope += pNativeSpeaker->getLocalizedStrFromID("find-status-scope-selection", TEXT("in selected text"));
2906  	}
2907  	else if (pFindOpt->_isWrapAround)
2908  	{
2909  		scope += pNativeSpeaker->getLocalizedStrFromID("find-status-scope-all", TEXT("in entire file"));
2910  	}
2911  	else if (pFindOpt->_whichDirection == DIR_UP)
2912  	{
2913  		scope += pNativeSpeaker->getLocalizedStrFromID("find-status-scope-backward", TEXT("from start-of-file to caret"));
2914  	}
2915  	else
2916  	{
2917  		scope += pNativeSpeaker->getLocalizedStrFromID("find-status-scope-forward", TEXT("from caret to end-of-file"));
2918  	}
2919  	return scope;
2920  }
2921  void FindReplaceDlg::execSavedCommand(int cmd, uptr_t intValue, const generic_string& stringValue)
2922  {
2923  	try
2924  	{
2925  		switch (cmd)
2926  		{
2927  			case IDC_FRCOMMAND_INIT:
2928  				_env = new FindOption;
2929  				break;
2930  			case IDFINDWHAT:
2931  				_env->_str2Search = stringValue;
2932  				break;
2933  			case IDC_FRCOMMAND_BOOLEANS:
2934  				_env->_isWholeWord = ((intValue & IDF_WHOLEWORD) > 0);
2935  				_env->_isMatchCase = ((intValue & IDF_MATCHCASE) > 0);
2936  				_env->_isRecursive = ((intValue & IDF_FINDINFILES_RECURSIVE_CHECK) > 0);
2937  				_env->_isInHiddenDir = ((intValue & IDF_FINDINFILES_INHIDDENDIR_CHECK) > 0);
2938  				_env->_isProjectPanel_1 = ((intValue & IDF_FINDINFILES_PROJECT1_CHECK) > 0);
2939  				_env->_isProjectPanel_2 = ((intValue & IDF_FINDINFILES_PROJECT2_CHECK) > 0);
2940  				_env->_isProjectPanel_3 = ((intValue & IDF_FINDINFILES_PROJECT3_CHECK) > 0);
2941  				_env->_doPurge = ((intValue & IDF_PURGE_CHECK) > 0);
2942  				_env->_doMarkLine = ((intValue & IDF_MARKLINE_CHECK) > 0);
2943  				_env->_isInSelection = ((intValue & IDF_IN_SELECTION_CHECK) > 0);
2944  				_env->_isWrapAround = ((intValue & IDF_WRAP) > 0);
2945  				_env->_whichDirection = ((intValue & IDF_WHICH_DIRECTION) > 0);
2946  				_env->_dotMatchesNewline = ((intValue & IDF_REDOTMATCHNL) > 0);
2947  				break;
2948  			case IDNORMAL:
2949  				_env->_searchType = static_cast<SearchType>(intValue);
2950  				break;
2951  			case IDREPLACEWITH:
2952  				_env->_str4Replace = stringValue;
2953  				break;
2954  			case IDD_FINDINFILES_DIR_COMBO:
2955  				_env->_directory = stringValue;
2956  				break;
2957  			case IDD_FINDINFILES_FILTERS_COMBO:
2958  				_env->_filters = stringValue;
2959  				break;
2960  			case IDC_FRCOMMAND_EXEC:
2961  			{
2962  				NppParameters& nppParamInst = NppParameters::getInstance();
2963  				switch (intValue)
2964  				{
2965  					case IDOK:
2966  						if ((_env->_whichDirection == DIR_UP) && (_env->_searchType == FindRegex) && !nppParamInst.regexBackward4PowerUser())
2967  						{
2968  						}
2969  						else
2970  						{
2971  							nppParamInst._isFindReplacing = true;
2972  							processFindNext(_env->_str2Search.c_str());
2973  							nppParamInst._isFindReplacing = false;
2974  						}
2975  						break;
2976  					case IDC_FINDNEXT:
2977  						nppParamInst._isFindReplacing = true;
2978  						_env->_whichDirection = DIR_DOWN;
2979  						processFindNext(_env->_str2Search.c_str());
2980  						nppParamInst._isFindReplacing = false;
2981  						break;
2982  					case IDC_FINDPREV:
2983  						if (_env->_searchType == FindRegex && !nppParamInst.regexBackward4PowerUser())
2984  						{
2985  						}
2986  						else
2987  						{
2988  							_env->_whichDirection = DIR_UP;
2989  							nppParamInst._isFindReplacing = true;
2990  							processFindNext(_env->_str2Search.c_str());
2991  							nppParamInst._isFindReplacing = false;
2992  						}
2993  						break;
2994  					case IDREPLACE:
2995  						if ((_env->_whichDirection == DIR_UP) && (_env->_searchType == FindRegex && !nppParamInst.regexBackward4PowerUser()))
2996  						{
2997  						}
2998  						else
2999  						{
3000  							nppParamInst._isFindReplacing = true;
3001  							processReplace(_env->_str2Search.c_str(), _env->_str4Replace.c_str(), _env);
3002  							nppParamInst._isFindReplacing = false;
3003  						}
3004  						break;
3005  					case IDC_FINDALL_OPENEDFILES:
3006  						nppParamInst._isFindReplacing = true;
3007  						findAllIn(ALL_OPEN_DOCS);
3008  						nppParamInst._isFindReplacing = false;
3009  						break;
3010  					case IDC_FINDALL_CURRENTFILE:
3011  						nppParamInst._isFindReplacing = true;
3012  						findAllIn(_env->_isInSelection ? CURR_DOC_SELECTION : CURRENT_DOC);
3013  						nppParamInst._isFindReplacing = false;
3014  						break;
3015  					case IDC_REPLACE_OPENEDFILES:
3016  					{
3017  						NppParameters& nppParam = NppParameters::getInstance();
3018  						const NppGUI& nppGui = nppParam.getNppGUI();
3019  						if (!nppGui._confirmReplaceInAllOpenDocs || replaceInOpenDocsConfirmCheck())
3020  						{
3021  							nppParamInst._isFindReplacing = true;
3022  							replaceAllInOpenedDocs();
3023  							nppParamInst._isFindReplacing = false;
3024  						}
3025  						break;
3026  					}
3027  					case IDD_FINDINFILES_FIND_BUTTON:
3028  						nppParamInst._isFindReplacing = true;
3029  						findAllIn(FILES_IN_DIR);
3030  						nppParamInst._isFindReplacing = false;
3031  						break;
3032  					case IDD_FINDINFILES_FINDINPROJECTS:
3033  						nppParamInst._isFindReplacing = true;
3034  						findAllIn(FILES_IN_PROJECTS);
3035  						nppParamInst._isFindReplacing = false;
3036  						break;
3037  					case IDD_FINDINFILES_REPLACEINFILES:
3038  					{
3039  						if (replaceInFilesConfirmCheck(_env->_directory, _env->_filters))
3040  						{
3041  							nppParamInst._isFindReplacing = true;
3042  							::SendMessage(_hParent, WM_REPLACEINFILES, 0, 0);
3043  							nppParamInst._isFindReplacing = false;
3044  						}
3045  						break;
3046  					}
3047  					case IDD_FINDINFILES_REPLACEINPROJECTS:
3048  					{
3049  						if (replaceInProjectsConfirmCheck())
3050  						{
3051  							nppParamInst._isFindReplacing = true;
3052  							::SendMessage(_hParent, WM_REPLACEINPROJECTS, 0, 0);
3053  							nppParamInst._isFindReplacing = false;
3054  						}
3055  						break;
3056  					}
3057  					case IDREPLACEALL:
3058  					{
3059  						nppParamInst._isFindReplacing = true;
3060  						(*_ppEditView)->execute(SCI_BEGINUNDOACTION);
3061  						int nbReplaced = processAll(ProcessReplaceAll, _env);
3062  						(*_ppEditView)->execute(SCI_ENDUNDOACTION);
3063  						nppParamInst._isFindReplacing = false;
3064  						generic_string result;
3065  						NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
3066  						if (nbReplaced < 0)
3067  						{
3068  							result = pNativeSpeaker->getLocalizedStrFromID("find-status-replaceall-re-malformed", TEXT("Replace All: The regular expression is malformed."));
3069  						}
3070  						else
3071  						{
3072  							if (nbReplaced == 1)
3073  							{
3074  								result = pNativeSpeaker->getLocalizedStrFromID("find-status-replaceall-1-replaced", TEXT("Replace All: 1 occurrence was replaced"));
3075  							}
3076  							else
3077  							{
3078  								result = pNativeSpeaker->getLocalizedStrFromID("find-status-replaceall-nb-replaced", TEXT("Replace All: $INT_REPLACE$ occurrences were replaced"));
3079  								result = stringReplace(result, TEXT("$INT_REPLACE$"), std::to_wstring(nbReplaced));
3080  							}
3081  							result += TEXT(" ");
3082  							result += getScopeInfoForStatusBar(_env);
3083  						}
3084  						setStatusbarMessage(result, FSMessage);
3085  						break;
3086  					}
3087  					case IDCCOUNTALL:
3088  					{
3089  						int nbCounted = processAll(ProcessCountAll, _env);
3090  						generic_string result;
3091  						NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
3092  						if (nbCounted < 0)
3093  						{
3094  							result = pNativeSpeaker->getLocalizedStrFromID("find-status-count-re-malformed", TEXT("Count: The regular expression to search is malformed."));
3095  						}
3096  						else
3097  						{
3098  							if (nbCounted == 1)
3099  							{
3100  								result = pNativeSpeaker->getLocalizedStrFromID("find-status-count-1-match", TEXT("Count: 1 match"));
3101  							}
3102  							else
3103  							{
3104  								result = pNativeSpeaker->getLocalizedStrFromID("find-status-count-nb-matches", TEXT("Count: $INT_REPLACE$ matches"));
3105  								result = stringReplace(result, TEXT("$INT_REPLACE$"), std::to_wstring(nbCounted));
3106  							}
3107  							result += TEXT(" ");
3108  							result += getScopeInfoForStatusBar(_env);
3109  						}
3110  						setStatusbarMessage(result, FSMessage);
3111  						break;
3112  					}
3113  					case IDCMARKALL:
3114  					{
3115  						nppParamInst._isFindReplacing = true;
3116  						int nbMarked = processAll(ProcessMarkAll, _env);
3117  						nppParamInst._isFindReplacing = false;
3118  						generic_string result;
3119  						NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
3120  						if (nbMarked < 0)
3121  						{
3122  							result = pNativeSpeaker->getLocalizedStrFromID("find-status-mark-re-malformed", TEXT("Mark: The regular expression to search is malformed."));
3123  						}
3124  						else
3125  						{
3126  							if (nbMarked == 1)
3127  							{
3128  								result = pNativeSpeaker->getLocalizedStrFromID("find-status-mark-1-match", TEXT("Mark: 1 match"));
3129  							}
3130  							else
3131  							{
3132  								result = pNativeSpeaker->getLocalizedStrFromID("find-status-mark-nb-matches", TEXT("Mark: $INT_REPLACE$ matches"));
3133  								result = stringReplace(result, TEXT("$INT_REPLACE$"), std::to_wstring(nbMarked));
3134  							}
3135  							result += TEXT(" ");
3136  							result += getScopeInfoForStatusBar(_env);
3137  						}
3138  						setStatusbarMessage(result, FSMessage);
3139  						break;
3140  					}
3141  					case IDC_CLEAR_ALL:
3142  					{
3143  						clearMarks(*_env);
3144  						break;
3145  					}
3146  					default:
3147  						throw std::runtime_error("Internal error: unknown saved command!");
3148  				}
3149  				delete _env;
3150  				_env = &_options;
3151  				break;
3152  			}
3153  			default:
3154  				throw std::runtime_error("Internal error: unknown SnR command!");
3155  		}
3156  	}
3157  	catch (const std::runtime_error& err)
3158  	{
3159  		MessageBoxA(NULL, err.what(), "Play Macro Exception", MB_OK);
3160  	}
3161  }
3162  void FindReplaceDlg::clearMarks(const FindOption& opt)
3163  {
3164  	if (opt._isInSelection)
3165  	{
3166  		Sci_CharacterRangeFull cr = (*_ppEditView)->getSelection();
3167  		intptr_t startPosition = cr.cpMin;
3168  		intptr_t endPosition = cr.cpMax;
3169  		(*_ppEditView)->execute(SCI_SETINDICATORCURRENT, SCE_UNIVERSAL_FOUND_STYLE);
3170  		(*_ppEditView)->execute(SCI_INDICATORCLEARRANGE, startPosition, endPosition - startPosition);
3171  		if (opt._doMarkLine)
3172  		{
3173  			auto lineNumber = (*_ppEditView)->execute(SCI_LINEFROMPOSITION, startPosition);
3174  			auto lineNumberEnd = (*_ppEditView)->execute(SCI_LINEFROMPOSITION, endPosition - 1);
3175  			for (auto i = lineNumber; i <= lineNumberEnd; ++i)
3176  			{
3177  				auto state = (*_ppEditView)->execute(SCI_MARKERGET, i);
3178  				if (state & (1 << MARK_BOOKMARK))
3179  					(*_ppEditView)->execute(SCI_MARKERDELETE, i, MARK_BOOKMARK);
3180  			}
3181  		}
3182  	}
3183  	else
3184  	{
3185  		(*_ppEditView)->clearIndicator(SCE_UNIVERSAL_FOUND_STYLE);
3186  		if (opt._doMarkLine)
3187  		{
3188  			(*_ppEditView)->execute(SCI_MARKERDELETEALL, MARK_BOOKMARK);
3189  		}
3190  	}
3191  	setStatusbarMessage(TEXT(""), FSNoMessage);
3192  }
3193  void FindReplaceDlg::setFindInFilesDirFilter(const TCHAR *dir, const TCHAR *filters)
3194  {
3195  	if (dir)
3196  	{
3197  		_options._directory = dir;
3198  		::SetDlgItemText(_hSelf, IDD_FINDINFILES_DIR_COMBO, dir);
3199  	}
3200  	if (filters)
3201  	{
3202  		_options._filters = filters;
3203  		::SetDlgItemText(_hSelf, IDD_FINDINFILES_FILTERS_COMBO, filters);
3204  	}
3205  }
3206  void FindReplaceDlg::enableProjectCheckmarks()
3207  {
3208  	NppParameters& nppParams = NppParameters::getInstance();
3209  	FindHistory & findHistory = nppParams.getFindHistory();
3210  	HMENU hMenu = (HMENU) ::SendMessage (_hParent, NPPM_INTERNAL_GETMENU, 0, 0);
3211  	if (hMenu)
3212  	{
3213  		int   idm [3] = {IDM_VIEW_PROJECT_PANEL_1, IDM_VIEW_PROJECT_PANEL_2, IDM_VIEW_PROJECT_PANEL_3};
3214  		int   idd [3] = {IDD_FINDINFILES_PROJECT1_CHECK, IDD_FINDINFILES_PROJECT2_CHECK, IDD_FINDINFILES_PROJECT3_CHECK};
3215  		bool *opt [3] = {&_options._isProjectPanel_1, &_options._isProjectPanel_2, &_options._isProjectPanel_3};
3216  		bool *hst [3] = {&findHistory._isFifProjectPanel_1, &findHistory._isFifProjectPanel_2, &findHistory._isFifProjectPanel_3};
3217  		bool enable = false;
3218  		for (int i = 0; i < 3; i++)
3219  		{
3220  			UINT s = GetMenuState (hMenu, idm [i], MF_BYCOMMAND);
3221  			if (s != ((UINT)-1))
3222  			{
3223  				if (s & MF_CHECKED)
3224  				{
3225  					enableFindDlgItem (idd [i], true);
3226  					if (BST_CHECKED == ::SendDlgItemMessage(_hSelf, idd [i], BM_GETCHECK, 0, 0))
3227  						enable = true;
3228  				}
3229  				else
3230  				{
3231  					*opt [i] = 0;
3232  					*hst [i] = 0;
3233  					::SendDlgItemMessage(_hSelf, idd [i], BM_SETCHECK, 0, 0);
3234  					enableFindDlgItem (idd [i], false);
3235  				}
3236  			}
3237  		}
3238  		enableFindDlgItem (IDD_FINDINFILES_FIND_BUTTON, enable || (_currentStatus != FINDINPROJECTS_DLG));
3239  		enableFindDlgItem (IDD_FINDINFILES_REPLACEINPROJECTS, enable);
3240  	}
3241  }
3242  void FindReplaceDlg::setProjectCheckmarks(FindHistory *findHistory, int msk)
3243  {
3244  	_options._isProjectPanel_1 = (msk & 1) ? true : false;
3245  	_options._isProjectPanel_2 = (msk & 2) ? true : false;
3246  	_options._isProjectPanel_3 = (msk & 4) ? true : false;
3247  	FindHistory *fh = findHistory;
3248  	if (! fh)
3249  	{
3250  		NppParameters& nppParams = NppParameters::getInstance();
3251  		fh = & nppParams.getFindHistory();
3252  	}
3253  	if (fh)
3254  	{
3255  		fh->_isFifProjectPanel_1 = _options._isProjectPanel_1;
3256  		fh->_isFifProjectPanel_2 = _options._isProjectPanel_2;
3257  		fh->_isFifProjectPanel_3 = _options._isProjectPanel_3;
3258  	}
3259  	::SendDlgItemMessage(_hSelf, IDD_FINDINFILES_PROJECT1_CHECK, BM_SETCHECK, _options._isProjectPanel_1, 0);
3260  	::SendDlgItemMessage(_hSelf, IDD_FINDINFILES_PROJECT2_CHECK, BM_SETCHECK, _options._isProjectPanel_2, 0);
3261  	::SendDlgItemMessage(_hSelf, IDD_FINDINFILES_PROJECT3_CHECK, BM_SETCHECK, _options._isProjectPanel_3, 0);
3262  	if (_currentStatus == FINDINPROJECTS_DLG)
3263  	{
3264  		enableFindDlgItem (IDD_FINDINFILES_FIND_BUTTON, msk != 0);
3265  		enableFindDlgItem (IDD_FINDINFILES_REPLACEINPROJECTS, msk != 0);
3266  	}
3267  }
3268  void FindReplaceDlg::initOptionsFromDlg()
3269  {
3270  	_options._isWholeWord = isCheckedOrNot(IDWHOLEWORD);
3271  	_options._isMatchCase = isCheckedOrNot(IDMATCHCASE);
3272  	_options._searchType = isCheckedOrNot(IDREGEXP)?FindRegex:isCheckedOrNot(IDEXTENDED)?FindExtended:FindNormal;
3273  	_options._isWrapAround = isCheckedOrNot(IDWRAP);
3274  	_options._isInSelection = isCheckedOrNot(IDC_IN_SELECTION_CHECK);
3275  	_options._dotMatchesNewline = isCheckedOrNot(IDREDOTMATCHNL);
3276  	_options._doPurge = isCheckedOrNot(IDC_PURGE_CHECK);
3277  	_options._doMarkLine = isCheckedOrNot(IDC_MARKLINE_CHECK);
3278  	_options._whichDirection = isCheckedOrNot(IDC_BACKWARDDIRECTION) ? DIR_UP : DIR_DOWN;
3279  	_options._isRecursive = isCheckedOrNot(IDD_FINDINFILES_RECURSIVE_CHECK);
3280  	_options._isInHiddenDir = isCheckedOrNot(IDD_FINDINFILES_INHIDDENDIR_CHECK);
3281  	_options._isProjectPanel_1 =  isCheckedOrNot(IDD_FINDINFILES_PROJECT1_CHECK);
3282  	_options._isProjectPanel_2 =  isCheckedOrNot(IDD_FINDINFILES_PROJECT2_CHECK);
3283  	_options._isProjectPanel_3 =  isCheckedOrNot(IDD_FINDINFILES_PROJECT3_CHECK);
3284  }
3285  void FindInFinderDlg::doDialog(Finder *launcher, bool isRTL)
3286  {
3287  	_pFinder2Search = launcher;
3288  	if (isRTL)
3289  	{
3290  		DLGTEMPLATE *pMyDlgTemplate = NULL;
3291  		HGLOBAL hMyDlgTemplate = makeRTLResource(IDD_FINDINFINDER_DLG, &pMyDlgTemplate);
3292  		::DialogBoxIndirectParam(_hInst, pMyDlgTemplate, _hParent, dlgProc, reinterpret_cast<LPARAM>(this));
3293  		::GlobalFree(hMyDlgTemplate);
3294  	}
3295  	else
3296  		::DialogBoxParam(_hInst, MAKEINTRESOURCE(IDD_FINDINFINDER_DLG), _hParent, dlgProc, reinterpret_cast<LPARAM>(this));
3297  }
3298  void FindReplaceDlg::doDialog(DIALOG_TYPE whichType, bool isRTL, bool toShow)
3299  {
3300  	if (!isCreated())
3301  	{
3302  		_isRTL = isRTL;
3303  		create(IDD_FIND_REPLACE_DLG, isRTL, true, toShow);
3304  	}
3305  	if (whichType == FINDINFILES_DLG)
3306  		enableFindInFilesFunc();
3307  	else if (whichType == FINDINPROJECTS_DLG)
3308  		enableFindInProjectsFunc();
3309  	else if (whichType == MARK_DLG)
3310  		enableMarkFunc();
3311  	else
3312  		enableReplaceFunc(whichType == REPLACE_DLG);
3313  	::SetFocus(toShow ? ::GetDlgItem(_hSelf, IDFINDWHAT) : (*_ppEditView)->getHSelf());
3314  	display(toShow, true);
3315  }
3316  LRESULT FAR PASCAL FindReplaceDlg::finderProc(HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)
3317  {
3318  	if (message == WM_KEYDOWN && (wParam == VK_DELETE || wParam == VK_RETURN || wParam == VK_ESCAPE))
3319  	{
3320  		ScintillaEditView *pScint = (ScintillaEditView *)(::GetWindowLongPtr(hwnd, GWLP_USERDATA));
3321  		Finder *pFinder = (Finder *)(::GetWindowLongPtr(pScint->getHParent(), GWLP_USERDATA));
3322  		if (wParam == VK_RETURN)
3323  		{
3324  			std::pair<intptr_t, intptr_t> newPos = pFinder->gotoFoundLine();
3325  			auto currentPos = pFinder->_scintView.execute(SCI_GETCURRENTPOS);
3326  			intptr_t lno = pFinder->_scintView.execute(SCI_LINEFROMPOSITION, currentPos);
3327  			intptr_t lineStartAbsPos = pFinder->_scintView.execute(SCI_POSITIONFROMLINE, lno);
3328  			intptr_t lineEndAbsPos = pFinder->_scintView.execute(SCI_GETLINEENDPOSITION, lno);
3329  			intptr_t begin = newPos.first + lineStartAbsPos;
3330  			intptr_t end = newPos.second + lineStartAbsPos;
3331  			if (end > lineEndAbsPos)
3332  				end = lineEndAbsPos;
3333  			pFinder->_scintView.execute(SCI_SETSEL, begin, end);
3334  			pFinder->_scintView.execute(SCI_SCROLLRANGE, begin, end);
3335  		}
3336  		else if (wParam == VK_ESCAPE)
3337  			pFinder->display(false);
3338  		else 
3339  			pFinder->deleteResult();
3340  		return 0;
3341  	}
3342  	else
3343  		return CallWindowProc(originalFinderProc, hwnd, message, wParam, lParam);
3344  }
3345  LRESULT FAR PASCAL FindReplaceDlg::comboEditProc(HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)
3346  {
3347  	HWND hwndCombo = reinterpret_cast<HWND>(GetWindowLongPtr(hwnd, GWLP_USERDATA));
3348  	bool isDropped = ::SendMessage(hwndCombo, CB_GETDROPPEDSTATE, 0, 0) != 0;
3349  	if (isDropped && (message == WM_KEYDOWN) && (wParam == VK_DELETE))
3350  	{
3351  		auto curSel = ::SendMessage(hwndCombo, CB_GETCURSEL, 0, 0);
3352  		if (curSel != CB_ERR)
3353  		{
3354  			auto itemsRemaining = ::SendMessage(hwndCombo, CB_DELETESTRING, curSel, 0);
3355  			::SendMessage(hwndCombo, CB_SHOWDROPDOWN, FALSE, 0);
3356  			if (itemsRemaining > 0)
3357  			{
3358  				if (itemsRemaining == curSel)
3359  				{
3360  					--curSel;
3361  				}
3362  				::SendMessage(hwndCombo, CB_SETCURSEL, curSel, 0);
3363  				::SendMessage(hwndCombo, CB_SHOWDROPDOWN, TRUE, 0);
3364  			}
3365  			return 0;
3366  		}
3367  	}
3368  	else if (message == WM_CHAR && wParam == 0x7F) 
3369  	{
3370  		delLeftWordInEdit(hwnd);
3371  		return 0;
3372  	}
3373  	return CallWindowProc(originalComboEditProc, hwnd, message, wParam, lParam);
3374  }
3375  void FindReplaceDlg::hideOrShowCtrl4reduceOrNormalMode(DIALOG_TYPE dlgT)
3376  {
3377  	bool isLessModeOn = NppParameters::getInstance().getNppGUI()._findWindowLessMode;
3378  	if (dlgT == FIND_DLG)
3379  	{
3380  		for (int id : _reduce2hide_find)
3381  			::ShowWindow(::GetDlgItem(_hSelf, id), isLessModeOn ? SW_HIDE : SW_SHOW);
3382  	}
3383  	else if (dlgT == REPLACE_DLG)
3384  	{
3385  		for (int id : _reduce2hide_findReplace)
3386  			::ShowWindow(::GetDlgItem(_hSelf, id), isLessModeOn ? SW_HIDE : SW_SHOW);
3387  	}
3388  	else if (dlgT == FINDINFILES_DLG)
3389  	{
3390  		for (int id : _reduce2hide_fif)
3391  			::ShowWindow(::GetDlgItem(_hSelf, id), isLessModeOn ? SW_HIDE : SW_SHOW);
3392  	}
3393  	else if (dlgT == FINDINPROJECTS_DLG)
3394  	{
3395  		for (int id : _reduce2hide_fip)
3396  			::ShowWindow(::GetDlgItem(_hSelf, id), isLessModeOn ? SW_HIDE : SW_SHOW);
3397  	}
3398  	else 
3399  	{
3400  		for (int id : _reduce2hide_mark)
3401  			::ShowWindow(::GetDlgItem(_hSelf, id), isLessModeOn ? SW_HIDE : SW_SHOW);
3402  	}
3403  }
3404  void FindReplaceDlg::enableFindInFilesFunc()
3405  {
3406  	enableFindInFilesControls(true, false);
3407  	_currentStatus = FINDINFILES_DLG;
3408  	gotoCorrectTab();
3409  	::MoveWindow(::GetDlgItem(_hSelf, IDCANCEL), _findInFilesClosePos.left + _deltaWidth, _findInFilesClosePos.top, _findInFilesClosePos.right, _findInFilesClosePos.bottom, TRUE);
3410  	TCHAR label[MAX_PATH]{};
3411  	_tab.getCurrentTitle(label, MAX_PATH);
3412  	::SetWindowText(_hSelf, label);
3413  	setDefaultButton(IDD_FINDINFILES_FIND_BUTTON);
3414  	enableFindDlgItem (IDD_FINDINFILES_FIND_BUTTON, true);
3415  	hideOrShowCtrl4reduceOrNormalMode(_currentStatus);
3416  }
3417  void FindReplaceDlg::enableFindInProjectsFunc()
3418  {
3419  	enableFindInFilesControls(true, true);
3420  	_currentStatus = FINDINPROJECTS_DLG;
3421  	gotoCorrectTab();
3422  	::MoveWindow(::GetDlgItem(_hSelf, IDCANCEL), _findInFilesClosePos.left + _deltaWidth, _findInFilesClosePos.top, _findInFilesClosePos.right, _findInFilesClosePos.bottom, TRUE);
3423  	TCHAR label[MAX_PATH]{};
3424  	_tab.getCurrentTitle(label, MAX_PATH);
3425  	::SetWindowText(_hSelf, label);
3426  	setDefaultButton(IDD_FINDINFILES_FIND_BUTTON);
3427  	bool enable = _options._isProjectPanel_1 || _options._isProjectPanel_2 || _options._isProjectPanel_3;
3428  	enableFindDlgItem (IDD_FINDINFILES_FIND_BUTTON, enable);
3429  	enableFindDlgItem (IDD_FINDINFILES_REPLACEINPROJECTS, enable);
3430  	hideOrShowCtrl4reduceOrNormalMode(_currentStatus);
3431  }
3432  void FindReplaceDlg::enableMarkFunc()
3433  {
3434  	enableFindInFilesControls(false, false);
3435  	enableMarkAllControls(true);
3436  	showFindDlgItem(ID_STATICTEXT_REPLACE, false);
3437  	showFindDlgItem(IDREPLACE, false);
3438  	showFindDlgItem(IDREPLACEWITH, false);
3439  	showFindDlgItem(IDD_FINDREPLACE_SWAP_BUTTON, false);
3440  	showFindDlgItem(IDREPLACEALL, false);
3441  	showFindDlgItem(IDC_REPLACE_OPENEDFILES, false);
3442  	showFindDlgItem(IDC_REPLACEINSELECTION, false);
3443  	showFindDlgItem(IDC_FINDALL_OPENEDFILES, false);
3444  	showFindDlgItem(IDCCOUNTALL, false);
3445  	showFindDlgItem(IDC_FINDALL_CURRENTFILE, false);
3446  	showFindDlgItem(IDOK, false);
3447  	showFindDlgItem(IDC_2_BUTTONS_MODE, false);
3448  	showFindDlgItem(IDC_FINDPREV, false);
3449  	showFindDlgItem(IDC_FINDNEXT, false);
3450  	_currentStatus = MARK_DLG;
3451  	gotoCorrectTab();
3452  	::MoveWindow(::GetDlgItem(_hSelf, IDCANCEL), _findInFilesClosePos.left + _deltaWidth, _findInFilesClosePos.top, _findInFilesClosePos.right, _findInFilesClosePos.bottom, TRUE);
3453  	::MoveWindow(::GetDlgItem(_hSelf, IDC_IN_SELECTION_CHECK), _replaceInSelCheckPos.left + _deltaWidth, _replaceInSelCheckPos.top, _replaceInSelCheckPos.right, _replaceInSelCheckPos.bottom, TRUE);
3454  	::MoveWindow(::GetDlgItem(_hSelf, IDC_REPLACEINSELECTION), _replaceInSelFramePos.left + _deltaWidth, _replaceInSelFramePos.top, _replaceInSelFramePos.right, _replaceInSelFramePos.bottom, TRUE);
3455  	::MoveWindow(::GetDlgItem(_hSelf, IDCANCEL), _markClosePos.left + _deltaWidth, _markClosePos.top, _markClosePos.right, _markClosePos.bottom, TRUE);
3456  	TCHAR label[MAX_PATH]{};
3457  	_tab.getCurrentTitle(label, MAX_PATH);
3458  	::SetWindowText(_hSelf, label);
3459  	setDefaultButton(IDCMARKALL);
3460  	hideOrShowCtrl4reduceOrNormalMode(_currentStatus);
3461  }
3462  void FindReplaceDlg::combo2ExtendedMode(int comboID)
3463  {
3464  	HWND hFindCombo = ::GetDlgItem(_hSelf, comboID);
3465  	if (!hFindCombo) return;
3466  	generic_string str2transform = getTextFromCombo(hFindCombo);
3467  	size_t nbEOL = 0;
3468  	size_t str2transformLen = lstrlen(str2transform.c_str());
3469  	for (size_t i = 0 ; i < str2transformLen ; ++i)
3470  	{
3471  		if (str2transform[i] == '\r' || str2transform[i] == '\n')
3472  			++nbEOL;
3473  	}
3474  	if (nbEOL)
3475  	{
3476  		TCHAR * newBuffer = new TCHAR[str2transformLen + nbEOL*2 + 1];
3477  		int j = 0;
3478  		for (size_t i = 0 ; i < str2transformLen ; ++i)
3479  		{
3480  			if (str2transform[i] == '\r')
3481  			{
3482  				newBuffer[j++] = '\\';
3483  				newBuffer[j++] = 'r';
3484  			}
3485  			else if (str2transform[i] == '\n')
3486  			{
3487  				newBuffer[j++] = '\\';
3488  				newBuffer[j++] = 'n';
3489  			}
3490  			else
3491  			{
3492  				newBuffer[j++] = str2transform[i];
3493  			}
3494  		}
3495  		newBuffer[j++] = '\0';
3496  		setSearchText(newBuffer);
3497  		_options._searchType = FindExtended;
3498  		::SendDlgItemMessage(_hSelf, IDNORMAL, BM_SETCHECK, FALSE, 0);
3499  		::SendDlgItemMessage(_hSelf, IDEXTENDED, BM_SETCHECK, TRUE, 0);
3500  		::SendDlgItemMessage(_hSelf, IDREGEXP, BM_SETCHECK, FALSE, 0);
3501  		delete [] newBuffer;
3502      }
3503  }
3504  void FindReplaceDlg::drawItem(LPDRAWITEMSTRUCT lpDrawItemStruct)
3505  {
3506  	COLORREF fgColor = RGB(0, 0, 0); 
3507  	PCTSTR ptStr =(PCTSTR)lpDrawItemStruct->itemData;
3508  	if (_statusbarFindStatus == FSNotFound)
3509  	{
3510  		fgColor = RGB(0xFF, 00, 00); 
3511  	}
3512  	else if (_statusbarFindStatus == FSMessage)
3513  	{
3514  		fgColor = RGB(0, 0, 0xFF); 
3515  	}
3516  	else if (_statusbarFindStatus == FSTopReached || _statusbarFindStatus == FSEndReached)
3517  	{
3518  		fgColor = RGB(0, 166, 0); 
3519  	}
3520  	else if (_statusbarFindStatus == FSNoMessage)
3521  	{
3522  		ptStr = TEXT("");
3523  	}
3524  	if (NppDarkMode::isEnabled())
3525  	{
3526  		fgColor = NppDarkMode::getTextColor();
3527  		if (_statusbarFindStatus == FSNotFound)
3528  		{
3529  			fgColor = RGB(0xFF, 0x50, 0x50); 
3530  		}
3531  		else if (_statusbarFindStatus == FSMessage)
3532  		{
3533  			fgColor = RGB(0x70, 0x70, 0xFF); 
3534  		}
3535  		else if (_statusbarFindStatus == FSTopReached || _statusbarFindStatus == FSEndReached)
3536  		{
3537  			fgColor = RGB(0x50, 0xFF, 0x50); 
3538  		}
3539  	}
3540  	SetTextColor(lpDrawItemStruct->hDC, fgColor);
3541  	COLORREF bgColor;
3542  	if (NppDarkMode::isEnabled())
3543  	{
3544  		bgColor = NppDarkMode::getBackgroundColor();
3545  	}
3546  	else
3547  	{
3548  		bgColor = getCtrlBgColor(_statusBar.getHSelf());
3549  	}
3550  	::SetBkColor(lpDrawItemStruct->hDC, bgColor);
3551  	RECT rect{};
3552  	_statusBar.getClientRect(rect);
3553  	if (NppDarkMode::isEnabled())
3554  	{
3555  		rect.left += 2;
3556  	}
3557  	::DrawText(lpDrawItemStruct->hDC, ptStr, lstrlen(ptStr), &rect, DT_SINGLELINE | DT_VCENTER | DT_LEFT);
3558  	if (_statusbarTooltipMsg.length() == 0) return;
3559  	SIZE size{};
3560  	::GetTextExtentPoint32(lpDrawItemStruct->hDC, ptStr, lstrlen(ptStr), &size);
3561  	int s = (rect.bottom - rect.top) & 0x70; 
3562  	if (s > 0)
3563  	{
3564  		if (_statusbarTooltipIcon && (_statusbarTooltipIconSize != s))
3565  		{
3566  			DestroyIcon (_statusbarTooltipIcon);
3567  			_statusbarTooltipIcon = nullptr;
3568  		}
3569  		if (!_statusbarTooltipIcon)
3570  			_statusbarTooltipIcon = (HICON)::LoadImage(_hInst, MAKEINTRESOURCE(IDI_GET_INFO_FROM_TOOLTIP), IMAGE_ICON, s, s, 0);
3571  		if (_statusbarTooltipIcon)
3572  		{
3573  			_statusbarTooltipIconSize = s;
3574  			rect.left = rect.left + size.cx + s / 2;
3575  			rect.top  = (rect.top + rect.bottom - s) / 2;
3576  			DrawIconEx (lpDrawItemStruct->hDC, rect.left, rect.top, _statusbarTooltipIcon, s, s, 0, NULL, DI_NORMAL);
3577  			if (!_statusbarTooltipWnd)
3578  			{
3579  				rect.right = rect.left + s;
3580  				rect.bottom = rect.top + s;
3581  				_statusbarTooltipWnd = CreateToolTipRect(1, _statusBar.getHSelf(), _hInst, const_cast<PTSTR>(_statusbarTooltipMsg.c_str()), rect);
3582  				NppDarkMode::setDarkTooltips(_statusbarTooltipWnd, NppDarkMode::ToolTipsType::tooltip);
3583  			}
3584  		}
3585  		else
3586  		{
3587  			_statusbarTooltipIconSize = 0;
3588  		}
3589  	}
3590  }
3591  bool FindReplaceDlg::replaceInFilesConfirmCheck(generic_string directory, generic_string fileTypes)
3592  {
3593  	bool confirmed = false;
3594  	NativeLangSpeaker* pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
3595  	generic_string title = pNativeSpeaker->getLocalizedStrFromID("replace-in-files-confirm-title", TEXT("Are you sure?"));
3596  	generic_string msg = pNativeSpeaker->getLocalizedStrFromID("replace-in-files-confirm-directory", TEXT("Are you sure you want to replace all occurrences in :"));
3597  	msg += TEXT("\r\r");
3598  	msg += directory;
3599  	msg += TEXT("\r\r");
3600  	generic_string msg2 = pNativeSpeaker->getLocalizedStrFromID("replace-in-files-confirm-filetype", TEXT("For file type :"));
3601  	msg2 += TEXT("\r\r");
3602  	msg2 += fileTypes[0] ? fileTypes : TEXT("*.*");
3603  	msg += msg2;
3604  	int res = ::MessageBox(NULL, msg.c_str(), title.c_str(), MB_OKCANCEL | MB_DEFBUTTON2 | MB_TASKMODAL);
3605  	if (res == IDOK)
3606  	{
3607  		confirmed = true;
3608  	}
3609  	return confirmed;
3610  }
3611  bool FindReplaceDlg::replaceInProjectsConfirmCheck()
3612  {
3613  	bool confirmed = false;
3614  	NativeLangSpeaker* pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
3615  	generic_string title = pNativeSpeaker->getLocalizedStrFromID("replace-in-projects-confirm-title", TEXT("Are you sure?"));
3616  	generic_string msg = pNativeSpeaker->getLocalizedStrFromID("replace-in-projects-confirm-message", TEXT("Do you want to replace all occurrences in all documents in the selected Project Panel(s)?"));
3617  	int res = ::MessageBox(NULL, msg.c_str(), title.c_str(), MB_OKCANCEL | MB_DEFBUTTON2 | MB_TASKMODAL);
3618  	if (res == IDOK)
3619  	{
3620  		confirmed = true;
3621  	}
3622  	return confirmed;
3623  }
3624  bool FindReplaceDlg::replaceInOpenDocsConfirmCheck(void)
3625  {
3626  	bool confirmed = false;
3627  	NativeLangSpeaker* pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
3628  	generic_string title = pNativeSpeaker->getLocalizedStrFromID("replace-in-open-docs-confirm-title", TEXT("Are you sure?"));
3629  	generic_string msg = pNativeSpeaker->getLocalizedStrFromID("replace-in-open-docs-confirm-message", TEXT("Are you sure you want to replace all occurrences in all open documents?"));
3630  	int res = ::MessageBox(NULL, msg.c_str(), title.c_str(), MB_OKCANCEL | MB_DEFBUTTON2 | MB_TASKMODAL);
3631  	if (res == IDOK)
3632  	{
3633  		confirmed = true;
3634  	}
3635  	return confirmed;
3636  }
3637  generic_string Finder::getHitsString(int count) const
3638  {
3639  	NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
3640  	generic_string text = pNativeSpeaker->getLocalizedStrFromID("find-result-hits", TEXT(""));
3641  	if (text.empty())
3642  	{
3643  		if (count == 1)
3644  		{
3645  			text = TEXT("(1 hit)");
3646  		}
3647  		else
3648  		{
3649  			text = TEXT("(");
3650  			text += std::to_wstring(count);
3651  			text += TEXT(" hits)");
3652  		}
3653  	}
3654  	else
3655  	{
3656  		text = stringReplace(text, TEXT("$INT_REPLACE$"), std::to_wstring(count));
3657  	}
3658  	return text;
3659  }
3660  void Finder::addSearchLine(const TCHAR *searchName)
3661  {
3662  	NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
3663  	generic_string str = pNativeSpeaker->getLocalizedStrFromID("find-result-title", TEXT("Search"));
3664  	str += TEXT(" \"");
3665  	str += searchName;
3666  	str += TEXT("\" \r\n");
3667  	setFinderReadOnly(false);
3668  	_scintView.addGenericText(str.c_str());
3669  	setFinderReadOnly(true);
3670  	_lastSearchHeaderPos = _scintView.execute(SCI_GETCURRENTPOS) - 2;
3671  	_pMainFoundInfos->push_back(EmptyFoundInfo);
3672  	_pMainMarkings->push_back(EmptySearchResultMarking);
3673  	_previousLineNumber = -1;
3674  }
3675  void Finder::addFileNameTitle(const TCHAR * fileName)
3676  {
3677  	generic_string str = TEXT("  ");
3678  	str += fileName;
3679  	str += TEXT("\r\n");
3680  	setFinderReadOnly(false);
3681  	_scintView.addGenericText(str.c_str());
3682  	setFinderReadOnly(true);
3683  	_lastFileHeaderPos = _scintView.execute(SCI_GETCURRENTPOS) - 2;
3684  	_pMainFoundInfos->push_back(EmptyFoundInfo);
3685  	_pMainMarkings->push_back(EmptySearchResultMarking);
3686  	_previousLineNumber = -1;
3687  }
3688  void Finder::addFileHitCount(int count)
3689  {
3690  	wstring text = TEXT(" ");
3691  	text += getHitsString(count);
3692  	setFinderReadOnly(false);
3693  	_scintView.insertGenericTextFrom(_lastFileHeaderPos, text.c_str());
3694  	setFinderReadOnly(true);
3695  	++_nbFoundFiles;
3696  }
3697  void Finder::addSearchHitCount(int count, int countSearched, bool isMatchLines, bool searchedEntireNotSelection)
3698  {
3699  	generic_string nbResStr = std::to_wstring(count);
3700  	generic_string nbFoundFilesStr = std::to_wstring(_nbFoundFiles);
3701  	generic_string nbSearchedFilesStr = std::to_wstring(countSearched);
3702  	NativeLangSpeaker* pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
3703  	generic_string text = pNativeSpeaker->getLocalizedStrFromID(
3704  		searchedEntireNotSelection ? "find-result-title-info" : "find-result-title-info-selections",
3705  		TEXT(""));
3706  	if (text.empty())
3707  	{
3708  		generic_string hitsIn = count == 1 ? TEXT("hit") : TEXT("hits");
3709  		generic_string fileOrSelection = searchedEntireNotSelection ? TEXT("file") : TEXT("selection");;
3710  		if (_nbFoundFiles != 1)
3711  		{
3712  			fileOrSelection += TEXT("s");
3713  		}
3714  		text = TEXT("(") + nbResStr + TEXT(" ") + hitsIn + TEXT(" in ") + nbFoundFilesStr + TEXT(" ") +
3715  			fileOrSelection + TEXT(" of ") + nbSearchedFilesStr + TEXT(" searched") TEXT(")");
3716  	}
3717  	else
3718  	{
3719  		text = stringReplace(text, TEXT("$INT_REPLACE1$"), nbResStr);
3720  		text = stringReplace(text, TEXT("$INT_REPLACE2$"), nbFoundFilesStr);
3721  		text = stringReplace(text, TEXT("$INT_REPLACE3$"), nbSearchedFilesStr);
3722  	}
3723  	if (isMatchLines)
3724  	{
3725  		generic_string lineFilterModeInfo = pNativeSpeaker->getLocalizedStrFromID("find-result-title-info-extra", TEXT(" - Line Filter Mode: only display the filtered results"));
3726  		text += lineFilterModeInfo;
3727  	}
3728  	setFinderReadOnly(false);
3729  	_scintView.insertGenericTextFrom(_lastSearchHeaderPos, text.c_str());
3730  	setFinderReadOnly(true);
3731  }
3732  const char* Finder::foundLine(FoundInfo fi, SearchResultMarkingLine miLine, const TCHAR* foundline, size_t totalLineNumber)
3733  {
3734  	bool isRepeatedLine = false;
3735  	NppParameters& nppParam = NppParameters::getInstance();
3736  	NppGUI& nppGUI = nppParam.getNppGUI();
3737  	if (nppGUI._finderShowOnlyOneEntryPerFoundLine)
3738  	{
3739  		if (_previousLineNumber == -1)
3740  		{
3741  			_previousLineNumber = fi._lineNumber;
3742  		}
3743  		else if (_previousLineNumber == static_cast<intptr_t>(fi._lineNumber))
3744  		{
3745  			isRepeatedLine = true;
3746  		}
3747  		else 
3748  		{
3749  			_previousLineNumber = fi._lineNumber;
3750  		}
3751  	}
3752  	generic_string headerStr = TEXT("\t");
3753  	headerStr += _prefixLineStr;
3754  	headerStr += TEXT(" ");
3755  	size_t totalLineNumberDigit = static_cast<size_t>(nbDigitsFromNbLines(totalLineNumber) + 1);
3756  	size_t currentLineNumberDigit = static_cast<size_t>(nbDigitsFromNbLines(fi._lineNumber) + 1);
3757  	generic_string lineNumberStr = TEXT("");
3758  	lineNumberStr.append(totalLineNumberDigit - currentLineNumberDigit, ' ');
3759  	lineNumberStr.append(std::to_wstring(fi._lineNumber));
3760  	headerStr += lineNumberStr;
3761  	headerStr += TEXT(": ");
3762  	miLine._segmentPostions[0].first += headerStr.length();
3763  	miLine._segmentPostions[0].second += headerStr.length();
3764  	headerStr += foundline;
3765  	WcharMbcsConvertor& wmc = WcharMbcsConvertor::getInstance();
3766  	const char* text2AddUtf8 = wmc.wchar2char(headerStr.c_str(), SC_CP_UTF8, &miLine._segmentPostions[0].first, &miLine._segmentPostions[0].second); 
3767  	if (isRepeatedLine) 
3768  	{
3769  		_pMainMarkings->back()._segmentPostions.push_back(std::pair<intptr_t, intptr_t>(miLine._segmentPostions[0].first, miLine._segmentPostions[0].second));
3770  		_pMainFoundInfos->back()._ranges.push_back(fi._ranges.back());
3771  		return "";
3772  	}
3773  	else 
3774  	{
3775  		_pMainFoundInfos->push_back(fi);
3776  		size_t len = strlen(text2AddUtf8);
3777  		if (len >= SC_SEARCHRESULT_LINEBUFFERMAXLENGTH)
3778  		{
3779  			const char* endOfLongLine = " ...\r\n"; 
3780  			size_t lenEndOfLongLine = strlen(endOfLongLine);
3781  			size_t cut = SC_SEARCHRESULT_LINEBUFFERMAXLENGTH - lenEndOfLongLine - 1;
3782  			while ((cut > 0) && (!Utf8::isValid(&text2AddUtf8[cut], (int)(len - cut))))
3783  				cut--;
3784  			memcpy((void*)&text2AddUtf8[cut], endOfLongLine, lenEndOfLongLine + 1);
3785  			len = cut + lenEndOfLongLine;
3786  		}
3787  		_pMainMarkings->push_back(miLine);
3788  		return text2AddUtf8;
3789  	}
3790  }
3791  void Finder::removeAll()
3792  {
3793  	_pMainFoundInfos->clear();
3794  	_pMainMarkings->clear();
3795  	setFinderReadOnly(false);
3796  	_scintView.execute(SCI_CLEARALL);
3797  	setFinderReadOnly(true);
3798  }
3799  void Finder::openAll()
3800  {
3801  	for (auto&& path : getResultFilePaths())
3802  	{
3803  		::SendMessage(_hParent, WM_DOOPEN, 0, reinterpret_cast<LPARAM>(path.c_str()));
3804  	}
3805  }
3806  void Finder::copyPathnames()
3807  {
3808  	generic_string toClipboard;
3809  	for (auto&& path : getResultFilePaths())
3810  	{
3811  		toClipboard += path + TEXT("\r\n");
3812  	}
3813  	if (!toClipboard.empty())
3814  	{
3815  		if (!str2Clipboard(toClipboard, _hSelf))
3816  		{
3817  			assert(false);
3818  			::MessageBox(NULL, TEXT("Error placing pathnames into clipboard."), TEXT("Notepad++"), MB_ICONINFORMATION);
3819  		}
3820  	}
3821  }
3822  void Finder::wrapLongLinesToggle()
3823  {
3824  	_longLinesAreWrapped = !_longLinesAreWrapped;
3825  	_scintView.wrap(_longLinesAreWrapped);
3826  	if (!_canBeVolatiled)
3827  	{
3828  		NppParameters& nppParam = NppParameters::getInstance();
3829  		NppGUI& nppGUI = nppParam.getNppGUI();
3830  		nppGUI._finderLinesAreCurrentlyWrapped = _longLinesAreWrapped;
3831  	}
3832  }
3833  void Finder::purgeToggle()
3834  {
3835  	_purgeBeforeEverySearch = !_purgeBeforeEverySearch;
3836  	if (!_canBeVolatiled)
3837  	{
3838  		NppParameters& nppParam = NppParameters::getInstance();
3839  		NppGUI& nppGUI = nppParam.getNppGUI();
3840  		nppGUI._finderPurgeBeforeEverySearch = _purgeBeforeEverySearch;
3841  	}
3842  }
3843  bool Finder::isLineActualSearchResult(const generic_string & s) const
3844  {
3845  	return (s.find(TEXT("\t")) == 0);
3846  }
3847  generic_string & Finder::prepareStringForClipboard(generic_string & s) const
3848  {
3849  	s = stringReplace(s, TEXT("\r"), TEXT(""));
3850  	s = stringReplace(s, TEXT("\n"), TEXT(""));
3851  	const auto firstColon = s.find(TEXT(':'));
3852  	if (firstColon == std::string::npos)
3853  	{
3854  		assert(false);
3855  		return s;
3856  	}
3857  	else
3858  	{
3859  		s = s.substr(2 + firstColon);
3860  		return s;
3861  	}
3862  }
3863  void Finder::copy()
3864  {
3865  	if (_scintView.execute(SCI_GETSELECTIONS) > 1) 
3866  	{
3867  		return;
3868  	}
3869  	size_t fromLine = 0, toLine = 0;
3870  	{
3871  		const pair<size_t, size_t> lineRange = _scintView.getSelectionLinesRange();
3872  		fromLine = lineRange.first;
3873  		toLine = lineRange.second;
3874  		const int selectedLineFoldLevel = _scintView.execute(SCI_GETFOLDLEVEL, fromLine) & SC_FOLDLEVELNUMBERMASK;
3875  		toLine = _scintView.execute(SCI_GETLASTCHILD, toLine, selectedLineFoldLevel);
3876  	}
3877  	std::vector<generic_string> lines;
3878  	generic_string previousResultLineStr(TEXT(""));
3879  	for (size_t line = fromLine; line <= toLine; ++line)
3880  	{
3881  		generic_string lineStr = _scintView.getLine(line);
3882  		if (isLineActualSearchResult(lineStr))
3883  		{
3884  			if (lineStr != previousResultLineStr)
3885  			{
3886  				previousResultLineStr = lineStr;
3887  				lines.push_back(prepareStringForClipboard(lineStr));
3888  			}
3889  		}
3890  	}
3891  	const generic_string toClipboard = stringJoin(lines, TEXT("\r\n")) + TEXT("\r\n");
3892  	if (!toClipboard.empty())
3893  	{
3894  		if (!str2Clipboard(toClipboard, _hSelf))
3895  		{
3896  			assert(false);
3897  			::MessageBox(NULL, TEXT("Error placing text in clipboard."), TEXT("Notepad++"), MB_ICONINFORMATION);
3898  		}
3899  	}
3900  }
3901  void Finder::beginNewFilesSearch()
3902  {
3903  	NativeLangSpeaker* pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
3904  	_prefixLineStr = pNativeSpeaker->getLocalizedStrFromID("find-result-line-prefix", TEXT("Line"));
3905  	_scintView.execute(SCI_SETSEL, 0, 0);
3906  	_pMainFoundInfos = _pMainFoundInfos == &_foundInfos1 ? &_foundInfos2 : &_foundInfos1;
3907  	_pMainMarkings = _pMainMarkings == &_markings1 ? &_markings2 : &_markings1;
3908  	_nbFoundFiles = 0;
3909  	_scintView.collapse(searchHeaderLevel - SC_FOLDLEVELBASE, fold_collapse);
3910  }
3911  void Finder::finishFilesSearch(int count, int searchedCount, bool isMatchLines, bool searchedEntireNotSelection)
3912  {
3913  	std::vector<FoundInfo>* _pOldFoundInfos;
3914  	std::vector<SearchResultMarkingLine>* _pOldMarkings;
3915  	_pOldFoundInfos = _pMainFoundInfos == &_foundInfos1 ? &_foundInfos2 : &_foundInfos1;
3916  	_pOldMarkings = _pMainMarkings == &_markings1 ? &_markings2 : &_markings1;
3917  	_pOldFoundInfos->insert(_pOldFoundInfos->begin(), _pMainFoundInfos->begin(), _pMainFoundInfos->end());
3918  	_pOldMarkings->insert(_pOldMarkings->begin(), _pMainMarkings->begin(), _pMainMarkings->end());
3919  	_pMainFoundInfos->clear();
3920  	_pMainMarkings->clear();
3921  	_pMainFoundInfos = _pOldFoundInfos;
3922  	_pMainMarkings = _pOldMarkings;
3923  	_markingsStruct._length = static_cast<long>(_pMainMarkings->size());
3924  	if (_pMainMarkings->size() > 0)
3925  		_markingsStruct._markings = &((*_pMainMarkings)[0]);
3926  	addSearchHitCount(count, searchedCount, isMatchLines, searchedEntireNotSelection);
3927  	_scintView.execute(SCI_SETSEL, 0, 0);
3928  	char ptrword[sizeof(void*) * 2 + 1];
3929  	sprintf(ptrword, "%p", static_cast<void*>(&_markingsStruct));
3930  	_scintView.execute(SCI_SETPROPERTY, reinterpret_cast<WPARAM>("@MarkingsStruct"), reinterpret_cast<LPARAM>(ptrword));
3931  	_scintView.execute(SCI_SETPROPERTY, reinterpret_cast<WPARAM>("fold"), reinterpret_cast<LPARAM>("1"));
3932  	_previousLineNumber = -1;
3933  }
3934  void Finder::setFinderStyle()
3935  {
3936  	_scintView.performGlobalStyles();
3937  	NppDarkMode::setDarkScrollBar(_scintView.getHSelf());
3938  	const TCHAR * lexerName = ScintillaEditView::_langNameInfoArray[L_SEARCHRESULT]._langName;
3939  	LexerStyler *pStyler = (NppParameters::getInstance().getLStylerArray()).getLexerStylerByName(lexerName);
3940  	if (pStyler)
3941  	{
3942  		const Style * pStyle = pStyler->findByID(SCE_SEARCHRESULT_CURRENT_LINE);
3943  		if (pStyle)
3944  		{
3945  			_scintView.execute(SCI_SETELEMENTCOLOUR, SC_ELEMENT_CARET_LINE_BACK, pStyle->_bgColor);
3946  			_scintView.execute(SCI_SETCARETLINEFRAME, 0);
3947  			_scintView.execute(SCI_SETCARETLINEVISIBLEALWAYS, true);
3948  		}
3949  	}
3950  	_scintView.setSearchResultLexer();
3951  	StyleArray & stylers = NppParameters::getInstance().getMiscStylerArray();
3952  	Style * pStyleDefault = stylers.findByID(STYLE_DEFAULT);
3953  	if (pStyleDefault)
3954  	{
3955  		_scintView.setStyle(*pStyleDefault);
3956  		GlobalOverride & go = NppParameters::getInstance().getGlobalOverrideStyle();
3957  		if (go.isEnable())
3958  		{
3959  			const Style * pStyleGlobalOverride = stylers.findByName(TEXT("Global override"));
3960  			if (pStyleGlobalOverride)
3961  			{
3962  				if (go.enableFg)
3963  				{
3964  					pStyleDefault->_fgColor = pStyleGlobalOverride->_fgColor;
3965  				}
3966  				if (go.enableBg)
3967  				{
3968  					pStyleDefault->_bgColor = pStyleGlobalOverride->_bgColor;
3969  				}
3970  			}
3971  		}
3972  		_scintView.execute(SCI_STYLESETFORE, SCE_SEARCHRESULT_DEFAULT, pStyleDefault->_fgColor);
3973  		_scintView.execute(SCI_STYLESETBACK, SCE_SEARCHRESULT_DEFAULT, pStyleDefault->_bgColor);
3974  	}
3975  	_scintView.execute(SCI_COLOURISE, 0, -1);
3976  	ScintillaViewParams& svp = (ScintillaViewParams&)NppParameters::getInstance().getSVP();
3977  	_scintView.setMakerStyle(svp._folderStyle == FOLDER_STYLE_NONE ? FOLDER_STYLE_BOX : svp._folderStyle);
3978  }
3979  void Finder::setFinderStyleForNpc(bool onlyColor)
3980  {
3981  	NppParameters& nppParam = NppParameters::getInstance();
3982  	const bool isShown = nppParam.getSVP()._npcShow;
3983  	if (!onlyColor)
3984  	{
3985  		_scintView.showNpc(isShown, true);
3986  	}
3987  	else if (isShown)
3988  	{
3989  		_scintView.setNpcAndCcUniEOL();
3990  	}
3991  }
3992  intptr_t CALLBACK Finder::run_dlgProc(UINT message, WPARAM wParam, LPARAM lParam)
3993  {
3994  	switch (message)
3995  	{
3996  		case WM_COMMAND :
3997  		{
3998  			switch (wParam)
3999  			{
4000  				case NPPM_INTERNAL_FINDINFINDERDLG:
4001  				{
4002  					::SendMessage(_hParent, NPPM_INTERNAL_FINDINFINDERDLG, reinterpret_cast<WPARAM>(this), 0);
4003  					return TRUE;
4004  				}
4005  				case NPPM_INTERNAL_REMOVEFINDER:
4006  				{
4007  					if (_canBeVolatiled)
4008  					{
4009  						::SendMessage(_hParent, NPPM_DMMHIDE, 0, reinterpret_cast<LPARAM>(_hSelf));
4010  						setClosed(true);
4011  					}
4012  					return TRUE;
4013  				}
4014  				case NPPM_INTERNAL_SCINTILLAFINDERCOLLAPSE :
4015  				{
4016  					_scintView.foldAll(fold_collapse);
4017  					return TRUE;
4018  				}
4019  				case NPPM_INTERNAL_SCINTILLAFINDERUNCOLLAPSE :
4020  				{
4021  					_scintView.foldAll(fold_uncollapse);
4022  					return TRUE;
4023  				}
4024  				case NPPM_INTERNAL_SCINTILLAFINDERCOPY :
4025  				{
4026  					copy();
4027  					return TRUE;
4028  				}
4029  				case NPPM_INTERNAL_SCINTILLAFINDERCOPYVERBATIM:
4030  				{
4031  					_scintView.execute(SCI_COPY);
4032  					return TRUE;
4033  				}
4034  				case NPPM_INTERNAL_SCINTILLAFINDERCOPYPATHS:
4035  				{
4036  					copyPathnames();
4037  					return TRUE;
4038  				}
4039  				case NPPM_INTERNAL_SCINTILLAFINDERSELECTALL :
4040  				{
4041  					_scintView.execute(SCI_SELECTALL);
4042  					return TRUE;
4043  				}
4044  				case NPPM_INTERNAL_SCINTILLAFINDERCLEARALL:
4045  				{
4046  					removeAll();
4047  					return TRUE;
4048  				}
4049  				case NPPM_INTERNAL_SCINTILLAFINDEROPENALL:
4050  				{
4051  					openAll();
4052  					return TRUE;
4053  				}
4054  				case NPPM_INTERNAL_SCINTILLAFINDERWRAP:
4055  				{
4056  					wrapLongLinesToggle();
4057  					return TRUE;
4058  				}
4059  				case NPPM_INTERNAL_SCINTILLAFINDERPURGE:
4060  				{
4061  					purgeToggle();
4062  					return TRUE;
4063  				}
4064  				default :
4065  				{
4066  					return FALSE;
4067  				}
4068  			}
4069  		}
4070  		case WM_CONTEXTMENU :
4071  		{
4072  			if (HWND(wParam) == _scintView.getHSelf())
4073  			{
4074  				POINT p;
4075  				::GetCursorPos(&p);
4076  				ContextMenu scintillaContextmenu;
4077  				vector<MenuItemUnit> tmp;
4078  				NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
4079  				generic_string findInFinder = pNativeSpeaker->getLocalizedStrFromID("finder-find-in-finder", TEXT("Find in these search results..."));
4080  				generic_string closeThis = pNativeSpeaker->getLocalizedStrFromID("finder-close-this", TEXT("Close these search results"));
4081  				generic_string collapseAll = pNativeSpeaker->getLocalizedStrFromID("finder-collapse-all", TEXT("Fold all"));
4082  				generic_string uncollapseAll = pNativeSpeaker->getLocalizedStrFromID("finder-uncollapse-all", TEXT("Unfold all"));
4083  				generic_string copyLines = pNativeSpeaker->getLocalizedStrFromID("finder-copy", TEXT("Copy Selected Line(s)"));
4084  				generic_string copyVerbatim = pNativeSpeaker->getLocalizedStrFromID("finder-copy-verbatim", TEXT("Copy"));
4085  				copyVerbatim += TEXT("\tCtrl+C");
4086  				generic_string copyPaths = pNativeSpeaker->getLocalizedStrFromID("finder-copy-paths", TEXT("Copy Pathname(s)"));
4087  				generic_string selectAll = pNativeSpeaker->getLocalizedStrFromID("finder-select-all", TEXT("Select all"));
4088  				selectAll += TEXT("\tCtrl+A");
4089  				generic_string clearAll = pNativeSpeaker->getLocalizedStrFromID("finder-clear-all", TEXT("Clear all"));
4090  				generic_string purgeForEverySearch = pNativeSpeaker->getLocalizedStrFromID("finder-purge-for-every-search", TEXT("Purge for every search"));
4091  				generic_string openAll = pNativeSpeaker->getLocalizedStrFromID("finder-open-all", TEXT("Open all"));
4092  				generic_string wrapLongLines = pNativeSpeaker->getLocalizedStrFromID("finder-wrap-long-lines", TEXT("Word wrap long lines"));
4093  				tmp.push_back(MenuItemUnit(NPPM_INTERNAL_FINDINFINDERDLG, findInFinder));
4094  				if (_canBeVolatiled)
4095  					tmp.push_back(MenuItemUnit(NPPM_INTERNAL_REMOVEFINDER, closeThis));
4096  				tmp.push_back(MenuItemUnit(0, TEXT("Separator")));
4097  				tmp.push_back(MenuItemUnit(NPPM_INTERNAL_SCINTILLAFINDERCOLLAPSE, collapseAll));
4098  				tmp.push_back(MenuItemUnit(NPPM_INTERNAL_SCINTILLAFINDERUNCOLLAPSE, uncollapseAll));
4099  				tmp.push_back(MenuItemUnit(0, TEXT("Separator")));
4100  				tmp.push_back(MenuItemUnit(NPPM_INTERNAL_SCINTILLAFINDERCOPYVERBATIM, copyVerbatim));
4101  				tmp.push_back(MenuItemUnit(NPPM_INTERNAL_SCINTILLAFINDERCOPY, copyLines));
4102  				tmp.push_back(MenuItemUnit(NPPM_INTERNAL_SCINTILLAFINDERCOPYPATHS, copyPaths));
4103  				tmp.push_back(MenuItemUnit(NPPM_INTERNAL_SCINTILLAFINDERSELECTALL, selectAll));
4104  				tmp.push_back(MenuItemUnit(NPPM_INTERNAL_SCINTILLAFINDERCLEARALL, clearAll));
4105  				tmp.push_back(MenuItemUnit(0, TEXT("Separator")));
4106  				tmp.push_back(MenuItemUnit(NPPM_INTERNAL_SCINTILLAFINDEROPENALL, openAll));
4107  				tmp.push_back(MenuItemUnit(0, TEXT("Separator")));
4108  				tmp.push_back(MenuItemUnit(NPPM_INTERNAL_SCINTILLAFINDERWRAP, wrapLongLines));
4109  				tmp.push_back(MenuItemUnit(NPPM_INTERNAL_SCINTILLAFINDERPURGE, purgeForEverySearch));
4110  				scintillaContextmenu.create(_hSelf, tmp);
4111  				bool hasSomeSelectedText = _scintView.getSelectedTextCount() > 0;
4112  				scintillaContextmenu.enableItem(NPPM_INTERNAL_SCINTILLAFINDERCOPYVERBATIM, hasSomeSelectedText);
4113  				scintillaContextmenu.enableItem(NPPM_INTERNAL_SCINTILLAFINDERCLEARALL, !_canBeVolatiled);
4114  				scintillaContextmenu.enableItem(NPPM_INTERNAL_SCINTILLAFINDERPURGE, !_canBeVolatiled);
4115  				scintillaContextmenu.checkItem(NPPM_INTERNAL_SCINTILLAFINDERPURGE, _purgeBeforeEverySearch && !_canBeVolatiled);
4116  				scintillaContextmenu.checkItem(NPPM_INTERNAL_SCINTILLAFINDERWRAP, _longLinesAreWrapped);
4117  				::TrackPopupMenu(scintillaContextmenu.getMenuHandle(),
4118  					NppParameters::getInstance().getNativeLangSpeaker()->isRTL() ? TPM_RIGHTALIGN | TPM_LAYOUTRTL : TPM_LEFTALIGN,
4119  					p.x, p.y, 0, _hSelf, NULL);
4120  				return TRUE;
4121  			}
4122  			return ::DefWindowProc(_hSelf, message, wParam, lParam);
4123  		}
4124  		case WM_SIZE :
4125  		{
4126  			RECT rc{};
4127  			getClientRect(rc);
4128  			_scintView.reSizeTo(rc);
4129  			break;
4130  		}
4131  		case WM_NOTIFY:
4132  		{
4133  			notify(reinterpret_cast<SCNotification *>(lParam));
4134  			return FALSE;
4135  		}
4136  		default :
4137  			return DockingDlgInterface::run_dlgProc(message, wParam, lParam);
4138  	}
4139  	return FALSE;
4140  }
4141  void FindIncrementDlg::init(HINSTANCE hInst, HWND hPere, FindReplaceDlg *pFRDlg, bool isRTL)
4142  {
4143  	Window::init(hInst, hPere);
4144  	if (!pFRDlg)
4145  		throw std::runtime_error("FindIncrementDlg::init : Parameter pFRDlg is null");
4146  	_pFRDlg = pFRDlg;
4147  	create(IDD_INCREMENT_FIND, isRTL);
4148  	_isRTL = isRTL;
4149  }
4150  void FindIncrementDlg::destroy()
4151  {
4152  	if (_pRebar)
4153  	{
4154  		_pRebar->removeBand(_rbBand.wID);
4155  		_pRebar = NULL;
4156  	}
4157  }
4158  void FindIncrementDlg::display(bool toShow) const
4159  {
4160  	if (!_pRebar)
4161  	{
4162  		Window::display(toShow);
4163  		return;
4164  	}
4165  	if (toShow)
4166  	{
4167  		::SetFocus(::GetDlgItem(_hSelf, IDC_INCFINDTEXT));
4168  		::SendDlgItemMessage(_hSelf, IDC_INCFINDTEXT, EM_SETSEL, 0, -1);
4169  	}
4170  	_pRebar->setIDVisible(_rbBand.wID, toShow);
4171  }
4172  intptr_t CALLBACK FindIncrementDlg::run_dlgProc(UINT message, WPARAM wParam, LPARAM &bsol;*lParam*/)
4173  {
4174  	switch (message)
4175  	{
4176  		case WM_CTLCOLOREDIT :
4177  		{
4178  			auto hdc = reinterpret_cast<HDC>(wParam);
4179  			if (NppDarkMode::isEnabled())
4180  			{
4181  				if (FSNotFound != getFindStatus())
4182  				{
4183  					return NppDarkMode::onCtlColorSofter(hdc);
4184  				}
4185  				else 
4186  				{
4187  					return NppDarkMode::onCtlColorError(hdc);
4188  				}
4189  			}
4190  			static HBRUSH hBrushBackground = CreateSolidBrush(BCKGRD_COLOR);
4191  			if (FSNotFound != getFindStatus())
4192  				return FALSE; 
4193  			SetTextColor(hdc, TXT_COLOR);
4194  			SetBkColor(hdc, BCKGRD_COLOR);
4195  			return reinterpret_cast<LRESULT>(hBrushBackground);
4196  		}
4197  		case WM_CTLCOLORDLG:
4198  		case WM_CTLCOLORSTATIC:
4199  		{
4200  			return NppDarkMode::onCtlColorDarker(reinterpret_cast<HDC>(wParam));
4201  		}
4202  		case WM_PRINTCLIENT:
4203  		{
4204  			if (NppDarkMode::isEnabled())
4205  			{
4206  				return TRUE;
4207  			}
4208  			break;
4209  		}
4210  		case NPPM_INTERNAL_REFRESHDARKMODE:
4211  		{
4212  			NppDarkMode::autoThemeChildControls(getHSelf());
4213  			return TRUE;
4214  		}
4215  		case WM_INITDIALOG:
4216  		{
4217  			NppDarkMode::autoSubclassAndThemeChildControls(getHSelf());
4218  			return TRUE;
4219  		}
4220  		case WM_COMMAND :
4221  		{
4222  			bool updateSearch = false;
4223  			bool forward = true;
4224  			bool advance = false;
4225  			bool updateHiLight = false;
4226  			bool updateCase = false;
4227  			switch (LOWORD(wParam))
4228  			{
4229  				case IDCANCEL :
4230  					(*(_pFRDlg->_ppEditView))->clearIndicator(SCE_UNIVERSAL_FOUND_STYLE_INC);
4231  					(*(_pFRDlg->_ppEditView))->getFocus();
4232  					display(false);
4233  					return TRUE;
4234  				case IDM_SEARCH_FINDINCREMENT:	
4235  					if (::GetFocus() != ::GetDlgItem(_hSelf, IDC_INCFINDTEXT))
4236  					{
4237  						HWND hFindTxt = ::GetDlgItem(_hSelf, IDC_INCFINDTEXT);
4238  						::PostMessage(_hSelf, WM_NEXTDLGCTL, reinterpret_cast<WPARAM>(hFindTxt), TRUE);
4239  						return TRUE;
4240  					}
4241  					[[fallthrough]];
4242  				case IDM_SEARCH_FINDPREV:		
4243  				case IDM_SEARCH_FINDNEXT:		
4244  				case IDC_INCFINDPREVOK:
4245  				case IDC_INCFINDNXTOK:
4246  				case IDOK:
4247  					updateSearch = true;
4248  					advance = true;
4249  					forward = (LOWORD(wParam) == IDC_INCFINDNXTOK) ||
4250  						(LOWORD(wParam) == IDM_SEARCH_FINDNEXT) ||
4251  						(LOWORD(wParam) == IDM_SEARCH_FINDINCREMENT) ||
4252  						((LOWORD(wParam) == IDOK) && !(GetKeyState(VK_SHIFT) & SHIFTED));
4253  					break;
4254  				case IDC_INCFINDMATCHCASE:
4255  					updateSearch = true;
4256  					updateCase = true;
4257  					updateHiLight = true;
4258  					break;
4259  				case IDC_INCFINDHILITEALL:
4260  					updateHiLight = true;
4261  					break;
4262  				case IDC_INCFINDTEXT:
4263  					if (HIWORD(wParam) == EN_CHANGE)
4264  					{
4265  						updateSearch = true;
4266  						updateHiLight = isCheckedOrNot(IDC_INCFINDHILITEALL);
4267  						updateCase = isCheckedOrNot(IDC_INCFINDMATCHCASE);
4268  						break;
4269  					}
4270  					[[fallthrough]];
4271  				default:
4272  					return FALSE;
4273  			}
4274  			FindOption fo;
4275  			fo._isWholeWord = false;
4276  			fo._incrementalType = advance ? NextIncremental : FirstIncremental;
4277  			fo._whichDirection = forward ? DIR_DOWN : DIR_UP;
4278  			fo._isMatchCase = (BST_CHECKED == ::SendDlgItemMessage(_hSelf, IDC_INCFINDMATCHCASE, BM_GETCHECK, 0, 0));
4279  			generic_string str2Search = getTextFromCombo(::GetDlgItem(_hSelf, IDC_INCFINDTEXT));
4280  			if (updateSearch)
4281  			{
4282  				FindStatus findStatus = FSFound;
4283  				bool isFound = _pFRDlg->processFindNext(str2Search.c_str(), &fo, &findStatus);
4284  				fo._str2Search = str2Search;
4285  				int nbCounted = _pFRDlg->processAll(ProcessCountAll, &fo);
4286  				setFindStatus(findStatus, nbCounted);
4287  				if (updateCase && !isFound)
4288  				{
4289  					Sci_CharacterRangeFull range = (*(_pFRDlg->_ppEditView))->getSelection();
4290  					(*(_pFRDlg->_ppEditView))->execute(SCI_SETSEL, static_cast<WPARAM>(-1), range.cpMin);
4291  				}
4292  			}
4293  			if (updateHiLight)
4294  			{
4295  				bool highlight = !str2Search.empty() &&
4296  					(BST_CHECKED == ::SendDlgItemMessage(_hSelf, IDC_INCFINDHILITEALL, BM_GETCHECK, 0, 0));
4297  				markSelectedTextInc(highlight, &fo);
4298  			}
4299  			return TRUE;
4300  		}
4301  		case WM_ERASEBKGND:
4302  		{
4303  			if (NppDarkMode::isEnabled())
4304  			{
4305  				RECT rcClient{};
4306  				GetClientRect(_hSelf, &rcClient);
4307  				::FillRect(reinterpret_cast<HDC>(wParam), &rcClient, NppDarkMode::getDarkerBackgroundBrush());
4308  				return TRUE;
4309  			}
4310  			else
4311  			{
4312  				HWND hParent = ::GetParent(_hSelf);
4313  				HDC winDC = (HDC)wParam;
4314  				POINT pt = { 0, 0 }, ptOrig = { 0, 0 };
4315  				::MapWindowPoints(_hSelf, hParent, &pt, 1);
4316  				::OffsetWindowOrgEx((HDC)wParam, pt.x, pt.y, &ptOrig);
4317  				LRESULT lResult = SendMessage(hParent, WM_ERASEBKGND, reinterpret_cast<WPARAM>(winDC), 0);
4318  				::SetWindowOrgEx(winDC, ptOrig.x, ptOrig.y, NULL);
4319  				return (BOOL)lResult;
4320  			}
4321  		}
4322  	}
4323  	return FALSE;
4324  }
4325  void FindIncrementDlg::markSelectedTextInc(bool enable, FindOption *opt)
4326  {
4327  	(*(_pFRDlg->_ppEditView))->clearIndicator(SCE_UNIVERSAL_FOUND_STYLE_INC);
4328  	if (!enable)
4329  		return;
4330  	Sci_CharacterRangeFull range = (*(_pFRDlg->_ppEditView))->getSelection();
4331  	if (range.cpMin == range.cpMax)
4332  		return;
4333  	TCHAR text2Find[FINDREPLACE_MAXLENGTH]{};
4334  	(*(_pFRDlg->_ppEditView))->getGenericSelectedText(text2Find, FINDREPLACE_MAXLENGTH, false);	
4335  	opt->_str2Search = text2Find;
4336  	_pFRDlg->markAllInc(opt);
4337  }
4338  void FindIncrementDlg::setFindStatus(FindStatus iStatus, int nbCounted)
4339  {
4340  	generic_string statusStr2Display;
4341  	static const TCHAR* const strFSNotFound = TEXT("Phrase not found");
4342  	static const TCHAR* const strFSTopReached = TEXT("Reached top of page, continued from bottom");
4343  	static const TCHAR* const strFSEndReached = TEXT("Reached end of page, continued from top");
4344  	NativeLangSpeaker* pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
4345  	if (nbCounted >= 0)
4346  	{
4347  		statusStr2Display = pNativeSpeaker->getLocalizedStrFromID("IncrementalFind-FSFound", TEXT(""));
4348  		if (statusStr2Display.empty())
4349  		{
4350  			TCHAR strFindFSFound[128] = TEXT("");
4351  			if (nbCounted == 1)
4352  				wsprintf(strFindFSFound, TEXT("%d match"), nbCounted);
4353  			else
4354  				wsprintf(strFindFSFound, TEXT("%s matches"), commafyInt(nbCounted).c_str());
4355  			statusStr2Display = strFindFSFound;
4356  		}
4357  		else
4358  		{
4359  			statusStr2Display = stringReplace(statusStr2Display, TEXT("$INT_REPLACE$"), std::to_wstring(nbCounted));
4360  		}
4361  	}
4362  	switch (iStatus)
4363  	{
4364  		case FindStatus::FSNotFound:
4365  			statusStr2Display = pNativeSpeaker->getLocalizedStrFromID("IncrementalFind-FSNotFound", strFSNotFound);
4366  			break;
4367  		case FindStatus::FSTopReached:
4368  			statusStr2Display = pNativeSpeaker->getLocalizedStrFromID("IncrementalFind-FSTopReached", strFSTopReached);
4369  			break;
4370  		case FindStatus::FSEndReached:
4371  			statusStr2Display = pNativeSpeaker->getLocalizedStrFromID("IncrementalFind-FSEndReached", strFSEndReached);
4372  			break;
4373  		case FindStatus::FSFound:
4374  			break;
4375  		default:
4376  			return; 
4377  	}
4378  	_findStatus = iStatus;
4379  	HWND hEditor = ::GetDlgItem(_hSelf, IDC_INCFINDTEXT);
4380  	::InvalidateRect(hEditor, NULL, TRUE);
4381  	::SendDlgItemMessage(_hSelf, IDC_INCFINDSTATUS, WM_SETTEXT, 0, reinterpret_cast<LPARAM>(statusStr2Display.c_str()));
4382  }
4383  void FindIncrementDlg::addToRebar(ReBar * rebar)
4384  {
4385  	if (_pRebar)
4386  		return;
4387  	_pRebar = rebar;
4388  	RECT client{};
4389  	getClientRect(client);
4390  	ZeroMemory(&_rbBand, REBARBAND_SIZE);
4391  	_rbBand.cbSize  = REBARBAND_SIZE;
4392  	_rbBand.fMask   = RBBIM_STYLE | RBBIM_CHILD | RBBIM_CHILDSIZE |
4393  					  RBBIM_SIZE | RBBIM_ID;
4394  	_rbBand.fStyle = RBBS_HIDDEN | RBBS_NOGRIPPER;
4395  	_rbBand.hwndChild	= getHSelf();
4396  	_rbBand.wID			= REBAR_BAR_SEARCH;	
4397  	_rbBand.cxMinChild	= 0;
4398  	_rbBand.cyIntegral	= 1;
4399  	_rbBand.cyMinChild	= _rbBand.cyMaxChild	= client.bottom-client.top;
4400  	_rbBand.cxIdeal		= _rbBand.cx			= client.right-client.left;
4401  	_pRebar->addBand(&_rbBand, true);
4402  	_pRebar->setGrayBackground(_rbBand.wID);
4403  }
4404  const TCHAR Progress::cClassName[] = TEXT("NppProgressClass");
4405  const TCHAR Progress::cDefaultHeader[] = TEXT("Operation progress...");
4406  const int Progress::cBackgroundColor = COLOR_3DFACE;
4407  const int Progress::cPBwidth = NppParameters::getInstance()._dpiManager.scaleX(550);
4408  const int Progress::cPBheight = NppParameters::getInstance()._dpiManager.scaleY(10);
4409  const int Progress::cBTNwidth = NppParameters::getInstance()._dpiManager.scaleX(80);
4410  const int Progress::cBTNheight = NppParameters::getInstance()._dpiManager.scaleY(25);
4411  volatile LONG Progress::refCount = 0;
4412  Progress::Progress(HINSTANCE hInst) : _hwnd(NULL), _hCallerWnd(NULL)
4413  {
4414  	if (::InterlockedIncrement(&refCount) == 1)
4415  	{
4416  		_hInst = hInst;
4417  		WNDCLASSEX wcex{};
4418  		wcex.cbSize = sizeof(wcex);
4419  		wcex.style = CS_HREDRAW | CS_VREDRAW;
4420  		wcex.lpfnWndProc = wndProc;
4421  		wcex.hInstance = _hInst;
4422  		wcex.hCursor = ::LoadCursor(NULL, IDC_ARROW);
4423  		wcex.hbrBackground = ::GetSysColorBrush(cBackgroundColor);
4424  		wcex.lpszClassName = cClassName;
4425  		::RegisterClassEx(&wcex);
4426  		INITCOMMONCONTROLSEX icex{};
4427  		icex.dwSize = sizeof(icex);
4428  		icex.dwICC = ICC_STANDARD_CLASSES | ICC_PROGRESS_CLASS;
4429  		::InitCommonControlsEx(&icex);
4430  	}
4431  }
4432  Progress::~Progress()
4433  {
4434  	close();
4435  	if (::InterlockedDecrement(&refCount) == 0)
4436  		::UnregisterClass(cClassName, _hInst);
4437  }
4438  HWND Progress::open(HWND hCallerWnd, const TCHAR* header)
4439  {
4440  	if (_hwnd)
4441  		return _hwnd;
4442  	_hActiveState = ::CreateEvent(NULL, TRUE, FALSE, NULL);
4443  	if (!_hActiveState)
4444  		return NULL;
4445  	if (!hCallerWnd)
4446  		return NULL;
4447  	_hCallerWnd = hCallerWnd;
4448  	for (HWND hwnd = _hCallerWnd; hwnd; hwnd = ::GetParent(hwnd))
4449  		::UpdateWindow(hwnd);
4450  	if (header)
4451  		wcscpy_s(_header, _countof(_header), header);
4452  	else
4453  		wcscpy_s(_header, _countof(_header), cDefaultHeader);
4454  	_hThread = ::CreateThread(NULL, 0, threadFunc, this, 0, NULL);
4455  	if (!_hThread)
4456  	{
4457  		::CloseHandle(_hActiveState);
4458  		return NULL;
4459  	}
4460  	::WaitForSingleObject(_hActiveState, INFINITE);
4461  	if (!_hwnd)
4462  	{
4463  		::WaitForSingleObject(_hThread, INFINITE);
4464  		::CloseHandle(_hThread);
4465  		::CloseHandle(_hActiveState);
4466  	}
4467  	return _hwnd;
4468  }
4469  void Progress::close()
4470  {
4471  	if (_hwnd)
4472  	{
4473  		::PostMessage(_hwnd, WM_CLOSE, 0, 0);
4474  		_hwnd = NULL;
4475  		::WaitForSingleObject(_hThread, INFINITE);
4476  		::CloseHandle(_hThread);
4477  		::CloseHandle(_hActiveState);
4478  	}
4479  	if (_hFont != nullptr)
4480  	{
4481  		::DeleteObject(_hFont);
4482  		_hFont = nullptr;
4483  	}
4484  }
4485  void Progress::setPercent(unsigned percent, const TCHAR* fileName, int nbHitsSoFar) const
4486  {
4487  	if (_hwnd)
4488  	{
4489  		::PostMessage(_hPBar, PBM_SETPOS, percent, 0);
4490  		::SendMessage(_hPathText, WM_SETTEXT, 0, reinterpret_cast<LPARAM>(fileName));
4491  		TCHAR str[16]{};
4492  		_itow(nbHitsSoFar, str, 10);
4493  		::SendMessage(_hRunningHitsText, WM_SETTEXT, 0, reinterpret_cast<LPARAM>(str));
4494  	}
4495  }
4496  void Progress::setInfo(const TCHAR* info, int nbHitsSoFar) const
4497  {
4498  	if (_hwnd)
4499  	{
4500  		::SendMessage(_hPathText, WM_SETTEXT, 0, reinterpret_cast<LPARAM>(info));
4501  		if (nbHitsSoFar != -1)
4502  		{
4503  			TCHAR str[16]{};
4504  			_itow(nbHitsSoFar, str, 10);
4505  			::SendMessage(_hRunningHitsText, WM_SETTEXT, 0, reinterpret_cast<LPARAM>(str));
4506  		}
4507  	}
4508  }
4509  DWORD WINAPI Progress::threadFunc(LPVOID data)
4510  {
4511  	Progress* pw = static_cast<Progress*>(data);
4512  	return (DWORD)pw->thread();
4513  }
4514  int Progress::thread()
4515  {
4516  	BOOL r = createProgressWindow();
4517  	::SetEvent(_hActiveState);
4518  	if (r)
4519  		return r;
4520  	MSG msg{};
4521  	while ((r = ::GetMessage(&msg, NULL, 0, 0)) != 0 && r != -1)
4522  	{
4523  		::TranslateMessage(&msg);
4524  		::DispatchMessage(&msg);
4525  	}
4526  	return r;
4527  }
4528  int Progress::createProgressWindow()
4529  {
4530  	DPIManager& dpiManager = NppParameters::getInstance()._dpiManager;
4531  	NativeLangSpeaker* pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
4532  	_hwnd = ::CreateWindowEx(
4533  		WS_EX_APPWINDOW | WS_EX_TOOLWINDOW | WS_EX_OVERLAPPEDWINDOW |
4534  			(pNativeSpeaker->isRTL() ? WS_EX_LAYOUTRTL : 0),
4535  		cClassName, _header, WS_POPUP | WS_CAPTION,
4536  		CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT,
4537  		NULL, NULL, _hInst, (LPVOID)this);
4538  	if (!_hwnd)
4539  		return -1;
4540  	const int paddedBorder = 3 * ::GetSystemMetrics(SM_CXPADDEDBORDER);
4541  	int widthPadding = dpiManager.scaleX(15) + paddedBorder;
4542  	int width = cPBwidth + widthPadding;
4543  	int textHeight = dpiManager.scaleY(20);
4544  	int progressBarPadding = dpiManager.scaleY(10);
4545  	int morePadding = dpiManager.scaleY(45);
4546  	int height = cPBheight + cBTNheight + textHeight + progressBarPadding + morePadding + paddedBorder;
4547  	POINT center{};
4548  	RECT callerRect{};
4549  	::GetWindowRect(_hCallerWnd, &callerRect);
4550  	center.x = (callerRect.left + callerRect.right) / 2;
4551  	center.y = (callerRect.top + callerRect.bottom) / 2;
4552  	int x = center.x - width / 2;
4553  	int y = center.y - height / 2;
4554  	::MoveWindow(_hwnd, x, y, width, height, TRUE);
4555  	int xStartPos = dpiManager.scaleX(5);
4556  	int yTextPos = dpiManager.scaleY(5);
4557  	auto ctrlWidth = width - widthPadding - xStartPos;
4558  	_hPathText = ::CreateWindowEx(0, TEXT("STATIC"), TEXT(""),
4559  		WS_CHILD | WS_VISIBLE | SS_PATHELLIPSIS,
4560  		xStartPos, yTextPos,
4561  		ctrlWidth, textHeight, _hwnd, NULL, _hInst, NULL);
4562  	generic_string hits = pNativeSpeaker->getLocalizedStrFromID("progress-hits-title", TEXT("Hits:"));
4563  	_hRunningHitsStaticText = ::CreateWindowEx(0, TEXT("STATIC"), hits.c_str(),
4564  		WS_CHILD | WS_VISIBLE | SS_RIGHT,
4565  		xStartPos, yTextPos + textHeight * 2,
4566  		75, textHeight, 
4567  		_hwnd, NULL, _hInst, NULL);
4568  	_hRunningHitsText = ::CreateWindowEx(0, TEXT("STATIC"), TEXT(""),
4569  		WS_CHILD | WS_VISIBLE,
4570  		xStartPos + 75 + 2, yTextPos + textHeight * 2,
4571  		dpiManager.scaleX(70), textHeight,
4572  		_hwnd, NULL, _hInst, NULL);
4573  	_hPBar = ::CreateWindowEx(0, PROGRESS_CLASS, TEXT("Progress Bar"),
4574  		WS_CHILD | WS_VISIBLE | PBS_SMOOTH,
4575  		xStartPos, yTextPos + textHeight,
4576  		ctrlWidth, cPBheight,
4577  		_hwnd, NULL, _hInst, NULL);
4578  	SendMessage(_hPBar, PBM_SETRANGE, 0, MAKELPARAM(0, 100));
4579  	NppDarkMode::setBorder(_hPBar, NppDarkMode::isEnabled()); 
4580  	NppDarkMode::disableVisualStyle(_hPBar, NppDarkMode::isEnabled());
4581  	if (NppDarkMode::isEnabled())
4582  	{
4583  		::SendMessage(_hPBar, PBM_SETBKCOLOR, 0, static_cast<LPARAM>(NppDarkMode::getBackgroundColor()));
4584  		::SendMessage(_hPBar, PBM_SETBARCOLOR, 0, static_cast<LPARAM>(NppDarkMode::getDarkerTextColor()));
4585  	}
4586  	generic_string cancel = pNativeSpeaker->getLocalizedStrFromID("progress-cancel-button", TEXT("Cancel"));
4587  	_hBtn = ::CreateWindowEx(0, TEXT("BUTTON"), cancel.c_str(),
4588  		WS_CHILD | WS_VISIBLE | BS_DEFPUSHBUTTON | BS_TEXT,
4589  		(width - cBTNwidth) / 2, yTextPos + textHeight + cPBheight + progressBarPadding,
4590  		cBTNwidth, cBTNheight,
4591  		_hwnd, NULL, _hInst, NULL);
4592  	if (_hFont == nullptr)
4593  	{
4594  		LOGFONT lf{ NppParameters::getDefaultGUIFont() };
4595  		_hFont = ::CreateFontIndirect(&lf);
4596  	}
4597  	if (_hFont != nullptr)
4598  	{
4599  		const auto& wpFont = reinterpret_cast<WPARAM>(_hFont);
4600  		::SendMessage(_hPathText, WM_SETFONT, wpFont, TRUE);
4601  		::SendMessage(_hRunningHitsStaticText, WM_SETFONT, wpFont, TRUE);
4602  		::SendMessage(_hRunningHitsText, WM_SETFONT, wpFont, TRUE);
4603  		::SendMessage(_hBtn, WM_SETFONT, wpFont, TRUE);
4604  	}
4605  	NppDarkMode::autoSubclassAndThemeChildControls(_hwnd);
4606  	NppDarkMode::setDarkTitleBar(_hwnd);
4607  	::ShowWindow(_hwnd, SW_SHOWNORMAL);
4608  	::UpdateWindow(_hwnd);
4609  	return 0;
4610  }
4611  LRESULT APIENTRY Progress::wndProc(HWND hwnd, UINT umsg, WPARAM wparam, LPARAM lparam)
4612  {
4613  	switch (umsg)
4614  	{
4615  		case WM_CREATE:
4616  		{
4617  			Progress* pw = static_cast<Progress*>(reinterpret_cast<LPCREATESTRUCT>(lparam)->lpCreateParams);
4618  			::SetWindowLongPtr(hwnd, GWLP_USERDATA, reinterpret_cast<LONG_PTR>(pw));
4619  			return 0;
4620  		}
4621  		case WM_CTLCOLORDLG:
4622  		{
4623  			if (NppDarkMode::isEnabled())
4624  			{
4625  				return NppDarkMode::onCtlColorDarker(reinterpret_cast<HDC>(wparam));
4626  			}
4627  			break;
4628  		}
4629  		case WM_CTLCOLORSTATIC:
4630  		{
4631  			if (NppDarkMode::isEnabled())
4632  			{
4633  				return NppDarkMode::onCtlColorDarker(reinterpret_cast<HDC>(wparam));
4634  			}
4635  			return reinterpret_cast<LRESULT>(::GetSysColorBrush(NULL_BRUSH));
4636  		}
4637  		case WM_PRINTCLIENT:
4638  		{
4639  			if (NppDarkMode::isEnabled())
4640  			{
4641  				return TRUE;
4642  			}
4643  			break;
4644  		}
4645  		case WM_ERASEBKGND:
4646  		{
4647  			if (NppDarkMode::isEnabled())
4648  			{
4649  				RECT rc{};
4650  				GetClientRect(hwnd, &rc);
4651  				::FillRect(reinterpret_cast<HDC>(wparam), &rc, NppDarkMode::getDarkerBackgroundBrush());
4652  			}
4653  			return TRUE;
4654  		}
4655  		case WM_SETFOCUS:
4656  		{
4657  			Progress* pw =	reinterpret_cast<Progress*>(static_cast<LONG_PTR>
4658  			(::GetWindowLongPtr(hwnd, GWLP_USERDATA)));
4659  			::SetFocus(pw->_hBtn);
4660  			return 0;
4661  		}
4662  		case WM_COMMAND:
4663  			if (HIWORD(wparam) == BN_CLICKED)
4664  			{
4665  				Progress* pw = reinterpret_cast<Progress*>(static_cast<LONG_PTR>(::GetWindowLongPtr(hwnd, GWLP_USERDATA)));
4666  				::ResetEvent(pw->_hActiveState);
4667  				::EnableWindow(pw->_hBtn, FALSE);
4668  				NativeLangSpeaker *pNativeSpeaker = (NppParameters::getInstance()).getNativeLangSpeaker();
4669  				generic_string info = pNativeSpeaker->getLocalizedStrFromID("progress-cancel-info", TEXT("Cancelling operation, please wait..."));
4670  				pw->setInfo(info.c_str());
4671  				return 0;
4672  			}
4673  			break;
4674  		case WM_DESTROY:
4675  			::PostQuitMessage(0);
4676  			return 0;
4677  	}
4678  	return ::DefWindowProc(hwnd, umsg, wparam, lparam);
4679  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from notepad-plus-plus-MDEwOlJlcG9zaXRvcnkzMzAxNDgxMQ==-flat-BabyGridWrapper.h</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from notepad-plus-plus-MDEwOlJlcG9zaXRvcnkzMzAxNDgxMQ==-flat-FindReplaceDlg.cpp</div>
                </div>
                <div class="column column_space"><pre><code>41  		cell.col = col;
42  		::SendMessage(_hSelf, BGM_DELETECELL, reinterpret_cast<WPARAM>(&cell), 0);
43  	};
</pre></code></div>
                <div class="column column_space"><pre><code>847  					findersInfo._findOption = _options;
848  					::SendMessage(_hParent, WM_FINDALL_INCURRENTFINDER, reinterpret_cast<WPARAM>(&findersInfo), 0);
849  					return TRUE;
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    