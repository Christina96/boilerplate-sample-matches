
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 27, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-btaserver.cpp</h3>
            <pre><code>1  #include "btaserver.h"
2  int TBTAServer::MnSeverity = 3;
3  int TBTAServer::ListItemsPerPage = 20;
4  int TBTAServer::DetailItemsPerPage = 10;
5  int TBTAServer::ListEventsPerPage = 10;
6  int64 TBTAServer::RootCouseTimeWnd = int64(24*3600) * int64(1000);  
7  int TBTAServer::RootCouseEventWnd = 300;
8  int64 TBTAServer::BoardTimeWnd = int64(4*3600) * int64(1000);  
9  int TBTAServer::BoardEventWnd = 5000;
10  int TBTAServer::MnBeforeCount = 5;
11  double TBTAServer::MxChiProb = 0.05;
12  double TBTAServer::MnChiVal = 0.01;
13  double TBTAServer::MnCorrProb = 0.001;
14  int TBTAServer::MnIpNumsPerPlot = 20;
15  int TBTAServer::GetTotalFq(const TIntPrV& IdFqV) {
16      int TotalFq = 0;
17      for (int IdFqN = 0; IdFqN < IdFqV.Len(); IdFqN++) {
18          TotalFq += IdFqV[IdFqN].Val2; }
19      return TotalFq;
20  }
21  TStr TBTAServer::TruncStr(const TStr& FullStr, const int& MxLen) {
22      if (FullStr.Len() > MxLen) {
23          return FullStr.GetSubStr(0, MxLen-1) + "...";
24      } else { return FullStr; }
25  }
26  TTm TBTAServer::GetBreakDate(const int& Days) const { 
27      TTm BreakDate = BtaEventBs->GetLastTime();
28      BreakDate.DelDays(Days);
29      return BreakDate;
30  }
31  void TBTAServer::GetIpNumEventCount(const int& IpNumId, const TTm& StartDate, 
32          const TTm& BreakDate, const TTm& EndDate, double& AvgCount, int& LastCount) const {
33      int OldCount = 0; LastCount = 0;
34      const TIntV& EventV = BtaCorrBs->GetIpNumEventV(IpNumId);
35      for (int EventN = 0; EventN < EventV.Len(); EventN++) {
36          TTm EventDate = BtaEventBs->GetEvent(EventV[EventN]).GetFirstTm();
37          if (EventDate < StartDate || EventDate > EndDate) { continue; }
38          if (EventDate < BreakDate) { OldCount++; }
39          else { LastCount++; }
40      }
41      const double NormFactor = TBtaLongProj::GetNormFact(StartDate, BreakDate, EndDate);
42      AvgCount = NormFactor * double(OldCount);
43  }
44  void TBTAServer::MakeEventsPage(const TIntV& EventV, const TStr& SortTypeStr,
45          const int& PageNum, TChA& HtmlChA) {
46      HtmlChA += "<h1>Alarms</h1>\n";                   
47      HtmlChA += TStr::Fmt("<p>Number of alarms: <b>%d</b> (severity > 2)<br>\n", EventV.Len());
48      TStr LatestAlarm = BtaEventBs->GetEvent(EventV.Last()).GetFirstTm().GetWebLogDateTimeStr();
49      HtmlChA += "Time of the latest alarm: <b>" + LatestAlarm + "</b><br>\n";
50      TStr OldestAlarm = BtaEventBs->GetEvent(EventV[0]).GetFirstTm().GetWebLogDateTimeStr();
51      HtmlChA += "Time of the oldest alarm: <b>" + OldestAlarm + "</b></p>\n";
52      TStr PlotFNm = TFile::GetUniqueFNm("img/EventPlot.plt");
53      PlotEventV("", EventV, PlotFNm);
54      PlotFNm.ChangeChAll('/', '-');
55      HtmlChA += "<p><img src=\"" + PlotFNm + ".png\"></p>";
56      HtmlChA += "<h2>List of recent alarms</h2>\n";
57      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/events?page=%d&sort=%s\">Previous</a>\n", PageNum-1, SortTypeStr.CStr()); }
58      HtmlChA += TStr::Fmt("<a href=\"/events?page=%d&sort=%s\">Next</a>\n", PageNum+1, SortTypeStr.CStr());
59      MakeEventList(EventV, true, PageNum, HtmlChA);
60      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/events?page=%d&sort=%s\">Previous</a>\n", PageNum-1, SortTypeStr.CStr()); }
61      HtmlChA += TStr::Fmt("<a href=\"/events?page=%d&sort=%s\">Next</a>\n", PageNum+1, SortTypeStr.CStr());
62  }
63  void TBTAServer::MakeEventPage(const int& EventId, TChA& HtmlChA) {
64      if (EventId < 0 || EventId >= BtaEventBs->GetEvents()) { 
65          HtmlChA += "<p>Wrong event Id!</p>"; return; }
66      HtmlChA += "<h1>Alarm statistics</h1>\n";       
67      EventStat(EventId, HtmlChA);
68      HtmlChA += "<p><a href=\"/event_full?id=" + 
69          TInt::GetStr(EventId) + "\">Show all fields</a></p>";
70      HtmlChA += "<h2>Pattern of related events</h2>\n";       
71      EventRootCause(EventId, HtmlChA);
72      HtmlChA += "<h2>Devices predicted to fail</h2>\n";
73      EventPredIpNums(EventId, HtmlChA);
74  }
75  void TBTAServer::MakeEventFullPage(const int& EventId, TChA& HtmlChA) {
76      HtmlChA += "<h1>Alarm database fields</h1>\n";       
77      HtmlChA += "<p><a href=\"/event?id=" + 
78          TInt::GetStr(EventId) + "\">Back to alarm statistics</a></p>";
79      EventFullStat(EventId, HtmlChA);
80  }
81  void TBTAServer::MakeIpNumPage(const int& IpNumId, TChA& HtmlChA) {
82      HtmlChA += "<h1>Device statistics</h1>\n";       
83      if (BtaCorrBs->IsIpNumId(IpNumId)) { 
84          TStr IpNumNm = BtaDevDefBs->GetIpNumNm(IpNumId);
85          HtmlChA += TStr::Fmt("<p><b>Device IP:</b> %s<br>\n", IpNumNm.CStr());
86          HtmlChA += TStr::Fmt("<b>Device project:</b> %s<br>\n", GetProjLink(IpNumId).CStr());
87          HtmlChA += TStr::Fmt("<b>Number of alarms:</b> %d</p>\n", BtaCorrBs->GetIpNumIdEvents(IpNumId));
88          HtmlChA += "<h2>Recent alarms</h2>\n";       
89          HtmlChA += TStr::Fmt("<p><a href=\"/d_events?id=%d\">Show all alarms</a></p>\n", IpNumId);
90          TIntV EventV = BtaCorrBs->GetIpNumEventV(IpNumId);
91          TStr PlotFNm = TFile::GetUniqueFNm("img/EventPlot.plt");
92          PlotEventV(BtaDevDefBs->GetIpNumNm(IpNumId), EventV, PlotFNm);
93          PlotFNm.ChangeChAll('/', '-');
94          HtmlChA += "<p><img src=\"" + PlotFNm + ".png\"></p>";
95          MakeEventList(EventV, false, 0, HtmlChA);
96          HtmlChA += "<h2>Correlated devices</h2>\n";       
97          IpNumDevCorrStat(IpNumId, HtmlChA);
98      } else {
99          HtmlChA += "<p><b>Device not in the database!</b></p>";                    
100      }   
101  }
102  void TBTAServer::MakeProjectPage(const int& ProjId, TChA& HtmlChA) {
103      HtmlChA += "<h1>Project statistics</h1>\n";
104      ShortProjStat(ProjId, HtmlChA);
105      HtmlChA += "<h2>Recent alarms</h2>\n";
106      HtmlChA += TStr::Fmt("<p><a href=\"/p_events?id=%d\">Show all alarms</a></p>\n", ProjId);
107      TIntV EventV = BtaCorrBs->GetProjEventV(ProjId);
108      TStr PlotFNm = TFile::GetUniqueFNm("img/EventPlot.plt");
109      PlotEventV(BtaDevDefBs->GetProjNm(ProjId), EventV, PlotFNm);
110      PlotFNm.ChangeChAll('/', '-');
111      HtmlChA += "<p><img src=\"" + PlotFNm + ".png\"></p>";
112      MakeEventList(EventV, false, 0, HtmlChA);
113      HtmlChA += "<h2>Devices predicted to fail</h2>\n";
114      EventShortPredIpNums(EventV.Last(), HtmlChA);
115  }
116  void TBTAServer::MakeIpNumEventsPage(const int& IpNumId, 
117          const TIntV& EventV, const int& PageNum, TChA& HtmlChA) {
118      HtmlChA += "<h1>Device's alarms</h1>\n";                   
119      ShortIpNumStat(IpNumId, HtmlChA);
120      HtmlChA += "<h2>List of alarms</h2>\n";                   
121      TStr LatestAlarm = BtaEventBs->GetEvent(EventV.Last()).GetFirstTm().GetWebLogDateTimeStr();
122      HtmlChA += "Time of the latest alarm: <b>" + LatestAlarm + "</b><br>\n";
123      TStr OldestAlarm = BtaEventBs->GetEvent(EventV[0]).GetFirstTm().GetWebLogDateTimeStr();
124      HtmlChA += "Time of the oldest alarm: <b>" + OldestAlarm + "</b></p>\n";
125      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/d_events?id=%d&page=%d\">Previous</a>\n", IpNumId, PageNum-1); }
126      HtmlChA += TStr::Fmt("<a href=\"/d_events?id=%d&page=%d\">Next</a>\n", IpNumId, PageNum+1);
127      MakeEventList(EventV, false, PageNum, HtmlChA);
128      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/d_events?id=%d&page=%d\">Previous</a>\n", IpNumId, PageNum-1); }
129      HtmlChA += TStr::Fmt("<a href=\"/d_events?id=%d&page=%d\">Next</a>\n", IpNumId, PageNum+1);
130  }
131  void TBTAServer::MakeProjEventsPage(const int& ProjId, const TIntV& EventV,
132          const int& PageNum, TChA& HtmlChA) {
133      HtmlChA += "<h1>Project's alarms</h1>\n";                   
134      ShortProjStat(ProjId, HtmlChA);
135      HtmlChA += "<h2>List of alarms</h2>\n";                   
136      TStr LatestAlarm = BtaEventBs->GetEvent(EventV.Last()).GetFirstTm().GetWebLogDateTimeStr();
137      HtmlChA += "Time of the latest alarm: <b>" + LatestAlarm + "</b><br>\n";
138      TStr OldestAlarm = BtaEventBs->GetEvent(EventV[0]).GetFirstTm().GetWebLogDateTimeStr();
139      HtmlChA += "Time of the oldest alarm: <b>" + OldestAlarm + "</b></p>\n";
140      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/p_events?id=%d&page=%d\">Previous</a>\n", ProjId, PageNum-1); }
141      HtmlChA += TStr::Fmt("<a href=\"/p_events?id=%d&page=%d\">Next</a>\n", ProjId, PageNum+1);
142      MakeEventList(EventV, false, PageNum, HtmlChA);
143      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/p_events?id=%d&page=%d\">Previous</a>\n", ProjId, PageNum-1); }
144      HtmlChA += TStr::Fmt("<a href=\"/p_events?id=%d&page=%d\">Next</a>\n", ProjId, PageNum+1);
145  }
146  void TBTAServer::MakeIpNumCorrEventPage(const int& IpNumId, 
147          const int& CorrIpNumId, const int& PageNum, TChA& HtmlChA) {
148      HtmlChA += "<h1>Alarms behind device-device correlation</h1>\n";
149      HtmlChA += "<h2>First device</h2>\n";
150      ShortIpNumStat(IpNumId, HtmlChA);
151      HtmlChA += "<h2>Second device</h2>\n";
152      ShortIpNumStat(CorrIpNumId, HtmlChA);
153      HtmlChA += "<h2>List of correlating alarms</h2>\n";
154      const TIntV& EventV = BtaCorrBs->GetIpNumEventV(IpNumId);
155      const TIntV& CorrEventV = BtaCorrBs->GetIpNumEventV(CorrIpNumId);
156      TStr PlotFNm = TFile::GetUniqueFNm("img/EventPlot.plt");
157      PlotEventV(BtaDevDefBs->GetIpNumNm(IpNumId), EventV, 
158          BtaDevDefBs->GetIpNumNm(CorrIpNumId), CorrEventV, PlotFNm);
159      PlotFNm.ChangeChAll('/', '-');
160      HtmlChA += "<p><img src=\"" + PlotFNm + ".png\"></p>";
161      if (BtaCorrBs->IsIpNumIdPrCorr(IpNumId, CorrIpNumId)) {
162          const TIntPrV& EventPrV = BtaCorrBs->GetIpNumCorrIpNumPrEventV(IpNumId, CorrIpNumId);
163          HtmlChA += TStr::Fmt("<p><b>Number of correlated alarm pairs:</b>%d</p>\n", EventPrV.Len());
164          if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/dd_events?page=%d&id=%d&corrid=%d\">Previous</a>\n", PageNum-1, IpNumId, CorrIpNumId); }
165          HtmlChA += TStr::Fmt("<a href=\"/dd_events?page=%d&id=%d&corrid=%d\">Next</a>\n", PageNum+1, IpNumId, CorrIpNumId);
166          MakeEventPrList(EventPrV, PageNum, HtmlChA);
167          if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/dd_events?page=%d&id=%d&corrid=%d\">Previous</a>\n", PageNum-1, IpNumId, CorrIpNumId); }
168          HtmlChA += TStr::Fmt("<a href=\"/dd_events?page=%d&id=%d&corrid=%d\">Next</a>\n", PageNum+1, IpNumId, CorrIpNumId);
169      }
170  }
171  void TBTAServer::MakeLongPage(const TIntV& SortProjIdV, 
172          const int& PageNum, const TStr& PeriodStr, TChA& HtmlChA) {
173      HtmlChA += "<h1>Projects with change trend</h1>\n";                   
174      if (PeriodStr == "week") { HtmlChA += "<p><b>[last week vs. history]</b>, "; } 
175      else { HtmlChA += "<p><a href=\"/long?period=week\">[last week vs. history]</a>, "; }
176      if (PeriodStr == "month") { HtmlChA += "<b>[last month vs. history]</b></p>"; }
177      else {HtmlChA += "<a href=\"/long?period=month\">[last month vs. history]</a></p>"; }
178      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/long?page=%d&period=%s\">Previous</a>\n", PageNum-1, PeriodStr.CStr()); }
179      HtmlChA += TStr::Fmt("<a href=\"/long?page=%d&period=%s\">Next</a>\n", PageNum+1, PeriodStr.CStr());
180      MakeLongProjList(SortProjIdV, PageNum, PeriodStr, HtmlChA);
181      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/long?page=%d&period=%s\">Previous</a>\n", PageNum-1, PeriodStr.CStr()); }
182      HtmlChA += TStr::Fmt("<a href=\"/long?page=%d&period=%s\">Next</a>\n", PageNum+1, PeriodStr.CStr());    
183  }
184  void TBTAServer::MakeProjLongPage(const int& ProjId,
185          const int& PageNum, const TStr& PeriodStr, TChA& HtmlChA) {
186      HtmlChA += "<h1>Devices with change trends</h1>\n";                   
187      ShortProjStat(ProjId, HtmlChA, true);
188      HtmlChA += "<h2>List of device trends</h2>\n";                   
189      if (PeriodStr == "week") { HtmlChA += "<p><b>[last week vs. history]</b>, "; } 
190      else { HtmlChA += TStr::Fmt("<p><a href=\"/p_long?id=%d&period=week\">[last week vs. history]</a>, ", ProjId); }
191      if (PeriodStr == "month") { HtmlChA += "<b>[last month vs. history]</b></p>"; }
192      else {HtmlChA += TStr::Fmt("<a href=\"/p_long?id=%d&period=month\">[last month vs. history]</a></p>", ProjId); }
193      TStr PlotFNm = TFile::GetUniqueFNm("IpNum.plt");
194      TTm StartDate = BtaEventBs->GetFirstTime();
195      TTm BreakDate = GetBreakDate(PeriodStr == "week" ? 7 : 30);
196      TTm EndDate = BtaEventBs->GetLastTime();
197      PlotLongIpNum(BtaDevDefBs->GetProjNm(ProjId), PlotFNm, ProjId, 
198          StartDate, BreakDate, EndDate, PeriodStr, MnIpNumsPerPlot, true);
199      HtmlChA += "<p><img src=\"" + PlotFNm + ".png\"></p>";
200      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/p_long?id=%d&page=%d&period=%s\">Previous</a>\n", ProjId, PageNum-1, PeriodStr.CStr()); }
201      HtmlChA += TStr::Fmt("<a href=\"/p_long?id=%d&page=%d&period=%s\">Next</a>\n", ProjId, PageNum+1, PeriodStr.CStr());
202      MakeLongIpNumList(ProjId, PageNum, PeriodStr, HtmlChA);
203      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/long?id=%d&page=%d&period=%s\">Previous</a>\n", ProjId, PageNum-1, PeriodStr.CStr()); }
204      HtmlChA += TStr::Fmt("<a href=\"/p_long?id=%d&page=%d&period=%s\">Next</a>\n", ProjId, PageNum+1, PeriodStr.CStr());    
205  }
206  void TBTAServer::MakeShortEventPage(const int& EventId, TChA& HtmlChA) {
207  	EventShortStat(EventId, HtmlChA);
208      HtmlChA += "<hr>";
209      HtmlChA += "<b>Related Traps:</b><br>";
210      EventShortRootCause(EventId, HtmlChA);
211  }
212  void TBTAServer::MakeShortPredIpNumsPage(const int& EventId, TChA& HtmlChA) {
213  	EventShortStat(EventId, HtmlChA);
214      HtmlChA += "<hr>";
215      HtmlChA += "<b>Devices predicted to fail:</b><br>";
216      EventShortPredIpNums(EventId, HtmlChA);
217  }
218  void TBTAServer::MakeShortIpNumPage(const int& EventId, TChA& HtmlChA) {
219      const int IpNumId = BtaEventBs->GetEvent(EventId).GetIpNumId();
220      const TIntV& IpNumEventV = BtaCorrBs->GetIpNumEventV(IpNumId);
221  	EventShortStat(EventId, HtmlChA);
222      HtmlChA += "<hr>";
223      HtmlChA += "<b>Device event trend</b><br>";
224      TStr PlotFNm = TFile::GetUniqueFNm("img/EventPlot.plt");
225      PlotEventV("", IpNumEventV, PlotFNm, 500, 250);
226      PlotFNm.ChangeChAll('/', '-');
227      HtmlChA += "<img src=\"" + PlotFNm + ".png\"><br>";
228      HtmlChA += "<hr>";
229      HtmlChA += "<b>Recent events</b><br>";
230      MakeShortEventList(IpNumEventV, HtmlChA);
231  }
232  void TBTAServer::MakeBoardPage(const int& ProjCount, const int& RefreshTmSec, TChA& HtmlChA) {
233      HtmlChA += "<html><head>\n";
234      HtmlChA += "<title>Prediction Board</title>\n";
235      HtmlChA += "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\">\n";
236      HtmlChA += TStr::Fmt("<meta http-equiv=\"REFRESH\" content=\"%d;url=board?count=%d&refresh=%d\"></HEAD>", 
237          RefreshTmSec, ProjCount + 1, RefreshTmSec);
238      HtmlChA += "<link href=\"board.css\" type=\"text/css\" rel=\"stylesheet\">\n";
239      HtmlChA += "</head><body>\n";
240      TIntKdV AllProjIdFqV;
241      BtaEventBs->GetMostActiveProjs(BoardTimeWnd, 
242          BoardEventWnd, MnSeverity, AllProjIdFqV);
243      TFltIntKdV ScoreProjIdV; THash<TInt, TFltIntPrV> ProbIpNumIdVH;
244      const int MxPredIpNums = 2; const int MxProjs = 6;
245      for (int ProjIdN = 0; ProjIdN < AllProjIdFqV.Len(); ProjIdN++) {
246          const int ProjId = AllProjIdFqV[ProjIdN].Key;
247          const int LastEventN = BtaCorrBs->GetProjEventV(ProjId).Last();
248          TIntFltH IpNumIdProbH;
249          BtaCorrBs->GetNextIpNumIdProb(LastEventN, ProjId, 
250              BtaEventBs, 100, 600, IpNumIdProbH);
251          if (IpNumIdProbH.Empty()) { continue;}
252          TFltIntPrV ProbIpNumIdV; 
253          IpNumIdProbH.GetDatKeyPrV(ProbIpNumIdV); 
254          ProbIpNumIdV.Sort(false);        
255          if (ProbIpNumIdV.Len() > MxPredIpNums) { 
256              ProbIpNumIdV.Trunc(MxPredIpNums); }
257          ScoreProjIdV.Add(TFltIntKd(ProbIpNumIdV[0].Val1, ProjId));
258          ProbIpNumIdVH.AddDat(ProjId, ProbIpNumIdV);
259          if (ScoreProjIdV.Len() >= 2*MxProjs) { break; }
260      } 
261      ScoreProjIdV.Sort(false);
262      if (ScoreProjIdV.Len() > MxProjs) { ScoreProjIdV.Trunc(MxProjs); }
263      if (ScoreProjIdV.Len() > 0) {
264          const int SelProjIdN = ProjCount % ScoreProjIdV.Len();
265  	    HtmlChA += "<div class=\"window\">\n";
266    	    HtmlChA += "<div class=\"project_list\">\n";
267          for (int ProjIdN = 0; ProjIdN < ScoreProjIdV.Len(); ProjIdN++) {
268              const int ProjId = ScoreProjIdV[ProjIdN].Dat;
269              const TFltIntPrV& ProbIpNumIdV = ProbIpNumIdVH.GetDat(ProjId);
270              if (ProjIdN == SelProjIdN) { 
271      	        HtmlChA += "<div class=\"project selected\">\n";
272              } else {
273      	        HtmlChA += "<div class=\"project\">\n";
274              }
275              TStr ProjNm = BtaDevDefBs->GetProjNm(ProjId);
276  	        HtmlChA += "<div class=\"project_title\">" + ProjNm + "</div>\n";
277              for (int IpNumN = 0; IpNumN < ProbIpNumIdV.Len(); IpNumN++) {
278                  const int IpNumId = ProbIpNumIdV[IpNumN].Val2;
279                  TStr IpNumNm = BtaDevDefBs->GetIpNumNm(IpNumId);
280  	            HtmlChA += "<div class=\"project_device\">" + IpNumNm + "</div>\n";
281              }
282  	        HtmlChA += "</div>\n";
283          }
284          HtmlChA += "</div>\n";
285          HtmlChA += "<div class=\"project_details\">\n";
286          const int SelProjId = ScoreProjIdV[SelProjIdN].Dat;
287          TStr SelProjNm = BtaDevDefBs->GetProjNm(SelProjId);
288          HtmlChA += "<div class=\"project_detail_title\">" + SelProjNm + "</div>\n";
289          HtmlChA += "<div class=\"project_detail_hist\">\n";
290          const TIntV& ProjEventV = BtaCorrBs->GetProjEventV(SelProjId);
291          TStr PlotFNm = TFile::GetUniqueFNm("img/EventPlot.plt");
292          PlotEventV("", ProjEventV, PlotFNm, 680, 200); PlotFNm.ChangeChAll('/', '-');
293          HtmlChA += "<p><img src=\"" + PlotFNm + ".png\"></p>";
294          HtmlChA += "</div>\n";
295          HtmlChA += "<div class=\"project_detail_h2\">Last trap:</div>\n";
296          HtmlChA += "<div class=\"project_detail_event_list\">\n";
297          {
298              const int LastEventN = ProjEventV.Last();
299              const TBtaEvent& LastEvent = BtaEventBs->GetEvent(LastEventN);
300              TStr IpNumNm = BtaDevDefBs->GetIpNumNm(LastEvent.GetIpNumId());       
301              TBtaEventDat LastEventDat; 
302              BtaEventBs->GetEventDat(LastEvent.GetBlobPt(), LastEventDat);
303              HtmlChA += "<div class=\"project_detail_event\">\n";
304              HtmlChA += "<b>Device ID:</b> " + IpNumNm + "<br>\n";
305              HtmlChA += "<b>First Time:</b> " + LastEventDat.GetFirstTm() + "<br>\n";
306              HtmlChA += "<b>Last Time:</b> " + LastEventDat.GetLastTm() + "<br>\n";
307              HtmlChA += "<b>Severity:</b> " + LastEventDat.GetSeverity() + "<br>\n";
308              HtmlChA += "<b>Summary:</b> " + LastEventDat.GetSummary() + "\n";
309              HtmlChA += "</div>\n";
310          }
311          HtmlChA += "</div>\n";
312          HtmlChA += "<div class=\"project_detail_h2\">Devices predicted to fail:</div>\n";
313          HtmlChA += "<div class=\"project_detail_device_list\">\n";
314          const TFltIntPrV& ProbIpNumIdV = ProbIpNumIdVH.GetDat(SelProjId);
315          for (int IpNumN = 0; IpNumN < ProbIpNumIdV.Len(); IpNumN++) {
316              const int IpNumId = ProbIpNumIdV[IpNumN].Val2;
317              TStr IpNumNm = BtaDevDefBs->GetIpNumNm(IpNumId);       
318              HtmlChA += "<div class=\"project_detail_device\">\n";
319              HtmlChA += "<b>Device ID:</b> " + IpNumNm + "<br>\n";
320              const int LastEventN = BtaCorrBs->GetIpNumEventV(IpNumId).Last();
321              const TBtaEvent& LastEvent = BtaEventBs->GetEvent(LastEventN);
322              TBtaEventDat LastEventDat; 
323              BtaEventBs->GetEventDat(LastEvent.GetBlobPt(), LastEventDat);
324              HtmlChA += "<b>Last trap:</b> " + LastEventDat.GetFirstTm() + "<br>\n";
325              HtmlChA += "<b>Summary:</b> " + LastEventDat.GetSummary() + "\n";
326              HtmlChA += "</div>\n";
327          }
328          HtmlChA += "</div>\n";
329          HtmlChA += "</div>\n";
330      }
331  	HtmlChA += "</body></html>";
332  }
333  TStr TBTAServer::GetIpNumLink(const int& IpNumId) {
334      TStr IpNumNm = BtaDevDefBs->GetIpNumNm(IpNumId);
335      return TStr::Fmt("<a href=\"/device?id=%d\">%s</a>", IpNumId, IpNumNm.CStr());
336  } 
337  TStr TBTAServer::GetProjLink(const int& IpNumId) {
338      TStr ProjStr;
339      if (BtaCorrBs->IsIpNumProj(IpNumId)) {
340          const int ProjId = BtaCorrBs->GetIpNumProjId(IpNumId);
341          TStr ProjNm = BtaDevDefBs->GetProjNm(ProjId);
342          ProjStr += TStr::Fmt("<a href=\"/project?id=%d\">%s</a>", ProjId, ProjNm.CStr());
343      } else {
344          ProjStr = "&nbsp;";
345      }
346      return ProjStr;
347  } 
348  TStr TBTAServer::GetProjLinkFromProj(const int& ProjId) {
349      TStr ProjNm = BtaDevDefBs->GetProjNm(ProjId);
350      return TStr::Fmt("<a href=\"/project?id=%d\">%s</a>", ProjId, ProjNm.CStr());
351  } 
352  TStr TBTAServer::GetBar(const double& Val, const double& _MxVal) {
353      double MxVal = TFlt::GetMx(_MxVal, TFlt::Eps);
354      if (MxVal < 1.0) { MxVal *= 1.2; }
355      return TStr::Fmt("<div style=\"width: %d%%; background-color: #cc0033;\">&nbsp;</div>", 
356          TInt::GetMn(TFlt::Round(100.0 * Val / MxVal), 100));
357  }
358  void TBTAServer::EventStat(const int& EventId, TChA& HtmlChA) {
359      TBtaEvent Event = BtaEventBs->GetEvent(EventId);
360      TBtaEventDat EventDat; BtaEventBs->GetEventDat(Event.GetBlobPt(), EventDat);
361      HtmlChA += "<p><b>#</b> " + TInt(EventId+1).GetStr() + "</br>";
362      HtmlChA += "<b>NodeId:</b> " + EventDat.GetNodeId() + "<br>";
363      HtmlChA += "<b>First occurance:</b> " + EventDat.GetFirstTm() + "<br>";
364      HtmlChA += "<b>Last occurance:</b> " + EventDat.GetLastTm() + "<br>";
365      HtmlChA += "<b>IP:</b> " + GetIpNumLink(Event.GetIpNumId()) + "<br>";
366      HtmlChA += "<b>Case Id:</b> " + EventDat.GetIR() + "<br>";
367      HtmlChA += "<b>Severity:</b> " + EventDat.GetSeverity() + "<br>";
368      HtmlChA += "<b>Project:</b> " + GetProjLinkFromProj(Event.GetProjId()) + "<br>";
369      HtmlChA += "<b>Summary:</b> " + EventDat.GetSummary() + "</p>";
370  }
371  void TBTAServer::EventShortStat(const int& EventId, TChA& HtmlChA) {
372      TBtaEvent Event = BtaEventBs->GetEvent(EventId);
373      TBtaEventDat EventDat; BtaEventBs->GetEventDat(Event.GetBlobPt(), EventDat);
374  	HtmlChA += "<small><b>Trap " + TInt(EventId+1).GetStr() + ":</b></br>";
375  	HtmlChA += "<b>IP:</b> " + BtaDevDefBs->GetIpNumNm(Event.GetIpNumId()) + ", ";
376      HtmlChA += "<b>Severity:</b> " + EventDat.GetSeverity() + ", ";
377      HtmlChA += "<b>Project:</b> " + BtaDevDefBs->GetProjNm(Event.GetProjId()) + "<br>";
378      HtmlChA += "<b>Summary:</b> " + EventDat.GetSummary() + "</small><br>";
379  }
380  void TBTAServer::EventFullStat(const int& EventId, TChA& HtmlChA) {
381      TBtaEvent Event = BtaEventBs->GetEvent(EventId);
382      TBtaEventDat EventDat; BtaEventBs->GetEventDat(Event.GetBlobPt(), EventDat);
383      const TStrStrH& FldNmToValH = EventDat.FldNmToValH;
384      int KeyId = FldNmToValH.FFirstKeyId();
385      HtmlChA += "<p>";
386      while (FldNmToValH.FNextKeyId(KeyId)) {
387          TStr FldNm = FldNmToValH.GetKey(KeyId);
388          TStr FldVal = FldNmToValH[KeyId];
389          HtmlChA += "<b>" + FldNm + ":</b> " + FldVal + "<br>\n";
390      }
391      HtmlChA += "</p>";
392  }
393  void TBTAServer::EventRootCause(const int& EventId, TChA& HtmlChA) {
394      TIntFltKdV EventIdScoreV; TStrV CorrTypeV;
395      BtaCorrBs->EventRootCause(BtaEventBs, EventId, RootCouseEventWnd, 
396          RootCouseTimeWnd, EventIdScoreV, CorrTypeV);
397      HtmlChA += "<table border=\"1\">\n";
398      DisplayEventHeader(false, true, true, HtmlChA);
399      const int IpNumId = BtaEventBs->GetEvent(EventId).GetIpNumId();
400      for (int EventIdScoreN = 0; EventIdScoreN < EventIdScoreV.Len(); EventIdScoreN++) {
401          const int ScoreEventId = EventIdScoreV[EventIdScoreN].Key;
402          const double Score = EventIdScoreV[EventIdScoreN].Dat;
403          const int ScoreIpNumId = BtaEventBs->GetEvent(ScoreEventId).GetIpNumId();
404          TBtaEvent ScoreEvent = BtaEventBs->GetEvent(ScoreEventId);
405          TBtaEventDat ScoreEventDat; 
406          BtaEventBs->GetEventDat(ScoreEvent.GetBlobPt(), ScoreEventDat);
407          if (CorrTypeV[EventIdScoreN] == "Prob") {
408              DisplayEventRow(ScoreEventId, ScoreEvent, ScoreEventDat, 
409                  false, true, Score, 1.0, ScoreIpNumId, IpNumId, HtmlChA);
410          } else {
411              DisplayEventRow(ScoreEventId, ScoreEvent, ScoreEventDat, 
412                  false, true, Score, 1.0, ScoreIpNumId, -1, HtmlChA);
413          }
414      }
415      HtmlChA += "</table>\n";
416  }
417  void TBTAServer::EventShortRootCause(const int& EventId, TChA& HtmlChA) {
418      TIntFltKdV EventIdScoreV; TStrV CorrTypeV;
419      BtaCorrBs->EventRootCause(BtaEventBs, EventId, RootCouseEventWnd, 
420          RootCouseTimeWnd, EventIdScoreV, CorrTypeV);
421      HtmlChA += "<table border=\"1\">\n";
422      DisplayShortEventHeader(true, HtmlChA);
423      for (int EventIdScoreN = 0; EventIdScoreN < EventIdScoreV.Len(); EventIdScoreN++) {
424          const int ScoreEventId = EventIdScoreV[EventIdScoreN].Key;
425          const double Score = EventIdScoreV[EventIdScoreN].Dat;
426          TBtaEvent ScoreEvent = BtaEventBs->GetEvent(ScoreEventId);
427          TBtaEventDat ScoreEventDat; 
428          BtaEventBs->GetEventDat(ScoreEvent.GetBlobPt(), ScoreEventDat);
429          DisplayShortEventRow(ScoreEventId, ScoreEvent, 
430              ScoreEventDat, true, Score, 1.0, HtmlChA);
431      }
432      HtmlChA += "</table>\n";
433  }
434  void TBTAServer::EventPredIpNums(const int& EventId, TChA& HtmlChA) {
435      const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
436      const int CurrIpNumId = Event.GetIpNumId();
437      const int CurrProjId = Event.GetProjId();
438      TIntFltH IpNumIdProbH;
439      BtaCorrBs->GetNextIpNumIdProb(EventId, 
440          CurrProjId, BtaEventBs, 100, 600, IpNumIdProbH);
441      if (IpNumIdProbH.Empty()) { return; }
442      TFltIntPrV ProbIpNumIdV; IpNumIdProbH.GetDatKeyPrV(ProbIpNumIdV); ProbIpNumIdV.Sort(false);
443      HtmlChA += "<table border=\"1\">\n";
444      HtmlChA += "<tr>";
445      HtmlChA += "<td>#</td>";
446      HtmlChA += "<td>Device</td>";
447      HtmlChA += "<td>Probability</td>";
448      HtmlChA += "<td>Next alarm</td>";
449      HtmlChA += "</tr>\n";
450      double MxProb = 0.0; int ProbIpNumIdN = 0, RowCount = 0;
451      while (ProbIpNumIdN < ProbIpNumIdV.Len()) {
452          const int IpNumId = ProbIpNumIdV[ProbIpNumIdN].Val2; 
453          const int ProjId = BtaCorrBs->GetIpNumProjId(IpNumId);
454          ProbIpNumIdN++; if (ProjId != CurrProjId) { continue; }
455          const double Prob = ProbIpNumIdV[ProbIpNumIdN].Val1;
456          if (RowCount == 0) { MxProb = Prob; }
457          HtmlChA += "<tr>";
458          HtmlChA += "<td>" + TInt(RowCount+1).GetStr() + "</td>";
459          HtmlChA += "<td>" + GetIpNumLink(IpNumId) + " (" + GetProjLink(IpNumId) + ")</td>";
460          HtmlChA += "<td>" + GetBar(Prob, MxProb) + "</td>";
461          const int NextEventN = BtaEventBs->GetNextEvent(EventId+1, IpNumId);
462          if (NextEventN != -1) {
463              const TBtaEvent& NextEvent = BtaEventBs->GetEvent(NextEventN);
464              HtmlChA += TStr::Fmt("<td><a href=\"/event?id=%d\">%d</a></td>", NextEventN, NextEventN);
465          } else {
466              HtmlChA += "<td>--</td>";
467          }
468          HtmlChA += "</tr>\n";
469          RowCount++; if (RowCount >= 5) { break; }
470      }
471      HtmlChA += "</table>\n";
472  }
473  void TBTAServer::EventShortPredIpNums(const int& EventId, TChA& HtmlChA) {
474      const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
475      const int CurrIpNumId = Event.GetIpNumId();
476      const int CurrProjId = Event.GetProjId();
477      TIntFltH IpNumIdProbH;
478      BtaCorrBs->GetNextIpNumIdProb(EventId, 
479          CurrProjId, BtaEventBs, 100, 600, IpNumIdProbH);
480      if (IpNumIdProbH.Empty()) { return; }
481      TFltIntPrV ProbIpNumIdV; IpNumIdProbH.GetDatKeyPrV(ProbIpNumIdV); ProbIpNumIdV.Sort(false);
482      HtmlChA += "<table border=\"1\">\n";
483      HtmlChA += "<tr>";
484      HtmlChA += "<td>#</td>";
485      HtmlChA += "<td>Device</td>";
486      HtmlChA += "<td>Probability</td>";
487      HtmlChA += "</tr>\n";
488      double MxProb = 0.0; int ProbIpNumIdN = 0, RowCount = 0;
489      while (ProbIpNumIdN < ProbIpNumIdV.Len()) {
490          const int IpNumId = ProbIpNumIdV[ProbIpNumIdN].Val2; 
491          const int ProjId = BtaCorrBs->GetIpNumProjId(IpNumId);
492          ProbIpNumIdN++; if (ProjId != CurrProjId) { continue; }
493          const double Prob = ProbIpNumIdV[ProbIpNumIdN].Val1;
494          if (RowCount == 0) { MxProb = Prob; }
495          HtmlChA += "<tr>";
496          HtmlChA += "<td>" + TInt(RowCount+1).GetStr() + "</td>";
497          HtmlChA += "<td>" + GetIpNumLink(IpNumId) + " (" + GetProjLink(IpNumId) + ")</td>";
498          HtmlChA += "<td>" + GetBar(Prob, MxProb) + "</td>";
499          HtmlChA += "</tr>\n";
500          RowCount++; if (RowCount >= 5) { break; }
501      }
502      HtmlChA += "</table>\n";
503  }
504  void TBTAServer::DisplayEventHeader(const bool& HdSortP, 
505          const bool& ScoreP, const bool& LinkP, TChA& HtmlChA) {
506      HtmlChA += "<tr>";
507      if (HdSortP) {
508          HtmlChA += "<td># (<a href=\"/events?sort=all\">all</a>)</td>";
509          HtmlChA += "<td>First</td>";
510          HtmlChA += "<td>Last</td>";
511          HtmlChA += "<td>Device IP</td>";
512          HtmlChA += "<td>CaseID (<a href=\"/events?sort=case_id\">filter</a>)</td>";
513      } else { 
514          HtmlChA += "<td>#</td>";
515          HtmlChA += "<td>First</td>";
516          HtmlChA += "<td>Device IP</td>";
517          HtmlChA += "<td>CaseID (IR)</td>";
518      }
519      HtmlChA += "<td>Severity</td>";
520      HtmlChA += "<td>Project</td>";
521      HtmlChA += "<td width=\"250\">Summary</td>";
522      if (ScoreP) { HtmlChA += "<td>Score</td>"; }
523      if (LinkP) { HtmlChA += "<td></td>"; }
524      HtmlChA += "</tr>\n";
525  }
526  void TBTAServer::DisplayEventRow(const int& EventN, const TBtaEvent& Event, 
527          const TBtaEventDat& EventDat, const bool& HdSortP, const bool& ScoreP, 
528          const double& Score, const double& MxScore, const int& IpNumId, 
529          const int& CorrIpNumId, TChA& HtmlChA) {
530      HtmlChA += "<tr>";
531      HtmlChA += TStr::Fmt("<td><a href=\"/event?id=%d\">%d</a> ", EventN, EventN);
532      HtmlChA += TStr::Fmt("(<a onClick=\"window.open('/related_traps?id=%d\','omnibus_view','menubar=0,resizable=1,scrollbars=1,width=600,height=500');\">Omnibus</a>)</td>", EventN);
533      HtmlChA += "<td>" + EventDat.GetFirstTm() + "</td>";
534      if (HdSortP) { HtmlChA += "<td>" + EventDat.GetLastTm() + "</td>"; }
535      HtmlChA += "<td>" + GetIpNumLink(Event.GetIpNumId()) + "</td>";
536      HtmlChA += "<td>" + EventDat.GetIR() + "</td>";
537      HtmlChA += "<td>" + EventDat.GetSeverity() + "</td>";
538      HtmlChA += "<td>" + GetProjLinkFromProj(Event.GetProjId()) + "</td>";
539      HtmlChA += "<td><small>" + EventDat.GetSummary() + "</small></td>";
540      if (ScoreP) { 
541          HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(Score, MxScore).CStr()); 
542      }
543      if (IpNumId != -1 && CorrIpNumId != -1) {
544          HtmlChA += TStr::Fmt("<td><a href=\"/dd_events?id=%d&corrid=%d\">historic co-occucerence</a></td>",
545              IpNumId, CorrIpNumId);
546      } else if (IpNumId != -1 && CorrIpNumId == -1) {
547          HtmlChA += "<td>similar summary text</td>";
548      }
549      HtmlChA += "</tr>\n";
550  }
551  void TBTAServer::DisplayShortEventHeader(const bool& ScoreP, TChA& HtmlChA) {
552      HtmlChA += "<tr>";
553      HtmlChA += "<td>Trap</td>";
554      HtmlChA += "<td>Device</td>";
555      HtmlChA += "<td width=\"150\">Summary</td>";
556      if (ScoreP) { HtmlChA += "<td width=\"20\"></td>"; }
557      HtmlChA += "</tr>\n";
558  }
559  void TBTAServer::DisplayShortEventRow(const int& EventN, const TBtaEvent& Event, 
560          const TBtaEventDat& EventDat, const bool& ScoreP, const double& Score, 
561          const double& MxScore, TChA& HtmlChA) {
562      HtmlChA += "<tr>";
563      HtmlChA += "<td><a href=\"/related_traps?id=" + TInt::GetStr(EventN) + "\">" + 
564          TInt(EventN).GetStr() + "</a></td>";
565      HtmlChA += "<td>" + BtaDevDefBs->GetIpNumNm(Event.GetIpNumId()) + "</td>";
566      HtmlChA += "<td><small>" + EventDat.GetSummary() + "</small></td>";
567      if (ScoreP) { HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(Score, MxScore).CStr()); }
568      HtmlChA += "</tr>\n";
569  }
570  void TBTAServer::MakeEventList(const TIntV& EventV, 
571          const bool& HdSortP, const int& DispPageN, TChA& HtmlChA) {
572      HtmlChA += "<table border=\"1\">\n";
573      DisplayEventHeader(HdSortP, false, false, HtmlChA);
574      const int Events = EventV.Len(); 
575      int EventN = Events - DispPageN*ListEventsPerPage;
576      const int MnEventN = TInt::GetMx(Events - (DispPageN+1)*ListEventsPerPage, 0);
577      while (EventN > MnEventN) {
578          EventN--;
579          TBtaEvent Event = BtaEventBs->GetEvent(EventV[EventN]);
580          TBtaEventDat EventDat; BtaEventBs->GetEventDat(Event.GetBlobPt(), EventDat);
581          if (Event.GetIpNumId() != -1 && Event.GetProjId() != -1) {
582              DisplayEventRow(EventV[EventN], Event, 
583                  EventDat, HdSortP, false, 0.0, 0.1, -1, -1, HtmlChA);
584          } else { 
585              printf("Error: EventN == %d, IpNumId == %d, ProjId  == %d\n", 
<span onclick='openModal()' class='match'>586                  EventV[EventN].Val, Event.GetIpNumId(), Event.GetProjId()); 
587          }
588      }
589      HtmlChA += "</table>\n";
590  }
591  void TBTAServer::MakeEventPrList(const TIntPrV& EventPrV, const int& DispPageN, TChA& HtmlChA) {
</span>592      TIntIntVH EventIdIdVH; 
593      const int EventPrs = EventPrV.Len();
594      for (int EventPrN = 0; EventPrN < EventPrs; EventPrN++) {
595          const TIntPr& EventPr = EventPrV[EventPrs - EventPrN - 1];
596          EventIdIdVH.AddDat(EventPr.Val1).Add(EventPr.Val2);
597      }
598      HtmlChA += "<table border=\"1\">\n";
599      HtmlChA += "<tr>";
600      HtmlChA += "<td>#</td>";
601      HtmlChA += "<td>Time</td>";
602      HtmlChA += "<td>Device IP</td>";
603      HtmlChA += "<td>Summary</td>";
604      HtmlChA += "<td>Correlated with event sequence</td>";
605      HtmlChA += "</tr>\n";
606      const int Events = EventIdIdVH.Len(); 
607      int EventKeyId = EventIdIdVH.FFirstKeyId(), PageN = 0, EventsOnLastPage = 0;
608      while (EventIdIdVH.FNextKeyId(EventKeyId) && !(PageN > DispPageN)) {
609          if (PageN == DispPageN) {
610              const int EventId = EventIdIdVH.GetKey(EventKeyId);
611              TBtaEvent Event = BtaEventBs->GetEvent(EventId);
612              TBtaEventDat EventDat; BtaEventBs->GetEventDat(Event.GetBlobPt(), EventDat);
613              HtmlChA += "<tr valign=\"top\">";
614              HtmlChA += "<td><a href=\"/event?id=" + TInt::GetStr(EventId) + 
615                  "\">" + TInt(EventId).GetStr() + "</a></td>";
616              HtmlChA += "<td>" + EventDat.GetFirstTm() + "</td>";
617              HtmlChA += "<td>" + GetIpNumLink(Event.GetIpNumId()) + "</td>";
618              HtmlChA += "<td>" + TruncStr(EventDat.GetSummary(), 60) + "</td>";
619              HtmlChA += "<td>\n";
620              HtmlChA += "<table border=\"1\">";
621              HtmlChA += "<tr>";
622              HtmlChA += "<td>#</td>";
623              HtmlChA += "<td>Time</td>";
624              HtmlChA += "<td>Device IP</td>";
625              HtmlChA += "<td>Summary</td>";
626              HtmlChA += "</tr>\n";
627              const TIntV& CorrEventIdV = EventIdIdVH[EventKeyId];
628              for (int CorrEventIdN = 0; CorrEventIdN < CorrEventIdV.Len(); CorrEventIdN++) {
629                  const int CorrEventId = CorrEventIdV[CorrEventIdN];
630                  TBtaEvent CorrEvent = BtaEventBs->GetEvent(CorrEventId);
631                  TBtaEventDat CorrEventDat; BtaEventBs->GetEventDat(
632                      CorrEvent.GetBlobPt(), CorrEventDat);
633                  HtmlChA += "<tr valign=\"top\">";
634                  HtmlChA += "<td><a href=\"/event?id=" + TInt::GetStr(CorrEventId) + 
635                      "\">" + TInt(CorrEventId).GetStr() + "</a></td>";
636                  HtmlChA += "<td>" + CorrEventDat.GetFirstTm() + "</td>";
637                  HtmlChA += "<td>" + GetIpNumLink(CorrEvent.GetIpNumId()) + "</td>";
638                  HtmlChA += "<td>" + TruncStr(CorrEventDat.GetSummary(), 60) + "</td>";
639                  HtmlChA += "</tr>";
640              }
641              HtmlChA += "</table>\n";
642              HtmlChA += "</td></tr>\n";
643              HtmlChA += "<tr><td colspan=\"5\">&nbsp;</td></tr>";
644          }
645          EventsOnLastPage += EventIdIdVH[EventKeyId].Len();
646          if (EventsOnLastPage > ListEventsPerPage) { 
647              PageN++; EventsOnLastPage = 0; 
648          }
649      }
650      HtmlChA += "</table>\n";
651  }
652  void TBTAServer::MakeShortEventList(const TIntV& EventV, TChA& HtmlChA) {
653      HtmlChA += "<table border=\"1\">\n";
654      DisplayShortEventHeader(false, HtmlChA);
655      const int Events = TInt::GetMn(ListEventsPerPage, EventV.Len());
656      for (int EventN = 0; EventN < Events; EventN++) {
657          TBtaEvent Event = BtaEventBs->GetEvent(EventV[EventN]);
658          TBtaEventDat EventDat; BtaEventBs->GetEventDat(Event.GetBlobPt(), EventDat);
659          if (Event.GetIpNumId() != -1 && Event.GetProjId() != -1) {
660              DisplayShortEventRow(EventV[EventN], Event, EventDat, false, 0.0, 1.0, HtmlChA);
661          } else { 
662              printf("Error: EventN == %d, IpNumId == %d, ProjId  == %d\n", 
663                  EventV[EventN].Val, Event.GetIpNumId(), Event.GetProjId()); 
664          }
665      }
666      HtmlChA += "</table>\n";
667  }
668  void TBTAServer::IpNumDevCorrStat(const int& IpNumId, TChA& HtmlChA) {
669      TIntFltKdV CorrIpNumIdV;
670      BtaCorrBs->GetIpNumCorrDevices(IpNumId, true, DetailItemsPerPage, CorrIpNumIdV);
671      HtmlChA += "<table border=\"1\">\n";
672      HtmlChA += "<tr>";
673      HtmlChA += "<td>#</td>";
674      HtmlChA += "<td>Device</td>";
675      HtmlChA += "<td>Correlation</td>";
676      HtmlChA += "<td>When does it fire alarms?</td>";
677      HtmlChA += "</tr>\n";
678      for (int CorrIpNumIdN = 0; CorrIpNumIdN < CorrIpNumIdV.Len(); CorrIpNumIdN++) {
679          const int CorrIpNumId = CorrIpNumIdV[CorrIpNumIdN].Key;
680          const double CorrProb = TFlt::Abs(CorrIpNumIdV[CorrIpNumIdN].Dat);
681          const int Sign = TFlt::Sign(CorrIpNumIdV[CorrIpNumIdN].Dat);
682          const double MxCorrProb = TFlt::Abs(CorrIpNumIdV[0].Dat);
683          if (CorrProb < MnCorrProb) { break; }
684          HtmlChA += "<tr>";
685          HtmlChA += "<td>" + TInt(CorrIpNumIdN+1).GetStr() + "</td>";
686          HtmlChA += "<td>" + GetIpNumLink(CorrIpNumId) + " (" + GetProjLink(CorrIpNumId) + ")</td>";
687          HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(CorrProb, MxCorrProb).CStr());            
688          if (Sign > 0) { 
689              HtmlChA += TStr::Fmt("<td>after (<a href=\"/dd_events?id=%d&corrid=%d\">correlated alarms</a>)</td>",
690                  IpNumId, CorrIpNumId);
691          } else { 
692              HtmlChA += TStr::Fmt("<td>before (<a href=\"/dd_events?id=%d&corrid=%d\">correlated alarms</a>)</td>",
693                  CorrIpNumId, IpNumId);
694          }
695          HtmlChA += "</tr>\n";
696      }
697      HtmlChA += "</table>\n";
698  }
699  void TBTAServer::ShortIpNumStat(const int& IpNumId, TChA& HtmlChA) {
700      TStr IpNumNm = BtaDevDefBs->GetIpNumNm(IpNumId);
701      HtmlChA += TStr::Fmt("<p><b>Device IP:</b> %s<br>\n", 
702          GetIpNumLink(IpNumId).CStr());
703      HtmlChA += TStr::Fmt("<b>Device project:</b> %s<br>\n", 
704          GetProjLink(IpNumId).CStr());
705      HtmlChA += TStr::Fmt("<b>Number of alarms:</b> %d</p>\n", 
706          BtaCorrBs->GetIpNumIdEvents(IpNumId));
707  }
708  void TBTAServer::MakeIpNumPrList(const TIntV& DevKeyIdV, const int& DispPageN, TChA& HtmlChA) {
709      HtmlChA += "<table border=\"1\">\n";
710      HtmlChA += "<tr>";
711      HtmlChA += "<td>#</td>";
712      HtmlChA += "<td>First device</td>";
713      HtmlChA += "<td>Second device</td>";
714      HtmlChA += "<td>Correlation</td>";
715      HtmlChA += "<td></td>";
716      HtmlChA += "</tr>\n";
717      const TIntPrIntPrVH& IpNumIdPrToFqH = BtaCorrBs->GetIpNumIdPrH();
718      const TIntPr& FirstIpNumIdPr = IpNumIdPrToFqH.GetKey(DevKeyIdV[0]);
719      const double MxCorrProb = BtaCorrBs->ProbCorrIpNumIdGivenIpNumId(
720          FirstIpNumIdPr.Val1, FirstIpNumIdPr.Val2);
721      const int StartItemN = DispPageN*ListItemsPerPage;
722      const int EndItemN = (DispPageN+1)*ListItemsPerPage;
723      const int DevKeyIds = DevKeyIdV.Len();
724      int DevKeyIdN = 0, ItemN = 0; 
725      while (DevKeyIdN < DevKeyIds && ItemN < EndItemN) {
726          const TIntPr& IpNumIdPr = IpNumIdPrToFqH.GetKey(DevKeyIdV[DevKeyIdN]);
727          const int IpNumId = IpNumIdPr.Val1, CorrIpNumId = IpNumIdPr.Val2;
728          DevKeyIdN++;
729          if (IpNumId == CorrIpNumId) { continue; }
730          ItemN++; if (ItemN < StartItemN) { continue; }
731          HtmlChA += "<tr>";
732          HtmlChA += "<td>" + TInt(ItemN).GetStr() + "</td>";
733          HtmlChA += "<td>" + GetIpNumLink(IpNumId) + " (" + GetProjLink(IpNumId) + ")</td>";
734          HtmlChA += "<td>" + GetIpNumLink(CorrIpNumId) + " (" + GetProjLink(CorrIpNumId) + ")</td>";
735          if (BtaCorrBs->IsIpNumId(IpNumId)) {
736              const double CorrProb = BtaCorrBs->ProbCorrIpNumIdGivenIpNumId(IpNumId, CorrIpNumId);
737              HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(CorrProb, MxCorrProb).CStr());
738          } else {
739              HtmlChA += "<td></td>";
740          }
741          HtmlChA += TStr::Fmt("<td><a href=\"/dd_events?id=%d&corrid=%d\">correlated alarms</a></td>",
742              IpNumId, CorrIpNumId);
743          HtmlChA += "</tr>\n";
744      }
745      HtmlChA += "</table>\n";
746  }
747  void TBTAServer::ProjWithinCorrStat(const int& ProjId, TChA& HtmlChA) {
748      HtmlChA += "<table border=\"1\">\n";
749      HtmlChA += "<tr>";
750      HtmlChA += "<td>#</td>";
751      HtmlChA += "<td>First device</td>";
752      HtmlChA += "<td>Second device</td>";
753      HtmlChA += "<td>Correlation</td>";
754      HtmlChA += "<td></td>";
755      HtmlChA += "</tr>\n";
756      TIntPrFltKdV CorrIpNumIdPrProbV;
757      BtaCorrBs->GetProjCorrDevices(ProjId, 
758          DetailItemsPerPage, CorrIpNumIdPrProbV);
759      const int IpNumPrs = CorrIpNumIdPrProbV.Len();
760      if (IpNumPrs > 0) {
761          double MxCorrProb = CorrIpNumIdPrProbV[0].Dat;
762          for (int IpNumPrN = 0; IpNumPrN < IpNumPrs; IpNumPrN++) {
763              const int IpNumId = CorrIpNumIdPrProbV[IpNumPrN].Key.Val1;
764              const int CorrIpNumId = CorrIpNumIdPrProbV[IpNumPrN].Key.Val2;
765              const double CorrProb = CorrIpNumIdPrProbV[IpNumPrN].Dat;
766              if (CorrProb < MnCorrProb) { break; }
767              HtmlChA += "<tr>";
768              HtmlChA += "<td>" + TInt(IpNumPrN+1).GetStr() + "</td>";
769              HtmlChA += "<td>" + GetIpNumLink(IpNumId) + "</td>";
770              HtmlChA += "<td>" + GetIpNumLink(CorrIpNumId) + "</td>";
771              HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(CorrProb, MxCorrProb).CStr());
772              HtmlChA += TStr::Fmt("<td><a href=\"/dd_events?id=%d&corrid=%d\">correlated alarms</a></td>",
773                  IpNumId, CorrIpNumId);
774              HtmlChA += "</tr>\n";
775          }
776      }
777      HtmlChA += "</table>\n";
778  }
779  void TBTAServer::ShortProjStat(const int& ProjId, TChA& HtmlChA, const bool& ProjNmLinkP) {
780      TStr ProjNm = BtaDevDefBs->GetProjNm(ProjId);
781      if (!ProjNmLinkP) { 
782          HtmlChA += TStr::Fmt("<p>Project name: <b>%s</b></p>\n", 
783              ProjNm.CStr()); 
784      } else { 
785          HtmlChA += TStr::Fmt("<p>Project name: <b>%s</b></p>\n", 
786              GetProjLinkFromProj(ProjId).CStr()); 
787      }
788      int BeforeCount, WeekAfterCount, MonthAfterCount;
789      TTm StartDate = BtaEventBs->GetFirstTime(), EndDate = BtaEventBs->GetLastTime();
790      TTm WeekBreakDate = GetBreakDate(7), MonthBreakDate = GetBreakDate(30);
791      PBtaLongProj LongProj = BtaLongBs->GetLongProjFromId(ProjId);
792      LongProj->Count(StartDate, WeekBreakDate, EndDate, BeforeCount, WeekAfterCount);
793      LongProj->Count(StartDate, MonthBreakDate, EndDate, BeforeCount, MonthAfterCount);
794      const int TotalCount = BeforeCount + MonthAfterCount;
795      const bool IsWeekTrendPosP = LongProj->IsTrendPos(StartDate, WeekBreakDate, EndDate);
796      const bool IsMonthTrendPosP = LongProj->IsTrendPos(StartDate, MonthBreakDate, EndDate);
797      const double WeekChiProb = LongProj->ChiSquare(StartDate, WeekBreakDate, EndDate);
798      const double MonthChiProb = LongProj->ChiSquare(StartDate, MonthBreakDate, EndDate);  
799      HtmlChA += TStr::Fmt("</p>Number of alarms: <b>%d</b> (severity > 2)<br>\n", TotalCount);
800      if (WeekChiProb < 0.05) {
801          HtmlChA += TStr::Fmt("Number of alarms in last 7 days: <b>%d</b> (%s)<br>\n", 
802              WeekAfterCount, IsWeekTrendPosP ? "increasing" : "decreasing");
803      } else {
804          HtmlChA += TStr::Fmt("Number of alarms in last 7 days: <b>%d</b><br>\n", WeekAfterCount);
805      }
806      if (MonthChiProb < 0.05) {
807          HtmlChA += TStr::Fmt("Number of alarms in last 30 days: <b>%d</b> (%s)</p>\n", 
808              MonthAfterCount, IsMonthTrendPosP ? "increasing" : "decreasing");
809      } else {
810          HtmlChA += TStr::Fmt("Number of alarms in last 30 days: <b>%d</b></p>\n", MonthAfterCount);
811      }
812  }
813  void TBTAServer::MakeLongProjList(const TIntV& SortProjIdV, 
814          const int& DispPageN, const TStr& PeriodStr, TChA& HtmlChA) {
815      HtmlChA += "<table border=\"1\">\n";
816      HtmlChA += "<tr>";
817      HtmlChA += "<td>#</td>";
818      HtmlChA += "<td>Project</td>";
819      HtmlChA += "<td>Significance</td>";
820      HtmlChA += "<td></td>";
821      HtmlChA += "</tr>\n";
822      TTm StartDate = BtaEventBs->GetFirstTime();
823      TTm BreakDate = GetBreakDate(PeriodStr == "week" ? 7 : 30);
824      TTm EndDate = BtaEventBs->GetLastTime();
825      const int Projs = TInt::GetMn((DispPageN+1)*ListItemsPerPage, SortProjIdV.Len());
826      for (int ProjN = DispPageN*ListItemsPerPage; ProjN < Projs; ProjN++) {
827          const int ProjId = SortProjIdV[ProjN];
828          PBtaLongProj LongProj = BtaLongBs->GetLongProjFromId(ProjId);
829          const double ChiProb = MxChiProb - LongProj->ChiSquare(StartDate, BreakDate, EndDate);
830          int BeforeCount, AfterCount; LongProj->Count(
831              StartDate, BreakDate, EndDate, BeforeCount, AfterCount);
832          const bool IsTrendPosP = LongProj->IsTrendPos(StartDate, BreakDate, EndDate);
833          HtmlChA += "<tr>";
834          HtmlChA += TStr::Fmt("<td>%d</td>", ProjN + 1);
835          HtmlChA += TStr::Fmt("<td>%s</td>", GetProjLinkFromProj(ProjId).CStr());
836          HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(ChiProb, MxChiProb).CStr());
837          HtmlChA += TStr::Fmt("<td><a href=\"/p_long?id=%d&period=%s\">Show Details</td>",
838              ProjId, PeriodStr.CStr());
839          HtmlChA += "</tr>\n";
840      }
841      HtmlChA += "</table>\n";
842  }
843  void TBTAServer::MakeLongIpNumList(const int& ProjId, 
844          const int& DispPageN, const TStr& PeriodStr, TChA& HtmlChA) {
845      HtmlChA += "<table border=\"1\">\n";
846      HtmlChA += "<tr>";
847      HtmlChA += "<td>#</td>";
848      HtmlChA += "<td>Device IP</td>";
849      HtmlChA += "<td>Significance</td>";
850      HtmlChA += "<td>Avg. alarms</td>";
851      HtmlChA += "<td>In last " + PeriodStr + "</td>";
852      HtmlChA += "<td>Trend</td>";
853      HtmlChA += "</tr>\n";
854      TTm StartDate = BtaEventBs->GetFirstTime();
855      TTm BreakDate = GetBreakDate(PeriodStr == "week" ? 7 : 30);
856      TTm EndDate = BtaEventBs->GetLastTime();
857      PBtaLongProj LongProj = BtaLongBs->GetLongProjFromId(ProjId);
858      TIntFltKdV IpNumIdWgtV; LongProj->GetIpNumWgtV(StartDate, BreakDate, EndDate, IpNumIdWgtV);
859      const double MxIpNumWgt = IpNumIdWgtV[0].Dat;
860      const int IpNums = TInt::GetMn((DispPageN+1)*ListItemsPerPage, IpNumIdWgtV.Len());
861      for (int IpNumN = DispPageN*ListItemsPerPage; IpNumN < IpNums; IpNumN++) {
862          const int IpNumId = IpNumIdWgtV[IpNumN].Key;
863          const double IpNumWgt = IpNumIdWgtV[IpNumN].Dat;
864          if ((IpNumWgt / MxIpNumWgt) < MnChiVal) { break; }
865          double AvgCount; int LastCount; 
866          GetIpNumEventCount(IpNumId, StartDate, BreakDate, EndDate, AvgCount, LastCount);
867          const bool IsTrendPosP = (double(LastCount) > AvgCount);
868          HtmlChA += "<tr>";
869          HtmlChA += TStr::Fmt("<td>%d</td>", IpNumN + 1);
870          HtmlChA += TStr::Fmt("<td>%s</td>", GetIpNumLink(IpNumId).CStr());
871          HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(IpNumWgt, MxIpNumWgt).CStr());
872          HtmlChA += TStr::Fmt("<td>%.2f</td>", AvgCount);
873          HtmlChA += TStr::Fmt("<td>%d</td>", LastCount);
874          HtmlChA += TStr::Fmt("<td>%s</td>", IsTrendPosP ? "+" : "-");
875          HtmlChA += "</tr>\n";
876      }
877      HtmlChA += "</table>\n";
878  }
879  void TBTAServer::RunGnuPlot(const TStr& PlotFNm) const {
880    TStr GPPath = GnuPlotPath;
881    IAssertR(TFile::Exists(GPPath), TStr("GnuPlot not found at '")+GnuPlotPath+"'. Set TGnuPlot::GnuPlotPath.");
882    system(TStr::Fmt("%s %s", GPPath.CStr(), PlotFNm.CStr()).CStr());
883  }
884  void TBTAServer::PlotEventV(const TStr& TitleStr, const TIntV& EventV, 
885          const TStr& PlotFNm, const int& Width, const int& Height) {
886      TUInt64H DateCountH;
887      for (int EventIdN = 0; EventIdN < EventV.Len(); EventIdN++) {
888          const int EventId = EventV[EventIdN];
889          const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
890          TTm EventTm = Event.GetFirstTm();
891          TTm DayEventTm(EventTm.GetYear(), EventTm.GetMonth(), EventTm.GetDay());
892          DateCountH.AddDat(TTm::GetMSecsFromTm(DayEventTm))++;
893      }
894      TUInt64IntPrV DateCountV;
895      DateCountH.GetKeyDatPrV(DateCountV);
896      DateCountV.Sort(true);
897      int MxCount = 0;
898      {
899          TFOut DataFOut(PlotFNm + ".tab"); 
900          DataFOut.PutStrLn("# day count");
901          for (int DayN = 0; DayN < DateCountV.Len(); DayN++) {
902              MxCount = TInt::GetMx(MxCount, DateCountV[DayN].Val2); 
903              DataFOut.PutStrLn(TStr::Fmt("%d %d", DayN+1, DateCountV[DayN].Val2));
904          }
905          DataFOut.Flush();
906      }
907      double MxCountFlt = (double)MxCount * 1.15;
908      {
909          TFOut PlotFOut(PlotFNm);
910          PlotFOut.PutStrLn("# event plot");
911          PlotFOut.PutStrLn(TStr::Fmt("set autoscale"));
912          PlotFOut.PutStrLn(TStr::Fmt("set xrange [0:%d]", DateCountV.Len() + 1));
913          PlotFOut.PutStrLn(TStr::Fmt("set yrange [0:%.2f]", MxCountFlt));
914          PlotFOut.PutStrLn(TStr::Fmt("set terminal png large size %d,%d", Width, Height));
915          PlotFOut.PutStrLn(TStr::Fmt("set output '%s.png'", PlotFNm.CStr()));
916          PlotFOut.PutStrLn(TStr::Fmt("set boxwidth 0.8"));
917          PlotFOut.PutStr(TStr::Fmt("set xtics rotate  ( "));
918          const int Dates = DateCountV.Len() > 10 ? 10 : DateCountV.Len();
919          double DayDiff = double(DateCountV.Len()) / double(Dates);
920          for (int DateN = 0; DateN < Dates; DateN++) {
921              const int DayN = TFlt::Round(DateN * DayDiff);
922              IAssertR(0 <= DayN && DayN < DateCountV.Len(), TInt::GetStr(DayN));
923              const uint64 DateMSecs = DateCountV[DayN].Val1.Val;
924              TStr DateStr = TTm::GetTmFromMSecs(DateMSecs).GetWebLogDateStr();
925              if (DateN != 0) { PlotFOut.PutStr(", "); }
926              PlotFOut.PutStr(TStr::Fmt("\" %s\" %d", DateStr.CStr(), DayN+1));
927          }
928          PlotFOut.PutStrLn(")");
929          PlotFOut.PutStrLn("set xlabel \"Time\"");
930          PlotFOut.PutStrLn(TStr::Fmt("plot \"%s.tab\" using 1:2 title \"%s\" with boxes", 
931              PlotFNm.CStr(), TitleStr.CStr()));
932      }
933      RunGnuPlot(PlotFNm);
934  }
935  void TBTAServer::PlotEventV(const TStr& TitleStr, const TIntV& EventV, 
936          const TStr& CorrTitleStr, const TIntV& CorrEventV, const TStr& PlotFNm) {
937      TUInt64IntPrH DateCountH;
938      for (int EventIdN = 0; EventIdN < EventV.Len(); EventIdN++) {
939          const int EventId = EventV[EventIdN];
940          const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
941          TTm EventTm = Event.GetFirstTm();
942          TTm DayEventTm(EventTm.GetYear(), EventTm.GetMonth(), EventTm.GetDay());
943          DateCountH.AddDat(TTm::GetMSecsFromTm(DayEventTm)).Val1++;
944      }
945      for (int EventIdN = 0; EventIdN < CorrEventV.Len(); EventIdN++) {
946          const int EventId = CorrEventV[EventIdN];
947          const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
948          TTm EventTm = Event.GetFirstTm();
949          TTm DayEventTm(EventTm.GetYear(), EventTm.GetMonth(), EventTm.GetDay());
950          DateCountH.AddDat(TTm::GetMSecsFromTm(DayEventTm)).Val2++;
951      }
952      TUInt64IntPrPrV DateCountV;
953      DateCountH.GetKeyDatPrV(DateCountV);
954      DateCountV.Sort(true);
955      int MxCount = 0;
956      {
957          TFOut DataFOut(PlotFNm + ".tab"); 
958          DataFOut.PutStrLn("# day count");
959          for (int DayN = 0; DayN < DateCountV.Len(); DayN++) {
960              MxCount = TInt::GetMx(MxCount, DateCountV[DayN].Val2.Val1); 
961              MxCount = TInt::GetMx(MxCount, DateCountV[DayN].Val2.Val2); 
962              DataFOut.PutStrLn(TStr::Fmt("%d %d %d", DayN+1, 
963                  DateCountV[DayN].Val2.Val1, DateCountV[DayN].Val2.Val2));
964          }
965          DataFOut.Flush();
966      }
967      double MxCountFlt = (double)MxCount * 1.25;
968      {
969          TFOut PlotFOut(PlotFNm);
970          PlotFOut.PutStrLn("# event plot");
971          PlotFOut.PutStrLn(TStr::Fmt("set autoscale"));
972          PlotFOut.PutStrLn(TStr::Fmt("set xrange [0:%d]", DateCountV.Len() + 1));
973          PlotFOut.PutStrLn(TStr::Fmt("set yrange [0:%.2f]", MxCountFlt));
974          PlotFOut.PutStrLn(TStr::Fmt("set terminal png large size 700,300"));
975          PlotFOut.PutStrLn(TStr::Fmt("set output '%s.png'", PlotFNm.CStr()));
976          PlotFOut.PutStrLn(TStr::Fmt("set boxwidth 0.4"));
977          PlotFOut.PutStr(TStr::Fmt("set xtics rotate  ( "));
978          const int Dates = DateCountV.Len() > 10 ? 10 : DateCountV.Len();
979          double DayDiff = double(DateCountV.Len()) / double(Dates);
980          for (int DateN = 0; DateN < Dates; DateN++) {
981              const int DayN = TFlt::Round(DateN * DayDiff);
982              IAssertR(0 <= DayN && DayN < DateCountV.Len(), TInt::GetStr(DayN));
983              const uint64 DateMSecs = DateCountV[DayN].Val1.Val;
984              TStr DateStr = TTm::GetTmFromMSecs(DateMSecs).GetWebLogDateStr();
985              if (DateN != 0) { PlotFOut.PutStr(", "); }
986              PlotFOut.PutStr(TStr::Fmt("\" %s\" %d", DateStr.CStr(), DayN+1));
987          }
988          PlotFOut.PutStrLn(")");
989          PlotFOut.PutStrLn("set xlabel \"Time\"");
990          PlotFOut.PutStrLn("set ylabel \"Number of alarms\"");
991          PlotFOut.PutStr(TStr::Fmt("plot \"%s.tab\" using ($1-0.22):2 title \"%s\" with boxes, ", 
992              PlotFNm.CStr(), TitleStr.CStr()));
993          PlotFOut.PutStrLn(TStr::Fmt("\"%s.tab\" using ($1+0.22):3 title \"%s\" with boxes", 
994              PlotFNm.CStr(), CorrTitleStr.CStr()));
995      }
996      RunGnuPlot(PlotFNm);
997  }
998  void TBTAServer::PlotLongIpNum(const TStr& TitleStr, const TStr& PlotFNm,
999          const int& ProjId, const TTm& StartDate, const TTm& BreakDate, 
1000          const TTm& EndDate, const TStr& PeriodStr, const int& MxIpNums, 
1001          const bool& BigP) {
1002      PBtaLongProj LongProj = BtaLongBs->GetLongProjFromId(ProjId);
1003      TIntFltKdV IpNumIdWgtV; LongProj->GetIpNumWgtV(
1004          StartDate, BreakDate, EndDate, IpNumIdWgtV);
1005      if (IpNumIdWgtV.Len() > MxIpNums) { IpNumIdWgtV.Trunc(MxIpNums); }
1006      int MxCount = 0;
1007      {
1008          TFOut DataFOut(PlotFNm + ".tab"); 
1009          DataFOut.PutStrLn("# ipnum count");
1010          for (int IpNumN = 0; IpNumN < IpNumIdWgtV.Len(); IpNumN++) {
1011              const int IpNumId = IpNumIdWgtV[IpNumN].Key;
1012              double AvgCount; int LastCount; 
1013              GetIpNumEventCount(IpNumId, StartDate, 
1014                      BreakDate, EndDate, AvgCount, LastCount);
1015              MxCount = TInt::GetMx(MxCount, int(ceil(AvgCount))); 
1016              MxCount = TInt::GetMx(MxCount, LastCount); 
1017              DataFOut.PutStrLn(TStr::Fmt("%d %.2f %d", IpNumN+1, AvgCount, LastCount));
1018          }
1019          DataFOut.Flush();
1020      }
1021      double MxCountFlt = (double)MxCount * 1.25;
1022      {
1023          TFOut PlotFOut(PlotFNm);
1024          PlotFOut.PutStrLn("# event plot");
1025          PlotFOut.PutStrLn(TStr::Fmt("set autoscale"));
1026          PlotFOut.PutStrLn(TStr::Fmt("set xrange [0:%d]", IpNumIdWgtV.Len() + 1));
1027          PlotFOut.PutStrLn(TStr::Fmt("set yrange [0:%.2f]", MxCountFlt));
1028          if (BigP) { PlotFOut.PutStrLn(TStr::Fmt("set terminal png large size 700,300")); }
1029          else { PlotFOut.PutStrLn(TStr::Fmt("set terminal png large size 300,100")); }
1030          PlotFOut.PutStrLn(TStr::Fmt("set output '%s.png'", PlotFNm.CStr()));
1031          PlotFOut.PutStrLn(TStr::Fmt("set boxwidth 0.4"));
1032          if (BigP) {
1033              PlotFOut.PutStr(TStr::Fmt("set xtics rotate  ( "));
1034              for (int IpNumN = 0; IpNumN < IpNumIdWgtV.Len(); IpNumN++) {
1035                  const int IpNumId = IpNumIdWgtV[IpNumN].Key;
1036                  TStr IpNumStr = BtaEventBs->GetDevDefBs()->GetIpNumNm(IpNumId);
1037                  if (IpNumN != 0) { PlotFOut.PutStr(", "); }
1038                  PlotFOut.PutStr(TStr::Fmt("\" %s\" %d", IpNumStr.CStr(), IpNumN+1));
1039              }
1040              PlotFOut.PutStrLn(")");
1041          }
1042          PlotFOut.PutStrLn("set xlabel \"Time\"");
1043          PlotFOut.PutStrLn("set ylabel \"Number of alarms\"");
1044          TStr TitleStr = "Average", LastTitleStr = "In last " + PeriodStr;
1045          PlotFOut.PutStr(TStr::Fmt("plot \"%s.tab\" using ($1-0.22):2 title \"%s\" with boxes, ", 
1046              PlotFNm.CStr(), TitleStr.CStr()));
1047          PlotFOut.PutStrLn(TStr::Fmt("\"%s.tab\" using ($1+0.22):3 title \"%s\" with boxes", 
1048              PlotFNm.CStr(), LastTitleStr.CStr()));
1049      }
1050      RunGnuPlot(PlotFNm);    
1051  }
1052  int TBTAServer::ProcessNewBuffer() {
1053      TIntV EventIdV; BtaEventBs->AddNewBuffer(EventIdV);
1054      for (int EventIdN = 0; EventIdN < EventIdV.Len(); EventIdN++) {
1055          const int EventId = EventIdV[EventIdN];
1056          BtaCorrBs->AddEvent(BtaEventBs, EventId);
1057          const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
1058          if (Event.GetIpNumId() == -1 || Event.GetProjId() == -1) { continue; }
1059          if (Event.GetSeverity() < MnSeverity) { continue; }
1060          AllEventIdV.Add(EventId);
1061          if (Event.GetCaseId() == -1) { continue; }
1062          CaseIdEventIdV.Add(EventId);
1063      }
1064      TFOut LogFOut("btalarms.log", true);
1065      LogFOut.PutStrLn(TStr::Fmt("[%s] processed %d new alarms!", 
1066          TTm::GetCurLocTm().GetWebLogDateTimeStr().CStr(), EventIdV.Len()));
1067      return EventIdV.Len();
1068  }
1069  void TBTAServer::ProcessDumpBuffer() {
1070      ProcessNewBuffer();
1071      BtaEventBs->SaveBin(TFile::GetUniqueFNm(DumpFPath + "BTAlarms.bta"));
1072      BtaCorrBs->SaveBin(TFile::GetUniqueFNm(DumpFPath + "BTAlarms.btc"));
1073      BtaLongBs->SaveBin(TFile::GetUniqueFNm(DumpFPath + "BTAlarms.btl"));
1074      BtaEventBs->SaveDumpBuffer();
1075      TFOut LogFOut("btalarms.log", true);
1076      LogFOut.PutStrLn(TStr::Fmt("[%s] dump completed!", 
1077          TTm::GetCurLocTm().GetWebLogDateTimeStr().CStr()));
1078  }
1079  int TBTAServer::RescueFromDumpBuffer() {
1080      TIntV EventIdV; BtaEventBs->RescueDumpBuffer(EventIdV);
1081      for (int EventIdN = 0; EventIdN < EventIdV.Len(); EventIdN++) {
1082          const int EventId = EventIdV[EventIdN];
1083          BtaCorrBs->AddEvent(BtaEventBs, EventId);
1084          const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
1085          if (Event.GetIpNumId() == -1 || Event.GetProjId() == -1) { continue; }
1086          if (Event.GetSeverity() < MnSeverity) { continue; }
1087          AllEventIdV.Add(EventId);
1088          if (Event.GetCaseId() == -1) { continue; }
1089          CaseIdEventIdV.Add(EventId);
1090      }
1091      TFOut LogFOut("btalarms.log", true);
1092      LogFOut.PutStrLn(TStr::Fmt("[%s] rescued %d alarms!", 
1093          TTm::GetCurLocTm().GetWebLogDateTimeStr().CStr(), EventIdV.Len()));
1094      return EventIdV.Len();
1095  }
1096  void TBTAServer::SaveAndExit() {
1097      ProcessNewBuffer();
1098      BtaEventBs->SaveBin(BinFPath + "BTAlarms.bta");
1099      BtaCorrBs->SaveBin(BinFPath + "BTAlarms.btc");
1100      BtaLongBs->SaveBin(BinFPath + "BTAlarms.btl");
1101      BtaEventBs->SaveDumpBuffer();
1102      TFOut LogFOut("btalarms.log", true);
1103      LogFOut.PutStrLn(TStr::Fmt("[%s] save completed!", 
1104          TTm::GetCurLocTm().GetWebLogDateTimeStr().CStr()));
1105      ExitProcess(0);
1106  }
1107  TBTAServer::TBTAServer(const int& WebSrvPortN, const TStr& _BinFPath, 
1108          const TStr& _DumpFPath, const POdbcDb& OdbcDb, const TStr& _GnuPlotPath):   
1109              TWebSrv(WebSrvPortN, true, TNotify::StdNotify) {
1110      printf("Starting server \n");
1111      BinFPath = _BinFPath; DumpFPath = _DumpFPath; GnuPlotPath = _GnuPlotPath;
1112      BtaEventBs = TBtaEventBs::LoadBin(BinFPath + "BTAlarms.bta", OdbcDb);
1113      BtaDevDefBs = BtaEventBs->GetDevDefBs();
1114      BtaCorrBs = TBtaCorrBs::LoadBin(BinFPath + "BTAlarms.btc");
1115      BtaLongBs = TBtaLongBs::LoadBin(BinFPath + "BTAlarms.btl");
1116      RescueFromDumpBuffer();
1117      const int Events = BtaEventBs->GetEvents();
1118      printf(" No. of events: %d\n", Events);
1119      {printf("Loading events ");   
1120      for (int EventN = 0; EventN < Events; EventN++) {
1121          TBtaEvent Event = BtaEventBs->GetEvent(EventN);
1122          if (Event.GetIpNumId() == -1 || Event.GetProjId() == -1) { continue; }
1123          if (Event.GetSeverity() < MnSeverity) { continue; }
1124          AllEventIdV.Add(EventN);
1125          if (Event.GetCaseId() == -1) { continue; }
1126          CaseIdEventIdV.Add(EventN);
1127      } printf(".");}
1128      {printf(" LongProj ");
1129      TFltIntKdV WeekChiProjIdV, WeekKsProjIdV, MonthChiProjIdV, MonthKsProjIdV; printf(".");
1130      TTm StartDate = BtaEventBs->GetFirstTime(), EndDate = BtaEventBs->GetLastTime(); printf(".");
1131      TTm WeekBreakDate = GetBreakDate(7), MonthBreakDate = GetBreakDate(30); printf(".");
1132      int ProjKeyId = BtaLongBs->FFirstKeyId(); printf(".");
1133      int AllCount = 0, WeekSkipCount = 0, MonthSkipCount = 0;
1134      while (BtaLongBs->FNextKeyId(ProjKeyId)) {
1135          AllCount++;
1136          const int ProjId = BtaLongBs->GetProjId(ProjKeyId);
1137          PBtaLongProj LongProj = BtaLongBs->GetLongProj(ProjKeyId);
1138          int BeforeCount, AfterCount;
1139          LongProj->Count(StartDate, WeekBreakDate, EndDate, BeforeCount, AfterCount);
1140          const bool IsWeekTrendPosP = LongProj->IsTrendPos(StartDate, WeekBreakDate, EndDate);
1141          if (BeforeCount > MnBeforeCount &bsol;*&& IsWeekTrendPosP*/) {
1142              const double WeekChi = LongProj->ChiSquare(StartDate, WeekBreakDate, EndDate);
1143              WeekChiProjIdV.Add(TFltIntKd(WeekChi, ProjId));
1144          } else { WeekSkipCount++; }
1145          LongProj->Count(StartDate, MonthBreakDate, EndDate, BeforeCount, AfterCount);
1146          const bool IsMonthTrendPosP = LongProj->IsTrendPos(StartDate, MonthBreakDate, EndDate);
1147          if (BeforeCount > MnBeforeCount &bsol;*&& IsMonthTrendPosP*/) {
1148              const double MonthChi = LongProj->ChiSquare(StartDate, MonthBreakDate, EndDate);
1149              MonthChiProjIdV.Add(TFltIntKd(MonthChi, ProjId));
1150          } else { MonthSkipCount++; }
1151      }
1152      printf("(%d/%d/%d)", AllCount, WeekSkipCount, MonthSkipCount);
1153      WeekChiProjIdV.Sort(true); WeekChiSortProjIdV.Clr();
1154      for (int EltN = 0; EltN < WeekChiProjIdV.Len(); EltN++) {
1155          if (WeekChiProjIdV[EltN].Key > MxChiProb) { break; }
1156          WeekChiSortProjIdV.Add(WeekChiProjIdV[EltN].Dat); }
1157      WeekChiSortProjIdV.Pack(); 
1158      MonthChiProjIdV.Sort(true); MonthChiSortProjIdV.Clr();
1159      for (int EltN = 0; EltN < MonthChiProjIdV.Len(); EltN++) {
1160          if (MonthChiProjIdV[EltN].Key > MxChiProb) { break; }
1161          MonthChiSortProjIdV.Add(MonthChiProjIdV[EltN].Dat); }
1162      MonthChiSortProjIdV.Pack();
1163      printf(".");}
1164      printf(" Done\n");
1165  }
1166  void TBTAServer::OnHttpRq(const int& SockId, const PHttpRq& HttpRq) {
1167      if (!HttpRq->IsOk()) { return; }
1168      PUrl RqUrl=HttpRq->GetUrl();
1169      if (!RqUrl->IsOk()) { return; }
1170      PUrl HttpRqUrl = HttpRq->GetUrl();
1171      TStr UrlStr = HttpRqUrl->GetUrlStr();
1172      TStr CmdNm = HttpRqUrl->GetPathSeg(0);
1173      TStr FullQueryStr = HttpRqUrl->GetSearchStr();
1174      PUrlEnv HttpRqUrlEnv=HttpRq->GetUrlEnv();
1175      TStr TimeNow = TTm::GetCurLocTm().GetWebLogDateTimeStr(true);
1176      printf("[%s] Request %s %s\n", TimeNow.CStr(), CmdNm.CStr(), FullQueryStr.CStr());
1177      PHttpResp HttpResp;
1178      if (CmdNm == "style.css") {
1179          PSIn BodySIn = TFIn::New("style.css");
1180          HttpResp = THttpResp::New(THttp::OkStatusCd, "text/css", false, BodySIn);
1181      } else if (CmdNm == "board.css") {
1182          PSIn BodySIn = TFIn::New("board.css");
1183          HttpResp = THttpResp::New(THttp::OkStatusCd, "text/css", false, BodySIn);
1184      } else if (CmdNm.Right(4) == ".png") {
1185          TStr ImgFNm = "./" + CmdNm; 
1186          ImgFNm.ChangeChAll('-', '/');
1187          PSIn BodySIn = TFIn::New(ImgFNm);
1188          HttpResp = THttpResp::New(THttp::OkStatusCd, "image/png", false, BodySIn);
1189      } else if (CmdNm == "process") { 
1190          TStr MsgStr; 
1191          try {
1192              TStr ProcessType = HttpRqUrlEnv->GetVal("type", 0, "new");
1193              if (ProcessType == "new") {
1194                  const int NewEvents = ProcessNewBuffer();
1195                  MsgStr = TStr::Fmt("Loaded %d new alarms!", NewEvents);
1196              } else if (ProcessType == "dump") {
1197                  ProcessDumpBuffer();
1198                  MsgStr = "Dump successful!";
1199              } else if (ProcessType == "exit") {
1200                  SaveAndExit();
1201                  MsgStr = "Exit successful!";
1202              }
1203          } catch (PExcept Except) {
1204              printf("Exception: %s", Except->GetMsgStr().CStr());
1205          }
1206  		PSIn BodySIn = TMIn::New(MsgStr);
1207  		HttpResp = THttpResp::New(THttp::OkStatusCd, 
1208  			THttp::TextHtmlFldVal, false, BodySIn);
1209      } else if (CmdNm == "board") { 
1210          TStr ProjCountStr = HttpRqUrlEnv->GetVal("count", 0, "0");
1211          const int ProjCount = ProjCountStr.IsInt() ? ProjCountStr.GetInt() : 0;
1212          TStr RefreshTmSecStr = HttpRqUrlEnv->GetVal("refresh", 0, "10");
1213          const int RefreshTmSec = RefreshTmSecStr.IsInt() ? RefreshTmSecStr.GetInt() : 10;
1214          TChA HtmlChA;
1215          MakeBoardPage(ProjCount, RefreshTmSec, HtmlChA);
1216  		PSIn BodySIn = TMIn::New(HtmlChA);
1217  		HttpResp = THttpResp::New(THttp::OkStatusCd, 
1218  			THttp::TextHtmlFldVal, false, BodySIn);
1219      } else if ((CmdNm == "related_traps") || 
1220          (CmdNm == "predicted_traps") || (CmdNm == "trap_device")) {
1221  		const bool RelatedTrapsP = (CmdNm == "related_traps");
1222          const bool PredictedTrapsP = (CmdNm == "predicted_traps");
1223  		const bool TrapDeviceP = (CmdNm == "trap_device");
1224          TStr EventIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1225          if (EventIdStr.IsInt()) {
1226              const int EventId = EventIdStr.GetInt();
1227  			TChA HtmlChA;
1228  			HtmlChA += "<html><head>\n";
1229  			HtmlChA += "<title>BT Alarms Explorer</title>\n";
1230  			HtmlChA += "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\">\n";
1231  			HtmlChA += "<link href=\"style.css\" type=\"text/css\" rel=\"stylesheet\">\n";
1232  			HtmlChA += "</head><body>\n";
1233  			if (RelatedTrapsP) { 
1234  				HtmlChA += "[ Related Traps | ";
1235  				HtmlChA += "<a href=\"/predicted_traps?id=" + 
1236                      EventIdStr + "\">Predicted Traps</a> |";
1237  				HtmlChA += "<a href=\"/trap_device?id=" + 
1238                      EventIdStr + "\">Device Histroy and Trends</a> ]";
1239              } else if (PredictedTrapsP) {
1240  				HtmlChA += "[ <a href=\"/related_traps?id=" +
1241                      EventIdStr + "\">Related Traps</a> |";
1242  				HtmlChA += "Predicted Traps |";
1243  				HtmlChA += "<a href=\"/trap_device?id=" + 
1244                      EventIdStr + "\">Device Histroy and Trends</a> ]";
1245  			} else {
1246  				HtmlChA += "[ <a href=\"/related_traps?id=" +
1247                      EventIdStr + "\">Related Traps</a> |";
1248  				HtmlChA += "<a href=\"/predicted_traps?id=" + 
1249                      EventIdStr + "\">Predicted Traps</a> |";
1250  				HtmlChA += "Device Histroy and Trends ]";
1251  			}
1252  			HtmlChA += "<br><hr>";
1253  			if (RelatedTrapsP) {
1254  				MakeShortEventPage(EventId, HtmlChA);
1255              } else if (PredictedTrapsP) {
1256                  MakeShortPredIpNumsPage(EventId, HtmlChA);
1257              } else if (TrapDeviceP) {
1258  				MakeShortIpNumPage(EventId, HtmlChA);
1259  			}
1260  			HtmlChA += "</body></html>";
1261  			PSIn BodySIn = TMIn::New(HtmlChA);
1262  			HttpResp = THttpResp::New(THttp::OkStatusCd, 
1263  				THttp::TextHtmlFldVal, false, BodySIn);
1264          } else {
1265              printf("Wrong parameter id '%s' ..;\n", EventIdStr.CStr());
1266          }
1267      } else if (CmdNm == "report") { 
1268          TStr ReportType = HttpRqUrlEnv->GetVal("type", 0, "related");
1269          TChA HtmlChA;
1270          HtmlChA += "<html><head>\n";
1271          HtmlChA += "<title>BT Alarms Explorer</title>\n";
1272          HtmlChA += "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\">\n";
1273          HtmlChA += "<link href=\"style.css\" type=\"text/css\" rel=\"stylesheet\">\n";
1274          HtmlChA += "</head><body>\n";
1275          if (ReportType == "related") {
1276              TStr ReportSubType = HttpRqUrlEnv->GetVal("subtype", 0, "all");
1277              const bool ProbP = ((ReportSubType == "all") || (ReportSubType == "prob"));
1278              const bool TextP = ((ReportSubType == "all") || (ReportSubType == "text"));
1279              TStr MxEventsStr = HttpRqUrlEnv->GetVal("events", 0, "");
1280              const int MxEvents = MxEventsStr.IsInt() ? MxEventsStr.GetInt() : 1000;
1281              TStr MnSeverityStr = HttpRqUrlEnv->GetVal("mnseverity", 0, "");
1282              const int MnSeverity = MnSeverityStr.IsInt() ? MnSeverityStr.GetInt() : 3;
1283              int AllEvents = 0;
1284              TIntV AllScoresCountV, ProbScoresCountV, TextScoresCountV; 
1285              BtaCorrBs->GetRootCauseStat(BtaEventBs, MxEvents, MnSeverity,
1286                  RootCouseEventWnd, RootCouseTimeWnd, ProbP, TextP, 
1287                  AllScoresCountV, ProbScoresCountV, TextScoresCountV, 
1288                  AllEvents);
1289              HtmlChA += TStr::Fmt(
1290                  "<b>Number of severe events (Severity > %d):</b> %d<br>\n", 
1291                  MnSeverity, AllEvents);
1292              HtmlChA += "<hr>\n";
1293              HtmlChA += "<table><tr>";
1294              HtmlChA += "<td>#related</td>";
1295              HtmlChA += "<td>#all_alarms</td>";
1296              HtmlChA += "<td>#prob_alarms</td>";
1297              HtmlChA += "<td>#text_alarms</td>";
1298              HtmlChA += "</tr>\n";
1299              for (int ScoresCountN = 0; ScoresCountN < AllScoresCountV.Len(); ScoresCountN++) {
1300                  HtmlChA += "<tr>\n";
1301                  HtmlChA += TStr::Fmt("<td>%d</td>\n", ScoresCountN);
1302                  HtmlChA += TStr::Fmt("<td>%d</td>\n", AllScoresCountV[ScoresCountN].Val);
1303                  HtmlChA += TStr::Fmt("<td>%d</td>\n", ProbScoresCountV[ScoresCountN].Val);
1304                  HtmlChA += TStr::Fmt("<td>%d</td>\n", TextScoresCountV[ScoresCountN].Val);
1305                  HtmlChA += "</tr>\n";
1306              }
1307              HtmlChA += "</table>";
1308          }
1309  		HtmlChA += "</body></html>";
1310          printf("\n\n%s\n\n", HtmlChA.CStr());
1311  		PSIn BodySIn = TMIn::New(HtmlChA);
1312  		HttpResp = THttpResp::New(THttp::OkStatusCd, 
1313  			THttp::TextHtmlFldVal, false, BodySIn);
1314  	} else {
1315          TChA HtmlChA;
1316          HtmlChA += "<html><head>\n";
1317          HtmlChA += "<title>BT Alarms Explorer</title>\n";
1318          HtmlChA += "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\">\n";
1319          HtmlChA += "<link href=\"style.css\" type=\"text/css\" rel=\"stylesheet\">\n";
1320          HtmlChA += "</head><body>\n";
1321          HtmlChA += "<form action=\"/search\"><b><a href=\"/events\">Alarms</a></b>, ";
1322          HtmlChA += "<b><a href=\"/long\">Long-Term Trends</a></b> | ";
1323          HtmlChA += "Search: <input maxLength=\"256\" size=\"23\" name=\"q\"";
1324          if (!HttpRqUrlEnv->GetVal("q", 0, "").Empty()) {
1325              HtmlChA += "value=\"" + HttpRqUrlEnv->GetVal("q", 0, "") + "\""; }
1326          HtmlChA += ">";
1327          HtmlChA += "<input type=submit name=\"type\" value=\"device\">\n";
1328          HtmlChA += "<input type=submit name=\"type\" value=\"project\">\n";
1329          HtmlChA += "</form>";
1330          HtmlChA += "<hr>\n";
1331          if (CmdNm.Empty() || CmdNm == "events") {
1332              TStr SortTypeStr = HttpRqUrlEnv->GetVal("sort", 0, "all");
1333              TStr PageNumStr = HttpRqUrlEnv->GetVal("page", 0, "0");
1334              if (PageNumStr.IsInt()) {
1335                  const int PageNum = PageNumStr.GetInt();
1336                  if (SortTypeStr == "all") {           
1337                      MakeEventsPage(AllEventIdV, SortTypeStr, PageNum, HtmlChA);
1338                  } else if (SortTypeStr == "case_id") {
1339                      MakeEventsPage(CaseIdEventIdV, SortTypeStr, PageNum, HtmlChA);
1340                  } else {
1341                      printf("Wrong parameter sort '%s' ..;\n", SortTypeStr.CStr());
1342                  }
1343              } else {
1344                  printf("Wrong parameter page '%s' ..;\n", PageNumStr.CStr());
1345              }
1346          } else if (CmdNm == "search") {
1347              TStr QueryStr = HttpRqUrlEnv->GetVal("q", 0, "");
1348              TStr TypeStr = HttpRqUrlEnv->GetVal("type", 0, "");
1349              if (!QueryStr.Empty() && !TypeStr.Empty()) {
1350                  bool SearchOkP = true;
1351                  if (TypeStr == "device") {
1352                      PBtaDevDefBs BtaDevDefBs = BtaEventBs->GetDevDefBs();
1353                      if (BtaDevDefBs->IsIpNumId(QueryStr)) {
1354                          const int IpNumId = BtaDevDefBs->GetIpNumId(QueryStr);
1355                          MakeIpNumPage(IpNumId, HtmlChA);
1356                      } else { SearchOkP = false; }
1357                  } else if (TypeStr == "project") {
1358                      PBtaDevDefBs BtaDevDefBs = BtaEventBs->GetDevDefBs();
1359                      if (BtaDevDefBs->IsProjId(QueryStr)) {
1360                          const int ProjId = BtaDevDefBs->GetProjId(QueryStr);
1361                          MakeProjectPage(ProjId, HtmlChA);
1362                      } else { SearchOkP = false; }
1363                  } else { SearchOkP = false; }
1364                  if (!SearchOkP) { HtmlChA += "<b>No results found, try again.</b>\n"; }
1365              } else { 
1366                  printf("Wrong parameter page '%s' and '%s' ..;\n", 
1367                      QueryStr.CStr(), TypeStr.CStr());
1368              }            
1369          } else if (CmdNm == "event") {
1370              TStr EventIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1371              if (EventIdStr.IsInt()) {
1372                  const int EventId = EventIdStr.GetInt();
1373                  MakeEventPage(EventId, HtmlChA);
1374              } else {
1375                  printf("Wrong parameter id '%s' ..;\n", EventIdStr.CStr());
1376              }
1377          } else if (CmdNm == "event_full") {
1378              TStr EventIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1379              if (EventIdStr.IsInt()) {
1380                  const int EventId = EventIdStr.GetInt();
1381                  MakeEventFullPage(EventId, HtmlChA);
1382              } else {
1383                  printf("Wrong parameter id '%s' ..;\n", EventIdStr.CStr());
1384              }
1385          } else if (CmdNm == "device") {
1386              TStr IpNumIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1387              if (IpNumIdStr.IsInt()) {
1388                  const int IpNumId = IpNumIdStr.GetInt();
1389                  MakeIpNumPage(IpNumId, HtmlChA);                
1390              } else {
1391                  printf("Wrong parameter id '%s' ..;\n", IpNumIdStr.CStr());
1392              }
1393          } else if (CmdNm == "project") {
1394              TStr ProjIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1395              if (ProjIdStr.IsInt()) {
1396                  const int ProjId = ProjIdStr.GetInt();
1397                  MakeProjectPage(ProjId, HtmlChA);
1398              } else {
1399                  printf("Wrong parameter id '%s' ..;\n", ProjIdStr.CStr());
1400              }
1401          } else if (CmdNm == "d_events") {
1402              TStr PageNumStr = HttpRqUrlEnv->GetVal("page", 0, "0");
1403              TStr IpNumIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1404              if (!PageNumStr.IsInt()) {
1405                  printf("Wrong parameter page '%s' ..;\n", PageNumStr.CStr());
1406              } else if (!IpNumIdStr.IsInt()) {
1407                  printf("Wrong parameter id '%s' ..;\n", IpNumIdStr.CStr());
1408              } else {              
1409                  const int PageNum = PageNumStr.GetInt();
1410                  const int IpNumId = IpNumIdStr.GetInt();
1411                  if (BtaCorrBs->IsIpNumId(IpNumId)) {
1412                      const TIntV& EventV = BtaCorrBs->GetIpNumEventV(IpNumId); 
1413                      MakeIpNumEventsPage(IpNumId, EventV, PageNum, HtmlChA);
1414                  }
1415              }
1416          } else if (CmdNm == "p_events") {
1417              TStr PageNumStr = HttpRqUrlEnv->GetVal("page", 0, "0");
1418              TStr ProjIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1419              if (!PageNumStr.IsInt()) {
1420                  printf("Wrong parameter page '%s' ..;\n", PageNumStr.CStr());
1421              } else if (!ProjIdStr.IsInt()) {
1422                  printf("Wrong parameter id '%s' ..;\n", ProjIdStr.CStr());
1423              } else {              
1424                  const int PageNum = PageNumStr.GetInt();
1425                  const int ProjId = ProjIdStr.GetInt();
1426                  if (BtaCorrBs->IsProjId(ProjId)) {
1427                      const TIntV& EventV = BtaCorrBs->GetProjEventV(ProjId); 
1428                      MakeProjEventsPage(ProjId, EventV, PageNum, HtmlChA);
1429                  }
1430              }
1431          } else if (CmdNm == "dd_events") {
1432              TStr PageNumStr = HttpRqUrlEnv->GetVal("page", 0, "0");
1433              TStr IpNumIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1434              TStr CorrIpNumIdStr = HttpRqUrlEnv->GetVal("corrid", 0, "0");
1435              if (!PageNumStr.IsInt()) {
1436                  printf("Wrong parameter page '%s' ..;\n", PageNumStr.CStr());
1437              } else if (!IpNumIdStr.IsInt()) {
1438                  printf("Wrong parameter id '%s' ..;\n", IpNumIdStr.CStr());
1439              } else if (!CorrIpNumIdStr.IsInt()) {
1440                  printf("Wrong parameter corrid '%s' ..;\n", CorrIpNumIdStr.CStr());
1441              } else {              
1442                  const int PageNum = PageNumStr.GetInt();
1443                  const int IpNumId = IpNumIdStr.GetInt();
1444                  const int CorrIpNumId = CorrIpNumIdStr.GetInt();
1445                  MakeIpNumCorrEventPage(IpNumId, CorrIpNumId, PageNum, HtmlChA);
1446              }
1447          } else if (CmdNm == "long") {
1448              TStr PageNumStr = HttpRqUrlEnv->GetVal("page", 0, "0");
1449              if (PageNumStr.IsInt()) {
1450                  TStr PeriodStr = HttpRqUrlEnv->GetVal("period", 0, "week");
1451                  const int PageNum = PageNumStr.GetInt();
1452                  if (PeriodStr == "week") {
1453                      MakeLongPage(WeekChiSortProjIdV, PageNum, PeriodStr, HtmlChA);
1454                  } else if (PeriodStr == "month") {
1455                      MakeLongPage(MonthChiSortProjIdV, PageNum, PeriodStr, HtmlChA);
1456                  }
1457              } else {
1458                  printf("Wrong parameter page '%s' ..;\n", PageNumStr.CStr());
1459              }
1460          } else if (CmdNm == "p_long") {
1461              TStr ProjIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1462              TStr PageNumStr = HttpRqUrlEnv->GetVal("page", 0, "0");
1463              if (!PageNumStr.IsInt()) {
1464                  printf("Wrong parameter page '%s' ..;\n", PageNumStr.CStr());
1465              } else if (!ProjIdStr.IsInt()) {
1466                  printf("Wrong parameter id '%s' ..;\n", ProjIdStr.CStr());
1467              } else {              
1468                  TStr PeriodStr = HttpRqUrlEnv->GetVal("period", 0, "week");
1469                  const int PageNum = PageNumStr.GetInt();
1470                  const int ProjId = ProjIdStr.GetInt();
1471                  if (PeriodStr == "week") {
1472                      MakeProjLongPage(ProjId, PageNum, PeriodStr, HtmlChA);
1473                  } else if (PeriodStr == "month") {
1474                      MakeProjLongPage(ProjId, PageNum, PeriodStr, HtmlChA);
1475                  }
1476              }
1477          }
1478          HtmlChA += "</body></html>";
1479          PSIn BodySIn = TMIn::New(HtmlChA);
1480          HttpResp = THttpResp::New(THttp::OkStatusCd, 
1481              THttp::TextHtmlFldVal, false, BodySIn);
1482      }
1483      SendHttpResp(SockId, HttpResp);
1484  }
</code></pre>
        </div>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-btaserver.cpp</h3>
            <pre><code>1  #include "btaserver.h"
2  int TBTAServer::MnSeverity = 3;
3  int TBTAServer::ListItemsPerPage = 20;
4  int TBTAServer::DetailItemsPerPage = 10;
5  int TBTAServer::ListEventsPerPage = 10;
6  int64 TBTAServer::RootCouseTimeWnd = int64(24*3600) * int64(1000);  
7  int TBTAServer::RootCouseEventWnd = 300;
8  int64 TBTAServer::BoardTimeWnd = int64(4*3600) * int64(1000);  
9  int TBTAServer::BoardEventWnd = 5000;
10  int TBTAServer::MnBeforeCount = 5;
11  double TBTAServer::MxChiProb = 0.05;
12  double TBTAServer::MnChiVal = 0.01;
13  double TBTAServer::MnCorrProb = 0.001;
14  int TBTAServer::MnIpNumsPerPlot = 20;
15  int TBTAServer::GetTotalFq(const TIntPrV& IdFqV) {
16      int TotalFq = 0;
17      for (int IdFqN = 0; IdFqN < IdFqV.Len(); IdFqN++) {
18          TotalFq += IdFqV[IdFqN].Val2; }
19      return TotalFq;
20  }
21  TStr TBTAServer::TruncStr(const TStr& FullStr, const int& MxLen) {
22      if (FullStr.Len() > MxLen) {
23          return FullStr.GetSubStr(0, MxLen-1) + "...";
24      } else { return FullStr; }
25  }
26  TTm TBTAServer::GetBreakDate(const int& Days) const { 
27      TTm BreakDate = BtaEventBs->GetLastTime();
28      BreakDate.DelDays(Days);
29      return BreakDate;
30  }
31  void TBTAServer::GetIpNumEventCount(const int& IpNumId, const TTm& StartDate, 
32          const TTm& BreakDate, const TTm& EndDate, double& AvgCount, int& LastCount) const {
33      int OldCount = 0; LastCount = 0;
34      const TIntV& EventV = BtaCorrBs->GetIpNumEventV(IpNumId);
35      for (int EventN = 0; EventN < EventV.Len(); EventN++) {
36          TTm EventDate = BtaEventBs->GetEvent(EventV[EventN]).GetFirstTm();
37          if (EventDate < StartDate || EventDate > EndDate) { continue; }
38          if (EventDate < BreakDate) { OldCount++; }
39          else { LastCount++; }
40      }
41      const double NormFactor = TBtaLongProj::GetNormFact(StartDate, BreakDate, EndDate);
42      AvgCount = NormFactor * double(OldCount);
43  }
44  void TBTAServer::MakeEventsPage(const TIntV& EventV, const TStr& SortTypeStr,
45          const int& PageNum, TChA& HtmlChA) {
46      HtmlChA += "<h1>Alarms</h1>\n";                   
47      HtmlChA += TStr::Fmt("<p>Number of alarms: <b>%d</b> (severity > 2)<br>\n", EventV.Len());
48      TStr LatestAlarm = BtaEventBs->GetEvent(EventV.Last()).GetFirstTm().GetWebLogDateTimeStr();
49      HtmlChA += "Time of the latest alarm: <b>" + LatestAlarm + "</b><br>\n";
50      TStr OldestAlarm = BtaEventBs->GetEvent(EventV[0]).GetFirstTm().GetWebLogDateTimeStr();
51      HtmlChA += "Time of the oldest alarm: <b>" + OldestAlarm + "</b></p>\n";
52      TStr PlotFNm = TFile::GetUniqueFNm("img/EventPlot.plt");
53      PlotEventV("", EventV, PlotFNm);
54      PlotFNm.ChangeChAll('/', '-');
55      HtmlChA += "<p><img src=\"" + PlotFNm + ".png\"></p>";
56      HtmlChA += "<h2>List of recent alarms</h2>\n";
57      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/events?page=%d&sort=%s\">Previous</a>\n", PageNum-1, SortTypeStr.CStr()); }
58      HtmlChA += TStr::Fmt("<a href=\"/events?page=%d&sort=%s\">Next</a>\n", PageNum+1, SortTypeStr.CStr());
59      MakeEventList(EventV, true, PageNum, HtmlChA);
60      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/events?page=%d&sort=%s\">Previous</a>\n", PageNum-1, SortTypeStr.CStr()); }
61      HtmlChA += TStr::Fmt("<a href=\"/events?page=%d&sort=%s\">Next</a>\n", PageNum+1, SortTypeStr.CStr());
62  }
63  void TBTAServer::MakeEventPage(const int& EventId, TChA& HtmlChA) {
64      if (EventId < 0 || EventId >= BtaEventBs->GetEvents()) { 
65          HtmlChA += "<p>Wrong event Id!</p>"; return; }
66      HtmlChA += "<h1>Alarm statistics</h1>\n";       
67      EventStat(EventId, HtmlChA);
68      HtmlChA += "<p><a href=\"/event_full?id=" + 
69          TInt::GetStr(EventId) + "\">Show all fields</a></p>";
70      HtmlChA += "<h2>Pattern of related events</h2>\n";       
71      EventRootCause(EventId, HtmlChA);
72      HtmlChA += "<h2>Devices predicted to fail</h2>\n";
73      EventPredIpNums(EventId, HtmlChA);
74  }
75  void TBTAServer::MakeEventFullPage(const int& EventId, TChA& HtmlChA) {
76      HtmlChA += "<h1>Alarm database fields</h1>\n";       
77      HtmlChA += "<p><a href=\"/event?id=" + 
78          TInt::GetStr(EventId) + "\">Back to alarm statistics</a></p>";
79      EventFullStat(EventId, HtmlChA);
80  }
81  void TBTAServer::MakeIpNumPage(const int& IpNumId, TChA& HtmlChA) {
82      HtmlChA += "<h1>Device statistics</h1>\n";       
83      if (BtaCorrBs->IsIpNumId(IpNumId)) { 
84          TStr IpNumNm = BtaDevDefBs->GetIpNumNm(IpNumId);
85          HtmlChA += TStr::Fmt("<p><b>Device IP:</b> %s<br>\n", IpNumNm.CStr());
86          HtmlChA += TStr::Fmt("<b>Device project:</b> %s<br>\n", GetProjLink(IpNumId).CStr());
87          HtmlChA += TStr::Fmt("<b>Number of alarms:</b> %d</p>\n", BtaCorrBs->GetIpNumIdEvents(IpNumId));
88          HtmlChA += "<h2>Recent alarms</h2>\n";       
89          HtmlChA += TStr::Fmt("<p><a href=\"/d_events?id=%d\">Show all alarms</a></p>\n", IpNumId);
90          TIntV EventV = BtaCorrBs->GetIpNumEventV(IpNumId);
91          TStr PlotFNm = TFile::GetUniqueFNm("img/EventPlot.plt");
92          PlotEventV(BtaDevDefBs->GetIpNumNm(IpNumId), EventV, PlotFNm);
93          PlotFNm.ChangeChAll('/', '-');
94          HtmlChA += "<p><img src=\"" + PlotFNm + ".png\"></p>";
95          MakeEventList(EventV, false, 0, HtmlChA);
96          HtmlChA += "<h2>Correlated devices</h2>\n";       
97          IpNumDevCorrStat(IpNumId, HtmlChA);
98      } else {
99          HtmlChA += "<p><b>Device not in the database!</b></p>";                    
100      }   
101  }
102  void TBTAServer::MakeProjectPage(const int& ProjId, TChA& HtmlChA) {
103      HtmlChA += "<h1>Project statistics</h1>\n";
104      ShortProjStat(ProjId, HtmlChA);
105      HtmlChA += "<h2>Recent alarms</h2>\n";
106      HtmlChA += TStr::Fmt("<p><a href=\"/p_events?id=%d\">Show all alarms</a></p>\n", ProjId);
107      TIntV EventV = BtaCorrBs->GetProjEventV(ProjId);
108      TStr PlotFNm = TFile::GetUniqueFNm("img/EventPlot.plt");
109      PlotEventV(BtaDevDefBs->GetProjNm(ProjId), EventV, PlotFNm);
110      PlotFNm.ChangeChAll('/', '-');
111      HtmlChA += "<p><img src=\"" + PlotFNm + ".png\"></p>";
112      MakeEventList(EventV, false, 0, HtmlChA);
113      HtmlChA += "<h2>Devices predicted to fail</h2>\n";
114      EventShortPredIpNums(EventV.Last(), HtmlChA);
115  }
116  void TBTAServer::MakeIpNumEventsPage(const int& IpNumId, 
117          const TIntV& EventV, const int& PageNum, TChA& HtmlChA) {
118      HtmlChA += "<h1>Device's alarms</h1>\n";                   
119      ShortIpNumStat(IpNumId, HtmlChA);
120      HtmlChA += "<h2>List of alarms</h2>\n";                   
121      TStr LatestAlarm = BtaEventBs->GetEvent(EventV.Last()).GetFirstTm().GetWebLogDateTimeStr();
122      HtmlChA += "Time of the latest alarm: <b>" + LatestAlarm + "</b><br>\n";
123      TStr OldestAlarm = BtaEventBs->GetEvent(EventV[0]).GetFirstTm().GetWebLogDateTimeStr();
124      HtmlChA += "Time of the oldest alarm: <b>" + OldestAlarm + "</b></p>\n";
125      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/d_events?id=%d&page=%d\">Previous</a>\n", IpNumId, PageNum-1); }
126      HtmlChA += TStr::Fmt("<a href=\"/d_events?id=%d&page=%d\">Next</a>\n", IpNumId, PageNum+1);
127      MakeEventList(EventV, false, PageNum, HtmlChA);
128      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/d_events?id=%d&page=%d\">Previous</a>\n", IpNumId, PageNum-1); }
129      HtmlChA += TStr::Fmt("<a href=\"/d_events?id=%d&page=%d\">Next</a>\n", IpNumId, PageNum+1);
130  }
131  void TBTAServer::MakeProjEventsPage(const int& ProjId, const TIntV& EventV,
132          const int& PageNum, TChA& HtmlChA) {
133      HtmlChA += "<h1>Project's alarms</h1>\n";                   
134      ShortProjStat(ProjId, HtmlChA);
135      HtmlChA += "<h2>List of alarms</h2>\n";                   
136      TStr LatestAlarm = BtaEventBs->GetEvent(EventV.Last()).GetFirstTm().GetWebLogDateTimeStr();
137      HtmlChA += "Time of the latest alarm: <b>" + LatestAlarm + "</b><br>\n";
138      TStr OldestAlarm = BtaEventBs->GetEvent(EventV[0]).GetFirstTm().GetWebLogDateTimeStr();
139      HtmlChA += "Time of the oldest alarm: <b>" + OldestAlarm + "</b></p>\n";
140      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/p_events?id=%d&page=%d\">Previous</a>\n", ProjId, PageNum-1); }
141      HtmlChA += TStr::Fmt("<a href=\"/p_events?id=%d&page=%d\">Next</a>\n", ProjId, PageNum+1);
142      MakeEventList(EventV, false, PageNum, HtmlChA);
143      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/p_events?id=%d&page=%d\">Previous</a>\n", ProjId, PageNum-1); }
144      HtmlChA += TStr::Fmt("<a href=\"/p_events?id=%d&page=%d\">Next</a>\n", ProjId, PageNum+1);
145  }
146  void TBTAServer::MakeIpNumCorrEventPage(const int& IpNumId, 
147          const int& CorrIpNumId, const int& PageNum, TChA& HtmlChA) {
148      HtmlChA += "<h1>Alarms behind device-device correlation</h1>\n";
149      HtmlChA += "<h2>First device</h2>\n";
150      ShortIpNumStat(IpNumId, HtmlChA);
151      HtmlChA += "<h2>Second device</h2>\n";
152      ShortIpNumStat(CorrIpNumId, HtmlChA);
153      HtmlChA += "<h2>List of correlating alarms</h2>\n";
154      const TIntV& EventV = BtaCorrBs->GetIpNumEventV(IpNumId);
155      const TIntV& CorrEventV = BtaCorrBs->GetIpNumEventV(CorrIpNumId);
156      TStr PlotFNm = TFile::GetUniqueFNm("img/EventPlot.plt");
157      PlotEventV(BtaDevDefBs->GetIpNumNm(IpNumId), EventV, 
158          BtaDevDefBs->GetIpNumNm(CorrIpNumId), CorrEventV, PlotFNm);
159      PlotFNm.ChangeChAll('/', '-');
160      HtmlChA += "<p><img src=\"" + PlotFNm + ".png\"></p>";
161      if (BtaCorrBs->IsIpNumIdPrCorr(IpNumId, CorrIpNumId)) {
162          const TIntPrV& EventPrV = BtaCorrBs->GetIpNumCorrIpNumPrEventV(IpNumId, CorrIpNumId);
163          HtmlChA += TStr::Fmt("<p><b>Number of correlated alarm pairs:</b>%d</p>\n", EventPrV.Len());
164          if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/dd_events?page=%d&id=%d&corrid=%d\">Previous</a>\n", PageNum-1, IpNumId, CorrIpNumId); }
165          HtmlChA += TStr::Fmt("<a href=\"/dd_events?page=%d&id=%d&corrid=%d\">Next</a>\n", PageNum+1, IpNumId, CorrIpNumId);
166          MakeEventPrList(EventPrV, PageNum, HtmlChA);
167          if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/dd_events?page=%d&id=%d&corrid=%d\">Previous</a>\n", PageNum-1, IpNumId, CorrIpNumId); }
168          HtmlChA += TStr::Fmt("<a href=\"/dd_events?page=%d&id=%d&corrid=%d\">Next</a>\n", PageNum+1, IpNumId, CorrIpNumId);
169      }
170  }
171  void TBTAServer::MakeLongPage(const TIntV& SortProjIdV, 
172          const int& PageNum, const TStr& PeriodStr, TChA& HtmlChA) {
173      HtmlChA += "<h1>Projects with change trend</h1>\n";                   
174      if (PeriodStr == "week") { HtmlChA += "<p><b>[last week vs. history]</b>, "; } 
175      else { HtmlChA += "<p><a href=\"/long?period=week\">[last week vs. history]</a>, "; }
176      if (PeriodStr == "month") { HtmlChA += "<b>[last month vs. history]</b></p>"; }
177      else {HtmlChA += "<a href=\"/long?period=month\">[last month vs. history]</a></p>"; }
178      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/long?page=%d&period=%s\">Previous</a>\n", PageNum-1, PeriodStr.CStr()); }
179      HtmlChA += TStr::Fmt("<a href=\"/long?page=%d&period=%s\">Next</a>\n", PageNum+1, PeriodStr.CStr());
180      MakeLongProjList(SortProjIdV, PageNum, PeriodStr, HtmlChA);
181      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/long?page=%d&period=%s\">Previous</a>\n", PageNum-1, PeriodStr.CStr()); }
182      HtmlChA += TStr::Fmt("<a href=\"/long?page=%d&period=%s\">Next</a>\n", PageNum+1, PeriodStr.CStr());    
183  }
184  void TBTAServer::MakeProjLongPage(const int& ProjId,
185          const int& PageNum, const TStr& PeriodStr, TChA& HtmlChA) {
186      HtmlChA += "<h1>Devices with change trends</h1>\n";                   
187      ShortProjStat(ProjId, HtmlChA, true);
188      HtmlChA += "<h2>List of device trends</h2>\n";                   
189      if (PeriodStr == "week") { HtmlChA += "<p><b>[last week vs. history]</b>, "; } 
190      else { HtmlChA += TStr::Fmt("<p><a href=\"/p_long?id=%d&period=week\">[last week vs. history]</a>, ", ProjId); }
191      if (PeriodStr == "month") { HtmlChA += "<b>[last month vs. history]</b></p>"; }
192      else {HtmlChA += TStr::Fmt("<a href=\"/p_long?id=%d&period=month\">[last month vs. history]</a></p>", ProjId); }
193      TStr PlotFNm = TFile::GetUniqueFNm("IpNum.plt");
194      TTm StartDate = BtaEventBs->GetFirstTime();
195      TTm BreakDate = GetBreakDate(PeriodStr == "week" ? 7 : 30);
196      TTm EndDate = BtaEventBs->GetLastTime();
197      PlotLongIpNum(BtaDevDefBs->GetProjNm(ProjId), PlotFNm, ProjId, 
198          StartDate, BreakDate, EndDate, PeriodStr, MnIpNumsPerPlot, true);
199      HtmlChA += "<p><img src=\"" + PlotFNm + ".png\"></p>";
200      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/p_long?id=%d&page=%d&period=%s\">Previous</a>\n", ProjId, PageNum-1, PeriodStr.CStr()); }
201      HtmlChA += TStr::Fmt("<a href=\"/p_long?id=%d&page=%d&period=%s\">Next</a>\n", ProjId, PageNum+1, PeriodStr.CStr());
202      MakeLongIpNumList(ProjId, PageNum, PeriodStr, HtmlChA);
203      if (PageNum > 0) { HtmlChA += TStr::Fmt("<a href=\"/long?id=%d&page=%d&period=%s\">Previous</a>\n", ProjId, PageNum-1, PeriodStr.CStr()); }
204      HtmlChA += TStr::Fmt("<a href=\"/p_long?id=%d&page=%d&period=%s\">Next</a>\n", ProjId, PageNum+1, PeriodStr.CStr());    
205  }
206  void TBTAServer::MakeShortEventPage(const int& EventId, TChA& HtmlChA) {
207  	EventShortStat(EventId, HtmlChA);
208      HtmlChA += "<hr>";
209      HtmlChA += "<b>Related Traps:</b><br>";
210      EventShortRootCause(EventId, HtmlChA);
211  }
212  void TBTAServer::MakeShortPredIpNumsPage(const int& EventId, TChA& HtmlChA) {
213  	EventShortStat(EventId, HtmlChA);
214      HtmlChA += "<hr>";
215      HtmlChA += "<b>Devices predicted to fail:</b><br>";
216      EventShortPredIpNums(EventId, HtmlChA);
217  }
218  void TBTAServer::MakeShortIpNumPage(const int& EventId, TChA& HtmlChA) {
219      const int IpNumId = BtaEventBs->GetEvent(EventId).GetIpNumId();
220      const TIntV& IpNumEventV = BtaCorrBs->GetIpNumEventV(IpNumId);
221  	EventShortStat(EventId, HtmlChA);
222      HtmlChA += "<hr>";
223      HtmlChA += "<b>Device event trend</b><br>";
224      TStr PlotFNm = TFile::GetUniqueFNm("img/EventPlot.plt");
225      PlotEventV("", IpNumEventV, PlotFNm, 500, 250);
226      PlotFNm.ChangeChAll('/', '-');
227      HtmlChA += "<img src=\"" + PlotFNm + ".png\"><br>";
228      HtmlChA += "<hr>";
229      HtmlChA += "<b>Recent events</b><br>";
230      MakeShortEventList(IpNumEventV, HtmlChA);
231  }
232  void TBTAServer::MakeBoardPage(const int& ProjCount, const int& RefreshTmSec, TChA& HtmlChA) {
233      HtmlChA += "<html><head>\n";
234      HtmlChA += "<title>Prediction Board</title>\n";
235      HtmlChA += "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\">\n";
236      HtmlChA += TStr::Fmt("<meta http-equiv=\"REFRESH\" content=\"%d;url=board?count=%d&refresh=%d\"></HEAD>", 
237          RefreshTmSec, ProjCount + 1, RefreshTmSec);
238      HtmlChA += "<link href=\"board.css\" type=\"text/css\" rel=\"stylesheet\">\n";
239      HtmlChA += "</head><body>\n";
240      TIntKdV AllProjIdFqV;
241      BtaEventBs->GetMostActiveProjs(BoardTimeWnd, 
242          BoardEventWnd, MnSeverity, AllProjIdFqV);
243      TFltIntKdV ScoreProjIdV; THash<TInt, TFltIntPrV> ProbIpNumIdVH;
244      const int MxPredIpNums = 2; const int MxProjs = 6;
245      for (int ProjIdN = 0; ProjIdN < AllProjIdFqV.Len(); ProjIdN++) {
246          const int ProjId = AllProjIdFqV[ProjIdN].Key;
247          const int LastEventN = BtaCorrBs->GetProjEventV(ProjId).Last();
248          TIntFltH IpNumIdProbH;
249          BtaCorrBs->GetNextIpNumIdProb(LastEventN, ProjId, 
250              BtaEventBs, 100, 600, IpNumIdProbH);
251          if (IpNumIdProbH.Empty()) { continue;}
252          TFltIntPrV ProbIpNumIdV; 
253          IpNumIdProbH.GetDatKeyPrV(ProbIpNumIdV); 
254          ProbIpNumIdV.Sort(false);        
255          if (ProbIpNumIdV.Len() > MxPredIpNums) { 
256              ProbIpNumIdV.Trunc(MxPredIpNums); }
257          ScoreProjIdV.Add(TFltIntKd(ProbIpNumIdV[0].Val1, ProjId));
258          ProbIpNumIdVH.AddDat(ProjId, ProbIpNumIdV);
259          if (ScoreProjIdV.Len() >= 2*MxProjs) { break; }
260      } 
261      ScoreProjIdV.Sort(false);
262      if (ScoreProjIdV.Len() > MxProjs) { ScoreProjIdV.Trunc(MxProjs); }
263      if (ScoreProjIdV.Len() > 0) {
264          const int SelProjIdN = ProjCount % ScoreProjIdV.Len();
265  	    HtmlChA += "<div class=\"window\">\n";
266    	    HtmlChA += "<div class=\"project_list\">\n";
267          for (int ProjIdN = 0; ProjIdN < ScoreProjIdV.Len(); ProjIdN++) {
268              const int ProjId = ScoreProjIdV[ProjIdN].Dat;
269              const TFltIntPrV& ProbIpNumIdV = ProbIpNumIdVH.GetDat(ProjId);
270              if (ProjIdN == SelProjIdN) { 
271      	        HtmlChA += "<div class=\"project selected\">\n";
272              } else {
273      	        HtmlChA += "<div class=\"project\">\n";
274              }
275              TStr ProjNm = BtaDevDefBs->GetProjNm(ProjId);
276  	        HtmlChA += "<div class=\"project_title\">" + ProjNm + "</div>\n";
277              for (int IpNumN = 0; IpNumN < ProbIpNumIdV.Len(); IpNumN++) {
278                  const int IpNumId = ProbIpNumIdV[IpNumN].Val2;
279                  TStr IpNumNm = BtaDevDefBs->GetIpNumNm(IpNumId);
280  	            HtmlChA += "<div class=\"project_device\">" + IpNumNm + "</div>\n";
281              }
282  	        HtmlChA += "</div>\n";
283          }
284          HtmlChA += "</div>\n";
285          HtmlChA += "<div class=\"project_details\">\n";
286          const int SelProjId = ScoreProjIdV[SelProjIdN].Dat;
287          TStr SelProjNm = BtaDevDefBs->GetProjNm(SelProjId);
288          HtmlChA += "<div class=\"project_detail_title\">" + SelProjNm + "</div>\n";
289          HtmlChA += "<div class=\"project_detail_hist\">\n";
290          const TIntV& ProjEventV = BtaCorrBs->GetProjEventV(SelProjId);
291          TStr PlotFNm = TFile::GetUniqueFNm("img/EventPlot.plt");
292          PlotEventV("", ProjEventV, PlotFNm, 680, 200); PlotFNm.ChangeChAll('/', '-');
293          HtmlChA += "<p><img src=\"" + PlotFNm + ".png\"></p>";
294          HtmlChA += "</div>\n";
295          HtmlChA += "<div class=\"project_detail_h2\">Last trap:</div>\n";
296          HtmlChA += "<div class=\"project_detail_event_list\">\n";
297          {
298              const int LastEventN = ProjEventV.Last();
299              const TBtaEvent& LastEvent = BtaEventBs->GetEvent(LastEventN);
300              TStr IpNumNm = BtaDevDefBs->GetIpNumNm(LastEvent.GetIpNumId());       
301              TBtaEventDat LastEventDat; 
302              BtaEventBs->GetEventDat(LastEvent.GetBlobPt(), LastEventDat);
303              HtmlChA += "<div class=\"project_detail_event\">\n";
304              HtmlChA += "<b>Device ID:</b> " + IpNumNm + "<br>\n";
305              HtmlChA += "<b>First Time:</b> " + LastEventDat.GetFirstTm() + "<br>\n";
306              HtmlChA += "<b>Last Time:</b> " + LastEventDat.GetLastTm() + "<br>\n";
307              HtmlChA += "<b>Severity:</b> " + LastEventDat.GetSeverity() + "<br>\n";
308              HtmlChA += "<b>Summary:</b> " + LastEventDat.GetSummary() + "\n";
309              HtmlChA += "</div>\n";
310          }
311          HtmlChA += "</div>\n";
312          HtmlChA += "<div class=\"project_detail_h2\">Devices predicted to fail:</div>\n";
313          HtmlChA += "<div class=\"project_detail_device_list\">\n";
314          const TFltIntPrV& ProbIpNumIdV = ProbIpNumIdVH.GetDat(SelProjId);
315          for (int IpNumN = 0; IpNumN < ProbIpNumIdV.Len(); IpNumN++) {
316              const int IpNumId = ProbIpNumIdV[IpNumN].Val2;
317              TStr IpNumNm = BtaDevDefBs->GetIpNumNm(IpNumId);       
318              HtmlChA += "<div class=\"project_detail_device\">\n";
319              HtmlChA += "<b>Device ID:</b> " + IpNumNm + "<br>\n";
320              const int LastEventN = BtaCorrBs->GetIpNumEventV(IpNumId).Last();
321              const TBtaEvent& LastEvent = BtaEventBs->GetEvent(LastEventN);
322              TBtaEventDat LastEventDat; 
323              BtaEventBs->GetEventDat(LastEvent.GetBlobPt(), LastEventDat);
324              HtmlChA += "<b>Last trap:</b> " + LastEventDat.GetFirstTm() + "<br>\n";
325              HtmlChA += "<b>Summary:</b> " + LastEventDat.GetSummary() + "\n";
326              HtmlChA += "</div>\n";
327          }
328          HtmlChA += "</div>\n";
329          HtmlChA += "</div>\n";
330      }
331  	HtmlChA += "</body></html>";
332  }
333  TStr TBTAServer::GetIpNumLink(const int& IpNumId) {
334      TStr IpNumNm = BtaDevDefBs->GetIpNumNm(IpNumId);
335      return TStr::Fmt("<a href=\"/device?id=%d\">%s</a>", IpNumId, IpNumNm.CStr());
336  } 
337  TStr TBTAServer::GetProjLink(const int& IpNumId) {
338      TStr ProjStr;
339      if (BtaCorrBs->IsIpNumProj(IpNumId)) {
340          const int ProjId = BtaCorrBs->GetIpNumProjId(IpNumId);
341          TStr ProjNm = BtaDevDefBs->GetProjNm(ProjId);
342          ProjStr += TStr::Fmt("<a href=\"/project?id=%d\">%s</a>", ProjId, ProjNm.CStr());
343      } else {
344          ProjStr = "&nbsp;";
345      }
346      return ProjStr;
347  } 
348  TStr TBTAServer::GetProjLinkFromProj(const int& ProjId) {
349      TStr ProjNm = BtaDevDefBs->GetProjNm(ProjId);
350      return TStr::Fmt("<a href=\"/project?id=%d\">%s</a>", ProjId, ProjNm.CStr());
351  } 
352  TStr TBTAServer::GetBar(const double& Val, const double& _MxVal) {
353      double MxVal = TFlt::GetMx(_MxVal, TFlt::Eps);
354      if (MxVal < 1.0) { MxVal *= 1.2; }
355      return TStr::Fmt("<div style=\"width: %d%%; background-color: #cc0033;\">&nbsp;</div>", 
356          TInt::GetMn(TFlt::Round(100.0 * Val / MxVal), 100));
357  }
358  void TBTAServer::EventStat(const int& EventId, TChA& HtmlChA) {
359      TBtaEvent Event = BtaEventBs->GetEvent(EventId);
360      TBtaEventDat EventDat; BtaEventBs->GetEventDat(Event.GetBlobPt(), EventDat);
361      HtmlChA += "<p><b>#</b> " + TInt(EventId+1).GetStr() + "</br>";
362      HtmlChA += "<b>NodeId:</b> " + EventDat.GetNodeId() + "<br>";
363      HtmlChA += "<b>First occurance:</b> " + EventDat.GetFirstTm() + "<br>";
364      HtmlChA += "<b>Last occurance:</b> " + EventDat.GetLastTm() + "<br>";
365      HtmlChA += "<b>IP:</b> " + GetIpNumLink(Event.GetIpNumId()) + "<br>";
366      HtmlChA += "<b>Case Id:</b> " + EventDat.GetIR() + "<br>";
367      HtmlChA += "<b>Severity:</b> " + EventDat.GetSeverity() + "<br>";
368      HtmlChA += "<b>Project:</b> " + GetProjLinkFromProj(Event.GetProjId()) + "<br>";
369      HtmlChA += "<b>Summary:</b> " + EventDat.GetSummary() + "</p>";
370  }
371  void TBTAServer::EventShortStat(const int& EventId, TChA& HtmlChA) {
372      TBtaEvent Event = BtaEventBs->GetEvent(EventId);
373      TBtaEventDat EventDat; BtaEventBs->GetEventDat(Event.GetBlobPt(), EventDat);
374  	HtmlChA += "<small><b>Trap " + TInt(EventId+1).GetStr() + ":</b></br>";
375  	HtmlChA += "<b>IP:</b> " + BtaDevDefBs->GetIpNumNm(Event.GetIpNumId()) + ", ";
376      HtmlChA += "<b>Severity:</b> " + EventDat.GetSeverity() + ", ";
377      HtmlChA += "<b>Project:</b> " + BtaDevDefBs->GetProjNm(Event.GetProjId()) + "<br>";
378      HtmlChA += "<b>Summary:</b> " + EventDat.GetSummary() + "</small><br>";
379  }
380  void TBTAServer::EventFullStat(const int& EventId, TChA& HtmlChA) {
381      TBtaEvent Event = BtaEventBs->GetEvent(EventId);
382      TBtaEventDat EventDat; BtaEventBs->GetEventDat(Event.GetBlobPt(), EventDat);
383      const TStrStrH& FldNmToValH = EventDat.FldNmToValH;
384      int KeyId = FldNmToValH.FFirstKeyId();
385      HtmlChA += "<p>";
386      while (FldNmToValH.FNextKeyId(KeyId)) {
387          TStr FldNm = FldNmToValH.GetKey(KeyId);
388          TStr FldVal = FldNmToValH[KeyId];
389          HtmlChA += "<b>" + FldNm + ":</b> " + FldVal + "<br>\n";
390      }
391      HtmlChA += "</p>";
392  }
393  void TBTAServer::EventRootCause(const int& EventId, TChA& HtmlChA) {
394      TIntFltKdV EventIdScoreV; TStrV CorrTypeV;
395      BtaCorrBs->EventRootCause(BtaEventBs, EventId, RootCouseEventWnd, 
396          RootCouseTimeWnd, EventIdScoreV, CorrTypeV);
397      HtmlChA += "<table border=\"1\">\n";
398      DisplayEventHeader(false, true, true, HtmlChA);
399      const int IpNumId = BtaEventBs->GetEvent(EventId).GetIpNumId();
400      for (int EventIdScoreN = 0; EventIdScoreN < EventIdScoreV.Len(); EventIdScoreN++) {
401          const int ScoreEventId = EventIdScoreV[EventIdScoreN].Key;
402          const double Score = EventIdScoreV[EventIdScoreN].Dat;
403          const int ScoreIpNumId = BtaEventBs->GetEvent(ScoreEventId).GetIpNumId();
404          TBtaEvent ScoreEvent = BtaEventBs->GetEvent(ScoreEventId);
405          TBtaEventDat ScoreEventDat; 
406          BtaEventBs->GetEventDat(ScoreEvent.GetBlobPt(), ScoreEventDat);
407          if (CorrTypeV[EventIdScoreN] == "Prob") {
408              DisplayEventRow(ScoreEventId, ScoreEvent, ScoreEventDat, 
409                  false, true, Score, 1.0, ScoreIpNumId, IpNumId, HtmlChA);
410          } else {
411              DisplayEventRow(ScoreEventId, ScoreEvent, ScoreEventDat, 
412                  false, true, Score, 1.0, ScoreIpNumId, -1, HtmlChA);
413          }
414      }
415      HtmlChA += "</table>\n";
416  }
417  void TBTAServer::EventShortRootCause(const int& EventId, TChA& HtmlChA) {
418      TIntFltKdV EventIdScoreV; TStrV CorrTypeV;
419      BtaCorrBs->EventRootCause(BtaEventBs, EventId, RootCouseEventWnd, 
420          RootCouseTimeWnd, EventIdScoreV, CorrTypeV);
421      HtmlChA += "<table border=\"1\">\n";
422      DisplayShortEventHeader(true, HtmlChA);
423      for (int EventIdScoreN = 0; EventIdScoreN < EventIdScoreV.Len(); EventIdScoreN++) {
424          const int ScoreEventId = EventIdScoreV[EventIdScoreN].Key;
425          const double Score = EventIdScoreV[EventIdScoreN].Dat;
426          TBtaEvent ScoreEvent = BtaEventBs->GetEvent(ScoreEventId);
427          TBtaEventDat ScoreEventDat; 
428          BtaEventBs->GetEventDat(ScoreEvent.GetBlobPt(), ScoreEventDat);
429          DisplayShortEventRow(ScoreEventId, ScoreEvent, 
430              ScoreEventDat, true, Score, 1.0, HtmlChA);
431      }
432      HtmlChA += "</table>\n";
433  }
434  void TBTAServer::EventPredIpNums(const int& EventId, TChA& HtmlChA) {
435      const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
436      const int CurrIpNumId = Event.GetIpNumId();
437      const int CurrProjId = Event.GetProjId();
438      TIntFltH IpNumIdProbH;
439      BtaCorrBs->GetNextIpNumIdProb(EventId, 
440          CurrProjId, BtaEventBs, 100, 600, IpNumIdProbH);
441      if (IpNumIdProbH.Empty()) { return; }
442      TFltIntPrV ProbIpNumIdV; IpNumIdProbH.GetDatKeyPrV(ProbIpNumIdV); ProbIpNumIdV.Sort(false);
443      HtmlChA += "<table border=\"1\">\n";
444      HtmlChA += "<tr>";
445      HtmlChA += "<td>#</td>";
446      HtmlChA += "<td>Device</td>";
447      HtmlChA += "<td>Probability</td>";
448      HtmlChA += "<td>Next alarm</td>";
449      HtmlChA += "</tr>\n";
450      double MxProb = 0.0; int ProbIpNumIdN = 0, RowCount = 0;
451      while (ProbIpNumIdN < ProbIpNumIdV.Len()) {
452          const int IpNumId = ProbIpNumIdV[ProbIpNumIdN].Val2; 
453          const int ProjId = BtaCorrBs->GetIpNumProjId(IpNumId);
454          ProbIpNumIdN++; if (ProjId != CurrProjId) { continue; }
455          const double Prob = ProbIpNumIdV[ProbIpNumIdN].Val1;
456          if (RowCount == 0) { MxProb = Prob; }
457          HtmlChA += "<tr>";
458          HtmlChA += "<td>" + TInt(RowCount+1).GetStr() + "</td>";
459          HtmlChA += "<td>" + GetIpNumLink(IpNumId) + " (" + GetProjLink(IpNumId) + ")</td>";
460          HtmlChA += "<td>" + GetBar(Prob, MxProb) + "</td>";
461          const int NextEventN = BtaEventBs->GetNextEvent(EventId+1, IpNumId);
462          if (NextEventN != -1) {
463              const TBtaEvent& NextEvent = BtaEventBs->GetEvent(NextEventN);
464              HtmlChA += TStr::Fmt("<td><a href=\"/event?id=%d\">%d</a></td>", NextEventN, NextEventN);
465          } else {
466              HtmlChA += "<td>--</td>";
467          }
468          HtmlChA += "</tr>\n";
469          RowCount++; if (RowCount >= 5) { break; }
470      }
471      HtmlChA += "</table>\n";
472  }
473  void TBTAServer::EventShortPredIpNums(const int& EventId, TChA& HtmlChA) {
474      const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
475      const int CurrIpNumId = Event.GetIpNumId();
476      const int CurrProjId = Event.GetProjId();
477      TIntFltH IpNumIdProbH;
478      BtaCorrBs->GetNextIpNumIdProb(EventId, 
479          CurrProjId, BtaEventBs, 100, 600, IpNumIdProbH);
480      if (IpNumIdProbH.Empty()) { return; }
481      TFltIntPrV ProbIpNumIdV; IpNumIdProbH.GetDatKeyPrV(ProbIpNumIdV); ProbIpNumIdV.Sort(false);
482      HtmlChA += "<table border=\"1\">\n";
483      HtmlChA += "<tr>";
484      HtmlChA += "<td>#</td>";
485      HtmlChA += "<td>Device</td>";
486      HtmlChA += "<td>Probability</td>";
487      HtmlChA += "</tr>\n";
488      double MxProb = 0.0; int ProbIpNumIdN = 0, RowCount = 0;
489      while (ProbIpNumIdN < ProbIpNumIdV.Len()) {
490          const int IpNumId = ProbIpNumIdV[ProbIpNumIdN].Val2; 
491          const int ProjId = BtaCorrBs->GetIpNumProjId(IpNumId);
492          ProbIpNumIdN++; if (ProjId != CurrProjId) { continue; }
493          const double Prob = ProbIpNumIdV[ProbIpNumIdN].Val1;
494          if (RowCount == 0) { MxProb = Prob; }
495          HtmlChA += "<tr>";
496          HtmlChA += "<td>" + TInt(RowCount+1).GetStr() + "</td>";
497          HtmlChA += "<td>" + GetIpNumLink(IpNumId) + " (" + GetProjLink(IpNumId) + ")</td>";
498          HtmlChA += "<td>" + GetBar(Prob, MxProb) + "</td>";
499          HtmlChA += "</tr>\n";
500          RowCount++; if (RowCount >= 5) { break; }
501      }
502      HtmlChA += "</table>\n";
503  }
504  void TBTAServer::DisplayEventHeader(const bool& HdSortP, 
505          const bool& ScoreP, const bool& LinkP, TChA& HtmlChA) {
506      HtmlChA += "<tr>";
507      if (HdSortP) {
508          HtmlChA += "<td># (<a href=\"/events?sort=all\">all</a>)</td>";
509          HtmlChA += "<td>First</td>";
510          HtmlChA += "<td>Last</td>";
511          HtmlChA += "<td>Device IP</td>";
512          HtmlChA += "<td>CaseID (<a href=\"/events?sort=case_id\">filter</a>)</td>";
513      } else { 
514          HtmlChA += "<td>#</td>";
515          HtmlChA += "<td>First</td>";
516          HtmlChA += "<td>Device IP</td>";
517          HtmlChA += "<td>CaseID (IR)</td>";
518      }
519      HtmlChA += "<td>Severity</td>";
520      HtmlChA += "<td>Project</td>";
521      HtmlChA += "<td width=\"250\">Summary</td>";
522      if (ScoreP) { HtmlChA += "<td>Score</td>"; }
523      if (LinkP) { HtmlChA += "<td></td>"; }
524      HtmlChA += "</tr>\n";
525  }
526  void TBTAServer::DisplayEventRow(const int& EventN, const TBtaEvent& Event, 
527          const TBtaEventDat& EventDat, const bool& HdSortP, const bool& ScoreP, 
528          const double& Score, const double& MxScore, const int& IpNumId, 
529          const int& CorrIpNumId, TChA& HtmlChA) {
530      HtmlChA += "<tr>";
531      HtmlChA += TStr::Fmt("<td><a href=\"/event?id=%d\">%d</a> ", EventN, EventN);
532      HtmlChA += TStr::Fmt("(<a onClick=\"window.open('/related_traps?id=%d\','omnibus_view','menubar=0,resizable=1,scrollbars=1,width=600,height=500');\">Omnibus</a>)</td>", EventN);
533      HtmlChA += "<td>" + EventDat.GetFirstTm() + "</td>";
534      if (HdSortP) { HtmlChA += "<td>" + EventDat.GetLastTm() + "</td>"; }
535      HtmlChA += "<td>" + GetIpNumLink(Event.GetIpNumId()) + "</td>";
536      HtmlChA += "<td>" + EventDat.GetIR() + "</td>";
537      HtmlChA += "<td>" + EventDat.GetSeverity() + "</td>";
538      HtmlChA += "<td>" + GetProjLinkFromProj(Event.GetProjId()) + "</td>";
539      HtmlChA += "<td><small>" + EventDat.GetSummary() + "</small></td>";
540      if (ScoreP) { 
541          HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(Score, MxScore).CStr()); 
542      }
543      if (IpNumId != -1 && CorrIpNumId != -1) {
544          HtmlChA += TStr::Fmt("<td><a href=\"/dd_events?id=%d&corrid=%d\">historic co-occucerence</a></td>",
545              IpNumId, CorrIpNumId);
546      } else if (IpNumId != -1 && CorrIpNumId == -1) {
547          HtmlChA += "<td>similar summary text</td>";
548      }
549      HtmlChA += "</tr>\n";
550  }
551  void TBTAServer::DisplayShortEventHeader(const bool& ScoreP, TChA& HtmlChA) {
552      HtmlChA += "<tr>";
553      HtmlChA += "<td>Trap</td>";
554      HtmlChA += "<td>Device</td>";
555      HtmlChA += "<td width=\"150\">Summary</td>";
556      if (ScoreP) { HtmlChA += "<td width=\"20\"></td>"; }
557      HtmlChA += "</tr>\n";
558  }
559  void TBTAServer::DisplayShortEventRow(const int& EventN, const TBtaEvent& Event, 
560          const TBtaEventDat& EventDat, const bool& ScoreP, const double& Score, 
561          const double& MxScore, TChA& HtmlChA) {
562      HtmlChA += "<tr>";
563      HtmlChA += "<td><a href=\"/related_traps?id=" + TInt::GetStr(EventN) + "\">" + 
564          TInt(EventN).GetStr() + "</a></td>";
565      HtmlChA += "<td>" + BtaDevDefBs->GetIpNumNm(Event.GetIpNumId()) + "</td>";
566      HtmlChA += "<td><small>" + EventDat.GetSummary() + "</small></td>";
567      if (ScoreP) { HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(Score, MxScore).CStr()); }
568      HtmlChA += "</tr>\n";
569  }
570  void TBTAServer::MakeEventList(const TIntV& EventV, 
571          const bool& HdSortP, const int& DispPageN, TChA& HtmlChA) {
572      HtmlChA += "<table border=\"1\">\n";
573      DisplayEventHeader(HdSortP, false, false, HtmlChA);
574      const int Events = EventV.Len(); 
575      int EventN = Events - DispPageN*ListEventsPerPage;
576      const int MnEventN = TInt::GetMx(Events - (DispPageN+1)*ListEventsPerPage, 0);
577      while (EventN > MnEventN) {
578          EventN--;
579          TBtaEvent Event = BtaEventBs->GetEvent(EventV[EventN]);
580          TBtaEventDat EventDat; BtaEventBs->GetEventDat(Event.GetBlobPt(), EventDat);
581          if (Event.GetIpNumId() != -1 && Event.GetProjId() != -1) {
582              DisplayEventRow(EventV[EventN], Event, 
583                  EventDat, HdSortP, false, 0.0, 0.1, -1, -1, HtmlChA);
584          } else { 
585              printf("Error: EventN == %d, IpNumId == %d, ProjId  == %d\n", 
<span onclick='openModal()' class='match'>586                  EventV[EventN].Val, Event.GetIpNumId(), Event.GetProjId()); 
587          }
588      }
589      HtmlChA += "</table>\n";
590  }
591  void TBTAServer::MakeEventPrList(const TIntPrV& EventPrV, const int& DispPageN, TChA& HtmlChA) {
</span>592      TIntIntVH EventIdIdVH; 
593      const int EventPrs = EventPrV.Len();
594      for (int EventPrN = 0; EventPrN < EventPrs; EventPrN++) {
595          const TIntPr& EventPr = EventPrV[EventPrs - EventPrN - 1];
596          EventIdIdVH.AddDat(EventPr.Val1).Add(EventPr.Val2);
597      }
598      HtmlChA += "<table border=\"1\">\n";
599      HtmlChA += "<tr>";
600      HtmlChA += "<td>#</td>";
601      HtmlChA += "<td>Time</td>";
602      HtmlChA += "<td>Device IP</td>";
603      HtmlChA += "<td>Summary</td>";
604      HtmlChA += "<td>Correlated with event sequence</td>";
605      HtmlChA += "</tr>\n";
606      const int Events = EventIdIdVH.Len(); 
607      int EventKeyId = EventIdIdVH.FFirstKeyId(), PageN = 0, EventsOnLastPage = 0;
608      while (EventIdIdVH.FNextKeyId(EventKeyId) && !(PageN > DispPageN)) {
609          if (PageN == DispPageN) {
610              const int EventId = EventIdIdVH.GetKey(EventKeyId);
611              TBtaEvent Event = BtaEventBs->GetEvent(EventId);
612              TBtaEventDat EventDat; BtaEventBs->GetEventDat(Event.GetBlobPt(), EventDat);
613              HtmlChA += "<tr valign=\"top\">";
614              HtmlChA += "<td><a href=\"/event?id=" + TInt::GetStr(EventId) + 
615                  "\">" + TInt(EventId).GetStr() + "</a></td>";
616              HtmlChA += "<td>" + EventDat.GetFirstTm() + "</td>";
617              HtmlChA += "<td>" + GetIpNumLink(Event.GetIpNumId()) + "</td>";
618              HtmlChA += "<td>" + TruncStr(EventDat.GetSummary(), 60) + "</td>";
619              HtmlChA += "<td>\n";
620              HtmlChA += "<table border=\"1\">";
621              HtmlChA += "<tr>";
622              HtmlChA += "<td>#</td>";
623              HtmlChA += "<td>Time</td>";
624              HtmlChA += "<td>Device IP</td>";
625              HtmlChA += "<td>Summary</td>";
626              HtmlChA += "</tr>\n";
627              const TIntV& CorrEventIdV = EventIdIdVH[EventKeyId];
628              for (int CorrEventIdN = 0; CorrEventIdN < CorrEventIdV.Len(); CorrEventIdN++) {
629                  const int CorrEventId = CorrEventIdV[CorrEventIdN];
630                  TBtaEvent CorrEvent = BtaEventBs->GetEvent(CorrEventId);
631                  TBtaEventDat CorrEventDat; BtaEventBs->GetEventDat(
632                      CorrEvent.GetBlobPt(), CorrEventDat);
633                  HtmlChA += "<tr valign=\"top\">";
634                  HtmlChA += "<td><a href=\"/event?id=" + TInt::GetStr(CorrEventId) + 
635                      "\">" + TInt(CorrEventId).GetStr() + "</a></td>";
636                  HtmlChA += "<td>" + CorrEventDat.GetFirstTm() + "</td>";
637                  HtmlChA += "<td>" + GetIpNumLink(CorrEvent.GetIpNumId()) + "</td>";
638                  HtmlChA += "<td>" + TruncStr(CorrEventDat.GetSummary(), 60) + "</td>";
639                  HtmlChA += "</tr>";
640              }
641              HtmlChA += "</table>\n";
642              HtmlChA += "</td></tr>\n";
643              HtmlChA += "<tr><td colspan=\"5\">&nbsp;</td></tr>";
644          }
645          EventsOnLastPage += EventIdIdVH[EventKeyId].Len();
646          if (EventsOnLastPage > ListEventsPerPage) { 
647              PageN++; EventsOnLastPage = 0; 
648          }
649      }
650      HtmlChA += "</table>\n";
651  }
652  void TBTAServer::MakeShortEventList(const TIntV& EventV, TChA& HtmlChA) {
653      HtmlChA += "<table border=\"1\">\n";
654      DisplayShortEventHeader(false, HtmlChA);
655      const int Events = TInt::GetMn(ListEventsPerPage, EventV.Len());
656      for (int EventN = 0; EventN < Events; EventN++) {
657          TBtaEvent Event = BtaEventBs->GetEvent(EventV[EventN]);
658          TBtaEventDat EventDat; BtaEventBs->GetEventDat(Event.GetBlobPt(), EventDat);
659          if (Event.GetIpNumId() != -1 && Event.GetProjId() != -1) {
660              DisplayShortEventRow(EventV[EventN], Event, EventDat, false, 0.0, 1.0, HtmlChA);
661          } else { 
662              printf("Error: EventN == %d, IpNumId == %d, ProjId  == %d\n", 
663                  EventV[EventN].Val, Event.GetIpNumId(), Event.GetProjId()); 
664          }
665      }
666      HtmlChA += "</table>\n";
667  }
668  void TBTAServer::IpNumDevCorrStat(const int& IpNumId, TChA& HtmlChA) {
669      TIntFltKdV CorrIpNumIdV;
670      BtaCorrBs->GetIpNumCorrDevices(IpNumId, true, DetailItemsPerPage, CorrIpNumIdV);
671      HtmlChA += "<table border=\"1\">\n";
672      HtmlChA += "<tr>";
673      HtmlChA += "<td>#</td>";
674      HtmlChA += "<td>Device</td>";
675      HtmlChA += "<td>Correlation</td>";
676      HtmlChA += "<td>When does it fire alarms?</td>";
677      HtmlChA += "</tr>\n";
678      for (int CorrIpNumIdN = 0; CorrIpNumIdN < CorrIpNumIdV.Len(); CorrIpNumIdN++) {
679          const int CorrIpNumId = CorrIpNumIdV[CorrIpNumIdN].Key;
680          const double CorrProb = TFlt::Abs(CorrIpNumIdV[CorrIpNumIdN].Dat);
681          const int Sign = TFlt::Sign(CorrIpNumIdV[CorrIpNumIdN].Dat);
682          const double MxCorrProb = TFlt::Abs(CorrIpNumIdV[0].Dat);
683          if (CorrProb < MnCorrProb) { break; }
684          HtmlChA += "<tr>";
685          HtmlChA += "<td>" + TInt(CorrIpNumIdN+1).GetStr() + "</td>";
686          HtmlChA += "<td>" + GetIpNumLink(CorrIpNumId) + " (" + GetProjLink(CorrIpNumId) + ")</td>";
687          HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(CorrProb, MxCorrProb).CStr());            
688          if (Sign > 0) { 
689              HtmlChA += TStr::Fmt("<td>after (<a href=\"/dd_events?id=%d&corrid=%d\">correlated alarms</a>)</td>",
690                  IpNumId, CorrIpNumId);
691          } else { 
692              HtmlChA += TStr::Fmt("<td>before (<a href=\"/dd_events?id=%d&corrid=%d\">correlated alarms</a>)</td>",
693                  CorrIpNumId, IpNumId);
694          }
695          HtmlChA += "</tr>\n";
696      }
697      HtmlChA += "</table>\n";
698  }
699  void TBTAServer::ShortIpNumStat(const int& IpNumId, TChA& HtmlChA) {
700      TStr IpNumNm = BtaDevDefBs->GetIpNumNm(IpNumId);
701      HtmlChA += TStr::Fmt("<p><b>Device IP:</b> %s<br>\n", 
702          GetIpNumLink(IpNumId).CStr());
703      HtmlChA += TStr::Fmt("<b>Device project:</b> %s<br>\n", 
704          GetProjLink(IpNumId).CStr());
705      HtmlChA += TStr::Fmt("<b>Number of alarms:</b> %d</p>\n", 
706          BtaCorrBs->GetIpNumIdEvents(IpNumId));
707  }
708  void TBTAServer::MakeIpNumPrList(const TIntV& DevKeyIdV, const int& DispPageN, TChA& HtmlChA) {
709      HtmlChA += "<table border=\"1\">\n";
710      HtmlChA += "<tr>";
711      HtmlChA += "<td>#</td>";
712      HtmlChA += "<td>First device</td>";
713      HtmlChA += "<td>Second device</td>";
714      HtmlChA += "<td>Correlation</td>";
715      HtmlChA += "<td></td>";
716      HtmlChA += "</tr>\n";
717      const TIntPrIntPrVH& IpNumIdPrToFqH = BtaCorrBs->GetIpNumIdPrH();
718      const TIntPr& FirstIpNumIdPr = IpNumIdPrToFqH.GetKey(DevKeyIdV[0]);
719      const double MxCorrProb = BtaCorrBs->ProbCorrIpNumIdGivenIpNumId(
720          FirstIpNumIdPr.Val1, FirstIpNumIdPr.Val2);
721      const int StartItemN = DispPageN*ListItemsPerPage;
722      const int EndItemN = (DispPageN+1)*ListItemsPerPage;
723      const int DevKeyIds = DevKeyIdV.Len();
724      int DevKeyIdN = 0, ItemN = 0; 
725      while (DevKeyIdN < DevKeyIds && ItemN < EndItemN) {
726          const TIntPr& IpNumIdPr = IpNumIdPrToFqH.GetKey(DevKeyIdV[DevKeyIdN]);
727          const int IpNumId = IpNumIdPr.Val1, CorrIpNumId = IpNumIdPr.Val2;
728          DevKeyIdN++;
729          if (IpNumId == CorrIpNumId) { continue; }
730          ItemN++; if (ItemN < StartItemN) { continue; }
731          HtmlChA += "<tr>";
732          HtmlChA += "<td>" + TInt(ItemN).GetStr() + "</td>";
733          HtmlChA += "<td>" + GetIpNumLink(IpNumId) + " (" + GetProjLink(IpNumId) + ")</td>";
734          HtmlChA += "<td>" + GetIpNumLink(CorrIpNumId) + " (" + GetProjLink(CorrIpNumId) + ")</td>";
735          if (BtaCorrBs->IsIpNumId(IpNumId)) {
736              const double CorrProb = BtaCorrBs->ProbCorrIpNumIdGivenIpNumId(IpNumId, CorrIpNumId);
737              HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(CorrProb, MxCorrProb).CStr());
738          } else {
739              HtmlChA += "<td></td>";
740          }
741          HtmlChA += TStr::Fmt("<td><a href=\"/dd_events?id=%d&corrid=%d\">correlated alarms</a></td>",
742              IpNumId, CorrIpNumId);
743          HtmlChA += "</tr>\n";
744      }
745      HtmlChA += "</table>\n";
746  }
747  void TBTAServer::ProjWithinCorrStat(const int& ProjId, TChA& HtmlChA) {
748      HtmlChA += "<table border=\"1\">\n";
749      HtmlChA += "<tr>";
750      HtmlChA += "<td>#</td>";
751      HtmlChA += "<td>First device</td>";
752      HtmlChA += "<td>Second device</td>";
753      HtmlChA += "<td>Correlation</td>";
754      HtmlChA += "<td></td>";
755      HtmlChA += "</tr>\n";
756      TIntPrFltKdV CorrIpNumIdPrProbV;
757      BtaCorrBs->GetProjCorrDevices(ProjId, 
758          DetailItemsPerPage, CorrIpNumIdPrProbV);
759      const int IpNumPrs = CorrIpNumIdPrProbV.Len();
760      if (IpNumPrs > 0) {
761          double MxCorrProb = CorrIpNumIdPrProbV[0].Dat;
762          for (int IpNumPrN = 0; IpNumPrN < IpNumPrs; IpNumPrN++) {
763              const int IpNumId = CorrIpNumIdPrProbV[IpNumPrN].Key.Val1;
764              const int CorrIpNumId = CorrIpNumIdPrProbV[IpNumPrN].Key.Val2;
765              const double CorrProb = CorrIpNumIdPrProbV[IpNumPrN].Dat;
766              if (CorrProb < MnCorrProb) { break; }
767              HtmlChA += "<tr>";
768              HtmlChA += "<td>" + TInt(IpNumPrN+1).GetStr() + "</td>";
769              HtmlChA += "<td>" + GetIpNumLink(IpNumId) + "</td>";
770              HtmlChA += "<td>" + GetIpNumLink(CorrIpNumId) + "</td>";
771              HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(CorrProb, MxCorrProb).CStr());
772              HtmlChA += TStr::Fmt("<td><a href=\"/dd_events?id=%d&corrid=%d\">correlated alarms</a></td>",
773                  IpNumId, CorrIpNumId);
774              HtmlChA += "</tr>\n";
775          }
776      }
777      HtmlChA += "</table>\n";
778  }
779  void TBTAServer::ShortProjStat(const int& ProjId, TChA& HtmlChA, const bool& ProjNmLinkP) {
780      TStr ProjNm = BtaDevDefBs->GetProjNm(ProjId);
781      if (!ProjNmLinkP) { 
782          HtmlChA += TStr::Fmt("<p>Project name: <b>%s</b></p>\n", 
783              ProjNm.CStr()); 
784      } else { 
785          HtmlChA += TStr::Fmt("<p>Project name: <b>%s</b></p>\n", 
786              GetProjLinkFromProj(ProjId).CStr()); 
787      }
788      int BeforeCount, WeekAfterCount, MonthAfterCount;
789      TTm StartDate = BtaEventBs->GetFirstTime(), EndDate = BtaEventBs->GetLastTime();
790      TTm WeekBreakDate = GetBreakDate(7), MonthBreakDate = GetBreakDate(30);
791      PBtaLongProj LongProj = BtaLongBs->GetLongProjFromId(ProjId);
792      LongProj->Count(StartDate, WeekBreakDate, EndDate, BeforeCount, WeekAfterCount);
793      LongProj->Count(StartDate, MonthBreakDate, EndDate, BeforeCount, MonthAfterCount);
794      const int TotalCount = BeforeCount + MonthAfterCount;
795      const bool IsWeekTrendPosP = LongProj->IsTrendPos(StartDate, WeekBreakDate, EndDate);
796      const bool IsMonthTrendPosP = LongProj->IsTrendPos(StartDate, MonthBreakDate, EndDate);
797      const double WeekChiProb = LongProj->ChiSquare(StartDate, WeekBreakDate, EndDate);
798      const double MonthChiProb = LongProj->ChiSquare(StartDate, MonthBreakDate, EndDate);  
799      HtmlChA += TStr::Fmt("</p>Number of alarms: <b>%d</b> (severity > 2)<br>\n", TotalCount);
800      if (WeekChiProb < 0.05) {
801          HtmlChA += TStr::Fmt("Number of alarms in last 7 days: <b>%d</b> (%s)<br>\n", 
802              WeekAfterCount, IsWeekTrendPosP ? "increasing" : "decreasing");
803      } else {
804          HtmlChA += TStr::Fmt("Number of alarms in last 7 days: <b>%d</b><br>\n", WeekAfterCount);
805      }
806      if (MonthChiProb < 0.05) {
807          HtmlChA += TStr::Fmt("Number of alarms in last 30 days: <b>%d</b> (%s)</p>\n", 
808              MonthAfterCount, IsMonthTrendPosP ? "increasing" : "decreasing");
809      } else {
810          HtmlChA += TStr::Fmt("Number of alarms in last 30 days: <b>%d</b></p>\n", MonthAfterCount);
811      }
812  }
813  void TBTAServer::MakeLongProjList(const TIntV& SortProjIdV, 
814          const int& DispPageN, const TStr& PeriodStr, TChA& HtmlChA) {
815      HtmlChA += "<table border=\"1\">\n";
816      HtmlChA += "<tr>";
817      HtmlChA += "<td>#</td>";
818      HtmlChA += "<td>Project</td>";
819      HtmlChA += "<td>Significance</td>";
820      HtmlChA += "<td></td>";
821      HtmlChA += "</tr>\n";
822      TTm StartDate = BtaEventBs->GetFirstTime();
823      TTm BreakDate = GetBreakDate(PeriodStr == "week" ? 7 : 30);
824      TTm EndDate = BtaEventBs->GetLastTime();
825      const int Projs = TInt::GetMn((DispPageN+1)*ListItemsPerPage, SortProjIdV.Len());
826      for (int ProjN = DispPageN*ListItemsPerPage; ProjN < Projs; ProjN++) {
827          const int ProjId = SortProjIdV[ProjN];
828          PBtaLongProj LongProj = BtaLongBs->GetLongProjFromId(ProjId);
829          const double ChiProb = MxChiProb - LongProj->ChiSquare(StartDate, BreakDate, EndDate);
830          int BeforeCount, AfterCount; LongProj->Count(
831              StartDate, BreakDate, EndDate, BeforeCount, AfterCount);
832          const bool IsTrendPosP = LongProj->IsTrendPos(StartDate, BreakDate, EndDate);
833          HtmlChA += "<tr>";
834          HtmlChA += TStr::Fmt("<td>%d</td>", ProjN + 1);
835          HtmlChA += TStr::Fmt("<td>%s</td>", GetProjLinkFromProj(ProjId).CStr());
836          HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(ChiProb, MxChiProb).CStr());
837          HtmlChA += TStr::Fmt("<td><a href=\"/p_long?id=%d&period=%s\">Show Details</td>",
838              ProjId, PeriodStr.CStr());
839          HtmlChA += "</tr>\n";
840      }
841      HtmlChA += "</table>\n";
842  }
843  void TBTAServer::MakeLongIpNumList(const int& ProjId, 
844          const int& DispPageN, const TStr& PeriodStr, TChA& HtmlChA) {
845      HtmlChA += "<table border=\"1\">\n";
846      HtmlChA += "<tr>";
847      HtmlChA += "<td>#</td>";
848      HtmlChA += "<td>Device IP</td>";
849      HtmlChA += "<td>Significance</td>";
850      HtmlChA += "<td>Avg. alarms</td>";
851      HtmlChA += "<td>In last " + PeriodStr + "</td>";
852      HtmlChA += "<td>Trend</td>";
853      HtmlChA += "</tr>\n";
854      TTm StartDate = BtaEventBs->GetFirstTime();
855      TTm BreakDate = GetBreakDate(PeriodStr == "week" ? 7 : 30);
856      TTm EndDate = BtaEventBs->GetLastTime();
857      PBtaLongProj LongProj = BtaLongBs->GetLongProjFromId(ProjId);
858      TIntFltKdV IpNumIdWgtV; LongProj->GetIpNumWgtV(StartDate, BreakDate, EndDate, IpNumIdWgtV);
859      const double MxIpNumWgt = IpNumIdWgtV[0].Dat;
860      const int IpNums = TInt::GetMn((DispPageN+1)*ListItemsPerPage, IpNumIdWgtV.Len());
861      for (int IpNumN = DispPageN*ListItemsPerPage; IpNumN < IpNums; IpNumN++) {
862          const int IpNumId = IpNumIdWgtV[IpNumN].Key;
863          const double IpNumWgt = IpNumIdWgtV[IpNumN].Dat;
864          if ((IpNumWgt / MxIpNumWgt) < MnChiVal) { break; }
865          double AvgCount; int LastCount; 
866          GetIpNumEventCount(IpNumId, StartDate, BreakDate, EndDate, AvgCount, LastCount);
867          const bool IsTrendPosP = (double(LastCount) > AvgCount);
868          HtmlChA += "<tr>";
869          HtmlChA += TStr::Fmt("<td>%d</td>", IpNumN + 1);
870          HtmlChA += TStr::Fmt("<td>%s</td>", GetIpNumLink(IpNumId).CStr());
871          HtmlChA += TStr::Fmt("<td>%s</td>", GetBar(IpNumWgt, MxIpNumWgt).CStr());
872          HtmlChA += TStr::Fmt("<td>%.2f</td>", AvgCount);
873          HtmlChA += TStr::Fmt("<td>%d</td>", LastCount);
874          HtmlChA += TStr::Fmt("<td>%s</td>", IsTrendPosP ? "+" : "-");
875          HtmlChA += "</tr>\n";
876      }
877      HtmlChA += "</table>\n";
878  }
879  void TBTAServer::RunGnuPlot(const TStr& PlotFNm) const {
880    TStr GPPath = GnuPlotPath;
881    IAssertR(TFile::Exists(GPPath), TStr("GnuPlot not found at '")+GnuPlotPath+"'. Set TGnuPlot::GnuPlotPath.");
882    system(TStr::Fmt("%s %s", GPPath.CStr(), PlotFNm.CStr()).CStr());
883  }
884  void TBTAServer::PlotEventV(const TStr& TitleStr, const TIntV& EventV, 
885          const TStr& PlotFNm, const int& Width, const int& Height) {
886      TUInt64H DateCountH;
887      for (int EventIdN = 0; EventIdN < EventV.Len(); EventIdN++) {
888          const int EventId = EventV[EventIdN];
889          const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
890          TTm EventTm = Event.GetFirstTm();
891          TTm DayEventTm(EventTm.GetYear(), EventTm.GetMonth(), EventTm.GetDay());
892          DateCountH.AddDat(TTm::GetMSecsFromTm(DayEventTm))++;
893      }
894      TUInt64IntPrV DateCountV;
895      DateCountH.GetKeyDatPrV(DateCountV);
896      DateCountV.Sort(true);
897      int MxCount = 0;
898      {
899          TFOut DataFOut(PlotFNm + ".tab"); 
900          DataFOut.PutStrLn("# day count");
901          for (int DayN = 0; DayN < DateCountV.Len(); DayN++) {
902              MxCount = TInt::GetMx(MxCount, DateCountV[DayN].Val2); 
903              DataFOut.PutStrLn(TStr::Fmt("%d %d", DayN+1, DateCountV[DayN].Val2));
904          }
905          DataFOut.Flush();
906      }
907      double MxCountFlt = (double)MxCount * 1.15;
908      {
909          TFOut PlotFOut(PlotFNm);
910          PlotFOut.PutStrLn("# event plot");
911          PlotFOut.PutStrLn(TStr::Fmt("set autoscale"));
912          PlotFOut.PutStrLn(TStr::Fmt("set xrange [0:%d]", DateCountV.Len() + 1));
913          PlotFOut.PutStrLn(TStr::Fmt("set yrange [0:%.2f]", MxCountFlt));
914          PlotFOut.PutStrLn(TStr::Fmt("set terminal png large size %d,%d", Width, Height));
915          PlotFOut.PutStrLn(TStr::Fmt("set output '%s.png'", PlotFNm.CStr()));
916          PlotFOut.PutStrLn(TStr::Fmt("set boxwidth 0.8"));
917          PlotFOut.PutStr(TStr::Fmt("set xtics rotate  ( "));
918          const int Dates = DateCountV.Len() > 10 ? 10 : DateCountV.Len();
919          double DayDiff = double(DateCountV.Len()) / double(Dates);
920          for (int DateN = 0; DateN < Dates; DateN++) {
921              const int DayN = TFlt::Round(DateN * DayDiff);
922              IAssertR(0 <= DayN && DayN < DateCountV.Len(), TInt::GetStr(DayN));
923              const uint64 DateMSecs = DateCountV[DayN].Val1.Val;
924              TStr DateStr = TTm::GetTmFromMSecs(DateMSecs).GetWebLogDateStr();
925              if (DateN != 0) { PlotFOut.PutStr(", "); }
926              PlotFOut.PutStr(TStr::Fmt("\" %s\" %d", DateStr.CStr(), DayN+1));
927          }
928          PlotFOut.PutStrLn(")");
929          PlotFOut.PutStrLn("set xlabel \"Time\"");
930          PlotFOut.PutStrLn(TStr::Fmt("plot \"%s.tab\" using 1:2 title \"%s\" with boxes", 
931              PlotFNm.CStr(), TitleStr.CStr()));
932      }
933      RunGnuPlot(PlotFNm);
934  }
935  void TBTAServer::PlotEventV(const TStr& TitleStr, const TIntV& EventV, 
936          const TStr& CorrTitleStr, const TIntV& CorrEventV, const TStr& PlotFNm) {
937      TUInt64IntPrH DateCountH;
938      for (int EventIdN = 0; EventIdN < EventV.Len(); EventIdN++) {
939          const int EventId = EventV[EventIdN];
940          const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
941          TTm EventTm = Event.GetFirstTm();
942          TTm DayEventTm(EventTm.GetYear(), EventTm.GetMonth(), EventTm.GetDay());
943          DateCountH.AddDat(TTm::GetMSecsFromTm(DayEventTm)).Val1++;
944      }
945      for (int EventIdN = 0; EventIdN < CorrEventV.Len(); EventIdN++) {
946          const int EventId = CorrEventV[EventIdN];
947          const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
948          TTm EventTm = Event.GetFirstTm();
949          TTm DayEventTm(EventTm.GetYear(), EventTm.GetMonth(), EventTm.GetDay());
950          DateCountH.AddDat(TTm::GetMSecsFromTm(DayEventTm)).Val2++;
951      }
952      TUInt64IntPrPrV DateCountV;
953      DateCountH.GetKeyDatPrV(DateCountV);
954      DateCountV.Sort(true);
955      int MxCount = 0;
956      {
957          TFOut DataFOut(PlotFNm + ".tab"); 
958          DataFOut.PutStrLn("# day count");
959          for (int DayN = 0; DayN < DateCountV.Len(); DayN++) {
960              MxCount = TInt::GetMx(MxCount, DateCountV[DayN].Val2.Val1); 
961              MxCount = TInt::GetMx(MxCount, DateCountV[DayN].Val2.Val2); 
962              DataFOut.PutStrLn(TStr::Fmt("%d %d %d", DayN+1, 
963                  DateCountV[DayN].Val2.Val1, DateCountV[DayN].Val2.Val2));
964          }
965          DataFOut.Flush();
966      }
967      double MxCountFlt = (double)MxCount * 1.25;
968      {
969          TFOut PlotFOut(PlotFNm);
970          PlotFOut.PutStrLn("# event plot");
971          PlotFOut.PutStrLn(TStr::Fmt("set autoscale"));
972          PlotFOut.PutStrLn(TStr::Fmt("set xrange [0:%d]", DateCountV.Len() + 1));
973          PlotFOut.PutStrLn(TStr::Fmt("set yrange [0:%.2f]", MxCountFlt));
974          PlotFOut.PutStrLn(TStr::Fmt("set terminal png large size 700,300"));
975          PlotFOut.PutStrLn(TStr::Fmt("set output '%s.png'", PlotFNm.CStr()));
976          PlotFOut.PutStrLn(TStr::Fmt("set boxwidth 0.4"));
977          PlotFOut.PutStr(TStr::Fmt("set xtics rotate  ( "));
978          const int Dates = DateCountV.Len() > 10 ? 10 : DateCountV.Len();
979          double DayDiff = double(DateCountV.Len()) / double(Dates);
980          for (int DateN = 0; DateN < Dates; DateN++) {
981              const int DayN = TFlt::Round(DateN * DayDiff);
982              IAssertR(0 <= DayN && DayN < DateCountV.Len(), TInt::GetStr(DayN));
983              const uint64 DateMSecs = DateCountV[DayN].Val1.Val;
984              TStr DateStr = TTm::GetTmFromMSecs(DateMSecs).GetWebLogDateStr();
985              if (DateN != 0) { PlotFOut.PutStr(", "); }
986              PlotFOut.PutStr(TStr::Fmt("\" %s\" %d", DateStr.CStr(), DayN+1));
987          }
988          PlotFOut.PutStrLn(")");
989          PlotFOut.PutStrLn("set xlabel \"Time\"");
990          PlotFOut.PutStrLn("set ylabel \"Number of alarms\"");
991          PlotFOut.PutStr(TStr::Fmt("plot \"%s.tab\" using ($1-0.22):2 title \"%s\" with boxes, ", 
992              PlotFNm.CStr(), TitleStr.CStr()));
993          PlotFOut.PutStrLn(TStr::Fmt("\"%s.tab\" using ($1+0.22):3 title \"%s\" with boxes", 
994              PlotFNm.CStr(), CorrTitleStr.CStr()));
995      }
996      RunGnuPlot(PlotFNm);
997  }
998  void TBTAServer::PlotLongIpNum(const TStr& TitleStr, const TStr& PlotFNm,
999          const int& ProjId, const TTm& StartDate, const TTm& BreakDate, 
1000          const TTm& EndDate, const TStr& PeriodStr, const int& MxIpNums, 
1001          const bool& BigP) {
1002      PBtaLongProj LongProj = BtaLongBs->GetLongProjFromId(ProjId);
1003      TIntFltKdV IpNumIdWgtV; LongProj->GetIpNumWgtV(
1004          StartDate, BreakDate, EndDate, IpNumIdWgtV);
1005      if (IpNumIdWgtV.Len() > MxIpNums) { IpNumIdWgtV.Trunc(MxIpNums); }
1006      int MxCount = 0;
1007      {
1008          TFOut DataFOut(PlotFNm + ".tab"); 
1009          DataFOut.PutStrLn("# ipnum count");
1010          for (int IpNumN = 0; IpNumN < IpNumIdWgtV.Len(); IpNumN++) {
1011              const int IpNumId = IpNumIdWgtV[IpNumN].Key;
1012              double AvgCount; int LastCount; 
1013              GetIpNumEventCount(IpNumId, StartDate, 
1014                      BreakDate, EndDate, AvgCount, LastCount);
1015              MxCount = TInt::GetMx(MxCount, int(ceil(AvgCount))); 
1016              MxCount = TInt::GetMx(MxCount, LastCount); 
1017              DataFOut.PutStrLn(TStr::Fmt("%d %.2f %d", IpNumN+1, AvgCount, LastCount));
1018          }
1019          DataFOut.Flush();
1020      }
1021      double MxCountFlt = (double)MxCount * 1.25;
1022      {
1023          TFOut PlotFOut(PlotFNm);
1024          PlotFOut.PutStrLn("# event plot");
1025          PlotFOut.PutStrLn(TStr::Fmt("set autoscale"));
1026          PlotFOut.PutStrLn(TStr::Fmt("set xrange [0:%d]", IpNumIdWgtV.Len() + 1));
1027          PlotFOut.PutStrLn(TStr::Fmt("set yrange [0:%.2f]", MxCountFlt));
1028          if (BigP) { PlotFOut.PutStrLn(TStr::Fmt("set terminal png large size 700,300")); }
1029          else { PlotFOut.PutStrLn(TStr::Fmt("set terminal png large size 300,100")); }
1030          PlotFOut.PutStrLn(TStr::Fmt("set output '%s.png'", PlotFNm.CStr()));
1031          PlotFOut.PutStrLn(TStr::Fmt("set boxwidth 0.4"));
1032          if (BigP) {
1033              PlotFOut.PutStr(TStr::Fmt("set xtics rotate  ( "));
1034              for (int IpNumN = 0; IpNumN < IpNumIdWgtV.Len(); IpNumN++) {
1035                  const int IpNumId = IpNumIdWgtV[IpNumN].Key;
1036                  TStr IpNumStr = BtaEventBs->GetDevDefBs()->GetIpNumNm(IpNumId);
1037                  if (IpNumN != 0) { PlotFOut.PutStr(", "); }
1038                  PlotFOut.PutStr(TStr::Fmt("\" %s\" %d", IpNumStr.CStr(), IpNumN+1));
1039              }
1040              PlotFOut.PutStrLn(")");
1041          }
1042          PlotFOut.PutStrLn("set xlabel \"Time\"");
1043          PlotFOut.PutStrLn("set ylabel \"Number of alarms\"");
1044          TStr TitleStr = "Average", LastTitleStr = "In last " + PeriodStr;
1045          PlotFOut.PutStr(TStr::Fmt("plot \"%s.tab\" using ($1-0.22):2 title \"%s\" with boxes, ", 
1046              PlotFNm.CStr(), TitleStr.CStr()));
1047          PlotFOut.PutStrLn(TStr::Fmt("\"%s.tab\" using ($1+0.22):3 title \"%s\" with boxes", 
1048              PlotFNm.CStr(), LastTitleStr.CStr()));
1049      }
1050      RunGnuPlot(PlotFNm);    
1051  }
1052  int TBTAServer::ProcessNewBuffer() {
1053      TIntV EventIdV; BtaEventBs->AddNewBuffer(EventIdV);
1054      for (int EventIdN = 0; EventIdN < EventIdV.Len(); EventIdN++) {
1055          const int EventId = EventIdV[EventIdN];
1056          BtaCorrBs->AddEvent(BtaEventBs, EventId);
1057          const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
1058          if (Event.GetIpNumId() == -1 || Event.GetProjId() == -1) { continue; }
1059          if (Event.GetSeverity() < MnSeverity) { continue; }
1060          AllEventIdV.Add(EventId);
1061          if (Event.GetCaseId() == -1) { continue; }
1062          CaseIdEventIdV.Add(EventId);
1063      }
1064      TFOut LogFOut("btalarms.log", true);
1065      LogFOut.PutStrLn(TStr::Fmt("[%s] processed %d new alarms!", 
1066          TTm::GetCurLocTm().GetWebLogDateTimeStr().CStr(), EventIdV.Len()));
1067      return EventIdV.Len();
1068  }
1069  void TBTAServer::ProcessDumpBuffer() {
1070      ProcessNewBuffer();
1071      BtaEventBs->SaveBin(TFile::GetUniqueFNm(DumpFPath + "BTAlarms.bta"));
1072      BtaCorrBs->SaveBin(TFile::GetUniqueFNm(DumpFPath + "BTAlarms.btc"));
1073      BtaLongBs->SaveBin(TFile::GetUniqueFNm(DumpFPath + "BTAlarms.btl"));
1074      BtaEventBs->SaveDumpBuffer();
1075      TFOut LogFOut("btalarms.log", true);
1076      LogFOut.PutStrLn(TStr::Fmt("[%s] dump completed!", 
1077          TTm::GetCurLocTm().GetWebLogDateTimeStr().CStr()));
1078  }
1079  int TBTAServer::RescueFromDumpBuffer() {
1080      TIntV EventIdV; BtaEventBs->RescueDumpBuffer(EventIdV);
1081      for (int EventIdN = 0; EventIdN < EventIdV.Len(); EventIdN++) {
1082          const int EventId = EventIdV[EventIdN];
1083          BtaCorrBs->AddEvent(BtaEventBs, EventId);
1084          const TBtaEvent& Event = BtaEventBs->GetEvent(EventId);
1085          if (Event.GetIpNumId() == -1 || Event.GetProjId() == -1) { continue; }
1086          if (Event.GetSeverity() < MnSeverity) { continue; }
1087          AllEventIdV.Add(EventId);
1088          if (Event.GetCaseId() == -1) { continue; }
1089          CaseIdEventIdV.Add(EventId);
1090      }
1091      TFOut LogFOut("btalarms.log", true);
1092      LogFOut.PutStrLn(TStr::Fmt("[%s] rescued %d alarms!", 
1093          TTm::GetCurLocTm().GetWebLogDateTimeStr().CStr(), EventIdV.Len()));
1094      return EventIdV.Len();
1095  }
1096  void TBTAServer::SaveAndExit() {
1097      ProcessNewBuffer();
1098      BtaEventBs->SaveBin(BinFPath + "BTAlarms.bta");
1099      BtaCorrBs->SaveBin(BinFPath + "BTAlarms.btc");
1100      BtaLongBs->SaveBin(BinFPath + "BTAlarms.btl");
1101      BtaEventBs->SaveDumpBuffer();
1102      TFOut LogFOut("btalarms.log", true);
1103      LogFOut.PutStrLn(TStr::Fmt("[%s] save completed!", 
1104          TTm::GetCurLocTm().GetWebLogDateTimeStr().CStr()));
1105      ExitProcess(0);
1106  }
1107  TBTAServer::TBTAServer(const int& WebSrvPortN, const TStr& _BinFPath, 
1108          const TStr& _DumpFPath, const POdbcDb& OdbcDb, const TStr& _GnuPlotPath):   
1109              TWebSrv(WebSrvPortN, true, TNotify::StdNotify) {
1110      printf("Starting server \n");
1111      BinFPath = _BinFPath; DumpFPath = _DumpFPath; GnuPlotPath = _GnuPlotPath;
1112      BtaEventBs = TBtaEventBs::LoadBin(BinFPath + "BTAlarms.bta", OdbcDb);
1113      BtaDevDefBs = BtaEventBs->GetDevDefBs();
1114      BtaCorrBs = TBtaCorrBs::LoadBin(BinFPath + "BTAlarms.btc");
1115      BtaLongBs = TBtaLongBs::LoadBin(BinFPath + "BTAlarms.btl");
1116      RescueFromDumpBuffer();
1117      const int Events = BtaEventBs->GetEvents();
1118      printf(" No. of events: %d\n", Events);
1119      {printf("Loading events ");   
1120      for (int EventN = 0; EventN < Events; EventN++) {
1121          TBtaEvent Event = BtaEventBs->GetEvent(EventN);
1122          if (Event.GetIpNumId() == -1 || Event.GetProjId() == -1) { continue; }
1123          if (Event.GetSeverity() < MnSeverity) { continue; }
1124          AllEventIdV.Add(EventN);
1125          if (Event.GetCaseId() == -1) { continue; }
1126          CaseIdEventIdV.Add(EventN);
1127      } printf(".");}
1128      {printf(" LongProj ");
1129      TFltIntKdV WeekChiProjIdV, WeekKsProjIdV, MonthChiProjIdV, MonthKsProjIdV; printf(".");
1130      TTm StartDate = BtaEventBs->GetFirstTime(), EndDate = BtaEventBs->GetLastTime(); printf(".");
1131      TTm WeekBreakDate = GetBreakDate(7), MonthBreakDate = GetBreakDate(30); printf(".");
1132      int ProjKeyId = BtaLongBs->FFirstKeyId(); printf(".");
1133      int AllCount = 0, WeekSkipCount = 0, MonthSkipCount = 0;
1134      while (BtaLongBs->FNextKeyId(ProjKeyId)) {
1135          AllCount++;
1136          const int ProjId = BtaLongBs->GetProjId(ProjKeyId);
1137          PBtaLongProj LongProj = BtaLongBs->GetLongProj(ProjKeyId);
1138          int BeforeCount, AfterCount;
1139          LongProj->Count(StartDate, WeekBreakDate, EndDate, BeforeCount, AfterCount);
1140          const bool IsWeekTrendPosP = LongProj->IsTrendPos(StartDate, WeekBreakDate, EndDate);
1141          if (BeforeCount > MnBeforeCount &bsol;*&& IsWeekTrendPosP*/) {
1142              const double WeekChi = LongProj->ChiSquare(StartDate, WeekBreakDate, EndDate);
1143              WeekChiProjIdV.Add(TFltIntKd(WeekChi, ProjId));
1144          } else { WeekSkipCount++; }
1145          LongProj->Count(StartDate, MonthBreakDate, EndDate, BeforeCount, AfterCount);
1146          const bool IsMonthTrendPosP = LongProj->IsTrendPos(StartDate, MonthBreakDate, EndDate);
1147          if (BeforeCount > MnBeforeCount &bsol;*&& IsMonthTrendPosP*/) {
1148              const double MonthChi = LongProj->ChiSquare(StartDate, MonthBreakDate, EndDate);
1149              MonthChiProjIdV.Add(TFltIntKd(MonthChi, ProjId));
1150          } else { MonthSkipCount++; }
1151      }
1152      printf("(%d/%d/%d)", AllCount, WeekSkipCount, MonthSkipCount);
1153      WeekChiProjIdV.Sort(true); WeekChiSortProjIdV.Clr();
1154      for (int EltN = 0; EltN < WeekChiProjIdV.Len(); EltN++) {
1155          if (WeekChiProjIdV[EltN].Key > MxChiProb) { break; }
1156          WeekChiSortProjIdV.Add(WeekChiProjIdV[EltN].Dat); }
1157      WeekChiSortProjIdV.Pack(); 
1158      MonthChiProjIdV.Sort(true); MonthChiSortProjIdV.Clr();
1159      for (int EltN = 0; EltN < MonthChiProjIdV.Len(); EltN++) {
1160          if (MonthChiProjIdV[EltN].Key > MxChiProb) { break; }
1161          MonthChiSortProjIdV.Add(MonthChiProjIdV[EltN].Dat); }
1162      MonthChiSortProjIdV.Pack();
1163      printf(".");}
1164      printf(" Done\n");
1165  }
1166  void TBTAServer::OnHttpRq(const int& SockId, const PHttpRq& HttpRq) {
1167      if (!HttpRq->IsOk()) { return; }
1168      PUrl RqUrl=HttpRq->GetUrl();
1169      if (!RqUrl->IsOk()) { return; }
1170      PUrl HttpRqUrl = HttpRq->GetUrl();
1171      TStr UrlStr = HttpRqUrl->GetUrlStr();
1172      TStr CmdNm = HttpRqUrl->GetPathSeg(0);
1173      TStr FullQueryStr = HttpRqUrl->GetSearchStr();
1174      PUrlEnv HttpRqUrlEnv=HttpRq->GetUrlEnv();
1175      TStr TimeNow = TTm::GetCurLocTm().GetWebLogDateTimeStr(true);
1176      printf("[%s] Request %s %s\n", TimeNow.CStr(), CmdNm.CStr(), FullQueryStr.CStr());
1177      PHttpResp HttpResp;
1178      if (CmdNm == "style.css") {
1179          PSIn BodySIn = TFIn::New("style.css");
1180          HttpResp = THttpResp::New(THttp::OkStatusCd, "text/css", false, BodySIn);
1181      } else if (CmdNm == "board.css") {
1182          PSIn BodySIn = TFIn::New("board.css");
1183          HttpResp = THttpResp::New(THttp::OkStatusCd, "text/css", false, BodySIn);
1184      } else if (CmdNm.Right(4) == ".png") {
1185          TStr ImgFNm = "./" + CmdNm; 
1186          ImgFNm.ChangeChAll('-', '/');
1187          PSIn BodySIn = TFIn::New(ImgFNm);
1188          HttpResp = THttpResp::New(THttp::OkStatusCd, "image/png", false, BodySIn);
1189      } else if (CmdNm == "process") { 
1190          TStr MsgStr; 
1191          try {
1192              TStr ProcessType = HttpRqUrlEnv->GetVal("type", 0, "new");
1193              if (ProcessType == "new") {
1194                  const int NewEvents = ProcessNewBuffer();
1195                  MsgStr = TStr::Fmt("Loaded %d new alarms!", NewEvents);
1196              } else if (ProcessType == "dump") {
1197                  ProcessDumpBuffer();
1198                  MsgStr = "Dump successful!";
1199              } else if (ProcessType == "exit") {
1200                  SaveAndExit();
1201                  MsgStr = "Exit successful!";
1202              }
1203          } catch (PExcept Except) {
1204              printf("Exception: %s", Except->GetMsgStr().CStr());
1205          }
1206  		PSIn BodySIn = TMIn::New(MsgStr);
1207  		HttpResp = THttpResp::New(THttp::OkStatusCd, 
1208  			THttp::TextHtmlFldVal, false, BodySIn);
1209      } else if (CmdNm == "board") { 
1210          TStr ProjCountStr = HttpRqUrlEnv->GetVal("count", 0, "0");
1211          const int ProjCount = ProjCountStr.IsInt() ? ProjCountStr.GetInt() : 0;
1212          TStr RefreshTmSecStr = HttpRqUrlEnv->GetVal("refresh", 0, "10");
1213          const int RefreshTmSec = RefreshTmSecStr.IsInt() ? RefreshTmSecStr.GetInt() : 10;
1214          TChA HtmlChA;
1215          MakeBoardPage(ProjCount, RefreshTmSec, HtmlChA);
1216  		PSIn BodySIn = TMIn::New(HtmlChA);
1217  		HttpResp = THttpResp::New(THttp::OkStatusCd, 
1218  			THttp::TextHtmlFldVal, false, BodySIn);
1219      } else if ((CmdNm == "related_traps") || 
1220          (CmdNm == "predicted_traps") || (CmdNm == "trap_device")) {
1221  		const bool RelatedTrapsP = (CmdNm == "related_traps");
1222          const bool PredictedTrapsP = (CmdNm == "predicted_traps");
1223  		const bool TrapDeviceP = (CmdNm == "trap_device");
1224          TStr EventIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1225          if (EventIdStr.IsInt()) {
1226              const int EventId = EventIdStr.GetInt();
1227  			TChA HtmlChA;
1228  			HtmlChA += "<html><head>\n";
1229  			HtmlChA += "<title>BT Alarms Explorer</title>\n";
1230  			HtmlChA += "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\">\n";
1231  			HtmlChA += "<link href=\"style.css\" type=\"text/css\" rel=\"stylesheet\">\n";
1232  			HtmlChA += "</head><body>\n";
1233  			if (RelatedTrapsP) { 
1234  				HtmlChA += "[ Related Traps | ";
1235  				HtmlChA += "<a href=\"/predicted_traps?id=" + 
1236                      EventIdStr + "\">Predicted Traps</a> |";
1237  				HtmlChA += "<a href=\"/trap_device?id=" + 
1238                      EventIdStr + "\">Device Histroy and Trends</a> ]";
1239              } else if (PredictedTrapsP) {
1240  				HtmlChA += "[ <a href=\"/related_traps?id=" +
1241                      EventIdStr + "\">Related Traps</a> |";
1242  				HtmlChA += "Predicted Traps |";
1243  				HtmlChA += "<a href=\"/trap_device?id=" + 
1244                      EventIdStr + "\">Device Histroy and Trends</a> ]";
1245  			} else {
1246  				HtmlChA += "[ <a href=\"/related_traps?id=" +
1247                      EventIdStr + "\">Related Traps</a> |";
1248  				HtmlChA += "<a href=\"/predicted_traps?id=" + 
1249                      EventIdStr + "\">Predicted Traps</a> |";
1250  				HtmlChA += "Device Histroy and Trends ]";
1251  			}
1252  			HtmlChA += "<br><hr>";
1253  			if (RelatedTrapsP) {
1254  				MakeShortEventPage(EventId, HtmlChA);
1255              } else if (PredictedTrapsP) {
1256                  MakeShortPredIpNumsPage(EventId, HtmlChA);
1257              } else if (TrapDeviceP) {
1258  				MakeShortIpNumPage(EventId, HtmlChA);
1259  			}
1260  			HtmlChA += "</body></html>";
1261  			PSIn BodySIn = TMIn::New(HtmlChA);
1262  			HttpResp = THttpResp::New(THttp::OkStatusCd, 
1263  				THttp::TextHtmlFldVal, false, BodySIn);
1264          } else {
1265              printf("Wrong parameter id '%s' ..;\n", EventIdStr.CStr());
1266          }
1267      } else if (CmdNm == "report") { 
1268          TStr ReportType = HttpRqUrlEnv->GetVal("type", 0, "related");
1269          TChA HtmlChA;
1270          HtmlChA += "<html><head>\n";
1271          HtmlChA += "<title>BT Alarms Explorer</title>\n";
1272          HtmlChA += "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\">\n";
1273          HtmlChA += "<link href=\"style.css\" type=\"text/css\" rel=\"stylesheet\">\n";
1274          HtmlChA += "</head><body>\n";
1275          if (ReportType == "related") {
1276              TStr ReportSubType = HttpRqUrlEnv->GetVal("subtype", 0, "all");
1277              const bool ProbP = ((ReportSubType == "all") || (ReportSubType == "prob"));
1278              const bool TextP = ((ReportSubType == "all") || (ReportSubType == "text"));
1279              TStr MxEventsStr = HttpRqUrlEnv->GetVal("events", 0, "");
1280              const int MxEvents = MxEventsStr.IsInt() ? MxEventsStr.GetInt() : 1000;
1281              TStr MnSeverityStr = HttpRqUrlEnv->GetVal("mnseverity", 0, "");
1282              const int MnSeverity = MnSeverityStr.IsInt() ? MnSeverityStr.GetInt() : 3;
1283              int AllEvents = 0;
1284              TIntV AllScoresCountV, ProbScoresCountV, TextScoresCountV; 
1285              BtaCorrBs->GetRootCauseStat(BtaEventBs, MxEvents, MnSeverity,
1286                  RootCouseEventWnd, RootCouseTimeWnd, ProbP, TextP, 
1287                  AllScoresCountV, ProbScoresCountV, TextScoresCountV, 
1288                  AllEvents);
1289              HtmlChA += TStr::Fmt(
1290                  "<b>Number of severe events (Severity > %d):</b> %d<br>\n", 
1291                  MnSeverity, AllEvents);
1292              HtmlChA += "<hr>\n";
1293              HtmlChA += "<table><tr>";
1294              HtmlChA += "<td>#related</td>";
1295              HtmlChA += "<td>#all_alarms</td>";
1296              HtmlChA += "<td>#prob_alarms</td>";
1297              HtmlChA += "<td>#text_alarms</td>";
1298              HtmlChA += "</tr>\n";
1299              for (int ScoresCountN = 0; ScoresCountN < AllScoresCountV.Len(); ScoresCountN++) {
1300                  HtmlChA += "<tr>\n";
1301                  HtmlChA += TStr::Fmt("<td>%d</td>\n", ScoresCountN);
1302                  HtmlChA += TStr::Fmt("<td>%d</td>\n", AllScoresCountV[ScoresCountN].Val);
1303                  HtmlChA += TStr::Fmt("<td>%d</td>\n", ProbScoresCountV[ScoresCountN].Val);
1304                  HtmlChA += TStr::Fmt("<td>%d</td>\n", TextScoresCountV[ScoresCountN].Val);
1305                  HtmlChA += "</tr>\n";
1306              }
1307              HtmlChA += "</table>";
1308          }
1309  		HtmlChA += "</body></html>";
1310          printf("\n\n%s\n\n", HtmlChA.CStr());
1311  		PSIn BodySIn = TMIn::New(HtmlChA);
1312  		HttpResp = THttpResp::New(THttp::OkStatusCd, 
1313  			THttp::TextHtmlFldVal, false, BodySIn);
1314  	} else {
1315          TChA HtmlChA;
1316          HtmlChA += "<html><head>\n";
1317          HtmlChA += "<title>BT Alarms Explorer</title>\n";
1318          HtmlChA += "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\">\n";
1319          HtmlChA += "<link href=\"style.css\" type=\"text/css\" rel=\"stylesheet\">\n";
1320          HtmlChA += "</head><body>\n";
1321          HtmlChA += "<form action=\"/search\"><b><a href=\"/events\">Alarms</a></b>, ";
1322          HtmlChA += "<b><a href=\"/long\">Long-Term Trends</a></b> | ";
1323          HtmlChA += "Search: <input maxLength=\"256\" size=\"23\" name=\"q\"";
1324          if (!HttpRqUrlEnv->GetVal("q", 0, "").Empty()) {
1325              HtmlChA += "value=\"" + HttpRqUrlEnv->GetVal("q", 0, "") + "\""; }
1326          HtmlChA += ">";
1327          HtmlChA += "<input type=submit name=\"type\" value=\"device\">\n";
1328          HtmlChA += "<input type=submit name=\"type\" value=\"project\">\n";
1329          HtmlChA += "</form>";
1330          HtmlChA += "<hr>\n";
1331          if (CmdNm.Empty() || CmdNm == "events") {
1332              TStr SortTypeStr = HttpRqUrlEnv->GetVal("sort", 0, "all");
1333              TStr PageNumStr = HttpRqUrlEnv->GetVal("page", 0, "0");
1334              if (PageNumStr.IsInt()) {
1335                  const int PageNum = PageNumStr.GetInt();
1336                  if (SortTypeStr == "all") {           
1337                      MakeEventsPage(AllEventIdV, SortTypeStr, PageNum, HtmlChA);
1338                  } else if (SortTypeStr == "case_id") {
1339                      MakeEventsPage(CaseIdEventIdV, SortTypeStr, PageNum, HtmlChA);
1340                  } else {
1341                      printf("Wrong parameter sort '%s' ..;\n", SortTypeStr.CStr());
1342                  }
1343              } else {
1344                  printf("Wrong parameter page '%s' ..;\n", PageNumStr.CStr());
1345              }
1346          } else if (CmdNm == "search") {
1347              TStr QueryStr = HttpRqUrlEnv->GetVal("q", 0, "");
1348              TStr TypeStr = HttpRqUrlEnv->GetVal("type", 0, "");
1349              if (!QueryStr.Empty() && !TypeStr.Empty()) {
1350                  bool SearchOkP = true;
1351                  if (TypeStr == "device") {
1352                      PBtaDevDefBs BtaDevDefBs = BtaEventBs->GetDevDefBs();
1353                      if (BtaDevDefBs->IsIpNumId(QueryStr)) {
1354                          const int IpNumId = BtaDevDefBs->GetIpNumId(QueryStr);
1355                          MakeIpNumPage(IpNumId, HtmlChA);
1356                      } else { SearchOkP = false; }
1357                  } else if (TypeStr == "project") {
1358                      PBtaDevDefBs BtaDevDefBs = BtaEventBs->GetDevDefBs();
1359                      if (BtaDevDefBs->IsProjId(QueryStr)) {
1360                          const int ProjId = BtaDevDefBs->GetProjId(QueryStr);
1361                          MakeProjectPage(ProjId, HtmlChA);
1362                      } else { SearchOkP = false; }
1363                  } else { SearchOkP = false; }
1364                  if (!SearchOkP) { HtmlChA += "<b>No results found, try again.</b>\n"; }
1365              } else { 
1366                  printf("Wrong parameter page '%s' and '%s' ..;\n", 
1367                      QueryStr.CStr(), TypeStr.CStr());
1368              }            
1369          } else if (CmdNm == "event") {
1370              TStr EventIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1371              if (EventIdStr.IsInt()) {
1372                  const int EventId = EventIdStr.GetInt();
1373                  MakeEventPage(EventId, HtmlChA);
1374              } else {
1375                  printf("Wrong parameter id '%s' ..;\n", EventIdStr.CStr());
1376              }
1377          } else if (CmdNm == "event_full") {
1378              TStr EventIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1379              if (EventIdStr.IsInt()) {
1380                  const int EventId = EventIdStr.GetInt();
1381                  MakeEventFullPage(EventId, HtmlChA);
1382              } else {
1383                  printf("Wrong parameter id '%s' ..;\n", EventIdStr.CStr());
1384              }
1385          } else if (CmdNm == "device") {
1386              TStr IpNumIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1387              if (IpNumIdStr.IsInt()) {
1388                  const int IpNumId = IpNumIdStr.GetInt();
1389                  MakeIpNumPage(IpNumId, HtmlChA);                
1390              } else {
1391                  printf("Wrong parameter id '%s' ..;\n", IpNumIdStr.CStr());
1392              }
1393          } else if (CmdNm == "project") {
1394              TStr ProjIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1395              if (ProjIdStr.IsInt()) {
1396                  const int ProjId = ProjIdStr.GetInt();
1397                  MakeProjectPage(ProjId, HtmlChA);
1398              } else {
1399                  printf("Wrong parameter id '%s' ..;\n", ProjIdStr.CStr());
1400              }
1401          } else if (CmdNm == "d_events") {
1402              TStr PageNumStr = HttpRqUrlEnv->GetVal("page", 0, "0");
1403              TStr IpNumIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1404              if (!PageNumStr.IsInt()) {
1405                  printf("Wrong parameter page '%s' ..;\n", PageNumStr.CStr());
1406              } else if (!IpNumIdStr.IsInt()) {
1407                  printf("Wrong parameter id '%s' ..;\n", IpNumIdStr.CStr());
1408              } else {              
1409                  const int PageNum = PageNumStr.GetInt();
1410                  const int IpNumId = IpNumIdStr.GetInt();
1411                  if (BtaCorrBs->IsIpNumId(IpNumId)) {
1412                      const TIntV& EventV = BtaCorrBs->GetIpNumEventV(IpNumId); 
1413                      MakeIpNumEventsPage(IpNumId, EventV, PageNum, HtmlChA);
1414                  }
1415              }
1416          } else if (CmdNm == "p_events") {
1417              TStr PageNumStr = HttpRqUrlEnv->GetVal("page", 0, "0");
1418              TStr ProjIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1419              if (!PageNumStr.IsInt()) {
1420                  printf("Wrong parameter page '%s' ..;\n", PageNumStr.CStr());
1421              } else if (!ProjIdStr.IsInt()) {
1422                  printf("Wrong parameter id '%s' ..;\n", ProjIdStr.CStr());
1423              } else {              
1424                  const int PageNum = PageNumStr.GetInt();
1425                  const int ProjId = ProjIdStr.GetInt();
1426                  if (BtaCorrBs->IsProjId(ProjId)) {
1427                      const TIntV& EventV = BtaCorrBs->GetProjEventV(ProjId); 
1428                      MakeProjEventsPage(ProjId, EventV, PageNum, HtmlChA);
1429                  }
1430              }
1431          } else if (CmdNm == "dd_events") {
1432              TStr PageNumStr = HttpRqUrlEnv->GetVal("page", 0, "0");
1433              TStr IpNumIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1434              TStr CorrIpNumIdStr = HttpRqUrlEnv->GetVal("corrid", 0, "0");
1435              if (!PageNumStr.IsInt()) {
1436                  printf("Wrong parameter page '%s' ..;\n", PageNumStr.CStr());
1437              } else if (!IpNumIdStr.IsInt()) {
1438                  printf("Wrong parameter id '%s' ..;\n", IpNumIdStr.CStr());
1439              } else if (!CorrIpNumIdStr.IsInt()) {
1440                  printf("Wrong parameter corrid '%s' ..;\n", CorrIpNumIdStr.CStr());
1441              } else {              
1442                  const int PageNum = PageNumStr.GetInt();
1443                  const int IpNumId = IpNumIdStr.GetInt();
1444                  const int CorrIpNumId = CorrIpNumIdStr.GetInt();
1445                  MakeIpNumCorrEventPage(IpNumId, CorrIpNumId, PageNum, HtmlChA);
1446              }
1447          } else if (CmdNm == "long") {
1448              TStr PageNumStr = HttpRqUrlEnv->GetVal("page", 0, "0");
1449              if (PageNumStr.IsInt()) {
1450                  TStr PeriodStr = HttpRqUrlEnv->GetVal("period", 0, "week");
1451                  const int PageNum = PageNumStr.GetInt();
1452                  if (PeriodStr == "week") {
1453                      MakeLongPage(WeekChiSortProjIdV, PageNum, PeriodStr, HtmlChA);
1454                  } else if (PeriodStr == "month") {
1455                      MakeLongPage(MonthChiSortProjIdV, PageNum, PeriodStr, HtmlChA);
1456                  }
1457              } else {
1458                  printf("Wrong parameter page '%s' ..;\n", PageNumStr.CStr());
1459              }
1460          } else if (CmdNm == "p_long") {
1461              TStr ProjIdStr = HttpRqUrlEnv->GetVal("id", 0, "0");
1462              TStr PageNumStr = HttpRqUrlEnv->GetVal("page", 0, "0");
1463              if (!PageNumStr.IsInt()) {
1464                  printf("Wrong parameter page '%s' ..;\n", PageNumStr.CStr());
1465              } else if (!ProjIdStr.IsInt()) {
1466                  printf("Wrong parameter id '%s' ..;\n", ProjIdStr.CStr());
1467              } else {              
1468                  TStr PeriodStr = HttpRqUrlEnv->GetVal("period", 0, "week");
1469                  const int PageNum = PageNumStr.GetInt();
1470                  const int ProjId = ProjIdStr.GetInt();
1471                  if (PeriodStr == "week") {
1472                      MakeProjLongPage(ProjId, PageNum, PeriodStr, HtmlChA);
1473                  } else if (PeriodStr == "month") {
1474                      MakeProjLongPage(ProjId, PageNum, PeriodStr, HtmlChA);
1475                  }
1476              }
1477          }
1478          HtmlChA += "</body></html>";
1479          PSIn BodySIn = TMIn::New(HtmlChA);
1480          HttpResp = THttpResp::New(THttp::OkStatusCd, 
1481              THttp::TextHtmlFldVal, false, BodySIn);
1482      }
1483      SendHttpResp(SockId, HttpResp);
1484  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-btaserver.cpp</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-btaserver.cpp</div>
                </div>
                <div class="column column_space"><pre><code>586                  EventV[EventN].Val, Event.GetIpNumId(), Event.GetProjId()); 
587          }
588      }
589      HtmlChA += "</table>\n";
590  }
591  void TBTAServer::MakeEventPrList(const TIntPrV& EventPrV, const int& DispPageN, TChA& HtmlChA) {
</pre></code></div>
                <div class="column column_space"><pre><code>586                  EventV[EventN].Val, Event.GetIpNumId(), Event.GetProjId()); 
587          }
588      }
589      HtmlChA += "</table>\n";
590  }
591  void TBTAServer::MakeEventPrList(const TIntPrV& EventPrV, const int& DispPageN, TChA& HtmlChA) {
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    