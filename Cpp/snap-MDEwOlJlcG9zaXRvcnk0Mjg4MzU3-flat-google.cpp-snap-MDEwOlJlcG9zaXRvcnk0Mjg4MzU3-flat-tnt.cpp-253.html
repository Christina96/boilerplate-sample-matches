
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 15, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-google.cpp</h3>
            <pre><code>1  #include &quot;google.h&quot;
2  TMd5Sig TGgSchRef::GetMd5Sig() const {
3    TChA ChA;
4    ChA+=TitleStr;
5    for (int AuthN=0; AuthN&lt;AuthNmV.Len(); AuthN++){
6      ChA+=&#x27;;&#x27;; ChA+=AuthNmV[AuthN];}
7    ChA+=&#x27;;&#x27;; ChA+=PubNm;
8    ChA+=&#x27;;&#x27;; ChA+=YearStr;
9    return TMd5Sig(ChA);
10  }
11  void TGgSchRef::GetAuthNmVPubStr(
12   const TStr&amp; AuthNmVPubStr, TStrV&amp; AuthNmV, TStr&amp; PubNm, TStr&amp; PubYearStr){
13    TStr AuthNmVStr; TStr PubStr;
14    AuthNmVPubStr.SplitOnStr(AuthNmVStr, &quot; - &quot;, PubStr);
15    AuthNmVStr.SplitOnAllCh(&#x27;,&#x27;, AuthNmV, true);
16    for (int AuthN=0; AuthN&lt;AuthNmV.Len(); AuthN++){
17      AuthNmV[AuthN].ToTrunc();
18    }
19    if ((!AuthNmV.Empty())&amp;&amp;
20     ((AuthNmV.Last().IsStrIn(&quot;...&quot;))||(AuthNmV.Last().Len()&lt;=2))){
21      AuthNmV.DelLast();
22    }
23    TStr OriginStr; TStr LinkStr;
24    PubStr.SplitOnStr(OriginStr, &quot; - &quot;, LinkStr);
25    OriginStr.SplitOnLastCh(PubNm, &#x27;,&#x27;, PubYearStr);
26    PubNm.ToTrunc(); PubYearStr.ToTrunc();
27    if ((PubYearStr.Len()&gt;=4)&amp;&amp;(PubYearStr.GetSubStr(0, 3).IsInt())){
28      PubYearStr=PubYearStr.GetSubStr(0, 3);
29    } else
30    if ((PubNm.Len()&gt;=4)&amp;&amp;(PubNm.GetSubStr(0, 3).IsInt())){
31      PubYearStr=PubNm.GetSubStr(0, 3); PubNm=&quot;&quot;;
32    } else {
33      PubYearStr=&quot;&quot;;
34    }
35  }
36  void TGgSchRef::SaveXml(FILE* fOut, const int&amp; RefN){
37    if (RefN==-1){
38      fprintf(fOut, &quot;    &lt;Ref&gt;\n&quot;);
39    } else {
40      fprintf(fOut, &quot;    &lt;Ref Num=\&quot;%d\&quot;&gt;\n&quot;, RefN);
41    }
42    fprintf(fOut, &quot;    &lt;MD5&gt;%s&lt;/MD5&gt;\n&quot;, GetMd5Sig().GetStr().CStr());
43    fprintf(fOut, &quot;      &lt;Title&gt;%s&lt;/Title&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(TitleStr).CStr());
44    if (AuthNmV.Len()&gt;0){
45      fprintf(fOut, &quot;      &lt;Authors&gt;&quot;);
46      for (int AuthN=0; AuthN&lt;AuthNmV.Len(); AuthN++){
47        fprintf(fOut, &quot;&lt;Author&gt;%s&lt;/Author&gt;&quot;, TXmlLx::GetXmlStrFromPlainStr(AuthNmV[AuthN]).CStr());
48      }
49      fprintf(fOut, &quot;&lt;/Authors&gt;\n&quot;);
50    }
51    if (!PubNm.Empty()){
52      fprintf(fOut, &quot;      &lt;Pub&gt;%s&lt;/Pub&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(PubNm).CStr());}
53    if (!YearStr.Empty()){
54      fprintf(fOut, &quot;      &lt;Year&gt;%s&lt;/Year&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(YearStr).CStr());}
55    fprintf(fOut, &quot;      &lt;Citations&gt;%d&lt;/Citations&gt;\n&quot;, Citations);
56    if (!CitedByUrlStr.Empty()){
57      fprintf(fOut, &quot;      &lt;CitedByUrl&gt;%s&lt;/CitedByUrl&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(CitedByUrlStr).CStr());}
58    fprintf(fOut, &quot;    &lt;/Ref&gt;\n&quot;);
59  }
60  PGgSchRSet TGgSchRSet::NewScholar(const TStr&amp; UrlStr, const TStr&amp; HtmlStr){
61    PGgSchRSet RSet=TGgSchRSet::New();
62    PSIn HtmlSIn=TStrIn::New(HtmlStr);
63    THtmlLx HtmlLx(HtmlSIn);
64    HtmlLx.MoveToStrOrEof(&quot;Results&quot;);
65    TStr FromResultStr=HtmlLx.GetStrInTag(&quot;&lt;B&gt;&quot;, true);
66    TStr ToResultStr=HtmlLx.GetStrInTag(&quot;&lt;B&gt;&quot;, true);
67    TStr AllHitsStr=HtmlLx.GetStrInTag(&quot;&lt;B&gt;&quot;, true);
68    AllHitsStr.DelChAll(&#x27;,&#x27;);
69    TStr QueryStr=HtmlLx.GetStrInTag(&quot;&lt;B&gt;&quot;, true);
70    HtmlLx.MoveToBTagOrEof(&quot;&lt;P&gt;&quot;);
71    forever {
72      if (!((HtmlLx.Sym==hsyBTag)&amp;&amp;(HtmlLx.UcChA==&quot;&lt;P&gt;&quot;))){break;}
73      HtmlLx.GetSym();
74      if (HtmlLx.Sym==hsyBTag){
75        TStr FullBTagStr=HtmlLx.GetFullBTagStr();
76        if (FullBTagStr==&quot;&lt;FONT SIZE=\&quot;-2\&quot;&gt;&quot;){
77          TStr PubTypeNm=HtmlLx.GetStrInTag(&quot;&lt;B&gt;&quot;, true);
78        } else
79        if (FullBTagStr==&quot;&lt;SPAN CLASS=\&quot;w\&quot;&gt;&quot;){
80        } else {
81          break;
82        }
83        TStr TitleStr=HtmlLx.GetStrToBTag(&quot;&lt;BR&gt;&quot;, true).GetTrunc();
84        if (TitleStr.IsPrefix(&quot;[PS] &quot;)){
85          TitleStr=TitleStr.GetSubStr(5, TitleStr.Len()).GetTrunc();}
86        TStr AuthNmVPubStr=HtmlLx.GetStrToBTag(&quot;&lt;BR&gt;&quot;, true);
87        TStrV AuthNmV; TStr PubNm; TStr PubYearStr;
88        TGgSchRef::GetAuthNmVPubStr(AuthNmVPubStr, AuthNmV, PubNm, PubYearStr);
89        TStr CitedByUrlStr; int Citations=0;
90        HtmlLx.MoveToBTag3OrEof(&quot;&lt;A&gt;&quot;, &quot;&lt;P&gt;&quot;, &quot;&lt;DIV&gt;&quot;);
91        if ((HtmlLx.Sym==hsyBTag)&amp;&amp;(HtmlLx.ChA==&quot;&lt;A&gt;&quot;)){
92          TStr CitedByRelUrlStr=HtmlLx.GetArg(&quot;HREF&quot;);
93          TStr AStr=HtmlLx.GetStrToETag(&quot;&lt;A&gt;&quot;, true);
94          if (AStr.IsPrefix(&quot;Cited by &quot;)){
95            PUrl CitedByUrl=TUrl::New(CitedByRelUrlStr, UrlStr);
96            if (CitedByUrl-&gt;IsOk()){
97              CitedByUrlStr=CitedByUrl-&gt;GetUrlStr();
98              Citations=AStr.GetSubStr(TStr(&quot;Cited by &quot;).Len(), AStr.Len()).GetInt(0);
99            }
100          }
101          HtmlLx.MoveToBTag2OrEof(&quot;&lt;P&gt;&quot;, &quot;&lt;DIV&gt;&quot;);
102        }
103        PGgSchRef Ref=
104         TGgSchRef::New(TitleStr, AuthNmV, PubNm, PubYearStr, Citations, CitedByUrlStr);
105        RSet-&gt;AddHit(Ref);
106      } else {
107        break;
108      }
109    }
110    TStr NextUrlStr;
111    if ((HtmlLx.Sym==hsyBTag)&amp;&amp;(HtmlLx.UcChA==&quot;&lt;DIV&gt;&quot;)){
112      TStr NextRelUrlStr=HtmlLx.GetHRefBeforeStr(&quot;Next&quot;);
113      if (!NextRelUrlStr.Empty()){
114        PUrl NextUrl=TUrl::New(NextRelUrlStr, UrlStr);
115        if (NextUrl-&gt;IsOk()){
116          NextUrlStr=NextUrl-&gt;GetUrlStr();
117        }
118      }
119    }
120    RSet-&gt;PutUrlStr(UrlStr);
121    RSet-&gt;PutNextUrlStr(NextUrlStr);
122    RSet-&gt;PutQueryStr(QueryStr);
123    RSet-&gt;PutAllHits(AllHitsStr.GetInt(-1));
124    return RSet;
125  }
126  PGgSchRSet TGgSchRSet::NewScholar(const PWebPg&amp; WebPg){
127    TStr UrlStr=WebPg-&gt;GetUrlStr();
128    TStr HtmlStr=WebPg-&gt;GetHttpBodyAsStr();
129    return TGgSchRSet::NewScholar(UrlStr, HtmlStr);
130  }
131  void TGgSchRSet::Merge(const PGgSchRSet&amp; RSet){
132    if (RSet.Empty()){return;}
133    TStrH TitleStrH(GetHits());
134    for (int HitN=0; HitN&lt;GetHits(); HitN++){
135      TitleStrH.AddKey(GetHit(HitN)-&gt;TitleStr);
136    }
137    for (int HitN=0; HitN&lt;RSet-&gt;GetHits(); HitN++){
138      PGgSchRef Ref=RSet-&gt;GetHit(HitN);
139      if (!TitleStrH.IsKey(Ref-&gt;TitleStr)){
140        AddHit(Ref);
141        TitleStrH.AddKey(Ref-&gt;TitleStr);
142      }
143    }
144    PutNextUrlStr(&quot;&quot;);
145    PutAllHits(-1);
146  }
147  PBowDocBs TGgSchRSet::GetBowDocBs() const {
148    PSwSet SwSet=TSwSet::GetSwSet(swstEn523);
149    PStemmer Stemmer=TStemmer::New(stmtPorter, true);
150    TStrV HtmlStrV(GetHits(), 0);
151    for (int HitN=0; HitN&lt;GetHits(); HitN++){
152      TStr HtmlStr=GetHit(HitN)-&gt;TitleStr;
153      HtmlStrV.Add(HtmlStr);
154    }
155    PNGramBs NGramBs=TNGramBs::GetNGramBsFromHtmlStrV(
156     HtmlStrV, 3, 3, SwSet, Stemmer);
157    printf(&quot;Create Bag-Of-Words Base ... &quot;);
158    PBowDocBs BowDocBs=TBowDocBs::New();
159    BowDocBs-&gt;PutNGramBs(NGramBs);
160    for (int HitN=0; HitN&lt;GetHits(); HitN++){
161      BowDocBs-&gt;AddHtmlDoc(TInt::GetStr(HitN), TStrV(), HtmlStrV[HitN], true);
162    }
163    BowDocBs-&gt;AssertOk();
164    printf(&quot;Done.\n&quot;);
165    return BowDocBs;
166  }
167  void TGgSchRSet::SaveBin(const TStr&amp; FNm, const PGgSchRSet&amp; GgSchRSet){
168    if (GgSchRSet.Empty()){
169      PGgSchRSet RSet=TGgSchRSet::New();
170      GgSchRSet-&gt;SaveBin(FNm);
171    } else {
172      GgSchRSet-&gt;SaveBin(FNm);
173    }
174  }
175  void TGgSchRSet::SaveXml(const TStr&amp; FNm, const PGgSchRSet&amp; GgSchRSet){
176    if (GgSchRSet.Empty()){
177      TFOut FOut(FNm); FILE* fOut=FOut.GetFileId();
178      fprintf(fOut, &quot;&lt;GgSchRSets&gt;\n&quot;);
179      fprintf(fOut, &quot;  &lt;Error/&gt;\n&quot;);
180      fprintf(fOut, &quot;&lt;/GgSchRSets&gt;&quot;);
181    } else {
182      GgSchRSet-&gt;SaveXml(FNm);
183    }
184  }
185  void TGgSchRSet::SaveXml(const TStr&amp; FNm){
186    TFOut FOut(FNm); FILE* fOut=FOut.GetFileId();
187    fprintf(fOut, &quot;&lt;RSet&gt;\n&quot;);
188    if (!GetUrlStr().Empty()){
189      fprintf(fOut, &quot;  &lt;Url&gt;%s&lt;/Url&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(GetUrlStr()).CStr());}
190    if (!GetNextUrlStr().Empty()){
191      fprintf(fOut, &quot;  &lt;NextUrl&gt;%s&lt;/NextUrl&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(GetNextUrlStr()).CStr());}
192    if (!GetQueryStr().Empty()){
193      fprintf(fOut, &quot;  &lt;Query&gt;%s&lt;/Query&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(GetQueryStr()).CStr());}
194    if (GetAllHits()!=-1){
195      fprintf(fOut, &quot;  &lt;AllHits&gt;%d&lt;/AllHits&gt;\n&quot;, GetAllHits());}
196    fprintf(fOut, &quot;  &lt;Hits Size=\&quot;%d\&quot;&gt;\n&quot;, GetHits());
197    for (int HitN=0; HitN&lt;GetHits(); HitN++){
198      PGgSchRef Ref=GetHit(HitN);
199      Ref-&gt;SaveXml(fOut, 1+HitN);
200    }
201    fprintf(fOut, &quot;  &lt;/Hits&gt;\n&quot;);
202    fprintf(fOut, &quot;&lt;/RSet&gt;&quot;);
203  }
204  void TGgSchRSet::LoadRSetsBin(const TStr&amp; FNm, TGgSchRSetV&amp; RSetV){
205    TFIn SIn(FNm); RSetV.Clr(); int RSets=0;
206    while (!SIn.Eof()){
207      RSets++; if (RSets%100==0){printf(&quot;%d\r&quot;, RSets);}
208      PGgSchRSet RSet(SIn);
209      RSetV.Add(RSet);
210    }
211  }
212  void TGgSchRSet::SaveRSetsBin(const TStr&amp; FNm, TGgSchRSetV&amp; RSetV){
213    TFOut SOut(FNm);
214    for (int RSetN=0; RSetN&lt;RSetV.Len(); RSetN++){
215      RSetV[RSetN].Save(SOut);
216    }
217  }
218  void TGgSchBs::AddRef(const PGgSchRef&amp; Ref){
219    TMd5Sig Sig=Ref-&gt;GetMd5Sig();
220    if (!RefMd5ToRefH.IsKey(Sig)){
221      RefMd5ToRefH.AddDat(Sig)=Ref;
222      RefMd5ToRefCiteCrawlPH.AddDat(Sig)=false;
223      for (int AuthN=0; AuthN&lt;Ref-&gt;AuthNmV.Len(); AuthN++){
224        TStr LcAuthNm=Ref-&gt;AuthNmV[AuthN].GetLc();
225        if ((!LcAuthNm.Empty())&amp;&amp;(!AuthNmToCrawlPH.IsKey(LcAuthNm))){
226          AuthNmToCrawlPH.AddDat(LcAuthNm)=false;
227        }
228      }
229      TStr LcPubNm=Ref-&gt;PubNm.GetLc();
230      if ((!Ref-&gt;PubNm.Empty())&amp;&amp;(!AuthNmToCrawlPH.IsKey(LcPubNm))){
231        PubNmToCrawlPH.AddDat(LcPubNm)=false;
232      }
233    }
234  }
235  void TGgSchBs::AddRSet(const PGgSchRSet&amp; RSet){
236    for (int HitN=0; HitN&lt;RSet-&gt;GetHits(); HitN++){
237      PGgSchRef Ref=RSet-&gt;GetHit(HitN);
238      AddRef(Ref);
239    }
240  }
241  TStr TGgSchBs::GetAuthNmToCrawl() const {
242    TStr AuthNm;
243    for (int AuthN=0; AuthN&lt;AuthNmToCrawlPH.Len(); AuthN++){
244      if (!AuthNmToCrawlPH[AuthN]){
245        AuthNm=AuthNmToCrawlPH.GetKey(AuthN); break;
246      }
247    }
248    return AuthNm;
249  }
250  void TGgSchBs::SetAuthCrawled(const TStr&amp; AuthNm){
251    AuthNmToCrawlPH.AddDat(AuthNm.GetLc())=true;
252  }
253  void TGgSchBs::SaveXml(const TStr&amp; FNm){
254    TFOut FOut(FNm); FILE* fOut=FOut.GetFileId();
255    fprintf(fOut, &quot;&lt;GgSchBs&gt;\n&quot;);
256    for (int RefN=0; RefN&lt;GetRefs(); RefN++){
257      PGgSchRef Ref=GetRef(RefN);
258      Ref-&gt;SaveXml(fOut, 1+RefN);
259    }
260    fprintf(fOut, &quot;&lt;/GgSchBs&gt;&quot;);
261  }
262  PRSet TRSet::NewWeb(const TStr&amp; UrlStr, const TStr&amp; HtmlStr){
263    PRSet RSet=TRSet::New();
264    PSIn HtmlSIn=TStrIn::New(HtmlStr);
265    THtmlLx HtmlLx(HtmlSIn);
266    HtmlLx.MoveToStrOrEof(&quot;Results&quot;);
267    TStr FromResultStr=HtmlLx.GetStrInTag(&quot;&lt;B&gt;&quot;, true);
268    TStr ToResultStr=HtmlLx.GetStrInTag(&quot;&lt;B&gt;&quot;, true);
269    TStr AllHitsStr=HtmlLx.GetStrInTag(&quot;&lt;B&gt;&quot;, true);
270    AllHitsStr.DelChAll(&#x27;,&#x27;);
271    TStr QueryStr=HtmlLx.GetStrInTag(&quot;&lt;B&gt;&quot;, true);
272    forever {
273      HtmlLx.MoveToBTagOrEof(&quot;&lt;DIV&gt;&quot;, &quot;CLASS&quot;, &quot;g&quot;, &quot;&lt;BR&gt;&quot;, &quot;CLEAR&quot;, &quot;all&quot;);
274      if (!((HtmlLx.Sym==hsyBTag)&amp;&amp;(HtmlLx.UcChA==&quot;&lt;DIV&gt;&quot;))){break;}
275      HtmlLx.MoveToBTagOrEof(&quot;&lt;A&gt;&quot;);
276      if (HtmlLx.Sym!=hsyBTag){break;}
277      TStr HitUrlStr=HtmlLx.GetArg(&quot;HREF&quot;);
278      TStr HitTitleStr=HtmlLx.GetStrToETag(&quot;&lt;A&gt;&quot;, true);
279      HtmlLx.MoveToBTagOrEof(&quot;&lt;DIV&gt;&quot;);
280      TStr HitCtxStr=HtmlLx.GetStrToBTag(&quot;&lt;BR&gt;&quot;, true);
281      RSet-&gt;AddHit(HitUrlStr, HitTitleStr, &quot;&quot;, HitCtxStr);
282    }
283    TStr NextUrlStr;
284    if ((HtmlLx.Sym==hsyBTag)&amp;&amp;(HtmlLx.UcChA==&quot;&lt;BR&gt;&quot;)){
285      TStr NextRelUrlStr=HtmlLx.GetHRefBeforeStr(&quot;Next&quot;);
286      if (!NextRelUrlStr.Empty()){
287        PUrl NextUrl=TUrl::New(NextRelUrlStr, UrlStr);
288        if (NextUrl-&gt;IsOk()){
289          NextUrlStr=NextUrl-&gt;GetUrlStr();
290        }
291      }
292    }
293    RSet-&gt;PutUrlStr(UrlStr);
294    RSet-&gt;PutNextUrlStr(NextUrlStr);
295    RSet-&gt;PutQueryStr(QueryStr);
296    RSet-&gt;PutAllHits(AllHitsStr.GetInt(-1));
297    return RSet;
298  }
299  PRSet TRSet::NewWeb(const PWebPg&amp; WebPg){
300    TStr UrlStr=WebPg-&gt;GetUrlStr();
301    TStr HtmlStr=WebPg-&gt;GetHttpBodyAsStr();
302    return TRSet::NewWeb(UrlStr, HtmlStr);
303  }
304  PRSet TRSet::NewNews(const TStr&amp; UrlStr, const TStr&amp; HtmlStr){
305    PRSet RSet=TRSet::New();
306    PSIn HtmlSIn=TStrIn::New(HtmlStr);
307    THtmlLx HtmlLx(HtmlSIn);
308    HtmlLx.MoveToStrOrEof(&quot;Results&quot;);
309    TStr FromResultStr=HtmlLx.GetStrInTag(&quot;&lt;B&gt;&quot;, true);
310    TStr ToResultStr=HtmlLx.GetStrInTag(&quot;&lt;B&gt;&quot;, true);
311    TStr AllHitsStr=HtmlLx.GetStrInTag(&quot;&lt;B&gt;&quot;, true);
312    AllHitsStr.DelChAll(&#x27;,&#x27;);
313    TStr QueryStr=HtmlLx.GetStrInTag(&quot;&lt;B&gt;&quot;, true);
314    forever {
315      HtmlLx.MoveToBTagOrEof(&quot;&lt;TABLE&gt;&quot;, &quot;WIDTH&quot;, &quot;75%&quot;, &quot;&lt;DIV&gt;&quot;, &quot;CLASS&quot;, &quot;n&quot;);
316      if (!((HtmlLx.Sym==hsyBTag)&amp;&amp;(HtmlLx.UcChA==&quot;&lt;TABLE&gt;&quot;))){break;}
317      HtmlLx.MoveToBTagOrEof(&quot;&lt;A&gt;&quot;);
318      if (HtmlLx.Sym!=hsyBTag){break;}
319      TStr HitUrlStr=HtmlLx.GetArg(&quot;HREF&quot;);
320      TStr IdStr=HtmlLx.GetArg(&quot;ID&quot;);
321      if ((!IdStr.Empty())&amp;&amp;(IdStr.LastCh()==&#x27;i&#x27;)){
322        HtmlLx.MoveToBTagOrEof(&quot;&lt;A&gt;&quot;);
323        if (HtmlLx.Sym!=hsyBTag){break;}
324        HitUrlStr=HtmlLx.GetArg(&quot;HREF&quot;);
325      }
326      TStr HitTitleStr=HtmlLx.GetStrToETag(&quot;&lt;A&gt;&quot;, true);
327      TStr HitSrcNm=HtmlLx.GetStrToBTag(&quot;&lt;NOBR&gt;&quot;, true);
328      if (HitSrcNm.IsSuffix(&quot; -&quot;)){
329        HitSrcNm=HitSrcNm.GetSubStr(0, HitSrcNm.Len()-3);}
330      HtmlLx.MoveToETagOrEof(&quot;&lt;NOBR&gt;&quot;);
331      TStr HitCtxStr=HtmlLx.GetStrToETag(&quot;&lt;TABLE&gt;&quot;, true);
332      RSet-&gt;AddHit(HitUrlStr, HitTitleStr, HitSrcNm, HitCtxStr);
333    }
334    TStr NextUrlStr;
335    if ((HtmlLx.Sym==hsyBTag)&amp;&amp;(HtmlLx.UcChA==&quot;&lt;DIV&gt;&quot;)){
336      TStr NextRelUrlStr=HtmlLx.GetHRefBeforeStr(&quot;Next&quot;);
337      if (!NextRelUrlStr.Empty()){
338        PUrl NextUrl=TUrl::New(NextRelUrlStr, UrlStr);
339        if (NextUrl-&gt;IsOk()){
340          NextUrlStr=NextUrl-&gt;GetUrlStr();
341        }
342      }
343    }
344    RSet-&gt;PutUrlStr(UrlStr);
345    RSet-&gt;PutNextUrlStr(NextUrlStr);
346    RSet-&gt;PutQueryStr(QueryStr);
347    RSet-&gt;PutAllHits(AllHitsStr.GetInt(-1));
348    return RSet;
349  }
350  PRSet TRSet::NewNews(const PWebPg&amp; WebPg){
351    TStr UrlStr=WebPg-&gt;GetUrlStr();
352    TStr HtmlStr=WebPg-&gt;GetHttpBodyAsStr();
353    return TRSet::NewNews(UrlStr, HtmlStr);
354  }
355  int TRSet::GetHitN(const TStr&amp; UrlStr, const bool&amp; LcP) const {
356    int Hits=GetHits();
357    TStr LcUrlStr=UrlStr.GetLc();
358    for (int HitN=0; HitN&lt;Hits; HitN++){
359      if (LcP){
360        if (GetHitUrlStr(HitN).GetLc()==LcUrlStr){return HitN;}
361      } else {
362        if (GetHitUrlStr(HitN)==UrlStr){return HitN;}
363      }
364    }
365    return -1;
366  }
367  void TRSet::Merge(const PRSet&amp; RSet){
368    if (RSet.Empty()){return;}
369    TStrH UrlStrH(GetHits());
370    for (int HitN=0; HitN&lt;GetHits(); HitN++){
371      UrlStrH.AddKey(GetHitUrlStr(HitN));
372    }
373    for (int HitN=0; HitN&lt;RSet-&gt;GetHits(); HitN++){
374      TStr HitUrlStr; TStr HitTitleStr; TStr HitSrcNm; TStr HitCtxStr;
375      RSet-&gt;GetHit(HitN, HitUrlStr, HitTitleStr, HitSrcNm, HitCtxStr);
376      if (!UrlStrH.IsKey(HitUrlStr)){
377        AddHit(HitUrlStr, HitTitleStr, HitSrcNm, HitCtxStr);
378        UrlStrH.AddKey(HitUrlStr);
379      }
380    }
381    PutNextUrlStr(&quot;&quot;);
382    PutAllHits(-1);
383  }
384  PBowDocBs TRSet::GetBowDocBs(
385   const TStr&amp; SwSetTypeNm, const TStr&amp; StemmerTypeNm,
386   const int&amp; MxNGramLen, const int&amp; MnNGramFq) const {
387    PSwSet SwSet=TSwSet::GetSwSet(SwSetTypeNm);
388    PStemmer Stemmer=TStemmer::GetStemmer(StemmerTypeNm);
389    TStrV HtmlStrV(GetHits(), 0);
390    for (int HitN=0; HitN&lt;GetHits(); HitN++){
391      TStr TitleStr=GetHitTitleStr(HitN);
392      TStr CtxStr=GetHitCtxStr(HitN);
393      TStr HtmlStr=TitleStr+&quot;. &quot;+CtxStr;
394      HtmlStrV.Add(HtmlStr);
395    }
396    PNGramBs NGramBs=TNGramBs::GetNGramBsFromHtmlStrV(
397     HtmlStrV, MxNGramLen, MnNGramFq, SwSet, Stemmer);
398    printf(&quot;Create Bag-Of-Words Base ... &quot;);
399    PBowDocBs BowDocBs=TBowDocBs::New();
400    BowDocBs-&gt;PutNGramBs(NGramBs);
401    for (int HitN=0; HitN&lt;GetHits(); HitN++){
402      BowDocBs-&gt;AddHtmlDoc(GetHitTitleStr(HitN), TStrV(), HtmlStrV[HitN], true);
403    }
404    BowDocBs-&gt;AssertOk();
405    printf(&quot;Done.\n&quot;);
406    return BowDocBs;
407  }
408  PRSet TRSet::LoadBin(const TStr&amp; FNm, const bool&amp; MultiRSetsP){
409    if (!MultiRSetsP){
410      TFIn SIn(FNm); return Load(SIn);
411    } else {
412      PRSet RSet=TRSet::New();
413      TFIn SIn(FNm); int RSets=0;
414      while (!SIn.Eof()){
415        RSets++; 
416        PRSet SubRSet=TRSet::Load(SIn);
417        RSet-&gt;Merge(SubRSet);
418      }
419      return RSet;
420    }
421  }
422  void TRSet::SaveBin(const TStr&amp; FNm, const PRSet&amp; RSet, const bool&amp; Append){
423    if (RSet.Empty()){
424      PRSet RSet=TRSet::New();
425      RSet-&gt;SaveBin(FNm, Append);
426    } else {
427      RSet-&gt;SaveBin(FNm, Append);
428    }
429  }
430  void TRSet::SaveXml(const TStr&amp; FNm, const PRSet&amp; RSet){
431    if (RSet.Empty()){
432      TFOut FOut(FNm); FILE* fOut=FOut.GetFileId();
433      fprintf(fOut, &quot;&lt;RSets&gt;\n&quot;);
434      fprintf(fOut, &quot;  &lt;Error/&gt;\n&quot;);
435      fprintf(fOut, &quot;&lt;/RSets&gt;&quot;);
436    } else {
437      RSet-&gt;SaveXml(FNm);
438    }
439  }
440  void TRSet::SaveXml(const TStr&amp; FNm){
441    TFOut FOut(FNm); FILE* fOut=FOut.GetFileId();
442    fprintf(fOut, &quot;&lt;RSet&gt;\n&quot;);
443    if (!GetUrlStr().Empty()){
444      fprintf(fOut, &quot;  &lt;Url&gt;%s&lt;/Url&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(GetUrlStr()).CStr());}
445    if (!GetNextUrlStr().Empty()){
446      fprintf(fOut, &quot;  &lt;NextUrl&gt;%s&lt;/NextUrl&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(GetNextUrlStr()).CStr());}
447    if (!GetQueryStr().Empty()){
448      fprintf(fOut, &quot;  &lt;Query&gt;%s&lt;/Query&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(GetQueryStr()).CStr());}
449    if (GetAllHits()!=-1){
450      fprintf(fOut, &quot;  &lt;AllHits&gt;%d&lt;/AllHits&gt;\n&quot;, GetAllHits());}
451    fprintf(fOut, &quot;  &lt;Hits Size=\&quot;%d\&quot;&gt;\n&quot;, GetHits());
452    for (int HitN=0; HitN&lt;GetHits(); HitN++){
453      TStr HitUrlStr; TStr HitTitleStr; TStr HitSrcNm; TStr HitCtxStr;
454      GetHit(HitN, HitUrlStr, HitTitleStr, HitSrcNm, HitCtxStr);
455      fprintf(fOut, &quot;    &lt;Hit Num=\&quot;%d\&quot;&gt;\n&quot;, 1+HitN);
456      fprintf(fOut, &quot;      &lt;Url&gt;%s&lt;/Url&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(HitUrlStr).CStr());
457      fprintf(fOut, &quot;      &lt;Title&gt;%s&lt;/Title&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(HitTitleStr).CStr());
458      if (!HitSrcNm.Empty()){
459        fprintf(fOut, &quot;      &lt;Source&gt;%s&lt;/Source&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(HitSrcNm).CStr());}
460      fprintf(fOut, &quot;      &lt;Snippet&gt;%s&lt;/Snippet&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(HitCtxStr).CStr());
461      fprintf(fOut, &quot;    &lt;/Hit&gt;\n&quot;);
462    }
463    fprintf(fOut, &quot;  &lt;/Hits&gt;\n&quot;);
464    fprintf(fOut, &quot;&lt;/RSet&gt;&quot;);
465  }
466  void TRSet::LoadRSetsBin(const TStr&amp; FNm, TRSetV&amp; RSetV){
467    TFIn SIn(FNm); RSetV.Clr(); int RSets=0;
468    while (!SIn.Eof()){
469      RSets++; printf(&quot;%d\r&quot;, RSets);
470      PRSet RSet=TRSet::Load(SIn);
471      RSetV.Add(RSet);
472    }
473  }
474  void TRSet::SaveRSetsBin(const TStr&amp; FNm, TRSetV&amp; RSetV){
475    TFOut SOut(FNm);
476    for (int RSetN=0; RSetN&lt;RSetV.Len(); RSetN++){
477      RSetV[RSetN]-&gt;Save(SOut);
478    }
479  }
480  void TGgWebFetchSaver::OnFetch(const int&amp;, const PWebPg&amp; WebPg){
481    printf(&quot;Fetched [Wait:%d Conn.:%d]: %s\n&quot;,
482     GetWaitUrls(), GetConnUrls(), WebPg-&gt;GetUrlStr().CStr());
483    WebPgV.Add(WebPg);
484    if (Empty()){
485      TSysMsg::Quit();}
486  }
487  void TGgWebFetchSaver::OnError(const int&amp;, const TStr&amp; MsgStr){
488    printf(&quot;Error [Wait:%d Conn.:%d]: %s\n&quot;,
489     GetWaitUrls(), GetConnUrls(), MsgStr.CStr());
490    if (Empty()){
491      TSysMsg::Quit();}
492  }
493  PWebPg TGgWebFetchSaver::GetWebPg(const TStr&amp; UrlStr) const {
494    for (int WebPgN=0; WebPgN&lt;GetWebPgs(); WebPgN++){
495      if (GetWebPg(WebPgN)-&gt;GetUrlStr(0)==UrlStr){
496        return GetWebPg(WebPgN);}
497    }
498    return NULL;
499  }
500  PGgFCrawl TGgFCrawl::GetFCrawl(
501   const TStr&amp; SrcUrlStr, const int&amp; MxCands, const TStr&amp; ProxyStr){
502    printf(&quot;Expand source URL: %s\n&quot;, SrcUrlStr.CStr());
503    PRSet SrcUrlRSet=
504     TGg::WebSearch(TStr(&quot;related:&quot;)+SrcUrlStr, -1, TNotify::NullNotify, ProxyStr);
505    PGgFCrawl FCrawl=TGgFCrawl::New();
506    FCrawl-&gt;SrcUrlStr=SrcUrlStr;
507    FCrawl-&gt;DstRSet=TRSet::New(SrcUrlRSet);
508    for (int HitN=0; HitN&lt;SrcUrlRSet-&gt;GetHits(); HitN++){
509      if ((MxCands!=-1)&amp;&amp;(FCrawl-&gt;DstRSet-&gt;GetHits()&gt;MxCands)){break;}
510      TStr HitUrlStr=SrcUrlRSet-&gt;GetHitUrlStr(HitN);
511      printf(&quot;Expand URL: %s\n&quot;, HitUrlStr.CStr());
512      PRSet RelUrlRSet=
513       TGg::WebSearch(TStr(&quot;related:&quot;)+HitUrlStr, -1, TNotify::NullNotify, ProxyStr);
514      FCrawl-&gt;DstRSet-&gt;Merge(RelUrlRSet);
515    }
516    TGgWebFetchSaver WebFetchSaver(100);
517    WebFetchSaver.PutProxyStr(ProxyStr);
518    {bool Ok; TStr MsgStr;
519    TWebFetchBlocking::GetWebPg(
520     SrcUrlStr, Ok, MsgStr, FCrawl-&gt;SrcWebPg, NULL, ProxyStr);
521    if (!Ok){FCrawl-&gt;SrcWebPg=NULL;}}
522    int FetchHits=FCrawl-&gt;DstRSet-&gt;GetHits();
523    if ((MxCands!=-1)&amp;&amp;(MxCands&lt;FetchHits)){FetchHits=MxCands;}
524    for (int HitN=0; HitN&lt;FetchHits; HitN++){
525      TStr HitUrlStr=FCrawl-&gt;DstRSet-&gt;GetHitUrlStr(HitN);
526      WebFetchSaver.FetchUrl(HitUrlStr);
527    }
528    TSysMsg::Loop();
529    for (int WebPgN=0; WebPgN&lt;WebFetchSaver.GetWebPgs(); WebPgN++){
530      PWebPg WebPg=WebFetchSaver.GetWebPg(WebPgN);
531      FCrawl-&gt;UrlStrToWebPgH.AddDat(WebPg-&gt;GetUrlStr(), WebPg);
532    }
533    FCrawl-&gt;BowDocBs=TBowDocBs::New();
534    FCrawl-&gt;SrcDId=FCrawl-&gt;BowDocBs-&gt;AddHtmlDoc(
535     SrcUrlStr, TStrV(), FCrawl-&gt;SrcWebPg-&gt;GetHttpBodyAsStr());
536    for (int WebPgN=0; WebPgN&lt;WebFetchSaver.GetWebPgs(); WebPgN++){
537      PWebPg WebPg=WebFetchSaver.GetWebPg(WebPgN);
538      FCrawl-&gt;BowDocBs-&gt;AddHtmlDoc(
539       WebPg-&gt;GetUrlStr(0), TStrV(), WebPg-&gt;GetHttpBodyAsStr());
540    }
541    PBowDocWgtBs BowDocWgtBs=TBowDocWgtBs::New(FCrawl-&gt;BowDocBs, bwwtNrmTFIDF);
542    PBowSim BowSim=TBowSim::New(bstCos);
543    FCrawl-&gt;SimDIdKdV; FCrawl-&gt;SumSim=0;
544    for (int DIdN=0; DIdN&lt;BowDocWgtBs-&gt;GetDocs(); DIdN++){
545      int DId=BowDocWgtBs-&gt;GetDId(DIdN);
546      if (DId!=FCrawl-&gt;SrcDId){
547        double Sim=BowSim-&gt;GetSim(
548         BowDocWgtBs-&gt;GetSpV(FCrawl-&gt;SrcDId), BowDocWgtBs-&gt;GetSpV(DId));
549        FCrawl-&gt;SimDIdKdV.Add(TFltIntKd(Sim, DId));
550        FCrawl-&gt;SumSim+=Sim;
551      }
552    }
553    FCrawl-&gt;SimDIdKdV.Sort(false);
554    FCrawl-&gt;Ok=true;
555    return FCrawl;
556  }
557  void TGgFCrawl::SaveXml(const TStr&amp; FNm, const bool&amp; SaveDocP){
558    if (!Ok){return;}
559    PSOut SOut=TFOut::New(FNm);
560    FILE* fOut=SOut-&gt;GetFileId();
561    fprintf(fOut, &quot;&lt;FocusedCrawl&gt;\n&quot;);
562    fprintf(fOut, &quot;  &lt;SourceWebPage&gt;\n&quot;);
563    fprintf(fOut, &quot;    &lt;Url&gt;%s&lt;/Url&gt;\n&quot;, SrcUrlStr.CStr());
564    if (SaveDocP){
565      THtmlDoc::SaveHtmlToXml(SrcWebPg-&gt;GetHttpBodyAsStr(), SOut,
566       SrcUrlStr, false, false, true, false, false);
567    }
568    fprintf(fOut, &quot;  &lt;/SourceWebPage&gt;\n&quot;);
569    fprintf(fOut, &quot;  &lt;FocusedWebPages&gt;\n&quot;, SimDIdKdV.Len());
570    double SumSimSF=0;
571    for (int DIdN=0; DIdN&lt;SimDIdKdV.Len(); DIdN++){
572      double Sim=SimDIdKdV[DIdN].Key;
573      SumSimSF+=Sim; if ((SumSim==0)||(SumSimSF&gt;SumSim*0.99)){break;}
574      int DId=SimDIdKdV[DIdN].Dat;
575      TStr UrlStr=BowDocBs-&gt;GetDocNm(DId);
576      printf(&quot;%d. %.3f %s\n&quot;, 1+DIdN, Sim, UrlStr.CStr());
577      int HitN=DstRSet-&gt;GetHitN(UrlStr); IAssert(HitN!=-1);
578      fprintf(fOut, &quot;    &lt;WebPage Rank=\&quot;%d\&quot; Sim=\&quot;%.3f\&quot;&gt;\n&quot;, 1+DIdN, Sim, UrlStr.CStr());
579      fprintf(fOut, &quot;      &lt;Url&gt;%s&lt;/Url&gt;\n&quot;, UrlStr.CStr());
580      fprintf(fOut, &quot;      &lt;Title&gt;%s&lt;/Title&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(DstRSet-&gt;GetHitTitleStr(HitN)).CStr());
581      fprintf(fOut, &quot;      &lt;Context&gt;%s&lt;/Context&gt;\n&quot;, TXmlLx::GetXmlStrFromPlainStr(DstRSet-&gt;GetHitCtxStr(HitN)).CStr());
582      if (SaveDocP){
583        PWebPg WebPg=UrlStrToWebPgH.GetDat(UrlStr);
584        THtmlDoc::SaveHtmlToXml(WebPg-&gt;GetHttpBodyAsStr(), SOut,
585         SrcUrlStr, false, false, true, false, false);
586      }
587      fprintf(fOut, &quot;    &lt;/WebPage&gt;\n&quot;);
588    }
589    printf(&quot;\n&quot;);
590    fprintf(fOut, &quot;  &lt;/FocusedWebPages&gt;\n&quot;);
591    fprintf(fOut, &quot;&lt;/FocusedCrawl&gt;\n&quot;);
592  }
593  void TGgFCrawl::SaveTxt(const TStr&amp; FNm){
594    PSOut SOut=TFOut::New(FNm);
595    FILE* fOut=SOut-&gt;GetFileId();
596    if (Ok){
597      fprintf(fOut, &quot;&lt;SourceWebPage&gt;\n&quot;);
598      fprintf(fOut, &quot;%s\n&quot;, SrcUrlStr.CStr());
599      double SumSimSF=0;
600      for (int DIdN=0; DIdN&lt;SimDIdKdV.Len(); DIdN++){
601        double Sim=SimDIdKdV[DIdN].Key;
602        SumSimSF+=Sim; if ((SumSim==0)||(SumSimSF&gt;SumSim*0.99)){break;}
603        int DId=SimDIdKdV[DIdN].Dat;
604        TStr UrlStr=BowDocBs-&gt;GetDocNm(DId);
605        printf(&quot;%d. %.3f %s\n&quot;, 1+DIdN, Sim, UrlStr.CStr());
606        int HitN=DstRSet-&gt;GetHitN(UrlStr); IAssert(HitN!=-1);
607        TStr TitleStr=DstRSet-&gt;GetHitTitleStr(HitN);
608        TitleStr.ChangeChAll(&#x27;\n&#x27;, &#x27; &#x27;);
609        TStr CtxStr=DstRSet-&gt;GetHitCtxStr(HitN);
610        CtxStr.ChangeChAll(&#x27;\n&#x27;, &#x27; &#x27;);
611        fprintf(fOut, &quot;&lt;ResultWebPage&gt;\n&quot;);
612        fprintf(fOut, &quot;%s\n&quot;, UrlStr.CStr());
613        fprintf(fOut, &quot;%s\n&quot;, TitleStr.CStr());
614        fprintf(fOut, &quot;%s\n&quot;, CtxStr.CStr());
615      }
616    } else {
617      fprintf(fOut, &quot;&lt;Error&gt;\n&quot;);
618    }
619    fprintf(fOut, &quot;&lt;End&gt;\n&quot;);
620  }
621  PGgCtxGraph TGgCtxGraph::GetCtxGraph(const TStr&amp; FocusUrlStr){
622    PGgCtxGraph CtxGraph=TGgCtxGraph::New();
623    CtxGraph-&gt;Ok=false;
624    CtxGraph-&gt;FocusUrlStr=FocusUrlStr;
625    {bool Ok; TStr MsgStr;
626    TWebFetchBlocking::GetWebPg(
627     CtxGraph-&gt;FocusUrlStr, Ok, MsgStr, CtxGraph-&gt;FocusWebPg, TNotify::StdNotify);
628    if (!Ok){return CtxGraph;}}
629    PRSet InRSet=
630     TGg::WebSearch(TStr(&quot;link:&quot;)+CtxGraph-&gt;FocusUrlStr, -1, TNotify::StdNotify);
631    for (int HitN=0; HitN&lt;InRSet-&gt;GetHits(); HitN++){
632      TStr UrlStr; TStr TitleStr; TStr SrcNm; TStr CtxStr;
633      InRSet-&gt;GetHit(HitN, UrlStr, TitleStr, SrcNm, CtxStr);
634      TitleStr.ChangeChAll(&#x27;\n&#x27;, &#x27; &#x27;);
635      CtxGraph-&gt;InUrlCtxStrPrV.Add(TStrPr(UrlStr, TitleStr));
636    }
637    TStrKdV OutDescUrlStrKdV;
638    CtxGraph-&gt;FocusWebPg-&gt;GetOutDescUrlStrKdV(OutDescUrlStrKdV);
639    for (int UrlN=0; UrlN&lt;OutDescUrlStrKdV.Len(); UrlN++){
640      OutDescUrlStrKdV[UrlN].Key.ChangeChAll(&#x27;\n&#x27;, &#x27; &#x27;);
641      CtxGraph-&gt;OutUrlCtxStrPrV.Add(
642       TStrPr(OutDescUrlStrKdV[UrlN].Dat, OutDescUrlStrKdV[UrlN].Key));
643    }
644    CtxGraph-&gt;Ok=true;
645    return CtxGraph;
646  }
647  void TGgCtxGraph::SaveTxt(const TStr&amp; FNm){
648    PSOut SOut=TFOut::New(FNm);
649    FILE* fOut=SOut-&gt;GetFileId();
650    if (Ok){
651      fprintf(fOut, &quot;&lt;FocusWebPage&gt;\n&quot;);
652      fprintf(fOut, &quot;%s\n&quot;, FocusUrlStr.CStr());
653      for (int UrlN=0; UrlN&lt;InUrlCtxStrPrV.Len(); UrlN++){
654        fprintf(fOut, &quot;&lt;InWebPage&gt;\n&quot;);
655        fprintf(fOut, &quot;%s\n&quot;, InUrlCtxStrPrV[UrlN].Val1.CStr());
656        fprintf(fOut, &quot;%s\n&quot;, InUrlCtxStrPrV[UrlN].Val2.CStr());
657      }
658      for (int UrlN=0; UrlN&lt;OutUrlCtxStrPrV.Len(); UrlN++){
659        fprintf(fOut, &quot;&lt;OutWebPage&gt;\n&quot;);
660        fprintf(fOut, &quot;%s\n&quot;, OutUrlCtxStrPrV[UrlN].Val1.CStr());
661        fprintf(fOut, &quot;%s\n&quot;, OutUrlCtxStrPrV[UrlN].Val2.CStr());
662      }
663    } else {
664      fprintf(fOut, &quot;&lt;Error&gt;\n&quot;);
665    }
666    fprintf(fOut, &quot;&lt;End&gt;\n&quot;);
667  }
668  TStr TGg::GetWebSearchUrlStr(const TStr&amp; QueryStr){
669    TStr SearchUrlStr=
670     &quot;http:&amp;bsol;&amp;bsol;www.google.com/search?num=100&amp;q=&quot;+
671     TUrl::GetUrlSearchStr(QueryStr);
672    return SearchUrlStr;
673  }
674  TStr TGg::GetNewsSearchUrlStr(const TStr&amp; QueryStr){
675    TStr SearchUrlStr=
676     &quot;http:&amp;bsol;&amp;bsol;news.google.com/news?num=100&amp;q=&quot;+
677     TUrl::GetUrlSearchStr(QueryStr);
678    return SearchUrlStr;
679  }
680  TStr TGg::GetScholarSearchUrlStr(const TStr&amp; QueryStr){
681    TStr SearchUrlStr=
682     &quot;http:&amp;bsol;&amp;bsol;scholar.google.com/scholar?num=100&amp;hl=en&amp;lr=&amp;q=&quot;+
683     TUrl::GetUrlSearchStr(QueryStr);
684    return SearchUrlStr;
685  }
686  TStr TGg::GetScholarAuthorSearchUrlStr(const TStr&amp; QueryStr){
687    TStr AuthorQueryStr=TStr(&quot;author:\&quot;&quot;)+QueryStr+&quot;\&quot;&quot;;
688    TStr SearchUrlStr=
689     &quot;http:&amp;bsol;&amp;bsol;scholar.google.com/scholar?num=100&amp;hl=en&amp;lr=&amp;q=&quot;+
690     TUrl::GetUrlSearchStr(AuthorQueryStr);
691    return SearchUrlStr;
692  }
693  TStr TGg::GetScholarPublicationSearchUrlStr(const TStr&amp; QueryStr){
694    TStr PublicationQueryStr=TStr(&quot;\&quot;&quot;)+QueryStr+&quot;\&quot;&quot;;
695    TStr SearchUrlStr=
696     &quot;http:&amp;bsol;&amp;bsol;scholar.google.com/scholar?num=100&amp;hl=en&amp;lr=&amp;q=&amp;as_publication=&quot;+
697     TUrl::GetUrlSearchStr(PublicationQueryStr);
698    return SearchUrlStr;
699  }
700  PRSet TGg::WebSearch(const TStr&amp; QueryStr, const int&amp; MxHits,
701   const PNotify&amp; Notify, const TStr&amp; ProxyStr){
702    TStr SearchUrlStr=TGg::GetWebSearchUrlStr(QueryStr);
703    printf(&quot;.&quot;); bool Ok; TStr MsgStr; PWebPg WebPg;
704    TWebFetchBlocking::GetWebPg(
705     SearchUrlStr, Ok, MsgStr, WebPg, Notify, ProxyStr);
706    if (Ok){
707      PRSet RSet=TRSet::NewWeb(WebPg);
708      TStr NextSearchUrlStr=RSet-&gt;GetNextUrlStr();
709      while (!NextSearchUrlStr.Empty()){
710        if ((MxHits!=-1)&amp;&amp;(RSet-&gt;GetHits()&gt;=MxHits)){break;}
711        printf(&quot;.&quot;); bool NextOk; TStr NextMsgStr; PWebPg NextWebPg;
712        TWebFetchBlocking::GetWebPg(
713         NextSearchUrlStr, NextOk, NextMsgStr, NextWebPg, Notify, ProxyStr);
714        if (NextOk){
715          PRSet NextRSet=TRSet::NewWeb(NextWebPg);
716          RSet-&gt;Merge(NextRSet);
717          NextSearchUrlStr=NextRSet-&gt;GetNextUrlStr();
718        } else {
719          NextSearchUrlStr=&quot;&quot;;
720        }
721      }
722      RSet-&gt;Trunc(MxHits);
723      RSet-&gt;PutQueryStr(QueryStr);
724      return RSet;
725    } else {
726      return TRSet::New();
727    }
728  }
729  PRSet TGg::WebSearchExternal(
730   const TStr&amp; QueryStr, const int&amp; MxHits, const PNotify&amp; Notify){
731    TStr ExeFPath=Env.GetExeFPath();
732    TStr ExeFNm=TStr::GetNrFPath(ExeFPath)+&quot;Google2RSet.exe&quot;;
733    TStr RSetFNm=TStr::GetNrFPath(ExeFPath)+TTm::GetCurUniTm().GetIdStr()+&quot;.RSet&quot;;
734    TStr CmLn=
735     TStr::GetStr(QueryStr, &quot; -iwq:%s&quot;)+
736     TInt::GetStr(MxHits, &quot; -hits:%d&quot;)+
737     TStr::GetStr(RSetFNm, &quot; -obin:\&quot;%s\&quot; -oxml: -obow: -ssilent&quot;);
738    if (TSysProc::ExeProc(ExeFNm, CmLn)){
739      PRSet RSet;
740      {TFIn RSetFIn(RSetFNm);
741      RSet=TRSet::Load(RSetFIn);}
742      TFile::Del(RSetFNm);
743      return RSet;
744    } else {
745      return TRSet::New();
746    }
747  }
748  PRSet TGg::NewsSearch(const TStr&amp; QueryStr, const int&amp; MxHits, const PNotify&amp; Notify){
749    TStr SearchUrlStr=TGg::GetNewsSearchUrlStr(QueryStr);
750    bool Ok; TStr MsgStr; PWebPg WebPg;
751    TWebFetchBlocking::GetWebPg(
752     SearchUrlStr, Ok, MsgStr, WebPg, Notify);
753    if (Ok){
754      PRSet RSet=TRSet::NewNews(WebPg);
755      TStr NextSearchUrlStr=RSet-&gt;GetNextUrlStr();
756      while (!NextSearchUrlStr.Empty()){
757        if ((MxHits!=-1)&amp;&amp;(RSet-&gt;GetHits()&gt;=MxHits)){break;}
758        bool NextOk; TStr NextMsgStr; PWebPg NextWebPg;
<span onclick='openModal()' class='match'>759        TWebFetchBlocking::GetWebPg(
760         NextSearchUrlStr, NextOk, NextMsgStr, NextWebPg, Notify);
761        if (NextOk){
</span>762          PRSet NextRSet=TRSet::NewNews(NextWebPg);
763          RSet-&gt;Merge(NextRSet);
764          NextSearchUrlStr=NextRSet-&gt;GetNextUrlStr();
765        } else {
766          NextSearchUrlStr=&quot;&quot;;
767        }
768      }
769      RSet-&gt;Trunc(MxHits);
770      return RSet;
771    } else {
772      return TRSet::New();
773    }
774  }
775  PGgSchRSet TGg::_ScholarSearch(
776   const TStr&amp; SearchUrlStr, const PNotify&amp; Notify){
777    bool Ok; TStr MsgStr; PWebPg WebPg;
778    TWebFetchBlocking::GetWebPg(
779     SearchUrlStr, Ok, MsgStr, WebPg, Notify);
780    if (Ok){
781      PGgSchRSet GgSchRSet=TGgSchRSet::NewScholar(WebPg);
782      TStr NextSearchUrlStr=GgSchRSet-&gt;GetNextUrlStr();
783      TRnd Rnd(0);
784      while (!NextSearchUrlStr.Empty()){
785        int WaitMSecs=int(1*1000*(Rnd.GetUniDev()+0.5));
786        TSysProc::Sleep(WaitMSecs);
787        bool NextOk; TStr NextMsgStr; PWebPg NextWebPg;
788        TWebFetchBlocking::GetWebPg(
789         NextSearchUrlStr, NextOk, NextMsgStr, NextWebPg, Notify);
790        if (NextOk){
791          PGgSchRSet NextRSet=TGgSchRSet::NewScholar(NextWebPg);
792          GgSchRSet-&gt;Merge(NextRSet);
793          NextSearchUrlStr=NextRSet-&gt;GetNextUrlStr();
794        } else {
795          NextSearchUrlStr=&quot;&quot;;
796        }
797      }
798      return GgSchRSet;
799    } else {
800      return TGgSchRSet::New();
801    }
802  }
803  PGgSchRSet TGg::ScholarSearch(const TStr&amp; QueryStr, const PNotify&amp; Notify){
804    TStr SearchUrlStr=GetScholarSearchUrlStr(QueryStr);
805    return _ScholarSearch(SearchUrlStr, Notify);
806  }
807  PGgSchRSet TGg::ScholarAuthorSearch(const TStr&amp; AuthorNm, const PNotify&amp; Notify){
808    TStr SearchUrlStr=GetScholarAuthorSearchUrlStr(AuthorNm);
809    return _ScholarSearch(SearchUrlStr, Notify);
810  }
811  PGgSchRSet TGg::ScholarPublicationSearch(const TStr&amp; PublicationNm, const PNotify&amp; Notify){
812    TStr SearchUrlStr=GetScholarPublicationSearchUrlStr(PublicationNm);
813    return _ScholarSearch(SearchUrlStr, Notify);
814  }
</code></pre>
        </div>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-tnt.cpp</h3>
            <pre><code>1  #include &quot;tnt.h&quot;
2  void TTntBinDoc::SaveBinDocV(
3   const TStr&amp; InXmlFPath, const TStr&amp; OutBinFNm, const int&amp; MxDocs){
4    printf(&quot;Processing Tnt-News-Xml files from &#x27;%s&#x27;...\n&quot;, InXmlFPath.CStr());
5    TFOut SOut(OutBinFNm);
6    TFFile FFile(InXmlFPath, true); TStr FNm;
7    int Docs=0; int DateDocs=0; uint64 PrevTm=0;
8    while (FFile.Next(FNm)){
9      if ((MxDocs!=-1)&amp;&amp;(Docs&gt;=MxDocs)){break;}
10      PXmlDoc XmlDoc=TXmlDoc::LoadTxt(FNm);
11      PXmlTok ContentTok=XmlDoc-&gt;GetTagTok(&quot;item|content&quot;);
12      TStr DocNm=ContentTok-&gt;GetTagTok(&quot;swid&quot;)-&gt;GetArgVal(&quot;value&quot;);
13      TStr UrlStr=ContentTok-&gt;GetTagTok(&quot;url&quot;)-&gt;GetTokStr(false);
14      TStr SubjStr=ContentTok-&gt;GetTagTok(&quot;title&quot;)-&gt;GetTokStr(false);
15      TStr FetchedValStr=ContentTok-&gt;GetTagTok(&quot;fetched&quot;)-&gt;GetArgVal(&quot;value&quot;);
16      TXmlTokV EntityTokV; ContentTok-&gt;GetTagTokV(&quot;annotations|entity&quot;, EntityTokV);
17      TStr BodyStr=ContentTok-&gt;GetTagTok(&quot;body&quot;)-&gt;GetTokStr(false);
18      TStr DateStr=DocNm.GetSubStr(0, 7);
19      TStr YearStr=DateStr.GetSubStr(0, 3);
20      TStr MonthStr=DateStr.GetSubStr(4, 5);
21      TStr DayStr=DateStr.GetSubStr(6, 7);
22      TTm DateTm(YearStr.GetInt(), MonthStr.GetInt(), DayStr.GetInt());
23      uint64 Tm=TTm::GetMSecsFromTm(DateTm);
24      TStrIntH EntNmToFqH;
25      for (int EntityTokN=0; EntityTokN&lt;EntityTokV.Len(); EntityTokN++){
26        PXmlTok EntityTok=EntityTokV[EntityTokN];
27        if (!EntityTok-&gt;IsTag(&quot;entity&quot;)){continue;}
28        TStr CanonicalNm=EntityTok-&gt;GetArgVal(&quot;canonical&quot;, &quot;&quot;);
29        TStr TextStr=EntityTok-&gt;GetArgVal(&quot;text&quot;, &quot;&quot;);
30        TStr TypeNm=EntityTok-&gt;GetArgVal(&quot;type&quot;, &quot;&quot;);
31        TStr EntNm=CanonicalNm.Empty() ? TextStr : CanonicalNm;
32        EntNmToFqH.AddDat(EntNm)++;
33      }
34      TIntStrPrV FqEntNmPrV; EntNmToFqH.GetDatKeyPrV(FqEntNmPrV); FqEntNmPrV.Sort(false);
35      TChA HeadlineChA=BodyStr.GetSubStr(0, 250);
36      while ((HeadlineChA.Len()&gt;0)&amp;&amp;(HeadlineChA.LastCh()!=&#x27; &#x27;)){
37        HeadlineChA.Trunc(HeadlineChA.Len()-1);}
38      HeadlineChA+=&quot;...&quot;;
39      TTntBinDoc Doc(DocNm, Tm, SubjStr, HeadlineChA, FqEntNmPrV);
40      Doc.Save(SOut);
41      if (PrevTm!=Tm){
42        if (PrevTm!=0){printf(&quot;\n&quot;);}
43        PrevTm=Tm; DateDocs=0;
44      }
45      Docs++; DateDocs++;
46      printf(&quot;  %s [Day:%d / All:%d]\r&quot;, DateStr.CStr(), DateDocs, Docs);
47    }
48    printf(&quot;\nDone.\n&quot;);
49  }
50  void TTntBinDoc::LoadBinDocV(const TStr&amp; InBinFNm){
51    printf(&quot;Processing Tnt News-Binary file &#x27;%s&#x27;...\n&quot;, InBinFNm.CStr());
52    TFIn SIn(InBinFNm); int Docs=0;
53    while (!SIn.Eof()){
54      TTntBinDoc Doc(SIn);
55      Docs++; printf(&quot;%d\r&quot;, Docs);
56    }
57    printf(&quot;\nDone.\n&quot;);
58  }
59  void TTntEnt::GetDocIdV(const TTntBs* TntBs,
60   const uint64&amp; MnTm, const uint64&amp; MxTm, TIntV&amp; DocIdV) const {
61    DocIdV.Gen(GetDocIds(), 0);
62    for (int DocN=0; DocN&lt;GetDocIds(); DocN++){
63      int DocId=GetDocId(DocN);
64      PTntDoc Doc=TntBs-&gt;GetDoc(DocId);
65      uint64 DocTm=Doc-&gt;GetTm();
66      if (((MnTm==0)||(MnTm&lt;=DocTm))&amp;&amp;((MxTm==0)||(DocTm&lt;MxTm))){
67        DocIdV.Add(DocId);
68      }
69    }
70  }
71  void TTntEnt::GetDocsPerDateV(
72   const TTntBs* TntBs, TStrIntPrV&amp; DateStrDocsPrV, int&amp; Docs) const {
73    TStrIntH DateStrToDocsH; Docs=0;
74    for (int DocN=0; DocN&lt;GetDocIds(); DocN++){
75      int DocId=GetDocId(DocN);
76      PTntDoc Doc=TntBs-&gt;GetDoc(DocId);
77      uint64 DocTm=Doc-&gt;GetTm();
78      TStr DocDateStr=TTm::GetTmFromMSecs(DocTm).GetWebLogDateStr();
79      DateStrToDocsH.AddDat(DocDateStr)++; Docs++;
80    }
81    DateStrToDocsH.GetKeyDatPrV(DateStrDocsPrV);
82    DateStrDocsPrV.Sort();
83  }
84  void TTntEnt::GetDocCentroid(const TTntBs* TntBs,
85   const int&amp; TopWords, const double&amp; TopWordsWgtSumPrc,
86   TStrFltPrV&amp; WordStrWgtPrV) const {
87    PSwSet SwSet=TSwSet::GetSwSet(swstEn523);
88    PStemmer Stemmer=TStemmer::GetStemmer(stmtPorter);
89    PBowDocBs BowDocBs=TBowDocBs::New(SwSet, Stemmer, NULL);
90    for (int DocN=0; DocN&lt;GetDocIds(); DocN++){
91      int DocId=GetDocId(DocN);
92      PTntDoc Doc=TntBs-&gt;GetDoc(DocId);
93      TStr DocStr=Doc-&gt;GetContStr();
94      BowDocBs-&gt;AddHtmlDoc(TInt::GetStr(DocId), TStrV(), DocStr);
95    }
96    TBowWordWgtType WordWgtType=bwwtNrmTFIDF; 
97    PBowDocWgtBs BowDocWgtBs=TBowDocWgtBs::New(BowDocBs, WordWgtType, 0, 0);
98    PBowSim BowSim=TBowSim::New(bstCos); 
99    TIntV AllDIdV; BowDocBs-&gt;GetAllDIdV(AllDIdV);
100    PBowSpV ConceptSpV=TBowClust::GetConceptSpV(BowDocWgtBs, BowSim, AllDIdV);
101    ConceptSpV-&gt;GetWordStrWgtPrV(BowDocBs, TopWords, TopWordsWgtSumPrc, WordStrWgtPrV);
102  }
103  void TTntEnt::GetDocCentroid(const TTntBs* TntBs,
104   const PBowDocBs&amp; BowDocBs, const PBowDocWgtBs&amp; BowDocWgtBs,
105   const uint64&amp; MnTm, const TStr&amp; QKwStr, 
106   const int&amp; TopWords, const double&amp; TopWordsWgtSumPrc,
107   int&amp; Docs, TStrFltPrV&amp; WordStrWgtPrV) const {
108    TIntV DocIdV; GetDocIdV(TntBs, MnTm, 0, DocIdV);
109    if (DocIdV.Len()&gt;0){
110    }
111    TIntV BowDIdV(DocIdV.Len(), 0);
112    for (int DocN=0; DocN&lt;DocIdV.Len(); DocN++){
113      int DocId=DocIdV[DocN];
114      TStr BowDocNm=TInt::GetStr(DocId);
115      int BowDId=BowDocBs-&gt;GetDId(BowDocNm);
116      if (QKwStr.Empty()){
117        BowDIdV.Add(BowDId);
118      } else {
119        if (BowDocBs-&gt;IsDocWordStr(BowDId, QKwStr)){
120          BowDIdV.Add(BowDId);
121        }
122      }
123    }
124    PBowSim BowSim=TBowSim::New(bstCos); 
125    PBowSpV ConceptSpV=TBowClust::GetConceptSpV(BowDocWgtBs, BowSim, BowDIdV);
126    Docs=DocIdV.Len();
127    ConceptSpV-&gt;GetWordStrWgtPrV(BowDocBs, TopWords, TopWordsWgtSumPrc, WordStrWgtPrV);
128  }
129  void TTntEnt::GetEntClustV(const TTntBs* TntBs,
130   const uint64&amp; MnTm, const int&amp; MnDocs, const int&amp; MxDocs, const int&amp; Clusts,
131   TVec&lt;TStrFltPrV&gt;&amp; EntNmWgtPrVV) const {
132    EntNmWgtPrVV.Clr();
133    PBowDocBs BowDocBs=TBowDocBs::New();
134    TIntV DocIdV; GetDocIdV(TntBs, MnTm, 0, DocIdV);
135    DocIdV.Reverse();
136    TRnd Rnd(1);
137    DocIdV.Shuffle(Rnd);
138    DocIdV.Trunc(MxDocs);
139    if (DocIdV.Len()&lt;MnDocs){return;}
140    for (int DocN=0; DocN&lt;DocIdV.Len(); DocN++){
141      int DocId=DocIdV[DocN];
142      PTntDoc Doc=TntBs-&gt;GetDoc(DocId);
143      TIntFltPrV WIdWgtPrV;
144      for (int EntN=0; EntN&lt;Doc-&gt;GetEnts(); EntN++){
145        int EntId; int EntFq; Doc-&gt;GetEntNmFq(EntN, EntId, EntFq);
146        TStr EntNm=TntBs-&gt;GetEntNm(EntId);
147        int EntWId=BowDocBs-&gt;AddWordStr(EntNm);
148        WIdWgtPrV.Add(TIntFltPr(EntWId, EntFq));
149      }
150      int DId=BowDocBs-&gt;AddDoc(TInt::GetStr(DocId), TStrV(), WIdWgtPrV);
151      TStr DocDescStr=Doc-&gt;GetSubjStr();
152      BowDocBs-&gt;PutDocDescStr(DId, DocDescStr);
153    }
154    PBowSim BowSim=TBowSim::New(bstCos); 
155    TBowWordWgtType WordWgtType=bwwtNrmTFIDF; 
156    PBowDocPart BowDocPart=TBowClust::GetKMeansPart(
157     TNotify::StdNotify, 
158     BowDocBs, 
159     BowSim, 
160     Rnd, 
161     Clusts, 
162     1, 
163     1, 
164     1, 
165     WordWgtType, 
166     0, 
167     0); 
168    EntNmWgtPrVV.Clr();
169    for (int ClustN=0; ClustN&lt;BowDocPart-&gt;GetClusts(); ClustN++){
170      PBowDocPartClust Clust=BowDocPart-&gt;GetClust(ClustN);
171      TStrFltPrV WordStrWgtPrV;
172      Clust-&gt;GetTopWordStrWgtPrV(BowDocBs, 25, 0.5, WordStrWgtPrV);
173      EntNmWgtPrVV.Add(WordStrWgtPrV);
174    }
175  }
176  void TTntEnt::GetSorted_LinkWgtDstEntIdPrV(
177   const uint64&amp; MnTm, const double&amp; TopWgtSumPrc, TIntPrV&amp; LinkWgtDstEntIdPrV) const {
178    double AllLinkWgtSum=0;
179    TIntIntH DstEntIdLinkWgtH;
180    int LinkEnts=GetLinkEnts();
181    for (int LinkEntN=0; LinkEntN&lt;LinkEnts; LinkEntN++){
182      int DstEntId=GetLinkEntId(LinkEntN);
183      int EntLinks=GetEntLinks(LinkEntN);
184      int EntLinkWgtSum=0;
185      for (int EntLinkN=0; EntLinkN&lt;EntLinks; EntLinkN++){
186        const TTntEntLinkCtx&amp; EntLinkCtx=GetEntLinkCtx(LinkEntN, EntLinkN);
187        if (EntLinkCtx.Tm&gt;=MnTm){
188          EntLinkWgtSum+=EntLinkCtx.LinkWgt;}
189      }
190      if (EntLinkWgtSum&gt;0){
191        DstEntIdLinkWgtH.AddDat(DstEntId, EntLinkWgtSum);}
192      AllLinkWgtSum+=EntLinkWgtSum;
193    }
194    LinkWgtDstEntIdPrV.Clr(); DstEntIdLinkWgtH.GetDatKeyPrV(LinkWgtDstEntIdPrV);
195    LinkWgtDstEntIdPrV.Sort(false);
196    if ((TopWgtSumPrc&gt;0.0)&amp;&amp;(LinkWgtDstEntIdPrV.Len()&gt;0)){
197      int TopLinkWgt=LinkWgtDstEntIdPrV[0].Val1;
198      if (TopLinkWgt&gt;(3*AllLinkWgtSum)/LinkWgtDstEntIdPrV.Len()){
199        double CutWgtSum=AllLinkWgtSum*(1-TopWgtSumPrc);
200        int LastValN=LinkWgtDstEntIdPrV.Len()-1;
201        while ((LastValN&gt;0)&amp;&amp;(CutWgtSum&gt;0)){
202          CutWgtSum-=LinkWgtDstEntIdPrV[LastValN].Val1;
203          LastValN--;
204        }
205        LinkWgtDstEntIdPrV.Trunc(LastValN+1);
206      }
207    }
208  }
209  void TTntBs::GetSorted_DocsEntIdPrV(TIntPrV&amp; DocsEntIdPrV){
210    TIntIntH EntIdToDocsH;
211    for (int EntId=0; EntId&lt;GetEnts(); EntId++){
212      int Docs=GetEnt(EntId)-&gt;GetDocIds();
213      EntIdToDocsH.AddDat(EntId, Docs);
214    }
215    DocsEntIdPrV.Clr(); EntIdToDocsH.GetDatKeyPrV(DocsEntIdPrV);
216    DocsEntIdPrV.Sort(false);
217  }
218  int TTntBs::AddDoc(
219   const TStr&amp; DocNm, const uint64&amp; Tm,
220   const TStr&amp; SubjStr, const TStr&amp; ContStr,
221   const TIntStrPrV FqEntNmPrV){
222    TIntPrV EntIdFqPrV(FqEntNmPrV.Len(), 0);
223    for (int EntN=0; EntN&lt;FqEntNmPrV.Len(); EntN++){
224      TStr EntNm=FqEntNmPrV[EntN].Val2;
225      int EntFq=FqEntNmPrV[EntN].Val1;
226      if (EntFq&gt;=GetMnEntFqPerDoc()){
227        int EntId=AddEnt(EntNm);
228        EntIdFqPrV.Add(TIntPr(EntId, EntFq));
229      }
230    }
231    if (EntIdFqPrV.Len()&lt;GetMnEntsPerDoc()){
232      return -1;}
233    PTntDoc Doc=
<span onclick='openModal()' class='match'>234     TTntDoc::New(DocNm, Tm, SubjStr, ContStr, EntIdFqPrV);
235    int DocId=GetNewDocId();
</span>236    IdToDocH.AddDat(DocId, Doc);
237    for (int EntN=0; EntN&lt;EntIdFqPrV.Len(); EntN++){
238      int EntId=EntIdFqPrV[EntN].Val1;
239      GetEnt(EntId)-&gt;PushDocId(DocId);
240    }
241    int EntLinkWgtSum=0;
242    for (int EntN1=0; EntN1&lt;EntIdFqPrV.Len(); EntN1++){
243      int EntId1=EntIdFqPrV[EntN1].Val1;
244      PTntEnt Ent1=GetEnt(EntId1);
245      int EntWgt1=EntIdFqPrV[EntN1].Val2;
246      for (int EntN2=0; EntN2&lt;EntIdFqPrV.Len(); EntN2++){
247        if (EntN1==EntN2){continue;}
248        int EntId2=EntIdFqPrV[EntN2].Val1;
249        int EntWgt2=EntIdFqPrV[EntN2].Val2;
250        int EntLinkWgt=EntWgt1*EntWgt2;
251        EntLinkWgtSum+=EntLinkWgt;
252        TTntEntLinkCtx LinkCtx(EntLinkWgt, DocId, Tm);
253        Ent1-&gt;AddLink(EntId2, LinkCtx);
254      }
255    }
256    return DocId;
257  }
258  void TTntBs::GetMnMxDocTm(uint64&amp; MnDocTm, uint64&amp; MxDocTm) const {
259    MnDocTm=TUInt64::Mx; MxDocTm=TUInt64::Mn;
260    TTntIdDocPrV IdDocPrV; GetIdDocPrV(IdDocPrV); int Docs=IdDocPrV.Len();
261    for (int DocN=0; DocN&lt;Docs; DocN++){
262      uint64 Tm=IdDocPrV[DocN].Val2-&gt;GetTm();
263      if (Tm&lt;MnDocTm){MnDocTm=Tm;}
264      if (Tm&gt;MxDocTm){MxDocTm=Tm;}
265    }
266  }
267  PBowDocBs TTntBs::GetBowDocBs(
268   const int&amp; MxNGramLen, const int&amp; MnNGramFq) const {
269    PSwSet SwSet=TSwSet::GetSwSet(swstEn523);
270    PStemmer Stemmer=TStemmer::GetStemmer(stmtPorter);
271    PNGramBs NGramBs;
272    if (!((MxNGramLen==1)&amp;&amp;(MnNGramFq==1))){
273      TStrV HtmlStrV;
274      TTntIdDocPrV IdDocPrV; GetIdDocPrV(IdDocPrV);
275      for (int DocN=0; DocN&lt;IdDocPrV.Len(); DocN++){
276        PTntDoc Doc=IdDocPrV[DocN].Val2;
277        TStr DocStr=Doc-&gt;GetContStr();
278        HtmlStrV.Add(DocStr);
279      }
280      NGramBs=TNGramBs::GetNGramBsFromHtmlStrV(
281       HtmlStrV, MxNGramLen, MnNGramFq, SwSet, Stemmer);
282    }
283    PBowDocBs BowDocBs=TBowDocBs::New(SwSet, Stemmer, NGramBs);
284    TTntIdDocPrV IdDocPrV; GetIdDocPrV(IdDocPrV);
285    for (int DocN=0; DocN&lt;IdDocPrV.Len(); DocN++){
286      int DocId=IdDocPrV[DocN].Val1;
287      PTntDoc Doc=IdDocPrV[DocN].Val2;
288      TStr DocStr=Doc-&gt;GetContStr();
289      BowDocBs-&gt;AddHtmlDoc(TInt::GetStr(DocId), TStrV(), DocStr);
290    }
291    return BowDocBs;
292  }
293  PBowDocWgtBs TTntBs::GetBowDocWgtBs(const PBowDocBs&amp; BowDocBs) const {
294    TBowWordWgtType WordWgtType=bwwtNrmTFIDF;
295    PBowDocWgtBs BowDocWgtBs=TBowDocWgtBs::New(BowDocBs, WordWgtType, 0, 0);
296    return BowDocWgtBs;
297  }
298  void TTntBs::GetWordStrWgtPrVDiff(
299   const TStrFltPrV&amp; OldWordStrWgtPrV, const TStrFltPrV&amp; NewWordStrWgtPrV,
300   TStrFltPrV&amp; NegDiffWordStrWgtPrV, TStrFltPrV&amp; PosDiffWordStrWgtPrV){
301    TStrFltH WordStrToWgtH;
302    for (int WordN=0; WordN&lt;NewWordStrWgtPrV.Len(); WordN++){
303      TStr WStr=NewWordStrWgtPrV[WordN].Val1;
304      double WWgt=NewWordStrWgtPrV[WordN].Val2;
305      WordStrToWgtH.AddDat(WStr, WWgt);
306    }
307    for (int WordN=0; WordN&lt;OldWordStrWgtPrV.Len(); WordN++){
308      TStr WStr=OldWordStrWgtPrV[WordN].Val1;
309      double WWgt=OldWordStrWgtPrV[WordN].Val2;
310      double CurWWgt=WordStrToWgtH.AddDat(WStr);
311      WordStrToWgtH.AddDat(WStr, CurWWgt-WWgt);
312    }
313    TFltStrPrV DiffWordWgtStrPrV; WordStrToWgtH.GetDatKeyPrV(DiffWordWgtStrPrV);
314    DiffWordWgtStrPrV.Sort(true);
315    NegDiffWordStrWgtPrV.Gen(DiffWordWgtStrPrV.Len(), 0);
316    for (int WordN=0; WordN&lt;DiffWordWgtStrPrV.Len(); WordN++){
317      TStr WStr=DiffWordWgtStrPrV[WordN].Val2;
318      double WWgt=DiffWordWgtStrPrV[WordN].Val1;
319      if (WWgt!=0){NegDiffWordStrWgtPrV.Add(TStrFltPr(WStr, WWgt));}
320    }
321    DiffWordWgtStrPrV.Sort(false);
322    PosDiffWordStrWgtPrV.Gen(DiffWordWgtStrPrV.Len(), 0);
323    for (int WordN=0; WordN&lt;DiffWordWgtStrPrV.Len(); WordN++){
324      TStr WStr=DiffWordWgtStrPrV[WordN].Val2;
325      double WWgt=DiffWordWgtStrPrV[WordN].Val1;
326      if (WWgt!=0){PosDiffWordStrWgtPrV.Add(TStrFltPr(WStr, WWgt));}
327    }
328  }
329  void TTntBs::GetWordStrWgtPrV(const TStrFltPrV&amp; WordStrWgtPrV, 
330   TChA&amp; WordStrWgtPrVChA, TChA&amp; WordStrWgtPrVXmlChA){
331    WordStrWgtPrVChA.Clr(); WordStrWgtPrVXmlChA.Clr();
332    for (int WordN=0; WordN&lt;WordStrWgtPrV.Len(); WordN++){
333      TStr WStr=WordStrWgtPrV[WordN].Val1;
334      TStr XmlWStr=TXmlLx::GetXmlStrFromPlainStr(WStr);
335      double WWgt=WordStrWgtPrV[WordN].Val2;
336      if (WordN&gt;0){WordStrWgtPrVChA+=&#x27; &#x27;;}
337      WordStrWgtPrVChA+=TStr::Fmt(&quot;[&#x27;%s&#x27;:%.3f]&quot;, WStr.CStr(), WWgt);
338      WordStrWgtPrVXmlChA+=TStr::Fmt(&quot;&lt;Kw str=\&quot;%s\&quot; wgt=\&quot;%.3f\&quot;/&gt;&quot;, XmlWStr.CStr(), WWgt);
339    }
340  }
341  void TTntBs::GetLinkWgtDstEntIdPrVDiff(
342   const TIntPrV&amp; OldLinkWgtDstEntIdPrV, const TIntPrV&amp; NewLinkWgtDstEntIdPrV,
343   TIntPrV&amp; NegDiffLinkWgtDstEntIdPrV, TIntPrV&amp; PosDiffLinkWgtDstEntIdPrV){
344    TIntIntH DstEntIdToLinkWgtH;
345    for (int WordN=0; WordN&lt;NewLinkWgtDstEntIdPrV.Len(); WordN++){
346      int LinkWgt=NewLinkWgtDstEntIdPrV[WordN].Val1;
347      int DstEntId=NewLinkWgtDstEntIdPrV[WordN].Val2;
348      DstEntIdToLinkWgtH.AddDat(DstEntId, LinkWgt);
349    }
350    for (int WordN=0; WordN&lt;OldLinkWgtDstEntIdPrV.Len(); WordN++){
351      int LinkWgt=OldLinkWgtDstEntIdPrV[WordN].Val1;
352      int DstEntId=OldLinkWgtDstEntIdPrV[WordN].Val2;
353      int CurLinkWgt=DstEntIdToLinkWgtH.AddDat(DstEntId);
354      DstEntIdToLinkWgtH.AddDat(DstEntId, CurLinkWgt-LinkWgt);
355    }
356    TIntPrV _DiffLinkWgtDstEntIdPrV;
357    DstEntIdToLinkWgtH.GetDatKeyPrV(_DiffLinkWgtDstEntIdPrV);
358    TIntPrV DiffLinkWgtDstEntIdPrV(_DiffLinkWgtDstEntIdPrV.Len(), 0);
359    for (int EntN=0; EntN&lt;_DiffLinkWgtDstEntIdPrV.Len(); EntN++){
360      int LinkWgt=_DiffLinkWgtDstEntIdPrV[EntN].Val1;
361      if (LinkWgt!=0){
362        DiffLinkWgtDstEntIdPrV.Add(_DiffLinkWgtDstEntIdPrV[EntN]);}
363    }
364    DiffLinkWgtDstEntIdPrV.Sort(true);
365    NegDiffLinkWgtDstEntIdPrV=DiffLinkWgtDstEntIdPrV;
366    DiffLinkWgtDstEntIdPrV.Sort(false);
367    PosDiffLinkWgtDstEntIdPrV=DiffLinkWgtDstEntIdPrV;
368  }
369  void TTntBs::GetLinkWgtDstEntNmPrV(const TIntPrV&amp; LinkWgtDstEntIdPrV, 
370   TStrIntPrV&amp; LinkWgtDstEntNmPrV, TChA&amp; LinkWgtDstEntIdPrVChA, TChA&amp; LinkWgtDstEntIdPrVXmlChA){
371    LinkWgtDstEntNmPrV.Clr(); LinkWgtDstEntIdPrVChA.Clr(); LinkWgtDstEntIdPrVXmlChA.Clr();
372    for (int DstEntN=0; DstEntN&lt;LinkWgtDstEntIdPrV.Len(); DstEntN++){
373      int DstEntId=LinkWgtDstEntIdPrV[DstEntN].Val2;
374      TStr DstEntNm=GetEntNm(DstEntId);
375      TStr XmlDstEntNm=TXmlLx::GetXmlStrFromPlainStr(DstEntNm);
376      int LinkWgt=LinkWgtDstEntIdPrV[DstEntN].Val1;
377      LinkWgtDstEntNmPrV.Add(TStrIntPr(DstEntNm, LinkWgt));
378      if (DstEntN&gt;0){LinkWgtDstEntIdPrVChA+=&#x27; &#x27;;}
379      LinkWgtDstEntIdPrVChA+=TStr::Fmt(&quot;[&#x27;%s&#x27;:%d]&quot;, DstEntNm.CStr(), LinkWgt);
380      LinkWgtDstEntIdPrVXmlChA+=TStr::Fmt(&quot;&lt;Ent name=\&quot;%s\&quot; wgt=\&quot;%d\&quot;/&gt;&quot;, XmlDstEntNm.CStr(), LinkWgt);
381    }
382  }
383  void TTntBs::GetSchTmV(const TStr&amp; SchNm, const uint64&amp; PivotTm, TUInt64V&amp; SchTmMSecsV){
384    SchTmMSecsV.Clr();
385    if (SchNm==&quot;dayexp&quot;){
386      SchTmMSecsV.Add(PivotTm-0*TTmInfo::GetDayMSecs());
387      SchTmMSecsV.Add(PivotTm-1*TTmInfo::GetDayMSecs());
388      SchTmMSecsV.Add(PivotTm-2*TTmInfo::GetDayMSecs());
389      SchTmMSecsV.Add(PivotTm-4*TTmInfo::GetDayMSecs());
390      SchTmMSecsV.Add(PivotTm-8*TTmInfo::GetDayMSecs());
391      SchTmMSecsV.Add(PivotTm-16*TTmInfo::GetDayMSecs());
392      SchTmMSecsV.Add(PivotTm-32*TTmInfo::GetDayMSecs());
393      SchTmMSecsV.Add(PivotTm-64*TTmInfo::GetDayMSecs());
394    } else 
395    if (SchNm==&quot;day&quot;){
396      SchTmMSecsV.Add(PivotTm-0*TTmInfo::GetDayMSecs());
397      SchTmMSecsV.Add(PivotTm-1*TTmInfo::GetDayMSecs());
398      SchTmMSecsV.Add(PivotTm-2*TTmInfo::GetDayMSecs());
399      SchTmMSecsV.Add(PivotTm-3*TTmInfo::GetDayMSecs());
400      SchTmMSecsV.Add(PivotTm-4*TTmInfo::GetDayMSecs());
401      SchTmMSecsV.Add(PivotTm-5*TTmInfo::GetDayMSecs());
402      SchTmMSecsV.Add(PivotTm-6*TTmInfo::GetDayMSecs());
403      SchTmMSecsV.Add(PivotTm-7*TTmInfo::GetDayMSecs());
404    } else 
405    if (SchNm==&quot;week&quot;){
406      SchTmMSecsV.Add(PivotTm-0*TTmInfo::GetDayMSecs());
407      SchTmMSecsV.Add(PivotTm-7*TTmInfo::GetDayMSecs());
408      SchTmMSecsV.Add(PivotTm-14*TTmInfo::GetDayMSecs());
409      SchTmMSecsV.Add(PivotTm-21*TTmInfo::GetDayMSecs());
410      SchTmMSecsV.Add(PivotTm-28*TTmInfo::GetDayMSecs());
411      SchTmMSecsV.Add(PivotTm-35*TTmInfo::GetDayMSecs());
412      SchTmMSecsV.Add(PivotTm-42*TTmInfo::GetDayMSecs());
413      SchTmMSecsV.Add(PivotTm-49*TTmInfo::GetDayMSecs());
414    } else 
415    if (SchNm==&quot;month&quot;){
416      SchTmMSecsV.Add(PivotTm-0*TTmInfo::GetDayMSecs());
417      SchTmMSecsV.Add(PivotTm-30*TTmInfo::GetDayMSecs());
418      SchTmMSecsV.Add(PivotTm-60*TTmInfo::GetDayMSecs());
419      SchTmMSecsV.Add(PivotTm-90*TTmInfo::GetDayMSecs());
420      SchTmMSecsV.Add(PivotTm-120*TTmInfo::GetDayMSecs());
421      SchTmMSecsV.Add(PivotTm-150*TTmInfo::GetDayMSecs());
422      SchTmMSecsV.Add(PivotTm-180*TTmInfo::GetDayMSecs());
423      SchTmMSecsV.Add(PivotTm-210*TTmInfo::GetDayMSecs());
424    } else 
425  	  if (SchNm==&quot;year&quot;){
426      SchTmMSecsV.Add(PivotTm-0*TTmInfo::GetDayMSecs());
427      SchTmMSecsV.Add(PivotTm-364*TTmInfo::GetDayMSecs());
428      SchTmMSecsV.Add(PivotTm-728*TTmInfo::GetDayMSecs());
429      SchTmMSecsV.Add(PivotTm-1092*TTmInfo::GetDayMSecs());
430      SchTmMSecsV.Add(PivotTm-1457*TTmInfo::GetDayMSecs());
431      SchTmMSecsV.Add(PivotTm-1821*TTmInfo::GetDayMSecs());
432      SchTmMSecsV.Add(PivotTm-2185*TTmInfo::GetDayMSecs());
433      SchTmMSecsV.Add(PivotTm-2550*TTmInfo::GetDayMSecs());
434    } else {
435      FailR(&quot;Invalid Time Schedule&quot;);
436    }
437  }
438  void TTntBs::Search(
439   const PBowDocBs&amp; TntBsBowDocBs, const PBowDocWgtBs&amp; TntBsBowDocWgtBs, 
440   const TStr&amp; QTmStr, const TStr&amp; QSchNm, 
441   const TStr&amp; QWcEntNm, const TStr&amp; QKwStr,
442   PTntRSet&amp; TntRSet, const TStr&amp; OutXmlFNm, const TStr&amp; OutTxtFNm){
443    TTm QTm=TTm::GetTmFromWebLogDateTimeStr(QTmStr);
444    if (!QTm.IsDef()){
445      uint64 MnDocTm; uint64 MxDocTm; GetMnMxDocTm(MnDocTm, MxDocTm);
446      QTm=TTm::GetTmFromMSecs(MxDocTm);
447    }
448    TTm RawPivotTm=QTm;
449    TStr RawPivotTmStr=RawPivotTm.GetWebLogDateTimeStr();
450    TTm PivotTm=TTm::GetTmFromWebLogDateTimeStr(RawPivotTm.GetWebLogDateStr());
451    TStr PivotTmStr=PivotTm.GetWebLogDateTimeStr();
452    uint64 PivotTmMSecs=TTm::GetMSecsFromTm(PivotTm);
453    TUInt64V SchTmMSecsV; GetSchTmV(QSchNm, PivotTmMSecs, SchTmMSecsV);
454    TStr NrQKwStr=QKwStr.GetUc();
455    TntRSet=TTntRSet::New();
456    TntRSet-&gt;PutQStrs(QTmStr, QSchNm, QWcEntNm, QKwStr);
457    TntRSet-&gt;PutPivotTm(RawPivotTm, PivotTm);
458    TFOut XmlFOut(OutXmlFNm); FILE* fXmlOut=XmlFOut.GetFileId();
459    fprintf(fXmlOut, &quot;&lt;TntProfile&gt;\n&quot;);
460    TFOut TxtFOut(OutTxtFNm); FILE* fTxtOut=TxtFOut.GetFileId();
461    TIntPrV DocsEntIdPrV; GetSorted_DocsEntIdPrV(DocsEntIdPrV);
462    for (int EntN=0; EntN&lt;DocsEntIdPrV.Len(); EntN++){
463      int EntId=DocsEntIdPrV[EntN].Val2;
464      TStr EntNm=GetEntNm(EntId);
465      if (!QWcEntNm.Empty()&amp;&amp;(!EntNm.IsWcMatch(QWcEntNm))){continue;}
466      PTntEntRSet EntRSet=TTntEntRSet::New();
467      EntRSet-&gt;PutEntNm(EntNm);
468      TntRSet-&gt;AddEntRSet(EntRSet);
469      int EntDocs=DocsEntIdPrV[EntN].Val1;
470      PTntEnt Ent=GetEnt(EntId);
471      int LinkEnts=Ent-&gt;GetLinkEnts();
472      fprintf(fXmlOut, &quot;&lt;Entity name=\&quot;%s\&quot; docs=\&quot;%d\&quot; ents=\&quot;%d\&quot;&gt;\n&quot;, EntNm.CStr(), EntDocs, LinkEnts);
473      fprintf(fTxtOut, &quot;&#x27;%s&#x27; [%d docs] [%d ents]\n&quot;, EntNm.CStr(), EntDocs, LinkEnts);
474      {TStrIntPrV DateStrDocsPrV; int _EntDocs;
475      Ent-&gt;GetDocsPerDateV(this, DateStrDocsPrV, _EntDocs);
476      fprintf(fXmlOut, &quot;&lt;DatesDocs docs=\&quot;%d\&quot;&gt;\n&quot;, _EntDocs);
477      fprintf(fTxtOut, &quot;   Docs per Date (%d docs):&quot;, _EntDocs);
478      for (int DateN=0; DateN&lt;DateStrDocsPrV.Len(); DateN++){
479        TStr DateStr=DateStrDocsPrV[DateN].Val1;
480        int Docs=DateStrDocsPrV[DateN].Val2;
481        fprintf(fXmlOut, &quot;  &lt;DateDoc date=\&quot;%s\&quot; docs=\&quot;%d\&quot;/&gt;\n&quot;, DateStr.CStr(), Docs);
482        fprintf(fTxtOut, &quot; [%s:%d]&quot;, DateStr.CStr(), Docs);
483      }
484      fprintf(fXmlOut, &quot;&lt;/DatesDocs&gt;\n&quot;);
485      fprintf(fTxtOut, &quot;\n&quot;);}
486      fprintf(fXmlOut, &quot;&lt;TimeSlices start-time=\&quot;%s\&quot;&gt;\n&quot;, RawPivotTmStr.CStr());
487      fprintf(fTxtOut, &quot;   [Now: %s]\n&quot;, RawPivotTmStr.CStr());
488      TIntPrV PrevLinkWgtDstEntIdPrV;
489      TStrFltPrV PrevWordStrWgtPrV;
490      for (int SchTmN=0; SchTmN&lt;SchTmMSecsV.Len(); SchTmN++){
491        uint64 StartTmMSecs=SchTmMSecsV[SchTmN];
492        TStr StartTmStr=TTm::GetTmFromMSecs(StartTmMSecs).GetWebLogDateTimeStr();
493        double PastDays=-1*((PivotTmMSecs-StartTmMSecs)/double(TTmInfo::GetDayMSecs()));
494        TStr EndTmStr;
495        if (SchTmN==0){EndTmStr=RawPivotTmStr;} 
496        else {EndTmStr=TTm::GetTmFromMSecs(SchTmMSecsV[SchTmN-1]).GetWebLogDateTimeStr();}
497        uint64 EndTmMSecs=TTm::GetMSecsFromTm(TTm::GetTmFromWebLogDateTimeStr(EndTmStr));
498        PTntEntRSet_TmSlice TmSlice=TTntEntRSet_TmSlice::New();
499        TmSlice-&gt;PutStartEndTm(StartTmMSecs, EndTmMSecs);
500        EntRSet-&gt;AddTmSlice(TmSlice);
501        fprintf(fXmlOut, &quot;&lt;TimeSlice start-time=\&quot;%s\&quot; end-time=\&quot;%s\&quot; past-days=\&quot;%.1f\&quot;&gt;\n&quot;, 
502         StartTmStr.CStr(), EndTmStr.CStr(), PastDays);
503        TIntPrV LinkWgtDstEntIdPrV;
504        Ent-&gt;GetSorted_LinkWgtDstEntIdPrV(StartTmMSecs, 0.9, LinkWgtDstEntIdPrV);
505        fprintf(fXmlOut, &quot;&lt;SocialProfile&gt;\n&quot;);
506        int TopLinkEnts=LinkWgtDstEntIdPrV.Len();
507        TStrIntPrV LinkWgtDstEntNmPrV; TChA LinkWgtDstEntIdPrVChA; TChA LinkWgtDstEntIdPrVXmlChA;
508        GetLinkWgtDstEntNmPrV(LinkWgtDstEntIdPrV, 
509         LinkWgtDstEntNmPrV, LinkWgtDstEntIdPrVChA, LinkWgtDstEntIdPrVXmlChA);
510        TmSlice-&gt;PutLinkWgtDstEntNmPrV(LinkWgtDstEntNmPrV);
511        fprintf(fXmlOut, &quot;  &lt;Entities ents=\&quot;%d\&quot;&gt;%s&lt;/Entities&gt;\n&quot;, TopLinkEnts, LinkWgtDstEntIdPrVXmlChA.CStr());
512        fprintf(fTxtOut, &quot;      Entities (%d ents): %s\n&quot;, TopLinkEnts, LinkWgtDstEntIdPrVChA.CStr());
513        if (SchTmN&gt;0){
514          TIntPrV NegDiffLinkWgtDstEntIdPrV; TIntPrV PosDiffLinkWgtDstEntIdPrV;
515          GetLinkWgtDstEntIdPrVDiff(LinkWgtDstEntIdPrV, PrevLinkWgtDstEntIdPrV,
516           NegDiffLinkWgtDstEntIdPrV, PosDiffLinkWgtDstEntIdPrV);
517          TStrIntPrV PosDiffLinkWgtDstEntNmPrV; TChA PosDiffLinkWgtDstEntIdPrVChA; TChA PosDiffLinkWgtDstEntIdPrVXmlChA;
518          GetLinkWgtDstEntNmPrV(PosDiffLinkWgtDstEntIdPrV, 
519           PosDiffLinkWgtDstEntNmPrV, PosDiffLinkWgtDstEntIdPrVChA, PosDiffLinkWgtDstEntIdPrVXmlChA);
520          TmSlice-&gt;PutPosDiffLinkWgtDstEntNmPrV(PosDiffLinkWgtDstEntNmPrV);
521          fprintf(fXmlOut, &quot;  &lt;RisingEntities&gt;%s&lt;/RisingEntities&gt;\n&quot;, PosDiffLinkWgtDstEntIdPrVXmlChA.CStr());
522          fprintf(fTxtOut, &quot;         Pos-Diff: %s\n&quot;, PosDiffLinkWgtDstEntIdPrVChA.CStr());
523          TStrIntPrV NegDiffLinkWgtDstEntNmPrV; TChA NegDiffLinkWgtDstEntIdPrVChA; TChA NegDiffLinkWgtDstEntIdPrVXmlChA;
524          GetLinkWgtDstEntNmPrV(NegDiffLinkWgtDstEntIdPrV, 
525           NegDiffLinkWgtDstEntNmPrV, NegDiffLinkWgtDstEntIdPrVChA, NegDiffLinkWgtDstEntIdPrVXmlChA);
526          TmSlice-&gt;PutNegDiffLinkWgtDstEntNmPrV(NegDiffLinkWgtDstEntNmPrV);
527          fprintf(fXmlOut, &quot;  &lt;FallingEntities&gt;%s&lt;/FallingEntities&gt;\n&quot;, NegDiffLinkWgtDstEntIdPrVXmlChA.CStr());
528          fprintf(fTxtOut, &quot;         Neg-Diff: %s\n&quot;, NegDiffLinkWgtDstEntIdPrVChA.CStr());
529        }
530        PrevLinkWgtDstEntIdPrV=LinkWgtDstEntIdPrV;
531        fprintf(fXmlOut, &quot;&lt;/SocialProfile&gt;\n&quot;);
532        int CtrDocs; TStrFltPrV WordStrWgtPrV;
533        Ent-&gt;GetDocCentroid(this, TntBsBowDocBs, TntBsBowDocWgtBs, StartTmMSecs, NrQKwStr, 150, 0.9, CtrDocs, WordStrWgtPrV);
534        fprintf(fXmlOut, &quot;&lt;ContentProfile&gt;\n&quot;);
535        TChA WordStrWgtPrVChA; TChA WordStrWgtPrVXmlChA; 
536        GetWordStrWgtPrV(WordStrWgtPrV, WordStrWgtPrVChA, WordStrWgtPrVXmlChA);
537        TmSlice-&gt;PutWordStrWgtPrV(WordStrWgtPrV);
538        fprintf(fXmlOut, &quot;  &lt;Keywords docs=\&quot;%d\&quot; kwords=\&quot;%d\&quot;&gt;%s&lt;/Keywords&gt;\n&quot;, 
539         CtrDocs, WordStrWgtPrV.Len(), WordStrWgtPrVXmlChA.CStr());
540        fprintf(fTxtOut, &quot;      Centroid (%d docs, %d words): %s\n&quot;,
541         CtrDocs, WordStrWgtPrV.Len(), WordStrWgtPrVChA.CStr());
542        if (SchTmN&gt;0){
543          TStrFltPrV NegDiffWordStrWgtPrV; TStrFltPrV PosDiffWordStrWgtPrV;
544          GetWordStrWgtPrVDiff(WordStrWgtPrV, PrevWordStrWgtPrV,
545           NegDiffWordStrWgtPrV, PosDiffWordStrWgtPrV);
546          TChA PosDiffWordStrWgtPrVChA; TChA PosDiffWordStrWgtPrVXmlChA; 
547          GetWordStrWgtPrV(PosDiffWordStrWgtPrV, PosDiffWordStrWgtPrVChA, PosDiffWordStrWgtPrVXmlChA);
548          TmSlice-&gt;PutPosDiffWordStrWgtPrV(PosDiffWordStrWgtPrV);
549          fprintf(fXmlOut, &quot;  &lt;RisingKeywords&gt;%s&lt;/RisingKeywords&gt;\n&quot;, PosDiffWordStrWgtPrVXmlChA.CStr());
550          fprintf(fTxtOut, &quot;         Pos-Diff: %s\n&quot;, PosDiffWordStrWgtPrVChA.CStr());
551          TChA NegDiffWordStrWgtPrVChA; TChA NegDiffWordStrWgtPrVXmlChA; 
552          GetWordStrWgtPrV(NegDiffWordStrWgtPrV, NegDiffWordStrWgtPrVChA, NegDiffWordStrWgtPrVXmlChA);
553          TmSlice-&gt;PutNegDiffWordStrWgtPrV(NegDiffWordStrWgtPrV);
554          fprintf(fXmlOut, &quot;  &lt;FallingKeywords&gt;%s&lt;/FallingKeywords&gt;\n&quot;, NegDiffWordStrWgtPrVXmlChA.CStr());
555          fprintf(fTxtOut, &quot;         Neg-Diff: %s\n&quot;, NegDiffWordStrWgtPrVChA.CStr());
556        }
557        PrevWordStrWgtPrV=WordStrWgtPrV;
558        fprintf(fXmlOut, &quot;&lt;/ContentProfile&gt;\n&quot;);
559        fprintf(fXmlOut, &quot;&lt;/TimeSlice&gt;\n&quot;);
560        fprintf(fTxtOut, &quot;   [%.1f days: %s]\n&quot;, PastDays, StartTmStr.CStr());
561      }
562      fprintf(fXmlOut, &quot;&lt;/TimeSlices&gt;\n&quot;);
563      TVec&lt;TStrFltPrV&gt; EntNmWgtPrVV;
564      Ent-&gt;GetEntClustV(this, SchTmMSecsV.Last(), 100, 1000, 15, EntNmWgtPrVV);
565      TntRSet-&gt;PutClust(EntNmWgtPrVV);
566      fprintf(fXmlOut, &quot;&lt;SocialClusters&gt;\n&quot;);
567      for (int ClustN=0; ClustN&lt;EntNmWgtPrVV.Len(); ClustN++){
568        TStrFltPrV&amp; EntNmWgtPrV=EntNmWgtPrVV[ClustN];
569        fprintf(fXmlOut, &quot;&lt;SocialCluster num=\&quot;%d\&quot;&gt;\n&quot;, ClustN);
570        fprintf(fTxtOut, &quot;   Clust-%d:&quot;, ClustN);
571        for (int EntN=0; EntN&lt;EntNmWgtPrV.Len(); EntN++){
572          TStr EntNm=EntNmWgtPrV[EntN].Val1;
573          double Wgt=EntNmWgtPrV[EntN].Val2;
574          fprintf(fXmlOut, &quot;&lt;Entity name=\&quot;%s\&quot; wgt=\&quot;%.3f\&quot;/&gt;&quot;, EntNm.CStr(), Wgt);
575          fprintf(fTxtOut, &quot; [&#x27;%s&#x27;:%.3f]&quot;, EntNm.CStr(), Wgt);
576        }
577        fprintf(fXmlOut, &quot;&lt;/SocialCluster&gt;\n&quot;);
578        fprintf(fTxtOut, &quot;\n&quot;);
579      }
580      fprintf(fXmlOut, &quot;&lt;/SocialClusters&gt;\n&quot;);
581      fprintf(fXmlOut, &quot;&lt;/Entity&gt;\n&quot;);
582      fprintf(fTxtOut, &quot;\n&quot;);
583    }
584    fprintf(fXmlOut, &quot;&lt;/TntProfile&gt;\n&quot;);
585  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-google.cpp</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-tnt.cpp</div>
                </div>
                <div class="column column_space"><pre><code>759        TWebFetchBlocking::GetWebPg(
760         NextSearchUrlStr, NextOk, NextMsgStr, NextWebPg, Notify);
761        if (NextOk){
</pre></code></div>
                <div class="column column_space"><pre><code>234     TTntDoc::New(DocNm, Tm, SubjStr, ContStr, EntIdFqPrV);
235    int DocId=GetNewDocId();
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    