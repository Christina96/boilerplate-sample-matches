<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for pieces_ex_legmoves.c & pieces_legmoves.c</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for pieces_ex_legmoves.c & pieces_legmoves.c
      </h3>
      <h1 align="center">
        33.7%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>pieces_ex_legmoves.c (34.951458%)<TH>pieces_legmoves.c (32.667877%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match50-0.html#0',2,'match50-1.html#0',3)" NAME="0">(358-377)<TD><A HREF="javascript:ZweiFrames('match50-0.html#0',2,'match50-1.html#0',3)" NAME="0">(120-139)</A><TD ALIGN=center><FONT COLOR="#ff0000">17</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match50-0.html#1',2,'match50-1.html#1',3)" NAME="1">(295-314)<TD><A HREF="javascript:ZweiFrames('match50-0.html#1',2,'match50-1.html#1',3)" NAME="1">(22-42)</A><TD ALIGN=center><FONT COLOR="#ff0000">17</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match50-0.html#2',2,'match50-1.html#2',3)" NAME="2">(181-192)<TD><A HREF="javascript:ZweiFrames('match50-0.html#2',2,'match50-1.html#2',3)" NAME="2">(186-197)</A><TD ALIGN=center><FONT COLOR="#e10000">15</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match50-0.html#3',2,'match50-1.html#3',3)" NAME="3">(163-174)<TD><A HREF="javascript:ZweiFrames('match50-0.html#3',2,'match50-1.html#3',3)" NAME="3">(169-180)</A><TD ALIGN=center><FONT COLOR="#e10000">15</FONT>
<TR><TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match50-0.html#4',2,'match50-1.html#4',3)" NAME="4">(145-156)<TD><A HREF="javascript:ZweiFrames('match50-0.html#4',2,'match50-1.html#4',3)" NAME="4">(152-163)</A><TD ALIGN=center><FONT COLOR="#e10000">15</FONT>
<TR><TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT><TD><A HREF="javascript:ZweiFrames('match50-0.html#5',2,'match50-1.html#5',3)" NAME="5">(89-101)<TD><A HREF="javascript:ZweiFrames('match50-0.html#5',2,'match50-1.html#5',3)" NAME="5">(94-106)</A><TD ALIGN=center><FONT COLOR="#e10000">15</FONT>
<TR><TD BGCOLOR="#8c8774"><FONT COLOR="#8c8774">-</FONT><TD><A HREF="javascript:ZweiFrames('match50-0.html#6',2,'match50-1.html#6',3)" NAME="6">(71-83)<TD><A HREF="javascript:ZweiFrames('match50-0.html#6',2,'match50-1.html#6',3)" NAME="6">(76-88)</A><TD ALIGN=center><FONT COLOR="#e10000">15</FONT>
<TR><TD BGCOLOR="#38a4a5"><FONT COLOR="#38a4a5">-</FONT><TD><A HREF="javascript:ZweiFrames('match50-0.html#7',2,'match50-1.html#7',3)" NAME="7">(53-65)<TD><A HREF="javascript:ZweiFrames('match50-0.html#7',2,'match50-1.html#7',3)" NAME="7">(58-70)</A><TD ALIGN=center><FONT COLOR="#e10000">15</FONT>
<TR><TD BGCOLOR="#c58917"><FONT COLOR="#c58917">-</FONT><TD><A HREF="javascript:ZweiFrames('match50-0.html#8',2,'match50-1.html#8',3)" NAME="8">(421-436)<TD><A HREF="javascript:ZweiFrames('match50-0.html#8',2,'match50-1.html#8',3)" NAME="8">(443-459)</A><TD ALIGN=center><FONT COLOR="#d20000">14</FONT>
<TR><TD BGCOLOR="#83a33a"><FONT COLOR="#83a33a">-</FONT><TD><A HREF="javascript:ZweiFrames('match50-0.html#9',2,'match50-1.html#9',3)" NAME="9">(216-233)<TD><A HREF="javascript:ZweiFrames('match50-0.html#9',2,'match50-1.html#9',3)" NAME="9">(377-394)</A><TD ALIGN=center><FONT COLOR="#d20000">14</FONT>
<TR><TD BGCOLOR="#ad5910"><FONT COLOR="#ad5910">-</FONT><TD><A HREF="javascript:ZweiFrames('match50-0.html#10',2,'match50-1.html#10',3)" NAME="10">(114-129)<TD><A HREF="javascript:ZweiFrames('match50-0.html#10',2,'match50-1.html#10',3)" NAME="10">(309-326)</A><TD ALIGN=center><FONT COLOR="#d20000">14</FONT>
<TR><TD BGCOLOR="#b041ff"><FONT COLOR="#b041ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match50-0.html#11',2,'match50-1.html#11',3)" NAME="11">(21-37)<TD><A HREF="javascript:ZweiFrames('match50-0.html#11',2,'match50-1.html#11',3)" NAME="11">(226-244)</A><TD ALIGN=center><FONT COLOR="#d20000">14</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>pieces_ex_legmoves.c</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/* This file is a part of the GiuChess Project. */
/* */
/* Copyright (c) 2005 Giuliano Ippoliti aka JSorel (ippo@linuxmail.org) */
/* */
/* This program is free software; you can redistribute it and/or */
/* modify it under the terms of the GNU General Public License */
/* as published by the Free Software Foundation; either */
/* version 2 of the License, or (at your option) any later version. */
/* */
/* This program is distributed in the hope that it will be useful, */
/* but WITHOUT ANY WARRANTY; without even the implied warranty of */
/* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the */
/* GNU General Public License for more details. */
/* */
/* You should have received a copy of the GNU General Public License */
/* along with this program; if not, write to the Free Software */
/* Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. */
<A NAME="11"></A>
#include &quot;pieces_ex_legmoves.h&quot;

<FONT color="#b041ff"><A HREF="javascript:ZweiFrames('match50-1.html#11',3,'match50-top.html#11',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>int             exist_rook_legmov(int order, piece * friends, piece * enem)
{
    int             i;
    BITMASK         bm_pos,
                    bm_work,
                    focc,
                    eocc;       /* bm_result,  */

    focc = eocc = 0;            /* bmasks for busy squares */
    for (i = 0; i &lt;= 15; i++) {
        eocc = eocc | enem[i].bm_pos;
        focc = focc | friends[i].bm_pos;
    }


    bm_pos = friends[order].bm_pos;
    focc = focc &amp; (bm_pos ^ RET_ERR);</B></FONT>

    if ((bm_pos &amp; LEFT) == 0) { /* left */
        bm_work = bm_pos;

        while (1) {
            bm_work = bm_work &gt;&gt; 1;
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))
                    return 1;
                break;
<A NAME="7"></A>            }
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
<FONT color="#38a4a5"><A HREF="javascript:ZweiFrames('match50-1.html#7',3,'match50-top.html#7',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>            if ((bm_work &amp; LEFT) != 0)
                break;
        }
    }
    if ((bm_pos &amp; RIGHT) == 0) {/* right */
        bm_work = bm_pos;

        while (1) {
            bm_work = bm_work &lt;&lt; 1;
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))</B></FONT>
                    return 1;
                break;
<A NAME="6"></A>            }
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
<FONT color="#8c8774"><A HREF="javascript:ZweiFrames('match50-1.html#6',3,'match50-top.html#6',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>            if ((bm_work &amp; RIGHT) != 0)
                break;
        }
    }
    if ((bm_pos &amp; BOTTOM) == 0) {       /* bottom */
        bm_work = bm_pos;

        while (1) {
            bm_work = bm_work &gt;&gt; 8;
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))</B></FONT>
                    return 1;
                break;
<A NAME="5"></A>            }
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
<FONT color="#151b8d"><A HREF="javascript:ZweiFrames('match50-1.html#5',3,'match50-top.html#5',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>            if ((bm_work &amp; BOTTOM) != 0)
                break;
        }
    }
    if ((bm_pos &amp; TOP) == 0) {  /* top */
        bm_work = bm_pos;

        while (1) {
            bm_work = bm_work &lt;&lt; 8;
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))</B></FONT>
                    return 1;
                break;
            }
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
            if ((bm_work &amp; TOP) != 0)
                break;
        }
    }
<A NAME="10"></A>    return 0;
}

<FONT color="#ad5910"><A HREF="javascript:ZweiFrames('match50-1.html#10',3,'match50-top.html#10',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>int             exist_bishop_legmov(int order, piece * friends, piece * enem)
{
    int             i;
    BITMASK         bm_pos,
                    bm_work,
                    focc,
                    eocc;

    focc = eocc = 0;            /* bmasks for busy squares */
    for (i = 0; i &lt;= 15; i++) {
        eocc = eocc | enem[i].bm_pos;
        focc = focc | friends[i].bm_pos;
    }

    bm_pos = friends[order].bm_pos;
    focc = focc &amp; (bm_pos ^ RET_ERR);</B></FONT>

    if ((bm_pos &amp; TOPLEFT) == 0) {
        bm_work = bm_pos;
        while (1) {
            bm_work = bm_work &lt;&lt; 7;     /* top left */
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))
                    return 1;
                else
                    break;
<A NAME="4"></A>            }
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
<FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match50-1.html#4',3,'match50-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>            if ((bm_work &amp; TOPLEFT) != 0)       /* border */
                break;
        }
    }
    if ((bm_pos &amp; TOPRIGHT) == 0) {
        bm_work = bm_pos;
        while (1) {
            bm_work = bm_work &lt;&lt; 9;     /* top right */
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))</B></FONT>
                    return 1;
                else
                    break;
<A NAME="3"></A>            }
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
<FONT color="#53858b"><A HREF="javascript:ZweiFrames('match50-1.html#3',3,'match50-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>            if ((bm_work &amp; TOPRIGHT) != 0)      /* border */
                break;
        }
    }
    if ((bm_pos &amp; BOTTOMRIGHT) == 0) {
        bm_work = bm_pos;
        while (1) {
            bm_work = bm_work &gt;&gt; 7;     /* bottom right */
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))</B></FONT>
                    return 1;
                else
                    break;
<A NAME="2"></A>            }
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
<FONT color="#980517"><A HREF="javascript:ZweiFrames('match50-1.html#2',3,'match50-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>            if ((bm_work &amp; BOTTOMRIGHT) != 0)   /* border */
                break;
        }
    }
    if ((bm_pos &amp; BOTTOMLEFT) == 0) {
        bm_work = bm_pos;
        while (1) {
            bm_work = bm_work &gt;&gt; 9;     /* bottom left */
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))</B></FONT>
                    return 1;
                else
                    break;
            }
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
            if ((bm_work &amp; BOTTOMLEFT) != 0)    /* border */
                break;
        }
    }
    return 0;
}

int             exist_queen_legmov(int order, piece * friends, piece * enem)
{
    if (exist_rook_legmov(order, friends, enem))
        return 1;
    if (exist_bishop_legmov(order, friends, enem))
        return 1;

<A NAME="9"></A>    return 0;
}

<FONT color="#83a33a"><A HREF="javascript:ZweiFrames('match50-1.html#9',3,'match50-top.html#9',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>int             exist_knight_legmov(int order, piece * friends, piece * enem)
{
    int             row,
                    col,
                    i;
    BITMASK         bm_pos,
                    bm_work,
                    focc,
                    eocc;

    focc = eocc = 0;            /* bmasks for busy squares */
    for (i = 0; i &lt;= 15; i++) {
        eocc = eocc | enem[i].bm_pos;
        focc = focc | friends[i].bm_pos;
    }

    bm_pos = friends[order].bm_pos;
    focc = focc &amp; (bm_pos ^ RET_ERR);</B></FONT>
    conv_bm_cases(bm_pos, &amp;row, &amp;col);

    if (((row + 2) &lt;= 7) &amp;&amp; ((col + 1) &lt;= 7)) {
        bm_work = bm_pos &lt;&lt; 17;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
        }
    }
    if (((row + 1) &lt;= 7) &amp;&amp; ((col + 2) &lt;= 7)) {
        bm_work = bm_pos &lt;&lt; 10;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
        }
    }
    if (((row - 1) &gt;= 0) &amp;&amp; ((col + 2) &lt;= 7)) {
        bm_work = bm_pos &gt;&gt; 6;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
        }
    }
    if (((row - 2) &gt;= 0) &amp;&amp; ((col + 1) &lt;= 7)) {
        bm_work = bm_pos &gt;&gt; 15;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
        }
    }
    if (((row - 2) &gt;= 0) &amp;&amp; ((col - 1) &gt;= 0)) {
        bm_work = bm_pos &gt;&gt; 17;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
        }
    }
    if (((row - 1) &gt;= 0) &amp;&amp; ((col - 2) &gt;= 0)) {
        bm_work = bm_pos &gt;&gt; 10;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
        }
    }
    if (((row + 1) &lt;= 7) &amp;&amp; ((col - 2) &gt;= 0)) {
        bm_work = bm_pos &lt;&lt; 6;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
        }
    }
    if (((row + 2) &lt;= 7) &amp;&amp; ((col - 1) &gt;= 0)) {
        bm_work = bm_pos &lt;&lt; 15;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                return 1;
        }
    }
<A NAME="1"></A>    return 0;
}

<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match50-1.html#1',3,'match50-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>int             exist_white_pawn_legmov(int order, piece * w, piece * b)
{
    int             col,
                    i;
    BITMASK         bm_pos,
                    bm_work,
                    focc,
                    eocc;

    focc = eocc = 0;            /* bmasks for busy squares */
    for (i = 0; i &lt;= 15; i++) {
        eocc = eocc | b[i].bm_pos;
        focc = focc | w[i].bm_pos;
    }

    bm_pos = w[order].bm_pos;
    focc = focc &amp; (bm_pos ^ RET_ERR);

    bm_work = bm_pos &lt;&lt; 8;
    if (((bm_work &amp; focc) == 0) &amp;&amp; ((bm_work &amp; eocc) == 0)) {   /* free square */</B></FONT>
        if (is_pawn_legal_mov(order, w, b, bm_work))
            return 1;
        if ((bm_pos &amp; ROW2) != 0) {     /* never moved */
            bm_work = bm_pos &lt;&lt; 16;
            if (((bm_work &amp; focc) == 0) &amp;&amp; ((bm_work &amp; eocc) == 0))
                if (is_pawn_legal_mov(order, w, b, bm_work))
                    return 1;
        }
    }
    if ((bm_pos &amp; COL1) == 0) { /* pas sur LEFT */
        bm_work = bm_pos &lt;&lt; 7;
        if ((bm_work &amp; eocc) != 0)
            if (is_pawn_legal_mov(order, w, b, bm_work))
                return 1;
    }
    if ((bm_pos &amp; COL8) == 0) { /* pas sur RIGHT */
        bm_work = bm_pos &lt;&lt; 9;
        if ((bm_work &amp; eocc) != 0)
            if (is_pawn_legal_mov(order, w, b, bm_work))
                return 1;
    }
    /* en passant */
    if ((bm_pos &amp; ROW5) != 0) {
        get_column_from_bm(bm_pos, &amp;col);
        if (col != 7) {
            if (b[8 + col + 1].last_double_move == 1) {
                bm_work = bm_pos &lt;&lt; 9;
                if (is_pawn_legal_mov(order, w, b, bm_work))
                    return 1;
            }
        }
        if (col != 0) {
            if (b[8 + col - 1].last_double_move == 1) {
                bm_work = bm_pos &lt;&lt; 7;
                if (is_pawn_legal_mov(order, w, b, bm_work))
                    return 1;
            }
        }
    }
    return 0;
<A NAME="0"></A>}


<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match50-1.html#0',3,'match50-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>int             exist_black_pawn_legmov(int order, piece * w, piece * b)
{
    int             col,
                    i;
    BITMASK         bm_pos,
                    bm_work,
                    focc,
                    eocc;

    focc = eocc = 0;            /* bmasks for busy squares */
    for (i = 0; i &lt;= 15; i++) {
        eocc = eocc | w[i].bm_pos;
        focc = focc | b[i].bm_pos;
    }

    bm_pos = b[order].bm_pos;
    focc = focc &amp; (bm_pos ^ RET_ERR);

    bm_work = bm_pos &gt;&gt; 8;
    if (((bm_work &amp; focc) == 0) &amp;&amp; ((bm_work &amp; eocc) == 0)) {   /* free square */</B></FONT>
        if (is_pawn_legal_mov(order, b, w, bm_work))
            return 1;
        if ((bm_pos &amp; ROW7) != 0) {     /* never moved */
            bm_work = bm_pos &gt;&gt; 16;
            if (((bm_work &amp; focc) == 0) &amp;&amp; ((bm_work &amp; eocc) == 0))
                if (is_pawn_legal_mov(order, b, w, bm_work))
                    return 1;
        }
    }
    if ((bm_pos &amp; COL1) == 0) { /* pas sur LEFT */
        bm_work = bm_pos &gt;&gt; 9;
        if ((bm_work &amp; eocc) != 0)
            if (is_pawn_legal_mov(order, b, w, bm_work))
                return 1;
    }
    if ((bm_pos &amp; COL8) == 0) { /* pas sur RIGHT */
        bm_work = bm_pos &gt;&gt; 7;
        if ((bm_work &amp; eocc) != 0)
            if (is_pawn_legal_mov(order, b, w, bm_work))
                return 1;
    }
    /* en passant */
    if ((bm_pos &amp; ROW4) != 0) {
        get_column_from_bm(bm_pos, &amp;col);
        if (col != 7) {
            if (w[8 + col + 1].last_double_move == 1) {
                bm_work = bm_pos &gt;&gt; 7;
                if (is_pawn_legal_mov(order, b, w, bm_work))
                    return 1;
            }
        }
        if (col != 0) {
            if (w[8 + col - 1].last_double_move == 1) {
                bm_work = bm_pos &gt;&gt; 9;
                if (is_pawn_legal_mov(order, b, w, bm_work))
                    return 1;
            }
        }
    }
    return 0;
<A NAME="8"></A>}


<FONT color="#c58917"><A HREF="javascript:ZweiFrames('match50-1.html#8',3,'match50-top.html#8',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>int             exist_king_legmov(int order, piece * friends, piece * enems)
{
    int             i;
    BITMASK         bm_pos,
                    bm_work,
                    focc,
                    eocc;

    focc = eocc = 0;
    for (i = 0; i &lt;= 15; i++) {
        eocc = eocc | enems[i].bm_pos;
        focc = focc | friends[i].bm_pos;
    }

    bm_pos = friends[order].bm_pos;
    focc = focc &amp; (bm_pos ^ RET_ERR);</B></FONT>

    if ((bm_pos &amp; ROW1) == 0) {
        bm_work = bm_pos &gt;&gt; 8;
        if ((bm_work &amp; focc) == 0) {    /* no friend in that case */
            if (is_legal_mov(order, friends, enems, bm_work))
                return 1;
        }
        if ((bm_pos &amp; COL1) == 0) {
            bm_work = bm_pos &gt;&gt; 9;
            if ((bm_work &amp; focc) == 0) {
                if (is_legal_mov(order, friends, enems, bm_work))
                    return 1;
            }
        }
    }
    if ((bm_pos &amp; COL1) == 0) {
        bm_work = bm_pos &gt;&gt; 1;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enems, bm_work))
                return 1;
        }
        if ((bm_pos &amp; ROW8) == 0) {
            bm_work = bm_pos &lt;&lt; 7;
            if ((bm_work &amp; focc) == 0) {
                if (is_legal_mov(order, friends, enems, bm_work))
                    return 1;
            }
        }
    }
    if ((bm_pos &amp; ROW8) == 0) {
        bm_work = bm_pos &lt;&lt; 8;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enems, bm_work))
                return 1;
        }
        if ((bm_pos &amp; COL8) == 0) {
            bm_work = bm_pos &lt;&lt; 9;
            if ((bm_work &amp; focc) == 0) {
                if (is_legal_mov(order, friends, enems, bm_work))
                    return 1;
            }
        }
    }
    if ((bm_pos &amp; COL8) == 0) {
        bm_work = bm_pos &lt;&lt; 1;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enems, bm_work))
                return 1;
        }
        if ((bm_pos &amp; ROW1) == 0) {
            bm_work = bm_pos &gt;&gt; 7;
            if ((bm_work &amp; focc) == 0) {
                if (is_legal_mov(order, friends, enems, bm_work))
                    return 1;
            }
        }
    }
    /* castle code: useless here */

    return 0;
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>pieces_legmoves.c</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/* This file is a part of the GiuChess Project. */
/* */
/* Copyright (c) 2005 Giuliano Ippoliti aka JSorel (ippo@linuxmail.org) */
/* */
/* This program is free software; you can redistribute it and/or */
/* modify it under the terms of the GNU General Public License */
/* as published by the Free Software Foundation; either */
/* version 2 of the License, or (at your option) any later version. */
/* */
/* This program is distributed in the hope that it will be useful, */
/* but WITHOUT ANY WARRANTY; without even the implied warranty of */
/* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the */
/* GNU General Public License for more details. */
/* */
/* You should have received a copy of the GNU General Public License */
/* along with this program; if not, write to the Free Software */
/* Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. */

<A NAME="1"></A>#include &quot;pieces_legmoves.h&quot;

BITMASK
<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50-0.html#1',2,'match50-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>rook_legmovs(int order, piece * friends, piece * enem)
{
    int             i;
    BITMASK         bm_pos,
                    bm_work,
                    focc,
                    eocc,
                    bm_result;

    focc = eocc = 0;            /* bmasks for busy squares */
    for (i = 0; i &lt;= 15; i++) {
        eocc = eocc | enem[i].bm_pos;   /* no probmem with king */
        focc = focc | friends[i].bm_pos;
    }

    bm_pos = friends[order].bm_pos;
    focc = focc &amp; (bm_pos ^ RET_ERR);

    bm_result = 0;

    if ((bm_pos &amp; LEFT) == 0) { /* left */</B></FONT>
        bm_work = bm_pos;

        while (1) {
            bm_work = bm_work &gt;&gt; 1;
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))
                    bm_result = bm_result | bm_work;
                break;
            }
            if (is_legal_mov(order, friends, enem, bm_work))
<A NAME="7"></A>                bm_result = bm_result | bm_work;
/*mettere un else? */
/*se andando a sin. non � legale a un certo punto, puo` essere che continuando sia legale? si` se mangia un cavallo, ad es. */
<FONT color="#38a4a5"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50-0.html#7',2,'match50-top.html#7',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>            if ((bm_work &amp; LEFT) != 0)
                break;
        }
    }
    if ((bm_pos &amp; RIGHT) == 0) {/* right */
        bm_work = bm_pos;

        while (1) {
            bm_work = bm_work &lt;&lt; 1;
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))</B></FONT>
                    bm_result = bm_result | bm_work;
                break;
<A NAME="6"></A>            }
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
<FONT color="#8c8774"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50-0.html#6',2,'match50-top.html#6',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>            if ((bm_work &amp; RIGHT) != 0)
                break;
        }
    }
    if ((bm_pos &amp; BOTTOM) == 0) {       /* bottom */
        bm_work = bm_pos;

        while (1) {
            bm_work = bm_work &gt;&gt; 8;
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))</B></FONT>
                    bm_result = bm_result | bm_work;
                break;
<A NAME="5"></A>            }
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
<FONT color="#151b8d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50-0.html#5',2,'match50-top.html#5',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>            if ((bm_work &amp; BOTTOM) != 0)
                break;
        }
    }
    if ((bm_pos &amp; TOP) == 0) {  /* top */
        bm_work = bm_pos;

        while (1) {
            bm_work = bm_work &lt;&lt; 8;
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))</B></FONT>
                    bm_result = bm_result | bm_work;
                break;
            }
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
            if ((bm_work &amp; TOP) != 0)
                break;
        }
    }
    return bm_result;
<A NAME="0"></A>}

BITMASK
<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50-0.html#0',2,'match50-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>bishop_legmovs(int order, piece * friends, piece * enem)
{
    int             i;
    BITMASK         bm_pos,
                    bm_work,
                    focc,
                    eocc,
                    bm_result;

    focc = eocc = 0;            /* bmasks for busy squares */
    for (i = 0; i &lt;= 15; i++) {
        eocc = eocc | enem[i].bm_pos;
        focc = focc | friends[i].bm_pos;
    }

    bm_pos = friends[order].bm_pos;
    focc = focc &amp; (bm_pos ^ RET_ERR);
    bm_result = 0;

    if ((bm_pos &amp; TOPLEFT) == 0) {</B></FONT>
        bm_work = bm_pos;
        while (1) {
            bm_work = bm_work &lt;&lt; 7;     /* top left */
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))
                    bm_result = bm_result | bm_work;
                break;
<A NAME="4"></A>            }
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
<FONT color="#6cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50-0.html#4',2,'match50-top.html#4',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>            if ((bm_work &amp; TOPLEFT) != 0)       /* border */
                break;
        }
    }
    if ((bm_pos &amp; TOPRIGHT) == 0) {
        bm_work = bm_pos;
        while (1) {
            bm_work = bm_work &lt;&lt; 9;     /* top right */
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))</B></FONT>
                    bm_result = bm_result | bm_work;
                break;
<A NAME="3"></A>            }
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
<FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50-0.html#3',2,'match50-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>            if ((bm_work &amp; TOPRIGHT) != 0)      /* border */
                break;
        }
    }
    if ((bm_pos &amp; BOTTOMRIGHT) == 0) {
        bm_work = bm_pos;
        while (1) {
            bm_work = bm_work &gt;&gt; 7;     /* bottom right */
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))</B></FONT>
                    bm_result = bm_result | bm_work;
                break;
<A NAME="2"></A>            }
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
<FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50-0.html#2',2,'match50-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>            if ((bm_work &amp; BOTTOMRIGHT) != 0)   /* border */
                break;
        }
    }
    if ((bm_pos &amp; BOTTOMLEFT) == 0) {
        bm_work = bm_pos;
        while (1) {
            bm_work = bm_work &gt;&gt; 9;     /* bottom left */
            if ((bm_work &amp; focc) != 0)
                break;
            if ((bm_work &amp; eocc) != 0) {
                if (is_legal_mov(order, friends, enem, bm_work))</B></FONT>
                    bm_result = bm_result | bm_work;
                break;
            }
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
            if ((bm_work &amp; BOTTOMLEFT) != 0)    /* border */
                break;
        }
    }
    return bm_result;
}

BITMASK
queen_legmovs(int order, piece * friends, piece * enem)
{
    BITMASK         bm_result,
                    bm_work;

    bm_work = rook_legmovs(order, friends, enem);
    bm_result = bm_work;

    bm_work = bishop_legmovs(order, friends, enem);
    bm_result = bm_result | bm_work;

    return bm_result;
<A NAME="11"></A>}

BITMASK
<FONT color="#b041ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50-0.html#11',2,'match50-top.html#11',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>knight_legmovs(int order, piece * friends, piece * enem)
{
    int             row,
                    col,
                    i;
    BITMASK         bm_pos,
                    bm_work,
                    focc,
                    eocc,
                    bm_result;

    focc = eocc = 0;            /* bmasks for busy squares */
    for (i = 0; i &lt;= 15; i++) {
        eocc = eocc | enem[i].bm_pos;
        focc = focc | friends[i].bm_pos;
    }

    bm_pos = friends[order].bm_pos;
    focc = focc &amp; (bm_pos ^ RET_ERR);</B></FONT>
    conv_bm_cases(bm_pos, &amp;row, &amp;col);

    bm_result = 0;

    if (((row + 2) &lt;= 7) &amp;&amp; ((col + 1) &lt;= 7)) {
        bm_work = bm_pos &lt;&lt; 17;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
        }
    }
    if (((row + 1) &lt;= 7) &amp;&amp; ((col + 2) &lt;= 7)) {
        bm_work = bm_pos &lt;&lt; 10;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
        }
    }
    if (((row - 1) &gt;= 0) &amp;&amp; ((col + 2) &lt;= 7)) {
        bm_work = bm_pos &gt;&gt; 6;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
        }
    }
    if (((row - 2) &gt;= 0) &amp;&amp; ((col + 1) &lt;= 7)) {
        bm_work = bm_pos &gt;&gt; 15;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
        }
    }
    if (((row - 2) &gt;= 0) &amp;&amp; ((col - 1) &gt;= 0)) {
        bm_work = bm_pos &gt;&gt; 17;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
        }
    }
    if (((row - 1) &gt;= 0) &amp;&amp; ((col - 2) &gt;= 0)) {
        bm_work = bm_pos &gt;&gt; 10;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
        }
    }
    if (((row + 1) &lt;= 7) &amp;&amp; ((col - 2) &gt;= 0)) {
        bm_work = bm_pos &lt;&lt; 6;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
        }
    }
    if (((row + 2) &lt;= 7) &amp;&amp; ((col - 1) &gt;= 0)) {
        bm_work = bm_pos &lt;&lt; 15;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enem, bm_work))
                bm_result = bm_result | bm_work;
        }
    }
    return bm_result;
<A NAME="10"></A>}

BITMASK
<FONT color="#ad5910"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50-0.html#10',2,'match50-top.html#10',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>white_pawn_legmovs(int order, piece * w, piece * b)
{
    int             col,
                    i;
    BITMASK         bm_pos,
                    bm_work,
                    focc,
                    eocc,
                    bm_result;

    focc = eocc = 0;            /* bmasks for busy squares */
    for (i = 0; i &lt;= 15; i++) {
        eocc = eocc | b[i].bm_pos;
        focc = focc | w[i].bm_pos;
    }

    bm_pos = w[order].bm_pos;
    focc = focc &amp; (bm_pos ^ RET_ERR);</B></FONT>
    bm_result = 0;

    bm_work = bm_pos &lt;&lt; 8;

    if (((bm_work &amp; focc) == 0) &amp;&amp; ((bm_work &amp; eocc) == 0)) {   /* free square */
        if (is_pawn_legal_mov(order, w, b, bm_work))
            bm_result = bm_result | bm_work;

        if ((bm_pos &amp; ROW2) != 0) {     /* never moved */
            bm_work = bm_pos &lt;&lt; 16;
            if (((bm_work &amp; focc) == 0) &amp;&amp; ((bm_work &amp; eocc) == 0))
                if (is_pawn_legal_mov(order, w, b, bm_work))
                    bm_result = bm_result | bm_work;
        }
    }
    if ((bm_pos &amp; COL1) == 0) { /* pas sur LEFT */
        bm_work = bm_pos &lt;&lt; 7;
        if ((bm_work &amp; eocc) != 0)
            if (is_pawn_legal_mov(order, w, b, bm_work))
                bm_result = bm_result | bm_work;
    }
    if ((bm_pos &amp; COL8) == 0) { /* pas sur RIGHT */
        bm_work = bm_pos &lt;&lt; 9;
        if ((bm_work &amp; eocc) != 0)
            if (is_pawn_legal_mov(order, w, b, bm_work))
                bm_result = bm_result | bm_work;
    }
    /* en passant */
    if ((bm_pos &amp; ROW5) != 0) {
        get_column_from_bm(bm_pos, &amp;col);
        if (col != 7) {
            if (b[8 + col + 1].last_double_move == 1) {
                bm_work = bm_pos &lt;&lt; 9;
                if (is_pawn_legal_mov(order, w, b, bm_work))
                    bm_result = bm_result | bm_work;
            }
        }
        if (col != 0) {
            if (b[8 + col - 1].last_double_move == 1) {
                bm_work = bm_pos &lt;&lt; 7;
                if (is_pawn_legal_mov(order, w, b, bm_work))
                    bm_result = bm_result | bm_work;
            }
        }
    }
    return bm_result;
}
<A NAME="9"></A>

BITMASK
<FONT color="#83a33a"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50-0.html#9',2,'match50-top.html#9',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>black_pawn_legmovs(int order, piece * w, piece * b)
{
    int             col,
                    i;
    BITMASK         bm_pos,
                    bm_work,
                    focc,
                    eocc,
                    bm_result;

    focc = eocc = 0;            /* bmasks for busy squares */
    for (i = 0; i &lt;= 15; i++) {
        eocc = eocc | w[i].bm_pos;
        focc = focc | b[i].bm_pos;
    }

    bm_pos = b[order].bm_pos;
    focc = focc &amp; (bm_pos ^ RET_ERR);</B></FONT>
    bm_result = 0;

    bm_work = bm_pos &gt;&gt; 8;
    if (((bm_work &amp; focc) == 0) &amp;&amp; ((bm_work &amp; eocc) == 0)) {   /* free square */
        if (is_pawn_legal_mov(order, b, w, bm_work))
            bm_result = bm_result | bm_work;
        if ((bm_pos &amp; ROW7) != 0) {     /* never moved */
            bm_work = bm_pos &gt;&gt; 16;
            if (((bm_work &amp; focc) == 0) &amp;&amp; ((bm_work &amp; eocc) == 0))
                if (is_pawn_legal_mov(order, b, w, bm_work))
                    bm_result = bm_result | bm_work;
        }
    }
    if ((bm_pos &amp; COL1) == 0) { /* pas sur LEFT */
        bm_work = bm_pos &gt;&gt; 9;
        if ((bm_work &amp; eocc) != 0)
            if (is_pawn_legal_mov(order, b, w, bm_work))
                bm_result = bm_result | bm_work;
    }
    if ((bm_pos &amp; COL8) == 0) { /* pas sur RIGHT */
        bm_work = bm_pos &gt;&gt; 7;
        if ((bm_work &amp; eocc) != 0)
            if (is_pawn_legal_mov(order, b, w, bm_work))
                bm_result = bm_result | bm_work;
    }
    /* en passant */
    if ((bm_pos &amp; ROW4) != 0) {
        get_column_from_bm(bm_pos, &amp;col);
        if (col != 7) {
            if (w[8 + col + 1].last_double_move == 1) {
                bm_work = bm_pos &gt;&gt; 7;
                if (is_pawn_legal_mov(order, b, w, bm_work))
                    bm_result = bm_result | bm_work;
            }
        }
        if (col != 0) {
            if (w[8 + col - 1].last_double_move == 1) {
                bm_work = bm_pos &gt;&gt; 9;
                if (is_pawn_legal_mov(order, b, w, bm_work))
                    bm_result = bm_result | bm_work;
            }
        }
    }
    return bm_result;
}
<A NAME="8"></A>

BITMASK
<FONT color="#c58917"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match50-0.html#8',2,'match50-top.html#8',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>king_legmovs(int order, piece * friends, piece * enems)
{
    int             i;
    BITMASK         bm_pos,
                    bm_work,
                    focc,
                    eocc,
                    bm_result;

    focc = eocc = 0;
    for (i = 0; i &lt;= 15; i++) {
        eocc = eocc | enems[i].bm_pos;
        focc = focc | friends[i].bm_pos;
    }

    bm_pos = friends[order].bm_pos;
    focc = focc &amp; (bm_pos ^ RET_ERR);</B></FONT>
    bm_result = 0;

    if ((bm_pos &amp; ROW1) == 0) {
        bm_work = bm_pos &gt;&gt; 8;
        if ((bm_work &amp; focc) == 0) {    /* no friend in that case */
            if (is_legal_mov(order, friends, enems, bm_work))
                bm_result = bm_result | bm_work;
        }
        if ((bm_pos &amp; COL1) == 0) {
            bm_work = bm_pos &gt;&gt; 9;
            if ((bm_work &amp; focc) == 0) {
                if (is_legal_mov(order, friends, enems, bm_work))
                    bm_result = bm_result | bm_work;
            }
        }
    }
    if ((bm_pos &amp; COL1) == 0) {
        bm_work = bm_pos &gt;&gt; 1;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enems, bm_work))
                bm_result = bm_result | bm_work;
        }
        if ((bm_pos &amp; ROW8) == 0) {
            bm_work = bm_pos &lt;&lt; 7;
            if ((bm_work &amp; focc) == 0) {
                if (is_legal_mov(order, friends, enems, bm_work))
                    bm_result = bm_result | bm_work;
            }
        }
    }
    if ((bm_pos &amp; ROW8) == 0) {
        bm_work = bm_pos &lt;&lt; 8;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enems, bm_work))
                bm_result = bm_result | bm_work;
        }
        if ((bm_pos &amp; COL8) == 0) {
            bm_work = bm_pos &lt;&lt; 9;
            if ((bm_work &amp; focc) == 0) {
                if (is_legal_mov(order, friends, enems, bm_work))
                    bm_result = bm_result | bm_work;
            }
        }
    }
    if ((bm_pos &amp; COL8) == 0) {
        bm_work = bm_pos &lt;&lt; 1;
        if ((bm_work &amp; focc) == 0) {
            if (is_legal_mov(order, friends, enems, bm_work))
                bm_result = bm_result | bm_work;
        }
        if ((bm_pos &amp; ROW1) == 0) {
            bm_work = bm_pos &gt;&gt; 7;
            if ((bm_work &amp; focc) == 0) {
                if (is_legal_mov(order, friends, enems, bm_work))
                    bm_result = bm_result | bm_work;
            }
        }
    }
    /* general castle */
    /* already moved */
    if (friends[order].deja_moved == 1)
        return bm_result;

    /* short castle */
    do {
        bm_work = bm_pos &lt;&lt; 1;
        if ((bm_work &amp; bm_result) == 0) /* &quot;e1f1&quot; not in move list */
            continue;

        if (friends[order + 3].deja_moved == 1) /* rook has already moved */
            continue;

        if (friends[order + 3].bm_pos == 0)
            continue;

        bm_work = bm_pos &lt;&lt; 2;
        if ((bm_work &amp; (focc | eocc)) != 0)
            continue;

        /* under check: last test! */
        if (friends[order].under_check == 1)
            return bm_result;

        if (is_legal_mov(order, friends, enems, bm_work))
            bm_result = bm_result | bm_work;
    }
    while (0);

    /* long castle */
    do {
        bm_work = bm_pos &gt;&gt; 1;
        if ((bm_work &amp; bm_result) == 0) /* &quot;e1c1&quot; not in move list */
            continue;

        if (friends[order - 4].deja_moved == 1) /* rook has already moved */
            continue;

        if (friends[order - 4].bm_pos == 0)
            continue;

        bm_work = bm_pos &gt;&gt; 3;
        if ((bm_work &amp; (focc | eocc)) != 0)
            continue;

        bm_work = bm_pos &gt;&gt; 2;
        if ((bm_work &amp; (focc | eocc)) != 0)
            continue;

        if (friends[order].under_check == 1)
            return bm_result;

        if (is_legal_mov(order, friends, enems, bm_work))
            bm_result = bm_result | bm_work;
    }
    while (0);

    return bm_result;
}
</PRE>
</div>
  </div>
</body>
</html>
