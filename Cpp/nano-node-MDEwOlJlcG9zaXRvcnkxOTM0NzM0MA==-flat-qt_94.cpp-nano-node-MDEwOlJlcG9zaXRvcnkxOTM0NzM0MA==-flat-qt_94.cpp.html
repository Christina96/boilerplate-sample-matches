
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 24, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>nano-node-MDEwOlJlcG9zaXRvcnkxOTM0NzM0MA==-flat-qt_94.cpp</h3>
            <pre><code>1  #include <nano/qt/qt.hpp>
2  #include <nano/test_common/network.hpp>
3  #include <nano/test_common/system.hpp>
4  #include <nano/test_common/testutil.hpp>
5  #include <gtest/gtest.h>
6  #include <boost/property_tree/json_parser.hpp>
7  #include <algorithm>
8  #include <nano/qt_test/QTest>
9  #include <thread>
10  using namespace std::chrono_literals;
11  extern QApplication * test_application;
12  TEST (wallet, construction)
13  {
14  	nano_qt::eventloop_processor processor;
15  	nano::test::system system (1);
16  	auto wallet_l (system.nodes[0]->wallets.create (nano::random_wallet_id ()));
17  	auto key (wallet_l->deterministic_insert ());
18  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], wallet_l, key));
19  	wallet->start ();
20  	std::string account (key.to_account ());
21  	ASSERT_EQ (account, wallet->self.account_text->text ().toStdString ());
22  	ASSERT_EQ (1, wallet->accounts.model->rowCount ());
23  	auto item1 (wallet->accounts.model->item (0, 1));
24  	ASSERT_EQ (key.to_account (), item1->text ().toStdString ());
25  }
26  TEST (wallet, DISABLED_status)
27  {
28  	nano_qt::eventloop_processor processor;
29  	nano::test::system system (1);
30  	auto wallet_l (system.nodes[0]->wallets.create (nano::random_wallet_id ()));
31  	nano::keypair key;
32  	wallet_l->insert_adhoc (key.prv);
33  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], wallet_l, key.pub));
34  	wallet->start ();
35  	auto wallet_has = [wallet] (nano_qt::status_types status_ty) {
36  		return wallet->active_status.active.find (status_ty) != wallet->active_status.active.end ();
37  	};
38  	ASSERT_EQ ("Status: Disconnected, Blocks: 1", wallet->status->text ().toStdString ());
39  	auto outer_node = nano::test::add_outer_node (system);
40  	nano::test::establish_tcp (system, *system.nodes[0], outer_node->network.endpoint ());
41  	ASSERT_FALSE (wallet_has (nano_qt::status_types::synchronizing));
42  	system.deadline_set (25s);
43  	while (!wallet_has (nano_qt::status_types::synchronizing))
44  	{
45  		test_application->processEvents ();
46  		ASSERT_NO_ERROR (system.poll ());
47  	}
48  	system.nodes[0]->network.cleanup (std::chrono::steady_clock::now () + std::chrono::seconds (5));
49  	while (wallet_has (nano_qt::status_types::synchronizing))
50  	{
51  		test_application->processEvents ();
52  	}
53  	ASSERT_TRUE (wallet_has (nano_qt::status_types::disconnected));
54  }
55  TEST (wallet, status_with_peer)
56  {
57  	nano_qt::eventloop_processor processor;
58  	nano::test::system system (2);
59  	auto wallet_l = system.nodes[0]->wallets.create (nano::random_wallet_id ());
60  	nano::keypair key;
61  	wallet_l->insert_adhoc (key.prv);
62  	auto wallet = std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], wallet_l, key.pub);
63  	wallet->start ();
64  	auto wallet_has = [wallet] (nano_qt::status_types status_ty) {
65  		return wallet->active_status.active.find (status_ty) != wallet->active_status.active.end ();
66  	};
67  	ASSERT_FALSE (wallet_has (nano_qt::status_types::synchronizing));
68  	system.deadline_set (25s);
69  	while (!wallet_has (nano_qt::status_types::synchronizing))
70  	{
71  		test_application->processEvents ();
72  		ASSERT_NO_ERROR (system.poll ());
73  	}
74  	system.nodes[0]->network.cleanup (std::chrono::steady_clock::now () + std::chrono::seconds (5));
75  	while (wallet_has (nano_qt::status_types::synchronizing))
76  	{
77  		test_application->processEvents ();
78  		ASSERT_NO_ERROR (system.poll ());
79  	}
80  	ASSERT_TRUE (wallet_has (nano_qt::status_types::nominal));
81  }
82  TEST (wallet, startup_balance)
83  {
84  	nano_qt::eventloop_processor processor;
85  	nano::test::system system (1);
86  	auto wallet_l (system.nodes[0]->wallets.create (nano::random_wallet_id ()));
87  	nano::keypair key;
88  	wallet_l->insert_adhoc (key.prv);
89  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], wallet_l, key.pub));
90  	wallet->needs_balance_refresh = true;
91  	wallet->start ();
92  	wallet->application.processEvents (QEventLoop::AllEvents);
93  	ASSERT_EQ ("Balance: 0 nano", wallet->self.balance_label->text ().toStdString ());
94  }
95  TEST (wallet, select_account)
96  {
97  	nano_qt::eventloop_processor processor;
98  	nano::test::system system (1);
99  	auto wallet_l (system.nodes[0]->wallets.create (nano::random_wallet_id ()));
100  	nano::public_key key1 (wallet_l->deterministic_insert ());
101  	nano::public_key key2 (wallet_l->deterministic_insert ());
102  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], wallet_l, key1));
103  	wallet->start ();
104  	ASSERT_EQ (key1, wallet->account);
105  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
106  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
107  	wallet->accounts.view->selectionModel ()->setCurrentIndex (wallet->accounts.model->index (0, 0), QItemSelectionModel::SelectionFlag::Select);
108  	QTest::mouseClick (wallet->accounts.use_account, Qt::LeftButton);
109  	auto key3 (wallet->account);
110  	wallet->accounts.view->selectionModel ()->setCurrentIndex (wallet->accounts.model->index (1, 0), QItemSelectionModel::SelectionFlag::Select);
111  	QTest::mouseClick (wallet->accounts.use_account, Qt::LeftButton);
112  	auto key4 (wallet->account);
113  	ASSERT_NE (key3, key4);
114  	if (key1 < key2)
115  	{
116  		ASSERT_EQ (key2, key4);
117  	}
118  	else
119  	{
120  		ASSERT_EQ (key1, key4);
121  	}
122  }
123  TEST (wallet, main)
124  {
125  	nano_qt::eventloop_processor processor;
126  	nano::test::system system (1);
127  	auto wallet_l (system.nodes[0]->wallets.create (nano::random_wallet_id ()));
128  	nano::keypair key;
129  	wallet_l->insert_adhoc (key.prv);
130  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], wallet_l, key.pub));
131  	wallet->start ();
132  	ASSERT_EQ (wallet->entry_window, wallet->main_stack->currentWidget ());
133  	QTest::mouseClick (wallet->send_blocks, Qt::LeftButton);
134  	ASSERT_EQ (wallet->send_blocks_window, wallet->main_stack->currentWidget ());
135  	QTest::mouseClick (wallet->send_blocks_back, Qt::LeftButton);
136  	QTest::mouseClick (wallet->settings_button, Qt::LeftButton);
137  	ASSERT_EQ (wallet->settings.window, wallet->main_stack->currentWidget ());
138  	QTest::mouseClick (wallet->settings.back, Qt::LeftButton);
139  	ASSERT_EQ (wallet->entry_window, wallet->main_stack->currentWidget ());
140  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
141  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
142  	QTest::mouseClick (wallet->advanced.show_ledger, Qt::LeftButton);
143  	ASSERT_EQ (wallet->advanced.ledger_window, wallet->main_stack->currentWidget ());
144  	QTest::mouseClick (wallet->advanced.ledger_back, Qt::LeftButton);
145  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
146  	QTest::mouseClick (wallet->advanced.show_peers, Qt::LeftButton);
147  	ASSERT_EQ (wallet->advanced.peers_window, wallet->main_stack->currentWidget ());
148  	QTest::mouseClick (wallet->advanced.peers_back, Qt::LeftButton);
149  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
150  	QTest::mouseClick (wallet->advanced.back, Qt::LeftButton);
151  	ASSERT_EQ (wallet->entry_window, wallet->main_stack->currentWidget ());
152  }
153  TEST (wallet, password_change)
154  {
155  	nano_qt::eventloop_processor processor;
156  	nano::test::system system (1);
157  	nano::account account;
158  	system.wallet (0)->insert_adhoc (nano::keypair ().prv);
159  	{
160  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
161  		account = system.account (transaction, 0);
162  	}
163  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
164  	wallet->start ();
165  	QTest::mouseClick (wallet->settings_button, Qt::LeftButton);
166  	{
167  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
168  		nano::raw_key password1;
169  		nano::raw_key password2;
170  		system.wallet (0)->store.derive_key (password1, transaction, "1");
171  		system.wallet (0)->store.password.value (password2);
172  		ASSERT_NE (password1, password2);
173  	}
174  	QTest::keyClicks (wallet->settings.new_password, "1");
175  	QTest::keyClicks (wallet->settings.retype_password, "1");
176  	QTest::mouseClick (wallet->settings.change, Qt::LeftButton);
177  	{
178  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
179  		nano::raw_key password1;
180  		nano::raw_key password2;
181  		system.wallet (0)->store.derive_key (password1, transaction, "1");
182  		system.wallet (0)->store.password.value (password2);
183  		ASSERT_EQ (password1, password2);
184  	}
185  	ASSERT_EQ ("", wallet->settings.new_password->text ());
186  	ASSERT_EQ ("", wallet->settings.retype_password->text ());
187  }
188  TEST (client, password_nochange)
189  {
190  	nano_qt::eventloop_processor processor;
191  	nano::test::system system (1);
192  	nano::account account;
193  	system.wallet (0)->insert_adhoc (nano::keypair ().prv);
194  	{
195  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
196  		account = system.account (transaction, 0);
197  	}
198  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
199  	wallet->start ();
200  	QTest::mouseClick (wallet->settings_button, Qt::LeftButton);
201  	nano::raw_key password;
202  	password.clear ();
203  	system.deadline_set (10s);
204  	while (password == 0)
205  	{
206  		ASSERT_NO_ERROR (system.poll ());
207  		system.wallet (0)->store.password.value (password);
208  	}
209  	{
210  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
211  		nano::raw_key password1;
212  		system.wallet (0)->store.derive_key (password1, transaction, "");
213  		nano::raw_key password2;
214  		system.wallet (0)->store.password.value (password2);
215  		ASSERT_EQ (password1, password2);
216  	}
217  	QTest::keyClicks (wallet->settings.new_password, "1");
218  	QTest::keyClicks (wallet->settings.retype_password, "2");
219  	QTest::mouseClick (wallet->settings.change, Qt::LeftButton);
220  	{
221  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
222  		nano::raw_key password1;
223  		system.wallet (0)->store.derive_key (password1, transaction, "");
224  		nano::raw_key password2;
225  		system.wallet (0)->store.password.value (password2);
226  		ASSERT_EQ (password1, password2);
227  	}
228  	ASSERT_EQ ("1", wallet->settings.new_password->text ());
229  	ASSERT_EQ ("", wallet->settings.retype_password->text ());
230  }
231  TEST (wallet, enter_password)
232  {
233  	nano_qt::eventloop_processor processor;
234  	nano::test::system system (2);
235  	nano::account account;
236  	system.wallet (0)->insert_adhoc (nano::keypair ().prv);
237  	{
238  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
239  		account = system.account (transaction, 0);
240  	}
241  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
242  	wallet->start ();
243  	ASSERT_NE (-1, wallet->settings.layout->indexOf (wallet->settings.password));
244  	ASSERT_NE (-1, wallet->settings.layout->indexOf (wallet->settings.lock_toggle));
245  	ASSERT_NE (-1, wallet->settings.layout->indexOf (wallet->settings.back));
246  	QTest::mouseClick (wallet->settings.lock_toggle, Qt::LeftButton);
247  	QTest::mouseClick (wallet->settings.lock_toggle, Qt::LeftButton);
248  	test_application->processEvents ();
249  	ASSERT_NE (wallet->status->text ().toStdString ().rfind ("Status: Wallet password empty", 0), std::string::npos);
250  	{
251  		auto transaction (system.nodes[0]->wallets.tx_begin_write ());
252  		ASSERT_FALSE (system.wallet (0)->store.rekey (transaction, "abc"));
253  	}
254  	QTest::mouseClick (wallet->settings_button, Qt::LeftButton);
255  	QTest::mouseClick (wallet->settings.lock_toggle, Qt::LeftButton);
256  	test_application->processEvents ();
257  	ASSERT_NE (wallet->status->text ().toStdString ().rfind ("Status: Wallet locked", 0), std::string::npos);
258  	wallet->settings.new_password->setText ("");
259  	QTest::keyClicks (wallet->settings.password, "abc");
260  	QTest::mouseClick (wallet->settings.lock_toggle, Qt::LeftButton);
261  	test_application->processEvents ();
262  	ASSERT_NE (wallet->status->text ().toStdString ().rfind ("Status: Running", 0), std::string::npos);
263  	ASSERT_EQ ("", wallet->settings.password->text ());
264  }
265  TEST (wallet, send)
266  {
267  	nano_qt::eventloop_processor processor;
268  	nano::test::system system (2);
269  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
270  	nano::public_key key1 (system.wallet (1)->insert_adhoc (nano::keypair ().prv));
271  	auto account (nano::dev::genesis_key.pub);
272  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
273  	wallet->start ();
274  	ASSERT_NE (wallet->rendering_ratio, nano::raw_ratio);
275  	QTest::mouseClick (wallet->send_blocks, Qt::LeftButton);
276  	QTest::keyClicks (wallet->send_account, key1.to_account ().c_str ());
277  	QTest::keyClicks (wallet->send_count, "2.03");
278  	QTest::mouseClick (wallet->send_blocks_send, Qt::LeftButton);
279  	system.deadline_set (10s);
280  	while (wallet->node.balance (key1).is_zero ())
281  	{
282  		ASSERT_NO_ERROR (system.poll ());
283  	}
284  	nano::uint128_t amount (wallet->node.balance (key1));
285  	ASSERT_EQ (2 * wallet->rendering_ratio + (3 * wallet->rendering_ratio / 100), amount);
286  	QTest::mouseClick (wallet->send_blocks_back, Qt::LeftButton);
287  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
288  	QTest::mouseClick (wallet->advanced.show_ledger, Qt::LeftButton);
289  	QTest::mouseClick (wallet->advanced.ledger_refresh, Qt::LeftButton);
290  	ASSERT_EQ (2, wallet->advanced.ledger_model->rowCount ());
291  	ASSERT_EQ (3, wallet->advanced.ledger_model->columnCount ());
292  	auto item (wallet->advanced.ledger_model->itemFromIndex (wallet->advanced.ledger_model->index (0, 1)));
293  	auto other_item (wallet->advanced.ledger_model->itemFromIndex (wallet->advanced.ledger_model->index (1, 1)));
294  	ASSERT_TRUE (("2" == item->text ()) || ("2" == other_item->text ()));
295  }
296  TEST (wallet, send_locked)
297  {
298  	nano_qt::eventloop_processor processor;
299  	nano::test::system system (1);
300  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
301  	nano::keypair key1;
302  	{
303  		auto transaction (system.wallet (0)->wallets.tx_begin_write ());
304  		system.wallet (0)->enter_password (transaction, "0");
305  	}
306  	auto account (nano::dev::genesis_key.pub);
307  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
308  	wallet->start ();
309  	QTest::mouseClick (wallet->send_blocks, Qt::LeftButton);
310  	QTest::keyClicks (wallet->send_account, key1.pub.to_account ().c_str ());
311  	QTest::keyClicks (wallet->send_count, "2");
312  	QTest::mouseClick (wallet->send_blocks_send, Qt::LeftButton);
313  	system.deadline_set (10s);
314  	while (!wallet->send_blocks_send->isEnabled ())
315  	{
316  		test_application->processEvents ();
317  		ASSERT_NO_ERROR (system.poll ());
318  	}
319  }
320  TEST (wallet, DISABLED_process_block)
321  {
322  	nano_qt::eventloop_processor processor;
323  	nano::test::system system (1);
324  	nano::account account;
325  	nano::block_hash latest (system.nodes[0]->latest (nano::dev::genesis->account ()));
326  	system.wallet (0)->insert_adhoc (nano::keypair ().prv);
327  	{
328  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
329  		account = system.account (transaction, 0);
330  	}
331  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
332  	wallet->start ();
333  	ASSERT_EQ ("Process", wallet->block_entry.process->text ());
334  	ASSERT_EQ ("Back", wallet->block_entry.back->text ());
335  	nano::keypair key1;
336  	ASSERT_EQ (wallet->entry_window, wallet->main_stack->currentWidget ());
337  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
338  	QTest::mouseClick (wallet->advanced.enter_block, Qt::LeftButton);
339  	ASSERT_EQ (wallet->block_entry.window, wallet->main_stack->currentWidget ());
340  	nano::send_block send (latest, key1.pub, 0, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (latest));
341  	std::string previous;
342  	send.hashables.previous.encode_hex (previous);
343  	std::string balance;
344  	send.hashables.balance.encode_hex (balance);
345  	std::string signature;
346  	send.signature.encode_hex (signature);
347  	std::string block_json;
348  	send.serialize_json (block_json);
349  	block_json.erase (std::remove (block_json.begin (), block_json.end (), '\n'), block_json.end ());
350  	QTest::keyClicks (wallet->block_entry.block, QString::fromStdString (block_json));
351  	QTest::mouseClick (wallet->block_entry.process, Qt::LeftButton);
352  	{
353  		auto transaction (system.nodes[0]->store.tx_begin_read ());
354  		system.deadline_set (10s);
355  		while (system.nodes[0]->store.block.exists (transaction, send.hash ()))
356  		{
357  			ASSERT_NO_ERROR (system.poll ());
358  		}
359  	}
360  	QTest::mouseClick (wallet->block_entry.back, Qt::LeftButton);
361  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
362  }
363  TEST (wallet, create_send)
364  {
365  	nano_qt::eventloop_processor processor;
366  	nano::keypair key;
367  	nano::test::system system (1);
368  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
369  	system.wallet (0)->insert_adhoc (key.prv);
370  	auto account (nano::dev::genesis_key.pub);
371  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
372  	wallet->start ();
373  	wallet->client_window->show ();
374  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
375  	QTest::mouseClick (wallet->advanced.create_block, Qt::LeftButton);
376  	QTest::mouseClick (wallet->block_creation.send, Qt::LeftButton);
377  	QTest::keyClicks (wallet->block_creation.account, nano::dev::genesis_key.pub.to_account ().c_str ());
378  	QTest::keyClicks (wallet->block_creation.amount, "100000000000000000000");
379  	QTest::keyClicks (wallet->block_creation.destination, key.pub.to_account ().c_str ());
380  	QTest::mouseClick (wallet->block_creation.create, Qt::LeftButton);
381  	std::string json (wallet->block_creation.block->toPlainText ().toStdString ());
382  	ASSERT_FALSE (json.empty ());
383  	boost::property_tree::ptree tree1;
384  	std::stringstream istream (json);
385  	boost::property_tree::read_json (istream, tree1);
386  	bool error (false);
387  	nano::state_block send (error, tree1);
388  	ASSERT_FALSE (error);
389  	ASSERT_EQ (nano::process_result::progress, system.nodes[0]->process (send).code);
390  	ASSERT_EQ (nano::process_result::old, system.nodes[0]->process (send).code);
391  }
392  TEST (wallet, create_open_receive)
393  {
394  	nano_qt::eventloop_processor processor;
395  	nano::keypair key;
396  	nano::test::system system (1);
397  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
398  	system.wallet (0)->send_action (nano::dev::genesis_key.pub, key.pub, 100);
399  	nano::block_hash latest1 (system.nodes[0]->latest (nano::dev::genesis_key.pub));
400  	system.wallet (0)->send_action (nano::dev::genesis_key.pub, key.pub, 100);
401  	nano::block_hash latest2 (system.nodes[0]->latest (nano::dev::genesis_key.pub));
402  	ASSERT_NE (latest1, latest2);
403  	system.wallet (0)->insert_adhoc (key.prv);
404  	auto account (nano::dev::genesis_key.pub);
405  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
406  	wallet->start ();
407  	wallet->client_window->show ();
408  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
409  	QTest::mouseClick (wallet->advanced.create_block, Qt::LeftButton);
410  	wallet->block_creation.open->click ();
411  	QTest::keyClicks (wallet->block_creation.source, latest1.to_string ().c_str ());
412  	QTest::keyClicks (wallet->block_creation.representative, nano::dev::genesis_key.pub.to_account ().c_str ());
413  	QTest::mouseClick (wallet->block_creation.create, Qt::LeftButton);
414  	std::string json1 (wallet->block_creation.block->toPlainText ().toStdString ());
415  	ASSERT_FALSE (json1.empty ());
416  	boost::property_tree::ptree tree1;
417  	std::stringstream istream1 (json1);
418  	boost::property_tree::read_json (istream1, tree1);
419  	bool error (false);
420  	nano::state_block open (error, tree1);
421  	ASSERT_FALSE (error);
422  	ASSERT_EQ (nano::process_result::progress, system.nodes[0]->process (open).code);
423  	ASSERT_EQ (nano::process_result::old, system.nodes[0]->process (open).code);
424  	wallet->block_creation.block->clear ();
425  	wallet->block_creation.source->clear ();
426  	wallet->block_creation.receive->click ();
427  	QTest::keyClicks (wallet->block_creation.source, latest2.to_string ().c_str ());
428  	QTest::mouseClick (wallet->block_creation.create, Qt::LeftButton);
429  	std::string json2 (wallet->block_creation.block->toPlainText ().toStdString ());
430  	ASSERT_FALSE (json2.empty ());
431  	boost::property_tree::ptree tree2;
432  	std::stringstream istream2 (json2);
433  	boost::property_tree::read_json (istream2, tree2);
434  	bool error2 (false);
435  	nano::state_block receive (error2, tree2);
436  	ASSERT_FALSE (error2);
437  	ASSERT_EQ (nano::process_result::progress, system.nodes[0]->process (receive).code);
438  	ASSERT_EQ (nano::process_result::old, system.nodes[0]->process (receive).code);
439  }
440  TEST (wallet, create_change)
441  {
442  	nano_qt::eventloop_processor processor;
443  	nano::keypair key;
444  	nano::test::system system (1);
445  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
446  	auto account (nano::dev::genesis_key.pub);
447  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
448  	wallet->start ();
449  	wallet->client_window->show ();
450  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
451  	QTest::mouseClick (wallet->advanced.create_block, Qt::LeftButton);
452  	wallet->block_creation.change->click ();
453  	QTest::keyClicks (wallet->block_creation.account, nano::dev::genesis_key.pub.to_account ().c_str ());
454  	QTest::keyClicks (wallet->block_creation.representative, key.pub.to_account ().c_str ());
455  	wallet->block_creation.create->click ();
456  	std::string json (wallet->block_creation.block->toPlainText ().toStdString ());
457  	ASSERT_FALSE (json.empty ());
458  	boost::property_tree::ptree tree1;
459  	std::stringstream istream (json);
460  	boost::property_tree::read_json (istream, tree1);
461  	bool error (false);
462  	nano::state_block change (error, tree1);
463  	ASSERT_FALSE (error);
464  	ASSERT_EQ (nano::process_result::progress, system.nodes[0]->process (change).code);
465  	ASSERT_EQ (nano::process_result::old, system.nodes[0]->process (change).code);
466  }
467  TEST (history, short_text)
468  {
469  	if (nano::rocksdb_config::using_rocksdb_in_tests ())
470  	{
471  		return;
472  	}
473  	nano_qt::eventloop_processor processor;
474  	nano::keypair key;
475  	nano::test::system system (1);
476  	system.wallet (0)->insert_adhoc (key.prv);
477  	nano::account account;
478  	{
479  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
480  		account = system.account (transaction, 0);
481  	}
482  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
483  	auto store = nano::make_store (system.nodes[0]->logger, nano::unique_path (), nano::dev::constants);
484  	ASSERT_TRUE (!store->init_error ());
<span onclick='openModal()' class='match'>485  	nano::ledger ledger (*store, system.nodes[0]->stats, nano::dev::constants);
486  	{
</span>487  		auto transaction (store->tx_begin_write ());
488  		store->initialize (transaction, ledger.cache, ledger.constants);
489  		nano::keypair key;
490  		auto latest (ledger.latest (transaction, nano::dev::genesis_key.pub));
491  		nano::send_block send (latest, nano::dev::genesis_key.pub, 0, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (latest));
492  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, send).code);
493  		nano::receive_block receive (send.hash (), send.hash (), nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (send.hash ()));
494  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, receive).code);
495  		nano::change_block change (receive.hash (), key.pub, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (receive.hash ()));
496  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, change).code);
497  	}
498  	nano_qt::history history (ledger, nano::dev::genesis_key.pub, *wallet);
499  	history.refresh ();
500  	ASSERT_EQ (4, history.model->rowCount ());
501  }
502  TEST (history, pruned_source)
503  {
504  	if (nano::rocksdb_config::using_rocksdb_in_tests ())
505  	{
506  		return;
507  	}
508  	nano_qt::eventloop_processor processor;
509  	nano::keypair key;
510  	nano::test::system system (1);
511  	system.wallet (0)->insert_adhoc (key.prv);
512  	nano::account account;
513  	{
514  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
515  		account = system.account (transaction, 0);
516  	}
517  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
518  	auto store = nano::make_store (system.nodes[0]->logger, nano::unique_path (), nano::dev::constants);
519  	ASSERT_TRUE (!store->init_error ());
520  	nano::ledger ledger (*store, system.nodes[0]->stats, nano::dev::constants);
521  	ledger.pruning = true;
522  	nano::block_hash next_pruning;
523  	{
524  		auto transaction (store->tx_begin_write ());
525  		store->initialize (transaction, ledger.cache, nano::dev::constants);
526  		auto latest (ledger.latest (transaction, nano::dev::genesis_key.pub));
527  		nano::send_block send1 (latest, nano::dev::genesis_key.pub, nano::dev::constants.genesis_amount - 100, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (latest));
528  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, send1).code);
529  		nano::send_block send2 (send1.hash (), key.pub, nano::dev::constants.genesis_amount - 200, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (send1.hash ()));
530  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, send2).code);
531  		nano::receive_block receive (send2.hash (), send1.hash (), nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (send2.hash ()));
532  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, receive).code);
533  		nano::open_block open (send2.hash (), key.pub, key.pub, key.prv, key.pub, *system.work.generate (key.pub));
534  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, open).code);
535  		ASSERT_EQ (1, ledger.pruning_action (transaction, send1.hash (), 2));
536  		next_pruning = send2.hash ();
537  	}
538  	nano_qt::history history1 (ledger, nano::dev::genesis_key.pub, *wallet);
539  	history1.refresh ();
540  	ASSERT_EQ (2, history1.model->rowCount ());
541  	nano_qt::history history2 (ledger, key.pub, *wallet);
542  	history2.refresh ();
543  	ASSERT_EQ (1, history2.model->rowCount ());
544  	{
545  		auto transaction (store->tx_begin_write ());
546  		ASSERT_EQ (1, ledger.pruning_action (transaction, next_pruning, 2));
547  	}
548  	history1.refresh ();
549  	ASSERT_EQ (1, history1.model->rowCount ());
550  	history2.refresh ();
551  	ASSERT_EQ (1, history2.model->rowCount ());
552  	{
553  		auto transaction (store->tx_begin_write ());
554  		auto latest (ledger.latest (transaction, nano::dev::genesis_key.pub));
555  		nano::state_block send (nano::dev::genesis_key.pub, latest, nano::dev::genesis_key.pub, nano::dev::constants.genesis_amount - 200, key.pub, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (latest));
556  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, send).code);
557  		auto latest_key (ledger.latest (transaction, key.pub));
558  		nano::state_block receive (key.pub, latest_key, key.pub, 200, send.hash (), key.prv, key.pub, *system.work.generate (latest_key));
559  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, receive).code);
560  		ASSERT_EQ (1, ledger.pruning_action (transaction, latest, 2));
561  		ASSERT_EQ (1, ledger.pruning_action (transaction, latest_key, 2));
562  	}
563  	history1.refresh ();
564  	ASSERT_EQ (1, history1.model->rowCount ());
565  	history2.refresh ();
566  	ASSERT_EQ (1, history2.model->rowCount ());
567  }
568  TEST (wallet, startup_work)
569  {
570  	nano_qt::eventloop_processor processor;
571  	nano::keypair key;
572  	nano::test::system system (1);
573  	system.wallet (0)->insert_adhoc (key.prv);
574  	nano::account account;
575  	{
576  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
577  		account = system.account (transaction, 0);
578  	}
579  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
580  	wallet->start ();
581  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
582  	uint64_t work1;
583  	{
584  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
585  		ASSERT_TRUE (wallet->wallet_m->store.work_get (transaction, nano::dev::genesis_key.pub, work1));
586  	}
587  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
588  	QTest::keyClicks (wallet->accounts.account_key_line, "34F0A37AAD20F4A260F0A5B3CB3D7FB50673212263E58A380BC10474BB039CE4");
589  	QTest::mouseClick (wallet->accounts.account_key_button, Qt::LeftButton);
590  	system.deadline_set (10s);
591  	auto again (true);
592  	while (again)
593  	{
594  		ASSERT_NO_ERROR (system.poll ());
595  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
596  		again = wallet->wallet_m->store.work_get (transaction, nano::dev::genesis_key.pub, work1);
597  	}
598  }
599  TEST (wallet, block_viewer)
600  {
601  	nano_qt::eventloop_processor processor;
602  	nano::keypair key;
603  	nano::test::system system (1);
604  	system.wallet (0)->insert_adhoc (key.prv);
605  	nano::account account;
606  	{
607  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
608  		account = system.account (transaction, 0);
609  	}
610  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
611  	wallet->start ();
612  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
613  	ASSERT_NE (-1, wallet->advanced.layout->indexOf (wallet->advanced.block_viewer));
614  	QTest::mouseClick (wallet->advanced.block_viewer, Qt::LeftButton);
615  	ASSERT_EQ (wallet->block_viewer.window, wallet->main_stack->currentWidget ());
616  	nano::block_hash latest (system.nodes[0]->latest (nano::dev::genesis->account ()));
617  	QTest::keyClicks (wallet->block_viewer.hash, latest.to_string ().c_str ());
618  	QTest::mouseClick (wallet->block_viewer.retrieve, Qt::LeftButton);
619  	ASSERT_FALSE (wallet->block_viewer.block->toPlainText ().toStdString ().empty ());
620  	QTest::mouseClick (wallet->block_viewer.back, Qt::LeftButton);
621  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
622  }
623  TEST (wallet, import)
624  {
625  	nano_qt::eventloop_processor processor;
626  	nano::test::system system (2);
627  	std::string json;
628  	nano::keypair key1;
629  	nano::keypair key2;
630  	system.wallet (0)->insert_adhoc (key1.prv);
631  	{
632  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
633  		system.wallet (0)->store.serialize_json (transaction, json);
634  	}
635  	system.wallet (1)->insert_adhoc (key2.prv);
636  	auto path (nano::unique_path ());
637  	{
638  		std::ofstream stream;
639  		stream.open (path.string ().c_str ());
640  		stream << json;
641  	}
642  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[1], system.wallet (1), key2.pub));
643  	wallet->start ();
644  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
645  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
646  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
647  	ASSERT_EQ (wallet->accounts.window, wallet->main_stack->currentWidget ());
648  	QTest::mouseClick (wallet->accounts.import_wallet, Qt::LeftButton);
649  	ASSERT_EQ (wallet->import.window, wallet->main_stack->currentWidget ());
650  	QTest::keyClicks (wallet->import.filename, path.string ().c_str ());
651  	QTest::keyClicks (wallet->import.password, "");
652  	ASSERT_FALSE (system.wallet (1)->exists (key1.pub));
653  	QTest::mouseClick (wallet->import.perform, Qt::LeftButton);
654  	ASSERT_TRUE (system.wallet (1)->exists (key1.pub));
655  }
656  TEST (wallet, republish)
657  {
658  	nano_qt::eventloop_processor processor;
659  	nano::test::system system (2);
660  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
661  	nano::keypair key;
662  	nano::block_hash hash;
663  	{
664  		auto transaction (system.nodes[0]->store.tx_begin_write ());
665  		auto latest (system.nodes[0]->ledger.latest (transaction, nano::dev::genesis_key.pub));
666  		nano::send_block block (latest, key.pub, 0, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (latest));
667  		hash = block.hash ();
668  		ASSERT_EQ (nano::process_result::progress, system.nodes[0]->ledger.process (transaction, block).code);
669  	}
670  	auto account (nano::dev::genesis_key.pub);
671  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
672  	wallet->start ();
673  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
674  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
675  	QTest::mouseClick (wallet->advanced.block_viewer, Qt::LeftButton);
676  	ASSERT_EQ (wallet->block_viewer.window, wallet->main_stack->currentWidget ());
677  	QTest::keyClicks (wallet->block_viewer.hash, hash.to_string ().c_str ());
678  	QTest::mouseClick (wallet->block_viewer.rebroadcast, Qt::LeftButton);
679  	ASSERT_FALSE (system.nodes[1]->balance (nano::dev::genesis_key.pub).is_zero ());
680  	system.deadline_set (10s);
681  	while (system.nodes[1]->balance (nano::dev::genesis_key.pub).is_zero ())
682  	{
683  		ASSERT_NO_ERROR (system.poll ());
684  	}
685  }
686  TEST (wallet, ignore_empty_adhoc)
687  {
688  	nano_qt::eventloop_processor processor;
689  	nano::test::system system (1);
690  	nano::keypair key1;
691  	system.wallet (0)->insert_adhoc (key1.prv);
692  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), key1.pub));
693  	wallet->start ();
694  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
695  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
696  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
697  	ASSERT_EQ (wallet->accounts.window, wallet->main_stack->currentWidget ());
698  	QTest::keyClicks (wallet->accounts.account_key_line, nano::dev::genesis_key.prv.to_string ().c_str ());
699  	QTest::mouseClick (wallet->accounts.account_key_button, Qt::LeftButton);
700  	ASSERT_EQ (1, wallet->accounts.model->rowCount ());
701  	ASSERT_EQ (0, wallet->accounts.account_key_line->text ().length ());
702  	nano::keypair key;
703  	QTest::keyClicks (wallet->accounts.account_key_line, key.prv.to_string ().c_str ());
704  	QTest::mouseClick (wallet->accounts.account_key_button, Qt::LeftButton);
705  	ASSERT_EQ (1, wallet->accounts.model->rowCount ());
706  	ASSERT_EQ (0, wallet->accounts.account_key_line->text ().length ());
707  	QTest::mouseClick (wallet->accounts.create_account, Qt::LeftButton);
708  	test_application->processEvents ();
709  	test_application->processEvents ();
710  	ASSERT_EQ (2, wallet->accounts.model->rowCount ());
711  }
712  TEST (wallet, change_seed)
713  {
714  	nano_qt::eventloop_processor processor;
715  	nano::test::system system (1);
716  	auto key1 (system.wallet (0)->deterministic_insert ());
717  	system.wallet (0)->deterministic_insert ();
718  	nano::raw_key seed3;
719  	{
720  		auto transaction (system.wallet (0)->wallets.tx_begin_read ());
721  		system.wallet (0)->store.seed (seed3, transaction);
722  	}
723  	auto wallet_key (key1);
724  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), wallet_key));
725  	wallet->start ();
726  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
727  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
728  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
729  	ASSERT_EQ (wallet->accounts.window, wallet->main_stack->currentWidget ());
730  	QTest::mouseClick (wallet->accounts.import_wallet, Qt::LeftButton);
731  	ASSERT_EQ (wallet->import.window, wallet->main_stack->currentWidget ());
732  	nano::raw_key seed;
733  	seed.clear ();
734  	QTest::keyClicks (wallet->import.seed, seed.to_string ().c_str ());
735  	nano::raw_key seed1;
736  	{
737  		auto transaction (system.wallet (0)->wallets.tx_begin_read ());
738  		system.wallet (0)->store.seed (seed1, transaction);
739  	}
740  	ASSERT_NE (seed, seed1);
741  	ASSERT_TRUE (system.wallet (0)->exists (key1));
742  	ASSERT_EQ (2, wallet->accounts.model->rowCount ());
743  	QTest::mouseClick (wallet->import.import_seed, Qt::LeftButton);
744  	ASSERT_EQ (2, wallet->accounts.model->rowCount ());
745  	QTest::keyClicks (wallet->import.clear_line, "clear keys");
746  	QTest::mouseClick (wallet->import.import_seed, Qt::LeftButton);
747  	ASSERT_EQ (1, wallet->accounts.model->rowCount ());
748  	ASSERT_TRUE (wallet->import.clear_line->text ().toStdString ().empty ());
749  	nano::raw_key seed2;
750  	auto transaction (system.wallet (0)->wallets.tx_begin_read ());
751  	system.wallet (0)->store.seed (seed2, transaction);
752  	ASSERT_EQ (seed, seed2);
753  	ASSERT_FALSE (system.wallet (0)->exists (key1));
754  	ASSERT_NE (key1, wallet->account);
755  	auto key2 (wallet->account);
756  	ASSERT_TRUE (system.wallet (0)->exists (key2));
757  	QTest::keyClicks (wallet->import.seed, seed3.to_string ().c_str ());
758  	QTest::keyClicks (wallet->import.clear_line, "clear keys");
759  	QTest::mouseClick (wallet->import.import_seed, Qt::LeftButton);
760  	ASSERT_EQ (key1, wallet->account);
761  	ASSERT_FALSE (system.wallet (0)->exists (key2));
762  	ASSERT_TRUE (system.wallet (0)->exists (key1));
763  }
764  TEST (wallet, seed_work_generation)
765  {
766  	nano_qt::eventloop_processor processor;
767  	nano::test::system system (1);
768  	auto key1 (system.wallet (0)->deterministic_insert ());
769  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), key1));
770  	wallet->start ();
771  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
772  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
773  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
774  	ASSERT_EQ (wallet->accounts.window, wallet->main_stack->currentWidget ());
775  	QTest::mouseClick (wallet->accounts.import_wallet, Qt::LeftButton);
776  	ASSERT_EQ (wallet->import.window, wallet->main_stack->currentWidget ());
777  	nano::raw_key seed;
778  	auto prv = nano::deterministic_key (seed, 0);
779  	auto pub (nano::pub_key (prv));
780  	QTest::keyClicks (wallet->import.seed, seed.to_string ().c_str ());
781  	QTest::keyClicks (wallet->import.clear_line, "clear keys");
782  	uint64_t work (0);
783  	QTest::mouseClick (wallet->import.import_seed, Qt::LeftButton);
784  	system.deadline_set (10s);
785  	while (work == 0)
786  	{
787  		auto ec = system.poll ();
788  		auto transaction (system.wallet (0)->wallets.tx_begin_read ());
789  		system.wallet (0)->store.work_get (transaction, pub, work);
790  		ASSERT_NO_ERROR (ec);
791  	}
792  	auto transaction (system.nodes[0]->store.tx_begin_read ());
793  	ASSERT_GE (nano::dev::network_params.work.difficulty (nano::work_version::work_1, system.nodes[0]->ledger.latest_root (transaction, pub), work), system.nodes[0]->default_difficulty (nano::work_version::work_1));
794  }
795  TEST (wallet, backup_seed)
796  {
797  	nano_qt::eventloop_processor processor;
798  	nano::test::system system (1);
799  	auto key1 (system.wallet (0)->deterministic_insert ());
800  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), key1));
801  	wallet->start ();
802  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
803  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
804  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
805  	ASSERT_EQ (wallet->accounts.window, wallet->main_stack->currentWidget ());
806  	QTest::mouseClick (wallet->accounts.backup_seed, Qt::LeftButton);
807  	nano::raw_key seed;
808  	auto transaction (system.wallet (0)->wallets.tx_begin_read ());
809  	system.wallet (0)->store.seed (seed, transaction);
810  	ASSERT_EQ (seed.to_string (), test_application->clipboard ()->text ().toStdString ());
811  }
812  TEST (wallet, import_locked)
813  {
814  	nano_qt::eventloop_processor processor;
815  	nano::test::system system (1);
816  	auto key1 (system.wallet (0)->deterministic_insert ());
817  	{
818  		auto transaction (system.wallet (0)->wallets.tx_begin_write ());
819  		system.wallet (0)->store.rekey (transaction, "1");
820  	}
821  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), key1));
822  	wallet->start ();
823  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
824  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
825  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
826  	ASSERT_EQ (wallet->accounts.window, wallet->main_stack->currentWidget ());
827  	nano::raw_key seed1;
828  	seed1.clear ();
829  	QTest::keyClicks (wallet->import.seed, seed1.to_string ().c_str ());
830  	QTest::keyClicks (wallet->import.clear_line, "clear keys");
831  	{
832  		auto transaction (system.wallet (0)->wallets.tx_begin_write ());
833  		system.wallet (0)->enter_password (transaction, "");
834  	}
835  	QTest::mouseClick (wallet->import.import_seed, Qt::LeftButton);
836  	nano::raw_key seed2;
837  	{
838  		auto transaction (system.wallet (0)->wallets.tx_begin_write ());
839  		system.wallet (0)->store.seed (seed2, transaction);
840  		ASSERT_NE (seed1, seed2);
841  		system.wallet (0)->enter_password (transaction, "1");
842  	}
843  	QTest::mouseClick (wallet->import.import_seed, Qt::LeftButton);
844  	nano::raw_key seed3;
845  	auto transaction (system.wallet (0)->wallets.tx_begin_read ());
846  	system.wallet (0)->store.seed (seed3, transaction);
847  	ASSERT_EQ (seed1, seed3);
848  }
849  TEST (wallet, DISABLED_synchronizing)
850  {
851  	nano_qt::eventloop_processor processor;
852  	nano::test::system system0 (1);
853  	nano::test::system system1 (1);
854  	auto key1 (system0.wallet (0)->deterministic_insert ());
855  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system0.nodes[0], system0.wallet (0), key1));
856  	wallet->start ();
857  	{
858  		auto transaction (system1.nodes[0]->store.tx_begin_write ());
859  		auto latest (system1.nodes[0]->ledger.latest (transaction, nano::dev::genesis->account ()));
860  		nano::send_block send (latest, key1, 0, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system1.work.generate (latest));
861  		system1.nodes[0]->ledger.process (transaction, send);
862  	}
863  	ASSERT_EQ (0, wallet->active_status.active.count (nano_qt::status_types::synchronizing));
864  	system0.nodes[0]->bootstrap_initiator.bootstrap (system1.nodes[0]->network.endpoint ());
865  	system1.deadline_set (10s);
866  	while (wallet->active_status.active.count (nano_qt::status_types::synchronizing) == 0)
867  	{
868  		ASSERT_NO_ERROR (system0.poll ());
869  		ASSERT_NO_ERROR (system1.poll ());
870  		test_application->processEvents ();
871  	}
872  	system1.deadline_set (25s);
873  	while (wallet->active_status.active.count (nano_qt::status_types::synchronizing) == 1)
874  	{
875  		ASSERT_NO_ERROR (system0.poll ());
876  		ASSERT_NO_ERROR (system1.poll ());
877  		test_application->processEvents ();
878  	}
879  }
880  TEST (wallet, epoch_2_validation)
881  {
882  	nano_qt::eventloop_processor processor;
883  	nano::test::system system (1);
884  	auto & node = system.nodes[0];
885  	ASSERT_NE (nullptr, system.upgrade_genesis_epoch (*node, nano::epoch::epoch_1));
886  	ASSERT_NE (nullptr, system.upgrade_genesis_epoch (*node, nano::epoch::epoch_2));
887  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
888  	auto account (nano::dev::genesis_key.pub);
889  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *node, system.wallet (0), account));
890  	wallet->start ();
891  	wallet->client_window->show ();
892  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
893  	QTest::mouseClick (wallet->advanced.create_block, Qt::LeftButton);
894  	auto create_and_process = [&] () -> nano::block_hash {
895  		wallet->block_creation.create->click ();
896  		std::string json (wallet->block_creation.block->toPlainText ().toStdString ());
897  		EXPECT_FALSE (json.empty ());
898  		boost::property_tree::ptree tree1;
899  		std::stringstream istream (json);
900  		boost::property_tree::read_json (istream, tree1);
901  		bool error (false);
902  		nano::state_block block (error, tree1);
903  		EXPECT_FALSE (error);
904  		EXPECT_EQ (nano::process_result::progress, node->process (block).code);
905  		return block.hash ();
906  	};
907  	auto do_send = [&] (nano::public_key const & destination) -> nano::block_hash {
908  		wallet->block_creation.send->click ();
909  		wallet->block_creation.account->setText (nano::dev::genesis_key.pub.to_account ().c_str ());
910  		wallet->block_creation.amount->setText ("1");
911  		wallet->block_creation.destination->setText (destination.to_account ().c_str ());
912  		return create_and_process ();
913  	};
914  	auto do_open = [&] (nano::block_hash const & source, nano::public_key const & account) -> nano::block_hash {
915  		wallet->block_creation.open->click ();
916  		wallet->block_creation.source->setText (source.to_string ().c_str ());
917  		wallet->block_creation.representative->setText (account.to_account ().c_str ());
918  		return create_and_process ();
919  	};
920  	auto do_receive = [&] (nano::block_hash const & source) -> nano::block_hash {
921  		wallet->block_creation.receive->click ();
922  		wallet->block_creation.source->setText (source.to_string ().c_str ());
923  		return create_and_process ();
924  	};
925  	auto do_change = [&] (nano::public_key const & account, nano::public_key const & representative) -> nano::block_hash {
926  		wallet->block_creation.change->click ();
927  		wallet->block_creation.account->setText (account.to_account ().c_str ());
928  		wallet->block_creation.representative->setText (representative.to_account ().c_str ());
929  		return create_and_process ();
930  	};
931  	auto tries = 0;
932  	auto max_tries = 20;
933  	while (++tries < max_tries)
934  	{
935  		nano::keypair key;
936  		system.wallet (0)->insert_adhoc (key.prv);
937  		auto send1 = do_send (key.pub);
938  		do_open (send1, key.pub);
939  		auto send2 = do_send (key.pub);
940  		do_receive (send2);
941  		do_change (key.pub, nano::dev::genesis_key.pub);
942  	}
943  }
</code></pre>
        </div>
        <div class="column">
            <h3>nano-node-MDEwOlJlcG9zaXRvcnkxOTM0NzM0MA==-flat-qt_94.cpp</h3>
            <pre><code>1  #include <nano/qt/qt.hpp>
2  #include <nano/test_common/network.hpp>
3  #include <nano/test_common/system.hpp>
4  #include <nano/test_common/testutil.hpp>
5  #include <gtest/gtest.h>
6  #include <boost/property_tree/json_parser.hpp>
7  #include <algorithm>
8  #include <nano/qt_test/QTest>
9  #include <thread>
10  using namespace std::chrono_literals;
11  extern QApplication * test_application;
12  TEST (wallet, construction)
13  {
14  	nano_qt::eventloop_processor processor;
15  	nano::test::system system (1);
16  	auto wallet_l (system.nodes[0]->wallets.create (nano::random_wallet_id ()));
17  	auto key (wallet_l->deterministic_insert ());
18  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], wallet_l, key));
19  	wallet->start ();
20  	std::string account (key.to_account ());
21  	ASSERT_EQ (account, wallet->self.account_text->text ().toStdString ());
22  	ASSERT_EQ (1, wallet->accounts.model->rowCount ());
23  	auto item1 (wallet->accounts.model->item (0, 1));
24  	ASSERT_EQ (key.to_account (), item1->text ().toStdString ());
25  }
26  TEST (wallet, DISABLED_status)
27  {
28  	nano_qt::eventloop_processor processor;
29  	nano::test::system system (1);
30  	auto wallet_l (system.nodes[0]->wallets.create (nano::random_wallet_id ()));
31  	nano::keypair key;
32  	wallet_l->insert_adhoc (key.prv);
33  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], wallet_l, key.pub));
34  	wallet->start ();
35  	auto wallet_has = [wallet] (nano_qt::status_types status_ty) {
36  		return wallet->active_status.active.find (status_ty) != wallet->active_status.active.end ();
37  	};
38  	ASSERT_EQ ("Status: Disconnected, Blocks: 1", wallet->status->text ().toStdString ());
39  	auto outer_node = nano::test::add_outer_node (system);
40  	nano::test::establish_tcp (system, *system.nodes[0], outer_node->network.endpoint ());
41  	ASSERT_FALSE (wallet_has (nano_qt::status_types::synchronizing));
42  	system.deadline_set (25s);
43  	while (!wallet_has (nano_qt::status_types::synchronizing))
44  	{
45  		test_application->processEvents ();
46  		ASSERT_NO_ERROR (system.poll ());
47  	}
48  	system.nodes[0]->network.cleanup (std::chrono::steady_clock::now () + std::chrono::seconds (5));
49  	while (wallet_has (nano_qt::status_types::synchronizing))
50  	{
51  		test_application->processEvents ();
52  	}
53  	ASSERT_TRUE (wallet_has (nano_qt::status_types::disconnected));
54  }
55  TEST (wallet, status_with_peer)
56  {
57  	nano_qt::eventloop_processor processor;
58  	nano::test::system system (2);
59  	auto wallet_l = system.nodes[0]->wallets.create (nano::random_wallet_id ());
60  	nano::keypair key;
61  	wallet_l->insert_adhoc (key.prv);
62  	auto wallet = std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], wallet_l, key.pub);
63  	wallet->start ();
64  	auto wallet_has = [wallet] (nano_qt::status_types status_ty) {
65  		return wallet->active_status.active.find (status_ty) != wallet->active_status.active.end ();
66  	};
67  	ASSERT_FALSE (wallet_has (nano_qt::status_types::synchronizing));
68  	system.deadline_set (25s);
69  	while (!wallet_has (nano_qt::status_types::synchronizing))
70  	{
71  		test_application->processEvents ();
72  		ASSERT_NO_ERROR (system.poll ());
73  	}
74  	system.nodes[0]->network.cleanup (std::chrono::steady_clock::now () + std::chrono::seconds (5));
75  	while (wallet_has (nano_qt::status_types::synchronizing))
76  	{
77  		test_application->processEvents ();
78  		ASSERT_NO_ERROR (system.poll ());
79  	}
80  	ASSERT_TRUE (wallet_has (nano_qt::status_types::nominal));
81  }
82  TEST (wallet, startup_balance)
83  {
84  	nano_qt::eventloop_processor processor;
85  	nano::test::system system (1);
86  	auto wallet_l (system.nodes[0]->wallets.create (nano::random_wallet_id ()));
87  	nano::keypair key;
88  	wallet_l->insert_adhoc (key.prv);
89  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], wallet_l, key.pub));
90  	wallet->needs_balance_refresh = true;
91  	wallet->start ();
92  	wallet->application.processEvents (QEventLoop::AllEvents);
93  	ASSERT_EQ ("Balance: 0 nano", wallet->self.balance_label->text ().toStdString ());
94  }
95  TEST (wallet, select_account)
96  {
97  	nano_qt::eventloop_processor processor;
98  	nano::test::system system (1);
99  	auto wallet_l (system.nodes[0]->wallets.create (nano::random_wallet_id ()));
100  	nano::public_key key1 (wallet_l->deterministic_insert ());
101  	nano::public_key key2 (wallet_l->deterministic_insert ());
102  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], wallet_l, key1));
103  	wallet->start ();
104  	ASSERT_EQ (key1, wallet->account);
105  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
106  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
107  	wallet->accounts.view->selectionModel ()->setCurrentIndex (wallet->accounts.model->index (0, 0), QItemSelectionModel::SelectionFlag::Select);
108  	QTest::mouseClick (wallet->accounts.use_account, Qt::LeftButton);
109  	auto key3 (wallet->account);
110  	wallet->accounts.view->selectionModel ()->setCurrentIndex (wallet->accounts.model->index (1, 0), QItemSelectionModel::SelectionFlag::Select);
111  	QTest::mouseClick (wallet->accounts.use_account, Qt::LeftButton);
112  	auto key4 (wallet->account);
113  	ASSERT_NE (key3, key4);
114  	if (key1 < key2)
115  	{
116  		ASSERT_EQ (key2, key4);
117  	}
118  	else
119  	{
120  		ASSERT_EQ (key1, key4);
121  	}
122  }
123  TEST (wallet, main)
124  {
125  	nano_qt::eventloop_processor processor;
126  	nano::test::system system (1);
127  	auto wallet_l (system.nodes[0]->wallets.create (nano::random_wallet_id ()));
128  	nano::keypair key;
129  	wallet_l->insert_adhoc (key.prv);
130  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], wallet_l, key.pub));
131  	wallet->start ();
132  	ASSERT_EQ (wallet->entry_window, wallet->main_stack->currentWidget ());
133  	QTest::mouseClick (wallet->send_blocks, Qt::LeftButton);
134  	ASSERT_EQ (wallet->send_blocks_window, wallet->main_stack->currentWidget ());
135  	QTest::mouseClick (wallet->send_blocks_back, Qt::LeftButton);
136  	QTest::mouseClick (wallet->settings_button, Qt::LeftButton);
137  	ASSERT_EQ (wallet->settings.window, wallet->main_stack->currentWidget ());
138  	QTest::mouseClick (wallet->settings.back, Qt::LeftButton);
139  	ASSERT_EQ (wallet->entry_window, wallet->main_stack->currentWidget ());
140  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
141  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
142  	QTest::mouseClick (wallet->advanced.show_ledger, Qt::LeftButton);
143  	ASSERT_EQ (wallet->advanced.ledger_window, wallet->main_stack->currentWidget ());
144  	QTest::mouseClick (wallet->advanced.ledger_back, Qt::LeftButton);
145  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
146  	QTest::mouseClick (wallet->advanced.show_peers, Qt::LeftButton);
147  	ASSERT_EQ (wallet->advanced.peers_window, wallet->main_stack->currentWidget ());
148  	QTest::mouseClick (wallet->advanced.peers_back, Qt::LeftButton);
149  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
150  	QTest::mouseClick (wallet->advanced.back, Qt::LeftButton);
151  	ASSERT_EQ (wallet->entry_window, wallet->main_stack->currentWidget ());
152  }
153  TEST (wallet, password_change)
154  {
155  	nano_qt::eventloop_processor processor;
156  	nano::test::system system (1);
157  	nano::account account;
158  	system.wallet (0)->insert_adhoc (nano::keypair ().prv);
159  	{
160  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
161  		account = system.account (transaction, 0);
162  	}
163  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
164  	wallet->start ();
165  	QTest::mouseClick (wallet->settings_button, Qt::LeftButton);
166  	{
167  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
168  		nano::raw_key password1;
169  		nano::raw_key password2;
170  		system.wallet (0)->store.derive_key (password1, transaction, "1");
171  		system.wallet (0)->store.password.value (password2);
172  		ASSERT_NE (password1, password2);
173  	}
174  	QTest::keyClicks (wallet->settings.new_password, "1");
175  	QTest::keyClicks (wallet->settings.retype_password, "1");
176  	QTest::mouseClick (wallet->settings.change, Qt::LeftButton);
177  	{
178  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
179  		nano::raw_key password1;
180  		nano::raw_key password2;
181  		system.wallet (0)->store.derive_key (password1, transaction, "1");
182  		system.wallet (0)->store.password.value (password2);
183  		ASSERT_EQ (password1, password2);
184  	}
185  	ASSERT_EQ ("", wallet->settings.new_password->text ());
186  	ASSERT_EQ ("", wallet->settings.retype_password->text ());
187  }
188  TEST (client, password_nochange)
189  {
190  	nano_qt::eventloop_processor processor;
191  	nano::test::system system (1);
192  	nano::account account;
193  	system.wallet (0)->insert_adhoc (nano::keypair ().prv);
194  	{
195  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
196  		account = system.account (transaction, 0);
197  	}
198  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
199  	wallet->start ();
200  	QTest::mouseClick (wallet->settings_button, Qt::LeftButton);
201  	nano::raw_key password;
202  	password.clear ();
203  	system.deadline_set (10s);
204  	while (password == 0)
205  	{
206  		ASSERT_NO_ERROR (system.poll ());
207  		system.wallet (0)->store.password.value (password);
208  	}
209  	{
210  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
211  		nano::raw_key password1;
212  		system.wallet (0)->store.derive_key (password1, transaction, "");
213  		nano::raw_key password2;
214  		system.wallet (0)->store.password.value (password2);
215  		ASSERT_EQ (password1, password2);
216  	}
217  	QTest::keyClicks (wallet->settings.new_password, "1");
218  	QTest::keyClicks (wallet->settings.retype_password, "2");
219  	QTest::mouseClick (wallet->settings.change, Qt::LeftButton);
220  	{
221  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
222  		nano::raw_key password1;
223  		system.wallet (0)->store.derive_key (password1, transaction, "");
224  		nano::raw_key password2;
225  		system.wallet (0)->store.password.value (password2);
226  		ASSERT_EQ (password1, password2);
227  	}
228  	ASSERT_EQ ("1", wallet->settings.new_password->text ());
229  	ASSERT_EQ ("", wallet->settings.retype_password->text ());
230  }
231  TEST (wallet, enter_password)
232  {
233  	nano_qt::eventloop_processor processor;
234  	nano::test::system system (2);
235  	nano::account account;
236  	system.wallet (0)->insert_adhoc (nano::keypair ().prv);
237  	{
238  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
239  		account = system.account (transaction, 0);
240  	}
241  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
242  	wallet->start ();
243  	ASSERT_NE (-1, wallet->settings.layout->indexOf (wallet->settings.password));
244  	ASSERT_NE (-1, wallet->settings.layout->indexOf (wallet->settings.lock_toggle));
245  	ASSERT_NE (-1, wallet->settings.layout->indexOf (wallet->settings.back));
246  	QTest::mouseClick (wallet->settings.lock_toggle, Qt::LeftButton);
247  	QTest::mouseClick (wallet->settings.lock_toggle, Qt::LeftButton);
248  	test_application->processEvents ();
249  	ASSERT_NE (wallet->status->text ().toStdString ().rfind ("Status: Wallet password empty", 0), std::string::npos);
250  	{
251  		auto transaction (system.nodes[0]->wallets.tx_begin_write ());
252  		ASSERT_FALSE (system.wallet (0)->store.rekey (transaction, "abc"));
253  	}
254  	QTest::mouseClick (wallet->settings_button, Qt::LeftButton);
255  	QTest::mouseClick (wallet->settings.lock_toggle, Qt::LeftButton);
256  	test_application->processEvents ();
257  	ASSERT_NE (wallet->status->text ().toStdString ().rfind ("Status: Wallet locked", 0), std::string::npos);
258  	wallet->settings.new_password->setText ("");
259  	QTest::keyClicks (wallet->settings.password, "abc");
260  	QTest::mouseClick (wallet->settings.lock_toggle, Qt::LeftButton);
261  	test_application->processEvents ();
262  	ASSERT_NE (wallet->status->text ().toStdString ().rfind ("Status: Running", 0), std::string::npos);
263  	ASSERT_EQ ("", wallet->settings.password->text ());
264  }
265  TEST (wallet, send)
266  {
267  	nano_qt::eventloop_processor processor;
268  	nano::test::system system (2);
269  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
270  	nano::public_key key1 (system.wallet (1)->insert_adhoc (nano::keypair ().prv));
271  	auto account (nano::dev::genesis_key.pub);
272  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
273  	wallet->start ();
274  	ASSERT_NE (wallet->rendering_ratio, nano::raw_ratio);
275  	QTest::mouseClick (wallet->send_blocks, Qt::LeftButton);
276  	QTest::keyClicks (wallet->send_account, key1.to_account ().c_str ());
277  	QTest::keyClicks (wallet->send_count, "2.03");
278  	QTest::mouseClick (wallet->send_blocks_send, Qt::LeftButton);
279  	system.deadline_set (10s);
280  	while (wallet->node.balance (key1).is_zero ())
281  	{
282  		ASSERT_NO_ERROR (system.poll ());
283  	}
284  	nano::uint128_t amount (wallet->node.balance (key1));
285  	ASSERT_EQ (2 * wallet->rendering_ratio + (3 * wallet->rendering_ratio / 100), amount);
286  	QTest::mouseClick (wallet->send_blocks_back, Qt::LeftButton);
287  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
288  	QTest::mouseClick (wallet->advanced.show_ledger, Qt::LeftButton);
289  	QTest::mouseClick (wallet->advanced.ledger_refresh, Qt::LeftButton);
290  	ASSERT_EQ (2, wallet->advanced.ledger_model->rowCount ());
291  	ASSERT_EQ (3, wallet->advanced.ledger_model->columnCount ());
292  	auto item (wallet->advanced.ledger_model->itemFromIndex (wallet->advanced.ledger_model->index (0, 1)));
293  	auto other_item (wallet->advanced.ledger_model->itemFromIndex (wallet->advanced.ledger_model->index (1, 1)));
294  	ASSERT_TRUE (("2" == item->text ()) || ("2" == other_item->text ()));
295  }
296  TEST (wallet, send_locked)
297  {
298  	nano_qt::eventloop_processor processor;
299  	nano::test::system system (1);
300  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
301  	nano::keypair key1;
302  	{
303  		auto transaction (system.wallet (0)->wallets.tx_begin_write ());
304  		system.wallet (0)->enter_password (transaction, "0");
305  	}
306  	auto account (nano::dev::genesis_key.pub);
307  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
308  	wallet->start ();
309  	QTest::mouseClick (wallet->send_blocks, Qt::LeftButton);
310  	QTest::keyClicks (wallet->send_account, key1.pub.to_account ().c_str ());
311  	QTest::keyClicks (wallet->send_count, "2");
312  	QTest::mouseClick (wallet->send_blocks_send, Qt::LeftButton);
313  	system.deadline_set (10s);
314  	while (!wallet->send_blocks_send->isEnabled ())
315  	{
316  		test_application->processEvents ();
317  		ASSERT_NO_ERROR (system.poll ());
318  	}
319  }
320  TEST (wallet, DISABLED_process_block)
321  {
322  	nano_qt::eventloop_processor processor;
323  	nano::test::system system (1);
324  	nano::account account;
325  	nano::block_hash latest (system.nodes[0]->latest (nano::dev::genesis->account ()));
326  	system.wallet (0)->insert_adhoc (nano::keypair ().prv);
327  	{
328  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
329  		account = system.account (transaction, 0);
330  	}
331  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
332  	wallet->start ();
333  	ASSERT_EQ ("Process", wallet->block_entry.process->text ());
334  	ASSERT_EQ ("Back", wallet->block_entry.back->text ());
335  	nano::keypair key1;
336  	ASSERT_EQ (wallet->entry_window, wallet->main_stack->currentWidget ());
337  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
338  	QTest::mouseClick (wallet->advanced.enter_block, Qt::LeftButton);
339  	ASSERT_EQ (wallet->block_entry.window, wallet->main_stack->currentWidget ());
340  	nano::send_block send (latest, key1.pub, 0, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (latest));
341  	std::string previous;
342  	send.hashables.previous.encode_hex (previous);
343  	std::string balance;
344  	send.hashables.balance.encode_hex (balance);
345  	std::string signature;
346  	send.signature.encode_hex (signature);
347  	std::string block_json;
348  	send.serialize_json (block_json);
349  	block_json.erase (std::remove (block_json.begin (), block_json.end (), '\n'), block_json.end ());
350  	QTest::keyClicks (wallet->block_entry.block, QString::fromStdString (block_json));
351  	QTest::mouseClick (wallet->block_entry.process, Qt::LeftButton);
352  	{
353  		auto transaction (system.nodes[0]->store.tx_begin_read ());
354  		system.deadline_set (10s);
355  		while (system.nodes[0]->store.block.exists (transaction, send.hash ()))
356  		{
357  			ASSERT_NO_ERROR (system.poll ());
358  		}
359  	}
360  	QTest::mouseClick (wallet->block_entry.back, Qt::LeftButton);
361  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
362  }
363  TEST (wallet, create_send)
364  {
365  	nano_qt::eventloop_processor processor;
366  	nano::keypair key;
367  	nano::test::system system (1);
368  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
369  	system.wallet (0)->insert_adhoc (key.prv);
370  	auto account (nano::dev::genesis_key.pub);
371  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
372  	wallet->start ();
373  	wallet->client_window->show ();
374  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
375  	QTest::mouseClick (wallet->advanced.create_block, Qt::LeftButton);
376  	QTest::mouseClick (wallet->block_creation.send, Qt::LeftButton);
377  	QTest::keyClicks (wallet->block_creation.account, nano::dev::genesis_key.pub.to_account ().c_str ());
378  	QTest::keyClicks (wallet->block_creation.amount, "100000000000000000000");
379  	QTest::keyClicks (wallet->block_creation.destination, key.pub.to_account ().c_str ());
380  	QTest::mouseClick (wallet->block_creation.create, Qt::LeftButton);
381  	std::string json (wallet->block_creation.block->toPlainText ().toStdString ());
382  	ASSERT_FALSE (json.empty ());
383  	boost::property_tree::ptree tree1;
384  	std::stringstream istream (json);
385  	boost::property_tree::read_json (istream, tree1);
386  	bool error (false);
387  	nano::state_block send (error, tree1);
388  	ASSERT_FALSE (error);
389  	ASSERT_EQ (nano::process_result::progress, system.nodes[0]->process (send).code);
390  	ASSERT_EQ (nano::process_result::old, system.nodes[0]->process (send).code);
391  }
392  TEST (wallet, create_open_receive)
393  {
394  	nano_qt::eventloop_processor processor;
395  	nano::keypair key;
396  	nano::test::system system (1);
397  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
398  	system.wallet (0)->send_action (nano::dev::genesis_key.pub, key.pub, 100);
399  	nano::block_hash latest1 (system.nodes[0]->latest (nano::dev::genesis_key.pub));
400  	system.wallet (0)->send_action (nano::dev::genesis_key.pub, key.pub, 100);
401  	nano::block_hash latest2 (system.nodes[0]->latest (nano::dev::genesis_key.pub));
402  	ASSERT_NE (latest1, latest2);
403  	system.wallet (0)->insert_adhoc (key.prv);
404  	auto account (nano::dev::genesis_key.pub);
405  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
406  	wallet->start ();
407  	wallet->client_window->show ();
408  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
409  	QTest::mouseClick (wallet->advanced.create_block, Qt::LeftButton);
410  	wallet->block_creation.open->click ();
411  	QTest::keyClicks (wallet->block_creation.source, latest1.to_string ().c_str ());
412  	QTest::keyClicks (wallet->block_creation.representative, nano::dev::genesis_key.pub.to_account ().c_str ());
413  	QTest::mouseClick (wallet->block_creation.create, Qt::LeftButton);
414  	std::string json1 (wallet->block_creation.block->toPlainText ().toStdString ());
415  	ASSERT_FALSE (json1.empty ());
416  	boost::property_tree::ptree tree1;
417  	std::stringstream istream1 (json1);
418  	boost::property_tree::read_json (istream1, tree1);
419  	bool error (false);
420  	nano::state_block open (error, tree1);
421  	ASSERT_FALSE (error);
422  	ASSERT_EQ (nano::process_result::progress, system.nodes[0]->process (open).code);
423  	ASSERT_EQ (nano::process_result::old, system.nodes[0]->process (open).code);
424  	wallet->block_creation.block->clear ();
425  	wallet->block_creation.source->clear ();
426  	wallet->block_creation.receive->click ();
427  	QTest::keyClicks (wallet->block_creation.source, latest2.to_string ().c_str ());
428  	QTest::mouseClick (wallet->block_creation.create, Qt::LeftButton);
429  	std::string json2 (wallet->block_creation.block->toPlainText ().toStdString ());
430  	ASSERT_FALSE (json2.empty ());
431  	boost::property_tree::ptree tree2;
432  	std::stringstream istream2 (json2);
433  	boost::property_tree::read_json (istream2, tree2);
434  	bool error2 (false);
435  	nano::state_block receive (error2, tree2);
436  	ASSERT_FALSE (error2);
437  	ASSERT_EQ (nano::process_result::progress, system.nodes[0]->process (receive).code);
438  	ASSERT_EQ (nano::process_result::old, system.nodes[0]->process (receive).code);
439  }
440  TEST (wallet, create_change)
441  {
442  	nano_qt::eventloop_processor processor;
443  	nano::keypair key;
444  	nano::test::system system (1);
445  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
446  	auto account (nano::dev::genesis_key.pub);
447  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
448  	wallet->start ();
449  	wallet->client_window->show ();
450  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
451  	QTest::mouseClick (wallet->advanced.create_block, Qt::LeftButton);
452  	wallet->block_creation.change->click ();
453  	QTest::keyClicks (wallet->block_creation.account, nano::dev::genesis_key.pub.to_account ().c_str ());
454  	QTest::keyClicks (wallet->block_creation.representative, key.pub.to_account ().c_str ());
455  	wallet->block_creation.create->click ();
456  	std::string json (wallet->block_creation.block->toPlainText ().toStdString ());
457  	ASSERT_FALSE (json.empty ());
458  	boost::property_tree::ptree tree1;
459  	std::stringstream istream (json);
460  	boost::property_tree::read_json (istream, tree1);
461  	bool error (false);
462  	nano::state_block change (error, tree1);
463  	ASSERT_FALSE (error);
464  	ASSERT_EQ (nano::process_result::progress, system.nodes[0]->process (change).code);
465  	ASSERT_EQ (nano::process_result::old, system.nodes[0]->process (change).code);
466  }
467  TEST (history, short_text)
468  {
469  	if (nano::rocksdb_config::using_rocksdb_in_tests ())
470  	{
471  		return;
472  	}
473  	nano_qt::eventloop_processor processor;
474  	nano::keypair key;
475  	nano::test::system system (1);
476  	system.wallet (0)->insert_adhoc (key.prv);
477  	nano::account account;
478  	{
479  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
480  		account = system.account (transaction, 0);
481  	}
482  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
483  	auto store = nano::make_store (system.nodes[0]->logger, nano::unique_path (), nano::dev::constants);
484  	ASSERT_TRUE (!store->init_error ());
485  	nano::ledger ledger (*store, system.nodes[0]->stats, nano::dev::constants);
486  	{
487  		auto transaction (store->tx_begin_write ());
488  		store->initialize (transaction, ledger.cache, ledger.constants);
489  		nano::keypair key;
490  		auto latest (ledger.latest (transaction, nano::dev::genesis_key.pub));
491  		nano::send_block send (latest, nano::dev::genesis_key.pub, 0, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (latest));
492  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, send).code);
493  		nano::receive_block receive (send.hash (), send.hash (), nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (send.hash ()));
494  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, receive).code);
495  		nano::change_block change (receive.hash (), key.pub, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (receive.hash ()));
496  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, change).code);
497  	}
498  	nano_qt::history history (ledger, nano::dev::genesis_key.pub, *wallet);
499  	history.refresh ();
500  	ASSERT_EQ (4, history.model->rowCount ());
501  }
502  TEST (history, pruned_source)
503  {
504  	if (nano::rocksdb_config::using_rocksdb_in_tests ())
505  	{
506  		return;
507  	}
508  	nano_qt::eventloop_processor processor;
509  	nano::keypair key;
510  	nano::test::system system (1);
511  	system.wallet (0)->insert_adhoc (key.prv);
512  	nano::account account;
513  	{
514  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
515  		account = system.account (transaction, 0);
516  	}
517  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
518  	auto store = nano::make_store (system.nodes[0]->logger, nano::unique_path (), nano::dev::constants);
519  	ASSERT_TRUE (!store->init_error ());
<span onclick='openModal()' class='match'>520  	nano::ledger ledger (*store, system.nodes[0]->stats, nano::dev::constants);
521  	ledger.pruning = true;
</span>522  	nano::block_hash next_pruning;
523  	{
524  		auto transaction (store->tx_begin_write ());
525  		store->initialize (transaction, ledger.cache, nano::dev::constants);
526  		auto latest (ledger.latest (transaction, nano::dev::genesis_key.pub));
527  		nano::send_block send1 (latest, nano::dev::genesis_key.pub, nano::dev::constants.genesis_amount - 100, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (latest));
528  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, send1).code);
529  		nano::send_block send2 (send1.hash (), key.pub, nano::dev::constants.genesis_amount - 200, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (send1.hash ()));
530  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, send2).code);
531  		nano::receive_block receive (send2.hash (), send1.hash (), nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (send2.hash ()));
532  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, receive).code);
533  		nano::open_block open (send2.hash (), key.pub, key.pub, key.prv, key.pub, *system.work.generate (key.pub));
534  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, open).code);
535  		ASSERT_EQ (1, ledger.pruning_action (transaction, send1.hash (), 2));
536  		next_pruning = send2.hash ();
537  	}
538  	nano_qt::history history1 (ledger, nano::dev::genesis_key.pub, *wallet);
539  	history1.refresh ();
540  	ASSERT_EQ (2, history1.model->rowCount ());
541  	nano_qt::history history2 (ledger, key.pub, *wallet);
542  	history2.refresh ();
543  	ASSERT_EQ (1, history2.model->rowCount ());
544  	{
545  		auto transaction (store->tx_begin_write ());
546  		ASSERT_EQ (1, ledger.pruning_action (transaction, next_pruning, 2));
547  	}
548  	history1.refresh ();
549  	ASSERT_EQ (1, history1.model->rowCount ());
550  	history2.refresh ();
551  	ASSERT_EQ (1, history2.model->rowCount ());
552  	{
553  		auto transaction (store->tx_begin_write ());
554  		auto latest (ledger.latest (transaction, nano::dev::genesis_key.pub));
555  		nano::state_block send (nano::dev::genesis_key.pub, latest, nano::dev::genesis_key.pub, nano::dev::constants.genesis_amount - 200, key.pub, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (latest));
556  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, send).code);
557  		auto latest_key (ledger.latest (transaction, key.pub));
558  		nano::state_block receive (key.pub, latest_key, key.pub, 200, send.hash (), key.prv, key.pub, *system.work.generate (latest_key));
559  		ASSERT_EQ (nano::process_result::progress, ledger.process (transaction, receive).code);
560  		ASSERT_EQ (1, ledger.pruning_action (transaction, latest, 2));
561  		ASSERT_EQ (1, ledger.pruning_action (transaction, latest_key, 2));
562  	}
563  	history1.refresh ();
564  	ASSERT_EQ (1, history1.model->rowCount ());
565  	history2.refresh ();
566  	ASSERT_EQ (1, history2.model->rowCount ());
567  }
568  TEST (wallet, startup_work)
569  {
570  	nano_qt::eventloop_processor processor;
571  	nano::keypair key;
572  	nano::test::system system (1);
573  	system.wallet (0)->insert_adhoc (key.prv);
574  	nano::account account;
575  	{
576  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
577  		account = system.account (transaction, 0);
578  	}
579  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
580  	wallet->start ();
581  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
582  	uint64_t work1;
583  	{
584  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
585  		ASSERT_TRUE (wallet->wallet_m->store.work_get (transaction, nano::dev::genesis_key.pub, work1));
586  	}
587  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
588  	QTest::keyClicks (wallet->accounts.account_key_line, "34F0A37AAD20F4A260F0A5B3CB3D7FB50673212263E58A380BC10474BB039CE4");
589  	QTest::mouseClick (wallet->accounts.account_key_button, Qt::LeftButton);
590  	system.deadline_set (10s);
591  	auto again (true);
592  	while (again)
593  	{
594  		ASSERT_NO_ERROR (system.poll ());
595  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
596  		again = wallet->wallet_m->store.work_get (transaction, nano::dev::genesis_key.pub, work1);
597  	}
598  }
599  TEST (wallet, block_viewer)
600  {
601  	nano_qt::eventloop_processor processor;
602  	nano::keypair key;
603  	nano::test::system system (1);
604  	system.wallet (0)->insert_adhoc (key.prv);
605  	nano::account account;
606  	{
607  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
608  		account = system.account (transaction, 0);
609  	}
610  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
611  	wallet->start ();
612  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
613  	ASSERT_NE (-1, wallet->advanced.layout->indexOf (wallet->advanced.block_viewer));
614  	QTest::mouseClick (wallet->advanced.block_viewer, Qt::LeftButton);
615  	ASSERT_EQ (wallet->block_viewer.window, wallet->main_stack->currentWidget ());
616  	nano::block_hash latest (system.nodes[0]->latest (nano::dev::genesis->account ()));
617  	QTest::keyClicks (wallet->block_viewer.hash, latest.to_string ().c_str ());
618  	QTest::mouseClick (wallet->block_viewer.retrieve, Qt::LeftButton);
619  	ASSERT_FALSE (wallet->block_viewer.block->toPlainText ().toStdString ().empty ());
620  	QTest::mouseClick (wallet->block_viewer.back, Qt::LeftButton);
621  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
622  }
623  TEST (wallet, import)
624  {
625  	nano_qt::eventloop_processor processor;
626  	nano::test::system system (2);
627  	std::string json;
628  	nano::keypair key1;
629  	nano::keypair key2;
630  	system.wallet (0)->insert_adhoc (key1.prv);
631  	{
632  		auto transaction (system.nodes[0]->wallets.tx_begin_read ());
633  		system.wallet (0)->store.serialize_json (transaction, json);
634  	}
635  	system.wallet (1)->insert_adhoc (key2.prv);
636  	auto path (nano::unique_path ());
637  	{
638  		std::ofstream stream;
639  		stream.open (path.string ().c_str ());
640  		stream << json;
641  	}
642  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[1], system.wallet (1), key2.pub));
643  	wallet->start ();
644  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
645  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
646  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
647  	ASSERT_EQ (wallet->accounts.window, wallet->main_stack->currentWidget ());
648  	QTest::mouseClick (wallet->accounts.import_wallet, Qt::LeftButton);
649  	ASSERT_EQ (wallet->import.window, wallet->main_stack->currentWidget ());
650  	QTest::keyClicks (wallet->import.filename, path.string ().c_str ());
651  	QTest::keyClicks (wallet->import.password, "");
652  	ASSERT_FALSE (system.wallet (1)->exists (key1.pub));
653  	QTest::mouseClick (wallet->import.perform, Qt::LeftButton);
654  	ASSERT_TRUE (system.wallet (1)->exists (key1.pub));
655  }
656  TEST (wallet, republish)
657  {
658  	nano_qt::eventloop_processor processor;
659  	nano::test::system system (2);
660  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
661  	nano::keypair key;
662  	nano::block_hash hash;
663  	{
664  		auto transaction (system.nodes[0]->store.tx_begin_write ());
665  		auto latest (system.nodes[0]->ledger.latest (transaction, nano::dev::genesis_key.pub));
666  		nano::send_block block (latest, key.pub, 0, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system.work.generate (latest));
667  		hash = block.hash ();
668  		ASSERT_EQ (nano::process_result::progress, system.nodes[0]->ledger.process (transaction, block).code);
669  	}
670  	auto account (nano::dev::genesis_key.pub);
671  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), account));
672  	wallet->start ();
673  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
674  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
675  	QTest::mouseClick (wallet->advanced.block_viewer, Qt::LeftButton);
676  	ASSERT_EQ (wallet->block_viewer.window, wallet->main_stack->currentWidget ());
677  	QTest::keyClicks (wallet->block_viewer.hash, hash.to_string ().c_str ());
678  	QTest::mouseClick (wallet->block_viewer.rebroadcast, Qt::LeftButton);
679  	ASSERT_FALSE (system.nodes[1]->balance (nano::dev::genesis_key.pub).is_zero ());
680  	system.deadline_set (10s);
681  	while (system.nodes[1]->balance (nano::dev::genesis_key.pub).is_zero ())
682  	{
683  		ASSERT_NO_ERROR (system.poll ());
684  	}
685  }
686  TEST (wallet, ignore_empty_adhoc)
687  {
688  	nano_qt::eventloop_processor processor;
689  	nano::test::system system (1);
690  	nano::keypair key1;
691  	system.wallet (0)->insert_adhoc (key1.prv);
692  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), key1.pub));
693  	wallet->start ();
694  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
695  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
696  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
697  	ASSERT_EQ (wallet->accounts.window, wallet->main_stack->currentWidget ());
698  	QTest::keyClicks (wallet->accounts.account_key_line, nano::dev::genesis_key.prv.to_string ().c_str ());
699  	QTest::mouseClick (wallet->accounts.account_key_button, Qt::LeftButton);
700  	ASSERT_EQ (1, wallet->accounts.model->rowCount ());
701  	ASSERT_EQ (0, wallet->accounts.account_key_line->text ().length ());
702  	nano::keypair key;
703  	QTest::keyClicks (wallet->accounts.account_key_line, key.prv.to_string ().c_str ());
704  	QTest::mouseClick (wallet->accounts.account_key_button, Qt::LeftButton);
705  	ASSERT_EQ (1, wallet->accounts.model->rowCount ());
706  	ASSERT_EQ (0, wallet->accounts.account_key_line->text ().length ());
707  	QTest::mouseClick (wallet->accounts.create_account, Qt::LeftButton);
708  	test_application->processEvents ();
709  	test_application->processEvents ();
710  	ASSERT_EQ (2, wallet->accounts.model->rowCount ());
711  }
712  TEST (wallet, change_seed)
713  {
714  	nano_qt::eventloop_processor processor;
715  	nano::test::system system (1);
716  	auto key1 (system.wallet (0)->deterministic_insert ());
717  	system.wallet (0)->deterministic_insert ();
718  	nano::raw_key seed3;
719  	{
720  		auto transaction (system.wallet (0)->wallets.tx_begin_read ());
721  		system.wallet (0)->store.seed (seed3, transaction);
722  	}
723  	auto wallet_key (key1);
724  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), wallet_key));
725  	wallet->start ();
726  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
727  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
728  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
729  	ASSERT_EQ (wallet->accounts.window, wallet->main_stack->currentWidget ());
730  	QTest::mouseClick (wallet->accounts.import_wallet, Qt::LeftButton);
731  	ASSERT_EQ (wallet->import.window, wallet->main_stack->currentWidget ());
732  	nano::raw_key seed;
733  	seed.clear ();
734  	QTest::keyClicks (wallet->import.seed, seed.to_string ().c_str ());
735  	nano::raw_key seed1;
736  	{
737  		auto transaction (system.wallet (0)->wallets.tx_begin_read ());
738  		system.wallet (0)->store.seed (seed1, transaction);
739  	}
740  	ASSERT_NE (seed, seed1);
741  	ASSERT_TRUE (system.wallet (0)->exists (key1));
742  	ASSERT_EQ (2, wallet->accounts.model->rowCount ());
743  	QTest::mouseClick (wallet->import.import_seed, Qt::LeftButton);
744  	ASSERT_EQ (2, wallet->accounts.model->rowCount ());
745  	QTest::keyClicks (wallet->import.clear_line, "clear keys");
746  	QTest::mouseClick (wallet->import.import_seed, Qt::LeftButton);
747  	ASSERT_EQ (1, wallet->accounts.model->rowCount ());
748  	ASSERT_TRUE (wallet->import.clear_line->text ().toStdString ().empty ());
749  	nano::raw_key seed2;
750  	auto transaction (system.wallet (0)->wallets.tx_begin_read ());
751  	system.wallet (0)->store.seed (seed2, transaction);
752  	ASSERT_EQ (seed, seed2);
753  	ASSERT_FALSE (system.wallet (0)->exists (key1));
754  	ASSERT_NE (key1, wallet->account);
755  	auto key2 (wallet->account);
756  	ASSERT_TRUE (system.wallet (0)->exists (key2));
757  	QTest::keyClicks (wallet->import.seed, seed3.to_string ().c_str ());
758  	QTest::keyClicks (wallet->import.clear_line, "clear keys");
759  	QTest::mouseClick (wallet->import.import_seed, Qt::LeftButton);
760  	ASSERT_EQ (key1, wallet->account);
761  	ASSERT_FALSE (system.wallet (0)->exists (key2));
762  	ASSERT_TRUE (system.wallet (0)->exists (key1));
763  }
764  TEST (wallet, seed_work_generation)
765  {
766  	nano_qt::eventloop_processor processor;
767  	nano::test::system system (1);
768  	auto key1 (system.wallet (0)->deterministic_insert ());
769  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), key1));
770  	wallet->start ();
771  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
772  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
773  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
774  	ASSERT_EQ (wallet->accounts.window, wallet->main_stack->currentWidget ());
775  	QTest::mouseClick (wallet->accounts.import_wallet, Qt::LeftButton);
776  	ASSERT_EQ (wallet->import.window, wallet->main_stack->currentWidget ());
777  	nano::raw_key seed;
778  	auto prv = nano::deterministic_key (seed, 0);
779  	auto pub (nano::pub_key (prv));
780  	QTest::keyClicks (wallet->import.seed, seed.to_string ().c_str ());
781  	QTest::keyClicks (wallet->import.clear_line, "clear keys");
782  	uint64_t work (0);
783  	QTest::mouseClick (wallet->import.import_seed, Qt::LeftButton);
784  	system.deadline_set (10s);
785  	while (work == 0)
786  	{
787  		auto ec = system.poll ();
788  		auto transaction (system.wallet (0)->wallets.tx_begin_read ());
789  		system.wallet (0)->store.work_get (transaction, pub, work);
790  		ASSERT_NO_ERROR (ec);
791  	}
792  	auto transaction (system.nodes[0]->store.tx_begin_read ());
793  	ASSERT_GE (nano::dev::network_params.work.difficulty (nano::work_version::work_1, system.nodes[0]->ledger.latest_root (transaction, pub), work), system.nodes[0]->default_difficulty (nano::work_version::work_1));
794  }
795  TEST (wallet, backup_seed)
796  {
797  	nano_qt::eventloop_processor processor;
798  	nano::test::system system (1);
799  	auto key1 (system.wallet (0)->deterministic_insert ());
800  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), key1));
801  	wallet->start ();
802  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
803  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
804  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
805  	ASSERT_EQ (wallet->accounts.window, wallet->main_stack->currentWidget ());
806  	QTest::mouseClick (wallet->accounts.backup_seed, Qt::LeftButton);
807  	nano::raw_key seed;
808  	auto transaction (system.wallet (0)->wallets.tx_begin_read ());
809  	system.wallet (0)->store.seed (seed, transaction);
810  	ASSERT_EQ (seed.to_string (), test_application->clipboard ()->text ().toStdString ());
811  }
812  TEST (wallet, import_locked)
813  {
814  	nano_qt::eventloop_processor processor;
815  	nano::test::system system (1);
816  	auto key1 (system.wallet (0)->deterministic_insert ());
817  	{
818  		auto transaction (system.wallet (0)->wallets.tx_begin_write ());
819  		system.wallet (0)->store.rekey (transaction, "1");
820  	}
821  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system.nodes[0], system.wallet (0), key1));
822  	wallet->start ();
823  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
824  	ASSERT_EQ (wallet->advanced.window, wallet->main_stack->currentWidget ());
825  	QTest::mouseClick (wallet->accounts_button, Qt::LeftButton);
826  	ASSERT_EQ (wallet->accounts.window, wallet->main_stack->currentWidget ());
827  	nano::raw_key seed1;
828  	seed1.clear ();
829  	QTest::keyClicks (wallet->import.seed, seed1.to_string ().c_str ());
830  	QTest::keyClicks (wallet->import.clear_line, "clear keys");
831  	{
832  		auto transaction (system.wallet (0)->wallets.tx_begin_write ());
833  		system.wallet (0)->enter_password (transaction, "");
834  	}
835  	QTest::mouseClick (wallet->import.import_seed, Qt::LeftButton);
836  	nano::raw_key seed2;
837  	{
838  		auto transaction (system.wallet (0)->wallets.tx_begin_write ());
839  		system.wallet (0)->store.seed (seed2, transaction);
840  		ASSERT_NE (seed1, seed2);
841  		system.wallet (0)->enter_password (transaction, "1");
842  	}
843  	QTest::mouseClick (wallet->import.import_seed, Qt::LeftButton);
844  	nano::raw_key seed3;
845  	auto transaction (system.wallet (0)->wallets.tx_begin_read ());
846  	system.wallet (0)->store.seed (seed3, transaction);
847  	ASSERT_EQ (seed1, seed3);
848  }
849  TEST (wallet, DISABLED_synchronizing)
850  {
851  	nano_qt::eventloop_processor processor;
852  	nano::test::system system0 (1);
853  	nano::test::system system1 (1);
854  	auto key1 (system0.wallet (0)->deterministic_insert ());
855  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *system0.nodes[0], system0.wallet (0), key1));
856  	wallet->start ();
857  	{
858  		auto transaction (system1.nodes[0]->store.tx_begin_write ());
859  		auto latest (system1.nodes[0]->ledger.latest (transaction, nano::dev::genesis->account ()));
860  		nano::send_block send (latest, key1, 0, nano::dev::genesis_key.prv, nano::dev::genesis_key.pub, *system1.work.generate (latest));
861  		system1.nodes[0]->ledger.process (transaction, send);
862  	}
863  	ASSERT_EQ (0, wallet->active_status.active.count (nano_qt::status_types::synchronizing));
864  	system0.nodes[0]->bootstrap_initiator.bootstrap (system1.nodes[0]->network.endpoint ());
865  	system1.deadline_set (10s);
866  	while (wallet->active_status.active.count (nano_qt::status_types::synchronizing) == 0)
867  	{
868  		ASSERT_NO_ERROR (system0.poll ());
869  		ASSERT_NO_ERROR (system1.poll ());
870  		test_application->processEvents ();
871  	}
872  	system1.deadline_set (25s);
873  	while (wallet->active_status.active.count (nano_qt::status_types::synchronizing) == 1)
874  	{
875  		ASSERT_NO_ERROR (system0.poll ());
876  		ASSERT_NO_ERROR (system1.poll ());
877  		test_application->processEvents ();
878  	}
879  }
880  TEST (wallet, epoch_2_validation)
881  {
882  	nano_qt::eventloop_processor processor;
883  	nano::test::system system (1);
884  	auto & node = system.nodes[0];
885  	ASSERT_NE (nullptr, system.upgrade_genesis_epoch (*node, nano::epoch::epoch_1));
886  	ASSERT_NE (nullptr, system.upgrade_genesis_epoch (*node, nano::epoch::epoch_2));
887  	system.wallet (0)->insert_adhoc (nano::dev::genesis_key.prv);
888  	auto account (nano::dev::genesis_key.pub);
889  	auto wallet (std::make_shared<nano_qt::wallet> (*test_application, processor, *node, system.wallet (0), account));
890  	wallet->start ();
891  	wallet->client_window->show ();
892  	QTest::mouseClick (wallet->show_advanced, Qt::LeftButton);
893  	QTest::mouseClick (wallet->advanced.create_block, Qt::LeftButton);
894  	auto create_and_process = [&] () -> nano::block_hash {
895  		wallet->block_creation.create->click ();
896  		std::string json (wallet->block_creation.block->toPlainText ().toStdString ());
897  		EXPECT_FALSE (json.empty ());
898  		boost::property_tree::ptree tree1;
899  		std::stringstream istream (json);
900  		boost::property_tree::read_json (istream, tree1);
901  		bool error (false);
902  		nano::state_block block (error, tree1);
903  		EXPECT_FALSE (error);
904  		EXPECT_EQ (nano::process_result::progress, node->process (block).code);
905  		return block.hash ();
906  	};
907  	auto do_send = [&] (nano::public_key const & destination) -> nano::block_hash {
908  		wallet->block_creation.send->click ();
909  		wallet->block_creation.account->setText (nano::dev::genesis_key.pub.to_account ().c_str ());
910  		wallet->block_creation.amount->setText ("1");
911  		wallet->block_creation.destination->setText (destination.to_account ().c_str ());
912  		return create_and_process ();
913  	};
914  	auto do_open = [&] (nano::block_hash const & source, nano::public_key const & account) -> nano::block_hash {
915  		wallet->block_creation.open->click ();
916  		wallet->block_creation.source->setText (source.to_string ().c_str ());
917  		wallet->block_creation.representative->setText (account.to_account ().c_str ());
918  		return create_and_process ();
919  	};
920  	auto do_receive = [&] (nano::block_hash const & source) -> nano::block_hash {
921  		wallet->block_creation.receive->click ();
922  		wallet->block_creation.source->setText (source.to_string ().c_str ());
923  		return create_and_process ();
924  	};
925  	auto do_change = [&] (nano::public_key const & account, nano::public_key const & representative) -> nano::block_hash {
926  		wallet->block_creation.change->click ();
927  		wallet->block_creation.account->setText (account.to_account ().c_str ());
928  		wallet->block_creation.representative->setText (representative.to_account ().c_str ());
929  		return create_and_process ();
930  	};
931  	auto tries = 0;
932  	auto max_tries = 20;
933  	while (++tries < max_tries)
934  	{
935  		nano::keypair key;
936  		system.wallet (0)->insert_adhoc (key.prv);
937  		auto send1 = do_send (key.pub);
938  		do_open (send1, key.pub);
939  		auto send2 = do_send (key.pub);
940  		do_receive (send2);
941  		do_change (key.pub, nano::dev::genesis_key.pub);
942  	}
943  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from nano-node-MDEwOlJlcG9zaXRvcnkxOTM0NzM0MA==-flat-qt_94.cpp</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from nano-node-MDEwOlJlcG9zaXRvcnkxOTM0NzM0MA==-flat-qt_94.cpp</div>
                </div>
                <div class="column column_space"><pre><code>485  	nano::ledger ledger (*store, system.nodes[0]->stats, nano::dev::constants);
486  	{
</pre></code></div>
                <div class="column column_space"><pre><code>520  	nano::ledger ledger (*store, system.nodes[0]->stats, nano::dev::constants);
521  	ledger.pruning = true;
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    