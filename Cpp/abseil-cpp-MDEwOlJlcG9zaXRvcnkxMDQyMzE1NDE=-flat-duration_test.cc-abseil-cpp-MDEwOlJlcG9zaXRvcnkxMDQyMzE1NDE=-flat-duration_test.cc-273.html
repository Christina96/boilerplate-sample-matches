
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 18, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-duration_test.cc</h3>
            <pre><code>1  #if defined(_MSC_VER)
2  #include &lt;winsock2.h&gt;  
3  #endif
4  #include &lt;array&gt;
5  #include &lt;cfloat&gt;
6  #include &lt;chrono&gt;  
7  #include &lt;cmath&gt;
8  #include &lt;cstdint&gt;
9  #include &lt;ctime&gt;
10  #include &lt;iomanip&gt;
11  #include &lt;limits&gt;
12  #include &lt;random&gt;
13  #include &lt;string&gt;
14  #include &quot;gmock/gmock.h&quot;
15  #include &quot;gtest/gtest.h&quot;
16  #include &quot;absl/strings/str_format.h&quot;
17  #include &quot;absl/time/time.h&quot;
18  namespace {
19  constexpr int64_t kint64max = std::numeric_limits&lt;int64_t&gt;::max();
20  constexpr int64_t kint64min = std::numeric_limits&lt;int64_t&gt;::min();
21  absl::Duration ApproxYears(int64_t n) { return absl::Hours(n) * 365 * 24; }
22  MATCHER_P(TimespecMatcher, ts, &quot;&quot;) {
23    if (ts.tv_sec == arg.tv_sec &amp;&amp; ts.tv_nsec == arg.tv_nsec)
24      return true;
25    *result_listener &lt;&lt; &quot;expected: {&quot; &lt;&lt; ts.tv_sec &lt;&lt; &quot;, &quot; &lt;&lt; ts.tv_nsec &lt;&lt; &quot;} &quot;;
26    *result_listener &lt;&lt; &quot;actual: {&quot; &lt;&lt; arg.tv_sec &lt;&lt; &quot;, &quot; &lt;&lt; arg.tv_nsec &lt;&lt; &quot;}&quot;;
27    return false;
28  }
29  MATCHER_P(TimevalMatcher, tv, &quot;&quot;) {
30    if (tv.tv_sec == arg.tv_sec &amp;&amp; tv.tv_usec == arg.tv_usec)
31      return true;
32    *result_listener &lt;&lt; &quot;expected: {&quot; &lt;&lt; tv.tv_sec &lt;&lt; &quot;, &quot; &lt;&lt; tv.tv_usec &lt;&lt; &quot;} &quot;;
33    *result_listener &lt;&lt; &quot;actual: {&quot; &lt;&lt; arg.tv_sec &lt;&lt; &quot;, &quot; &lt;&lt; arg.tv_usec &lt;&lt; &quot;}&quot;;
34    return false;
35  }
36  TEST(Duration, ConstExpr) {
37    constexpr absl::Duration d0 = absl::ZeroDuration();
38    static_assert(d0 == absl::ZeroDuration(), &quot;ZeroDuration()&quot;);
39    constexpr absl::Duration d1 = absl::Seconds(1);
40    static_assert(d1 == absl::Seconds(1), &quot;Seconds(1)&quot;);
41    static_assert(d1 != absl::ZeroDuration(), &quot;Seconds(1)&quot;);
42    constexpr absl::Duration d2 = absl::InfiniteDuration();
43    static_assert(d2 == absl::InfiniteDuration(), &quot;InfiniteDuration()&quot;);
44    static_assert(d2 != absl::ZeroDuration(), &quot;InfiniteDuration()&quot;);
45  }
46  TEST(Duration, ValueSemantics) {
47    constexpr absl::Duration a;      
48    constexpr absl::Duration b = a;  
49    constexpr absl::Duration c(b);   
50    absl::Duration d;
51    d = c;  
52  }
53  TEST(Duration, Factories) {
54    constexpr absl::Duration zero = absl::ZeroDuration();
55    constexpr absl::Duration nano = absl::Nanoseconds(1);
56    constexpr absl::Duration micro = absl::Microseconds(1);
57    constexpr absl::Duration milli = absl::Milliseconds(1);
58    constexpr absl::Duration sec = absl::Seconds(1);
59    constexpr absl::Duration min = absl::Minutes(1);
60    constexpr absl::Duration hour = absl::Hours(1);
61    EXPECT_EQ(zero, absl::Duration());
62    EXPECT_EQ(zero, absl::Seconds(0));
63    EXPECT_EQ(nano, absl::Nanoseconds(1));
64    EXPECT_EQ(micro, absl::Nanoseconds(1000));
65    EXPECT_EQ(milli, absl::Microseconds(1000));
66    EXPECT_EQ(sec, absl::Milliseconds(1000));
67    EXPECT_EQ(min, absl::Seconds(60));
68    EXPECT_EQ(hour, absl::Minutes(60));
69    const absl::Duration inf = absl::InfiniteDuration();
70    EXPECT_GT(inf, absl::Seconds(kint64max));
71    EXPECT_LT(-inf, absl::Seconds(kint64min));
72    EXPECT_LT(-inf, absl::Seconds(-kint64max));
73    EXPECT_EQ(inf, absl::Minutes(kint64max));
74    EXPECT_EQ(-inf, absl::Minutes(kint64min));
75    EXPECT_EQ(-inf, absl::Minutes(-kint64max));
76    EXPECT_GT(inf, absl::Minutes(kint64max / 60));
77    EXPECT_LT(-inf, absl::Minutes(kint64min / 60));
78    EXPECT_LT(-inf, absl::Minutes(-kint64max / 60));
79    EXPECT_EQ(inf, absl::Hours(kint64max));
80    EXPECT_EQ(-inf, absl::Hours(kint64min));
81    EXPECT_EQ(-inf, absl::Hours(-kint64max));
82    EXPECT_GT(inf, absl::Hours(kint64max / 3600));
83    EXPECT_LT(-inf, absl::Hours(kint64min / 3600));
84    EXPECT_LT(-inf, absl::Hours(-kint64max / 3600));
85  }
86  TEST(Duration, ToConversion) {
87  #define TEST_DURATION_CONVERSION(UNIT)                                  \
88    do {                                                                  \
89      const absl::Duration d = absl::UNIT(1.5);                           \
90      constexpr absl::Duration z = absl::ZeroDuration();                  \
91      constexpr absl::Duration inf = absl::InfiniteDuration();            \
92      constexpr double dbl_inf = std::numeric_limits&lt;double&gt;::infinity(); \
93      EXPECT_EQ(kint64min, absl::ToInt64##UNIT(-inf));                    \
94      EXPECT_EQ(-1, absl::ToInt64##UNIT(-d));                             \
95      EXPECT_EQ(0, absl::ToInt64##UNIT(z));                               \
96      EXPECT_EQ(1, absl::ToInt64##UNIT(d));                               \
97      EXPECT_EQ(kint64max, absl::ToInt64##UNIT(inf));                     \
98      EXPECT_EQ(-dbl_inf, absl::ToDouble##UNIT(-inf));                    \
99      EXPECT_EQ(-1.5, absl::ToDouble##UNIT(-d));                          \
100      EXPECT_EQ(0, absl::ToDouble##UNIT(z));                              \
101      EXPECT_EQ(1.5, absl::ToDouble##UNIT(d));                            \
102      EXPECT_EQ(dbl_inf, absl::ToDouble##UNIT(inf));                      \
103    } while (0)
104    TEST_DURATION_CONVERSION(Nanoseconds);
105    TEST_DURATION_CONVERSION(Microseconds);
106    TEST_DURATION_CONVERSION(Milliseconds);
107    TEST_DURATION_CONVERSION(Seconds);
108    TEST_DURATION_CONVERSION(Minutes);
109    TEST_DURATION_CONVERSION(Hours);
110  #undef TEST_DURATION_CONVERSION
111  }
112  template &lt;int64_t N&gt;
113  void TestToConversion() {
114    constexpr absl::Duration nano = absl::Nanoseconds(N);
115    EXPECT_EQ(N, absl::ToInt64Nanoseconds(nano));
116    EXPECT_EQ(0, absl::ToInt64Microseconds(nano));
117    EXPECT_EQ(0, absl::ToInt64Milliseconds(nano));
118    EXPECT_EQ(0, absl::ToInt64Seconds(nano));
119    EXPECT_EQ(0, absl::ToInt64Minutes(nano));
120    EXPECT_EQ(0, absl::ToInt64Hours(nano));
121    const absl::Duration micro = absl::Microseconds(N);
122    EXPECT_EQ(N * 1000, absl::ToInt64Nanoseconds(micro));
123    EXPECT_EQ(N, absl::ToInt64Microseconds(micro));
124    EXPECT_EQ(0, absl::ToInt64Milliseconds(micro));
125    EXPECT_EQ(0, absl::ToInt64Seconds(micro));
126    EXPECT_EQ(0, absl::ToInt64Minutes(micro));
127    EXPECT_EQ(0, absl::ToInt64Hours(micro));
128    const absl::Duration milli = absl::Milliseconds(N);
129    EXPECT_EQ(N * 1000 * 1000, absl::ToInt64Nanoseconds(milli));
130    EXPECT_EQ(N * 1000, absl::ToInt64Microseconds(milli));
131    EXPECT_EQ(N, absl::ToInt64Milliseconds(milli));
132    EXPECT_EQ(0, absl::ToInt64Seconds(milli));
133    EXPECT_EQ(0, absl::ToInt64Minutes(milli));
134    EXPECT_EQ(0, absl::ToInt64Hours(milli));
135    const absl::Duration sec = absl::Seconds(N);
136    EXPECT_EQ(N * 1000 * 1000 * 1000, absl::ToInt64Nanoseconds(sec));
137    EXPECT_EQ(N * 1000 * 1000, absl::ToInt64Microseconds(sec));
138    EXPECT_EQ(N * 1000, absl::ToInt64Milliseconds(sec));
139    EXPECT_EQ(N, absl::ToInt64Seconds(sec));
140    EXPECT_EQ(0, absl::ToInt64Minutes(sec));
141    EXPECT_EQ(0, absl::ToInt64Hours(sec));
142    const absl::Duration min = absl::Minutes(N);
143    EXPECT_EQ(N * 60 * 1000 * 1000 * 1000, absl::ToInt64Nanoseconds(min));
144    EXPECT_EQ(N * 60 * 1000 * 1000, absl::ToInt64Microseconds(min));
145    EXPECT_EQ(N * 60 * 1000, absl::ToInt64Milliseconds(min));
146    EXPECT_EQ(N * 60, absl::ToInt64Seconds(min));
147    EXPECT_EQ(N, absl::ToInt64Minutes(min));
148    EXPECT_EQ(0, absl::ToInt64Hours(min));
149    const absl::Duration hour = absl::Hours(N);
150    EXPECT_EQ(N * 60 * 60 * 1000 * 1000 * 1000, absl::ToInt64Nanoseconds(hour));
151    EXPECT_EQ(N * 60 * 60 * 1000 * 1000, absl::ToInt64Microseconds(hour));
152    EXPECT_EQ(N * 60 * 60 * 1000, absl::ToInt64Milliseconds(hour));
153    EXPECT_EQ(N * 60 * 60, absl::ToInt64Seconds(hour));
154    EXPECT_EQ(N * 60, absl::ToInt64Minutes(hour));
155    EXPECT_EQ(N, absl::ToInt64Hours(hour));
156  }
157  TEST(Duration, ToConversionDeprecated) {
158    TestToConversion&lt;43&gt;();
159    TestToConversion&lt;1&gt;();
160    TestToConversion&lt;0&gt;();
161    TestToConversion&lt;-1&gt;();
162    TestToConversion&lt;-43&gt;();
163  }
164  template &lt;int64_t N&gt;
165  void TestFromChronoBasicEquality() {
166    using std::chrono::nanoseconds;
167    using std::chrono::microseconds;
168    using std::chrono::milliseconds;
169    using std::chrono::seconds;
170    using std::chrono::minutes;
171    using std::chrono::hours;
172    static_assert(absl::Nanoseconds(N) == absl::FromChrono(nanoseconds(N)), &quot;&quot;);
173    static_assert(absl::Microseconds(N) == absl::FromChrono(microseconds(N)), &quot;&quot;);
174    static_assert(absl::Milliseconds(N) == absl::FromChrono(milliseconds(N)), &quot;&quot;);
175    static_assert(absl::Seconds(N) == absl::FromChrono(seconds(N)), &quot;&quot;);
176    static_assert(absl::Minutes(N) == absl::FromChrono(minutes(N)), &quot;&quot;);
177    static_assert(absl::Hours(N) == absl::FromChrono(hours(N)), &quot;&quot;);
178  }
179  TEST(Duration, FromChrono) {
180    TestFromChronoBasicEquality&lt;-123&gt;();
181    TestFromChronoBasicEquality&lt;-1&gt;();
182    TestFromChronoBasicEquality&lt;0&gt;();
183    TestFromChronoBasicEquality&lt;1&gt;();
184    TestFromChronoBasicEquality&lt;123&gt;();
185    const auto chrono_minutes_max = std::chrono::minutes::max();
186    const auto minutes_max = absl::FromChrono(chrono_minutes_max);
187    const int64_t minutes_max_count = chrono_minutes_max.count();
188    if (minutes_max_count &gt; kint64max / 60) {
189      EXPECT_EQ(absl::InfiniteDuration(), minutes_max);
190    } else {
191      EXPECT_EQ(absl::Minutes(minutes_max_count), minutes_max);
192    }
193    const auto chrono_minutes_min = std::chrono::minutes::min();
194    const auto minutes_min = absl::FromChrono(chrono_minutes_min);
195    const int64_t minutes_min_count = chrono_minutes_min.count();
196    if (minutes_min_count &lt; kint64min / 60) {
197      EXPECT_EQ(-absl::InfiniteDuration(), minutes_min);
198    } else {
199      EXPECT_EQ(absl::Minutes(minutes_min_count), minutes_min);
200    }
201    const auto chrono_hours_max = std::chrono::hours::max();
202    const auto hours_max = absl::FromChrono(chrono_hours_max);
203    const int64_t hours_max_count = chrono_hours_max.count();
204    if (hours_max_count &gt; kint64max / 3600) {
205      EXPECT_EQ(absl::InfiniteDuration(), hours_max);
206    } else {
207      EXPECT_EQ(absl::Hours(hours_max_count), hours_max);
208    }
209    const auto chrono_hours_min = std::chrono::hours::min();
210    const auto hours_min = absl::FromChrono(chrono_hours_min);
211    const int64_t hours_min_count = chrono_hours_min.count();
212    if (hours_min_count &lt; kint64min / 3600) {
213      EXPECT_EQ(-absl::InfiniteDuration(), hours_min);
214    } else {
215      EXPECT_EQ(absl::Hours(hours_min_count), hours_min);
216    }
217  }
218  template &lt;int64_t N&gt;
219  void TestToChrono() {
220    using std::chrono::nanoseconds;
221    using std::chrono::microseconds;
222    using std::chrono::milliseconds;
223    using std::chrono::seconds;
224    using std::chrono::minutes;
225    using std::chrono::hours;
226    EXPECT_EQ(nanoseconds(N), absl::ToChronoNanoseconds(absl::Nanoseconds(N)));
227    EXPECT_EQ(microseconds(N), absl::ToChronoMicroseconds(absl::Microseconds(N)));
228    EXPECT_EQ(milliseconds(N), absl::ToChronoMilliseconds(absl::Milliseconds(N)));
229    EXPECT_EQ(seconds(N), absl::ToChronoSeconds(absl::Seconds(N)));
230    constexpr auto absl_minutes = absl::Minutes(N);
231    auto chrono_minutes = minutes(N);
232    if (absl_minutes == -absl::InfiniteDuration()) {
233      chrono_minutes = minutes::min();
234    } else if (absl_minutes == absl::InfiniteDuration()) {
235      chrono_minutes = minutes::max();
236    }
237    EXPECT_EQ(chrono_minutes, absl::ToChronoMinutes(absl_minutes));
238    constexpr auto absl_hours = absl::Hours(N);
239    auto chrono_hours = hours(N);
240    if (absl_hours == -absl::InfiniteDuration()) {
241      chrono_hours = hours::min();
242    } else if (absl_hours == absl::InfiniteDuration()) {
243      chrono_hours = hours::max();
244    }
245    EXPECT_EQ(chrono_hours, absl::ToChronoHours(absl_hours));
246  }
247  TEST(Duration, ToChrono) {
248    using std::chrono::nanoseconds;
249    using std::chrono::microseconds;
250    using std::chrono::milliseconds;
251    using std::chrono::seconds;
252    using std::chrono::minutes;
253    using std::chrono::hours;
254    TestToChrono&lt;kint64min&gt;();
255    TestToChrono&lt;-1&gt;();
256    TestToChrono&lt;0&gt;();
257    TestToChrono&lt;1&gt;();
258    TestToChrono&lt;kint64max&gt;();
259    const auto tick = absl::Nanoseconds(1) / 4;
260    EXPECT_EQ(nanoseconds(0), absl::ToChronoNanoseconds(tick));
261    EXPECT_EQ(nanoseconds(0), absl::ToChronoNanoseconds(-tick));
262    EXPECT_EQ(microseconds(0), absl::ToChronoMicroseconds(tick));
263    EXPECT_EQ(microseconds(0), absl::ToChronoMicroseconds(-tick));
264    EXPECT_EQ(milliseconds(0), absl::ToChronoMilliseconds(tick));
265    EXPECT_EQ(milliseconds(0), absl::ToChronoMilliseconds(-tick));
266    EXPECT_EQ(seconds(0), absl::ToChronoSeconds(tick));
267    EXPECT_EQ(seconds(0), absl::ToChronoSeconds(-tick));
268    EXPECT_EQ(minutes(0), absl::ToChronoMinutes(tick));
269    EXPECT_EQ(minutes(0), absl::ToChronoMinutes(-tick));
270    EXPECT_EQ(hours(0), absl::ToChronoHours(tick));
271    EXPECT_EQ(hours(0), absl::ToChronoHours(-tick));
272    constexpr auto inf = absl::InfiniteDuration();
273    EXPECT_EQ(nanoseconds::min(), absl::ToChronoNanoseconds(-inf));
274    EXPECT_EQ(nanoseconds::max(), absl::ToChronoNanoseconds(inf));
275    EXPECT_EQ(microseconds::min(), absl::ToChronoMicroseconds(-inf));
276    EXPECT_EQ(microseconds::max(), absl::ToChronoMicroseconds(inf));
277    EXPECT_EQ(milliseconds::min(), absl::ToChronoMilliseconds(-inf));
278    EXPECT_EQ(milliseconds::max(), absl::ToChronoMilliseconds(inf));
279    EXPECT_EQ(seconds::min(), absl::ToChronoSeconds(-inf));
280    EXPECT_EQ(seconds::max(), absl::ToChronoSeconds(inf));
281    EXPECT_EQ(minutes::min(), absl::ToChronoMinutes(-inf));
282    EXPECT_EQ(minutes::max(), absl::ToChronoMinutes(inf));
283    EXPECT_EQ(hours::min(), absl::ToChronoHours(-inf));
284    EXPECT_EQ(hours::max(), absl::ToChronoHours(inf));
285  }
286  TEST(Duration, FactoryOverloads) {
287    enum E { kOne = 1 };
288  #define TEST_FACTORY_OVERLOADS(NAME)                                          \
289    EXPECT_EQ(1, NAME(kOne) / NAME(kOne));                                      \
290    EXPECT_EQ(1, NAME(static_cast&lt;int8_t&gt;(1)) / NAME(1));                       \
291    EXPECT_EQ(1, NAME(static_cast&lt;int16_t&gt;(1)) / NAME(1));                      \
292    EXPECT_EQ(1, NAME(static_cast&lt;int32_t&gt;(1)) / NAME(1));                      \
293    EXPECT_EQ(1, NAME(static_cast&lt;int64_t&gt;(1)) / NAME(1));                      \
294    EXPECT_EQ(1, NAME(static_cast&lt;uint8_t&gt;(1)) / NAME(1));                      \
295    EXPECT_EQ(1, NAME(static_cast&lt;uint16_t&gt;(1)) / NAME(1));                     \
296    EXPECT_EQ(1, NAME(static_cast&lt;uint32_t&gt;(1)) / NAME(1));                     \
297    EXPECT_EQ(1, NAME(static_cast&lt;uint64_t&gt;(1)) / NAME(1));                     \
298    EXPECT_EQ(NAME(1) / 2, NAME(static_cast&lt;float&gt;(0.5)));                      \
299    EXPECT_EQ(NAME(1) / 2, NAME(static_cast&lt;double&gt;(0.5)));                     \
300    EXPECT_EQ(1.5, absl::FDivDuration(NAME(static_cast&lt;float&gt;(1.5)), NAME(1))); \
301    EXPECT_EQ(1.5, absl::FDivDuration(NAME(static_cast&lt;double&gt;(1.5)), NAME(1)));
302    TEST_FACTORY_OVERLOADS(absl::Nanoseconds);
303    TEST_FACTORY_OVERLOADS(absl::Microseconds);
304    TEST_FACTORY_OVERLOADS(absl::Milliseconds);
305    TEST_FACTORY_OVERLOADS(absl::Seconds);
306    TEST_FACTORY_OVERLOADS(absl::Minutes);
307    TEST_FACTORY_OVERLOADS(absl::Hours);
308  #undef TEST_FACTORY_OVERLOADS
309    EXPECT_EQ(absl::Milliseconds(1500), absl::Seconds(1.5));
310    EXPECT_LT(absl::Nanoseconds(1), absl::Nanoseconds(1.5));
311    EXPECT_GT(absl::Nanoseconds(2), absl::Nanoseconds(1.5));
312    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
313    EXPECT_EQ(absl::InfiniteDuration(), absl::Nanoseconds(dbl_inf));
314    EXPECT_EQ(absl::InfiniteDuration(), absl::Microseconds(dbl_inf));
315    EXPECT_EQ(absl::InfiniteDuration(), absl::Milliseconds(dbl_inf));
316    EXPECT_EQ(absl::InfiniteDuration(), absl::Seconds(dbl_inf));
317    EXPECT_EQ(absl::InfiniteDuration(), absl::Minutes(dbl_inf));
318    EXPECT_EQ(absl::InfiniteDuration(), absl::Hours(dbl_inf));
319    EXPECT_EQ(-absl::InfiniteDuration(), absl::Nanoseconds(-dbl_inf));
320    EXPECT_EQ(-absl::InfiniteDuration(), absl::Microseconds(-dbl_inf));
321    EXPECT_EQ(-absl::InfiniteDuration(), absl::Milliseconds(-dbl_inf));
322    EXPECT_EQ(-absl::InfiniteDuration(), absl::Seconds(-dbl_inf));
323    EXPECT_EQ(-absl::InfiniteDuration(), absl::Minutes(-dbl_inf));
324    EXPECT_EQ(-absl::InfiniteDuration(), absl::Hours(-dbl_inf));
325  }
326  TEST(Duration, InfinityExamples) {
327    constexpr absl::Duration inf = absl::InfiniteDuration();
328    constexpr absl::Duration d = absl::Seconds(1);  
329    EXPECT_TRUE(inf == inf + inf);
330    EXPECT_TRUE(inf == inf + d);
331    EXPECT_TRUE(inf == inf - inf);
332    EXPECT_TRUE(-inf == d - inf);
333    EXPECT_TRUE(inf == d * 1e100);
334    EXPECT_TRUE(0 == d / inf);  
335    EXPECT_TRUE(inf == d / 0);
336    EXPECT_TRUE(kint64max == d / absl::ZeroDuration());
337  }
338  TEST(Duration, InfinityComparison) {
339    const absl::Duration inf = absl::InfiniteDuration();
340    const absl::Duration any_dur = absl::Seconds(1);
341    EXPECT_EQ(inf, inf);
342    EXPECT_EQ(-inf, -inf);
343    EXPECT_NE(inf, -inf);
344    EXPECT_NE(any_dur, inf);
345    EXPECT_NE(any_dur, -inf);
346    EXPECT_GT(inf, any_dur);
347    EXPECT_LT(-inf, any_dur);
348    EXPECT_LT(-inf, inf);
349    EXPECT_GT(inf, -inf);
350  }
351  TEST(Duration, InfinityAddition) {
352    const absl::Duration sec_max = absl::Seconds(kint64max);
353    const absl::Duration sec_min = absl::Seconds(kint64min);
354    const absl::Duration any_dur = absl::Seconds(1);
355    const absl::Duration inf = absl::InfiniteDuration();
356    EXPECT_EQ(inf, inf + inf);
357    EXPECT_EQ(inf, inf + -inf);
358    EXPECT_EQ(-inf, -inf + inf);
359    EXPECT_EQ(-inf, -inf + -inf);
360    EXPECT_EQ(inf, inf + any_dur);
361    EXPECT_EQ(inf, any_dur + inf);
362    EXPECT_EQ(-inf, -inf + any_dur);
363    EXPECT_EQ(-inf, any_dur + -inf);
364    absl::Duration almost_inf = sec_max + absl::Nanoseconds(999999999);
365    EXPECT_GT(inf, almost_inf);
366    almost_inf += -absl::Nanoseconds(999999999);
367    EXPECT_GT(inf, almost_inf);
368    EXPECT_EQ(inf, sec_max + absl::Seconds(1));
369    EXPECT_EQ(inf, sec_max + sec_max);
370    EXPECT_EQ(-inf, sec_min + -absl::Seconds(1));
371    EXPECT_EQ(-inf, sec_min + -sec_max);
372    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
373    EXPECT_TRUE(std::isinf(dbl_inf + dbl_inf));
374    EXPECT_TRUE(std::isnan(dbl_inf + -dbl_inf));  
375    EXPECT_TRUE(std::isnan(-dbl_inf + dbl_inf));  
376    EXPECT_TRUE(std::isinf(-dbl_inf + -dbl_inf));
377  }
378  TEST(Duration, InfinitySubtraction) {
379    const absl::Duration sec_max = absl::Seconds(kint64max);
380    const absl::Duration sec_min = absl::Seconds(kint64min);
381    const absl::Duration any_dur = absl::Seconds(1);
382    const absl::Duration inf = absl::InfiniteDuration();
383    EXPECT_EQ(inf, inf - inf);
384    EXPECT_EQ(inf, inf - -inf);
385    EXPECT_EQ(-inf, -inf - inf);
386    EXPECT_EQ(-inf, -inf - -inf);
387    EXPECT_EQ(inf, inf - any_dur);
388    EXPECT_EQ(-inf, any_dur - inf);
389    EXPECT_EQ(-inf, -inf - any_dur);
390    EXPECT_EQ(inf, any_dur - -inf);
391    EXPECT_EQ(inf, sec_max - -absl::Seconds(1));
392    EXPECT_EQ(inf, sec_max - -sec_max);
393    EXPECT_EQ(-inf, sec_min - absl::Seconds(1));
394    EXPECT_EQ(-inf, sec_min - sec_max);
395    absl::Duration almost_neg_inf = sec_min;
396    EXPECT_LT(-inf, almost_neg_inf);
397    almost_neg_inf -= -absl::Nanoseconds(1);
398    EXPECT_LT(-inf, almost_neg_inf);
399    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
400    EXPECT_TRUE(std::isnan(dbl_inf - dbl_inf));  
401    EXPECT_TRUE(std::isinf(dbl_inf - -dbl_inf));
402    EXPECT_TRUE(std::isinf(-dbl_inf - dbl_inf));
403    EXPECT_TRUE(std::isnan(-dbl_inf - -dbl_inf));  
404  }
405  TEST(Duration, InfinityMultiplication) {
406    const absl::Duration sec_max = absl::Seconds(kint64max);
407    const absl::Duration sec_min = absl::Seconds(kint64min);
408    const absl::Duration inf = absl::InfiniteDuration();
409  #define TEST_INF_MUL_WITH_TYPE(T)                                     \
410    EXPECT_EQ(inf, inf * static_cast&lt;T&gt;(2));                            \
<span onclick='openModal()' class='match'>411    EXPECT_EQ(-inf, inf * static_cast&lt;T&gt;(-2));                          \
412    EXPECT_EQ(-inf, -inf * static_cast&lt;T&gt;(2));                          \
</span>413    EXPECT_EQ(inf, -inf * static_cast&lt;T&gt;(-2));                          \
414    EXPECT_EQ(inf, inf * static_cast&lt;T&gt;(0));                            \
415    EXPECT_EQ(-inf, -inf * static_cast&lt;T&gt;(0));                          \
416    EXPECT_EQ(inf, sec_max * static_cast&lt;T&gt;(2));                        \
417    EXPECT_EQ(inf, sec_min * static_cast&lt;T&gt;(-2));                       \
418    EXPECT_EQ(inf, (sec_max / static_cast&lt;T&gt;(2)) * static_cast&lt;T&gt;(3));  \
419    EXPECT_EQ(-inf, sec_max * static_cast&lt;T&gt;(-2));                      \
420    EXPECT_EQ(-inf, sec_min * static_cast&lt;T&gt;(2));                       \
421    EXPECT_EQ(-inf, (sec_min / static_cast&lt;T&gt;(2)) * static_cast&lt;T&gt;(3));
422    TEST_INF_MUL_WITH_TYPE(int64_t);  
423    TEST_INF_MUL_WITH_TYPE(double);   
424  #undef TEST_INF_MUL_WITH_TYPE
425    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
426    EXPECT_EQ(inf, inf * dbl_inf);
427    EXPECT_EQ(-inf, -inf * dbl_inf);
428    EXPECT_EQ(-inf, inf * -dbl_inf);
429    EXPECT_EQ(inf, -inf * -dbl_inf);
430    const absl::Duration any_dur = absl::Seconds(1);
431    EXPECT_EQ(inf, any_dur * dbl_inf);
432    EXPECT_EQ(-inf, -any_dur * dbl_inf);
433    EXPECT_EQ(-inf, any_dur * -dbl_inf);
434    EXPECT_EQ(inf, -any_dur * -dbl_inf);
435    EXPECT_NE(absl::InfiniteDuration(), absl::Seconds(1) * kint64max);
436    EXPECT_EQ(inf, absl::Seconds(1) * static_cast&lt;double&gt;(kint64max));
437    EXPECT_NE(-absl::InfiniteDuration(), absl::Seconds(1) * kint64min);
438    EXPECT_EQ(-inf, absl::Seconds(1) * static_cast&lt;double&gt;(kint64min));
439    EXPECT_NE(inf, sec_max);
440    EXPECT_NE(inf, sec_max / 1);
441    EXPECT_EQ(inf, sec_max / 1.0);
442    EXPECT_NE(inf, sec_max * 1);
443    EXPECT_EQ(inf, sec_max * 1.0);
444  }
445  TEST(Duration, InfinityDivision) {
446    const absl::Duration sec_max = absl::Seconds(kint64max);
447    const absl::Duration sec_min = absl::Seconds(kint64min);
448    const absl::Duration inf = absl::InfiniteDuration();
449  #define TEST_INF_DIV_WITH_TYPE(T)            \
450    EXPECT_EQ(inf, inf / static_cast&lt;T&gt;(2));   \
451    EXPECT_EQ(-inf, inf / static_cast&lt;T&gt;(-2)); \
452    EXPECT_EQ(-inf, -inf / static_cast&lt;T&gt;(2)); \
453    EXPECT_EQ(inf, -inf / static_cast&lt;T&gt;(-2));
454    TEST_INF_DIV_WITH_TYPE(int64_t);  
455    TEST_INF_DIV_WITH_TYPE(double);   
456  #undef TEST_INF_DIV_WITH_TYPE
457    EXPECT_EQ(inf, sec_max / 0.5);
458    EXPECT_EQ(inf, sec_min / -0.5);
459    EXPECT_EQ(inf, ((sec_max / 0.5) + absl::Seconds(1)) / 0.5);
460    EXPECT_EQ(-inf, sec_max / -0.5);
461    EXPECT_EQ(-inf, sec_min / 0.5);
462    EXPECT_EQ(-inf, ((sec_min / 0.5) - absl::Seconds(1)) / 0.5);
463    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
464    EXPECT_EQ(inf, inf / dbl_inf);
465    EXPECT_EQ(-inf, inf / -dbl_inf);
466    EXPECT_EQ(-inf, -inf / dbl_inf);
467    EXPECT_EQ(inf, -inf / -dbl_inf);
468    const absl::Duration any_dur = absl::Seconds(1);
469    EXPECT_EQ(absl::ZeroDuration(), any_dur / dbl_inf);
470    EXPECT_EQ(absl::ZeroDuration(), any_dur / -dbl_inf);
471    EXPECT_EQ(absl::ZeroDuration(), -any_dur / dbl_inf);
472    EXPECT_EQ(absl::ZeroDuration(), -any_dur / -dbl_inf);
473  }
474  TEST(Duration, InfinityModulus) {
475    const absl::Duration sec_max = absl::Seconds(kint64max);
476    const absl::Duration any_dur = absl::Seconds(1);
477    const absl::Duration inf = absl::InfiniteDuration();
478    EXPECT_EQ(inf, inf % inf);
479    EXPECT_EQ(inf, inf % -inf);
480    EXPECT_EQ(-inf, -inf % -inf);
481    EXPECT_EQ(-inf, -inf % inf);
482    EXPECT_EQ(any_dur, any_dur % inf);
483    EXPECT_EQ(any_dur, any_dur % -inf);
484    EXPECT_EQ(-any_dur, -any_dur % inf);
485    EXPECT_EQ(-any_dur, -any_dur % -inf);
486    EXPECT_EQ(inf, inf % -any_dur);
487    EXPECT_EQ(inf, inf % any_dur);
488    EXPECT_EQ(-inf, -inf % -any_dur);
489    EXPECT_EQ(-inf, -inf % any_dur);
490    EXPECT_EQ(absl::ZeroDuration(), sec_max % absl::Seconds(1));
491    EXPECT_EQ(absl::ZeroDuration(), sec_max % absl::Milliseconds(1));
492    EXPECT_EQ(absl::ZeroDuration(), sec_max % absl::Microseconds(1));
493    EXPECT_EQ(absl::ZeroDuration(), sec_max % absl::Nanoseconds(1));
494    EXPECT_EQ(absl::ZeroDuration(), sec_max % absl::Nanoseconds(1) / 4);
495  }
496  TEST(Duration, InfinityIDiv) {
497    const absl::Duration sec_max = absl::Seconds(kint64max);
498    const absl::Duration any_dur = absl::Seconds(1);
499    const absl::Duration inf = absl::InfiniteDuration();
500    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
501    absl::Duration rem = absl::ZeroDuration();
502    EXPECT_EQ(kint64max, absl::IDivDuration(inf, inf, &amp;rem));
503    EXPECT_EQ(inf, rem);
504    rem = absl::ZeroDuration();
505    EXPECT_EQ(kint64max, absl::IDivDuration(-inf, -inf, &amp;rem));
506    EXPECT_EQ(-inf, rem);
507    rem = absl::ZeroDuration();
508    EXPECT_EQ(kint64max, absl::IDivDuration(inf, any_dur, &amp;rem));
509    EXPECT_EQ(inf, rem);
510    rem = absl::ZeroDuration();
511    EXPECT_EQ(0, absl::IDivDuration(any_dur, inf, &amp;rem));
512    EXPECT_EQ(any_dur, rem);
513    rem = absl::ZeroDuration();
514    EXPECT_EQ(kint64max, absl::IDivDuration(-inf, -any_dur, &amp;rem));
515    EXPECT_EQ(-inf, rem);
516    rem = absl::ZeroDuration();
517    EXPECT_EQ(0, absl::IDivDuration(-any_dur, -inf, &amp;rem));
518    EXPECT_EQ(-any_dur, rem);
519    rem = absl::ZeroDuration();
520    EXPECT_EQ(kint64min, absl::IDivDuration(-inf, inf, &amp;rem));
521    EXPECT_EQ(-inf, rem);
522    rem = absl::ZeroDuration();
523    EXPECT_EQ(kint64min, absl::IDivDuration(inf, -inf, &amp;rem));
524    EXPECT_EQ(inf, rem);
525    rem = absl::ZeroDuration();
526    EXPECT_EQ(kint64min, absl::IDivDuration(-inf, any_dur, &amp;rem));
527    EXPECT_EQ(-inf, rem);
528    rem = absl::ZeroDuration();
529    EXPECT_EQ(0, absl::IDivDuration(-any_dur, inf, &amp;rem));
530    EXPECT_EQ(-any_dur, rem);
531    rem = absl::ZeroDuration();
532    EXPECT_EQ(kint64min, absl::IDivDuration(inf, -any_dur, &amp;rem));
533    EXPECT_EQ(inf, rem);
534    rem = absl::ZeroDuration();
535    EXPECT_EQ(0, absl::IDivDuration(any_dur, -inf, &amp;rem));
536    EXPECT_EQ(any_dur, rem);
537    rem = any_dur;
538    EXPECT_EQ(kint64max,
539              absl::IDivDuration(sec_max, absl::Nanoseconds(1) / 4, &amp;rem));
540    EXPECT_EQ(sec_max - absl::Nanoseconds(kint64max) / 4, rem);
541    rem = any_dur;
542    EXPECT_EQ(kint64max,
543              absl::IDivDuration(sec_max, absl::Milliseconds(1), &amp;rem));
544    EXPECT_EQ(sec_max - absl::Milliseconds(kint64max), rem);
545    rem = any_dur;
546    EXPECT_EQ(kint64max,
547              absl::IDivDuration(-sec_max, -absl::Milliseconds(1), &amp;rem));
548    EXPECT_EQ(-sec_max + absl::Milliseconds(kint64max), rem);
549    rem = any_dur;
550    EXPECT_EQ(kint64min,
551              absl::IDivDuration(-sec_max, absl::Milliseconds(1), &amp;rem));
552    EXPECT_EQ(-sec_max - absl::Milliseconds(kint64min), rem);
553    rem = any_dur;
554    EXPECT_EQ(kint64min,
555              absl::IDivDuration(sec_max, -absl::Milliseconds(1), &amp;rem));
556    EXPECT_EQ(sec_max + absl::Milliseconds(kint64min), rem);
557    EXPECT_TRUE(std::isnan(dbl_inf / dbl_inf));
558    EXPECT_EQ(kint64max, inf / inf);
559    EXPECT_EQ(kint64max, -inf / -inf);
560    EXPECT_EQ(kint64min, -inf / inf);
561    EXPECT_EQ(kint64min, inf / -inf);
562    EXPECT_TRUE(std::isinf(dbl_inf / 2.0));
563    EXPECT_EQ(kint64max, inf / any_dur);
564    EXPECT_EQ(kint64max, -inf / -any_dur);
565    EXPECT_EQ(kint64min, -inf / any_dur);
566    EXPECT_EQ(kint64min, inf / -any_dur);
567    EXPECT_EQ(0.0, 2.0 / dbl_inf);
568    EXPECT_EQ(0, any_dur / inf);
569    EXPECT_EQ(0, any_dur / -inf);
570    EXPECT_EQ(0, -any_dur / inf);
571    EXPECT_EQ(0, -any_dur / -inf);
572    EXPECT_EQ(0, absl::ZeroDuration() / inf);
573    EXPECT_EQ(kint64max, sec_max / absl::Milliseconds(1));
574    EXPECT_EQ(kint64max, -sec_max / -absl::Milliseconds(1));
575    EXPECT_EQ(kint64min, -sec_max / absl::Milliseconds(1));
576    EXPECT_EQ(kint64min, sec_max / -absl::Milliseconds(1));
577  }
578  TEST(Duration, InfinityFDiv) {
579    const absl::Duration any_dur = absl::Seconds(1);
580    const absl::Duration inf = absl::InfiniteDuration();
581    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
582    EXPECT_EQ(dbl_inf, absl::FDivDuration(inf, inf));
583    EXPECT_EQ(dbl_inf, absl::FDivDuration(-inf, -inf));
584    EXPECT_EQ(dbl_inf, absl::FDivDuration(inf, any_dur));
585    EXPECT_EQ(0.0, absl::FDivDuration(any_dur, inf));
586    EXPECT_EQ(dbl_inf, absl::FDivDuration(-inf, -any_dur));
587    EXPECT_EQ(0.0, absl::FDivDuration(-any_dur, -inf));
588    EXPECT_EQ(-dbl_inf, absl::FDivDuration(-inf, inf));
589    EXPECT_EQ(-dbl_inf, absl::FDivDuration(inf, -inf));
590    EXPECT_EQ(-dbl_inf, absl::FDivDuration(-inf, any_dur));
591    EXPECT_EQ(0.0, absl::FDivDuration(-any_dur, inf));
592    EXPECT_EQ(-dbl_inf, absl::FDivDuration(inf, -any_dur));
593    EXPECT_EQ(0.0, absl::FDivDuration(any_dur, -inf));
594  }
595  TEST(Duration, DivisionByZero) {
596    const absl::Duration zero = absl::ZeroDuration();
597    const absl::Duration inf = absl::InfiniteDuration();
598    const absl::Duration any_dur = absl::Seconds(1);
599    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
600    const double dbl_denorm = std::numeric_limits&lt;double&gt;::denorm_min();
601    EXPECT_EQ(inf, zero / 0.0);
602    EXPECT_EQ(-inf, zero / -0.0);
603    EXPECT_EQ(inf, any_dur / 0.0);
604    EXPECT_EQ(-inf, any_dur / -0.0);
605    EXPECT_EQ(-inf, -any_dur / 0.0);
606    EXPECT_EQ(inf, -any_dur / -0.0);
607    EXPECT_EQ(zero, zero / dbl_denorm);
608    EXPECT_EQ(zero, zero / -dbl_denorm);
609    EXPECT_EQ(inf, any_dur / dbl_denorm);
610    EXPECT_EQ(-inf, any_dur / -dbl_denorm);
611    EXPECT_EQ(-inf, -any_dur / dbl_denorm);
612    EXPECT_EQ(inf, -any_dur / -dbl_denorm);
613    absl::Duration rem = zero;
614    EXPECT_EQ(kint64max, absl::IDivDuration(zero, zero, &amp;rem));
615    EXPECT_EQ(inf, rem);
616    rem = zero;
617    EXPECT_EQ(kint64max, absl::IDivDuration(any_dur, zero, &amp;rem));
618    EXPECT_EQ(inf, rem);
619    rem = zero;
620    EXPECT_EQ(kint64min, absl::IDivDuration(-any_dur, zero, &amp;rem));
621    EXPECT_EQ(-inf, rem);
622    EXPECT_EQ(kint64max, zero / zero);
623    EXPECT_EQ(kint64max, any_dur / zero);
624    EXPECT_EQ(kint64min, -any_dur / zero);
625    EXPECT_EQ(dbl_inf, absl::FDivDuration(zero, zero));
626    EXPECT_EQ(dbl_inf, absl::FDivDuration(any_dur, zero));
627    EXPECT_EQ(-dbl_inf, absl::FDivDuration(-any_dur, zero));
628  }
629  TEST(Duration, NaN) {
630  #define TEST_NAN_HANDLING(NAME, NAN)           \
631    do {                                         \
632      const auto inf = absl::InfiniteDuration(); \
633      auto x = NAME(NAN);                        \
634      EXPECT_TRUE(x == inf || x == -inf);        \
635      auto y = NAME(42);                         \
636      y *= NAN;                                  \
637      EXPECT_TRUE(y == inf || y == -inf);        \
638      auto z = NAME(42);                         \
639      z /= NAN;                                  \
640      EXPECT_TRUE(z == inf || z == -inf);        \
641    } while (0)
642    const double nan = std::numeric_limits&lt;double&gt;::quiet_NaN();
643    TEST_NAN_HANDLING(absl::Nanoseconds, nan);
644    TEST_NAN_HANDLING(absl::Microseconds, nan);
645    TEST_NAN_HANDLING(absl::Milliseconds, nan);
646    TEST_NAN_HANDLING(absl::Seconds, nan);
647    TEST_NAN_HANDLING(absl::Minutes, nan);
648    TEST_NAN_HANDLING(absl::Hours, nan);
649    TEST_NAN_HANDLING(absl::Nanoseconds, -nan);
650    TEST_NAN_HANDLING(absl::Microseconds, -nan);
651    TEST_NAN_HANDLING(absl::Milliseconds, -nan);
652    TEST_NAN_HANDLING(absl::Seconds, -nan);
653    TEST_NAN_HANDLING(absl::Minutes, -nan);
654    TEST_NAN_HANDLING(absl::Hours, -nan);
655  #undef TEST_NAN_HANDLING
656  }
657  TEST(Duration, Range) {
658    const absl::Duration range = ApproxYears(100 * 1e9);
659    const absl::Duration range_future = range;
660    const absl::Duration range_past = -range;
661    EXPECT_LT(range_future, absl::InfiniteDuration());
662    EXPECT_GT(range_past, -absl::InfiniteDuration());
663    const absl::Duration full_range = range_future - range_past;
664    EXPECT_GT(full_range, absl::ZeroDuration());
665    EXPECT_LT(full_range, absl::InfiniteDuration());
666    const absl::Duration neg_full_range = range_past - range_future;
667    EXPECT_LT(neg_full_range, absl::ZeroDuration());
668    EXPECT_GT(neg_full_range, -absl::InfiniteDuration());
669    EXPECT_LT(neg_full_range, full_range);
670    EXPECT_EQ(neg_full_range, -full_range);
671  }
672  TEST(Duration, RelationalOperators) {
673  #define TEST_REL_OPS(UNIT)               \
674    static_assert(UNIT(2) == UNIT(2), &quot;&quot;); \
675    static_assert(UNIT(1) != UNIT(2), &quot;&quot;); \
676    static_assert(UNIT(1) &lt; UNIT(2), &quot;&quot;);  \
677    static_assert(UNIT(3) &gt; UNIT(2), &quot;&quot;);  \
678    static_assert(UNIT(1) &lt;= UNIT(2), &quot;&quot;); \
679    static_assert(UNIT(2) &lt;= UNIT(2), &quot;&quot;); \
680    static_assert(UNIT(3) &gt;= UNIT(2), &quot;&quot;); \
681    static_assert(UNIT(2) &gt;= UNIT(2), &quot;&quot;);
682    TEST_REL_OPS(absl::Nanoseconds);
683    TEST_REL_OPS(absl::Microseconds);
684    TEST_REL_OPS(absl::Milliseconds);
685    TEST_REL_OPS(absl::Seconds);
686    TEST_REL_OPS(absl::Minutes);
687    TEST_REL_OPS(absl::Hours);
688  #undef TEST_REL_OPS
689  }
690  TEST(Duration, Addition) {
691  #define TEST_ADD_OPS(UNIT)                  \
692    do {                                      \
693      EXPECT_EQ(UNIT(2), UNIT(1) + UNIT(1));  \
694      EXPECT_EQ(UNIT(1), UNIT(2) - UNIT(1));  \
695      EXPECT_EQ(UNIT(0), UNIT(2) - UNIT(2));  \
696      EXPECT_EQ(UNIT(-1), UNIT(1) - UNIT(2)); \
697      EXPECT_EQ(UNIT(-2), UNIT(0) - UNIT(2)); \
698      EXPECT_EQ(UNIT(-2), UNIT(1) - UNIT(3)); \
699      absl::Duration a = UNIT(1);             \
700      a += UNIT(1);                           \
701      EXPECT_EQ(UNIT(2), a);                  \
702      a -= UNIT(1);                           \
703      EXPECT_EQ(UNIT(1), a);                  \
704    } while (0)
705    TEST_ADD_OPS(absl::Nanoseconds);
706    TEST_ADD_OPS(absl::Microseconds);
707    TEST_ADD_OPS(absl::Milliseconds);
708    TEST_ADD_OPS(absl::Seconds);
709    TEST_ADD_OPS(absl::Minutes);
710    TEST_ADD_OPS(absl::Hours);
711  #undef TEST_ADD_OPS
712    EXPECT_EQ(absl::Seconds(2), absl::Seconds(3) - 2 * absl::Milliseconds(500));
713    EXPECT_EQ(absl::Seconds(2) + absl::Milliseconds(500),
714              absl::Seconds(3) - absl::Milliseconds(500));
715    EXPECT_EQ(absl::Seconds(1) + absl::Milliseconds(998),
716              absl::Milliseconds(999) + absl::Milliseconds(999));
717    EXPECT_EQ(absl::Milliseconds(-1),
718              absl::Milliseconds(998) - absl::Milliseconds(999));
719    EXPECT_GT(absl::Nanoseconds(1), absl::Nanoseconds(1) / 2);
720    EXPECT_EQ(absl::Nanoseconds(1),
721              absl::Nanoseconds(1) / 2 + absl::Nanoseconds(1) / 2);
722    EXPECT_GT(absl::Nanoseconds(1) / 4, absl::Nanoseconds(0));
723    EXPECT_EQ(absl::Nanoseconds(1) / 8, absl::Nanoseconds(0));
724    absl::Duration d_7_5 = absl::Seconds(7) + absl::Milliseconds(500);
725    absl::Duration d_3_7 = absl::Seconds(3) + absl::Milliseconds(700);
726    absl::Duration ans_3_8 = absl::Seconds(3) + absl::Milliseconds(800);
727    EXPECT_EQ(ans_3_8, d_7_5 - d_3_7);
728    absl::Duration min_dur = absl::Seconds(kint64min);
729    EXPECT_EQ(absl::Seconds(0), min_dur - min_dur);
730    EXPECT_EQ(absl::Seconds(kint64max), absl::Seconds(-1) - min_dur);
731  }
732  TEST(Duration, Negation) {
733    constexpr absl::Duration negated_zero_duration = -absl::ZeroDuration();
734    EXPECT_EQ(negated_zero_duration, absl::ZeroDuration());
735    constexpr absl::Duration negated_infinite_duration =
736        -absl::InfiniteDuration();
737    EXPECT_NE(negated_infinite_duration, absl::InfiniteDuration());
738    EXPECT_EQ(-negated_infinite_duration, absl::InfiniteDuration());
739    EXPECT_TRUE(
740        absl::time_internal::IsInfiniteDuration(negated_infinite_duration));
741    constexpr absl::Duration max_duration = absl::time_internal::MakeDuration(
742        kint64max, absl::time_internal::kTicksPerSecond - 1);
743    constexpr absl::Duration negated_max_duration = -max_duration;
744    constexpr absl::Duration nearly_min_duration =
745        absl::time_internal::MakeDuration(kint64min, int64_t{1});
746    constexpr absl::Duration negated_nearly_min_duration = -nearly_min_duration;
747    EXPECT_EQ(negated_max_duration, nearly_min_duration);
748    EXPECT_EQ(negated_nearly_min_duration, max_duration);
749    EXPECT_EQ(-(-max_duration), max_duration);
750    constexpr absl::Duration min_duration =
751        absl::time_internal::MakeDuration(kint64min);
752    constexpr absl::Duration negated_min_duration = -min_duration;
753    EXPECT_EQ(negated_min_duration, absl::InfiniteDuration());
754  }
755  TEST(Duration, AbsoluteValue) {
756    EXPECT_EQ(absl::ZeroDuration(), AbsDuration(absl::ZeroDuration()));
757    EXPECT_EQ(absl::Seconds(1), AbsDuration(absl::Seconds(1)));
758    EXPECT_EQ(absl::Seconds(1), AbsDuration(absl::Seconds(-1)));
759    EXPECT_EQ(absl::InfiniteDuration(), AbsDuration(absl::InfiniteDuration()));
760    EXPECT_EQ(absl::InfiniteDuration(), AbsDuration(-absl::InfiniteDuration()));
761    absl::Duration max_dur =
762        absl::Seconds(kint64max) + (absl::Seconds(1) - absl::Nanoseconds(1) / 4);
763    EXPECT_EQ(max_dur, AbsDuration(max_dur));
764    absl::Duration min_dur = absl::Seconds(kint64min);
765    EXPECT_EQ(absl::InfiniteDuration(), AbsDuration(min_dur));
766    EXPECT_EQ(max_dur, AbsDuration(min_dur + absl::Nanoseconds(1) / 4));
767  }
768  TEST(Duration, Multiplication) {
769  #define TEST_MUL_OPS(UNIT)                                    \
770    do {                                                        \
771      EXPECT_EQ(UNIT(5), UNIT(2) * 2.5);                        \
772      EXPECT_EQ(UNIT(2), UNIT(5) / 2.5);                        \
773      EXPECT_EQ(UNIT(-5), UNIT(-2) * 2.5);                      \
774      EXPECT_EQ(UNIT(-5), -UNIT(2) * 2.5);                      \
775      EXPECT_EQ(UNIT(-5), UNIT(2) * -2.5);                      \
776      EXPECT_EQ(UNIT(-2), UNIT(-5) / 2.5);                      \
777      EXPECT_EQ(UNIT(-2), -UNIT(5) / 2.5);                      \
778      EXPECT_EQ(UNIT(-2), UNIT(5) / -2.5);                      \
779      EXPECT_EQ(UNIT(2), UNIT(11) % UNIT(3));                   \
780      absl::Duration a = UNIT(2);                               \
781      a *= 2.5;                                                 \
782      EXPECT_EQ(UNIT(5), a);                                    \
783      a /= 2.5;                                                 \
784      EXPECT_EQ(UNIT(2), a);                                    \
785      a %= UNIT(1);                                             \
786      EXPECT_EQ(UNIT(0), a);                                    \
787      absl::Duration big = UNIT(1000000000);                    \
788      big *= 3;                                                 \
789      big /= 3;                                                 \
790      EXPECT_EQ(UNIT(1000000000), big);                         \
791      EXPECT_EQ(-UNIT(2), -UNIT(2));                            \
792      EXPECT_EQ(-UNIT(2), UNIT(2) * -1);                        \
793      EXPECT_EQ(-UNIT(2), -1 * UNIT(2));                        \
794      EXPECT_EQ(-UNIT(-2), UNIT(2));                            \
795      EXPECT_EQ(2, UNIT(2) / UNIT(1));                          \
796      absl::Duration rem;                                       \
797      EXPECT_EQ(2, absl::IDivDuration(UNIT(2), UNIT(1), &amp;rem)); \
798      EXPECT_EQ(2.0, absl::FDivDuration(UNIT(2), UNIT(1)));     \
799    } while (0)
800    TEST_MUL_OPS(absl::Nanoseconds);
801    TEST_MUL_OPS(absl::Microseconds);
802    TEST_MUL_OPS(absl::Milliseconds);
803    TEST_MUL_OPS(absl::Seconds);
804    TEST_MUL_OPS(absl::Minutes);
805    TEST_MUL_OPS(absl::Hours);
806  #undef TEST_MUL_OPS
807    absl::Duration max_dur =
808        absl::Seconds(kint64max) + (absl::Seconds(1) - absl::Nanoseconds(1) / 4);
809    absl::Duration min_dur = absl::Seconds(kint64min);
810    EXPECT_EQ(max_dur, max_dur * 1);
811    EXPECT_EQ(max_dur, max_dur / 1);
812    EXPECT_EQ(min_dur, min_dur * 1);
813    EXPECT_EQ(min_dur, min_dur / 1);
814    absl::Duration sigfigs = absl::Seconds(2000000000) + absl::Nanoseconds(3);
815    EXPECT_EQ(absl::Seconds(666666666) + absl::Nanoseconds(666666667) +
816                  absl::Nanoseconds(1) / 2,
817              sigfigs / 3);
818    sigfigs = absl::Seconds(int64_t{7000000000});
819    EXPECT_EQ(absl::Seconds(2333333333) + absl::Nanoseconds(333333333) +
820                  absl::Nanoseconds(1) / 4,
821              sigfigs / 3);
822    EXPECT_EQ(absl::Seconds(7) + absl::Milliseconds(500), absl::Seconds(3) * 2.5);
823    EXPECT_EQ(absl::Seconds(8) * -1 + absl::Milliseconds(300),
824              (absl::Seconds(2) + absl::Milliseconds(200)) * -3.5);
825    EXPECT_EQ(-absl::Seconds(8) + absl::Milliseconds(300),
826              (absl::Seconds(2) + absl::Milliseconds(200)) * -3.5);
827    EXPECT_EQ(absl::Seconds(1) + absl::Milliseconds(875),
828              (absl::Seconds(7) + absl::Milliseconds(500)) / 4);
829    EXPECT_EQ(absl::Seconds(30),
830              (absl::Seconds(7) + absl::Milliseconds(500)) / 0.25);
831    EXPECT_EQ(absl::Seconds(3),
832              (absl::Seconds(7) + absl::Milliseconds(500)) / 2.5);
833    EXPECT_EQ(absl::Nanoseconds(0), absl::Nanoseconds(7) % absl::Nanoseconds(1));
834    EXPECT_EQ(absl::Nanoseconds(0), absl::Nanoseconds(0) % absl::Nanoseconds(10));
835    EXPECT_EQ(absl::Nanoseconds(2), absl::Nanoseconds(7) % absl::Nanoseconds(5));
836    EXPECT_EQ(absl::Nanoseconds(2), absl::Nanoseconds(2) % absl::Nanoseconds(5));
837    EXPECT_EQ(absl::Nanoseconds(1), absl::Nanoseconds(10) % absl::Nanoseconds(3));
838    EXPECT_EQ(absl::Nanoseconds(1),
839              absl::Nanoseconds(10) % absl::Nanoseconds(-3));
840    EXPECT_EQ(absl::Nanoseconds(-1),
841              absl::Nanoseconds(-10) % absl::Nanoseconds(3));
842    EXPECT_EQ(absl::Nanoseconds(-1),
843              absl::Nanoseconds(-10) % absl::Nanoseconds(-3));
844    EXPECT_EQ(absl::Milliseconds(100),
845              absl::Seconds(1) % absl::Milliseconds(300));
846    EXPECT_EQ(
847        absl::Milliseconds(300),
848        (absl::Seconds(3) + absl::Milliseconds(800)) % absl::Milliseconds(500));
849    EXPECT_EQ(absl::Nanoseconds(1), absl::Nanoseconds(1) % absl::Seconds(1));
850    EXPECT_EQ(absl::Nanoseconds(-1), absl::Nanoseconds(-1) % absl::Seconds(1));
851    EXPECT_EQ(0, absl::Nanoseconds(-1) / absl::Seconds(1));  
852  #define TEST_MOD_IDENTITY(a, b) \
853    EXPECT_EQ((a), ((a) / (b))*(b) + ((a)%(b)))
854    TEST_MOD_IDENTITY(absl::Seconds(0), absl::Seconds(2));
855    TEST_MOD_IDENTITY(absl::Seconds(1), absl::Seconds(1));
856    TEST_MOD_IDENTITY(absl::Seconds(1), absl::Seconds(2));
857    TEST_MOD_IDENTITY(absl::Seconds(2), absl::Seconds(1));
858    TEST_MOD_IDENTITY(absl::Seconds(-2), absl::Seconds(1));
859    TEST_MOD_IDENTITY(absl::Seconds(2), absl::Seconds(-1));
860    TEST_MOD_IDENTITY(absl::Seconds(-2), absl::Seconds(-1));
861    TEST_MOD_IDENTITY(absl::Nanoseconds(0), absl::Nanoseconds(2));
862    TEST_MOD_IDENTITY(absl::Nanoseconds(1), absl::Nanoseconds(1));
863    TEST_MOD_IDENTITY(absl::Nanoseconds(1), absl::Nanoseconds(2));
864    TEST_MOD_IDENTITY(absl::Nanoseconds(2), absl::Nanoseconds(1));
865    TEST_MOD_IDENTITY(absl::Nanoseconds(-2), absl::Nanoseconds(1));
866    TEST_MOD_IDENTITY(absl::Nanoseconds(2), absl::Nanoseconds(-1));
867    TEST_MOD_IDENTITY(absl::Nanoseconds(-2), absl::Nanoseconds(-1));
868    absl::Duration mixed_a = absl::Seconds(1) + absl::Nanoseconds(2);
869    absl::Duration mixed_b = absl::Seconds(1) + absl::Nanoseconds(3);
870    TEST_MOD_IDENTITY(absl::Seconds(0), mixed_a);
871    TEST_MOD_IDENTITY(mixed_a, mixed_a);
872    TEST_MOD_IDENTITY(mixed_a, mixed_b);
873    TEST_MOD_IDENTITY(mixed_b, mixed_a);
874    TEST_MOD_IDENTITY(-mixed_a, mixed_b);
875    TEST_MOD_IDENTITY(mixed_a, -mixed_b);
876    TEST_MOD_IDENTITY(-mixed_a, -mixed_b);
877  #undef TEST_MOD_IDENTITY
878  }
879  TEST(Duration, Truncation) {
880    const absl::Duration d = absl::Nanoseconds(1234567890);
881    const absl::Duration inf = absl::InfiniteDuration();
882    for (int unit_sign : {1, -1}) {  
883      EXPECT_EQ(absl::Nanoseconds(1234567890),
884                Trunc(d, unit_sign * absl::Nanoseconds(1)));
885      EXPECT_EQ(absl::Microseconds(1234567),
886                Trunc(d, unit_sign * absl::Microseconds(1)));
887      EXPECT_EQ(absl::Milliseconds(1234),
888                Trunc(d, unit_sign * absl::Milliseconds(1)));
889      EXPECT_EQ(absl::Seconds(1), Trunc(d, unit_sign * absl::Seconds(1)));
890      EXPECT_EQ(inf, Trunc(inf, unit_sign * absl::Seconds(1)));
891      EXPECT_EQ(absl::Nanoseconds(-1234567890),
892                Trunc(-d, unit_sign * absl::Nanoseconds(1)));
893      EXPECT_EQ(absl::Microseconds(-1234567),
894                Trunc(-d, unit_sign * absl::Microseconds(1)));
895      EXPECT_EQ(absl::Milliseconds(-1234),
896                Trunc(-d, unit_sign * absl::Milliseconds(1)));
897      EXPECT_EQ(absl::Seconds(-1), Trunc(-d, unit_sign * absl::Seconds(1)));
898      EXPECT_EQ(-inf, Trunc(-inf, unit_sign * absl::Seconds(1)));
899    }
900  }
901  TEST(Duration, Flooring) {
902    const absl::Duration d = absl::Nanoseconds(1234567890);
903    const absl::Duration inf = absl::InfiniteDuration();
904    for (int unit_sign : {1, -1}) {  
905      EXPECT_EQ(absl::Nanoseconds(1234567890),
906                absl::Floor(d, unit_sign * absl::Nanoseconds(1)));
907      EXPECT_EQ(absl::Microseconds(1234567),
908                absl::Floor(d, unit_sign * absl::Microseconds(1)));
909      EXPECT_EQ(absl::Milliseconds(1234),
910                absl::Floor(d, unit_sign * absl::Milliseconds(1)));
911      EXPECT_EQ(absl::Seconds(1), absl::Floor(d, unit_sign * absl::Seconds(1)));
912      EXPECT_EQ(inf, absl::Floor(inf, unit_sign * absl::Seconds(1)));
913      EXPECT_EQ(absl::Nanoseconds(-1234567890),
914                absl::Floor(-d, unit_sign * absl::Nanoseconds(1)));
915      EXPECT_EQ(absl::Microseconds(-1234568),
916                absl::Floor(-d, unit_sign * absl::Microseconds(1)));
917      EXPECT_EQ(absl::Milliseconds(-1235),
918                absl::Floor(-d, unit_sign * absl::Milliseconds(1)));
919      EXPECT_EQ(absl::Seconds(-2), absl::Floor(-d, unit_sign * absl::Seconds(1)));
920      EXPECT_EQ(-inf, absl::Floor(-inf, unit_sign * absl::Seconds(1)));
921    }
922  }
923  TEST(Duration, Ceiling) {
924    const absl::Duration d = absl::Nanoseconds(1234567890);
925    const absl::Duration inf = absl::InfiniteDuration();
926    for (int unit_sign : {1, -1}) {  
927      EXPECT_EQ(absl::Nanoseconds(1234567890),
928                absl::Ceil(d, unit_sign * absl::Nanoseconds(1)));
929      EXPECT_EQ(absl::Microseconds(1234568),
930                absl::Ceil(d, unit_sign * absl::Microseconds(1)));
931      EXPECT_EQ(absl::Milliseconds(1235),
932                absl::Ceil(d, unit_sign * absl::Milliseconds(1)));
933      EXPECT_EQ(absl::Seconds(2), absl::Ceil(d, unit_sign * absl::Seconds(1)));
934      EXPECT_EQ(inf, absl::Ceil(inf, unit_sign * absl::Seconds(1)));
935      EXPECT_EQ(absl::Nanoseconds(-1234567890),
936                absl::Ceil(-d, unit_sign * absl::Nanoseconds(1)));
937      EXPECT_EQ(absl::Microseconds(-1234567),
938                absl::Ceil(-d, unit_sign * absl::Microseconds(1)));
939      EXPECT_EQ(absl::Milliseconds(-1234),
940                absl::Ceil(-d, unit_sign * absl::Milliseconds(1)));
941      EXPECT_EQ(absl::Seconds(-1), absl::Ceil(-d, unit_sign * absl::Seconds(1)));
942      EXPECT_EQ(-inf, absl::Ceil(-inf, unit_sign * absl::Seconds(1)));
943    }
944  }
945  TEST(Duration, RoundTripUnits) {
946    const int kRange = 100000;
947  #define ROUND_TRIP_UNIT(U, LOW, HIGH)          \
948    do {                                         \
949      for (int64_t i = LOW; i &lt; HIGH; ++i) {     \
950        absl::Duration d = absl::U(i);           \
951        if (d == absl::InfiniteDuration())       \
952          EXPECT_EQ(kint64max, d / absl::U(1));  \
953        else if (d == -absl::InfiniteDuration()) \
954          EXPECT_EQ(kint64min, d / absl::U(1));  \
955        else                                     \
956          EXPECT_EQ(i, absl::U(i) / absl::U(1)); \
957      }                                          \
958    } while (0)
959    ROUND_TRIP_UNIT(Nanoseconds, kint64min, kint64min + kRange);
960    ROUND_TRIP_UNIT(Nanoseconds, -kRange, kRange);
961    ROUND_TRIP_UNIT(Nanoseconds, kint64max - kRange, kint64max);
962    ROUND_TRIP_UNIT(Microseconds, kint64min, kint64min + kRange);
963    ROUND_TRIP_UNIT(Microseconds, -kRange, kRange);
964    ROUND_TRIP_UNIT(Microseconds, kint64max - kRange, kint64max);
965    ROUND_TRIP_UNIT(Milliseconds, kint64min, kint64min + kRange);
966    ROUND_TRIP_UNIT(Milliseconds, -kRange, kRange);
967    ROUND_TRIP_UNIT(Milliseconds, kint64max - kRange, kint64max);
968    ROUND_TRIP_UNIT(Seconds, kint64min, kint64min + kRange);
969    ROUND_TRIP_UNIT(Seconds, -kRange, kRange);
970    ROUND_TRIP_UNIT(Seconds, kint64max - kRange, kint64max);
971    ROUND_TRIP_UNIT(Minutes, kint64min / 60, kint64min / 60 + kRange);
972    ROUND_TRIP_UNIT(Minutes, -kRange, kRange);
973    ROUND_TRIP_UNIT(Minutes, kint64max / 60 - kRange, kint64max / 60);
974    ROUND_TRIP_UNIT(Hours, kint64min / 3600, kint64min / 3600 + kRange);
975    ROUND_TRIP_UNIT(Hours, -kRange, kRange);
976    ROUND_TRIP_UNIT(Hours, kint64max / 3600 - kRange, kint64max / 3600);
977  #undef ROUND_TRIP_UNIT
978  }
979  TEST(Duration, TruncConversions) {
980    const struct {
981      absl::Duration d;
982      timespec ts;
983    } to_ts[] = {
984        {absl::Seconds(1) + absl::Nanoseconds(1), {1, 1}},
985        {absl::Seconds(1) + absl::Nanoseconds(1) / 2, {1, 0}},
986        {absl::Seconds(1) + absl::Nanoseconds(0), {1, 0}},
987        {absl::Seconds(0) + absl::Nanoseconds(0), {0, 0}},
988        {absl::Seconds(0) - absl::Nanoseconds(1) / 2, {0, 0}},
989        {absl::Seconds(0) - absl::Nanoseconds(1), {-1, 999999999}},
990        {absl::Seconds(-1) + absl::Nanoseconds(1), {-1, 1}},
991        {absl::Seconds(-1) + absl::Nanoseconds(1) / 2, {-1, 1}},
992        {absl::Seconds(-1) + absl::Nanoseconds(0), {-1, 0}},
993        {absl::Seconds(-1) - absl::Nanoseconds(1) / 2, {-1, 0}},
994    };
995    for (const auto&amp; test : to_ts) {
996      EXPECT_THAT(absl::ToTimespec(test.d), TimespecMatcher(test.ts));
997    }
998    const struct {
999      timespec ts;
1000      absl::Duration d;
1001    } from_ts[] = {
1002        {{1, 1}, absl::Seconds(1) + absl::Nanoseconds(1)},
1003        {{1, 0}, absl::Seconds(1) + absl::Nanoseconds(0)},
1004        {{0, 0}, absl::Seconds(0) + absl::Nanoseconds(0)},
1005        {{0, -1}, absl::Seconds(0) - absl::Nanoseconds(1)},
1006        {{-1, 999999999}, absl::Seconds(0) - absl::Nanoseconds(1)},
1007        {{-1, 1}, absl::Seconds(-1) + absl::Nanoseconds(1)},
1008        {{-1, 0}, absl::Seconds(-1) + absl::Nanoseconds(0)},
1009        {{-1, -1}, absl::Seconds(-1) - absl::Nanoseconds(1)},
1010        {{-2, 999999999}, absl::Seconds(-1) - absl::Nanoseconds(1)},
1011    };
1012    for (const auto&amp; test : from_ts) {
1013      EXPECT_EQ(test.d, absl::DurationFromTimespec(test.ts));
1014    }
1015    const struct {
1016      absl::Duration d;
1017      timeval tv;
1018    } to_tv[] = {
1019        {absl::Seconds(1) + absl::Microseconds(1), {1, 1}},
1020        {absl::Seconds(1) + absl::Microseconds(1) / 2, {1, 0}},
1021        {absl::Seconds(1) + absl::Microseconds(0), {1, 0}},
1022        {absl::Seconds(0) + absl::Microseconds(0), {0, 0}},
1023        {absl::Seconds(0) - absl::Microseconds(1) / 2, {0, 0}},
1024        {absl::Seconds(0) - absl::Microseconds(1), {-1, 999999}},
1025        {absl::Seconds(-1) + absl::Microseconds(1), {-1, 1}},
1026        {absl::Seconds(-1) + absl::Microseconds(1) / 2, {-1, 1}},
1027        {absl::Seconds(-1) + absl::Microseconds(0), {-1, 0}},
1028        {absl::Seconds(-1) - absl::Microseconds(1) / 2, {-1, 0}},
1029    };
1030    for (const auto&amp; test : to_tv) {
1031      EXPECT_THAT(absl::ToTimeval(test.d), TimevalMatcher(test.tv));
1032    }
1033    const struct {
1034      timeval tv;
1035      absl::Duration d;
1036    } from_tv[] = {
1037        {{1, 1}, absl::Seconds(1) + absl::Microseconds(1)},
1038        {{1, 0}, absl::Seconds(1) + absl::Microseconds(0)},
1039        {{0, 0}, absl::Seconds(0) + absl::Microseconds(0)},
1040        {{0, -1}, absl::Seconds(0) - absl::Microseconds(1)},
1041        {{-1, 999999}, absl::Seconds(0) - absl::Microseconds(1)},
1042        {{-1, 1}, absl::Seconds(-1) + absl::Microseconds(1)},
1043        {{-1, 0}, absl::Seconds(-1) + absl::Microseconds(0)},
1044        {{-1, -1}, absl::Seconds(-1) - absl::Microseconds(1)},
1045        {{-2, 999999}, absl::Seconds(-1) - absl::Microseconds(1)},
1046    };
1047    for (const auto&amp; test : from_tv) {
1048      EXPECT_EQ(test.d, absl::DurationFromTimeval(test.tv));
1049    }
1050  }
1051  TEST(Duration, SmallConversions) {
1052    EXPECT_EQ(absl::ZeroDuration(), absl::Seconds(0));
1053    EXPECT_EQ(absl::ZeroDuration(), absl::Seconds(std::nextafter(0.125e-9, 0)));
1054    EXPECT_EQ(absl::Nanoseconds(1) / 4, absl::Seconds(0.125e-9));
1055    EXPECT_EQ(absl::Nanoseconds(1) / 4, absl::Seconds(0.250e-9));
1056    EXPECT_EQ(absl::Nanoseconds(1) / 2, absl::Seconds(0.375e-9));
1057    EXPECT_EQ(absl::Nanoseconds(1) / 2, absl::Seconds(0.500e-9));
1058    EXPECT_EQ(absl::Nanoseconds(3) / 4, absl::Seconds(0.625e-9));
1059    EXPECT_EQ(absl::Nanoseconds(3) / 4, absl::Seconds(0.750e-9));
1060    EXPECT_EQ(absl::Nanoseconds(1), absl::Seconds(0.875e-9));
1061    EXPECT_EQ(absl::Nanoseconds(1), absl::Seconds(1.000e-9));
1062    EXPECT_EQ(absl::ZeroDuration(), absl::Seconds(std::nextafter(-0.125e-9, 0)));
1063    EXPECT_EQ(-absl::Nanoseconds(1) / 4, absl::Seconds(-0.125e-9));
1064    EXPECT_EQ(-absl::Nanoseconds(1) / 4, absl::Seconds(-0.250e-9));
1065    EXPECT_EQ(-absl::Nanoseconds(1) / 2, absl::Seconds(-0.375e-9));
1066    EXPECT_EQ(-absl::Nanoseconds(1) / 2, absl::Seconds(-0.500e-9));
1067    EXPECT_EQ(-absl::Nanoseconds(3) / 4, absl::Seconds(-0.625e-9));
1068    EXPECT_EQ(-absl::Nanoseconds(3) / 4, absl::Seconds(-0.750e-9));
1069    EXPECT_EQ(-absl::Nanoseconds(1), absl::Seconds(-0.875e-9));
1070    EXPECT_EQ(-absl::Nanoseconds(1), absl::Seconds(-1.000e-9));
1071    timespec ts;
1072    ts.tv_sec = 0;
1073    ts.tv_nsec = 0;
1074    EXPECT_THAT(ToTimespec(absl::Nanoseconds(0)), TimespecMatcher(ts));
1075    EXPECT_THAT(ToTimespec(absl::Nanoseconds(1) / 4), TimespecMatcher(ts));
1076    EXPECT_THAT(ToTimespec(absl::Nanoseconds(2) / 4), TimespecMatcher(ts));
1077    EXPECT_THAT(ToTimespec(absl::Nanoseconds(3) / 4), TimespecMatcher(ts));
1078    ts.tv_nsec = 1;
1079    EXPECT_THAT(ToTimespec(absl::Nanoseconds(4) / 4), TimespecMatcher(ts));
1080    EXPECT_THAT(ToTimespec(absl::Nanoseconds(5) / 4), TimespecMatcher(ts));
1081    EXPECT_THAT(ToTimespec(absl::Nanoseconds(6) / 4), TimespecMatcher(ts));
1082    EXPECT_THAT(ToTimespec(absl::Nanoseconds(7) / 4), TimespecMatcher(ts));
1083    ts.tv_nsec = 2;
1084    EXPECT_THAT(ToTimespec(absl::Nanoseconds(8) / 4), TimespecMatcher(ts));
1085    timeval tv;
1086    tv.tv_sec = 0;
1087    tv.tv_usec = 0;
1088    EXPECT_THAT(ToTimeval(absl::Nanoseconds(0)), TimevalMatcher(tv));
1089    EXPECT_THAT(ToTimeval(absl::Nanoseconds(999)), TimevalMatcher(tv));
1090    tv.tv_usec = 1;
1091    EXPECT_THAT(ToTimeval(absl::Nanoseconds(1000)), TimevalMatcher(tv));
1092    EXPECT_THAT(ToTimeval(absl::Nanoseconds(1999)), TimevalMatcher(tv));
1093    tv.tv_usec = 2;
1094    EXPECT_THAT(ToTimeval(absl::Nanoseconds(2000)), TimevalMatcher(tv));
1095  }
1096  void VerifyApproxSameAsMul(double time_as_seconds, int* const misses) {
1097    auto direct_seconds = absl::Seconds(time_as_seconds);
1098    auto mul_by_one_second = time_as_seconds * absl::Seconds(1);
1099    if (absl::AbsDuration(direct_seconds - mul_by_one_second) &gt;
1100        absl::time_internal::MakeDuration(0, 1u)) {
1101      if (*misses &gt; 10) return;
1102      ASSERT_LE(++(*misses), 10) &lt;&lt; &quot;Too many errors, not reporting more.&quot;;
1103      EXPECT_EQ(direct_seconds, mul_by_one_second)
1104          &lt;&lt; &quot;given double time_as_seconds = &quot; &lt;&lt; std::setprecision(17)
1105          &lt;&lt; time_as_seconds;
1106    }
1107  }
1108  TEST(Duration, ToDoubleSecondsCheckEdgeCases) {
1109  #if (defined(__i386__) || defined(_M_IX86)) &amp;&amp; FLT_EVAL_METHOD != 0
1110    GTEST_SKIP()
1111        &lt;&lt; &quot;Skipping the test because we detected x87 floating-point semantics&quot;;
1112  #endif
1113    constexpr uint32_t kTicksPerSecond = absl::time_internal::kTicksPerSecond;
1114    constexpr auto duration_tick = absl::time_internal::MakeDuration(0, 1u);
1115    int misses = 0;
1116    for (int64_t seconds = 0; seconds &lt; 99; ++seconds) {
1117      uint32_t tick_vals[] = {0, +999, +999999, +999999999, kTicksPerSecond - 1,
1118                              0, 1000, 1000000, 1000000000, kTicksPerSecond,
1119                              1, 1001, 1000001, 1000000001, kTicksPerSecond + 1,
1120                              2, 1002, 1000002, 1000000002, kTicksPerSecond + 2,
1121                              3, 1003, 1000003, 1000000003, kTicksPerSecond + 3,
1122                              4, 1004, 1000004, 1000000004, kTicksPerSecond + 4,
1123                              5, 6,    7,       8,          9};
1124      for (uint32_t ticks : tick_vals) {
1125        absl::Duration s_plus_t = absl::Seconds(seconds) + ticks * duration_tick;
1126        for (absl::Duration d : {s_plus_t, -s_plus_t}) {
1127          absl::Duration after_d = d + duration_tick;
1128          EXPECT_NE(d, after_d);
1129          EXPECT_EQ(after_d - d, duration_tick);
1130          double low_edge = ToDoubleSeconds(d);
1131          EXPECT_EQ(d, absl::Seconds(low_edge));
1132          double high_edge = ToDoubleSeconds(after_d);
1133          EXPECT_EQ(after_d, absl::Seconds(high_edge));
1134          for (;;) {
1135            double midpoint = low_edge + (high_edge - low_edge) / 2;
1136            if (midpoint == low_edge || midpoint == high_edge) break;
1137            absl::Duration mid_duration = absl::Seconds(midpoint);
1138            if (mid_duration == d) {
1139              low_edge = midpoint;
1140            } else {
1141              EXPECT_EQ(mid_duration, after_d);
1142              high_edge = midpoint;
1143            }
1144          }
1145          VerifyApproxSameAsMul(low_edge, &amp;misses);
1146          VerifyApproxSameAsMul(high_edge, &amp;misses);
1147        }
1148      }
1149    }
1150  }
1151  TEST(Duration, ToDoubleSecondsCheckRandom) {
1152    std::random_device rd;
1153    std::seed_seq seed({rd(), rd(), rd(), rd(), rd(), rd(), rd(), rd()});
1154    std::mt19937_64 gen(seed);
1155    std::uniform_real_distribution&lt;double&gt; uniform(std::log(0.125e-9),
1156                                                   std::log(9.223377e+18));
1157    int misses = 0;
1158    for (int i = 0; i &lt; 1000000; ++i) {
1159      double d = std::exp(uniform(gen));
1160      VerifyApproxSameAsMul(d, &amp;misses);
1161      VerifyApproxSameAsMul(-d, &amp;misses);
1162    }
1163  }
1164  TEST(Duration, ConversionSaturation) {
1165    absl::Duration d;
1166    const auto max_timeval_sec =
1167        std::numeric_limits&lt;decltype(timeval::tv_sec)&gt;::max();
1168    const auto min_timeval_sec =
1169        std::numeric_limits&lt;decltype(timeval::tv_sec)&gt;::min();
1170    timeval tv;
1171    tv.tv_sec = max_timeval_sec;
1172    tv.tv_usec = 999998;
1173    d = absl::DurationFromTimeval(tv);
1174    tv = ToTimeval(d);
1175    EXPECT_EQ(max_timeval_sec, tv.tv_sec);
1176    EXPECT_EQ(999998, tv.tv_usec);
1177    d += absl::Microseconds(1);
1178    tv = ToTimeval(d);
1179    EXPECT_EQ(max_timeval_sec, tv.tv_sec);
1180    EXPECT_EQ(999999, tv.tv_usec);
1181    d += absl::Microseconds(1);  
1182    tv = ToTimeval(d);
1183    EXPECT_EQ(max_timeval_sec, tv.tv_sec);
1184    EXPECT_EQ(999999, tv.tv_usec);
1185    tv.tv_sec = min_timeval_sec;
1186    tv.tv_usec = 1;
1187    d = absl::DurationFromTimeval(tv);
1188    tv = ToTimeval(d);
1189    EXPECT_EQ(min_timeval_sec, tv.tv_sec);
1190    EXPECT_EQ(1, tv.tv_usec);
1191    d -= absl::Microseconds(1);
1192    tv = ToTimeval(d);
1193    EXPECT_EQ(min_timeval_sec, tv.tv_sec);
1194    EXPECT_EQ(0, tv.tv_usec);
1195    d -= absl::Microseconds(1);  
1196    tv = ToTimeval(d);
1197    EXPECT_EQ(min_timeval_sec, tv.tv_sec);
1198    EXPECT_EQ(0, tv.tv_usec);
1199    const auto max_timespec_sec =
1200        std::numeric_limits&lt;decltype(timespec::tv_sec)&gt;::max();
1201    const auto min_timespec_sec =
1202        std::numeric_limits&lt;decltype(timespec::tv_sec)&gt;::min();
1203    timespec ts;
1204    ts.tv_sec = max_timespec_sec;
1205    ts.tv_nsec = 999999998;
1206    d = absl::DurationFromTimespec(ts);
1207    ts = absl::ToTimespec(d);
1208    EXPECT_EQ(max_timespec_sec, ts.tv_sec);
1209    EXPECT_EQ(999999998, ts.tv_nsec);
1210    d += absl::Nanoseconds(1);
1211    ts = absl::ToTimespec(d);
1212    EXPECT_EQ(max_timespec_sec, ts.tv_sec);
1213    EXPECT_EQ(999999999, ts.tv_nsec);
1214    d += absl::Nanoseconds(1);  
1215    ts = absl::ToTimespec(d);
1216    EXPECT_EQ(max_timespec_sec, ts.tv_sec);
1217    EXPECT_EQ(999999999, ts.tv_nsec);
1218    ts.tv_sec = min_timespec_sec;
1219    ts.tv_nsec = 1;
1220    d = absl::DurationFromTimespec(ts);
1221    ts = absl::ToTimespec(d);
1222    EXPECT_EQ(min_timespec_sec, ts.tv_sec);
1223    EXPECT_EQ(1, ts.tv_nsec);
1224    d -= absl::Nanoseconds(1);
1225    ts = absl::ToTimespec(d);
1226    EXPECT_EQ(min_timespec_sec, ts.tv_sec);
1227    EXPECT_EQ(0, ts.tv_nsec);
1228    d -= absl::Nanoseconds(1);  
1229    ts = absl::ToTimespec(d);
1230    EXPECT_EQ(min_timespec_sec, ts.tv_sec);
1231    EXPECT_EQ(0, ts.tv_nsec);
1232  }
1233  TEST(Duration, FormatDuration) {
1234    EXPECT_EQ(&quot;72h3m0.5s&quot;,
1235              absl::FormatDuration(absl::Hours(72) + absl::Minutes(3) +
1236                                   absl::Milliseconds(500)));
1237    EXPECT_EQ(&quot;2540400h10m10s&quot;,
1238              absl::FormatDuration(absl::Hours(2540400) + absl::Minutes(10) +
1239                                   absl::Seconds(10)));
1240    EXPECT_EQ(&quot;0&quot;, absl::FormatDuration(absl::ZeroDuration()));
1241    EXPECT_EQ(&quot;0&quot;, absl::FormatDuration(absl::Seconds(0)));
1242    EXPECT_EQ(&quot;0&quot;, absl::FormatDuration(absl::Nanoseconds(0)));
1243    EXPECT_EQ(&quot;1ns&quot;, absl::FormatDuration(absl::Nanoseconds(1)));
1244    EXPECT_EQ(&quot;1us&quot;, absl::FormatDuration(absl::Microseconds(1)));
1245    EXPECT_EQ(&quot;1ms&quot;, absl::FormatDuration(absl::Milliseconds(1)));
1246    EXPECT_EQ(&quot;1s&quot;, absl::FormatDuration(absl::Seconds(1)));
1247    EXPECT_EQ(&quot;1m&quot;, absl::FormatDuration(absl::Minutes(1)));
1248    EXPECT_EQ(&quot;1h&quot;, absl::FormatDuration(absl::Hours(1)));
1249    EXPECT_EQ(&quot;1h1m&quot;, absl::FormatDuration(absl::Hours(1) + absl::Minutes(1)));
1250    EXPECT_EQ(&quot;1h1s&quot;, absl::FormatDuration(absl::Hours(1) + absl::Seconds(1)));
1251    EXPECT_EQ(&quot;1m1s&quot;, absl::FormatDuration(absl::Minutes(1) + absl::Seconds(1)));
1252    EXPECT_EQ(&quot;1h0.25s&quot;,
1253              absl::FormatDuration(absl::Hours(1) + absl::Milliseconds(250)));
1254    EXPECT_EQ(&quot;1m0.25s&quot;,
1255              absl::FormatDuration(absl::Minutes(1) + absl::Milliseconds(250)));
1256    EXPECT_EQ(&quot;1h1m0.25s&quot;,
1257              absl::FormatDuration(absl::Hours(1) + absl::Minutes(1) +
1258                                   absl::Milliseconds(250)));
1259    EXPECT_EQ(&quot;1h0.0005s&quot;,
1260              absl::FormatDuration(absl::Hours(1) + absl::Microseconds(500)));
1261    EXPECT_EQ(&quot;1h0.0000005s&quot;,
1262              absl::FormatDuration(absl::Hours(1) + absl::Nanoseconds(500)));
1263    EXPECT_EQ(&quot;1.5ns&quot;, absl::FormatDuration(absl::Nanoseconds(1) +
1264                                            absl::Nanoseconds(1) / 2));
1265    EXPECT_EQ(&quot;1.25ns&quot;, absl::FormatDuration(absl::Nanoseconds(1) +
1266                                             absl::Nanoseconds(1) / 4));
1267    EXPECT_EQ(&quot;1ns&quot;, absl::FormatDuration(absl::Nanoseconds(1) +
1268                                          absl::Nanoseconds(1) / 9));
1269    EXPECT_EQ(&quot;1.2us&quot;, absl::FormatDuration(absl::Microseconds(1) +
1270                                            absl::Nanoseconds(200)));
1271    EXPECT_EQ(&quot;1.2ms&quot;, absl::FormatDuration(absl::Milliseconds(1) +
1272                                            absl::Microseconds(200)));
1273    EXPECT_EQ(&quot;1.0002ms&quot;, absl::FormatDuration(absl::Milliseconds(1) +
1274                                               absl::Nanoseconds(200)));
1275    EXPECT_EQ(&quot;1.00001ms&quot;, absl::FormatDuration(absl::Milliseconds(1) +
1276                                                absl::Nanoseconds(10)));
1277    EXPECT_EQ(&quot;1.000001ms&quot;,
1278              absl::FormatDuration(absl::Milliseconds(1) + absl::Nanoseconds(1)));
1279    EXPECT_EQ(&quot;-1ns&quot;, absl::FormatDuration(absl::Nanoseconds(-1)));
1280    EXPECT_EQ(&quot;-1us&quot;, absl::FormatDuration(absl::Microseconds(-1)));
1281    EXPECT_EQ(&quot;-1ms&quot;, absl::FormatDuration(absl::Milliseconds(-1)));
1282    EXPECT_EQ(&quot;-1s&quot;, absl::FormatDuration(absl::Seconds(-1)));
1283    EXPECT_EQ(&quot;-1m&quot;, absl::FormatDuration(absl::Minutes(-1)));
1284    EXPECT_EQ(&quot;-1h&quot;, absl::FormatDuration(absl::Hours(-1)));
1285    EXPECT_EQ(&quot;-1h1m&quot;,
1286              absl::FormatDuration(-(absl::Hours(1) + absl::Minutes(1))));
1287    EXPECT_EQ(&quot;-1h1s&quot;,
1288              absl::FormatDuration(-(absl::Hours(1) + absl::Seconds(1))));
1289    EXPECT_EQ(&quot;-1m1s&quot;,
1290              absl::FormatDuration(-(absl::Minutes(1) + absl::Seconds(1))));
1291    EXPECT_EQ(&quot;-1ns&quot;, absl::FormatDuration(absl::Nanoseconds(-1)));
1292    EXPECT_EQ(&quot;-1.2us&quot;, absl::FormatDuration(
1293                            -(absl::Microseconds(1) + absl::Nanoseconds(200))));
1294    EXPECT_EQ(&quot;-1.2ms&quot;, absl::FormatDuration(
1295                            -(absl::Milliseconds(1) + absl::Microseconds(200))));
1296    EXPECT_EQ(&quot;-1.0002ms&quot;, absl::FormatDuration(-(absl::Milliseconds(1) +
1297                                                  absl::Nanoseconds(200))));
1298    EXPECT_EQ(&quot;-1.00001ms&quot;, absl::FormatDuration(-(absl::Milliseconds(1) +
1299                                                   absl::Nanoseconds(10))));
1300    EXPECT_EQ(&quot;-1.000001ms&quot;, absl::FormatDuration(-(absl::Milliseconds(1) +
1301                                                    absl::Nanoseconds(1))));
1302    const absl::Duration qns = absl::Nanoseconds(1) / 4;
1303    const absl::Duration max_dur =
1304        absl::Seconds(kint64max) + (absl::Seconds(1) - qns);
1305    const absl::Duration min_dur = absl::Seconds(kint64min);
1306    EXPECT_EQ(&quot;0.25ns&quot;, absl::FormatDuration(qns));
1307    EXPECT_EQ(&quot;-0.25ns&quot;, absl::FormatDuration(-qns));
1308    EXPECT_EQ(&quot;2562047788015215h30m7.99999999975s&quot;,
1309              absl::FormatDuration(max_dur));
1310    EXPECT_EQ(&quot;-2562047788015215h30m8s&quot;, absl::FormatDuration(min_dur));
1311    EXPECT_EQ(&quot;55.00000000025s&quot;, absl::FormatDuration(absl::Seconds(55) + qns));
1312    EXPECT_EQ(&quot;55.00000025ms&quot;,
1313              absl::FormatDuration(absl::Milliseconds(55) + qns));
1314    EXPECT_EQ(&quot;55.00025us&quot;, absl::FormatDuration(absl::Microseconds(55) + qns));
1315    EXPECT_EQ(&quot;55.25ns&quot;, absl::FormatDuration(absl::Nanoseconds(55) + qns));
1316    EXPECT_EQ(&quot;inf&quot;, absl::FormatDuration(absl::InfiniteDuration()));
1317    EXPECT_EQ(&quot;-inf&quot;, absl::FormatDuration(-absl::InfiniteDuration()));
1318    const absl::Duration huge_range = ApproxYears(100000000000);
1319    EXPECT_EQ(&quot;876000000000000h&quot;, absl::FormatDuration(huge_range));
1320    EXPECT_EQ(&quot;-876000000000000h&quot;, absl::FormatDuration(-huge_range));
1321    EXPECT_EQ(&quot;876000000000000h0.999999999s&quot;,
1322              absl::FormatDuration(huge_range +
1323                                   (absl::Seconds(1) - absl::Nanoseconds(1))));
1324    EXPECT_EQ(&quot;876000000000000h0.9999999995s&quot;,
1325              absl::FormatDuration(
1326                  huge_range + (absl::Seconds(1) - absl::Nanoseconds(1) / 2)));
1327    EXPECT_EQ(&quot;876000000000000h0.99999999975s&quot;,
1328              absl::FormatDuration(
1329                  huge_range + (absl::Seconds(1) - absl::Nanoseconds(1) / 4)));
1330    EXPECT_EQ(&quot;-876000000000000h0.999999999s&quot;,
1331              absl::FormatDuration(-huge_range -
1332                                   (absl::Seconds(1) - absl::Nanoseconds(1))));
1333    EXPECT_EQ(&quot;-876000000000000h0.9999999995s&quot;,
1334              absl::FormatDuration(
1335                  -huge_range - (absl::Seconds(1) - absl::Nanoseconds(1) / 2)));
1336    EXPECT_EQ(&quot;-876000000000000h0.99999999975s&quot;,
1337              absl::FormatDuration(
1338                  -huge_range - (absl::Seconds(1) - absl::Nanoseconds(1) / 4)));
1339  }
1340  TEST(Duration, ParseDuration) {
1341    absl::Duration d;
1342    EXPECT_TRUE(absl::ParseDuration(&quot;0&quot;, &amp;d));
1343    EXPECT_EQ(absl::ZeroDuration(), d);
1344    EXPECT_TRUE(absl::ParseDuration(&quot;+0&quot;, &amp;d));
1345    EXPECT_EQ(absl::ZeroDuration(), d);
1346    EXPECT_TRUE(absl::ParseDuration(&quot;-0&quot;, &amp;d));
1347    EXPECT_EQ(absl::ZeroDuration(), d);
1348    EXPECT_TRUE(absl::ParseDuration(&quot;inf&quot;, &amp;d));
1349    EXPECT_EQ(absl::InfiniteDuration(), d);
1350    EXPECT_TRUE(absl::ParseDuration(&quot;+inf&quot;, &amp;d));
1351    EXPECT_EQ(absl::InfiniteDuration(), d);
1352    EXPECT_TRUE(absl::ParseDuration(&quot;-inf&quot;, &amp;d));
1353    EXPECT_EQ(-absl::InfiniteDuration(), d);
1354    EXPECT_FALSE(absl::ParseDuration(&quot;infBlah&quot;, &amp;d));
1355    EXPECT_FALSE(absl::ParseDuration(&quot;&quot;, &amp;d));
1356    EXPECT_FALSE(absl::ParseDuration(&quot;0.0&quot;, &amp;d));
1357    EXPECT_FALSE(absl::ParseDuration(&quot;.0&quot;, &amp;d));
1358    EXPECT_FALSE(absl::ParseDuration(&quot;.&quot;, &amp;d));
1359    EXPECT_FALSE(absl::ParseDuration(&quot;01&quot;, &amp;d));
1360    EXPECT_FALSE(absl::ParseDuration(&quot;1&quot;, &amp;d));
1361    EXPECT_FALSE(absl::ParseDuration(&quot;-1&quot;, &amp;d));
1362    EXPECT_FALSE(absl::ParseDuration(&quot;2&quot;, &amp;d));
1363    EXPECT_FALSE(absl::ParseDuration(&quot;2 s&quot;, &amp;d));
1364    EXPECT_FALSE(absl::ParseDuration(&quot;.s&quot;, &amp;d));
1365    EXPECT_FALSE(absl::ParseDuration(&quot;-.s&quot;, &amp;d));
1366    EXPECT_FALSE(absl::ParseDuration(&quot;s&quot;, &amp;d));
1367    EXPECT_FALSE(absl::ParseDuration(&quot; 2s&quot;, &amp;d));
1368    EXPECT_FALSE(absl::ParseDuration(&quot;2s &quot;, &amp;d));
1369    EXPECT_FALSE(absl::ParseDuration(&quot; 2s &quot;, &amp;d));
1370    EXPECT_FALSE(absl::ParseDuration(&quot;2mt&quot;, &amp;d));
1371    EXPECT_FALSE(absl::ParseDuration(&quot;1e3s&quot;, &amp;d));
1372    EXPECT_TRUE(absl::ParseDuration(&quot;1ns&quot;, &amp;d));
1373    EXPECT_EQ(absl::Nanoseconds(1), d);
1374    EXPECT_TRUE(absl::ParseDuration(&quot;1us&quot;, &amp;d));
1375    EXPECT_EQ(absl::Microseconds(1), d);
1376    EXPECT_TRUE(absl::ParseDuration(&quot;1ms&quot;, &amp;d));
1377    EXPECT_EQ(absl::Milliseconds(1), d);
1378    EXPECT_TRUE(absl::ParseDuration(&quot;1s&quot;, &amp;d));
1379    EXPECT_EQ(absl::Seconds(1), d);
1380    EXPECT_TRUE(absl::ParseDuration(&quot;2m&quot;, &amp;d));
1381    EXPECT_EQ(absl::Minutes(2), d);
1382    EXPECT_TRUE(absl::ParseDuration(&quot;2h&quot;, &amp;d));
1383    EXPECT_EQ(absl::Hours(2), d);
1384    EXPECT_TRUE(absl::ParseDuration(&quot;9223372036854775807us&quot;, &amp;d));
1385    EXPECT_EQ(absl::Microseconds(9223372036854775807), d);
1386    EXPECT_TRUE(absl::ParseDuration(&quot;-9223372036854775807us&quot;, &amp;d));
1387    EXPECT_EQ(absl::Microseconds(-9223372036854775807), d);
1388    EXPECT_TRUE(absl::ParseDuration(&quot;2h3m4s&quot;, &amp;d));
1389    EXPECT_EQ(absl::Hours(2) + absl::Minutes(3) + absl::Seconds(4), d);
1390    EXPECT_TRUE(absl::ParseDuration(&quot;3m4s5us&quot;, &amp;d));
1391    EXPECT_EQ(absl::Minutes(3) + absl::Seconds(4) + absl::Microseconds(5), d);
1392    EXPECT_TRUE(absl::ParseDuration(&quot;2h3m4s5ms6us7ns&quot;, &amp;d));
1393    EXPECT_EQ(absl::Hours(2) + absl::Minutes(3) + absl::Seconds(4) +
1394                  absl::Milliseconds(5) + absl::Microseconds(6) +
1395                  absl::Nanoseconds(7),
1396              d);
1397    EXPECT_TRUE(absl::ParseDuration(&quot;2us3m4s5h&quot;, &amp;d));
1398    EXPECT_EQ(absl::Hours(5) + absl::Minutes(3) + absl::Seconds(4) +
1399                  absl::Microseconds(2),
1400              d);
1401    EXPECT_TRUE(absl::ParseDuration(&quot;1.5ns&quot;, &amp;d));
1402    EXPECT_EQ(1.5 * absl::Nanoseconds(1), d);
1403    EXPECT_TRUE(absl::ParseDuration(&quot;1.5us&quot;, &amp;d));
1404    EXPECT_EQ(1.5 * absl::Microseconds(1), d);
1405    EXPECT_TRUE(absl::ParseDuration(&quot;1.5ms&quot;, &amp;d));
1406    EXPECT_EQ(1.5 * absl::Milliseconds(1), d);
1407    EXPECT_TRUE(absl::ParseDuration(&quot;1.5s&quot;, &amp;d));
1408    EXPECT_EQ(1.5 * absl::Seconds(1), d);
1409    EXPECT_TRUE(absl::ParseDuration(&quot;1.5m&quot;, &amp;d));
1410    EXPECT_EQ(1.5 * absl::Minutes(1), d);
1411    EXPECT_TRUE(absl::ParseDuration(&quot;1.5h&quot;, &amp;d));
1412    EXPECT_EQ(1.5 * absl::Hours(1), d);
1413    EXPECT_TRUE(absl::ParseDuration(&quot;0.4294967295s&quot;, &amp;d));
1414    EXPECT_EQ(absl::Nanoseconds(429496729) + absl::Nanoseconds(1) / 2, d);
1415    EXPECT_TRUE(absl::ParseDuration(&quot;0.429496729501234567890123456789s&quot;, &amp;d));
1416    EXPECT_EQ(absl::Nanoseconds(429496729) + absl::Nanoseconds(1) / 2, d);
1417    EXPECT_TRUE(absl::ParseDuration(&quot;-1s&quot;, &amp;d));
1418    EXPECT_EQ(absl::Seconds(-1), d);
1419    EXPECT_TRUE(absl::ParseDuration(&quot;-1m&quot;, &amp;d));
1420    EXPECT_EQ(absl::Minutes(-1), d);
1421    EXPECT_TRUE(absl::ParseDuration(&quot;-1h&quot;, &amp;d));
1422    EXPECT_EQ(absl::Hours(-1), d);
1423    EXPECT_TRUE(absl::ParseDuration(&quot;-1h2s&quot;, &amp;d));
1424    EXPECT_EQ(-(absl::Hours(1) + absl::Seconds(2)), d);
1425    EXPECT_FALSE(absl::ParseDuration(&quot;1h-2s&quot;, &amp;d));
1426    EXPECT_FALSE(absl::ParseDuration(&quot;-1h-2s&quot;, &amp;d));
1427    EXPECT_FALSE(absl::ParseDuration(&quot;-1h -2s&quot;, &amp;d));
1428  }
1429  TEST(Duration, FormatParseRoundTrip) {
1430  #define TEST_PARSE_ROUNDTRIP(d)                \
1431    do {                                         \
1432      std::string s = absl::FormatDuration(d);   \
1433      absl::Duration dur;                        \
1434      EXPECT_TRUE(absl::ParseDuration(s, &amp;dur)); \
1435      EXPECT_EQ(d, dur);                         \
1436    } while (0)
1437    TEST_PARSE_ROUNDTRIP(absl::Nanoseconds(1));
1438    TEST_PARSE_ROUNDTRIP(absl::Microseconds(1));
1439    TEST_PARSE_ROUNDTRIP(absl::Milliseconds(1));
1440    TEST_PARSE_ROUNDTRIP(absl::Seconds(1));
1441    TEST_PARSE_ROUNDTRIP(absl::Minutes(1));
1442    TEST_PARSE_ROUNDTRIP(absl::Hours(1));
1443    TEST_PARSE_ROUNDTRIP(absl::Hours(1) + absl::Nanoseconds(2));
1444    TEST_PARSE_ROUNDTRIP(absl::Nanoseconds(-1));
1445    TEST_PARSE_ROUNDTRIP(absl::Microseconds(-1));
1446    TEST_PARSE_ROUNDTRIP(absl::Milliseconds(-1));
1447    TEST_PARSE_ROUNDTRIP(absl::Seconds(-1));
1448    TEST_PARSE_ROUNDTRIP(absl::Minutes(-1));
1449    TEST_PARSE_ROUNDTRIP(absl::Hours(-1));
1450    TEST_PARSE_ROUNDTRIP(absl::Hours(-1) + absl::Nanoseconds(2));
1451    TEST_PARSE_ROUNDTRIP(absl::Hours(1) + absl::Nanoseconds(-2));
1452    TEST_PARSE_ROUNDTRIP(absl::Hours(-1) + absl::Nanoseconds(-2));
1453    TEST_PARSE_ROUNDTRIP(absl::Nanoseconds(1) +
1454                         absl::Nanoseconds(1) / 4);  
1455    const absl::Duration huge_range = ApproxYears(100000000000);
1456    TEST_PARSE_ROUNDTRIP(huge_range);
1457    TEST_PARSE_ROUNDTRIP(huge_range + (absl::Seconds(1) - absl::Nanoseconds(1)));
1458  #undef TEST_PARSE_ROUNDTRIP
1459  }
1460  TEST(Duration, AbslStringify) {
1461    absl::Duration d = absl::Seconds(1);
1462    EXPECT_EQ(absl::StrFormat(&quot;%v&quot;, d), absl::FormatDuration(d));
1463  }
1464  TEST(Duration, NoPadding) {
1465    using NoPadding = std::array&lt;uint32_t, 3&gt;;
1466    EXPECT_EQ(sizeof(NoPadding), sizeof(absl::Duration));
1467    EXPECT_EQ(alignof(NoPadding), alignof(absl::Duration));
1468  }
1469  }  
</code></pre>
        </div>
        <div class="column">
            <h3>abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-duration_test.cc</h3>
            <pre><code>1  #if defined(_MSC_VER)
2  #include &lt;winsock2.h&gt;  
3  #endif
4  #include &lt;array&gt;
5  #include &lt;cfloat&gt;
6  #include &lt;chrono&gt;  
7  #include &lt;cmath&gt;
8  #include &lt;cstdint&gt;
9  #include &lt;ctime&gt;
10  #include &lt;iomanip&gt;
11  #include &lt;limits&gt;
12  #include &lt;random&gt;
13  #include &lt;string&gt;
14  #include &quot;gmock/gmock.h&quot;
15  #include &quot;gtest/gtest.h&quot;
16  #include &quot;absl/strings/str_format.h&quot;
17  #include &quot;absl/time/time.h&quot;
18  namespace {
19  constexpr int64_t kint64max = std::numeric_limits&lt;int64_t&gt;::max();
20  constexpr int64_t kint64min = std::numeric_limits&lt;int64_t&gt;::min();
21  absl::Duration ApproxYears(int64_t n) { return absl::Hours(n) * 365 * 24; }
22  MATCHER_P(TimespecMatcher, ts, &quot;&quot;) {
23    if (ts.tv_sec == arg.tv_sec &amp;&amp; ts.tv_nsec == arg.tv_nsec)
24      return true;
25    *result_listener &lt;&lt; &quot;expected: {&quot; &lt;&lt; ts.tv_sec &lt;&lt; &quot;, &quot; &lt;&lt; ts.tv_nsec &lt;&lt; &quot;} &quot;;
26    *result_listener &lt;&lt; &quot;actual: {&quot; &lt;&lt; arg.tv_sec &lt;&lt; &quot;, &quot; &lt;&lt; arg.tv_nsec &lt;&lt; &quot;}&quot;;
27    return false;
28  }
29  MATCHER_P(TimevalMatcher, tv, &quot;&quot;) {
30    if (tv.tv_sec == arg.tv_sec &amp;&amp; tv.tv_usec == arg.tv_usec)
31      return true;
32    *result_listener &lt;&lt; &quot;expected: {&quot; &lt;&lt; tv.tv_sec &lt;&lt; &quot;, &quot; &lt;&lt; tv.tv_usec &lt;&lt; &quot;} &quot;;
33    *result_listener &lt;&lt; &quot;actual: {&quot; &lt;&lt; arg.tv_sec &lt;&lt; &quot;, &quot; &lt;&lt; arg.tv_usec &lt;&lt; &quot;}&quot;;
34    return false;
35  }
36  TEST(Duration, ConstExpr) {
37    constexpr absl::Duration d0 = absl::ZeroDuration();
38    static_assert(d0 == absl::ZeroDuration(), &quot;ZeroDuration()&quot;);
39    constexpr absl::Duration d1 = absl::Seconds(1);
40    static_assert(d1 == absl::Seconds(1), &quot;Seconds(1)&quot;);
41    static_assert(d1 != absl::ZeroDuration(), &quot;Seconds(1)&quot;);
42    constexpr absl::Duration d2 = absl::InfiniteDuration();
43    static_assert(d2 == absl::InfiniteDuration(), &quot;InfiniteDuration()&quot;);
44    static_assert(d2 != absl::ZeroDuration(), &quot;InfiniteDuration()&quot;);
45  }
46  TEST(Duration, ValueSemantics) {
47    constexpr absl::Duration a;      
48    constexpr absl::Duration b = a;  
49    constexpr absl::Duration c(b);   
50    absl::Duration d;
51    d = c;  
52  }
53  TEST(Duration, Factories) {
54    constexpr absl::Duration zero = absl::ZeroDuration();
55    constexpr absl::Duration nano = absl::Nanoseconds(1);
56    constexpr absl::Duration micro = absl::Microseconds(1);
57    constexpr absl::Duration milli = absl::Milliseconds(1);
58    constexpr absl::Duration sec = absl::Seconds(1);
59    constexpr absl::Duration min = absl::Minutes(1);
60    constexpr absl::Duration hour = absl::Hours(1);
61    EXPECT_EQ(zero, absl::Duration());
62    EXPECT_EQ(zero, absl::Seconds(0));
63    EXPECT_EQ(nano, absl::Nanoseconds(1));
64    EXPECT_EQ(micro, absl::Nanoseconds(1000));
65    EXPECT_EQ(milli, absl::Microseconds(1000));
66    EXPECT_EQ(sec, absl::Milliseconds(1000));
67    EXPECT_EQ(min, absl::Seconds(60));
68    EXPECT_EQ(hour, absl::Minutes(60));
69    const absl::Duration inf = absl::InfiniteDuration();
70    EXPECT_GT(inf, absl::Seconds(kint64max));
71    EXPECT_LT(-inf, absl::Seconds(kint64min));
72    EXPECT_LT(-inf, absl::Seconds(-kint64max));
73    EXPECT_EQ(inf, absl::Minutes(kint64max));
74    EXPECT_EQ(-inf, absl::Minutes(kint64min));
75    EXPECT_EQ(-inf, absl::Minutes(-kint64max));
76    EXPECT_GT(inf, absl::Minutes(kint64max / 60));
77    EXPECT_LT(-inf, absl::Minutes(kint64min / 60));
78    EXPECT_LT(-inf, absl::Minutes(-kint64max / 60));
79    EXPECT_EQ(inf, absl::Hours(kint64max));
80    EXPECT_EQ(-inf, absl::Hours(kint64min));
81    EXPECT_EQ(-inf, absl::Hours(-kint64max));
82    EXPECT_GT(inf, absl::Hours(kint64max / 3600));
83    EXPECT_LT(-inf, absl::Hours(kint64min / 3600));
84    EXPECT_LT(-inf, absl::Hours(-kint64max / 3600));
85  }
86  TEST(Duration, ToConversion) {
87  #define TEST_DURATION_CONVERSION(UNIT)                                  \
88    do {                                                                  \
89      const absl::Duration d = absl::UNIT(1.5);                           \
90      constexpr absl::Duration z = absl::ZeroDuration();                  \
91      constexpr absl::Duration inf = absl::InfiniteDuration();            \
92      constexpr double dbl_inf = std::numeric_limits&lt;double&gt;::infinity(); \
93      EXPECT_EQ(kint64min, absl::ToInt64##UNIT(-inf));                    \
94      EXPECT_EQ(-1, absl::ToInt64##UNIT(-d));                             \
95      EXPECT_EQ(0, absl::ToInt64##UNIT(z));                               \
96      EXPECT_EQ(1, absl::ToInt64##UNIT(d));                               \
97      EXPECT_EQ(kint64max, absl::ToInt64##UNIT(inf));                     \
98      EXPECT_EQ(-dbl_inf, absl::ToDouble##UNIT(-inf));                    \
99      EXPECT_EQ(-1.5, absl::ToDouble##UNIT(-d));                          \
100      EXPECT_EQ(0, absl::ToDouble##UNIT(z));                              \
101      EXPECT_EQ(1.5, absl::ToDouble##UNIT(d));                            \
102      EXPECT_EQ(dbl_inf, absl::ToDouble##UNIT(inf));                      \
103    } while (0)
104    TEST_DURATION_CONVERSION(Nanoseconds);
105    TEST_DURATION_CONVERSION(Microseconds);
106    TEST_DURATION_CONVERSION(Milliseconds);
107    TEST_DURATION_CONVERSION(Seconds);
108    TEST_DURATION_CONVERSION(Minutes);
109    TEST_DURATION_CONVERSION(Hours);
110  #undef TEST_DURATION_CONVERSION
111  }
112  template &lt;int64_t N&gt;
113  void TestToConversion() {
114    constexpr absl::Duration nano = absl::Nanoseconds(N);
115    EXPECT_EQ(N, absl::ToInt64Nanoseconds(nano));
116    EXPECT_EQ(0, absl::ToInt64Microseconds(nano));
117    EXPECT_EQ(0, absl::ToInt64Milliseconds(nano));
118    EXPECT_EQ(0, absl::ToInt64Seconds(nano));
119    EXPECT_EQ(0, absl::ToInt64Minutes(nano));
120    EXPECT_EQ(0, absl::ToInt64Hours(nano));
121    const absl::Duration micro = absl::Microseconds(N);
122    EXPECT_EQ(N * 1000, absl::ToInt64Nanoseconds(micro));
123    EXPECT_EQ(N, absl::ToInt64Microseconds(micro));
124    EXPECT_EQ(0, absl::ToInt64Milliseconds(micro));
125    EXPECT_EQ(0, absl::ToInt64Seconds(micro));
126    EXPECT_EQ(0, absl::ToInt64Minutes(micro));
127    EXPECT_EQ(0, absl::ToInt64Hours(micro));
128    const absl::Duration milli = absl::Milliseconds(N);
129    EXPECT_EQ(N * 1000 * 1000, absl::ToInt64Nanoseconds(milli));
130    EXPECT_EQ(N * 1000, absl::ToInt64Microseconds(milli));
131    EXPECT_EQ(N, absl::ToInt64Milliseconds(milli));
132    EXPECT_EQ(0, absl::ToInt64Seconds(milli));
133    EXPECT_EQ(0, absl::ToInt64Minutes(milli));
134    EXPECT_EQ(0, absl::ToInt64Hours(milli));
135    const absl::Duration sec = absl::Seconds(N);
136    EXPECT_EQ(N * 1000 * 1000 * 1000, absl::ToInt64Nanoseconds(sec));
137    EXPECT_EQ(N * 1000 * 1000, absl::ToInt64Microseconds(sec));
138    EXPECT_EQ(N * 1000, absl::ToInt64Milliseconds(sec));
139    EXPECT_EQ(N, absl::ToInt64Seconds(sec));
140    EXPECT_EQ(0, absl::ToInt64Minutes(sec));
141    EXPECT_EQ(0, absl::ToInt64Hours(sec));
142    const absl::Duration min = absl::Minutes(N);
143    EXPECT_EQ(N * 60 * 1000 * 1000 * 1000, absl::ToInt64Nanoseconds(min));
144    EXPECT_EQ(N * 60 * 1000 * 1000, absl::ToInt64Microseconds(min));
145    EXPECT_EQ(N * 60 * 1000, absl::ToInt64Milliseconds(min));
146    EXPECT_EQ(N * 60, absl::ToInt64Seconds(min));
147    EXPECT_EQ(N, absl::ToInt64Minutes(min));
148    EXPECT_EQ(0, absl::ToInt64Hours(min));
149    const absl::Duration hour = absl::Hours(N);
150    EXPECT_EQ(N * 60 * 60 * 1000 * 1000 * 1000, absl::ToInt64Nanoseconds(hour));
151    EXPECT_EQ(N * 60 * 60 * 1000 * 1000, absl::ToInt64Microseconds(hour));
152    EXPECT_EQ(N * 60 * 60 * 1000, absl::ToInt64Milliseconds(hour));
153    EXPECT_EQ(N * 60 * 60, absl::ToInt64Seconds(hour));
154    EXPECT_EQ(N * 60, absl::ToInt64Minutes(hour));
155    EXPECT_EQ(N, absl::ToInt64Hours(hour));
156  }
157  TEST(Duration, ToConversionDeprecated) {
158    TestToConversion&lt;43&gt;();
159    TestToConversion&lt;1&gt;();
160    TestToConversion&lt;0&gt;();
161    TestToConversion&lt;-1&gt;();
162    TestToConversion&lt;-43&gt;();
163  }
164  template &lt;int64_t N&gt;
165  void TestFromChronoBasicEquality() {
166    using std::chrono::nanoseconds;
167    using std::chrono::microseconds;
168    using std::chrono::milliseconds;
169    using std::chrono::seconds;
170    using std::chrono::minutes;
171    using std::chrono::hours;
172    static_assert(absl::Nanoseconds(N) == absl::FromChrono(nanoseconds(N)), &quot;&quot;);
173    static_assert(absl::Microseconds(N) == absl::FromChrono(microseconds(N)), &quot;&quot;);
174    static_assert(absl::Milliseconds(N) == absl::FromChrono(milliseconds(N)), &quot;&quot;);
175    static_assert(absl::Seconds(N) == absl::FromChrono(seconds(N)), &quot;&quot;);
176    static_assert(absl::Minutes(N) == absl::FromChrono(minutes(N)), &quot;&quot;);
177    static_assert(absl::Hours(N) == absl::FromChrono(hours(N)), &quot;&quot;);
178  }
179  TEST(Duration, FromChrono) {
180    TestFromChronoBasicEquality&lt;-123&gt;();
181    TestFromChronoBasicEquality&lt;-1&gt;();
182    TestFromChronoBasicEquality&lt;0&gt;();
183    TestFromChronoBasicEquality&lt;1&gt;();
184    TestFromChronoBasicEquality&lt;123&gt;();
185    const auto chrono_minutes_max = std::chrono::minutes::max();
186    const auto minutes_max = absl::FromChrono(chrono_minutes_max);
187    const int64_t minutes_max_count = chrono_minutes_max.count();
188    if (minutes_max_count &gt; kint64max / 60) {
189      EXPECT_EQ(absl::InfiniteDuration(), minutes_max);
190    } else {
191      EXPECT_EQ(absl::Minutes(minutes_max_count), minutes_max);
192    }
193    const auto chrono_minutes_min = std::chrono::minutes::min();
194    const auto minutes_min = absl::FromChrono(chrono_minutes_min);
195    const int64_t minutes_min_count = chrono_minutes_min.count();
196    if (minutes_min_count &lt; kint64min / 60) {
197      EXPECT_EQ(-absl::InfiniteDuration(), minutes_min);
198    } else {
199      EXPECT_EQ(absl::Minutes(minutes_min_count), minutes_min);
200    }
201    const auto chrono_hours_max = std::chrono::hours::max();
202    const auto hours_max = absl::FromChrono(chrono_hours_max);
203    const int64_t hours_max_count = chrono_hours_max.count();
204    if (hours_max_count &gt; kint64max / 3600) {
205      EXPECT_EQ(absl::InfiniteDuration(), hours_max);
206    } else {
207      EXPECT_EQ(absl::Hours(hours_max_count), hours_max);
208    }
209    const auto chrono_hours_min = std::chrono::hours::min();
210    const auto hours_min = absl::FromChrono(chrono_hours_min);
211    const int64_t hours_min_count = chrono_hours_min.count();
212    if (hours_min_count &lt; kint64min / 3600) {
213      EXPECT_EQ(-absl::InfiniteDuration(), hours_min);
214    } else {
215      EXPECT_EQ(absl::Hours(hours_min_count), hours_min);
216    }
217  }
218  template &lt;int64_t N&gt;
219  void TestToChrono() {
220    using std::chrono::nanoseconds;
221    using std::chrono::microseconds;
222    using std::chrono::milliseconds;
223    using std::chrono::seconds;
224    using std::chrono::minutes;
225    using std::chrono::hours;
226    EXPECT_EQ(nanoseconds(N), absl::ToChronoNanoseconds(absl::Nanoseconds(N)));
227    EXPECT_EQ(microseconds(N), absl::ToChronoMicroseconds(absl::Microseconds(N)));
228    EXPECT_EQ(milliseconds(N), absl::ToChronoMilliseconds(absl::Milliseconds(N)));
229    EXPECT_EQ(seconds(N), absl::ToChronoSeconds(absl::Seconds(N)));
230    constexpr auto absl_minutes = absl::Minutes(N);
231    auto chrono_minutes = minutes(N);
232    if (absl_minutes == -absl::InfiniteDuration()) {
233      chrono_minutes = minutes::min();
234    } else if (absl_minutes == absl::InfiniteDuration()) {
235      chrono_minutes = minutes::max();
236    }
237    EXPECT_EQ(chrono_minutes, absl::ToChronoMinutes(absl_minutes));
238    constexpr auto absl_hours = absl::Hours(N);
239    auto chrono_hours = hours(N);
240    if (absl_hours == -absl::InfiniteDuration()) {
241      chrono_hours = hours::min();
242    } else if (absl_hours == absl::InfiniteDuration()) {
243      chrono_hours = hours::max();
244    }
245    EXPECT_EQ(chrono_hours, absl::ToChronoHours(absl_hours));
246  }
247  TEST(Duration, ToChrono) {
248    using std::chrono::nanoseconds;
249    using std::chrono::microseconds;
250    using std::chrono::milliseconds;
251    using std::chrono::seconds;
252    using std::chrono::minutes;
253    using std::chrono::hours;
254    TestToChrono&lt;kint64min&gt;();
255    TestToChrono&lt;-1&gt;();
256    TestToChrono&lt;0&gt;();
257    TestToChrono&lt;1&gt;();
258    TestToChrono&lt;kint64max&gt;();
259    const auto tick = absl::Nanoseconds(1) / 4;
260    EXPECT_EQ(nanoseconds(0), absl::ToChronoNanoseconds(tick));
261    EXPECT_EQ(nanoseconds(0), absl::ToChronoNanoseconds(-tick));
262    EXPECT_EQ(microseconds(0), absl::ToChronoMicroseconds(tick));
263    EXPECT_EQ(microseconds(0), absl::ToChronoMicroseconds(-tick));
264    EXPECT_EQ(milliseconds(0), absl::ToChronoMilliseconds(tick));
265    EXPECT_EQ(milliseconds(0), absl::ToChronoMilliseconds(-tick));
266    EXPECT_EQ(seconds(0), absl::ToChronoSeconds(tick));
267    EXPECT_EQ(seconds(0), absl::ToChronoSeconds(-tick));
268    EXPECT_EQ(minutes(0), absl::ToChronoMinutes(tick));
269    EXPECT_EQ(minutes(0), absl::ToChronoMinutes(-tick));
270    EXPECT_EQ(hours(0), absl::ToChronoHours(tick));
271    EXPECT_EQ(hours(0), absl::ToChronoHours(-tick));
272    constexpr auto inf = absl::InfiniteDuration();
273    EXPECT_EQ(nanoseconds::min(), absl::ToChronoNanoseconds(-inf));
274    EXPECT_EQ(nanoseconds::max(), absl::ToChronoNanoseconds(inf));
275    EXPECT_EQ(microseconds::min(), absl::ToChronoMicroseconds(-inf));
276    EXPECT_EQ(microseconds::max(), absl::ToChronoMicroseconds(inf));
277    EXPECT_EQ(milliseconds::min(), absl::ToChronoMilliseconds(-inf));
278    EXPECT_EQ(milliseconds::max(), absl::ToChronoMilliseconds(inf));
279    EXPECT_EQ(seconds::min(), absl::ToChronoSeconds(-inf));
280    EXPECT_EQ(seconds::max(), absl::ToChronoSeconds(inf));
281    EXPECT_EQ(minutes::min(), absl::ToChronoMinutes(-inf));
282    EXPECT_EQ(minutes::max(), absl::ToChronoMinutes(inf));
283    EXPECT_EQ(hours::min(), absl::ToChronoHours(-inf));
284    EXPECT_EQ(hours::max(), absl::ToChronoHours(inf));
285  }
286  TEST(Duration, FactoryOverloads) {
287    enum E { kOne = 1 };
288  #define TEST_FACTORY_OVERLOADS(NAME)                                          \
289    EXPECT_EQ(1, NAME(kOne) / NAME(kOne));                                      \
290    EXPECT_EQ(1, NAME(static_cast&lt;int8_t&gt;(1)) / NAME(1));                       \
291    EXPECT_EQ(1, NAME(static_cast&lt;int16_t&gt;(1)) / NAME(1));                      \
292    EXPECT_EQ(1, NAME(static_cast&lt;int32_t&gt;(1)) / NAME(1));                      \
293    EXPECT_EQ(1, NAME(static_cast&lt;int64_t&gt;(1)) / NAME(1));                      \
294    EXPECT_EQ(1, NAME(static_cast&lt;uint8_t&gt;(1)) / NAME(1));                      \
295    EXPECT_EQ(1, NAME(static_cast&lt;uint16_t&gt;(1)) / NAME(1));                     \
296    EXPECT_EQ(1, NAME(static_cast&lt;uint32_t&gt;(1)) / NAME(1));                     \
297    EXPECT_EQ(1, NAME(static_cast&lt;uint64_t&gt;(1)) / NAME(1));                     \
298    EXPECT_EQ(NAME(1) / 2, NAME(static_cast&lt;float&gt;(0.5)));                      \
299    EXPECT_EQ(NAME(1) / 2, NAME(static_cast&lt;double&gt;(0.5)));                     \
300    EXPECT_EQ(1.5, absl::FDivDuration(NAME(static_cast&lt;float&gt;(1.5)), NAME(1))); \
301    EXPECT_EQ(1.5, absl::FDivDuration(NAME(static_cast&lt;double&gt;(1.5)), NAME(1)));
302    TEST_FACTORY_OVERLOADS(absl::Nanoseconds);
303    TEST_FACTORY_OVERLOADS(absl::Microseconds);
304    TEST_FACTORY_OVERLOADS(absl::Milliseconds);
305    TEST_FACTORY_OVERLOADS(absl::Seconds);
306    TEST_FACTORY_OVERLOADS(absl::Minutes);
307    TEST_FACTORY_OVERLOADS(absl::Hours);
308  #undef TEST_FACTORY_OVERLOADS
309    EXPECT_EQ(absl::Milliseconds(1500), absl::Seconds(1.5));
310    EXPECT_LT(absl::Nanoseconds(1), absl::Nanoseconds(1.5));
311    EXPECT_GT(absl::Nanoseconds(2), absl::Nanoseconds(1.5));
312    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
313    EXPECT_EQ(absl::InfiniteDuration(), absl::Nanoseconds(dbl_inf));
314    EXPECT_EQ(absl::InfiniteDuration(), absl::Microseconds(dbl_inf));
315    EXPECT_EQ(absl::InfiniteDuration(), absl::Milliseconds(dbl_inf));
316    EXPECT_EQ(absl::InfiniteDuration(), absl::Seconds(dbl_inf));
317    EXPECT_EQ(absl::InfiniteDuration(), absl::Minutes(dbl_inf));
318    EXPECT_EQ(absl::InfiniteDuration(), absl::Hours(dbl_inf));
319    EXPECT_EQ(-absl::InfiniteDuration(), absl::Nanoseconds(-dbl_inf));
320    EXPECT_EQ(-absl::InfiniteDuration(), absl::Microseconds(-dbl_inf));
321    EXPECT_EQ(-absl::InfiniteDuration(), absl::Milliseconds(-dbl_inf));
322    EXPECT_EQ(-absl::InfiniteDuration(), absl::Seconds(-dbl_inf));
323    EXPECT_EQ(-absl::InfiniteDuration(), absl::Minutes(-dbl_inf));
324    EXPECT_EQ(-absl::InfiniteDuration(), absl::Hours(-dbl_inf));
325  }
326  TEST(Duration, InfinityExamples) {
327    constexpr absl::Duration inf = absl::InfiniteDuration();
328    constexpr absl::Duration d = absl::Seconds(1);  
329    EXPECT_TRUE(inf == inf + inf);
330    EXPECT_TRUE(inf == inf + d);
331    EXPECT_TRUE(inf == inf - inf);
332    EXPECT_TRUE(-inf == d - inf);
333    EXPECT_TRUE(inf == d * 1e100);
334    EXPECT_TRUE(0 == d / inf);  
335    EXPECT_TRUE(inf == d / 0);
336    EXPECT_TRUE(kint64max == d / absl::ZeroDuration());
337  }
338  TEST(Duration, InfinityComparison) {
339    const absl::Duration inf = absl::InfiniteDuration();
340    const absl::Duration any_dur = absl::Seconds(1);
341    EXPECT_EQ(inf, inf);
342    EXPECT_EQ(-inf, -inf);
343    EXPECT_NE(inf, -inf);
344    EXPECT_NE(any_dur, inf);
345    EXPECT_NE(any_dur, -inf);
346    EXPECT_GT(inf, any_dur);
347    EXPECT_LT(-inf, any_dur);
348    EXPECT_LT(-inf, inf);
349    EXPECT_GT(inf, -inf);
350  }
351  TEST(Duration, InfinityAddition) {
352    const absl::Duration sec_max = absl::Seconds(kint64max);
353    const absl::Duration sec_min = absl::Seconds(kint64min);
354    const absl::Duration any_dur = absl::Seconds(1);
355    const absl::Duration inf = absl::InfiniteDuration();
356    EXPECT_EQ(inf, inf + inf);
357    EXPECT_EQ(inf, inf + -inf);
358    EXPECT_EQ(-inf, -inf + inf);
359    EXPECT_EQ(-inf, -inf + -inf);
360    EXPECT_EQ(inf, inf + any_dur);
361    EXPECT_EQ(inf, any_dur + inf);
362    EXPECT_EQ(-inf, -inf + any_dur);
363    EXPECT_EQ(-inf, any_dur + -inf);
364    absl::Duration almost_inf = sec_max + absl::Nanoseconds(999999999);
365    EXPECT_GT(inf, almost_inf);
366    almost_inf += -absl::Nanoseconds(999999999);
367    EXPECT_GT(inf, almost_inf);
368    EXPECT_EQ(inf, sec_max + absl::Seconds(1));
369    EXPECT_EQ(inf, sec_max + sec_max);
370    EXPECT_EQ(-inf, sec_min + -absl::Seconds(1));
371    EXPECT_EQ(-inf, sec_min + -sec_max);
372    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
373    EXPECT_TRUE(std::isinf(dbl_inf + dbl_inf));
374    EXPECT_TRUE(std::isnan(dbl_inf + -dbl_inf));  
375    EXPECT_TRUE(std::isnan(-dbl_inf + dbl_inf));  
376    EXPECT_TRUE(std::isinf(-dbl_inf + -dbl_inf));
377  }
378  TEST(Duration, InfinitySubtraction) {
379    const absl::Duration sec_max = absl::Seconds(kint64max);
380    const absl::Duration sec_min = absl::Seconds(kint64min);
381    const absl::Duration any_dur = absl::Seconds(1);
382    const absl::Duration inf = absl::InfiniteDuration();
383    EXPECT_EQ(inf, inf - inf);
384    EXPECT_EQ(inf, inf - -inf);
385    EXPECT_EQ(-inf, -inf - inf);
386    EXPECT_EQ(-inf, -inf - -inf);
387    EXPECT_EQ(inf, inf - any_dur);
388    EXPECT_EQ(-inf, any_dur - inf);
389    EXPECT_EQ(-inf, -inf - any_dur);
390    EXPECT_EQ(inf, any_dur - -inf);
391    EXPECT_EQ(inf, sec_max - -absl::Seconds(1));
392    EXPECT_EQ(inf, sec_max - -sec_max);
393    EXPECT_EQ(-inf, sec_min - absl::Seconds(1));
394    EXPECT_EQ(-inf, sec_min - sec_max);
395    absl::Duration almost_neg_inf = sec_min;
396    EXPECT_LT(-inf, almost_neg_inf);
397    almost_neg_inf -= -absl::Nanoseconds(1);
398    EXPECT_LT(-inf, almost_neg_inf);
399    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
400    EXPECT_TRUE(std::isnan(dbl_inf - dbl_inf));  
401    EXPECT_TRUE(std::isinf(dbl_inf - -dbl_inf));
402    EXPECT_TRUE(std::isinf(-dbl_inf - dbl_inf));
403    EXPECT_TRUE(std::isnan(-dbl_inf - -dbl_inf));  
404  }
405  TEST(Duration, InfinityMultiplication) {
406    const absl::Duration sec_max = absl::Seconds(kint64max);
407    const absl::Duration sec_min = absl::Seconds(kint64min);
408    const absl::Duration inf = absl::InfiniteDuration();
409  #define TEST_INF_MUL_WITH_TYPE(T)                                     \
410    EXPECT_EQ(inf, inf * static_cast&lt;T&gt;(2));                            \
411    EXPECT_EQ(-inf, inf * static_cast&lt;T&gt;(-2));                          \
412    EXPECT_EQ(-inf, -inf * static_cast&lt;T&gt;(2));                          \
413    EXPECT_EQ(inf, -inf * static_cast&lt;T&gt;(-2));                          \
414    EXPECT_EQ(inf, inf * static_cast&lt;T&gt;(0));                            \
415    EXPECT_EQ(-inf, -inf * static_cast&lt;T&gt;(0));                          \
416    EXPECT_EQ(inf, sec_max * static_cast&lt;T&gt;(2));                        \
417    EXPECT_EQ(inf, sec_min * static_cast&lt;T&gt;(-2));                       \
418    EXPECT_EQ(inf, (sec_max / static_cast&lt;T&gt;(2)) * static_cast&lt;T&gt;(3));  \
<span onclick='openModal()' class='match'>419    EXPECT_EQ(-inf, sec_max * static_cast&lt;T&gt;(-2));                      \
420    EXPECT_EQ(-inf, sec_min * static_cast&lt;T&gt;(2));                       \
</span>421    EXPECT_EQ(-inf, (sec_min / static_cast&lt;T&gt;(2)) * static_cast&lt;T&gt;(3));
422    TEST_INF_MUL_WITH_TYPE(int64_t);  
423    TEST_INF_MUL_WITH_TYPE(double);   
424  #undef TEST_INF_MUL_WITH_TYPE
425    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
426    EXPECT_EQ(inf, inf * dbl_inf);
427    EXPECT_EQ(-inf, -inf * dbl_inf);
428    EXPECT_EQ(-inf, inf * -dbl_inf);
429    EXPECT_EQ(inf, -inf * -dbl_inf);
430    const absl::Duration any_dur = absl::Seconds(1);
431    EXPECT_EQ(inf, any_dur * dbl_inf);
432    EXPECT_EQ(-inf, -any_dur * dbl_inf);
433    EXPECT_EQ(-inf, any_dur * -dbl_inf);
434    EXPECT_EQ(inf, -any_dur * -dbl_inf);
435    EXPECT_NE(absl::InfiniteDuration(), absl::Seconds(1) * kint64max);
436    EXPECT_EQ(inf, absl::Seconds(1) * static_cast&lt;double&gt;(kint64max));
437    EXPECT_NE(-absl::InfiniteDuration(), absl::Seconds(1) * kint64min);
438    EXPECT_EQ(-inf, absl::Seconds(1) * static_cast&lt;double&gt;(kint64min));
439    EXPECT_NE(inf, sec_max);
440    EXPECT_NE(inf, sec_max / 1);
441    EXPECT_EQ(inf, sec_max / 1.0);
442    EXPECT_NE(inf, sec_max * 1);
443    EXPECT_EQ(inf, sec_max * 1.0);
444  }
445  TEST(Duration, InfinityDivision) {
446    const absl::Duration sec_max = absl::Seconds(kint64max);
447    const absl::Duration sec_min = absl::Seconds(kint64min);
448    const absl::Duration inf = absl::InfiniteDuration();
449  #define TEST_INF_DIV_WITH_TYPE(T)            \
450    EXPECT_EQ(inf, inf / static_cast&lt;T&gt;(2));   \
451    EXPECT_EQ(-inf, inf / static_cast&lt;T&gt;(-2)); \
452    EXPECT_EQ(-inf, -inf / static_cast&lt;T&gt;(2)); \
453    EXPECT_EQ(inf, -inf / static_cast&lt;T&gt;(-2));
454    TEST_INF_DIV_WITH_TYPE(int64_t);  
455    TEST_INF_DIV_WITH_TYPE(double);   
456  #undef TEST_INF_DIV_WITH_TYPE
457    EXPECT_EQ(inf, sec_max / 0.5);
458    EXPECT_EQ(inf, sec_min / -0.5);
459    EXPECT_EQ(inf, ((sec_max / 0.5) + absl::Seconds(1)) / 0.5);
460    EXPECT_EQ(-inf, sec_max / -0.5);
461    EXPECT_EQ(-inf, sec_min / 0.5);
462    EXPECT_EQ(-inf, ((sec_min / 0.5) - absl::Seconds(1)) / 0.5);
463    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
464    EXPECT_EQ(inf, inf / dbl_inf);
465    EXPECT_EQ(-inf, inf / -dbl_inf);
466    EXPECT_EQ(-inf, -inf / dbl_inf);
467    EXPECT_EQ(inf, -inf / -dbl_inf);
468    const absl::Duration any_dur = absl::Seconds(1);
469    EXPECT_EQ(absl::ZeroDuration(), any_dur / dbl_inf);
470    EXPECT_EQ(absl::ZeroDuration(), any_dur / -dbl_inf);
471    EXPECT_EQ(absl::ZeroDuration(), -any_dur / dbl_inf);
472    EXPECT_EQ(absl::ZeroDuration(), -any_dur / -dbl_inf);
473  }
474  TEST(Duration, InfinityModulus) {
475    const absl::Duration sec_max = absl::Seconds(kint64max);
476    const absl::Duration any_dur = absl::Seconds(1);
477    const absl::Duration inf = absl::InfiniteDuration();
478    EXPECT_EQ(inf, inf % inf);
479    EXPECT_EQ(inf, inf % -inf);
480    EXPECT_EQ(-inf, -inf % -inf);
481    EXPECT_EQ(-inf, -inf % inf);
482    EXPECT_EQ(any_dur, any_dur % inf);
483    EXPECT_EQ(any_dur, any_dur % -inf);
484    EXPECT_EQ(-any_dur, -any_dur % inf);
485    EXPECT_EQ(-any_dur, -any_dur % -inf);
486    EXPECT_EQ(inf, inf % -any_dur);
487    EXPECT_EQ(inf, inf % any_dur);
488    EXPECT_EQ(-inf, -inf % -any_dur);
489    EXPECT_EQ(-inf, -inf % any_dur);
490    EXPECT_EQ(absl::ZeroDuration(), sec_max % absl::Seconds(1));
491    EXPECT_EQ(absl::ZeroDuration(), sec_max % absl::Milliseconds(1));
492    EXPECT_EQ(absl::ZeroDuration(), sec_max % absl::Microseconds(1));
493    EXPECT_EQ(absl::ZeroDuration(), sec_max % absl::Nanoseconds(1));
494    EXPECT_EQ(absl::ZeroDuration(), sec_max % absl::Nanoseconds(1) / 4);
495  }
496  TEST(Duration, InfinityIDiv) {
497    const absl::Duration sec_max = absl::Seconds(kint64max);
498    const absl::Duration any_dur = absl::Seconds(1);
499    const absl::Duration inf = absl::InfiniteDuration();
500    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
501    absl::Duration rem = absl::ZeroDuration();
502    EXPECT_EQ(kint64max, absl::IDivDuration(inf, inf, &amp;rem));
503    EXPECT_EQ(inf, rem);
504    rem = absl::ZeroDuration();
505    EXPECT_EQ(kint64max, absl::IDivDuration(-inf, -inf, &amp;rem));
506    EXPECT_EQ(-inf, rem);
507    rem = absl::ZeroDuration();
508    EXPECT_EQ(kint64max, absl::IDivDuration(inf, any_dur, &amp;rem));
509    EXPECT_EQ(inf, rem);
510    rem = absl::ZeroDuration();
511    EXPECT_EQ(0, absl::IDivDuration(any_dur, inf, &amp;rem));
512    EXPECT_EQ(any_dur, rem);
513    rem = absl::ZeroDuration();
514    EXPECT_EQ(kint64max, absl::IDivDuration(-inf, -any_dur, &amp;rem));
515    EXPECT_EQ(-inf, rem);
516    rem = absl::ZeroDuration();
517    EXPECT_EQ(0, absl::IDivDuration(-any_dur, -inf, &amp;rem));
518    EXPECT_EQ(-any_dur, rem);
519    rem = absl::ZeroDuration();
520    EXPECT_EQ(kint64min, absl::IDivDuration(-inf, inf, &amp;rem));
521    EXPECT_EQ(-inf, rem);
522    rem = absl::ZeroDuration();
523    EXPECT_EQ(kint64min, absl::IDivDuration(inf, -inf, &amp;rem));
524    EXPECT_EQ(inf, rem);
525    rem = absl::ZeroDuration();
526    EXPECT_EQ(kint64min, absl::IDivDuration(-inf, any_dur, &amp;rem));
527    EXPECT_EQ(-inf, rem);
528    rem = absl::ZeroDuration();
529    EXPECT_EQ(0, absl::IDivDuration(-any_dur, inf, &amp;rem));
530    EXPECT_EQ(-any_dur, rem);
531    rem = absl::ZeroDuration();
532    EXPECT_EQ(kint64min, absl::IDivDuration(inf, -any_dur, &amp;rem));
533    EXPECT_EQ(inf, rem);
534    rem = absl::ZeroDuration();
535    EXPECT_EQ(0, absl::IDivDuration(any_dur, -inf, &amp;rem));
536    EXPECT_EQ(any_dur, rem);
537    rem = any_dur;
538    EXPECT_EQ(kint64max,
539              absl::IDivDuration(sec_max, absl::Nanoseconds(1) / 4, &amp;rem));
540    EXPECT_EQ(sec_max - absl::Nanoseconds(kint64max) / 4, rem);
541    rem = any_dur;
542    EXPECT_EQ(kint64max,
543              absl::IDivDuration(sec_max, absl::Milliseconds(1), &amp;rem));
544    EXPECT_EQ(sec_max - absl::Milliseconds(kint64max), rem);
545    rem = any_dur;
546    EXPECT_EQ(kint64max,
547              absl::IDivDuration(-sec_max, -absl::Milliseconds(1), &amp;rem));
548    EXPECT_EQ(-sec_max + absl::Milliseconds(kint64max), rem);
549    rem = any_dur;
550    EXPECT_EQ(kint64min,
551              absl::IDivDuration(-sec_max, absl::Milliseconds(1), &amp;rem));
552    EXPECT_EQ(-sec_max - absl::Milliseconds(kint64min), rem);
553    rem = any_dur;
554    EXPECT_EQ(kint64min,
555              absl::IDivDuration(sec_max, -absl::Milliseconds(1), &amp;rem));
556    EXPECT_EQ(sec_max + absl::Milliseconds(kint64min), rem);
557    EXPECT_TRUE(std::isnan(dbl_inf / dbl_inf));
558    EXPECT_EQ(kint64max, inf / inf);
559    EXPECT_EQ(kint64max, -inf / -inf);
560    EXPECT_EQ(kint64min, -inf / inf);
561    EXPECT_EQ(kint64min, inf / -inf);
562    EXPECT_TRUE(std::isinf(dbl_inf / 2.0));
563    EXPECT_EQ(kint64max, inf / any_dur);
564    EXPECT_EQ(kint64max, -inf / -any_dur);
565    EXPECT_EQ(kint64min, -inf / any_dur);
566    EXPECT_EQ(kint64min, inf / -any_dur);
567    EXPECT_EQ(0.0, 2.0 / dbl_inf);
568    EXPECT_EQ(0, any_dur / inf);
569    EXPECT_EQ(0, any_dur / -inf);
570    EXPECT_EQ(0, -any_dur / inf);
571    EXPECT_EQ(0, -any_dur / -inf);
572    EXPECT_EQ(0, absl::ZeroDuration() / inf);
573    EXPECT_EQ(kint64max, sec_max / absl::Milliseconds(1));
574    EXPECT_EQ(kint64max, -sec_max / -absl::Milliseconds(1));
575    EXPECT_EQ(kint64min, -sec_max / absl::Milliseconds(1));
576    EXPECT_EQ(kint64min, sec_max / -absl::Milliseconds(1));
577  }
578  TEST(Duration, InfinityFDiv) {
579    const absl::Duration any_dur = absl::Seconds(1);
580    const absl::Duration inf = absl::InfiniteDuration();
581    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
582    EXPECT_EQ(dbl_inf, absl::FDivDuration(inf, inf));
583    EXPECT_EQ(dbl_inf, absl::FDivDuration(-inf, -inf));
584    EXPECT_EQ(dbl_inf, absl::FDivDuration(inf, any_dur));
585    EXPECT_EQ(0.0, absl::FDivDuration(any_dur, inf));
586    EXPECT_EQ(dbl_inf, absl::FDivDuration(-inf, -any_dur));
587    EXPECT_EQ(0.0, absl::FDivDuration(-any_dur, -inf));
588    EXPECT_EQ(-dbl_inf, absl::FDivDuration(-inf, inf));
589    EXPECT_EQ(-dbl_inf, absl::FDivDuration(inf, -inf));
590    EXPECT_EQ(-dbl_inf, absl::FDivDuration(-inf, any_dur));
591    EXPECT_EQ(0.0, absl::FDivDuration(-any_dur, inf));
592    EXPECT_EQ(-dbl_inf, absl::FDivDuration(inf, -any_dur));
593    EXPECT_EQ(0.0, absl::FDivDuration(any_dur, -inf));
594  }
595  TEST(Duration, DivisionByZero) {
596    const absl::Duration zero = absl::ZeroDuration();
597    const absl::Duration inf = absl::InfiniteDuration();
598    const absl::Duration any_dur = absl::Seconds(1);
599    const double dbl_inf = std::numeric_limits&lt;double&gt;::infinity();
600    const double dbl_denorm = std::numeric_limits&lt;double&gt;::denorm_min();
601    EXPECT_EQ(inf, zero / 0.0);
602    EXPECT_EQ(-inf, zero / -0.0);
603    EXPECT_EQ(inf, any_dur / 0.0);
604    EXPECT_EQ(-inf, any_dur / -0.0);
605    EXPECT_EQ(-inf, -any_dur / 0.0);
606    EXPECT_EQ(inf, -any_dur / -0.0);
607    EXPECT_EQ(zero, zero / dbl_denorm);
608    EXPECT_EQ(zero, zero / -dbl_denorm);
609    EXPECT_EQ(inf, any_dur / dbl_denorm);
610    EXPECT_EQ(-inf, any_dur / -dbl_denorm);
611    EXPECT_EQ(-inf, -any_dur / dbl_denorm);
612    EXPECT_EQ(inf, -any_dur / -dbl_denorm);
613    absl::Duration rem = zero;
614    EXPECT_EQ(kint64max, absl::IDivDuration(zero, zero, &amp;rem));
615    EXPECT_EQ(inf, rem);
616    rem = zero;
617    EXPECT_EQ(kint64max, absl::IDivDuration(any_dur, zero, &amp;rem));
618    EXPECT_EQ(inf, rem);
619    rem = zero;
620    EXPECT_EQ(kint64min, absl::IDivDuration(-any_dur, zero, &amp;rem));
621    EXPECT_EQ(-inf, rem);
622    EXPECT_EQ(kint64max, zero / zero);
623    EXPECT_EQ(kint64max, any_dur / zero);
624    EXPECT_EQ(kint64min, -any_dur / zero);
625    EXPECT_EQ(dbl_inf, absl::FDivDuration(zero, zero));
626    EXPECT_EQ(dbl_inf, absl::FDivDuration(any_dur, zero));
627    EXPECT_EQ(-dbl_inf, absl::FDivDuration(-any_dur, zero));
628  }
629  TEST(Duration, NaN) {
630  #define TEST_NAN_HANDLING(NAME, NAN)           \
631    do {                                         \
632      const auto inf = absl::InfiniteDuration(); \
633      auto x = NAME(NAN);                        \
634      EXPECT_TRUE(x == inf || x == -inf);        \
635      auto y = NAME(42);                         \
636      y *= NAN;                                  \
637      EXPECT_TRUE(y == inf || y == -inf);        \
638      auto z = NAME(42);                         \
639      z /= NAN;                                  \
640      EXPECT_TRUE(z == inf || z == -inf);        \
641    } while (0)
642    const double nan = std::numeric_limits&lt;double&gt;::quiet_NaN();
643    TEST_NAN_HANDLING(absl::Nanoseconds, nan);
644    TEST_NAN_HANDLING(absl::Microseconds, nan);
645    TEST_NAN_HANDLING(absl::Milliseconds, nan);
646    TEST_NAN_HANDLING(absl::Seconds, nan);
647    TEST_NAN_HANDLING(absl::Minutes, nan);
648    TEST_NAN_HANDLING(absl::Hours, nan);
649    TEST_NAN_HANDLING(absl::Nanoseconds, -nan);
650    TEST_NAN_HANDLING(absl::Microseconds, -nan);
651    TEST_NAN_HANDLING(absl::Milliseconds, -nan);
652    TEST_NAN_HANDLING(absl::Seconds, -nan);
653    TEST_NAN_HANDLING(absl::Minutes, -nan);
654    TEST_NAN_HANDLING(absl::Hours, -nan);
655  #undef TEST_NAN_HANDLING
656  }
657  TEST(Duration, Range) {
658    const absl::Duration range = ApproxYears(100 * 1e9);
659    const absl::Duration range_future = range;
660    const absl::Duration range_past = -range;
661    EXPECT_LT(range_future, absl::InfiniteDuration());
662    EXPECT_GT(range_past, -absl::InfiniteDuration());
663    const absl::Duration full_range = range_future - range_past;
664    EXPECT_GT(full_range, absl::ZeroDuration());
665    EXPECT_LT(full_range, absl::InfiniteDuration());
666    const absl::Duration neg_full_range = range_past - range_future;
667    EXPECT_LT(neg_full_range, absl::ZeroDuration());
668    EXPECT_GT(neg_full_range, -absl::InfiniteDuration());
669    EXPECT_LT(neg_full_range, full_range);
670    EXPECT_EQ(neg_full_range, -full_range);
671  }
672  TEST(Duration, RelationalOperators) {
673  #define TEST_REL_OPS(UNIT)               \
674    static_assert(UNIT(2) == UNIT(2), &quot;&quot;); \
675    static_assert(UNIT(1) != UNIT(2), &quot;&quot;); \
676    static_assert(UNIT(1) &lt; UNIT(2), &quot;&quot;);  \
677    static_assert(UNIT(3) &gt; UNIT(2), &quot;&quot;);  \
678    static_assert(UNIT(1) &lt;= UNIT(2), &quot;&quot;); \
679    static_assert(UNIT(2) &lt;= UNIT(2), &quot;&quot;); \
680    static_assert(UNIT(3) &gt;= UNIT(2), &quot;&quot;); \
681    static_assert(UNIT(2) &gt;= UNIT(2), &quot;&quot;);
682    TEST_REL_OPS(absl::Nanoseconds);
683    TEST_REL_OPS(absl::Microseconds);
684    TEST_REL_OPS(absl::Milliseconds);
685    TEST_REL_OPS(absl::Seconds);
686    TEST_REL_OPS(absl::Minutes);
687    TEST_REL_OPS(absl::Hours);
688  #undef TEST_REL_OPS
689  }
690  TEST(Duration, Addition) {
691  #define TEST_ADD_OPS(UNIT)                  \
692    do {                                      \
693      EXPECT_EQ(UNIT(2), UNIT(1) + UNIT(1));  \
694      EXPECT_EQ(UNIT(1), UNIT(2) - UNIT(1));  \
695      EXPECT_EQ(UNIT(0), UNIT(2) - UNIT(2));  \
696      EXPECT_EQ(UNIT(-1), UNIT(1) - UNIT(2)); \
697      EXPECT_EQ(UNIT(-2), UNIT(0) - UNIT(2)); \
698      EXPECT_EQ(UNIT(-2), UNIT(1) - UNIT(3)); \
699      absl::Duration a = UNIT(1);             \
700      a += UNIT(1);                           \
701      EXPECT_EQ(UNIT(2), a);                  \
702      a -= UNIT(1);                           \
703      EXPECT_EQ(UNIT(1), a);                  \
704    } while (0)
705    TEST_ADD_OPS(absl::Nanoseconds);
706    TEST_ADD_OPS(absl::Microseconds);
707    TEST_ADD_OPS(absl::Milliseconds);
708    TEST_ADD_OPS(absl::Seconds);
709    TEST_ADD_OPS(absl::Minutes);
710    TEST_ADD_OPS(absl::Hours);
711  #undef TEST_ADD_OPS
712    EXPECT_EQ(absl::Seconds(2), absl::Seconds(3) - 2 * absl::Milliseconds(500));
713    EXPECT_EQ(absl::Seconds(2) + absl::Milliseconds(500),
714              absl::Seconds(3) - absl::Milliseconds(500));
715    EXPECT_EQ(absl::Seconds(1) + absl::Milliseconds(998),
716              absl::Milliseconds(999) + absl::Milliseconds(999));
717    EXPECT_EQ(absl::Milliseconds(-1),
718              absl::Milliseconds(998) - absl::Milliseconds(999));
719    EXPECT_GT(absl::Nanoseconds(1), absl::Nanoseconds(1) / 2);
720    EXPECT_EQ(absl::Nanoseconds(1),
721              absl::Nanoseconds(1) / 2 + absl::Nanoseconds(1) / 2);
722    EXPECT_GT(absl::Nanoseconds(1) / 4, absl::Nanoseconds(0));
723    EXPECT_EQ(absl::Nanoseconds(1) / 8, absl::Nanoseconds(0));
724    absl::Duration d_7_5 = absl::Seconds(7) + absl::Milliseconds(500);
725    absl::Duration d_3_7 = absl::Seconds(3) + absl::Milliseconds(700);
726    absl::Duration ans_3_8 = absl::Seconds(3) + absl::Milliseconds(800);
727    EXPECT_EQ(ans_3_8, d_7_5 - d_3_7);
728    absl::Duration min_dur = absl::Seconds(kint64min);
729    EXPECT_EQ(absl::Seconds(0), min_dur - min_dur);
730    EXPECT_EQ(absl::Seconds(kint64max), absl::Seconds(-1) - min_dur);
731  }
732  TEST(Duration, Negation) {
733    constexpr absl::Duration negated_zero_duration = -absl::ZeroDuration();
734    EXPECT_EQ(negated_zero_duration, absl::ZeroDuration());
735    constexpr absl::Duration negated_infinite_duration =
736        -absl::InfiniteDuration();
737    EXPECT_NE(negated_infinite_duration, absl::InfiniteDuration());
738    EXPECT_EQ(-negated_infinite_duration, absl::InfiniteDuration());
739    EXPECT_TRUE(
740        absl::time_internal::IsInfiniteDuration(negated_infinite_duration));
741    constexpr absl::Duration max_duration = absl::time_internal::MakeDuration(
742        kint64max, absl::time_internal::kTicksPerSecond - 1);
743    constexpr absl::Duration negated_max_duration = -max_duration;
744    constexpr absl::Duration nearly_min_duration =
745        absl::time_internal::MakeDuration(kint64min, int64_t{1});
746    constexpr absl::Duration negated_nearly_min_duration = -nearly_min_duration;
747    EXPECT_EQ(negated_max_duration, nearly_min_duration);
748    EXPECT_EQ(negated_nearly_min_duration, max_duration);
749    EXPECT_EQ(-(-max_duration), max_duration);
750    constexpr absl::Duration min_duration =
751        absl::time_internal::MakeDuration(kint64min);
752    constexpr absl::Duration negated_min_duration = -min_duration;
753    EXPECT_EQ(negated_min_duration, absl::InfiniteDuration());
754  }
755  TEST(Duration, AbsoluteValue) {
756    EXPECT_EQ(absl::ZeroDuration(), AbsDuration(absl::ZeroDuration()));
757    EXPECT_EQ(absl::Seconds(1), AbsDuration(absl::Seconds(1)));
758    EXPECT_EQ(absl::Seconds(1), AbsDuration(absl::Seconds(-1)));
759    EXPECT_EQ(absl::InfiniteDuration(), AbsDuration(absl::InfiniteDuration()));
760    EXPECT_EQ(absl::InfiniteDuration(), AbsDuration(-absl::InfiniteDuration()));
761    absl::Duration max_dur =
762        absl::Seconds(kint64max) + (absl::Seconds(1) - absl::Nanoseconds(1) / 4);
763    EXPECT_EQ(max_dur, AbsDuration(max_dur));
764    absl::Duration min_dur = absl::Seconds(kint64min);
765    EXPECT_EQ(absl::InfiniteDuration(), AbsDuration(min_dur));
766    EXPECT_EQ(max_dur, AbsDuration(min_dur + absl::Nanoseconds(1) / 4));
767  }
768  TEST(Duration, Multiplication) {
769  #define TEST_MUL_OPS(UNIT)                                    \
770    do {                                                        \
771      EXPECT_EQ(UNIT(5), UNIT(2) * 2.5);                        \
772      EXPECT_EQ(UNIT(2), UNIT(5) / 2.5);                        \
773      EXPECT_EQ(UNIT(-5), UNIT(-2) * 2.5);                      \
774      EXPECT_EQ(UNIT(-5), -UNIT(2) * 2.5);                      \
775      EXPECT_EQ(UNIT(-5), UNIT(2) * -2.5);                      \
776      EXPECT_EQ(UNIT(-2), UNIT(-5) / 2.5);                      \
777      EXPECT_EQ(UNIT(-2), -UNIT(5) / 2.5);                      \
778      EXPECT_EQ(UNIT(-2), UNIT(5) / -2.5);                      \
779      EXPECT_EQ(UNIT(2), UNIT(11) % UNIT(3));                   \
780      absl::Duration a = UNIT(2);                               \
781      a *= 2.5;                                                 \
782      EXPECT_EQ(UNIT(5), a);                                    \
783      a /= 2.5;                                                 \
784      EXPECT_EQ(UNIT(2), a);                                    \
785      a %= UNIT(1);                                             \
786      EXPECT_EQ(UNIT(0), a);                                    \
787      absl::Duration big = UNIT(1000000000);                    \
788      big *= 3;                                                 \
789      big /= 3;                                                 \
790      EXPECT_EQ(UNIT(1000000000), big);                         \
791      EXPECT_EQ(-UNIT(2), -UNIT(2));                            \
792      EXPECT_EQ(-UNIT(2), UNIT(2) * -1);                        \
793      EXPECT_EQ(-UNIT(2), -1 * UNIT(2));                        \
794      EXPECT_EQ(-UNIT(-2), UNIT(2));                            \
795      EXPECT_EQ(2, UNIT(2) / UNIT(1));                          \
796      absl::Duration rem;                                       \
797      EXPECT_EQ(2, absl::IDivDuration(UNIT(2), UNIT(1), &amp;rem)); \
798      EXPECT_EQ(2.0, absl::FDivDuration(UNIT(2), UNIT(1)));     \
799    } while (0)
800    TEST_MUL_OPS(absl::Nanoseconds);
801    TEST_MUL_OPS(absl::Microseconds);
802    TEST_MUL_OPS(absl::Milliseconds);
803    TEST_MUL_OPS(absl::Seconds);
804    TEST_MUL_OPS(absl::Minutes);
805    TEST_MUL_OPS(absl::Hours);
806  #undef TEST_MUL_OPS
807    absl::Duration max_dur =
808        absl::Seconds(kint64max) + (absl::Seconds(1) - absl::Nanoseconds(1) / 4);
809    absl::Duration min_dur = absl::Seconds(kint64min);
810    EXPECT_EQ(max_dur, max_dur * 1);
811    EXPECT_EQ(max_dur, max_dur / 1);
812    EXPECT_EQ(min_dur, min_dur * 1);
813    EXPECT_EQ(min_dur, min_dur / 1);
814    absl::Duration sigfigs = absl::Seconds(2000000000) + absl::Nanoseconds(3);
815    EXPECT_EQ(absl::Seconds(666666666) + absl::Nanoseconds(666666667) +
816                  absl::Nanoseconds(1) / 2,
817              sigfigs / 3);
818    sigfigs = absl::Seconds(int64_t{7000000000});
819    EXPECT_EQ(absl::Seconds(2333333333) + absl::Nanoseconds(333333333) +
820                  absl::Nanoseconds(1) / 4,
821              sigfigs / 3);
822    EXPECT_EQ(absl::Seconds(7) + absl::Milliseconds(500), absl::Seconds(3) * 2.5);
823    EXPECT_EQ(absl::Seconds(8) * -1 + absl::Milliseconds(300),
824              (absl::Seconds(2) + absl::Milliseconds(200)) * -3.5);
825    EXPECT_EQ(-absl::Seconds(8) + absl::Milliseconds(300),
826              (absl::Seconds(2) + absl::Milliseconds(200)) * -3.5);
827    EXPECT_EQ(absl::Seconds(1) + absl::Milliseconds(875),
828              (absl::Seconds(7) + absl::Milliseconds(500)) / 4);
829    EXPECT_EQ(absl::Seconds(30),
830              (absl::Seconds(7) + absl::Milliseconds(500)) / 0.25);
831    EXPECT_EQ(absl::Seconds(3),
832              (absl::Seconds(7) + absl::Milliseconds(500)) / 2.5);
833    EXPECT_EQ(absl::Nanoseconds(0), absl::Nanoseconds(7) % absl::Nanoseconds(1));
834    EXPECT_EQ(absl::Nanoseconds(0), absl::Nanoseconds(0) % absl::Nanoseconds(10));
835    EXPECT_EQ(absl::Nanoseconds(2), absl::Nanoseconds(7) % absl::Nanoseconds(5));
836    EXPECT_EQ(absl::Nanoseconds(2), absl::Nanoseconds(2) % absl::Nanoseconds(5));
837    EXPECT_EQ(absl::Nanoseconds(1), absl::Nanoseconds(10) % absl::Nanoseconds(3));
838    EXPECT_EQ(absl::Nanoseconds(1),
839              absl::Nanoseconds(10) % absl::Nanoseconds(-3));
840    EXPECT_EQ(absl::Nanoseconds(-1),
841              absl::Nanoseconds(-10) % absl::Nanoseconds(3));
842    EXPECT_EQ(absl::Nanoseconds(-1),
843              absl::Nanoseconds(-10) % absl::Nanoseconds(-3));
844    EXPECT_EQ(absl::Milliseconds(100),
845              absl::Seconds(1) % absl::Milliseconds(300));
846    EXPECT_EQ(
847        absl::Milliseconds(300),
848        (absl::Seconds(3) + absl::Milliseconds(800)) % absl::Milliseconds(500));
849    EXPECT_EQ(absl::Nanoseconds(1), absl::Nanoseconds(1) % absl::Seconds(1));
850    EXPECT_EQ(absl::Nanoseconds(-1), absl::Nanoseconds(-1) % absl::Seconds(1));
851    EXPECT_EQ(0, absl::Nanoseconds(-1) / absl::Seconds(1));  
852  #define TEST_MOD_IDENTITY(a, b) \
853    EXPECT_EQ((a), ((a) / (b))*(b) + ((a)%(b)))
854    TEST_MOD_IDENTITY(absl::Seconds(0), absl::Seconds(2));
855    TEST_MOD_IDENTITY(absl::Seconds(1), absl::Seconds(1));
856    TEST_MOD_IDENTITY(absl::Seconds(1), absl::Seconds(2));
857    TEST_MOD_IDENTITY(absl::Seconds(2), absl::Seconds(1));
858    TEST_MOD_IDENTITY(absl::Seconds(-2), absl::Seconds(1));
859    TEST_MOD_IDENTITY(absl::Seconds(2), absl::Seconds(-1));
860    TEST_MOD_IDENTITY(absl::Seconds(-2), absl::Seconds(-1));
861    TEST_MOD_IDENTITY(absl::Nanoseconds(0), absl::Nanoseconds(2));
862    TEST_MOD_IDENTITY(absl::Nanoseconds(1), absl::Nanoseconds(1));
863    TEST_MOD_IDENTITY(absl::Nanoseconds(1), absl::Nanoseconds(2));
864    TEST_MOD_IDENTITY(absl::Nanoseconds(2), absl::Nanoseconds(1));
865    TEST_MOD_IDENTITY(absl::Nanoseconds(-2), absl::Nanoseconds(1));
866    TEST_MOD_IDENTITY(absl::Nanoseconds(2), absl::Nanoseconds(-1));
867    TEST_MOD_IDENTITY(absl::Nanoseconds(-2), absl::Nanoseconds(-1));
868    absl::Duration mixed_a = absl::Seconds(1) + absl::Nanoseconds(2);
869    absl::Duration mixed_b = absl::Seconds(1) + absl::Nanoseconds(3);
870    TEST_MOD_IDENTITY(absl::Seconds(0), mixed_a);
871    TEST_MOD_IDENTITY(mixed_a, mixed_a);
872    TEST_MOD_IDENTITY(mixed_a, mixed_b);
873    TEST_MOD_IDENTITY(mixed_b, mixed_a);
874    TEST_MOD_IDENTITY(-mixed_a, mixed_b);
875    TEST_MOD_IDENTITY(mixed_a, -mixed_b);
876    TEST_MOD_IDENTITY(-mixed_a, -mixed_b);
877  #undef TEST_MOD_IDENTITY
878  }
879  TEST(Duration, Truncation) {
880    const absl::Duration d = absl::Nanoseconds(1234567890);
881    const absl::Duration inf = absl::InfiniteDuration();
882    for (int unit_sign : {1, -1}) {  
883      EXPECT_EQ(absl::Nanoseconds(1234567890),
884                Trunc(d, unit_sign * absl::Nanoseconds(1)));
885      EXPECT_EQ(absl::Microseconds(1234567),
886                Trunc(d, unit_sign * absl::Microseconds(1)));
887      EXPECT_EQ(absl::Milliseconds(1234),
888                Trunc(d, unit_sign * absl::Milliseconds(1)));
889      EXPECT_EQ(absl::Seconds(1), Trunc(d, unit_sign * absl::Seconds(1)));
890      EXPECT_EQ(inf, Trunc(inf, unit_sign * absl::Seconds(1)));
891      EXPECT_EQ(absl::Nanoseconds(-1234567890),
892                Trunc(-d, unit_sign * absl::Nanoseconds(1)));
893      EXPECT_EQ(absl::Microseconds(-1234567),
894                Trunc(-d, unit_sign * absl::Microseconds(1)));
895      EXPECT_EQ(absl::Milliseconds(-1234),
896                Trunc(-d, unit_sign * absl::Milliseconds(1)));
897      EXPECT_EQ(absl::Seconds(-1), Trunc(-d, unit_sign * absl::Seconds(1)));
898      EXPECT_EQ(-inf, Trunc(-inf, unit_sign * absl::Seconds(1)));
899    }
900  }
901  TEST(Duration, Flooring) {
902    const absl::Duration d = absl::Nanoseconds(1234567890);
903    const absl::Duration inf = absl::InfiniteDuration();
904    for (int unit_sign : {1, -1}) {  
905      EXPECT_EQ(absl::Nanoseconds(1234567890),
906                absl::Floor(d, unit_sign * absl::Nanoseconds(1)));
907      EXPECT_EQ(absl::Microseconds(1234567),
908                absl::Floor(d, unit_sign * absl::Microseconds(1)));
909      EXPECT_EQ(absl::Milliseconds(1234),
910                absl::Floor(d, unit_sign * absl::Milliseconds(1)));
911      EXPECT_EQ(absl::Seconds(1), absl::Floor(d, unit_sign * absl::Seconds(1)));
912      EXPECT_EQ(inf, absl::Floor(inf, unit_sign * absl::Seconds(1)));
913      EXPECT_EQ(absl::Nanoseconds(-1234567890),
914                absl::Floor(-d, unit_sign * absl::Nanoseconds(1)));
915      EXPECT_EQ(absl::Microseconds(-1234568),
916                absl::Floor(-d, unit_sign * absl::Microseconds(1)));
917      EXPECT_EQ(absl::Milliseconds(-1235),
918                absl::Floor(-d, unit_sign * absl::Milliseconds(1)));
919      EXPECT_EQ(absl::Seconds(-2), absl::Floor(-d, unit_sign * absl::Seconds(1)));
920      EXPECT_EQ(-inf, absl::Floor(-inf, unit_sign * absl::Seconds(1)));
921    }
922  }
923  TEST(Duration, Ceiling) {
924    const absl::Duration d = absl::Nanoseconds(1234567890);
925    const absl::Duration inf = absl::InfiniteDuration();
926    for (int unit_sign : {1, -1}) {  
927      EXPECT_EQ(absl::Nanoseconds(1234567890),
928                absl::Ceil(d, unit_sign * absl::Nanoseconds(1)));
929      EXPECT_EQ(absl::Microseconds(1234568),
930                absl::Ceil(d, unit_sign * absl::Microseconds(1)));
931      EXPECT_EQ(absl::Milliseconds(1235),
932                absl::Ceil(d, unit_sign * absl::Milliseconds(1)));
933      EXPECT_EQ(absl::Seconds(2), absl::Ceil(d, unit_sign * absl::Seconds(1)));
934      EXPECT_EQ(inf, absl::Ceil(inf, unit_sign * absl::Seconds(1)));
935      EXPECT_EQ(absl::Nanoseconds(-1234567890),
936                absl::Ceil(-d, unit_sign * absl::Nanoseconds(1)));
937      EXPECT_EQ(absl::Microseconds(-1234567),
938                absl::Ceil(-d, unit_sign * absl::Microseconds(1)));
939      EXPECT_EQ(absl::Milliseconds(-1234),
940                absl::Ceil(-d, unit_sign * absl::Milliseconds(1)));
941      EXPECT_EQ(absl::Seconds(-1), absl::Ceil(-d, unit_sign * absl::Seconds(1)));
942      EXPECT_EQ(-inf, absl::Ceil(-inf, unit_sign * absl::Seconds(1)));
943    }
944  }
945  TEST(Duration, RoundTripUnits) {
946    const int kRange = 100000;
947  #define ROUND_TRIP_UNIT(U, LOW, HIGH)          \
948    do {                                         \
949      for (int64_t i = LOW; i &lt; HIGH; ++i) {     \
950        absl::Duration d = absl::U(i);           \
951        if (d == absl::InfiniteDuration())       \
952          EXPECT_EQ(kint64max, d / absl::U(1));  \
953        else if (d == -absl::InfiniteDuration()) \
954          EXPECT_EQ(kint64min, d / absl::U(1));  \
955        else                                     \
956          EXPECT_EQ(i, absl::U(i) / absl::U(1)); \
957      }                                          \
958    } while (0)
959    ROUND_TRIP_UNIT(Nanoseconds, kint64min, kint64min + kRange);
960    ROUND_TRIP_UNIT(Nanoseconds, -kRange, kRange);
961    ROUND_TRIP_UNIT(Nanoseconds, kint64max - kRange, kint64max);
962    ROUND_TRIP_UNIT(Microseconds, kint64min, kint64min + kRange);
963    ROUND_TRIP_UNIT(Microseconds, -kRange, kRange);
964    ROUND_TRIP_UNIT(Microseconds, kint64max - kRange, kint64max);
965    ROUND_TRIP_UNIT(Milliseconds, kint64min, kint64min + kRange);
966    ROUND_TRIP_UNIT(Milliseconds, -kRange, kRange);
967    ROUND_TRIP_UNIT(Milliseconds, kint64max - kRange, kint64max);
968    ROUND_TRIP_UNIT(Seconds, kint64min, kint64min + kRange);
969    ROUND_TRIP_UNIT(Seconds, -kRange, kRange);
970    ROUND_TRIP_UNIT(Seconds, kint64max - kRange, kint64max);
971    ROUND_TRIP_UNIT(Minutes, kint64min / 60, kint64min / 60 + kRange);
972    ROUND_TRIP_UNIT(Minutes, -kRange, kRange);
973    ROUND_TRIP_UNIT(Minutes, kint64max / 60 - kRange, kint64max / 60);
974    ROUND_TRIP_UNIT(Hours, kint64min / 3600, kint64min / 3600 + kRange);
975    ROUND_TRIP_UNIT(Hours, -kRange, kRange);
976    ROUND_TRIP_UNIT(Hours, kint64max / 3600 - kRange, kint64max / 3600);
977  #undef ROUND_TRIP_UNIT
978  }
979  TEST(Duration, TruncConversions) {
980    const struct {
981      absl::Duration d;
982      timespec ts;
983    } to_ts[] = {
984        {absl::Seconds(1) + absl::Nanoseconds(1), {1, 1}},
985        {absl::Seconds(1) + absl::Nanoseconds(1) / 2, {1, 0}},
986        {absl::Seconds(1) + absl::Nanoseconds(0), {1, 0}},
987        {absl::Seconds(0) + absl::Nanoseconds(0), {0, 0}},
988        {absl::Seconds(0) - absl::Nanoseconds(1) / 2, {0, 0}},
989        {absl::Seconds(0) - absl::Nanoseconds(1), {-1, 999999999}},
990        {absl::Seconds(-1) + absl::Nanoseconds(1), {-1, 1}},
991        {absl::Seconds(-1) + absl::Nanoseconds(1) / 2, {-1, 1}},
992        {absl::Seconds(-1) + absl::Nanoseconds(0), {-1, 0}},
993        {absl::Seconds(-1) - absl::Nanoseconds(1) / 2, {-1, 0}},
994    };
995    for (const auto&amp; test : to_ts) {
996      EXPECT_THAT(absl::ToTimespec(test.d), TimespecMatcher(test.ts));
997    }
998    const struct {
999      timespec ts;
1000      absl::Duration d;
1001    } from_ts[] = {
1002        {{1, 1}, absl::Seconds(1) + absl::Nanoseconds(1)},
1003        {{1, 0}, absl::Seconds(1) + absl::Nanoseconds(0)},
1004        {{0, 0}, absl::Seconds(0) + absl::Nanoseconds(0)},
1005        {{0, -1}, absl::Seconds(0) - absl::Nanoseconds(1)},
1006        {{-1, 999999999}, absl::Seconds(0) - absl::Nanoseconds(1)},
1007        {{-1, 1}, absl::Seconds(-1) + absl::Nanoseconds(1)},
1008        {{-1, 0}, absl::Seconds(-1) + absl::Nanoseconds(0)},
1009        {{-1, -1}, absl::Seconds(-1) - absl::Nanoseconds(1)},
1010        {{-2, 999999999}, absl::Seconds(-1) - absl::Nanoseconds(1)},
1011    };
1012    for (const auto&amp; test : from_ts) {
1013      EXPECT_EQ(test.d, absl::DurationFromTimespec(test.ts));
1014    }
1015    const struct {
1016      absl::Duration d;
1017      timeval tv;
1018    } to_tv[] = {
1019        {absl::Seconds(1) + absl::Microseconds(1), {1, 1}},
1020        {absl::Seconds(1) + absl::Microseconds(1) / 2, {1, 0}},
1021        {absl::Seconds(1) + absl::Microseconds(0), {1, 0}},
1022        {absl::Seconds(0) + absl::Microseconds(0), {0, 0}},
1023        {absl::Seconds(0) - absl::Microseconds(1) / 2, {0, 0}},
1024        {absl::Seconds(0) - absl::Microseconds(1), {-1, 999999}},
1025        {absl::Seconds(-1) + absl::Microseconds(1), {-1, 1}},
1026        {absl::Seconds(-1) + absl::Microseconds(1) / 2, {-1, 1}},
1027        {absl::Seconds(-1) + absl::Microseconds(0), {-1, 0}},
1028        {absl::Seconds(-1) - absl::Microseconds(1) / 2, {-1, 0}},
1029    };
1030    for (const auto&amp; test : to_tv) {
1031      EXPECT_THAT(absl::ToTimeval(test.d), TimevalMatcher(test.tv));
1032    }
1033    const struct {
1034      timeval tv;
1035      absl::Duration d;
1036    } from_tv[] = {
1037        {{1, 1}, absl::Seconds(1) + absl::Microseconds(1)},
1038        {{1, 0}, absl::Seconds(1) + absl::Microseconds(0)},
1039        {{0, 0}, absl::Seconds(0) + absl::Microseconds(0)},
1040        {{0, -1}, absl::Seconds(0) - absl::Microseconds(1)},
1041        {{-1, 999999}, absl::Seconds(0) - absl::Microseconds(1)},
1042        {{-1, 1}, absl::Seconds(-1) + absl::Microseconds(1)},
1043        {{-1, 0}, absl::Seconds(-1) + absl::Microseconds(0)},
1044        {{-1, -1}, absl::Seconds(-1) - absl::Microseconds(1)},
1045        {{-2, 999999}, absl::Seconds(-1) - absl::Microseconds(1)},
1046    };
1047    for (const auto&amp; test : from_tv) {
1048      EXPECT_EQ(test.d, absl::DurationFromTimeval(test.tv));
1049    }
1050  }
1051  TEST(Duration, SmallConversions) {
1052    EXPECT_EQ(absl::ZeroDuration(), absl::Seconds(0));
1053    EXPECT_EQ(absl::ZeroDuration(), absl::Seconds(std::nextafter(0.125e-9, 0)));
1054    EXPECT_EQ(absl::Nanoseconds(1) / 4, absl::Seconds(0.125e-9));
1055    EXPECT_EQ(absl::Nanoseconds(1) / 4, absl::Seconds(0.250e-9));
1056    EXPECT_EQ(absl::Nanoseconds(1) / 2, absl::Seconds(0.375e-9));
1057    EXPECT_EQ(absl::Nanoseconds(1) / 2, absl::Seconds(0.500e-9));
1058    EXPECT_EQ(absl::Nanoseconds(3) / 4, absl::Seconds(0.625e-9));
1059    EXPECT_EQ(absl::Nanoseconds(3) / 4, absl::Seconds(0.750e-9));
1060    EXPECT_EQ(absl::Nanoseconds(1), absl::Seconds(0.875e-9));
1061    EXPECT_EQ(absl::Nanoseconds(1), absl::Seconds(1.000e-9));
1062    EXPECT_EQ(absl::ZeroDuration(), absl::Seconds(std::nextafter(-0.125e-9, 0)));
1063    EXPECT_EQ(-absl::Nanoseconds(1) / 4, absl::Seconds(-0.125e-9));
1064    EXPECT_EQ(-absl::Nanoseconds(1) / 4, absl::Seconds(-0.250e-9));
1065    EXPECT_EQ(-absl::Nanoseconds(1) / 2, absl::Seconds(-0.375e-9));
1066    EXPECT_EQ(-absl::Nanoseconds(1) / 2, absl::Seconds(-0.500e-9));
1067    EXPECT_EQ(-absl::Nanoseconds(3) / 4, absl::Seconds(-0.625e-9));
1068    EXPECT_EQ(-absl::Nanoseconds(3) / 4, absl::Seconds(-0.750e-9));
1069    EXPECT_EQ(-absl::Nanoseconds(1), absl::Seconds(-0.875e-9));
1070    EXPECT_EQ(-absl::Nanoseconds(1), absl::Seconds(-1.000e-9));
1071    timespec ts;
1072    ts.tv_sec = 0;
1073    ts.tv_nsec = 0;
1074    EXPECT_THAT(ToTimespec(absl::Nanoseconds(0)), TimespecMatcher(ts));
1075    EXPECT_THAT(ToTimespec(absl::Nanoseconds(1) / 4), TimespecMatcher(ts));
1076    EXPECT_THAT(ToTimespec(absl::Nanoseconds(2) / 4), TimespecMatcher(ts));
1077    EXPECT_THAT(ToTimespec(absl::Nanoseconds(3) / 4), TimespecMatcher(ts));
1078    ts.tv_nsec = 1;
1079    EXPECT_THAT(ToTimespec(absl::Nanoseconds(4) / 4), TimespecMatcher(ts));
1080    EXPECT_THAT(ToTimespec(absl::Nanoseconds(5) / 4), TimespecMatcher(ts));
1081    EXPECT_THAT(ToTimespec(absl::Nanoseconds(6) / 4), TimespecMatcher(ts));
1082    EXPECT_THAT(ToTimespec(absl::Nanoseconds(7) / 4), TimespecMatcher(ts));
1083    ts.tv_nsec = 2;
1084    EXPECT_THAT(ToTimespec(absl::Nanoseconds(8) / 4), TimespecMatcher(ts));
1085    timeval tv;
1086    tv.tv_sec = 0;
1087    tv.tv_usec = 0;
1088    EXPECT_THAT(ToTimeval(absl::Nanoseconds(0)), TimevalMatcher(tv));
1089    EXPECT_THAT(ToTimeval(absl::Nanoseconds(999)), TimevalMatcher(tv));
1090    tv.tv_usec = 1;
1091    EXPECT_THAT(ToTimeval(absl::Nanoseconds(1000)), TimevalMatcher(tv));
1092    EXPECT_THAT(ToTimeval(absl::Nanoseconds(1999)), TimevalMatcher(tv));
1093    tv.tv_usec = 2;
1094    EXPECT_THAT(ToTimeval(absl::Nanoseconds(2000)), TimevalMatcher(tv));
1095  }
1096  void VerifyApproxSameAsMul(double time_as_seconds, int* const misses) {
1097    auto direct_seconds = absl::Seconds(time_as_seconds);
1098    auto mul_by_one_second = time_as_seconds * absl::Seconds(1);
1099    if (absl::AbsDuration(direct_seconds - mul_by_one_second) &gt;
1100        absl::time_internal::MakeDuration(0, 1u)) {
1101      if (*misses &gt; 10) return;
1102      ASSERT_LE(++(*misses), 10) &lt;&lt; &quot;Too many errors, not reporting more.&quot;;
1103      EXPECT_EQ(direct_seconds, mul_by_one_second)
1104          &lt;&lt; &quot;given double time_as_seconds = &quot; &lt;&lt; std::setprecision(17)
1105          &lt;&lt; time_as_seconds;
1106    }
1107  }
1108  TEST(Duration, ToDoubleSecondsCheckEdgeCases) {
1109  #if (defined(__i386__) || defined(_M_IX86)) &amp;&amp; FLT_EVAL_METHOD != 0
1110    GTEST_SKIP()
1111        &lt;&lt; &quot;Skipping the test because we detected x87 floating-point semantics&quot;;
1112  #endif
1113    constexpr uint32_t kTicksPerSecond = absl::time_internal::kTicksPerSecond;
1114    constexpr auto duration_tick = absl::time_internal::MakeDuration(0, 1u);
1115    int misses = 0;
1116    for (int64_t seconds = 0; seconds &lt; 99; ++seconds) {
1117      uint32_t tick_vals[] = {0, +999, +999999, +999999999, kTicksPerSecond - 1,
1118                              0, 1000, 1000000, 1000000000, kTicksPerSecond,
1119                              1, 1001, 1000001, 1000000001, kTicksPerSecond + 1,
1120                              2, 1002, 1000002, 1000000002, kTicksPerSecond + 2,
1121                              3, 1003, 1000003, 1000000003, kTicksPerSecond + 3,
1122                              4, 1004, 1000004, 1000000004, kTicksPerSecond + 4,
1123                              5, 6,    7,       8,          9};
1124      for (uint32_t ticks : tick_vals) {
1125        absl::Duration s_plus_t = absl::Seconds(seconds) + ticks * duration_tick;
1126        for (absl::Duration d : {s_plus_t, -s_plus_t}) {
1127          absl::Duration after_d = d + duration_tick;
1128          EXPECT_NE(d, after_d);
1129          EXPECT_EQ(after_d - d, duration_tick);
1130          double low_edge = ToDoubleSeconds(d);
1131          EXPECT_EQ(d, absl::Seconds(low_edge));
1132          double high_edge = ToDoubleSeconds(after_d);
1133          EXPECT_EQ(after_d, absl::Seconds(high_edge));
1134          for (;;) {
1135            double midpoint = low_edge + (high_edge - low_edge) / 2;
1136            if (midpoint == low_edge || midpoint == high_edge) break;
1137            absl::Duration mid_duration = absl::Seconds(midpoint);
1138            if (mid_duration == d) {
1139              low_edge = midpoint;
1140            } else {
1141              EXPECT_EQ(mid_duration, after_d);
1142              high_edge = midpoint;
1143            }
1144          }
1145          VerifyApproxSameAsMul(low_edge, &amp;misses);
1146          VerifyApproxSameAsMul(high_edge, &amp;misses);
1147        }
1148      }
1149    }
1150  }
1151  TEST(Duration, ToDoubleSecondsCheckRandom) {
1152    std::random_device rd;
1153    std::seed_seq seed({rd(), rd(), rd(), rd(), rd(), rd(), rd(), rd()});
1154    std::mt19937_64 gen(seed);
1155    std::uniform_real_distribution&lt;double&gt; uniform(std::log(0.125e-9),
1156                                                   std::log(9.223377e+18));
1157    int misses = 0;
1158    for (int i = 0; i &lt; 1000000; ++i) {
1159      double d = std::exp(uniform(gen));
1160      VerifyApproxSameAsMul(d, &amp;misses);
1161      VerifyApproxSameAsMul(-d, &amp;misses);
1162    }
1163  }
1164  TEST(Duration, ConversionSaturation) {
1165    absl::Duration d;
1166    const auto max_timeval_sec =
1167        std::numeric_limits&lt;decltype(timeval::tv_sec)&gt;::max();
1168    const auto min_timeval_sec =
1169        std::numeric_limits&lt;decltype(timeval::tv_sec)&gt;::min();
1170    timeval tv;
1171    tv.tv_sec = max_timeval_sec;
1172    tv.tv_usec = 999998;
1173    d = absl::DurationFromTimeval(tv);
1174    tv = ToTimeval(d);
1175    EXPECT_EQ(max_timeval_sec, tv.tv_sec);
1176    EXPECT_EQ(999998, tv.tv_usec);
1177    d += absl::Microseconds(1);
1178    tv = ToTimeval(d);
1179    EXPECT_EQ(max_timeval_sec, tv.tv_sec);
1180    EXPECT_EQ(999999, tv.tv_usec);
1181    d += absl::Microseconds(1);  
1182    tv = ToTimeval(d);
1183    EXPECT_EQ(max_timeval_sec, tv.tv_sec);
1184    EXPECT_EQ(999999, tv.tv_usec);
1185    tv.tv_sec = min_timeval_sec;
1186    tv.tv_usec = 1;
1187    d = absl::DurationFromTimeval(tv);
1188    tv = ToTimeval(d);
1189    EXPECT_EQ(min_timeval_sec, tv.tv_sec);
1190    EXPECT_EQ(1, tv.tv_usec);
1191    d -= absl::Microseconds(1);
1192    tv = ToTimeval(d);
1193    EXPECT_EQ(min_timeval_sec, tv.tv_sec);
1194    EXPECT_EQ(0, tv.tv_usec);
1195    d -= absl::Microseconds(1);  
1196    tv = ToTimeval(d);
1197    EXPECT_EQ(min_timeval_sec, tv.tv_sec);
1198    EXPECT_EQ(0, tv.tv_usec);
1199    const auto max_timespec_sec =
1200        std::numeric_limits&lt;decltype(timespec::tv_sec)&gt;::max();
1201    const auto min_timespec_sec =
1202        std::numeric_limits&lt;decltype(timespec::tv_sec)&gt;::min();
1203    timespec ts;
1204    ts.tv_sec = max_timespec_sec;
1205    ts.tv_nsec = 999999998;
1206    d = absl::DurationFromTimespec(ts);
1207    ts = absl::ToTimespec(d);
1208    EXPECT_EQ(max_timespec_sec, ts.tv_sec);
1209    EXPECT_EQ(999999998, ts.tv_nsec);
1210    d += absl::Nanoseconds(1);
1211    ts = absl::ToTimespec(d);
1212    EXPECT_EQ(max_timespec_sec, ts.tv_sec);
1213    EXPECT_EQ(999999999, ts.tv_nsec);
1214    d += absl::Nanoseconds(1);  
1215    ts = absl::ToTimespec(d);
1216    EXPECT_EQ(max_timespec_sec, ts.tv_sec);
1217    EXPECT_EQ(999999999, ts.tv_nsec);
1218    ts.tv_sec = min_timespec_sec;
1219    ts.tv_nsec = 1;
1220    d = absl::DurationFromTimespec(ts);
1221    ts = absl::ToTimespec(d);
1222    EXPECT_EQ(min_timespec_sec, ts.tv_sec);
1223    EXPECT_EQ(1, ts.tv_nsec);
1224    d -= absl::Nanoseconds(1);
1225    ts = absl::ToTimespec(d);
1226    EXPECT_EQ(min_timespec_sec, ts.tv_sec);
1227    EXPECT_EQ(0, ts.tv_nsec);
1228    d -= absl::Nanoseconds(1);  
1229    ts = absl::ToTimespec(d);
1230    EXPECT_EQ(min_timespec_sec, ts.tv_sec);
1231    EXPECT_EQ(0, ts.tv_nsec);
1232  }
1233  TEST(Duration, FormatDuration) {
1234    EXPECT_EQ(&quot;72h3m0.5s&quot;,
1235              absl::FormatDuration(absl::Hours(72) + absl::Minutes(3) +
1236                                   absl::Milliseconds(500)));
1237    EXPECT_EQ(&quot;2540400h10m10s&quot;,
1238              absl::FormatDuration(absl::Hours(2540400) + absl::Minutes(10) +
1239                                   absl::Seconds(10)));
1240    EXPECT_EQ(&quot;0&quot;, absl::FormatDuration(absl::ZeroDuration()));
1241    EXPECT_EQ(&quot;0&quot;, absl::FormatDuration(absl::Seconds(0)));
1242    EXPECT_EQ(&quot;0&quot;, absl::FormatDuration(absl::Nanoseconds(0)));
1243    EXPECT_EQ(&quot;1ns&quot;, absl::FormatDuration(absl::Nanoseconds(1)));
1244    EXPECT_EQ(&quot;1us&quot;, absl::FormatDuration(absl::Microseconds(1)));
1245    EXPECT_EQ(&quot;1ms&quot;, absl::FormatDuration(absl::Milliseconds(1)));
1246    EXPECT_EQ(&quot;1s&quot;, absl::FormatDuration(absl::Seconds(1)));
1247    EXPECT_EQ(&quot;1m&quot;, absl::FormatDuration(absl::Minutes(1)));
1248    EXPECT_EQ(&quot;1h&quot;, absl::FormatDuration(absl::Hours(1)));
1249    EXPECT_EQ(&quot;1h1m&quot;, absl::FormatDuration(absl::Hours(1) + absl::Minutes(1)));
1250    EXPECT_EQ(&quot;1h1s&quot;, absl::FormatDuration(absl::Hours(1) + absl::Seconds(1)));
1251    EXPECT_EQ(&quot;1m1s&quot;, absl::FormatDuration(absl::Minutes(1) + absl::Seconds(1)));
1252    EXPECT_EQ(&quot;1h0.25s&quot;,
1253              absl::FormatDuration(absl::Hours(1) + absl::Milliseconds(250)));
1254    EXPECT_EQ(&quot;1m0.25s&quot;,
1255              absl::FormatDuration(absl::Minutes(1) + absl::Milliseconds(250)));
1256    EXPECT_EQ(&quot;1h1m0.25s&quot;,
1257              absl::FormatDuration(absl::Hours(1) + absl::Minutes(1) +
1258                                   absl::Milliseconds(250)));
1259    EXPECT_EQ(&quot;1h0.0005s&quot;,
1260              absl::FormatDuration(absl::Hours(1) + absl::Microseconds(500)));
1261    EXPECT_EQ(&quot;1h0.0000005s&quot;,
1262              absl::FormatDuration(absl::Hours(1) + absl::Nanoseconds(500)));
1263    EXPECT_EQ(&quot;1.5ns&quot;, absl::FormatDuration(absl::Nanoseconds(1) +
1264                                            absl::Nanoseconds(1) / 2));
1265    EXPECT_EQ(&quot;1.25ns&quot;, absl::FormatDuration(absl::Nanoseconds(1) +
1266                                             absl::Nanoseconds(1) / 4));
1267    EXPECT_EQ(&quot;1ns&quot;, absl::FormatDuration(absl::Nanoseconds(1) +
1268                                          absl::Nanoseconds(1) / 9));
1269    EXPECT_EQ(&quot;1.2us&quot;, absl::FormatDuration(absl::Microseconds(1) +
1270                                            absl::Nanoseconds(200)));
1271    EXPECT_EQ(&quot;1.2ms&quot;, absl::FormatDuration(absl::Milliseconds(1) +
1272                                            absl::Microseconds(200)));
1273    EXPECT_EQ(&quot;1.0002ms&quot;, absl::FormatDuration(absl::Milliseconds(1) +
1274                                               absl::Nanoseconds(200)));
1275    EXPECT_EQ(&quot;1.00001ms&quot;, absl::FormatDuration(absl::Milliseconds(1) +
1276                                                absl::Nanoseconds(10)));
1277    EXPECT_EQ(&quot;1.000001ms&quot;,
1278              absl::FormatDuration(absl::Milliseconds(1) + absl::Nanoseconds(1)));
1279    EXPECT_EQ(&quot;-1ns&quot;, absl::FormatDuration(absl::Nanoseconds(-1)));
1280    EXPECT_EQ(&quot;-1us&quot;, absl::FormatDuration(absl::Microseconds(-1)));
1281    EXPECT_EQ(&quot;-1ms&quot;, absl::FormatDuration(absl::Milliseconds(-1)));
1282    EXPECT_EQ(&quot;-1s&quot;, absl::FormatDuration(absl::Seconds(-1)));
1283    EXPECT_EQ(&quot;-1m&quot;, absl::FormatDuration(absl::Minutes(-1)));
1284    EXPECT_EQ(&quot;-1h&quot;, absl::FormatDuration(absl::Hours(-1)));
1285    EXPECT_EQ(&quot;-1h1m&quot;,
1286              absl::FormatDuration(-(absl::Hours(1) + absl::Minutes(1))));
1287    EXPECT_EQ(&quot;-1h1s&quot;,
1288              absl::FormatDuration(-(absl::Hours(1) + absl::Seconds(1))));
1289    EXPECT_EQ(&quot;-1m1s&quot;,
1290              absl::FormatDuration(-(absl::Minutes(1) + absl::Seconds(1))));
1291    EXPECT_EQ(&quot;-1ns&quot;, absl::FormatDuration(absl::Nanoseconds(-1)));
1292    EXPECT_EQ(&quot;-1.2us&quot;, absl::FormatDuration(
1293                            -(absl::Microseconds(1) + absl::Nanoseconds(200))));
1294    EXPECT_EQ(&quot;-1.2ms&quot;, absl::FormatDuration(
1295                            -(absl::Milliseconds(1) + absl::Microseconds(200))));
1296    EXPECT_EQ(&quot;-1.0002ms&quot;, absl::FormatDuration(-(absl::Milliseconds(1) +
1297                                                  absl::Nanoseconds(200))));
1298    EXPECT_EQ(&quot;-1.00001ms&quot;, absl::FormatDuration(-(absl::Milliseconds(1) +
1299                                                   absl::Nanoseconds(10))));
1300    EXPECT_EQ(&quot;-1.000001ms&quot;, absl::FormatDuration(-(absl::Milliseconds(1) +
1301                                                    absl::Nanoseconds(1))));
1302    const absl::Duration qns = absl::Nanoseconds(1) / 4;
1303    const absl::Duration max_dur =
1304        absl::Seconds(kint64max) + (absl::Seconds(1) - qns);
1305    const absl::Duration min_dur = absl::Seconds(kint64min);
1306    EXPECT_EQ(&quot;0.25ns&quot;, absl::FormatDuration(qns));
1307    EXPECT_EQ(&quot;-0.25ns&quot;, absl::FormatDuration(-qns));
1308    EXPECT_EQ(&quot;2562047788015215h30m7.99999999975s&quot;,
1309              absl::FormatDuration(max_dur));
1310    EXPECT_EQ(&quot;-2562047788015215h30m8s&quot;, absl::FormatDuration(min_dur));
1311    EXPECT_EQ(&quot;55.00000000025s&quot;, absl::FormatDuration(absl::Seconds(55) + qns));
1312    EXPECT_EQ(&quot;55.00000025ms&quot;,
1313              absl::FormatDuration(absl::Milliseconds(55) + qns));
1314    EXPECT_EQ(&quot;55.00025us&quot;, absl::FormatDuration(absl::Microseconds(55) + qns));
1315    EXPECT_EQ(&quot;55.25ns&quot;, absl::FormatDuration(absl::Nanoseconds(55) + qns));
1316    EXPECT_EQ(&quot;inf&quot;, absl::FormatDuration(absl::InfiniteDuration()));
1317    EXPECT_EQ(&quot;-inf&quot;, absl::FormatDuration(-absl::InfiniteDuration()));
1318    const absl::Duration huge_range = ApproxYears(100000000000);
1319    EXPECT_EQ(&quot;876000000000000h&quot;, absl::FormatDuration(huge_range));
1320    EXPECT_EQ(&quot;-876000000000000h&quot;, absl::FormatDuration(-huge_range));
1321    EXPECT_EQ(&quot;876000000000000h0.999999999s&quot;,
1322              absl::FormatDuration(huge_range +
1323                                   (absl::Seconds(1) - absl::Nanoseconds(1))));
1324    EXPECT_EQ(&quot;876000000000000h0.9999999995s&quot;,
1325              absl::FormatDuration(
1326                  huge_range + (absl::Seconds(1) - absl::Nanoseconds(1) / 2)));
1327    EXPECT_EQ(&quot;876000000000000h0.99999999975s&quot;,
1328              absl::FormatDuration(
1329                  huge_range + (absl::Seconds(1) - absl::Nanoseconds(1) / 4)));
1330    EXPECT_EQ(&quot;-876000000000000h0.999999999s&quot;,
1331              absl::FormatDuration(-huge_range -
1332                                   (absl::Seconds(1) - absl::Nanoseconds(1))));
1333    EXPECT_EQ(&quot;-876000000000000h0.9999999995s&quot;,
1334              absl::FormatDuration(
1335                  -huge_range - (absl::Seconds(1) - absl::Nanoseconds(1) / 2)));
1336    EXPECT_EQ(&quot;-876000000000000h0.99999999975s&quot;,
1337              absl::FormatDuration(
1338                  -huge_range - (absl::Seconds(1) - absl::Nanoseconds(1) / 4)));
1339  }
1340  TEST(Duration, ParseDuration) {
1341    absl::Duration d;
1342    EXPECT_TRUE(absl::ParseDuration(&quot;0&quot;, &amp;d));
1343    EXPECT_EQ(absl::ZeroDuration(), d);
1344    EXPECT_TRUE(absl::ParseDuration(&quot;+0&quot;, &amp;d));
1345    EXPECT_EQ(absl::ZeroDuration(), d);
1346    EXPECT_TRUE(absl::ParseDuration(&quot;-0&quot;, &amp;d));
1347    EXPECT_EQ(absl::ZeroDuration(), d);
1348    EXPECT_TRUE(absl::ParseDuration(&quot;inf&quot;, &amp;d));
1349    EXPECT_EQ(absl::InfiniteDuration(), d);
1350    EXPECT_TRUE(absl::ParseDuration(&quot;+inf&quot;, &amp;d));
1351    EXPECT_EQ(absl::InfiniteDuration(), d);
1352    EXPECT_TRUE(absl::ParseDuration(&quot;-inf&quot;, &amp;d));
1353    EXPECT_EQ(-absl::InfiniteDuration(), d);
1354    EXPECT_FALSE(absl::ParseDuration(&quot;infBlah&quot;, &amp;d));
1355    EXPECT_FALSE(absl::ParseDuration(&quot;&quot;, &amp;d));
1356    EXPECT_FALSE(absl::ParseDuration(&quot;0.0&quot;, &amp;d));
1357    EXPECT_FALSE(absl::ParseDuration(&quot;.0&quot;, &amp;d));
1358    EXPECT_FALSE(absl::ParseDuration(&quot;.&quot;, &amp;d));
1359    EXPECT_FALSE(absl::ParseDuration(&quot;01&quot;, &amp;d));
1360    EXPECT_FALSE(absl::ParseDuration(&quot;1&quot;, &amp;d));
1361    EXPECT_FALSE(absl::ParseDuration(&quot;-1&quot;, &amp;d));
1362    EXPECT_FALSE(absl::ParseDuration(&quot;2&quot;, &amp;d));
1363    EXPECT_FALSE(absl::ParseDuration(&quot;2 s&quot;, &amp;d));
1364    EXPECT_FALSE(absl::ParseDuration(&quot;.s&quot;, &amp;d));
1365    EXPECT_FALSE(absl::ParseDuration(&quot;-.s&quot;, &amp;d));
1366    EXPECT_FALSE(absl::ParseDuration(&quot;s&quot;, &amp;d));
1367    EXPECT_FALSE(absl::ParseDuration(&quot; 2s&quot;, &amp;d));
1368    EXPECT_FALSE(absl::ParseDuration(&quot;2s &quot;, &amp;d));
1369    EXPECT_FALSE(absl::ParseDuration(&quot; 2s &quot;, &amp;d));
1370    EXPECT_FALSE(absl::ParseDuration(&quot;2mt&quot;, &amp;d));
1371    EXPECT_FALSE(absl::ParseDuration(&quot;1e3s&quot;, &amp;d));
1372    EXPECT_TRUE(absl::ParseDuration(&quot;1ns&quot;, &amp;d));
1373    EXPECT_EQ(absl::Nanoseconds(1), d);
1374    EXPECT_TRUE(absl::ParseDuration(&quot;1us&quot;, &amp;d));
1375    EXPECT_EQ(absl::Microseconds(1), d);
1376    EXPECT_TRUE(absl::ParseDuration(&quot;1ms&quot;, &amp;d));
1377    EXPECT_EQ(absl::Milliseconds(1), d);
1378    EXPECT_TRUE(absl::ParseDuration(&quot;1s&quot;, &amp;d));
1379    EXPECT_EQ(absl::Seconds(1), d);
1380    EXPECT_TRUE(absl::ParseDuration(&quot;2m&quot;, &amp;d));
1381    EXPECT_EQ(absl::Minutes(2), d);
1382    EXPECT_TRUE(absl::ParseDuration(&quot;2h&quot;, &amp;d));
1383    EXPECT_EQ(absl::Hours(2), d);
1384    EXPECT_TRUE(absl::ParseDuration(&quot;9223372036854775807us&quot;, &amp;d));
1385    EXPECT_EQ(absl::Microseconds(9223372036854775807), d);
1386    EXPECT_TRUE(absl::ParseDuration(&quot;-9223372036854775807us&quot;, &amp;d));
1387    EXPECT_EQ(absl::Microseconds(-9223372036854775807), d);
1388    EXPECT_TRUE(absl::ParseDuration(&quot;2h3m4s&quot;, &amp;d));
1389    EXPECT_EQ(absl::Hours(2) + absl::Minutes(3) + absl::Seconds(4), d);
1390    EXPECT_TRUE(absl::ParseDuration(&quot;3m4s5us&quot;, &amp;d));
1391    EXPECT_EQ(absl::Minutes(3) + absl::Seconds(4) + absl::Microseconds(5), d);
1392    EXPECT_TRUE(absl::ParseDuration(&quot;2h3m4s5ms6us7ns&quot;, &amp;d));
1393    EXPECT_EQ(absl::Hours(2) + absl::Minutes(3) + absl::Seconds(4) +
1394                  absl::Milliseconds(5) + absl::Microseconds(6) +
1395                  absl::Nanoseconds(7),
1396              d);
1397    EXPECT_TRUE(absl::ParseDuration(&quot;2us3m4s5h&quot;, &amp;d));
1398    EXPECT_EQ(absl::Hours(5) + absl::Minutes(3) + absl::Seconds(4) +
1399                  absl::Microseconds(2),
1400              d);
1401    EXPECT_TRUE(absl::ParseDuration(&quot;1.5ns&quot;, &amp;d));
1402    EXPECT_EQ(1.5 * absl::Nanoseconds(1), d);
1403    EXPECT_TRUE(absl::ParseDuration(&quot;1.5us&quot;, &amp;d));
1404    EXPECT_EQ(1.5 * absl::Microseconds(1), d);
1405    EXPECT_TRUE(absl::ParseDuration(&quot;1.5ms&quot;, &amp;d));
1406    EXPECT_EQ(1.5 * absl::Milliseconds(1), d);
1407    EXPECT_TRUE(absl::ParseDuration(&quot;1.5s&quot;, &amp;d));
1408    EXPECT_EQ(1.5 * absl::Seconds(1), d);
1409    EXPECT_TRUE(absl::ParseDuration(&quot;1.5m&quot;, &amp;d));
1410    EXPECT_EQ(1.5 * absl::Minutes(1), d);
1411    EXPECT_TRUE(absl::ParseDuration(&quot;1.5h&quot;, &amp;d));
1412    EXPECT_EQ(1.5 * absl::Hours(1), d);
1413    EXPECT_TRUE(absl::ParseDuration(&quot;0.4294967295s&quot;, &amp;d));
1414    EXPECT_EQ(absl::Nanoseconds(429496729) + absl::Nanoseconds(1) / 2, d);
1415    EXPECT_TRUE(absl::ParseDuration(&quot;0.429496729501234567890123456789s&quot;, &amp;d));
1416    EXPECT_EQ(absl::Nanoseconds(429496729) + absl::Nanoseconds(1) / 2, d);
1417    EXPECT_TRUE(absl::ParseDuration(&quot;-1s&quot;, &amp;d));
1418    EXPECT_EQ(absl::Seconds(-1), d);
1419    EXPECT_TRUE(absl::ParseDuration(&quot;-1m&quot;, &amp;d));
1420    EXPECT_EQ(absl::Minutes(-1), d);
1421    EXPECT_TRUE(absl::ParseDuration(&quot;-1h&quot;, &amp;d));
1422    EXPECT_EQ(absl::Hours(-1), d);
1423    EXPECT_TRUE(absl::ParseDuration(&quot;-1h2s&quot;, &amp;d));
1424    EXPECT_EQ(-(absl::Hours(1) + absl::Seconds(2)), d);
1425    EXPECT_FALSE(absl::ParseDuration(&quot;1h-2s&quot;, &amp;d));
1426    EXPECT_FALSE(absl::ParseDuration(&quot;-1h-2s&quot;, &amp;d));
1427    EXPECT_FALSE(absl::ParseDuration(&quot;-1h -2s&quot;, &amp;d));
1428  }
1429  TEST(Duration, FormatParseRoundTrip) {
1430  #define TEST_PARSE_ROUNDTRIP(d)                \
1431    do {                                         \
1432      std::string s = absl::FormatDuration(d);   \
1433      absl::Duration dur;                        \
1434      EXPECT_TRUE(absl::ParseDuration(s, &amp;dur)); \
1435      EXPECT_EQ(d, dur);                         \
1436    } while (0)
1437    TEST_PARSE_ROUNDTRIP(absl::Nanoseconds(1));
1438    TEST_PARSE_ROUNDTRIP(absl::Microseconds(1));
1439    TEST_PARSE_ROUNDTRIP(absl::Milliseconds(1));
1440    TEST_PARSE_ROUNDTRIP(absl::Seconds(1));
1441    TEST_PARSE_ROUNDTRIP(absl::Minutes(1));
1442    TEST_PARSE_ROUNDTRIP(absl::Hours(1));
1443    TEST_PARSE_ROUNDTRIP(absl::Hours(1) + absl::Nanoseconds(2));
1444    TEST_PARSE_ROUNDTRIP(absl::Nanoseconds(-1));
1445    TEST_PARSE_ROUNDTRIP(absl::Microseconds(-1));
1446    TEST_PARSE_ROUNDTRIP(absl::Milliseconds(-1));
1447    TEST_PARSE_ROUNDTRIP(absl::Seconds(-1));
1448    TEST_PARSE_ROUNDTRIP(absl::Minutes(-1));
1449    TEST_PARSE_ROUNDTRIP(absl::Hours(-1));
1450    TEST_PARSE_ROUNDTRIP(absl::Hours(-1) + absl::Nanoseconds(2));
1451    TEST_PARSE_ROUNDTRIP(absl::Hours(1) + absl::Nanoseconds(-2));
1452    TEST_PARSE_ROUNDTRIP(absl::Hours(-1) + absl::Nanoseconds(-2));
1453    TEST_PARSE_ROUNDTRIP(absl::Nanoseconds(1) +
1454                         absl::Nanoseconds(1) / 4);  
1455    const absl::Duration huge_range = ApproxYears(100000000000);
1456    TEST_PARSE_ROUNDTRIP(huge_range);
1457    TEST_PARSE_ROUNDTRIP(huge_range + (absl::Seconds(1) - absl::Nanoseconds(1)));
1458  #undef TEST_PARSE_ROUNDTRIP
1459  }
1460  TEST(Duration, AbslStringify) {
1461    absl::Duration d = absl::Seconds(1);
1462    EXPECT_EQ(absl::StrFormat(&quot;%v&quot;, d), absl::FormatDuration(d));
1463  }
1464  TEST(Duration, NoPadding) {
1465    using NoPadding = std::array&lt;uint32_t, 3&gt;;
1466    EXPECT_EQ(sizeof(NoPadding), sizeof(absl::Duration));
1467    EXPECT_EQ(alignof(NoPadding), alignof(absl::Duration));
1468  }
1469  }  
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-duration_test.cc</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-duration_test.cc</div>
                </div>
                <div class="column column_space"><pre><code>411    EXPECT_EQ(-inf, inf * static_cast&lt;T&gt;(-2));                          \
412    EXPECT_EQ(-inf, -inf * static_cast&lt;T&gt;(2));                          \
</pre></code></div>
                <div class="column column_space"><pre><code>419    EXPECT_EQ(-inf, sec_max * static_cast&lt;T&gt;(-2));                      \
420    EXPECT_EQ(-inf, sec_min * static_cast&lt;T&gt;(2));                       \
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    