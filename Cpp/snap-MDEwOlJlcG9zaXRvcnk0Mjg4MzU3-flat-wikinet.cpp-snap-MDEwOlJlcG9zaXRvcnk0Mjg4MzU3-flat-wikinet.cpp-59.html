
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 59, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-wikinet.cpp</h3>
            <pre><code>1  #include &quot;stdafx.h&quot;
2  #include &quot;wikinet.h&quot;
3  #include &quot;trawling.h&quot;
4  TWikiUsr::TWikiUsr() : Usr(), Admin(false), ElecTm(), BarnStars(), MnEdCnt(), MnEdWrds(), MnTkEdCnt(), MnTkEdWrds(),
5    WkEdCnt(), WkEdWrds(), WkTkEdCnt(), WkTkEdWrds(), MnRevCnt(), MnRevWrds() {
6  }
7  TWikiUsr::TWikiUsr(const TChA&amp; UsrStr) : Usr(UsrStr), Admin(false), ElecTm(), BarnStars(), MnEdCnt(), MnEdWrds(),
8    MnTkEdCnt(), MnTkEdWrds(), WkEdCnt(), WkEdWrds(), WkTkEdCnt(), WkTkEdWrds(), MnRevCnt(), MnRevWrds() {
9  }
10  TWikiUsr::TWikiUsr(const TWikiUsr&amp; WikiUsr) : Usr(WikiUsr.Usr), Admin(WikiUsr.Admin), ElecTm(WikiUsr.ElecTm),
11    BarnStars(WikiUsr.BarnStars), MnEdCnt(WikiUsr.MnEdCnt), MnEdWrds(WikiUsr.MnEdWrds),
12    MnTkEdCnt(WikiUsr.MnTkEdCnt), MnTkEdWrds(WikiUsr.MnTkEdWrds), WkEdCnt(WikiUsr.WkEdCnt),
13    WkEdWrds(WikiUsr.WkEdWrds), WkTkEdCnt(WikiUsr.WkTkEdCnt), WkTkEdWrds(WikiUsr.WkTkEdWrds),
14    MnRevCnt(WikiUsr.MnRevCnt), MnRevWrds(WikiUsr.MnRevCnt) {
15  }
16  TWikiUsr::TWikiUsr(TSIn&amp; SIn) : Usr(SIn), Admin(SIn), ElecTm(SIn), BarnStars(SIn), MnEdCnt(SIn),
17    MnEdWrds(SIn), MnTkEdCnt(SIn), MnTkEdWrds(SIn), WkEdCnt(SIn), WkEdWrds(SIn), WkTkEdCnt(SIn), WkTkEdWrds(SIn)
18    , MnRevCnt(SIn), MnRevWrds(SIn)
19  {
20  }
21  void TWikiUsr::Save(TSOut&amp; SOut) const {
22    Usr.Save(SOut);  Admin.Save(SOut);  ElecTm.Save(SOut);
23    BarnStars.Save(SOut);  MnEdCnt.Save(SOut);  MnEdWrds.Save(SOut);
24    MnTkEdCnt.Save(SOut);  MnTkEdWrds.Save(SOut);  WkEdCnt.Save(SOut);  WkEdWrds.Save(SOut);
25    WkTkEdCnt.Save(SOut);  WkTkEdWrds.Save(SOut);
26    MnRevCnt.Save(SOut);   MnRevWrds.Save(SOut);
27  }
28  TWikiTalkEdge::TWikiTalkEdge() : TotTalks(), TotWords(), TalksBE(), WordsBE(), TalksAE(), WordsAE(), VoteSign(0), FirstTalk(), LastTalk(), VoteTm() {
29  }
30  TWikiTalkEdge::TWikiTalkEdge(const int&amp; _VoteSign) : TotTalks(), TotWords(), TalksBE(), WordsBE(), TalksAE(), WordsAE(),
31    VoteSign(_VoteSign), FirstTalk(), LastTalk(), VoteTm() {
32  }
33  TWikiTalkEdge::TWikiTalkEdge(const TSecTm&amp; FTalk, const TSecTm&amp; LTalk, const int&amp; NTalks, const int&amp; NWords) :
34    TotTalks(NTalks), TotWords(NWords), TalksBE(), WordsBE(), TalksAE(), WordsAE(), VoteSign(0), FirstTalk(FTalk), LastTalk(LTalk), VoteTm() {
35  }
36  TWikiTalkEdge::TWikiTalkEdge(const TWikiTalkEdge&amp; Talk) : TotTalks(Talk.TotTalks), TotWords(Talk.TotWords),
37    TalksBE(Talk.TalksBE), WordsBE(Talk.WordsBE), TalksAE(Talk.TalksAE), WordsAE(Talk.WordsAE),
38    VoteSign(Talk.VoteSign), FirstTalk(Talk.FirstTalk), LastTalk(Talk.LastTalk), VoteTm(Talk.VoteTm) {
39  }
40  TWikiTalkEdge::TWikiTalkEdge(TSIn&amp; SIn) : TotTalks(SIn), TotWords(SIn), TalksBE(SIn), WordsBE(SIn),
41    TalksAE(SIn), WordsAE(SIn), VoteSign(SIn), FirstTalk(SIn), LastTalk(SIn), VoteTm(SIn) {
42  }
43  void TWikiTalkEdge::Save(TSOut&amp; SOut) const {
44    TotTalks.Save(SOut);  TotWords.Save(SOut);
45    TalksBE.Save(SOut);   WordsBE.Save(SOut);
46    TalksAE.Save(SOut);   WordsAE.Save(SOut);
47    VoteSign.Save(SOut);  FirstTalk.Save(SOut);
48    LastTalk.Save(SOut);  VoteTm.Save(SOut);
49  }
50  int TWikiTalkNet::GetUsrNId(const TStr&amp; UsrStr) const {
51    const int KeyId = UsrNIdH.GetKeyId(UsrStr);
52    if (KeyId==-1) { return -1; }
53    else { return UsrNIdH[KeyId]; }
54  }
55  bool TWikiTalkNet::IsUsr(const TStr&amp; UsrStr) const {
56    return UsrNIdH.IsKey(UsrStr);
57  }
58  void TWikiTalkNet::PermuteAllVoteSigns(const bool&amp; OnlyVotes) {
59    printf(&quot;\nPermuting %s edge signs\n&quot;, OnlyVotes?&quot;VOTE&quot;:&quot;ALL&quot;);
60    TVec&lt;TWikiTalkEdge&gt; EDatV;
61    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
62      if (OnlyVotes &amp;&amp; EI().GetVote() != 0) { EDatV.Add(EI()); }
63      else if (! OnlyVotes){ EDatV.Add(EI()); }
64    }
65    EDatV.Shuffle(TInt::Rnd);
66    int cnt = 0;
67    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
68      if (OnlyVotes &amp;&amp; EI().GetVote() != 0) { EI() = EDatV[cnt++]; }
69      else if (! OnlyVotes){ EI() = EDatV[cnt++]; }
70    }
71  }
72  void TWikiTalkNet::PermuteOutVoteSigns(const bool&amp; OnlyVotes) {
73    TIntV VoteSignV;
74    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
75      for (int e = 0; e &lt; NI.GetOutDeg(); e++) {
76        if (OnlyVotes &amp;&amp; NI.GetOutEDat(e).GetVote() != 0) {
77          VoteSignV.Add(NI.GetOutEDat(e).GetVote()); }
78        else if (! OnlyVotes) {
79          VoteSignV.Add(NI.GetOutEDat(e).GetVote()); }
80      }
81    }
82    VoteSignV.Shuffle(TInt::Rnd);
83    int cnt = 0;
84    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
85      for (int e = 0; e &lt; NI.GetOutDeg(); e++) {
86        if (OnlyVotes &amp;&amp; NI.GetOutEDat(e).GetVote() != 0) {
87          NI.GetOutEDat(e).VoteSign = VoteSignV[cnt++]; }
88        else if (! OnlyVotes) {
89          NI.GetOutEDat(e).VoteSign = VoteSignV[cnt++]; }
90      }
91    }
92  }
93  void TWikiTalkNet::CountStructBalance() const {
94    TIntSet NbrIdSet;
95    THash&lt;TIntTr, TInt&gt; TriadCntH;
96    TIntH SignH;
97    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
98      SignH.AddDat(EI().VoteSign()) += 1;
99    }
100    printf(&quot;Structural balance triads:\n  background sign distribution:\n&quot;);
101    SignH.SortByKey(false);
102    for (int i = 0; i &lt; SignH.Len(); i++) {
103      printf(&quot;\t%2d\t%d\n&quot;, SignH.GetKey(i), SignH[i]);
104    }
105    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
106      const TNodeI SrcNI = GetNI(EI.GetSrcNId());
107      const TNodeI DstNI = GetNI(EI.GetDstNId());
108      const TInt E1Dat = EI().VoteSign();
109      NbrIdSet.Clr(false);
110      for (int es = 0; es &lt; SrcNI.GetDeg(); es++) {
111        NbrIdSet.AddKey(SrcNI.GetNbrNId(es)); }
112      for (int ed = 0; ed &lt; DstNI.GetDeg(); ed++) {
113        const int nbr = DstNI.GetNbrNId(ed);
114        if (! NbrIdSet.IsKey(nbr)) { continue; }
115        const TInt E2Dat = SrcNI.GetNbrEDat(NbrIdSet.GetKeyId(nbr)).VoteSign();
116        const TInt E3Dat = DstNI.GetNbrEDat(ed).VoteSign();
117        TriadCntH.AddDat(TIntTr(TMath::Mx(E1Dat, E2Dat, E3Dat),
118          TMath::Median(E1Dat, E2Dat, E3Dat), TMath::Mn(E1Dat, E2Dat, E3Dat))) += 1;
119      }
120    }
121    TriadCntH.SortByKey(false);
122    printf(&quot;triad counts (all counts times 3):\n&quot;);
123    int SumTriad = 0, SignTriad=0;
124    for (int i = 0; i &lt; TriadCntH.Len(); i++) {
125      SumTriad += TriadCntH[i];
126      TIntTr SignTr = TriadCntH.GetKey(i);
127      if (SignTr.Val1!=0 &amp;&amp; SignTr.Val2!=0 &amp;&amp; SignTr.Val3!=0) {
128        SignTriad += TriadCntH[i];; }
129    }
130    for (int i = 0; i &lt; TriadCntH.Len(); i++) {
131      TIntTr SignTr = TriadCntH.GetKey(i);
132      printf(&quot;\t%2d %2d %2d\t%8d\t%f&quot;, SignTr.Val1, SignTr.Val2, SignTr.Val3,
133        TriadCntH[i], TriadCntH[i]/double(SumTriad));
134      if (SignTr.Val1!=0 &amp;&amp; SignTr.Val2!=0 &amp;&amp; SignTr.Val3!=0) {
135        printf(&quot;\t%f&quot;, TriadCntH[i]/double(SignTriad)); }
136      printf(&quot;\n&quot;);
137    }
138  }
139  void TWikiTalkNet::FindPartitions(const int&amp; NPart, const bool&amp; OnlyMinus) const {
140    printf(&quot;\nFind %d partitions use %s edges\n&quot;, NPart, OnlyMinus?&quot;NEGATIVE&quot;:&quot;ALL&quot;);
141    TIntV NIdV(GetNodes(), 0);
142    TIntH NIdPartH;
143    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
144      NIdPartH.AddDat(NI.GetId(), TInt::Rnd.GetUniDevInt(NPart));
145      NIdV.Add(NI.GetId());
146    }
147    int Flips = 0;
148    TIntPrV CntPartV;
149    for (int p = 0; p &lt; NPart; p++) {
150      CntPartV.Add(TIntPr(0, p)); }
151    for (int iter = 0; iter &lt; 100; iter++) {
152      NIdV.Shuffle(TInt::Rnd);
153      Flips = 0;
154      for (int n = 0; n &lt; NIdV.Len(); n++) {
155        TNodeI NI = GetNI(NIdV[n]);
156        for (int p = 0; p &lt; NPart; p++) {
157          CntPartV[p].Val1=0;  CntPartV[p].Val2=p; }
158        for (int e = 0; e &lt; NI.GetOutDeg(); e++) {
159          const int DstPart = NIdPartH.GetDat(NI.GetOutNId(e));
160          const int Vote = NI.GetOutEDat(e).GetVote();
161          if (OnlyMinus &amp;&amp; Vote==-1) { CntPartV[DstPart].Val1 += -1; }
162          else if (! OnlyMinus) { CntPartV[DstPart].Val1 += Vote; }
163        }
164        CntPartV.Sort(false); 
165        const int NewPart = CntPartV[0].Val2;
166        if (NIdPartH.GetDat(NI.GetId()) != NewPart) {
167          NIdPartH.AddDat(NI.GetId(), NewPart);
168          Flips++;
169        }
170      }
171    }
172    int OkMns=0, OkPls=0, AllMns=0, AllPls=0;
173    TIntH OkPlsH, AllPlsH, OkMnsH, AllMnsH;
174    for (int p = 0; p &lt; NPart; p++) {
175      OkPlsH.AddDat(p,0); AllPlsH.AddDat(p,0);
176      OkMnsH.AddDat(p,0); AllMnsH.AddDat(p,0);
177    }
178    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
179      const int SrcPart = NIdPartH.GetDat(NI.GetId());
180      for (int e = 0; e &lt; NI.GetOutDeg(); e++) {
181        const int DstPart = NIdPartH.GetDat(NI.GetOutNId(e));
182        const int Vote = NI.GetOutEDat(e).GetVote();
183        if (Vote == -1) {
184          if (DstPart != SrcPart) { OkMnsH.AddDat(SrcPart) += 1;  OkMns++; }
185          AllMnsH.AddDat(SrcPart) += 1;  AllMns++; }
186        if (Vote == +1) {
187          if (DstPart == SrcPart) { OkPlsH.AddDat(SrcPart) += 1;  OkPls++; }
188          AllPlsH.AddDat(SrcPart) += 1;  AllPls++;
189        }
190      }
191    }
192    printf(&quot;\nSatisfied edges: + : %5d / %5d  = %f\n&quot;, OkPls, AllPls, double(OkPls)/double(AllPls));
193    printf(  &quot;                 - : %5d / %5d  = %f\n&quot;, OkMns, AllMns, double(OkMns)/double(AllMns));
194    TIntH PartCntH;
195    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
196      PartCntH.AddDat(NIdPartH.GetDat(NI.GetId())) += 1; }
197    PartCntH.SortByKey();
198    for (int p = 0; p &lt; PartCntH.Len(); p++) {
199      printf(&quot;  part %2d : %5d (%.4f) nodes: +: %25s    -: %25s\n&quot;, p, PartCntH[p], PartCntH[p]/double(NIdPartH.Len()),
200        TStr::Fmt(&quot;%5d/%d=%.4f&quot;, OkPlsH.GetDat(PartCntH.GetKey(p)), AllPlsH.GetDat(PartCntH.GetKey(p)), OkPlsH.GetDat(PartCntH.GetKey(p))/double(AllPlsH.GetDat(PartCntH.GetKey(p)))).CStr(),
201        TStr::Fmt(&quot;%5d/%d=%.4f&quot;, OkMnsH.GetDat(PartCntH.GetKey(p)), AllMnsH.GetDat(PartCntH.GetKey(p)), OkMnsH.GetDat(PartCntH.GetKey(p))/double(AllMnsH.GetDat(PartCntH.GetKey(p)))).CStr() );
202    }
203  }
204  void TWikiTalkNet::GetPartStat(const TVec&lt;TIntV&gt;&amp; PartNIdV) const {
205    THash&lt;TIntPr, TIntPr&gt; PartEdgeH;
206    TIntH NIdPartH;
207    for (int p = 0; p &lt; PartNIdV.Len(); p++) {
208      for (int n = 0; n &lt; PartNIdV[p].Len(); n++) {
209        NIdPartH.AddDat(PartNIdV[p][n], p);
210      }
211    }
212    TInt DstPart;
213    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
214      if (! NIdPartH.IsKey(NI.GetId())) { continue; }
215      const int p = NIdPartH.GetDat(NI.GetId());
216      for (int e = 0; e &lt; NI.GetOutDeg(); e++) {
217        const int Vote = NI.GetOutEDat(e).GetVote();
218        TIntPr&amp; IOCnt = PartEdgeH.AddDat(TIntPr(p, Vote));
219        if (NIdPartH.IsKeyGetDat(NI.GetOutNId(e), DstPart) &amp;&amp; DstPart==p) {
220          if (Vote==1) { IOCnt.Val1++; } else { IOCnt.Val2++; } }
221        else {
222          if (Vote==-1) { IOCnt.Val1++; } else { IOCnt.Val2++; } }
223      }
224    }
225    PartEdgeH.SortByKey();
226    printf(&quot;Partition statistics (satisfied edges):\n&quot;);
227    for (int p = 0; p &lt; PartEdgeH.Len(); p++) {
228      printf(&quot;  %2d  %2d : %6d : %6d  =  %f\n&quot;, PartEdgeH.GetKey(p).Val1, PartEdgeH.GetKey(p).Val2,
229        PartEdgeH[p].Val1(), PartEdgeH[p].Val2(), PartEdgeH[p].Val1/double(PartEdgeH[p].Val1+PartEdgeH[p].Val2));
230    }
231  }
232  PWikiTalkNet TWikiTalkNet::GetVoteSubNet(const int&amp; VoteSign, const bool&amp; VoteOnly, const bool&amp; TalkOnly) const {
233    PWikiTalkNet Net = TWikiTalkNet::New();
234    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
235      if (! (EI().GetVote()==VoteSign || (VoteSign==11 &amp;&amp; EI().GetVote()!=0))) { continue; }
236      if (VoteOnly &amp;&amp; ! EI().IsVoteE()) { continue; }
237      if (TalkOnly &amp;&amp; ! EI().IsTalkE()) { continue; }
238      if (! Net-&gt;IsNode(EI.GetSrcNId())) {
239        Net-&gt;UsrNIdH.AddDat(EI.GetSrcNDat().Usr, EI.GetSrcNId());
240        Net-&gt;AddNode(EI.GetSrcNId(), EI.GetSrcNDat());
241      }
242      if (! Net-&gt;IsNode(EI.GetDstNId())) {
243        Net-&gt;UsrNIdH.AddDat(EI.GetDstNDat().Usr, EI.GetDstNId());
244        Net-&gt;AddNode(EI.GetDstNId(), EI.GetDstNDat());
245      }
246      Net-&gt;AddEdge(EI);
247    }
248    TSnap::PrintInfo(Net, TStr::Fmt(&quot;Vote network: sign %d %s %s&quot;,
249      VoteSign, VoteOnly?&quot;OnlyVote&quot;:&quot;&quot;, TalkOnly?&quot;OnlyTalk&quot;:&quot;&quot;));
250    return Net;
251  }
252  PSignNet TWikiTalkNet::GetSignNet(const int&amp; VoteSign, const bool&amp; VoteOnly, const bool&amp; TalkOnly) const {
253    PSignNet Net = TSignNet::New();
254    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
255      if (EI.GetSrcNId() == EI.GetDstNId()) { continue; }
256      if (! (EI().GetVote()==VoteSign || (VoteSign==11 &amp;&amp; EI().GetVote()!=0))) { continue; }
257      if (VoteOnly &amp;&amp; ! EI().IsVoteE()) { continue; }
258      if (TalkOnly &amp;&amp; ! EI().IsTalkE()) { continue; }
259      if (! Net-&gt;IsNode(EI.GetSrcNId())) {
260        Net-&gt;AddNode(EI.GetSrcNId(), 0); }
261      if (! Net-&gt;IsNode(EI.GetDstNId())) {
262        Net-&gt;AddNode(EI.GetDstNId(), 0); }
263      Net-&gt;AddEdge(EI.GetSrcNId(), EI.GetDstNId(), EI().GetVote());
264    }
265    return Net;
266  }
267  void TWikiTalkNet::TestPartitions(const TStr&amp; OutFNm) {
268    { PSignNet MnsNet = GetSignNet(-1, true, false);
269    PSignNet AllNet = GetSignNet(11, true, false);
270    PSignNet CoreNet = TSnap::GetKCore(TSnap::GetMxWcc(MnsNet), 2);
271    TSnap::PrintInfo(CoreNet, &quot;MINUS K-CORE&quot;);
272    for (int npart  = 2; npart &lt; 5; npart++) {
273      printf(&quot;\n**** %d-partitions\n&quot;, npart);
274      THopfield Hopfield(CoreNet);
275      Hopfield.FindStableSet(npart, 1000);
276      TVec&lt;TIntV&gt; PartNIdV;
277      Hopfield.GetStableSet(990, PartNIdV);
278      Hopfield.PlotPartStab(TStr::Fmt(&quot;%s-c2-p%d&quot;, OutFNm.CStr(), npart));
279      CoreNet-&gt;GetPartStat(PartNIdV, &quot;NETWORK 2-CORE&quot;);
280      MnsNet-&gt;GetPartStat(PartNIdV, &quot;FULL MINUS NET&quot;);
281      AllNet-&gt;GetPartStat(PartNIdV, &quot;FULL PLUS-MINUS NET&quot;);
282    } }
283    PermuteAllVoteSigns(false);
284    printf(&quot;\n*** PERMUTE EDGE SIGNS ************************************************************************************\n&quot;);
285    { PSignNet MnsNet = GetSignNet(-1, true, false);
286    PSignNet AllNet = GetSignNet(11, true, false);
287    PSignNet CoreNet = TSnap::GetKCore(TSnap::GetMxWcc(MnsNet), 2);
288    TSnap::PrintInfo(CoreNet, &quot;MINUS K-CORE&quot;);
289    for (int npart  = 2; npart &lt; 6; npart++) {
290      printf(&quot;\n**** %d-partitions\n&quot;, npart);
291      THopfield Hopfield(CoreNet);
292      Hopfield.FindStableSet(npart, 1000);
293      TVec&lt;TIntV&gt; PartNIdV;
294      Hopfield.GetStableSet(990, PartNIdV);
295      Hopfield.PlotPartStab(TStr::Fmt(&quot;%s-c2-Rp%d&quot;, OutFNm.CStr(), npart));
296      CoreNet-&gt;GetPartStat(PartNIdV, &quot;NETWORK 2-CORE&quot;);
297      MnsNet-&gt;GetPartStat(PartNIdV, &quot;FULL MINUS NET&quot;);
298      AllNet-&gt;GetPartStat(PartNIdV, &quot;FULL PLUS-MINUS NET&quot;);
299    } }
300  }
301  void TWikiTalkNet::PlotBarnStarDelta(const TStr&amp; OutFNm) const {
302    THash&lt;TInt, TMom&gt; DiffMomH;
303    TIntH DiffCntH;
304    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
305      if (EI().GetVote() == 0) { continue; }
306      DiffMomH.AddDat(EI.GetSrcNDat().GetStars()-EI.GetDstNDat().GetStars()).Add(EI().GetVote()==1?1:0);
307      DiffCntH.AddDat(EI.GetSrcNDat().GetStars()-EI.GetDstNDat().GetStars()) += 1;
308    }
309    TGnuPlot::PlotValMomH(DiffMomH, &quot;dBarnStars-&quot;+OutFNm, &quot;Number of BarnStars (over ALL VOTES): &quot;+OutFNm, &quot;Barnstars delta (source - destination)&quot;,
310      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, true);
311    TGnuPlot::PlotValCntH(DiffCntH, &quot;dBarnStarts2-&quot;+OutFNm, &quot;Number of BarnSTars (over aLL VOES): &quot;+OutFNm, &quot;Barnstars delta (source - destination)&quot;,
312      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
313  }
314  int log10Delta(const int&amp; Delta) {
315    if (Delta == 0) { return 0; }
316    else if (Delta &gt; 0) { return (int)log10((double)Delta)+1; }
317    else if (Delta &lt; 0) { return -(int)log10((double)-Delta)+1; }
318    Fail; return -1;
319  }
320  void TWikiTalkNet::PlotFracPosVsWords(const TStr&amp; OutFNm) const {
321    THash&lt;TInt, TMom&gt; DiffMomH, DiffMomH2, WrdAE, WrdBE, TlkAE, TlkBE;
322    TIntH DiffCntH, DiffCntH2, CWrdAE, CWrdBE, CTlkAE, CTlkBE;
323    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
324      if (EI().GetVote() == 0) { continue; }
325      if (! EI().IsVoteTalkE()) { continue; }
326      if (EI().GetTalks() &lt; 50) {
327        DiffMomH.AddDat(EI().GetTalks()).Add(EI().GetVote()==1?1:0);
328        DiffCntH.AddDat(EI().GetTalks()) += 1;
329        TlkBE.AddDat((EI().GetTalksBE())).Add(EI().GetVote()==1?1:0);
330        CTlkBE.AddDat((EI().GetTalksBE())) += 1;
331        TlkAE.AddDat((EI().GetTalksAE())).Add(EI().GetVote()==1?1:0);
332        CTlkAE.AddDat((EI().GetTalksAE())) += 1;
333      }
334      DiffMomH2.AddDat(log10Delta(EI().GetWords())).Add(EI().GetVote()==1?1:0);
335      DiffCntH2.AddDat(log10Delta(EI().GetWords())) += 1;
336      WrdBE.AddDat(log10Delta(EI().GetWordsBE())).Add(EI().GetVote()==1?1:0);
337      CWrdBE.AddDat(log10Delta(EI().GetWordsBE())) += 1;
338      WrdAE.AddDat(log10Delta(EI().GetWordsAE())).Add(EI().GetVote()==1?1:0);
339      CWrdAE.AddDat(log10Delta(EI().GetWordsAE())) += 1;
340    }
341    TGnuPlot::PlotValMomH(DiffMomH, &quot;talks-&quot;+OutFNm, &quot;Number of talks: &quot;+OutFNm, &quot;Number of times users talked&quot;,
342      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
343    TGnuPlot::PlotValCntH(DiffCntH, &quot;talks2-&quot;+OutFNm, &quot;Number of talks: &quot;+OutFNm, &quot;Number of times users talked&quot;,
344      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
345    TGnuPlot::PlotValMomH(DiffMomH2, &quot;words-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;Number of words edited&quot;,
346      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
347    TGnuPlot::PlotValCntH(DiffCntH2, &quot;words2-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;Number of words edited&quot;,
348      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
349    TGnuPlot::PlotValMomH(WrdAE, &quot;wordsBE-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;Number of words edited BEFORE the election (on talk page between a pair)&quot;,
350      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
351    TGnuPlot::PlotValCntH(CWrdAE, &quot;wordsBE2-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;Number of words edited BEFORE the election (on talk page between a pair)&quot;,
352      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
353    TGnuPlot::PlotValMomH(WrdBE, &quot;wordsAE-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;Number of words edited AFTER the election (on talk page between a pair)&quot;,
354      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
355    TGnuPlot::PlotValCntH(CWrdBE, &quot;wordsAE2-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;Number of words edited AFTER the election (on talk page between a pair)&quot;,
356      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
357    TGnuPlot::PlotValMomH(TlkAE, &quot;talksBE-&quot;+OutFNm, &quot;Number of talks edited: &quot;+OutFNm, &quot;Number of talks BEFORE the election (on talk page between a pair)&quot;,
358      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
359    TGnuPlot::PlotValCntH(CTlkAE, &quot;talksBE2-&quot;+OutFNm, &quot;Number of talks edited: &quot;+OutFNm, &quot;Number of talks BEFORE the election (on talk page between a pair)&quot;,
360      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
361    TGnuPlot::PlotValMomH(TlkBE, &quot;talksAE-&quot;+OutFNm, &quot;Number of talks edited: &quot;+OutFNm, &quot;Number of talks AFTER the election (on talk page between a pair)&quot;,
362      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
363    TGnuPlot::PlotValCntH(CTlkBE, &quot;talksAE2-&quot;+OutFNm, &quot;Number of talks edited: &quot;+OutFNm, &quot;Number of talks AFTER the election (on talk page between a pair)&quot;,
364      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
365  }
366  void TWikiTalkNet::PlotFracPosVsWords2(const TStr&amp; OutFNm) const {
367    THash&lt;TInt, TMom&gt; TlkAll, WrdAll, WrdAE, WrdBE, TlkAE, TlkBE, EdtAll, EdtAll2, EdtAll3;
368    TIntH NIdTAE, NIdTBE, NIdTalks, NIdWAE, NIdWBE, NIdWords;
369    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
370      NIdTAE.AddDat(EI.GetDstNId()) += EI().GetTalksAE();
371      NIdTBE.AddDat(EI.GetDstNId()) += EI().GetTalksBE();
372      NIdTalks.AddDat(EI.GetDstNId()) += EI().GetTalks();
373      NIdWAE.AddDat(EI.GetDstNId()) += EI().GetWordsAE();
374      NIdWBE.AddDat(EI.GetDstNId()) += EI().GetWordsBE();
375      NIdWords.AddDat(EI.GetDstNId()) += EI().GetWords();
376    }
377    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
378      if (EI().GetVote() == 0) { continue; }
379      const int C = EI.GetDstNId(); 
380      if (NIdTAE.GetDat(C)&lt;1000) TlkAE.AddDat(NIdTAE.GetDat(C)).Add(EI().GetVote()==1?1:0);
381      if (NIdTBE.GetDat(C)&lt;1000) TlkBE.AddDat(NIdTBE.GetDat(C)).Add(EI().GetVote()==1?1:0);
382      if (NIdTalks.GetDat(C)&lt;1000) TlkAll.AddDat(NIdTalks.GetDat(C)).Add(EI().GetVote()==1?1:0);
383      WrdAE.AddDat(log10Delta(NIdWAE.GetDat(C))).Add(EI().GetVote()==1?1:0);
384      WrdBE.AddDat(log10Delta(NIdWBE.GetDat(C))).Add(EI().GetVote()==1?1:0);
385      WrdAll.AddDat(log10Delta(NIdWords.GetDat(C))).Add(EI().GetVote()==1?1:0);
386      EdtAll.AddDat(log10Delta(EI.GetDstNDat().GetEdCnt())).Add(EI().GetVote()==1?1:0);
387      EdtAll2.AddDat(log10Delta(EI.GetDstNDat().GetAllEdCnt())).Add(EI().GetVote()==1?1:0);
388      EdtAll3.AddDat(log10Delta(EI.GetDstNDat().GetTkEdCnt())).Add(EI().GetVote()==1?1:0);
389    }
390    TGnuPlot::PlotValMomH(EdtAll, &quot;editsTot-&quot;+OutFNm, &quot;Number of edits: &quot;+OutFNm, &quot;Total number of times candidate edited&quot;,
391      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
392    TGnuPlot::PlotValMomH(EdtAll2, &quot;editsTot2-&quot;+OutFNm, &quot;Number of edits: &quot;+OutFNm, &quot;Total number of times candidate edited&quot;,
393      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
394    TGnuPlot::PlotValMomH(EdtAll3, &quot;editsTot3-&quot;+OutFNm, &quot;Number of edits: &quot;+OutFNm, &quot;Total number of times candidate edited&quot;,
395      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
396    TGnuPlot::PlotValMomH(TlkAll, &quot;talksTot-&quot;+OutFNm, &quot;Number of talks: &quot;+OutFNm, &quot;Total number of times candidate talked&quot;,
397      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
398    TGnuPlot::PlotValMomH(WrdAE, &quot;wordsBETot-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;1+Log_10 Total number of words edited of candidate BEFORE the election&quot;,
399      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
400    TGnuPlot::PlotValMomH(WrdBE, &quot;wordsAETot-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;1+Log_10 Total number of words edited of candidate AFTER the election&quot;,
401      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
402    TGnuPlot::PlotValMomH(WrdAll, &quot;wordsTot-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;1+Log_10 Total number of words candidate edited&quot;,
403      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
404    TGnuPlot::PlotValMomH(TlkAE, &quot;talksBETot-&quot;+OutFNm, &quot;Number of talks edited: &quot;+OutFNm, &quot;Total number of talks of candidate BEFORE the election&quot;,
405      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
406    TGnuPlot::PlotValMomH(TlkBE, &quot;talksAETot-&quot;+OutFNm, &quot;Number of talks edited: &quot;+OutFNm, &quot;Total number of talks of candidate AFTER the election&quot;,
407      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
408  }
409  void TWikiTalkNet::PlotNodeAttrDistr(const TStr&amp; OutFNm) const {
410    TIntH BarnStars, AllEdCnt, AllEdWrds, MnEdCnt, MnEdWrds, TkEdCnt, TkEdWrds;
411    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
412      const TWikiUsr&amp; N = NI();
413      BarnStars.AddDat(N.GetStars()) += 1;
414      AllEdCnt.AddDat(N.GetAllEdCnt()) += 1;
415      AllEdWrds.AddDat(1*(N.GetAllWrdCnt()/1)) += 1;
416      MnEdCnt.AddDat(N.GetEdCnt()) += 1;
417      MnEdWrds.AddDat(1*(N.GetWrdCnt()/1)) += 1;
418      TkEdCnt.AddDat(N.GetTkEdCnt()) += 1;
419      TkEdWrds.AddDat(1*(N.GetTkWrdCnt()/1)) += 1;
420    }
421    TGnuPlot::PlotValCntH(BarnStars, &quot;barnStars-&quot;+OutFNm, OutFNm, &quot;Number of barn stars&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
422    TGnuPlot::PlotValCntH(AllEdCnt, &quot;allEdCnt-&quot;+OutFNm, OutFNm, &quot;Number of edits&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
423    TGnuPlot::PlotValCntH(AllEdWrds, &quot;allEdWrds-&quot;+OutFNm, OutFNm, &quot;Number of edited words&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
424    TGnuPlot::PlotValCntH(MnEdCnt, &quot;MnEdCnt-&quot;+OutFNm, OutFNm, &quot;Number of edits on MAIN pages&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
425    TGnuPlot::PlotValCntH(MnEdWrds, &quot;MnEdWrds-&quot;+OutFNm, OutFNm, &quot;Number of edited words onmain pages&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
426    TGnuPlot::PlotValCntH(TkEdCnt, &quot;tkEdCnt-&quot;+OutFNm, OutFNm, &quot;Number of edits on TALK pages&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
427    TGnuPlot::PlotValCntH(TkEdWrds, &quot;tkEdWrds-&quot;+OutFNm, OutFNm, &quot;Number of edited words onmain pages&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
428  }
429  void TWikiTalkNet::PlotFracPosVsEdgeAttr(const TStr&amp; OutFNm) const {
430    THash&lt;TInt, TMom&gt; EdgeTalksH, EdgeTalksH2, EdgeWordsH;
431    THash&lt;TInt, TMom&gt; dBarnStars, dAllEdCnt, dAllEdWrds;
432    TIntH dBarnStarsCnt, dAllEdCntCnt, dAllEdWrdsCnt;
433    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
434      const int Val = EI().GetVote() ==1 ? 1 : 0;
435      if (EI().GetTalks() &lt; 100) {
436        EdgeTalksH.AddDat(int(EI().GetTalks())).Add(Val);
437      }
438      EdgeTalksH2.AddDat((int)log10((double)EI().GetTalks())).Add(Val);
439      EdgeWordsH.AddDat((int)log10((double)EI().GetWords())).Add(Val);
440      const TWikiUsr&amp; S = EI.GetSrcNDat();
441      const TWikiUsr&amp; D = EI.GetDstNDat();
442      if (abs(S.GetStars()-D.GetStars()) &lt; 10) {
443        dBarnStars.AddDat(S.GetStars()-D.GetStars()).Add(Val);
444        dBarnStarsCnt.AddDat(S.GetStars()-D.GetStars())++;
445      }
446      dAllEdCnt.AddDat(log10Delta(S.GetAllEdCnt()-D.GetAllEdCnt())).Add(Val);
447      dAllEdCntCnt.AddDat(log10Delta(S.GetAllEdCnt()-D.GetAllEdCnt()))++;
448      dAllEdWrds.AddDat(log10Delta(S.GetAllWrdCnt()-D.GetAllWrdCnt())).Add(Val);
449      dAllEdWrdsCnt.AddDat(log10Delta(S.GetAllWrdCnt()-D.GetAllWrdCnt()))++;
450    }
451    const bool SDev = true;
452    TGnuPlot::PlotValMomH(EdgeTalksH, &quot;edgeTks&quot;+OutFNm, OutFNm, &quot;Number of talks over the edge&quot;, &quot;Fraction of positive edges&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, SDev);
453    TGnuPlot::PlotValMomH(EdgeTalksH2, &quot;edgeTks2&quot;+OutFNm, OutFNm, &quot;1+Log_{10} Number of talks over the edge&quot;, &quot;Fraction of positive edges&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, SDev);
454    TGnuPlot::PlotValMomH(EdgeWordsH, &quot;edgeWrds&quot;+OutFNm, OutFNm, &quot;1+Log_{10} Number of words over all talks over the edge&quot;, &quot;Fraction of positive edges&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, SDev);
455    TGnuPlot::PlotValMomH(dBarnStars, &quot;dBarnStars-&quot;+OutFNm, OutFNm, &quot;delta BarnStars&quot;, &quot;Fraction of positive edges&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, SDev);
456    TGnuPlot::PlotValMomH(dAllEdCnt, &quot;dAllEdCnt-&quot;+OutFNm, OutFNm, &quot;delta AllEdCnt&quot;, &quot;Fraction of positive edges&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, SDev);
457    TGnuPlot::PlotValMomH(dAllEdWrds, &quot;dAllEdWrds-&quot;+OutFNm, OutFNm, &quot;delta AllEdWrds&quot;, &quot;Fraction of positive edges&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, SDev);
458    TGnuPlot::PlotValCntH(dBarnStarsCnt, &quot;dBarnStarsCnt-&quot;+OutFNm, OutFNm, &quot;delta BarnStars&quot;, &quot;Count&quot;, gpsAuto);
459    TGnuPlot::PlotValCntH(dAllEdCntCnt, &quot;dAllEdCntCnt-&quot;+OutFNm, OutFNm, &quot;delta AllEdCnt&quot;, &quot;Count&quot;, gpsAuto);
460    TGnuPlot::PlotValCntH(dAllEdWrdsCnt, &quot;dAllEdWrdsCnt-&quot;+OutFNm, OutFNm, &quot;delta AllEdWrds&quot;, &quot;Count&quot;, gpsAuto);
461  }
462  void TWikiTalkNet::PlotVoteSignCmnFriends(const TStr&amp; OutFNm) const {
463    TFltFltH SupRngH, OppRngH; 
464    TFltFltH SupCmnH, OppCmnH; 
465    THash&lt;TFlt, TMom&gt; RngFracH, CmnFracH; 
466    PWikiTalkNet ThisPt = PWikiTalkNet((TWikiTalkNet*) this);
467    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
468      const int C = -1; Fail;
469      const int R = -1; 
470      if (EI().GetVote() == 1) {
471        SupRngH.AddDat(R)++;  RngFracH.AddDat(R).Add(1);
472        SupCmnH.AddDat(C)++;  CmnFracH.AddDat(C).Add(1);
473      } else if (EI().GetVote() == -1) {
474        OppRngH.AddDat(R)++;  RngFracH.AddDat(R).Add(0);
475        OppCmnH.AddDat(C)++;  CmnFracH.AddDat(C).Add(0);
476      }
477    }
478    TGnuPlot::PlotValCntH(SupRngH, &quot;rngSup-&quot;+OutFNm, &quot;range of support votes&quot;, &quot;range (path length after edge is removed)&quot;, &quot;count&quot;);
479    TGnuPlot::PlotValCntH(OppRngH, &quot;rngOpp-&quot;+OutFNm, &quot;range of opposing votes&quot;, &quot;range (path length after edge is removed)&quot;, &quot;count&quot;);
480    TGnuPlot::PlotValCntH(SupCmnH, &quot;cmnSup-&quot;+OutFNm, &quot;number of common friends of support votes&quot;, &quot;number of common friends&quot;, &quot;count&quot;, gpsLog);
481    TGnuPlot::PlotValCntH(OppCmnH, &quot;cmnOpp-&quot;+OutFNm, &quot;number of common friends of opposing votes&quot;, &quot;number of common friends&quot;, &quot;count&quot;, gpsLog);
482    TGnuPlot::PlotValMomH(RngFracH, &quot;fracRng-&quot;+OutFNm, &quot;fraction of support edges spanning range X&quot;, &quot;range&quot;, &quot;fraction of support edges&quot;);
483    TGnuPlot::PlotValMomH(CmnFracH, &quot;fracCmn-&quot;+OutFNm, &quot;fraction of support edges having X common neighbors&quot;, &quot;number of common neighbors&quot;, &quot;fraction of support edges&quot;, gpsLog);
484  }
485  void TWikiTalkNet::SaveAreaUTrailAttr(const TStr&amp; OutFNm, const int&amp; MinUsrVotes, const TWikiElecBs&amp; ElecBs) const {
486    TIntV UIdV;
487    TFltV AreaV;
488    TIntSet AdminSet, ElecUsrV;
489    { TIntSet FqVoterSet; ElecBs.GetFqVoters(FqVoterSet, MinUsrVotes, 10, false); FqVoterSet.GetKeyV(UIdV);
490    TIntV ElecUIdV; ElecBs.GetElecUsrV(ElecUIdV); ElecUsrV=TIntSet(ElecUIdV); }
491    ElecBs.GetUsrAreaUTrail(UIdV, AreaV);
492    ElecBs.GetAdminSet(AdminSet);
493    FILE *F = fopen(OutFNm.CStr(), &quot;wt&quot;);
494    fprintf(F, &quot;Area\tUser\tIsAdmin\tIsElec\tTalkOutDeg\tInDeg\tTalkTriads\tBarnStars\tInAdmins\tOutAdmins\tAllEdCnt\tAllWrdCnt\tRevCnt\tRevWrds\n&quot;);
495    printf(&quot;%d users&quot;, UIdV.Len());
496    int skip=0;
497    for (int u = 0; u &lt; UIdV.Len(); u++) {
498      TStr Usr = ElecBs.GetUsr(UIdV[u]);
499      if (! IsUsr(Usr)) {  printf(&quot;x&quot;); skip++; continue; } else { printf(&quot;.&quot;); }
500      fprintf(F, &quot;%f\t%s\t%d\t%d&quot;, AreaV[u], Usr.CStr(), AdminSet.IsKey(UIdV[u])?1:0, ElecUsrV.IsKey(UIdV[u])?1:0);
501      TNodeI U =  GetNI(GetUsrNId(Usr));
502      fprintf(F, &quot;\t%d\t%d\t%d&quot;, U.GetOutDeg(), U.GetInDeg(), TSnap::GetNodeTriads&lt;PWikiTalkNet&gt;((TWikiTalkNet*)this, U.GetId()));
503      int OutAdmins=0, InAdmins=0;
504      for (int i = 0; i &lt; U.GetOutDeg(); i++) {
505        if (U.GetOutNDat(i).IsAdmin()) { OutAdmins++; } }
506      for (int i = 0; i &lt; U.GetInDeg(); i++) {
507        if (U.GetInNDat(i).IsAdmin()) { InAdmins++; } }
508      fprintf(F, &quot;\t%d\t%d\t%d\t%d\t%d\t%d\t%d\n&quot;, U().GetStars(), OutAdmins, InAdmins,
509        U().GetAllEdCnt(), U().GetAllWrdCnt(), U().GetRevCnt(), U().GetRevWrds());
510      fflush(F);
511    }
512    fclose(F);
513    printf(&quot;\n%d users, %d skip\n&quot;, UIdV.Len(), skip);
514  }
515  void TWikiTalkNet::DumpEdgeStat() const {
516    TIntH VoteE, TalkE, AllE, VtTkE;
517    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
518      const TWikiTalkEdge&amp; E = EI();
519      const int V = E.GetVote();
520      AllE.AddDat(V) += 1;
521      if (E.IsTalkE()) { TalkE.AddDat(V)+=1; }
522      if (E.IsVoteE()) { VoteE.AddDat(V)+=1; }
523      if (E.IsVoteTalkE()) { VtTkE.AddDat(V)+=1; }
524    }
525    VoteE.SortByKey(); TalkE.SortByKey(); AllE.SortByKey(); VtTkE.SortByKey();
526    printf(&quot;Edge\tAll\tTalk\tVote\tVoteTalk\n&quot;);
527    for (int e = 0; e &lt; AllE.Len(); e++) {
528      const int v = AllE.GetKey(e);
529      printf(&quot;%4d\t%7d\t%7d\t%7d\t%7d\n&quot;, v, AllE[e], TalkE.IsKey(v)?TalkE.GetDat(v):0,
530        VoteE.IsKey(v)?VoteE.GetDat(v):0, VtTkE.IsKey(v)?VtTkE.GetDat(v):0);
531    }
532    printf(&quot;\n&quot;);
533  }
534  void TWikiTalkNet::ClearElecData() {
535    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
536      EI().VoteSign = -1;
537      EI().VoteTm = TSecTm();
538    }
539    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
540      NI().Admin = false;
541      NI().ElecTm = TSecTm();
542    }
543  }
544  void TWikiTalkNet::ImposeElecNet(const TWikiElecBs&amp; ElecBs, const THash&lt;TChA, TChA&gt;&amp; UsrChageH, const bool&amp; AddVoteOnlyEdges) {
545    int GoodEl=0, ESet=0, ESkip=0, GoodVotes=0, AllCmts=0, VoteEdge=0;
546    int DstNf=0, SrcNf=0;
547    for (int e = 0; e &lt; ElecBs.Len(); e++) {
548      const TWikiElec&amp; E = ElecBs[e];
549      TChA DstUsr = ElecBs.GetUsr(E.GetUId());  DstUsr.ToLc();
550      if (UsrChageH.IsKey(DstUsr)) { DstUsr = UsrChageH.GetDat(DstUsr); }
551      if (! UsrNIdH.IsKey(DstUsr)) { DstNf++; continue; }
552      GoodEl++;
553      TWikiElec Votes;
554      E.GetOnlyVotes(Votes, false);
555      AllCmts += E.Len();
556      GoodVotes += Votes.Len();
557      for (int v = 0; v &lt; Votes.Len(); v++) {
558        TChA SrcUsr = ElecBs.GetUsr(E.GetVote(v).GetUId());  SrcUsr.ToLc();
559        if (UsrChageH.IsKey(SrcUsr)) { SrcUsr = UsrChageH.GetDat(SrcUsr); }
560        if (! UsrNIdH.IsKey(SrcUsr)) { SrcNf++;  continue; }
561        const int SrcId = UsrNIdH.GetDat(SrcUsr);
562        const int DstId = UsrNIdH.GetDat(DstUsr);
563        if (SrcId==DstId) { continue; }
564        if (IsEdge(SrcId, DstId)) {
565          GetEDat(SrcId, DstId).VoteSign = E.GetVote(v).GetVote();
566          GetEDat(SrcId, DstId).VoteTm = E.GetVote(v).GetTm();
567          ESet++;
568        }
569        else if (AddVoteOnlyEdges) {
570          AddEdge(SrcId, DstId);
571          TWikiTalkEdge&amp; EdgeDat = GetEDat(SrcId, DstId);
572          EdgeDat.VoteSign = E[v].GetVote();
573          EdgeDat.VoteTm = E[v].GetTm();
574          VoteEdge++;
575        }
576        else { ESkip++; }
577      }
578    }
579    printf(&quot;admins that talk (good elections): %d / %d\n&quot;, GoodEl, ElecBs.Len());
580    printf(&quot;actual votes vs. comments in elections: %d / %d : %f\n&quot;, GoodVotes, AllCmts, GoodVotes/double(AllCmts));
581    printf(&quot;votes where both users talk %d (%f of votes where nodes exist)\n&quot;, ESet, ESet/double(ESet+ESkip));
582    printf(&quot;fraction of all votes found in the graph: %d/%d : %f\n&quot;, ESet, GoodVotes, ESet/double(GoodVotes));
583    printf(&quot;destination not found: %d\n&quot;, DstNf);
584    printf(&quot;source not found: %d\n&quot;, SrcNf);
585    printf(&quot;talk+vote: %d  vote: %d  skip: %d\n&quot;, ESet, VoteEdge, ESkip);
586  }
587  PWikiTalkNet TWikiTalkNet::LoadTalkNet(const TStr&amp; ParsedWikiDir, const TWikiElecBs&amp; ElecBs) {
588    const TStr WikiUsrTalk = &quot;enwiki-20080103.user_talk.7z&quot;; 
589    const TStr WikiMain = &quot;enwiki-20080103.main.7z&quot;;
590    const TStr WikiMainTalk = &quot;enwiki-20080103.talk.7z&quot;;
591    const TStr WikiWiki = &quot;enwiki-20080103.wikipedia.7z&quot;;
592    const TStr WikiWikiTalk = &quot;enwiki-20080103.wikipedia_talk.7z&quot;;
593    const TStr BarnStartList = &quot;barnstars.history.unsorted&quot;;
594    const TStr AdminList = &quot;enwiki.admins2009.txt&quot;;
595    const TStr BotList = &quot;enwiki.botlist.2007-03&quot;;
596    const TStr UsrChanges = &quot;enwiki.important-username-changes.2007-08-06.txt&quot;;
597    THash&lt;TChA, TChA&gt; UsrMapH;
598    THashSet&lt;TChA&gt; BotSet;
599    THash&lt;TChA, TInt&gt; UsrElecId; 
600    TChA Ln;
601    TExeTm ExeTm;
602    for (TFIn FIn(ParsedWikiDir+BotList); FIn.GetNextLn(Ln); ) {
603      BotSet.AddKey(Ln.ToLc()); }
604    printf(&quot;Bots: %d bots\n&quot;, BotSet.Len());
605    for (TSsParser Ss(ParsedWikiDir+UsrChanges, ssfSpaceSep); Ss.Next(); ) {
606      TChA U1=Ss[0], U2=Ss[1]; if (U1.ToLc()!=U2.ToLc()) { UsrMapH.AddDat(U1,U2); }
607    }
608    printf(&quot;User changes: %d chages\n&quot;, UsrMapH.Len());
609    for (int e = 0; e &lt; ElecBs.Len(); e++) {
610      UsrElecId.AddDat(ElecBs.GetUsr(ElecBs[e].GetUId()), e); }
611    printf(&quot;Elections: %d users up for election\n&quot;, UsrElecId.Len());
612    printf(&quot;Load WikiTalk network:&quot;);
613    PWikiTalkNet Net = TWikiTalkNet::New();
614    printf(&quot;  Load %s &quot;, WikiUsrTalk.CStr());
615    { TWikiMetaLoader WML(ParsedWikiDir+WikiUsrTalk);
616    int src, dst, k, elecSet=0;
617    for (int edges=0; WML.Next(); edges++) {
618      if (! WML.Title.IsPrefix(&quot;User_talk:&quot;)) { printf(&quot;.&quot;); continue; }
619      const int b = (int) strlen(&quot;User_talk:&quot;);
620      int e2 = WML.Title.SearchCh(&#x27;/&#x27;, b)-1;
621      if (e2&lt;0) { e2=TInt::Mx; }
622      TChA Dst = WML.Title.GetSubStr(b, e2).ToLc();
623      TChA Src = WML.Usr.ToLc();
624      if (BotSet.IsKey(Src) || BotSet.IsKey(Dst)) { printf(&quot;&quot;); continue; }
625      if (TWikiMetaLoader::IsIpAddr(Src) || TWikiMetaLoader::IsIpAddr(Dst)) { printf(&quot;&quot;); continue; }
626      if (Src != Dst) { 
627        k = UsrMapH.GetKeyId(Src);
628        if (k != -1) { Src = UsrMapH[k]; }
629        k = UsrMapH.GetKeyId(Dst);
630        if (k != -1) { Dst = UsrMapH[k]; }
631        src = Net-&gt;UsrNIdH.AddDatId(Src);
632        dst = Net-&gt;UsrNIdH.AddDatId(Dst);
633        IAssert(src != dst);
634        if (! Net-&gt;IsNode(src)) {
635          Net-&gt;AddNode(src, TWikiUsr(Src));
636          if (UsrElecId.IsKey(Src)) { printf(&quot;T&quot;); elecSet++; 
637            Net-&gt;GetNDat(src).ElecTm = ElecBs.GetElec(UsrElecId.GetDat(Src)).GetTm();  }
638        }
639        if (! Net-&gt;IsNode(dst)) {
640          Net-&gt;AddNode(dst, TWikiUsr(Dst));
641          if (UsrElecId.IsKey(Dst)) { printf(&quot;T&quot;); elecSet++; 
642            Net-&gt;GetNDat(dst).ElecTm = ElecBs.GetElec(UsrElecId.GetDat(Dst)).GetTm(); }
643        }
644        if (! Net-&gt;IsEdge(src, dst)) {
645          Net-&gt;AddEdge(src, dst, TWikiTalkEdge(WML.RevTm, WML.RevTm, 1, WML.RevWrds));
646        }
647        TWikiTalkEdge&amp; TalkEdge = Net-&gt;GetEDat(src, dst);
648        if (TalkEdge.FirstTalk &gt; WML.RevTm) { TalkEdge.FirstTalk = WML.RevTm; }
649        if (TalkEdge.LastTalk &lt; WML.RevTm) { TalkEdge.LastTalk = WML.RevTm; }
650        TalkEdge.TotWords += WML.RevWrds;
651        TalkEdge.TotTalks += 1;
652        const TSecTm DstElecTm = Net-&gt;GetNDat(dst).ElecTm;
653        if (DstElecTm.IsDef()) { 
654          if (WML.RevTm &lt; DstElecTm) { TalkEdge.TalksBE++; TalkEdge.WordsBE+=WML.RevWrds; }
655          else { TalkEdge.TalksAE++; TalkEdge.WordsAE+=WML.RevWrds; }
656        }
657      }
658    }
659    printf(&quot;DONE NET[%s]\n&quot;, ExeTm.GetStr());  ExeTm.Tick();
660    printf(&quot;node election time %d / %d (%f)\n&quot;, elecSet, UsrElecId.Len(), elecSet/double(UsrElecId.Len())); }
661    TSnap::PrintInfo(Net, &quot;WikiUserTalk network.&quot;);
662    printf(&quot; [%s]\n  Loading %s\n&quot;, ExeTm.GetStr(), BarnStartList.CStr());  ExeTm.Tick();
663    int cnt=0, cnt2=0;
664    for (TSsParser Ss(ParsedWikiDir+BarnStartList, ssfSpaceSep); Ss.Next(); cnt2++) { TChA U1=Ss[3]; U1.ToLc();
665      if (UsrMapH.IsKey(U1)) { U1 = UsrMapH.GetDat(U1); }
666      if (Net-&gt;UsrNIdH.IsKey(U1)) { cnt++;
667        Net-&gt;GetNDat(Net-&gt;UsrNIdH.GetDat(U1)).BarnStars += 1; }
668    }
669    printf(&quot;    %d / %d stars set [%s]\n  Loading %s\n&quot;, cnt, cnt2, ExeTm.GetStr(), AdminList.CStr());  ExeTm.Tick();
670    cnt=0; cnt2=0;
671    for (TFIn FIn(ParsedWikiDir+AdminList); FIn.GetNextLn(Ln); cnt2++) { Ln.ToLc();
672      if (UsrMapH.IsKey(Ln)) { Ln = UsrMapH.GetDat(Ln); }
673      if (Net-&gt;UsrNIdH.IsKey(Ln)) { cnt++;
674        Net-&gt;GetNDat(Net-&gt;UsrNIdH.GetDat(Ln)).Admin = true; }
675    }/&amp;bsol;*/
676    printf(&quot;    %d / %d admins set [%s]\n&quot;, cnt, cnt2, ExeTm.GetStr());
677    TIntSet AdminSet; ElecBs.GetAdminSet(AdminSet);
678    for (int a = 0; a &lt; AdminSet.Len(); a++, cnt2++) {
679      TChA Ln = ElecBs.GetUsr(AdminSet[a]);
680      if (Net-&gt;UsrNIdH.IsKey(Ln)) { cnt++;
681        Net-&gt;GetNDat(Net-&gt;UsrNIdH.GetDat(Ln)).Admin = true; }
682    }
683    printf(&quot;    %d / %d admins set [%s]\n&quot;, cnt, cnt2, ExeTm.GetStr());
684    Net-&gt;ImposeElecNet(ElecBs, UsrMapH, true); 
685    TSnap::PrintInfo(Net);
686    printf(&quot;SAVE DONE.\n\nLoading user edit statistics:\n&quot;);
687    printf(&quot;  Loading %s &quot;, WikiMain.CStr());
688    { TWikiMetaLoader WML(ParsedWikiDir+WikiMain);
689    for (int rec=0; WML.Next(); rec++) {
690      const TChA&amp; U = WML.Usr;
691      const int keyId = Net-&gt;UsrNIdH.GetKeyId(U);
692      if (keyId == -1) { continue; }
693      TWikiUsr&amp; WU = Net-&gt;GetNDat(Net-&gt;UsrNIdH[keyId]);
694      WU.MnEdCnt += 1;  WU.MnEdWrds += WML.RevWrds;
695      WML.CommentStr.ToLc();
696      if (WML.CommentStr.IsPrefix(&quot;rv&quot;) || WML.CommentStr.SearchStr(&quot;revert&quot;)!=-1) {
697        WU.MnRevCnt+=1; WU.MnRevWrds+=WML.RevWrds; }
698    } }
699    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiMainTalk.CStr());  ExeTm.Tick();
700    { TWikiMetaLoader WML(ParsedWikiDir+WikiMainTalk);
701    for (int rec=0; WML.Next(); rec++) {
702      const TChA&amp; U = WML.Usr.ToLc();
703      const int keyId = Net-&gt;UsrNIdH.GetKeyId(U);
704      if (keyId == -1) { continue; }
705      TWikiUsr&amp; WU = Net-&gt;GetNDat(Net-&gt;UsrNIdH[keyId]);
706      WU.MnTkEdCnt += 1;  WU.MnTkEdWrds += WML.RevWrds;
707    } }
708    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiWiki.CStr());  ExeTm.Tick();
709    { TWikiMetaLoader WML(ParsedWikiDir+WikiWiki);
710    for (int rec=0; WML.Next(); rec++) {
711      const TChA&amp; U = WML.Usr.ToLc();
712      const int keyId = Net-&gt;UsrNIdH.GetKeyId(U);
713      if (keyId == -1) { continue; }
714      TWikiUsr&amp; WU = Net-&gt;GetNDat(Net-&gt;UsrNIdH[keyId]);
715      WU.WkEdCnt += 1;  WU.WkEdWrds += WML.RevWrds;
716    } }
717    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiWikiTalk.CStr());  ExeTm.Tick();
718    { TWikiMetaLoader WML(ParsedWikiDir+WikiWikiTalk);
719    for (int rec=0; WML.Next(); rec++) {
720      const TChA&amp; U = WML.Usr.ToLc();
721      const int keyId = Net-&gt;UsrNIdH.GetKeyId(U);
722      if (keyId == -1) { continue; }
723      TWikiUsr&amp; WU = Net-&gt;GetNDat(Net-&gt;UsrNIdH[keyId]);
724      WU.WkTkEdCnt += 1;  WU.WkTkEdWrds += WML.RevWrds;
725    } }
726    TSnap::PrintInfo(Net, &quot;WikiUserTalk network.&quot;);
727    printf(&quot;\n[%s]\nDONE.\n&quot;, ExeTm.GetStr());
728    return Net;
729  }
730  PWikiTalkNet TWikiTalkNet::LoadSlashdot(const TStr&amp; InFNm) {
731    THashSet&lt;TChA&gt; NIdSet;
732    TChA LnStr;
733    TVec&lt;char *&gt; WrdV;
734    int Sign;
735    PWikiTalkNet Net = TWikiTalkNet::New();
736    for (TFIn FIn(InFNm); FIn.GetNextLn(LnStr); ) {
737      if (LnStr.Empty() || LnStr[0]==&#x27;#&#x27;) { continue; }
738      LnStr.ToLc();
739      TStrUtil::SplitOnCh(LnStr, WrdV, &#x27;\t&#x27;, false);
740      NIdSet.AddKey(WrdV[0]);
741      if (strcmp(WrdV[1], &quot;friends&quot;)==0) { Sign = 1; }
742      else if (strcmp(WrdV[1], &quot;fans&quot;)==0) { continue; } 
743      else if (strcmp(WrdV[1], &quot;foes&quot;)==0) { Sign = -1; }
744      else { Fail; }
745      const int SrcNId = NIdSet.AddKey(WrdV[0]);
746      if (! Net-&gt;IsNode(SrcNId)) {
747        Net-&gt;AddNode(SrcNId, TWikiUsr(WrdV[0]));
748        Net-&gt;UsrNIdH.AddDat(WrdV[0], SrcNId);
749      }
750      for (int e = 2; e &lt; WrdV.Len(); e++) {
751        const int DstNId = NIdSet.AddKey(WrdV[e]);
752        if (! Net-&gt;IsNode(DstNId)) {
753          Net-&gt;AddNode(DstNId, TWikiUsr(WrdV[e]));
754          Net-&gt;UsrNIdH.AddDat(WrdV[e], DstNId);
755        }
756        if (SrcNId != DstNId &amp;&amp; ! Net-&gt;IsEdge(SrcNId, DstNId)) {
757          Net-&gt;AddEdge(SrcNId, DstNId, TWikiTalkEdge(Sign));
758        }
759      }
760    }
761    TSnap::PrintInfo(Net, InFNm);
762    return Net;
763  }
764  PWikiTalkNet TWikiTalkNet::LoadOldNet(const TStr&amp; InFNm) {
765    typedef TNodeEDatNet&lt;TStr, TInt&gt; TOldNet;
766    PWikiTalkNet Net = TWikiTalkNet::New();
767    TPt&lt;TOldNet&gt; ON = TOldNet::Load(TZipIn(InFNm));
768    TSnap::PrintInfo(ON);
769    for(TOldNet::TEdgeI EI = ON-&gt;BegEI(); EI&lt;ON-&gt;EndEI(); EI++) {
770      if (! Net-&gt;IsNode(EI.GetSrcNId())) {
771        Net-&gt;AddNode(EI.GetSrcNId(), TWikiUsr(EI.GetSrcNDat().GetLc()));
772        Net-&gt;UsrNIdH.AddDat(EI.GetDstNDat().GetLc(), EI.GetSrcNId());
773      }
774      if (! Net-&gt;IsNode(EI.GetDstNId())) {
775        Net-&gt;AddNode(EI.GetDstNId(), TWikiUsr(EI.GetDstNDat().GetLc()));
776        Net-&gt;UsrNIdH.AddDat(EI.GetDstNDat().GetLc(), EI.GetDstNId());
777      }
778      Net-&gt;AddEdge(EI.GetSrcNId(), EI.GetDstNId(), TWikiTalkEdge(EI()));
779    }
780    TSnap::PrintInfo(Net);
781    return Net;
782  }
783  PNGraph TWikiTimeTalkNet::GetBeforeTimeG(const TSecTm&amp; EdgeTm) const {
784    PNGraph G = TNGraph::New();
785    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
786      if (EI().Tm &lt;= EdgeTm) {
787        if (! G-&gt;IsNode(EI.GetSrcNId())) { G-&gt;AddNode(EI.GetSrcNId()); }
788        if (! G-&gt;IsNode(EI.GetDstNId())) { G-&gt;AddNode(EI.GetDstNId()); }
789        G-&gt;AddEdge(EI.GetSrcNId(), EI.GetDstNId());
790      }
791    }
792    return G;
793  }
794  PSignNet TWikiTimeTalkNet::GetBeforeTimeNet(const TSecTm&amp; EdgeTm) const {
795    PSignNet Net = TSignNet::New();
796    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
797      if (EI().Tm &lt;= EdgeTm) {
798        if (! Net-&gt;IsNode(EI.GetSrcNId())) { Net-&gt;AddNode(EI.GetSrcNId()); }
799        if (! Net-&gt;IsNode(EI.GetDstNId())) { Net-&gt;AddNode(EI.GetDstNId()); }
800        Net-&gt;AddEdge(EI.GetSrcNId(), EI.GetDstNId());
801        Net-&gt;GetEDat(EI.GetSrcNId(), EI.GetDstNId()) += EI().Words;
802      }
803    }
804    return Net;
805  }
806  void TWikiTimeTalkNet::SaveDataset(const TWikiElecBs&amp; ElecBs, const TStr&amp; OutFNm) const {
807    FILE *F = fopen(OutFNm.CStr(), &quot;wt&quot;);
808    fprintf(F, &quot;SuccElec\tRfa\tNetNodes\tNetEdges\tNetConstraint\tBarnStars\tTalkOutDeg\tTalkInDeg\tTalkTriads\tInWords\tOutWords\tInAdmins\tOutAdmins\tAdminTriads\tInAdminWords\tOutAdminWords\n&quot;);
809    TStrSet AdminSet;
810    for (TSsParser Ss(&quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki.admins2009.txt&quot;, ssfTabSep); Ss.Next(); ) {
811      TStr A=Ss[0]; AdminSet.AddKey(A.GetTrunc().GetLc());
812    }
813    TExeTm ExeTm;
814    TBarnStars  BarnStars;
815    TIntSet AdminNIdSet;
816    printf(&quot;Admin list: %d\n&quot;, AdminSet.Len());
817    for (int e = 0; e &lt; ElecBs.Len(); e++) {
818      const TWikiElec&amp; E = ElecBs.GetElec(e);
819      const TStr Usr = ElecBs.GetUsr(E.UsrId);
820      printf(&quot;%s: %s   &quot;, Usr.CStr(), E.RfaTitle.CStr());
821      if (! UsrNIdH.IsKey(Usr)) {
822        printf(&quot; DOES NOT TALK\n&quot;, Usr.CStr()); continue;
823      }
824      PSignNet Net = GetBeforeTimeNet(E.ElecTm);
825      const int NId = UsrNIdH.GetDat(Usr);
826      if (! Net-&gt;IsNode(NId)) {
827        printf(&quot; TALKS AFTER ELECTION\n&quot;); continue;
828      }
829      const TSignNet::TNodeI NI = Net-&gt;GetNI(NId);
830      printf(&quot; deg %d:%d &quot;, NI.GetInDeg(), NI.GetOutDeg());
831      int InWgt=0, OutWgt=0, InAdmins=0, OutAdmins=0, InAWgt=0, OutAWgt=0;
832      AdminNIdSet.Clr(false);
833      AdminNIdSet.AddKey(NI.GetId());
834      for (int i = 0; i &lt; NI.GetOutDeg(); i++) {
835        OutWgt += NI.GetOutEDat(i);
836        if (AdminSet.IsKey(UsrNIdH.GetKey(NI.GetOutNId(i)))) {
837          OutAWgt += NI.GetOutEDat(i);
838          OutAdmins++;
839          AdminNIdSet.AddKey(NI.GetOutNId(e));
840        }
841      }
842      for (int i = 0; i &lt; NI.GetInDeg(); i++) {
843        InWgt += NI.GetInEDat(i);
844        if (AdminSet.IsKey(UsrNIdH.GetKey(NI.GetInNId(i)))) {
845          InAWgt += NI.GetInEDat(i);
846          InAdmins++;
847          AdminNIdSet.AddKey(NI.GetInNId(e));
848        }
849      }
850      TSnap::TNetConstraint&lt;PSignNet&gt; NetC(Net, false);
851      NetC.CalcConstraints(NId);
852      TIntV AdminV; AdminNIdSet.GetKeyV(AdminV);
853      const double C = NetC.GetNodeC(NId);
854      const int BS = BarnStars.GetBarnStars(Usr, E.GetTm());
855      const int Triads = TSnap::GetNodeTriads(Net, NI.GetId());
856      const int AdmintTriads = TSnap::GetNodeTriads(TSnap::GetSubGraph(Net, AdminV), NI.GetId());
857      fprintf(F, &quot;%d\t%s\t%d\t%d\t%f\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\n&quot;, E.IsSucc?1:0, E.RfaTitle.CStr(), Net-&gt;GetNodes(), Net-&gt;GetEdges(), C, BS,
858        NI.GetOutDeg(), NI.GetInDeg(), Triads, InWgt, OutWgt, InAdmins, OutAdmins, AdmintTriads, InAWgt, OutAWgt);
859      fflush(F);
860      printf(&quot; [%s]\n&quot;, ExeTm.GetStr());
861    }
862    fclose(F);
863  }
864  PWikiTimeTalkNet TWikiTimeTalkNet::LoadWikiTimeTalkNet() {
865    const TStr WikiUsrTalk = &quot;W:\\data\\wiki20080103-parseByGuerogy\\enwiki-20080103.user_talk.7z&quot;; 
866    const TStr UsrChanges = &quot;W:\\data\\wiki20080103-parseByGuerogy\\enwiki.important-username-changes.2007-08-06&quot;;
867    const TStr BotList = &quot;W:\\data\\wiki20080103-parseByGuerogy\\enwiki.botlist.2007-03&quot;;
868    THash&lt;TChA, TChA&gt; UsrMapH;
869    THashSet&lt;TChA&gt; BotSet;
870    TChA Ln;
871    TExeTm ExeTm;
872    for (TFIn FIn(BotList); FIn.GetNextLn(Ln); ) {
873      BotSet.AddKey(Ln.ToLc()); }
874    printf(&quot;Bots: %d bots\n&quot;, BotSet.Len());
875    for (TSsParser Ss(UsrChanges, ssfSpaceSep); Ss.Next(); ) {
876      TChA U1=Ss[3], U2=Ss[4]; if (U1.ToLc()!=U2.ToLc()) { UsrMapH.AddDat(U1,U2); } }
877    printf(&quot;User changes: %d chages\n&quot;, UsrMapH.Len());
878    printf(&quot;Load Take network before the election:&quot;);
879    PWikiTimeTalkNet Net = TWikiTimeTalkNet::New();
880    printf(&quot;  Load %s &quot;, WikiUsrTalk.CStr());
881    TWikiMetaLoader WML(WikiUsrTalk);
882    int src, dst, k;
883    for (int edges=0; WML.Next(); edges++) {
884      if (! WML.Title.IsPrefix(&quot;User_talk:&quot;)) { printf(&quot;.&quot;); continue; }
885      const int b = (int) strlen(&quot;User_talk:&quot;);
886      int e2 = WML.Title.SearchCh(&#x27;/&#x27;, b)-1;
887      if (e2&lt;0) { e2=TInt::Mx; }
888      TChA Dst = WML.Title.GetSubStr(b, e2).ToLc();
889      TChA Src = WML.Usr.ToLc();
890      if (BotSet.IsKey(Src) || BotSet.IsKey(Dst)) { printf(&quot;&quot;); continue; }
891      if (TWikiMetaLoader::IsIpAddr(Src) || TWikiMetaLoader::IsIpAddr(Dst)) { printf(&quot;&quot;); continue; }
892      if (Src != Dst) { 
893        k = UsrMapH.GetKeyId(Src);
894        if (k != -1) { Src = UsrMapH[k]; }
895        k = UsrMapH.GetKeyId(Dst);
896        if (k != -1) { Dst = UsrMapH[k]; }
897        src = Net-&gt;UsrNIdH.AddDatId(Src);
898        dst = Net-&gt;UsrNIdH.AddDatId(Dst);
899        if (src != dst) {
900          if (! Net-&gt;IsNode(src)) { Net-&gt;AddNode(src, Src); }
901          if (! Net-&gt;IsNode(dst)) { Net-&gt;AddNode(dst, Dst); }
902          Net-&gt;AddEdge(src, dst, -1, TWikiTalkEdge2(WML.RevTm, WML.RevWrds));
903        }
904      }
905    }
906    printf(&quot;DONE NET[%s]\n&quot;, ExeTm.GetStr());  ExeTm.Tick();
907    return Net;
908  }
909  void TWikiEditCnt::LoadTxtBeforeElec(const TWikiElecBs&amp; ElecBs) {
910    const TStr WikiMain = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.main.7z&quot;;
911    const TStr WikiMainTalk = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.talk.7z&quot;;
912    const TStr WikiWiki = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.wikipedia.7z&quot;;
913    const TStr WikiWikiTalk = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.wikipedia_talk.7z&quot;;
914    const TStr UsrChanges = &quot;W:\\data\\wiki20080103-parseByGuerogy\\enwiki.important-username-changes.2007-08-06&quot;;
915    THash&lt;TChA, TChA&gt; UsrMapH;
916    for (TSsParser Ss(UsrChanges, ssfSpaceSep); Ss.Next(); ) {
917      TChA U1=Ss[3], U2=Ss[4]; if (U1.ToLc()!=U2.ToLc()) { UsrMapH.AddDat(U1,U2); } }
918    THash&lt;TChA, TVec&lt;TPair&lt;TChA, TSecTm&gt; &gt; &gt; UsrToRfaTmH;
919    for (int e = 0; e &lt; ElecBs.Len(); e++) {
920      UsrToRfaTmH.AddDat(ElecBs.GetUsr(ElecBs[e].GetUId())).Add(TPair&lt;TChA, TSecTm&gt;(ElecBs[e].RfaTitle, ElecBs[e].GetTm()));
921    }
922    TExeTm ExeTm;
923    printf(&quot;  Loading %s &quot;, WikiMain.GetFMid().CStr());
924    { TWikiMetaLoader WML(WikiMain);
925    for (int rec=0; WML.Next(); rec++) {
926      TChA U = WML.Usr;
927      if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
928      if (! UsrToRfaTmH.IsKey(U)) { continue; }
929      const TVec&lt;TPair&lt;TChA, TSecTm&gt; &gt;&amp; V = UsrToRfaTmH.GetDat(U);
930      for (int t = 0; t &lt; V.Len(); t++) {
931        if (WML.RevTm &lt;= V[t].Val2 ) { 
932          TEditCnt&amp; EC = RfaEdCntH.AddDat(V[t].Val1);
933          EC.MainE+=1; EC.MainW+=WML.RevWrds;
934          WML.CommentStr.ToLc();
935          if (WML.CommentStr.IsPrefix(&quot;rv&quot;) || WML.CommentStr.SearchStr(&quot;revert&quot;)!=-1) {
936            EC.RevE+=1; EC.RevW+=WML.RevWrds;
937          }
938        }
939      }
940    } }
<span onclick='openModal()' class='match'>941    Save(TZipOut(&quot;wikiEditCounts.BeforeElec.rar&quot;));
942    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiMainTalk.GetFMid().CStr());  ExeTm.Tick();
943    { TWikiMetaLoader WML(WikiMainTalk);
944    for (int rec=0; WML.Next(); rec++) {
945      TChA U = WML.Usr;
</span>946      if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
947      if (! UsrToRfaTmH.IsKey(U)) { continue; }
948      const TVec&lt;TPair&lt;TChA, TSecTm&gt; &gt;&amp; V = UsrToRfaTmH.GetDat(U);
949      for (int t = 0; t &lt; V.Len(); t++) {
950        if (WML.RevTm &lt;= V[t].Val2 ) {
951          TEditCnt&amp; EC = RfaEdCntH.AddDat(V[t].Val1);
952          EC.MainTE+=1; EC.MainTW+=WML.RevWrds;
953        }
954      }
955    } }
956    Save(TZipOut(&quot;wikiEditCounts.BeforeElec.rar&quot;));
957    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiWiki.GetFMid().CStr());  ExeTm.Tick();
958    { TWikiMetaLoader WML(WikiWiki);
959    for (int rec=0; WML.Next(); rec++) {
960      TChA U = WML.Usr;
961      if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
962      if (! UsrToRfaTmH.IsKey(U)) { continue; }
963      const TVec&lt;TPair&lt;TChA, TSecTm&gt; &gt;&amp; V = UsrToRfaTmH.GetDat(U);
964      for (int t = 0; t &lt; V.Len(); t++) {
965        if (WML.RevTm &lt;= V[t].Val2 ) {
966          TEditCnt&amp; EC = RfaEdCntH.AddDat(V[t].Val1);
967          EC.WikiE+=1; EC.WikiW+=WML.RevWrds;
968        }
969      }
970    } }
971    Save(TZipOut(&quot;wikiEditCounts.BeforeElec.rar&quot;));
972    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiWikiTalk.GetFMid().CStr());  ExeTm.Tick();
973    { TWikiMetaLoader WML(WikiWikiTalk);
974    for (int rec=0; WML.Next(); rec++) {
975      TChA U = WML.Usr;
976      if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
977      if (! UsrToRfaTmH.IsKey(U)) { continue; }
978      const TVec&lt;TPair&lt;TChA, TSecTm&gt; &gt;&amp; V = UsrToRfaTmH.GetDat(U);
979      for (int t = 0; t &lt; V.Len(); t++) {
980        if (WML.RevTm &lt;= V[t].Val2 ) {
981          TEditCnt&amp; EC = RfaEdCntH.AddDat(V[t].Val1);
982          EC.WikiTE+=1; EC.WikiTW+=WML.RevWrds;
983        }
984      }
985    } }
986    Save(TZipOut(&quot;wikiEditCounts.BeforeElec.rar&quot;));
987    printf(&quot; [%s]\n&quot;, ExeTm.GetStr());
988  }
989  void TWikiEditCnt::LoadTxtAll(const TWikiElecBs&amp; ElecBs) {
990    const TStr WikiMain = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.main.7z&quot;;
991    const TStr WikiMainTalk = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.talk.7z&quot;;
992    const TStr WikiWiki = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.wikipedia.7z&quot;;
993    const TStr WikiWikiTalk = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.wikipedia_talk.7z&quot;;
994    const TStr UsrChanges = &quot;W:\\data\\wiki20080103-parseByGuerogy\\enwiki.important-username-changes.2007-08-06&quot;;
995    TExeTm ExeTm;
996    printf(&quot;  Loading %s &quot;, WikiMain.GetFMid().CStr());
997    { TWikiMetaLoader WML(WikiMain);
998    for (int rec=0; WML.Next(); rec++) {
999      if (! ElecBs.IsUsr(WML.Usr)) { continue; }
1000      TEditCnt&amp; EC = RfaEdCntH.AddDat(WML.Usr);
1001      EC.MainE+=1; EC.MainW+=WML.RevWrds;
1002      WML.CommentStr.ToLc();
1003      if (WML.CommentStr.IsPrefix(&quot;rv&quot;) || WML.CommentStr.SearchStr(&quot;revert&quot;)!=-1) {
1004        EC.RevE+=1; EC.RevW+=WML.RevWrds;
1005      }
1006    } }
1007    Save(TZipOut(&quot;wikiEditCounts.All.rar&quot;));
1008    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiMainTalk.GetFMid().CStr());  ExeTm.Tick();
1009    { TWikiMetaLoader WML(WikiMainTalk);
1010    for (int rec=0; WML.Next(); rec++) {
1011      if (! ElecBs.IsUsr(WML.Usr)) { continue; }
1012      TEditCnt&amp; EC = RfaEdCntH.AddDat(WML.Usr);
1013      EC.MainTE+=1; EC.MainTW+=WML.RevWrds;
1014    } }
1015    Save(TZipOut(&quot;wikiEditCounts.All.rar&quot;));
1016    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiWiki.GetFMid().CStr());  ExeTm.Tick();
1017    { TWikiMetaLoader WML(WikiWiki);
1018    for (int rec=0; WML.Next(); rec++) {
1019      TChA U = WML.Usr;
1020      if (! ElecBs.IsUsr(WML.Usr)) { continue; }
1021      TEditCnt&amp; EC = RfaEdCntH.AddDat(WML.Usr);
1022      EC.WikiE+=1; EC.WikiW+=WML.RevWrds;
1023    } }
1024    Save(TZipOut(&quot;wikiEditCounts.All.rar&quot;));
1025    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiWikiTalk.GetFMid().CStr());  ExeTm.Tick();
1026    { TWikiMetaLoader WML(WikiWikiTalk);
1027    for (int rec=0; WML.Next(); rec++) {
1028      if (! ElecBs.IsUsr(WML.Usr)) { continue; }
1029      TEditCnt&amp; EC = RfaEdCntH.AddDat(WML.Usr);
1030      EC.WikiTE+=1; EC.WikiTW+=WML.RevWrds;
1031    } }
1032    Save(TZipOut(&quot;wikiEditCounts.All.rar&quot;));
1033    printf(&quot; [%s]\n&quot;, ExeTm.GetStr());
1034  }
1035  void TWikiEditCnt::SaveTxt(const TWikiElecBs&amp; ElecBs, const TStr&amp; OutFNm) {
1036    FILE *F = fopen(OutFNm.CStr(), &quot;wt&quot;);
1037    fprintf(F, &quot;Rfat\tMainE\tMainW\tMainTE\tMainTW\tWikiE\tWikiW\tWikiTE\tWikiTW\n&quot;);
1038    for (TSsParser Ss(&quot;isSuccVote-TalkNet3.tab&quot;, ssfTabSep); Ss.Next(); ) {
1039      TStr Rfa = Ss[1];
1040      if (! RfaEdCntH.IsKey(Rfa)) {
1041        printf(&quot;%s\n&quot;, Rfa.CStr());
1042        fprintf(F, &quot;%s\t0\t0\t0\t0\t0\t0\t0\t0\n&quot;, Rfa.CStr());
1043      } else {
1044        const TEditCnt&amp; EC = RfaEdCntH.GetDat(Rfa);
1045        fprintf(F, &quot;%s\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\n&quot;, Rfa.CStr(),
1046          EC.MainE(), EC.MainW(), EC.MainTE(), EC.MainTW(), EC.WikiE(), EC.WikiW(), EC.WikiTE(), EC.WikiTW());
1047      }
1048    }
1049    fclose(F);
1050  }
1051  TWikiElec::TWikiElec(TSIn&amp; SIn) : RfaTitle(SIn), UsrId(SIn), NomUId(SIn), BurUId(SIn), IsSucc(SIn), ElecTm(SIn), VoteV(SIn) {
1052  }
1053  void TWikiElec::Save(TSOut&amp; SOut) const {
1054    RfaTitle.Save(SOut); UsrId.Save(SOut); NomUId.Save(SOut);
1055    BurUId.Save(SOut); IsSucc.Save(SOut); ElecTm.Save(SOut);
1056    VoteV.Save(SOut);
1057  }
1058  bool TWikiElec::operator &lt; (const TWikiElec&amp; WE) const {
1059    return ElecTm&lt;WE.ElecTm || (ElecTm==WE.ElecTm &amp;&amp; UsrId&lt;WE.UsrId);
1060  }
1061  void TWikiElec::SetIsVoteFlag() {
1062    THash&lt;TInt, TIntPr&gt; UsrVoteH(Len());
1063    for (int i = 0; i &lt; VoteV.Len(); i++) {
1064      if (VoteV[i].GetIndent() != 0) { continue; } 
1065      if (VoteV[i].GetUId() == UsrId) { continue; }  
1066      if (! UsrVoteH.IsKey(VoteV[i].GetUId())) {
1067        UsrVoteH.AddDat(VoteV[i].GetUId(), TIntPr(VoteV[i].GetTm().GetAbsSecs(), i));
1068      } else {
1069        TIntPr&amp; Dat = UsrVoteH.GetDat(VoteV[i].GetUId());
1070        if (Dat.Val1 &gt; (int)VoteV[i].GetTm().GetAbsSecs()) { 
1071          Dat = TIntPr(VoteV[i].GetTm().GetAbsSecs(), i);
1072        }
1073      }
1074    }
1075    for (int v = 0; v &lt; VoteV.Len(); v++) {
1076      VoteV[v].IsAVote = false;
1077    }
1078    for (int v = 0; v &lt; UsrVoteH.Len(); v++) {
1079      VoteV[UsrVoteH[v].Val2].IsAVote = true;
1080    }
1081  }
1082  double TWikiElec::GetFracSup(const bool&amp; OnlyVotes) const {
1083    const TIntTr Votes = GetVotes(OnlyVotes);
1084    return double(Votes.Val1)/double(Votes.Val1+Votes.Val3);
1085  }
1086  double TWikiElec::GetFracSup(int VoteId1, int VoteId2) const {
1087    double Sup=0;
1088    for (int v = VoteId1; v &lt; TMath::Mn(VoteId2, Len()); v++) {
1089      if (VoteV[v].GetVote()==1) { Sup+=1; }
1090    }
1091    if (VoteId1==VoteId2) { return 0.0; }
1092    return Sup/double(VoteId2-VoteId1);
1093  }
1094  double TWikiElec::GetTrend(int VoteId1, int VoteId2) const {
1095    TFltPrV XY;
1096    for (int v = VoteId1; v &lt; VoteId2; v++) {
1097      XY.Add(TFltPr(v, (double)VoteV[v].GetVote()));
1098    }
1099    double A, B, SigA, SigB, Chi2, R2;
1100    TSpecFunc::LinearFit(XY, A, B, SigA, SigB, Chi2, R2);
1101    return B;
1102  }
1103  TIntTr TWikiElec::GetVotes(const bool&amp; OnlyVotes) const {
1104    int Sup=0, Opp=0, Neu=0;
1105    for (int i = 0; i &lt; VoteV.Len(); i++) {
1106      if (OnlyVotes &amp;&amp; ! VoteV[i].IsVote()) { continue; }
1107      if (VoteV[i].GetVote()==1) { Sup++; }
1108      else if (VoteV[i].GetVote()==0) { Neu++; }
1109      else if (VoteV[i].GetVote()==-1) { Opp++; }
1110    }
1111    return TIntTr(Sup, Neu, Opp);
1112  }
1113  void TWikiElec::GetVotesOt(TWikiVoteV&amp; WVoteV, const bool&amp; OnlyVotes) const {
1114    if (! OnlyVotes) {
1115      WVoteV = VoteV;
1116      WVoteV.Sort();
1117      return;
1118    }
1119    TIntPrV TmIdV;
1120    for (int i = 0; i &lt; VoteV.Len(); i++) {
1121      if (OnlyVotes &amp;&amp; ! VoteV[i].IsVote()) { continue; }
1122      TmIdV.Add(TIntPr(VoteV[i].VoteTm.GetAbsSecs(), i));
1123    }
1124    TmIdV.Sort();
1125    WVoteV.Clr(false);
1126    for (int v = 0; v &lt; TmIdV.Len(); v++) {
1127      WVoteV.Add(VoteV[TmIdV[v].Val2]);
1128    }
1129    WVoteV.Sort();
1130  }
1131  int TWikiElec::GetAvgVoteOt(TFltV&amp; AvgVoteV, const bool&amp; OnlyVotes) const {
1132    TWikiVoteV WVoteV;  GetVotesOt(WVoteV, OnlyVotes);
1133    double VoteSum = 0;
1134    AvgVoteV.Clr(false);
1135    for (int i = 0; i &lt; WVoteV.Len(); i++) {
1136      VoteSum += WVoteV[i].GetVote() &gt; 0 ? 1 : 0;
1137      AvgVoteV.Add(VoteSum/double(i+1));
1138    }
1139    return AvgVoteV.Len();
1140  }
1141  int TWikiElec::GetAvgVoteDevOt(TFltV&amp; AvgVoteV, const bool&amp; OnlyVotes) const {
1142    TWikiVoteV WVoteV;  GetVotesOt(WVoteV, OnlyVotes);
1143    double XBar = WVoteV[0].GetVote() &gt; 0 ? 1 : 0;
1144    AvgVoteV.Clr(false);
1145    for (int i = 1; i &lt; WVoteV.Len(); i++) {
1146      const double CurVote = WVoteV[i].GetVote() &gt; 0 ? 1 : 0;
1147      AvgVoteV.Add(fabs(CurVote-XBar)/double(i+1));
1148      XBar = (i*XBar+CurVote)/double(i+1);
1149    }
1150    return AvgVoteV.Len();
1151  }
1152  int TWikiElec::GetRunLen(const int&amp; VoteId) const {
1153    const int V = VoteV[VoteId].GetVote();
1154    int runL=0;
1155    for (int v = VoteId+1; v &lt; Len(); v++) {
1156      if (VoteV[v].GetVote() == V) { runL++; }
1157      else { return runL; }
1158    }
1159    return runL;
1160  }
1161  void TWikiElec::PermuteVotes() {
1162    TIntV ValV(VoteV.Len(), 0);
1163    for (int i = 0; i &lt; VoteV.Len(); i++) {
1164      ValV.Add(VoteV[i].UsrVote); }
1165    ValV.Shuffle(TInt::Rnd);
1166    for (int i = 0; i &lt; ValV.Len(); i++) {
1167      VoteV[i].UsrVote=ValV[i]; }
1168  }
1169  void TWikiElec::KeepVotes(const TIntSet&amp; UIdSet) {
1170    TWikiVoteV NewVoteV;
1171    for (int v = 0; v &lt; VoteV.Len(); v++) {
1172      if (UIdSet.IsKey(VoteV[v].GetUId())) {
1173        NewVoteV.Add(VoteV[v]);
1174      }
1175    }
1176    VoteV=NewVoteV;
1177  }
1178  void TWikiElec::GetOnlyVotes(TWikiElec&amp; NewElec, const bool&amp; OnlySupOpp) const {
1179    NewElec.RfaTitle = RfaTitle;
1180    NewElec.UsrId = UsrId;
1181    NewElec.NomUId = NomUId;
1182    NewElec.BurUId = BurUId;
1183    NewElec.IsSucc = IsSucc;
1184    NewElec.ElecTm = ElecTm;
1185    NewElec.VoteV.Clr(false);
1186    for (int i = 0; i &lt; VoteV.Len(); i++) {
1187      if (! VoteV[i].IsVote()) { continue; }
1188      if (OnlySupOpp &amp;&amp; VoteV[i].GetVote()==0) { continue; }
1189      NewElec.VoteV.Add(VoteV[i]);
1190    }
1191  }
1192  void TWikiElec::RemoveSelfVotes() {
1193    TWikiVoteV VoteV2(Len(), 0);
1194    for (int v = 0; v &lt; VoteV.Len(); v++) {
1195      if (VoteV[v].GetIndent()==0 &amp;&amp; VoteV[v].GetUId()==UsrId) { continue; } 
1196      VoteV2.Add(VoteV[v]);
1197    }
1198    VoteV.Swap(VoteV2);
1199  }
1200  void TWikiElec::Dump(const TStrHash&lt;TInt&gt;&amp; UsrH) const {
1201    TIntTr V = GetVotes(true);
1202    if (UsrH.IsKeyId(UsrId)) {
1203      printf(&quot;\nELEC %s : %s %d vote at %s votes %d\n&quot;, RfaTitle.CStr(), UsrH.GetKey(UsrId), UsrId, ElecTm.GetYmdTmStr().CStr(), VoteV.Len()); }
1204    else {
1205       printf(&quot;\nELEC %s : %d  %d vote at %s votes %d\n&quot;, RfaTitle.CStr(), UsrId, ElecTm.GetYmdTmStr().CStr(), VoteV.Len()); }
1206    printf(&quot;    %d / %d / %d  =  %f\n&quot;, V.Val1, V.Val2, V.Val3, V.Val1/double(V.Val1+V.Val3));
1207    for (int v = 0; v &lt; VoteV.Len(); v++) {
1208      if (UsrH.IsKeyId(VoteV[v].UsrId)) {
1209        printf(&quot;  %2d  %2d %s: %s (%d)  %s  t:%d  i: %d\n&quot;, v+1, VoteV[v].UsrVote, VoteV[v].IsVote()?&quot;V&quot;:&quot; &quot;, UsrH.GetKey(VoteV[v].UsrId), VoteV[v].UsrId, VoteV[v].VoteTm.GetYmdTmStr().CStr(), VoteV[v].TxtLen, VoteV[v].UsrIndent);
1210      } else {
1211        printf(&quot;  %2d  %2d %s: %d  %s  t:%d  i: %d\n&quot;, v+1, VoteV[v].UsrVote, VoteV[v].IsVote()?&quot;V&quot;:&quot; &quot;, VoteV[v].UsrId, VoteV[v].VoteTm.GetYmdTmStr().CStr(), VoteV[v].TxtLen, VoteV[v].UsrIndent);
1212      }
1213    }
1214  }
1215  void TWikiElecBs::GetEIdByVotes(TIntV&amp; EIdV, const bool&amp; AscNumVotes) const {
1216    TIntPrV V(Len(), 0);
1217    for (int u = 0; u &lt; Len(); u++) {
1218      const TWikiElec&amp; E = GetElec(u);
1219      V.Add(TIntPr(E.Len(), E.UsrId));
1220    }
1221    V.Sort(AscNumVotes);
1222    EIdV.Clr(false);
1223    for (int u = 0; u &lt; V.Len(); u++) {
1224      EIdV.Add(V[u].Val2); }
1225  }
1226  void TWikiElecBs::GetEIdByVotes(TIntV&amp; EIdV, const int&amp; MinLen, const double&amp; FracPos, const double AboveFrac, const bool&amp; AscNumVotes) const {
1227    TFltIntPrV V(Len(), 0);
1228    for (int u = 0; u &lt; Len(); u++) {
1229      const TWikiElec&amp; E = GetElec(u);
1230      if (E.Len() &lt; MinLen) { continue; }
1231      if ((AboveFrac &amp;&amp; E.GetFracSup() &gt; FracPos) || (!AboveFrac &amp;&amp; E.GetFracSup() &lt; FracPos)) {
1232        V.Add(TFltIntPr(E.Len(), E.UsrId)); }
1233    }
1234    V.Sort(AscNumVotes);
1235    EIdV.Clr(false);
1236    for (int u = 0; u &lt; V.Len(); u++) {
1237      EIdV.Add(V[u].Val2); }
1238  }
1239  void TWikiElecBs::GetEIdByFrac(TIntV&amp; EIdV, const int&amp; MinLen, const double&amp; MnFracSup, const double&amp; MxFracSup) const {
1240    TFltIntPrV V(Len(), 0);
1241    for (int u = 0; u &lt; Len(); u++) {
1242      const TWikiElec&amp; E = GetElec(u);
1243      if (E.Len() &lt; MinLen) { continue; }
1244      const double FracSup = E.GetFracSup();
1245      if (FracSup==1) { continue; }
1246      if (FracSup &gt;= MnFracSup &amp;&amp; FracSup &lt;= MxFracSup) {
1247        V.Add(TFltIntPr(FracSup, E.UsrId)); }
1248    }
1249    V.Sort(true);
1250    EIdV.Clr(false);
1251    for (int u = 0; u &lt; V.Len(); u++) {
1252      EIdV.Add(V[u].Val2); }
1253  }
1254  void TWikiElecBs::GetUsrV(TIntV&amp; UIdV) const {
1255    TIntSet UIdSet;
1256    for (int e = 0; e &lt; Len(); e++) {
1257      const TWikiElec&amp; E = GetElec(e);
1258      UIdSet.AddKey(E.GetUId());
1259      for (int v = 0; v &lt; E.Len(); v++) {
1260        UIdSet.AddKey(E.GetVote(v).GetUId());
1261      }
1262    }
1263    UIdSet.GetKeyV(UIdV);
1264  }
1265  void TWikiElecBs::GetElecUsrV(TIntV&amp; ElecUsrV) const {
1266    ElecUsrV.Clr(false);
1267    for (int e = 0; e &lt; Len(); e++) {
1268      const TWikiElec&amp; E = GetElec(e);
1269      ElecUsrV.Add(E.UsrId);
1270    }
1271  }
1272  void TWikiElecBs::GetElecAdminUsrV(TIntV&amp; ElecAdminUsrV) const {
1273    ElecAdminUsrV.Clr(false);
1274    for (int e = 0; e &lt; Len(); e++) {
1275      const TWikiElec&amp; E = GetElec(e);
1276      if (E.IsSucc) {
1277        ElecAdminUsrV.Add(E.UsrId);
1278      }
1279    }
1280  }
1281  void TWikiElecBs::GetElecNonAdminUsrV(TIntV&amp; ElecNonAdminUsrV) const {
1282    ElecNonAdminUsrV.Clr(false);
1283    for (int e = 0; e &lt; Len(); e++) {
1284      const TWikiElec&amp; E = GetElec(e);
1285      if (! E.IsSucc) {
1286        ElecNonAdminUsrV.Add(E.UsrId);
1287      }
1288    }
1289  }
1290  void TWikiElecBs::GetFqVoters(TIntSet&amp; FqVoterSet, const int&amp; MinVotes, const int&amp; MinElecLen, const bool&amp; OnlyAdmins) const {
1291    TIntH UsrCntH, CntH;
1292    printf(&quot;%d\n&quot;, Len());
1293    TIntSet AdminSet;
1294    if (OnlyAdmins) {
1295      GetAdminSet(AdminSet);
1296    }
1297    for (int e = 0; e &lt; Len(); e++) {
1298      const TWikiElec&amp; E = GetElec(e);
1299      if (E.Len() &lt; MinElecLen) { continue; }
1300      for (int v = 0; v &lt; E.Len(); v++) {
1301        if (OnlyAdmins &amp;&amp; ! AdminSet.IsKey(E[v].GetUId())) {
1302          continue; } 
1303        UsrCntH.AddDat(E[v].GetUId()) += 1;
1304      }
1305    }
1306    for (int i = 0; i &lt; UsrCntH.Len(); i++) {
1307      CntH.AddDat(UsrCntH[i]) += 1; }
1308    FqVoterSet.Clr(false);
1309    UsrCntH.SortByDat(false);
1310    for (int i = 0; i &lt; UsrCntH.Len(); i++) {
1311      if (UsrCntH[i] &gt;= MinVotes) {
1312        FqVoterSet.AddKey(UsrCntH.GetKey(i));
1313      }
1314    }
1315  }
1316  void TWikiElecBs::GetUsrVotes(TIntPrV&amp; VoteUIdV) const {
1317    TIntH UsrCntH;
1318    for (int e = 0; e &lt; Len(); e++) {
1319      const TWikiElec&amp; E = GetElec(e);
1320      for (int v = 0; v &lt; E.Len(); v++) {
1321        UsrCntH.AddDat(E[v].GetUId()) += 1;
1322      }
1323    }
1324    VoteUIdV.Clr();
1325    for (int i = 0; i &lt; UsrCntH.Len(); i++) {
1326      VoteUIdV.Add(TIntPr(UsrCntH[i], UsrCntH.GetKey(i)));
1327    }
1328    VoteUIdV.Sort(false);
1329  }
1330  void TWikiElecBs::GetAdminSet(TIntSet&amp; AdminSet) const {
1331    AdminSet.Clr(false);
1332    for (int e = 0; e &lt; Len(); e++) {
1333      const TWikiElec&amp; E = GetElec(e);
1334      if (E.IsSucc) {
1335        AdminSet.AddKey(E.UsrId);
1336      }
1337    }
1338    printf(&quot;  %d admins from elecs. &quot;, AdminSet.Len());
1339    if (TFile::Exists(&quot;../../admin-list.txt&quot;)) {
1340      for (TSsParser Ss(&quot;../../admin-list.txt&quot;, ssfTabSep); Ss.Next(); ) {
1341        TStr U = Ss[0];
1342        if (IsUsr(U)) { AdminSet.AddKey(GetUId(U)); }
1343        if(IsUsr(U.GetLc())) { AdminSet.AddKey(GetUId(U.GetLc())); }
1344      }
1345    }
1346    printf(&quot;  %d admins after admin-list.txt\n&quot;, AdminSet.Len());
1347  }
1348  void TWikiElecBs::GetFqVoterSet(TIntSet&amp; FqVoterSet) const {
1349    TIntPrV VoteUIdV;
1350    GetUsrVotes(VoteUIdV);
1351    int HalfVotes = GetVotes()/2, SoFar=0;
1352    FqVoterSet.Clr(false);
1353    for (int i = 0; i &lt; VoteUIdV.Len() &amp;&amp; SoFar &lt; HalfVotes; i++) {
1354      FqVoterSet.AddKey(VoteUIdV[i].Val2);
1355      SoFar+=VoteUIdV[i].Val1;
1356    }
1357    printf(&quot;Users:%d (%d votes) FqVoters:%d (%d votes)\n&quot;, VoteUIdV.Len(), HalfVotes*2, FqVoterSet.Len(), SoFar);
1358  }
1359  void TWikiElecBs::GetAdminTmSet(THash&lt;TInt, TSecTm&gt;&amp; AdminSet) const {
1360    AdminSet.Clr(false);
1361    for (int e = 0; e &lt; Len(); e++) {
1362      const TWikiElec&amp; E = GetElec(e);
1363      if (E.IsSucc) {
1364        AdminSet.AddDat(E.UsrId, E.GetTm());
1365      }
1366    }
1367  }
1368  void TWikiElecBs::KeepFqVoters(const int&amp; MinVotes, const int&amp; MinElecLen, const bool&amp; OnlyAdmins) {
1369    TIntSet Voters;
1370    GetFqVoters(Voters, MinVotes, MinElecLen, OnlyAdmins);
1371    printf(&quot;freq  voters %d\n&quot;, Voters.Len());
1372    int VotesB=0, VotesA=0;
1373    for (int e = 0; e &lt; Len(); e++) {
1374      TWikiElec&amp; E = GetElec(e);
1375      VotesB += E.Len();
1376      if (E.Len() &lt; MinElecLen) { E.VoteV.Clr(); }
1377      E.KeepVotes(Voters);
1378      VotesA += E.Len();
1379    }
1380    printf(&quot;Votes: %d --&gt; %d\n&quot;, VotesB, VotesA);
1381  }
1382  void TWikiElecBs::KeepVoters(const bool&amp; KeepAdmins, const bool&amp; KeepNonAdmins) {
1383    TIntSet KeepVoters, Admins;
1384    GetAdminSet(Admins);
1385    if (KeepAdmins) {
1386      KeepVoters = Admins; }
1387    if (KeepNonAdmins) {
1388      TIntV UIdV; GetUsrV(UIdV);
1389      for (int i = 0; i &lt; UIdV.Len(); i++) {
1390        if (! Admins.IsKey(UIdV[i])) {
1391          KeepVoters.AddKey(UIdV[i]); } }
1392    }
1393    int VotesB=0, VotesA=0;
1394    printf(&quot;voters %d\n&quot;, KeepVoters.Len());
1395    for (int e = 0; e &lt; Len(); e++) {
1396      TWikiElec&amp; E = GetElec(e);
1397      VotesB += E.Len();
1398      E.KeepVotes(KeepVoters);
1399      VotesA += E.Len();
1400    }
1401    printf(&quot;  votes: %d --&gt; %d\n&quot;, VotesB, VotesA);
1402  }
1403  void TWikiElecBs::KeepTopVoters(const int&amp; Votes, const bool&amp; KeepTop) {
1404  }
1405  void TWikiElecBs::PermuteVotes() {
1406    printf(&quot;Permute election entries...&quot;);
1407    for (int u = 0; u &lt; Len(); u++) {
1408      GetElec(u).PermuteVotes();
1409    }
1410    printf(&quot;done.\n&quot;);
1411  }
1412  void TWikiElecBs::SortVotesByTm() {
1413    for (int e = 0; e &lt; Len(); e++) {
1414      GetElec(e).VoteV.Sort();
1415    }
1416  }
1417  int TWikiElecBs::GetVoteTrails(const int&amp; MinUsrVotes, const bool&amp; No01Prob, TIntV&amp; UIdV, TVec&lt;TFltPrV&gt;&amp; ProbSupTmV,
1418                                  TVec&lt;TFltPrV&gt;&amp; FracSupTmV, TVec&lt;TFltPrV&gt;&amp; ProbSupFracSupV, TVec&lt;TFltPrV&gt;&amp; VotesTmV) const {
1419    UIdV.Clr();  ProbSupTmV.Clr();  FracSupTmV.Clr();
1420    ProbSupFracSupV.Clr();  VotesTmV.Clr();
1421    THash&lt;TInt, TIntPrV&gt; UIdVotesH;
1422    TIntFltH FracSupH;
1423    for (int e = 0; e &lt; Len(); e++) {
1424      const TWikiElec&amp; E = GetElec(e);
1425      if (E.Len() &lt; 10) { continue; } 
1426      for (int v = 0; v &lt; E.Len(); v++) {
1427        UIdVotesH.AddDat(E[v].GetUId()).Add(TIntPr(e,v));
1428      }
1429      FracSupH.AddDat(e, E.GetFracSup());
1430    }
1431    int Votes = 0;
1432    UIdVotesH.SortByDat(false);
1433    TIntH AllCntH, AllCntHS, AllCntHF;
1434    for (int u = 0; u &lt; UIdVotesH.Len(); u++) {
1435      THash&lt;TInt, TMom&gt; TProbH, TFracH, UFPH;
1436      THash&lt;TFlt, TFlt&gt; TVotesH;
1437      TIntPrV&amp; EV = UIdVotesH[u];
1438      EV.Sort();
1439      const int UId = UIdVotesH.GetKey(u);
1440      if (EV.Len() &lt; MinUsrVotes) { continue; }
1441      EV.Del(EV.Len()/2, EV.Len()-1);
1442      for (int ev = 0; ev &lt; EV.Len(); ev++) { 
1443        const TWikiElec&amp; E = GetElec(EV[ev].Val1);
1444        const int v = EV[ev].Val2;
1445        if (v &lt; 10) { continue; } 
1446        const int Vote = E[v].GetVote()==1 ? 1:0;
1447        const double Frac = E.GetFracSup(0, v); 
1448        if (v &lt; 110) { 
1449          TProbH.AddDat(10*(v/10)).Add(Vote);
1450          TFracH.AddDat(10*(v/10)).Add(Frac);
1451          TVotesH.AddDat(10*(v/10)) += 1;
1452        }
1453        UFPH.AddDat(10*(int)TMath::Round(10*Frac)).Add(Vote);
1454        Votes++;
1455      }
1456      double M;
1457      TFltPrV TPV, TFV, TFPV, TVV;
1458      for (int i = 0; i &lt; TProbH.Len(); i++) {
1459        TProbH[i].Def();   M = TProbH[i].GetMean();
1460        if (No01Prob &amp;&amp; M!=0 &amp;&amp; M!=1) { TPV.Add(TFltPr(TProbH.GetKey(i).Val, M)); }
1461        else if (! No01Prob) { TPV.Add(TFltPr(TProbH.GetKey(i).Val, M)); }
1462      }
1463      for (int i = 0; i &lt; TFracH.Len(); i++) {
1464        TFracH[i].Def();   M = TFracH[i].GetMean();
1465        if (No01Prob &amp;&amp; M!=0 &amp;&amp; M!=1) { TFV.Add(TFltPr(TFracH.GetKey(i).Val, M)); }
1466        else if (! No01Prob) { TFV.Add(TFltPr(TFracH.GetKey(i).Val, M)); }
1467      }
1468      for (int i = 0; i &lt; UFPH.Len(); i++) {
1469        UFPH[i].Def();   M = UFPH[i].GetMean();
1470        if (No01Prob &amp;&amp; M!=0 &amp;&amp; M!=1) { TFPV.Add(TFltPr(UFPH.GetKey(i).Val, M)); }
1471        else if (! No01Prob) { TFPV.Add(TFltPr(UFPH.GetKey(i).Val, M)); }
1472      }
1473      TVotesH.GetKeyDatPrV(TVV);  TVV.Sort();
1474      TFPV.Sort(); TPV.Sort(); TFV.Sort();
1475      if (TFPV[0].Val1!=0.0) { TFPV.Ins(0, TFltPr(0,0)); printf(&quot;Z&quot;);} 
1476      if (TFPV.Last().Val1!=100.0) { TFPV.Add(TFltPr(100,1)); printf(&quot;O&quot;);} 
1477      UIdV.Add(UId);
1478      ProbSupTmV.Add(TPV);
1479      FracSupTmV.Add(TFV);
1480      ProbSupFracSupV.Add(TFPV);
1481      VotesTmV.Add(TVV);
1482    }
1483    IAssert(UIdV.Len() == ProbSupTmV.Len());
1484    return Votes;
1485  }
1486  void TWikiElecBs::GetVoteTrails2(const int&amp; MinUsrVotes, const bool&amp; No01Prob, TIntV&amp; UIdV, TVec&lt;TFltPrV&gt;&amp; VoteIdxFracSupV, TVec&lt;TFltPrV&gt;&amp; NVotesFracSupV) const {
1487    UIdV.Clr();  VoteIdxFracSupV.Clr();  NVotesFracSupV.Clr();
1488    THash&lt;TInt, TIntPrV&gt; UIdVotesH;
1489    TIntFltH FracSupH;
1490    for (int e = 0; e &lt; Len(); e++) {
1491      const TWikiElec&amp; E = GetElec(e);
1492      if (E.Len() &lt; 10) { continue; } 
1493      for (int v = 0; v &lt; E.Len(); v++) {
1494        UIdVotesH.AddDat(E[v].GetUId()).Add(TIntPr(e,v));
1495      }
1496      FracSupH.AddDat(e, E.GetFracSup());
1497    }
1498    UIdVotesH.SortByDat(false);
1499    TIntH AllCntH, AllCntHS, AllCntHF;
1500    for (int u = 0; u &lt; UIdVotesH.Len(); u++) {
1501      THash&lt;TInt, TMom&gt; FSVIdxH;
1502      TFltFltH FSVotesH;
1503      const TIntPrV&amp; EV = UIdVotesH[u];
1504      const int UId = UIdVotesH.GetKey(u);
1505      if (EV.Len() &lt; MinUsrVotes) { continue; }
1506      for (int ev = 0; ev &lt; EV.Len(); ev++) { 
1507        const TWikiElec&amp; E = GetElec(EV[ev].Val1);
1508        const int v = EV[ev].Val2;
1509        const int Vote = E[v].GetVote()==1 ? 1:0;
1510        const double Frac = E.GetFracSup(0, v); 
1511        FSVotesH.AddDat(10*int(10*Frac)) += 1;
1512        FSVIdxH.AddDat(10*int(10*Frac)).Add(v);
1513      }
1514      UIdV.Add(UId);
1515      double M = 0;
1516      VoteIdxFracSupV.Add();
1517      TFltPrV&amp; VoteIdxV = VoteIdxFracSupV.Last();
1518      for (int i = 0; i &lt; FSVIdxH.Len(); i++) {
1519        FSVIdxH[i].Def();   M = FSVIdxH[i].GetMean();
1520        if (No01Prob &amp;&amp; M!=0 &amp;&amp; M!=1) { VoteIdxV.Add(TFltPr(FSVIdxH.GetKey(i).Val, M)); }
1521        else if (! No01Prob) { VoteIdxV.Add(TFltPr(FSVIdxH.GetKey(i).Val, M)); }
1522      }
1523      VoteIdxV.Sort();
1524      NVotesFracSupV.Add();
1525      FSVotesH.GetKeyDatPrV(NVotesFracSupV.Last());
1526      NVotesFracSupV.Last().Sort();
1527    }
1528  }
1529  void TWikiElecBs::GetUsrVoteTrail(const TIntV&amp; UIdV, TVec&lt;TFltPrV&gt;&amp; ProbPosFracPosV) const {
1530    ProbPosFracPosV.Clr();
1531    THash&lt;TInt, TIntPrV&gt; UIdVotesH;
1532    for (int e = 0; e &lt; Len(); e++) {
1533      const TWikiElec&amp; E = GetElec(e);
1534      if (E.Len() &lt; 10) { continue; } 
1535      for (int v = 0; v &lt; E.Len(); v++) {
1536        UIdVotesH.AddDat(E[v].GetUId()).Add(TIntPr(e,v));
1537      }
1538    }
1539    for (int u = 0; u &lt; UIdV.Len(); u++) {
1540      ProbPosFracPosV.Add();
1541      if (! UIdVotesH.IsKey(UIdV[u])) { continue; }
1542      const TIntPrV&amp; EV = UIdVotesH.GetDat(UIdV[u]);
1543      THash&lt;TInt, TMom&gt; FracProbH;
1544      for (int ev = 0; ev &lt; EV.Len(); ev++) { 
1545        const TWikiElec&amp; E = GetElec(EV[ev].Val1);
1546        const int v = EV[ev].Val2;
1547        const int Vote = E[v].GetVote()==1 ? 1:0;
1548        const double Frac = E.GetFracSup(0, v); 
1549        FracProbH.AddDat(10*int(10*Frac)).Add(Vote);
1550      }
1551      FracProbH.SortByKey();
1552      TFltPrV&amp; ProbFracV = ProbPosFracPosV.Last();
1553      for (int i = 0; i &lt; FracProbH.Len(); i++) {
1554        FracProbH[i].Def();
1555        const double M = FracProbH[i].GetMean();
1556        ProbFracV.Add(TFltPr(FracProbH.GetKey(i).Val, M));
1557      }
1558      ProbFracV.Sort();
1559    }
1560  }
1561  void TWikiElecBs::GetUsrAreaUTrail(const TIntV&amp; UIdV, TFltV&amp; AreaV) const {
1562    TVec&lt;TFltPrV&gt; ProbPosFracPosV;
1563    GetUsrVoteTrail(UIdV, ProbPosFracPosV);
1564    AreaV.Clr();
1565    for (int u = 0; u &lt; ProbPosFracPosV.Len(); u++) {
1566      double Area = 0;
1567      TFltPrV&amp; V = ProbPosFracPosV[u];
1568      for (int f = 0; f &lt; V.Len(); f++) {
1569        IAssert(V[f].Val1&gt;= 0 &amp;&amp; V[f].Val1&lt;=100);
1570        Area += (V[f].Val2 - V[f].Val1/100.0);
1571      }
1572      AreaV.Add(Area);
1573    }
1574  }
1575  void TWikiElecBs::PlotElecLenDistr(const TStr&amp; OutFNm) const {
1576    TIntH SupCntHS, OppCntHS, VotesCntHS, 
1577          SupCntHF, OppCntHF, VotesCntHF, 
1578          SupCntHA, OppCntHA, VotesCntHA; 
1579    TIntH VotesPerUser;
1580    THashSet&lt;TFltPr&gt; SupOppHS, SupOppHF;
1581    THash&lt;TInt, TMom&gt; ElLenVsSucc;
1582    TIntH SupFracA, SupFracS, SupFracF;
1583    for (int e = 0; e &lt; Len(); e++) {
1584      const TWikiElec&amp; E = GetElec(e);
1585      const int SupFrac = (int)TMath::Round(E.GetFracSup()*10)*10;
1586      TIntTr V = E.GetVotes();
1587      int len = (E.Len()/5)*5;
1588      V.Val1 = (V.Val1/5)*5;
1589      V.Val2 = (V.Val2/5)*5;
1590      V.Val3 = (V.Val3/5)*5;
1591      SupFracA.AddDat(SupFrac) +=1;
1592      if (E.IsSucc) {
1593        SupFracS.AddDat(SupFrac) += 1;
1594        VotesCntHS.AddDat(len) += 1;
1595        SupCntHS.AddDat(V.Val1) += 1;
1596        OppCntHS.AddDat(V.Val3) += 1;
1597        SupOppHS.AddKey(TFltPr(V.Val1+0.1+TInt::Rnd.GetNrmDev(), V.Val3+0.1+TInt::Rnd.GetNrmDev()));
1598        ElLenVsSucc.AddDat(len).Add(1);
1599      } else {
1600        SupFracF.AddDat(SupFrac) += 1;
1601        VotesCntHF.AddDat(len) += 1;
1602        SupCntHF.AddDat(V.Val1) += 1;
1603        OppCntHF.AddDat(V.Val3) += 1;
1604        SupOppHF.AddKey(TFltPr(V.Val1+0.1+TInt::Rnd.GetNrmDev(), V.Val3+0.1+TInt::Rnd.GetNrmDev()));
1605        ElLenVsSucc.AddDat(len).Add(0);
1606      }
1607      VotesCntHA.AddDat(len) += 1;
1608      SupCntHA.AddDat(V.Val1) += 1;
1609      OppCntHA.AddDat(V.Val3) += 1;
1610    }
1611    TIntPrV VotesUIdV; GetUsrVotes(VotesUIdV);
1612    for (int i = 0; i &lt; VotesUIdV.Len(); i++) {
1613      VotesPerUser.AddDat(10*(VotesUIdV[i].Val1/10))+=1;
1614    }
1615    TGnuPlot::PlotValCntH(VotesPerUser, &quot;userVotes-&quot;+OutFNm, &quot;&quot;, &quot;Number of votes&quot;, &quot;Number of such users&quot;);
1616    TGnuPlot::PlotValMomH(ElLenVsSucc, &quot;elLenSucc-&quot;+OutFNm, &quot;&quot;, &quot;Election length&quot;, &quot;Probability of success&quot;);
1617    { TGnuPlot GP(&quot;suppOppScatter-&quot;+OutFNm); GP.SetXYLabel(&quot;Support votes&quot;, &quot;Oppose votes&quot;);
1618    TFltPrV SuccV, FailV;  SupOppHS.GetKeyV(SuccV);  SupOppHF.GetKeyV(FailV);
1619    GP.AddPlot(FailV, gpwPoints, &quot;FAIL&quot;);  GP.AddPlot(SuccV, gpwPoints, &quot;SUCC&quot;);
1620    GP.SavePng(); }
1621    { TGnuPlot GP(&quot;countSup-&quot;+OutFNm); GP.SetXYLabel(&quot;Support votes&quot;, &quot;Count&quot;);
1622    GP.AddPlot(SupCntHA, gpwLinesPoints, &quot;ALL elections&quot;);
1623    GP.AddPlot(SupCntHS, gpwLinesPoints, &quot;SUCC elections&quot;);
1624    GP.AddPlot(SupCntHF, gpwLinesPoints, &quot;FAIL elections&quot;);
1625    GP.SavePng(); }
1626    { TGnuPlot GP(&quot;countOpp-&quot;+OutFNm); GP.SetXYLabel(&quot;Oppose votes&quot;, &quot;Count&quot;);
1627    GP.AddPlot(OppCntHA, gpwLinesPoints, &quot;ALL elections&quot;);
1628    GP.AddPlot(OppCntHS, gpwLinesPoints, &quot;SUCC elections&quot;);
1629    GP.AddPlot(OppCntHF, gpwLinesPoints, &quot;FAIL elections&quot;);
1630    GP.SavePng(); }
1631    { TGnuPlot GP(&quot;countVot-&quot;+OutFNm); GP.SetXYLabel(&quot;Votes&quot;, &quot;Count&quot;);
1632    GP.AddPlot(VotesCntHA, gpwLinesPoints, &quot;ALL elections&quot;);
1633    GP.AddPlot(VotesCntHS, gpwLinesPoints, &quot;SUCC elections&quot;);
1634    GP.AddPlot(VotesCntHF, gpwLinesPoints, &quot;FAIL elections&quot;);
1635    GP.SavePng(); }
1636    { TGnuPlot GP(&quot;supFrac-&quot;+OutFNm); GP.SetXYLabel(&quot;Final Fraction of support votes&quot;, &quot;Number of such elections&quot;);
1637    GP.AddPlot(SupFracA, gpwLinesPoints, &quot;ALL elections&quot;);
1638    GP.AddPlot(SupFracS, gpwLinesPoints, &quot;SUCC elections&quot;);
1639    GP.AddPlot(SupFracF, gpwLinesPoints, &quot;FAIL elections&quot;);
1640    GP.SavePng(); }
1641  }
1642  void TWikiElecBs::PlotElecSupOppOt(const TStr&amp; OutFNm, const int&amp; MinVotes, const int&amp; MaxVotes) const {
1643    int ElecCnt=0;
1644    TGnuPlot GP(&quot;supOppOT-&quot;+OutFNm);
1645    for (int e = 0; e &lt; Len(); e++) {
1646      const TWikiElec&amp; E = GetElec(e);
1647      if (E.Len() &lt; MinVotes || E.Len() &gt; MaxVotes) { continue; }
1648      TFltPrV OppSupV; OppSupV.Add(TFltPr(0,0));
1649      for (int v = 0; v &lt; E.Len(); v++) {
1650        const int S = E[v].GetVote();
1651        OppSupV.Add(TFltPr(OppSupV.Last().Val1+(S&lt;0?1:0)+0.1*TInt::Rnd.GetNrmDev(),
1652                           OppSupV.Last().Val2+(S&gt;0?1:0)+0.1*TInt::Rnd.GetNrmDev()));
1653      }
1654      GP.AddPlot(OppSupV, gpwLines, &quot;&quot;, TStr::Fmt(&quot;lt %d&quot;, E.IsSucc?2:1));
1655      ElecCnt++;
1656    }
1657    GP.SetXYLabel(&quot;oppose votes&quot;, &quot;support votes&quot;);
1658    GP.SetTitle(TStr::Fmt(&quot;elections with %d -- %d votes: %d elections&quot;, MinVotes, MaxVotes, ElecCnt));
1659    GP.SavePng();
1660  }
1661  void TWikiElecBs::PlotRunLenStat(const TStr&amp; OutFNm, const int&amp; MinVotes, const int&amp; MaxVotes) const {
1662    THash&lt;TInt, TTriple&lt;TMom, TMom, TMom&gt; &gt; UsrMomH;
1663    THash&lt;TInt, TMom&gt; TxtLenH;
1664    TPair&lt;TMom, TMom&gt; RunLStat;
1665    THash&lt;TInt, TInt&gt; SupH, OppH;
1666    int Cnt=0;
1667    for (int e = 0; e &lt; Len(); e++) {
1668      const TWikiElec&amp; E = GetElec(e);
1669      if (E.Len() &lt; MinVotes || E.Len() &gt; MaxVotes) { continue; }
1670      for (int v = 0; v &lt; E.Len(); v++) {
1671        const int V = E.GetVote(v).GetVote();
1672        const int RunL = E.GetRunLen(v);
1673        if (V == 1) {
1674          UsrMomH.AddDat(E.GetVote(v).GetUId()).Val1.Add(RunL);
1675          RunLStat.Val1.Add(RunL);
1676          SupH.AddDat(RunL)++;
1677        } else {
1678          UsrMomH.AddDat(E.GetVote(v).GetUId()).Val2.Add(RunL);
1679          RunLStat.Val2.Add(RunL);
1680          OppH.AddDat(RunL)++;
1681        }
1682        UsrMomH.AddDat(E.GetVote(v).GetUId()).Val3.Add(E[v].GetTxtLen());
1683        TxtLenH.AddDat(10*(E[v].GetTxtLen()/10)).Add(RunL);
1684      }
1685      Cnt++;
1686    }
1687    TGnuPlot::PlotValMomH(TxtLenH, &quot;runLenTxtLen-&quot;+OutFNm, &quot;&quot;, &quot;Length of the text supporting the vote&quot;, &quot;Run length&quot;,
1688      gpsAuto, gpwLinesPoints, true, true, false, false, false);
1689    RunLStat.Val1.Def();
1690    RunLStat.Val2.Def();
1691    printf(&quot;SUP run len: A:%g  M:%g\n&quot;, RunLStat.Val1.GetMean(), RunLStat.Val1.GetMedian());
1692    printf(&quot;OPP run len: A:%g  M:%g\n&quot;, RunLStat.Val2.GetMean(), RunLStat.Val2.GetMedian());
1693    TGnuPlot GP(&quot;runLen-&quot;+OutFNm, TStr::Fmt(&quot;Elecs %d--%d: %d. SUP run len: A:%g  M:%g  OPP: A:%g  M:%g&quot;, MinVotes, MaxVotes, Cnt,
1694      RunLStat.Val1.GetMean(), RunLStat.Val1.GetMedian(), RunLStat.Val2.GetMean(), RunLStat.Val2.GetMedian()));
1695    GP.AddPlot(OppH, gpwLinesPoints, &quot;OPP&quot;);
1696    GP.AddPlot(SupH, gpwLinesPoints, &quot;SUP&quot;);
1697    GP.SetXYLabel(&quot;run length&quot;, &quot;count&quot;);
1698    GP.SavePng();
1699    FILE *F = fopen(TStr::Fmt(&quot;runLenUsers-%s.tab&quot;, OutFNm.CStr()).CStr(), &quot;wt&quot;);
1700    fprintf(F, &quot;#UsrId\tUser\tVotes\tSup-Votes\tOpp-Votes\tSup-Avg\tSup-Med\tOpp-Avg\tOpp-Med\tTxtLen-Avg\tTxtLen-Med\n&quot;);
1701    for (int u = 0; u &lt; UsrMomH.Len(); u++) {
1702      TMom&amp; MS = UsrMomH[u].Val1;  MS.Def();
1703      TMom&amp; MO = UsrMomH[u].Val2;  MO.Def();
1704      TMom&amp; TL = UsrMomH[u].Val3;  TL.Def();
1705      fprintf(F, &quot;%d\t%s\t%d\t%d\t%d\t%g\t%g\t%g\t%g\t%g\t%g\n&quot;, UsrMomH.GetKey(u), GetUsr(UsrMomH.GetKey(u)),
1706        MS.GetVals()+MO.GetVals(), MS.GetVals(), MO.GetVals(), MS.GetMean(), MS.GetMedian(), MO.GetMean(), MO.GetMedian(),
1707        TL.GetMean(), TL.GetMedian());
1708    }
1709    fclose(F);
1710  }
1711  void TWikiElecBs::DrawElecTree(const TStr&amp; OutFNm, const int&amp; MinVotes) const {
1712    TIntV UIdV;  GetEIdByVotes(UIdV);
1713    TWikiVoteV VoteV;
1714    THash&lt;TInt, TIntQu&gt; TreeH;  
1715    const int TakeVotes = 3;
1716    for (int e = 0; e &lt; Len(); e++) {
1717      const TWikiElec&amp; E = GetElec(e);
1718      if (E.Len() &lt; MinVotes) { continue; }
1719      TInt BegVote=1;
1720      const TIntTr SNO = E.GetVotes();
1721      { TIntQu&amp; V = TreeH.AddDat(BegVote);
1722      V.Val1 += SNO.Val1; V.Val2 += SNO.Val3;  V.Val3 += 1;
1723      V.Val4 += E.IsSucc() ? 1:0; }
1724      for (int v = 0; v &lt; TakeVotes; v++) {
1725        if (E[v].GetVote() == 1) { BegVote = 2*BegVote+1; } 
1726        else { BegVote = 2*BegVote; } 
1727        TIntQu&amp; V = TreeH.AddDat(BegVote);
1728        V.Val1 += SNO.Val1;
1729        V.Val2 += SNO.Val3;
1730        V.Val3 += 1;
1731        V.Val4 += E.IsSucc() ? 1:0;
1732      }
1733    }
1734    PNGraph G = TNGraph::New();
1735    TIntStrH LabelH;
1736    TreeH.SortByKey();
1737    for (int i = 0; i &lt; TreeH.Len(); i++) {
1738      printf(&quot;%d\n&quot;, TreeH.GetKey(i));
1739      const int id = TreeH.GetKey(i);
1740      const int nid = G-&gt;AddNode(i+1);
1741      LabelH.AddDat(nid, TStr::Fmt(&quot;%sElections: %d\\nSuccessful: %.3f&quot;, id==1?&quot;&quot;:(id%2==1 ?&quot;SUPPORT\\n&quot;:&quot;OPPOSE\\n&quot;), TreeH[i].Val3, TreeH[i].Val4/double(TreeH[i].Val3)));
1742      if (id &gt; 1) {
1743        G-&gt;AddEdge(id/2, nid);
1744        printf(&quot;link  %d &lt;-- %d\n&quot;, id/2, nid);
1745      }
1746    }
1747    TGraphViz::Plot(G, gvlDot, &quot;elecTree-&quot;+OutFNm+&quot;.gif&quot;, &quot;&quot;, LabelH);
1748  }
1749  void TWikiElecBs::PlotVotesOt(const TStr&amp; OutFNm, const int&amp; MinVotes, const int&amp; MaxVotes) const {
1750    THash&lt;TInt, TMom&gt; FSupOtA, PSupOtA, DevOtA,
1751      FSupOtS, PSupOtS, DevOtS, FSupOtF, PSupOtF, DevOtF;
1752    int Cnt=0;
1753    for (int e = 0; e &lt; Len(); e++) {
1754      const TWikiElec&amp; E = GetElec(e);
1755      if (E.Len() &lt; MinVotes || E.Len() &gt; MaxVotes) { continue; }
1756      int S = 0;
1757      double Dev = 0;
1758      for (int v = 0; v &lt; E.Len(); v++) {
1759        const int V = E.GetVote(v).GetVote()==1? 1:0;
1760        if (v &gt; 0) {
1761          Dev = fabs(V - S/double(v))/double(v+1); }
1762        S += V; 
1763        if (E.IsSucc) {
1764          FSupOtS.AddDat(v+1).Add(S/double(v+1));
1765          PSupOtS.AddDat(v+1).Add(V);
1766          DevOtS.AddDat(v+1).Add(Dev);
1767        } else {
1768          FSupOtF.AddDat(v+1).Add(S/double(v+1));
1769          PSupOtF.AddDat(v+1).Add(V);
1770          DevOtF.AddDat(v+1).Add(Dev);
1771        }
1772        FSupOtA.AddDat(v+1).Add(S/double(v+1));
1773        PSupOtA.AddDat(v+1).Add(V);
1774        DevOtA.AddDat(v+1).Add(Dev);
1775      }
1776      Cnt++;
1777    }
1778    { TGnuPlot GP(&quot;votesOT-Frac-&quot;+OutFNm, TStr::Fmt(&quot;Elections %d--%d: %d&quot;, MinVotes, MaxVotes, Cnt));
1779    GP.SetXYLabel(&quot;Time (vote index)&quot;, &quot;Fraction of support votes so far&quot;);
1780    GP.AddPlot(FSupOtA, gpwLinesPoints, &quot;ALL elections&quot;, &quot;&quot;, true, false);
1781    GP.AddPlot(FSupOtS, gpwLinesPoints, &quot;SUCC elections&quot;, &quot;&quot;, true, false);
1782    GP.AddPlot(FSupOtF, gpwLinesPoints, &quot;FAIL elections&quot;, &quot;&quot;, true, false);
1783    if (MinVotes&gt;10) { GP.SetXRange(0, MinVotes); }  GP.SavePng(); }
1784    { TGnuPlot GP(&quot;votesOT-Sup-&quot;+OutFNm, TStr::Fmt(&quot;Elections %d--%d: %d&quot;, MinVotes, MaxVotes, Cnt));
1785    GP.SetXYLabel(&quot;Time (vote index)&quot;, &quot;Probability i-th vote is Support&quot;);
1786    GP.AddPlot(PSupOtA, gpwLinesPoints, &quot;ALL elections&quot;, &quot;&quot;, true, false);
1787    GP.AddPlot(PSupOtS, gpwLinesPoints, &quot;SUCC elections&quot;, &quot;&quot;, true, false);
1788    GP.AddPlot(PSupOtF, gpwLinesPoints, &quot;FAIL elections&quot;, &quot;&quot;, true, false);
1789    if (MinVotes&gt;10) { GP.SetXRange(0, MinVotes); }  GP.SavePng(); }
1790    { TGnuPlot GP(&quot;votesOT-Dev-&quot;+OutFNm, TStr::Fmt(&quot;Elections %d--%d: %d&quot;, MinVotes, MaxVotes, Cnt));
1791    GP.SetXYLabel(&quot;Time (vote index)&quot;, &quot;Vote deviation: avg |avg(V,t+1) - avg(V,t)|&quot;);
1792    GP.AddPlot(DevOtA, gpwLinesPoints, &quot;ALL elections&quot;, &quot;&quot;, true, false);
1793    GP.AddPlot(DevOtS, gpwLinesPoints, &quot;SUCC elections&quot;, &quot;&quot;, true, false);
1794    GP.AddPlot(DevOtF, gpwLinesPoints, &quot;FAIL elections&quot;, &quot;&quot;, true, false);
1795    if (MinVotes&gt;10) { GP.SetXRange(0, MinVotes); }  GP.SavePng(); }
1796  }
1797  void TWikiElecBs::PlotCovotingUsers(const TStr&amp; OutFNm, const TStr&amp; MinSupStr, const int&amp; TakeOnlyVotes) const {
1798    PNGraph G = TNGraph::New();
1799    TStrSet RfaSet;
1800    for (int e = 0; e &lt; Len(); e++) {
1801      const TWikiElec&amp; E = GetElec(e);
1802      const int RfaId = Kilo(100)+RfaSet.AddKey(E.RfaTitle);
1803      if (G-&gt;IsNode(RfaId)) { printf(&quot;%s\n&quot;, E.RfaTitle.CStr()); continue; }
1804      IAssertR(! G-&gt;IsNode(RfaId), E.RfaTitle);
1805      G-&gt;AddNode(RfaId);
1806      for (int v = 0; v &lt; E.Len(); v++) {
1807        if (TakeOnlyVotes==1 &amp;&amp; E[v].GetVote() != 1) { continue; } 
1808        else if (TakeOnlyVotes==-1 &amp;&amp; E[v].GetVote() != -1) { continue; } 
1809        const int usr = E[v].GetUId();
1810        if (! G-&gt;IsNode(usr)) { G-&gt;AddNode(usr); }
1811        IAssert(! G-&gt;IsEdge(usr, RfaId));
1812        G-&gt;AddEdge(usr, RfaId);
1813      }
1814    }
1815    TSnap::PrintInfo(G);
1816    printf(&quot;\n*** ALL VOTES\n&quot;);
1817    TStrV MinSupV;
1818    TStr(MinSupStr).SplitOnAllCh(&#x27;,&#x27;, MinSupV);
1819    TGnuPlot GP(TStr::Fmt(&quot;itemSet-%s&quot;, OutFNm.CStr()), &quot;Number and size of frequent itemsets&quot;);
1820    for (int i = 0; i &lt; MinSupV.Len(); i++) {
1821      printf(&quot;\n*** MinSup = %s\n&quot;, MinSupV[i].CStr());
1822      TTrawling Trawl(G, MinSupV[i].GetInt());
1823      const TIntPrV SzCntV = Trawl.PlotMinFqVsMaxSet(TStr::Fmt(&quot;%s-%02d&quot;, OutFNm.CStr(), MinSupV[i].GetInt()));
1824      GP.AddPlot(SzCntV, gpwLinesPoints, TStr::Fmt(&quot;MinSup = %d&quot;, MinSupV[i].GetInt()));
1825    }
1826    GP.SetXYLabel(&quot;Itemset size&quot;, &quot;Number of itemsets&quot;);
1827    GP.SavePng();
1828  }
1829  void TWikiElecBs::PlotFracBeforeAfterVote(const TStr&amp; OutFNm) const {
1830    THash&lt;TInt, TIntPrV&gt; UIdVotesH;
1831    for (int e = 0; e &lt; Len(); e++) {
1832      const TWikiElec&amp; E = GetElec(e);
1833      if (E.Len() &lt; 10) { continue; } 
1834      for (int v = 0; v &lt; E.Len(); v++) {
1835        UIdVotesH.AddDat(E[v].GetUId()).Add(TIntPr(e,v));
1836      }
1837    }
1838    THash&lt;TFlt, TInt&gt; DeltaCntHA, DeltaCntHS, DeltaCntHO, DeltaCntHA2, DeltaCntHS2, DeltaCntHO2;
1839    FILE *F = fopen(TStr::Fmt(&quot;deltabBAUsr-%s.tab&quot;, OutFNm.CStr()).CStr(), &quot;wt&quot;);
1840    fprintf(F, &quot;#Usr\tVotes\tAvgDSup\tMedDSup\tSupVotes\tAvgDOpp\tMedDOpp\tOppVotes\tAvgTrendSup\tMedTrendSup\tAvgTrendOpp\tMedTrendOpp\n&quot;);
1841    for (int u = 0; u &lt; UIdVotesH.Len(); u++) {
1842      const TIntPrV&amp; EV = UIdVotesH[u];
1843      if (EV.Len() &lt; 10) { continue; } 
1844      TMom MomS, MomO, MomS2, MomO2;
1845      for (int ev = 0; ev &lt; EV.Len(); ev++) {
1846        const TWikiElec&amp; E = GetElec(EV[ev].Val1);
1847        const int v = EV[ev].Val2;
1848        if (v &lt; 5 || v+5 &gt;= E.Len()) { continue; }
1849        const double Bef = E.GetFracSup(0, v); 
1850        const double Aft = E.GetFracSup(v+1, E.Len()); 
1851        const double Bef2 = E.GetTrend(0, v);
1852        const double Aft2 = E.GetTrend(v+1, E.Len()); 
1853        DeltaCntHA.AddDat(TMath::Round(Aft-Bef, 2)) += 1;
1854        DeltaCntHA2.AddDat(TMath::Round(Aft2-Bef2, 2)) += 1;
1855        if (E[v].GetVote() == 1) {
1856          DeltaCntHS.AddDat(TMath::Round(Aft-Bef, 2)) += 1;
1857          DeltaCntHS2.AddDat(TMath::Round(Aft2-Bef2, 2)) += 1;
1858          MomS.Add(Aft-Bef);
1859          MomS2.Add(Aft2-Bef2);
1860        } else {
1861          DeltaCntHO.AddDat(TMath::Round(Aft-Bef, 2)) += 1;
1862          DeltaCntHO2.AddDat(TMath::Round(Aft2-Bef2, 2)) += 1;
1863          MomO.Add(Aft-Bef);
1864          MomO2.Add(Aft2-Bef2);
1865        }
1866      }
1867      MomS.Def(); MomO.Def();  MomS2.Def(); MomO2.Def();
1868      if (! MomS.IsUsable() || ! MomO.IsUsable()) { continue; }
1869      fprintf(F, &quot;%s\t%d\t%f\t%f\t%d\t%f\t%f\t%d\n&quot;, GetUsr(UIdVotesH.GetKey(u)), EV.Len(),
1870        MomS.GetMean(), MomS.GetMedian(), MomS.GetVals(), MomO.GetMean(), MomO.GetMedian(), MomO.GetVals(),
1871        MomS2.GetMean(), MomS2.GetMedian(), MomO2.GetMean(), MomO2.GetMedian());
1872    }
1873    fclose(F);
1874    TGnuPlot::PlotValCntH(DeltaCntHA, &quot;deltaBA-&quot;+OutFNm, &quot;Fraction of support votes After-Before user casted a vote. (min 10 votes per user, min 10 vote elections, min 5 votes before/after&quot;,
1875      &quot;After - Before fraction of support votes. Any vote.&quot;, &quot;Count&quot;);
1876    TGnuPlot::PlotValCntH(DeltaCntHS, &quot;deltaBASup-&quot;+OutFNm, &quot;Fraction of support votes After-Before user casted a vote. (min 10 votes per user, min 10 vote elections, min 5 votes before/after&quot;,
1877      &quot;After - Before fraction of support votes. User voted +1.&quot;, &quot;Count&quot;);
1878    TGnuPlot::PlotValCntH(DeltaCntHO, &quot;deltaBAOpp-&quot;+OutFNm, &quot;Fraction of support votes After-Before user casted a vote. (min 10 votes per user, min 10 vote elections, min 5 votes before/after&quot;,
1879      &quot;After - Before fraction of support votes. User voted -1.&quot;, &quot;Count&quot;);
1880    TGnuPlot::PlotValCntH(DeltaCntHA2, &quot;deltaTrBA-&quot;+OutFNm, &quot;Trend of fraction ofsupport votes After-Before user casted a vote. (min 10 votes per user, min 10 vote elections, min 5 votes before/after&quot;,
1881      &quot;After - Before trend (linear fit coefficient) fraction of support votes. Any vote.&quot;, &quot;Count&quot;);
1882    TGnuPlot::PlotValCntH(DeltaCntHS2, &quot;deltaTrBASup-&quot;+OutFNm, &quot;Trend of fraction ofsupport votes After-Before user casted a vote. (min 10 votes per user, min 10 vote elections, min 5 votes before/after&quot;,
1883      &quot;After - Before trend (linear fit coefficient) fraction of support votes. User voted +1.&quot;, &quot;Count&quot;);
1884    TGnuPlot::PlotValCntH(DeltaCntHO2, &quot;deltaTrBAOpp-&quot;+OutFNm, &quot;Trend of fraction of support votes After-Before user casted a vote. (min 10 votes per user, min 10 vote elections, min 5 votes before/after&quot;,
1885      &quot;After - Before trend (linear fit coefficient) fraction of support votes. User voted -1.&quot;, &quot;Count&quot;);
1886  }
1887  void TWikiElecBs::PlotDeltaFracSupOt(const TStr&amp; OutFNm, const int&amp; MinVotes, const int&amp; MaxVotes) const {
1888    THash&lt;TInt, TMom&gt; DeltaOtA, DeltaOtS, DeltaOtF;
1889    int Cnt = 0, CntS=0, CntF=0;
1890    for (int e = 0; e &lt; Len(); e++) {
1891      const TWikiElec&amp; E = GetElec(e);
1892      if (E.Len() &lt; MinVotes || E.Len() &gt; MaxVotes) { continue; }
1893      TIntTr SNO = E.GetVotes();
1894      const double FinalF = SNO.Val1/double(SNO.Val1+SNO.Val3);
1895      int S = 0;
1896      for (int v = 0; v &lt; E.Len(); v++) {
1897        const int V = E.GetVote(v).GetVote()==1? 1:0;
1898        S += V; 
1899        if (E.IsSucc) { DeltaOtS.AddDat(v).Add(S/double(v+1)-FinalF); }
1900        else { DeltaOtF.AddDat(v).Add(S/double(v+1)-FinalF); }
1901        DeltaOtA.AddDat(v).Add(S/double(v+1)-FinalF);
1902      }
1903      if (E.IsSucc) { CntS++; }
1904      else { CntF++; }
1905      Cnt++;
1906    }
1907    TGnuPlot::PlotValMomH(DeltaOtA, &quot;deltaFracSup-A-&quot;+OutFNm, TStr::Fmt(&quot;ALL Elections %d--%d: %d&quot;, MinVotes, MaxVotes, Cnt),
1908      &quot;Vote index&quot;, &quot;Deviation from the final fraction of support votes&quot;);
1909    TGnuPlot::PlotValMomH(DeltaOtS, &quot;deltaFracSup-S-&quot;+OutFNm, TStr::Fmt(&quot;SUCC Elections %d--%d: %d&quot;, MinVotes, MaxVotes, CntS),
1910      &quot;Vote index&quot;, &quot;Deviation from the final fraction of support votes&quot;);
1911    TGnuPlot::PlotValMomH(DeltaOtF, &quot;deltaFracSup-F-&quot;+OutFNm, TStr::Fmt(&quot;FAIL Elections %d--%d: %d&quot;, MinVotes, MaxVotes, CntF),
1912      &quot;Vote index&quot;, &quot;Deviation from the final fraction of support votes&quot;);
1913  }
1914  void TWikiElecBs::PlotUsrVoteVsTime(const TStr&amp; OutFNm, const int&amp; MinUsrVotes, const TIntSet&amp; UsrSplitSet) const {
1915    THash&lt;TInt, TIntPrV&gt; UIdVotesH;
1916    TIntFltH FracSupH;
1917    for (int e = 0; e &lt; Len(); e++) {
1918      const TWikiElec&amp; E = GetElec(e);
1919      for (int v = 0; v &lt; E.Len(); v++) {
1920        UIdVotesH.AddDat(E[v].GetUId()).Add(TIntPr(e,v));
1921      }
1922      FracSupH.AddDat(e, E.GetFracSup());
1923    }
1924    UIdVotesH.SortByDat(false);
1925    THash&lt;TInt, TMom&gt; AllMomH, AllMomHS, AllMomHF, AdmMomH, NAdmMomH;
1926    TIntH AllCntH, AllCntHS, AllCntHF, AdmCntH, NAdmCntH;
1927    int Cnt=0, UCnt=0;
1928    for (int e = 0; e &lt; Len(); e++) {
1929      const TWikiElec&amp; E = GetElec(e);
1930      for (int v = 0; v &lt; TMath::Mn(E.Len(),101); v++) {
1931        const int Vote = E.GetVote(v).GetVote()==1?1:0;
1932        AllMomH.AddDat(v).Add(Vote);
1933        AllCntH.AddDat(v) += 1;
1934        if (E.IsSucc) {
1935          AllMomHS.AddDat(v).Add(Vote);
1936          AllCntHS.AddDat(v) += 1; }
1937        else {
1938          AllMomHF.AddDat(v).Add(Vote);
1939          AllCntHF.AddDat(v) += 1;
1940        }
1941        if (UsrSplitSet.IsKey(E[v].GetUId())) {
1942          AdmMomH.AddDat(v).Add(Vote);
1943          AdmCntH.AddDat(v) += 1;
1944        } else {
1945          NAdmMomH.AddDat(v).Add(Vote);
1946          NAdmCntH.AddDat(v) += 1;
1947        }
1948      }
1949    }
1950    TGnuPlot::PlotValMomH(AllMomH, TStr::Fmt(&quot;usrVoteVsTm-%s-all&quot;, OutFNm.CStr()),
1951      TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, Cnt, UCnt, MinUsrVotes),
1952      &quot;time when user voted&quot;, &quot;fraction of positive votes&quot;,
1953      gpsAuto, gpwLinesPoints, true, false, false, false, false, false);
1954    TGnuPlot::PlotValCntH(AllCntH, TStr::Fmt(&quot;usrVoteVsTm-%s-CNT-all&quot;, OutFNm.CStr()),
1955      TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, Cnt, UCnt, MinUsrVotes),
1956      &quot;time when user voted&quot;, &quot;number of votes&quot;);
1957    TGnuPlot::PlotValMomH(AdmMomH, TStr::Fmt(&quot;usrVoteVsTm-%s-admin&quot;, OutFNm.CStr()),
1958      TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, Cnt, UCnt, MinUsrVotes),
1959      &quot;time when user voted&quot;, &quot;fraction of positive votes&quot;,
1960      gpsAuto, gpwLinesPoints, true, false, false, false, false, false);
1961    TGnuPlot::PlotValCntH(AdmCntH, TStr::Fmt(&quot;usrVoteVsTm-%s-CNT-admin&quot;, OutFNm.CStr()),
1962      TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, Cnt, UCnt, MinUsrVotes),
1963      &quot;time when user voted&quot;, &quot;number of votes&quot;);
1964    TGnuPlot::PlotValMomH(NAdmMomH, TStr::Fmt(&quot;usrVoteVsTm-%s-nonadmin&quot;, OutFNm.CStr()),
1965      TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, Cnt, UCnt, MinUsrVotes),
1966      &quot;time when user voted&quot;, &quot;fraction of positive votes&quot;,
1967      gpsAuto, gpwLinesPoints, true, false, false, false, false, false);
1968    TGnuPlot::PlotValCntH(NAdmCntH, TStr::Fmt(&quot;usrVoteVsTm-%s-CNT-nonadmin&quot;, OutFNm.CStr()),
1969      TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, Cnt, UCnt, MinUsrVotes),
1970      &quot;time when user voted&quot;, &quot;number of votes&quot;);
1971  }
1972  void TWikiElecBs::PlotFirstOppOutcome(const TStr&amp; OutFNm, const int&amp; NVotes) const {
1973    THash&lt;TInt, TMom&gt; FOppH, FOpp2H;
1974    TIntH FOppCntH;
1975    int NElec=0;
1976    for (int e = 0; e &lt; Len(); e++) {
1977      const TWikiElec&amp; E = GetElec(e);
1978      if (E.Len() &lt; 10 || E.Len() &lt; NVotes) { continue; } 
1979      int FirstOpp=-1, VoteSum=0;
1980      for (int v = 0; v &lt; NVotes; v++) {
1981        if (E[v].GetVote()==-1 &amp;&amp; FirstOpp==-1) { FirstOpp = v+1; }
1982        VoteSum += E[v].GetVote();
1983      }
1984      if (VoteSum != NVotes-2) { continue; }
1985      FOppCntH.AddDat(FirstOpp) += 1;
1986      FOppH.AddDat(FirstOpp).Add(E.IsSucc?1:0);
1987      FOpp2H.AddDat(FirstOpp).Add(E.GetFracSup());
1988      NElec++;
1989    }
1990    TGnuPlot::PlotValMomH(FOppH, &quot;firstOpp1-&quot;+OutFNm, TStr::Fmt(&quot;Take first %d votes of an election, where %d Sup and 1 Opp. %d such elections&quot;, NVotes, NVotes-1, NElec),
1991      &quot;Index of the oppose vote&quot;, &quot;Fraction of successful elections&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
1992    TGnuPlot::PlotValMomH(FOpp2H, &quot;firstOpp2-&quot;+OutFNm, TStr::Fmt(&quot;Take first %d votes of an election, where %d Sup and 1 Opp. %d such elections&quot;, NVotes, NVotes-1, NElec),
1993      &quot;Index of the oppose vote&quot;, &quot;Final fraction of support votes in the election&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, true, false);
1994    TGnuPlot::PlotValCntH(FOppCntH, &quot;firstOppCnt-&quot;+OutFNm, TStr::Fmt(&quot;Take first %d votes of an election, where %d Sup and 1 Opp. %d such elections&quot;, NVotes, NVotes-1, NElec),
1995      &quot;Index of the oppose vote&quot;, &quot;Number of such elections&quot;);
1996  }
1997  void TWikiElecBs::PlotVoteTrails(const TStr&amp; OutFNm, const int&amp; MinUsrVotes, const bool&amp; No01Prob) const {
1998    TIntSet AdminSet;
1999    TIntV UIdV;
2000    TVec&lt;TFltPrV&gt; ProbSupTmV, FracSupTmV, ProbSupFracSupV, VotesTmV, VoteIdxFracSupV, NVotesFracSupV;
2001    const int TotalVotes = GetVoteTrails(MinUsrVotes, No01Prob, UIdV, ProbSupTmV, FracSupTmV, ProbSupFracSupV, VotesTmV);
2002    GetVoteTrails2(MinUsrVotes, No01Prob, UIdV, VoteIdxFracSupV, NVotesFracSupV);
2003    GetAdminSet(AdminSet);
2004    TIntH UsrLnTy;
2005    for (int u = 0; u &lt; UIdV.Len(); u++) { UsrLnTy.AddDat(UIdV[u], AdminSet.IsKey(UIdV[u])?2:1); }
2006    TGnuPlot GPP(&quot;voteTrailP-&quot;+OutFNm+&quot;-r10&quot;); 
2007    TGnuPlot GPF(&quot;voteTrailF-&quot;+OutFNm+&quot;-r10&quot;);
2008    TGnuPlot GPPF(&quot;voteTrailPF-&quot;+OutFNm+&quot;-r10&quot;);
2009    TGnuPlot GPV(&quot;voteHist-&quot;+OutFNm+&quot;-r10&quot;); 
2010    TGnuPlot GPFI(&quot;voteFIdx-&quot;+OutFNm+&quot;-r10&quot;);
2011    TGnuPlot GPFC(&quot;voteFCnt-&quot;+OutFNm+&quot;-r10&quot;);
2012    THash&lt;TFlt, TMom&gt; AvgAdm, AvgNAdm;
2013    bool FirstA=true, FirstNA=true;
2014    for (int u = 0; u &lt; UIdV.Len(); u++) {
2015      const int UId = UIdV[u];
2016      TStr Tit;
2017      if (FirstA &amp;&amp; UsrLnTy.GetDat(UId) == 2) { Tit=&quot;Admin (HIGH)&quot;; FirstA=false; }
2018      if (FirstNA &amp;&amp; UsrLnTy.GetDat(UId) == 1) { Tit=&quot;NonAdmin (LOW)&quot;; FirstNA=false; }
2019      GPP.AddPlot(ProbSupTmV[u], gpwLines, Tit, TStr::Fmt(&quot;lt %d lw 1 smooth bezier&quot;, UsrLnTy.GetDat(UId)));
2020      GPF.AddPlot(FracSupTmV[u], gpwLines, Tit, TStr::Fmt(&quot;lt %d lw 1 smooth bezier&quot;, UsrLnTy.GetDat(UId)));
2021      GPV.AddPlot(VotesTmV[u], gpwLines, Tit, TStr::Fmt(&quot;lt %d lw 1 smooth bezier&quot;, UsrLnTy.GetDat(UId)));
2022      GPPF.AddPlot(ProbSupFracSupV[u], gpwLinesPoints, Tit, TStr::Fmt(&quot;lt %d lw 1 smooth bezier&quot;, UsrLnTy.GetDat(UId)));
2023      GPFI.AddPlot(VoteIdxFracSupV[u], gpwLines, Tit, TStr::Fmt(&quot;lt %d lw 1 smooth bezier&quot;, UsrLnTy.GetDat(UId)));
2024      GPFC.AddPlot(NVotesFracSupV[u], gpwLines, Tit, TStr::Fmt(&quot;lt %d lw 1 smooth bezier&quot;, UsrLnTy.GetDat(UId)));
2025      for (int i = 0; i &lt; ProbSupFracSupV[u].Len(); i++) {
2026        if (AdminSet.IsKey(UId) || AdminSet.Empty()) { 
2027          AvgAdm.AddDat(ProbSupFracSupV[u][i].Val1).Add(ProbSupFracSupV[u][i].Val2); }
2028        else { 
2029          AvgNAdm.AddDat(ProbSupFracSupV[u][i].Val1).Add(ProbSupFracSupV[u][i].Val2); }
2030      }
2031    }
2032    TFltPrV AvgAdmV, AvgNAdmV;
2033    for (int i =0; i &lt; AvgAdm.Len(); i++) { AvgAdm[i].Def();
2034      AvgAdmV.Add(TFltPr(AvgAdm.GetKey(i), AvgAdm[i].GetMean())); }
2035    for (int i =0; i &lt; AvgNAdm.Len(); i++) { AvgNAdm[i].Def();
2036      AvgNAdmV.Add(TFltPr(AvgNAdm.GetKey(i), AvgNAdm[i].GetMean())); }
2037    AvgAdmV.Sort();  AvgNAdmV.Sort();
2038    GPPF.AddPlot(AvgAdmV, gpwLinesPoints, &quot;AVG ADMIN (HIGH)&quot;, TStr::Fmt(&quot;lt %d lw 5 smooth bezier&quot;, 4));
2039    GPPF.AddPlot(AvgNAdmV, gpwLinesPoints, &quot;AVG NON-ADMIN (LOW)&quot;, TStr::Fmt(&quot;lt %d lw 5 smooth bezier&quot;, 3));
2040    GPP.SetTitle(TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, TotalVotes, UIdV.Len(), MinUsrVotes));
2041    GPP.SetXYLabel(&quot;vote index&quot;, &quot;probability of support vote&quot;);
2042    GPP.SetYRange(0,1.01);
2043    GPF.SetTitle(TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, TotalVotes, UIdV.Len(), MinUsrVotes));
2044    GPF.SetXYLabel(&quot;vote index&quot;, &quot;fraction of support votes so far&quot;);
2045    GPF.SetYRange(0,1.01);
2046    GPPF.SetTitle(TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, TotalVotes, UIdV.Len(), MinUsrVotes));
2047    GPPF.SetXYLabel(&quot;Fraction of support votes at time of vote&quot;, &quot;Probability of voting positively&quot;);
2048    GPPF.SetYRange(0,1.01);
2049    GPPF.SavePng();
2050    GPV.SetTitle(TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, TotalVotes, UIdV.Len(), MinUsrVotes));
2051    GPV.SetXYLabel(&quot;vote index&quot;, &quot;number of votes&quot;);
2052    GPFI.SetTitle(TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, TotalVotes, UIdV.Len(), MinUsrVotes));
2053    GPFI.SetXYLabel(&quot;Fraction of support votes at time of vote&quot;, &quot;Average vote index (time) of a user voting&quot;);
2054    GPFC.SetTitle(TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, TotalVotes, UIdV.Len(), MinUsrVotes));
2055    GPFC.SetXYLabel(&quot;Fraction of support votes at time of vote&quot;, &quot;Number of times user voted at that fraction&quot;);
2056  }
2057  void TWikiElecBs::PlotVoteTrailGlobal(const TStr&amp; OutFNm) const {
2058    THash&lt;TInt, TMom&gt; SuppVoteH, Set1, Set2;
2059    TIntSet UIdSet;
2060    GetAdminSet(UIdSet);
2061    for (int e = 0; e &lt; Len(); e++) {
2062      const TWikiElec&amp; E = GetElec(e);
2063      int nsup=0;
2064      if (E.Len()&lt;10) { continue; }
2065      for (int v = 0; v &lt; E.Len(); v++) {
2066        const int supFrac = v==0? 0 : int(TMath::Round(10.0*nsup/double(v)))*10;
2067        nsup += E.GetVote(v).GetVote()==1?1:0;
2068        if (v&lt;10) { continue; } 
2069        SuppVoteH.AddDat(supFrac).Add(E.GetVote(v).GetVote()==1?1:0);
2070        if (UIdSet.IsKey(E.GetVote(v).GetUId())) { 
2071          Set1.AddDat(supFrac).Add(E.GetVote(v).GetVote()==1?1:0);
2072        } else { 
2073          Set2.AddDat(supFrac).Add(E.GetVote(v).GetVote()==1?1:0);
2074        }
2075      }
2076    }
2077    TGnuPlot::PlotValMomH(SuppVoteH, &quot;voteTrailAll-&quot;+OutFNm, &quot;Global vote trail&quot;, &quot;Fraction of support votes at time of vote&quot;, &quot;Probability of voting positively&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
2078    TGnuPlot::PlotValMomH(Set1, &quot;voteTrailAll1-&quot;+OutFNm, &quot;Global vote trail. Set1&quot;, &quot;Fraction of support votes at time of vote&quot;, &quot;Probability of voting positively&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
2079    TGnuPlot::PlotValMomH(Set2, &quot;voteTrailAll2-&quot;+OutFNm, &quot;Global vote trail. Set2&quot;, &quot;Fraction of support votes at time of vote&quot;, &quot;Probability of voting positively&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
2080  }
2081  void TWikiElecBs::PlotFinalFracVoteCnt(const TStr&amp; OutFNm, const int&amp; MinUsrVotes, const TIntSet&amp; UsrSplitSet) const {
2082    TIntPrV VoteUIdV; GetUsrVotes(VoteUIdV);
2083    THash&lt;TInt, TIntH&gt; UIdVoteCntH;
2084    TIntH FracVotesH, Set1, Set2;
2085    VoteUIdV.Sort(false);
2086    for (int i = 0; i &lt; VoteUIdV.Len() &amp;&amp; VoteUIdV[i].Val1&gt;MinUsrVotes; i++) {
2087      UIdVoteCntH.AddKey(VoteUIdV[i].Val2); }
2088    for (int e = 0; e &lt; Len(); e++) {
2089      const TWikiElec&amp; E = GetElec(e);
2090      const int SupFrac= (int(100*E.GetFracSup())/10)*10;
2091      for (int v = 0; v &lt; E.Len(); v++) {
2092        const int V = E[v].GetVote()==1?1:0;
2093        const int U = E[v].GetUId();
2094        FracVotesH.AddDat(SupFrac) += 1;
2095        if (UsrSplitSet.IsKey(U)) { Set1.AddDat(SupFrac) += 1; }
2096        else { Set2.AddDat(SupFrac) += 1; }
2097        if (UIdVoteCntH.IsKey(U)) { UIdVoteCntH.AddDat(U).AddDat(SupFrac) += 1; }
2098      }
2099    }
2100    TGnuPlot::PlotValCntH(FracVotesH, &quot;voteFrac-&quot;+OutFNm+&quot;-all&quot;, &quot;All users&quot;, &quot;Final fraction of support votes&quot;, &quot;Number of votes&quot;);
2101    TGnuPlot::PlotValCntH(Set1, &quot;voteFrac-&quot;+OutFNm+&quot;-set1&quot;, &quot;UsrSplitSet users&quot;, &quot;Final fraction of support votes&quot;, &quot;Number of votes&quot;);
2102    TGnuPlot::PlotValCntH(Set2, &quot;voteFrac-&quot;+OutFNm+&quot;-set2&quot;, &quot;Users no in UsrSplitSet&quot;, &quot;Final fraction of support votes&quot;, &quot;Number of votes&quot;);
2103    TGnuPlot GP(&quot;voteFrac-&quot;+OutFNm);
2104    for (int u = 0; u &lt; UIdVoteCntH.Len(); u++) {
2105      TIntPrV ValV;
2106      UIdVoteCntH[u].GetKeyDatPrV(ValV);
2107      ValV.Sort();
2108      GP.AddPlot(ValV, gpwLinesPoints, &quot;&quot;, TStr::Fmt(&quot;lw 1 smooth bezier&quot;));
2109    }
2110    GP.SetXYLabel(&quot;Final fraction of support votes&quot;, &quot;Number of votes&quot;);
2111    GP.SavePng();
2112  }
2113  void TWikiElecBs::PlotConfusionMatrix(const TStr&amp; OutFNm, const int&amp; MinUsrVotes) const {
2114    THash&lt;TInt, TTuple&lt;TFlt, 4&gt; &gt; TupH;
2115    for (int e = 0; e &lt; Len(); e++) {
2116      const TWikiElec&amp; E = GetElec(e);
2117      const int R = E.IsSucc?1:0;
2118      for (int v = 0; v &lt; E.Len(); v++) {
2119        const int V = E[v].GetVote()==1?1:0;
2120        TupH.AddDat(E[v].GetUId())[2*R+V] += 1;
2121      }
2122    }
2123    FILE *F=fopen(TStr::Fmt(&quot;confusion-%s.tab&quot;, OutFNm.CStr()).CStr(), &quot;wt&quot;);
2124    for (int u = 0; u &lt; TupH.Len(); u++) {
2125      const double S = TupH[u][0]+TupH[u][1]+TupH[u][2]+TupH[u][3];
2126      if (S &lt; MinUsrVotes) { continue; }
2127      fprintf(F, &quot;%f\t%f\t%f\t%f\n&quot;, TupH[u][0], TupH[u][1], TupH[u][2], TupH[u][3]);
2128    }
2129    fclose(F);
2130  }
2131  void TWikiElecBs::PlotSlopeHist(const TStr&amp; OutFNm, const int&amp; MinElecLen) const {
2132    const double BPrec = 1000;
2133    TIntH R21A, R22A, K1A, K2A;
2134    TIntH R21S, R22S, K1S, K2S;
2135    TIntH R21F, R22F, K1F, K2F;
2136    int Cnt=0;
2137    for (int e = 0; e &lt; Len(); e++) {
2138      const TWikiElec&amp; E = GetElec(e);
2139      if (E.Len() &lt; MinElecLen) { continue; }
2140      TFltPrV XyV, Xy2;
2141      for (int v = 0; v &lt; E.Len(); v++) {
2142        XyV.Add(TFltPr(v, E[v].GetVote()));
2143        Xy2.Add(TFltPr(v, E.GetFracSup(0, v+1)));
2144      }
2145      double A, B, SigA, SigB, Chi2, R2=0;
2146      TSpecFunc::LinearFit(XyV, A, B, SigA, SigB, Chi2, R2);
2147      if (R2 &lt; -1 || _isnan(R2)) R2 = 0;
2148      K1A.AddDat(int(BPrec*B))+=1;
2149      R21A.AddDat(int(100*R2))+=1;
2150      if (E.IsSucc) {
2151        K1S.AddDat(int(BPrec*B))+=1;
2152        R21S.AddDat(int(100*R2))+=1;
2153      } else {
2154        K1F.AddDat(int(BPrec*B))+=1;
2155        R21F.AddDat(int(100*R2))+=1;
2156      }
2157      TSpecFunc::LinearFit(Xy2, A, B, SigA, SigB, Chi2, R2);
2158      if (R2 &lt; -1 || _isnan(R2)) R2 = 0;
2159      K2A.AddDat(int(BPrec*B))+=1;
2160      R22A.AddDat(int(100*R2))+=1;
2161      if (E.IsSucc) {
2162        K2S.AddDat(int(BPrec*B))+=1;
2163        R22S.AddDat(int(100*R2))+=1;
2164      } else {
2165        K2F.AddDat(int(BPrec*B))+=1;
2166        R22F.AddDat(int(100*R2))+=1;
2167      }
2168      Cnt++;
2169    }
2170    TGnuPlot::PlotValCntH(K1A, &quot;ALL ELEC&quot;, K1S, &quot;SUCC ELEC&quot;, K1F, &quot;FAIL ELEC&quot;, &quot;slopeK1-&quot;+OutFNm, TStr::Fmt(&quot;%d elections with &gt;%d votes&quot;, Cnt, MinElecLen),  &quot;slope (fit of Prob(+|t) vs t)&quot;, &quot;count&quot;, gpsLog10Y);
2171    TGnuPlot::PlotValCntH(K2A, &quot;ALL ELEC&quot;, K2S, &quot;SUCC ELEC&quot;, K2F, &quot;FAIL ELEC&quot;, &quot;slopeK2-&quot;+OutFNm, TStr::Fmt(&quot;%d elections with &gt;%d votes&quot;, Cnt, MinElecLen),  &quot;slope (fit of FracSup(1..t) vs t)&quot;, &quot;count&quot;, gpsLog10Y);
2172    TGnuPlot::PlotValCntH(R21A, &quot;ALL ELEC&quot;, R21S, &quot;SUCC ELEC&quot;, R21F, &quot;FAIL ELEC&quot;, &quot;slopeR1-&quot;+OutFNm, TStr::Fmt(&quot;%d elections with &gt;%d votes&quot;, Cnt, MinElecLen),  &quot;R2 (fit of Prob(+|t) vs t)&quot;, &quot;count&quot;, gpsLog10Y);
2173    TGnuPlot::PlotValCntH(R22A, &quot;ALL ELEC&quot;, R22S, &quot;SUCC ELEC&quot;, R22F, &quot;FAIL ELEC&quot;, &quot;slopeR2-&quot;+OutFNm, TStr::Fmt(&quot;%d elections with &gt;%d votes&quot;, Cnt, MinElecLen),  &quot;R2 (fit of FracSup(1..t) vs t)&quot;, &quot;count&quot;, gpsLog10Y);
2174  }
2175  void TWikiElecBs::PlotBarnStarsDelta(const TStr&amp; OutFNm) const {
2176    TBarnStars BarnStars;
2177    THash&lt;TInt, TMom&gt; DiffMomH;
2178    TIntH DiffCntH;
2179    for (int e = 0; e &lt; Len(); e++) {
2180      const TWikiElec&amp; E = GetElec(e);
2181      const TStr TargetUsr = GetUsr(E.GetUId());
2182      const int TB = BarnStars.GetBarnStars(TargetUsr, E.GetTm());
2183      for (int v = 0; v &lt; E.Len(); v++) {
2184        if (! E[v].IsVote()) { continue; }
2185        const int DeltaStars = BarnStars.GetBarnStars(GetUsr(E[v].GetUId()), E[v].GetTm()) - TB;
2186        DiffMomH.AddDat(DeltaStars).Add(E[v].GetVote()==1?1:0);
2187        DiffCntH.AddDat(DeltaStars) += 1;
2188      }
2189    }
2190    TGnuPlot::PlotValMomH(DiffMomH, &quot;dBarnStars-&quot;+OutFNm, &quot;Number of BarnStars (over ALL VOTES): &quot;+OutFNm, &quot;Barnstars delta (source - destination)&quot;,
2191      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false);
2192    TGnuPlot::PlotValCntH(DiffCntH, &quot;dBarnStarts2-&quot;+OutFNm, &quot;Number of BarnSTars (over aLL VOES): &quot;+OutFNm, &quot;Barnstars delta (source - destination)&quot;,
2193      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
2194  }
2195  void TWikiElecBs::PlotAdminVotes(const TStr&amp; OutFNm) const {
2196    TIntH APos, NAPos, ANeg, NANeg;
2197    TIntPrSet AVotes, NAVotes;
2198    for (int e = 0; e &lt; Len(); e++) {
2199      const TIntTr V = GetElec(e).GetVotes(true);
2200      if (GetElec(e).IsSucc) {
2201        APos.AddDat(V.Val1) += 1;
2202        ANeg.AddDat(V.Val3) += 1;
2203        AVotes.AddKey(TIntPr(V.Val1, V.Val3));
2204      } else {
2205        NAPos.AddDat(V.Val1) += 1;
2206        NANeg.AddDat(V.Val3) += 1;
2207        NAVotes.AddKey(TIntPr(V.Val1, V.Val3));
2208      }
2209    }
2210    { TGnuPlot GP(&quot;adminSup-&quot;+OutFNm, OutFNm);
2211    GP.AddPlot(APos, gpwLinesPoints, &quot;Support votes for ADMINS&quot;);
2212    GP.AddPlot(NAPos, gpwLinesPoints, &quot;Support votes for NON-ADMINS&quot;);
2213    GP.SetXYLabel(&quot;Number of support votes&quot;, &quot;Number of elections&quot;);
2214    GP.SavePng(); }
2215    { TGnuPlot GP(&quot;adminOpp-&quot;+OutFNm, OutFNm);
2216    GP.AddPlot(ANeg, gpwLinesPoints, &quot;Oppose votes for ADMINS&quot;);
2217    GP.AddPlot(NANeg, gpwLinesPoints, &quot;Oppose votes for NON-ADMINS&quot;);
2218    GP.SetXYLabel(&quot;Number of oppose votes&quot;, &quot;Number of elections&quot;);
2219    GP.SavePng(); }
2220    { TGnuPlot GP(&quot;adminSupOpp-&quot;+OutFNm, OutFNm);
2221    TIntPrV V;  AVotes.GetKeyV(V);
2222    GP.AddPlot(V, gpwPoints, &quot;Votes for ADMINS&quot;);
2223    NAVotes.GetKeyV(V);
2224    GP.AddPlot(V, gpwPoints, &quot;Votes for NON-ADMINS&quot;);
2225    GP.SetXYLabel(&quot;Number of support votes&quot;, &quot;Number of oppose votes&quot;);
2226    GP.SavePng(); }
2227  }
2228  void TWikiElecBs::PlotAvgVote(const TStr&amp; OutFNm, const int&amp; MinVotes, const int&amp; MaxVotes) const {
2229    TIntV ElecV;
2230    for (int e = 0; e &lt; Len(); e++) {
2231      if (! GetElec(e).IsSucc()) {
2232        ElecV.Add(e); }
2233    }
2234    PlotAvgVote(ElecV, OutFNm, TStr::Fmt(&quot;Elections with %d--%d votes, %d elections&quot;, MinVotes, MaxVotes, ElecV.Len()));
2235  }
2236  void TWikiElecBs::PlotAvgVote(const TIntV&amp; ElecIdV, const TStr&amp; OutFNm, const TStr&amp; Desc) const {
2237    THash&lt;TInt, TMom&gt; MomH;
2238    THash&lt;TInt, TMom&gt; Mom2H;
2239    TFltV AvgVoteV;
2240    for (int i = 0; i &lt; ElecIdV.Len(); i++) {
2241      GetElec(ElecIdV[i]).GetAvgVoteOt(AvgVoteV, true);
2242      for (int v = 0; v &lt; AvgVoteV.Len(); v++) {
2243        MomH.AddDat(v+1).Add(AvgVoteV[v]); }
2244      const TWikiElec&amp; E = GetElec(ElecIdV[i]);
2245      for (int v = 0; v &lt; E.Len(); v++) {
2246        Mom2H.AddDat(v).Add(E.GetVote(v).GetVote()==1?1:0);
2247      }
2248    }
2249    TGnuPlot::PlotValMomH(MomH, &quot;voteAvg-&quot;+OutFNm, TStr::Fmt(&quot;%s. %d elections&quot;, Desc.CStr(), ElecIdV.Len()),
2250      &quot;n (vote index, time)&quot;, &quot;Running average of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false);
2251    TGnuPlot::PlotValMomH(Mom2H, &quot;voteAvg2-&quot;+OutFNm, TStr::Fmt(&quot;%s. %d elections&quot;, Desc.CStr(), ElecIdV.Len()),
2252      &quot;n (vote index, time)&quot;, &quot;Probability of positive vote&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false);
2253  }
2254  void TWikiElecBs::PlotAvgVoteDev(const TIntV&amp; ElecIdV, const TStr&amp; OutFNm, const TStr&amp; Desc) const {
2255    THash&lt;TInt, TMom&gt; MomH;
2256    TFltV AvgVoteV;
2257    for (int i = 0; i &lt; ElecIdV.Len(); i++) {
2258      GetElec(ElecIdV[i]).GetAvgVoteDevOt(AvgVoteV, true);
2259      for (int v = 0; v &lt; AvgVoteV.Len(); v++) {
2260        MomH.AddDat(v+1).Add(AvgVoteV[v]); }
2261    }
2262    TGnuPlot::PlotValMomH(MomH, &quot;voteDev-&quot;+OutFNm, TStr::Fmt(&quot;%s. %d elections&quot;, Desc.CStr(), ElecIdV.Len()),
2263      &quot;n (vote index, time)&quot;, &quot;Deviation of the running average&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false);
2264    MomH.SortByKey();
2265    for (int v = 0; v &lt; MomH.Len(); v+=10) {
2266      printf(&quot;  %d\t%g\n&quot;, v, MomH[v].GetWgt());
2267    }
2268  }
2269  void TWikiElecBs::PlotAvgSupFrac(const TIntV&amp; ElecIdV, const TStr&amp; OutFNm, const TStr&amp; Desc) const {
2270    THash&lt;TInt, TMom&gt; MomH;
2271    TFltV AvgVoteV;
2272    for (int i = 0; i &lt; ElecIdV.Len(); i++) {
2273      TWikiVoteV VoteV;
2274      GetElec(ElecIdV[i]).GetVotesOt(VoteV);
2275      for (int v = 0; v &lt; VoteV.Len(); v++) {
2276        MomH.AddDat(v+1).Add(VoteV[v].GetVote()==1?1:0); }
2277    }
2278    TGnuPlot::PlotValMomH(MomH, &quot;voteFrac-&quot;+OutFNm, TStr::Fmt(&quot;%s. %d elections&quot;, Desc.CStr(), ElecIdV.Len()),
2279      &quot;T (vote index, time)&quot;, &quot;Fraction of all votes casted at time T that were supporting&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false);
2280  }
2281  void TWikiElecBs::PlotOutcomes(const TStr&amp; OutFNm) const {
2282    TWikiVoteV VoteV;
2283    TIntV UIdV;  GetEIdByVotes(UIdV);
2284    TGnuPlot GP(&quot;votes-otime3-0&quot;), GP2(&quot;votes-otime4-0&quot;);
2285    for (int u = 0; u &lt; 100; u++) {
2286      const TWikiElec&amp; E = GetElec(UIdV[u]);
2287      E.GetVotesOt(VoteV, true);
2288      const int b = VoteV[0].GetTm().GetAbsSecs();
2289      TFltPrV FracV, FracV2;
2290      int pos=0, neg=0;
2291      for (int v = 0; v &lt; VoteV.Len(); v++) {
2292        if (VoteV[v].GetVote()==1) { pos++; }
2293        else if (VoteV[v].GetVote()==-1) { neg++; } else { continue; }
2294        FracV.Add(TFltPr(v, pos/double(pos+neg)));
2295        FracV2.Add(TFltPr(v/double(VoteV.Len()), pos/double(pos+neg)));
2296      }
2297      GP.AddPlot(FracV, gpwLines);
2298      GP2.AddPlot(FracV2, gpwLines);
2299      if ((u+1) % 10 == 0) {
2300        GP.SavePng();
2301        GP2.SavePng();
2302        GP = TGnuPlot(TStr::Fmt(&quot;votes-otime3-%d&quot;, u/10));
2303        GP2 = TGnuPlot(TStr::Fmt(&quot;votes-otime4-%d&quot;, u/10));
2304      }
2305    }
2306    GP.SavePng();
2307    GP2.SavePng();
2308  }
2309  void TWikiElecBs::PlotSupFracVsElecLen(const TStr&amp; OutFNm) const {
2310    THash&lt;TInt, TMom&gt; ElecMom;
2311    THash&lt;TInt, TMom&gt; ElecMom5;
2312    THash&lt;TInt, TMom&gt; ElecMom10;
2313    for (int e = 0; e &lt; Len(); e++) {
2314      ElecMom.AddDat(GetElec(e).Len()).Add(GetElec(e).GetFracSup());
2315      ElecMom5.AddDat(5*(GetElec(e).Len()/5)).Add(GetElec(e).GetFracSup());
2316      ElecMom10.AddDat(10*(GetElec(e).Len()/10)).Add(GetElec(e).GetFracSup());
2317    }
2318    TGnuPlot::PlotValMomH(ElecMom, &quot;fracSupLen-&quot;+OutFNm, &quot;Bucket size 1&quot;, &quot;Number of votes in the election&quot;, &quot;Final fraction of support votes&quot;);
2319    TGnuPlot::PlotValMomH(ElecMom5, &quot;fracSupLen-&quot;+OutFNm+&quot;5&quot;, &quot;Bucket size 5&quot;, &quot;Number of votes in the election&quot;, &quot;Final fraction of support votes&quot;);
2320    TGnuPlot::PlotValMomH(ElecMom10, &quot;fracSupLen-&quot;+OutFNm+&quot;10&quot;, &quot;Bucket size 10&quot;, &quot;Number of votes in the election&quot;, &quot;Final fraction of support votes&quot;);
2321  }
2322  void TWikiElecBs::PlotSupOpp(const TStr&amp; OutFNm) const {
2323  }
2324  void TWikiElecBs::PlotVoteDistr(const TStr&amp; OutFNm) const {
2325    TWikiVoteV VoteV;
2326    TIntV UIdV;  GetEIdByVotes(UIdV);
2327    TVec&lt;TMom&gt; SupV, OppV;
2328    THash&lt;TInt, TIntH&gt; PosH, NegH;
2329    for (int u = 0; u &lt; 2000; u++) {
2330      const TWikiElec&amp; E = GetElec(UIdV[u]);
2331      const TIntTr PON = E.GetVotes(true);
2332      if ((PON.Val1+2*PON.Val2) &lt; 50)  {
2333        PosH.AddDat((PON.Val1+PON.Val2)/10).AddDat((PON.Val1))++;
2334        NegH.AddDat((PON.Val1+PON.Val2)/10).AddDat((PON.Val1-PON.Val2))++;
2335        printf(&quot;%d &quot;, PON.Val1+PON.Val2);
2336      }
2337    }
2338    PosH.SortByKey(); NegH.SortByKey();
2339    for (int i = 0; i &lt; PosH.Len(); i++) {
2340      TGnuPlot GP(TStr::Fmt(&quot;voteX-distr%02d&quot;, PosH.GetKey(i)));
2341      TFltPrV PrV1, PrV2;
2342      IAssert(PosH.GetKey(i) == NegH.GetKey(i));
2343      TIntH&amp; CntH1 = PosH[i];  CntH1.SortByKey();
2344      TIntH&amp; CntH2 = NegH[i];  CntH2.SortByKey();
2345      for (int j = 0; j &lt; CntH1.Len(); j++) {
2346        PrV1.Add(TFltPr(CntH1.GetKey(j).Val, CntH1[j].Val)); }
2347      for (int j = 0; j &lt; CntH2.Len(); j++) {
2348        PrV2.Add(TFltPr(CntH2.GetKey(j).Val, CntH2[j].Val)); }
2349      GP.AddPlot(PrV1, gpwLinesPoints, &quot;Pos&quot;);
2350      GP.AddCmd(&quot;set yzeroaxis lt -1&quot;);
2351      GP.SavePng();
2352    }
2353  }
2354  PSignNet TWikiElecBs::GetAdminUsrVoteNet() const {
2355    TIntV UIdV;
2356    GetElecAdminUsrV(UIdV);
2357    return GetVoteNet(UIdV);
2358  }
2359  PSignNet TWikiElecBs::GetElecUsrVoteNet() const {
2360    TIntV UIdV;
2361    GetElecUsrV(UIdV);
2362    return GetVoteNet(UIdV);
2363  }
2364  PSignNet TWikiElecBs::GetAllUsrVoteNet() const {
2365    TIntV UIdV;
2366    GetUsrV(UIdV);
2367    return GetVoteNet(UIdV);
2368  }
2369  PSignNet TWikiElecBs::GetVoteNet(const TIntV&amp; UsrIdV) const {
2370    TIntSet UsrSet;
2371    for (int u = 0; u &lt; UsrIdV.Len(); u++) {
2372      UsrSet.AddKey(UsrIdV[u]);
2373    }
2374    PSignNet Net = TSignNet::New();
2375    THash&lt;TIntPr, TStr&gt; EdgeElecH;
2376    for (int e = 0; e &lt; Len(); e++) {
2377      const TWikiElec&amp; FullE = GetElec(e);
2378      const int Dst = FullE.GetUId();
2379      if (! UsrSet.IsKey(Dst)) { continue; }
2380      TWikiElec NewElec;
2381      FullE.GetOnlyVotes(NewElec, true);
2382      for (int v = 0; v &lt; NewElec.Len(); v++) {
2383        const int Src = NewElec[v].GetUId();
2384        if (! UsrSet.IsKey(Src)) { continue; }
2385        if (Src == Dst) { continue; }
2386        if (! Net-&gt;IsNode(Dst)) {
2387          Net-&gt;AddNode(Dst); }
2388        if (! Net-&gt;IsNode(Src)) {
2389          Net-&gt;AddNode(Src); }
2390        if (Net-&gt;IsEdge(Src, Dst)) { 
2391        }
2392        Net-&gt;AddEdge(Src, Dst, NewElec[v].GetVote());
2393      }
2394    }
2395    return Net;
2396  }
2397  void TWikiElecBs::GetOnlyVoteElecBs(TWikiElecBs&amp; NewElecBs, const bool&amp; OnlySupOpp) const {
2398    NewElecBs.UsrH = UsrH;
2399    NewElecBs.ElecV = ElecV;
2400    for (int e = 0; e &lt; ElecV.Len(); e++) {
2401      ElecV[e].GetOnlyVotes(NewElecBs.ElecV[e], OnlySupOpp);  
2402    }
2403  }
2404  bool TWikiElecBs::AddElecRes(const TWikiMetaHist&amp; WMH, const THash&lt;TStr, TStr&gt;&amp; UsrMapH, const THash&lt;TStr, TWikiElecBs::TElecSum&gt;&amp; ElecSumH) {
2405    if (! WMH.Title.IsPrefix(&quot;Wikipedia:Requests_for_adminship/&quot;)) { return false; }
2406    const int b = WMH.Title.SearchCh(&#x27;/&#x27;)+1;
2407    const int e = WMH.Title.SearchCh(&#x27;/&#x27;, b+1)-1;
2408    TChA RfaTitle = WMH.Title.GetSubStr(b, e&gt;b?e:TInt::Mx);
2409    TWikiElec WikiElec(-1, WMH.RevTm); 
2410    ParseVotes(WMH, UsrMapH, WikiElec);
2411    WikiElec.SetIsVoteFlag();
2412    WikiElec.RfaTitle = RfaTitle;
2413    TIntTr V = WikiElec.GetVotes();
2414    if (RfaTitle.IsSuffix(&quot;_Couriano&quot;)) { RfaTitle = &quot;Couriano&quot;; } 
2415    if (ElecSumH.IsKey(RfaTitle)) {
2416      const TElecSum&amp; ElSum = ElecSumH.GetDat(RfaTitle);
2417      WikiElec.IsSucc = true;
2418      TChA U = ElSum.Usr;
2419      if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
2420      WikiElec.UsrId = AddUsr(ElSum.Usr.CStr()); 
2421      if (! ElSum.Bureaucrat.Empty()) {
2422        TChA U = ElSum.Bureaucrat;
2423        if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
2424        WikiElec.BurUId = AddUsr(U);
2425      }
2426      if (! ElSum.NominatedBy.Empty()) {
2427        TChA U = ElSum.NominatedBy;
2428        if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
2429        WikiElec.NomUId = AddUsr(U);
2430      }
2431      if (abs(V.Val1-ElSum.Sup) &gt; 0) { printf(&quot;SUP VOTES: %d != %d\n&quot;, V.Val1, ElSum.Sup);  }
2432      if (abs(V.Val2-ElSum.Neu) &gt; 0) { printf(&quot;NEU VOTES: %d != %d\n&quot;, V.Val2, ElSum.Neu);  }
2433      if (abs(V.Val3-ElSum.Opp) &gt; 0) { printf(&quot;OPP VOTES: %d != %d\n&quot;, V.Val3, ElSum.Opp);  }
2434    } else {
2435      TChA U = RfaTitle.ToLc(); 
2436      if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
2437      WikiElec.UsrId = AddUsr(U); 
2438    }
2439    if (V.Val1+V.Val2+V.Val3 == 0) {
2440      printf(&quot;no votes\n&quot;); return false;
2441    }
2442    ElecV.Add(WikiElec);
2443    return true;
2444  }
2445  int TWikiElecBs::GetWikiTxtLen(char* LineStr) {
2446    int Len=0;
2447    for (char *ch=LineStr+1; *ch != NULL; ch++) {
2448      if (TCh::IsAlNum(*ch)) { Len++; }
2449      if (*ch==&#x27;[&#x27; &amp;&amp; *(ch-1)==&#x27;[&#x27;) {
2450        while (*ch &amp;&amp; *ch!=&#x27;]&#x27; &amp;&amp; *(ch-1)!=&#x27;]&#x27;) { ch++; }
2451      }
2452    }
2453    return Len;
2454  }
2455  void TWikiElecBs::LoadElecSumTxt(const TStr&amp; FNm, THash&lt;TStr, TWikiElecBs::TElecSum&gt;&amp; ElecSumH) {
2456    ElecSumH.Clr();
2457    for (TSsParser SS(FNm, ssfTabSep); SS.Next(); ) {
2458      IAssert(SS.Len() == 9);
2459      TElecSum&amp; S = ElecSumH.AddDat(SS[1]); 
2460      S.Usr = SS[0];          S.Usr.ToLc();
2461      S.RfA = SS[1];
2462      S.Sup = SS.GetInt(2);
2463      S.Opp = SS.GetInt(3);
2464      S.Neu = SS.GetInt(4);
2465      S.NominatedBy = SS[7];  S.NominatedBy.ToLc();
2466      S.Bureaucrat = SS[8];   S.Bureaucrat.ToLc();
2467    }
2468  }
2469  bool EndOfSection(char* Line, const TStr&amp; WhatStr) {
2470    if (Line[0]==&#x27;#&#x27; || Line[0]==&#x27;:&#x27;) { return false; }
2471    TChA LnStr(Line);
2472    LnStr.ToTrunc();
2473    if (LnStr.SearchStr(TStr::Fmt(&quot;&#x27;&#x27;&#x27;%s&#x27;&#x27;&#x27;&quot;, WhatStr.CStr()))!=-1) { return true; }
2474    if (LnStr.SearchStr(TStr::Fmt(&quot;====%s====&quot;, WhatStr.CStr()))!=-1) { return true; }
2475    if (LnStr.SearchStr(TStr::Fmt(&quot;==== %s ====&quot;, WhatStr.CStr()))!=-1) { return true; }
2476    if (LnStr.SearchStr(TStr::Fmt(&quot;&#x27;&#x27;&#x27;%s:&#x27;&#x27;&#x27;&quot;, WhatStr.CStr()))!=-1) { return true; }
2477    if (LnStr.SearchStr(TStr::Fmt(&quot;====%s:====&quot;, WhatStr.CStr()))!=-1) { return true; }
2478    if (LnStr.IsPrefix(TStr::Fmt(&quot;; %s&quot;, WhatStr.CStr()))) { return true; }
2479    if (LnStr.IsPrefix(TStr::Fmt(&quot;;%s&quot;, WhatStr.CStr()))) { return true; }
2480    if (LnStr==TStr::Fmt(&quot;%s&quot;, WhatStr.CStr())) { return true; }
2481    if (LnStr==TStr::Fmt(&quot;%s:&quot;, WhatStr.CStr())) { return true; }
2482    return false;
2483  }
2484  void TWikiElecBs::ParseVotes(const TWikiMetaHist&amp; WMH, const THash&lt;TStr, TStr&gt;&amp; UsrMapH, TWikiElec&amp; WikiElec) {
2485    TVec&lt;char *&gt; LineV;  TChA Tmp = WMH.Text;
2486    Tmp.ToLc();
2487    TStrUtil::SplitLines(Tmp, LineV);
2488    int l = 0, goodVote=0;
2489    int NSup=0, NOpp=0, NNeu=0;
2490    for (; l &lt; LineV.Len(); l++) {
2491      if (EndOfSection(LineV[l], &quot;support&quot;)) { l++; break; }
2492      char *vote=strstr(LineV[l], &quot;) end&quot;);
2493      if (vote == NULL) { vote=strstr(LineV[l], &quot;) end&quot;); }
2494      if (vote != NULL &amp;&amp; TCh::IsNum(*(vote-1)) &amp;&amp; NSup==-1) {
2495        *vote=0;  vote--;
2496        while(TCh::IsNum(*vote)) { vote--; }
2497        if (*vote == &#x27;/&#x27;) {
2498          NNeu = atoi(vote+1);  *vote=0;  vote--;
2499          while(TCh::IsNum(*vote)) { vote--; }
2500          if (*vote == &#x27;/&#x27;) {
2501            NOpp = atoi(vote+1);  *vote=0;  vote--;
2502            while(TCh::IsNum(*vote)) { vote--; }
2503            if (*vote == &#x27;(&#x27;) { NSup = atoi(vote+1); } }
2504      } }/&amp;bsol;*/
2505    }
2506    TChA Usr;  TSecTm Tm;  int Indent;
2507    for (; l &lt; LineV.Len(); l++) {
2508      if(GetUsrTm(LineV[l], Usr, Tm, Indent)) {  goodVote++;
2509      if (UsrMapH.IsKey(Usr)) { Usr = UsrMapH.GetDat(Usr);  }
2510        WikiElec.VoteV.Add(TWikiVote(AddUsr(Usr), +1, Indent, GetWikiTxtLen(LineV[l]), Tm));
2511      }
2512      if (EndOfSection(LineV[l], &quot;oppose&quot;)) { l++; break; }
2513    }
2514    for (; l &lt; LineV.Len(); l++) {
2515      if(GetUsrTm(LineV[l], Usr, Tm, Indent)) {  goodVote++;
2516        if (UsrMapH.IsKey(Usr)) { Usr = UsrMapH.GetDat(Usr); }
2517        WikiElec.VoteV.Add(TWikiVote(AddUsr(Usr), -1, Indent, GetWikiTxtLen(LineV[l]), Tm));
2518      }
2519      if (EndOfSection(LineV[l], &quot;neutral&quot;)) { l++; break; }
2520    }
2521    for (; l &lt; LineV.Len(); l++) {
2522      if(GetUsrTm(LineV[l], Usr, Tm, Indent)) {  goodVote++;
2523        if (UsrMapH.IsKey(Usr)) { Usr = UsrMapH.GetDat(Usr); printf(&quot;u&quot;); }
2524        WikiElec.VoteV.Add(TWikiVote(AddUsr(Usr), 0, Indent, GetWikiTxtLen(LineV[l]), Tm));
2525      }
2526      if (LineV[l][0]!=&#x27;#&#x27; &amp;&amp; (strstr(LineV[l], &quot;&#x27;&#x27;&#x27;comments&quot;)!=NULL || strstr(LineV[l], &quot;&#x27;&#x27;&#x27;no vote&quot;)!=NULL
2527        || strstr(LineV[l], &quot;====&quot;)!=NULL || strstr(LineV[l], &quot;;comments&quot;)!=NULL || strstr(LineV[l], &quot;; comments&quot;)!=NULL ||
2528        strcmp(LineV[l],&quot;comment&quot;)==0 || strcmp(LineV[l],&quot;comments&quot;)==0)) { l++; break; }
2529    }
2530    const TIntTr SON = WikiElec.GetVotes(true);
2531    if (SON.Val1+SON.Val2+SON.Val3 &gt; 100 &amp;&amp; (SON.Val1==0 || SON.Val2==0)) {
2532    }
2533  }
2534  void TWikiElecBs::SetUserIdFromRfa() {
2535    THash&lt;TChA, TChA&gt; RfaUsrMapH;
2536    RfaUsrMapH.AddDat(&quot;White_Cat_(01)&quot;, &quot;White_Cat&quot;);
2537    RfaUsrMapH.AddDat(&quot;White_Cat_(02)&quot;, &quot;White_Cat&quot;);
2538    RfaUsrMapH.AddDat(&quot;White_Cat_(03)&quot;, &quot;White_Cat&quot;);
2539    RfaUsrMapH.AddDat(&quot;White_Cat_(04)&quot;, &quot;White_Cat&quot;);
2540    RfaUsrMapH.AddDat(&quot;Computerjoe_(4)&quot;, &quot;Computerjoe&quot;);
2541    RfaUsrMapH.AddDat(&quot;Purplefeltangel2&quot;, &quot;Purplefeltangel&quot;);
2542    RfaUsrMapH.AddDat(&quot;Haham_Hanuka_(3)&quot;, &quot;Haham_Hanuka&quot;);
2543    RfaUsrMapH.AddDat(&quot;dbertman_(archive)&quot;, &quot;dbertman&quot;);
2544    RfaUsrMapH.AddDat(&quot;Agentsoo_(archive)&quot;, &quot;Agentsoo&quot;);
2545    RfaUsrMapH.AddDat(&quot;Guanaco3&quot;, &quot;Guanaco&quot;);
2546    RfaUsrMapH.AddDat(&quot;Brendenhull2&quot;, &quot;Brendenhull&quot;);
2547    RfaUsrMapH.AddDat(&quot;Xerocs2&quot;, &quot;Xerocs&quot;);
2548    RfaUsrMapH.AddDat(&quot;Wikiwoohoo2&quot;, &quot;Wikiwoohoo&quot;);
2549    RfaUsrMapH.AddDat(&quot;Folajimi2&quot;, &quot;Folajimi&quot;);
2550    RfaUsrMapH.AddDat(&quot;FuriousFreddy_r1&quot;, &quot;FuriousFreddy&quot;);
2551    RfaUsrMapH.AddDat(&quot;General_Eisenhower3&quot;, &quot;General_Eisenhower&quot;);
2552    RfaUsrMapH.AddDat(&quot;HolyRomanEmperor2&quot;, &quot;HolyRomanEmperor&quot;);
2553    RfaUsrMapH.AddDat(&quot;HolyRomanEmperor3&quot;, &quot;HolyRomanEmperor&quot;);
2554    RfaUsrMapH.AddDat(&quot;HolyRomanEmperor3a&quot;, &quot;HolyRomanEmperor&quot;);
2555    RfaUsrMapH.AddDat(&quot;Jet123_(2nd_nom)&quot;, &quot;Jet123&quot;);
2556    RfaUsrMapH.AddDat(&quot;Natl1_(2nd_nom)&quot;, &quot;Natl1&quot;);
2557    RfaUsrMapH.AddDat(&quot;NickCatal2&quot;, &quot;NickCatal&quot;);
2558    RfaUsrMapH.AddDat(&quot;P.B._Pilhet_2nd_Nomination&quot;, &quot;P.B._Pilhet&quot;);
2559    RfaUsrMapH.AddDat(&quot;Patchouli2&quot;, &quot;Patchouli&quot;);
2560    RfaUsrMapH.AddDat(&quot;Patchouli3&quot;, &quot;Patchouli&quot;);
2561    RfaUsrMapH.AddDat(&quot;The_Wookieepedian2&quot;, &quot;The_Wookieepedian&quot;);
2562    RfaUsrMapH.AddDat(&quot;Son_of_a_Peach_II&quot;, &quot;Son_of_a_Peach&quot;);
2563    RfaUsrMapH.AddDat(&quot;SVera1NY_(second_nomination)&quot;, &quot;SVera1NY&quot;);
2564    RfaUsrMapH.AddDat(&quot;Tellyaddict2&quot;, &quot;Tellyaddict&quot;);
2565    RfaUsrMapH.AddDat(&quot;Tenebrae2&quot;, &quot;Tenebrae&quot;);
2566    RfaUsrMapH.AddDat(&quot;Poccil2&quot;, &quot;Poccil&quot;);
2567    RfaUsrMapH.AddDat(&quot;Purplefeltangel2&quot;, &quot;Purplefeltangel&quot;);
2568    RfaUsrMapH.AddDat(&quot;Ramsquire2&quot;, &quot;Ramsquire&quot;);
2569    RfaUsrMapH.AddDat(&quot;ScienceApologist2&quot;, &quot;ScienceApologist&quot;);
2570    RfaUsrMapH.AddDat(&quot;Jor2&quot;, &quot;Jor&quot;);
2571    for (int e = 0; e &lt; Len(); e++) {
2572      TWikiElec&amp; E = GetElec(e);
2573      if (E.IsSucc()) { continue; }
2574      TChA Rfa = E.RfaTitle;
2575      const int l = Rfa.Len();
2576      TChA User;
2577      if (l&gt;2 &amp;&amp; Rfa[l-2]==&#x27;_&#x27; &amp;&amp; TCh::IsNum(Rfa[l-1])) { User = Rfa.GetSubStr(0, l-3); } 
2578      else if (Rfa.IsSuffix(&quot;.08&quot;) || Rfa.IsSuffix(&quot;.09&quot;) || Rfa.IsSuffix(&quot;.10&quot;)) { User = Rfa.GetSubStr(0, l-4); }
2579      else if (Rfa.IsSuffix(&quot;_(renomination)&quot;)) { User = Rfa.GetSubStr(0, l-(int)strlen(&quot;_(renomination)&quot;)-1); }
2580      else if (Rfa.IsSuffix(&quot;_(2)&quot;)) { User = Rfa.GetSubStr(0, l-5); }
2581      else if (Rfa.IsSuffix(&quot;_(2nd)&quot;)) { User = Rfa.GetSubStr(0, l-7); }
2582      else if (Rfa.IsSuffix(&quot;_(2nd_nomination)&quot;)) { User = Rfa.GetSubStr(0, l-(int)strlen(&quot;_(2nd_nomination)&quot;)-1); }
2583      else if (RfaUsrMapH.IsKey(Rfa)) { User = RfaUsrMapH.GetDat(Rfa); }
2584      else { continue; }
2585      User.ToLc();
2586      printf(&quot;%20s\t-&gt;\t%s\n&quot;, Rfa.CStr(), User.CStr());
2587      E.UsrId = AddUsr(User.CStr());
2588    }
2589  }
2590  void TWikiElecBs::Dump() const {
2591    int v=0, Sup=0, Opp=0, Neu=0;
2592    int VSup=0, VOpp=0, VNeu=0;
2593    for (int e=0; e&lt; Len(); e++) {
2594      v += GetElec(e).Len();
2595      TIntTr Votes = GetElec(e).GetVotes(false);
2596      Sup += Votes.Val1;  Neu += Votes.Val2;  Opp += Votes.Val3;
2597      Votes = GetElec(e).GetVotes(true);
2598      VSup += Votes.Val1;  VNeu += Votes.Val2;  VOpp += Votes.Val3;
2599    }
2600    printf(&quot;%5d users, %3d elections, %d all votes (%d/%d/%d)\n&quot;, UsrH.Len(), Len(), v, Sup, Opp, Neu);
2601    printf(&quot;                             %d all votes (%d/%d/%d)\n&quot;, VSup+VOpp+VNeu, VSup, VOpp, VNeu);
2602    TIntSet AdminSet, NAdminSet;
2603    TMom SupA, OppA, NeuA, SupNA, OppNA, NeuNA, ASupFrac, NASupFrac;
2604    TFltIntPrV AElecV, NAElecV;
2605    int nsucc=0;
2606    for (int e = 0; e &lt; Len(); e++) {
2607      const TWikiElec&amp; E = GetElec(e);
2608      const TIntTr V = E.GetVotes(true);
2609      double SupFrac = V.Val1+V.Val3&gt;0 ? V.Val1/double(V.Val1+V.Val3) : 0;
2610      if (V.Val1+V.Val3 == 0) { continue; }
2611      if (E.IsSucc) {
2612        AdminSet.AddKey(E.UsrId);
2613        SupA.Add(V.Val1());  NeuA.Add(V.Val2());  OppA.Add(V.Val3());
2614        AElecV.Add(TFltIntPr(SupFrac, e));
2615        ASupFrac.Add(SupFrac);
2616        nsucc++;
2617      } else {
2618        NAdminSet.AddKey(E.UsrId());
2619        SupNA.Add(V.Val1());  NeuNA.Add(V.Val2());  OppNA.Add(V.Val3());
2620        NAElecV.Add(TFltIntPr(SupFrac, e));
2621        NASupFrac.Add(SupFrac);
2622      }
2623    }
2624    printf(&quot;succ elecs %d\n&quot;, nsucc);
2625    SupA.Def(); OppA.Def(); NeuA.Def(); SupNA.Def(); OppNA.Def(); NeuNA.Def();
2626    ASupFrac.Def();  NASupFrac.Def();
2627    printf(&quot;succ elecs vs. failed elecs: %d admins. Votes:\n&quot;, AdminSet.Len());
2628    printf(&quot;  sup: %.1f : %.1f\n&quot;, SupA.GetMean(), SupNA.GetMean());
2629    printf(&quot;  neu:  %.1f : %.1f\n&quot;, NeuA.GetMean(), NeuNA.GetMean());
2630    printf(&quot;  fail: %.1f : %.1f\n&quot;, OppA.GetMean(), OppNA.GetMean());
2631    printf(&quot;  support fraction: %f : %f\n&quot;, ASupFrac.GetMean(), NASupFrac.GetMean());
2632    TInt ASup, AOpp, NASup, NAOpp, OSup, OOpp, AllSup, AllOpp; 
2633    TInt AEl, NAEl, OEl;
2634    TIntPrV TmV;
2635    for (int e = 0; e &lt; Len(); e++) {
2636      const TWikiElec&amp; E = GetElec(e);
2637      TWikiElec NewElec;  E.GetOnlyVotes(NewElec, true);
2638      bool IsA=false, IsNA=false, IsO=false;
2639      TmV.Add(TIntPr(E.GetTm().GetAbsSecs(), e));
2640      for (int v = 0; v &lt; NewElec.Len(); v++) {
2641        const int vote = NewElec[v].GetVote();
2642        const int uid = NewElec[v].GetUId();
2643        if (AdminSet.IsKey(uid)) {
2644          if (vote == 1) { ASup++; } else { AOpp++; }
2645          IsA=true; }
2646        else if (NAdminSet.IsKey(uid)) {
2647          if (vote == 1) { NASup++; } else { NAOpp++; }
2648          IsNA=true; }
2649        else {
2650          if (vote == 1) { OSup++; } else { OOpp++; }
2651          IsO=true; }
2652        if (vote == 1) { AllSup++; }
2653        if (vote == -1) { AllOpp++; }
2654      }
2655      if (IsA) { AEl++; }
2656      if (IsNA) { NAEl++; }
2657      if (IsO) { OEl++; }
2658    }
2659    TmV.Sort();
2660    printf(&quot;elections from:\t%s\n\t%s\n&quot;, TSecTm(TmV[0].Val1()).GetStr().CStr(), TSecTm(TmV.Last().Val1()).GetStr().CStr());
2661    for (int i = 0; i &lt;100; i++) { printf(&quot;%d\n&quot;, TmV[i].Val2); }
2662    for (int i = TmV.Len()-100; i &lt;TmV.Len(); i++) { printf(&quot;%d\n&quot;, TmV[i].Val2); }
2663    TIntV UsrV; GetUsrV(UsrV);
2664    printf(&quot;voters: %d\n&quot;, UsrV.Len());
2665    printf(&quot;votes by:\n&quot;);
2666    printf(&quot;  all:         %5d : %5d = %f    elecs: %d    users: %d\n&quot;, AllSup, AllOpp, AllSup/double(AllSup+AllOpp), Len(), UsrV.Len());
2667    printf(&quot;  admins:      %5d : %5d = %f    elecs: %d    users: %d\n&quot;, ASup, AOpp, ASup/double(ASup+AOpp), AEl, AdminSet.Len());
2668    printf(&quot;  non-admins:  %5d : %5d = %f    elecs: %d    users: %d\n&quot;, NASup, NAOpp, NASup/double(NASup+NAOpp), NAEl, NAdminSet.Len());
2669    printf(&quot;  others:      %5d : %5d = %f    elecs: %d    users: %d\n\n&quot;, OSup, OOpp, OSup/double(OSup+OOpp), OEl, UsrH.Len()-AdminSet.Len()-NAdminSet.Len());
2670  }
2671  void TWikiElecBs::SaveElecUserVotes(const TStr&amp; OutFNm) const {
2672    TIntSet USet;
2673    for (int e = 0; e &lt; Len(); e++) {
2674      const TWikiElec&amp; E = GetElec(e);
2675      if (E.Len() &lt; 10) { continue; }
2676      for (int v = 0; v &lt; E.Len(); v++) {
2677        USet.AddKey(E[v].GetUId()); }
2678    }
2679    FILE *F = fopen(OutFNm.CStr(), &quot;wt&quot;);
2680    fprintf(F, &quot;IsSucc&quot;);
2681    for (int u = 0; u &lt; USet.Len(); u++) {
2682      fprintf(F, &quot;\tu%d&quot;, USet[u]);
2683    }
2684    fprintf(F, &quot;\n&quot;);
2685    for (int e = 0; e &lt; Len(); e++) {
2686      const TWikiElec&amp; E = GetElec(e);
2687      if (E.Len() &lt; 10) { continue; }
2688      TIntSet Voters;
2689      for (int v = 0; v &lt; E.Len(); v++) {
2690        Voters.AddKey(E[v].GetUId()); }
2691      fprintf(F, &quot;%d&quot;, E.IsSucc?1:0);
2692      for (int u = 0; u &lt; USet.Len(); u++) {
2693        if (Voters.IsKey(USet[u])) { fprintf(F, &quot;\t1&quot;); }
2694        else { fprintf(F, &quot;\t0&quot;); }
2695      }
2696      fprintf(F, &quot;\n&quot;);
2697    }
2698    fclose(F);
2699  }
2700  void TWikiElecBs::SaveTxt(const TStr&amp; OutFNm) {
2701    SortVotesByTm();
2702    FILE *F = fopen(OutFNm.CStr(), &quot;wt&quot;);
2703    fprintf(F, &quot;# Wikipedia elections (http:&amp;bsol;&amp;bsol;cs.stanford.edu/people/jure/pubs/triads-chi10.pdf). Data format:\n&quot;);
2704    fprintf(F, &quot;#   E: is election succesful (1) or not (0)\n&quot;);
2705    fprintf(F, &quot;#   T: time election was closed\n&quot;);
2706    fprintf(F, &quot;#   U: user id (and username) of editor that is being considered for promotion\n&quot;);
2707    fprintf(F, &quot;#   N: user id (and username) of the nominator\n&quot;);
2708    fprintf(F, &quot;#   V: &lt;vote(1:support, 0:neutral, -1:oppose)&gt; &lt;user_id&gt; &lt;time&gt; &lt;username&gt;\n&quot;);
2709    for (int e = 0; e &lt; Len(); e++) {
2710      const TWikiElec&amp; E = GetElec(e);
2711      fprintf(F, &quot;E\t%d\n&quot;, E.IsSucc?1:0);
2712      fprintf(F, &quot;T\t%s\n&quot;, E.ElecTm.GetYmdTmStr().CStr());
2713      fprintf(F, &quot;U\t%d\t%s\n&quot;, E.UsrId, GetUsr(E.UsrId));
2714      fprintf(F, &quot;N\t%d\t%s\n&quot;, E.NomUId, E.NomUId==-1?&quot;UNKNOWN&quot;:GetUsr(E.NomUId));
2715      for (int v = 0; v &lt; E.Len(); v++) {
2716        if (! E[v].IsVote()) { continue; }
2717        fprintf(F, &quot;V\t%d\t%d\t%s\t%s\n&quot;, E[v].GetVote(), E[v].GetUId(), E[v].GetTm().GetYmdTmStr().CStr(), GetUsr(E[v].GetUId()));
2718      }
2719      fprintf(F, &quot;\n&quot;);
2720    }
2721    fclose(F);
2722  }
2723  void TWikiElecBs::SaveOnlyVotes() {
2724    TWikiElecBs NewElBs;
2725    GetOnlyVoteElecBs(NewElBs, true);
2726    NewElBs.SortVotesByTm();
2727    TStrSet RfaSet;
2728    for (int e = 0; e &lt; NewElBs.Len(); e++) {
2729      TWikiElec&amp; E = NewElBs.GetElec(e);
2730      if (RfaSet.IsKey(E.RfaTitle)) {
2731        for (int i = 2; ; i++) {
2732          TStr NewRfa = TStr::Fmt(&quot;%s_%d&quot;, E.RfaTitle.CStr(), i);
2733          if (! RfaSet.IsKey(NewRfa)) {
2734            printf(&quot;  %s --&gt; %s\n&quot;, E.RfaTitle.CStr(), NewRfa.CStr());
2735            E.RfaTitle= NewRfa;
2736            break;
2737          }
2738        }
2739      }
2740      RfaSet.AddKey(E.RfaTitle);
2741    }
2742    NewElBs.Save(TZipOut(&quot;wikiElec-Votes.ElecBs3.rar&quot;));
2743  }
2744  bool TWikiElecBs::GetUsrTm(char* LineStr, TChA&amp; Usr, TSecTm&amp; Tm, int&amp; Indent) {
2745    TChA TmpLine=LineStr;
2746    TChA SearchStr = &quot;[[user:&quot;;
2747    char *UsrId = NULL;
2748    for (char *next=LineStr; next=strstr(next, SearchStr.CStr()); ) {
2749      UsrId=next; next++; }
2750    if (UsrId == NULL) {
2751      SearchStr = &quot;[[user talk:&quot;;
2752      for (char *next=LineStr; next=strstr(next, SearchStr.CStr()); ) {
2753        UsrId=next; next++; }
2754    }
2755    if (UsrId == NULL) {
2756      SearchStr = &quot;[[user_talk:&quot;;
2757      for (char *next=LineStr; next=strstr(next, SearchStr.CStr()); ) {
2758        UsrId=next; next++; }
2759    }
2760    if (UsrId == NULL) {
2761      return false;
2762    }
2763    UsrId += SearchStr.Len();
2764    while (*UsrId &amp;&amp; TCh::IsWs(*UsrId)) { UsrId++; }
2765    char *c = UsrId;
2766    while (*c &amp;&amp; *c!=&#x27;|&#x27; &amp;&amp; *c!=&#x27;]&#x27; &amp;&amp; *c!=&#x27;/&#x27; &amp;&amp; *c!=&#x27;#&#x27; &amp;&amp; *c!=&#x27; &#x27; &amp;&amp; *c!=&#x27;&amp;&#x27;) {
2767      if (*c==&#x27; &#x27;) { *c=&#x27;_&#x27;; }
2768      c++;
2769    }
2770    *c = 0; c++;
2771    Usr = UsrId;  Usr.ToLc();
2772    char *utc = strstr(c, &quot; (utc)&quot;);
2773    if (utc == NULL) { return false; }
2774    while (strstr(utc+1, &quot;(utc)&quot;)!=NULL) { utc = strstr(utc+1, &quot;(utc)&quot;); }
2775    *utc = 0; utc--;
2776    int FldCnt=0;
2777    char *e = utc;
2778    while (e&gt;c &amp;&amp; (*e==&#x27; &#x27; || *e==&#x27;-&#x27; || *e==&#x27;,&#x27;)) { e--; }
2779    while(e&gt;c) {
2780      while (e&gt;c &amp;&amp; ! (*e==&#x27; &#x27; || *e==&#x27;-&#x27; || *e==&#x27;,&#x27;)) { e--; }
2781      if (++FldCnt==4) { break; }
2782      while (e&gt;c &amp;&amp; (*e==&#x27; &#x27; || *e==&#x27;-&#x27; || *e==&#x27;,&#x27;)) { e--; }
2783    }
2784    e += 1;
2785    if (! TStrUtil::GetTmFromStr(e, Tm)) {
2786      return false; }
2787    Indent=0;
2788    for (char *ch=LineStr; *ch &amp;&amp; ! TCh::IsAlNum(*ch); ch++) {
2789      if (*ch == &#x27;:&#x27; || *ch == &#x27;*&#x27;) { Indent++; }
2790    }
2791    return true;
2792  }
2793  TWikiMetaLoader::TWikiMetaLoader(const TStr&amp; InFNm) {
2794    if (TZipIn::IsZipExt(InFNm.GetFExt())) { SInPt = TZipIn::New(InFNm); }
2795    else if (! InFNm.Empty()) { SInPt = TFIn::New(InFNm); }
2796    else { SInPt = TStdIn::New(); } 
2797  }
2798  bool TWikiMetaLoader::IsIpAddrUsr() const {
2799    return IsIpAddr(Usr);
2800  }
2801  bool TWikiMetaLoader::Next() {
2802    TSIn&amp; SIn = *SInPt;
2803    static TChA LnStr;
2804    for (int rec=0; SIn.GetNextLn(LnStr); rec++) {
2805      if (! LnStr.IsPrefix(&quot;REVISION &quot;)) {
2806        continue;
2807      }
2808      TChA Tmp = LnStr;
2809      TVec&lt;char *&gt; FldV; TStrUtil::SplitWords(Tmp, FldV);
2810      if (FldV.Len() != 7) {
2811        continue;
2812      }
2813      IAssert(FldV.Len() == 7);
2814      ArticleId = atoi(FldV[1]);
2815      RevisionId = atoi(FldV[2]);
2816      Title = FldV[3];
2817      RevTm = TSecTm::GetDtTmFromStr(FldV[4]);
2818      Usr = FldV[5];  Usr.ToLc();  Usr.ChangeCh(&#x27; &#x27;, &#x27;_&#x27;);  
2819      UsrId = atoi(FldV[6]);
2820      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;CATEGORY&quot;));
2821      CatStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2822      IAssert(SIn.GetNextLn(LnStr)); IAssert(LnStr.IsPrefix(&quot;IMAGE&quot;));
2823      ImgStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2824      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;MAIN&quot;));
2825      MainLStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2826      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;TALK&quot;));
2827      TalkLStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2828      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;USER&quot;));
2829      UserLStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2830      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;USER_TALK&quot;));
2831      UserTalkLStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2832      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;OTHER&quot;));
2833      OtherLStr =  LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2834      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;EXTERNAL&quot;));
2835      ExternalLStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2836      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;TEMPLATE&quot;));
2837      TemplateStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2838      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;COMMENT&quot;));
2839      CommentStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2840      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;MINOR&quot;));
2841      MonorEdit = LnStr[LnStr.SearchCh(&#x27; &#x27;)+1] == &#x27;1&#x27;;
2842      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;TEXTDATA&quot;));
2843      RevWrds = atoi(LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx).CStr());
2844      return true;
2845    }
2846    return false;
2847  }
2848  bool TWikiMetaLoader::IsIpAddr(const TChA&amp; Usr) {
2849    if (Usr.IsPrefix(&quot;ip:&quot;)) { return true; }
2850    int i = 0, Len=Usr.Len();
2851    while (i&lt;Len &amp;&amp; TCh::IsNum(Usr[i])) { i++; }
2852    if (! (i&lt;Len &amp;&amp; Usr[i]==&#x27;.&#x27;)) { return false; }
2853    i++;
2854    while (i&lt;Len &amp;&amp; TCh::IsNum(Usr[i])) { i++; }
2855    if (! (i&lt;Len &amp;&amp; Usr[i]==&#x27;.&#x27;)) { return false; }
2856    i++;
2857    while (i&lt;Len &amp;&amp; TCh::IsNum(Usr[i])) { i++; }
2858    if (i==Len) { return true; }
2859    return false;
2860  }
2861  TWikiMetaHist::TWikiMetaHist(const TStr&amp; InFNm) : SInPt(TZipIn::IsZipFNm(InFNm) ? TZipIn::New(InFNm) : TFIn::New(InFNm)), XmlInPt(TXmlParser::New(SInPt)), PageCnt(0) {
2862    printf(&quot;Init from %s\n skip till &lt;page&gt;...&quot;, InFNm.CStr());
2863    XmlInPt-&gt;SkipTillTag(&quot;page&quot;);
2864    printf(&quot;done\n&quot;);
2865  }
2866  TWikiMetaHist::TWikiMetaHist(const PSIn&amp; SIn) : SInPt(SIn), XmlInPt() {
2867  }
2868  void TWikiMetaHist::Save(TSOut&amp; SOut) const {
2869    SOut.Save(PageId);
2870    SOut.Save(RevId);
2871    SOut.Save(UsrId);
2872    RevTm.Save(SOut);
2873    Usr.Save(SOut);
2874    Cmt.Save(SOut);
2875    Title.Save(SOut);
2876    Text.Save(SOut);
2877  }
2878  void TWikiMetaHist::Clr() {
2879    PageId = RevId = UsrId = -1;
2880    RevTm = TSecTm();
2881    Usr.Clr();  Cmt.Clr();
2882    Title.Clr();  Text.Clr();  Tmp.Clr();
2883  }
2884  bool TWikiMetaHist::LoadNextBin() {
2885    TSIn&amp; SIn = *SInPt;
2886    if (SIn.Eof()) { Clr(); return false; }
2887    SIn.Load(PageId);
2888    SIn.Load(RevId);
2889    SIn.Load(UsrId);
2890    RevTm.Load(SIn);
2891    Usr.Load(SIn);
2892    Cmt.Load(SIn);
2893    Title.Load(SIn);
2894    Text.Load(SIn);
2895    for (int i = 0; i &lt; Usr.Len(); i++) {
2896      if (Usr[i]==&#x27; &#x27;) { Usr[i]=&#x27;_&#x27;; }
2897    }
2898    for (int i = 0; i &lt; Title.Len(); i++) {
2899      if (Title[i]==&#x27; &#x27;) { Title[i]=&#x27;_&#x27;; }
2900    }
2901    return true;
2902  }
2903  bool TWikiMetaHist::LoadNextTxt() {
2904    IAssert(! XmlInPt.Empty());
2905    TXmlParser&amp; XmlIn = *XmlInPt;
2906    while (! (XmlIn.Sym == xsySTag &amp;&amp; (XmlIn.SymStr == &quot;page&quot; || XmlIn.SymStr == &quot;revision&quot;))) {
2907      XmlIn.GetSym();
2908      if (XmlIn.Sym == xsyEof) { return false; }
2909    }
2910    if (XmlIn.SymStr == &quot;page&quot;) {
2911      XmlIn.GetTagVal(&quot;title&quot;, Title);
2912      XmlIn.GetTagVal(&quot;id&quot;, Tmp);
2913      PageId = atoi(Tmp.CStr());
2914      XmlIn.GetSym();
2915      if (XmlIn.SymStr != &quot;revision&quot;) {
2916        while (XmlIn.SymStr != &quot;revision&quot;) { printf(&quot;NEW_TAG:  %s\n&quot;, XmlIn.SymStr.CStr()); XmlIn.GetSym(); }
2917      }
2918    }
2919    EAssertR(XmlIn.SymStr == &quot;revision&quot;, XmlIn.SymStr); 
2920    XmlIn.GetTagVal(&quot;id&quot;, Tmp);
2921    RevId = atoi(Tmp.CStr());          
2922    XmlIn.GetTagVal(&quot;timestamp&quot;, Tmp); 
2923    Tmp[4]=0; Tmp[7]=0; Tmp[10]=0; Tmp[13]=0; Tmp[16]=0; Tmp[19]=0;
2924    RevTm = TSecTm(atoi(Tmp.CStr()), atoi(Tmp.CStr()+5), atoi(Tmp.CStr()+8),
2925      atoi(Tmp.CStr()+11), atoi(Tmp.CStr()+14), atoi(Tmp.CStr()+17));
2926    EAssert(XmlIn.GetTag(&quot;contributor&quot;) == xsySTag);
2927    XmlIn.GetSym();
2928    if (XmlIn.SymStr == &quot;ip&quot; &amp;&amp; XmlIn.Sym==xsySTag) {
2929      XmlIn.GetSym();  Usr=&quot;ip:&quot;; Usr+=XmlIn.SymStr;
2930      XmlIn.GetTag(&quot;ip&quot;);  IAssert(! XmlIn.SymStr.IsPrefix(&quot;ip:&quot;)); }
2931    else if (XmlIn.SymStr == &quot;username&quot;) {
2932      if (XmlIn.Sym == xsySTag) { XmlIn.GetSym(); Usr=XmlIn.SymStr;  EAssert(XmlIn.GetTag(&quot;username&quot;) == xsyETag); } 
2933      else { EAssert(XmlIn.Sym == xsyETag &amp;&amp; XmlIn.SymStr == &quot;username&quot;); } 
2934      XmlIn.GetTagVal(&quot;id&quot;, Tmp);  UsrId = atoi(Tmp.CStr());
2935    }
2936    for (int i = 0; i &lt; Usr.Len(); i++) {
2937      if (Usr[i]==&#x27; &#x27;) { Usr[i]=&#x27;_&#x27;; }
2938    }
2939    EAssert(XmlIn.GetTag(&quot;contributor&quot;) == xsyETag);
2940    XmlIn.GetSym();
2941    if (XmlIn.Sym == xsyETag &amp;&amp; XmlIn.SymStr == &quot;minor&quot;) { XmlIn.GetSym(); }
2942    if (XmlIn.Sym == xsySTag &amp;&amp; XmlIn.SymStr == &quot;comment&quot;) {
2943      XmlIn.GetSym();
2944      if (XmlIn.Sym == xsyStr) { Cmt=XmlIn.SymStr;  EAssert(XmlIn.GetTag(&quot;comment&quot;) == xsyETag); } 
2945      else { EAssert(XmlIn.Sym == xsyETag &amp;&amp; XmlIn.SymStr == &quot;comment&quot;); } 
2946      XmlIn.GetSym();
2947    }
2948    EAssertR(XmlIn.SymStr.IsPrefix(&quot;text&quot;), XmlIn.SymStr);
2949    if (XmlIn.Sym == xsySTag) {
2950      XmlIn.GetSym(Text);
2951      if (XmlIn.Sym == xsyStr) { EAssert(XmlIn.GetTag(&quot;text&quot;) == xsyETag); } 
2952      else { EAssert(XmlIn.Sym == xsyETag &amp;&amp; XmlIn.SymStr == &quot;text&quot;); } 
2953    }
2954    EAssert(XmlIn.GetTag(&quot;revision&quot;) == xsyETag);
2955    if (++PageCnt % 10000 == 0) {
2956      printf(&quot;** %dk items: %s time %f\n&quot;, PageCnt/1000, ExeTm.GetStr(), ExeTm.GetSecs()); fflush(stdout); }
2957    return true;
2958  }
2959  void TWikiMetaHist::Dump(const bool&amp; AlsoText) const {
2960    printf(&quot;page: %d %s\n&quot;, PageId, Title.CStr());
2961    printf(&quot;rev:  %d %s\n&quot;, RevId, RevTm.GetYmdTmStr().CStr());
2962    printf(&quot;user: %d %s\n&quot;, UsrId, Usr.CStr());
2963    printf(&quot;cmt:  %s\n&quot;, Cmt.CStr());
2964    if (AlsoText) { printf(&quot;text:\n%s\n&quot;, Text.CStr()); }
2965    printf(&quot;\n&quot;);
2966  }
2967  void TWikiMetaHist::DumpNextXmlTags(const int&amp; DumpN) {
2968    TXmlParser&amp; XmlIn = *XmlInPt;
2969    for (int i = 0; i &lt; DumpN; i++) {
2970      printf(&quot;%s\n&quot;, XmlIn.SymStr.CStr());
2971      XmlIn.GetSym();
2972      if (XmlIn.Sym == xsyEof) { return; }
2973    }
2974  }
</code></pre>
        </div>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-wikinet.cpp</h3>
            <pre><code>1  #include &quot;stdafx.h&quot;
2  #include &quot;wikinet.h&quot;
3  #include &quot;trawling.h&quot;
4  TWikiUsr::TWikiUsr() : Usr(), Admin(false), ElecTm(), BarnStars(), MnEdCnt(), MnEdWrds(), MnTkEdCnt(), MnTkEdWrds(),
5    WkEdCnt(), WkEdWrds(), WkTkEdCnt(), WkTkEdWrds(), MnRevCnt(), MnRevWrds() {
6  }
7  TWikiUsr::TWikiUsr(const TChA&amp; UsrStr) : Usr(UsrStr), Admin(false), ElecTm(), BarnStars(), MnEdCnt(), MnEdWrds(),
8    MnTkEdCnt(), MnTkEdWrds(), WkEdCnt(), WkEdWrds(), WkTkEdCnt(), WkTkEdWrds(), MnRevCnt(), MnRevWrds() {
9  }
10  TWikiUsr::TWikiUsr(const TWikiUsr&amp; WikiUsr) : Usr(WikiUsr.Usr), Admin(WikiUsr.Admin), ElecTm(WikiUsr.ElecTm),
11    BarnStars(WikiUsr.BarnStars), MnEdCnt(WikiUsr.MnEdCnt), MnEdWrds(WikiUsr.MnEdWrds),
12    MnTkEdCnt(WikiUsr.MnTkEdCnt), MnTkEdWrds(WikiUsr.MnTkEdWrds), WkEdCnt(WikiUsr.WkEdCnt),
13    WkEdWrds(WikiUsr.WkEdWrds), WkTkEdCnt(WikiUsr.WkTkEdCnt), WkTkEdWrds(WikiUsr.WkTkEdWrds),
14    MnRevCnt(WikiUsr.MnRevCnt), MnRevWrds(WikiUsr.MnRevCnt) {
15  }
16  TWikiUsr::TWikiUsr(TSIn&amp; SIn) : Usr(SIn), Admin(SIn), ElecTm(SIn), BarnStars(SIn), MnEdCnt(SIn),
17    MnEdWrds(SIn), MnTkEdCnt(SIn), MnTkEdWrds(SIn), WkEdCnt(SIn), WkEdWrds(SIn), WkTkEdCnt(SIn), WkTkEdWrds(SIn)
18    , MnRevCnt(SIn), MnRevWrds(SIn)
19  {
20  }
21  void TWikiUsr::Save(TSOut&amp; SOut) const {
22    Usr.Save(SOut);  Admin.Save(SOut);  ElecTm.Save(SOut);
23    BarnStars.Save(SOut);  MnEdCnt.Save(SOut);  MnEdWrds.Save(SOut);
24    MnTkEdCnt.Save(SOut);  MnTkEdWrds.Save(SOut);  WkEdCnt.Save(SOut);  WkEdWrds.Save(SOut);
25    WkTkEdCnt.Save(SOut);  WkTkEdWrds.Save(SOut);
26    MnRevCnt.Save(SOut);   MnRevWrds.Save(SOut);
27  }
28  TWikiTalkEdge::TWikiTalkEdge() : TotTalks(), TotWords(), TalksBE(), WordsBE(), TalksAE(), WordsAE(), VoteSign(0), FirstTalk(), LastTalk(), VoteTm() {
29  }
30  TWikiTalkEdge::TWikiTalkEdge(const int&amp; _VoteSign) : TotTalks(), TotWords(), TalksBE(), WordsBE(), TalksAE(), WordsAE(),
31    VoteSign(_VoteSign), FirstTalk(), LastTalk(), VoteTm() {
32  }
33  TWikiTalkEdge::TWikiTalkEdge(const TSecTm&amp; FTalk, const TSecTm&amp; LTalk, const int&amp; NTalks, const int&amp; NWords) :
34    TotTalks(NTalks), TotWords(NWords), TalksBE(), WordsBE(), TalksAE(), WordsAE(), VoteSign(0), FirstTalk(FTalk), LastTalk(LTalk), VoteTm() {
35  }
36  TWikiTalkEdge::TWikiTalkEdge(const TWikiTalkEdge&amp; Talk) : TotTalks(Talk.TotTalks), TotWords(Talk.TotWords),
37    TalksBE(Talk.TalksBE), WordsBE(Talk.WordsBE), TalksAE(Talk.TalksAE), WordsAE(Talk.WordsAE),
38    VoteSign(Talk.VoteSign), FirstTalk(Talk.FirstTalk), LastTalk(Talk.LastTalk), VoteTm(Talk.VoteTm) {
39  }
40  TWikiTalkEdge::TWikiTalkEdge(TSIn&amp; SIn) : TotTalks(SIn), TotWords(SIn), TalksBE(SIn), WordsBE(SIn),
41    TalksAE(SIn), WordsAE(SIn), VoteSign(SIn), FirstTalk(SIn), LastTalk(SIn), VoteTm(SIn) {
42  }
43  void TWikiTalkEdge::Save(TSOut&amp; SOut) const {
44    TotTalks.Save(SOut);  TotWords.Save(SOut);
45    TalksBE.Save(SOut);   WordsBE.Save(SOut);
46    TalksAE.Save(SOut);   WordsAE.Save(SOut);
47    VoteSign.Save(SOut);  FirstTalk.Save(SOut);
48    LastTalk.Save(SOut);  VoteTm.Save(SOut);
49  }
50  int TWikiTalkNet::GetUsrNId(const TStr&amp; UsrStr) const {
51    const int KeyId = UsrNIdH.GetKeyId(UsrStr);
52    if (KeyId==-1) { return -1; }
53    else { return UsrNIdH[KeyId]; }
54  }
55  bool TWikiTalkNet::IsUsr(const TStr&amp; UsrStr) const {
56    return UsrNIdH.IsKey(UsrStr);
57  }
58  void TWikiTalkNet::PermuteAllVoteSigns(const bool&amp; OnlyVotes) {
59    printf(&quot;\nPermuting %s edge signs\n&quot;, OnlyVotes?&quot;VOTE&quot;:&quot;ALL&quot;);
60    TVec&lt;TWikiTalkEdge&gt; EDatV;
61    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
62      if (OnlyVotes &amp;&amp; EI().GetVote() != 0) { EDatV.Add(EI()); }
63      else if (! OnlyVotes){ EDatV.Add(EI()); }
64    }
65    EDatV.Shuffle(TInt::Rnd);
66    int cnt = 0;
67    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
68      if (OnlyVotes &amp;&amp; EI().GetVote() != 0) { EI() = EDatV[cnt++]; }
69      else if (! OnlyVotes){ EI() = EDatV[cnt++]; }
70    }
71  }
72  void TWikiTalkNet::PermuteOutVoteSigns(const bool&amp; OnlyVotes) {
73    TIntV VoteSignV;
74    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
75      for (int e = 0; e &lt; NI.GetOutDeg(); e++) {
76        if (OnlyVotes &amp;&amp; NI.GetOutEDat(e).GetVote() != 0) {
77          VoteSignV.Add(NI.GetOutEDat(e).GetVote()); }
78        else if (! OnlyVotes) {
79          VoteSignV.Add(NI.GetOutEDat(e).GetVote()); }
80      }
81    }
82    VoteSignV.Shuffle(TInt::Rnd);
83    int cnt = 0;
84    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
85      for (int e = 0; e &lt; NI.GetOutDeg(); e++) {
86        if (OnlyVotes &amp;&amp; NI.GetOutEDat(e).GetVote() != 0) {
87          NI.GetOutEDat(e).VoteSign = VoteSignV[cnt++]; }
88        else if (! OnlyVotes) {
89          NI.GetOutEDat(e).VoteSign = VoteSignV[cnt++]; }
90      }
91    }
92  }
93  void TWikiTalkNet::CountStructBalance() const {
94    TIntSet NbrIdSet;
95    THash&lt;TIntTr, TInt&gt; TriadCntH;
96    TIntH SignH;
97    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
98      SignH.AddDat(EI().VoteSign()) += 1;
99    }
100    printf(&quot;Structural balance triads:\n  background sign distribution:\n&quot;);
101    SignH.SortByKey(false);
102    for (int i = 0; i &lt; SignH.Len(); i++) {
103      printf(&quot;\t%2d\t%d\n&quot;, SignH.GetKey(i), SignH[i]);
104    }
105    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
106      const TNodeI SrcNI = GetNI(EI.GetSrcNId());
107      const TNodeI DstNI = GetNI(EI.GetDstNId());
108      const TInt E1Dat = EI().VoteSign();
109      NbrIdSet.Clr(false);
110      for (int es = 0; es &lt; SrcNI.GetDeg(); es++) {
111        NbrIdSet.AddKey(SrcNI.GetNbrNId(es)); }
112      for (int ed = 0; ed &lt; DstNI.GetDeg(); ed++) {
113        const int nbr = DstNI.GetNbrNId(ed);
114        if (! NbrIdSet.IsKey(nbr)) { continue; }
115        const TInt E2Dat = SrcNI.GetNbrEDat(NbrIdSet.GetKeyId(nbr)).VoteSign();
116        const TInt E3Dat = DstNI.GetNbrEDat(ed).VoteSign();
117        TriadCntH.AddDat(TIntTr(TMath::Mx(E1Dat, E2Dat, E3Dat),
118          TMath::Median(E1Dat, E2Dat, E3Dat), TMath::Mn(E1Dat, E2Dat, E3Dat))) += 1;
119      }
120    }
121    TriadCntH.SortByKey(false);
122    printf(&quot;triad counts (all counts times 3):\n&quot;);
123    int SumTriad = 0, SignTriad=0;
124    for (int i = 0; i &lt; TriadCntH.Len(); i++) {
125      SumTriad += TriadCntH[i];
126      TIntTr SignTr = TriadCntH.GetKey(i);
127      if (SignTr.Val1!=0 &amp;&amp; SignTr.Val2!=0 &amp;&amp; SignTr.Val3!=0) {
128        SignTriad += TriadCntH[i];; }
129    }
130    for (int i = 0; i &lt; TriadCntH.Len(); i++) {
131      TIntTr SignTr = TriadCntH.GetKey(i);
132      printf(&quot;\t%2d %2d %2d\t%8d\t%f&quot;, SignTr.Val1, SignTr.Val2, SignTr.Val3,
133        TriadCntH[i], TriadCntH[i]/double(SumTriad));
134      if (SignTr.Val1!=0 &amp;&amp; SignTr.Val2!=0 &amp;&amp; SignTr.Val3!=0) {
135        printf(&quot;\t%f&quot;, TriadCntH[i]/double(SignTriad)); }
136      printf(&quot;\n&quot;);
137    }
138  }
139  void TWikiTalkNet::FindPartitions(const int&amp; NPart, const bool&amp; OnlyMinus) const {
140    printf(&quot;\nFind %d partitions use %s edges\n&quot;, NPart, OnlyMinus?&quot;NEGATIVE&quot;:&quot;ALL&quot;);
141    TIntV NIdV(GetNodes(), 0);
142    TIntH NIdPartH;
143    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
144      NIdPartH.AddDat(NI.GetId(), TInt::Rnd.GetUniDevInt(NPart));
145      NIdV.Add(NI.GetId());
146    }
147    int Flips = 0;
148    TIntPrV CntPartV;
149    for (int p = 0; p &lt; NPart; p++) {
150      CntPartV.Add(TIntPr(0, p)); }
151    for (int iter = 0; iter &lt; 100; iter++) {
152      NIdV.Shuffle(TInt::Rnd);
153      Flips = 0;
154      for (int n = 0; n &lt; NIdV.Len(); n++) {
155        TNodeI NI = GetNI(NIdV[n]);
156        for (int p = 0; p &lt; NPart; p++) {
157          CntPartV[p].Val1=0;  CntPartV[p].Val2=p; }
158        for (int e = 0; e &lt; NI.GetOutDeg(); e++) {
159          const int DstPart = NIdPartH.GetDat(NI.GetOutNId(e));
160          const int Vote = NI.GetOutEDat(e).GetVote();
161          if (OnlyMinus &amp;&amp; Vote==-1) { CntPartV[DstPart].Val1 += -1; }
162          else if (! OnlyMinus) { CntPartV[DstPart].Val1 += Vote; }
163        }
164        CntPartV.Sort(false); 
165        const int NewPart = CntPartV[0].Val2;
166        if (NIdPartH.GetDat(NI.GetId()) != NewPart) {
167          NIdPartH.AddDat(NI.GetId(), NewPart);
168          Flips++;
169        }
170      }
171    }
172    int OkMns=0, OkPls=0, AllMns=0, AllPls=0;
173    TIntH OkPlsH, AllPlsH, OkMnsH, AllMnsH;
174    for (int p = 0; p &lt; NPart; p++) {
175      OkPlsH.AddDat(p,0); AllPlsH.AddDat(p,0);
176      OkMnsH.AddDat(p,0); AllMnsH.AddDat(p,0);
177    }
178    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
179      const int SrcPart = NIdPartH.GetDat(NI.GetId());
180      for (int e = 0; e &lt; NI.GetOutDeg(); e++) {
181        const int DstPart = NIdPartH.GetDat(NI.GetOutNId(e));
182        const int Vote = NI.GetOutEDat(e).GetVote();
183        if (Vote == -1) {
184          if (DstPart != SrcPart) { OkMnsH.AddDat(SrcPart) += 1;  OkMns++; }
185          AllMnsH.AddDat(SrcPart) += 1;  AllMns++; }
186        if (Vote == +1) {
187          if (DstPart == SrcPart) { OkPlsH.AddDat(SrcPart) += 1;  OkPls++; }
188          AllPlsH.AddDat(SrcPart) += 1;  AllPls++;
189        }
190      }
191    }
192    printf(&quot;\nSatisfied edges: + : %5d / %5d  = %f\n&quot;, OkPls, AllPls, double(OkPls)/double(AllPls));
193    printf(  &quot;                 - : %5d / %5d  = %f\n&quot;, OkMns, AllMns, double(OkMns)/double(AllMns));
194    TIntH PartCntH;
195    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
196      PartCntH.AddDat(NIdPartH.GetDat(NI.GetId())) += 1; }
197    PartCntH.SortByKey();
198    for (int p = 0; p &lt; PartCntH.Len(); p++) {
199      printf(&quot;  part %2d : %5d (%.4f) nodes: +: %25s    -: %25s\n&quot;, p, PartCntH[p], PartCntH[p]/double(NIdPartH.Len()),
200        TStr::Fmt(&quot;%5d/%d=%.4f&quot;, OkPlsH.GetDat(PartCntH.GetKey(p)), AllPlsH.GetDat(PartCntH.GetKey(p)), OkPlsH.GetDat(PartCntH.GetKey(p))/double(AllPlsH.GetDat(PartCntH.GetKey(p)))).CStr(),
201        TStr::Fmt(&quot;%5d/%d=%.4f&quot;, OkMnsH.GetDat(PartCntH.GetKey(p)), AllMnsH.GetDat(PartCntH.GetKey(p)), OkMnsH.GetDat(PartCntH.GetKey(p))/double(AllMnsH.GetDat(PartCntH.GetKey(p)))).CStr() );
202    }
203  }
204  void TWikiTalkNet::GetPartStat(const TVec&lt;TIntV&gt;&amp; PartNIdV) const {
205    THash&lt;TIntPr, TIntPr&gt; PartEdgeH;
206    TIntH NIdPartH;
207    for (int p = 0; p &lt; PartNIdV.Len(); p++) {
208      for (int n = 0; n &lt; PartNIdV[p].Len(); n++) {
209        NIdPartH.AddDat(PartNIdV[p][n], p);
210      }
211    }
212    TInt DstPart;
213    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
214      if (! NIdPartH.IsKey(NI.GetId())) { continue; }
215      const int p = NIdPartH.GetDat(NI.GetId());
216      for (int e = 0; e &lt; NI.GetOutDeg(); e++) {
217        const int Vote = NI.GetOutEDat(e).GetVote();
218        TIntPr&amp; IOCnt = PartEdgeH.AddDat(TIntPr(p, Vote));
219        if (NIdPartH.IsKeyGetDat(NI.GetOutNId(e), DstPart) &amp;&amp; DstPart==p) {
220          if (Vote==1) { IOCnt.Val1++; } else { IOCnt.Val2++; } }
221        else {
222          if (Vote==-1) { IOCnt.Val1++; } else { IOCnt.Val2++; } }
223      }
224    }
225    PartEdgeH.SortByKey();
226    printf(&quot;Partition statistics (satisfied edges):\n&quot;);
227    for (int p = 0; p &lt; PartEdgeH.Len(); p++) {
228      printf(&quot;  %2d  %2d : %6d : %6d  =  %f\n&quot;, PartEdgeH.GetKey(p).Val1, PartEdgeH.GetKey(p).Val2,
229        PartEdgeH[p].Val1(), PartEdgeH[p].Val2(), PartEdgeH[p].Val1/double(PartEdgeH[p].Val1+PartEdgeH[p].Val2));
230    }
231  }
232  PWikiTalkNet TWikiTalkNet::GetVoteSubNet(const int&amp; VoteSign, const bool&amp; VoteOnly, const bool&amp; TalkOnly) const {
233    PWikiTalkNet Net = TWikiTalkNet::New();
234    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
235      if (! (EI().GetVote()==VoteSign || (VoteSign==11 &amp;&amp; EI().GetVote()!=0))) { continue; }
236      if (VoteOnly &amp;&amp; ! EI().IsVoteE()) { continue; }
237      if (TalkOnly &amp;&amp; ! EI().IsTalkE()) { continue; }
238      if (! Net-&gt;IsNode(EI.GetSrcNId())) {
239        Net-&gt;UsrNIdH.AddDat(EI.GetSrcNDat().Usr, EI.GetSrcNId());
240        Net-&gt;AddNode(EI.GetSrcNId(), EI.GetSrcNDat());
241      }
242      if (! Net-&gt;IsNode(EI.GetDstNId())) {
243        Net-&gt;UsrNIdH.AddDat(EI.GetDstNDat().Usr, EI.GetDstNId());
244        Net-&gt;AddNode(EI.GetDstNId(), EI.GetDstNDat());
245      }
246      Net-&gt;AddEdge(EI);
247    }
248    TSnap::PrintInfo(Net, TStr::Fmt(&quot;Vote network: sign %d %s %s&quot;,
249      VoteSign, VoteOnly?&quot;OnlyVote&quot;:&quot;&quot;, TalkOnly?&quot;OnlyTalk&quot;:&quot;&quot;));
250    return Net;
251  }
252  PSignNet TWikiTalkNet::GetSignNet(const int&amp; VoteSign, const bool&amp; VoteOnly, const bool&amp; TalkOnly) const {
253    PSignNet Net = TSignNet::New();
254    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
255      if (EI.GetSrcNId() == EI.GetDstNId()) { continue; }
256      if (! (EI().GetVote()==VoteSign || (VoteSign==11 &amp;&amp; EI().GetVote()!=0))) { continue; }
257      if (VoteOnly &amp;&amp; ! EI().IsVoteE()) { continue; }
258      if (TalkOnly &amp;&amp; ! EI().IsTalkE()) { continue; }
259      if (! Net-&gt;IsNode(EI.GetSrcNId())) {
260        Net-&gt;AddNode(EI.GetSrcNId(), 0); }
261      if (! Net-&gt;IsNode(EI.GetDstNId())) {
262        Net-&gt;AddNode(EI.GetDstNId(), 0); }
263      Net-&gt;AddEdge(EI.GetSrcNId(), EI.GetDstNId(), EI().GetVote());
264    }
265    return Net;
266  }
267  void TWikiTalkNet::TestPartitions(const TStr&amp; OutFNm) {
268    { PSignNet MnsNet = GetSignNet(-1, true, false);
269    PSignNet AllNet = GetSignNet(11, true, false);
270    PSignNet CoreNet = TSnap::GetKCore(TSnap::GetMxWcc(MnsNet), 2);
271    TSnap::PrintInfo(CoreNet, &quot;MINUS K-CORE&quot;);
272    for (int npart  = 2; npart &lt; 5; npart++) {
273      printf(&quot;\n**** %d-partitions\n&quot;, npart);
274      THopfield Hopfield(CoreNet);
275      Hopfield.FindStableSet(npart, 1000);
276      TVec&lt;TIntV&gt; PartNIdV;
277      Hopfield.GetStableSet(990, PartNIdV);
278      Hopfield.PlotPartStab(TStr::Fmt(&quot;%s-c2-p%d&quot;, OutFNm.CStr(), npart));
279      CoreNet-&gt;GetPartStat(PartNIdV, &quot;NETWORK 2-CORE&quot;);
280      MnsNet-&gt;GetPartStat(PartNIdV, &quot;FULL MINUS NET&quot;);
281      AllNet-&gt;GetPartStat(PartNIdV, &quot;FULL PLUS-MINUS NET&quot;);
282    } }
283    PermuteAllVoteSigns(false);
284    printf(&quot;\n*** PERMUTE EDGE SIGNS ************************************************************************************\n&quot;);
285    { PSignNet MnsNet = GetSignNet(-1, true, false);
286    PSignNet AllNet = GetSignNet(11, true, false);
287    PSignNet CoreNet = TSnap::GetKCore(TSnap::GetMxWcc(MnsNet), 2);
288    TSnap::PrintInfo(CoreNet, &quot;MINUS K-CORE&quot;);
289    for (int npart  = 2; npart &lt; 6; npart++) {
290      printf(&quot;\n**** %d-partitions\n&quot;, npart);
291      THopfield Hopfield(CoreNet);
292      Hopfield.FindStableSet(npart, 1000);
293      TVec&lt;TIntV&gt; PartNIdV;
294      Hopfield.GetStableSet(990, PartNIdV);
295      Hopfield.PlotPartStab(TStr::Fmt(&quot;%s-c2-Rp%d&quot;, OutFNm.CStr(), npart));
296      CoreNet-&gt;GetPartStat(PartNIdV, &quot;NETWORK 2-CORE&quot;);
297      MnsNet-&gt;GetPartStat(PartNIdV, &quot;FULL MINUS NET&quot;);
298      AllNet-&gt;GetPartStat(PartNIdV, &quot;FULL PLUS-MINUS NET&quot;);
299    } }
300  }
301  void TWikiTalkNet::PlotBarnStarDelta(const TStr&amp; OutFNm) const {
302    THash&lt;TInt, TMom&gt; DiffMomH;
303    TIntH DiffCntH;
304    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
305      if (EI().GetVote() == 0) { continue; }
306      DiffMomH.AddDat(EI.GetSrcNDat().GetStars()-EI.GetDstNDat().GetStars()).Add(EI().GetVote()==1?1:0);
307      DiffCntH.AddDat(EI.GetSrcNDat().GetStars()-EI.GetDstNDat().GetStars()) += 1;
308    }
309    TGnuPlot::PlotValMomH(DiffMomH, &quot;dBarnStars-&quot;+OutFNm, &quot;Number of BarnStars (over ALL VOTES): &quot;+OutFNm, &quot;Barnstars delta (source - destination)&quot;,
310      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, true);
311    TGnuPlot::PlotValCntH(DiffCntH, &quot;dBarnStarts2-&quot;+OutFNm, &quot;Number of BarnSTars (over aLL VOES): &quot;+OutFNm, &quot;Barnstars delta (source - destination)&quot;,
312      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
313  }
314  int log10Delta(const int&amp; Delta) {
315    if (Delta == 0) { return 0; }
316    else if (Delta &gt; 0) { return (int)log10((double)Delta)+1; }
317    else if (Delta &lt; 0) { return -(int)log10((double)-Delta)+1; }
318    Fail; return -1;
319  }
320  void TWikiTalkNet::PlotFracPosVsWords(const TStr&amp; OutFNm) const {
321    THash&lt;TInt, TMom&gt; DiffMomH, DiffMomH2, WrdAE, WrdBE, TlkAE, TlkBE;
322    TIntH DiffCntH, DiffCntH2, CWrdAE, CWrdBE, CTlkAE, CTlkBE;
323    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
324      if (EI().GetVote() == 0) { continue; }
325      if (! EI().IsVoteTalkE()) { continue; }
326      if (EI().GetTalks() &lt; 50) {
327        DiffMomH.AddDat(EI().GetTalks()).Add(EI().GetVote()==1?1:0);
328        DiffCntH.AddDat(EI().GetTalks()) += 1;
329        TlkBE.AddDat((EI().GetTalksBE())).Add(EI().GetVote()==1?1:0);
330        CTlkBE.AddDat((EI().GetTalksBE())) += 1;
331        TlkAE.AddDat((EI().GetTalksAE())).Add(EI().GetVote()==1?1:0);
332        CTlkAE.AddDat((EI().GetTalksAE())) += 1;
333      }
334      DiffMomH2.AddDat(log10Delta(EI().GetWords())).Add(EI().GetVote()==1?1:0);
335      DiffCntH2.AddDat(log10Delta(EI().GetWords())) += 1;
336      WrdBE.AddDat(log10Delta(EI().GetWordsBE())).Add(EI().GetVote()==1?1:0);
337      CWrdBE.AddDat(log10Delta(EI().GetWordsBE())) += 1;
338      WrdAE.AddDat(log10Delta(EI().GetWordsAE())).Add(EI().GetVote()==1?1:0);
339      CWrdAE.AddDat(log10Delta(EI().GetWordsAE())) += 1;
340    }
341    TGnuPlot::PlotValMomH(DiffMomH, &quot;talks-&quot;+OutFNm, &quot;Number of talks: &quot;+OutFNm, &quot;Number of times users talked&quot;,
342      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
343    TGnuPlot::PlotValCntH(DiffCntH, &quot;talks2-&quot;+OutFNm, &quot;Number of talks: &quot;+OutFNm, &quot;Number of times users talked&quot;,
344      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
345    TGnuPlot::PlotValMomH(DiffMomH2, &quot;words-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;Number of words edited&quot;,
346      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
347    TGnuPlot::PlotValCntH(DiffCntH2, &quot;words2-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;Number of words edited&quot;,
348      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
349    TGnuPlot::PlotValMomH(WrdAE, &quot;wordsBE-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;Number of words edited BEFORE the election (on talk page between a pair)&quot;,
350      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
351    TGnuPlot::PlotValCntH(CWrdAE, &quot;wordsBE2-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;Number of words edited BEFORE the election (on talk page between a pair)&quot;,
352      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
353    TGnuPlot::PlotValMomH(WrdBE, &quot;wordsAE-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;Number of words edited AFTER the election (on talk page between a pair)&quot;,
354      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
355    TGnuPlot::PlotValCntH(CWrdBE, &quot;wordsAE2-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;Number of words edited AFTER the election (on talk page between a pair)&quot;,
356      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
357    TGnuPlot::PlotValMomH(TlkAE, &quot;talksBE-&quot;+OutFNm, &quot;Number of talks edited: &quot;+OutFNm, &quot;Number of talks BEFORE the election (on talk page between a pair)&quot;,
358      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
359    TGnuPlot::PlotValCntH(CTlkAE, &quot;talksBE2-&quot;+OutFNm, &quot;Number of talks edited: &quot;+OutFNm, &quot;Number of talks BEFORE the election (on talk page between a pair)&quot;,
360      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
361    TGnuPlot::PlotValMomH(TlkBE, &quot;talksAE-&quot;+OutFNm, &quot;Number of talks edited: &quot;+OutFNm, &quot;Number of talks AFTER the election (on talk page between a pair)&quot;,
362      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
363    TGnuPlot::PlotValCntH(CTlkBE, &quot;talksAE2-&quot;+OutFNm, &quot;Number of talks edited: &quot;+OutFNm, &quot;Number of talks AFTER the election (on talk page between a pair)&quot;,
364      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
365  }
366  void TWikiTalkNet::PlotFracPosVsWords2(const TStr&amp; OutFNm) const {
367    THash&lt;TInt, TMom&gt; TlkAll, WrdAll, WrdAE, WrdBE, TlkAE, TlkBE, EdtAll, EdtAll2, EdtAll3;
368    TIntH NIdTAE, NIdTBE, NIdTalks, NIdWAE, NIdWBE, NIdWords;
369    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
370      NIdTAE.AddDat(EI.GetDstNId()) += EI().GetTalksAE();
371      NIdTBE.AddDat(EI.GetDstNId()) += EI().GetTalksBE();
372      NIdTalks.AddDat(EI.GetDstNId()) += EI().GetTalks();
373      NIdWAE.AddDat(EI.GetDstNId()) += EI().GetWordsAE();
374      NIdWBE.AddDat(EI.GetDstNId()) += EI().GetWordsBE();
375      NIdWords.AddDat(EI.GetDstNId()) += EI().GetWords();
376    }
377    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
378      if (EI().GetVote() == 0) { continue; }
379      const int C = EI.GetDstNId(); 
380      if (NIdTAE.GetDat(C)&lt;1000) TlkAE.AddDat(NIdTAE.GetDat(C)).Add(EI().GetVote()==1?1:0);
381      if (NIdTBE.GetDat(C)&lt;1000) TlkBE.AddDat(NIdTBE.GetDat(C)).Add(EI().GetVote()==1?1:0);
382      if (NIdTalks.GetDat(C)&lt;1000) TlkAll.AddDat(NIdTalks.GetDat(C)).Add(EI().GetVote()==1?1:0);
383      WrdAE.AddDat(log10Delta(NIdWAE.GetDat(C))).Add(EI().GetVote()==1?1:0);
384      WrdBE.AddDat(log10Delta(NIdWBE.GetDat(C))).Add(EI().GetVote()==1?1:0);
385      WrdAll.AddDat(log10Delta(NIdWords.GetDat(C))).Add(EI().GetVote()==1?1:0);
386      EdtAll.AddDat(log10Delta(EI.GetDstNDat().GetEdCnt())).Add(EI().GetVote()==1?1:0);
387      EdtAll2.AddDat(log10Delta(EI.GetDstNDat().GetAllEdCnt())).Add(EI().GetVote()==1?1:0);
388      EdtAll3.AddDat(log10Delta(EI.GetDstNDat().GetTkEdCnt())).Add(EI().GetVote()==1?1:0);
389    }
390    TGnuPlot::PlotValMomH(EdtAll, &quot;editsTot-&quot;+OutFNm, &quot;Number of edits: &quot;+OutFNm, &quot;Total number of times candidate edited&quot;,
391      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
392    TGnuPlot::PlotValMomH(EdtAll2, &quot;editsTot2-&quot;+OutFNm, &quot;Number of edits: &quot;+OutFNm, &quot;Total number of times candidate edited&quot;,
393      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
394    TGnuPlot::PlotValMomH(EdtAll3, &quot;editsTot3-&quot;+OutFNm, &quot;Number of edits: &quot;+OutFNm, &quot;Total number of times candidate edited&quot;,
395      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
396    TGnuPlot::PlotValMomH(TlkAll, &quot;talksTot-&quot;+OutFNm, &quot;Number of talks: &quot;+OutFNm, &quot;Total number of times candidate talked&quot;,
397      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
398    TGnuPlot::PlotValMomH(WrdAE, &quot;wordsBETot-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;1+Log_10 Total number of words edited of candidate BEFORE the election&quot;,
399      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
400    TGnuPlot::PlotValMomH(WrdBE, &quot;wordsAETot-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;1+Log_10 Total number of words edited of candidate AFTER the election&quot;,
401      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
402    TGnuPlot::PlotValMomH(WrdAll, &quot;wordsTot-&quot;+OutFNm, &quot;Number of words edited: &quot;+OutFNm, &quot;1+Log_10 Total number of words candidate edited&quot;,
403      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
404    TGnuPlot::PlotValMomH(TlkAE, &quot;talksBETot-&quot;+OutFNm, &quot;Number of talks edited: &quot;+OutFNm, &quot;Total number of talks of candidate BEFORE the election&quot;,
405      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
406    TGnuPlot::PlotValMomH(TlkBE, &quot;talksAETot-&quot;+OutFNm, &quot;Number of talks edited: &quot;+OutFNm, &quot;Total number of talks of candidate AFTER the election&quot;,
407      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
408  }
409  void TWikiTalkNet::PlotNodeAttrDistr(const TStr&amp; OutFNm) const {
410    TIntH BarnStars, AllEdCnt, AllEdWrds, MnEdCnt, MnEdWrds, TkEdCnt, TkEdWrds;
411    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
412      const TWikiUsr&amp; N = NI();
413      BarnStars.AddDat(N.GetStars()) += 1;
414      AllEdCnt.AddDat(N.GetAllEdCnt()) += 1;
415      AllEdWrds.AddDat(1*(N.GetAllWrdCnt()/1)) += 1;
416      MnEdCnt.AddDat(N.GetEdCnt()) += 1;
417      MnEdWrds.AddDat(1*(N.GetWrdCnt()/1)) += 1;
418      TkEdCnt.AddDat(N.GetTkEdCnt()) += 1;
419      TkEdWrds.AddDat(1*(N.GetTkWrdCnt()/1)) += 1;
420    }
421    TGnuPlot::PlotValCntH(BarnStars, &quot;barnStars-&quot;+OutFNm, OutFNm, &quot;Number of barn stars&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
422    TGnuPlot::PlotValCntH(AllEdCnt, &quot;allEdCnt-&quot;+OutFNm, OutFNm, &quot;Number of edits&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
423    TGnuPlot::PlotValCntH(AllEdWrds, &quot;allEdWrds-&quot;+OutFNm, OutFNm, &quot;Number of edited words&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
424    TGnuPlot::PlotValCntH(MnEdCnt, &quot;MnEdCnt-&quot;+OutFNm, OutFNm, &quot;Number of edits on MAIN pages&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
425    TGnuPlot::PlotValCntH(MnEdWrds, &quot;MnEdWrds-&quot;+OutFNm, OutFNm, &quot;Number of edited words onmain pages&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
426    TGnuPlot::PlotValCntH(TkEdCnt, &quot;tkEdCnt-&quot;+OutFNm, OutFNm, &quot;Number of edits on TALK pages&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
427    TGnuPlot::PlotValCntH(TkEdWrds, &quot;tkEdWrds-&quot;+OutFNm, OutFNm, &quot;Number of edited words onmain pages&quot;, &quot;Number of users&quot;, gpsLog, false, gpwLinesPoints, false, false);
428  }
429  void TWikiTalkNet::PlotFracPosVsEdgeAttr(const TStr&amp; OutFNm) const {
430    THash&lt;TInt, TMom&gt; EdgeTalksH, EdgeTalksH2, EdgeWordsH;
431    THash&lt;TInt, TMom&gt; dBarnStars, dAllEdCnt, dAllEdWrds;
432    TIntH dBarnStarsCnt, dAllEdCntCnt, dAllEdWrdsCnt;
433    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
434      const int Val = EI().GetVote() ==1 ? 1 : 0;
435      if (EI().GetTalks() &lt; 100) {
436        EdgeTalksH.AddDat(int(EI().GetTalks())).Add(Val);
437      }
438      EdgeTalksH2.AddDat((int)log10((double)EI().GetTalks())).Add(Val);
439      EdgeWordsH.AddDat((int)log10((double)EI().GetWords())).Add(Val);
440      const TWikiUsr&amp; S = EI.GetSrcNDat();
441      const TWikiUsr&amp; D = EI.GetDstNDat();
442      if (abs(S.GetStars()-D.GetStars()) &lt; 10) {
443        dBarnStars.AddDat(S.GetStars()-D.GetStars()).Add(Val);
444        dBarnStarsCnt.AddDat(S.GetStars()-D.GetStars())++;
445      }
446      dAllEdCnt.AddDat(log10Delta(S.GetAllEdCnt()-D.GetAllEdCnt())).Add(Val);
447      dAllEdCntCnt.AddDat(log10Delta(S.GetAllEdCnt()-D.GetAllEdCnt()))++;
448      dAllEdWrds.AddDat(log10Delta(S.GetAllWrdCnt()-D.GetAllWrdCnt())).Add(Val);
449      dAllEdWrdsCnt.AddDat(log10Delta(S.GetAllWrdCnt()-D.GetAllWrdCnt()))++;
450    }
451    const bool SDev = true;
452    TGnuPlot::PlotValMomH(EdgeTalksH, &quot;edgeTks&quot;+OutFNm, OutFNm, &quot;Number of talks over the edge&quot;, &quot;Fraction of positive edges&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, SDev);
453    TGnuPlot::PlotValMomH(EdgeTalksH2, &quot;edgeTks2&quot;+OutFNm, OutFNm, &quot;1+Log_{10} Number of talks over the edge&quot;, &quot;Fraction of positive edges&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, SDev);
454    TGnuPlot::PlotValMomH(EdgeWordsH, &quot;edgeWrds&quot;+OutFNm, OutFNm, &quot;1+Log_{10} Number of words over all talks over the edge&quot;, &quot;Fraction of positive edges&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, SDev);
455    TGnuPlot::PlotValMomH(dBarnStars, &quot;dBarnStars-&quot;+OutFNm, OutFNm, &quot;delta BarnStars&quot;, &quot;Fraction of positive edges&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, SDev);
456    TGnuPlot::PlotValMomH(dAllEdCnt, &quot;dAllEdCnt-&quot;+OutFNm, OutFNm, &quot;delta AllEdCnt&quot;, &quot;Fraction of positive edges&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, SDev);
457    TGnuPlot::PlotValMomH(dAllEdWrds, &quot;dAllEdWrds-&quot;+OutFNm, OutFNm, &quot;delta AllEdWrds&quot;, &quot;Fraction of positive edges&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, SDev);
458    TGnuPlot::PlotValCntH(dBarnStarsCnt, &quot;dBarnStarsCnt-&quot;+OutFNm, OutFNm, &quot;delta BarnStars&quot;, &quot;Count&quot;, gpsAuto);
459    TGnuPlot::PlotValCntH(dAllEdCntCnt, &quot;dAllEdCntCnt-&quot;+OutFNm, OutFNm, &quot;delta AllEdCnt&quot;, &quot;Count&quot;, gpsAuto);
460    TGnuPlot::PlotValCntH(dAllEdWrdsCnt, &quot;dAllEdWrdsCnt-&quot;+OutFNm, OutFNm, &quot;delta AllEdWrds&quot;, &quot;Count&quot;, gpsAuto);
461  }
462  void TWikiTalkNet::PlotVoteSignCmnFriends(const TStr&amp; OutFNm) const {
463    TFltFltH SupRngH, OppRngH; 
464    TFltFltH SupCmnH, OppCmnH; 
465    THash&lt;TFlt, TMom&gt; RngFracH, CmnFracH; 
466    PWikiTalkNet ThisPt = PWikiTalkNet((TWikiTalkNet*) this);
467    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
468      const int C = -1; Fail;
469      const int R = -1; 
470      if (EI().GetVote() == 1) {
471        SupRngH.AddDat(R)++;  RngFracH.AddDat(R).Add(1);
472        SupCmnH.AddDat(C)++;  CmnFracH.AddDat(C).Add(1);
473      } else if (EI().GetVote() == -1) {
474        OppRngH.AddDat(R)++;  RngFracH.AddDat(R).Add(0);
475        OppCmnH.AddDat(C)++;  CmnFracH.AddDat(C).Add(0);
476      }
477    }
478    TGnuPlot::PlotValCntH(SupRngH, &quot;rngSup-&quot;+OutFNm, &quot;range of support votes&quot;, &quot;range (path length after edge is removed)&quot;, &quot;count&quot;);
479    TGnuPlot::PlotValCntH(OppRngH, &quot;rngOpp-&quot;+OutFNm, &quot;range of opposing votes&quot;, &quot;range (path length after edge is removed)&quot;, &quot;count&quot;);
480    TGnuPlot::PlotValCntH(SupCmnH, &quot;cmnSup-&quot;+OutFNm, &quot;number of common friends of support votes&quot;, &quot;number of common friends&quot;, &quot;count&quot;, gpsLog);
481    TGnuPlot::PlotValCntH(OppCmnH, &quot;cmnOpp-&quot;+OutFNm, &quot;number of common friends of opposing votes&quot;, &quot;number of common friends&quot;, &quot;count&quot;, gpsLog);
482    TGnuPlot::PlotValMomH(RngFracH, &quot;fracRng-&quot;+OutFNm, &quot;fraction of support edges spanning range X&quot;, &quot;range&quot;, &quot;fraction of support edges&quot;);
483    TGnuPlot::PlotValMomH(CmnFracH, &quot;fracCmn-&quot;+OutFNm, &quot;fraction of support edges having X common neighbors&quot;, &quot;number of common neighbors&quot;, &quot;fraction of support edges&quot;, gpsLog);
484  }
485  void TWikiTalkNet::SaveAreaUTrailAttr(const TStr&amp; OutFNm, const int&amp; MinUsrVotes, const TWikiElecBs&amp; ElecBs) const {
486    TIntV UIdV;
487    TFltV AreaV;
488    TIntSet AdminSet, ElecUsrV;
489    { TIntSet FqVoterSet; ElecBs.GetFqVoters(FqVoterSet, MinUsrVotes, 10, false); FqVoterSet.GetKeyV(UIdV);
490    TIntV ElecUIdV; ElecBs.GetElecUsrV(ElecUIdV); ElecUsrV=TIntSet(ElecUIdV); }
491    ElecBs.GetUsrAreaUTrail(UIdV, AreaV);
492    ElecBs.GetAdminSet(AdminSet);
493    FILE *F = fopen(OutFNm.CStr(), &quot;wt&quot;);
494    fprintf(F, &quot;Area\tUser\tIsAdmin\tIsElec\tTalkOutDeg\tInDeg\tTalkTriads\tBarnStars\tInAdmins\tOutAdmins\tAllEdCnt\tAllWrdCnt\tRevCnt\tRevWrds\n&quot;);
495    printf(&quot;%d users&quot;, UIdV.Len());
496    int skip=0;
497    for (int u = 0; u &lt; UIdV.Len(); u++) {
498      TStr Usr = ElecBs.GetUsr(UIdV[u]);
499      if (! IsUsr(Usr)) {  printf(&quot;x&quot;); skip++; continue; } else { printf(&quot;.&quot;); }
500      fprintf(F, &quot;%f\t%s\t%d\t%d&quot;, AreaV[u], Usr.CStr(), AdminSet.IsKey(UIdV[u])?1:0, ElecUsrV.IsKey(UIdV[u])?1:0);
501      TNodeI U =  GetNI(GetUsrNId(Usr));
502      fprintf(F, &quot;\t%d\t%d\t%d&quot;, U.GetOutDeg(), U.GetInDeg(), TSnap::GetNodeTriads&lt;PWikiTalkNet&gt;((TWikiTalkNet*)this, U.GetId()));
503      int OutAdmins=0, InAdmins=0;
504      for (int i = 0; i &lt; U.GetOutDeg(); i++) {
505        if (U.GetOutNDat(i).IsAdmin()) { OutAdmins++; } }
506      for (int i = 0; i &lt; U.GetInDeg(); i++) {
507        if (U.GetInNDat(i).IsAdmin()) { InAdmins++; } }
508      fprintf(F, &quot;\t%d\t%d\t%d\t%d\t%d\t%d\t%d\n&quot;, U().GetStars(), OutAdmins, InAdmins,
509        U().GetAllEdCnt(), U().GetAllWrdCnt(), U().GetRevCnt(), U().GetRevWrds());
510      fflush(F);
511    }
512    fclose(F);
513    printf(&quot;\n%d users, %d skip\n&quot;, UIdV.Len(), skip);
514  }
515  void TWikiTalkNet::DumpEdgeStat() const {
516    TIntH VoteE, TalkE, AllE, VtTkE;
517    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
518      const TWikiTalkEdge&amp; E = EI();
519      const int V = E.GetVote();
520      AllE.AddDat(V) += 1;
521      if (E.IsTalkE()) { TalkE.AddDat(V)+=1; }
522      if (E.IsVoteE()) { VoteE.AddDat(V)+=1; }
523      if (E.IsVoteTalkE()) { VtTkE.AddDat(V)+=1; }
524    }
525    VoteE.SortByKey(); TalkE.SortByKey(); AllE.SortByKey(); VtTkE.SortByKey();
526    printf(&quot;Edge\tAll\tTalk\tVote\tVoteTalk\n&quot;);
527    for (int e = 0; e &lt; AllE.Len(); e++) {
528      const int v = AllE.GetKey(e);
529      printf(&quot;%4d\t%7d\t%7d\t%7d\t%7d\n&quot;, v, AllE[e], TalkE.IsKey(v)?TalkE.GetDat(v):0,
530        VoteE.IsKey(v)?VoteE.GetDat(v):0, VtTkE.IsKey(v)?VtTkE.GetDat(v):0);
531    }
532    printf(&quot;\n&quot;);
533  }
534  void TWikiTalkNet::ClearElecData() {
535    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
536      EI().VoteSign = -1;
537      EI().VoteTm = TSecTm();
538    }
539    for (TNodeI NI = BegNI(); NI &lt; EndNI(); NI++) {
540      NI().Admin = false;
541      NI().ElecTm = TSecTm();
542    }
543  }
544  void TWikiTalkNet::ImposeElecNet(const TWikiElecBs&amp; ElecBs, const THash&lt;TChA, TChA&gt;&amp; UsrChageH, const bool&amp; AddVoteOnlyEdges) {
545    int GoodEl=0, ESet=0, ESkip=0, GoodVotes=0, AllCmts=0, VoteEdge=0;
546    int DstNf=0, SrcNf=0;
547    for (int e = 0; e &lt; ElecBs.Len(); e++) {
548      const TWikiElec&amp; E = ElecBs[e];
549      TChA DstUsr = ElecBs.GetUsr(E.GetUId());  DstUsr.ToLc();
550      if (UsrChageH.IsKey(DstUsr)) { DstUsr = UsrChageH.GetDat(DstUsr); }
551      if (! UsrNIdH.IsKey(DstUsr)) { DstNf++; continue; }
552      GoodEl++;
553      TWikiElec Votes;
554      E.GetOnlyVotes(Votes, false);
555      AllCmts += E.Len();
556      GoodVotes += Votes.Len();
557      for (int v = 0; v &lt; Votes.Len(); v++) {
558        TChA SrcUsr = ElecBs.GetUsr(E.GetVote(v).GetUId());  SrcUsr.ToLc();
559        if (UsrChageH.IsKey(SrcUsr)) { SrcUsr = UsrChageH.GetDat(SrcUsr); }
560        if (! UsrNIdH.IsKey(SrcUsr)) { SrcNf++;  continue; }
561        const int SrcId = UsrNIdH.GetDat(SrcUsr);
562        const int DstId = UsrNIdH.GetDat(DstUsr);
563        if (SrcId==DstId) { continue; }
564        if (IsEdge(SrcId, DstId)) {
565          GetEDat(SrcId, DstId).VoteSign = E.GetVote(v).GetVote();
566          GetEDat(SrcId, DstId).VoteTm = E.GetVote(v).GetTm();
567          ESet++;
568        }
569        else if (AddVoteOnlyEdges) {
570          AddEdge(SrcId, DstId);
571          TWikiTalkEdge&amp; EdgeDat = GetEDat(SrcId, DstId);
572          EdgeDat.VoteSign = E[v].GetVote();
573          EdgeDat.VoteTm = E[v].GetTm();
574          VoteEdge++;
575        }
576        else { ESkip++; }
577      }
578    }
579    printf(&quot;admins that talk (good elections): %d / %d\n&quot;, GoodEl, ElecBs.Len());
580    printf(&quot;actual votes vs. comments in elections: %d / %d : %f\n&quot;, GoodVotes, AllCmts, GoodVotes/double(AllCmts));
581    printf(&quot;votes where both users talk %d (%f of votes where nodes exist)\n&quot;, ESet, ESet/double(ESet+ESkip));
582    printf(&quot;fraction of all votes found in the graph: %d/%d : %f\n&quot;, ESet, GoodVotes, ESet/double(GoodVotes));
583    printf(&quot;destination not found: %d\n&quot;, DstNf);
584    printf(&quot;source not found: %d\n&quot;, SrcNf);
585    printf(&quot;talk+vote: %d  vote: %d  skip: %d\n&quot;, ESet, VoteEdge, ESkip);
586  }
587  PWikiTalkNet TWikiTalkNet::LoadTalkNet(const TStr&amp; ParsedWikiDir, const TWikiElecBs&amp; ElecBs) {
588    const TStr WikiUsrTalk = &quot;enwiki-20080103.user_talk.7z&quot;; 
589    const TStr WikiMain = &quot;enwiki-20080103.main.7z&quot;;
590    const TStr WikiMainTalk = &quot;enwiki-20080103.talk.7z&quot;;
591    const TStr WikiWiki = &quot;enwiki-20080103.wikipedia.7z&quot;;
592    const TStr WikiWikiTalk = &quot;enwiki-20080103.wikipedia_talk.7z&quot;;
593    const TStr BarnStartList = &quot;barnstars.history.unsorted&quot;;
594    const TStr AdminList = &quot;enwiki.admins2009.txt&quot;;
595    const TStr BotList = &quot;enwiki.botlist.2007-03&quot;;
596    const TStr UsrChanges = &quot;enwiki.important-username-changes.2007-08-06.txt&quot;;
597    THash&lt;TChA, TChA&gt; UsrMapH;
598    THashSet&lt;TChA&gt; BotSet;
599    THash&lt;TChA, TInt&gt; UsrElecId; 
600    TChA Ln;
601    TExeTm ExeTm;
602    for (TFIn FIn(ParsedWikiDir+BotList); FIn.GetNextLn(Ln); ) {
603      BotSet.AddKey(Ln.ToLc()); }
604    printf(&quot;Bots: %d bots\n&quot;, BotSet.Len());
605    for (TSsParser Ss(ParsedWikiDir+UsrChanges, ssfSpaceSep); Ss.Next(); ) {
606      TChA U1=Ss[0], U2=Ss[1]; if (U1.ToLc()!=U2.ToLc()) { UsrMapH.AddDat(U1,U2); }
607    }
608    printf(&quot;User changes: %d chages\n&quot;, UsrMapH.Len());
609    for (int e = 0; e &lt; ElecBs.Len(); e++) {
610      UsrElecId.AddDat(ElecBs.GetUsr(ElecBs[e].GetUId()), e); }
611    printf(&quot;Elections: %d users up for election\n&quot;, UsrElecId.Len());
612    printf(&quot;Load WikiTalk network:&quot;);
613    PWikiTalkNet Net = TWikiTalkNet::New();
614    printf(&quot;  Load %s &quot;, WikiUsrTalk.CStr());
615    { TWikiMetaLoader WML(ParsedWikiDir+WikiUsrTalk);
616    int src, dst, k, elecSet=0;
617    for (int edges=0; WML.Next(); edges++) {
618      if (! WML.Title.IsPrefix(&quot;User_talk:&quot;)) { printf(&quot;.&quot;); continue; }
619      const int b = (int) strlen(&quot;User_talk:&quot;);
620      int e2 = WML.Title.SearchCh(&#x27;/&#x27;, b)-1;
621      if (e2&lt;0) { e2=TInt::Mx; }
622      TChA Dst = WML.Title.GetSubStr(b, e2).ToLc();
623      TChA Src = WML.Usr.ToLc();
624      if (BotSet.IsKey(Src) || BotSet.IsKey(Dst)) { printf(&quot;&quot;); continue; }
625      if (TWikiMetaLoader::IsIpAddr(Src) || TWikiMetaLoader::IsIpAddr(Dst)) { printf(&quot;&quot;); continue; }
626      if (Src != Dst) { 
627        k = UsrMapH.GetKeyId(Src);
628        if (k != -1) { Src = UsrMapH[k]; }
629        k = UsrMapH.GetKeyId(Dst);
630        if (k != -1) { Dst = UsrMapH[k]; }
631        src = Net-&gt;UsrNIdH.AddDatId(Src);
632        dst = Net-&gt;UsrNIdH.AddDatId(Dst);
633        IAssert(src != dst);
634        if (! Net-&gt;IsNode(src)) {
635          Net-&gt;AddNode(src, TWikiUsr(Src));
636          if (UsrElecId.IsKey(Src)) { printf(&quot;T&quot;); elecSet++; 
637            Net-&gt;GetNDat(src).ElecTm = ElecBs.GetElec(UsrElecId.GetDat(Src)).GetTm();  }
638        }
639        if (! Net-&gt;IsNode(dst)) {
640          Net-&gt;AddNode(dst, TWikiUsr(Dst));
641          if (UsrElecId.IsKey(Dst)) { printf(&quot;T&quot;); elecSet++; 
642            Net-&gt;GetNDat(dst).ElecTm = ElecBs.GetElec(UsrElecId.GetDat(Dst)).GetTm(); }
643        }
644        if (! Net-&gt;IsEdge(src, dst)) {
645          Net-&gt;AddEdge(src, dst, TWikiTalkEdge(WML.RevTm, WML.RevTm, 1, WML.RevWrds));
646        }
647        TWikiTalkEdge&amp; TalkEdge = Net-&gt;GetEDat(src, dst);
648        if (TalkEdge.FirstTalk &gt; WML.RevTm) { TalkEdge.FirstTalk = WML.RevTm; }
649        if (TalkEdge.LastTalk &lt; WML.RevTm) { TalkEdge.LastTalk = WML.RevTm; }
650        TalkEdge.TotWords += WML.RevWrds;
651        TalkEdge.TotTalks += 1;
652        const TSecTm DstElecTm = Net-&gt;GetNDat(dst).ElecTm;
653        if (DstElecTm.IsDef()) { 
654          if (WML.RevTm &lt; DstElecTm) { TalkEdge.TalksBE++; TalkEdge.WordsBE+=WML.RevWrds; }
655          else { TalkEdge.TalksAE++; TalkEdge.WordsAE+=WML.RevWrds; }
656        }
657      }
658    }
659    printf(&quot;DONE NET[%s]\n&quot;, ExeTm.GetStr());  ExeTm.Tick();
660    printf(&quot;node election time %d / %d (%f)\n&quot;, elecSet, UsrElecId.Len(), elecSet/double(UsrElecId.Len())); }
661    TSnap::PrintInfo(Net, &quot;WikiUserTalk network.&quot;);
662    printf(&quot; [%s]\n  Loading %s\n&quot;, ExeTm.GetStr(), BarnStartList.CStr());  ExeTm.Tick();
663    int cnt=0, cnt2=0;
664    for (TSsParser Ss(ParsedWikiDir+BarnStartList, ssfSpaceSep); Ss.Next(); cnt2++) { TChA U1=Ss[3]; U1.ToLc();
665      if (UsrMapH.IsKey(U1)) { U1 = UsrMapH.GetDat(U1); }
666      if (Net-&gt;UsrNIdH.IsKey(U1)) { cnt++;
667        Net-&gt;GetNDat(Net-&gt;UsrNIdH.GetDat(U1)).BarnStars += 1; }
668    }
669    printf(&quot;    %d / %d stars set [%s]\n  Loading %s\n&quot;, cnt, cnt2, ExeTm.GetStr(), AdminList.CStr());  ExeTm.Tick();
670    cnt=0; cnt2=0;
671    for (TFIn FIn(ParsedWikiDir+AdminList); FIn.GetNextLn(Ln); cnt2++) { Ln.ToLc();
672      if (UsrMapH.IsKey(Ln)) { Ln = UsrMapH.GetDat(Ln); }
673      if (Net-&gt;UsrNIdH.IsKey(Ln)) { cnt++;
674        Net-&gt;GetNDat(Net-&gt;UsrNIdH.GetDat(Ln)).Admin = true; }
675    }/&amp;bsol;*/
676    printf(&quot;    %d / %d admins set [%s]\n&quot;, cnt, cnt2, ExeTm.GetStr());
677    TIntSet AdminSet; ElecBs.GetAdminSet(AdminSet);
678    for (int a = 0; a &lt; AdminSet.Len(); a++, cnt2++) {
679      TChA Ln = ElecBs.GetUsr(AdminSet[a]);
680      if (Net-&gt;UsrNIdH.IsKey(Ln)) { cnt++;
681        Net-&gt;GetNDat(Net-&gt;UsrNIdH.GetDat(Ln)).Admin = true; }
682    }
683    printf(&quot;    %d / %d admins set [%s]\n&quot;, cnt, cnt2, ExeTm.GetStr());
684    Net-&gt;ImposeElecNet(ElecBs, UsrMapH, true); 
685    TSnap::PrintInfo(Net);
686    printf(&quot;SAVE DONE.\n\nLoading user edit statistics:\n&quot;);
687    printf(&quot;  Loading %s &quot;, WikiMain.CStr());
688    { TWikiMetaLoader WML(ParsedWikiDir+WikiMain);
689    for (int rec=0; WML.Next(); rec++) {
690      const TChA&amp; U = WML.Usr;
691      const int keyId = Net-&gt;UsrNIdH.GetKeyId(U);
692      if (keyId == -1) { continue; }
693      TWikiUsr&amp; WU = Net-&gt;GetNDat(Net-&gt;UsrNIdH[keyId]);
694      WU.MnEdCnt += 1;  WU.MnEdWrds += WML.RevWrds;
695      WML.CommentStr.ToLc();
696      if (WML.CommentStr.IsPrefix(&quot;rv&quot;) || WML.CommentStr.SearchStr(&quot;revert&quot;)!=-1) {
697        WU.MnRevCnt+=1; WU.MnRevWrds+=WML.RevWrds; }
698    } }
699    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiMainTalk.CStr());  ExeTm.Tick();
700    { TWikiMetaLoader WML(ParsedWikiDir+WikiMainTalk);
701    for (int rec=0; WML.Next(); rec++) {
702      const TChA&amp; U = WML.Usr.ToLc();
703      const int keyId = Net-&gt;UsrNIdH.GetKeyId(U);
704      if (keyId == -1) { continue; }
705      TWikiUsr&amp; WU = Net-&gt;GetNDat(Net-&gt;UsrNIdH[keyId]);
706      WU.MnTkEdCnt += 1;  WU.MnTkEdWrds += WML.RevWrds;
707    } }
708    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiWiki.CStr());  ExeTm.Tick();
709    { TWikiMetaLoader WML(ParsedWikiDir+WikiWiki);
710    for (int rec=0; WML.Next(); rec++) {
711      const TChA&amp; U = WML.Usr.ToLc();
712      const int keyId = Net-&gt;UsrNIdH.GetKeyId(U);
713      if (keyId == -1) { continue; }
714      TWikiUsr&amp; WU = Net-&gt;GetNDat(Net-&gt;UsrNIdH[keyId]);
715      WU.WkEdCnt += 1;  WU.WkEdWrds += WML.RevWrds;
716    } }
717    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiWikiTalk.CStr());  ExeTm.Tick();
718    { TWikiMetaLoader WML(ParsedWikiDir+WikiWikiTalk);
719    for (int rec=0; WML.Next(); rec++) {
720      const TChA&amp; U = WML.Usr.ToLc();
721      const int keyId = Net-&gt;UsrNIdH.GetKeyId(U);
722      if (keyId == -1) { continue; }
723      TWikiUsr&amp; WU = Net-&gt;GetNDat(Net-&gt;UsrNIdH[keyId]);
724      WU.WkTkEdCnt += 1;  WU.WkTkEdWrds += WML.RevWrds;
725    } }
726    TSnap::PrintInfo(Net, &quot;WikiUserTalk network.&quot;);
727    printf(&quot;\n[%s]\nDONE.\n&quot;, ExeTm.GetStr());
728    return Net;
729  }
730  PWikiTalkNet TWikiTalkNet::LoadSlashdot(const TStr&amp; InFNm) {
731    THashSet&lt;TChA&gt; NIdSet;
732    TChA LnStr;
733    TVec&lt;char *&gt; WrdV;
734    int Sign;
735    PWikiTalkNet Net = TWikiTalkNet::New();
736    for (TFIn FIn(InFNm); FIn.GetNextLn(LnStr); ) {
737      if (LnStr.Empty() || LnStr[0]==&#x27;#&#x27;) { continue; }
738      LnStr.ToLc();
739      TStrUtil::SplitOnCh(LnStr, WrdV, &#x27;\t&#x27;, false);
740      NIdSet.AddKey(WrdV[0]);
741      if (strcmp(WrdV[1], &quot;friends&quot;)==0) { Sign = 1; }
742      else if (strcmp(WrdV[1], &quot;fans&quot;)==0) { continue; } 
743      else if (strcmp(WrdV[1], &quot;foes&quot;)==0) { Sign = -1; }
744      else { Fail; }
745      const int SrcNId = NIdSet.AddKey(WrdV[0]);
746      if (! Net-&gt;IsNode(SrcNId)) {
747        Net-&gt;AddNode(SrcNId, TWikiUsr(WrdV[0]));
748        Net-&gt;UsrNIdH.AddDat(WrdV[0], SrcNId);
749      }
750      for (int e = 2; e &lt; WrdV.Len(); e++) {
751        const int DstNId = NIdSet.AddKey(WrdV[e]);
752        if (! Net-&gt;IsNode(DstNId)) {
753          Net-&gt;AddNode(DstNId, TWikiUsr(WrdV[e]));
754          Net-&gt;UsrNIdH.AddDat(WrdV[e], DstNId);
755        }
756        if (SrcNId != DstNId &amp;&amp; ! Net-&gt;IsEdge(SrcNId, DstNId)) {
757          Net-&gt;AddEdge(SrcNId, DstNId, TWikiTalkEdge(Sign));
758        }
759      }
760    }
761    TSnap::PrintInfo(Net, InFNm);
762    return Net;
763  }
764  PWikiTalkNet TWikiTalkNet::LoadOldNet(const TStr&amp; InFNm) {
765    typedef TNodeEDatNet&lt;TStr, TInt&gt; TOldNet;
766    PWikiTalkNet Net = TWikiTalkNet::New();
767    TPt&lt;TOldNet&gt; ON = TOldNet::Load(TZipIn(InFNm));
768    TSnap::PrintInfo(ON);
769    for(TOldNet::TEdgeI EI = ON-&gt;BegEI(); EI&lt;ON-&gt;EndEI(); EI++) {
770      if (! Net-&gt;IsNode(EI.GetSrcNId())) {
771        Net-&gt;AddNode(EI.GetSrcNId(), TWikiUsr(EI.GetSrcNDat().GetLc()));
772        Net-&gt;UsrNIdH.AddDat(EI.GetDstNDat().GetLc(), EI.GetSrcNId());
773      }
774      if (! Net-&gt;IsNode(EI.GetDstNId())) {
775        Net-&gt;AddNode(EI.GetDstNId(), TWikiUsr(EI.GetDstNDat().GetLc()));
776        Net-&gt;UsrNIdH.AddDat(EI.GetDstNDat().GetLc(), EI.GetDstNId());
777      }
778      Net-&gt;AddEdge(EI.GetSrcNId(), EI.GetDstNId(), TWikiTalkEdge(EI()));
779    }
780    TSnap::PrintInfo(Net);
781    return Net;
782  }
783  PNGraph TWikiTimeTalkNet::GetBeforeTimeG(const TSecTm&amp; EdgeTm) const {
784    PNGraph G = TNGraph::New();
785    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
786      if (EI().Tm &lt;= EdgeTm) {
787        if (! G-&gt;IsNode(EI.GetSrcNId())) { G-&gt;AddNode(EI.GetSrcNId()); }
788        if (! G-&gt;IsNode(EI.GetDstNId())) { G-&gt;AddNode(EI.GetDstNId()); }
789        G-&gt;AddEdge(EI.GetSrcNId(), EI.GetDstNId());
790      }
791    }
792    return G;
793  }
794  PSignNet TWikiTimeTalkNet::GetBeforeTimeNet(const TSecTm&amp; EdgeTm) const {
795    PSignNet Net = TSignNet::New();
796    for (TEdgeI EI = BegEI(); EI &lt; EndEI(); EI++) {
797      if (EI().Tm &lt;= EdgeTm) {
798        if (! Net-&gt;IsNode(EI.GetSrcNId())) { Net-&gt;AddNode(EI.GetSrcNId()); }
799        if (! Net-&gt;IsNode(EI.GetDstNId())) { Net-&gt;AddNode(EI.GetDstNId()); }
800        Net-&gt;AddEdge(EI.GetSrcNId(), EI.GetDstNId());
801        Net-&gt;GetEDat(EI.GetSrcNId(), EI.GetDstNId()) += EI().Words;
802      }
803    }
804    return Net;
805  }
806  void TWikiTimeTalkNet::SaveDataset(const TWikiElecBs&amp; ElecBs, const TStr&amp; OutFNm) const {
807    FILE *F = fopen(OutFNm.CStr(), &quot;wt&quot;);
808    fprintf(F, &quot;SuccElec\tRfa\tNetNodes\tNetEdges\tNetConstraint\tBarnStars\tTalkOutDeg\tTalkInDeg\tTalkTriads\tInWords\tOutWords\tInAdmins\tOutAdmins\tAdminTriads\tInAdminWords\tOutAdminWords\n&quot;);
809    TStrSet AdminSet;
810    for (TSsParser Ss(&quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki.admins2009.txt&quot;, ssfTabSep); Ss.Next(); ) {
811      TStr A=Ss[0]; AdminSet.AddKey(A.GetTrunc().GetLc());
812    }
813    TExeTm ExeTm;
814    TBarnStars  BarnStars;
815    TIntSet AdminNIdSet;
816    printf(&quot;Admin list: %d\n&quot;, AdminSet.Len());
817    for (int e = 0; e &lt; ElecBs.Len(); e++) {
818      const TWikiElec&amp; E = ElecBs.GetElec(e);
819      const TStr Usr = ElecBs.GetUsr(E.UsrId);
820      printf(&quot;%s: %s   &quot;, Usr.CStr(), E.RfaTitle.CStr());
821      if (! UsrNIdH.IsKey(Usr)) {
822        printf(&quot; DOES NOT TALK\n&quot;, Usr.CStr()); continue;
823      }
824      PSignNet Net = GetBeforeTimeNet(E.ElecTm);
825      const int NId = UsrNIdH.GetDat(Usr);
826      if (! Net-&gt;IsNode(NId)) {
827        printf(&quot; TALKS AFTER ELECTION\n&quot;); continue;
828      }
829      const TSignNet::TNodeI NI = Net-&gt;GetNI(NId);
830      printf(&quot; deg %d:%d &quot;, NI.GetInDeg(), NI.GetOutDeg());
831      int InWgt=0, OutWgt=0, InAdmins=0, OutAdmins=0, InAWgt=0, OutAWgt=0;
832      AdminNIdSet.Clr(false);
833      AdminNIdSet.AddKey(NI.GetId());
834      for (int i = 0; i &lt; NI.GetOutDeg(); i++) {
835        OutWgt += NI.GetOutEDat(i);
836        if (AdminSet.IsKey(UsrNIdH.GetKey(NI.GetOutNId(i)))) {
837          OutAWgt += NI.GetOutEDat(i);
838          OutAdmins++;
839          AdminNIdSet.AddKey(NI.GetOutNId(e));
840        }
841      }
842      for (int i = 0; i &lt; NI.GetInDeg(); i++) {
843        InWgt += NI.GetInEDat(i);
844        if (AdminSet.IsKey(UsrNIdH.GetKey(NI.GetInNId(i)))) {
845          InAWgt += NI.GetInEDat(i);
846          InAdmins++;
847          AdminNIdSet.AddKey(NI.GetInNId(e));
848        }
849      }
850      TSnap::TNetConstraint&lt;PSignNet&gt; NetC(Net, false);
851      NetC.CalcConstraints(NId);
852      TIntV AdminV; AdminNIdSet.GetKeyV(AdminV);
853      const double C = NetC.GetNodeC(NId);
854      const int BS = BarnStars.GetBarnStars(Usr, E.GetTm());
855      const int Triads = TSnap::GetNodeTriads(Net, NI.GetId());
856      const int AdmintTriads = TSnap::GetNodeTriads(TSnap::GetSubGraph(Net, AdminV), NI.GetId());
857      fprintf(F, &quot;%d\t%s\t%d\t%d\t%f\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\n&quot;, E.IsSucc?1:0, E.RfaTitle.CStr(), Net-&gt;GetNodes(), Net-&gt;GetEdges(), C, BS,
858        NI.GetOutDeg(), NI.GetInDeg(), Triads, InWgt, OutWgt, InAdmins, OutAdmins, AdmintTriads, InAWgt, OutAWgt);
859      fflush(F);
860      printf(&quot; [%s]\n&quot;, ExeTm.GetStr());
861    }
862    fclose(F);
863  }
864  PWikiTimeTalkNet TWikiTimeTalkNet::LoadWikiTimeTalkNet() {
865    const TStr WikiUsrTalk = &quot;W:\\data\\wiki20080103-parseByGuerogy\\enwiki-20080103.user_talk.7z&quot;; 
866    const TStr UsrChanges = &quot;W:\\data\\wiki20080103-parseByGuerogy\\enwiki.important-username-changes.2007-08-06&quot;;
867    const TStr BotList = &quot;W:\\data\\wiki20080103-parseByGuerogy\\enwiki.botlist.2007-03&quot;;
868    THash&lt;TChA, TChA&gt; UsrMapH;
869    THashSet&lt;TChA&gt; BotSet;
870    TChA Ln;
871    TExeTm ExeTm;
872    for (TFIn FIn(BotList); FIn.GetNextLn(Ln); ) {
873      BotSet.AddKey(Ln.ToLc()); }
874    printf(&quot;Bots: %d bots\n&quot;, BotSet.Len());
875    for (TSsParser Ss(UsrChanges, ssfSpaceSep); Ss.Next(); ) {
876      TChA U1=Ss[3], U2=Ss[4]; if (U1.ToLc()!=U2.ToLc()) { UsrMapH.AddDat(U1,U2); } }
877    printf(&quot;User changes: %d chages\n&quot;, UsrMapH.Len());
878    printf(&quot;Load Take network before the election:&quot;);
879    PWikiTimeTalkNet Net = TWikiTimeTalkNet::New();
880    printf(&quot;  Load %s &quot;, WikiUsrTalk.CStr());
881    TWikiMetaLoader WML(WikiUsrTalk);
882    int src, dst, k;
883    for (int edges=0; WML.Next(); edges++) {
884      if (! WML.Title.IsPrefix(&quot;User_talk:&quot;)) { printf(&quot;.&quot;); continue; }
885      const int b = (int) strlen(&quot;User_talk:&quot;);
886      int e2 = WML.Title.SearchCh(&#x27;/&#x27;, b)-1;
887      if (e2&lt;0) { e2=TInt::Mx; }
888      TChA Dst = WML.Title.GetSubStr(b, e2).ToLc();
889      TChA Src = WML.Usr.ToLc();
890      if (BotSet.IsKey(Src) || BotSet.IsKey(Dst)) { printf(&quot;&quot;); continue; }
891      if (TWikiMetaLoader::IsIpAddr(Src) || TWikiMetaLoader::IsIpAddr(Dst)) { printf(&quot;&quot;); continue; }
892      if (Src != Dst) { 
893        k = UsrMapH.GetKeyId(Src);
894        if (k != -1) { Src = UsrMapH[k]; }
895        k = UsrMapH.GetKeyId(Dst);
896        if (k != -1) { Dst = UsrMapH[k]; }
897        src = Net-&gt;UsrNIdH.AddDatId(Src);
898        dst = Net-&gt;UsrNIdH.AddDatId(Dst);
899        if (src != dst) {
900          if (! Net-&gt;IsNode(src)) { Net-&gt;AddNode(src, Src); }
901          if (! Net-&gt;IsNode(dst)) { Net-&gt;AddNode(dst, Dst); }
902          Net-&gt;AddEdge(src, dst, -1, TWikiTalkEdge2(WML.RevTm, WML.RevWrds));
903        }
904      }
905    }
906    printf(&quot;DONE NET[%s]\n&quot;, ExeTm.GetStr());  ExeTm.Tick();
907    return Net;
908  }
909  void TWikiEditCnt::LoadTxtBeforeElec(const TWikiElecBs&amp; ElecBs) {
910    const TStr WikiMain = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.main.7z&quot;;
911    const TStr WikiMainTalk = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.talk.7z&quot;;
912    const TStr WikiWiki = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.wikipedia.7z&quot;;
913    const TStr WikiWikiTalk = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.wikipedia_talk.7z&quot;;
914    const TStr UsrChanges = &quot;W:\\data\\wiki20080103-parseByGuerogy\\enwiki.important-username-changes.2007-08-06&quot;;
915    THash&lt;TChA, TChA&gt; UsrMapH;
916    for (TSsParser Ss(UsrChanges, ssfSpaceSep); Ss.Next(); ) {
917      TChA U1=Ss[3], U2=Ss[4]; if (U1.ToLc()!=U2.ToLc()) { UsrMapH.AddDat(U1,U2); } }
918    THash&lt;TChA, TVec&lt;TPair&lt;TChA, TSecTm&gt; &gt; &gt; UsrToRfaTmH;
919    for (int e = 0; e &lt; ElecBs.Len(); e++) {
920      UsrToRfaTmH.AddDat(ElecBs.GetUsr(ElecBs[e].GetUId())).Add(TPair&lt;TChA, TSecTm&gt;(ElecBs[e].RfaTitle, ElecBs[e].GetTm()));
921    }
922    TExeTm ExeTm;
923    printf(&quot;  Loading %s &quot;, WikiMain.GetFMid().CStr());
924    { TWikiMetaLoader WML(WikiMain);
925    for (int rec=0; WML.Next(); rec++) {
926      TChA U = WML.Usr;
927      if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
928      if (! UsrToRfaTmH.IsKey(U)) { continue; }
929      const TVec&lt;TPair&lt;TChA, TSecTm&gt; &gt;&amp; V = UsrToRfaTmH.GetDat(U);
930      for (int t = 0; t &lt; V.Len(); t++) {
931        if (WML.RevTm &lt;= V[t].Val2 ) { 
932          TEditCnt&amp; EC = RfaEdCntH.AddDat(V[t].Val1);
933          EC.MainE+=1; EC.MainW+=WML.RevWrds;
934          WML.CommentStr.ToLc();
935          if (WML.CommentStr.IsPrefix(&quot;rv&quot;) || WML.CommentStr.SearchStr(&quot;revert&quot;)!=-1) {
936            EC.RevE+=1; EC.RevW+=WML.RevWrds;
937          }
938        }
939      }
940    } }
941    Save(TZipOut(&quot;wikiEditCounts.BeforeElec.rar&quot;));
942    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiMainTalk.GetFMid().CStr());  ExeTm.Tick();
943    { TWikiMetaLoader WML(WikiMainTalk);
944    for (int rec=0; WML.Next(); rec++) {
945      TChA U = WML.Usr;
946      if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
947      if (! UsrToRfaTmH.IsKey(U)) { continue; }
948      const TVec&lt;TPair&lt;TChA, TSecTm&gt; &gt;&amp; V = UsrToRfaTmH.GetDat(U);
949      for (int t = 0; t &lt; V.Len(); t++) {
950        if (WML.RevTm &lt;= V[t].Val2 ) {
951          TEditCnt&amp; EC = RfaEdCntH.AddDat(V[t].Val1);
952          EC.MainTE+=1; EC.MainTW+=WML.RevWrds;
953        }
954      }
955    } }
956    Save(TZipOut(&quot;wikiEditCounts.BeforeElec.rar&quot;));
957    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiWiki.GetFMid().CStr());  ExeTm.Tick();
958    { TWikiMetaLoader WML(WikiWiki);
959    for (int rec=0; WML.Next(); rec++) {
960      TChA U = WML.Usr;
961      if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
962      if (! UsrToRfaTmH.IsKey(U)) { continue; }
963      const TVec&lt;TPair&lt;TChA, TSecTm&gt; &gt;&amp; V = UsrToRfaTmH.GetDat(U);
964      for (int t = 0; t &lt; V.Len(); t++) {
965        if (WML.RevTm &lt;= V[t].Val2 ) {
966          TEditCnt&amp; EC = RfaEdCntH.AddDat(V[t].Val1);
967          EC.WikiE+=1; EC.WikiW+=WML.RevWrds;
968        }
969      }
970    } }
971    Save(TZipOut(&quot;wikiEditCounts.BeforeElec.rar&quot;));
972    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiWikiTalk.GetFMid().CStr());  ExeTm.Tick();
973    { TWikiMetaLoader WML(WikiWikiTalk);
974    for (int rec=0; WML.Next(); rec++) {
975      TChA U = WML.Usr;
976      if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
977      if (! UsrToRfaTmH.IsKey(U)) { continue; }
978      const TVec&lt;TPair&lt;TChA, TSecTm&gt; &gt;&amp; V = UsrToRfaTmH.GetDat(U);
979      for (int t = 0; t &lt; V.Len(); t++) {
980        if (WML.RevTm &lt;= V[t].Val2 ) {
981          TEditCnt&amp; EC = RfaEdCntH.AddDat(V[t].Val1);
982          EC.WikiTE+=1; EC.WikiTW+=WML.RevWrds;
983        }
984      }
985    } }
986    Save(TZipOut(&quot;wikiEditCounts.BeforeElec.rar&quot;));
987    printf(&quot; [%s]\n&quot;, ExeTm.GetStr());
988  }
989  void TWikiEditCnt::LoadTxtAll(const TWikiElecBs&amp; ElecBs) {
990    const TStr WikiMain = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.main.7z&quot;;
991    const TStr WikiMainTalk = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.talk.7z&quot;;
992    const TStr WikiWiki = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.wikipedia.7z&quot;;
993    const TStr WikiWikiTalk = &quot;W:\\Data\\wiki20080103-parseByGuerogy\\enwiki-20080103.wikipedia_talk.7z&quot;;
994    const TStr UsrChanges = &quot;W:\\data\\wiki20080103-parseByGuerogy\\enwiki.important-username-changes.2007-08-06&quot;;
995    TExeTm ExeTm;
996    printf(&quot;  Loading %s &quot;, WikiMain.GetFMid().CStr());
997    { TWikiMetaLoader WML(WikiMain);
998    for (int rec=0; WML.Next(); rec++) {
999      if (! ElecBs.IsUsr(WML.Usr)) { continue; }
1000      TEditCnt&amp; EC = RfaEdCntH.AddDat(WML.Usr);
1001      EC.MainE+=1; EC.MainW+=WML.RevWrds;
1002      WML.CommentStr.ToLc();
1003      if (WML.CommentStr.IsPrefix(&quot;rv&quot;) || WML.CommentStr.SearchStr(&quot;revert&quot;)!=-1) {
1004        EC.RevE+=1; EC.RevW+=WML.RevWrds;
1005      }
1006    } }
<span onclick='openModal()' class='match'>1007    Save(TZipOut(&quot;wikiEditCounts.All.rar&quot;));
1008    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiMainTalk.GetFMid().CStr());  ExeTm.Tick();
1009    { TWikiMetaLoader WML(WikiMainTalk);
1010    for (int rec=0; WML.Next(); rec++) {
1011      if (! ElecBs.IsUsr(WML.Usr)) { continue; }
</span>1012      TEditCnt&amp; EC = RfaEdCntH.AddDat(WML.Usr);
1013      EC.MainTE+=1; EC.MainTW+=WML.RevWrds;
1014    } }
1015    Save(TZipOut(&quot;wikiEditCounts.All.rar&quot;));
1016    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiWiki.GetFMid().CStr());  ExeTm.Tick();
1017    { TWikiMetaLoader WML(WikiWiki);
1018    for (int rec=0; WML.Next(); rec++) {
1019      TChA U = WML.Usr;
1020      if (! ElecBs.IsUsr(WML.Usr)) { continue; }
1021      TEditCnt&amp; EC = RfaEdCntH.AddDat(WML.Usr);
1022      EC.WikiE+=1; EC.WikiW+=WML.RevWrds;
1023    } }
1024    Save(TZipOut(&quot;wikiEditCounts.All.rar&quot;));
1025    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiWikiTalk.GetFMid().CStr());  ExeTm.Tick();
1026    { TWikiMetaLoader WML(WikiWikiTalk);
1027    for (int rec=0; WML.Next(); rec++) {
1028      if (! ElecBs.IsUsr(WML.Usr)) { continue; }
1029      TEditCnt&amp; EC = RfaEdCntH.AddDat(WML.Usr);
1030      EC.WikiTE+=1; EC.WikiTW+=WML.RevWrds;
1031    } }
1032    Save(TZipOut(&quot;wikiEditCounts.All.rar&quot;));
1033    printf(&quot; [%s]\n&quot;, ExeTm.GetStr());
1034  }
1035  void TWikiEditCnt::SaveTxt(const TWikiElecBs&amp; ElecBs, const TStr&amp; OutFNm) {
1036    FILE *F = fopen(OutFNm.CStr(), &quot;wt&quot;);
1037    fprintf(F, &quot;Rfat\tMainE\tMainW\tMainTE\tMainTW\tWikiE\tWikiW\tWikiTE\tWikiTW\n&quot;);
1038    for (TSsParser Ss(&quot;isSuccVote-TalkNet3.tab&quot;, ssfTabSep); Ss.Next(); ) {
1039      TStr Rfa = Ss[1];
1040      if (! RfaEdCntH.IsKey(Rfa)) {
1041        printf(&quot;%s\n&quot;, Rfa.CStr());
1042        fprintf(F, &quot;%s\t0\t0\t0\t0\t0\t0\t0\t0\n&quot;, Rfa.CStr());
1043      } else {
1044        const TEditCnt&amp; EC = RfaEdCntH.GetDat(Rfa);
1045        fprintf(F, &quot;%s\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\n&quot;, Rfa.CStr(),
1046          EC.MainE(), EC.MainW(), EC.MainTE(), EC.MainTW(), EC.WikiE(), EC.WikiW(), EC.WikiTE(), EC.WikiTW());
1047      }
1048    }
1049    fclose(F);
1050  }
1051  TWikiElec::TWikiElec(TSIn&amp; SIn) : RfaTitle(SIn), UsrId(SIn), NomUId(SIn), BurUId(SIn), IsSucc(SIn), ElecTm(SIn), VoteV(SIn) {
1052  }
1053  void TWikiElec::Save(TSOut&amp; SOut) const {
1054    RfaTitle.Save(SOut); UsrId.Save(SOut); NomUId.Save(SOut);
1055    BurUId.Save(SOut); IsSucc.Save(SOut); ElecTm.Save(SOut);
1056    VoteV.Save(SOut);
1057  }
1058  bool TWikiElec::operator &lt; (const TWikiElec&amp; WE) const {
1059    return ElecTm&lt;WE.ElecTm || (ElecTm==WE.ElecTm &amp;&amp; UsrId&lt;WE.UsrId);
1060  }
1061  void TWikiElec::SetIsVoteFlag() {
1062    THash&lt;TInt, TIntPr&gt; UsrVoteH(Len());
1063    for (int i = 0; i &lt; VoteV.Len(); i++) {
1064      if (VoteV[i].GetIndent() != 0) { continue; } 
1065      if (VoteV[i].GetUId() == UsrId) { continue; }  
1066      if (! UsrVoteH.IsKey(VoteV[i].GetUId())) {
1067        UsrVoteH.AddDat(VoteV[i].GetUId(), TIntPr(VoteV[i].GetTm().GetAbsSecs(), i));
1068      } else {
1069        TIntPr&amp; Dat = UsrVoteH.GetDat(VoteV[i].GetUId());
1070        if (Dat.Val1 &gt; (int)VoteV[i].GetTm().GetAbsSecs()) { 
1071          Dat = TIntPr(VoteV[i].GetTm().GetAbsSecs(), i);
1072        }
1073      }
1074    }
1075    for (int v = 0; v &lt; VoteV.Len(); v++) {
1076      VoteV[v].IsAVote = false;
1077    }
1078    for (int v = 0; v &lt; UsrVoteH.Len(); v++) {
1079      VoteV[UsrVoteH[v].Val2].IsAVote = true;
1080    }
1081  }
1082  double TWikiElec::GetFracSup(const bool&amp; OnlyVotes) const {
1083    const TIntTr Votes = GetVotes(OnlyVotes);
1084    return double(Votes.Val1)/double(Votes.Val1+Votes.Val3);
1085  }
1086  double TWikiElec::GetFracSup(int VoteId1, int VoteId2) const {
1087    double Sup=0;
1088    for (int v = VoteId1; v &lt; TMath::Mn(VoteId2, Len()); v++) {
1089      if (VoteV[v].GetVote()==1) { Sup+=1; }
1090    }
1091    if (VoteId1==VoteId2) { return 0.0; }
1092    return Sup/double(VoteId2-VoteId1);
1093  }
1094  double TWikiElec::GetTrend(int VoteId1, int VoteId2) const {
1095    TFltPrV XY;
1096    for (int v = VoteId1; v &lt; VoteId2; v++) {
1097      XY.Add(TFltPr(v, (double)VoteV[v].GetVote()));
1098    }
1099    double A, B, SigA, SigB, Chi2, R2;
1100    TSpecFunc::LinearFit(XY, A, B, SigA, SigB, Chi2, R2);
1101    return B;
1102  }
1103  TIntTr TWikiElec::GetVotes(const bool&amp; OnlyVotes) const {
1104    int Sup=0, Opp=0, Neu=0;
1105    for (int i = 0; i &lt; VoteV.Len(); i++) {
1106      if (OnlyVotes &amp;&amp; ! VoteV[i].IsVote()) { continue; }
1107      if (VoteV[i].GetVote()==1) { Sup++; }
1108      else if (VoteV[i].GetVote()==0) { Neu++; }
1109      else if (VoteV[i].GetVote()==-1) { Opp++; }
1110    }
1111    return TIntTr(Sup, Neu, Opp);
1112  }
1113  void TWikiElec::GetVotesOt(TWikiVoteV&amp; WVoteV, const bool&amp; OnlyVotes) const {
1114    if (! OnlyVotes) {
1115      WVoteV = VoteV;
1116      WVoteV.Sort();
1117      return;
1118    }
1119    TIntPrV TmIdV;
1120    for (int i = 0; i &lt; VoteV.Len(); i++) {
1121      if (OnlyVotes &amp;&amp; ! VoteV[i].IsVote()) { continue; }
1122      TmIdV.Add(TIntPr(VoteV[i].VoteTm.GetAbsSecs(), i));
1123    }
1124    TmIdV.Sort();
1125    WVoteV.Clr(false);
1126    for (int v = 0; v &lt; TmIdV.Len(); v++) {
1127      WVoteV.Add(VoteV[TmIdV[v].Val2]);
1128    }
1129    WVoteV.Sort();
1130  }
1131  int TWikiElec::GetAvgVoteOt(TFltV&amp; AvgVoteV, const bool&amp; OnlyVotes) const {
1132    TWikiVoteV WVoteV;  GetVotesOt(WVoteV, OnlyVotes);
1133    double VoteSum = 0;
1134    AvgVoteV.Clr(false);
1135    for (int i = 0; i &lt; WVoteV.Len(); i++) {
1136      VoteSum += WVoteV[i].GetVote() &gt; 0 ? 1 : 0;
1137      AvgVoteV.Add(VoteSum/double(i+1));
1138    }
1139    return AvgVoteV.Len();
1140  }
1141  int TWikiElec::GetAvgVoteDevOt(TFltV&amp; AvgVoteV, const bool&amp; OnlyVotes) const {
1142    TWikiVoteV WVoteV;  GetVotesOt(WVoteV, OnlyVotes);
1143    double XBar = WVoteV[0].GetVote() &gt; 0 ? 1 : 0;
1144    AvgVoteV.Clr(false);
1145    for (int i = 1; i &lt; WVoteV.Len(); i++) {
1146      const double CurVote = WVoteV[i].GetVote() &gt; 0 ? 1 : 0;
1147      AvgVoteV.Add(fabs(CurVote-XBar)/double(i+1));
1148      XBar = (i*XBar+CurVote)/double(i+1);
1149    }
1150    return AvgVoteV.Len();
1151  }
1152  int TWikiElec::GetRunLen(const int&amp; VoteId) const {
1153    const int V = VoteV[VoteId].GetVote();
1154    int runL=0;
1155    for (int v = VoteId+1; v &lt; Len(); v++) {
1156      if (VoteV[v].GetVote() == V) { runL++; }
1157      else { return runL; }
1158    }
1159    return runL;
1160  }
1161  void TWikiElec::PermuteVotes() {
1162    TIntV ValV(VoteV.Len(), 0);
1163    for (int i = 0; i &lt; VoteV.Len(); i++) {
1164      ValV.Add(VoteV[i].UsrVote); }
1165    ValV.Shuffle(TInt::Rnd);
1166    for (int i = 0; i &lt; ValV.Len(); i++) {
1167      VoteV[i].UsrVote=ValV[i]; }
1168  }
1169  void TWikiElec::KeepVotes(const TIntSet&amp; UIdSet) {
1170    TWikiVoteV NewVoteV;
1171    for (int v = 0; v &lt; VoteV.Len(); v++) {
1172      if (UIdSet.IsKey(VoteV[v].GetUId())) {
1173        NewVoteV.Add(VoteV[v]);
1174      }
1175    }
1176    VoteV=NewVoteV;
1177  }
1178  void TWikiElec::GetOnlyVotes(TWikiElec&amp; NewElec, const bool&amp; OnlySupOpp) const {
1179    NewElec.RfaTitle = RfaTitle;
1180    NewElec.UsrId = UsrId;
1181    NewElec.NomUId = NomUId;
1182    NewElec.BurUId = BurUId;
1183    NewElec.IsSucc = IsSucc;
1184    NewElec.ElecTm = ElecTm;
1185    NewElec.VoteV.Clr(false);
1186    for (int i = 0; i &lt; VoteV.Len(); i++) {
1187      if (! VoteV[i].IsVote()) { continue; }
1188      if (OnlySupOpp &amp;&amp; VoteV[i].GetVote()==0) { continue; }
1189      NewElec.VoteV.Add(VoteV[i]);
1190    }
1191  }
1192  void TWikiElec::RemoveSelfVotes() {
1193    TWikiVoteV VoteV2(Len(), 0);
1194    for (int v = 0; v &lt; VoteV.Len(); v++) {
1195      if (VoteV[v].GetIndent()==0 &amp;&amp; VoteV[v].GetUId()==UsrId) { continue; } 
1196      VoteV2.Add(VoteV[v]);
1197    }
1198    VoteV.Swap(VoteV2);
1199  }
1200  void TWikiElec::Dump(const TStrHash&lt;TInt&gt;&amp; UsrH) const {
1201    TIntTr V = GetVotes(true);
1202    if (UsrH.IsKeyId(UsrId)) {
1203      printf(&quot;\nELEC %s : %s %d vote at %s votes %d\n&quot;, RfaTitle.CStr(), UsrH.GetKey(UsrId), UsrId, ElecTm.GetYmdTmStr().CStr(), VoteV.Len()); }
1204    else {
1205       printf(&quot;\nELEC %s : %d  %d vote at %s votes %d\n&quot;, RfaTitle.CStr(), UsrId, ElecTm.GetYmdTmStr().CStr(), VoteV.Len()); }
1206    printf(&quot;    %d / %d / %d  =  %f\n&quot;, V.Val1, V.Val2, V.Val3, V.Val1/double(V.Val1+V.Val3));
1207    for (int v = 0; v &lt; VoteV.Len(); v++) {
1208      if (UsrH.IsKeyId(VoteV[v].UsrId)) {
1209        printf(&quot;  %2d  %2d %s: %s (%d)  %s  t:%d  i: %d\n&quot;, v+1, VoteV[v].UsrVote, VoteV[v].IsVote()?&quot;V&quot;:&quot; &quot;, UsrH.GetKey(VoteV[v].UsrId), VoteV[v].UsrId, VoteV[v].VoteTm.GetYmdTmStr().CStr(), VoteV[v].TxtLen, VoteV[v].UsrIndent);
1210      } else {
1211        printf(&quot;  %2d  %2d %s: %d  %s  t:%d  i: %d\n&quot;, v+1, VoteV[v].UsrVote, VoteV[v].IsVote()?&quot;V&quot;:&quot; &quot;, VoteV[v].UsrId, VoteV[v].VoteTm.GetYmdTmStr().CStr(), VoteV[v].TxtLen, VoteV[v].UsrIndent);
1212      }
1213    }
1214  }
1215  void TWikiElecBs::GetEIdByVotes(TIntV&amp; EIdV, const bool&amp; AscNumVotes) const {
1216    TIntPrV V(Len(), 0);
1217    for (int u = 0; u &lt; Len(); u++) {
1218      const TWikiElec&amp; E = GetElec(u);
1219      V.Add(TIntPr(E.Len(), E.UsrId));
1220    }
1221    V.Sort(AscNumVotes);
1222    EIdV.Clr(false);
1223    for (int u = 0; u &lt; V.Len(); u++) {
1224      EIdV.Add(V[u].Val2); }
1225  }
1226  void TWikiElecBs::GetEIdByVotes(TIntV&amp; EIdV, const int&amp; MinLen, const double&amp; FracPos, const double AboveFrac, const bool&amp; AscNumVotes) const {
1227    TFltIntPrV V(Len(), 0);
1228    for (int u = 0; u &lt; Len(); u++) {
1229      const TWikiElec&amp; E = GetElec(u);
1230      if (E.Len() &lt; MinLen) { continue; }
1231      if ((AboveFrac &amp;&amp; E.GetFracSup() &gt; FracPos) || (!AboveFrac &amp;&amp; E.GetFracSup() &lt; FracPos)) {
1232        V.Add(TFltIntPr(E.Len(), E.UsrId)); }
1233    }
1234    V.Sort(AscNumVotes);
1235    EIdV.Clr(false);
1236    for (int u = 0; u &lt; V.Len(); u++) {
1237      EIdV.Add(V[u].Val2); }
1238  }
1239  void TWikiElecBs::GetEIdByFrac(TIntV&amp; EIdV, const int&amp; MinLen, const double&amp; MnFracSup, const double&amp; MxFracSup) const {
1240    TFltIntPrV V(Len(), 0);
1241    for (int u = 0; u &lt; Len(); u++) {
1242      const TWikiElec&amp; E = GetElec(u);
1243      if (E.Len() &lt; MinLen) { continue; }
1244      const double FracSup = E.GetFracSup();
1245      if (FracSup==1) { continue; }
1246      if (FracSup &gt;= MnFracSup &amp;&amp; FracSup &lt;= MxFracSup) {
1247        V.Add(TFltIntPr(FracSup, E.UsrId)); }
1248    }
1249    V.Sort(true);
1250    EIdV.Clr(false);
1251    for (int u = 0; u &lt; V.Len(); u++) {
1252      EIdV.Add(V[u].Val2); }
1253  }
1254  void TWikiElecBs::GetUsrV(TIntV&amp; UIdV) const {
1255    TIntSet UIdSet;
1256    for (int e = 0; e &lt; Len(); e++) {
1257      const TWikiElec&amp; E = GetElec(e);
1258      UIdSet.AddKey(E.GetUId());
1259      for (int v = 0; v &lt; E.Len(); v++) {
1260        UIdSet.AddKey(E.GetVote(v).GetUId());
1261      }
1262    }
1263    UIdSet.GetKeyV(UIdV);
1264  }
1265  void TWikiElecBs::GetElecUsrV(TIntV&amp; ElecUsrV) const {
1266    ElecUsrV.Clr(false);
1267    for (int e = 0; e &lt; Len(); e++) {
1268      const TWikiElec&amp; E = GetElec(e);
1269      ElecUsrV.Add(E.UsrId);
1270    }
1271  }
1272  void TWikiElecBs::GetElecAdminUsrV(TIntV&amp; ElecAdminUsrV) const {
1273    ElecAdminUsrV.Clr(false);
1274    for (int e = 0; e &lt; Len(); e++) {
1275      const TWikiElec&amp; E = GetElec(e);
1276      if (E.IsSucc) {
1277        ElecAdminUsrV.Add(E.UsrId);
1278      }
1279    }
1280  }
1281  void TWikiElecBs::GetElecNonAdminUsrV(TIntV&amp; ElecNonAdminUsrV) const {
1282    ElecNonAdminUsrV.Clr(false);
1283    for (int e = 0; e &lt; Len(); e++) {
1284      const TWikiElec&amp; E = GetElec(e);
1285      if (! E.IsSucc) {
1286        ElecNonAdminUsrV.Add(E.UsrId);
1287      }
1288    }
1289  }
1290  void TWikiElecBs::GetFqVoters(TIntSet&amp; FqVoterSet, const int&amp; MinVotes, const int&amp; MinElecLen, const bool&amp; OnlyAdmins) const {
1291    TIntH UsrCntH, CntH;
1292    printf(&quot;%d\n&quot;, Len());
1293    TIntSet AdminSet;
1294    if (OnlyAdmins) {
1295      GetAdminSet(AdminSet);
1296    }
1297    for (int e = 0; e &lt; Len(); e++) {
1298      const TWikiElec&amp; E = GetElec(e);
1299      if (E.Len() &lt; MinElecLen) { continue; }
1300      for (int v = 0; v &lt; E.Len(); v++) {
1301        if (OnlyAdmins &amp;&amp; ! AdminSet.IsKey(E[v].GetUId())) {
1302          continue; } 
1303        UsrCntH.AddDat(E[v].GetUId()) += 1;
1304      }
1305    }
1306    for (int i = 0; i &lt; UsrCntH.Len(); i++) {
1307      CntH.AddDat(UsrCntH[i]) += 1; }
1308    FqVoterSet.Clr(false);
1309    UsrCntH.SortByDat(false);
1310    for (int i = 0; i &lt; UsrCntH.Len(); i++) {
1311      if (UsrCntH[i] &gt;= MinVotes) {
1312        FqVoterSet.AddKey(UsrCntH.GetKey(i));
1313      }
1314    }
1315  }
1316  void TWikiElecBs::GetUsrVotes(TIntPrV&amp; VoteUIdV) const {
1317    TIntH UsrCntH;
1318    for (int e = 0; e &lt; Len(); e++) {
1319      const TWikiElec&amp; E = GetElec(e);
1320      for (int v = 0; v &lt; E.Len(); v++) {
1321        UsrCntH.AddDat(E[v].GetUId()) += 1;
1322      }
1323    }
1324    VoteUIdV.Clr();
1325    for (int i = 0; i &lt; UsrCntH.Len(); i++) {
1326      VoteUIdV.Add(TIntPr(UsrCntH[i], UsrCntH.GetKey(i)));
1327    }
1328    VoteUIdV.Sort(false);
1329  }
1330  void TWikiElecBs::GetAdminSet(TIntSet&amp; AdminSet) const {
1331    AdminSet.Clr(false);
1332    for (int e = 0; e &lt; Len(); e++) {
1333      const TWikiElec&amp; E = GetElec(e);
1334      if (E.IsSucc) {
1335        AdminSet.AddKey(E.UsrId);
1336      }
1337    }
1338    printf(&quot;  %d admins from elecs. &quot;, AdminSet.Len());
1339    if (TFile::Exists(&quot;../../admin-list.txt&quot;)) {
1340      for (TSsParser Ss(&quot;../../admin-list.txt&quot;, ssfTabSep); Ss.Next(); ) {
1341        TStr U = Ss[0];
1342        if (IsUsr(U)) { AdminSet.AddKey(GetUId(U)); }
1343        if(IsUsr(U.GetLc())) { AdminSet.AddKey(GetUId(U.GetLc())); }
1344      }
1345    }
1346    printf(&quot;  %d admins after admin-list.txt\n&quot;, AdminSet.Len());
1347  }
1348  void TWikiElecBs::GetFqVoterSet(TIntSet&amp; FqVoterSet) const {
1349    TIntPrV VoteUIdV;
1350    GetUsrVotes(VoteUIdV);
1351    int HalfVotes = GetVotes()/2, SoFar=0;
1352    FqVoterSet.Clr(false);
1353    for (int i = 0; i &lt; VoteUIdV.Len() &amp;&amp; SoFar &lt; HalfVotes; i++) {
1354      FqVoterSet.AddKey(VoteUIdV[i].Val2);
1355      SoFar+=VoteUIdV[i].Val1;
1356    }
1357    printf(&quot;Users:%d (%d votes) FqVoters:%d (%d votes)\n&quot;, VoteUIdV.Len(), HalfVotes*2, FqVoterSet.Len(), SoFar);
1358  }
1359  void TWikiElecBs::GetAdminTmSet(THash&lt;TInt, TSecTm&gt;&amp; AdminSet) const {
1360    AdminSet.Clr(false);
1361    for (int e = 0; e &lt; Len(); e++) {
1362      const TWikiElec&amp; E = GetElec(e);
1363      if (E.IsSucc) {
1364        AdminSet.AddDat(E.UsrId, E.GetTm());
1365      }
1366    }
1367  }
1368  void TWikiElecBs::KeepFqVoters(const int&amp; MinVotes, const int&amp; MinElecLen, const bool&amp; OnlyAdmins) {
1369    TIntSet Voters;
1370    GetFqVoters(Voters, MinVotes, MinElecLen, OnlyAdmins);
1371    printf(&quot;freq  voters %d\n&quot;, Voters.Len());
1372    int VotesB=0, VotesA=0;
1373    for (int e = 0; e &lt; Len(); e++) {
1374      TWikiElec&amp; E = GetElec(e);
1375      VotesB += E.Len();
1376      if (E.Len() &lt; MinElecLen) { E.VoteV.Clr(); }
1377      E.KeepVotes(Voters);
1378      VotesA += E.Len();
1379    }
1380    printf(&quot;Votes: %d --&gt; %d\n&quot;, VotesB, VotesA);
1381  }
1382  void TWikiElecBs::KeepVoters(const bool&amp; KeepAdmins, const bool&amp; KeepNonAdmins) {
1383    TIntSet KeepVoters, Admins;
1384    GetAdminSet(Admins);
1385    if (KeepAdmins) {
1386      KeepVoters = Admins; }
1387    if (KeepNonAdmins) {
1388      TIntV UIdV; GetUsrV(UIdV);
1389      for (int i = 0; i &lt; UIdV.Len(); i++) {
1390        if (! Admins.IsKey(UIdV[i])) {
1391          KeepVoters.AddKey(UIdV[i]); } }
1392    }
1393    int VotesB=0, VotesA=0;
1394    printf(&quot;voters %d\n&quot;, KeepVoters.Len());
1395    for (int e = 0; e &lt; Len(); e++) {
1396      TWikiElec&amp; E = GetElec(e);
1397      VotesB += E.Len();
1398      E.KeepVotes(KeepVoters);
1399      VotesA += E.Len();
1400    }
1401    printf(&quot;  votes: %d --&gt; %d\n&quot;, VotesB, VotesA);
1402  }
1403  void TWikiElecBs::KeepTopVoters(const int&amp; Votes, const bool&amp; KeepTop) {
1404  }
1405  void TWikiElecBs::PermuteVotes() {
1406    printf(&quot;Permute election entries...&quot;);
1407    for (int u = 0; u &lt; Len(); u++) {
1408      GetElec(u).PermuteVotes();
1409    }
1410    printf(&quot;done.\n&quot;);
1411  }
1412  void TWikiElecBs::SortVotesByTm() {
1413    for (int e = 0; e &lt; Len(); e++) {
1414      GetElec(e).VoteV.Sort();
1415    }
1416  }
1417  int TWikiElecBs::GetVoteTrails(const int&amp; MinUsrVotes, const bool&amp; No01Prob, TIntV&amp; UIdV, TVec&lt;TFltPrV&gt;&amp; ProbSupTmV,
1418                                  TVec&lt;TFltPrV&gt;&amp; FracSupTmV, TVec&lt;TFltPrV&gt;&amp; ProbSupFracSupV, TVec&lt;TFltPrV&gt;&amp; VotesTmV) const {
1419    UIdV.Clr();  ProbSupTmV.Clr();  FracSupTmV.Clr();
1420    ProbSupFracSupV.Clr();  VotesTmV.Clr();
1421    THash&lt;TInt, TIntPrV&gt; UIdVotesH;
1422    TIntFltH FracSupH;
1423    for (int e = 0; e &lt; Len(); e++) {
1424      const TWikiElec&amp; E = GetElec(e);
1425      if (E.Len() &lt; 10) { continue; } 
1426      for (int v = 0; v &lt; E.Len(); v++) {
1427        UIdVotesH.AddDat(E[v].GetUId()).Add(TIntPr(e,v));
1428      }
1429      FracSupH.AddDat(e, E.GetFracSup());
1430    }
1431    int Votes = 0;
1432    UIdVotesH.SortByDat(false);
1433    TIntH AllCntH, AllCntHS, AllCntHF;
1434    for (int u = 0; u &lt; UIdVotesH.Len(); u++) {
1435      THash&lt;TInt, TMom&gt; TProbH, TFracH, UFPH;
1436      THash&lt;TFlt, TFlt&gt; TVotesH;
1437      TIntPrV&amp; EV = UIdVotesH[u];
1438      EV.Sort();
1439      const int UId = UIdVotesH.GetKey(u);
1440      if (EV.Len() &lt; MinUsrVotes) { continue; }
1441      EV.Del(EV.Len()/2, EV.Len()-1);
1442      for (int ev = 0; ev &lt; EV.Len(); ev++) { 
1443        const TWikiElec&amp; E = GetElec(EV[ev].Val1);
1444        const int v = EV[ev].Val2;
1445        if (v &lt; 10) { continue; } 
1446        const int Vote = E[v].GetVote()==1 ? 1:0;
1447        const double Frac = E.GetFracSup(0, v); 
1448        if (v &lt; 110) { 
1449          TProbH.AddDat(10*(v/10)).Add(Vote);
1450          TFracH.AddDat(10*(v/10)).Add(Frac);
1451          TVotesH.AddDat(10*(v/10)) += 1;
1452        }
1453        UFPH.AddDat(10*(int)TMath::Round(10*Frac)).Add(Vote);
1454        Votes++;
1455      }
1456      double M;
1457      TFltPrV TPV, TFV, TFPV, TVV;
1458      for (int i = 0; i &lt; TProbH.Len(); i++) {
1459        TProbH[i].Def();   M = TProbH[i].GetMean();
1460        if (No01Prob &amp;&amp; M!=0 &amp;&amp; M!=1) { TPV.Add(TFltPr(TProbH.GetKey(i).Val, M)); }
1461        else if (! No01Prob) { TPV.Add(TFltPr(TProbH.GetKey(i).Val, M)); }
1462      }
1463      for (int i = 0; i &lt; TFracH.Len(); i++) {
1464        TFracH[i].Def();   M = TFracH[i].GetMean();
1465        if (No01Prob &amp;&amp; M!=0 &amp;&amp; M!=1) { TFV.Add(TFltPr(TFracH.GetKey(i).Val, M)); }
1466        else if (! No01Prob) { TFV.Add(TFltPr(TFracH.GetKey(i).Val, M)); }
1467      }
1468      for (int i = 0; i &lt; UFPH.Len(); i++) {
1469        UFPH[i].Def();   M = UFPH[i].GetMean();
1470        if (No01Prob &amp;&amp; M!=0 &amp;&amp; M!=1) { TFPV.Add(TFltPr(UFPH.GetKey(i).Val, M)); }
1471        else if (! No01Prob) { TFPV.Add(TFltPr(UFPH.GetKey(i).Val, M)); }
1472      }
1473      TVotesH.GetKeyDatPrV(TVV);  TVV.Sort();
1474      TFPV.Sort(); TPV.Sort(); TFV.Sort();
1475      if (TFPV[0].Val1!=0.0) { TFPV.Ins(0, TFltPr(0,0)); printf(&quot;Z&quot;);} 
1476      if (TFPV.Last().Val1!=100.0) { TFPV.Add(TFltPr(100,1)); printf(&quot;O&quot;);} 
1477      UIdV.Add(UId);
1478      ProbSupTmV.Add(TPV);
1479      FracSupTmV.Add(TFV);
1480      ProbSupFracSupV.Add(TFPV);
1481      VotesTmV.Add(TVV);
1482    }
1483    IAssert(UIdV.Len() == ProbSupTmV.Len());
1484    return Votes;
1485  }
1486  void TWikiElecBs::GetVoteTrails2(const int&amp; MinUsrVotes, const bool&amp; No01Prob, TIntV&amp; UIdV, TVec&lt;TFltPrV&gt;&amp; VoteIdxFracSupV, TVec&lt;TFltPrV&gt;&amp; NVotesFracSupV) const {
1487    UIdV.Clr();  VoteIdxFracSupV.Clr();  NVotesFracSupV.Clr();
1488    THash&lt;TInt, TIntPrV&gt; UIdVotesH;
1489    TIntFltH FracSupH;
1490    for (int e = 0; e &lt; Len(); e++) {
1491      const TWikiElec&amp; E = GetElec(e);
1492      if (E.Len() &lt; 10) { continue; } 
1493      for (int v = 0; v &lt; E.Len(); v++) {
1494        UIdVotesH.AddDat(E[v].GetUId()).Add(TIntPr(e,v));
1495      }
1496      FracSupH.AddDat(e, E.GetFracSup());
1497    }
1498    UIdVotesH.SortByDat(false);
1499    TIntH AllCntH, AllCntHS, AllCntHF;
1500    for (int u = 0; u &lt; UIdVotesH.Len(); u++) {
1501      THash&lt;TInt, TMom&gt; FSVIdxH;
1502      TFltFltH FSVotesH;
1503      const TIntPrV&amp; EV = UIdVotesH[u];
1504      const int UId = UIdVotesH.GetKey(u);
1505      if (EV.Len() &lt; MinUsrVotes) { continue; }
1506      for (int ev = 0; ev &lt; EV.Len(); ev++) { 
1507        const TWikiElec&amp; E = GetElec(EV[ev].Val1);
1508        const int v = EV[ev].Val2;
1509        const int Vote = E[v].GetVote()==1 ? 1:0;
1510        const double Frac = E.GetFracSup(0, v); 
1511        FSVotesH.AddDat(10*int(10*Frac)) += 1;
1512        FSVIdxH.AddDat(10*int(10*Frac)).Add(v);
1513      }
1514      UIdV.Add(UId);
1515      double M = 0;
1516      VoteIdxFracSupV.Add();
1517      TFltPrV&amp; VoteIdxV = VoteIdxFracSupV.Last();
1518      for (int i = 0; i &lt; FSVIdxH.Len(); i++) {
1519        FSVIdxH[i].Def();   M = FSVIdxH[i].GetMean();
1520        if (No01Prob &amp;&amp; M!=0 &amp;&amp; M!=1) { VoteIdxV.Add(TFltPr(FSVIdxH.GetKey(i).Val, M)); }
1521        else if (! No01Prob) { VoteIdxV.Add(TFltPr(FSVIdxH.GetKey(i).Val, M)); }
1522      }
1523      VoteIdxV.Sort();
1524      NVotesFracSupV.Add();
1525      FSVotesH.GetKeyDatPrV(NVotesFracSupV.Last());
1526      NVotesFracSupV.Last().Sort();
1527    }
1528  }
1529  void TWikiElecBs::GetUsrVoteTrail(const TIntV&amp; UIdV, TVec&lt;TFltPrV&gt;&amp; ProbPosFracPosV) const {
1530    ProbPosFracPosV.Clr();
1531    THash&lt;TInt, TIntPrV&gt; UIdVotesH;
1532    for (int e = 0; e &lt; Len(); e++) {
1533      const TWikiElec&amp; E = GetElec(e);
1534      if (E.Len() &lt; 10) { continue; } 
1535      for (int v = 0; v &lt; E.Len(); v++) {
1536        UIdVotesH.AddDat(E[v].GetUId()).Add(TIntPr(e,v));
1537      }
1538    }
1539    for (int u = 0; u &lt; UIdV.Len(); u++) {
1540      ProbPosFracPosV.Add();
1541      if (! UIdVotesH.IsKey(UIdV[u])) { continue; }
1542      const TIntPrV&amp; EV = UIdVotesH.GetDat(UIdV[u]);
1543      THash&lt;TInt, TMom&gt; FracProbH;
1544      for (int ev = 0; ev &lt; EV.Len(); ev++) { 
1545        const TWikiElec&amp; E = GetElec(EV[ev].Val1);
1546        const int v = EV[ev].Val2;
1547        const int Vote = E[v].GetVote()==1 ? 1:0;
1548        const double Frac = E.GetFracSup(0, v); 
1549        FracProbH.AddDat(10*int(10*Frac)).Add(Vote);
1550      }
1551      FracProbH.SortByKey();
1552      TFltPrV&amp; ProbFracV = ProbPosFracPosV.Last();
1553      for (int i = 0; i &lt; FracProbH.Len(); i++) {
1554        FracProbH[i].Def();
1555        const double M = FracProbH[i].GetMean();
1556        ProbFracV.Add(TFltPr(FracProbH.GetKey(i).Val, M));
1557      }
1558      ProbFracV.Sort();
1559    }
1560  }
1561  void TWikiElecBs::GetUsrAreaUTrail(const TIntV&amp; UIdV, TFltV&amp; AreaV) const {
1562    TVec&lt;TFltPrV&gt; ProbPosFracPosV;
1563    GetUsrVoteTrail(UIdV, ProbPosFracPosV);
1564    AreaV.Clr();
1565    for (int u = 0; u &lt; ProbPosFracPosV.Len(); u++) {
1566      double Area = 0;
1567      TFltPrV&amp; V = ProbPosFracPosV[u];
1568      for (int f = 0; f &lt; V.Len(); f++) {
1569        IAssert(V[f].Val1&gt;= 0 &amp;&amp; V[f].Val1&lt;=100);
1570        Area += (V[f].Val2 - V[f].Val1/100.0);
1571      }
1572      AreaV.Add(Area);
1573    }
1574  }
1575  void TWikiElecBs::PlotElecLenDistr(const TStr&amp; OutFNm) const {
1576    TIntH SupCntHS, OppCntHS, VotesCntHS, 
1577          SupCntHF, OppCntHF, VotesCntHF, 
1578          SupCntHA, OppCntHA, VotesCntHA; 
1579    TIntH VotesPerUser;
1580    THashSet&lt;TFltPr&gt; SupOppHS, SupOppHF;
1581    THash&lt;TInt, TMom&gt; ElLenVsSucc;
1582    TIntH SupFracA, SupFracS, SupFracF;
1583    for (int e = 0; e &lt; Len(); e++) {
1584      const TWikiElec&amp; E = GetElec(e);
1585      const int SupFrac = (int)TMath::Round(E.GetFracSup()*10)*10;
1586      TIntTr V = E.GetVotes();
1587      int len = (E.Len()/5)*5;
1588      V.Val1 = (V.Val1/5)*5;
1589      V.Val2 = (V.Val2/5)*5;
1590      V.Val3 = (V.Val3/5)*5;
1591      SupFracA.AddDat(SupFrac) +=1;
1592      if (E.IsSucc) {
1593        SupFracS.AddDat(SupFrac) += 1;
1594        VotesCntHS.AddDat(len) += 1;
1595        SupCntHS.AddDat(V.Val1) += 1;
1596        OppCntHS.AddDat(V.Val3) += 1;
1597        SupOppHS.AddKey(TFltPr(V.Val1+0.1+TInt::Rnd.GetNrmDev(), V.Val3+0.1+TInt::Rnd.GetNrmDev()));
1598        ElLenVsSucc.AddDat(len).Add(1);
1599      } else {
1600        SupFracF.AddDat(SupFrac) += 1;
1601        VotesCntHF.AddDat(len) += 1;
1602        SupCntHF.AddDat(V.Val1) += 1;
1603        OppCntHF.AddDat(V.Val3) += 1;
1604        SupOppHF.AddKey(TFltPr(V.Val1+0.1+TInt::Rnd.GetNrmDev(), V.Val3+0.1+TInt::Rnd.GetNrmDev()));
1605        ElLenVsSucc.AddDat(len).Add(0);
1606      }
1607      VotesCntHA.AddDat(len) += 1;
1608      SupCntHA.AddDat(V.Val1) += 1;
1609      OppCntHA.AddDat(V.Val3) += 1;
1610    }
1611    TIntPrV VotesUIdV; GetUsrVotes(VotesUIdV);
1612    for (int i = 0; i &lt; VotesUIdV.Len(); i++) {
1613      VotesPerUser.AddDat(10*(VotesUIdV[i].Val1/10))+=1;
1614    }
1615    TGnuPlot::PlotValCntH(VotesPerUser, &quot;userVotes-&quot;+OutFNm, &quot;&quot;, &quot;Number of votes&quot;, &quot;Number of such users&quot;);
1616    TGnuPlot::PlotValMomH(ElLenVsSucc, &quot;elLenSucc-&quot;+OutFNm, &quot;&quot;, &quot;Election length&quot;, &quot;Probability of success&quot;);
1617    { TGnuPlot GP(&quot;suppOppScatter-&quot;+OutFNm); GP.SetXYLabel(&quot;Support votes&quot;, &quot;Oppose votes&quot;);
1618    TFltPrV SuccV, FailV;  SupOppHS.GetKeyV(SuccV);  SupOppHF.GetKeyV(FailV);
1619    GP.AddPlot(FailV, gpwPoints, &quot;FAIL&quot;);  GP.AddPlot(SuccV, gpwPoints, &quot;SUCC&quot;);
1620    GP.SavePng(); }
1621    { TGnuPlot GP(&quot;countSup-&quot;+OutFNm); GP.SetXYLabel(&quot;Support votes&quot;, &quot;Count&quot;);
1622    GP.AddPlot(SupCntHA, gpwLinesPoints, &quot;ALL elections&quot;);
1623    GP.AddPlot(SupCntHS, gpwLinesPoints, &quot;SUCC elections&quot;);
1624    GP.AddPlot(SupCntHF, gpwLinesPoints, &quot;FAIL elections&quot;);
1625    GP.SavePng(); }
1626    { TGnuPlot GP(&quot;countOpp-&quot;+OutFNm); GP.SetXYLabel(&quot;Oppose votes&quot;, &quot;Count&quot;);
1627    GP.AddPlot(OppCntHA, gpwLinesPoints, &quot;ALL elections&quot;);
1628    GP.AddPlot(OppCntHS, gpwLinesPoints, &quot;SUCC elections&quot;);
1629    GP.AddPlot(OppCntHF, gpwLinesPoints, &quot;FAIL elections&quot;);
1630    GP.SavePng(); }
1631    { TGnuPlot GP(&quot;countVot-&quot;+OutFNm); GP.SetXYLabel(&quot;Votes&quot;, &quot;Count&quot;);
1632    GP.AddPlot(VotesCntHA, gpwLinesPoints, &quot;ALL elections&quot;);
1633    GP.AddPlot(VotesCntHS, gpwLinesPoints, &quot;SUCC elections&quot;);
1634    GP.AddPlot(VotesCntHF, gpwLinesPoints, &quot;FAIL elections&quot;);
1635    GP.SavePng(); }
1636    { TGnuPlot GP(&quot;supFrac-&quot;+OutFNm); GP.SetXYLabel(&quot;Final Fraction of support votes&quot;, &quot;Number of such elections&quot;);
1637    GP.AddPlot(SupFracA, gpwLinesPoints, &quot;ALL elections&quot;);
1638    GP.AddPlot(SupFracS, gpwLinesPoints, &quot;SUCC elections&quot;);
1639    GP.AddPlot(SupFracF, gpwLinesPoints, &quot;FAIL elections&quot;);
1640    GP.SavePng(); }
1641  }
1642  void TWikiElecBs::PlotElecSupOppOt(const TStr&amp; OutFNm, const int&amp; MinVotes, const int&amp; MaxVotes) const {
1643    int ElecCnt=0;
1644    TGnuPlot GP(&quot;supOppOT-&quot;+OutFNm);
1645    for (int e = 0; e &lt; Len(); e++) {
1646      const TWikiElec&amp; E = GetElec(e);
1647      if (E.Len() &lt; MinVotes || E.Len() &gt; MaxVotes) { continue; }
1648      TFltPrV OppSupV; OppSupV.Add(TFltPr(0,0));
1649      for (int v = 0; v &lt; E.Len(); v++) {
1650        const int S = E[v].GetVote();
1651        OppSupV.Add(TFltPr(OppSupV.Last().Val1+(S&lt;0?1:0)+0.1*TInt::Rnd.GetNrmDev(),
1652                           OppSupV.Last().Val2+(S&gt;0?1:0)+0.1*TInt::Rnd.GetNrmDev()));
1653      }
1654      GP.AddPlot(OppSupV, gpwLines, &quot;&quot;, TStr::Fmt(&quot;lt %d&quot;, E.IsSucc?2:1));
1655      ElecCnt++;
1656    }
1657    GP.SetXYLabel(&quot;oppose votes&quot;, &quot;support votes&quot;);
1658    GP.SetTitle(TStr::Fmt(&quot;elections with %d -- %d votes: %d elections&quot;, MinVotes, MaxVotes, ElecCnt));
1659    GP.SavePng();
1660  }
1661  void TWikiElecBs::PlotRunLenStat(const TStr&amp; OutFNm, const int&amp; MinVotes, const int&amp; MaxVotes) const {
1662    THash&lt;TInt, TTriple&lt;TMom, TMom, TMom&gt; &gt; UsrMomH;
1663    THash&lt;TInt, TMom&gt; TxtLenH;
1664    TPair&lt;TMom, TMom&gt; RunLStat;
1665    THash&lt;TInt, TInt&gt; SupH, OppH;
1666    int Cnt=0;
1667    for (int e = 0; e &lt; Len(); e++) {
1668      const TWikiElec&amp; E = GetElec(e);
1669      if (E.Len() &lt; MinVotes || E.Len() &gt; MaxVotes) { continue; }
1670      for (int v = 0; v &lt; E.Len(); v++) {
1671        const int V = E.GetVote(v).GetVote();
1672        const int RunL = E.GetRunLen(v);
1673        if (V == 1) {
1674          UsrMomH.AddDat(E.GetVote(v).GetUId()).Val1.Add(RunL);
1675          RunLStat.Val1.Add(RunL);
1676          SupH.AddDat(RunL)++;
1677        } else {
1678          UsrMomH.AddDat(E.GetVote(v).GetUId()).Val2.Add(RunL);
1679          RunLStat.Val2.Add(RunL);
1680          OppH.AddDat(RunL)++;
1681        }
1682        UsrMomH.AddDat(E.GetVote(v).GetUId()).Val3.Add(E[v].GetTxtLen());
1683        TxtLenH.AddDat(10*(E[v].GetTxtLen()/10)).Add(RunL);
1684      }
1685      Cnt++;
1686    }
1687    TGnuPlot::PlotValMomH(TxtLenH, &quot;runLenTxtLen-&quot;+OutFNm, &quot;&quot;, &quot;Length of the text supporting the vote&quot;, &quot;Run length&quot;,
1688      gpsAuto, gpwLinesPoints, true, true, false, false, false);
1689    RunLStat.Val1.Def();
1690    RunLStat.Val2.Def();
1691    printf(&quot;SUP run len: A:%g  M:%g\n&quot;, RunLStat.Val1.GetMean(), RunLStat.Val1.GetMedian());
1692    printf(&quot;OPP run len: A:%g  M:%g\n&quot;, RunLStat.Val2.GetMean(), RunLStat.Val2.GetMedian());
1693    TGnuPlot GP(&quot;runLen-&quot;+OutFNm, TStr::Fmt(&quot;Elecs %d--%d: %d. SUP run len: A:%g  M:%g  OPP: A:%g  M:%g&quot;, MinVotes, MaxVotes, Cnt,
1694      RunLStat.Val1.GetMean(), RunLStat.Val1.GetMedian(), RunLStat.Val2.GetMean(), RunLStat.Val2.GetMedian()));
1695    GP.AddPlot(OppH, gpwLinesPoints, &quot;OPP&quot;);
1696    GP.AddPlot(SupH, gpwLinesPoints, &quot;SUP&quot;);
1697    GP.SetXYLabel(&quot;run length&quot;, &quot;count&quot;);
1698    GP.SavePng();
1699    FILE *F = fopen(TStr::Fmt(&quot;runLenUsers-%s.tab&quot;, OutFNm.CStr()).CStr(), &quot;wt&quot;);
1700    fprintf(F, &quot;#UsrId\tUser\tVotes\tSup-Votes\tOpp-Votes\tSup-Avg\tSup-Med\tOpp-Avg\tOpp-Med\tTxtLen-Avg\tTxtLen-Med\n&quot;);
1701    for (int u = 0; u &lt; UsrMomH.Len(); u++) {
1702      TMom&amp; MS = UsrMomH[u].Val1;  MS.Def();
1703      TMom&amp; MO = UsrMomH[u].Val2;  MO.Def();
1704      TMom&amp; TL = UsrMomH[u].Val3;  TL.Def();
1705      fprintf(F, &quot;%d\t%s\t%d\t%d\t%d\t%g\t%g\t%g\t%g\t%g\t%g\n&quot;, UsrMomH.GetKey(u), GetUsr(UsrMomH.GetKey(u)),
1706        MS.GetVals()+MO.GetVals(), MS.GetVals(), MO.GetVals(), MS.GetMean(), MS.GetMedian(), MO.GetMean(), MO.GetMedian(),
1707        TL.GetMean(), TL.GetMedian());
1708    }
1709    fclose(F);
1710  }
1711  void TWikiElecBs::DrawElecTree(const TStr&amp; OutFNm, const int&amp; MinVotes) const {
1712    TIntV UIdV;  GetEIdByVotes(UIdV);
1713    TWikiVoteV VoteV;
1714    THash&lt;TInt, TIntQu&gt; TreeH;  
1715    const int TakeVotes = 3;
1716    for (int e = 0; e &lt; Len(); e++) {
1717      const TWikiElec&amp; E = GetElec(e);
1718      if (E.Len() &lt; MinVotes) { continue; }
1719      TInt BegVote=1;
1720      const TIntTr SNO = E.GetVotes();
1721      { TIntQu&amp; V = TreeH.AddDat(BegVote);
1722      V.Val1 += SNO.Val1; V.Val2 += SNO.Val3;  V.Val3 += 1;
1723      V.Val4 += E.IsSucc() ? 1:0; }
1724      for (int v = 0; v &lt; TakeVotes; v++) {
1725        if (E[v].GetVote() == 1) { BegVote = 2*BegVote+1; } 
1726        else { BegVote = 2*BegVote; } 
1727        TIntQu&amp; V = TreeH.AddDat(BegVote);
1728        V.Val1 += SNO.Val1;
1729        V.Val2 += SNO.Val3;
1730        V.Val3 += 1;
1731        V.Val4 += E.IsSucc() ? 1:0;
1732      }
1733    }
1734    PNGraph G = TNGraph::New();
1735    TIntStrH LabelH;
1736    TreeH.SortByKey();
1737    for (int i = 0; i &lt; TreeH.Len(); i++) {
1738      printf(&quot;%d\n&quot;, TreeH.GetKey(i));
1739      const int id = TreeH.GetKey(i);
1740      const int nid = G-&gt;AddNode(i+1);
1741      LabelH.AddDat(nid, TStr::Fmt(&quot;%sElections: %d\\nSuccessful: %.3f&quot;, id==1?&quot;&quot;:(id%2==1 ?&quot;SUPPORT\\n&quot;:&quot;OPPOSE\\n&quot;), TreeH[i].Val3, TreeH[i].Val4/double(TreeH[i].Val3)));
1742      if (id &gt; 1) {
1743        G-&gt;AddEdge(id/2, nid);
1744        printf(&quot;link  %d &lt;-- %d\n&quot;, id/2, nid);
1745      }
1746    }
1747    TGraphViz::Plot(G, gvlDot, &quot;elecTree-&quot;+OutFNm+&quot;.gif&quot;, &quot;&quot;, LabelH);
1748  }
1749  void TWikiElecBs::PlotVotesOt(const TStr&amp; OutFNm, const int&amp; MinVotes, const int&amp; MaxVotes) const {
1750    THash&lt;TInt, TMom&gt; FSupOtA, PSupOtA, DevOtA,
1751      FSupOtS, PSupOtS, DevOtS, FSupOtF, PSupOtF, DevOtF;
1752    int Cnt=0;
1753    for (int e = 0; e &lt; Len(); e++) {
1754      const TWikiElec&amp; E = GetElec(e);
1755      if (E.Len() &lt; MinVotes || E.Len() &gt; MaxVotes) { continue; }
1756      int S = 0;
1757      double Dev = 0;
1758      for (int v = 0; v &lt; E.Len(); v++) {
1759        const int V = E.GetVote(v).GetVote()==1? 1:0;
1760        if (v &gt; 0) {
1761          Dev = fabs(V - S/double(v))/double(v+1); }
1762        S += V; 
1763        if (E.IsSucc) {
1764          FSupOtS.AddDat(v+1).Add(S/double(v+1));
1765          PSupOtS.AddDat(v+1).Add(V);
1766          DevOtS.AddDat(v+1).Add(Dev);
1767        } else {
1768          FSupOtF.AddDat(v+1).Add(S/double(v+1));
1769          PSupOtF.AddDat(v+1).Add(V);
1770          DevOtF.AddDat(v+1).Add(Dev);
1771        }
1772        FSupOtA.AddDat(v+1).Add(S/double(v+1));
1773        PSupOtA.AddDat(v+1).Add(V);
1774        DevOtA.AddDat(v+1).Add(Dev);
1775      }
1776      Cnt++;
1777    }
1778    { TGnuPlot GP(&quot;votesOT-Frac-&quot;+OutFNm, TStr::Fmt(&quot;Elections %d--%d: %d&quot;, MinVotes, MaxVotes, Cnt));
1779    GP.SetXYLabel(&quot;Time (vote index)&quot;, &quot;Fraction of support votes so far&quot;);
1780    GP.AddPlot(FSupOtA, gpwLinesPoints, &quot;ALL elections&quot;, &quot;&quot;, true, false);
1781    GP.AddPlot(FSupOtS, gpwLinesPoints, &quot;SUCC elections&quot;, &quot;&quot;, true, false);
1782    GP.AddPlot(FSupOtF, gpwLinesPoints, &quot;FAIL elections&quot;, &quot;&quot;, true, false);
1783    if (MinVotes&gt;10) { GP.SetXRange(0, MinVotes); }  GP.SavePng(); }
1784    { TGnuPlot GP(&quot;votesOT-Sup-&quot;+OutFNm, TStr::Fmt(&quot;Elections %d--%d: %d&quot;, MinVotes, MaxVotes, Cnt));
1785    GP.SetXYLabel(&quot;Time (vote index)&quot;, &quot;Probability i-th vote is Support&quot;);
1786    GP.AddPlot(PSupOtA, gpwLinesPoints, &quot;ALL elections&quot;, &quot;&quot;, true, false);
1787    GP.AddPlot(PSupOtS, gpwLinesPoints, &quot;SUCC elections&quot;, &quot;&quot;, true, false);
1788    GP.AddPlot(PSupOtF, gpwLinesPoints, &quot;FAIL elections&quot;, &quot;&quot;, true, false);
1789    if (MinVotes&gt;10) { GP.SetXRange(0, MinVotes); }  GP.SavePng(); }
1790    { TGnuPlot GP(&quot;votesOT-Dev-&quot;+OutFNm, TStr::Fmt(&quot;Elections %d--%d: %d&quot;, MinVotes, MaxVotes, Cnt));
1791    GP.SetXYLabel(&quot;Time (vote index)&quot;, &quot;Vote deviation: avg |avg(V,t+1) - avg(V,t)|&quot;);
1792    GP.AddPlot(DevOtA, gpwLinesPoints, &quot;ALL elections&quot;, &quot;&quot;, true, false);
1793    GP.AddPlot(DevOtS, gpwLinesPoints, &quot;SUCC elections&quot;, &quot;&quot;, true, false);
1794    GP.AddPlot(DevOtF, gpwLinesPoints, &quot;FAIL elections&quot;, &quot;&quot;, true, false);
1795    if (MinVotes&gt;10) { GP.SetXRange(0, MinVotes); }  GP.SavePng(); }
1796  }
1797  void TWikiElecBs::PlotCovotingUsers(const TStr&amp; OutFNm, const TStr&amp; MinSupStr, const int&amp; TakeOnlyVotes) const {
1798    PNGraph G = TNGraph::New();
1799    TStrSet RfaSet;
1800    for (int e = 0; e &lt; Len(); e++) {
1801      const TWikiElec&amp; E = GetElec(e);
1802      const int RfaId = Kilo(100)+RfaSet.AddKey(E.RfaTitle);
1803      if (G-&gt;IsNode(RfaId)) { printf(&quot;%s\n&quot;, E.RfaTitle.CStr()); continue; }
1804      IAssertR(! G-&gt;IsNode(RfaId), E.RfaTitle);
1805      G-&gt;AddNode(RfaId);
1806      for (int v = 0; v &lt; E.Len(); v++) {
1807        if (TakeOnlyVotes==1 &amp;&amp; E[v].GetVote() != 1) { continue; } 
1808        else if (TakeOnlyVotes==-1 &amp;&amp; E[v].GetVote() != -1) { continue; } 
1809        const int usr = E[v].GetUId();
1810        if (! G-&gt;IsNode(usr)) { G-&gt;AddNode(usr); }
1811        IAssert(! G-&gt;IsEdge(usr, RfaId));
1812        G-&gt;AddEdge(usr, RfaId);
1813      }
1814    }
1815    TSnap::PrintInfo(G);
1816    printf(&quot;\n*** ALL VOTES\n&quot;);
1817    TStrV MinSupV;
1818    TStr(MinSupStr).SplitOnAllCh(&#x27;,&#x27;, MinSupV);
1819    TGnuPlot GP(TStr::Fmt(&quot;itemSet-%s&quot;, OutFNm.CStr()), &quot;Number and size of frequent itemsets&quot;);
1820    for (int i = 0; i &lt; MinSupV.Len(); i++) {
1821      printf(&quot;\n*** MinSup = %s\n&quot;, MinSupV[i].CStr());
1822      TTrawling Trawl(G, MinSupV[i].GetInt());
1823      const TIntPrV SzCntV = Trawl.PlotMinFqVsMaxSet(TStr::Fmt(&quot;%s-%02d&quot;, OutFNm.CStr(), MinSupV[i].GetInt()));
1824      GP.AddPlot(SzCntV, gpwLinesPoints, TStr::Fmt(&quot;MinSup = %d&quot;, MinSupV[i].GetInt()));
1825    }
1826    GP.SetXYLabel(&quot;Itemset size&quot;, &quot;Number of itemsets&quot;);
1827    GP.SavePng();
1828  }
1829  void TWikiElecBs::PlotFracBeforeAfterVote(const TStr&amp; OutFNm) const {
1830    THash&lt;TInt, TIntPrV&gt; UIdVotesH;
1831    for (int e = 0; e &lt; Len(); e++) {
1832      const TWikiElec&amp; E = GetElec(e);
1833      if (E.Len() &lt; 10) { continue; } 
1834      for (int v = 0; v &lt; E.Len(); v++) {
1835        UIdVotesH.AddDat(E[v].GetUId()).Add(TIntPr(e,v));
1836      }
1837    }
1838    THash&lt;TFlt, TInt&gt; DeltaCntHA, DeltaCntHS, DeltaCntHO, DeltaCntHA2, DeltaCntHS2, DeltaCntHO2;
1839    FILE *F = fopen(TStr::Fmt(&quot;deltabBAUsr-%s.tab&quot;, OutFNm.CStr()).CStr(), &quot;wt&quot;);
1840    fprintf(F, &quot;#Usr\tVotes\tAvgDSup\tMedDSup\tSupVotes\tAvgDOpp\tMedDOpp\tOppVotes\tAvgTrendSup\tMedTrendSup\tAvgTrendOpp\tMedTrendOpp\n&quot;);
1841    for (int u = 0; u &lt; UIdVotesH.Len(); u++) {
1842      const TIntPrV&amp; EV = UIdVotesH[u];
1843      if (EV.Len() &lt; 10) { continue; } 
1844      TMom MomS, MomO, MomS2, MomO2;
1845      for (int ev = 0; ev &lt; EV.Len(); ev++) {
1846        const TWikiElec&amp; E = GetElec(EV[ev].Val1);
1847        const int v = EV[ev].Val2;
1848        if (v &lt; 5 || v+5 &gt;= E.Len()) { continue; }
1849        const double Bef = E.GetFracSup(0, v); 
1850        const double Aft = E.GetFracSup(v+1, E.Len()); 
1851        const double Bef2 = E.GetTrend(0, v);
1852        const double Aft2 = E.GetTrend(v+1, E.Len()); 
1853        DeltaCntHA.AddDat(TMath::Round(Aft-Bef, 2)) += 1;
1854        DeltaCntHA2.AddDat(TMath::Round(Aft2-Bef2, 2)) += 1;
1855        if (E[v].GetVote() == 1) {
1856          DeltaCntHS.AddDat(TMath::Round(Aft-Bef, 2)) += 1;
1857          DeltaCntHS2.AddDat(TMath::Round(Aft2-Bef2, 2)) += 1;
1858          MomS.Add(Aft-Bef);
1859          MomS2.Add(Aft2-Bef2);
1860        } else {
1861          DeltaCntHO.AddDat(TMath::Round(Aft-Bef, 2)) += 1;
1862          DeltaCntHO2.AddDat(TMath::Round(Aft2-Bef2, 2)) += 1;
1863          MomO.Add(Aft-Bef);
1864          MomO2.Add(Aft2-Bef2);
1865        }
1866      }
1867      MomS.Def(); MomO.Def();  MomS2.Def(); MomO2.Def();
1868      if (! MomS.IsUsable() || ! MomO.IsUsable()) { continue; }
1869      fprintf(F, &quot;%s\t%d\t%f\t%f\t%d\t%f\t%f\t%d\n&quot;, GetUsr(UIdVotesH.GetKey(u)), EV.Len(),
1870        MomS.GetMean(), MomS.GetMedian(), MomS.GetVals(), MomO.GetMean(), MomO.GetMedian(), MomO.GetVals(),
1871        MomS2.GetMean(), MomS2.GetMedian(), MomO2.GetMean(), MomO2.GetMedian());
1872    }
1873    fclose(F);
1874    TGnuPlot::PlotValCntH(DeltaCntHA, &quot;deltaBA-&quot;+OutFNm, &quot;Fraction of support votes After-Before user casted a vote. (min 10 votes per user, min 10 vote elections, min 5 votes before/after&quot;,
1875      &quot;After - Before fraction of support votes. Any vote.&quot;, &quot;Count&quot;);
1876    TGnuPlot::PlotValCntH(DeltaCntHS, &quot;deltaBASup-&quot;+OutFNm, &quot;Fraction of support votes After-Before user casted a vote. (min 10 votes per user, min 10 vote elections, min 5 votes before/after&quot;,
1877      &quot;After - Before fraction of support votes. User voted +1.&quot;, &quot;Count&quot;);
1878    TGnuPlot::PlotValCntH(DeltaCntHO, &quot;deltaBAOpp-&quot;+OutFNm, &quot;Fraction of support votes After-Before user casted a vote. (min 10 votes per user, min 10 vote elections, min 5 votes before/after&quot;,
1879      &quot;After - Before fraction of support votes. User voted -1.&quot;, &quot;Count&quot;);
1880    TGnuPlot::PlotValCntH(DeltaCntHA2, &quot;deltaTrBA-&quot;+OutFNm, &quot;Trend of fraction ofsupport votes After-Before user casted a vote. (min 10 votes per user, min 10 vote elections, min 5 votes before/after&quot;,
1881      &quot;After - Before trend (linear fit coefficient) fraction of support votes. Any vote.&quot;, &quot;Count&quot;);
1882    TGnuPlot::PlotValCntH(DeltaCntHS2, &quot;deltaTrBASup-&quot;+OutFNm, &quot;Trend of fraction ofsupport votes After-Before user casted a vote. (min 10 votes per user, min 10 vote elections, min 5 votes before/after&quot;,
1883      &quot;After - Before trend (linear fit coefficient) fraction of support votes. User voted +1.&quot;, &quot;Count&quot;);
1884    TGnuPlot::PlotValCntH(DeltaCntHO2, &quot;deltaTrBAOpp-&quot;+OutFNm, &quot;Trend of fraction of support votes After-Before user casted a vote. (min 10 votes per user, min 10 vote elections, min 5 votes before/after&quot;,
1885      &quot;After - Before trend (linear fit coefficient) fraction of support votes. User voted -1.&quot;, &quot;Count&quot;);
1886  }
1887  void TWikiElecBs::PlotDeltaFracSupOt(const TStr&amp; OutFNm, const int&amp; MinVotes, const int&amp; MaxVotes) const {
1888    THash&lt;TInt, TMom&gt; DeltaOtA, DeltaOtS, DeltaOtF;
1889    int Cnt = 0, CntS=0, CntF=0;
1890    for (int e = 0; e &lt; Len(); e++) {
1891      const TWikiElec&amp; E = GetElec(e);
1892      if (E.Len() &lt; MinVotes || E.Len() &gt; MaxVotes) { continue; }
1893      TIntTr SNO = E.GetVotes();
1894      const double FinalF = SNO.Val1/double(SNO.Val1+SNO.Val3);
1895      int S = 0;
1896      for (int v = 0; v &lt; E.Len(); v++) {
1897        const int V = E.GetVote(v).GetVote()==1? 1:0;
1898        S += V; 
1899        if (E.IsSucc) { DeltaOtS.AddDat(v).Add(S/double(v+1)-FinalF); }
1900        else { DeltaOtF.AddDat(v).Add(S/double(v+1)-FinalF); }
1901        DeltaOtA.AddDat(v).Add(S/double(v+1)-FinalF);
1902      }
1903      if (E.IsSucc) { CntS++; }
1904      else { CntF++; }
1905      Cnt++;
1906    }
1907    TGnuPlot::PlotValMomH(DeltaOtA, &quot;deltaFracSup-A-&quot;+OutFNm, TStr::Fmt(&quot;ALL Elections %d--%d: %d&quot;, MinVotes, MaxVotes, Cnt),
1908      &quot;Vote index&quot;, &quot;Deviation from the final fraction of support votes&quot;);
1909    TGnuPlot::PlotValMomH(DeltaOtS, &quot;deltaFracSup-S-&quot;+OutFNm, TStr::Fmt(&quot;SUCC Elections %d--%d: %d&quot;, MinVotes, MaxVotes, CntS),
1910      &quot;Vote index&quot;, &quot;Deviation from the final fraction of support votes&quot;);
1911    TGnuPlot::PlotValMomH(DeltaOtF, &quot;deltaFracSup-F-&quot;+OutFNm, TStr::Fmt(&quot;FAIL Elections %d--%d: %d&quot;, MinVotes, MaxVotes, CntF),
1912      &quot;Vote index&quot;, &quot;Deviation from the final fraction of support votes&quot;);
1913  }
1914  void TWikiElecBs::PlotUsrVoteVsTime(const TStr&amp; OutFNm, const int&amp; MinUsrVotes, const TIntSet&amp; UsrSplitSet) const {
1915    THash&lt;TInt, TIntPrV&gt; UIdVotesH;
1916    TIntFltH FracSupH;
1917    for (int e = 0; e &lt; Len(); e++) {
1918      const TWikiElec&amp; E = GetElec(e);
1919      for (int v = 0; v &lt; E.Len(); v++) {
1920        UIdVotesH.AddDat(E[v].GetUId()).Add(TIntPr(e,v));
1921      }
1922      FracSupH.AddDat(e, E.GetFracSup());
1923    }
1924    UIdVotesH.SortByDat(false);
1925    THash&lt;TInt, TMom&gt; AllMomH, AllMomHS, AllMomHF, AdmMomH, NAdmMomH;
1926    TIntH AllCntH, AllCntHS, AllCntHF, AdmCntH, NAdmCntH;
1927    int Cnt=0, UCnt=0;
1928    for (int e = 0; e &lt; Len(); e++) {
1929      const TWikiElec&amp; E = GetElec(e);
1930      for (int v = 0; v &lt; TMath::Mn(E.Len(),101); v++) {
1931        const int Vote = E.GetVote(v).GetVote()==1?1:0;
1932        AllMomH.AddDat(v).Add(Vote);
1933        AllCntH.AddDat(v) += 1;
1934        if (E.IsSucc) {
1935          AllMomHS.AddDat(v).Add(Vote);
1936          AllCntHS.AddDat(v) += 1; }
1937        else {
1938          AllMomHF.AddDat(v).Add(Vote);
1939          AllCntHF.AddDat(v) += 1;
1940        }
1941        if (UsrSplitSet.IsKey(E[v].GetUId())) {
1942          AdmMomH.AddDat(v).Add(Vote);
1943          AdmCntH.AddDat(v) += 1;
1944        } else {
1945          NAdmMomH.AddDat(v).Add(Vote);
1946          NAdmCntH.AddDat(v) += 1;
1947        }
1948      }
1949    }
1950    TGnuPlot::PlotValMomH(AllMomH, TStr::Fmt(&quot;usrVoteVsTm-%s-all&quot;, OutFNm.CStr()),
1951      TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, Cnt, UCnt, MinUsrVotes),
1952      &quot;time when user voted&quot;, &quot;fraction of positive votes&quot;,
1953      gpsAuto, gpwLinesPoints, true, false, false, false, false, false);
1954    TGnuPlot::PlotValCntH(AllCntH, TStr::Fmt(&quot;usrVoteVsTm-%s-CNT-all&quot;, OutFNm.CStr()),
1955      TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, Cnt, UCnt, MinUsrVotes),
1956      &quot;time when user voted&quot;, &quot;number of votes&quot;);
1957    TGnuPlot::PlotValMomH(AdmMomH, TStr::Fmt(&quot;usrVoteVsTm-%s-admin&quot;, OutFNm.CStr()),
1958      TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, Cnt, UCnt, MinUsrVotes),
1959      &quot;time when user voted&quot;, &quot;fraction of positive votes&quot;,
1960      gpsAuto, gpwLinesPoints, true, false, false, false, false, false);
1961    TGnuPlot::PlotValCntH(AdmCntH, TStr::Fmt(&quot;usrVoteVsTm-%s-CNT-admin&quot;, OutFNm.CStr()),
1962      TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, Cnt, UCnt, MinUsrVotes),
1963      &quot;time when user voted&quot;, &quot;number of votes&quot;);
1964    TGnuPlot::PlotValMomH(NAdmMomH, TStr::Fmt(&quot;usrVoteVsTm-%s-nonadmin&quot;, OutFNm.CStr()),
1965      TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, Cnt, UCnt, MinUsrVotes),
1966      &quot;time when user voted&quot;, &quot;fraction of positive votes&quot;,
1967      gpsAuto, gpwLinesPoints, true, false, false, false, false, false);
1968    TGnuPlot::PlotValCntH(NAdmCntH, TStr::Fmt(&quot;usrVoteVsTm-%s-CNT-nonadmin&quot;, OutFNm.CStr()),
1969      TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, Cnt, UCnt, MinUsrVotes),
1970      &quot;time when user voted&quot;, &quot;number of votes&quot;);
1971  }
1972  void TWikiElecBs::PlotFirstOppOutcome(const TStr&amp; OutFNm, const int&amp; NVotes) const {
1973    THash&lt;TInt, TMom&gt; FOppH, FOpp2H;
1974    TIntH FOppCntH;
1975    int NElec=0;
1976    for (int e = 0; e &lt; Len(); e++) {
1977      const TWikiElec&amp; E = GetElec(e);
1978      if (E.Len() &lt; 10 || E.Len() &lt; NVotes) { continue; } 
1979      int FirstOpp=-1, VoteSum=0;
1980      for (int v = 0; v &lt; NVotes; v++) {
1981        if (E[v].GetVote()==-1 &amp;&amp; FirstOpp==-1) { FirstOpp = v+1; }
1982        VoteSum += E[v].GetVote();
1983      }
1984      if (VoteSum != NVotes-2) { continue; }
1985      FOppCntH.AddDat(FirstOpp) += 1;
1986      FOppH.AddDat(FirstOpp).Add(E.IsSucc?1:0);
1987      FOpp2H.AddDat(FirstOpp).Add(E.GetFracSup());
1988      NElec++;
1989    }
1990    TGnuPlot::PlotValMomH(FOppH, &quot;firstOpp1-&quot;+OutFNm, TStr::Fmt(&quot;Take first %d votes of an election, where %d Sup and 1 Opp. %d such elections&quot;, NVotes, NVotes-1, NElec),
1991      &quot;Index of the oppose vote&quot;, &quot;Fraction of successful elections&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
1992    TGnuPlot::PlotValMomH(FOpp2H, &quot;firstOpp2-&quot;+OutFNm, TStr::Fmt(&quot;Take first %d votes of an election, where %d Sup and 1 Opp. %d such elections&quot;, NVotes, NVotes-1, NElec),
1993      &quot;Index of the oppose vote&quot;, &quot;Final fraction of support votes in the election&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, true, false);
1994    TGnuPlot::PlotValCntH(FOppCntH, &quot;firstOppCnt-&quot;+OutFNm, TStr::Fmt(&quot;Take first %d votes of an election, where %d Sup and 1 Opp. %d such elections&quot;, NVotes, NVotes-1, NElec),
1995      &quot;Index of the oppose vote&quot;, &quot;Number of such elections&quot;);
1996  }
1997  void TWikiElecBs::PlotVoteTrails(const TStr&amp; OutFNm, const int&amp; MinUsrVotes, const bool&amp; No01Prob) const {
1998    TIntSet AdminSet;
1999    TIntV UIdV;
2000    TVec&lt;TFltPrV&gt; ProbSupTmV, FracSupTmV, ProbSupFracSupV, VotesTmV, VoteIdxFracSupV, NVotesFracSupV;
2001    const int TotalVotes = GetVoteTrails(MinUsrVotes, No01Prob, UIdV, ProbSupTmV, FracSupTmV, ProbSupFracSupV, VotesTmV);
2002    GetVoteTrails2(MinUsrVotes, No01Prob, UIdV, VoteIdxFracSupV, NVotesFracSupV);
2003    GetAdminSet(AdminSet);
2004    TIntH UsrLnTy;
2005    for (int u = 0; u &lt; UIdV.Len(); u++) { UsrLnTy.AddDat(UIdV[u], AdminSet.IsKey(UIdV[u])?2:1); }
2006    TGnuPlot GPP(&quot;voteTrailP-&quot;+OutFNm+&quot;-r10&quot;); 
2007    TGnuPlot GPF(&quot;voteTrailF-&quot;+OutFNm+&quot;-r10&quot;);
2008    TGnuPlot GPPF(&quot;voteTrailPF-&quot;+OutFNm+&quot;-r10&quot;);
2009    TGnuPlot GPV(&quot;voteHist-&quot;+OutFNm+&quot;-r10&quot;); 
2010    TGnuPlot GPFI(&quot;voteFIdx-&quot;+OutFNm+&quot;-r10&quot;);
2011    TGnuPlot GPFC(&quot;voteFCnt-&quot;+OutFNm+&quot;-r10&quot;);
2012    THash&lt;TFlt, TMom&gt; AvgAdm, AvgNAdm;
2013    bool FirstA=true, FirstNA=true;
2014    for (int u = 0; u &lt; UIdV.Len(); u++) {
2015      const int UId = UIdV[u];
2016      TStr Tit;
2017      if (FirstA &amp;&amp; UsrLnTy.GetDat(UId) == 2) { Tit=&quot;Admin (HIGH)&quot;; FirstA=false; }
2018      if (FirstNA &amp;&amp; UsrLnTy.GetDat(UId) == 1) { Tit=&quot;NonAdmin (LOW)&quot;; FirstNA=false; }
2019      GPP.AddPlot(ProbSupTmV[u], gpwLines, Tit, TStr::Fmt(&quot;lt %d lw 1 smooth bezier&quot;, UsrLnTy.GetDat(UId)));
2020      GPF.AddPlot(FracSupTmV[u], gpwLines, Tit, TStr::Fmt(&quot;lt %d lw 1 smooth bezier&quot;, UsrLnTy.GetDat(UId)));
2021      GPV.AddPlot(VotesTmV[u], gpwLines, Tit, TStr::Fmt(&quot;lt %d lw 1 smooth bezier&quot;, UsrLnTy.GetDat(UId)));
2022      GPPF.AddPlot(ProbSupFracSupV[u], gpwLinesPoints, Tit, TStr::Fmt(&quot;lt %d lw 1 smooth bezier&quot;, UsrLnTy.GetDat(UId)));
2023      GPFI.AddPlot(VoteIdxFracSupV[u], gpwLines, Tit, TStr::Fmt(&quot;lt %d lw 1 smooth bezier&quot;, UsrLnTy.GetDat(UId)));
2024      GPFC.AddPlot(NVotesFracSupV[u], gpwLines, Tit, TStr::Fmt(&quot;lt %d lw 1 smooth bezier&quot;, UsrLnTy.GetDat(UId)));
2025      for (int i = 0; i &lt; ProbSupFracSupV[u].Len(); i++) {
2026        if (AdminSet.IsKey(UId) || AdminSet.Empty()) { 
2027          AvgAdm.AddDat(ProbSupFracSupV[u][i].Val1).Add(ProbSupFracSupV[u][i].Val2); }
2028        else { 
2029          AvgNAdm.AddDat(ProbSupFracSupV[u][i].Val1).Add(ProbSupFracSupV[u][i].Val2); }
2030      }
2031    }
2032    TFltPrV AvgAdmV, AvgNAdmV;
2033    for (int i =0; i &lt; AvgAdm.Len(); i++) { AvgAdm[i].Def();
2034      AvgAdmV.Add(TFltPr(AvgAdm.GetKey(i), AvgAdm[i].GetMean())); }
2035    for (int i =0; i &lt; AvgNAdm.Len(); i++) { AvgNAdm[i].Def();
2036      AvgNAdmV.Add(TFltPr(AvgNAdm.GetKey(i), AvgNAdm[i].GetMean())); }
2037    AvgAdmV.Sort();  AvgNAdmV.Sort();
2038    GPPF.AddPlot(AvgAdmV, gpwLinesPoints, &quot;AVG ADMIN (HIGH)&quot;, TStr::Fmt(&quot;lt %d lw 5 smooth bezier&quot;, 4));
2039    GPPF.AddPlot(AvgNAdmV, gpwLinesPoints, &quot;AVG NON-ADMIN (LOW)&quot;, TStr::Fmt(&quot;lt %d lw 5 smooth bezier&quot;, 3));
2040    GPP.SetTitle(TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, TotalVotes, UIdV.Len(), MinUsrVotes));
2041    GPP.SetXYLabel(&quot;vote index&quot;, &quot;probability of support vote&quot;);
2042    GPP.SetYRange(0,1.01);
2043    GPF.SetTitle(TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, TotalVotes, UIdV.Len(), MinUsrVotes));
2044    GPF.SetXYLabel(&quot;vote index&quot;, &quot;fraction of support votes so far&quot;);
2045    GPF.SetYRange(0,1.01);
2046    GPPF.SetTitle(TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, TotalVotes, UIdV.Len(), MinUsrVotes));
2047    GPPF.SetXYLabel(&quot;Fraction of support votes at time of vote&quot;, &quot;Probability of voting positively&quot;);
2048    GPPF.SetYRange(0,1.01);
2049    GPPF.SavePng();
2050    GPV.SetTitle(TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, TotalVotes, UIdV.Len(), MinUsrVotes));
2051    GPV.SetXYLabel(&quot;vote index&quot;, &quot;number of votes&quot;);
2052    GPFI.SetTitle(TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, TotalVotes, UIdV.Len(), MinUsrVotes));
2053    GPFI.SetXYLabel(&quot;Fraction of support votes at time of vote&quot;, &quot;Average vote index (time) of a user voting&quot;);
2054    GPFC.SetTitle(TStr::Fmt(&quot;%d votes of %d users with more than %d votes. ALL ELEC.&quot;, TotalVotes, UIdV.Len(), MinUsrVotes));
2055    GPFC.SetXYLabel(&quot;Fraction of support votes at time of vote&quot;, &quot;Number of times user voted at that fraction&quot;);
2056  }
2057  void TWikiElecBs::PlotVoteTrailGlobal(const TStr&amp; OutFNm) const {
2058    THash&lt;TInt, TMom&gt; SuppVoteH, Set1, Set2;
2059    TIntSet UIdSet;
2060    GetAdminSet(UIdSet);
2061    for (int e = 0; e &lt; Len(); e++) {
2062      const TWikiElec&amp; E = GetElec(e);
2063      int nsup=0;
2064      if (E.Len()&lt;10) { continue; }
2065      for (int v = 0; v &lt; E.Len(); v++) {
2066        const int supFrac = v==0? 0 : int(TMath::Round(10.0*nsup/double(v)))*10;
2067        nsup += E.GetVote(v).GetVote()==1?1:0;
2068        if (v&lt;10) { continue; } 
2069        SuppVoteH.AddDat(supFrac).Add(E.GetVote(v).GetVote()==1?1:0);
2070        if (UIdSet.IsKey(E.GetVote(v).GetUId())) { 
2071          Set1.AddDat(supFrac).Add(E.GetVote(v).GetVote()==1?1:0);
2072        } else { 
2073          Set2.AddDat(supFrac).Add(E.GetVote(v).GetVote()==1?1:0);
2074        }
2075      }
2076    }
2077    TGnuPlot::PlotValMomH(SuppVoteH, &quot;voteTrailAll-&quot;+OutFNm, &quot;Global vote trail&quot;, &quot;Fraction of support votes at time of vote&quot;, &quot;Probability of voting positively&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
2078    TGnuPlot::PlotValMomH(Set1, &quot;voteTrailAll1-&quot;+OutFNm, &quot;Global vote trail. Set1&quot;, &quot;Fraction of support votes at time of vote&quot;, &quot;Probability of voting positively&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
2079    TGnuPlot::PlotValMomH(Set2, &quot;voteTrailAll2-&quot;+OutFNm, &quot;Global vote trail. Set2&quot;, &quot;Fraction of support votes at time of vote&quot;, &quot;Probability of voting positively&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false, true);
2080  }
2081  void TWikiElecBs::PlotFinalFracVoteCnt(const TStr&amp; OutFNm, const int&amp; MinUsrVotes, const TIntSet&amp; UsrSplitSet) const {
2082    TIntPrV VoteUIdV; GetUsrVotes(VoteUIdV);
2083    THash&lt;TInt, TIntH&gt; UIdVoteCntH;
2084    TIntH FracVotesH, Set1, Set2;
2085    VoteUIdV.Sort(false);
2086    for (int i = 0; i &lt; VoteUIdV.Len() &amp;&amp; VoteUIdV[i].Val1&gt;MinUsrVotes; i++) {
2087      UIdVoteCntH.AddKey(VoteUIdV[i].Val2); }
2088    for (int e = 0; e &lt; Len(); e++) {
2089      const TWikiElec&amp; E = GetElec(e);
2090      const int SupFrac= (int(100*E.GetFracSup())/10)*10;
2091      for (int v = 0; v &lt; E.Len(); v++) {
2092        const int V = E[v].GetVote()==1?1:0;
2093        const int U = E[v].GetUId();
2094        FracVotesH.AddDat(SupFrac) += 1;
2095        if (UsrSplitSet.IsKey(U)) { Set1.AddDat(SupFrac) += 1; }
2096        else { Set2.AddDat(SupFrac) += 1; }
2097        if (UIdVoteCntH.IsKey(U)) { UIdVoteCntH.AddDat(U).AddDat(SupFrac) += 1; }
2098      }
2099    }
2100    TGnuPlot::PlotValCntH(FracVotesH, &quot;voteFrac-&quot;+OutFNm+&quot;-all&quot;, &quot;All users&quot;, &quot;Final fraction of support votes&quot;, &quot;Number of votes&quot;);
2101    TGnuPlot::PlotValCntH(Set1, &quot;voteFrac-&quot;+OutFNm+&quot;-set1&quot;, &quot;UsrSplitSet users&quot;, &quot;Final fraction of support votes&quot;, &quot;Number of votes&quot;);
2102    TGnuPlot::PlotValCntH(Set2, &quot;voteFrac-&quot;+OutFNm+&quot;-set2&quot;, &quot;Users no in UsrSplitSet&quot;, &quot;Final fraction of support votes&quot;, &quot;Number of votes&quot;);
2103    TGnuPlot GP(&quot;voteFrac-&quot;+OutFNm);
2104    for (int u = 0; u &lt; UIdVoteCntH.Len(); u++) {
2105      TIntPrV ValV;
2106      UIdVoteCntH[u].GetKeyDatPrV(ValV);
2107      ValV.Sort();
2108      GP.AddPlot(ValV, gpwLinesPoints, &quot;&quot;, TStr::Fmt(&quot;lw 1 smooth bezier&quot;));
2109    }
2110    GP.SetXYLabel(&quot;Final fraction of support votes&quot;, &quot;Number of votes&quot;);
2111    GP.SavePng();
2112  }
2113  void TWikiElecBs::PlotConfusionMatrix(const TStr&amp; OutFNm, const int&amp; MinUsrVotes) const {
2114    THash&lt;TInt, TTuple&lt;TFlt, 4&gt; &gt; TupH;
2115    for (int e = 0; e &lt; Len(); e++) {
2116      const TWikiElec&amp; E = GetElec(e);
2117      const int R = E.IsSucc?1:0;
2118      for (int v = 0; v &lt; E.Len(); v++) {
2119        const int V = E[v].GetVote()==1?1:0;
2120        TupH.AddDat(E[v].GetUId())[2*R+V] += 1;
2121      }
2122    }
2123    FILE *F=fopen(TStr::Fmt(&quot;confusion-%s.tab&quot;, OutFNm.CStr()).CStr(), &quot;wt&quot;);
2124    for (int u = 0; u &lt; TupH.Len(); u++) {
2125      const double S = TupH[u][0]+TupH[u][1]+TupH[u][2]+TupH[u][3];
2126      if (S &lt; MinUsrVotes) { continue; }
2127      fprintf(F, &quot;%f\t%f\t%f\t%f\n&quot;, TupH[u][0], TupH[u][1], TupH[u][2], TupH[u][3]);
2128    }
2129    fclose(F);
2130  }
2131  void TWikiElecBs::PlotSlopeHist(const TStr&amp; OutFNm, const int&amp; MinElecLen) const {
2132    const double BPrec = 1000;
2133    TIntH R21A, R22A, K1A, K2A;
2134    TIntH R21S, R22S, K1S, K2S;
2135    TIntH R21F, R22F, K1F, K2F;
2136    int Cnt=0;
2137    for (int e = 0; e &lt; Len(); e++) {
2138      const TWikiElec&amp; E = GetElec(e);
2139      if (E.Len() &lt; MinElecLen) { continue; }
2140      TFltPrV XyV, Xy2;
2141      for (int v = 0; v &lt; E.Len(); v++) {
2142        XyV.Add(TFltPr(v, E[v].GetVote()));
2143        Xy2.Add(TFltPr(v, E.GetFracSup(0, v+1)));
2144      }
2145      double A, B, SigA, SigB, Chi2, R2=0;
2146      TSpecFunc::LinearFit(XyV, A, B, SigA, SigB, Chi2, R2);
2147      if (R2 &lt; -1 || _isnan(R2)) R2 = 0;
2148      K1A.AddDat(int(BPrec*B))+=1;
2149      R21A.AddDat(int(100*R2))+=1;
2150      if (E.IsSucc) {
2151        K1S.AddDat(int(BPrec*B))+=1;
2152        R21S.AddDat(int(100*R2))+=1;
2153      } else {
2154        K1F.AddDat(int(BPrec*B))+=1;
2155        R21F.AddDat(int(100*R2))+=1;
2156      }
2157      TSpecFunc::LinearFit(Xy2, A, B, SigA, SigB, Chi2, R2);
2158      if (R2 &lt; -1 || _isnan(R2)) R2 = 0;
2159      K2A.AddDat(int(BPrec*B))+=1;
2160      R22A.AddDat(int(100*R2))+=1;
2161      if (E.IsSucc) {
2162        K2S.AddDat(int(BPrec*B))+=1;
2163        R22S.AddDat(int(100*R2))+=1;
2164      } else {
2165        K2F.AddDat(int(BPrec*B))+=1;
2166        R22F.AddDat(int(100*R2))+=1;
2167      }
2168      Cnt++;
2169    }
2170    TGnuPlot::PlotValCntH(K1A, &quot;ALL ELEC&quot;, K1S, &quot;SUCC ELEC&quot;, K1F, &quot;FAIL ELEC&quot;, &quot;slopeK1-&quot;+OutFNm, TStr::Fmt(&quot;%d elections with &gt;%d votes&quot;, Cnt, MinElecLen),  &quot;slope (fit of Prob(+|t) vs t)&quot;, &quot;count&quot;, gpsLog10Y);
2171    TGnuPlot::PlotValCntH(K2A, &quot;ALL ELEC&quot;, K2S, &quot;SUCC ELEC&quot;, K2F, &quot;FAIL ELEC&quot;, &quot;slopeK2-&quot;+OutFNm, TStr::Fmt(&quot;%d elections with &gt;%d votes&quot;, Cnt, MinElecLen),  &quot;slope (fit of FracSup(1..t) vs t)&quot;, &quot;count&quot;, gpsLog10Y);
2172    TGnuPlot::PlotValCntH(R21A, &quot;ALL ELEC&quot;, R21S, &quot;SUCC ELEC&quot;, R21F, &quot;FAIL ELEC&quot;, &quot;slopeR1-&quot;+OutFNm, TStr::Fmt(&quot;%d elections with &gt;%d votes&quot;, Cnt, MinElecLen),  &quot;R2 (fit of Prob(+|t) vs t)&quot;, &quot;count&quot;, gpsLog10Y);
2173    TGnuPlot::PlotValCntH(R22A, &quot;ALL ELEC&quot;, R22S, &quot;SUCC ELEC&quot;, R22F, &quot;FAIL ELEC&quot;, &quot;slopeR2-&quot;+OutFNm, TStr::Fmt(&quot;%d elections with &gt;%d votes&quot;, Cnt, MinElecLen),  &quot;R2 (fit of FracSup(1..t) vs t)&quot;, &quot;count&quot;, gpsLog10Y);
2174  }
2175  void TWikiElecBs::PlotBarnStarsDelta(const TStr&amp; OutFNm) const {
2176    TBarnStars BarnStars;
2177    THash&lt;TInt, TMom&gt; DiffMomH;
2178    TIntH DiffCntH;
2179    for (int e = 0; e &lt; Len(); e++) {
2180      const TWikiElec&amp; E = GetElec(e);
2181      const TStr TargetUsr = GetUsr(E.GetUId());
2182      const int TB = BarnStars.GetBarnStars(TargetUsr, E.GetTm());
2183      for (int v = 0; v &lt; E.Len(); v++) {
2184        if (! E[v].IsVote()) { continue; }
2185        const int DeltaStars = BarnStars.GetBarnStars(GetUsr(E[v].GetUId()), E[v].GetTm()) - TB;
2186        DiffMomH.AddDat(DeltaStars).Add(E[v].GetVote()==1?1:0);
2187        DiffCntH.AddDat(DeltaStars) += 1;
2188      }
2189    }
2190    TGnuPlot::PlotValMomH(DiffMomH, &quot;dBarnStars-&quot;+OutFNm, &quot;Number of BarnStars (over ALL VOTES): &quot;+OutFNm, &quot;Barnstars delta (source - destination)&quot;,
2191      &quot;Fraction of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false);
2192    TGnuPlot::PlotValCntH(DiffCntH, &quot;dBarnStarts2-&quot;+OutFNm, &quot;Number of BarnSTars (over aLL VOES): &quot;+OutFNm, &quot;Barnstars delta (source - destination)&quot;,
2193      &quot;Number of such users&quot;, gpsAuto, false, gpwLinesPoints, false, false);
2194  }
2195  void TWikiElecBs::PlotAdminVotes(const TStr&amp; OutFNm) const {
2196    TIntH APos, NAPos, ANeg, NANeg;
2197    TIntPrSet AVotes, NAVotes;
2198    for (int e = 0; e &lt; Len(); e++) {
2199      const TIntTr V = GetElec(e).GetVotes(true);
2200      if (GetElec(e).IsSucc) {
2201        APos.AddDat(V.Val1) += 1;
2202        ANeg.AddDat(V.Val3) += 1;
2203        AVotes.AddKey(TIntPr(V.Val1, V.Val3));
2204      } else {
2205        NAPos.AddDat(V.Val1) += 1;
2206        NANeg.AddDat(V.Val3) += 1;
2207        NAVotes.AddKey(TIntPr(V.Val1, V.Val3));
2208      }
2209    }
2210    { TGnuPlot GP(&quot;adminSup-&quot;+OutFNm, OutFNm);
2211    GP.AddPlot(APos, gpwLinesPoints, &quot;Support votes for ADMINS&quot;);
2212    GP.AddPlot(NAPos, gpwLinesPoints, &quot;Support votes for NON-ADMINS&quot;);
2213    GP.SetXYLabel(&quot;Number of support votes&quot;, &quot;Number of elections&quot;);
2214    GP.SavePng(); }
2215    { TGnuPlot GP(&quot;adminOpp-&quot;+OutFNm, OutFNm);
2216    GP.AddPlot(ANeg, gpwLinesPoints, &quot;Oppose votes for ADMINS&quot;);
2217    GP.AddPlot(NANeg, gpwLinesPoints, &quot;Oppose votes for NON-ADMINS&quot;);
2218    GP.SetXYLabel(&quot;Number of oppose votes&quot;, &quot;Number of elections&quot;);
2219    GP.SavePng(); }
2220    { TGnuPlot GP(&quot;adminSupOpp-&quot;+OutFNm, OutFNm);
2221    TIntPrV V;  AVotes.GetKeyV(V);
2222    GP.AddPlot(V, gpwPoints, &quot;Votes for ADMINS&quot;);
2223    NAVotes.GetKeyV(V);
2224    GP.AddPlot(V, gpwPoints, &quot;Votes for NON-ADMINS&quot;);
2225    GP.SetXYLabel(&quot;Number of support votes&quot;, &quot;Number of oppose votes&quot;);
2226    GP.SavePng(); }
2227  }
2228  void TWikiElecBs::PlotAvgVote(const TStr&amp; OutFNm, const int&amp; MinVotes, const int&amp; MaxVotes) const {
2229    TIntV ElecV;
2230    for (int e = 0; e &lt; Len(); e++) {
2231      if (! GetElec(e).IsSucc()) {
2232        ElecV.Add(e); }
2233    }
2234    PlotAvgVote(ElecV, OutFNm, TStr::Fmt(&quot;Elections with %d--%d votes, %d elections&quot;, MinVotes, MaxVotes, ElecV.Len()));
2235  }
2236  void TWikiElecBs::PlotAvgVote(const TIntV&amp; ElecIdV, const TStr&amp; OutFNm, const TStr&amp; Desc) const {
2237    THash&lt;TInt, TMom&gt; MomH;
2238    THash&lt;TInt, TMom&gt; Mom2H;
2239    TFltV AvgVoteV;
2240    for (int i = 0; i &lt; ElecIdV.Len(); i++) {
2241      GetElec(ElecIdV[i]).GetAvgVoteOt(AvgVoteV, true);
2242      for (int v = 0; v &lt; AvgVoteV.Len(); v++) {
2243        MomH.AddDat(v+1).Add(AvgVoteV[v]); }
2244      const TWikiElec&amp; E = GetElec(ElecIdV[i]);
2245      for (int v = 0; v &lt; E.Len(); v++) {
2246        Mom2H.AddDat(v).Add(E.GetVote(v).GetVote()==1?1:0);
2247      }
2248    }
2249    TGnuPlot::PlotValMomH(MomH, &quot;voteAvg-&quot;+OutFNm, TStr::Fmt(&quot;%s. %d elections&quot;, Desc.CStr(), ElecIdV.Len()),
2250      &quot;n (vote index, time)&quot;, &quot;Running average of positive votes&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false);
2251    TGnuPlot::PlotValMomH(Mom2H, &quot;voteAvg2-&quot;+OutFNm, TStr::Fmt(&quot;%s. %d elections&quot;, Desc.CStr(), ElecIdV.Len()),
2252      &quot;n (vote index, time)&quot;, &quot;Probability of positive vote&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false);
2253  }
2254  void TWikiElecBs::PlotAvgVoteDev(const TIntV&amp; ElecIdV, const TStr&amp; OutFNm, const TStr&amp; Desc) const {
2255    THash&lt;TInt, TMom&gt; MomH;
2256    TFltV AvgVoteV;
2257    for (int i = 0; i &lt; ElecIdV.Len(); i++) {
2258      GetElec(ElecIdV[i]).GetAvgVoteDevOt(AvgVoteV, true);
2259      for (int v = 0; v &lt; AvgVoteV.Len(); v++) {
2260        MomH.AddDat(v+1).Add(AvgVoteV[v]); }
2261    }
2262    TGnuPlot::PlotValMomH(MomH, &quot;voteDev-&quot;+OutFNm, TStr::Fmt(&quot;%s. %d elections&quot;, Desc.CStr(), ElecIdV.Len()),
2263      &quot;n (vote index, time)&quot;, &quot;Deviation of the running average&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false);
2264    MomH.SortByKey();
2265    for (int v = 0; v &lt; MomH.Len(); v+=10) {
2266      printf(&quot;  %d\t%g\n&quot;, v, MomH[v].GetWgt());
2267    }
2268  }
2269  void TWikiElecBs::PlotAvgSupFrac(const TIntV&amp; ElecIdV, const TStr&amp; OutFNm, const TStr&amp; Desc) const {
2270    THash&lt;TInt, TMom&gt; MomH;
2271    TFltV AvgVoteV;
2272    for (int i = 0; i &lt; ElecIdV.Len(); i++) {
2273      TWikiVoteV VoteV;
2274      GetElec(ElecIdV[i]).GetVotesOt(VoteV);
2275      for (int v = 0; v &lt; VoteV.Len(); v++) {
2276        MomH.AddDat(v+1).Add(VoteV[v].GetVote()==1?1:0); }
2277    }
2278    TGnuPlot::PlotValMomH(MomH, &quot;voteFrac-&quot;+OutFNm, TStr::Fmt(&quot;%s. %d elections&quot;, Desc.CStr(), ElecIdV.Len()),
2279      &quot;T (vote index, time)&quot;, &quot;Fraction of all votes casted at time T that were supporting&quot;, gpsAuto, gpwLinesPoints, true, false, false, false, false);
2280  }
2281  void TWikiElecBs::PlotOutcomes(const TStr&amp; OutFNm) const {
2282    TWikiVoteV VoteV;
2283    TIntV UIdV;  GetEIdByVotes(UIdV);
2284    TGnuPlot GP(&quot;votes-otime3-0&quot;), GP2(&quot;votes-otime4-0&quot;);
2285    for (int u = 0; u &lt; 100; u++) {
2286      const TWikiElec&amp; E = GetElec(UIdV[u]);
2287      E.GetVotesOt(VoteV, true);
2288      const int b = VoteV[0].GetTm().GetAbsSecs();
2289      TFltPrV FracV, FracV2;
2290      int pos=0, neg=0;
2291      for (int v = 0; v &lt; VoteV.Len(); v++) {
2292        if (VoteV[v].GetVote()==1) { pos++; }
2293        else if (VoteV[v].GetVote()==-1) { neg++; } else { continue; }
2294        FracV.Add(TFltPr(v, pos/double(pos+neg)));
2295        FracV2.Add(TFltPr(v/double(VoteV.Len()), pos/double(pos+neg)));
2296      }
2297      GP.AddPlot(FracV, gpwLines);
2298      GP2.AddPlot(FracV2, gpwLines);
2299      if ((u+1) % 10 == 0) {
2300        GP.SavePng();
2301        GP2.SavePng();
2302        GP = TGnuPlot(TStr::Fmt(&quot;votes-otime3-%d&quot;, u/10));
2303        GP2 = TGnuPlot(TStr::Fmt(&quot;votes-otime4-%d&quot;, u/10));
2304      }
2305    }
2306    GP.SavePng();
2307    GP2.SavePng();
2308  }
2309  void TWikiElecBs::PlotSupFracVsElecLen(const TStr&amp; OutFNm) const {
2310    THash&lt;TInt, TMom&gt; ElecMom;
2311    THash&lt;TInt, TMom&gt; ElecMom5;
2312    THash&lt;TInt, TMom&gt; ElecMom10;
2313    for (int e = 0; e &lt; Len(); e++) {
2314      ElecMom.AddDat(GetElec(e).Len()).Add(GetElec(e).GetFracSup());
2315      ElecMom5.AddDat(5*(GetElec(e).Len()/5)).Add(GetElec(e).GetFracSup());
2316      ElecMom10.AddDat(10*(GetElec(e).Len()/10)).Add(GetElec(e).GetFracSup());
2317    }
2318    TGnuPlot::PlotValMomH(ElecMom, &quot;fracSupLen-&quot;+OutFNm, &quot;Bucket size 1&quot;, &quot;Number of votes in the election&quot;, &quot;Final fraction of support votes&quot;);
2319    TGnuPlot::PlotValMomH(ElecMom5, &quot;fracSupLen-&quot;+OutFNm+&quot;5&quot;, &quot;Bucket size 5&quot;, &quot;Number of votes in the election&quot;, &quot;Final fraction of support votes&quot;);
2320    TGnuPlot::PlotValMomH(ElecMom10, &quot;fracSupLen-&quot;+OutFNm+&quot;10&quot;, &quot;Bucket size 10&quot;, &quot;Number of votes in the election&quot;, &quot;Final fraction of support votes&quot;);
2321  }
2322  void TWikiElecBs::PlotSupOpp(const TStr&amp; OutFNm) const {
2323  }
2324  void TWikiElecBs::PlotVoteDistr(const TStr&amp; OutFNm) const {
2325    TWikiVoteV VoteV;
2326    TIntV UIdV;  GetEIdByVotes(UIdV);
2327    TVec&lt;TMom&gt; SupV, OppV;
2328    THash&lt;TInt, TIntH&gt; PosH, NegH;
2329    for (int u = 0; u &lt; 2000; u++) {
2330      const TWikiElec&amp; E = GetElec(UIdV[u]);
2331      const TIntTr PON = E.GetVotes(true);
2332      if ((PON.Val1+2*PON.Val2) &lt; 50)  {
2333        PosH.AddDat((PON.Val1+PON.Val2)/10).AddDat((PON.Val1))++;
2334        NegH.AddDat((PON.Val1+PON.Val2)/10).AddDat((PON.Val1-PON.Val2))++;
2335        printf(&quot;%d &quot;, PON.Val1+PON.Val2);
2336      }
2337    }
2338    PosH.SortByKey(); NegH.SortByKey();
2339    for (int i = 0; i &lt; PosH.Len(); i++) {
2340      TGnuPlot GP(TStr::Fmt(&quot;voteX-distr%02d&quot;, PosH.GetKey(i)));
2341      TFltPrV PrV1, PrV2;
2342      IAssert(PosH.GetKey(i) == NegH.GetKey(i));
2343      TIntH&amp; CntH1 = PosH[i];  CntH1.SortByKey();
2344      TIntH&amp; CntH2 = NegH[i];  CntH2.SortByKey();
2345      for (int j = 0; j &lt; CntH1.Len(); j++) {
2346        PrV1.Add(TFltPr(CntH1.GetKey(j).Val, CntH1[j].Val)); }
2347      for (int j = 0; j &lt; CntH2.Len(); j++) {
2348        PrV2.Add(TFltPr(CntH2.GetKey(j).Val, CntH2[j].Val)); }
2349      GP.AddPlot(PrV1, gpwLinesPoints, &quot;Pos&quot;);
2350      GP.AddCmd(&quot;set yzeroaxis lt -1&quot;);
2351      GP.SavePng();
2352    }
2353  }
2354  PSignNet TWikiElecBs::GetAdminUsrVoteNet() const {
2355    TIntV UIdV;
2356    GetElecAdminUsrV(UIdV);
2357    return GetVoteNet(UIdV);
2358  }
2359  PSignNet TWikiElecBs::GetElecUsrVoteNet() const {
2360    TIntV UIdV;
2361    GetElecUsrV(UIdV);
2362    return GetVoteNet(UIdV);
2363  }
2364  PSignNet TWikiElecBs::GetAllUsrVoteNet() const {
2365    TIntV UIdV;
2366    GetUsrV(UIdV);
2367    return GetVoteNet(UIdV);
2368  }
2369  PSignNet TWikiElecBs::GetVoteNet(const TIntV&amp; UsrIdV) const {
2370    TIntSet UsrSet;
2371    for (int u = 0; u &lt; UsrIdV.Len(); u++) {
2372      UsrSet.AddKey(UsrIdV[u]);
2373    }
2374    PSignNet Net = TSignNet::New();
2375    THash&lt;TIntPr, TStr&gt; EdgeElecH;
2376    for (int e = 0; e &lt; Len(); e++) {
2377      const TWikiElec&amp; FullE = GetElec(e);
2378      const int Dst = FullE.GetUId();
2379      if (! UsrSet.IsKey(Dst)) { continue; }
2380      TWikiElec NewElec;
2381      FullE.GetOnlyVotes(NewElec, true);
2382      for (int v = 0; v &lt; NewElec.Len(); v++) {
2383        const int Src = NewElec[v].GetUId();
2384        if (! UsrSet.IsKey(Src)) { continue; }
2385        if (Src == Dst) { continue; }
2386        if (! Net-&gt;IsNode(Dst)) {
2387          Net-&gt;AddNode(Dst); }
2388        if (! Net-&gt;IsNode(Src)) {
2389          Net-&gt;AddNode(Src); }
2390        if (Net-&gt;IsEdge(Src, Dst)) { 
2391        }
2392        Net-&gt;AddEdge(Src, Dst, NewElec[v].GetVote());
2393      }
2394    }
2395    return Net;
2396  }
2397  void TWikiElecBs::GetOnlyVoteElecBs(TWikiElecBs&amp; NewElecBs, const bool&amp; OnlySupOpp) const {
2398    NewElecBs.UsrH = UsrH;
2399    NewElecBs.ElecV = ElecV;
2400    for (int e = 0; e &lt; ElecV.Len(); e++) {
2401      ElecV[e].GetOnlyVotes(NewElecBs.ElecV[e], OnlySupOpp);  
2402    }
2403  }
2404  bool TWikiElecBs::AddElecRes(const TWikiMetaHist&amp; WMH, const THash&lt;TStr, TStr&gt;&amp; UsrMapH, const THash&lt;TStr, TWikiElecBs::TElecSum&gt;&amp; ElecSumH) {
2405    if (! WMH.Title.IsPrefix(&quot;Wikipedia:Requests_for_adminship/&quot;)) { return false; }
2406    const int b = WMH.Title.SearchCh(&#x27;/&#x27;)+1;
2407    const int e = WMH.Title.SearchCh(&#x27;/&#x27;, b+1)-1;
2408    TChA RfaTitle = WMH.Title.GetSubStr(b, e&gt;b?e:TInt::Mx);
2409    TWikiElec WikiElec(-1, WMH.RevTm); 
2410    ParseVotes(WMH, UsrMapH, WikiElec);
2411    WikiElec.SetIsVoteFlag();
2412    WikiElec.RfaTitle = RfaTitle;
2413    TIntTr V = WikiElec.GetVotes();
2414    if (RfaTitle.IsSuffix(&quot;_Couriano&quot;)) { RfaTitle = &quot;Couriano&quot;; } 
2415    if (ElecSumH.IsKey(RfaTitle)) {
2416      const TElecSum&amp; ElSum = ElecSumH.GetDat(RfaTitle);
2417      WikiElec.IsSucc = true;
2418      TChA U = ElSum.Usr;
2419      if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
2420      WikiElec.UsrId = AddUsr(ElSum.Usr.CStr()); 
2421      if (! ElSum.Bureaucrat.Empty()) {
2422        TChA U = ElSum.Bureaucrat;
2423        if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
2424        WikiElec.BurUId = AddUsr(U);
2425      }
2426      if (! ElSum.NominatedBy.Empty()) {
2427        TChA U = ElSum.NominatedBy;
2428        if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
2429        WikiElec.NomUId = AddUsr(U);
2430      }
2431      if (abs(V.Val1-ElSum.Sup) &gt; 0) { printf(&quot;SUP VOTES: %d != %d\n&quot;, V.Val1, ElSum.Sup);  }
2432      if (abs(V.Val2-ElSum.Neu) &gt; 0) { printf(&quot;NEU VOTES: %d != %d\n&quot;, V.Val2, ElSum.Neu);  }
2433      if (abs(V.Val3-ElSum.Opp) &gt; 0) { printf(&quot;OPP VOTES: %d != %d\n&quot;, V.Val3, ElSum.Opp);  }
2434    } else {
2435      TChA U = RfaTitle.ToLc(); 
2436      if (UsrMapH.IsKey(U)) { U = UsrMapH.GetDat(U); }
2437      WikiElec.UsrId = AddUsr(U); 
2438    }
2439    if (V.Val1+V.Val2+V.Val3 == 0) {
2440      printf(&quot;no votes\n&quot;); return false;
2441    }
2442    ElecV.Add(WikiElec);
2443    return true;
2444  }
2445  int TWikiElecBs::GetWikiTxtLen(char* LineStr) {
2446    int Len=0;
2447    for (char *ch=LineStr+1; *ch != NULL; ch++) {
2448      if (TCh::IsAlNum(*ch)) { Len++; }
2449      if (*ch==&#x27;[&#x27; &amp;&amp; *(ch-1)==&#x27;[&#x27;) {
2450        while (*ch &amp;&amp; *ch!=&#x27;]&#x27; &amp;&amp; *(ch-1)!=&#x27;]&#x27;) { ch++; }
2451      }
2452    }
2453    return Len;
2454  }
2455  void TWikiElecBs::LoadElecSumTxt(const TStr&amp; FNm, THash&lt;TStr, TWikiElecBs::TElecSum&gt;&amp; ElecSumH) {
2456    ElecSumH.Clr();
2457    for (TSsParser SS(FNm, ssfTabSep); SS.Next(); ) {
2458      IAssert(SS.Len() == 9);
2459      TElecSum&amp; S = ElecSumH.AddDat(SS[1]); 
2460      S.Usr = SS[0];          S.Usr.ToLc();
2461      S.RfA = SS[1];
2462      S.Sup = SS.GetInt(2);
2463      S.Opp = SS.GetInt(3);
2464      S.Neu = SS.GetInt(4);
2465      S.NominatedBy = SS[7];  S.NominatedBy.ToLc();
2466      S.Bureaucrat = SS[8];   S.Bureaucrat.ToLc();
2467    }
2468  }
2469  bool EndOfSection(char* Line, const TStr&amp; WhatStr) {
2470    if (Line[0]==&#x27;#&#x27; || Line[0]==&#x27;:&#x27;) { return false; }
2471    TChA LnStr(Line);
2472    LnStr.ToTrunc();
2473    if (LnStr.SearchStr(TStr::Fmt(&quot;&#x27;&#x27;&#x27;%s&#x27;&#x27;&#x27;&quot;, WhatStr.CStr()))!=-1) { return true; }
2474    if (LnStr.SearchStr(TStr::Fmt(&quot;====%s====&quot;, WhatStr.CStr()))!=-1) { return true; }
2475    if (LnStr.SearchStr(TStr::Fmt(&quot;==== %s ====&quot;, WhatStr.CStr()))!=-1) { return true; }
2476    if (LnStr.SearchStr(TStr::Fmt(&quot;&#x27;&#x27;&#x27;%s:&#x27;&#x27;&#x27;&quot;, WhatStr.CStr()))!=-1) { return true; }
2477    if (LnStr.SearchStr(TStr::Fmt(&quot;====%s:====&quot;, WhatStr.CStr()))!=-1) { return true; }
2478    if (LnStr.IsPrefix(TStr::Fmt(&quot;; %s&quot;, WhatStr.CStr()))) { return true; }
2479    if (LnStr.IsPrefix(TStr::Fmt(&quot;;%s&quot;, WhatStr.CStr()))) { return true; }
2480    if (LnStr==TStr::Fmt(&quot;%s&quot;, WhatStr.CStr())) { return true; }
2481    if (LnStr==TStr::Fmt(&quot;%s:&quot;, WhatStr.CStr())) { return true; }
2482    return false;
2483  }
2484  void TWikiElecBs::ParseVotes(const TWikiMetaHist&amp; WMH, const THash&lt;TStr, TStr&gt;&amp; UsrMapH, TWikiElec&amp; WikiElec) {
2485    TVec&lt;char *&gt; LineV;  TChA Tmp = WMH.Text;
2486    Tmp.ToLc();
2487    TStrUtil::SplitLines(Tmp, LineV);
2488    int l = 0, goodVote=0;
2489    int NSup=0, NOpp=0, NNeu=0;
2490    for (; l &lt; LineV.Len(); l++) {
2491      if (EndOfSection(LineV[l], &quot;support&quot;)) { l++; break; }
2492      char *vote=strstr(LineV[l], &quot;) end&quot;);
2493      if (vote == NULL) { vote=strstr(LineV[l], &quot;) end&quot;); }
2494      if (vote != NULL &amp;&amp; TCh::IsNum(*(vote-1)) &amp;&amp; NSup==-1) {
2495        *vote=0;  vote--;
2496        while(TCh::IsNum(*vote)) { vote--; }
2497        if (*vote == &#x27;/&#x27;) {
2498          NNeu = atoi(vote+1);  *vote=0;  vote--;
2499          while(TCh::IsNum(*vote)) { vote--; }
2500          if (*vote == &#x27;/&#x27;) {
2501            NOpp = atoi(vote+1);  *vote=0;  vote--;
2502            while(TCh::IsNum(*vote)) { vote--; }
2503            if (*vote == &#x27;(&#x27;) { NSup = atoi(vote+1); } }
2504      } }/&amp;bsol;*/
2505    }
2506    TChA Usr;  TSecTm Tm;  int Indent;
2507    for (; l &lt; LineV.Len(); l++) {
2508      if(GetUsrTm(LineV[l], Usr, Tm, Indent)) {  goodVote++;
2509      if (UsrMapH.IsKey(Usr)) { Usr = UsrMapH.GetDat(Usr);  }
2510        WikiElec.VoteV.Add(TWikiVote(AddUsr(Usr), +1, Indent, GetWikiTxtLen(LineV[l]), Tm));
2511      }
2512      if (EndOfSection(LineV[l], &quot;oppose&quot;)) { l++; break; }
2513    }
2514    for (; l &lt; LineV.Len(); l++) {
2515      if(GetUsrTm(LineV[l], Usr, Tm, Indent)) {  goodVote++;
2516        if (UsrMapH.IsKey(Usr)) { Usr = UsrMapH.GetDat(Usr); }
2517        WikiElec.VoteV.Add(TWikiVote(AddUsr(Usr), -1, Indent, GetWikiTxtLen(LineV[l]), Tm));
2518      }
2519      if (EndOfSection(LineV[l], &quot;neutral&quot;)) { l++; break; }
2520    }
2521    for (; l &lt; LineV.Len(); l++) {
2522      if(GetUsrTm(LineV[l], Usr, Tm, Indent)) {  goodVote++;
2523        if (UsrMapH.IsKey(Usr)) { Usr = UsrMapH.GetDat(Usr); printf(&quot;u&quot;); }
2524        WikiElec.VoteV.Add(TWikiVote(AddUsr(Usr), 0, Indent, GetWikiTxtLen(LineV[l]), Tm));
2525      }
2526      if (LineV[l][0]!=&#x27;#&#x27; &amp;&amp; (strstr(LineV[l], &quot;&#x27;&#x27;&#x27;comments&quot;)!=NULL || strstr(LineV[l], &quot;&#x27;&#x27;&#x27;no vote&quot;)!=NULL
2527        || strstr(LineV[l], &quot;====&quot;)!=NULL || strstr(LineV[l], &quot;;comments&quot;)!=NULL || strstr(LineV[l], &quot;; comments&quot;)!=NULL ||
2528        strcmp(LineV[l],&quot;comment&quot;)==0 || strcmp(LineV[l],&quot;comments&quot;)==0)) { l++; break; }
2529    }
2530    const TIntTr SON = WikiElec.GetVotes(true);
2531    if (SON.Val1+SON.Val2+SON.Val3 &gt; 100 &amp;&amp; (SON.Val1==0 || SON.Val2==0)) {
2532    }
2533  }
2534  void TWikiElecBs::SetUserIdFromRfa() {
2535    THash&lt;TChA, TChA&gt; RfaUsrMapH;
2536    RfaUsrMapH.AddDat(&quot;White_Cat_(01)&quot;, &quot;White_Cat&quot;);
2537    RfaUsrMapH.AddDat(&quot;White_Cat_(02)&quot;, &quot;White_Cat&quot;);
2538    RfaUsrMapH.AddDat(&quot;White_Cat_(03)&quot;, &quot;White_Cat&quot;);
2539    RfaUsrMapH.AddDat(&quot;White_Cat_(04)&quot;, &quot;White_Cat&quot;);
2540    RfaUsrMapH.AddDat(&quot;Computerjoe_(4)&quot;, &quot;Computerjoe&quot;);
2541    RfaUsrMapH.AddDat(&quot;Purplefeltangel2&quot;, &quot;Purplefeltangel&quot;);
2542    RfaUsrMapH.AddDat(&quot;Haham_Hanuka_(3)&quot;, &quot;Haham_Hanuka&quot;);
2543    RfaUsrMapH.AddDat(&quot;dbertman_(archive)&quot;, &quot;dbertman&quot;);
2544    RfaUsrMapH.AddDat(&quot;Agentsoo_(archive)&quot;, &quot;Agentsoo&quot;);
2545    RfaUsrMapH.AddDat(&quot;Guanaco3&quot;, &quot;Guanaco&quot;);
2546    RfaUsrMapH.AddDat(&quot;Brendenhull2&quot;, &quot;Brendenhull&quot;);
2547    RfaUsrMapH.AddDat(&quot;Xerocs2&quot;, &quot;Xerocs&quot;);
2548    RfaUsrMapH.AddDat(&quot;Wikiwoohoo2&quot;, &quot;Wikiwoohoo&quot;);
2549    RfaUsrMapH.AddDat(&quot;Folajimi2&quot;, &quot;Folajimi&quot;);
2550    RfaUsrMapH.AddDat(&quot;FuriousFreddy_r1&quot;, &quot;FuriousFreddy&quot;);
2551    RfaUsrMapH.AddDat(&quot;General_Eisenhower3&quot;, &quot;General_Eisenhower&quot;);
2552    RfaUsrMapH.AddDat(&quot;HolyRomanEmperor2&quot;, &quot;HolyRomanEmperor&quot;);
2553    RfaUsrMapH.AddDat(&quot;HolyRomanEmperor3&quot;, &quot;HolyRomanEmperor&quot;);
2554    RfaUsrMapH.AddDat(&quot;HolyRomanEmperor3a&quot;, &quot;HolyRomanEmperor&quot;);
2555    RfaUsrMapH.AddDat(&quot;Jet123_(2nd_nom)&quot;, &quot;Jet123&quot;);
2556    RfaUsrMapH.AddDat(&quot;Natl1_(2nd_nom)&quot;, &quot;Natl1&quot;);
2557    RfaUsrMapH.AddDat(&quot;NickCatal2&quot;, &quot;NickCatal&quot;);
2558    RfaUsrMapH.AddDat(&quot;P.B._Pilhet_2nd_Nomination&quot;, &quot;P.B._Pilhet&quot;);
2559    RfaUsrMapH.AddDat(&quot;Patchouli2&quot;, &quot;Patchouli&quot;);
2560    RfaUsrMapH.AddDat(&quot;Patchouli3&quot;, &quot;Patchouli&quot;);
2561    RfaUsrMapH.AddDat(&quot;The_Wookieepedian2&quot;, &quot;The_Wookieepedian&quot;);
2562    RfaUsrMapH.AddDat(&quot;Son_of_a_Peach_II&quot;, &quot;Son_of_a_Peach&quot;);
2563    RfaUsrMapH.AddDat(&quot;SVera1NY_(second_nomination)&quot;, &quot;SVera1NY&quot;);
2564    RfaUsrMapH.AddDat(&quot;Tellyaddict2&quot;, &quot;Tellyaddict&quot;);
2565    RfaUsrMapH.AddDat(&quot;Tenebrae2&quot;, &quot;Tenebrae&quot;);
2566    RfaUsrMapH.AddDat(&quot;Poccil2&quot;, &quot;Poccil&quot;);
2567    RfaUsrMapH.AddDat(&quot;Purplefeltangel2&quot;, &quot;Purplefeltangel&quot;);
2568    RfaUsrMapH.AddDat(&quot;Ramsquire2&quot;, &quot;Ramsquire&quot;);
2569    RfaUsrMapH.AddDat(&quot;ScienceApologist2&quot;, &quot;ScienceApologist&quot;);
2570    RfaUsrMapH.AddDat(&quot;Jor2&quot;, &quot;Jor&quot;);
2571    for (int e = 0; e &lt; Len(); e++) {
2572      TWikiElec&amp; E = GetElec(e);
2573      if (E.IsSucc()) { continue; }
2574      TChA Rfa = E.RfaTitle;
2575      const int l = Rfa.Len();
2576      TChA User;
2577      if (l&gt;2 &amp;&amp; Rfa[l-2]==&#x27;_&#x27; &amp;&amp; TCh::IsNum(Rfa[l-1])) { User = Rfa.GetSubStr(0, l-3); } 
2578      else if (Rfa.IsSuffix(&quot;.08&quot;) || Rfa.IsSuffix(&quot;.09&quot;) || Rfa.IsSuffix(&quot;.10&quot;)) { User = Rfa.GetSubStr(0, l-4); }
2579      else if (Rfa.IsSuffix(&quot;_(renomination)&quot;)) { User = Rfa.GetSubStr(0, l-(int)strlen(&quot;_(renomination)&quot;)-1); }
2580      else if (Rfa.IsSuffix(&quot;_(2)&quot;)) { User = Rfa.GetSubStr(0, l-5); }
2581      else if (Rfa.IsSuffix(&quot;_(2nd)&quot;)) { User = Rfa.GetSubStr(0, l-7); }
2582      else if (Rfa.IsSuffix(&quot;_(2nd_nomination)&quot;)) { User = Rfa.GetSubStr(0, l-(int)strlen(&quot;_(2nd_nomination)&quot;)-1); }
2583      else if (RfaUsrMapH.IsKey(Rfa)) { User = RfaUsrMapH.GetDat(Rfa); }
2584      else { continue; }
2585      User.ToLc();
2586      printf(&quot;%20s\t-&gt;\t%s\n&quot;, Rfa.CStr(), User.CStr());
2587      E.UsrId = AddUsr(User.CStr());
2588    }
2589  }
2590  void TWikiElecBs::Dump() const {
2591    int v=0, Sup=0, Opp=0, Neu=0;
2592    int VSup=0, VOpp=0, VNeu=0;
2593    for (int e=0; e&lt; Len(); e++) {
2594      v += GetElec(e).Len();
2595      TIntTr Votes = GetElec(e).GetVotes(false);
2596      Sup += Votes.Val1;  Neu += Votes.Val2;  Opp += Votes.Val3;
2597      Votes = GetElec(e).GetVotes(true);
2598      VSup += Votes.Val1;  VNeu += Votes.Val2;  VOpp += Votes.Val3;
2599    }
2600    printf(&quot;%5d users, %3d elections, %d all votes (%d/%d/%d)\n&quot;, UsrH.Len(), Len(), v, Sup, Opp, Neu);
2601    printf(&quot;                             %d all votes (%d/%d/%d)\n&quot;, VSup+VOpp+VNeu, VSup, VOpp, VNeu);
2602    TIntSet AdminSet, NAdminSet;
2603    TMom SupA, OppA, NeuA, SupNA, OppNA, NeuNA, ASupFrac, NASupFrac;
2604    TFltIntPrV AElecV, NAElecV;
2605    int nsucc=0;
2606    for (int e = 0; e &lt; Len(); e++) {
2607      const TWikiElec&amp; E = GetElec(e);
2608      const TIntTr V = E.GetVotes(true);
2609      double SupFrac = V.Val1+V.Val3&gt;0 ? V.Val1/double(V.Val1+V.Val3) : 0;
2610      if (V.Val1+V.Val3 == 0) { continue; }
2611      if (E.IsSucc) {
2612        AdminSet.AddKey(E.UsrId);
2613        SupA.Add(V.Val1());  NeuA.Add(V.Val2());  OppA.Add(V.Val3());
2614        AElecV.Add(TFltIntPr(SupFrac, e));
2615        ASupFrac.Add(SupFrac);
2616        nsucc++;
2617      } else {
2618        NAdminSet.AddKey(E.UsrId());
2619        SupNA.Add(V.Val1());  NeuNA.Add(V.Val2());  OppNA.Add(V.Val3());
2620        NAElecV.Add(TFltIntPr(SupFrac, e));
2621        NASupFrac.Add(SupFrac);
2622      }
2623    }
2624    printf(&quot;succ elecs %d\n&quot;, nsucc);
2625    SupA.Def(); OppA.Def(); NeuA.Def(); SupNA.Def(); OppNA.Def(); NeuNA.Def();
2626    ASupFrac.Def();  NASupFrac.Def();
2627    printf(&quot;succ elecs vs. failed elecs: %d admins. Votes:\n&quot;, AdminSet.Len());
2628    printf(&quot;  sup: %.1f : %.1f\n&quot;, SupA.GetMean(), SupNA.GetMean());
2629    printf(&quot;  neu:  %.1f : %.1f\n&quot;, NeuA.GetMean(), NeuNA.GetMean());
2630    printf(&quot;  fail: %.1f : %.1f\n&quot;, OppA.GetMean(), OppNA.GetMean());
2631    printf(&quot;  support fraction: %f : %f\n&quot;, ASupFrac.GetMean(), NASupFrac.GetMean());
2632    TInt ASup, AOpp, NASup, NAOpp, OSup, OOpp, AllSup, AllOpp; 
2633    TInt AEl, NAEl, OEl;
2634    TIntPrV TmV;
2635    for (int e = 0; e &lt; Len(); e++) {
2636      const TWikiElec&amp; E = GetElec(e);
2637      TWikiElec NewElec;  E.GetOnlyVotes(NewElec, true);
2638      bool IsA=false, IsNA=false, IsO=false;
2639      TmV.Add(TIntPr(E.GetTm().GetAbsSecs(), e));
2640      for (int v = 0; v &lt; NewElec.Len(); v++) {
2641        const int vote = NewElec[v].GetVote();
2642        const int uid = NewElec[v].GetUId();
2643        if (AdminSet.IsKey(uid)) {
2644          if (vote == 1) { ASup++; } else { AOpp++; }
2645          IsA=true; }
2646        else if (NAdminSet.IsKey(uid)) {
2647          if (vote == 1) { NASup++; } else { NAOpp++; }
2648          IsNA=true; }
2649        else {
2650          if (vote == 1) { OSup++; } else { OOpp++; }
2651          IsO=true; }
2652        if (vote == 1) { AllSup++; }
2653        if (vote == -1) { AllOpp++; }
2654      }
2655      if (IsA) { AEl++; }
2656      if (IsNA) { NAEl++; }
2657      if (IsO) { OEl++; }
2658    }
2659    TmV.Sort();
2660    printf(&quot;elections from:\t%s\n\t%s\n&quot;, TSecTm(TmV[0].Val1()).GetStr().CStr(), TSecTm(TmV.Last().Val1()).GetStr().CStr());
2661    for (int i = 0; i &lt;100; i++) { printf(&quot;%d\n&quot;, TmV[i].Val2); }
2662    for (int i = TmV.Len()-100; i &lt;TmV.Len(); i++) { printf(&quot;%d\n&quot;, TmV[i].Val2); }
2663    TIntV UsrV; GetUsrV(UsrV);
2664    printf(&quot;voters: %d\n&quot;, UsrV.Len());
2665    printf(&quot;votes by:\n&quot;);
2666    printf(&quot;  all:         %5d : %5d = %f    elecs: %d    users: %d\n&quot;, AllSup, AllOpp, AllSup/double(AllSup+AllOpp), Len(), UsrV.Len());
2667    printf(&quot;  admins:      %5d : %5d = %f    elecs: %d    users: %d\n&quot;, ASup, AOpp, ASup/double(ASup+AOpp), AEl, AdminSet.Len());
2668    printf(&quot;  non-admins:  %5d : %5d = %f    elecs: %d    users: %d\n&quot;, NASup, NAOpp, NASup/double(NASup+NAOpp), NAEl, NAdminSet.Len());
2669    printf(&quot;  others:      %5d : %5d = %f    elecs: %d    users: %d\n\n&quot;, OSup, OOpp, OSup/double(OSup+OOpp), OEl, UsrH.Len()-AdminSet.Len()-NAdminSet.Len());
2670  }
2671  void TWikiElecBs::SaveElecUserVotes(const TStr&amp; OutFNm) const {
2672    TIntSet USet;
2673    for (int e = 0; e &lt; Len(); e++) {
2674      const TWikiElec&amp; E = GetElec(e);
2675      if (E.Len() &lt; 10) { continue; }
2676      for (int v = 0; v &lt; E.Len(); v++) {
2677        USet.AddKey(E[v].GetUId()); }
2678    }
2679    FILE *F = fopen(OutFNm.CStr(), &quot;wt&quot;);
2680    fprintf(F, &quot;IsSucc&quot;);
2681    for (int u = 0; u &lt; USet.Len(); u++) {
2682      fprintf(F, &quot;\tu%d&quot;, USet[u]);
2683    }
2684    fprintf(F, &quot;\n&quot;);
2685    for (int e = 0; e &lt; Len(); e++) {
2686      const TWikiElec&amp; E = GetElec(e);
2687      if (E.Len() &lt; 10) { continue; }
2688      TIntSet Voters;
2689      for (int v = 0; v &lt; E.Len(); v++) {
2690        Voters.AddKey(E[v].GetUId()); }
2691      fprintf(F, &quot;%d&quot;, E.IsSucc?1:0);
2692      for (int u = 0; u &lt; USet.Len(); u++) {
2693        if (Voters.IsKey(USet[u])) { fprintf(F, &quot;\t1&quot;); }
2694        else { fprintf(F, &quot;\t0&quot;); }
2695      }
2696      fprintf(F, &quot;\n&quot;);
2697    }
2698    fclose(F);
2699  }
2700  void TWikiElecBs::SaveTxt(const TStr&amp; OutFNm) {
2701    SortVotesByTm();
2702    FILE *F = fopen(OutFNm.CStr(), &quot;wt&quot;);
2703    fprintf(F, &quot;# Wikipedia elections (http:&amp;bsol;&amp;bsol;cs.stanford.edu/people/jure/pubs/triads-chi10.pdf). Data format:\n&quot;);
2704    fprintf(F, &quot;#   E: is election succesful (1) or not (0)\n&quot;);
2705    fprintf(F, &quot;#   T: time election was closed\n&quot;);
2706    fprintf(F, &quot;#   U: user id (and username) of editor that is being considered for promotion\n&quot;);
2707    fprintf(F, &quot;#   N: user id (and username) of the nominator\n&quot;);
2708    fprintf(F, &quot;#   V: &lt;vote(1:support, 0:neutral, -1:oppose)&gt; &lt;user_id&gt; &lt;time&gt; &lt;username&gt;\n&quot;);
2709    for (int e = 0; e &lt; Len(); e++) {
2710      const TWikiElec&amp; E = GetElec(e);
2711      fprintf(F, &quot;E\t%d\n&quot;, E.IsSucc?1:0);
2712      fprintf(F, &quot;T\t%s\n&quot;, E.ElecTm.GetYmdTmStr().CStr());
2713      fprintf(F, &quot;U\t%d\t%s\n&quot;, E.UsrId, GetUsr(E.UsrId));
2714      fprintf(F, &quot;N\t%d\t%s\n&quot;, E.NomUId, E.NomUId==-1?&quot;UNKNOWN&quot;:GetUsr(E.NomUId));
2715      for (int v = 0; v &lt; E.Len(); v++) {
2716        if (! E[v].IsVote()) { continue; }
2717        fprintf(F, &quot;V\t%d\t%d\t%s\t%s\n&quot;, E[v].GetVote(), E[v].GetUId(), E[v].GetTm().GetYmdTmStr().CStr(), GetUsr(E[v].GetUId()));
2718      }
2719      fprintf(F, &quot;\n&quot;);
2720    }
2721    fclose(F);
2722  }
2723  void TWikiElecBs::SaveOnlyVotes() {
2724    TWikiElecBs NewElBs;
2725    GetOnlyVoteElecBs(NewElBs, true);
2726    NewElBs.SortVotesByTm();
2727    TStrSet RfaSet;
2728    for (int e = 0; e &lt; NewElBs.Len(); e++) {
2729      TWikiElec&amp; E = NewElBs.GetElec(e);
2730      if (RfaSet.IsKey(E.RfaTitle)) {
2731        for (int i = 2; ; i++) {
2732          TStr NewRfa = TStr::Fmt(&quot;%s_%d&quot;, E.RfaTitle.CStr(), i);
2733          if (! RfaSet.IsKey(NewRfa)) {
2734            printf(&quot;  %s --&gt; %s\n&quot;, E.RfaTitle.CStr(), NewRfa.CStr());
2735            E.RfaTitle= NewRfa;
2736            break;
2737          }
2738        }
2739      }
2740      RfaSet.AddKey(E.RfaTitle);
2741    }
2742    NewElBs.Save(TZipOut(&quot;wikiElec-Votes.ElecBs3.rar&quot;));
2743  }
2744  bool TWikiElecBs::GetUsrTm(char* LineStr, TChA&amp; Usr, TSecTm&amp; Tm, int&amp; Indent) {
2745    TChA TmpLine=LineStr;
2746    TChA SearchStr = &quot;[[user:&quot;;
2747    char *UsrId = NULL;
2748    for (char *next=LineStr; next=strstr(next, SearchStr.CStr()); ) {
2749      UsrId=next; next++; }
2750    if (UsrId == NULL) {
2751      SearchStr = &quot;[[user talk:&quot;;
2752      for (char *next=LineStr; next=strstr(next, SearchStr.CStr()); ) {
2753        UsrId=next; next++; }
2754    }
2755    if (UsrId == NULL) {
2756      SearchStr = &quot;[[user_talk:&quot;;
2757      for (char *next=LineStr; next=strstr(next, SearchStr.CStr()); ) {
2758        UsrId=next; next++; }
2759    }
2760    if (UsrId == NULL) {
2761      return false;
2762    }
2763    UsrId += SearchStr.Len();
2764    while (*UsrId &amp;&amp; TCh::IsWs(*UsrId)) { UsrId++; }
2765    char *c = UsrId;
2766    while (*c &amp;&amp; *c!=&#x27;|&#x27; &amp;&amp; *c!=&#x27;]&#x27; &amp;&amp; *c!=&#x27;/&#x27; &amp;&amp; *c!=&#x27;#&#x27; &amp;&amp; *c!=&#x27; &#x27; &amp;&amp; *c!=&#x27;&amp;&#x27;) {
2767      if (*c==&#x27; &#x27;) { *c=&#x27;_&#x27;; }
2768      c++;
2769    }
2770    *c = 0; c++;
2771    Usr = UsrId;  Usr.ToLc();
2772    char *utc = strstr(c, &quot; (utc)&quot;);
2773    if (utc == NULL) { return false; }
2774    while (strstr(utc+1, &quot;(utc)&quot;)!=NULL) { utc = strstr(utc+1, &quot;(utc)&quot;); }
2775    *utc = 0; utc--;
2776    int FldCnt=0;
2777    char *e = utc;
2778    while (e&gt;c &amp;&amp; (*e==&#x27; &#x27; || *e==&#x27;-&#x27; || *e==&#x27;,&#x27;)) { e--; }
2779    while(e&gt;c) {
2780      while (e&gt;c &amp;&amp; ! (*e==&#x27; &#x27; || *e==&#x27;-&#x27; || *e==&#x27;,&#x27;)) { e--; }
2781      if (++FldCnt==4) { break; }
2782      while (e&gt;c &amp;&amp; (*e==&#x27; &#x27; || *e==&#x27;-&#x27; || *e==&#x27;,&#x27;)) { e--; }
2783    }
2784    e += 1;
2785    if (! TStrUtil::GetTmFromStr(e, Tm)) {
2786      return false; }
2787    Indent=0;
2788    for (char *ch=LineStr; *ch &amp;&amp; ! TCh::IsAlNum(*ch); ch++) {
2789      if (*ch == &#x27;:&#x27; || *ch == &#x27;*&#x27;) { Indent++; }
2790    }
2791    return true;
2792  }
2793  TWikiMetaLoader::TWikiMetaLoader(const TStr&amp; InFNm) {
2794    if (TZipIn::IsZipExt(InFNm.GetFExt())) { SInPt = TZipIn::New(InFNm); }
2795    else if (! InFNm.Empty()) { SInPt = TFIn::New(InFNm); }
2796    else { SInPt = TStdIn::New(); } 
2797  }
2798  bool TWikiMetaLoader::IsIpAddrUsr() const {
2799    return IsIpAddr(Usr);
2800  }
2801  bool TWikiMetaLoader::Next() {
2802    TSIn&amp; SIn = *SInPt;
2803    static TChA LnStr;
2804    for (int rec=0; SIn.GetNextLn(LnStr); rec++) {
2805      if (! LnStr.IsPrefix(&quot;REVISION &quot;)) {
2806        continue;
2807      }
2808      TChA Tmp = LnStr;
2809      TVec&lt;char *&gt; FldV; TStrUtil::SplitWords(Tmp, FldV);
2810      if (FldV.Len() != 7) {
2811        continue;
2812      }
2813      IAssert(FldV.Len() == 7);
2814      ArticleId = atoi(FldV[1]);
2815      RevisionId = atoi(FldV[2]);
2816      Title = FldV[3];
2817      RevTm = TSecTm::GetDtTmFromStr(FldV[4]);
2818      Usr = FldV[5];  Usr.ToLc();  Usr.ChangeCh(&#x27; &#x27;, &#x27;_&#x27;);  
2819      UsrId = atoi(FldV[6]);
2820      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;CATEGORY&quot;));
2821      CatStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2822      IAssert(SIn.GetNextLn(LnStr)); IAssert(LnStr.IsPrefix(&quot;IMAGE&quot;));
2823      ImgStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2824      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;MAIN&quot;));
2825      MainLStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2826      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;TALK&quot;));
2827      TalkLStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2828      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;USER&quot;));
2829      UserLStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2830      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;USER_TALK&quot;));
2831      UserTalkLStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2832      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;OTHER&quot;));
2833      OtherLStr =  LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2834      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;EXTERNAL&quot;));
2835      ExternalLStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2836      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;TEMPLATE&quot;));
2837      TemplateStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2838      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;COMMENT&quot;));
2839      CommentStr = LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx);
2840      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;MINOR&quot;));
2841      MonorEdit = LnStr[LnStr.SearchCh(&#x27; &#x27;)+1] == &#x27;1&#x27;;
2842      IAssert(SIn.GetNextLn(LnStr));  IAssert(LnStr.IsPrefix(&quot;TEXTDATA&quot;));
2843      RevWrds = atoi(LnStr.GetSubStr(LnStr.SearchCh(&#x27; &#x27;)+1, TInt::Mx).CStr());
2844      return true;
2845    }
2846    return false;
2847  }
2848  bool TWikiMetaLoader::IsIpAddr(const TChA&amp; Usr) {
2849    if (Usr.IsPrefix(&quot;ip:&quot;)) { return true; }
2850    int i = 0, Len=Usr.Len();
2851    while (i&lt;Len &amp;&amp; TCh::IsNum(Usr[i])) { i++; }
2852    if (! (i&lt;Len &amp;&amp; Usr[i]==&#x27;.&#x27;)) { return false; }
2853    i++;
2854    while (i&lt;Len &amp;&amp; TCh::IsNum(Usr[i])) { i++; }
2855    if (! (i&lt;Len &amp;&amp; Usr[i]==&#x27;.&#x27;)) { return false; }
2856    i++;
2857    while (i&lt;Len &amp;&amp; TCh::IsNum(Usr[i])) { i++; }
2858    if (i==Len) { return true; }
2859    return false;
2860  }
2861  TWikiMetaHist::TWikiMetaHist(const TStr&amp; InFNm) : SInPt(TZipIn::IsZipFNm(InFNm) ? TZipIn::New(InFNm) : TFIn::New(InFNm)), XmlInPt(TXmlParser::New(SInPt)), PageCnt(0) {
2862    printf(&quot;Init from %s\n skip till &lt;page&gt;...&quot;, InFNm.CStr());
2863    XmlInPt-&gt;SkipTillTag(&quot;page&quot;);
2864    printf(&quot;done\n&quot;);
2865  }
2866  TWikiMetaHist::TWikiMetaHist(const PSIn&amp; SIn) : SInPt(SIn), XmlInPt() {
2867  }
2868  void TWikiMetaHist::Save(TSOut&amp; SOut) const {
2869    SOut.Save(PageId);
2870    SOut.Save(RevId);
2871    SOut.Save(UsrId);
2872    RevTm.Save(SOut);
2873    Usr.Save(SOut);
2874    Cmt.Save(SOut);
2875    Title.Save(SOut);
2876    Text.Save(SOut);
2877  }
2878  void TWikiMetaHist::Clr() {
2879    PageId = RevId = UsrId = -1;
2880    RevTm = TSecTm();
2881    Usr.Clr();  Cmt.Clr();
2882    Title.Clr();  Text.Clr();  Tmp.Clr();
2883  }
2884  bool TWikiMetaHist::LoadNextBin() {
2885    TSIn&amp; SIn = *SInPt;
2886    if (SIn.Eof()) { Clr(); return false; }
2887    SIn.Load(PageId);
2888    SIn.Load(RevId);
2889    SIn.Load(UsrId);
2890    RevTm.Load(SIn);
2891    Usr.Load(SIn);
2892    Cmt.Load(SIn);
2893    Title.Load(SIn);
2894    Text.Load(SIn);
2895    for (int i = 0; i &lt; Usr.Len(); i++) {
2896      if (Usr[i]==&#x27; &#x27;) { Usr[i]=&#x27;_&#x27;; }
2897    }
2898    for (int i = 0; i &lt; Title.Len(); i++) {
2899      if (Title[i]==&#x27; &#x27;) { Title[i]=&#x27;_&#x27;; }
2900    }
2901    return true;
2902  }
2903  bool TWikiMetaHist::LoadNextTxt() {
2904    IAssert(! XmlInPt.Empty());
2905    TXmlParser&amp; XmlIn = *XmlInPt;
2906    while (! (XmlIn.Sym == xsySTag &amp;&amp; (XmlIn.SymStr == &quot;page&quot; || XmlIn.SymStr == &quot;revision&quot;))) {
2907      XmlIn.GetSym();
2908      if (XmlIn.Sym == xsyEof) { return false; }
2909    }
2910    if (XmlIn.SymStr == &quot;page&quot;) {
2911      XmlIn.GetTagVal(&quot;title&quot;, Title);
2912      XmlIn.GetTagVal(&quot;id&quot;, Tmp);
2913      PageId = atoi(Tmp.CStr());
2914      XmlIn.GetSym();
2915      if (XmlIn.SymStr != &quot;revision&quot;) {
2916        while (XmlIn.SymStr != &quot;revision&quot;) { printf(&quot;NEW_TAG:  %s\n&quot;, XmlIn.SymStr.CStr()); XmlIn.GetSym(); }
2917      }
2918    }
2919    EAssertR(XmlIn.SymStr == &quot;revision&quot;, XmlIn.SymStr); 
2920    XmlIn.GetTagVal(&quot;id&quot;, Tmp);
2921    RevId = atoi(Tmp.CStr());          
2922    XmlIn.GetTagVal(&quot;timestamp&quot;, Tmp); 
2923    Tmp[4]=0; Tmp[7]=0; Tmp[10]=0; Tmp[13]=0; Tmp[16]=0; Tmp[19]=0;
2924    RevTm = TSecTm(atoi(Tmp.CStr()), atoi(Tmp.CStr()+5), atoi(Tmp.CStr()+8),
2925      atoi(Tmp.CStr()+11), atoi(Tmp.CStr()+14), atoi(Tmp.CStr()+17));
2926    EAssert(XmlIn.GetTag(&quot;contributor&quot;) == xsySTag);
2927    XmlIn.GetSym();
2928    if (XmlIn.SymStr == &quot;ip&quot; &amp;&amp; XmlIn.Sym==xsySTag) {
2929      XmlIn.GetSym();  Usr=&quot;ip:&quot;; Usr+=XmlIn.SymStr;
2930      XmlIn.GetTag(&quot;ip&quot;);  IAssert(! XmlIn.SymStr.IsPrefix(&quot;ip:&quot;)); }
2931    else if (XmlIn.SymStr == &quot;username&quot;) {
2932      if (XmlIn.Sym == xsySTag) { XmlIn.GetSym(); Usr=XmlIn.SymStr;  EAssert(XmlIn.GetTag(&quot;username&quot;) == xsyETag); } 
2933      else { EAssert(XmlIn.Sym == xsyETag &amp;&amp; XmlIn.SymStr == &quot;username&quot;); } 
2934      XmlIn.GetTagVal(&quot;id&quot;, Tmp);  UsrId = atoi(Tmp.CStr());
2935    }
2936    for (int i = 0; i &lt; Usr.Len(); i++) {
2937      if (Usr[i]==&#x27; &#x27;) { Usr[i]=&#x27;_&#x27;; }
2938    }
2939    EAssert(XmlIn.GetTag(&quot;contributor&quot;) == xsyETag);
2940    XmlIn.GetSym();
2941    if (XmlIn.Sym == xsyETag &amp;&amp; XmlIn.SymStr == &quot;minor&quot;) { XmlIn.GetSym(); }
2942    if (XmlIn.Sym == xsySTag &amp;&amp; XmlIn.SymStr == &quot;comment&quot;) {
2943      XmlIn.GetSym();
2944      if (XmlIn.Sym == xsyStr) { Cmt=XmlIn.SymStr;  EAssert(XmlIn.GetTag(&quot;comment&quot;) == xsyETag); } 
2945      else { EAssert(XmlIn.Sym == xsyETag &amp;&amp; XmlIn.SymStr == &quot;comment&quot;); } 
2946      XmlIn.GetSym();
2947    }
2948    EAssertR(XmlIn.SymStr.IsPrefix(&quot;text&quot;), XmlIn.SymStr);
2949    if (XmlIn.Sym == xsySTag) {
2950      XmlIn.GetSym(Text);
2951      if (XmlIn.Sym == xsyStr) { EAssert(XmlIn.GetTag(&quot;text&quot;) == xsyETag); } 
2952      else { EAssert(XmlIn.Sym == xsyETag &amp;&amp; XmlIn.SymStr == &quot;text&quot;); } 
2953    }
2954    EAssert(XmlIn.GetTag(&quot;revision&quot;) == xsyETag);
2955    if (++PageCnt % 10000 == 0) {
2956      printf(&quot;** %dk items: %s time %f\n&quot;, PageCnt/1000, ExeTm.GetStr(), ExeTm.GetSecs()); fflush(stdout); }
2957    return true;
2958  }
2959  void TWikiMetaHist::Dump(const bool&amp; AlsoText) const {
2960    printf(&quot;page: %d %s\n&quot;, PageId, Title.CStr());
2961    printf(&quot;rev:  %d %s\n&quot;, RevId, RevTm.GetYmdTmStr().CStr());
2962    printf(&quot;user: %d %s\n&quot;, UsrId, Usr.CStr());
2963    printf(&quot;cmt:  %s\n&quot;, Cmt.CStr());
2964    if (AlsoText) { printf(&quot;text:\n%s\n&quot;, Text.CStr()); }
2965    printf(&quot;\n&quot;);
2966  }
2967  void TWikiMetaHist::DumpNextXmlTags(const int&amp; DumpN) {
2968    TXmlParser&amp; XmlIn = *XmlInPt;
2969    for (int i = 0; i &lt; DumpN; i++) {
2970      printf(&quot;%s\n&quot;, XmlIn.SymStr.CStr());
2971      XmlIn.GetSym();
2972      if (XmlIn.Sym == xsyEof) { return; }
2973    }
2974  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-wikinet.cpp</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-wikinet.cpp</div>
                </div>
                <div class="column column_space"><pre><code>941    Save(TZipOut(&quot;wikiEditCounts.BeforeElec.rar&quot;));
942    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiMainTalk.GetFMid().CStr());  ExeTm.Tick();
943    { TWikiMetaLoader WML(WikiMainTalk);
944    for (int rec=0; WML.Next(); rec++) {
945      TChA U = WML.Usr;
</pre></code></div>
                <div class="column column_space"><pre><code>1007    Save(TZipOut(&quot;wikiEditCounts.All.rar&quot;));
1008    printf(&quot; [%s]\n  Loading %s&quot;, ExeTm.GetStr(), WikiMainTalk.GetFMid().CStr());  ExeTm.Tick();
1009    { TWikiMetaLoader WML(WikiMainTalk);
1010    for (int rec=0; WML.Next(); rec++) {
1011      if (! ElecBs.IsUsr(WML.Usr)) { continue; }
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    