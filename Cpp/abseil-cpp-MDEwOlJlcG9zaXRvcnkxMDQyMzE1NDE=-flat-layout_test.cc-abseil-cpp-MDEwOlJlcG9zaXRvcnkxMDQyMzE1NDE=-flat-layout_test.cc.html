
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 20, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-layout_test.cc</h3>
            <pre><code>1  #include "absl/container/internal/layout.h"
2  #include <stddef.h>
3  #include <cstdint>
4  #include <memory>
5  #include <sstream>
6  #include <type_traits>
7  #include "gmock/gmock.h"
8  #include "gtest/gtest.h"
9  #include "absl/base/config.h"
10  #include "absl/log/check.h"
11  #include "absl/types/span.h"
12  namespace absl {
13  ABSL_NAMESPACE_BEGIN
14  namespace container_internal {
15  namespace {
16  using ::absl::Span;
17  using ::testing::ElementsAre;
18  size_t Distance(const void* from, const void* to) {
19    CHECK_LE(from, to) << "Distance must be non-negative";
20    return static_cast<const char*>(to) - static_cast<const char*>(from);
21  }
22  template <class Expected, class Actual>
23  Expected Type(Actual val) {
24    static_assert(std::is_same<Expected, Actual>(), "");
25    return val;
26  }
27  struct alignas(8) Int128 {
28    uint64_t a, b;
29    friend bool operator==(Int128 lhs, Int128 rhs) {
30      return std::tie(lhs.a, lhs.b) == std::tie(rhs.a, rhs.b);
31    }
32    static std::string Name() {
33      return internal_layout::adl_barrier::TypeName<Int128>();
34    }
35  };
36  struct alignas(8) Int64 {
37    int64_t a;
38    friend bool operator==(Int64 lhs, Int64 rhs) {
39      return lhs.a == rhs.a;
40    }
41  };
42  static_assert(sizeof(int8_t) == 1, "");
43  static_assert(alignof(int8_t) == 1, "");
44  static_assert(sizeof(int16_t) == 2, "");
45  static_assert(alignof(int16_t) == 2, "");
46  static_assert(sizeof(int32_t) == 4, "");
47  static_assert(alignof(int32_t) == 4, "");
48  static_assert(sizeof(Int64) == 8, "");
49  static_assert(alignof(Int64) == 8, "");
50  static_assert(sizeof(Int128) == 16, "");
51  static_assert(alignof(Int128) == 8, "");
52  template <class Expected, class Actual>
53  void SameType() {
54    static_assert(std::is_same<Expected, Actual>(), "");
55  }
56  TEST(Layout, ElementType) {
57    {
58      using L = Layout<int32_t>;
59      SameType<int32_t, L::ElementType<0>>();
60      SameType<int32_t, decltype(L::Partial())::ElementType<0>>();
61      SameType<int32_t, decltype(L::Partial(0))::ElementType<0>>();
62    }
63    {
64      using L = Layout<int32_t, int32_t>;
65      SameType<int32_t, L::ElementType<0>>();
66      SameType<int32_t, L::ElementType<1>>();
67      SameType<int32_t, decltype(L::Partial())::ElementType<0>>();
68      SameType<int32_t, decltype(L::Partial())::ElementType<1>>();
69      SameType<int32_t, decltype(L::Partial(0))::ElementType<0>>();
70      SameType<int32_t, decltype(L::Partial(0))::ElementType<1>>();
71    }
72    {
73      using L = Layout<int8_t, int32_t, Int128>;
74      SameType<int8_t, L::ElementType<0>>();
75      SameType<int32_t, L::ElementType<1>>();
76      SameType<Int128, L::ElementType<2>>();
77      SameType<int8_t, decltype(L::Partial())::ElementType<0>>();
78      SameType<int8_t, decltype(L::Partial(0))::ElementType<0>>();
79      SameType<int32_t, decltype(L::Partial(0))::ElementType<1>>();
80      SameType<int8_t, decltype(L::Partial(0, 0))::ElementType<0>>();
81      SameType<int32_t, decltype(L::Partial(0, 0))::ElementType<1>>();
82      SameType<Int128, decltype(L::Partial(0, 0))::ElementType<2>>();
83      SameType<int8_t, decltype(L::Partial(0, 0, 0))::ElementType<0>>();
84      SameType<int32_t, decltype(L::Partial(0, 0, 0))::ElementType<1>>();
85      SameType<Int128, decltype(L::Partial(0, 0, 0))::ElementType<2>>();
86    }
87  }
88  TEST(Layout, ElementTypes) {
89    {
90      using L = Layout<int32_t>;
91      SameType<std::tuple<int32_t>, L::ElementTypes>();
92      SameType<std::tuple<int32_t>, decltype(L::Partial())::ElementTypes>();
93      SameType<std::tuple<int32_t>, decltype(L::Partial(0))::ElementTypes>();
94    }
95    {
96      using L = Layout<int32_t, int32_t>;
97      SameType<std::tuple<int32_t, int32_t>, L::ElementTypes>();
98      SameType<std::tuple<int32_t, int32_t>,
99               decltype(L::Partial())::ElementTypes>();
100      SameType<std::tuple<int32_t, int32_t>,
101               decltype(L::Partial(0))::ElementTypes>();
102    }
103    {
104      using L = Layout<int8_t, int32_t, Int128>;
105      SameType<std::tuple<int8_t, int32_t, Int128>, L::ElementTypes>();
106      SameType<std::tuple<int8_t, int32_t, Int128>,
107               decltype(L::Partial())::ElementTypes>();
108      SameType<std::tuple<int8_t, int32_t, Int128>,
109               decltype(L::Partial(0))::ElementTypes>();
110      SameType<std::tuple<int8_t, int32_t, Int128>,
111               decltype(L::Partial(0, 0))::ElementTypes>();
112      SameType<std::tuple<int8_t, int32_t, Int128>,
113               decltype(L::Partial(0, 0, 0))::ElementTypes>();
114    }
115  }
116  TEST(Layout, OffsetByIndex) {
117    {
118      using L = Layout<int32_t>;
119      EXPECT_EQ(0, L::Partial().Offset<0>());
120      EXPECT_EQ(0, L::Partial(3).Offset<0>());
121      EXPECT_EQ(0, L(3).Offset<0>());
122    }
123    {
124      using L = Layout<int32_t, int32_t>;
125      EXPECT_EQ(0, L::Partial().Offset<0>());
126      EXPECT_EQ(0, L::Partial(3).Offset<0>());
127      EXPECT_EQ(12, L::Partial(3).Offset<1>());
128      EXPECT_EQ(0, L::Partial(3, 5).Offset<0>());
129      EXPECT_EQ(12, L::Partial(3, 5).Offset<1>());
130      EXPECT_EQ(0, L(3, 5).Offset<0>());
131      EXPECT_EQ(12, L(3, 5).Offset<1>());
132    }
133    {
134      using L = Layout<int8_t, int32_t, Int128>;
135      EXPECT_EQ(0, L::Partial().Offset<0>());
136      EXPECT_EQ(0, L::Partial(0).Offset<0>());
137      EXPECT_EQ(0, L::Partial(0).Offset<1>());
138      EXPECT_EQ(0, L::Partial(1).Offset<0>());
139      EXPECT_EQ(4, L::Partial(1).Offset<1>());
140      EXPECT_EQ(0, L::Partial(5).Offset<0>());
141      EXPECT_EQ(8, L::Partial(5).Offset<1>());
142      EXPECT_EQ(0, L::Partial(0, 0).Offset<0>());
143      EXPECT_EQ(0, L::Partial(0, 0).Offset<1>());
144      EXPECT_EQ(0, L::Partial(0, 0).Offset<2>());
145      EXPECT_EQ(0, L::Partial(1, 0).Offset<0>());
146      EXPECT_EQ(4, L::Partial(1, 0).Offset<1>());
147      EXPECT_EQ(8, L::Partial(1, 0).Offset<2>());
148      EXPECT_EQ(0, L::Partial(5, 3).Offset<0>());
149      EXPECT_EQ(8, L::Partial(5, 3).Offset<1>());
150      EXPECT_EQ(24, L::Partial(5, 3).Offset<2>());
151      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset<0>());
152      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset<1>());
153      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset<2>());
154      EXPECT_EQ(0, L::Partial(1, 0, 0).Offset<0>());
155      EXPECT_EQ(4, L::Partial(1, 0, 0).Offset<1>());
156      EXPECT_EQ(8, L::Partial(1, 0, 0).Offset<2>());
157      EXPECT_EQ(0, L::Partial(5, 3, 1).Offset<0>());
158      EXPECT_EQ(24, L::Partial(5, 3, 1).Offset<2>());
159      EXPECT_EQ(8, L::Partial(5, 3, 1).Offset<1>());
160      EXPECT_EQ(0, L(5, 3, 1).Offset<0>());
161      EXPECT_EQ(24, L(5, 3, 1).Offset<2>());
162      EXPECT_EQ(8, L(5, 3, 1).Offset<1>());
163    }
164  }
165  TEST(Layout, OffsetByType) {
166    {
167      using L = Layout<int32_t>;
168      EXPECT_EQ(0, L::Partial().Offset<int32_t>());
169      EXPECT_EQ(0, L::Partial(3).Offset<int32_t>());
170      EXPECT_EQ(0, L(3).Offset<int32_t>());
171    }
172    {
173      using L = Layout<int8_t, int32_t, Int128>;
174      EXPECT_EQ(0, L::Partial().Offset<int8_t>());
175      EXPECT_EQ(0, L::Partial(0).Offset<int8_t>());
176      EXPECT_EQ(0, L::Partial(0).Offset<int32_t>());
177      EXPECT_EQ(0, L::Partial(1).Offset<int8_t>());
178      EXPECT_EQ(4, L::Partial(1).Offset<int32_t>());
179      EXPECT_EQ(0, L::Partial(5).Offset<int8_t>());
180      EXPECT_EQ(8, L::Partial(5).Offset<int32_t>());
181      EXPECT_EQ(0, L::Partial(0, 0).Offset<int8_t>());
182      EXPECT_EQ(0, L::Partial(0, 0).Offset<int32_t>());
183      EXPECT_EQ(0, L::Partial(0, 0).Offset<Int128>());
184      EXPECT_EQ(0, L::Partial(1, 0).Offset<int8_t>());
185      EXPECT_EQ(4, L::Partial(1, 0).Offset<int32_t>());
186      EXPECT_EQ(8, L::Partial(1, 0).Offset<Int128>());
187      EXPECT_EQ(0, L::Partial(5, 3).Offset<int8_t>());
188      EXPECT_EQ(8, L::Partial(5, 3).Offset<int32_t>());
189      EXPECT_EQ(24, L::Partial(5, 3).Offset<Int128>());
190      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset<int8_t>());
191      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset<int32_t>());
192      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset<Int128>());
193      EXPECT_EQ(0, L::Partial(1, 0, 0).Offset<int8_t>());
194      EXPECT_EQ(4, L::Partial(1, 0, 0).Offset<int32_t>());
195      EXPECT_EQ(8, L::Partial(1, 0, 0).Offset<Int128>());
196      EXPECT_EQ(0, L::Partial(5, 3, 1).Offset<int8_t>());
197      EXPECT_EQ(24, L::Partial(5, 3, 1).Offset<Int128>());
198      EXPECT_EQ(8, L::Partial(5, 3, 1).Offset<int32_t>());
199      EXPECT_EQ(0, L(5, 3, 1).Offset<int8_t>());
200      EXPECT_EQ(24, L(5, 3, 1).Offset<Int128>());
201      EXPECT_EQ(8, L(5, 3, 1).Offset<int32_t>());
202    }
203  }
204  TEST(Layout, Offsets) {
205    {
206      using L = Layout<int32_t>;
207      EXPECT_THAT(L::Partial().Offsets(), ElementsAre(0));
208      EXPECT_THAT(L::Partial(3).Offsets(), ElementsAre(0));
209      EXPECT_THAT(L(3).Offsets(), ElementsAre(0));
210    }
211    {
212      using L = Layout<int32_t, int32_t>;
213      EXPECT_THAT(L::Partial().Offsets(), ElementsAre(0));
214      EXPECT_THAT(L::Partial(3).Offsets(), ElementsAre(0, 12));
215      EXPECT_THAT(L::Partial(3, 5).Offsets(), ElementsAre(0, 12));
216      EXPECT_THAT(L(3, 5).Offsets(), ElementsAre(0, 12));
217    }
218    {
219      using L = Layout<int8_t, int32_t, Int128>;
220      EXPECT_THAT(L::Partial().Offsets(), ElementsAre(0));
221      EXPECT_THAT(L::Partial(1).Offsets(), ElementsAre(0, 4));
222      EXPECT_THAT(L::Partial(5).Offsets(), ElementsAre(0, 8));
223      EXPECT_THAT(L::Partial(0, 0).Offsets(), ElementsAre(0, 0, 0));
224      EXPECT_THAT(L::Partial(1, 0).Offsets(), ElementsAre(0, 4, 8));
225      EXPECT_THAT(L::Partial(5, 3).Offsets(), ElementsAre(0, 8, 24));
226      EXPECT_THAT(L::Partial(0, 0, 0).Offsets(), ElementsAre(0, 0, 0));
227      EXPECT_THAT(L::Partial(1, 0, 0).Offsets(), ElementsAre(0, 4, 8));
228      EXPECT_THAT(L::Partial(5, 3, 1).Offsets(), ElementsAre(0, 8, 24));
229      EXPECT_THAT(L(5, 3, 1).Offsets(), ElementsAre(0, 8, 24));
230    }
231  }
232  TEST(Layout, AllocSize) {
233    {
234      using L = Layout<int32_t>;
235      EXPECT_EQ(0, L::Partial(0).AllocSize());
236      EXPECT_EQ(12, L::Partial(3).AllocSize());
237      EXPECT_EQ(12, L(3).AllocSize());
238    }
239    {
240      using L = Layout<int32_t, int32_t>;
241      EXPECT_EQ(32, L::Partial(3, 5).AllocSize());
242      EXPECT_EQ(32, L(3, 5).AllocSize());
243    }
244    {
245      using L = Layout<int8_t, int32_t, Int128>;
246      EXPECT_EQ(0, L::Partial(0, 0, 0).AllocSize());
247      EXPECT_EQ(8, L::Partial(1, 0, 0).AllocSize());
248      EXPECT_EQ(8, L::Partial(0, 1, 0).AllocSize());
249      EXPECT_EQ(16, L::Partial(0, 0, 1).AllocSize());
250      EXPECT_EQ(24, L::Partial(1, 1, 1).AllocSize());
251      EXPECT_EQ(136, L::Partial(3, 5, 7).AllocSize());
252      EXPECT_EQ(136, L(3, 5, 7).AllocSize());
253    }
254  }
255  TEST(Layout, SizeByIndex) {
256    {
257      using L = Layout<int32_t>;
258      EXPECT_EQ(0, L::Partial(0).Size<0>());
259      EXPECT_EQ(3, L::Partial(3).Size<0>());
260      EXPECT_EQ(3, L(3).Size<0>());
261    }
262    {
263      using L = Layout<int32_t, int32_t>;
264      EXPECT_EQ(0, L::Partial(0).Size<0>());
265      EXPECT_EQ(3, L::Partial(3).Size<0>());
266      EXPECT_EQ(3, L::Partial(3, 5).Size<0>());
267      EXPECT_EQ(5, L::Partial(3, 5).Size<1>());
268      EXPECT_EQ(3, L(3, 5).Size<0>());
269      EXPECT_EQ(5, L(3, 5).Size<1>());
270    }
271    {
272      using L = Layout<int8_t, int32_t, Int128>;
273      EXPECT_EQ(3, L::Partial(3).Size<0>());
274      EXPECT_EQ(3, L::Partial(3, 5).Size<0>());
275      EXPECT_EQ(5, L::Partial(3, 5).Size<1>());
276      EXPECT_EQ(3, L::Partial(3, 5, 7).Size<0>());
277      EXPECT_EQ(5, L::Partial(3, 5, 7).Size<1>());
278      EXPECT_EQ(7, L::Partial(3, 5, 7).Size<2>());
279      EXPECT_EQ(3, L(3, 5, 7).Size<0>());
280      EXPECT_EQ(5, L(3, 5, 7).Size<1>());
281      EXPECT_EQ(7, L(3, 5, 7).Size<2>());
282    }
283  }
284  TEST(Layout, SizeByType) {
285    {
286      using L = Layout<int32_t>;
287      EXPECT_EQ(0, L::Partial(0).Size<int32_t>());
288      EXPECT_EQ(3, L::Partial(3).Size<int32_t>());
289      EXPECT_EQ(3, L(3).Size<int32_t>());
290    }
291    {
292      using L = Layout<int8_t, int32_t, Int128>;
293      EXPECT_EQ(3, L::Partial(3).Size<int8_t>());
294      EXPECT_EQ(3, L::Partial(3, 5).Size<int8_t>());
295      EXPECT_EQ(5, L::Partial(3, 5).Size<int32_t>());
296      EXPECT_EQ(3, L::Partial(3, 5, 7).Size<int8_t>());
297      EXPECT_EQ(5, L::Partial(3, 5, 7).Size<int32_t>());
298      EXPECT_EQ(7, L::Partial(3, 5, 7).Size<Int128>());
299      EXPECT_EQ(3, L(3, 5, 7).Size<int8_t>());
300      EXPECT_EQ(5, L(3, 5, 7).Size<int32_t>());
301      EXPECT_EQ(7, L(3, 5, 7).Size<Int128>());
302    }
303  }
304  TEST(Layout, Sizes) {
305    {
306      using L = Layout<int32_t>;
307      EXPECT_THAT(L::Partial().Sizes(), ElementsAre());
308      EXPECT_THAT(L::Partial(3).Sizes(), ElementsAre(3));
309      EXPECT_THAT(L(3).Sizes(), ElementsAre(3));
310    }
311    {
312      using L = Layout<int32_t, int32_t>;
313      EXPECT_THAT(L::Partial().Sizes(), ElementsAre());
314      EXPECT_THAT(L::Partial(3).Sizes(), ElementsAre(3));
315      EXPECT_THAT(L::Partial(3, 5).Sizes(), ElementsAre(3, 5));
316      EXPECT_THAT(L(3, 5).Sizes(), ElementsAre(3, 5));
317    }
318    {
319      using L = Layout<int8_t, int32_t, Int128>;
320      EXPECT_THAT(L::Partial().Sizes(), ElementsAre());
321      EXPECT_THAT(L::Partial(3).Sizes(), ElementsAre(3));
322      EXPECT_THAT(L::Partial(3, 5).Sizes(), ElementsAre(3, 5));
323      EXPECT_THAT(L::Partial(3, 5, 7).Sizes(), ElementsAre(3, 5, 7));
324      EXPECT_THAT(L(3, 5, 7).Sizes(), ElementsAre(3, 5, 7));
325    }
326  }
327  TEST(Layout, PointerByIndex) {
328    alignas(max_align_t) const unsigned char p[100] = {0};
329    {
330      using L = Layout<int32_t>;
331      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(L::Partial().Pointer<0>(p))));
332      EXPECT_EQ(0,
333                Distance(p, Type<const int32_t*>(L::Partial(3).Pointer<0>(p))));
334      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(L(3).Pointer<0>(p))));
335    }
336    {
337      using L = Layout<int32_t, int32_t>;
338      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(L::Partial().Pointer<0>(p))));
339      EXPECT_EQ(0,
340                Distance(p, Type<const int32_t*>(L::Partial(3).Pointer<0>(p))));
341      EXPECT_EQ(12,
342                Distance(p, Type<const int32_t*>(L::Partial(3).Pointer<1>(p))));
343      EXPECT_EQ(
344          0, Distance(p, Type<const int32_t*>(L::Partial(3, 5).Pointer<0>(p))));
345      EXPECT_EQ(
346          12, Distance(p, Type<const int32_t*>(L::Partial(3, 5).Pointer<1>(p))));
347      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(L(3, 5).Pointer<0>(p))));
348      EXPECT_EQ(12, Distance(p, Type<const int32_t*>(L(3, 5).Pointer<1>(p))));
349    }
350    {
351      using L = Layout<int8_t, int32_t, Int128>;
352      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(L::Partial().Pointer<0>(p))));
353      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(L::Partial(0).Pointer<0>(p))));
354      EXPECT_EQ(0,
355                Distance(p, Type<const int32_t*>(L::Partial(0).Pointer<1>(p))));
356      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(L::Partial(1).Pointer<0>(p))));
357      EXPECT_EQ(4,
358                Distance(p, Type<const int32_t*>(L::Partial(1).Pointer<1>(p))));
359      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(L::Partial(5).Pointer<0>(p))));
360      EXPECT_EQ(8,
361                Distance(p, Type<const int32_t*>(L::Partial(5).Pointer<1>(p))));
362      EXPECT_EQ(0,
363                Distance(p, Type<const int8_t*>(L::Partial(0, 0).Pointer<0>(p))));
364      EXPECT_EQ(
365          0, Distance(p, Type<const int32_t*>(L::Partial(0, 0).Pointer<1>(p))));
366      EXPECT_EQ(0,
367                Distance(p, Type<const Int128*>(L::Partial(0, 0).Pointer<2>(p))));
368      EXPECT_EQ(0,
369                Distance(p, Type<const int8_t*>(L::Partial(1, 0).Pointer<0>(p))));
370      EXPECT_EQ(
371          4, Distance(p, Type<const int32_t*>(L::Partial(1, 0).Pointer<1>(p))));
372      EXPECT_EQ(8,
373                Distance(p, Type<const Int128*>(L::Partial(1, 0).Pointer<2>(p))));
374      EXPECT_EQ(0,
375                Distance(p, Type<const int8_t*>(L::Partial(5, 3).Pointer<0>(p))));
376      EXPECT_EQ(
377          8, Distance(p, Type<const int32_t*>(L::Partial(5, 3).Pointer<1>(p))));
378      EXPECT_EQ(24,
379                Distance(p, Type<const Int128*>(L::Partial(5, 3).Pointer<2>(p))));
380      EXPECT_EQ(
381          0, Distance(p, Type<const int8_t*>(L::Partial(0, 0, 0).Pointer<0>(p))));
382      EXPECT_EQ(
383          0,
384          Distance(p, Type<const int32_t*>(L::Partial(0, 0, 0).Pointer<1>(p))));
385      EXPECT_EQ(
386          0, Distance(p, Type<const Int128*>(L::Partial(0, 0, 0).Pointer<2>(p))));
387      EXPECT_EQ(
388          0, Distance(p, Type<const int8_t*>(L::Partial(1, 0, 0).Pointer<0>(p))));
389      EXPECT_EQ(
390          4,
391          Distance(p, Type<const int32_t*>(L::Partial(1, 0, 0).Pointer<1>(p))));
392      EXPECT_EQ(
393          8, Distance(p, Type<const Int128*>(L::Partial(1, 0, 0).Pointer<2>(p))));
394      EXPECT_EQ(
395          0, Distance(p, Type<const int8_t*>(L::Partial(5, 3, 1).Pointer<0>(p))));
396      EXPECT_EQ(
397          24,
398          Distance(p, Type<const Int128*>(L::Partial(5, 3, 1).Pointer<2>(p))));
399      EXPECT_EQ(
400          8,
401          Distance(p, Type<const int32_t*>(L::Partial(5, 3, 1).Pointer<1>(p))));
402      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(L(5, 3, 1).Pointer<0>(p))));
403      EXPECT_EQ(24, Distance(p, Type<const Int128*>(L(5, 3, 1).Pointer<2>(p))));
404      EXPECT_EQ(8, Distance(p, Type<const int32_t*>(L(5, 3, 1).Pointer<1>(p))));
405    }
406  }
407  TEST(Layout, PointerByType) {
408    alignas(max_align_t) const unsigned char p[100] = {0};
409    {
410      using L = Layout<int32_t>;
411      EXPECT_EQ(
412          0, Distance(p, Type<const int32_t*>(L::Partial().Pointer<int32_t>(p))));
413      EXPECT_EQ(
414          0,
415          Distance(p, Type<const int32_t*>(L::Partial(3).Pointer<int32_t>(p))));
416      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(L(3).Pointer<int32_t>(p))));
417    }
418    {
419      using L = Layout<int8_t, int32_t, Int128>;
420      EXPECT_EQ(
421          0, Distance(p, Type<const int8_t*>(L::Partial().Pointer<int8_t>(p))));
422      EXPECT_EQ(
423          0, Distance(p, Type<const int8_t*>(L::Partial(0).Pointer<int8_t>(p))));
424      EXPECT_EQ(
425          0,
426          Distance(p, Type<const int32_t*>(L::Partial(0).Pointer<int32_t>(p))));
427      EXPECT_EQ(
428          0, Distance(p, Type<const int8_t*>(L::Partial(1).Pointer<int8_t>(p))));
429      EXPECT_EQ(
430          4,
431          Distance(p, Type<const int32_t*>(L::Partial(1).Pointer<int32_t>(p))));
432      EXPECT_EQ(
433          0, Distance(p, Type<const int8_t*>(L::Partial(5).Pointer<int8_t>(p))));
434      EXPECT_EQ(
435          8,
436          Distance(p, Type<const int32_t*>(L::Partial(5).Pointer<int32_t>(p))));
437      EXPECT_EQ(
438          0,
439          Distance(p, Type<const int8_t*>(L::Partial(0, 0).Pointer<int8_t>(p))));
440      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(
441                                   L::Partial(0, 0).Pointer<int32_t>(p))));
442      EXPECT_EQ(
443          0,
444          Distance(p, Type<const Int128*>(L::Partial(0, 0).Pointer<Int128>(p))));
445      EXPECT_EQ(
446          0,
447          Distance(p, Type<const int8_t*>(L::Partial(1, 0).Pointer<int8_t>(p))));
448      EXPECT_EQ(4, Distance(p, Type<const int32_t*>(
449                                   L::Partial(1, 0).Pointer<int32_t>(p))));
450      EXPECT_EQ(
451          8,
452          Distance(p, Type<const Int128*>(L::Partial(1, 0).Pointer<Int128>(p))));
453      EXPECT_EQ(
454          0,
455          Distance(p, Type<const int8_t*>(L::Partial(5, 3).Pointer<int8_t>(p))));
456      EXPECT_EQ(8, Distance(p, Type<const int32_t*>(
457                                   L::Partial(5, 3).Pointer<int32_t>(p))));
458      EXPECT_EQ(
459          24,
460          Distance(p, Type<const Int128*>(L::Partial(5, 3).Pointer<Int128>(p))));
461      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(
462                                   L::Partial(0, 0, 0).Pointer<int8_t>(p))));
463      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(
464                                   L::Partial(0, 0, 0).Pointer<int32_t>(p))));
465      EXPECT_EQ(0, Distance(p, Type<const Int128*>(
466                                   L::Partial(0, 0, 0).Pointer<Int128>(p))));
467      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(
468                                   L::Partial(1, 0, 0).Pointer<int8_t>(p))));
469      EXPECT_EQ(4, Distance(p, Type<const int32_t*>(
470                                   L::Partial(1, 0, 0).Pointer<int32_t>(p))));
471      EXPECT_EQ(8, Distance(p, Type<const Int128*>(
472                                   L::Partial(1, 0, 0).Pointer<Int128>(p))));
473      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(
474                                   L::Partial(5, 3, 1).Pointer<int8_t>(p))));
475      EXPECT_EQ(24, Distance(p, Type<const Int128*>(
476                                    L::Partial(5, 3, 1).Pointer<Int128>(p))));
477      EXPECT_EQ(8, Distance(p, Type<const int32_t*>(
478                                   L::Partial(5, 3, 1).Pointer<int32_t>(p))));
479      EXPECT_EQ(24,
480                Distance(p, Type<const Int128*>(L(5, 3, 1).Pointer<Int128>(p))));
481      EXPECT_EQ(
482          8, Distance(p, Type<const int32_t*>(L(5, 3, 1).Pointer<int32_t>(p))));
483    }
484  }
485  TEST(Layout, MutablePointerByIndex) {
486    alignas(max_align_t) unsigned char p[100] = {0};
487    {
488      using L = Layout<int32_t>;
489      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial().Pointer<0>(p))));
490      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial(3).Pointer<0>(p))));
491      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L(3).Pointer<0>(p))));
492    }
493    {
494      using L = Layout<int32_t, int32_t>;
495      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial().Pointer<0>(p))));
496      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial(3).Pointer<0>(p))));
497      EXPECT_EQ(12, Distance(p, Type<int32_t*>(L::Partial(3).Pointer<1>(p))));
498      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial(3, 5).Pointer<0>(p))));
499      EXPECT_EQ(12, Distance(p, Type<int32_t*>(L::Partial(3, 5).Pointer<1>(p))));
500      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L(3, 5).Pointer<0>(p))));
501      EXPECT_EQ(12, Distance(p, Type<int32_t*>(L(3, 5).Pointer<1>(p))));
502    }
503    {
504      using L = Layout<int8_t, int32_t, Int128>;
505      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial().Pointer<0>(p))));
506      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(0).Pointer<0>(p))));
507      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial(0).Pointer<1>(p))));
508      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(1).Pointer<0>(p))));
509      EXPECT_EQ(4, Distance(p, Type<int32_t*>(L::Partial(1).Pointer<1>(p))));
510      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(5).Pointer<0>(p))));
511      EXPECT_EQ(8, Distance(p, Type<int32_t*>(L::Partial(5).Pointer<1>(p))));
512      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(0, 0).Pointer<0>(p))));
513      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial(0, 0).Pointer<1>(p))));
514      EXPECT_EQ(0, Distance(p, Type<Int128*>(L::Partial(0, 0).Pointer<2>(p))));
515      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(1, 0).Pointer<0>(p))));
516      EXPECT_EQ(4, Distance(p, Type<int32_t*>(L::Partial(1, 0).Pointer<1>(p))));
517      EXPECT_EQ(8, Distance(p, Type<Int128*>(L::Partial(1, 0).Pointer<2>(p))));
518      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(5, 3).Pointer<0>(p))));
519      EXPECT_EQ(8, Distance(p, Type<int32_t*>(L::Partial(5, 3).Pointer<1>(p))));
520      EXPECT_EQ(24, Distance(p, Type<Int128*>(L::Partial(5, 3).Pointer<2>(p))));
521      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(0, 0, 0).Pointer<0>(p))));
522      EXPECT_EQ(0,
523                Distance(p, Type<int32_t*>(L::Partial(0, 0, 0).Pointer<1>(p))));
524      EXPECT_EQ(0, Distance(p, Type<Int128*>(L::Partial(0, 0, 0).Pointer<2>(p))));
525      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(1, 0, 0).Pointer<0>(p))));
526      EXPECT_EQ(4,
527                Distance(p, Type<int32_t*>(L::Partial(1, 0, 0).Pointer<1>(p))));
528      EXPECT_EQ(8, Distance(p, Type<Int128*>(L::Partial(1, 0, 0).Pointer<2>(p))));
529      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(5, 3, 1).Pointer<0>(p))));
530      EXPECT_EQ(24,
531                Distance(p, Type<Int128*>(L::Partial(5, 3, 1).Pointer<2>(p))));
532      EXPECT_EQ(8,
533                Distance(p, Type<int32_t*>(L::Partial(5, 3, 1).Pointer<1>(p))));
534      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L(5, 3, 1).Pointer<0>(p))));
535      EXPECT_EQ(24, Distance(p, Type<Int128*>(L(5, 3, 1).Pointer<2>(p))));
536      EXPECT_EQ(8, Distance(p, Type<int32_t*>(L(5, 3, 1).Pointer<1>(p))));
537    }
538  }
539  TEST(Layout, MutablePointerByType) {
540    alignas(max_align_t) unsigned char p[100] = {0};
541    {
542      using L = Layout<int32_t>;
543      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial().Pointer<int32_t>(p))));
544      EXPECT_EQ(0,
545                Distance(p, Type<int32_t*>(L::Partial(3).Pointer<int32_t>(p))));
546      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L(3).Pointer<int32_t>(p))));
547    }
548    {
549      using L = Layout<int8_t, int32_t, Int128>;
550      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial().Pointer<int8_t>(p))));
551      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(0).Pointer<int8_t>(p))));
552      EXPECT_EQ(0,
553                Distance(p, Type<int32_t*>(L::Partial(0).Pointer<int32_t>(p))));
554      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(1).Pointer<int8_t>(p))));
555      EXPECT_EQ(4,
556                Distance(p, Type<int32_t*>(L::Partial(1).Pointer<int32_t>(p))));
557      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(5).Pointer<int8_t>(p))));
558      EXPECT_EQ(8,
559                Distance(p, Type<int32_t*>(L::Partial(5).Pointer<int32_t>(p))));
560      EXPECT_EQ(0,
561                Distance(p, Type<int8_t*>(L::Partial(0, 0).Pointer<int8_t>(p))));
562      EXPECT_EQ(
563          0, Distance(p, Type<int32_t*>(L::Partial(0, 0).Pointer<int32_t>(p))));
564      EXPECT_EQ(0,
565                Distance(p, Type<Int128*>(L::Partial(0, 0).Pointer<Int128>(p))));
566      EXPECT_EQ(0,
567                Distance(p, Type<int8_t*>(L::Partial(1, 0).Pointer<int8_t>(p))));
568      EXPECT_EQ(
569          4, Distance(p, Type<int32_t*>(L::Partial(1, 0).Pointer<int32_t>(p))));
570      EXPECT_EQ(8,
571                Distance(p, Type<Int128*>(L::Partial(1, 0).Pointer<Int128>(p))));
572      EXPECT_EQ(0,
573                Distance(p, Type<int8_t*>(L::Partial(5, 3).Pointer<int8_t>(p))));
574      EXPECT_EQ(
575          8, Distance(p, Type<int32_t*>(L::Partial(5, 3).Pointer<int32_t>(p))));
576      EXPECT_EQ(24,
577                Distance(p, Type<Int128*>(L::Partial(5, 3).Pointer<Int128>(p))));
578      EXPECT_EQ(
579          0, Distance(p, Type<int8_t*>(L::Partial(0, 0, 0).Pointer<int8_t>(p))));
580      EXPECT_EQ(
581          0,
582          Distance(p, Type<int32_t*>(L::Partial(0, 0, 0).Pointer<int32_t>(p))));
583      EXPECT_EQ(
584          0, Distance(p, Type<Int128*>(L::Partial(0, 0, 0).Pointer<Int128>(p))));
585      EXPECT_EQ(
586          0, Distance(p, Type<int8_t*>(L::Partial(1, 0, 0).Pointer<int8_t>(p))));
587      EXPECT_EQ(
588          4,
589          Distance(p, Type<int32_t*>(L::Partial(1, 0, 0).Pointer<int32_t>(p))));
590      EXPECT_EQ(
591          8, Distance(p, Type<Int128*>(L::Partial(1, 0, 0).Pointer<Int128>(p))));
592      EXPECT_EQ(
593          0, Distance(p, Type<int8_t*>(L::Partial(5, 3, 1).Pointer<int8_t>(p))));
594      EXPECT_EQ(
595          24, Distance(p, Type<Int128*>(L::Partial(5, 3, 1).Pointer<Int128>(p))));
596      EXPECT_EQ(
597          8,
598          Distance(p, Type<int32_t*>(L::Partial(5, 3, 1).Pointer<int32_t>(p))));
599      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L(5, 3, 1).Pointer<int8_t>(p))));
600      EXPECT_EQ(24, Distance(p, Type<Int128*>(L(5, 3, 1).Pointer<Int128>(p))));
601      EXPECT_EQ(8, Distance(p, Type<int32_t*>(L(5, 3, 1).Pointer<int32_t>(p))));
602    }
603  }
604  TEST(Layout, Pointers) {
605    alignas(max_align_t) const unsigned char p[100] = {0};
606    using L = Layout<int8_t, int8_t, Int128>;
607    {
608      const auto x = L::Partial();
609      EXPECT_EQ(std::make_tuple(x.Pointer<0>(p)),
610                Type<std::tuple<const int8_t*>>(x.Pointers(p)));
611    }
612    {
613      const auto x = L::Partial(1);
614      EXPECT_EQ(std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p)),
615                (Type<std::tuple<const int8_t*, const int8_t*>>(x.Pointers(p))));
616    }
617    {
618      const auto x = L::Partial(1, 2);
619      EXPECT_EQ(
620          std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p), x.Pointer<2>(p)),
621          (Type<std::tuple<const int8_t*, const int8_t*, const Int128*>>(
622              x.Pointers(p))));
623    }
624    {
625      const auto x = L::Partial(1, 2, 3);
626      EXPECT_EQ(
627          std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p), x.Pointer<2>(p)),
628          (Type<std::tuple<const int8_t*, const int8_t*, const Int128*>>(
629              x.Pointers(p))));
630    }
631    {
632      const L x(1, 2, 3);
633      EXPECT_EQ(
634          std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p), x.Pointer<2>(p)),
635          (Type<std::tuple<const int8_t*, const int8_t*, const Int128*>>(
636              x.Pointers(p))));
637    }
638  }
639  TEST(Layout, MutablePointers) {
640    alignas(max_align_t) unsigned char p[100] = {0};
641    using L = Layout<int8_t, int8_t, Int128>;
642    {
643      const auto x = L::Partial();
644      EXPECT_EQ(std::make_tuple(x.Pointer<0>(p)),
645                Type<std::tuple<int8_t*>>(x.Pointers(p)));
646    }
647    {
648      const auto x = L::Partial(1);
649      EXPECT_EQ(std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p)),
650                (Type<std::tuple<int8_t*, int8_t*>>(x.Pointers(p))));
651    }
652    {
653      const auto x = L::Partial(1, 2);
654      EXPECT_EQ(
655          std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p), x.Pointer<2>(p)),
656          (Type<std::tuple<int8_t*, int8_t*, Int128*>>(x.Pointers(p))));
657    }
658    {
659      const auto x = L::Partial(1, 2, 3);
660      EXPECT_EQ(
661          std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p), x.Pointer<2>(p)),
662          (Type<std::tuple<int8_t*, int8_t*, Int128*>>(x.Pointers(p))));
663    }
664    {
665      const L x(1, 2, 3);
666      EXPECT_EQ(
667          std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p), x.Pointer<2>(p)),
668          (Type<std::tuple<int8_t*, int8_t*, Int128*>>(x.Pointers(p))));
669    }
670  }
671  TEST(Layout, SliceByIndexSize) {
672    alignas(max_align_t) const unsigned char p[100] = {0};
673    {
674      using L = Layout<int32_t>;
675      EXPECT_EQ(0, L::Partial(0).Slice<0>(p).size());
676      EXPECT_EQ(3, L::Partial(3).Slice<0>(p).size());
677      EXPECT_EQ(3, L(3).Slice<0>(p).size());
678    }
679    {
680      using L = Layout<int32_t, int32_t>;
681      EXPECT_EQ(3, L::Partial(3).Slice<0>(p).size());
682      EXPECT_EQ(5, L::Partial(3, 5).Slice<1>(p).size());
683      EXPECT_EQ(5, L(3, 5).Slice<1>(p).size());
684    }
685    {
686      using L = Layout<int8_t, int32_t, Int128>;
687      EXPECT_EQ(3, L::Partial(3).Slice<0>(p).size());
688      EXPECT_EQ(3, L::Partial(3, 5).Slice<0>(p).size());
689      EXPECT_EQ(5, L::Partial(3, 5).Slice<1>(p).size());
690      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice<0>(p).size());
691      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice<1>(p).size());
692      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice<2>(p).size());
693      EXPECT_EQ(3, L(3, 5, 7).Slice<0>(p).size());
694      EXPECT_EQ(5, L(3, 5, 7).Slice<1>(p).size());
695      EXPECT_EQ(7, L(3, 5, 7).Slice<2>(p).size());
696    }
697  }
698  TEST(Layout, SliceByTypeSize) {
699    alignas(max_align_t) const unsigned char p[100] = {0};
700    {
701      using L = Layout<int32_t>;
702      EXPECT_EQ(0, L::Partial(0).Slice<int32_t>(p).size());
703      EXPECT_EQ(3, L::Partial(3).Slice<int32_t>(p).size());
704      EXPECT_EQ(3, L(3).Slice<int32_t>(p).size());
705    }
706    {
707      using L = Layout<int8_t, int32_t, Int128>;
708      EXPECT_EQ(3, L::Partial(3).Slice<int8_t>(p).size());
709      EXPECT_EQ(3, L::Partial(3, 5).Slice<int8_t>(p).size());
710      EXPECT_EQ(5, L::Partial(3, 5).Slice<int32_t>(p).size());
711      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice<int8_t>(p).size());
712      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice<int32_t>(p).size());
713      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice<Int128>(p).size());
714      EXPECT_EQ(3, L(3, 5, 7).Slice<int8_t>(p).size());
715      EXPECT_EQ(5, L(3, 5, 7).Slice<int32_t>(p).size());
716      EXPECT_EQ(7, L(3, 5, 7).Slice<Int128>(p).size());
717    }
718  }
719  TEST(Layout, MutableSliceByIndexSize) {
720    alignas(max_align_t) unsigned char p[100] = {0};
721    {
722      using L = Layout<int32_t>;
723      EXPECT_EQ(0, L::Partial(0).Slice<0>(p).size());
724      EXPECT_EQ(3, L::Partial(3).Slice<0>(p).size());
725      EXPECT_EQ(3, L(3).Slice<0>(p).size());
726    }
727    {
728      using L = Layout<int32_t, int32_t>;
729      EXPECT_EQ(3, L::Partial(3).Slice<0>(p).size());
730      EXPECT_EQ(5, L::Partial(3, 5).Slice<1>(p).size());
731      EXPECT_EQ(5, L(3, 5).Slice<1>(p).size());
732    }
733    {
734      using L = Layout<int8_t, int32_t, Int128>;
735      EXPECT_EQ(3, L::Partial(3).Slice<0>(p).size());
736      EXPECT_EQ(3, L::Partial(3, 5).Slice<0>(p).size());
737      EXPECT_EQ(5, L::Partial(3, 5).Slice<1>(p).size());
738      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice<0>(p).size());
739      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice<1>(p).size());
740      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice<2>(p).size());
741      EXPECT_EQ(3, L(3, 5, 7).Slice<0>(p).size());
742      EXPECT_EQ(5, L(3, 5, 7).Slice<1>(p).size());
743      EXPECT_EQ(7, L(3, 5, 7).Slice<2>(p).size());
744    }
745  }
746  TEST(Layout, MutableSliceByTypeSize) {
747    alignas(max_align_t) unsigned char p[100] = {0};
748    {
749      using L = Layout<int32_t>;
750      EXPECT_EQ(0, L::Partial(0).Slice<int32_t>(p).size());
751      EXPECT_EQ(3, L::Partial(3).Slice<int32_t>(p).size());
752      EXPECT_EQ(3, L(3).Slice<int32_t>(p).size());
753    }
754    {
755      using L = Layout<int8_t, int32_t, Int128>;
756      EXPECT_EQ(3, L::Partial(3).Slice<int8_t>(p).size());
757      EXPECT_EQ(3, L::Partial(3, 5).Slice<int8_t>(p).size());
758      EXPECT_EQ(5, L::Partial(3, 5).Slice<int32_t>(p).size());
759      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice<int8_t>(p).size());
760      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice<int32_t>(p).size());
761      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice<Int128>(p).size());
762      EXPECT_EQ(3, L(3, 5, 7).Slice<int8_t>(p).size());
763      EXPECT_EQ(5, L(3, 5, 7).Slice<int32_t>(p).size());
764      EXPECT_EQ(7, L(3, 5, 7).Slice<Int128>(p).size());
765    }
766  }
767  TEST(Layout, SliceByIndexData) {
768    alignas(max_align_t) const unsigned char p[100] = {0};
769    {
770      using L = Layout<int32_t>;
771      EXPECT_EQ(
772          0, Distance(
773                 p, Type<Span<const int32_t>>(L::Partial(0).Slice<0>(p)).data()));
774      EXPECT_EQ(
775          0, Distance(
776                 p, Type<Span<const int32_t>>(L::Partial(3).Slice<0>(p)).data()));
777      EXPECT_EQ(0,
778                Distance(p, Type<Span<const int32_t>>(L(3).Slice<0>(p)).data()));
779    }
780    {
781      using L = Layout<int32_t, int32_t>;
782      EXPECT_EQ(
783          0, Distance(
784                 p, Type<Span<const int32_t>>(L::Partial(3).Slice<0>(p)).data()));
785      EXPECT_EQ(
786          0,
787          Distance(
788              p, Type<Span<const int32_t>>(L::Partial(3, 5).Slice<0>(p)).data()));
789      EXPECT_EQ(
790          12,
791          Distance(
792              p, Type<Span<const int32_t>>(L::Partial(3, 5).Slice<1>(p)).data()));
793      EXPECT_EQ(
794          0, Distance(p, Type<Span<const int32_t>>(L(3, 5).Slice<0>(p)).data()));
795      EXPECT_EQ(
796          12, Distance(p, Type<Span<const int32_t>>(L(3, 5).Slice<1>(p)).data()));
797    }
798    {
799      using L = Layout<int8_t, int32_t, Int128>;
800      EXPECT_EQ(
801          0, Distance(
802                 p, Type<Span<const int8_t>>(L::Partial(0).Slice<0>(p)).data()));
803      EXPECT_EQ(
804          0, Distance(
805                 p, Type<Span<const int8_t>>(L::Partial(1).Slice<0>(p)).data()));
806      EXPECT_EQ(
807          0, Distance(
808                 p, Type<Span<const int8_t>>(L::Partial(5).Slice<0>(p)).data()));
809      EXPECT_EQ(
810          0,
811          Distance(
812              p, Type<Span<const int8_t>>(L::Partial(0, 0).Slice<0>(p)).data()));
813      EXPECT_EQ(
814          0,
815          Distance(
816              p, Type<Span<const int32_t>>(L::Partial(0, 0).Slice<1>(p)).data()));
817      EXPECT_EQ(
818          0,
819          Distance(
820              p, Type<Span<const int8_t>>(L::Partial(1, 0).Slice<0>(p)).data()));
821      EXPECT_EQ(
822          4,
823          Distance(
824              p, Type<Span<const int32_t>>(L::Partial(1, 0).Slice<1>(p)).data()));
825      EXPECT_EQ(
826          0,
827          Distance(
828              p, Type<Span<const int8_t>>(L::Partial(5, 3).Slice<0>(p)).data()));
829      EXPECT_EQ(
830          8,
831          Distance(
832              p, Type<Span<const int32_t>>(L::Partial(5, 3).Slice<1>(p)).data()));
833      EXPECT_EQ(
834          0,
835          Distance(
836              p,
837              Type<Span<const int8_t>>(L::Partial(0, 0, 0).Slice<0>(p)).data()));
838      EXPECT_EQ(
839          0,
840          Distance(
841              p,
842              Type<Span<const int32_t>>(L::Partial(0, 0, 0).Slice<1>(p)).data()));
843      EXPECT_EQ(
844          0,
845          Distance(
846              p,
847              Type<Span<const Int128>>(L::Partial(0, 0, 0).Slice<2>(p)).data()));
848      EXPECT_EQ(
849          0,
850          Distance(
851              p,
852              Type<Span<const int8_t>>(L::Partial(1, 0, 0).Slice<0>(p)).data()));
853      EXPECT_EQ(
854          4,
855          Distance(
856              p,
857              Type<Span<const int32_t>>(L::Partial(1, 0, 0).Slice<1>(p)).data()));
858      EXPECT_EQ(
859          8,
860          Distance(
861              p,
862              Type<Span<const Int128>>(L::Partial(1, 0, 0).Slice<2>(p)).data()));
863      EXPECT_EQ(
864          0,
865          Distance(
866              p,
867              Type<Span<const int8_t>>(L::Partial(5, 3, 1).Slice<0>(p)).data()));
868      EXPECT_EQ(
869          24,
870          Distance(
871              p,
872              Type<Span<const Int128>>(L::Partial(5, 3, 1).Slice<2>(p)).data()));
873      EXPECT_EQ(
874          8,
875          Distance(
876              p,
877              Type<Span<const int32_t>>(L::Partial(5, 3, 1).Slice<1>(p)).data()));
878      EXPECT_EQ(
879          0,
880          Distance(p, Type<Span<const int8_t>>(L(5, 3, 1).Slice<0>(p)).data()));
881      EXPECT_EQ(
882          24,
883          Distance(p, Type<Span<const Int128>>(L(5, 3, 1).Slice<2>(p)).data()));
884      EXPECT_EQ(
885          8,
886          Distance(p, Type<Span<const int32_t>>(L(5, 3, 1).Slice<1>(p)).data()));
887    }
888  }
889  TEST(Layout, SliceByTypeData) {
890    alignas(max_align_t) const unsigned char p[100] = {0};
891    {
892      using L = Layout<int32_t>;
893      EXPECT_EQ(
894          0,
895          Distance(
896              p,
897              Type<Span<const int32_t>>(L::Partial(0).Slice<int32_t>(p)).data()));
898      EXPECT_EQ(
899          0,
900          Distance(
901              p,
902              Type<Span<const int32_t>>(L::Partial(3).Slice<int32_t>(p)).data()));
903      EXPECT_EQ(
904          0,
905          Distance(p, Type<Span<const int32_t>>(L(3).Slice<int32_t>(p)).data()));
906    }
907    {
908      using L = Layout<int8_t, int32_t, Int128>;
909      EXPECT_EQ(
910          0,
911          Distance(
912              p,
913              Type<Span<const int8_t>>(L::Partial(0).Slice<int8_t>(p)).data()));
914      EXPECT_EQ(
915          0,
916          Distance(
917              p,
918              Type<Span<const int8_t>>(L::Partial(1).Slice<int8_t>(p)).data()));
919      EXPECT_EQ(
920          0,
921          Distance(
922              p,
923              Type<Span<const int8_t>>(L::Partial(5).Slice<int8_t>(p)).data()));
924      EXPECT_EQ(
925          0,
926          Distance(p, Type<Span<const int8_t>>(L::Partial(0, 0).Slice<int8_t>(p))
927                          .data()));
928      EXPECT_EQ(0, Distance(p, Type<Span<const int32_t>>(
929                                   L::Partial(0, 0).Slice<int32_t>(p))
930                                   .data()));
931      EXPECT_EQ(
932          0,
933          Distance(p, Type<Span<const int8_t>>(L::Partial(1, 0).Slice<int8_t>(p))
934                          .data()));
935      EXPECT_EQ(4, Distance(p, Type<Span<const int32_t>>(
936                                   L::Partial(1, 0).Slice<int32_t>(p))
937                                   .data()));
938      EXPECT_EQ(
939          0,
940          Distance(p, Type<Span<const int8_t>>(L::Partial(5, 3).Slice<int8_t>(p))
941                          .data()));
942      EXPECT_EQ(8, Distance(p, Type<Span<const int32_t>>(
943                                   L::Partial(5, 3).Slice<int32_t>(p))
944                                   .data()));
945      EXPECT_EQ(0, Distance(p, Type<Span<const int8_t>>(
946                                   L::Partial(0, 0, 0).Slice<int8_t>(p))
947                                   .data()));
948      EXPECT_EQ(0, Distance(p, Type<Span<const int32_t>>(
949                                   L::Partial(0, 0, 0).Slice<int32_t>(p))
950                                   .data()));
951      EXPECT_EQ(0, Distance(p, Type<Span<const Int128>>(
952                                   L::Partial(0, 0, 0).Slice<Int128>(p))
953                                   .data()));
954      EXPECT_EQ(0, Distance(p, Type<Span<const int8_t>>(
955                                   L::Partial(1, 0, 0).Slice<int8_t>(p))
956                                   .data()));
957      EXPECT_EQ(4, Distance(p, Type<Span<const int32_t>>(
958                                   L::Partial(1, 0, 0).Slice<int32_t>(p))
959                                   .data()));
960      EXPECT_EQ(8, Distance(p, Type<Span<const Int128>>(
961                                   L::Partial(1, 0, 0).Slice<Int128>(p))
962                                   .data()));
963      EXPECT_EQ(0, Distance(p, Type<Span<const int8_t>>(
964                                   L::Partial(5, 3, 1).Slice<int8_t>(p))
965                                   .data()));
966      EXPECT_EQ(24, Distance(p, Type<Span<const Int128>>(
967                                    L::Partial(5, 3, 1).Slice<Int128>(p))
968                                    .data()));
969      EXPECT_EQ(8, Distance(p, Type<Span<const int32_t>>(
970                                   L::Partial(5, 3, 1).Slice<int32_t>(p))
971                                   .data()));
972      EXPECT_EQ(
973          0,
974          Distance(p,
975                   Type<Span<const int8_t>>(L(5, 3, 1).Slice<int8_t>(p)).data()));
976      EXPECT_EQ(
977          24,
978          Distance(p,
979                   Type<Span<const Int128>>(L(5, 3, 1).Slice<Int128>(p)).data()));
980      EXPECT_EQ(
981          8,
982          Distance(
983              p, Type<Span<const int32_t>>(L(5, 3, 1).Slice<int32_t>(p)).data()));
984    }
985  }
986  TEST(Layout, MutableSliceByIndexData) {
987    alignas(max_align_t) unsigned char p[100] = {0};
988    {
989      using L = Layout<int32_t>;
990      EXPECT_EQ(
991          0, Distance(p, Type<Span<int32_t>>(L::Partial(0).Slice<0>(p)).data()));
992      EXPECT_EQ(
993          0, Distance(p, Type<Span<int32_t>>(L::Partial(3).Slice<0>(p)).data()));
994      EXPECT_EQ(0, Distance(p, Type<Span<int32_t>>(L(3).Slice<0>(p)).data()));
995    }
996    {
997      using L = Layout<int32_t, int32_t>;
998      EXPECT_EQ(
999          0, Distance(p, Type<Span<int32_t>>(L::Partial(3).Slice<0>(p)).data()));
1000      EXPECT_EQ(
1001          0,
1002          Distance(p, Type<Span<int32_t>>(L::Partial(3, 5).Slice<0>(p)).data()));
1003      EXPECT_EQ(
1004          12,
1005          Distance(p, Type<Span<int32_t>>(L::Partial(3, 5).Slice<1>(p)).data()));
1006      EXPECT_EQ(0, Distance(p, Type<Span<int32_t>>(L(3, 5).Slice<0>(p)).data()));
1007      EXPECT_EQ(12, Distance(p, Type<Span<int32_t>>(L(3, 5).Slice<1>(p)).data()));
1008    }
1009    {
1010      using L = Layout<int8_t, int32_t, Int128>;
1011      EXPECT_EQ(
1012          0, Distance(p, Type<Span<int8_t>>(L::Partial(0).Slice<0>(p)).data()));
1013      EXPECT_EQ(
1014          0, Distance(p, Type<Span<int8_t>>(L::Partial(1).Slice<0>(p)).data()));
1015      EXPECT_EQ(
1016          0, Distance(p, Type<Span<int8_t>>(L::Partial(5).Slice<0>(p)).data()));
1017      EXPECT_EQ(
1018          0,
1019          Distance(p, Type<Span<int8_t>>(L::Partial(0, 0).Slice<0>(p)).data()));
1020      EXPECT_EQ(
1021          0,
1022          Distance(p, Type<Span<int32_t>>(L::Partial(0, 0).Slice<1>(p)).data()));
1023      EXPECT_EQ(
1024          0,
1025          Distance(p, Type<Span<int8_t>>(L::Partial(1, 0).Slice<0>(p)).data()));
1026      EXPECT_EQ(
1027          4,
1028          Distance(p, Type<Span<int32_t>>(L::Partial(1, 0).Slice<1>(p)).data()));
1029      EXPECT_EQ(
1030          0,
1031          Distance(p, Type<Span<int8_t>>(L::Partial(5, 3).Slice<0>(p)).data()));
1032      EXPECT_EQ(
1033          8,
1034          Distance(p, Type<Span<int32_t>>(L::Partial(5, 3).Slice<1>(p)).data()));
1035      EXPECT_EQ(
1036          0, Distance(
1037                 p, Type<Span<int8_t>>(L::Partial(0, 0, 0).Slice<0>(p)).data()));
1038      EXPECT_EQ(
1039          0, Distance(
1040                 p, Type<Span<int32_t>>(L::Partial(0, 0, 0).Slice<1>(p)).data()));
1041      EXPECT_EQ(
1042          0, Distance(
1043                 p, Type<Span<Int128>>(L::Partial(0, 0, 0).Slice<2>(p)).data()));
1044      EXPECT_EQ(
1045          0, Distance(
1046                 p, Type<Span<int8_t>>(L::Partial(1, 0, 0).Slice<0>(p)).data()));
1047      EXPECT_EQ(
1048          4, Distance(
1049                 p, Type<Span<int32_t>>(L::Partial(1, 0, 0).Slice<1>(p)).data()));
1050      EXPECT_EQ(
1051          8, Distance(
1052                 p, Type<Span<Int128>>(L::Partial(1, 0, 0).Slice<2>(p)).data()));
1053      EXPECT_EQ(
1054          0, Distance(
1055                 p, Type<Span<int8_t>>(L::Partial(5, 3, 1).Slice<0>(p)).data()));
1056      EXPECT_EQ(
1057          24, Distance(
1058                  p, Type<Span<Int128>>(L::Partial(5, 3, 1).Slice<2>(p)).data()));
1059      EXPECT_EQ(
1060          8, Distance(
1061                 p, Type<Span<int32_t>>(L::Partial(5, 3, 1).Slice<1>(p)).data()));
1062      EXPECT_EQ(0,
1063                Distance(p, Type<Span<int8_t>>(L(5, 3, 1).Slice<0>(p)).data()));
1064      EXPECT_EQ(24,
1065                Distance(p, Type<Span<Int128>>(L(5, 3, 1).Slice<2>(p)).data()));
1066      EXPECT_EQ(8,
1067                Distance(p, Type<Span<int32_t>>(L(5, 3, 1).Slice<1>(p)).data()));
1068    }
1069  }
1070  TEST(Layout, MutableSliceByTypeData) {
1071    alignas(max_align_t) unsigned char p[100] = {0};
1072    {
1073      using L = Layout<int32_t>;
1074      EXPECT_EQ(
1075          0, Distance(
1076                 p, Type<Span<int32_t>>(L::Partial(0).Slice<int32_t>(p)).data()));
1077      EXPECT_EQ(
1078          0, Distance(
1079                 p, Type<Span<int32_t>>(L::Partial(3).Slice<int32_t>(p)).data()));
1080      EXPECT_EQ(0,
1081                Distance(p, Type<Span<int32_t>>(L(3).Slice<int32_t>(p)).data()));
1082    }
1083    {
1084      using L = Layout<int8_t, int32_t, Int128>;
1085      EXPECT_EQ(
1086          0,
1087          Distance(p, Type<Span<int8_t>>(L::Partial(0).Slice<int8_t>(p)).data()));
1088      EXPECT_EQ(
1089          0,
1090          Distance(p, Type<Span<int8_t>>(L::Partial(1).Slice<int8_t>(p)).data()));
1091      EXPECT_EQ(
1092          0,
1093          Distance(p, Type<Span<int8_t>>(L::Partial(5).Slice<int8_t>(p)).data()));
1094      EXPECT_EQ(
1095          0,
1096          Distance(p,
1097                   Type<Span<int8_t>>(L::Partial(0, 0).Slice<int8_t>(p)).data()));
1098      EXPECT_EQ(
1099          0,
1100          Distance(
1101              p, Type<Span<int32_t>>(L::Partial(0, 0).Slice<int32_t>(p)).data()));
1102      EXPECT_EQ(
1103          0,
1104          Distance(p,
1105                   Type<Span<int8_t>>(L::Partial(1, 0).Slice<int8_t>(p)).data()));
1106      EXPECT_EQ(
1107          4,
1108          Distance(
1109              p, Type<Span<int32_t>>(L::Partial(1, 0).Slice<int32_t>(p)).data()));
1110      EXPECT_EQ(
1111          0,
1112          Distance(p,
1113                   Type<Span<int8_t>>(L::Partial(5, 3).Slice<int8_t>(p)).data()));
1114      EXPECT_EQ(
1115          8,
1116          Distance(
1117              p, Type<Span<int32_t>>(L::Partial(5, 3).Slice<int32_t>(p)).data()));
1118      EXPECT_EQ(
1119          0,
1120          Distance(
1121              p,
1122              Type<Span<int8_t>>(L::Partial(0, 0, 0).Slice<int8_t>(p)).data()));
1123      EXPECT_EQ(
1124          0,
1125          Distance(
1126              p,
1127              Type<Span<int32_t>>(L::Partial(0, 0, 0).Slice<int32_t>(p)).data()));
1128      EXPECT_EQ(
1129          0,
1130          Distance(
1131              p,
1132              Type<Span<Int128>>(L::Partial(0, 0, 0).Slice<Int128>(p)).data()));
1133      EXPECT_EQ(
1134          0,
1135          Distance(
1136              p,
1137              Type<Span<int8_t>>(L::Partial(1, 0, 0).Slice<int8_t>(p)).data()));
1138      EXPECT_EQ(
1139          4,
1140          Distance(
1141              p,
1142              Type<Span<int32_t>>(L::Partial(1, 0, 0).Slice<int32_t>(p)).data()));
1143      EXPECT_EQ(
1144          8,
1145          Distance(
1146              p,
1147              Type<Span<Int128>>(L::Partial(1, 0, 0).Slice<Int128>(p)).data()));
1148      EXPECT_EQ(
1149          0,
1150          Distance(
1151              p,
1152              Type<Span<int8_t>>(L::Partial(5, 3, 1).Slice<int8_t>(p)).data()));
1153      EXPECT_EQ(
1154          24,
1155          Distance(
1156              p,
1157              Type<Span<Int128>>(L::Partial(5, 3, 1).Slice<Int128>(p)).data()));
1158      EXPECT_EQ(
1159          8,
1160          Distance(
1161              p,
1162              Type<Span<int32_t>>(L::Partial(5, 3, 1).Slice<int32_t>(p)).data()));
1163      EXPECT_EQ(
1164          0, Distance(p, Type<Span<int8_t>>(L(5, 3, 1).Slice<int8_t>(p)).data()));
1165      EXPECT_EQ(
1166          24,
1167          Distance(p, Type<Span<Int128>>(L(5, 3, 1).Slice<Int128>(p)).data()));
1168      EXPECT_EQ(
1169          8,
1170          Distance(p, Type<Span<int32_t>>(L(5, 3, 1).Slice<int32_t>(p)).data()));
1171    }
1172  }
1173  MATCHER_P(IsSameSlice, slice, "") {
1174    return arg.size() == slice.size() && arg.data() == slice.data();
1175  }
1176  template <typename... M>
1177  class TupleMatcher {
1178   public:
1179    explicit TupleMatcher(M... matchers) : matchers_(std::move(matchers)...) {}
1180    template <typename Tuple>
1181    bool MatchAndExplain(const Tuple& p,
1182                         testing::MatchResultListener* &bsol;* listener */) const {
1183      static_assert(std::tuple_size<Tuple>::value == sizeof...(M), "");
1184      return MatchAndExplainImpl(
1185          p, absl::make_index_sequence<std::tuple_size<Tuple>::value>{});
1186    }
1187    void DescribeTo(::std::ostream* os) const {}
1188    void DescribeNegationTo(::std::ostream* os) const {}
1189   private:
1190    template <typename Tuple, size_t... Is>
1191    bool MatchAndExplainImpl(const Tuple& p, absl::index_sequence<Is...>) const {
1192      return std::min(
1193          {true, testing::SafeMatcherCast<
1194                     const typename std::tuple_element<Is, Tuple>::type&>(
1195                     std::get<Is>(matchers_))
1196                     .Matches(std::get<Is>(p))...});
1197    }
1198    std::tuple<M...> matchers_;
1199  };
1200  template <typename... M>
1201  testing::PolymorphicMatcher<TupleMatcher<M...>> Tuple(M... matchers) {
1202    return testing::MakePolymorphicMatcher(
1203        TupleMatcher<M...>(std::move(matchers)...));
1204  }
1205  TEST(Layout, Slices) {
1206    alignas(max_align_t) const unsigned char p[100] = {0};
1207    using L = Layout<int8_t, int8_t, Int128>;
1208    {
1209      const auto x = L::Partial();
1210      EXPECT_THAT(Type<std::tuple<>>(x.Slices(p)), Tuple());
1211    }
1212    {
1213      const auto x = L::Partial(1);
1214      EXPECT_THAT(Type<std::tuple<Span<const int8_t>>>(x.Slices(p)),
1215                  Tuple(IsSameSlice(x.Slice<0>(p))));
1216    }
1217    {
1218      const auto x = L::Partial(1, 2);
1219      EXPECT_THAT(
1220          (Type<std::tuple<Span<const int8_t>, Span<const int8_t>>>(x.Slices(p))),
1221          Tuple(IsSameSlice(x.Slice<0>(p)), IsSameSlice(x.Slice<1>(p))));
1222    }
1223    {
1224      const auto x = L::Partial(1, 2, 3);
1225      EXPECT_THAT((Type<std::tuple<Span<const int8_t>, Span<const int8_t>,
1226                                   Span<const Int128>>>(x.Slices(p))),
1227                  Tuple(IsSameSlice(x.Slice<0>(p)), IsSameSlice(x.Slice<1>(p)),
1228                        IsSameSlice(x.Slice<2>(p))));
1229    }
1230    {
1231      const L x(1, 2, 3);
1232      EXPECT_THAT((Type<std::tuple<Span<const int8_t>, Span<const int8_t>,
1233                                   Span<const Int128>>>(x.Slices(p))),
1234                  Tuple(IsSameSlice(x.Slice<0>(p)), IsSameSlice(x.Slice<1>(p)),
1235                        IsSameSlice(x.Slice<2>(p))));
1236    }
1237  }
1238  TEST(Layout, MutableSlices) {
1239    alignas(max_align_t) unsigned char p[100] = {0};
1240    using L = Layout<int8_t, int8_t, Int128>;
1241    {
1242      const auto x = L::Partial();
1243      EXPECT_THAT(Type<std::tuple<>>(x.Slices(p)), Tuple());
1244    }
1245    {
1246      const auto x = L::Partial(1);
1247      EXPECT_THAT(Type<std::tuple<Span<int8_t>>>(x.Slices(p)),
1248                  Tuple(IsSameSlice(x.Slice<0>(p))));
1249    }
1250    {
1251      const auto x = L::Partial(1, 2);
1252      EXPECT_THAT((Type<std::tuple<Span<int8_t>, Span<int8_t>>>(x.Slices(p))),
1253                  Tuple(IsSameSlice(x.Slice<0>(p)), IsSameSlice(x.Slice<1>(p))));
1254    }
1255    {
1256      const auto x = L::Partial(1, 2, 3);
1257      EXPECT_THAT((Type<std::tuple<Span<int8_t>, Span<int8_t>, Span<Int128>>>(
1258                      x.Slices(p))),
1259                  Tuple(IsSameSlice(x.Slice<0>(p)), IsSameSlice(x.Slice<1>(p)),
1260                        IsSameSlice(x.Slice<2>(p))));
1261    }
1262    {
1263      const L x(1, 2, 3);
1264      EXPECT_THAT((Type<std::tuple<Span<int8_t>, Span<int8_t>, Span<Int128>>>(
1265                      x.Slices(p))),
1266                  Tuple(IsSameSlice(x.Slice<0>(p)), IsSameSlice(x.Slice<1>(p)),
1267                        IsSameSlice(x.Slice<2>(p))));
1268    }
1269  }
1270  TEST(Layout, UnalignedTypes) {
1271    constexpr Layout<unsigned char, unsigned char, unsigned char> x(1, 2, 3);
1272    alignas(max_align_t) unsigned char p[x.AllocSize() + 1];
1273    EXPECT_THAT(x.Pointers(p + 1), Tuple(p + 1, p + 2, p + 4));
1274  }
1275  TEST(Layout, CustomAlignment) {
1276    constexpr Layout<unsigned char, Aligned<unsigned char, 8>> x(1, 2);
1277    alignas(max_align_t) unsigned char p[x.AllocSize()];
1278    EXPECT_EQ(10, x.AllocSize());
1279    EXPECT_THAT(x.Pointers(p), Tuple(p + 0, p + 8));
1280  }
1281  TEST(Layout, OverAligned) {
1282    constexpr size_t M = alignof(max_align_t);
1283    constexpr Layout<unsigned char, Aligned<unsigned char, 2 * M>> x(1, 3);
1284  #ifdef __GNUC__
1285    __attribute__((aligned(2 * M))) unsigned char p[x.AllocSize()];
1286  #else
1287    alignas(2 * M) unsigned char p[x.AllocSize()];
1288  #endif
1289    EXPECT_EQ(2 * M + 3, x.AllocSize());
1290    EXPECT_THAT(x.Pointers(p), Tuple(p + 0, p + 2 * M));
1291  }
1292  TEST(Layout, Alignment) {
1293    static_assert(Layout<int8_t>::Alignment() == 1, "");
1294    static_assert(Layout<int32_t>::Alignment() == 4, "");
1295    static_assert(Layout<Int64>::Alignment() == 8, "");
1296    static_assert(Layout<Aligned<int8_t, 64>>::Alignment() == 64, "");
1297    static_assert(Layout<int8_t, int32_t, Int64>::Alignment() == 8, "");
1298    static_assert(Layout<int8_t, Int64, int32_t>::Alignment() == 8, "");
1299    static_assert(Layout<int32_t, int8_t, Int64>::Alignment() == 8, "");
1300    static_assert(Layout<int32_t, Int64, int8_t>::Alignment() == 8, "");
1301    static_assert(Layout<Int64, int8_t, int32_t>::Alignment() == 8, "");
1302    static_assert(Layout<Int64, int32_t, int8_t>::Alignment() == 8, "");
1303  }
1304  TEST(Layout, ConstexprPartial) {
1305    constexpr size_t M = alignof(max_align_t);
1306    constexpr Layout<unsigned char, Aligned<unsigned char, 2 * M>> x(1, 3);
1307    static_assert(x.Partial(1).template Offset<1>() == 2 * M, "");
1308  }
1309  struct Region {
1310    size_t from;
1311    size_t to;
1312  };
1313  void ExpectRegionPoisoned(const unsigned char* p, size_t n, bool poisoned) {
1314  #ifdef ABSL_HAVE_ADDRESS_SANITIZER
1315    for (size_t i = 0; i != n; ++i) {
1316      EXPECT_EQ(poisoned, __asan_address_is_poisoned(p + i));
1317    }
1318  #endif
1319  }
1320  template <size_t N>
1321  void ExpectPoisoned(const unsigned char (&buf)[N],
1322                      std::initializer_list<Region> reg) {
1323    size_t prev = 0;
1324    for (const Region& r : reg) {
1325      ExpectRegionPoisoned(buf + prev, r.from - prev, false);
1326      ExpectRegionPoisoned(buf + r.from, r.to - r.from, true);
1327      prev = r.to;
1328    }
1329    ExpectRegionPoisoned(buf + prev, N - prev, false);
1330  }
1331  TEST(Layout, PoisonPadding) {
1332    using L = Layout<int8_t, Int64, int32_t, Int128>;
1333    constexpr size_t n = L::Partial(1, 2, 3, 4).AllocSize();
1334    {
1335      constexpr auto x = L::Partial();
1336      alignas(max_align_t) const unsigned char c[n] = {};
1337      x.PoisonPadding(c);
1338      EXPECT_EQ(x.Slices(c), x.Slices(c));
1339      ExpectPoisoned(c, {});
1340    }
1341    {
1342      constexpr auto x = L::Partial(1);
1343      alignas(max_align_t) const unsigned char c[n] = {};
1344      x.PoisonPadding(c);
1345      EXPECT_EQ(x.Slices(c), x.Slices(c));
1346      ExpectPoisoned(c, {{1, 8}});
1347    }
1348    {
1349      constexpr auto x = L::Partial(1, 2);
1350      alignas(max_align_t) const unsigned char c[n] = {};
1351      x.PoisonPadding(c);
1352      EXPECT_EQ(x.Slices(c), x.Slices(c));
1353      ExpectPoisoned(c, {{1, 8}});
1354    }
1355    {
1356      constexpr auto x = L::Partial(1, 2, 3);
1357      alignas(max_align_t) const unsigned char c[n] = {};
1358      x.PoisonPadding(c);
1359      EXPECT_EQ(x.Slices(c), x.Slices(c));
1360      ExpectPoisoned(c, {{1, 8}, {36, 40}});
1361    }
1362    {
1363      constexpr auto x = L::Partial(1, 2, 3, 4);
1364      alignas(max_align_t) const unsigned char c[n] = {};
1365      x.PoisonPadding(c);
1366      EXPECT_EQ(x.Slices(c), x.Slices(c));
1367      ExpectPoisoned(c, {{1, 8}, {36, 40}});
1368    }
1369    {
1370      constexpr L x(1, 2, 3, 4);
1371      alignas(max_align_t) const unsigned char c[n] = {};
1372      x.PoisonPadding(c);
1373      EXPECT_EQ(x.Slices(c), x.Slices(c));
1374      ExpectPoisoned(c, {{1, 8}, {36, 40}});
1375    }
1376  }
1377  TEST(Layout, DebugString) {
1378    {
1379      constexpr auto x = Layout<int8_t, int32_t, int8_t, Int128>::Partial();
1380      EXPECT_EQ("@0<signed char>(1)", x.DebugString());
1381    }
1382    {
1383      constexpr auto x = Layout<int8_t, int32_t, int8_t, Int128>::Partial(1);
1384      EXPECT_EQ("@0<signed char>(1)[1]; @4<int>(4)", x.DebugString());
1385    }
1386    {
1387      constexpr auto x = Layout<int8_t, int32_t, int8_t, Int128>::Partial(1, 2);
1388      EXPECT_EQ("@0<signed char>(1)[1]; @4<int>(4)[2]; @12<signed char>(1)",
1389                x.DebugString());
1390    }
1391    {
1392      constexpr auto x =
1393          Layout<int8_t, int32_t, int8_t, Int128>::Partial(1, 2, 3);
1394      EXPECT_EQ(
1395          "@0<signed char>(1)[1]; @4<int>(4)[2]; @12<signed char>(1)[3]; "
1396          "@16" +
1397              Int128::Name() + "(16)",
1398          x.DebugString());
1399    }
1400    {
1401      constexpr auto x =
1402          Layout<int8_t, int32_t, int8_t, Int128>::Partial(1, 2, 3, 4);
1403      EXPECT_EQ(
1404          "@0<signed char>(1)[1]; @4<int>(4)[2]; @12<signed char>(1)[3]; "
1405          "@16" +
1406              Int128::Name() + "(16)[4]",
1407          x.DebugString());
1408    }
1409    {
1410      constexpr Layout<int8_t, int32_t, int8_t, Int128> x(1, 2, 3, 4);
1411      EXPECT_EQ(
1412          "@0<signed char>(1)[1]; @4<int>(4)[2]; @12<signed char>(1)[3]; "
1413          "@16" +
1414              Int128::Name() + "(16)[4]",
1415          x.DebugString());
1416    }
1417  }
1418  TEST(Layout, CharTypes) {
1419    constexpr Layout<int32_t> x(1);
1420    alignas(max_align_t) char c[x.AllocSize()] = {};
1421    alignas(max_align_t) unsigned char uc[x.AllocSize()] = {};
1422    alignas(max_align_t) signed char sc[x.AllocSize()] = {};
1423    alignas(max_align_t) const char cc[x.AllocSize()] = {};
1424    alignas(max_align_t) const unsigned char cuc[x.AllocSize()] = {};
1425    alignas(max_align_t) const signed char csc[x.AllocSize()] = {};
1426    Type<int32_t*>(x.Pointer<0>(c));
1427    Type<int32_t*>(x.Pointer<0>(uc));
1428    Type<int32_t*>(x.Pointer<0>(sc));
1429    Type<const int32_t*>(x.Pointer<0>(cc));
1430    Type<const int32_t*>(x.Pointer<0>(cuc));
1431    Type<const int32_t*>(x.Pointer<0>(csc));
1432    Type<int32_t*>(x.Pointer<int32_t>(c));
1433    Type<int32_t*>(x.Pointer<int32_t>(uc));
1434    Type<int32_t*>(x.Pointer<int32_t>(sc));
1435    Type<const int32_t*>(x.Pointer<int32_t>(cc));
1436    Type<const int32_t*>(x.Pointer<int32_t>(cuc));
1437    Type<const int32_t*>(x.Pointer<int32_t>(csc));
1438    Type<std::tuple<int32_t*>>(x.Pointers(c));
1439    Type<std::tuple<int32_t*>>(x.Pointers(uc));
1440    Type<std::tuple<int32_t*>>(x.Pointers(sc));
1441    Type<std::tuple<const int32_t*>>(x.Pointers(cc));
1442    Type<std::tuple<const int32_t*>>(x.Pointers(cuc));
1443    Type<std::tuple<const int32_t*>>(x.Pointers(csc));
1444    Type<Span<int32_t>>(x.Slice<0>(c));
1445    Type<Span<int32_t>>(x.Slice<0>(uc));
1446    Type<Span<int32_t>>(x.Slice<0>(sc));
1447    Type<Span<const int32_t>>(x.Slice<0>(cc));
1448    Type<Span<const int32_t>>(x.Slice<0>(cuc));
1449    Type<Span<const int32_t>>(x.Slice<0>(csc));
1450    Type<std::tuple<Span<int32_t>>>(x.Slices(c));
1451    Type<std::tuple<Span<int32_t>>>(x.Slices(uc));
<span onclick='openModal()' class='match'>1452    Type<std::tuple<Span<int32_t>>>(x.Slices(sc));
1453    Type<std::tuple<Span<const int32_t>>>(x.Slices(cc));
</span>1454    Type<std::tuple<Span<const int32_t>>>(x.Slices(cuc));
1455    Type<std::tuple<Span<const int32_t>>>(x.Slices(csc));
1456  }
1457  TEST(Layout, ConstElementType) {
1458    constexpr Layout<const int32_t> x(1);
1459    alignas(int32_t) char c[x.AllocSize()] = {};
1460    const char* cc = c;
1461    const int32_t* p = reinterpret_cast<const int32_t*>(cc);
1462    EXPECT_EQ(alignof(int32_t), x.Alignment());
1463    EXPECT_EQ(0, x.Offset<0>());
1464    EXPECT_EQ(0, x.Offset<const int32_t>());
1465    EXPECT_THAT(x.Offsets(), ElementsAre(0));
1466    EXPECT_EQ(1, x.Size<0>());
1467    EXPECT_EQ(1, x.Size<const int32_t>());
1468    EXPECT_THAT(x.Sizes(), ElementsAre(1));
1469    EXPECT_EQ(sizeof(int32_t), x.AllocSize());
1470    EXPECT_EQ(p, Type<const int32_t*>(x.Pointer<0>(c)));
1471    EXPECT_EQ(p, Type<const int32_t*>(x.Pointer<0>(cc)));
1472    EXPECT_EQ(p, Type<const int32_t*>(x.Pointer<const int32_t>(c)));
1473    EXPECT_EQ(p, Type<const int32_t*>(x.Pointer<const int32_t>(cc)));
1474    EXPECT_THAT(Type<std::tuple<const int32_t*>>(x.Pointers(c)), Tuple(p));
1475    EXPECT_THAT(Type<std::tuple<const int32_t*>>(x.Pointers(cc)), Tuple(p));
1476    EXPECT_THAT(Type<Span<const int32_t>>(x.Slice<0>(c)),
1477                IsSameSlice(Span<const int32_t>(p, 1)));
1478    EXPECT_THAT(Type<Span<const int32_t>>(x.Slice<0>(cc)),
1479                IsSameSlice(Span<const int32_t>(p, 1)));
1480    EXPECT_THAT(Type<Span<const int32_t>>(x.Slice<const int32_t>(c)),
1481                IsSameSlice(Span<const int32_t>(p, 1)));
1482    EXPECT_THAT(Type<Span<const int32_t>>(x.Slice<const int32_t>(cc)),
1483                IsSameSlice(Span<const int32_t>(p, 1)));
1484    EXPECT_THAT(Type<std::tuple<Span<const int32_t>>>(x.Slices(c)),
1485                Tuple(IsSameSlice(Span<const int32_t>(p, 1))));
1486    EXPECT_THAT(Type<std::tuple<Span<const int32_t>>>(x.Slices(cc)),
1487                Tuple(IsSameSlice(Span<const int32_t>(p, 1))));
1488  }
1489  namespace example {
1490  class CompactString {
1491   public:
1492    CompactString(const char* s = "") {  
1493      const size_t size = strlen(s);
1494      const L layout(1, size + 1);
1495      p_.reset(new unsigned char[layout.AllocSize()]);
1496      layout.PoisonPadding(p_.get());
1497      *layout.Pointer<size_t>(p_.get()) = size;
1498      memcpy(layout.Pointer<char>(p_.get()), s, size + 1);
1499    }
1500    size_t size() const {
1501      return *L::Partial().Pointer<size_t>(p_.get());
1502    }
1503    const char* c_str() const {
1504      return L::Partial(1).Pointer<char>(p_.get());
1505    }
1506   private:
1507    using L = Layout<size_t, char>;
1508    std::unique_ptr<unsigned char[]> p_;
1509  };
1510  TEST(CompactString, Works) {
1511    CompactString s = "hello";
1512    EXPECT_EQ(5, s.size());
1513    EXPECT_STREQ("hello", s.c_str());
1514  }
1515  }  
1516  }  
1517  }  
1518  ABSL_NAMESPACE_END
1519  }  
</code></pre>
        </div>
        <div class="column">
            <h3>abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-layout_test.cc</h3>
            <pre><code>1  #include "absl/container/internal/layout.h"
2  #include <stddef.h>
3  #include <cstdint>
4  #include <memory>
5  #include <sstream>
6  #include <type_traits>
7  #include "gmock/gmock.h"
8  #include "gtest/gtest.h"
9  #include "absl/base/config.h"
10  #include "absl/log/check.h"
11  #include "absl/types/span.h"
12  namespace absl {
13  ABSL_NAMESPACE_BEGIN
14  namespace container_internal {
15  namespace {
16  using ::absl::Span;
17  using ::testing::ElementsAre;
18  size_t Distance(const void* from, const void* to) {
19    CHECK_LE(from, to) << "Distance must be non-negative";
20    return static_cast<const char*>(to) - static_cast<const char*>(from);
21  }
22  template <class Expected, class Actual>
23  Expected Type(Actual val) {
24    static_assert(std::is_same<Expected, Actual>(), "");
25    return val;
26  }
27  struct alignas(8) Int128 {
28    uint64_t a, b;
29    friend bool operator==(Int128 lhs, Int128 rhs) {
30      return std::tie(lhs.a, lhs.b) == std::tie(rhs.a, rhs.b);
31    }
32    static std::string Name() {
33      return internal_layout::adl_barrier::TypeName<Int128>();
34    }
35  };
36  struct alignas(8) Int64 {
37    int64_t a;
38    friend bool operator==(Int64 lhs, Int64 rhs) {
39      return lhs.a == rhs.a;
40    }
41  };
42  static_assert(sizeof(int8_t) == 1, "");
43  static_assert(alignof(int8_t) == 1, "");
44  static_assert(sizeof(int16_t) == 2, "");
45  static_assert(alignof(int16_t) == 2, "");
46  static_assert(sizeof(int32_t) == 4, "");
47  static_assert(alignof(int32_t) == 4, "");
48  static_assert(sizeof(Int64) == 8, "");
49  static_assert(alignof(Int64) == 8, "");
50  static_assert(sizeof(Int128) == 16, "");
51  static_assert(alignof(Int128) == 8, "");
52  template <class Expected, class Actual>
53  void SameType() {
54    static_assert(std::is_same<Expected, Actual>(), "");
55  }
56  TEST(Layout, ElementType) {
57    {
58      using L = Layout<int32_t>;
59      SameType<int32_t, L::ElementType<0>>();
60      SameType<int32_t, decltype(L::Partial())::ElementType<0>>();
61      SameType<int32_t, decltype(L::Partial(0))::ElementType<0>>();
62    }
63    {
64      using L = Layout<int32_t, int32_t>;
65      SameType<int32_t, L::ElementType<0>>();
66      SameType<int32_t, L::ElementType<1>>();
67      SameType<int32_t, decltype(L::Partial())::ElementType<0>>();
68      SameType<int32_t, decltype(L::Partial())::ElementType<1>>();
69      SameType<int32_t, decltype(L::Partial(0))::ElementType<0>>();
70      SameType<int32_t, decltype(L::Partial(0))::ElementType<1>>();
71    }
72    {
73      using L = Layout<int8_t, int32_t, Int128>;
74      SameType<int8_t, L::ElementType<0>>();
75      SameType<int32_t, L::ElementType<1>>();
76      SameType<Int128, L::ElementType<2>>();
77      SameType<int8_t, decltype(L::Partial())::ElementType<0>>();
78      SameType<int8_t, decltype(L::Partial(0))::ElementType<0>>();
79      SameType<int32_t, decltype(L::Partial(0))::ElementType<1>>();
80      SameType<int8_t, decltype(L::Partial(0, 0))::ElementType<0>>();
81      SameType<int32_t, decltype(L::Partial(0, 0))::ElementType<1>>();
82      SameType<Int128, decltype(L::Partial(0, 0))::ElementType<2>>();
83      SameType<int8_t, decltype(L::Partial(0, 0, 0))::ElementType<0>>();
84      SameType<int32_t, decltype(L::Partial(0, 0, 0))::ElementType<1>>();
85      SameType<Int128, decltype(L::Partial(0, 0, 0))::ElementType<2>>();
86    }
87  }
88  TEST(Layout, ElementTypes) {
89    {
90      using L = Layout<int32_t>;
91      SameType<std::tuple<int32_t>, L::ElementTypes>();
92      SameType<std::tuple<int32_t>, decltype(L::Partial())::ElementTypes>();
93      SameType<std::tuple<int32_t>, decltype(L::Partial(0))::ElementTypes>();
94    }
95    {
96      using L = Layout<int32_t, int32_t>;
97      SameType<std::tuple<int32_t, int32_t>, L::ElementTypes>();
98      SameType<std::tuple<int32_t, int32_t>,
99               decltype(L::Partial())::ElementTypes>();
100      SameType<std::tuple<int32_t, int32_t>,
101               decltype(L::Partial(0))::ElementTypes>();
102    }
103    {
104      using L = Layout<int8_t, int32_t, Int128>;
105      SameType<std::tuple<int8_t, int32_t, Int128>, L::ElementTypes>();
106      SameType<std::tuple<int8_t, int32_t, Int128>,
107               decltype(L::Partial())::ElementTypes>();
108      SameType<std::tuple<int8_t, int32_t, Int128>,
109               decltype(L::Partial(0))::ElementTypes>();
110      SameType<std::tuple<int8_t, int32_t, Int128>,
111               decltype(L::Partial(0, 0))::ElementTypes>();
112      SameType<std::tuple<int8_t, int32_t, Int128>,
113               decltype(L::Partial(0, 0, 0))::ElementTypes>();
114    }
115  }
116  TEST(Layout, OffsetByIndex) {
117    {
118      using L = Layout<int32_t>;
119      EXPECT_EQ(0, L::Partial().Offset<0>());
120      EXPECT_EQ(0, L::Partial(3).Offset<0>());
121      EXPECT_EQ(0, L(3).Offset<0>());
122    }
123    {
124      using L = Layout<int32_t, int32_t>;
125      EXPECT_EQ(0, L::Partial().Offset<0>());
126      EXPECT_EQ(0, L::Partial(3).Offset<0>());
127      EXPECT_EQ(12, L::Partial(3).Offset<1>());
128      EXPECT_EQ(0, L::Partial(3, 5).Offset<0>());
129      EXPECT_EQ(12, L::Partial(3, 5).Offset<1>());
130      EXPECT_EQ(0, L(3, 5).Offset<0>());
131      EXPECT_EQ(12, L(3, 5).Offset<1>());
132    }
133    {
134      using L = Layout<int8_t, int32_t, Int128>;
135      EXPECT_EQ(0, L::Partial().Offset<0>());
136      EXPECT_EQ(0, L::Partial(0).Offset<0>());
137      EXPECT_EQ(0, L::Partial(0).Offset<1>());
138      EXPECT_EQ(0, L::Partial(1).Offset<0>());
139      EXPECT_EQ(4, L::Partial(1).Offset<1>());
140      EXPECT_EQ(0, L::Partial(5).Offset<0>());
141      EXPECT_EQ(8, L::Partial(5).Offset<1>());
142      EXPECT_EQ(0, L::Partial(0, 0).Offset<0>());
143      EXPECT_EQ(0, L::Partial(0, 0).Offset<1>());
144      EXPECT_EQ(0, L::Partial(0, 0).Offset<2>());
145      EXPECT_EQ(0, L::Partial(1, 0).Offset<0>());
146      EXPECT_EQ(4, L::Partial(1, 0).Offset<1>());
147      EXPECT_EQ(8, L::Partial(1, 0).Offset<2>());
148      EXPECT_EQ(0, L::Partial(5, 3).Offset<0>());
149      EXPECT_EQ(8, L::Partial(5, 3).Offset<1>());
150      EXPECT_EQ(24, L::Partial(5, 3).Offset<2>());
151      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset<0>());
152      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset<1>());
153      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset<2>());
154      EXPECT_EQ(0, L::Partial(1, 0, 0).Offset<0>());
155      EXPECT_EQ(4, L::Partial(1, 0, 0).Offset<1>());
156      EXPECT_EQ(8, L::Partial(1, 0, 0).Offset<2>());
157      EXPECT_EQ(0, L::Partial(5, 3, 1).Offset<0>());
158      EXPECT_EQ(24, L::Partial(5, 3, 1).Offset<2>());
159      EXPECT_EQ(8, L::Partial(5, 3, 1).Offset<1>());
160      EXPECT_EQ(0, L(5, 3, 1).Offset<0>());
161      EXPECT_EQ(24, L(5, 3, 1).Offset<2>());
162      EXPECT_EQ(8, L(5, 3, 1).Offset<1>());
163    }
164  }
165  TEST(Layout, OffsetByType) {
166    {
167      using L = Layout<int32_t>;
168      EXPECT_EQ(0, L::Partial().Offset<int32_t>());
169      EXPECT_EQ(0, L::Partial(3).Offset<int32_t>());
170      EXPECT_EQ(0, L(3).Offset<int32_t>());
171    }
172    {
173      using L = Layout<int8_t, int32_t, Int128>;
174      EXPECT_EQ(0, L::Partial().Offset<int8_t>());
175      EXPECT_EQ(0, L::Partial(0).Offset<int8_t>());
176      EXPECT_EQ(0, L::Partial(0).Offset<int32_t>());
177      EXPECT_EQ(0, L::Partial(1).Offset<int8_t>());
178      EXPECT_EQ(4, L::Partial(1).Offset<int32_t>());
179      EXPECT_EQ(0, L::Partial(5).Offset<int8_t>());
180      EXPECT_EQ(8, L::Partial(5).Offset<int32_t>());
181      EXPECT_EQ(0, L::Partial(0, 0).Offset<int8_t>());
182      EXPECT_EQ(0, L::Partial(0, 0).Offset<int32_t>());
183      EXPECT_EQ(0, L::Partial(0, 0).Offset<Int128>());
184      EXPECT_EQ(0, L::Partial(1, 0).Offset<int8_t>());
185      EXPECT_EQ(4, L::Partial(1, 0).Offset<int32_t>());
186      EXPECT_EQ(8, L::Partial(1, 0).Offset<Int128>());
187      EXPECT_EQ(0, L::Partial(5, 3).Offset<int8_t>());
188      EXPECT_EQ(8, L::Partial(5, 3).Offset<int32_t>());
189      EXPECT_EQ(24, L::Partial(5, 3).Offset<Int128>());
190      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset<int8_t>());
191      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset<int32_t>());
192      EXPECT_EQ(0, L::Partial(0, 0, 0).Offset<Int128>());
193      EXPECT_EQ(0, L::Partial(1, 0, 0).Offset<int8_t>());
194      EXPECT_EQ(4, L::Partial(1, 0, 0).Offset<int32_t>());
195      EXPECT_EQ(8, L::Partial(1, 0, 0).Offset<Int128>());
196      EXPECT_EQ(0, L::Partial(5, 3, 1).Offset<int8_t>());
197      EXPECT_EQ(24, L::Partial(5, 3, 1).Offset<Int128>());
198      EXPECT_EQ(8, L::Partial(5, 3, 1).Offset<int32_t>());
199      EXPECT_EQ(0, L(5, 3, 1).Offset<int8_t>());
200      EXPECT_EQ(24, L(5, 3, 1).Offset<Int128>());
201      EXPECT_EQ(8, L(5, 3, 1).Offset<int32_t>());
202    }
203  }
204  TEST(Layout, Offsets) {
205    {
206      using L = Layout<int32_t>;
207      EXPECT_THAT(L::Partial().Offsets(), ElementsAre(0));
208      EXPECT_THAT(L::Partial(3).Offsets(), ElementsAre(0));
209      EXPECT_THAT(L(3).Offsets(), ElementsAre(0));
210    }
211    {
212      using L = Layout<int32_t, int32_t>;
213      EXPECT_THAT(L::Partial().Offsets(), ElementsAre(0));
214      EXPECT_THAT(L::Partial(3).Offsets(), ElementsAre(0, 12));
215      EXPECT_THAT(L::Partial(3, 5).Offsets(), ElementsAre(0, 12));
216      EXPECT_THAT(L(3, 5).Offsets(), ElementsAre(0, 12));
217    }
218    {
219      using L = Layout<int8_t, int32_t, Int128>;
220      EXPECT_THAT(L::Partial().Offsets(), ElementsAre(0));
221      EXPECT_THAT(L::Partial(1).Offsets(), ElementsAre(0, 4));
222      EXPECT_THAT(L::Partial(5).Offsets(), ElementsAre(0, 8));
223      EXPECT_THAT(L::Partial(0, 0).Offsets(), ElementsAre(0, 0, 0));
224      EXPECT_THAT(L::Partial(1, 0).Offsets(), ElementsAre(0, 4, 8));
225      EXPECT_THAT(L::Partial(5, 3).Offsets(), ElementsAre(0, 8, 24));
226      EXPECT_THAT(L::Partial(0, 0, 0).Offsets(), ElementsAre(0, 0, 0));
227      EXPECT_THAT(L::Partial(1, 0, 0).Offsets(), ElementsAre(0, 4, 8));
228      EXPECT_THAT(L::Partial(5, 3, 1).Offsets(), ElementsAre(0, 8, 24));
229      EXPECT_THAT(L(5, 3, 1).Offsets(), ElementsAre(0, 8, 24));
230    }
231  }
232  TEST(Layout, AllocSize) {
233    {
234      using L = Layout<int32_t>;
235      EXPECT_EQ(0, L::Partial(0).AllocSize());
236      EXPECT_EQ(12, L::Partial(3).AllocSize());
237      EXPECT_EQ(12, L(3).AllocSize());
238    }
239    {
240      using L = Layout<int32_t, int32_t>;
241      EXPECT_EQ(32, L::Partial(3, 5).AllocSize());
242      EXPECT_EQ(32, L(3, 5).AllocSize());
243    }
244    {
245      using L = Layout<int8_t, int32_t, Int128>;
246      EXPECT_EQ(0, L::Partial(0, 0, 0).AllocSize());
247      EXPECT_EQ(8, L::Partial(1, 0, 0).AllocSize());
248      EXPECT_EQ(8, L::Partial(0, 1, 0).AllocSize());
249      EXPECT_EQ(16, L::Partial(0, 0, 1).AllocSize());
250      EXPECT_EQ(24, L::Partial(1, 1, 1).AllocSize());
251      EXPECT_EQ(136, L::Partial(3, 5, 7).AllocSize());
252      EXPECT_EQ(136, L(3, 5, 7).AllocSize());
253    }
254  }
255  TEST(Layout, SizeByIndex) {
256    {
257      using L = Layout<int32_t>;
258      EXPECT_EQ(0, L::Partial(0).Size<0>());
259      EXPECT_EQ(3, L::Partial(3).Size<0>());
260      EXPECT_EQ(3, L(3).Size<0>());
261    }
262    {
263      using L = Layout<int32_t, int32_t>;
264      EXPECT_EQ(0, L::Partial(0).Size<0>());
265      EXPECT_EQ(3, L::Partial(3).Size<0>());
266      EXPECT_EQ(3, L::Partial(3, 5).Size<0>());
267      EXPECT_EQ(5, L::Partial(3, 5).Size<1>());
268      EXPECT_EQ(3, L(3, 5).Size<0>());
269      EXPECT_EQ(5, L(3, 5).Size<1>());
270    }
271    {
272      using L = Layout<int8_t, int32_t, Int128>;
273      EXPECT_EQ(3, L::Partial(3).Size<0>());
274      EXPECT_EQ(3, L::Partial(3, 5).Size<0>());
275      EXPECT_EQ(5, L::Partial(3, 5).Size<1>());
276      EXPECT_EQ(3, L::Partial(3, 5, 7).Size<0>());
277      EXPECT_EQ(5, L::Partial(3, 5, 7).Size<1>());
278      EXPECT_EQ(7, L::Partial(3, 5, 7).Size<2>());
279      EXPECT_EQ(3, L(3, 5, 7).Size<0>());
280      EXPECT_EQ(5, L(3, 5, 7).Size<1>());
281      EXPECT_EQ(7, L(3, 5, 7).Size<2>());
282    }
283  }
284  TEST(Layout, SizeByType) {
285    {
286      using L = Layout<int32_t>;
287      EXPECT_EQ(0, L::Partial(0).Size<int32_t>());
288      EXPECT_EQ(3, L::Partial(3).Size<int32_t>());
289      EXPECT_EQ(3, L(3).Size<int32_t>());
290    }
291    {
292      using L = Layout<int8_t, int32_t, Int128>;
293      EXPECT_EQ(3, L::Partial(3).Size<int8_t>());
294      EXPECT_EQ(3, L::Partial(3, 5).Size<int8_t>());
295      EXPECT_EQ(5, L::Partial(3, 5).Size<int32_t>());
296      EXPECT_EQ(3, L::Partial(3, 5, 7).Size<int8_t>());
297      EXPECT_EQ(5, L::Partial(3, 5, 7).Size<int32_t>());
298      EXPECT_EQ(7, L::Partial(3, 5, 7).Size<Int128>());
299      EXPECT_EQ(3, L(3, 5, 7).Size<int8_t>());
300      EXPECT_EQ(5, L(3, 5, 7).Size<int32_t>());
301      EXPECT_EQ(7, L(3, 5, 7).Size<Int128>());
302    }
303  }
304  TEST(Layout, Sizes) {
305    {
306      using L = Layout<int32_t>;
307      EXPECT_THAT(L::Partial().Sizes(), ElementsAre());
308      EXPECT_THAT(L::Partial(3).Sizes(), ElementsAre(3));
309      EXPECT_THAT(L(3).Sizes(), ElementsAre(3));
310    }
311    {
312      using L = Layout<int32_t, int32_t>;
313      EXPECT_THAT(L::Partial().Sizes(), ElementsAre());
314      EXPECT_THAT(L::Partial(3).Sizes(), ElementsAre(3));
315      EXPECT_THAT(L::Partial(3, 5).Sizes(), ElementsAre(3, 5));
316      EXPECT_THAT(L(3, 5).Sizes(), ElementsAre(3, 5));
317    }
318    {
319      using L = Layout<int8_t, int32_t, Int128>;
320      EXPECT_THAT(L::Partial().Sizes(), ElementsAre());
321      EXPECT_THAT(L::Partial(3).Sizes(), ElementsAre(3));
322      EXPECT_THAT(L::Partial(3, 5).Sizes(), ElementsAre(3, 5));
323      EXPECT_THAT(L::Partial(3, 5, 7).Sizes(), ElementsAre(3, 5, 7));
324      EXPECT_THAT(L(3, 5, 7).Sizes(), ElementsAre(3, 5, 7));
325    }
326  }
327  TEST(Layout, PointerByIndex) {
328    alignas(max_align_t) const unsigned char p[100] = {0};
329    {
330      using L = Layout<int32_t>;
331      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(L::Partial().Pointer<0>(p))));
332      EXPECT_EQ(0,
333                Distance(p, Type<const int32_t*>(L::Partial(3).Pointer<0>(p))));
334      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(L(3).Pointer<0>(p))));
335    }
336    {
337      using L = Layout<int32_t, int32_t>;
338      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(L::Partial().Pointer<0>(p))));
339      EXPECT_EQ(0,
340                Distance(p, Type<const int32_t*>(L::Partial(3).Pointer<0>(p))));
341      EXPECT_EQ(12,
342                Distance(p, Type<const int32_t*>(L::Partial(3).Pointer<1>(p))));
343      EXPECT_EQ(
344          0, Distance(p, Type<const int32_t*>(L::Partial(3, 5).Pointer<0>(p))));
345      EXPECT_EQ(
346          12, Distance(p, Type<const int32_t*>(L::Partial(3, 5).Pointer<1>(p))));
347      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(L(3, 5).Pointer<0>(p))));
348      EXPECT_EQ(12, Distance(p, Type<const int32_t*>(L(3, 5).Pointer<1>(p))));
349    }
350    {
351      using L = Layout<int8_t, int32_t, Int128>;
352      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(L::Partial().Pointer<0>(p))));
353      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(L::Partial(0).Pointer<0>(p))));
354      EXPECT_EQ(0,
355                Distance(p, Type<const int32_t*>(L::Partial(0).Pointer<1>(p))));
356      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(L::Partial(1).Pointer<0>(p))));
357      EXPECT_EQ(4,
358                Distance(p, Type<const int32_t*>(L::Partial(1).Pointer<1>(p))));
359      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(L::Partial(5).Pointer<0>(p))));
360      EXPECT_EQ(8,
361                Distance(p, Type<const int32_t*>(L::Partial(5).Pointer<1>(p))));
362      EXPECT_EQ(0,
363                Distance(p, Type<const int8_t*>(L::Partial(0, 0).Pointer<0>(p))));
364      EXPECT_EQ(
365          0, Distance(p, Type<const int32_t*>(L::Partial(0, 0).Pointer<1>(p))));
366      EXPECT_EQ(0,
367                Distance(p, Type<const Int128*>(L::Partial(0, 0).Pointer<2>(p))));
368      EXPECT_EQ(0,
369                Distance(p, Type<const int8_t*>(L::Partial(1, 0).Pointer<0>(p))));
370      EXPECT_EQ(
371          4, Distance(p, Type<const int32_t*>(L::Partial(1, 0).Pointer<1>(p))));
372      EXPECT_EQ(8,
373                Distance(p, Type<const Int128*>(L::Partial(1, 0).Pointer<2>(p))));
374      EXPECT_EQ(0,
375                Distance(p, Type<const int8_t*>(L::Partial(5, 3).Pointer<0>(p))));
376      EXPECT_EQ(
377          8, Distance(p, Type<const int32_t*>(L::Partial(5, 3).Pointer<1>(p))));
378      EXPECT_EQ(24,
379                Distance(p, Type<const Int128*>(L::Partial(5, 3).Pointer<2>(p))));
380      EXPECT_EQ(
381          0, Distance(p, Type<const int8_t*>(L::Partial(0, 0, 0).Pointer<0>(p))));
382      EXPECT_EQ(
383          0,
384          Distance(p, Type<const int32_t*>(L::Partial(0, 0, 0).Pointer<1>(p))));
385      EXPECT_EQ(
386          0, Distance(p, Type<const Int128*>(L::Partial(0, 0, 0).Pointer<2>(p))));
387      EXPECT_EQ(
388          0, Distance(p, Type<const int8_t*>(L::Partial(1, 0, 0).Pointer<0>(p))));
389      EXPECT_EQ(
390          4,
391          Distance(p, Type<const int32_t*>(L::Partial(1, 0, 0).Pointer<1>(p))));
392      EXPECT_EQ(
393          8, Distance(p, Type<const Int128*>(L::Partial(1, 0, 0).Pointer<2>(p))));
394      EXPECT_EQ(
395          0, Distance(p, Type<const int8_t*>(L::Partial(5, 3, 1).Pointer<0>(p))));
396      EXPECT_EQ(
397          24,
398          Distance(p, Type<const Int128*>(L::Partial(5, 3, 1).Pointer<2>(p))));
399      EXPECT_EQ(
400          8,
401          Distance(p, Type<const int32_t*>(L::Partial(5, 3, 1).Pointer<1>(p))));
402      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(L(5, 3, 1).Pointer<0>(p))));
403      EXPECT_EQ(24, Distance(p, Type<const Int128*>(L(5, 3, 1).Pointer<2>(p))));
404      EXPECT_EQ(8, Distance(p, Type<const int32_t*>(L(5, 3, 1).Pointer<1>(p))));
405    }
406  }
407  TEST(Layout, PointerByType) {
408    alignas(max_align_t) const unsigned char p[100] = {0};
409    {
410      using L = Layout<int32_t>;
411      EXPECT_EQ(
412          0, Distance(p, Type<const int32_t*>(L::Partial().Pointer<int32_t>(p))));
413      EXPECT_EQ(
414          0,
415          Distance(p, Type<const int32_t*>(L::Partial(3).Pointer<int32_t>(p))));
416      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(L(3).Pointer<int32_t>(p))));
417    }
418    {
419      using L = Layout<int8_t, int32_t, Int128>;
420      EXPECT_EQ(
421          0, Distance(p, Type<const int8_t*>(L::Partial().Pointer<int8_t>(p))));
422      EXPECT_EQ(
423          0, Distance(p, Type<const int8_t*>(L::Partial(0).Pointer<int8_t>(p))));
424      EXPECT_EQ(
425          0,
426          Distance(p, Type<const int32_t*>(L::Partial(0).Pointer<int32_t>(p))));
427      EXPECT_EQ(
428          0, Distance(p, Type<const int8_t*>(L::Partial(1).Pointer<int8_t>(p))));
429      EXPECT_EQ(
430          4,
431          Distance(p, Type<const int32_t*>(L::Partial(1).Pointer<int32_t>(p))));
432      EXPECT_EQ(
433          0, Distance(p, Type<const int8_t*>(L::Partial(5).Pointer<int8_t>(p))));
434      EXPECT_EQ(
435          8,
436          Distance(p, Type<const int32_t*>(L::Partial(5).Pointer<int32_t>(p))));
437      EXPECT_EQ(
438          0,
439          Distance(p, Type<const int8_t*>(L::Partial(0, 0).Pointer<int8_t>(p))));
440      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(
441                                   L::Partial(0, 0).Pointer<int32_t>(p))));
442      EXPECT_EQ(
443          0,
444          Distance(p, Type<const Int128*>(L::Partial(0, 0).Pointer<Int128>(p))));
445      EXPECT_EQ(
446          0,
447          Distance(p, Type<const int8_t*>(L::Partial(1, 0).Pointer<int8_t>(p))));
448      EXPECT_EQ(4, Distance(p, Type<const int32_t*>(
449                                   L::Partial(1, 0).Pointer<int32_t>(p))));
450      EXPECT_EQ(
451          8,
452          Distance(p, Type<const Int128*>(L::Partial(1, 0).Pointer<Int128>(p))));
453      EXPECT_EQ(
454          0,
455          Distance(p, Type<const int8_t*>(L::Partial(5, 3).Pointer<int8_t>(p))));
456      EXPECT_EQ(8, Distance(p, Type<const int32_t*>(
457                                   L::Partial(5, 3).Pointer<int32_t>(p))));
458      EXPECT_EQ(
459          24,
460          Distance(p, Type<const Int128*>(L::Partial(5, 3).Pointer<Int128>(p))));
461      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(
462                                   L::Partial(0, 0, 0).Pointer<int8_t>(p))));
463      EXPECT_EQ(0, Distance(p, Type<const int32_t*>(
464                                   L::Partial(0, 0, 0).Pointer<int32_t>(p))));
465      EXPECT_EQ(0, Distance(p, Type<const Int128*>(
466                                   L::Partial(0, 0, 0).Pointer<Int128>(p))));
467      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(
468                                   L::Partial(1, 0, 0).Pointer<int8_t>(p))));
469      EXPECT_EQ(4, Distance(p, Type<const int32_t*>(
470                                   L::Partial(1, 0, 0).Pointer<int32_t>(p))));
471      EXPECT_EQ(8, Distance(p, Type<const Int128*>(
472                                   L::Partial(1, 0, 0).Pointer<Int128>(p))));
473      EXPECT_EQ(0, Distance(p, Type<const int8_t*>(
474                                   L::Partial(5, 3, 1).Pointer<int8_t>(p))));
475      EXPECT_EQ(24, Distance(p, Type<const Int128*>(
476                                    L::Partial(5, 3, 1).Pointer<Int128>(p))));
477      EXPECT_EQ(8, Distance(p, Type<const int32_t*>(
478                                   L::Partial(5, 3, 1).Pointer<int32_t>(p))));
479      EXPECT_EQ(24,
480                Distance(p, Type<const Int128*>(L(5, 3, 1).Pointer<Int128>(p))));
481      EXPECT_EQ(
482          8, Distance(p, Type<const int32_t*>(L(5, 3, 1).Pointer<int32_t>(p))));
483    }
484  }
485  TEST(Layout, MutablePointerByIndex) {
486    alignas(max_align_t) unsigned char p[100] = {0};
487    {
488      using L = Layout<int32_t>;
489      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial().Pointer<0>(p))));
490      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial(3).Pointer<0>(p))));
491      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L(3).Pointer<0>(p))));
492    }
493    {
494      using L = Layout<int32_t, int32_t>;
495      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial().Pointer<0>(p))));
496      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial(3).Pointer<0>(p))));
497      EXPECT_EQ(12, Distance(p, Type<int32_t*>(L::Partial(3).Pointer<1>(p))));
498      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial(3, 5).Pointer<0>(p))));
499      EXPECT_EQ(12, Distance(p, Type<int32_t*>(L::Partial(3, 5).Pointer<1>(p))));
500      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L(3, 5).Pointer<0>(p))));
501      EXPECT_EQ(12, Distance(p, Type<int32_t*>(L(3, 5).Pointer<1>(p))));
502    }
503    {
504      using L = Layout<int8_t, int32_t, Int128>;
505      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial().Pointer<0>(p))));
506      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(0).Pointer<0>(p))));
507      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial(0).Pointer<1>(p))));
508      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(1).Pointer<0>(p))));
509      EXPECT_EQ(4, Distance(p, Type<int32_t*>(L::Partial(1).Pointer<1>(p))));
510      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(5).Pointer<0>(p))));
511      EXPECT_EQ(8, Distance(p, Type<int32_t*>(L::Partial(5).Pointer<1>(p))));
512      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(0, 0).Pointer<0>(p))));
513      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial(0, 0).Pointer<1>(p))));
514      EXPECT_EQ(0, Distance(p, Type<Int128*>(L::Partial(0, 0).Pointer<2>(p))));
515      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(1, 0).Pointer<0>(p))));
516      EXPECT_EQ(4, Distance(p, Type<int32_t*>(L::Partial(1, 0).Pointer<1>(p))));
517      EXPECT_EQ(8, Distance(p, Type<Int128*>(L::Partial(1, 0).Pointer<2>(p))));
518      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(5, 3).Pointer<0>(p))));
519      EXPECT_EQ(8, Distance(p, Type<int32_t*>(L::Partial(5, 3).Pointer<1>(p))));
520      EXPECT_EQ(24, Distance(p, Type<Int128*>(L::Partial(5, 3).Pointer<2>(p))));
521      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(0, 0, 0).Pointer<0>(p))));
522      EXPECT_EQ(0,
523                Distance(p, Type<int32_t*>(L::Partial(0, 0, 0).Pointer<1>(p))));
524      EXPECT_EQ(0, Distance(p, Type<Int128*>(L::Partial(0, 0, 0).Pointer<2>(p))));
525      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(1, 0, 0).Pointer<0>(p))));
526      EXPECT_EQ(4,
527                Distance(p, Type<int32_t*>(L::Partial(1, 0, 0).Pointer<1>(p))));
528      EXPECT_EQ(8, Distance(p, Type<Int128*>(L::Partial(1, 0, 0).Pointer<2>(p))));
529      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(5, 3, 1).Pointer<0>(p))));
530      EXPECT_EQ(24,
531                Distance(p, Type<Int128*>(L::Partial(5, 3, 1).Pointer<2>(p))));
532      EXPECT_EQ(8,
533                Distance(p, Type<int32_t*>(L::Partial(5, 3, 1).Pointer<1>(p))));
534      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L(5, 3, 1).Pointer<0>(p))));
535      EXPECT_EQ(24, Distance(p, Type<Int128*>(L(5, 3, 1).Pointer<2>(p))));
536      EXPECT_EQ(8, Distance(p, Type<int32_t*>(L(5, 3, 1).Pointer<1>(p))));
537    }
538  }
539  TEST(Layout, MutablePointerByType) {
540    alignas(max_align_t) unsigned char p[100] = {0};
541    {
542      using L = Layout<int32_t>;
543      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L::Partial().Pointer<int32_t>(p))));
544      EXPECT_EQ(0,
545                Distance(p, Type<int32_t*>(L::Partial(3).Pointer<int32_t>(p))));
546      EXPECT_EQ(0, Distance(p, Type<int32_t*>(L(3).Pointer<int32_t>(p))));
547    }
548    {
549      using L = Layout<int8_t, int32_t, Int128>;
550      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial().Pointer<int8_t>(p))));
551      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(0).Pointer<int8_t>(p))));
552      EXPECT_EQ(0,
553                Distance(p, Type<int32_t*>(L::Partial(0).Pointer<int32_t>(p))));
554      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(1).Pointer<int8_t>(p))));
555      EXPECT_EQ(4,
556                Distance(p, Type<int32_t*>(L::Partial(1).Pointer<int32_t>(p))));
557      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L::Partial(5).Pointer<int8_t>(p))));
558      EXPECT_EQ(8,
559                Distance(p, Type<int32_t*>(L::Partial(5).Pointer<int32_t>(p))));
560      EXPECT_EQ(0,
561                Distance(p, Type<int8_t*>(L::Partial(0, 0).Pointer<int8_t>(p))));
562      EXPECT_EQ(
563          0, Distance(p, Type<int32_t*>(L::Partial(0, 0).Pointer<int32_t>(p))));
564      EXPECT_EQ(0,
565                Distance(p, Type<Int128*>(L::Partial(0, 0).Pointer<Int128>(p))));
566      EXPECT_EQ(0,
567                Distance(p, Type<int8_t*>(L::Partial(1, 0).Pointer<int8_t>(p))));
568      EXPECT_EQ(
569          4, Distance(p, Type<int32_t*>(L::Partial(1, 0).Pointer<int32_t>(p))));
570      EXPECT_EQ(8,
571                Distance(p, Type<Int128*>(L::Partial(1, 0).Pointer<Int128>(p))));
572      EXPECT_EQ(0,
573                Distance(p, Type<int8_t*>(L::Partial(5, 3).Pointer<int8_t>(p))));
574      EXPECT_EQ(
575          8, Distance(p, Type<int32_t*>(L::Partial(5, 3).Pointer<int32_t>(p))));
576      EXPECT_EQ(24,
577                Distance(p, Type<Int128*>(L::Partial(5, 3).Pointer<Int128>(p))));
578      EXPECT_EQ(
579          0, Distance(p, Type<int8_t*>(L::Partial(0, 0, 0).Pointer<int8_t>(p))));
580      EXPECT_EQ(
581          0,
582          Distance(p, Type<int32_t*>(L::Partial(0, 0, 0).Pointer<int32_t>(p))));
583      EXPECT_EQ(
584          0, Distance(p, Type<Int128*>(L::Partial(0, 0, 0).Pointer<Int128>(p))));
585      EXPECT_EQ(
586          0, Distance(p, Type<int8_t*>(L::Partial(1, 0, 0).Pointer<int8_t>(p))));
587      EXPECT_EQ(
588          4,
589          Distance(p, Type<int32_t*>(L::Partial(1, 0, 0).Pointer<int32_t>(p))));
590      EXPECT_EQ(
591          8, Distance(p, Type<Int128*>(L::Partial(1, 0, 0).Pointer<Int128>(p))));
592      EXPECT_EQ(
593          0, Distance(p, Type<int8_t*>(L::Partial(5, 3, 1).Pointer<int8_t>(p))));
594      EXPECT_EQ(
595          24, Distance(p, Type<Int128*>(L::Partial(5, 3, 1).Pointer<Int128>(p))));
596      EXPECT_EQ(
597          8,
598          Distance(p, Type<int32_t*>(L::Partial(5, 3, 1).Pointer<int32_t>(p))));
599      EXPECT_EQ(0, Distance(p, Type<int8_t*>(L(5, 3, 1).Pointer<int8_t>(p))));
600      EXPECT_EQ(24, Distance(p, Type<Int128*>(L(5, 3, 1).Pointer<Int128>(p))));
601      EXPECT_EQ(8, Distance(p, Type<int32_t*>(L(5, 3, 1).Pointer<int32_t>(p))));
602    }
603  }
604  TEST(Layout, Pointers) {
605    alignas(max_align_t) const unsigned char p[100] = {0};
606    using L = Layout<int8_t, int8_t, Int128>;
607    {
608      const auto x = L::Partial();
609      EXPECT_EQ(std::make_tuple(x.Pointer<0>(p)),
610                Type<std::tuple<const int8_t*>>(x.Pointers(p)));
611    }
612    {
613      const auto x = L::Partial(1);
614      EXPECT_EQ(std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p)),
615                (Type<std::tuple<const int8_t*, const int8_t*>>(x.Pointers(p))));
616    }
617    {
618      const auto x = L::Partial(1, 2);
619      EXPECT_EQ(
620          std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p), x.Pointer<2>(p)),
621          (Type<std::tuple<const int8_t*, const int8_t*, const Int128*>>(
622              x.Pointers(p))));
623    }
624    {
625      const auto x = L::Partial(1, 2, 3);
626      EXPECT_EQ(
627          std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p), x.Pointer<2>(p)),
628          (Type<std::tuple<const int8_t*, const int8_t*, const Int128*>>(
629              x.Pointers(p))));
630    }
631    {
632      const L x(1, 2, 3);
633      EXPECT_EQ(
634          std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p), x.Pointer<2>(p)),
635          (Type<std::tuple<const int8_t*, const int8_t*, const Int128*>>(
636              x.Pointers(p))));
637    }
638  }
639  TEST(Layout, MutablePointers) {
640    alignas(max_align_t) unsigned char p[100] = {0};
641    using L = Layout<int8_t, int8_t, Int128>;
642    {
643      const auto x = L::Partial();
644      EXPECT_EQ(std::make_tuple(x.Pointer<0>(p)),
645                Type<std::tuple<int8_t*>>(x.Pointers(p)));
646    }
647    {
648      const auto x = L::Partial(1);
649      EXPECT_EQ(std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p)),
650                (Type<std::tuple<int8_t*, int8_t*>>(x.Pointers(p))));
651    }
652    {
653      const auto x = L::Partial(1, 2);
654      EXPECT_EQ(
655          std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p), x.Pointer<2>(p)),
656          (Type<std::tuple<int8_t*, int8_t*, Int128*>>(x.Pointers(p))));
657    }
658    {
659      const auto x = L::Partial(1, 2, 3);
660      EXPECT_EQ(
661          std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p), x.Pointer<2>(p)),
662          (Type<std::tuple<int8_t*, int8_t*, Int128*>>(x.Pointers(p))));
663    }
664    {
665      const L x(1, 2, 3);
666      EXPECT_EQ(
667          std::make_tuple(x.Pointer<0>(p), x.Pointer<1>(p), x.Pointer<2>(p)),
668          (Type<std::tuple<int8_t*, int8_t*, Int128*>>(x.Pointers(p))));
669    }
670  }
671  TEST(Layout, SliceByIndexSize) {
672    alignas(max_align_t) const unsigned char p[100] = {0};
673    {
674      using L = Layout<int32_t>;
675      EXPECT_EQ(0, L::Partial(0).Slice<0>(p).size());
676      EXPECT_EQ(3, L::Partial(3).Slice<0>(p).size());
677      EXPECT_EQ(3, L(3).Slice<0>(p).size());
678    }
679    {
680      using L = Layout<int32_t, int32_t>;
681      EXPECT_EQ(3, L::Partial(3).Slice<0>(p).size());
682      EXPECT_EQ(5, L::Partial(3, 5).Slice<1>(p).size());
683      EXPECT_EQ(5, L(3, 5).Slice<1>(p).size());
684    }
685    {
686      using L = Layout<int8_t, int32_t, Int128>;
687      EXPECT_EQ(3, L::Partial(3).Slice<0>(p).size());
688      EXPECT_EQ(3, L::Partial(3, 5).Slice<0>(p).size());
689      EXPECT_EQ(5, L::Partial(3, 5).Slice<1>(p).size());
690      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice<0>(p).size());
691      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice<1>(p).size());
692      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice<2>(p).size());
693      EXPECT_EQ(3, L(3, 5, 7).Slice<0>(p).size());
694      EXPECT_EQ(5, L(3, 5, 7).Slice<1>(p).size());
695      EXPECT_EQ(7, L(3, 5, 7).Slice<2>(p).size());
696    }
697  }
698  TEST(Layout, SliceByTypeSize) {
699    alignas(max_align_t) const unsigned char p[100] = {0};
700    {
701      using L = Layout<int32_t>;
702      EXPECT_EQ(0, L::Partial(0).Slice<int32_t>(p).size());
703      EXPECT_EQ(3, L::Partial(3).Slice<int32_t>(p).size());
704      EXPECT_EQ(3, L(3).Slice<int32_t>(p).size());
705    }
706    {
707      using L = Layout<int8_t, int32_t, Int128>;
708      EXPECT_EQ(3, L::Partial(3).Slice<int8_t>(p).size());
709      EXPECT_EQ(3, L::Partial(3, 5).Slice<int8_t>(p).size());
710      EXPECT_EQ(5, L::Partial(3, 5).Slice<int32_t>(p).size());
711      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice<int8_t>(p).size());
712      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice<int32_t>(p).size());
713      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice<Int128>(p).size());
714      EXPECT_EQ(3, L(3, 5, 7).Slice<int8_t>(p).size());
715      EXPECT_EQ(5, L(3, 5, 7).Slice<int32_t>(p).size());
716      EXPECT_EQ(7, L(3, 5, 7).Slice<Int128>(p).size());
717    }
718  }
719  TEST(Layout, MutableSliceByIndexSize) {
720    alignas(max_align_t) unsigned char p[100] = {0};
721    {
722      using L = Layout<int32_t>;
723      EXPECT_EQ(0, L::Partial(0).Slice<0>(p).size());
724      EXPECT_EQ(3, L::Partial(3).Slice<0>(p).size());
725      EXPECT_EQ(3, L(3).Slice<0>(p).size());
726    }
727    {
728      using L = Layout<int32_t, int32_t>;
729      EXPECT_EQ(3, L::Partial(3).Slice<0>(p).size());
730      EXPECT_EQ(5, L::Partial(3, 5).Slice<1>(p).size());
731      EXPECT_EQ(5, L(3, 5).Slice<1>(p).size());
732    }
733    {
734      using L = Layout<int8_t, int32_t, Int128>;
735      EXPECT_EQ(3, L::Partial(3).Slice<0>(p).size());
736      EXPECT_EQ(3, L::Partial(3, 5).Slice<0>(p).size());
737      EXPECT_EQ(5, L::Partial(3, 5).Slice<1>(p).size());
738      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice<0>(p).size());
739      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice<1>(p).size());
740      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice<2>(p).size());
741      EXPECT_EQ(3, L(3, 5, 7).Slice<0>(p).size());
742      EXPECT_EQ(5, L(3, 5, 7).Slice<1>(p).size());
743      EXPECT_EQ(7, L(3, 5, 7).Slice<2>(p).size());
744    }
745  }
746  TEST(Layout, MutableSliceByTypeSize) {
747    alignas(max_align_t) unsigned char p[100] = {0};
748    {
749      using L = Layout<int32_t>;
750      EXPECT_EQ(0, L::Partial(0).Slice<int32_t>(p).size());
751      EXPECT_EQ(3, L::Partial(3).Slice<int32_t>(p).size());
752      EXPECT_EQ(3, L(3).Slice<int32_t>(p).size());
753    }
754    {
755      using L = Layout<int8_t, int32_t, Int128>;
756      EXPECT_EQ(3, L::Partial(3).Slice<int8_t>(p).size());
757      EXPECT_EQ(3, L::Partial(3, 5).Slice<int8_t>(p).size());
758      EXPECT_EQ(5, L::Partial(3, 5).Slice<int32_t>(p).size());
759      EXPECT_EQ(3, L::Partial(3, 5, 7).Slice<int8_t>(p).size());
760      EXPECT_EQ(5, L::Partial(3, 5, 7).Slice<int32_t>(p).size());
761      EXPECT_EQ(7, L::Partial(3, 5, 7).Slice<Int128>(p).size());
762      EXPECT_EQ(3, L(3, 5, 7).Slice<int8_t>(p).size());
763      EXPECT_EQ(5, L(3, 5, 7).Slice<int32_t>(p).size());
764      EXPECT_EQ(7, L(3, 5, 7).Slice<Int128>(p).size());
765    }
766  }
767  TEST(Layout, SliceByIndexData) {
768    alignas(max_align_t) const unsigned char p[100] = {0};
769    {
770      using L = Layout<int32_t>;
771      EXPECT_EQ(
772          0, Distance(
773                 p, Type<Span<const int32_t>>(L::Partial(0).Slice<0>(p)).data()));
774      EXPECT_EQ(
775          0, Distance(
776                 p, Type<Span<const int32_t>>(L::Partial(3).Slice<0>(p)).data()));
777      EXPECT_EQ(0,
778                Distance(p, Type<Span<const int32_t>>(L(3).Slice<0>(p)).data()));
779    }
780    {
781      using L = Layout<int32_t, int32_t>;
782      EXPECT_EQ(
783          0, Distance(
784                 p, Type<Span<const int32_t>>(L::Partial(3).Slice<0>(p)).data()));
785      EXPECT_EQ(
786          0,
787          Distance(
788              p, Type<Span<const int32_t>>(L::Partial(3, 5).Slice<0>(p)).data()));
789      EXPECT_EQ(
790          12,
791          Distance(
792              p, Type<Span<const int32_t>>(L::Partial(3, 5).Slice<1>(p)).data()));
793      EXPECT_EQ(
794          0, Distance(p, Type<Span<const int32_t>>(L(3, 5).Slice<0>(p)).data()));
795      EXPECT_EQ(
796          12, Distance(p, Type<Span<const int32_t>>(L(3, 5).Slice<1>(p)).data()));
797    }
798    {
799      using L = Layout<int8_t, int32_t, Int128>;
800      EXPECT_EQ(
801          0, Distance(
802                 p, Type<Span<const int8_t>>(L::Partial(0).Slice<0>(p)).data()));
803      EXPECT_EQ(
804          0, Distance(
805                 p, Type<Span<const int8_t>>(L::Partial(1).Slice<0>(p)).data()));
806      EXPECT_EQ(
807          0, Distance(
808                 p, Type<Span<const int8_t>>(L::Partial(5).Slice<0>(p)).data()));
809      EXPECT_EQ(
810          0,
811          Distance(
812              p, Type<Span<const int8_t>>(L::Partial(0, 0).Slice<0>(p)).data()));
813      EXPECT_EQ(
814          0,
815          Distance(
816              p, Type<Span<const int32_t>>(L::Partial(0, 0).Slice<1>(p)).data()));
817      EXPECT_EQ(
818          0,
819          Distance(
820              p, Type<Span<const int8_t>>(L::Partial(1, 0).Slice<0>(p)).data()));
821      EXPECT_EQ(
822          4,
823          Distance(
824              p, Type<Span<const int32_t>>(L::Partial(1, 0).Slice<1>(p)).data()));
825      EXPECT_EQ(
826          0,
827          Distance(
828              p, Type<Span<const int8_t>>(L::Partial(5, 3).Slice<0>(p)).data()));
829      EXPECT_EQ(
830          8,
831          Distance(
832              p, Type<Span<const int32_t>>(L::Partial(5, 3).Slice<1>(p)).data()));
833      EXPECT_EQ(
834          0,
835          Distance(
836              p,
837              Type<Span<const int8_t>>(L::Partial(0, 0, 0).Slice<0>(p)).data()));
838      EXPECT_EQ(
839          0,
840          Distance(
841              p,
842              Type<Span<const int32_t>>(L::Partial(0, 0, 0).Slice<1>(p)).data()));
843      EXPECT_EQ(
844          0,
845          Distance(
846              p,
847              Type<Span<const Int128>>(L::Partial(0, 0, 0).Slice<2>(p)).data()));
848      EXPECT_EQ(
849          0,
850          Distance(
851              p,
852              Type<Span<const int8_t>>(L::Partial(1, 0, 0).Slice<0>(p)).data()));
853      EXPECT_EQ(
854          4,
855          Distance(
856              p,
857              Type<Span<const int32_t>>(L::Partial(1, 0, 0).Slice<1>(p)).data()));
858      EXPECT_EQ(
859          8,
860          Distance(
861              p,
862              Type<Span<const Int128>>(L::Partial(1, 0, 0).Slice<2>(p)).data()));
863      EXPECT_EQ(
864          0,
865          Distance(
866              p,
867              Type<Span<const int8_t>>(L::Partial(5, 3, 1).Slice<0>(p)).data()));
868      EXPECT_EQ(
869          24,
870          Distance(
871              p,
872              Type<Span<const Int128>>(L::Partial(5, 3, 1).Slice<2>(p)).data()));
873      EXPECT_EQ(
874          8,
875          Distance(
876              p,
877              Type<Span<const int32_t>>(L::Partial(5, 3, 1).Slice<1>(p)).data()));
878      EXPECT_EQ(
879          0,
880          Distance(p, Type<Span<const int8_t>>(L(5, 3, 1).Slice<0>(p)).data()));
881      EXPECT_EQ(
882          24,
883          Distance(p, Type<Span<const Int128>>(L(5, 3, 1).Slice<2>(p)).data()));
884      EXPECT_EQ(
885          8,
886          Distance(p, Type<Span<const int32_t>>(L(5, 3, 1).Slice<1>(p)).data()));
887    }
888  }
889  TEST(Layout, SliceByTypeData) {
890    alignas(max_align_t) const unsigned char p[100] = {0};
891    {
892      using L = Layout<int32_t>;
893      EXPECT_EQ(
894          0,
895          Distance(
896              p,
897              Type<Span<const int32_t>>(L::Partial(0).Slice<int32_t>(p)).data()));
898      EXPECT_EQ(
899          0,
900          Distance(
901              p,
902              Type<Span<const int32_t>>(L::Partial(3).Slice<int32_t>(p)).data()));
903      EXPECT_EQ(
904          0,
905          Distance(p, Type<Span<const int32_t>>(L(3).Slice<int32_t>(p)).data()));
906    }
907    {
908      using L = Layout<int8_t, int32_t, Int128>;
909      EXPECT_EQ(
910          0,
911          Distance(
912              p,
913              Type<Span<const int8_t>>(L::Partial(0).Slice<int8_t>(p)).data()));
914      EXPECT_EQ(
915          0,
916          Distance(
917              p,
918              Type<Span<const int8_t>>(L::Partial(1).Slice<int8_t>(p)).data()));
919      EXPECT_EQ(
920          0,
921          Distance(
922              p,
923              Type<Span<const int8_t>>(L::Partial(5).Slice<int8_t>(p)).data()));
924      EXPECT_EQ(
925          0,
926          Distance(p, Type<Span<const int8_t>>(L::Partial(0, 0).Slice<int8_t>(p))
927                          .data()));
928      EXPECT_EQ(0, Distance(p, Type<Span<const int32_t>>(
929                                   L::Partial(0, 0).Slice<int32_t>(p))
930                                   .data()));
931      EXPECT_EQ(
932          0,
933          Distance(p, Type<Span<const int8_t>>(L::Partial(1, 0).Slice<int8_t>(p))
934                          .data()));
935      EXPECT_EQ(4, Distance(p, Type<Span<const int32_t>>(
936                                   L::Partial(1, 0).Slice<int32_t>(p))
937                                   .data()));
938      EXPECT_EQ(
939          0,
940          Distance(p, Type<Span<const int8_t>>(L::Partial(5, 3).Slice<int8_t>(p))
941                          .data()));
942      EXPECT_EQ(8, Distance(p, Type<Span<const int32_t>>(
943                                   L::Partial(5, 3).Slice<int32_t>(p))
944                                   .data()));
945      EXPECT_EQ(0, Distance(p, Type<Span<const int8_t>>(
946                                   L::Partial(0, 0, 0).Slice<int8_t>(p))
947                                   .data()));
948      EXPECT_EQ(0, Distance(p, Type<Span<const int32_t>>(
949                                   L::Partial(0, 0, 0).Slice<int32_t>(p))
950                                   .data()));
951      EXPECT_EQ(0, Distance(p, Type<Span<const Int128>>(
952                                   L::Partial(0, 0, 0).Slice<Int128>(p))
953                                   .data()));
954      EXPECT_EQ(0, Distance(p, Type<Span<const int8_t>>(
955                                   L::Partial(1, 0, 0).Slice<int8_t>(p))
956                                   .data()));
957      EXPECT_EQ(4, Distance(p, Type<Span<const int32_t>>(
958                                   L::Partial(1, 0, 0).Slice<int32_t>(p))
959                                   .data()));
960      EXPECT_EQ(8, Distance(p, Type<Span<const Int128>>(
961                                   L::Partial(1, 0, 0).Slice<Int128>(p))
962                                   .data()));
963      EXPECT_EQ(0, Distance(p, Type<Span<const int8_t>>(
964                                   L::Partial(5, 3, 1).Slice<int8_t>(p))
965                                   .data()));
966      EXPECT_EQ(24, Distance(p, Type<Span<const Int128>>(
967                                    L::Partial(5, 3, 1).Slice<Int128>(p))
968                                    .data()));
969      EXPECT_EQ(8, Distance(p, Type<Span<const int32_t>>(
970                                   L::Partial(5, 3, 1).Slice<int32_t>(p))
971                                   .data()));
972      EXPECT_EQ(
973          0,
974          Distance(p,
975                   Type<Span<const int8_t>>(L(5, 3, 1).Slice<int8_t>(p)).data()));
976      EXPECT_EQ(
977          24,
978          Distance(p,
979                   Type<Span<const Int128>>(L(5, 3, 1).Slice<Int128>(p)).data()));
980      EXPECT_EQ(
981          8,
982          Distance(
983              p, Type<Span<const int32_t>>(L(5, 3, 1).Slice<int32_t>(p)).data()));
984    }
985  }
986  TEST(Layout, MutableSliceByIndexData) {
987    alignas(max_align_t) unsigned char p[100] = {0};
988    {
989      using L = Layout<int32_t>;
990      EXPECT_EQ(
991          0, Distance(p, Type<Span<int32_t>>(L::Partial(0).Slice<0>(p)).data()));
992      EXPECT_EQ(
993          0, Distance(p, Type<Span<int32_t>>(L::Partial(3).Slice<0>(p)).data()));
994      EXPECT_EQ(0, Distance(p, Type<Span<int32_t>>(L(3).Slice<0>(p)).data()));
995    }
996    {
997      using L = Layout<int32_t, int32_t>;
998      EXPECT_EQ(
999          0, Distance(p, Type<Span<int32_t>>(L::Partial(3).Slice<0>(p)).data()));
1000      EXPECT_EQ(
1001          0,
1002          Distance(p, Type<Span<int32_t>>(L::Partial(3, 5).Slice<0>(p)).data()));
1003      EXPECT_EQ(
1004          12,
1005          Distance(p, Type<Span<int32_t>>(L::Partial(3, 5).Slice<1>(p)).data()));
1006      EXPECT_EQ(0, Distance(p, Type<Span<int32_t>>(L(3, 5).Slice<0>(p)).data()));
1007      EXPECT_EQ(12, Distance(p, Type<Span<int32_t>>(L(3, 5).Slice<1>(p)).data()));
1008    }
1009    {
1010      using L = Layout<int8_t, int32_t, Int128>;
1011      EXPECT_EQ(
1012          0, Distance(p, Type<Span<int8_t>>(L::Partial(0).Slice<0>(p)).data()));
1013      EXPECT_EQ(
1014          0, Distance(p, Type<Span<int8_t>>(L::Partial(1).Slice<0>(p)).data()));
1015      EXPECT_EQ(
1016          0, Distance(p, Type<Span<int8_t>>(L::Partial(5).Slice<0>(p)).data()));
1017      EXPECT_EQ(
1018          0,
1019          Distance(p, Type<Span<int8_t>>(L::Partial(0, 0).Slice<0>(p)).data()));
1020      EXPECT_EQ(
1021          0,
1022          Distance(p, Type<Span<int32_t>>(L::Partial(0, 0).Slice<1>(p)).data()));
1023      EXPECT_EQ(
1024          0,
1025          Distance(p, Type<Span<int8_t>>(L::Partial(1, 0).Slice<0>(p)).data()));
1026      EXPECT_EQ(
1027          4,
1028          Distance(p, Type<Span<int32_t>>(L::Partial(1, 0).Slice<1>(p)).data()));
1029      EXPECT_EQ(
1030          0,
1031          Distance(p, Type<Span<int8_t>>(L::Partial(5, 3).Slice<0>(p)).data()));
1032      EXPECT_EQ(
1033          8,
1034          Distance(p, Type<Span<int32_t>>(L::Partial(5, 3).Slice<1>(p)).data()));
1035      EXPECT_EQ(
1036          0, Distance(
1037                 p, Type<Span<int8_t>>(L::Partial(0, 0, 0).Slice<0>(p)).data()));
1038      EXPECT_EQ(
1039          0, Distance(
1040                 p, Type<Span<int32_t>>(L::Partial(0, 0, 0).Slice<1>(p)).data()));
1041      EXPECT_EQ(
1042          0, Distance(
1043                 p, Type<Span<Int128>>(L::Partial(0, 0, 0).Slice<2>(p)).data()));
1044      EXPECT_EQ(
1045          0, Distance(
1046                 p, Type<Span<int8_t>>(L::Partial(1, 0, 0).Slice<0>(p)).data()));
1047      EXPECT_EQ(
1048          4, Distance(
1049                 p, Type<Span<int32_t>>(L::Partial(1, 0, 0).Slice<1>(p)).data()));
1050      EXPECT_EQ(
1051          8, Distance(
1052                 p, Type<Span<Int128>>(L::Partial(1, 0, 0).Slice<2>(p)).data()));
1053      EXPECT_EQ(
1054          0, Distance(
1055                 p, Type<Span<int8_t>>(L::Partial(5, 3, 1).Slice<0>(p)).data()));
1056      EXPECT_EQ(
1057          24, Distance(
1058                  p, Type<Span<Int128>>(L::Partial(5, 3, 1).Slice<2>(p)).data()));
1059      EXPECT_EQ(
1060          8, Distance(
1061                 p, Type<Span<int32_t>>(L::Partial(5, 3, 1).Slice<1>(p)).data()));
1062      EXPECT_EQ(0,
1063                Distance(p, Type<Span<int8_t>>(L(5, 3, 1).Slice<0>(p)).data()));
1064      EXPECT_EQ(24,
1065                Distance(p, Type<Span<Int128>>(L(5, 3, 1).Slice<2>(p)).data()));
1066      EXPECT_EQ(8,
1067                Distance(p, Type<Span<int32_t>>(L(5, 3, 1).Slice<1>(p)).data()));
1068    }
1069  }
1070  TEST(Layout, MutableSliceByTypeData) {
1071    alignas(max_align_t) unsigned char p[100] = {0};
1072    {
1073      using L = Layout<int32_t>;
1074      EXPECT_EQ(
1075          0, Distance(
1076                 p, Type<Span<int32_t>>(L::Partial(0).Slice<int32_t>(p)).data()));
1077      EXPECT_EQ(
1078          0, Distance(
1079                 p, Type<Span<int32_t>>(L::Partial(3).Slice<int32_t>(p)).data()));
1080      EXPECT_EQ(0,
1081                Distance(p, Type<Span<int32_t>>(L(3).Slice<int32_t>(p)).data()));
1082    }
1083    {
1084      using L = Layout<int8_t, int32_t, Int128>;
1085      EXPECT_EQ(
1086          0,
1087          Distance(p, Type<Span<int8_t>>(L::Partial(0).Slice<int8_t>(p)).data()));
1088      EXPECT_EQ(
1089          0,
1090          Distance(p, Type<Span<int8_t>>(L::Partial(1).Slice<int8_t>(p)).data()));
1091      EXPECT_EQ(
1092          0,
1093          Distance(p, Type<Span<int8_t>>(L::Partial(5).Slice<int8_t>(p)).data()));
1094      EXPECT_EQ(
1095          0,
1096          Distance(p,
1097                   Type<Span<int8_t>>(L::Partial(0, 0).Slice<int8_t>(p)).data()));
1098      EXPECT_EQ(
1099          0,
1100          Distance(
1101              p, Type<Span<int32_t>>(L::Partial(0, 0).Slice<int32_t>(p)).data()));
1102      EXPECT_EQ(
1103          0,
1104          Distance(p,
1105                   Type<Span<int8_t>>(L::Partial(1, 0).Slice<int8_t>(p)).data()));
1106      EXPECT_EQ(
1107          4,
1108          Distance(
1109              p, Type<Span<int32_t>>(L::Partial(1, 0).Slice<int32_t>(p)).data()));
1110      EXPECT_EQ(
1111          0,
1112          Distance(p,
1113                   Type<Span<int8_t>>(L::Partial(5, 3).Slice<int8_t>(p)).data()));
1114      EXPECT_EQ(
1115          8,
1116          Distance(
1117              p, Type<Span<int32_t>>(L::Partial(5, 3).Slice<int32_t>(p)).data()));
1118      EXPECT_EQ(
1119          0,
1120          Distance(
1121              p,
1122              Type<Span<int8_t>>(L::Partial(0, 0, 0).Slice<int8_t>(p)).data()));
1123      EXPECT_EQ(
1124          0,
1125          Distance(
1126              p,
1127              Type<Span<int32_t>>(L::Partial(0, 0, 0).Slice<int32_t>(p)).data()));
1128      EXPECT_EQ(
1129          0,
1130          Distance(
1131              p,
1132              Type<Span<Int128>>(L::Partial(0, 0, 0).Slice<Int128>(p)).data()));
1133      EXPECT_EQ(
1134          0,
1135          Distance(
1136              p,
1137              Type<Span<int8_t>>(L::Partial(1, 0, 0).Slice<int8_t>(p)).data()));
1138      EXPECT_EQ(
1139          4,
1140          Distance(
1141              p,
1142              Type<Span<int32_t>>(L::Partial(1, 0, 0).Slice<int32_t>(p)).data()));
1143      EXPECT_EQ(
1144          8,
1145          Distance(
1146              p,
1147              Type<Span<Int128>>(L::Partial(1, 0, 0).Slice<Int128>(p)).data()));
1148      EXPECT_EQ(
1149          0,
1150          Distance(
1151              p,
1152              Type<Span<int8_t>>(L::Partial(5, 3, 1).Slice<int8_t>(p)).data()));
1153      EXPECT_EQ(
1154          24,
1155          Distance(
1156              p,
1157              Type<Span<Int128>>(L::Partial(5, 3, 1).Slice<Int128>(p)).data()));
1158      EXPECT_EQ(
1159          8,
1160          Distance(
1161              p,
1162              Type<Span<int32_t>>(L::Partial(5, 3, 1).Slice<int32_t>(p)).data()));
1163      EXPECT_EQ(
1164          0, Distance(p, Type<Span<int8_t>>(L(5, 3, 1).Slice<int8_t>(p)).data()));
1165      EXPECT_EQ(
1166          24,
1167          Distance(p, Type<Span<Int128>>(L(5, 3, 1).Slice<Int128>(p)).data()));
1168      EXPECT_EQ(
1169          8,
1170          Distance(p, Type<Span<int32_t>>(L(5, 3, 1).Slice<int32_t>(p)).data()));
1171    }
1172  }
1173  MATCHER_P(IsSameSlice, slice, "") {
1174    return arg.size() == slice.size() && arg.data() == slice.data();
1175  }
1176  template <typename... M>
1177  class TupleMatcher {
1178   public:
1179    explicit TupleMatcher(M... matchers) : matchers_(std::move(matchers)...) {}
1180    template <typename Tuple>
1181    bool MatchAndExplain(const Tuple& p,
1182                         testing::MatchResultListener* &bsol;* listener */) const {
1183      static_assert(std::tuple_size<Tuple>::value == sizeof...(M), "");
1184      return MatchAndExplainImpl(
1185          p, absl::make_index_sequence<std::tuple_size<Tuple>::value>{});
1186    }
1187    void DescribeTo(::std::ostream* os) const {}
1188    void DescribeNegationTo(::std::ostream* os) const {}
1189   private:
1190    template <typename Tuple, size_t... Is>
1191    bool MatchAndExplainImpl(const Tuple& p, absl::index_sequence<Is...>) const {
1192      return std::min(
1193          {true, testing::SafeMatcherCast<
1194                     const typename std::tuple_element<Is, Tuple>::type&>(
1195                     std::get<Is>(matchers_))
1196                     .Matches(std::get<Is>(p))...});
1197    }
1198    std::tuple<M...> matchers_;
1199  };
1200  template <typename... M>
1201  testing::PolymorphicMatcher<TupleMatcher<M...>> Tuple(M... matchers) {
1202    return testing::MakePolymorphicMatcher(
1203        TupleMatcher<M...>(std::move(matchers)...));
1204  }
1205  TEST(Layout, Slices) {
1206    alignas(max_align_t) const unsigned char p[100] = {0};
1207    using L = Layout<int8_t, int8_t, Int128>;
1208    {
1209      const auto x = L::Partial();
1210      EXPECT_THAT(Type<std::tuple<>>(x.Slices(p)), Tuple());
1211    }
1212    {
1213      const auto x = L::Partial(1);
1214      EXPECT_THAT(Type<std::tuple<Span<const int8_t>>>(x.Slices(p)),
1215                  Tuple(IsSameSlice(x.Slice<0>(p))));
1216    }
1217    {
1218      const auto x = L::Partial(1, 2);
1219      EXPECT_THAT(
1220          (Type<std::tuple<Span<const int8_t>, Span<const int8_t>>>(x.Slices(p))),
1221          Tuple(IsSameSlice(x.Slice<0>(p)), IsSameSlice(x.Slice<1>(p))));
1222    }
1223    {
1224      const auto x = L::Partial(1, 2, 3);
1225      EXPECT_THAT((Type<std::tuple<Span<const int8_t>, Span<const int8_t>,
1226                                   Span<const Int128>>>(x.Slices(p))),
1227                  Tuple(IsSameSlice(x.Slice<0>(p)), IsSameSlice(x.Slice<1>(p)),
1228                        IsSameSlice(x.Slice<2>(p))));
1229    }
1230    {
1231      const L x(1, 2, 3);
1232      EXPECT_THAT((Type<std::tuple<Span<const int8_t>, Span<const int8_t>,
1233                                   Span<const Int128>>>(x.Slices(p))),
1234                  Tuple(IsSameSlice(x.Slice<0>(p)), IsSameSlice(x.Slice<1>(p)),
1235                        IsSameSlice(x.Slice<2>(p))));
1236    }
1237  }
1238  TEST(Layout, MutableSlices) {
1239    alignas(max_align_t) unsigned char p[100] = {0};
1240    using L = Layout<int8_t, int8_t, Int128>;
1241    {
1242      const auto x = L::Partial();
1243      EXPECT_THAT(Type<std::tuple<>>(x.Slices(p)), Tuple());
1244    }
1245    {
1246      const auto x = L::Partial(1);
1247      EXPECT_THAT(Type<std::tuple<Span<int8_t>>>(x.Slices(p)),
1248                  Tuple(IsSameSlice(x.Slice<0>(p))));
1249    }
1250    {
1251      const auto x = L::Partial(1, 2);
1252      EXPECT_THAT((Type<std::tuple<Span<int8_t>, Span<int8_t>>>(x.Slices(p))),
1253                  Tuple(IsSameSlice(x.Slice<0>(p)), IsSameSlice(x.Slice<1>(p))));
1254    }
1255    {
1256      const auto x = L::Partial(1, 2, 3);
1257      EXPECT_THAT((Type<std::tuple<Span<int8_t>, Span<int8_t>, Span<Int128>>>(
1258                      x.Slices(p))),
1259                  Tuple(IsSameSlice(x.Slice<0>(p)), IsSameSlice(x.Slice<1>(p)),
1260                        IsSameSlice(x.Slice<2>(p))));
1261    }
1262    {
1263      const L x(1, 2, 3);
1264      EXPECT_THAT((Type<std::tuple<Span<int8_t>, Span<int8_t>, Span<Int128>>>(
1265                      x.Slices(p))),
1266                  Tuple(IsSameSlice(x.Slice<0>(p)), IsSameSlice(x.Slice<1>(p)),
1267                        IsSameSlice(x.Slice<2>(p))));
1268    }
1269  }
1270  TEST(Layout, UnalignedTypes) {
1271    constexpr Layout<unsigned char, unsigned char, unsigned char> x(1, 2, 3);
1272    alignas(max_align_t) unsigned char p[x.AllocSize() + 1];
1273    EXPECT_THAT(x.Pointers(p + 1), Tuple(p + 1, p + 2, p + 4));
1274  }
1275  TEST(Layout, CustomAlignment) {
1276    constexpr Layout<unsigned char, Aligned<unsigned char, 8>> x(1, 2);
1277    alignas(max_align_t) unsigned char p[x.AllocSize()];
1278    EXPECT_EQ(10, x.AllocSize());
1279    EXPECT_THAT(x.Pointers(p), Tuple(p + 0, p + 8));
1280  }
1281  TEST(Layout, OverAligned) {
1282    constexpr size_t M = alignof(max_align_t);
1283    constexpr Layout<unsigned char, Aligned<unsigned char, 2 * M>> x(1, 3);
1284  #ifdef __GNUC__
1285    __attribute__((aligned(2 * M))) unsigned char p[x.AllocSize()];
1286  #else
1287    alignas(2 * M) unsigned char p[x.AllocSize()];
1288  #endif
1289    EXPECT_EQ(2 * M + 3, x.AllocSize());
1290    EXPECT_THAT(x.Pointers(p), Tuple(p + 0, p + 2 * M));
1291  }
1292  TEST(Layout, Alignment) {
1293    static_assert(Layout<int8_t>::Alignment() == 1, "");
1294    static_assert(Layout<int32_t>::Alignment() == 4, "");
1295    static_assert(Layout<Int64>::Alignment() == 8, "");
1296    static_assert(Layout<Aligned<int8_t, 64>>::Alignment() == 64, "");
1297    static_assert(Layout<int8_t, int32_t, Int64>::Alignment() == 8, "");
1298    static_assert(Layout<int8_t, Int64, int32_t>::Alignment() == 8, "");
1299    static_assert(Layout<int32_t, int8_t, Int64>::Alignment() == 8, "");
1300    static_assert(Layout<int32_t, Int64, int8_t>::Alignment() == 8, "");
1301    static_assert(Layout<Int64, int8_t, int32_t>::Alignment() == 8, "");
1302    static_assert(Layout<Int64, int32_t, int8_t>::Alignment() == 8, "");
1303  }
1304  TEST(Layout, ConstexprPartial) {
1305    constexpr size_t M = alignof(max_align_t);
1306    constexpr Layout<unsigned char, Aligned<unsigned char, 2 * M>> x(1, 3);
1307    static_assert(x.Partial(1).template Offset<1>() == 2 * M, "");
1308  }
1309  struct Region {
1310    size_t from;
1311    size_t to;
1312  };
1313  void ExpectRegionPoisoned(const unsigned char* p, size_t n, bool poisoned) {
1314  #ifdef ABSL_HAVE_ADDRESS_SANITIZER
1315    for (size_t i = 0; i != n; ++i) {
1316      EXPECT_EQ(poisoned, __asan_address_is_poisoned(p + i));
1317    }
1318  #endif
1319  }
1320  template <size_t N>
1321  void ExpectPoisoned(const unsigned char (&buf)[N],
1322                      std::initializer_list<Region> reg) {
1323    size_t prev = 0;
1324    for (const Region& r : reg) {
1325      ExpectRegionPoisoned(buf + prev, r.from - prev, false);
1326      ExpectRegionPoisoned(buf + r.from, r.to - r.from, true);
1327      prev = r.to;
1328    }
1329    ExpectRegionPoisoned(buf + prev, N - prev, false);
1330  }
1331  TEST(Layout, PoisonPadding) {
1332    using L = Layout<int8_t, Int64, int32_t, Int128>;
1333    constexpr size_t n = L::Partial(1, 2, 3, 4).AllocSize();
1334    {
1335      constexpr auto x = L::Partial();
1336      alignas(max_align_t) const unsigned char c[n] = {};
1337      x.PoisonPadding(c);
1338      EXPECT_EQ(x.Slices(c), x.Slices(c));
1339      ExpectPoisoned(c, {});
1340    }
1341    {
1342      constexpr auto x = L::Partial(1);
1343      alignas(max_align_t) const unsigned char c[n] = {};
1344      x.PoisonPadding(c);
1345      EXPECT_EQ(x.Slices(c), x.Slices(c));
1346      ExpectPoisoned(c, {{1, 8}});
1347    }
1348    {
1349      constexpr auto x = L::Partial(1, 2);
1350      alignas(max_align_t) const unsigned char c[n] = {};
1351      x.PoisonPadding(c);
1352      EXPECT_EQ(x.Slices(c), x.Slices(c));
1353      ExpectPoisoned(c, {{1, 8}});
1354    }
1355    {
1356      constexpr auto x = L::Partial(1, 2, 3);
1357      alignas(max_align_t) const unsigned char c[n] = {};
1358      x.PoisonPadding(c);
1359      EXPECT_EQ(x.Slices(c), x.Slices(c));
1360      ExpectPoisoned(c, {{1, 8}, {36, 40}});
1361    }
1362    {
1363      constexpr auto x = L::Partial(1, 2, 3, 4);
1364      alignas(max_align_t) const unsigned char c[n] = {};
1365      x.PoisonPadding(c);
1366      EXPECT_EQ(x.Slices(c), x.Slices(c));
1367      ExpectPoisoned(c, {{1, 8}, {36, 40}});
1368    }
1369    {
1370      constexpr L x(1, 2, 3, 4);
1371      alignas(max_align_t) const unsigned char c[n] = {};
1372      x.PoisonPadding(c);
1373      EXPECT_EQ(x.Slices(c), x.Slices(c));
1374      ExpectPoisoned(c, {{1, 8}, {36, 40}});
1375    }
1376  }
1377  TEST(Layout, DebugString) {
1378    {
1379      constexpr auto x = Layout<int8_t, int32_t, int8_t, Int128>::Partial();
1380      EXPECT_EQ("@0<signed char>(1)", x.DebugString());
1381    }
1382    {
1383      constexpr auto x = Layout<int8_t, int32_t, int8_t, Int128>::Partial(1);
1384      EXPECT_EQ("@0<signed char>(1)[1]; @4<int>(4)", x.DebugString());
1385    }
1386    {
1387      constexpr auto x = Layout<int8_t, int32_t, int8_t, Int128>::Partial(1, 2);
1388      EXPECT_EQ("@0<signed char>(1)[1]; @4<int>(4)[2]; @12<signed char>(1)",
1389                x.DebugString());
1390    }
1391    {
1392      constexpr auto x =
1393          Layout<int8_t, int32_t, int8_t, Int128>::Partial(1, 2, 3);
1394      EXPECT_EQ(
1395          "@0<signed char>(1)[1]; @4<int>(4)[2]; @12<signed char>(1)[3]; "
1396          "@16" +
1397              Int128::Name() + "(16)",
1398          x.DebugString());
1399    }
1400    {
1401      constexpr auto x =
1402          Layout<int8_t, int32_t, int8_t, Int128>::Partial(1, 2, 3, 4);
1403      EXPECT_EQ(
1404          "@0<signed char>(1)[1]; @4<int>(4)[2]; @12<signed char>(1)[3]; "
1405          "@16" +
1406              Int128::Name() + "(16)[4]",
1407          x.DebugString());
1408    }
1409    {
1410      constexpr Layout<int8_t, int32_t, int8_t, Int128> x(1, 2, 3, 4);
1411      EXPECT_EQ(
1412          "@0<signed char>(1)[1]; @4<int>(4)[2]; @12<signed char>(1)[3]; "
1413          "@16" +
1414              Int128::Name() + "(16)[4]",
1415          x.DebugString());
1416    }
1417  }
1418  TEST(Layout, CharTypes) {
1419    constexpr Layout<int32_t> x(1);
1420    alignas(max_align_t) char c[x.AllocSize()] = {};
1421    alignas(max_align_t) unsigned char uc[x.AllocSize()] = {};
1422    alignas(max_align_t) signed char sc[x.AllocSize()] = {};
1423    alignas(max_align_t) const char cc[x.AllocSize()] = {};
1424    alignas(max_align_t) const unsigned char cuc[x.AllocSize()] = {};
1425    alignas(max_align_t) const signed char csc[x.AllocSize()] = {};
1426    Type<int32_t*>(x.Pointer<0>(c));
1427    Type<int32_t*>(x.Pointer<0>(uc));
1428    Type<int32_t*>(x.Pointer<0>(sc));
1429    Type<const int32_t*>(x.Pointer<0>(cc));
1430    Type<const int32_t*>(x.Pointer<0>(cuc));
1431    Type<const int32_t*>(x.Pointer<0>(csc));
1432    Type<int32_t*>(x.Pointer<int32_t>(c));
1433    Type<int32_t*>(x.Pointer<int32_t>(uc));
1434    Type<int32_t*>(x.Pointer<int32_t>(sc));
1435    Type<const int32_t*>(x.Pointer<int32_t>(cc));
1436    Type<const int32_t*>(x.Pointer<int32_t>(cuc));
1437    Type<const int32_t*>(x.Pointer<int32_t>(csc));
1438    Type<std::tuple<int32_t*>>(x.Pointers(c));
1439    Type<std::tuple<int32_t*>>(x.Pointers(uc));
1440    Type<std::tuple<int32_t*>>(x.Pointers(sc));
1441    Type<std::tuple<const int32_t*>>(x.Pointers(cc));
1442    Type<std::tuple<const int32_t*>>(x.Pointers(cuc));
1443    Type<std::tuple<const int32_t*>>(x.Pointers(csc));
1444    Type<Span<int32_t>>(x.Slice<0>(c));
1445    Type<Span<int32_t>>(x.Slice<0>(uc));
1446    Type<Span<int32_t>>(x.Slice<0>(sc));
1447    Type<Span<const int32_t>>(x.Slice<0>(cc));
1448    Type<Span<const int32_t>>(x.Slice<0>(cuc));
1449    Type<Span<const int32_t>>(x.Slice<0>(csc));
1450    Type<std::tuple<Span<int32_t>>>(x.Slices(c));
<span onclick='openModal()' class='match'>1451    Type<std::tuple<Span<int32_t>>>(x.Slices(uc));
1452    Type<std::tuple<Span<int32_t>>>(x.Slices(sc));
</span>1453    Type<std::tuple<Span<const int32_t>>>(x.Slices(cc));
1454    Type<std::tuple<Span<const int32_t>>>(x.Slices(cuc));
1455    Type<std::tuple<Span<const int32_t>>>(x.Slices(csc));
1456  }
1457  TEST(Layout, ConstElementType) {
1458    constexpr Layout<const int32_t> x(1);
1459    alignas(int32_t) char c[x.AllocSize()] = {};
1460    const char* cc = c;
1461    const int32_t* p = reinterpret_cast<const int32_t*>(cc);
1462    EXPECT_EQ(alignof(int32_t), x.Alignment());
1463    EXPECT_EQ(0, x.Offset<0>());
1464    EXPECT_EQ(0, x.Offset<const int32_t>());
1465    EXPECT_THAT(x.Offsets(), ElementsAre(0));
1466    EXPECT_EQ(1, x.Size<0>());
1467    EXPECT_EQ(1, x.Size<const int32_t>());
1468    EXPECT_THAT(x.Sizes(), ElementsAre(1));
1469    EXPECT_EQ(sizeof(int32_t), x.AllocSize());
1470    EXPECT_EQ(p, Type<const int32_t*>(x.Pointer<0>(c)));
1471    EXPECT_EQ(p, Type<const int32_t*>(x.Pointer<0>(cc)));
1472    EXPECT_EQ(p, Type<const int32_t*>(x.Pointer<const int32_t>(c)));
1473    EXPECT_EQ(p, Type<const int32_t*>(x.Pointer<const int32_t>(cc)));
1474    EXPECT_THAT(Type<std::tuple<const int32_t*>>(x.Pointers(c)), Tuple(p));
1475    EXPECT_THAT(Type<std::tuple<const int32_t*>>(x.Pointers(cc)), Tuple(p));
1476    EXPECT_THAT(Type<Span<const int32_t>>(x.Slice<0>(c)),
1477                IsSameSlice(Span<const int32_t>(p, 1)));
1478    EXPECT_THAT(Type<Span<const int32_t>>(x.Slice<0>(cc)),
1479                IsSameSlice(Span<const int32_t>(p, 1)));
1480    EXPECT_THAT(Type<Span<const int32_t>>(x.Slice<const int32_t>(c)),
1481                IsSameSlice(Span<const int32_t>(p, 1)));
1482    EXPECT_THAT(Type<Span<const int32_t>>(x.Slice<const int32_t>(cc)),
1483                IsSameSlice(Span<const int32_t>(p, 1)));
1484    EXPECT_THAT(Type<std::tuple<Span<const int32_t>>>(x.Slices(c)),
1485                Tuple(IsSameSlice(Span<const int32_t>(p, 1))));
1486    EXPECT_THAT(Type<std::tuple<Span<const int32_t>>>(x.Slices(cc)),
1487                Tuple(IsSameSlice(Span<const int32_t>(p, 1))));
1488  }
1489  namespace example {
1490  class CompactString {
1491   public:
1492    CompactString(const char* s = "") {  
1493      const size_t size = strlen(s);
1494      const L layout(1, size + 1);
1495      p_.reset(new unsigned char[layout.AllocSize()]);
1496      layout.PoisonPadding(p_.get());
1497      *layout.Pointer<size_t>(p_.get()) = size;
1498      memcpy(layout.Pointer<char>(p_.get()), s, size + 1);
1499    }
1500    size_t size() const {
1501      return *L::Partial().Pointer<size_t>(p_.get());
1502    }
1503    const char* c_str() const {
1504      return L::Partial(1).Pointer<char>(p_.get());
1505    }
1506   private:
1507    using L = Layout<size_t, char>;
1508    std::unique_ptr<unsigned char[]> p_;
1509  };
1510  TEST(CompactString, Works) {
1511    CompactString s = "hello";
1512    EXPECT_EQ(5, s.size());
1513    EXPECT_STREQ("hello", s.c_str());
1514  }
1515  }  
1516  }  
1517  }  
1518  ABSL_NAMESPACE_END
1519  }  
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-layout_test.cc</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from abseil-cpp-MDEwOlJlcG9zaXRvcnkxMDQyMzE1NDE=-flat-layout_test.cc</div>
                </div>
                <div class="column column_space"><pre><code>1452    Type<std::tuple<Span<int32_t>>>(x.Slices(sc));
1453    Type<std::tuple<Span<const int32_t>>>(x.Slices(cc));
</pre></code></div>
                <div class="column column_space"><pre><code>1451    Type<std::tuple<Span<int32_t>>>(x.Slices(uc));
1452    Type<std::tuple<Span<int32_t>>>(x.Slices(sc));
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    