<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for zip.c &amp; unzip.c</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for zip.c &amp; unzip.c
      </h3>
<h1 align="center">
        21.1%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>zip.c (20.0%)<th>unzip.c (22.392414%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(342-469)<td><a href="#" name="0">(193-346)</a><td align="center"><font color="#ff0000">108</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(478-584)<td><a href="#" name="1">(412-522)</a><td align="center"><font color="#c60000">84</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(683-735)<td><a href="#" name="2">(631-684)</a><td align="center"><font color="#420000">28</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(592-638)<td><a href="#" name="3">(528-573)</a><td align="center"><font color="#420000">28</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(933-948)<td><a href="#" name="4">(780-793)</a><td align="center"><font color="#2a0000">18</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(1781-1804)<td><a href="#" name="5">(941-964)</a><td align="center"><font color="#250000">16</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(921-932)<td><a href="#" name="6">(767-778)</a><td align="center"><font color="#1e0000">13</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(1013-1027)<td><a href="#" name="7">(1043-1056)</a><td align="center"><font color="#1c0000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>zip.c</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 #include &lt;stdio.h&gt;
2 #include &lt;stdlib.h&gt;
3 #include &lt;string.h&gt;
4 #include &lt;time.h&gt;
5 #include "zlib.h"
6 #include "zip.h"
7 #ifdef STDC
8 #  include &lt;stddef.h&gt;
9 #  include &lt;string.h&gt;
10 #  include &lt;stdlib.h&gt;
11 #endif
12 #ifdef NO_ERRNO_H
13     extern int errno;
14 #else
15 #   include &lt;errno.h&gt;
16 #endif
17 #ifndef local
18 #  define local static
19 #endif
20 #ifndef VERSIONMADEBY
21 # define VERSIONMADEBY   (0x0) #endif
22 #ifndef Z_BUFSIZE
23 #define Z_BUFSIZE (64*1024) //(16384)
24 #endif
25 #ifndef Z_MAXFILENAMEINZIP
26 #define Z_MAXFILENAMEINZIP (256)
27 #endif
28 #ifndef ALLOC
29 # define ALLOC(size) (malloc(size))
30 #endif
31 #ifndef TRYFREE
32 # define TRYFREE(p) {if (p) free(p);}
33 #endif
34 #define MAKEULONG64(a, b) ((ZPOS64_T)(((unsigned long)(a)) | ((ZPOS64_T)((unsigned long)(b))) &lt;&lt; 32))
35 #ifndef SEEK_CUR
36 #define SEEK_CUR    1
37 #endif
38 #ifndef SEEK_END
39 #define SEEK_END    2
40 #endif
41 #ifndef SEEK_SET
42 #define SEEK_SET    0
43 #endif
44 #ifndef DEF_MEM_LEVEL
45 #if MAX_MEM_LEVEL &gt;= 8
46 #  define DEF_MEM_LEVEL 8
47 #else
48 #  define DEF_MEM_LEVEL  MAX_MEM_LEVEL
49 #endif
50 #endif
51 const char zip_copyright[] =" zip 1.01 Copyright 1998-2004 Gilles Vollant - http://www.winimage.com/zLibDll";
52 #define SIZEDATA_INDATABLOCK (4096-(4*4))
53 #define LOCALHEADERMAGIC    (0x04034b50)
54 #define CENTRALHEADERMAGIC  (0x02014b50)
55 #define ENDHEADERMAGIC      (0x06054b50)
56 #define ZIP64ENDHEADERMAGIC      (0x6064b50)
57 #define ZIP64ENDLOCHEADERMAGIC   (0x7064b50)
58 #define FLAG_LOCALHEADER_OFFSET (0x06)
59 #define CRC_LOCALHEADER_OFFSET  (0x0e)
60 #define SIZECENTRALHEADER (0x2e) 
61 typedef struct linkedlist_datablock_internal_s
62 {
63   struct linkedlist_datablock_internal_s* next_datablock;
64   uLong  avail_in_this_block;
65   uLong  filled_in_this_block;
66   uLong  unused;   unsigned char data[SIZEDATA_INDATABLOCK];
67 } linkedlist_datablock_internal;
68 typedef struct linkedlist_data_s
69 {
70     linkedlist_datablock_internal* first_block;
71     linkedlist_datablock_internal* last_block;
72 } linkedlist_data;
73 typedef struct
74 {
75     z_stream stream;            #ifdef HAVE_BZIP2
76     bz_stream bstream;          #endif
77     int  stream_initialised;        uInt pos_in_buffered_data;  
78     char* central_header;           uLong size_centralExtra;
79     uLong size_centralheader;       uLong size_centralExtraFree;     uLong flag;                 
80     uLong dosDate;
81     uLong crc32;
82     int  encrypt;
83     int  zip64;                   ZPOS64_T pos_zip64extrainfo;
84     ZPOS64_T totalCompressedData;
85     ZPOS64_T totalUncompressedData;
86 #ifndef NOCRYPT
87     unsigned long keys[3];         const z_crc_t* pcrc_32_tab;
88     int crypt_header_size;
89 #endif
90 } curfile64_info;
91 typedef struct
92 {
93     zlib_filefunc64_32_def z_filefunc;
94     curfile64_info ci;            
95     ZPOS64_T begin_pos;                ZPOS64_T add_position_when_writting_offset;
96     ZPOS64_T number_entry;
97 #ifndef NO_ADDFILEINEXISTINGZIP
98     char *globalcomment;
99 #endif
100 } zip64_internal;
101 #ifndef NOCRYPT
102 #define INCLUDECRYPTINGCODE_IFCRYPTALLOWED
103 #include "crypt.h"
104 #endif
105 local linkedlist_datablock_internal* allocate_new_datablock()
106 {
107     linkedlist_datablock_internal* ldi;
108     ldi = (linkedlist_datablock_internal*)
109                  ALLOC(sizeof(linkedlist_datablock_internal));
110     if (ldi!=NULL)
111     {
112         ldi-&gt;next_datablock = NULL ;
113         ldi-&gt;filled_in_this_block = 0 ;
114         ldi-&gt;avail_in_this_block = SIZEDATA_INDATABLOCK ;
115     }
116     return ldi;
117 }
118 local void free_datablock(linkedlist_datablock_internal* ldi)
119 {
120     while (ldi!=NULL)
121     {
122         linkedlist_datablock_internal* ldinext = ldi-&gt;next_datablock;
123         TRYFREE(ldi);
124         ldi = ldinext;
125     }
126 }
127 local void init_linkedlist(linkedlist_data* ll)
128 {
129     ll-&gt;first_block = ll-&gt;last_block = NULL;
130 }
131 local void free_linkedlist(linkedlist_data* ll)
132 {
133     free_datablock(ll-&gt;first_block);
134     ll-&gt;first_block = ll-&gt;last_block = NULL;
135 }
136 local int add_data_in_datablock(linkedlist_data* ll, const void* buf, uLong len)
137 {
138     linkedlist_datablock_internal* ldi;
139     const unsigned char* from_copy;
140     if (ll==NULL)
141         return ZIP_INTERNALERROR;
142     if (ll-&gt;last_block == NULL)
143     {
144         ll-&gt;first_block = ll-&gt;last_block = allocate_new_datablock();
145         if (ll-&gt;first_block == NULL)
146             return ZIP_INTERNALERROR;
147     }
148     ldi = ll-&gt;last_block;
149     from_copy = (unsigned char*)buf;
150     while (len&gt;0)
151     {
152         uInt copy_this;
153         uInt i;
154         unsigned char* to_copy;
155         if (ldi-&gt;avail_in_this_block==0)
156         {
157             ldi-&gt;next_datablock = allocate_new_datablock();
158             if (ldi-&gt;next_datablock == NULL)
159                 return ZIP_INTERNALERROR;
160             ldi = ldi-&gt;next_datablock ;
161             ll-&gt;last_block = ldi;
162         }
163         if (ldi-&gt;avail_in_this_block &lt; len)
164             copy_this = (uInt)ldi-&gt;avail_in_this_block;
165         else
166             copy_this = (uInt)len;
167         to_copy = &amp;(ldi-&gt;data[ldi-&gt;filled_in_this_block]);
168         for (i=0;i&lt;copy_this;i++)
169             *(to_copy+i)=*(from_copy+i);
170         ldi-&gt;filled_in_this_block += copy_this;
171         ldi-&gt;avail_in_this_block -= copy_this;
172         from_copy += copy_this ;
173         len -= copy_this;
174     }
175     return ZIP_OK;
176 }
177 #ifndef NO_ADDFILEINEXISTINGZIP
178 local int zip64local_putValue OF((const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream, ZPOS64_T x, int nbByte));
179 local int zip64local_putValue (const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream, ZPOS64_T x, int nbByte)
180 {
181     unsigned char buf[8];
182     int n;
183     for (n = 0; n &lt; nbByte; n++)
184     {
185         buf[n] = (unsigned char)(x &amp; 0xff);
186         x &gt;&gt;= 8;
187     }
188     if (x != 0)
189       {           for (n = 0; n &lt; nbByte; n++)
190         {
191           buf[n] = 0xff;
192         }
193       }
194     if (ZWRITE64(*pzlib_filefunc_def,filestream,buf,nbByte)!=(uLong)nbByte)
195         return ZIP_ERRNO;
196     else
197         return ZIP_OK;
198 }
199 local void zip64local_putValue_inmemory OF((void* dest, ZPOS64_T x, int nbByte));
200 local void zip64local_putValue_inmemory (void* dest, ZPOS64_T x, int nbByte)
201 {
202     unsigned char* buf=(unsigned char*)dest;
203     int n;
204     for (n = 0; n &lt; nbByte; n++) {
205         buf[n] = (unsigned char)(x &amp; 0xff);
206         x &gt;&gt;= 8;
207     }
208     if (x != 0)
209     {            for (n = 0; n &lt; nbByte; n++)
210        {
211           buf[n] = 0xff;
212        }
213     }
214 }
215 local uLong zip64local_TmzDateToDosDate(const tm_zip* ptm)
216 {
217     uLong year = (uLong)ptm-&gt;tm_year;
218     if (year&gt;=1980)
219         year-=1980;
220     else if (year&gt;=80)
221         year-=80;
222 <a name="0"></a>    return
223       (uLong) (((ptm-&gt;tm_mday) + (32 * (ptm-&gt;tm_mon+1)) + (512 * year)) &lt;&lt; 16) |
224         ((ptm-&gt;tm_sec/2) + (32* ptm-&gt;tm_min) + (2048 * (uLong)ptm-&gt;tm_hour));
225 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
226 local int zip64local_getByte OF((const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream, int *pi));
227 local int zip64local_getByte(const zlib_filefunc64_32_def* pzlib_filefunc_def,voidpf filestream,int* pi)
228 {
229     unsigned char c;
230     int err = (int)ZREAD64(*pzlib_filefunc_def,filestream,&amp;c,1);
231     if (err==1)
232     {
233         *pi = (int)c;
234         return ZIP_OK;
235     }
236     else
237     {
238         if (ZERROR64(*pzlib_filefunc_def,filestream))
239             return ZIP_ERRNO;
240         else
241             return ZIP_EOF;
242     }
243 }
244 local int zip64local_getShort OF((const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream, uLong *pX));
245 local int zip64local_getShort (const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream, uLong* pX)
246 {
247     uLong x ;
248     int i = 0;
249     int err;
250     err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
251     x = (uLong)i;
252     if (err==ZIP_OK)
253         err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
254     x += ((uLong)i)&lt;&lt;8;
255     if (err==ZIP_OK)
256         *pX = x;
257     else
258         *pX = 0;
259     return err;
260 }
261 local int zip64local_getLong OF((const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream, uLong *pX));
262 local int zip64local_getLong (const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream, uLong* pX)
263 {
264     uLong x ;
265     int i = 0;
266     int err;
267     err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
268     x = (uLong)i;
269     if (err==ZIP_OK)
270         err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
271     x += ((uLong)i)&lt;&lt;8;
272     if (err==ZIP_OK)
273         err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
274     x += ((uLong)i)&lt;&lt;16;
275     if (err==ZIP_OK)
276         err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
277     x += ((uLong)i)&lt;&lt;24;
278     if (err==ZIP_OK)
279         *pX = x;
280     else
281         *pX = 0;
282     return err;
283 }
284 local int zip64local_getLong64 OF((const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream, ZPOS64_T *pX));
285 local int zip64local_getLong64 (const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream, ZPOS64_T *pX)
286 {
287   ZPOS64_T x;
288   int i = 0;
289   int err;
290   err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
291   x = (ZPOS64_T)i;
292   if (err==ZIP_OK)
293     err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
294   x += ((ZPOS64_T)i)&lt;&lt;8;
295   if (err==ZIP_OK)
296     err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
297   x += ((ZPOS64_T)i)&lt;&lt;16;
298   if (err==ZIP_OK)
299     err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
300   x += ((ZPOS64_T)i)&lt;&lt;24;
301   if (err==ZIP_OK)
302     err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
303   x += ((ZPOS64_T)i)&lt;&lt;32;
304   if (err==ZIP_OK)
305     err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
306   x += ((ZPOS64_T)i)&lt;&lt;40;
307   if (err==ZIP_OK)
308     err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
309   x += ((ZPOS64_T)i)&lt;&lt;48;
310   if (err==ZIP_OK)
311     err = zip64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
312   x += ((ZPOS64_T)i)&lt;&lt;56;
313   if (err==ZIP_OK)
314     *pX = x;
315   else
316     *pX = 0;
317   return err;
318 }</b></font>
319 #ifndef BUFREADCOMMENT
320 #define BUFREADCOMMENT (0x400)
321 #endif
322 <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>local ZPOS64_T zip64local_SearchCentralDir OF((const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream));
323 local ZPOS64_T zip64local_SearchCentralDir(const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream)
324 {
325   unsigned char* buf;
326   ZPOS64_T uSizeFile;
327   ZPOS64_T uBackRead;
328   ZPOS64_T uMaxBack=0xffff;   ZPOS64_T uPosFound=0;
329   if (ZSEEK64(*pzlib_filefunc_def,filestream,0,ZLIB_FILEFUNC_SEEK_END) != 0)
330     return 0;
331   uSizeFile = ZTELL64(*pzlib_filefunc_def,filestream);
332   if (uMaxBack&gt;uSizeFile)
333     uMaxBack = uSizeFile;
334   buf = (unsigned char*)ALLOC(BUFREADCOMMENT+4);
335   if (buf==NULL)
336     return 0;
337   uBackRead = 4;
338   while (uBackRead&lt;uMaxBack)
339   {
340     uLong uReadSize;
341     ZPOS64_T uReadPos ;
342     int i;
343     if (uBackRead+BUFREADCOMMENT&gt;uMaxBack)
344       uBackRead = uMaxBack;
345     else
346       uBackRead+=BUFREADCOMMENT;
347     uReadPos = uSizeFile-uBackRead ;
348     uReadSize = ((BUFREADCOMMENT+4) &lt; (uSizeFile-uReadPos)) ?
349       (BUFREADCOMMENT+4) : (uLong)(uSizeFile-uReadPos);
350     if (ZSEEK64(*pzlib_filefunc_def,filestream,uReadPos,ZLIB_FILEFUNC_SEEK_SET)!=0)
351       break;
352     if (ZREAD64(*pzlib_filefunc_def,filestream,buf,uReadSize)!=uReadSize)
353       break;
354     for (i=(int)uReadSize-3; (i--)&gt;0;)
355       if (((*(buf+i))==0x50) &amp;&amp; ((*(buf+i+1))==0x4b) &amp;&amp;
356         ((*(buf+i+2))==0x05) &amp;&amp; ((*(buf+i+3))==0x06))
357       {
358         uPosFound = uReadPos+i;
359         break;
360       }
361       if (uPosFound!=0)
362         break;
363   }
364   TRYFREE(buf);
365   return uPosFound;
366 }
367 local ZPOS64_T zip64local_SearchCentralDir64 OF((const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream));
368 local ZPOS64_T zip64local_SearchCentralDir64(const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream)
369 {
370   unsigned char* buf;
371   ZPOS64_T uSizeFile;
372   ZPOS64_T uBackRead;
373   ZPOS64_T uMaxBack=0xffff;   ZPOS64_T uPosFound=0;
374   uLong uL;
375   ZPOS64_T relativeOffset;
376   if (ZSEEK64(*pzlib_filefunc_def,filestream,0,ZLIB_FILEFUNC_SEEK_END) != 0)
377     return 0;
378   uSizeFile = ZTELL64(*pzlib_filefunc_def,filestream);
379   if (uMaxBack&gt;uSizeFile)
380     uMaxBack = uSizeFile;
381   buf = (unsigned char*)ALLOC(BUFREADCOMMENT+4);
382   if (buf==NULL)
383     return 0;
384   uBackRead = 4;
385   while (uBackRead&lt;uMaxBack)
386   {
387     uLong uReadSize;
388     ZPOS64_T uReadPos;
389     int i;
390     if (uBackRead+BUFREADCOMMENT&gt;uMaxBack)
391       uBackRead = uMaxBack;
392     else
393       uBackRead+=BUFREADCOMMENT;
394     uReadPos = uSizeFile-uBackRead ;
395     uReadSize = ((BUFREADCOMMENT+4) &lt; (uSizeFile-uReadPos)) ?
396       (BUFREADCOMMENT+4) : (uLong)(uSizeFile-uReadPos);
397     if (ZSEEK64(*pzlib_filefunc_def,filestream,uReadPos,ZLIB_FILEFUNC_SEEK_SET)!=0)
398       break;
399     if (ZREAD64(*pzlib_filefunc_def,filestream,buf,uReadSize)!=uReadSize)
400       break;
401     for (i=(int)uReadSize-3; (i--)&gt;0;)</b></font>
402     {
403       if (((*(buf+i))==0x50) &amp;&amp; ((*(buf+i+1))==0x4b) &amp;&amp; ((*(buf+i+2))==0x06) &amp;&amp; ((*(buf+i+3))==0x07))
404       {
405 <a name="3"></a>        uPosFound = uReadPos+i;
406         break;
407       }
408 <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>    }
409       if (uPosFound!=0)
410         break;
411   }
412   TRYFREE(buf);
413   if (uPosFound == 0)
414     return 0;
415   if (ZSEEK64(*pzlib_filefunc_def,filestream, uPosFound,ZLIB_FILEFUNC_SEEK_SET)!=0)
416     return 0;
417   if (zip64local_getLong(pzlib_filefunc_def,filestream,&amp;uL)!=ZIP_OK)
418     return 0;
419   if (zip64local_getLong(pzlib_filefunc_def,filestream,&amp;uL)!=ZIP_OK)
420     return 0;
421   if (uL != 0)
422     return 0;
423   if (zip64local_getLong64(pzlib_filefunc_def,filestream,&amp;relativeOffset)!=ZIP_OK)
424     return 0;
425   if (zip64local_getLong(pzlib_filefunc_def,filestream,&amp;uL)!=ZIP_OK)
426     return 0;
427   if (uL != 1)
428     return 0;
429   if (ZSEEK64(*pzlib_filefunc_def,filestream, relativeOffset,ZLIB_FILEFUNC_SEEK_SET)!=0)
430     return 0;
431   if (zip64local_getLong(pzlib_filefunc_def,filestream,&amp;uL)!=ZIP_OK)
432     return 0;
433   if (uL != 0x06064b50)     return 0;
434   return relativeOffset;
435 }</b></font>
436 int LoadCentralDirectoryRecord(zip64_internal* pziinit)
437 {
438   int err=ZIP_OK;
439   ZPOS64_T size_central_dir;       ZPOS64_T offset_central_dir;     ZPOS64_T central_pos;
440   uLong uL;
441   ZPOS64_T number_entry;
442   uLong VersionMadeBy;
443   uLong VersionNeeded;
444   uLong size_comment;
445   int hasZIP64Record = 0;
446   central_pos = zip64local_SearchCentralDir64(&amp;pziinit-&gt;z_filefunc,pziinit-&gt;filestream);
447   if(central_pos &gt; 0)
448   {
449     hasZIP64Record = 1;
450   }
451   else if(central_pos == 0)
452   {
453     central_pos = zip64local_SearchCentralDir(&amp;pziinit-&gt;z_filefunc,pziinit-&gt;filestream);
454   }
455 <a name="2"></a>  if(hasZIP64Record)
456   {
457     ZPOS64_T sizeEndOfCentralDirectory;
458 <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>    if (ZSEEK64(pziinit-&gt;z_filefunc, pziinit-&gt;filestream, central_pos, ZLIB_FILEFUNC_SEEK_SET) != 0)
459       err=ZIP_ERRNO;
460     if (zip64local_getLong(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream,&amp;uL)!=ZIP_OK)
461       err=ZIP_ERRNO;
462     if (zip64local_getLong64(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream, &amp;sizeEndOfCentralDirectory)!=ZIP_OK)
463       err=ZIP_ERRNO;
464     if (zip64local_getShort(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream, &amp;VersionMadeBy)!=ZIP_OK)
465       err=ZIP_ERRNO;
466     if (zip64local_getShort(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream, &amp;VersionNeeded)!=ZIP_OK)
467       err=ZIP_ERRNO;
468     if (zip64local_getLong(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream,&amp;number_disk)!=ZIP_OK)
469       err=ZIP_ERRNO;
470     if (zip64local_getLong(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream,&amp;number_disk_with_CD)!=ZIP_OK)
471       err=ZIP_ERRNO;
472     if (zip64local_getLong64(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream, &amp;number_entry)!=ZIP_OK)
473       err=ZIP_ERRNO;
474     if (zip64local_getLong64(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream,&amp;number_entry_CD)!=ZIP_OK)
475       err=ZIP_ERRNO;
476     if ((number_entry_CD!=number_entry) || (number_disk_with_CD!=0) || (number_disk!=0))
477       err=ZIP_BADZIPFILE;
478     if (zip64local_getLong64(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream,&amp;size_central_dir)!=ZIP_OK)
479       err=ZIP_ERRNO;
480     if (zip64local_getLong64(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream,&amp;offset_central_dir)!=ZIP_OK)
481       err=ZIP_ERRNO;
482     size_comment = 0;
483   }
484   else
485   {</b></font>
486     if (ZSEEK64(pziinit-&gt;z_filefunc, pziinit-&gt;filestream, central_pos,ZLIB_FILEFUNC_SEEK_SET)!=0)
487       err=ZIP_ERRNO;
488     if (zip64local_getLong(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream,&amp;uL)!=ZIP_OK)
489       err=ZIP_ERRNO;
490     if (zip64local_getShort(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream,&amp;number_disk)!=ZIP_OK)
491       err=ZIP_ERRNO;
492     if (zip64local_getShort(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream,&amp;number_disk_with_CD)!=ZIP_OK)
493       err=ZIP_ERRNO;
494     number_entry = 0;
495     if (zip64local_getShort(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream, &amp;uL)!=ZIP_OK)
496       err=ZIP_ERRNO;
497     else
498       number_entry = uL;
499     number_entry_CD = 0;
500     if (zip64local_getShort(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream, &amp;uL)!=ZIP_OK)
501       err=ZIP_ERRNO;
502     else
503       number_entry_CD = uL;
504     if ((number_entry_CD!=number_entry) || (number_disk_with_CD!=0) || (number_disk!=0))
505       err=ZIP_BADZIPFILE;
506     size_central_dir = 0;
507     if (zip64local_getLong(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream, &amp;uL)!=ZIP_OK)
508       err=ZIP_ERRNO;
509     else
510       size_central_dir = uL;
511     offset_central_dir = 0;
512     if (zip64local_getLong(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream, &amp;uL)!=ZIP_OK)
513       err=ZIP_ERRNO;
514     else
515       offset_central_dir = uL;
516     if (zip64local_getShort(&amp;pziinit-&gt;z_filefunc, pziinit-&gt;filestream, &amp;size_comment)!=ZIP_OK)
517       err=ZIP_ERRNO;
518   }
519   if ((central_pos&lt;offset_central_dir+size_central_dir) &amp;&amp;
520     (err==ZIP_OK))
521     err=ZIP_BADZIPFILE;
522   if (err!=ZIP_OK)
523   {
524     ZCLOSE64(pziinit-&gt;z_filefunc, pziinit-&gt;filestream);
525     return ZIP_ERRNO;
526   }
527   if (size_comment&gt;0)
528   {
529     pziinit-&gt;globalcomment = (char*)ALLOC(size_comment+1);
530     if (pziinit-&gt;globalcomment)
531     {
532       size_comment = ZREAD64(pziinit-&gt;z_filefunc, pziinit-&gt;filestream, pziinit-&gt;globalcomment,size_comment);
533       pziinit-&gt;globalcomment[size_comment]=0;
534     }
535   }
536   byte_before_the_zipfile = central_pos - (offset_central_dir+size_central_dir);
537   pziinit-&gt;add_position_when_writting_offset = byte_before_the_zipfile;
538   {
539     ZPOS64_T size_central_dir_to_read = size_central_dir;
540     size_t buf_size = SIZEDATA_INDATABLOCK;
541     void* buf_read = (void*)ALLOC(buf_size);
542     if (ZSEEK64(pziinit-&gt;z_filefunc, pziinit-&gt;filestream, offset_central_dir + byte_before_the_zipfile, ZLIB_FILEFUNC_SEEK_SET) != 0)
543       err=ZIP_ERRNO;
544     while ((size_central_dir_to_read&gt;0) &amp;&amp; (err==ZIP_OK))
545     {
546       ZPOS64_T read_this = SIZEDATA_INDATABLOCK;
547       if (read_this &gt; size_central_dir_to_read)
548         read_this = size_central_dir_to_read;
549       if (ZREAD64(pziinit-&gt;z_filefunc, pziinit-&gt;filestream,buf_read,(uLong)read_this) != read_this)
550         err=ZIP_ERRNO;
551       if (err==ZIP_OK)
552         err = add_data_in_datablock(&amp;pziinit-&gt;central_dir,buf_read, (uLong)read_this);
553       size_central_dir_to_read-=read_this;
554     }
555     TRYFREE(buf_read);
556   }
557   pziinit-&gt;begin_pos = byte_before_the_zipfile;
558   pziinit-&gt;number_entry = number_entry_CD;
559   if (ZSEEK64(pziinit-&gt;z_filefunc, pziinit-&gt;filestream, offset_central_dir+byte_before_the_zipfile,ZLIB_FILEFUNC_SEEK_SET) != 0)
560     err=ZIP_ERRNO;
561   return err;
562 }
563 extern zipFile ZEXPORT zipOpen3 (const void *pathname, int append, zipcharpc* globalcomment, zlib_filefunc64_32_def* pzlib_filefunc64_32_def)
564 {
565     zip64_internal ziinit;
566     zip64_internal* zi;
567     int err=ZIP_OK;
568     ziinit.z_filefunc.zseek32_file = NULL;
569     ziinit.z_filefunc.ztell32_file = NULL;
570     if (pzlib_filefunc64_32_def==NULL)
571         fill_fopen64_filefunc(&amp;ziinit.z_filefunc.zfile_func64);
572     else
573         ziinit.z_filefunc = *pzlib_filefunc64_32_def;
574     ziinit.filestream = ZOPEN64(ziinit.z_filefunc,
575                   pathname,
576                   (append == APPEND_STATUS_CREATE) ?
577                   (ZLIB_FILEFUNC_MODE_READ | ZLIB_FILEFUNC_MODE_WRITE | ZLIB_FILEFUNC_MODE_CREATE) :
578                     (ZLIB_FILEFUNC_MODE_READ | ZLIB_FILEFUNC_MODE_WRITE | ZLIB_FILEFUNC_MODE_EXISTING));
579     if (ziinit.filestream == NULL)
580         return NULL;
581     if (append == APPEND_STATUS_CREATEAFTER)
582         ZSEEK64(ziinit.z_filefunc,ziinit.filestream,0,SEEK_END);
583     ziinit.begin_pos = ZTELL64(ziinit.z_filefunc,ziinit.filestream);
584     ziinit.in_opened_file_inzip = 0;
585     ziinit.ci.stream_initialised = 0;
586     ziinit.number_entry = 0;
587     ziinit.add_position_when_writting_offset = 0;
588     init_linkedlist(&amp;(ziinit.central_dir));
589     zi = (zip64_internal*)ALLOC(sizeof(zip64_internal));
590     if (zi==NULL)
591     {
592         ZCLOSE64(ziinit.z_filefunc,ziinit.filestream);
593         return NULL;
594     }
595 #    ifndef NO_ADDFILEINEXISTINGZIP
596     ziinit.globalcomment = NULL;
597     if (append == APPEND_STATUS_ADDINZIP)
598     {
599       err = LoadCentralDirectoryRecord(&amp;ziinit);
600     }
601     if (globalcomment)
602     {
603       *globalcomment = ziinit.globalcomment;
604     }
605     if (err != ZIP_OK)
606     {
607 #    ifndef NO_ADDFILEINEXISTINGZIP
608         TRYFREE(ziinit.globalcomment);
609         TRYFREE(zi);
610         return NULL;
611     }
612     else
613     {
614         *zi = ziinit;
615         return (zipFile)zi;
616     }
617 <a name="6"></a>}
618 extern zipFile ZEXPORT zipOpen2 (const char *pathname, int append, zipcharpc* globalcomment, zlib_filefunc_def* pzlib_filefunc32_def)
619 <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
620     if (pzlib_filefunc32_def != NULL)
621     {
622         zlib_filefunc64_32_def zlib_filefunc64_32_def_fill;
623         fill_zlib_filefunc64_32_def_from_filefunc32(&amp;zlib_filefunc64_32_def_fill,pzlib_filefunc32_def);
624         return zipOpen3(pathname, append, globalcomment, &amp;zlib_filefunc64_32_def_fill);
625     }
626     else
627         return zipOpen3(pathname, append, globalcomment, NULL);
628 <a name="4"></a>}
629 extern zipFile ZEXPORT zipOpen2_64 (const void *pathname, int append, zipcharpc* globalcomment, zlib_filefunc64_def* pzlib_filefunc_def)</b></font>
630 <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
631     if (pzlib_filefunc_def != NULL)
632     {
633         zlib_filefunc64_32_def zlib_filefunc64_32_def_fill;
634         zlib_filefunc64_32_def_fill.zfile_func64 = *pzlib_filefunc_def;
635         zlib_filefunc64_32_def_fill.ztell32_file = NULL;
636         zlib_filefunc64_32_def_fill.zseek32_file = NULL;
637         return zipOpen3(pathname, append, globalcomment, &amp;zlib_filefunc64_32_def_fill);
638     }
639     else
640         return zipOpen3(pathname, append, globalcomment, NULL);
641 }
642 extern zipFile ZEXPORT zipOpen (const char* pathname, int append)</b></font>
643 {
644     return zipOpen3((const void*)pathname,append,NULL,NULL);
645 }
646 extern zipFile ZEXPORT zipOpen64 (const void* pathname, int append)
647 {
648     return zipOpen3(pathname,append,NULL,NULL);
649 }
650 int Write_LocalFileHeader(zip64_internal* zi, const char* filename, uInt size_extrafield_local, const void* extrafield_local)
651 {
652   int err;
653   uInt size_filename = (uInt)strlen(filename);
654   uInt size_extrafield = size_extrafield_local;
655   err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)LOCALHEADERMAGIC, 4);
656   if (err==ZIP_OK)
657   {
658     if(zi-&gt;ci.zip64)
659       err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)45,2);    else
660       err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)20,2);  }
661   if (err==ZIP_OK)
662     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)zi-&gt;ci.flag,2);
663   if (err==ZIP_OK)
664     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)zi-&gt;ci.method,2);
665   if (err==ZIP_OK)
666     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)zi-&gt;ci.dosDate,4);
667   if (err==ZIP_OK)
668     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)0,4);   if (err==ZIP_OK)
669   {
670     if(zi-&gt;ci.zip64)
671       err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)0xFFFFFFFF,4);     else
672       err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)0,4);   }
673   if (err==ZIP_OK)
674   {
675     if(zi-&gt;ci.zip64)
676       err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)0xFFFFFFFF,4);     else
677       err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)0,4);   }
678   if (err==ZIP_OK)
679     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)size_filename,2);
680   if(zi-&gt;ci.zip64)
681   {
682     size_extrafield += 20;
683   }
684 <a name="7"></a>  if (err==ZIP_OK)
685     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)size_extrafield,2);
686 <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>  if ((err==ZIP_OK) &amp;&amp; (size_filename &gt; 0))
687   {
688     if (ZWRITE64(zi-&gt;z_filefunc,zi-&gt;filestream,filename,size_filename)!=size_filename)
689       err = ZIP_ERRNO;
690   }
691   if ((err==ZIP_OK) &amp;&amp; (size_extrafield_local &gt; 0))
692   {
693     if (ZWRITE64(zi-&gt;z_filefunc, zi-&gt;filestream, extrafield_local, size_extrafield_local) != size_extrafield_local)
694       err = ZIP_ERRNO;
695   }
696   if ((err==ZIP_OK) &amp;&amp; (zi-&gt;ci.zip64))
697   {</b></font>
698       short HeaderID = 1;
699       short DataSize = 16;
700       ZPOS64_T CompressedSize = 0;
701       ZPOS64_T UncompressedSize = 0;
702       zi-&gt;ci.pos_zip64extrainfo = ZTELL64(zi-&gt;z_filefunc,zi-&gt;filestream);
703       err = zip64local_putValue(&amp;zi-&gt;z_filefunc, zi-&gt;filestream, (short)HeaderID,2);
704       err = zip64local_putValue(&amp;zi-&gt;z_filefunc, zi-&gt;filestream, (short)DataSize,2);
705       err = zip64local_putValue(&amp;zi-&gt;z_filefunc, zi-&gt;filestream, (ZPOS64_T)UncompressedSize,8);
706       err = zip64local_putValue(&amp;zi-&gt;z_filefunc, zi-&gt;filestream, (ZPOS64_T)CompressedSize,8);
707   }
708   return err;
709 }
710 extern int ZEXPORT zipOpenNewFileInZip4_64 (zipFile file, const char* filename, const zip_fileinfo* zipfi,
711                                          const void* extrafield_local, uInt size_extrafield_local,
712                                          const void* extrafield_global, uInt size_extrafield_global,
713                                          const char* comment, int method, int level, int raw,
714                                          int windowBits,int memLevel, int strategy,
715                                          const char* password, uLong crcForCrypting,
716                                          uLong versionMadeBy, uLong flagBase, int zip64)
717 {
718     zip64_internal* zi;
719     uInt size_filename;
720     uInt size_comment;
721     uInt i;
722     int err = ZIP_OK;
723 #    ifdef NOCRYPT
724     (crcForCrypting);
725     if (password != NULL)
726         return ZIP_PARAMERROR;
727 #    endif
728     if (file == NULL)
729         return ZIP_PARAMERROR;
730 #ifdef HAVE_BZIP2
731     if ((method!=0) &amp;&amp; (method!=Z_DEFLATED) &amp;&amp; (method!=Z_BZIP2ED))
732       return ZIP_PARAMERROR;
733 #else
734     if ((method!=0) &amp;&amp; (method!=Z_DEFLATED))
735       return ZIP_PARAMERROR;
736 #endif
737     zi = (zip64_internal*)file;
738     if (zi-&gt;in_opened_file_inzip == 1)
739     {
740         err = zipCloseFileInZip (file);
741         if (err != ZIP_OK)
742             return err;
743     }
744     if (filename==NULL)
745         filename="-";
746     if (comment==NULL)
747         size_comment = 0;
748     else
749         size_comment = (uInt)strlen(comment);
750     size_filename = (uInt)strlen(filename);
751     if (zipfi == NULL)
752         zi-&gt;ci.dosDate = 0;
753     else
754     {
755         if (zipfi-&gt;dosDate != 0)
756             zi-&gt;ci.dosDate = zipfi-&gt;dosDate;
757         else
758           zi-&gt;ci.dosDate = zip64local_TmzDateToDosDate(&amp;zipfi-&gt;tmz_date);
759     }
760     zi-&gt;ci.flag = flagBase;
761     if ((level==8) || (level==9))
762       zi-&gt;ci.flag |= 2;
763     if (level==2)
764       zi-&gt;ci.flag |= 4;
765     if (level==1)
766       zi-&gt;ci.flag |= 6;
767     if (password != NULL)
768       zi-&gt;ci.flag |= 1;
769     zi-&gt;ci.crc32 = 0;
770     zi-&gt;ci.method = method;
771     zi-&gt;ci.encrypt = 0;
772     zi-&gt;ci.stream_initialised = 0;
773     zi-&gt;ci.pos_in_buffered_data = 0;
774     zi-&gt;ci.raw = raw;
775     zi-&gt;ci.pos_local_header = ZTELL64(zi-&gt;z_filefunc,zi-&gt;filestream);
776     zi-&gt;ci.size_centralheader = SIZECENTRALHEADER + size_filename + size_extrafield_global + size_comment;
777     zi-&gt;ci.size_centralExtraFree = 32; 
778     zi-&gt;ci.central_header = (char*)ALLOC((uInt)zi-&gt;ci.size_centralheader + zi-&gt;ci.size_centralExtraFree);
779     zi-&gt;ci.size_centralExtra = size_extrafield_global;
780     zip64local_putValue_inmemory(zi-&gt;ci.central_header,(uLong)CENTRALHEADERMAGIC,4);
781     zip64local_putValue_inmemory(zi-&gt;ci.central_header+4,(uLong)versionMadeBy,2);
782     zip64local_putValue_inmemory(zi-&gt;ci.central_header+6,(uLong)20,2);
783     zip64local_putValue_inmemory(zi-&gt;ci.central_header+8,(uLong)zi-&gt;ci.flag,2);
784     zip64local_putValue_inmemory(zi-&gt;ci.central_header+10,(uLong)zi-&gt;ci.method,2);
785     zip64local_putValue_inmemory(zi-&gt;ci.central_header+12,(uLong)zi-&gt;ci.dosDate,4);
786     zip64local_putValue_inmemory(zi-&gt;ci.central_header+28,(uLong)size_filename,2);
787     zip64local_putValue_inmemory(zi-&gt;ci.central_header+30,(uLong)size_extrafield_global,2);
788     zip64local_putValue_inmemory(zi-&gt;ci.central_header+32,(uLong)size_comment,2);
789     if (zipfi==NULL)
790         zip64local_putValue_inmemory(zi-&gt;ci.central_header+36,(uLong)0,2);
791     else
792         zip64local_putValue_inmemory(zi-&gt;ci.central_header+36,(uLong)zipfi-&gt;internal_fa,2);
793     if (zipfi==NULL)
794         zip64local_putValue_inmemory(zi-&gt;ci.central_header+38,(uLong)0,4);
795     else
796         zip64local_putValue_inmemory(zi-&gt;ci.central_header+38,(uLong)zipfi-&gt;external_fa,4);
797     if(zi-&gt;ci.pos_local_header &gt;= 0xffffffff)
798       zip64local_putValue_inmemory(zi-&gt;ci.central_header+42,(uLong)0xffffffff,4);
799     else
800       zip64local_putValue_inmemory(zi-&gt;ci.central_header+42,(uLong)zi-&gt;ci.pos_local_header - zi-&gt;add_position_when_writting_offset,4);
801     for (i=0;i&lt;size_filename;i++)
802         *(zi-&gt;ci.central_header+SIZECENTRALHEADER+i) = *(filename+i);
803     for (i=0;i&lt;size_extrafield_global;i++)
804         *(zi-&gt;ci.central_header+SIZECENTRALHEADER+size_filename+i) =
805               *(((const char*)extrafield_global)+i);
806     for (i=0;i&lt;size_comment;i++)
807         *(zi-&gt;ci.central_header+SIZECENTRALHEADER+size_filename+
808               size_extrafield_global+i) = *(comment+i);
809     if (zi-&gt;ci.central_header == NULL)
810         return ZIP_INTERNALERROR;
811     zi-&gt;ci.zip64 = zip64;
812     zi-&gt;ci.totalCompressedData = 0;
813     zi-&gt;ci.totalUncompressedData = 0;
814     zi-&gt;ci.pos_zip64extrainfo = 0;
815     err = Write_LocalFileHeader(zi, filename, size_extrafield_local, extrafield_local);
816 #ifdef HAVE_BZIP2
817     zi-&gt;ci.bstream.avail_in = (uInt)0;
818     zi-&gt;ci.bstream.avail_out = (uInt)Z_BUFSIZE;
819     zi-&gt;ci.bstream.next_out = (char*)zi-&gt;ci.buffered_data;
820     zi-&gt;ci.bstream.total_in_hi32 = 0;
821     zi-&gt;ci.bstream.total_in_lo32 = 0;
822     zi-&gt;ci.bstream.total_out_hi32 = 0;
823     zi-&gt;ci.bstream.total_out_lo32 = 0;
824 #endif
825     zi-&gt;ci.stream.avail_in = (uInt)0;
826     zi-&gt;ci.stream.avail_out = (uInt)Z_BUFSIZE;
827     zi-&gt;ci.stream.next_out = zi-&gt;ci.buffered_data;
828     zi-&gt;ci.stream.total_in = 0;
829     zi-&gt;ci.stream.total_out = 0;
830     zi-&gt;ci.stream.data_type = Z_BINARY;
831 #ifdef HAVE_BZIP2
832     if ((err==ZIP_OK) &amp;&amp; (zi-&gt;ci.method == Z_DEFLATED || zi-&gt;ci.method == Z_BZIP2ED) &amp;&amp; (!zi-&gt;ci.raw))
833 #else
834     if ((err==ZIP_OK) &amp;&amp; (zi-&gt;ci.method == Z_DEFLATED) &amp;&amp; (!zi-&gt;ci.raw))
835 #endif
836     {
837         if(zi-&gt;ci.method == Z_DEFLATED)
838         {
839           zi-&gt;ci.stream.zalloc = (alloc_func)0;
840           zi-&gt;ci.stream.zfree = (free_func)0;
841           zi-&gt;ci.stream.opaque = (voidpf)0;
842           if (windowBits&gt;0)
843               windowBits = -windowBits;
844           err = deflateInit2(&amp;zi-&gt;ci.stream, level, Z_DEFLATED, windowBits, memLevel, strategy);
845           if (err==Z_OK)
846               zi-&gt;ci.stream_initialised = Z_DEFLATED;
847         }
848         else if(zi-&gt;ci.method == Z_BZIP2ED)
849         {
850 #ifdef HAVE_BZIP2
851           zi-&gt;ci.bstream.bzalloc = 0;
852           zi-&gt;ci.bstream.bzfree = 0;
853           zi-&gt;ci.bstream.opaque = (voidpf)0;
854           err = BZ2_bzCompressInit(&amp;zi-&gt;ci.bstream, level, 0,35);
855           if(err == BZ_OK)
856             zi-&gt;ci.stream_initialised = Z_BZIP2ED;
857 #endif
858         }
859     }
860 #    ifndef NOCRYPT
861     zi-&gt;ci.crypt_header_size = 0;
862     if ((err==Z_OK) &amp;&amp; (password != NULL))
863     {
864         unsigned char bufHead[RAND_HEAD_LEN];
865         unsigned int sizeHead;
866         zi-&gt;ci.encrypt = 1;
867         zi-&gt;ci.pcrc_32_tab = get_crc_table();
868         sizeHead=crypthead(password,bufHead,RAND_HEAD_LEN,zi-&gt;ci.keys,zi-&gt;ci.pcrc_32_tab,crcForCrypting);
869         zi-&gt;ci.crypt_header_size = sizeHead;
870         if (ZWRITE64(zi-&gt;z_filefunc,zi-&gt;filestream,bufHead,sizeHead) != sizeHead)
871                 err = ZIP_ERRNO;
872     }
873 #    endif
874     if (err==Z_OK)
875         zi-&gt;in_opened_file_inzip = 1;
876     return err;
877 }
878 extern int ZEXPORT zipOpenNewFileInZip4 (zipFile file, const char* filename, const zip_fileinfo* zipfi,
879                                          const void* extrafield_local, uInt size_extrafield_local,
880                                          const void* extrafield_global, uInt size_extrafield_global,
881                                          const char* comment, int method, int level, int raw,
882                                          int windowBits,int memLevel, int strategy,
883                                          const char* password, uLong crcForCrypting,
884                                          uLong versionMadeBy, uLong flagBase)
885 {
886     return zipOpenNewFileInZip4_64 (file, filename, zipfi,
887                                  extrafield_local, size_extrafield_local,
888                                  extrafield_global, size_extrafield_global,
889                                  comment, method, level, raw,
890                                  windowBits, memLevel, strategy,
891                                  password, crcForCrypting, versionMadeBy, flagBase, 0);
892 }
893 extern int ZEXPORT zipOpenNewFileInZip3 (zipFile file, const char* filename, const zip_fileinfo* zipfi,
894                                          const void* extrafield_local, uInt size_extrafield_local,
895                                          const void* extrafield_global, uInt size_extrafield_global,
896                                          const char* comment, int method, int level, int raw,
897                                          int windowBits,int memLevel, int strategy,
898                                          const char* password, uLong crcForCrypting)
899 {
900     return zipOpenNewFileInZip4_64 (file, filename, zipfi,
901                                  extrafield_local, size_extrafield_local,
902                                  extrafield_global, size_extrafield_global,
903                                  comment, method, level, raw,
904                                  windowBits, memLevel, strategy,
905                                  password, crcForCrypting, VERSIONMADEBY, 0, 0);
906 }
907 extern int ZEXPORT zipOpenNewFileInZip3_64(zipFile file, const char* filename, const zip_fileinfo* zipfi,
908                                          const void* extrafield_local, uInt size_extrafield_local,
909                                          const void* extrafield_global, uInt size_extrafield_global,
910                                          const char* comment, int method, int level, int raw,
911                                          int windowBits,int memLevel, int strategy,
912                                          const char* password, uLong crcForCrypting, int zip64)
913 {
914     return zipOpenNewFileInZip4_64 (file, filename, zipfi,
915                                  extrafield_local, size_extrafield_local,
916                                  extrafield_global, size_extrafield_global,
917                                  comment, method, level, raw,
918                                  windowBits, memLevel, strategy,
919                                  password, crcForCrypting, VERSIONMADEBY, 0, zip64);
920 }
921 extern int ZEXPORT zipOpenNewFileInZip2(zipFile file, const char* filename, const zip_fileinfo* zipfi,
922                                         const void* extrafield_local, uInt size_extrafield_local,
923                                         const void* extrafield_global, uInt size_extrafield_global,
924                                         const char* comment, int method, int level, int raw)
925 {
926     return zipOpenNewFileInZip4_64 (file, filename, zipfi,
927                                  extrafield_local, size_extrafield_local,
928                                  extrafield_global, size_extrafield_global,
929                                  comment, method, level, raw,
930                                  -MAX_WBITS, DEF_MEM_LEVEL, Z_DEFAULT_STRATEGY,
931                                  NULL, 0, VERSIONMADEBY, 0, 0);
932 }
933 extern int ZEXPORT zipOpenNewFileInZip2_64(zipFile file, const char* filename, const zip_fileinfo* zipfi,
934                                         const void* extrafield_local, uInt size_extrafield_local,
935                                         const void* extrafield_global, uInt size_extrafield_global,
936                                         const char* comment, int method, int level, int raw, int zip64)
937 {
938     return zipOpenNewFileInZip4_64 (file, filename, zipfi,
939                                  extrafield_local, size_extrafield_local,
940                                  extrafield_global, size_extrafield_global,
941                                  comment, method, level, raw,
942                                  -MAX_WBITS, DEF_MEM_LEVEL, Z_DEFAULT_STRATEGY,
943                                  NULL, 0, VERSIONMADEBY, 0, zip64);
944 }
945 extern int ZEXPORT zipOpenNewFileInZip64 (zipFile file, const char* filename, const zip_fileinfo* zipfi,
946                                         const void* extrafield_local, uInt size_extrafield_local,
947                                         const void*extrafield_global, uInt size_extrafield_global,
948                                         const char* comment, int method, int level, int zip64)
949 {
950     return zipOpenNewFileInZip4_64 (file, filename, zipfi,
951                                  extrafield_local, size_extrafield_local,
952                                  extrafield_global, size_extrafield_global,
953                                  comment, method, level, 0,
954                                  -MAX_WBITS, DEF_MEM_LEVEL, Z_DEFAULT_STRATEGY,
955                                  NULL, 0, VERSIONMADEBY, 0, zip64);
956 }
957 extern int ZEXPORT zipOpenNewFileInZip (zipFile file, const char* filename, const zip_fileinfo* zipfi,
958                                         const void* extrafield_local, uInt size_extrafield_local,
959                                         const void*extrafield_global, uInt size_extrafield_global,
960                                         const char* comment, int method, int level)
961 {
962     return zipOpenNewFileInZip4_64 (file, filename, zipfi,
963                                  extrafield_local, size_extrafield_local,
964                                  extrafield_global, size_extrafield_global,
965                                  comment, method, level, 0,
966                                  -MAX_WBITS, DEF_MEM_LEVEL, Z_DEFAULT_STRATEGY,
967                                  NULL, 0, VERSIONMADEBY, 0, 0);
968 }
969 local int zip64FlushWriteBuffer(zip64_internal* zi)
970 {
971     int err=ZIP_OK;
972     if (zi-&gt;ci.encrypt != 0)
973     {
974 #ifndef NOCRYPT
975         uInt i;
976         int t;
977         for (i=0;i&lt;zi-&gt;ci.pos_in_buffered_data;i++)
978             zi-&gt;ci.buffered_data[i] = zencode(zi-&gt;ci.keys, zi-&gt;ci.pcrc_32_tab, zi-&gt;ci.buffered_data[i],t);
979 #endif
980     }
981     if (ZWRITE64(zi-&gt;z_filefunc,zi-&gt;filestream,zi-&gt;ci.buffered_data,zi-&gt;ci.pos_in_buffered_data) != zi-&gt;ci.pos_in_buffered_data)
982       err = ZIP_ERRNO;
983     zi-&gt;ci.totalCompressedData += zi-&gt;ci.pos_in_buffered_data;
984 #ifdef HAVE_BZIP2
985     if(zi-&gt;ci.method == Z_BZIP2ED)
986     {
987       zi-&gt;ci.totalUncompressedData += zi-&gt;ci.bstream.total_in_lo32;
988       zi-&gt;ci.bstream.total_in_lo32 = 0;
989       zi-&gt;ci.bstream.total_in_hi32 = 0;
990     }
991     else
992 #endif
993     {
994       zi-&gt;ci.totalUncompressedData += zi-&gt;ci.stream.total_in;
995       zi-&gt;ci.stream.total_in = 0;
996     }
997     zi-&gt;ci.pos_in_buffered_data = 0;
998     return err;
999 }
1000 extern int ZEXPORT zipWriteInFileInZip (zipFile file,const void* buf,unsigned int len)
1001 {
1002     zip64_internal* zi;
1003     int err=ZIP_OK;
1004     if (file == NULL)
1005         return ZIP_PARAMERROR;
1006     zi = (zip64_internal*)file;
1007     if (zi-&gt;in_opened_file_inzip == 0)
1008         return ZIP_PARAMERROR;
1009     zi-&gt;ci.crc32 = crc32(zi-&gt;ci.crc32,buf,(uInt)len);
1010 #ifdef HAVE_BZIP2
1011     if(zi-&gt;ci.method == Z_BZIP2ED &amp;&amp; (!zi-&gt;ci.raw))
1012     {
1013       zi-&gt;ci.bstream.next_in = (void*)buf;
1014       zi-&gt;ci.bstream.avail_in = len;
1015       err = BZ_RUN_OK;
1016       while ((err==BZ_RUN_OK) &amp;&amp; (zi-&gt;ci.bstream.avail_in&gt;0))
1017       {
1018         if (zi-&gt;ci.bstream.avail_out == 0)
1019         {
1020           if (zip64FlushWriteBuffer(zi) == ZIP_ERRNO)
1021             err = ZIP_ERRNO;
1022           zi-&gt;ci.bstream.avail_out = (uInt)Z_BUFSIZE;
1023           zi-&gt;ci.bstream.next_out = (char*)zi-&gt;ci.buffered_data;
1024         }
1025         if(err != BZ_RUN_OK)
1026           break;
1027         if ((zi-&gt;ci.method == Z_BZIP2ED) &amp;&amp; (!zi-&gt;ci.raw))
1028         {
1029           uLong uTotalOutBefore_lo = zi-&gt;ci.bstream.total_out_lo32;
1030           err=BZ2_bzCompress(&amp;zi-&gt;ci.bstream,  BZ_RUN);
1031           zi-&gt;ci.pos_in_buffered_data += (uInt)(zi-&gt;ci.bstream.total_out_lo32 - uTotalOutBefore_lo) ;
1032         }
1033       }
1034       if(err == BZ_RUN_OK)
1035         err = ZIP_OK;
1036     }
1037     else
1038 #endif
1039     {
1040       zi-&gt;ci.stream.next_in = (Bytef*)buf;
1041       zi-&gt;ci.stream.avail_in = len;
1042       while ((err==ZIP_OK) &amp;&amp; (zi-&gt;ci.stream.avail_in&gt;0))
1043       {
1044           if (zi-&gt;ci.stream.avail_out == 0)
1045           {
1046               if (zip64FlushWriteBuffer(zi) == ZIP_ERRNO)
1047                   err = ZIP_ERRNO;
1048               zi-&gt;ci.stream.avail_out = (uInt)Z_BUFSIZE;
1049               zi-&gt;ci.stream.next_out = zi-&gt;ci.buffered_data;
1050           }
1051           if(err != ZIP_OK)
1052               break;
1053           if ((zi-&gt;ci.method == Z_DEFLATED) &amp;&amp; (!zi-&gt;ci.raw))
1054           {
1055               uLong uTotalOutBefore = zi-&gt;ci.stream.total_out;
1056               err=deflate(&amp;zi-&gt;ci.stream,  Z_NO_FLUSH);
1057               if(uTotalOutBefore &gt; zi-&gt;ci.stream.total_out)
1058               {
1059                 int bBreak = 0;
1060                 bBreak++;
1061               }
1062               zi-&gt;ci.pos_in_buffered_data += (uInt)(zi-&gt;ci.stream.total_out - uTotalOutBefore) ;
1063           }
1064           else
1065           {
1066               uInt copy_this,i;
1067               if (zi-&gt;ci.stream.avail_in &lt; zi-&gt;ci.stream.avail_out)
1068                   copy_this = zi-&gt;ci.stream.avail_in;
1069               else
1070                   copy_this = zi-&gt;ci.stream.avail_out;
1071               for (i = 0; i &lt; copy_this; i++)
1072                   *(((char*)zi-&gt;ci.stream.next_out)+i) =
1073                       *(((const char*)zi-&gt;ci.stream.next_in)+i);
1074               {
1075                   zi-&gt;ci.stream.avail_in -= copy_this;
1076                   zi-&gt;ci.stream.avail_out-= copy_this;
1077                   zi-&gt;ci.stream.next_in+= copy_this;
1078                   zi-&gt;ci.stream.next_out+= copy_this;
1079                   zi-&gt;ci.stream.total_in+= copy_this;
1080                   zi-&gt;ci.stream.total_out+= copy_this;
1081                   zi-&gt;ci.pos_in_buffered_data += copy_this;
1082               }
1083           }
1084       }    }
1085     return err;
1086 }
1087 extern int ZEXPORT zipCloseFileInZipRaw (zipFile file, uLong uncompressed_size, uLong crc32)
1088 {
1089     return zipCloseFileInZipRaw64 (file, uncompressed_size, crc32);
1090 }
1091 extern int ZEXPORT zipCloseFileInZipRaw64 (zipFile file, ZPOS64_T uncompressed_size, uLong crc32)
1092 {
1093     zip64_internal* zi;
1094     ZPOS64_T compressed_size;
1095     uLong invalidValue = 0xffffffff;
1096     short datasize = 0;
1097     int err=ZIP_OK;
1098     if (file == NULL)
1099         return ZIP_PARAMERROR;
1100     zi = (zip64_internal*)file;
1101     if (zi-&gt;in_opened_file_inzip == 0)
1102         return ZIP_PARAMERROR;
1103     zi-&gt;ci.stream.avail_in = 0;
1104     if ((zi-&gt;ci.method == Z_DEFLATED) &amp;&amp; (!zi-&gt;ci.raw))
1105                 {
1106                         while (err==ZIP_OK)
1107                         {
1108                                 uLong uTotalOutBefore;
1109                                 if (zi-&gt;ci.stream.avail_out == 0)
1110                                 {
1111                                         if (zip64FlushWriteBuffer(zi) == ZIP_ERRNO)
1112                                                 err = ZIP_ERRNO;
1113                                         zi-&gt;ci.stream.avail_out = (uInt)Z_BUFSIZE;
1114                                         zi-&gt;ci.stream.next_out = zi-&gt;ci.buffered_data;
1115                                 }
1116                                 uTotalOutBefore = zi-&gt;ci.stream.total_out;
1117                                 err=deflate(&amp;zi-&gt;ci.stream,  Z_FINISH);
1118                                 zi-&gt;ci.pos_in_buffered_data += (uInt)(zi-&gt;ci.stream.total_out - uTotalOutBefore) ;
1119                         }
1120                 }
1121     else if ((zi-&gt;ci.method == Z_BZIP2ED) &amp;&amp; (!zi-&gt;ci.raw))
1122     {
1123 #ifdef HAVE_BZIP2
1124       err = BZ_FINISH_OK;
1125       while (err==BZ_FINISH_OK)
1126       {
1127         uLong uTotalOutBefore;
1128         if (zi-&gt;ci.bstream.avail_out == 0)
1129         {
1130           if (zip64FlushWriteBuffer(zi) == ZIP_ERRNO)
1131             err = ZIP_ERRNO;
1132           zi-&gt;ci.bstream.avail_out = (uInt)Z_BUFSIZE;
1133           zi-&gt;ci.bstream.next_out = (char*)zi-&gt;ci.buffered_data;
1134         }
1135         uTotalOutBefore = zi-&gt;ci.bstream.total_out_lo32;
1136         err=BZ2_bzCompress(&amp;zi-&gt;ci.bstream,  BZ_FINISH);
1137         if(err == BZ_STREAM_END)
1138           err = Z_STREAM_END;
1139         zi-&gt;ci.pos_in_buffered_data += (uInt)(zi-&gt;ci.bstream.total_out_lo32 - uTotalOutBefore);
1140       }
1141       if(err == BZ_FINISH_OK)
1142         err = ZIP_OK;
1143 #endif
1144     }
1145     if (err==Z_STREAM_END)
1146         err=ZIP_OK; 
1147     if ((zi-&gt;ci.pos_in_buffered_data&gt;0) &amp;&amp; (err==ZIP_OK))
1148                 {
1149         if (zip64FlushWriteBuffer(zi)==ZIP_ERRNO)
1150             err = ZIP_ERRNO;
1151                 }
1152     if ((zi-&gt;ci.method == Z_DEFLATED) &amp;&amp; (!zi-&gt;ci.raw))
1153     {
1154         int tmp_err = deflateEnd(&amp;zi-&gt;ci.stream);
1155         if (err == ZIP_OK)
1156             err = tmp_err;
1157         zi-&gt;ci.stream_initialised = 0;
1158     }
1159 #ifdef HAVE_BZIP2
1160     else if((zi-&gt;ci.method == Z_BZIP2ED) &amp;&amp; (!zi-&gt;ci.raw))
1161     {
1162       int tmperr = BZ2_bzCompressEnd(&amp;zi-&gt;ci.bstream);
1163                         if (err==ZIP_OK)
1164                                 err = tmperr;
1165                         zi-&gt;ci.stream_initialised = 0;
1166     }
1167 #endif
1168     if (!zi-&gt;ci.raw)
1169     {
1170         crc32 = (uLong)zi-&gt;ci.crc32;
1171         uncompressed_size = zi-&gt;ci.totalUncompressedData;
1172     }
1173     compressed_size = zi-&gt;ci.totalCompressedData;
1174 #    ifndef NOCRYPT
1175     compressed_size += zi-&gt;ci.crypt_header_size;
1176 #    endif
1177     if(compressed_size &gt;= 0xffffffff || uncompressed_size &gt;= 0xffffffff || zi-&gt;ci.pos_local_header &gt;= 0xffffffff)
1178     {
1179       zip64local_putValue_inmemory(zi-&gt;ci.central_header+4,(uLong)45,2);
1180       zip64local_putValue_inmemory(zi-&gt;ci.central_header+6,(uLong)45,2);
1181     }
1182     if(compressed_size &gt;= 0xffffffff)
1183     else
1184     if (zi-&gt;ci.stream.data_type == Z_ASCII)
1185         zip64local_putValue_inmemory(zi-&gt;ci.central_header+36,(uLong)Z_ASCII,2);
1186     if(uncompressed_size &gt;= 0xffffffff)
1187     else
1188     if(uncompressed_size &gt;= 0xffffffff)
1189       datasize += 8;
1190     if(compressed_size &gt;= 0xffffffff)
1191       datasize += 8;
1192     if(zi-&gt;ci.pos_local_header &gt;= 0xffffffff)
1193       datasize += 8;
1194     if(datasize &gt; 0)
1195     {
1196       char* p = NULL;
1197       if((uLong)(datasize + 4) &gt; zi-&gt;ci.size_centralExtraFree)
1198       {
1199         return ZIP_BADZIPFILE;
1200       }
1201       p = zi-&gt;ci.central_header + zi-&gt;ci.size_centralheader;
1202       zip64local_putValue_inmemory(p, 0x0001, 2);       p += 2;
1203       zip64local_putValue_inmemory(p, datasize, 2);       p += 2;
1204       if(uncompressed_size &gt;= 0xffffffff)
1205       {
1206         zip64local_putValue_inmemory(p, uncompressed_size, 8);
1207         p += 8;
1208       }
1209       if(compressed_size &gt;= 0xffffffff)
1210       {
1211         zip64local_putValue_inmemory(p, compressed_size, 8);
1212         p += 8;
1213       }
1214       if(zi-&gt;ci.pos_local_header &gt;= 0xffffffff)
1215       {
1216         zip64local_putValue_inmemory(p, zi-&gt;ci.pos_local_header, 8);
1217         p += 8;
1218       }
1219       zi-&gt;ci.size_centralExtraFree -= datasize + 4;
1220       zi-&gt;ci.size_centralheader += datasize + 4;
1221       zi-&gt;ci.size_centralExtra += datasize + 4;
1222       zip64local_putValue_inmemory(zi-&gt;ci.central_header+30,(uLong)zi-&gt;ci.size_centralExtra,2);
1223     }
1224     if (err==ZIP_OK)
1225         err = add_data_in_datablock(&amp;zi-&gt;central_dir, zi-&gt;ci.central_header, (uLong)zi-&gt;ci.size_centralheader);
1226     free(zi-&gt;ci.central_header);
1227     if (err==ZIP_OK)
1228     {
1229         ZPOS64_T cur_pos_inzip = ZTELL64(zi-&gt;z_filefunc,zi-&gt;filestream);
1230         if (ZSEEK64(zi-&gt;z_filefunc,zi-&gt;filestream, zi-&gt;ci.pos_local_header + 14,ZLIB_FILEFUNC_SEEK_SET)!=0)
1231             err = ZIP_ERRNO;
1232         if (err==ZIP_OK)
1233             err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,crc32,4); 
1234         if(uncompressed_size &gt;= 0xffffffff || compressed_size &gt;= 0xffffffff )
1235         {
1236           if(zi-&gt;ci.pos_zip64extrainfo &gt; 0)
1237           {
1238             if (ZSEEK64(zi-&gt;z_filefunc,zi-&gt;filestream, zi-&gt;ci.pos_zip64extrainfo + 4,ZLIB_FILEFUNC_SEEK_SET)!=0)
1239               err = ZIP_ERRNO;
1240             if (err==ZIP_OK)               err = zip64local_putValue(&amp;zi-&gt;z_filefunc, zi-&gt;filestream, uncompressed_size, 8);
1241             if (err==ZIP_OK)               err = zip64local_putValue(&amp;zi-&gt;z_filefunc, zi-&gt;filestream, compressed_size, 8);
1242           }
1243           else
1244               err = ZIP_BADZIPFILE;         }
1245         else
1246         {
1247           if (err==ZIP_OK)               err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,compressed_size,4);
1248           if (err==ZIP_OK)               err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,uncompressed_size,4);
1249         }
1250         if (ZSEEK64(zi-&gt;z_filefunc,zi-&gt;filestream, cur_pos_inzip,ZLIB_FILEFUNC_SEEK_SET)!=0)
1251             err = ZIP_ERRNO;
1252     }
1253     zi-&gt;number_entry ++;
1254     zi-&gt;in_opened_file_inzip = 0;
1255     return err;
1256 }
1257 extern int ZEXPORT zipCloseFileInZip (zipFile file)
1258 {
1259     return zipCloseFileInZipRaw (file,0,0);
1260 }
1261 int Write_Zip64EndOfCentralDirectoryLocator(zip64_internal* zi, ZPOS64_T zip64eocd_pos_inzip)
1262 {
1263   int err = ZIP_OK;
1264   ZPOS64_T pos = zip64eocd_pos_inzip - zi-&gt;add_position_when_writting_offset;
1265   err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)ZIP64ENDLOCHEADERMAGIC,4);
1266     if (err==ZIP_OK)       err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)0,4);
1267     if (err==ZIP_OK)       err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream, pos,8);
1268     if (err==ZIP_OK)       err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)1,4);
1269     return err;
1270 }
1271 int Write_Zip64EndOfCentralDirectoryRecord(zip64_internal* zi, uLong size_centraldir, ZPOS64_T centraldir_pos_inzip)
1272 <a name="5"></a>{
1273   int err = ZIP_OK;
1274 <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>  uLong Zip64DataSize = 44;
1275   err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)ZIP64ENDHEADERMAGIC,4);
1276   if (err==ZIP_OK)     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(ZPOS64_T)Zip64DataSize,8); 
1277   if (err==ZIP_OK)     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)45,2);
1278   if (err==ZIP_OK)     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)45,2);
1279   if (err==ZIP_OK)     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)0,4);
1280   if (err==ZIP_OK)     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)0,4);
1281   if (err==ZIP_OK)     err = zip64local_putValue(&amp;zi-&gt;z_filefunc, zi-&gt;filestream, zi-&gt;number_entry, 8);
1282   if (err==ZIP_OK)     err = zip64local_putValue(&amp;zi-&gt;z_filefunc, zi-&gt;filestream, zi-&gt;number_entry, 8);</b></font>
1283   if (err==ZIP_OK)     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(ZPOS64_T)size_centraldir,8);
1284   if (err==ZIP_OK)   {
1285     ZPOS64_T pos = centraldir_pos_inzip - zi-&gt;add_position_when_writting_offset;
1286     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream, (ZPOS64_T)pos,8);
1287   }
1288   return err;
1289 }
1290 int Write_EndOfCentralDirectoryRecord(zip64_internal* zi, uLong size_centraldir, ZPOS64_T centraldir_pos_inzip)
1291 {
1292   int err = ZIP_OK;
1293   err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)ENDHEADERMAGIC,4);
1294   if (err==ZIP_OK)     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)0,2);
1295   if (err==ZIP_OK)     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)0,2);
1296   if (err==ZIP_OK)   {
1297     {
1298       if(zi-&gt;number_entry &gt;= 0xFFFF)
1299         err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)0xffff,2);       else
1300         err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)zi-&gt;number_entry,2);
1301     }
1302   }
1303   if (err==ZIP_OK)   {
1304     if(zi-&gt;number_entry &gt;= 0xFFFF)
1305       err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)0xffff,2);     else
1306       err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)zi-&gt;number_entry,2);
1307   }
1308   if (err==ZIP_OK)     err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)size_centraldir,4);
1309   if (err==ZIP_OK)   {
1310     ZPOS64_T pos = centraldir_pos_inzip - zi-&gt;add_position_when_writting_offset;
1311     if(pos &gt;= 0xffffffff)
1312     {
1313       err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream, (uLong)0xffffffff,4);
1314     }
1315     else
1316       err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream, (uLong)(centraldir_pos_inzip - zi-&gt;add_position_when_writting_offset),4);
1317   }
1318    return err;
1319 }
1320 int Write_GlobalComment(zip64_internal* zi, const char* global_comment)
1321 {
1322   int err = ZIP_OK;
1323   uInt size_global_comment = 0;
1324   if(global_comment != NULL)
1325     size_global_comment = (uInt)strlen(global_comment);
1326   err = zip64local_putValue(&amp;zi-&gt;z_filefunc,zi-&gt;filestream,(uLong)size_global_comment,2);
1327   if (err == ZIP_OK &amp;&amp; size_global_comment &gt; 0)
1328   {
1329     if (ZWRITE64(zi-&gt;z_filefunc,zi-&gt;filestream, global_comment, size_global_comment) != size_global_comment)
1330       err = ZIP_ERRNO;
1331   }
1332   return err;
1333 }
1334 extern int ZEXPORT zipClose (zipFile file, const char* global_comment)
1335 {
1336     zip64_internal* zi;
1337     int err = 0;
1338     uLong size_centraldir = 0;
1339     ZPOS64_T centraldir_pos_inzip;
1340     ZPOS64_T pos;
1341     if (file == NULL)
1342         return ZIP_PARAMERROR;
1343     zi = (zip64_internal*)file;
1344     if (zi-&gt;in_opened_file_inzip == 1)
1345     {
1346         err = zipCloseFileInZip (file);
1347     }
1348 #ifndef NO_ADDFILEINEXISTINGZIP
1349     if (global_comment==NULL)
1350         global_comment = zi-&gt;globalcomment;
1351 #endif
1352     centraldir_pos_inzip = ZTELL64(zi-&gt;z_filefunc,zi-&gt;filestream);
1353     if (err==ZIP_OK)
1354     {
1355         linkedlist_datablock_internal* ldi = zi-&gt;central_dir.first_block;
1356         while (ldi!=NULL)
1357         {
1358             if ((err==ZIP_OK) &amp;&amp; (ldi-&gt;filled_in_this_block&gt;0))
1359             {
1360                 if (ZWRITE64(zi-&gt;z_filefunc,zi-&gt;filestream, ldi-&gt;data, ldi-&gt;filled_in_this_block) != ldi-&gt;filled_in_this_block)
1361                     err = ZIP_ERRNO;
1362             }
1363             size_centraldir += ldi-&gt;filled_in_this_block;
1364             ldi = ldi-&gt;next_datablock;
1365         }
1366     }
1367     free_linkedlist(&amp;(zi-&gt;central_dir));
1368     pos = centraldir_pos_inzip - zi-&gt;add_position_when_writting_offset;
1369     if(pos &gt;= 0xffffffff || zi-&gt;number_entry &gt; 0xFFFF)
1370     {
1371       ZPOS64_T Zip64EOCDpos = ZTELL64(zi-&gt;z_filefunc,zi-&gt;filestream);
1372       Write_Zip64EndOfCentralDirectoryRecord(zi, size_centraldir, centraldir_pos_inzip);
1373       Write_Zip64EndOfCentralDirectoryLocator(zi, Zip64EOCDpos);
1374     }
1375     if (err==ZIP_OK)
1376       err = Write_EndOfCentralDirectoryRecord(zi, size_centraldir, centraldir_pos_inzip);
1377     if(err == ZIP_OK)
1378       err = Write_GlobalComment(zi, global_comment);
1379     if (ZCLOSE64(zi-&gt;z_filefunc,zi-&gt;filestream) != 0)
1380         if (err == ZIP_OK)
1381             err = ZIP_ERRNO;
1382 #ifndef NO_ADDFILEINEXISTINGZIP
1383     TRYFREE(zi-&gt;globalcomment);
1384 #endif
1385     TRYFREE(zi);
1386     return err;
1387 }
1388 extern int ZEXPORT zipRemoveExtraInfoBlock (char* pData, int* dataLen, short sHeader)
1389 {
1390   char* p = pData;
1391   int size = 0;
1392   char* pNewHeader;
1393   char* pTmp;
1394   short header;
1395   short dataSize;
1396   int retVal = ZIP_OK;
1397   if(pData == NULL || *dataLen &lt; 4)
1398     return ZIP_PARAMERROR;
1399   pNewHeader = (char*)ALLOC(*dataLen);
1400   pTmp = pNewHeader;
1401   while(p &lt; (pData + *dataLen))
1402   {
1403     header = *(short*)p;
1404     dataSize = *(((short*)p)+1);
1405     if( header == sHeader )     {
1406       p += dataSize + 4;     }
1407     else
1408     {
1409       memcpy(pTmp, p, dataSize + 4);
1410       p += dataSize + 4;
1411       size += dataSize + 4;
1412     }
1413   }
1414   if(size &lt; *dataLen)
1415   {
1416     memset(pData,0, *dataLen);
1417     if(size &gt; 0)
1418       memcpy(pData, pNewHeader, size);
1419     *dataLen = size;
1420     retVal = ZIP_OK;
1421   }
1422   else
1423     retVal = ZIP_ERRNO;
1424   TRYFREE(pNewHeader);
1425   return retVal;
1426 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>unzip.c</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 #include &lt;stdio.h&gt;
2 #include &lt;stdlib.h&gt;
3 #include &lt;string.h&gt;
4 #ifndef NOUNCRYPT
5         #define NOUNCRYPT
6 #endif
7 #include "zlib.h"
8 #include "unzip.h"
9 #ifdef STDC
10 #  include &lt;stddef.h&gt;
11 #  include &lt;string.h&gt;
12 #  include &lt;stdlib.h&gt;
13 #endif
14 #ifdef NO_ERRNO_H
15     extern int errno;
16 #else
17 #   include &lt;errno.h&gt;
18 #endif
19 #ifndef local
20 #  define local static
21 #endif
22 #ifndef CASESENSITIVITYDEFAULT_NO
23 #  if !defined(unix) &amp;&amp; !defined(CASESENSITIVITYDEFAULT_YES)
24 #    define CASESENSITIVITYDEFAULT_NO
25 #  endif
26 #endif
27 #ifndef UNZ_BUFSIZE
28 #define UNZ_BUFSIZE (16384)
29 #endif
30 #ifndef UNZ_MAXFILENAMEINZIP
31 #define UNZ_MAXFILENAMEINZIP (256)
32 #endif
33 #ifndef ALLOC
34 # define ALLOC(size) (malloc(size))
35 #endif
36 #ifndef TRYFREE
37 # define TRYFREE(p) {if (p) free(p);}
38 #endif
39 #define SIZECENTRALDIRITEM (0x2e)
40 #define SIZEZIPLOCALHEADER (0x1e)
41 const char unz_copyright[] =
42    " unzip 1.01 Copyright 1998-2004 Gilles Vollant - http://www.winimage.com/zLibDll";
43 typedef struct unz_file_info64_internal_s
44 {
45     ZPOS64_T offset_curfile;} unz_file_info64_internal;
46 typedef struct
47 {
48     char  *read_buffer;             z_stream stream;            
49 #ifdef HAVE_BZIP2
50     bz_stream bstream;          #endif
51     ZPOS64_T total_out_64;
52     zlib_filefunc64_32_def z_filefunc;
53     int   raw;
54 } file_in_zip64_read_info_s;
55 typedef struct
56 {
57     zlib_filefunc64_32_def z_filefunc;
58     int is64bitOpenFunction;
59     int encrypted;
60     int isZip64;
61 #    ifndef NOUNCRYPT
62 <a name="0"></a>    unsigned long keys[3];         const z_crc_t* pcrc_32_tab;
63 #    endif
64 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>} unz64_s;
65 #ifndef NOUNCRYPT
66 #include "crypt.h"
67 #endif
68 local int unz64local_getByte OF((
69     const zlib_filefunc64_32_def* pzlib_filefunc_def,
70     voidpf filestream,
71     int *pi));
72 local int unz64local_getByte(const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream, int *pi)
73 {
74     unsigned char c;
75     int err = (int)ZREAD64(*pzlib_filefunc_def,filestream,&amp;c,1);
76     if (err==1)
77     {
78         *pi = (int)c;
79         return UNZ_OK;
80     }
81     else
82     {
83         if (ZERROR64(*pzlib_filefunc_def,filestream))
84             return UNZ_ERRNO;
85         else
86             return UNZ_EOF;
87     }
88 }
89 local int unz64local_getShort OF((
90     const zlib_filefunc64_32_def* pzlib_filefunc_def,
91     voidpf filestream,
92     uLong *pX));
93 local int unz64local_getShort (const zlib_filefunc64_32_def* pzlib_filefunc_def,
94                              voidpf filestream,
95                              uLong *pX)
96 {
97     uLong x ;
98     int i = 0;
99     int err;
100     err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
101     x = (uLong)i;
102     if (err==UNZ_OK)
103         err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
104     x |= ((uLong)i)&lt;&lt;8;
105     if (err==UNZ_OK)
106         *pX = x;
107     else
108         *pX = 0;
109     return err;
110 }
111 local int unz64local_getLong OF((
112     const zlib_filefunc64_32_def* pzlib_filefunc_def,
113     voidpf filestream,
114     uLong *pX));
115 local int unz64local_getLong (const zlib_filefunc64_32_def* pzlib_filefunc_def,
116                             voidpf filestream,
117                             uLong *pX)
118 {
119     uLong x ;
120     int i = 0;
121     int err;
122     err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
123     x = (uLong)i;
124     if (err==UNZ_OK)
125         err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
126     x |= ((uLong)i)&lt;&lt;8;
127     if (err==UNZ_OK)
128         err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
129     x |= ((uLong)i)&lt;&lt;16;
130     if (err==UNZ_OK)
131         err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
132     x += ((uLong)i)&lt;&lt;24;
133     if (err==UNZ_OK)
134         *pX = x;
135     else
136         *pX = 0;
137     return err;
138 }
139 local int unz64local_getLong64 OF((
140     const zlib_filefunc64_32_def* pzlib_filefunc_def,
141     voidpf filestream,
142     ZPOS64_T *pX));
143 local int unz64local_getLong64 (const zlib_filefunc64_32_def* pzlib_filefunc_def,
144                             voidpf filestream,
145                             ZPOS64_T *pX)
146 {
147     ZPOS64_T x ;
148     int i = 0;
149     int err;
150     err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
151     x = (ZPOS64_T)i;
152     if (err==UNZ_OK)
153         err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
154     x |= ((ZPOS64_T)i)&lt;&lt;8;
155     if (err==UNZ_OK)
156         err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
157     x |= ((ZPOS64_T)i)&lt;&lt;16;
158     if (err==UNZ_OK)
159         err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
160     x |= ((ZPOS64_T)i)&lt;&lt;24;
161     if (err==UNZ_OK)
162         err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
163     x |= ((ZPOS64_T)i)&lt;&lt;32;
164     if (err==UNZ_OK)
165         err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
166     x |= ((ZPOS64_T)i)&lt;&lt;40;
167     if (err==UNZ_OK)
168         err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
169     x |= ((ZPOS64_T)i)&lt;&lt;48;
170     if (err==UNZ_OK)
171         err = unz64local_getByte(pzlib_filefunc_def,filestream,&amp;i);
172     x |= ((ZPOS64_T)i)&lt;&lt;56;
173     if (err==UNZ_OK)
174         *pX = x;
175     else
176         *pX = 0;
177     return err;
178 }</b></font>
179 local int strcmpcasenosensitive_internal (const char* fileName1, const char* fileName2)
180 {
181     for (;;)
182     {
183         char c1=*(fileName1++);
184         char c2=*(fileName2++);
185         if ((c1&gt;='a') &amp;&amp; (c1&lt;='z'))
186             c1 -= 0x20;
187         if ((c2&gt;='a') &amp;&amp; (c2&lt;='z'))
188             c2 -= 0x20;
189         if (c1=='\0')
190             return ((c2=='\0') ? 0 : -1);
191         if (c2=='\0')
192             return 1;
193         if (c1&lt;c2)
194             return -1;
195         if (c1&gt;c2)
196             return 1;
197     }
198 }
199 #ifdef  CASESENSITIVITYDEFAULT_NO
200 #define CASESENSITIVITYDEFAULTVALUE 2
201 #else
202 #define CASESENSITIVITYDEFAULTVALUE 1
203 #endif
204 #ifndef STRCMPCASENOSENTIVEFUNCTION
205 #define STRCMPCASENOSENTIVEFUNCTION strcmpcasenosensitive_internal
206 #endif
207 extern int ZEXPORT unzStringFileNameCompare (const char*  fileName1,
208                                                  const char*  fileName2,
209                                                  int iCaseSensitivity)
210 {
211     if (iCaseSensitivity==0)
212         iCaseSensitivity=CASESENSITIVITYDEFAULTVALUE;
213     if (iCaseSensitivity==1)
214         return strcmp(fileName1,fileName2);
215     return STRCMPCASENOSENTIVEFUNCTION(fileName1,fileName2);
216 }
217 #ifndef BUFREADCOMMENT
218 #define BUFREADCOMMENT (0x400)
219 #endif
220 <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>local ZPOS64_T unz64local_SearchCentralDir OF((const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream));
221 local ZPOS64_T unz64local_SearchCentralDir(const zlib_filefunc64_32_def* pzlib_filefunc_def, voidpf filestream)
222 {
223     unsigned char* buf;
224     ZPOS64_T uSizeFile;
225     ZPOS64_T uBackRead;
226     ZPOS64_T uMaxBack=0xffff;     ZPOS64_T uPosFound=0;
227     if (ZSEEK64(*pzlib_filefunc_def,filestream,0,ZLIB_FILEFUNC_SEEK_END) != 0)
228         return 0;
229     uSizeFile = ZTELL64(*pzlib_filefunc_def,filestream);
230     if (uMaxBack&gt;uSizeFile)
231         uMaxBack = uSizeFile;
232     buf = (unsigned char*)ALLOC(BUFREADCOMMENT+4);
233     if (buf==NULL)
234         return 0;
235     uBackRead = 4;
236     while (uBackRead&lt;uMaxBack)
237     {
238         uLong uReadSize;
239         ZPOS64_T uReadPos ;
240         int i;
241         if (uBackRead+BUFREADCOMMENT&gt;uMaxBack)
242             uBackRead = uMaxBack;
243         else
244             uBackRead+=BUFREADCOMMENT;
245         uReadPos = uSizeFile-uBackRead ;
246         uReadSize = ((BUFREADCOMMENT+4) &lt; (uSizeFile-uReadPos)) ?
247                      (BUFREADCOMMENT+4) : (uLong)(uSizeFile-uReadPos);
248         if (ZSEEK64(*pzlib_filefunc_def,filestream,uReadPos,ZLIB_FILEFUNC_SEEK_SET)!=0)
249             break;
250         if (ZREAD64(*pzlib_filefunc_def,filestream,buf,uReadSize)!=uReadSize)
251             break;
252         for (i=(int)uReadSize-3; (i--)&gt;0;)
253             if (((*(buf+i))==0x50) &amp;&amp; ((*(buf+i+1))==0x4b) &amp;&amp;
254                 ((*(buf+i+2))==0x05) &amp;&amp; ((*(buf+i+3))==0x06))
255             {
256                 uPosFound = uReadPos+i;
257                 break;
258             }
259         if (uPosFound!=0)
260             break;
261     }
262     TRYFREE(buf);
263     return uPosFound;
264 }
265 local ZPOS64_T unz64local_SearchCentralDir64 OF((
266     const zlib_filefunc64_32_def* pzlib_filefunc_def,
267     voidpf filestream));
268 local ZPOS64_T unz64local_SearchCentralDir64(const zlib_filefunc64_32_def* pzlib_filefunc_def,
269                                       voidpf filestream)
270 {
271     unsigned char* buf;
272     ZPOS64_T uSizeFile;
273     ZPOS64_T uBackRead;
274     ZPOS64_T uMaxBack=0xffff;     ZPOS64_T uPosFound=0;
275     uLong uL;
276                 ZPOS64_T relativeOffset;
277     if (ZSEEK64(*pzlib_filefunc_def,filestream,0,ZLIB_FILEFUNC_SEEK_END) != 0)
278         return 0;
279     uSizeFile = ZTELL64(*pzlib_filefunc_def,filestream);
280     if (uMaxBack&gt;uSizeFile)
281         uMaxBack = uSizeFile;
282     buf = (unsigned char*)ALLOC(BUFREADCOMMENT+4);
283     if (buf==NULL)
284         return 0;
285     uBackRead = 4;
286     while (uBackRead&lt;uMaxBack)
287     {
288         uLong uReadSize;
289         ZPOS64_T uReadPos;
290         int i;
291         if (uBackRead+BUFREADCOMMENT&gt;uMaxBack)
292             uBackRead = uMaxBack;
293         else
294             uBackRead+=BUFREADCOMMENT;
295         uReadPos = uSizeFile-uBackRead ;
296         uReadSize = ((BUFREADCOMMENT+4) &lt; (uSizeFile-uReadPos)) ?
297                      (BUFREADCOMMENT+4) : (uLong)(uSizeFile-uReadPos);
298         if (ZSEEK64(*pzlib_filefunc_def,filestream,uReadPos,ZLIB_FILEFUNC_SEEK_SET)!=0)
299             break;
300         if (ZREAD64(*pzlib_filefunc_def,filestream,buf,uReadSize)!=uReadSize)
301             break;
302         for (i=(int)uReadSize-3; (i--)&gt;0;)</b></font>
303             if (((*(buf+i))==0x50) &amp;&amp; ((*(buf+i+1))==0x4b) &amp;&amp;
304                 ((*(buf+i+2))==0x06) &amp;&amp; ((*(buf+i+3))==0x07))
305 <a name="3"></a>            {
306                 uPosFound = uReadPos+i;
307                 break;
308 <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>            }
309         if (uPosFound!=0)
310             break;
311     }
312     TRYFREE(buf);
313     if (uPosFound == 0)
314         return 0;
315     if (ZSEEK64(*pzlib_filefunc_def,filestream, uPosFound,ZLIB_FILEFUNC_SEEK_SET)!=0)
316         return 0;
317     if (unz64local_getLong(pzlib_filefunc_def,filestream,&amp;uL)!=UNZ_OK)
318         return 0;
319     if (unz64local_getLong(pzlib_filefunc_def,filestream,&amp;uL)!=UNZ_OK)
320         return 0;
321     if (uL != 0)
322         return 0;
323     if (unz64local_getLong64(pzlib_filefunc_def,filestream,&amp;relativeOffset)!=UNZ_OK)
324         return 0;
325     if (unz64local_getLong(pzlib_filefunc_def,filestream,&amp;uL)!=UNZ_OK)
326         return 0;
327     if (uL != 1)
328         return 0;
329     if (ZSEEK64(*pzlib_filefunc_def,filestream, relativeOffset,ZLIB_FILEFUNC_SEEK_SET)!=0)
330         return 0;
331     if (unz64local_getLong(pzlib_filefunc_def,filestream,&amp;uL)!=UNZ_OK)
332         return 0;
333     if (uL != 0x06064b50)
334         return 0;
335     return relativeOffset;
336 }</b></font>
337 local unzFile unzOpenInternal (const void *path,
338                                zlib_filefunc64_32_def* pzlib_filefunc64_32_def,
339                                int is64bitOpenFunction)
340 {
341     unz64_s us;
342     unz64_s *s;
343     ZPOS64_T central_pos;
344     uLong   uL;
345     int err=UNZ_OK;
346     if (unz_copyright[0]!=' ')
347         return NULL;
348     us.z_filefunc.zseek32_file = NULL;
349     us.z_filefunc.ztell32_file = NULL;
350     if (pzlib_filefunc64_32_def==NULL)
351         fill_fopen64_filefunc(&amp;us.z_filefunc.zfile_func64);
352     else
353         us.z_filefunc = *pzlib_filefunc64_32_def;
354     us.is64bitOpenFunction = is64bitOpenFunction;
355     us.filestream = ZOPEN64(us.z_filefunc,
356                                                  path,
357                                                  ZLIB_FILEFUNC_MODE_READ |
358                                                  ZLIB_FILEFUNC_MODE_EXISTING);
359     if (us.filestream==NULL)
360         return NULL;
361     central_pos = unz64local_SearchCentralDir64(&amp;us.z_filefunc,us.filestream);
362     if (central_pos)
363     {
364         uLong uS;
365         ZPOS64_T uL64;
366 <a name="2"></a>
367         us.isZip64 = 1;
368 <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>        if (ZSEEK64(us.z_filefunc, us.filestream,
369                                       central_pos,ZLIB_FILEFUNC_SEEK_SET)!=0)
370         err=UNZ_ERRNO;
371         if (unz64local_getLong(&amp;us.z_filefunc, us.filestream,&amp;uL)!=UNZ_OK)
372             err=UNZ_ERRNO;
373         if (unz64local_getLong64(&amp;us.z_filefunc, us.filestream,&amp;uL64)!=UNZ_OK)
374             err=UNZ_ERRNO;
375         if (unz64local_getShort(&amp;us.z_filefunc, us.filestream,&amp;uS)!=UNZ_OK)
376             err=UNZ_ERRNO;
377         if (unz64local_getShort(&amp;us.z_filefunc, us.filestream,&amp;uS)!=UNZ_OK)
378             err=UNZ_ERRNO;
379         if (unz64local_getLong(&amp;us.z_filefunc, us.filestream,&amp;number_disk)!=UNZ_OK)
380             err=UNZ_ERRNO;
381         if (unz64local_getLong(&amp;us.z_filefunc, us.filestream,&amp;number_disk_with_CD)!=UNZ_OK)
382             err=UNZ_ERRNO;
383         if (unz64local_getLong64(&amp;us.z_filefunc, us.filestream,&amp;us.gi.number_entry)!=UNZ_OK)
384             err=UNZ_ERRNO;
385         if (unz64local_getLong64(&amp;us.z_filefunc, us.filestream,&amp;number_entry_CD)!=UNZ_OK)
386             err=UNZ_ERRNO;
387         if ((number_entry_CD!=us.gi.number_entry) ||
388             (number_disk_with_CD!=0) ||
389             (number_disk!=0))
390             err=UNZ_BADZIPFILE;
391         if (unz64local_getLong64(&amp;us.z_filefunc, us.filestream,&amp;us.size_central_dir)!=UNZ_OK)
392             err=UNZ_ERRNO;
393         if (unz64local_getLong64(&amp;us.z_filefunc, us.filestream,&amp;us.offset_central_dir)!=UNZ_OK)
394             err=UNZ_ERRNO;
395         us.gi.size_comment = 0;
396     }
397     else
398     {</b></font>
399         central_pos = unz64local_SearchCentralDir(&amp;us.z_filefunc,us.filestream);
400         if (central_pos==0)
401             err=UNZ_ERRNO;
402         us.isZip64 = 0;
403         if (ZSEEK64(us.z_filefunc, us.filestream,
404                                         central_pos,ZLIB_FILEFUNC_SEEK_SET)!=0)
405             err=UNZ_ERRNO;
406         if (unz64local_getLong(&amp;us.z_filefunc, us.filestream,&amp;uL)!=UNZ_OK)
407             err=UNZ_ERRNO;
408         if (unz64local_getShort(&amp;us.z_filefunc, us.filestream,&amp;number_disk)!=UNZ_OK)
409             err=UNZ_ERRNO;
410         if (unz64local_getShort(&amp;us.z_filefunc, us.filestream,&amp;number_disk_with_CD)!=UNZ_OK)
411             err=UNZ_ERRNO;
412         if (unz64local_getShort(&amp;us.z_filefunc, us.filestream,&amp;uL)!=UNZ_OK)
413             err=UNZ_ERRNO;
414         us.gi.number_entry = uL;
415         if (unz64local_getShort(&amp;us.z_filefunc, us.filestream,&amp;uL)!=UNZ_OK)
416             err=UNZ_ERRNO;
417         number_entry_CD = uL;
418         if ((number_entry_CD!=us.gi.number_entry) ||
419             (number_disk_with_CD!=0) ||
420             (number_disk!=0))
421             err=UNZ_BADZIPFILE;
422         if (unz64local_getLong(&amp;us.z_filefunc, us.filestream,&amp;uL)!=UNZ_OK)
423             err=UNZ_ERRNO;
424         us.size_central_dir = uL;
425         if (unz64local_getLong(&amp;us.z_filefunc, us.filestream,&amp;uL)!=UNZ_OK)
426             err=UNZ_ERRNO;
427         us.offset_central_dir = uL;
428         if (unz64local_getShort(&amp;us.z_filefunc, us.filestream,&amp;us.gi.size_comment)!=UNZ_OK)
429             err=UNZ_ERRNO;
430     }
431     if ((central_pos&lt;us.offset_central_dir+us.size_central_dir) &amp;&amp;
432         (err==UNZ_OK))
433         err=UNZ_BADZIPFILE;
434     if (err!=UNZ_OK)
435     {
436         ZCLOSE64(us.z_filefunc, us.filestream);
437         return NULL;
438     }
439     us.byte_before_the_zipfile = central_pos -
440                             (us.offset_central_dir+us.size_central_dir);
441     us.central_pos = central_pos;
442     us.pfile_in_zip_read = NULL;
443     us.encrypted = 0;
444     s=(unz64_s*)ALLOC(sizeof(unz64_s));
445     if( s != NULL)
446     {
447         *s=us;
448         unzGoToFirstFile((unzFile)s);
449     }
450     return (unzFile)s;
451 }
452 <a name="6"></a>
453 extern unzFile ZEXPORT unzOpen2 (const char *path,
454                                         zlib_filefunc_def* pzlib_filefunc32_def)
455 <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
456     if (pzlib_filefunc32_def != NULL)
457     {
458         zlib_filefunc64_32_def zlib_filefunc64_32_def_fill;
459         fill_zlib_filefunc64_32_def_from_filefunc32(&amp;zlib_filefunc64_32_def_fill,pzlib_filefunc32_def);
460         return unzOpenInternal(path, &amp;zlib_filefunc64_32_def_fill, 0);
461     }
462     else
463         return unzOpenInternal(path, NULL, 0);
464 }
465 <a name="4"></a>
466 extern unzFile ZEXPORT unzOpen2_64 (const void *path,</b></font>
467                                      zlib_filefunc64_def* pzlib_filefunc_def)
468 <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
469     if (pzlib_filefunc_def != NULL)
470     {
471         zlib_filefunc64_32_def zlib_filefunc64_32_def_fill;
472         zlib_filefunc64_32_def_fill.zfile_func64 = *pzlib_filefunc_def;
473         zlib_filefunc64_32_def_fill.ztell32_file = NULL;
474         zlib_filefunc64_32_def_fill.zseek32_file = NULL;
475         return unzOpenInternal(path, &amp;zlib_filefunc64_32_def_fill, 1);
476     }
477     else
478         return unzOpenInternal(path, NULL, 1);
479 }
480 extern unzFile ZEXPORT unzOpen (const char *path)</b></font>
481 {
482     return unzOpenInternal(path, NULL, 0);
483 }
484 extern unzFile ZEXPORT unzOpen64 (const void *path)
485 {
486     return unzOpenInternal(path, NULL, 1);
487 }
488 extern int ZEXPORT unzClose (unzFile file)
489 {
490     unz64_s* s;
491     if (file==NULL)
492         return UNZ_PARAMERROR;
493     s=(unz64_s*)file;
494     if (s-&gt;pfile_in_zip_read!=NULL)
495         unzCloseCurrentFile(file);
496     ZCLOSE64(s-&gt;z_filefunc, s-&gt;filestream);
497     TRYFREE(s);
498     return UNZ_OK;
499 }
500 extern int ZEXPORT unzGetGlobalInfo64 (unzFile file, unz_global_info64* pglobal_info)
501 {
502     unz64_s* s;
503     if (file==NULL)
504         return UNZ_PARAMERROR;
505     s=(unz64_s*)file;
506     *pglobal_info=s-&gt;gi;
507     return UNZ_OK;
508 }
509 extern int ZEXPORT unzGetGlobalInfo (unzFile file, unz_global_info* pglobal_info32)
510 {
511     unz64_s* s;
512     if (file==NULL)
513         return UNZ_PARAMERROR;
514     s=(unz64_s*)file;
515     pglobal_info32-&gt;number_entry = (uLong)s-&gt;gi.number_entry;
516     pglobal_info32-&gt;size_comment = s-&gt;gi.size_comment;
517     return UNZ_OK;
518 }
519 local void unz64local_DosDateToTmuDate (ZPOS64_T ulDosDate, tm_unz* ptm)
520 {
521     ZPOS64_T uDate;
522     uDate = (ZPOS64_T)(ulDosDate&gt;&gt;16);
523     ptm-&gt;tm_mday = (uInt)(uDate&amp;0x1f) ;
524     ptm-&gt;tm_mon =  (uInt)((((uDate)&amp;0x1E0)/0x20)-1) ;
525     ptm-&gt;tm_year = (uInt)(((uDate&amp;0x0FE00)/0x0200)+1980) ;
526     ptm-&gt;tm_hour = (uInt) ((ulDosDate &amp;0xF800)/0x800);
527     ptm-&gt;tm_min =  (uInt) ((ulDosDate&amp;0x7E0)/0x20) ;
528     ptm-&gt;tm_sec =  (uInt) (2*(ulDosDate&amp;0x1f)) ;
529 }
530 local int unz64local_GetCurrentFileInfoInternal OF((unzFile file,
531                                                   unz_file_info64 *pfile_info,
532                                                   unz_file_info64_internal
533                                                   *pfile_info_internal,
534                                                   char *szFileName,
535                                                   uLong fileNameBufferSize,
536                                                   void *extraField,
537                                                   uLong extraFieldBufferSize,
538                                                   char *szComment,
539                                                   uLong commentBufferSize));
540 local int unz64local_GetCurrentFileInfoInternal (unzFile file,
541                                                   unz_file_info64 *pfile_info,
542                                                   unz_file_info64_internal
543                                                   *pfile_info_internal,
544                                                   char *szFileName,
545                                                   uLong fileNameBufferSize,
546                                                   void *extraField,
547                                                   uLong extraFieldBufferSize,
548                                                   char *szComment,
549                                                   uLong commentBufferSize)
550 {
551     unz64_s* s;
552     unz_file_info64 file_info;
553     unz_file_info64_internal file_info_internal;
554     int err=UNZ_OK;
555     uLong uMagic;
556     long lSeek=0;
557     uLong uL;
558     if (file==NULL)
559         return UNZ_PARAMERROR;
560     s=(unz64_s*)file;
561     if (ZSEEK64(s-&gt;z_filefunc, s-&gt;filestream,
562               s-&gt;pos_in_central_dir+s-&gt;byte_before_the_zipfile,
563               ZLIB_FILEFUNC_SEEK_SET)!=0)
564         err=UNZ_ERRNO;
565     if (err==UNZ_OK)
566     {
567         if (unz64local_getLong(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;uMagic) != UNZ_OK)
568             err=UNZ_ERRNO;
569         else if (uMagic!=0x02014b50)
570             err=UNZ_BADZIPFILE;
571     }
572     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.version) != UNZ_OK)
573         err=UNZ_ERRNO;
574     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.version_needed) != UNZ_OK)
575         err=UNZ_ERRNO;
576     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.flag) != UNZ_OK)
577         err=UNZ_ERRNO;
578     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.compression_method) != UNZ_OK)
579         err=UNZ_ERRNO;
580     if (unz64local_getLong(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.dosDate) != UNZ_OK)
581         err=UNZ_ERRNO;
582     unz64local_DosDateToTmuDate(file_info.dosDate,&amp;file_info.tmu_date);
583     if (unz64local_getLong(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.crc) != UNZ_OK)
584         err=UNZ_ERRNO;
585     if (unz64local_getLong(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;uL) != UNZ_OK)
586         err=UNZ_ERRNO;
587 <a name="5"></a>    file_info.compressed_size = uL;
588     if (unz64local_getLong(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;uL) != UNZ_OK)
589 <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>        err=UNZ_ERRNO;
590     file_info.uncompressed_size = uL;
591     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.size_filename) != UNZ_OK)
592         err=UNZ_ERRNO;
593     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.size_file_extra) != UNZ_OK)
594         err=UNZ_ERRNO;
595     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.size_file_comment) != UNZ_OK)
596         err=UNZ_ERRNO;
597     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.disk_num_start) != UNZ_OK)
598         err=UNZ_ERRNO;
599     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.internal_fa) != UNZ_OK)
600         err=UNZ_ERRNO;
601     if (unz64local_getLong(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.external_fa) != UNZ_OK)
602         err=UNZ_ERRNO;
603     if (unz64local_getLong(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;uL) != UNZ_OK)
604         err=UNZ_ERRNO;</b></font>
605     file_info_internal.offset_curfile = uL;
606     lSeek+=file_info.size_filename;
607     if ((err==UNZ_OK) &amp;&amp; (szFileName!=NULL))
608     {
609         uLong uSizeRead ;
610         if (file_info.size_filename&lt;fileNameBufferSize)
611         {
612             *(szFileName+file_info.size_filename)='\0';
613             uSizeRead = file_info.size_filename;
614         }
615         else
616             uSizeRead = fileNameBufferSize;
617         if ((file_info.size_filename&gt;0) &amp;&amp; (fileNameBufferSize&gt;0))
618             if (ZREAD64(s-&gt;z_filefunc, s-&gt;filestream,szFileName,uSizeRead)!=uSizeRead)
619                 err=UNZ_ERRNO;
620         lSeek -= uSizeRead;
621     }
622     if ((err==UNZ_OK) &amp;&amp; (extraField!=NULL))
623     {
624         ZPOS64_T uSizeRead ;
625         if (file_info.size_file_extra&lt;extraFieldBufferSize)
626             uSizeRead = file_info.size_file_extra;
627         else
628             uSizeRead = extraFieldBufferSize;
629         if (lSeek!=0)
630         {
631             if (ZSEEK64(s-&gt;z_filefunc, s-&gt;filestream,lSeek,ZLIB_FILEFUNC_SEEK_CUR)==0)
632                 lSeek=0;
633             else
634                 err=UNZ_ERRNO;
635         }
636         if ((file_info.size_file_extra&gt;0) &amp;&amp; (extraFieldBufferSize&gt;0))
637             if (ZREAD64(s-&gt;z_filefunc, s-&gt;filestream,extraField,(uLong)uSizeRead)!=uSizeRead)
638                 err=UNZ_ERRNO;
639         lSeek += file_info.size_file_extra - (uLong)uSizeRead;
640     }
641     else
642         lSeek += file_info.size_file_extra;
643     if ((err==UNZ_OK) &amp;&amp; (file_info.size_file_extra != 0))
644     {
645                                 uLong acc = 0;
646         lSeek -= file_info.size_file_extra;
647         if (lSeek!=0)
648         {
649             if (ZSEEK64(s-&gt;z_filefunc, s-&gt;filestream,lSeek,ZLIB_FILEFUNC_SEEK_CUR)==0)
650                 lSeek=0;
651             else
652                 err=UNZ_ERRNO;
653         }
654         while(acc &lt; file_info.size_file_extra)
655         {
656             uLong headerId;
657                                                 uLong dataSize;
658             if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;headerId) != UNZ_OK)
659                 err=UNZ_ERRNO;
660             if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;dataSize) != UNZ_OK)
661                 err=UNZ_ERRNO;
662             if (headerId == 0x0001)
663 <a name="7"></a>            {
664                                                         uLong uL;
665 <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>                                                                if(file_info.uncompressed_size == MAXU32)
666                                                                 {
667                                                                         if (unz64local_getLong64(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.uncompressed_size) != UNZ_OK)
668                                                                                         err=UNZ_ERRNO;
669                                                                 }
670                                                                 if(file_info.compressed_size == MAXU32)
671                                                                 {
672                                                                         if (unz64local_getLong64(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info.compressed_size) != UNZ_OK)
673                                                                                   err=UNZ_ERRNO;
674                                                                 }
675                                                                 if(file_info_internal.offset_curfile == MAXU32)
676                                                                 {</b></font>
677                                                                         if (unz64local_getLong64(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;file_info_internal.offset_curfile) != UNZ_OK)
678                                                                                 err=UNZ_ERRNO;
679                                                                 }
680                                                                 if(file_info.disk_num_start == MAXU32)
681                                                                 {
682                                                                         if (unz64local_getLong(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;uL) != UNZ_OK)
683                                                                                 err=UNZ_ERRNO;
684                                                                 }
685             }
686             else
687             {
688                 if (ZSEEK64(s-&gt;z_filefunc, s-&gt;filestream,dataSize,ZLIB_FILEFUNC_SEEK_CUR)!=0)
689                     err=UNZ_ERRNO;
690             }
691             acc += 2 + 2 + dataSize;
692         }
693     }
694     if ((err==UNZ_OK) &amp;&amp; (szComment!=NULL))
695     {
696         uLong uSizeRead ;
697         if (file_info.size_file_comment&lt;commentBufferSize)
698         {
699             *(szComment+file_info.size_file_comment)='\0';
700             uSizeRead = file_info.size_file_comment;
701         }
702         else
703             uSizeRead = commentBufferSize;
704         if (lSeek!=0)
705         {
706             if (ZSEEK64(s-&gt;z_filefunc, s-&gt;filestream,lSeek,ZLIB_FILEFUNC_SEEK_CUR)==0)
707                 lSeek=0;
708             else
709                 err=UNZ_ERRNO;
710         }
711         if ((file_info.size_file_comment&gt;0) &amp;&amp; (commentBufferSize&gt;0))
712             if (ZREAD64(s-&gt;z_filefunc, s-&gt;filestream,szComment,uSizeRead)!=uSizeRead)
713                 err=UNZ_ERRNO;
714         lSeek+=file_info.size_file_comment - uSizeRead;
715     }
716     else
717         lSeek+=file_info.size_file_comment;
718     if ((err==UNZ_OK) &amp;&amp; (pfile_info!=NULL))
719         *pfile_info=file_info;
720     if ((err==UNZ_OK) &amp;&amp; (pfile_info_internal!=NULL))
721         *pfile_info_internal=file_info_internal;
722     return err;
723 }
724 extern int ZEXPORT unzGetCurrentFileInfo64 (unzFile file,
725                                           unz_file_info64 * pfile_info,
726                                           char * szFileName, uLong fileNameBufferSize,
727                                           void *extraField, uLong extraFieldBufferSize,
728                                           char* szComment,  uLong commentBufferSize)
729 {
730     return unz64local_GetCurrentFileInfoInternal(file,pfile_info,NULL,
731                                                 szFileName,fileNameBufferSize,
732                                                 extraField,extraFieldBufferSize,
733                                                 szComment,commentBufferSize);
734 }
735 extern int ZEXPORT unzGetCurrentFileInfo (unzFile file,
736                                           unz_file_info * pfile_info,
737                                           char * szFileName, uLong fileNameBufferSize,
738                                           void *extraField, uLong extraFieldBufferSize,
739                                           char* szComment,  uLong commentBufferSize)
740 {
741     int err;
742     unz_file_info64 file_info64;
743     err = unz64local_GetCurrentFileInfoInternal(file,&amp;file_info64,NULL,
744                                                 szFileName,fileNameBufferSize,
745                                                 extraField,extraFieldBufferSize,
746                                                 szComment,commentBufferSize);
747     if ((err==UNZ_OK) &amp;&amp; (pfile_info != NULL))
748     {
749         pfile_info-&gt;version = file_info64.version;
750         pfile_info-&gt;version_needed = file_info64.version_needed;
751         pfile_info-&gt;flag = file_info64.flag;
752         pfile_info-&gt;compression_method = file_info64.compression_method;
753         pfile_info-&gt;dosDate = file_info64.dosDate;
754         pfile_info-&gt;crc = file_info64.crc;
755         pfile_info-&gt;size_filename = file_info64.size_filename;
756         pfile_info-&gt;size_file_extra = file_info64.size_file_extra;
757         pfile_info-&gt;size_file_comment = file_info64.size_file_comment;
758         pfile_info-&gt;disk_num_start = file_info64.disk_num_start;
759         pfile_info-&gt;internal_fa = file_info64.internal_fa;
760         pfile_info-&gt;external_fa = file_info64.external_fa;
761         pfile_info-&gt;tmu_date = file_info64.tmu_date,
762         pfile_info-&gt;compressed_size = (uLong)file_info64.compressed_size;
763         pfile_info-&gt;uncompressed_size = (uLong)file_info64.uncompressed_size;
764     }
765     return err;
766 }
767 extern int ZEXPORT unzGoToFirstFile (unzFile file)
768 {
769     int err=UNZ_OK;
770     unz64_s* s;
771     if (file==NULL)
772         return UNZ_PARAMERROR;
773     s=(unz64_s*)file;
774     s-&gt;pos_in_central_dir=s-&gt;offset_central_dir;
775     s-&gt;num_file=0;
776     err=unz64local_GetCurrentFileInfoInternal(file,&amp;s-&gt;cur_file_info,
777                                              &amp;s-&gt;cur_file_info_internal,
778                                              NULL,0,NULL,0,NULL,0);
779     s-&gt;current_file_ok = (err == UNZ_OK);
780     return err;
781 }
782 extern int ZEXPORT unzGoToNextFile (unzFile  file)
783 {
784     unz64_s* s;
785     int err;
786     if (file==NULL)
787         return UNZ_PARAMERROR;
788     s=(unz64_s*)file;
789     if (!s-&gt;current_file_ok)
790         return UNZ_END_OF_LIST_OF_FILE;
791     if (s-&gt;gi.number_entry != 0xffff)          if (s-&gt;num_file+1==s-&gt;gi.number_entry)
792         return UNZ_END_OF_LIST_OF_FILE;
793     s-&gt;pos_in_central_dir += SIZECENTRALDIRITEM + s-&gt;cur_file_info.size_filename +
794             s-&gt;cur_file_info.size_file_extra + s-&gt;cur_file_info.size_file_comment ;
795     s-&gt;num_file++;
796     err = unz64local_GetCurrentFileInfoInternal(file,&amp;s-&gt;cur_file_info,
797                                                &amp;s-&gt;cur_file_info_internal,
798                                                NULL,0,NULL,0,NULL,0);
799     s-&gt;current_file_ok = (err == UNZ_OK);
800     return err;
801 }
802 extern int ZEXPORT unzLocateFile (unzFile file, const char *szFileName, int iCaseSensitivity)
803 {
804     unz64_s* s;
805     int err;
806     unz_file_info64 cur_file_infoSaved;
807     unz_file_info64_internal cur_file_info_internalSaved;
808     ZPOS64_T num_fileSaved;
809     ZPOS64_T pos_in_central_dirSaved;
810     if (file==NULL)
811         return UNZ_PARAMERROR;
812     if (strlen(szFileName)&gt;=UNZ_MAXFILENAMEINZIP)
813         return UNZ_PARAMERROR;
814     s=(unz64_s*)file;
815     if (!s-&gt;current_file_ok)
816         return UNZ_END_OF_LIST_OF_FILE;
817     num_fileSaved = s-&gt;num_file;
818     pos_in_central_dirSaved = s-&gt;pos_in_central_dir;
819     cur_file_infoSaved = s-&gt;cur_file_info;
820     cur_file_info_internalSaved = s-&gt;cur_file_info_internal;
821     err = unzGoToFirstFile(file);
822     while (err == UNZ_OK)
823     {
824         char szCurrentFileName[UNZ_MAXFILENAMEINZIP+1];
825         err = unzGetCurrentFileInfo64(file,NULL,
826                                     szCurrentFileName,sizeof(szCurrentFileName)-1,
827                                     NULL,0,NULL,0);
828         if (err == UNZ_OK)
829         {
830             if (unzStringFileNameCompare(szCurrentFileName,
831                                             szFileName,iCaseSensitivity)==0)
832                 return UNZ_OK;
833             err = unzGoToNextFile(file);
834         }
835     }
836     s-&gt;num_file = num_fileSaved ;
837     s-&gt;pos_in_central_dir = pos_in_central_dirSaved ;
838     s-&gt;cur_file_info = cur_file_infoSaved;
839     s-&gt;cur_file_info_internal = cur_file_info_internalSaved;
840     return err;
841 }
842 extern int ZEXPORT unzGetFilePos64(unzFile file, unz64_file_pos*  file_pos)
843 {
844     unz64_s* s;
845     if (file==NULL || file_pos==NULL)
846         return UNZ_PARAMERROR;
847     s=(unz64_s*)file;
848     if (!s-&gt;current_file_ok)
849         return UNZ_END_OF_LIST_OF_FILE;
850     file_pos-&gt;pos_in_zip_directory  = s-&gt;pos_in_central_dir;
851     file_pos-&gt;num_of_file           = s-&gt;num_file;
852     return UNZ_OK;
853 }
854 extern int ZEXPORT unzGetFilePos(
855     unzFile file,
856     unz_file_pos* file_pos)
857 {
858     unz64_file_pos file_pos64;
859     int err = unzGetFilePos64(file,&amp;file_pos64);
860     if (err==UNZ_OK)
861     {
862         file_pos-&gt;pos_in_zip_directory = (uLong)file_pos64.pos_in_zip_directory;
863         file_pos-&gt;num_of_file = (uLong)file_pos64.num_of_file;
864     }
865     return err;
866 }
867 extern int ZEXPORT unzGoToFilePos64(unzFile file, const unz64_file_pos* file_pos)
868 {
869     unz64_s* s;
870     int err;
871     if (file==NULL || file_pos==NULL)
872         return UNZ_PARAMERROR;
873     s=(unz64_s*)file;
874     s-&gt;pos_in_central_dir = file_pos-&gt;pos_in_zip_directory;
875     s-&gt;num_file           = file_pos-&gt;num_of_file;
876     err = unz64local_GetCurrentFileInfoInternal(file,&amp;s-&gt;cur_file_info,
877                                                &amp;s-&gt;cur_file_info_internal,
878                                                NULL,0,NULL,0,NULL,0);
879     s-&gt;current_file_ok = (err == UNZ_OK);
880     return err;
881 }
882 extern int ZEXPORT unzGoToFilePos(
883     unzFile file,
884     unz_file_pos* file_pos)
885 {
886     unz64_file_pos file_pos64;
887     if (file_pos == NULL)
888         return UNZ_PARAMERROR;
889     file_pos64.pos_in_zip_directory = file_pos-&gt;pos_in_zip_directory;
890     file_pos64.num_of_file = file_pos-&gt;num_of_file;
891     return unzGoToFilePos64(file,&amp;file_pos64);
892 }
893 local int unz64local_CheckCurrentFileCoherencyHeader (unz64_s* s, uInt* piSizeVar,
894                                                     ZPOS64_T * poffset_local_extrafield,
895                                                     uInt  * psize_local_extrafield)
896 {
897     uLong uMagic,uData,uFlags;
898     uLong size_filename;
899     uLong size_extra_field;
900     int err=UNZ_OK;
901     *piSizeVar = 0;
902     *poffset_local_extrafield = 0;
903     *psize_local_extrafield = 0;
904     if (ZSEEK64(s-&gt;z_filefunc, s-&gt;filestream,s-&gt;cur_file_info_internal.offset_curfile +
905                                 s-&gt;byte_before_the_zipfile,ZLIB_FILEFUNC_SEEK_SET)!=0)
906         return UNZ_ERRNO;
907     if (err==UNZ_OK)
908     {
909         if (unz64local_getLong(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;uMagic) != UNZ_OK)
910             err=UNZ_ERRNO;
911         else if (uMagic!=0x04034b50)
912             err=UNZ_BADZIPFILE;
913     }
914     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;uData) != UNZ_OK)
915         err=UNZ_ERRNO;
916     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;uFlags) != UNZ_OK)
917         err=UNZ_ERRNO;
918     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;uData) != UNZ_OK)
919         err=UNZ_ERRNO;
920     else if ((err==UNZ_OK) &amp;&amp; (uData!=s-&gt;cur_file_info.compression_method))
921         err=UNZ_BADZIPFILE;
922     if ((err==UNZ_OK) &amp;&amp; (s-&gt;cur_file_info.compression_method!=0) &amp;&amp;
923                          (s-&gt;cur_file_info.compression_method!=Z_BZIP2ED) &amp;&amp;
924                          (s-&gt;cur_file_info.compression_method!=Z_DEFLATED))
925         err=UNZ_BADZIPFILE;
926     if (unz64local_getLong(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;uData) != UNZ_OK)         err=UNZ_ERRNO;
927     if (unz64local_getLong(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;uData) != UNZ_OK)         err=UNZ_ERRNO;
928     else if ((err==UNZ_OK) &amp;&amp; (uData!=s-&gt;cur_file_info.crc) &amp;&amp; ((uFlags &amp; 8)==0))
929         err=UNZ_BADZIPFILE;
930     if (unz64local_getLong(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;uData) != UNZ_OK)         err=UNZ_ERRNO;
931     else if (uData != 0xFFFFFFFF &amp;&amp; (err==UNZ_OK) &amp;&amp; (uData!=s-&gt;cur_file_info.compressed_size) &amp;&amp; ((uFlags &amp; 8)==0))
932         err=UNZ_BADZIPFILE;
933     if (unz64local_getLong(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;uData) != UNZ_OK)         err=UNZ_ERRNO;
934     else if (uData != 0xFFFFFFFF &amp;&amp; (err==UNZ_OK) &amp;&amp; (uData!=s-&gt;cur_file_info.uncompressed_size) &amp;&amp; ((uFlags &amp; 8)==0))
935         err=UNZ_BADZIPFILE;
936     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;size_filename) != UNZ_OK)
937         err=UNZ_ERRNO;
938     else if ((err==UNZ_OK) &amp;&amp; (size_filename!=s-&gt;cur_file_info.size_filename))
939         err=UNZ_BADZIPFILE;
940     *piSizeVar += (uInt)size_filename;
941     if (unz64local_getShort(&amp;s-&gt;z_filefunc, s-&gt;filestream,&amp;size_extra_field) != UNZ_OK)
942         err=UNZ_ERRNO;
943     *poffset_local_extrafield= s-&gt;cur_file_info_internal.offset_curfile +
944                                     SIZEZIPLOCALHEADER + size_filename;
945     *psize_local_extrafield = (uInt)size_extra_field;
946     *piSizeVar += (uInt)size_extra_field;
947     return err;
948 }
949 extern int ZEXPORT unzOpenCurrentFile3 (unzFile file, int* method,
950                                             int* level, int raw, const char* password)
951 {
952     int err=UNZ_OK;
953     uInt iSizeVar;
954     unz64_s* s;
955     file_in_zip64_read_info_s* pfile_in_zip_read_info;
956     ZPOS64_T offset_local_extrafield;      uInt  size_local_extrafield;    #    ifndef NOUNCRYPT
957     char source[12];
958 #    else
959     if (password != NULL)
960         return UNZ_PARAMERROR;
961 #    endif
962     if (file==NULL)
963         return UNZ_PARAMERROR;
964     s=(unz64_s*)file;
965     if (!s-&gt;current_file_ok)
966         return UNZ_PARAMERROR;
967     if (s-&gt;pfile_in_zip_read != NULL)
968         unzCloseCurrentFile(file);
969     if (unz64local_CheckCurrentFileCoherencyHeader(s,&amp;iSizeVar, &amp;offset_local_extrafield,&amp;size_local_extrafield)!=UNZ_OK)
970         return UNZ_BADZIPFILE;
971     pfile_in_zip_read_info = (file_in_zip64_read_info_s*)ALLOC(sizeof(file_in_zip64_read_info_s));
972     if (pfile_in_zip_read_info==NULL)
973         return UNZ_INTERNALERROR;
974     pfile_in_zip_read_info-&gt;read_buffer=(char*)ALLOC(UNZ_BUFSIZE);
975     pfile_in_zip_read_info-&gt;offset_local_extrafield = offset_local_extrafield;
976     pfile_in_zip_read_info-&gt;size_local_extrafield = size_local_extrafield;
977     pfile_in_zip_read_info-&gt;pos_local_extrafield=0;
978     pfile_in_zip_read_info-&gt;raw=raw;
979     if (pfile_in_zip_read_info-&gt;read_buffer==NULL)
980     {
981         TRYFREE(pfile_in_zip_read_info);
982         return UNZ_INTERNALERROR;
983     }
984     pfile_in_zip_read_info-&gt;stream_initialised=0;
985     if (method!=NULL)
986         *method = (int)s-&gt;cur_file_info.compression_method;
987     if (level!=NULL)
988     {
989         *level = 6;
990         switch (s-&gt;cur_file_info.flag &amp; 0x06)
991         {
992           case 6 : *level = 1; break;
993           case 4 : *level = 2; break;
994           case 2 : *level = 9; break;
995         }
996     }
997     if ((s-&gt;cur_file_info.compression_method!=0) &amp;&amp;
998         (s-&gt;cur_file_info.compression_method!=Z_BZIP2ED) &amp;&amp;
999         (s-&gt;cur_file_info.compression_method!=Z_DEFLATED))
1000         err=UNZ_BADZIPFILE;
1001     pfile_in_zip_read_info-&gt;crc32_wait=s-&gt;cur_file_info.crc;
1002     pfile_in_zip_read_info-&gt;crc32=0;
1003     pfile_in_zip_read_info-&gt;total_out_64=0;
1004     pfile_in_zip_read_info-&gt;compression_method = s-&gt;cur_file_info.compression_method;
1005     pfile_in_zip_read_info-&gt;filestream=s-&gt;filestream;
1006     pfile_in_zip_read_info-&gt;z_filefunc=s-&gt;z_filefunc;
1007     pfile_in_zip_read_info-&gt;byte_before_the_zipfile=s-&gt;byte_before_the_zipfile;
1008     pfile_in_zip_read_info-&gt;stream.total_out = 0;
1009     if ((s-&gt;cur_file_info.compression_method==Z_BZIP2ED) &amp;&amp; (!raw))
1010     {
1011 #ifdef HAVE_BZIP2
1012       pfile_in_zip_read_info-&gt;bstream.bzalloc = (void *(*) (void *, int, int))0;
1013       pfile_in_zip_read_info-&gt;bstream.bzfree = (free_func)0;
1014       pfile_in_zip_read_info-&gt;bstream.opaque = (voidpf)0;
1015       pfile_in_zip_read_info-&gt;bstream.state = (voidpf)0;
1016       pfile_in_zip_read_info-&gt;stream.zalloc = (alloc_func)0;
1017       pfile_in_zip_read_info-&gt;stream.zfree = (free_func)0;
1018       pfile_in_zip_read_info-&gt;stream.opaque = (voidpf)0;
1019       pfile_in_zip_read_info-&gt;stream.next_in = (voidpf)0;
1020       pfile_in_zip_read_info-&gt;stream.avail_in = 0;
1021       err=BZ2_bzDecompressInit(&amp;pfile_in_zip_read_info-&gt;bstream, 0, 0);
1022       if (err == Z_OK)
1023         pfile_in_zip_read_info-&gt;stream_initialised=Z_BZIP2ED;
1024       else
1025       {
1026         TRYFREE(pfile_in_zip_read_info);
1027         return err;
1028       }
1029 #else
1030       pfile_in_zip_read_info-&gt;raw=1;
1031 #endif
1032     }
1033     else if ((s-&gt;cur_file_info.compression_method==Z_DEFLATED) &amp;&amp; (!raw))
1034     {
1035       pfile_in_zip_read_info-&gt;stream.zalloc = (alloc_func)0;
1036       pfile_in_zip_read_info-&gt;stream.zfree = (free_func)0;
1037       pfile_in_zip_read_info-&gt;stream.opaque = (voidpf)0;
1038       pfile_in_zip_read_info-&gt;stream.next_in = 0;
1039       pfile_in_zip_read_info-&gt;stream.avail_in = 0;
1040       err=inflateInit2(&amp;pfile_in_zip_read_info-&gt;stream, -MAX_WBITS);
1041       if (err == Z_OK)
1042         pfile_in_zip_read_info-&gt;stream_initialised=Z_DEFLATED;
1043       else
1044       {
1045         TRYFREE(pfile_in_zip_read_info);
1046         return err;
1047       }
1048     }
1049     pfile_in_zip_read_info-&gt;rest_read_compressed =
1050             s-&gt;cur_file_info.compressed_size ;
1051     pfile_in_zip_read_info-&gt;rest_read_uncompressed =
1052             s-&gt;cur_file_info.uncompressed_size ;
1053     pfile_in_zip_read_info-&gt;pos_in_zipfile =
1054             s-&gt;cur_file_info_internal.offset_curfile + SIZEZIPLOCALHEADER +
1055               iSizeVar;
1056     pfile_in_zip_read_info-&gt;stream.avail_in = (uInt)0;
1057     s-&gt;pfile_in_zip_read = pfile_in_zip_read_info;
1058                 s-&gt;encrypted = 0;
1059 #    ifndef NOUNCRYPT
1060     if (password != NULL)
1061     {
1062         int i;
1063         s-&gt;pcrc_32_tab = get_crc_table();
1064         init_keys(password,s-&gt;keys,s-&gt;pcrc_32_tab);
1065         if (ZSEEK64(s-&gt;z_filefunc, s-&gt;filestream,
1066                   s-&gt;pfile_in_zip_read-&gt;pos_in_zipfile +
1067                      s-&gt;pfile_in_zip_read-&gt;byte_before_the_zipfile,
1068                   SEEK_SET)!=0)
1069             return UNZ_INTERNALERROR;
1070         if(ZREAD64(s-&gt;z_filefunc, s-&gt;filestream,source, 12)&lt;12)
1071             return UNZ_INTERNALERROR;
1072         for (i = 0; i&lt;12; i++)
1073             zdecode(s-&gt;keys,s-&gt;pcrc_32_tab,source[i]);
1074         s-&gt;pfile_in_zip_read-&gt;pos_in_zipfile+=12;
1075         s-&gt;encrypted=1;
1076     }
1077 #    endif
1078     return UNZ_OK;
1079 }
1080 extern int ZEXPORT unzOpenCurrentFile (unzFile file)
1081 {
1082     return unzOpenCurrentFile3(file, NULL, NULL, 0, NULL);
1083 }
1084 extern int ZEXPORT unzOpenCurrentFilePassword (unzFile file, const char*  password)
1085 {
1086     return unzOpenCurrentFile3(file, NULL, NULL, 0, password);
1087 }
1088 extern int ZEXPORT unzOpenCurrentFile2 (unzFile file, int* method, int* level, int raw)
1089 {
1090     return unzOpenCurrentFile3(file, method, level, raw, NULL);
1091 }
1092 extern ZPOS64_T ZEXPORT unzGetCurrentFileZStreamPos64( unzFile file)
1093 {
1094     unz64_s* s;
1095     file_in_zip64_read_info_s* pfile_in_zip_read_info;
1096     s=(unz64_s*)file;
1097     if (file==NULL)
1098         return 0; //UNZ_PARAMERROR;
1099     pfile_in_zip_read_info=s-&gt;pfile_in_zip_read;
1100     if (pfile_in_zip_read_info==NULL)
1101         return 0; //UNZ_PARAMERROR;
1102     return pfile_in_zip_read_info-&gt;pos_in_zipfile +
1103                          pfile_in_zip_read_info-&gt;byte_before_the_zipfile;
1104 }
1105 extern int ZEXPORT unzReadCurrentFile  (unzFile file, voidp buf, unsigned len)
1106 {
1107     int err=UNZ_OK;
1108     uInt iRead = 0;
1109     unz64_s* s;
1110     file_in_zip64_read_info_s* pfile_in_zip_read_info;
1111     if (file==NULL)
1112         return UNZ_PARAMERROR;
1113     s=(unz64_s*)file;
1114     pfile_in_zip_read_info=s-&gt;pfile_in_zip_read;
1115     if (pfile_in_zip_read_info==NULL)
1116         return UNZ_PARAMERROR;
1117     if (pfile_in_zip_read_info-&gt;read_buffer == NULL)
1118         return UNZ_END_OF_LIST_OF_FILE;
1119     if (len==0)
1120         return 0;
1121     pfile_in_zip_read_info-&gt;stream.next_out = (Bytef*)buf;
1122     pfile_in_zip_read_info-&gt;stream.avail_out = (uInt)len;
1123     if ((len&gt;pfile_in_zip_read_info-&gt;rest_read_uncompressed) &amp;&amp;
1124         (!(pfile_in_zip_read_info-&gt;raw)))
1125         pfile_in_zip_read_info-&gt;stream.avail_out =
1126             (uInt)pfile_in_zip_read_info-&gt;rest_read_uncompressed;
1127     if ((len&gt;pfile_in_zip_read_info-&gt;rest_read_compressed+
1128            pfile_in_zip_read_info-&gt;stream.avail_in) &amp;&amp;
1129          (pfile_in_zip_read_info-&gt;raw))
1130         pfile_in_zip_read_info-&gt;stream.avail_out =
1131             (uInt)pfile_in_zip_read_info-&gt;rest_read_compressed+
1132             pfile_in_zip_read_info-&gt;stream.avail_in;
1133     while (pfile_in_zip_read_info-&gt;stream.avail_out&gt;0)
1134     {
1135         if ((pfile_in_zip_read_info-&gt;stream.avail_in==0) &amp;&amp;
1136             (pfile_in_zip_read_info-&gt;rest_read_compressed&gt;0))
1137         {
1138             uInt uReadThis = UNZ_BUFSIZE;
1139             if (pfile_in_zip_read_info-&gt;rest_read_compressed&lt;uReadThis)
1140                 uReadThis = (uInt)pfile_in_zip_read_info-&gt;rest_read_compressed;
1141             if (uReadThis == 0)
1142                 return UNZ_EOF;
1143             if (ZSEEK64(pfile_in_zip_read_info-&gt;z_filefunc,
1144                       pfile_in_zip_read_info-&gt;filestream,
1145                       pfile_in_zip_read_info-&gt;pos_in_zipfile +
1146                          pfile_in_zip_read_info-&gt;byte_before_the_zipfile,
1147                          ZLIB_FILEFUNC_SEEK_SET)!=0)
1148                 return UNZ_ERRNO;
1149             if (ZREAD64(pfile_in_zip_read_info-&gt;z_filefunc,
1150                       pfile_in_zip_read_info-&gt;filestream,
1151                       pfile_in_zip_read_info-&gt;read_buffer,
1152                       uReadThis)!=uReadThis)
1153                 return UNZ_ERRNO;
1154 #            ifndef NOUNCRYPT
1155             if(s-&gt;encrypted)
1156             {
1157                 uInt i;
1158                 for(i=0;i&lt;uReadThis;i++)
1159                   pfile_in_zip_read_info-&gt;read_buffer[i] =
1160                       zdecode(s-&gt;keys,s-&gt;pcrc_32_tab,
1161                               pfile_in_zip_read_info-&gt;read_buffer[i]);
1162             }
1163 #            endif
1164             pfile_in_zip_read_info-&gt;pos_in_zipfile += uReadThis;
1165             pfile_in_zip_read_info-&gt;rest_read_compressed-=uReadThis;
1166             pfile_in_zip_read_info-&gt;stream.next_in =
1167                 (Bytef*)pfile_in_zip_read_info-&gt;read_buffer;
1168             pfile_in_zip_read_info-&gt;stream.avail_in = (uInt)uReadThis;
1169         }
1170         if ((pfile_in_zip_read_info-&gt;compression_method==0) || (pfile_in_zip_read_info-&gt;raw))
1171         {
1172             uInt uDoCopy,i ;
1173             if ((pfile_in_zip_read_info-&gt;stream.avail_in == 0) &amp;&amp;
1174                 (pfile_in_zip_read_info-&gt;rest_read_compressed == 0))
1175                 return (iRead==0) ? UNZ_EOF : iRead;
1176             if (pfile_in_zip_read_info-&gt;stream.avail_out &lt;
1177                             pfile_in_zip_read_info-&gt;stream.avail_in)
1178                 uDoCopy = pfile_in_zip_read_info-&gt;stream.avail_out ;
1179             else
1180                 uDoCopy = pfile_in_zip_read_info-&gt;stream.avail_in ;
1181             for (i=0;i&lt;uDoCopy;i++)
1182                 *(pfile_in_zip_read_info-&gt;stream.next_out+i) =
1183                         *(pfile_in_zip_read_info-&gt;stream.next_in+i);
1184             pfile_in_zip_read_info-&gt;total_out_64 = pfile_in_zip_read_info-&gt;total_out_64 + uDoCopy;
1185             pfile_in_zip_read_info-&gt;crc32 = crc32(pfile_in_zip_read_info-&gt;crc32,
1186                                 pfile_in_zip_read_info-&gt;stream.next_out,
1187                                 uDoCopy);
1188             pfile_in_zip_read_info-&gt;rest_read_uncompressed-=uDoCopy;
1189             pfile_in_zip_read_info-&gt;stream.avail_in -= uDoCopy;
1190             pfile_in_zip_read_info-&gt;stream.avail_out -= uDoCopy;
1191             pfile_in_zip_read_info-&gt;stream.next_out += uDoCopy;
1192             pfile_in_zip_read_info-&gt;stream.next_in += uDoCopy;
1193             pfile_in_zip_read_info-&gt;stream.total_out += uDoCopy;
1194             iRead += uDoCopy;
1195         }
1196         else if (pfile_in_zip_read_info-&gt;compression_method==Z_BZIP2ED)
1197         {
1198 #ifdef HAVE_BZIP2
1199             uLong uTotalOutBefore,uTotalOutAfter;
1200             const Bytef *bufBefore;
1201             uLong uOutThis;
1202             pfile_in_zip_read_info-&gt;bstream.next_in        = (char*)pfile_in_zip_read_info-&gt;stream.next_in;
1203             pfile_in_zip_read_info-&gt;bstream.avail_in       = pfile_in_zip_read_info-&gt;stream.avail_in;
1204             pfile_in_zip_read_info-&gt;bstream.total_in_lo32  = pfile_in_zip_read_info-&gt;stream.total_in;
1205             pfile_in_zip_read_info-&gt;bstream.total_in_hi32  = 0;
1206             pfile_in_zip_read_info-&gt;bstream.next_out       = (char*)pfile_in_zip_read_info-&gt;stream.next_out;
1207             pfile_in_zip_read_info-&gt;bstream.avail_out      = pfile_in_zip_read_info-&gt;stream.avail_out;
1208             pfile_in_zip_read_info-&gt;bstream.total_out_lo32 = pfile_in_zip_read_info-&gt;stream.total_out;
1209             pfile_in_zip_read_info-&gt;bstream.total_out_hi32 = 0;
1210             uTotalOutBefore = pfile_in_zip_read_info-&gt;bstream.total_out_lo32;
1211             bufBefore = (const Bytef *)pfile_in_zip_read_info-&gt;bstream.next_out;
1212             err=BZ2_bzDecompress(&amp;pfile_in_zip_read_info-&gt;bstream);
1213             uTotalOutAfter = pfile_in_zip_read_info-&gt;bstream.total_out_lo32;
1214             uOutThis = uTotalOutAfter-uTotalOutBefore;
1215             pfile_in_zip_read_info-&gt;total_out_64 = pfile_in_zip_read_info-&gt;total_out_64 + uOutThis;
1216             pfile_in_zip_read_info-&gt;crc32 = crc32(pfile_in_zip_read_info-&gt;crc32,bufBefore, (uInt)(uOutThis));
1217             pfile_in_zip_read_info-&gt;rest_read_uncompressed -= uOutThis;
1218             iRead += (uInt)(uTotalOutAfter - uTotalOutBefore);
1219             pfile_in_zip_read_info-&gt;stream.next_in   = (Bytef*)pfile_in_zip_read_info-&gt;bstream.next_in;
1220             pfile_in_zip_read_info-&gt;stream.avail_in  = pfile_in_zip_read_info-&gt;bstream.avail_in;
1221             pfile_in_zip_read_info-&gt;stream.total_in  = pfile_in_zip_read_info-&gt;bstream.total_in_lo32;
1222             pfile_in_zip_read_info-&gt;stream.next_out  = (Bytef*)pfile_in_zip_read_info-&gt;bstream.next_out;
1223             pfile_in_zip_read_info-&gt;stream.avail_out = pfile_in_zip_read_info-&gt;bstream.avail_out;
1224             pfile_in_zip_read_info-&gt;stream.total_out = pfile_in_zip_read_info-&gt;bstream.total_out_lo32;
1225             if (err==BZ_STREAM_END)
1226               return (iRead==0) ? UNZ_EOF : iRead;
1227             if (err!=BZ_OK)
1228               break;
1229 #endif
1230         }         else
1231         {
1232             ZPOS64_T uTotalOutBefore,uTotalOutAfter;
1233             const Bytef *bufBefore;
1234             ZPOS64_T uOutThis;
1235             int flush=Z_SYNC_FLUSH;
1236             uTotalOutBefore = pfile_in_zip_read_info-&gt;stream.total_out;
1237             bufBefore = pfile_in_zip_read_info-&gt;stream.next_out;
1238             err=inflate(&amp;pfile_in_zip_read_info-&gt;stream,flush);
1239             if ((err&gt;=0) &amp;&amp; (pfile_in_zip_read_info-&gt;stream.msg!=NULL))
1240               err = Z_DATA_ERROR;
1241             uTotalOutAfter = pfile_in_zip_read_info-&gt;stream.total_out;
1242             uOutThis = uTotalOutAfter-uTotalOutBefore;
1243             pfile_in_zip_read_info-&gt;total_out_64 = pfile_in_zip_read_info-&gt;total_out_64 + uOutThis;
1244             pfile_in_zip_read_info-&gt;crc32 =
1245                 crc32(pfile_in_zip_read_info-&gt;crc32,bufBefore,
1246                         (uInt)(uOutThis));
1247             pfile_in_zip_read_info-&gt;rest_read_uncompressed -=
1248                 uOutThis;
1249             iRead += (uInt)(uTotalOutAfter - uTotalOutBefore);
1250             if (err==Z_STREAM_END)
1251                 return (iRead==0) ? UNZ_EOF : iRead;
1252             if (err!=Z_OK)
1253                 break;
1254         }
1255     }
1256     if (err==Z_OK)
1257         return iRead;
1258     return err;
1259 }
1260 extern z_off_t ZEXPORT unztell (unzFile file)
1261 {
1262     unz64_s* s;
1263     file_in_zip64_read_info_s* pfile_in_zip_read_info;
1264     if (file==NULL)
1265         return UNZ_PARAMERROR;
1266     s=(unz64_s*)file;
1267     pfile_in_zip_read_info=s-&gt;pfile_in_zip_read;
1268     if (pfile_in_zip_read_info==NULL)
1269         return UNZ_PARAMERROR;
1270     return (z_off_t)pfile_in_zip_read_info-&gt;stream.total_out;
1271 }
1272 extern ZPOS64_T ZEXPORT unztell64 (unzFile file)
1273 {
1274     unz64_s* s;
1275     file_in_zip64_read_info_s* pfile_in_zip_read_info;
1276     if (file==NULL)
1277         return (ZPOS64_T)-1;
1278     s=(unz64_s*)file;
1279     pfile_in_zip_read_info=s-&gt;pfile_in_zip_read;
1280     if (pfile_in_zip_read_info==NULL)
1281         return (ZPOS64_T)-1;
1282     return pfile_in_zip_read_info-&gt;total_out_64;
1283 }
1284 extern int ZEXPORT unzeof (unzFile file)
1285 {
1286     unz64_s* s;
1287     file_in_zip64_read_info_s* pfile_in_zip_read_info;
1288     if (file==NULL)
1289         return UNZ_PARAMERROR;
1290     s=(unz64_s*)file;
1291     pfile_in_zip_read_info=s-&gt;pfile_in_zip_read;
1292     if (pfile_in_zip_read_info==NULL)
1293         return UNZ_PARAMERROR;
1294     if (pfile_in_zip_read_info-&gt;rest_read_uncompressed == 0)
1295         return 1;
1296     else
1297         return 0;
1298 }
1299 extern int ZEXPORT unzGetLocalExtrafield (unzFile file, voidp buf, unsigned len)
1300 {
1301     unz64_s* s;
1302     file_in_zip64_read_info_s* pfile_in_zip_read_info;
1303     uInt read_now;
1304     ZPOS64_T size_to_read;
1305     if (file==NULL)
1306         return UNZ_PARAMERROR;
1307     s=(unz64_s*)file;
1308     pfile_in_zip_read_info=s-&gt;pfile_in_zip_read;
1309     if (pfile_in_zip_read_info==NULL)
1310         return UNZ_PARAMERROR;
1311     size_to_read = (pfile_in_zip_read_info-&gt;size_local_extrafield -
1312                 pfile_in_zip_read_info-&gt;pos_local_extrafield);
1313     if (buf==NULL)
1314         return (int)size_to_read;
1315     if (len&gt;size_to_read)
1316         read_now = (uInt)size_to_read;
1317     else
1318         read_now = (uInt)len ;
1319     if (read_now==0)
1320         return 0;
1321     if (ZSEEK64(pfile_in_zip_read_info-&gt;z_filefunc,
1322               pfile_in_zip_read_info-&gt;filestream,
1323               pfile_in_zip_read_info-&gt;offset_local_extrafield +
1324               pfile_in_zip_read_info-&gt;pos_local_extrafield,
1325               ZLIB_FILEFUNC_SEEK_SET)!=0)
1326         return UNZ_ERRNO;
1327     if (ZREAD64(pfile_in_zip_read_info-&gt;z_filefunc,
1328               pfile_in_zip_read_info-&gt;filestream,
1329               buf,read_now)!=read_now)
1330         return UNZ_ERRNO;
1331     return (int)read_now;
1332 }
1333 extern int ZEXPORT unzCloseCurrentFile (unzFile file)
1334 {
1335     int err=UNZ_OK;
1336     unz64_s* s;
1337     file_in_zip64_read_info_s* pfile_in_zip_read_info;
1338     if (file==NULL)
1339         return UNZ_PARAMERROR;
1340     s=(unz64_s*)file;
1341     pfile_in_zip_read_info=s-&gt;pfile_in_zip_read;
1342     if (pfile_in_zip_read_info==NULL)
1343         return UNZ_PARAMERROR;
1344     if ((pfile_in_zip_read_info-&gt;rest_read_uncompressed == 0) &amp;&amp;
1345         (!pfile_in_zip_read_info-&gt;raw))
1346     {
1347         if (pfile_in_zip_read_info-&gt;crc32 != pfile_in_zip_read_info-&gt;crc32_wait)
1348             err=UNZ_CRCERROR;
1349     }
1350     TRYFREE(pfile_in_zip_read_info-&gt;read_buffer);
1351     pfile_in_zip_read_info-&gt;read_buffer = NULL;
1352     if (pfile_in_zip_read_info-&gt;stream_initialised == Z_DEFLATED)
1353         inflateEnd(&amp;pfile_in_zip_read_info-&gt;stream);
1354 #ifdef HAVE_BZIP2
1355     else if (pfile_in_zip_read_info-&gt;stream_initialised == Z_BZIP2ED)
1356         BZ2_bzDecompressEnd(&amp;pfile_in_zip_read_info-&gt;bstream);
1357 #endif
1358     pfile_in_zip_read_info-&gt;stream_initialised = 0;
1359     TRYFREE(pfile_in_zip_read_info);
1360     s-&gt;pfile_in_zip_read=NULL;
1361     return err;
1362 }
1363 extern int ZEXPORT unzGetGlobalComment (unzFile file, char * szComment, uLong uSizeBuf)
1364 {
1365     unz64_s* s;
1366     uLong uReadThis ;
1367     if (file==NULL)
1368         return (int)UNZ_PARAMERROR;
1369     s=(unz64_s*)file;
1370     uReadThis = uSizeBuf;
1371     if (uReadThis&gt;s-&gt;gi.size_comment)
1372         uReadThis = s-&gt;gi.size_comment;
1373     if (ZSEEK64(s-&gt;z_filefunc,s-&gt;filestream,s-&gt;central_pos+22,ZLIB_FILEFUNC_SEEK_SET)!=0)
1374         return UNZ_ERRNO;
1375     if (uReadThis&gt;0)
1376     {
1377       *szComment='\0';
1378       if (ZREAD64(s-&gt;z_filefunc,s-&gt;filestream,szComment,uReadThis)!=uReadThis)
1379         return UNZ_ERRNO;
1380     }
1381     if ((szComment != NULL) &amp;&amp; (uSizeBuf &gt; s-&gt;gi.size_comment))
1382         *(szComment+s-&gt;gi.size_comment)='\0';
1383     return (int)uReadThis;
1384 }
1385 extern ZPOS64_T ZEXPORT unzGetOffset64(unzFile file)
1386 {
1387     unz64_s* s;
1388     if (file==NULL)
1389           return 0; //UNZ_PARAMERROR;
1390     s=(unz64_s*)file;
1391     if (!s-&gt;current_file_ok)
1392       return 0;
1393     if (s-&gt;gi.number_entry != 0 &amp;&amp; s-&gt;gi.number_entry != 0xffff)
1394       if (s-&gt;num_file==s-&gt;gi.number_entry)
1395          return 0;
1396     return s-&gt;pos_in_central_dir;
1397 }
1398 extern uLong ZEXPORT unzGetOffset (unzFile file)
1399 {
1400     ZPOS64_T offset64;
1401     if (file==NULL)
1402           return 0; //UNZ_PARAMERROR;
1403     offset64 = unzGetOffset64(file);
1404     return (uLong)offset64;
1405 }
1406 extern int ZEXPORT unzSetOffset64(unzFile file, ZPOS64_T pos)
1407 {
1408     unz64_s* s;
1409     int err;
1410     if (file==NULL)
1411         return UNZ_PARAMERROR;
1412     s=(unz64_s*)file;
1413     s-&gt;pos_in_central_dir = pos;
1414     s-&gt;num_file = s-&gt;gi.number_entry;          err = unz64local_GetCurrentFileInfoInternal(file,&amp;s-&gt;cur_file_info,
1415                                               &amp;s-&gt;cur_file_info_internal,
1416                                               NULL,0,NULL,0,NULL,0);
1417     s-&gt;current_file_ok = (err == UNZ_OK);
1418     return err;
1419 }
1420 extern int ZEXPORT unzSetOffset (unzFile file, uLong pos)
1421 {
1422     return unzSetOffset64(file,pos);
1423 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
