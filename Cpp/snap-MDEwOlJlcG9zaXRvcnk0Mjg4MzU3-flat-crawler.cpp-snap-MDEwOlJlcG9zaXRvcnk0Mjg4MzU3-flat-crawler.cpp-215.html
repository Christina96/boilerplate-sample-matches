
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 29, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-crawler.cpp</h3>
            <pre><code>1  #include &quot;crawler.h&quot;
2  bool TCrawlerDef::IsHostNmOk(const TStr&amp; HostNm){
3    bool HostNmOkP=false;
4    if (RqDmNmV.Empty()){
5      HostNmOkP=true;
6    } else {
7      for (int RqDmNmN=0; RqDmNmN&lt;RqDmNmV.Len(); RqDmNmN++){
8        if (HostNm.IsSuffix(RqDmNmV[RqDmNmN])){
9          HostNmOkP=true; break;
10        }
11      }
12    }
13    if (HostNmOkP){
14      for (int BadDmNmN=0; BadDmNmN&lt;BadDmNmV.Len(); BadDmNmN++){
15        if (HostNm.IsSuffix(BadDmNmV[BadDmNmN])){
16          HostNmOkP=false; break;
17        }
18      }
19    }
20    return HostNmOkP;
21  }
22  bool TCrawlerDef::IsContTypeNmOk(const TStr&amp; ContTypeNm){
23    if (RqContTypeNmV.Empty()){
24      return true;
25    } else {
26      TStr LcContTypeNm=ContTypeNm.GetLc();
27      for (int ContTypeNmN=0; ContTypeNmN&lt;RqContTypeNmV.Len(); ContTypeNmN++){
28        if (LcContTypeNm.IsWcMatch(RqContTypeNmV[ContTypeNmN])){return true;}
29      }
30      return false;
31    }
32  }
33  bool TCrawlerDef::IsFExtOk(const PUrl&amp; Url) const {
34    if (BadFExtV.Empty()||(Url-&gt;GetPathSegs()==0)){
35      return true;
36    } else {
37      TStr UrlStr=Url-&gt;GetUrlStr();
38      TStr FBase=Url-&gt;GetPathSeg(Url-&gt;GetPathSegs()-1);
39      TStr FExt=FBase.GetFExt().GetUc();
40      return (!BadFExtH.IsKey(FExt));
41    }
42  }
43  void TCrawlerDef::OptHtmlCrawling(){
44    AddBadFExt(&quot;.JPEG&quot;); AddBadFExt(&quot;.JPG&quot;); AddBadFExt(&quot;.GIF&quot;); AddBadFExt(&quot;.BMP&quot;);
45    AddBadFExt(&quot;.MPEG&quot;); AddBadFExt(&quot;.MPG&quot;); AddBadFExt(&quot;.AVI&quot;); AddBadFExt(&quot;.MOV&quot;);
46    AddBadFExt(&quot;.MP3&quot;); AddBadFExt(&quot;.WAV&quot;); AddBadFExt(&quot;.MID&quot;); AddBadFExt(&quot;.RA&quot;);
47    AddBadFExt(&quot;.ZIP&quot;); AddBadFExt(&quot;.RAR&quot;); AddBadFExt(&quot;.GZ&quot;); AddBadFExt(&quot;.TAR&quot;);
48    AddBadFExt(&quot;.PDF&quot;); AddBadFExt(&quot;.DOC&quot;); AddBadFExt(&quot;.XSL&quot;); AddBadFExt(&quot;.PPT&quot;);
49    AddRqContTypeNm(&quot;text&amp;bsol;*&quot;);
50  }
51  void TCrawlerDef::AddSiteUrlStr(const TStr&amp; SiteUrlStr){
52    PUrl Url=TUrl::New(SiteUrlStr);
53    if (Url-&gt;IsOk(usHttp)){
54      AddRqDmNm(Url-&gt;GetHostNm());
55      AddStartUrlStr(SiteUrlStr);
56    }
57  }
58  void TCrawlerDef::AddSiteUrlStrV(const TStrV&amp; SiteUrlStrV){
59    for (int UrlStrN=0; UrlStrN&lt;SiteUrlStrV.Len(); UrlStrN++){
60      AddSiteUrlStr(SiteUrlStrV[UrlStrN]);
61    }
62  }
63  void TCrawlerDef::LoadUrlStrV(const TStr&amp; SiteUrlStrVFNm){
64    if (SiteUrlStrVFNm.Empty()){return;}
65    PSIn SIn=TFIn::New(SiteUrlStrVFNm);
66    TILx Lx(SIn);
67    while (Lx.GetSym(syLn, syEof)!=syEof){
68      TStr UrlStr=TStr(Lx.Str).GetTrunc();
69      AddSiteUrlStr(UrlStr);
70    }
71  }
72  TStr TCrawlerDef::GetStr(){
73    TChA ChA;
74    ChA+=TStr::Fmt(&quot;                  Max. Urls: %d\n&quot;, GetMxUrls());
75    ChA+=TStr::Fmt(&quot;           Min. Connections: %d\n&quot;, GetMnConns());
76    ChA+=TStr::Fmt(&quot;           Max. Connections: %d\n&quot;, GetMxConns());
77    ChA+=TStr::Fmt(&quot;Max. Connections Per Server: %d\n&quot;, GetMxConnsPerSrv());
78    ChA+=TStr::Fmt(&quot;          After Fetch Delay: %d\n&quot;, GetAfterFetchDelaySecs());
79    ChA+=TStr::Fmt(&quot;                 Max. Level: %d\n&quot;, GetMxLev());
80    ChA+=TStr::Fmt(&quot;                 Max. Depth: %d\n&quot;, GetMxDep());
81    ChA+=TStr::Fmt(&quot;        Max. Content Length: %d\n&quot;, GetMxContLen());
82    ChA+=TStr::Fmt(&quot;          Min. Queue Length: %d\n&quot;, GetMnQLen());
83    ChA+=TStr::Fmt(&quot;         Queue Reset Modulo: %d\n&quot;, GetQResetMod());
84    ChA+=TStr::Fmt(&quot;  Max. Queue Segment Length: %d\n&quot;, GetMxQSegLen());
85    ChA+=TStr::Fmt(&quot;               Max. Retries: %d\n&quot;, GetMxRetries());
86    ChA+=TStr::Fmt(&quot;           Revisits Seconds: %d\n&quot;, GetRevisitSecs());
87    ChA+=TStr::Fmt(&quot;Redirection Domains Allowed: %d\n&quot;, TBool::GetYesNoStr(IsRedirDmAllowed()));
88    ChA+=TStr::Fmt(&quot;                 Start Urls:&quot;);
89    for (int UrlN=0; UrlN&lt;GetStartUrls(); UrlN++){
90      ChA+=&quot; &quot;; ChA+=GetStartUrl(UrlN);}
91    ChA+=&quot;\n&quot;;
92    ChA+=TStr::Fmt(&quot;           Required Domains:&quot;);
93    for (int DmNmN=0; DmNmN&lt;RqDmNmV.Len(); DmNmN++){
94      ChA+=&quot; &quot;; ChA+=RqDmNmV[DmNmN];}
95    ChA+=&quot;\n&quot;;
96    ChA+=TStr::Fmt(&quot;                Bad Domains:&quot;);
97    for (int DmNmN=0; DmNmN&lt;BadDmNmV.Len(); DmNmN++){
98      ChA+=&quot; &quot;; ChA+=BadDmNmV[DmNmN];}
99    ChA+=&quot;\n&quot;;
100    ChA+=TStr::Fmt(&quot;                Geo-IP Base: %s\n&quot;, TBool::GetYesNoStr(IsGeoIpBs()).CStr());
101    ChA+=TStr::Fmt(&quot;                  Countries:&quot;);
102    for (int CountryNmN=0; CountryNmN&lt;RqCountryNmV.Len(); CountryNmN++){
103      ChA+=&quot; &quot;; ChA+=RqCountryNmV[CountryNmN];}
104    ChA+=&quot;\n&quot;;
105    ChA+=TStr::Fmt(&quot;              Content Types:&quot;);
106    for (int ContTypeNmN=0; ContTypeNmN&lt;RqContTypeNmV.Len(); ContTypeNmN++){
107      ChA+=&quot; &quot;; ChA+=RqContTypeNmV[ContTypeNmN];}
108    ChA+=&quot;\n&quot;;
109    ChA+=TStr::Fmt(&quot;        Bad File Extensions:&quot;);
110    for (int FExtN=0; FExtN&lt;BadFExtV.Len(); FExtN++){
111      ChA+=&quot; &quot;; ChA+=BadFExtV[FExtN];}
112    ChA+=&quot;\n&quot;;
113    return ChA;
114  }
115  TCrawlerUrlDescBs::TCrawlerUrlDescBs(TCrawler* _Crawler):
116    Crawler(_Crawler){
117    IAssert(Crawler-&gt;GetDef()-&gt;GetMxUrls()!=-1);
118    UrlMd5SigToDescH.Gen(Crawler-&gt;GetDef()-&gt;GetMxUrls());
119  }
120  TStr TCrawlerUrlDescBs::GetFNm() const {
121    return
122     Crawler-&gt;GetDocBs()-&gt;GetDocBsNrFPath()+
123     Crawler-&gt;GetDocBs()-&gt;GetDocBsNm()+&quot;.UrlBs&quot;;
124  }
125  void TCrawlerUrlDescBs::Load(){
126    TFIn SIn(GetFNm()); UrlMd5SigToDescH.Load(SIn);
127  }
128  void TCrawlerUrlDescBs::Save(){
129    TFOut SOut(GetFNm()); UrlMd5SigToDescH.Save(SOut);
130  }
131  TCrawlerHostBs::TCrawlerHostBs(TCrawler* _Crawler):
132    Crawler(_Crawler){
133  }
134  PCrawlerHost TCrawlerHostBs::AddGetHost(const TStr&amp; HostNm){
135    int HostId;
136    if (!NmToHostH.IsKey(HostNm, HostId)){
137      HostId=NmToHostH.AddKey(HostNm);
138      NmToHostH[HostId]=TCrawlerHost::New(HostNm);
139    }
140    return NmToHostH[HostId];
141  }
142  void TCrawlerHostBs::GetSortedHostV(TCrawlerHostV&amp; HostV, const TStr&amp; SortOrderNm){
143    typedef TKeyDat&lt;TStr, PCrawlerHost&gt; TNmHostKd;
144    TVec&lt;TNmHostKd&gt; NmHostKdV;
145    int Hosts=GetHosts(); bool SortAscP=true;
146    for (int HostN=0; HostN&lt;Hosts; HostN++){
147      PCrawlerHost Host=GetHost(HostN);
148      TStr KeyStr;
149      if (SortOrderNm==&quot;Host&quot;){KeyStr=Host-&gt;GetRevHostNm(); SortAscP=true;}
150      else if (SortOrderNm==&quot;Active&quot;){KeyStr=TInt::GetStr(Host-&gt;GetActiveConns(), &quot;%012d&quot;); SortAscP=false;}
151      else if (SortOrderNm==&quot;Fetched&quot;){KeyStr=TInt::GetStr(Host-&gt;GetFetchedUrls(), &quot;%012d&quot;); SortAscP=false;}
152      else if (SortOrderNm==&quot;Errors&quot;){KeyStr=TInt::GetStr(Host-&gt;GetFetchErrors(), &quot;%012d&quot;); SortAscP=false;}
153      else if (SortOrderNm==&quot;Queue&quot;){KeyStr=TInt::GetStr(Host-&gt;GetQueueUrls(), &quot;%012d&quot;); SortAscP=false;}
154      else if (SortOrderNm==&quot;Bytes&quot;){KeyStr=TFlt::GetStr(double(Host-&gt;GetTransferBytes()), &quot;%012.0f&quot;); SortAscP=false;}
155      else if (SortOrderNm==&quot;Time&quot;){KeyStr=TFlt::GetStr(Host-&gt;GetTransferMSecs(), &quot;%012.0f&quot;); SortAscP=false;}
156      else if (SortOrderNm==&quot;PageLen&quot;){KeyStr=TFlt::GetStr(Host-&gt;GetAvgHttpRespLen(), &quot;%012.0f&quot;); SortAscP=false;}
157      else if (SortOrderNm==&quot;Speed&quot;){KeyStr=TFlt::GetStr(Host-&gt;GetAvgTransferBps(), &quot;%012.0f&quot;); SortAscP=false;}
158      else {KeyStr=Host-&gt;GetRevHostNm(); SortAscP=true;}
159      NmHostKdV.Add(TNmHostKd(KeyStr, Host));
160    }
161    NmHostKdV.Sort(SortAscP);
162    HostV.Gen(NmHostKdV.Len(), 0);
163    for (int HostN=0; HostN&lt;NmHostKdV.Len(); HostN++){
164      HostV.Add(NmHostKdV[HostN].Dat);
165    }
166  }
167  void TCrawlerHostBs::GetSummaryInfo(
168   int&amp; ActiveConns, int&amp; FetchedUrls, int&amp; FetchErrors, int&amp; QueueUrls, 
169   double&amp; TransferBytes, double&amp; TransferMSecs, double&amp; AvgHttpRespLen, 
170   double&amp; AvgTransferBps){
171    ActiveConns=0; FetchedUrls=0; FetchErrors=0; QueueUrls=0;
172    TransferBytes=0; TransferMSecs=0; 
173    AvgHttpRespLen=0; AvgTransferBps=0;
174    int Hosts=GetHosts();
175    for (int HostN=0; HostN&lt;Hosts; HostN++){
176      PCrawlerHost Host=GetHost(HostN);
177      ActiveConns+=Host-&gt;GetActiveConns();
178      FetchedUrls+=Host-&gt;GetFetchedUrls();
179      FetchErrors+=Host-&gt;GetFetchErrors();
180      QueueUrls+=Host-&gt;GetQueueUrls();
181      TransferBytes+=Host-&gt;GetTransferBytes();
182      TransferMSecs+=Host-&gt;GetTransferMSecs();
183      AvgHttpRespLen+=Host-&gt;GetAvgHttpRespLen();
184      AvgTransferBps+=Host-&gt;GetAvgTransferBps();
185    }
186    if (Hosts&gt;0){
187      AvgHttpRespLen=AvgHttpRespLen/Hosts;
188      AvgTransferBps=AvgTransferBps/Hosts;
189    }
190  }
191  TCrawlerQueue::TCrawlerQueue(TCrawler* _Crawler):
192    Crawler(_Crawler), UrlMd5SigToUrlStrHostNmLevDepQuH(){
193  }
194  void TCrawlerQueue::GetQUrlsHostPrV(TIntStrPrV&amp; QUrlsHostPrV){
195    QUrlsHostPrV.Clr();
196    TStrIntH HostToQUrlsH;
197    int QUrlP=UrlMd5SigToUrlStrHostNmLevDepQuH.FFirstKeyId();
198    while (UrlMd5SigToUrlStrHostNmLevDepQuH.FNextKeyId(QUrlP)){
199      TStr HostNm=GetQHostNm(QUrlP);
200      int Lev=GetQUrlLev(QUrlP);
201      HostToQUrlsH.AddDat(HostNm+&quot;:&quot;+TInt::GetStr(Lev))++;
202    }
203    HostToQUrlsH.GetDatKeyPrV(QUrlsHostPrV);
204    QUrlsHostPrV.Sort(false);
205  }
206  void TCrawlerQueue::PushQUrl(const PUrl&amp; Url, const int&amp; Lev, const int&amp; Dep){
207    PCrawlerDef Def=Crawler-&gt;GetDef();
208    PCrawlerUrlDescBs UrlDescBs=Crawler-&gt;GetUrlDescBs();
209    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
210    IAssert(Url-&gt;IsOk(usHttp));
211    TMd5Sig UrlMd5Sig=TCrawler::GetUrlMd5Sig(Url-&gt;GetUrlStr());
212    if (UrlDescBs-&gt;IsUrl(UrlMd5Sig)){ 
213      if (UrlDescBs-&gt;GetUrlDesc(UrlMd5Sig).DocLev&gt;Lev){
214        UrlDescBs-&gt;GetUrlDesc(UrlMd5Sig).DocLev=Lev;}
215    } else
216    if (IsQUrl(UrlMd5Sig)){ 
217    } else
218    if ((Def-&gt;GetMxLev()==-1)||(Lev&lt;=Def-&gt;GetMxLev())&amp;&amp;
219     ((Def-&gt;GetMxDep()==-1)||(Dep&lt;=Def-&gt;GetMxDep()))){
220      int QUrlId=AddQUrl(UrlMd5Sig, Url-&gt;GetUrlStr(), Url-&gt;GetHostNm(), Lev, Dep);
221      while (LevUrlIdQV.Len()-1&lt;Lev){LevUrlIdQV.Add();}
222      LevUrlIdQV[Lev].Push(QUrlId);
223      HostBs-&gt;AddGetHost(Url-&gt;GetHostNm())-&gt;GetQueueUrls()++;
224    }
225  }
226  void TCrawlerQueue::PushQUrl(const TStr&amp; UrlStr, const int&amp; Lev, const int&amp; Dep){
227    PUrl Url=TUrl::New(UrlStr);
228    if (Url-&gt;IsOk(usHttp)){
229      PushQUrl(Url, Lev, Dep);
230    }
231  }
232  bool TCrawlerQueue::PopQUrl(int&amp; QUrlId, TStr&amp; UrlStr){
233    PCrawlerDef Def=Crawler-&gt;GetDef();
234    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
235    int MxCheckedUrlsPerLev=100; 
236    while (MxCheckedUrlsPerLev&lt;=100000){
237      for (int Lev=0; Lev&lt;LevUrlIdQV.Len(); Lev++){
238        int CheckedUrls=0;
239        if (!LevUrlIdQV[Lev].Empty()){
240          bool FirstP=true; int FirstQUrlId;
241          forever {
242            QUrlId=LevUrlIdQV[Lev].Top();
243            if (FirstP){FirstQUrlId=QUrlId; FirstP=false;}
244            else if (QUrlId==FirstQUrlId){break;}
245            CheckedUrls++;
246            if (CheckedUrls&gt;MxCheckedUrlsPerLev){break;}
247            LevUrlIdQV[Lev].Pop();
248            UrlStr=GetQUrlStr(QUrlId);
249            TStr HostNm=GetQHostNm(QUrlId);
250            PCrawlerHost Host=HostBs-&gt;AddGetHost(HostNm);
251            int ActiveConns=Host-&gt;GetActiveConns();
252            int MxConnsPerSrv=Def-&gt;GetMxConnsPerSrv();
253            TSecTm LastFetchTm=Host-&gt;GetLastFetchTm();
254            TSecTm CurTm=TSecTm::GetCurTm();
255            int AfterFetchDelaySecs=Def-&gt;GetAfterFetchDelaySecs();
256  		  int FetchDSecs=TInt::Abs(TSecTm::GetDSecs(LastFetchTm, CurTm));
257            if ((ActiveConns&lt;MxConnsPerSrv)&amp;&amp;(FetchDSecs&gt;=AfterFetchDelaySecs)){
258              Host-&gt;GetQueueUrls()--;
259              return true;
260            } else {
261              LevUrlIdQV[Lev].Push(QUrlId);
262            }
263          }
264        }
265      }
266      MxCheckedUrlsPerLev=MxCheckedUrlsPerLev*10;
267    }
268    return false;
269  }
270  void TCrawlerQueue::ShuffleUrlQ(){
271    if (Crawler-&gt;GetUrlDescBs()-&gt;GetUrls()%1000==0){
272      printf(&quot;*** Shuffle Queues\n&quot;);
273      for (int Lev=0; Lev&lt;LevUrlIdQV.Len(); Lev++){
274        TRnd Rnd(0); LevUrlIdQV[Lev].Shuffle(Rnd);
275        printf(&quot;    Queue Level %d: %d\n&quot;, Lev, LevUrlIdQV[Lev].Len());
276      }
277    }
278  }
279  void TCrawlerQueue::ResetQUrlBs(){
280    PCrawlerDef Def=Crawler-&gt;GetDef();
281    PCrawlerUrlDescBs UrlDescBs=Crawler-&gt;GetUrlDescBs();
282    if ((Def-&gt;GetQResetMod()&gt;0)&amp;&amp;(UrlDescBs-&gt;GetUrls()%Def-&gt;GetQResetMod()==0)){
283      PopSaveQUrlBs();
284      PushQUrlBs();
285    }
286  }
287  TStr TCrawlerQueue::GetUrlQBBsFNm() const {
288    TStr UrlQBBsFNm=
289     Crawler-&gt;GetDocBs()-&gt;GetDocBsNrFPath()+
290     Crawler-&gt;GetDocBs()-&gt;GetDocBsNm()+&quot;.&quot;+
291     TTm::GetUniqueCurUniTm().GetIdStr()+&quot;.UrlQBs&quot;;
292    return UrlQBBsFNm;
293  }
294  TStr TCrawlerQueue::GetUrlQBBsWcFNm() const {
295    TStr UrlQBBsFNm=
296     Crawler-&gt;GetDocBs()-&gt;GetDocBsNrFPath()+
297     Crawler-&gt;GetDocBs()-&gt;GetDocBsNm()+&quot;.*.UrlQBs&quot;;
298    return UrlQBBsFNm;
299  }
300  void TCrawlerQueue::PushQUrlBs(){
301    if (Empty()){
302      UrlMd5SigToUrlStrHostNmLevDepQuH.Clr(); 
303      LevUrlIdQV.Clr(); 
304    }
305    UrlQBBs=NULL; 
306    if (!ToDelUrlQBBsFNm.Empty()){ 
307      TFile::Del(ToDelUrlQBBsFNm); ToDelUrlQBBsFNm=&quot;&quot;;
308    }
309    TFFile FFile(GetUrlQBBsWcFNm(), false); TStr UrlQBBsFNm;
310    if (FFile.Next(UrlQBBsFNm)){
311      PBlobBs UrlQBBs=TGBlobBs::New(UrlQBBsFNm);
312      ToDelUrlQBBsFNm=UrlQBBsFNm;
313      TBlobPt TrvUrlQBlobPt=UrlQBBs-&gt;FFirstBlobPt();
314      TBlobPt UrlQBlobPt; PSIn UrlQBlobSIn;
315      while (UrlQBBs-&gt;FNextBlobPt(TrvUrlQBlobPt, UrlQBlobPt, UrlQBlobSIn)){
316        TStr UrlStr=TStr(*UrlQBlobSIn);
317        int Lev=TInt(*UrlQBlobSIn);
318        int Dep=TInt(*UrlQBlobSIn);
319        PushQUrl(UrlStr, Lev, Dep);
320      }
321    }
322  }
323  void TCrawlerQueue::PushQUrlToUrlQBs(const PUrl&amp; Url, const int&amp; Lev, const int&amp; Dep){
324    PCrawlerDef Def=Crawler-&gt;GetDef();
325    PCrawlerUrlDescBs UrlDescBs=Crawler-&gt;GetUrlDescBs();
326    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
327    IAssert(Url-&gt;IsOk(usHttp));
328    TMd5Sig UrlMd5Sig=TCrawler::GetUrlMd5Sig(Url-&gt;GetUrlStr());
329    if (UrlDescBs-&gt;IsUrl(UrlMd5Sig)){ 
330      if (UrlDescBs-&gt;GetUrlDesc(UrlMd5Sig).DocLev&gt;Lev){
331        UrlDescBs-&gt;GetUrlDesc(UrlMd5Sig).DocLev=Lev;}
332    } else
333    if (IsQUrl(UrlMd5Sig)){ 
334    } else
335    if ((Def-&gt;GetMxLev()==-1)||(Lev&lt;=Def-&gt;GetMxLev())&amp;&amp;
336     ((Def-&gt;GetMxDep()==-1)||(Dep&lt;=Def-&gt;GetMxDep()))){
337      if (UrlQBBs.Empty()){
338        TStr UrlQBBsFNm=GetUrlQBBsFNm(); printf(&quot;*** %s\n&quot;, UrlQBBsFNm.CStr());
339        UrlQBBs=TGBlobBs::New(UrlQBBsFNm, faCreate, Def-&gt;GetMxQSegLen());
340      }
341      TMOut UrlQSOut(Url-&gt;GetUrlStr().Len()+100);
342      Url-&gt;GetUrlStr().Save(UrlQSOut);
343      TInt(Lev).Save(UrlQSOut);
<span onclick='openModal()' class='match'>344      TInt(Dep).Save(UrlQSOut);
345      PSIn UrlQSIn=UrlQSOut.GetSIn();
346      TBlobPt UrlQBlobPt=UrlQBBs-&gt;PutBlob(UrlQSIn);
347      if (UrlQBlobPt.Empty()){
</span>348        TStr UrlQBBsFNm=GetUrlQBBsFNm(); printf(&quot;*** %s\n&quot;, UrlQBBsFNm.CStr());
349        UrlQBBs=TGBlobBs::New(UrlQBBsFNm, faCreate, Def-&gt;GetMxQSegLen());
350        UrlQBlobPt=UrlQBBs-&gt;PutBlob(UrlQSIn);
351        IAssert(!UrlQBlobPt.Empty());
352      }
353    }
354  }
355  void TCrawlerQueue::PushQUrlToUrlQBs(const TStr&amp; UrlStr, const int&amp; Lev, const int&amp; Dep){
356    PUrl Url=TUrl::New(UrlStr);
357    if (Url-&gt;IsOk(usHttp)){
358      PushQUrlToUrlQBs(Url, Lev, Dep);
359    }
360  }
361  void TCrawlerQueue::PopSaveQUrlBs(){
362    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
363    PCrawlerFetcher Fetcher=Crawler-&gt;GetFetcher();
364    TStr UrlQBBsFNm=GetUrlQBBsFNm(); 
365    printf(&quot;*** Saving Active Queue-Url-Base To %s\n&quot;, UrlQBBsFNm.CStr());
366    UrlQBBs=TGBlobBs::New(UrlQBBsFNm, faCreate);
367    for (int Lev=0; Lev&lt;LevUrlIdQV.Len(); Lev++){
368      while (!LevUrlIdQV[Lev].Empty()){
369        int QUrlId=LevUrlIdQV[Lev].Top();
370        TStr HostNm=GetQHostNm(QUrlId);
371        PCrawlerHost Host=HostBs-&gt;GetHost(HostNm);
372        TStr UrlStr=GetQUrlStr(QUrlId);
373        int Dep=GetQUrlDep(QUrlId);
374        LevUrlIdQV[Lev].Pop();
375        Host-&gt;GetQueueUrls()--;
376        DelQUrl(QUrlId);
377        TMOut UrlQSOut(UrlStr.Len()+100);
378        UrlStr.Save(UrlQSOut);
379        TInt(Lev).Save(UrlQSOut);
380        TInt(Dep).Save(UrlQSOut);
381        PSIn UrlQSIn=UrlQSOut.GetSIn();
382        TBlobPt UrlQBlobPt=UrlQBBs-&gt;PutBlob(UrlQSIn);
383      }
384    }
385  }
386  void TCrawlerFetcher::DelCrawlerFetcherConn(const int&amp; ConnId){
387    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
388    int QUrlId; PUrl Url; int FetchMSecs; GetDelConn(ConnId, QUrlId, Url, FetchMSecs);
389    Crawler-&gt;GetQueue()-&gt;DelQUrl(QUrlId);
390    PCrawlerHost Host=HostBs-&gt;GetHost(Url-&gt;GetHostNm());
391    Host-&gt;GetActiveConns()--;
392    Host-&gt;GetFetchErrors()++;
393    Host-&gt;GetLastFetchTm()=TSecTm::GetCurTm();
394  }
395  TCrawlerFetcher::TCrawlerFetcher(TCrawler* _Crawler):
396    TWebPgFetch(), Crawler(_Crawler), CurMxConns(-1), 
397    LastClrZombiesTm(), Zombies(0), ZombieConnIdToFetchSizeH(){
398    IAssert(Crawler-&gt;GetDef()-&gt;GetMxConns()!=-1);
399    PutMxConns(Crawler-&gt;GetDef()-&gt;GetMxConns());
400    CurMxConns=1;
401    PutMxContLen(Crawler-&gt;GetDef()-&gt;GetMxContLen());
402    PutMxRetries(Crawler-&gt;GetDef()-&gt;GetMxRetries());
403    if (Crawler-&gt;GetDef()-&gt;GetUserAgentStr()==&quot;ie8&quot;){
404      PutUserAgentStrIE8();
405    } else {
406      PutUserAgentStr(Crawler-&gt;GetDef()-&gt;GetUserAgentStr());
407    }
408  }
409  void TCrawlerFetcher::GetConnV(TIntStrIntIntQuV&amp; ConnIdUrlStrMSecsSizeQuV){
410    ConnIdUrlStrMSecsSizeQuV.Gen(GetConns(), 0);
411    int ConnP=ConnIdToQUrlIdUrlTmTrH.FFirstKeyId();
412    while (ConnIdToQUrlIdUrlTmTrH.FNextKeyId(ConnP)){
413      int ConnId=ConnIdToQUrlIdUrlTmTrH.GetKey(ConnP);
414      TStr UrlStr=ConnIdToQUrlIdUrlTmTrH[ConnP].Val2-&gt;GetUrlStr();
415      int FetchMSecs=int(TTm::GetCurUniMSecs()-ConnIdToQUrlIdUrlTmTrH[ConnP].Val3);
416      int FetchSize=GetConnBytesRead(ConnId);
417      ConnIdUrlStrMSecsSizeQuV.Add(TIntStrIntIntQu(ConnId, UrlStr, FetchMSecs, FetchSize));
418    }
419    ConnIdUrlStrMSecsSizeQuV.Sort();
420  }
421  void TCrawlerFetcher::ClrZombies(){
422    PCrawlerDef Def=Crawler-&gt;GetDef();
423    PCrawlerQueue Queue=Crawler-&gt;GetQueue();
424    if ((LastClrZombiesTm.IsDef())&amp;&amp;(TTm::GetDiffMSecs(LastClrZombiesTm, TTm::GetCurUniTm())&lt;100000)){return;}
425    LastClrZombiesTm=TTm::GetCurUniTm();
426    TIntStrIntIntQuV ConnIdUrlStrMSecsSizeQuV; GetConnV(ConnIdUrlStrMSecsSizeQuV);
427    int ConnIds=ConnIdUrlStrMSecsSizeQuV.Len();
428    for (int ConnN=0; ConnN&lt;ConnIds; ConnN++){
429      int ConnId=ConnIdUrlStrMSecsSizeQuV[ConnN].Val1;
430      TStr UrlStr=ConnIdUrlStrMSecsSizeQuV[ConnN].Val2;
431      int FetchSize=ConnIdUrlStrMSecsSizeQuV[ConnN].Val4;
432      if (ZombieConnIdToFetchSizeH.IsKey(ConnId)){
433        int PrevFetchSize=ZombieConnIdToFetchSizeH.GetDat(ConnId);
434        if (FetchSize==PrevFetchSize){
435          printf(&quot;*** Zombie: %s\n&quot;, UrlStr.CStr()); 
436          Zombies++; 
437          DelConn(ConnId); 
438          DelCrawlerFetcherConn(ConnId); 
439          Queue()-&gt;PushQUrl(UrlStr, 0, 0); 
440          PutCurMxConns(Def-&gt;GetMnConns()); 
441        }
442      }
443    }
444    ZombieConnIdToFetchSizeH.Clr(false);
445    for (int ConnN=0; ConnN&lt;ConnIds; ConnN++){
446      int ConnId=ConnIdUrlStrMSecsSizeQuV[ConnN].Val1;
447      int FetchSize=ConnIdUrlStrMSecsSizeQuV[ConnN].Val4;
448      ZombieConnIdToFetchSizeH.AddDat(ConnId)=FetchSize;
449    }
450  }
451  void TCrawlerFetcher::Fetch(){
452    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
453    PCrawlerQueue Queue=Crawler-&gt;GetQueue();
454    int QUrlId; TStr UrlStr;
455    while ((GetConns()&lt;=GetCurMxConns())&amp;&amp;(GetWaitUrls()==0)&amp;&amp;
456     (Queue-&gt;PopQUrl(QUrlId, UrlStr))){
457      PUrl IpUrl=TUrl::New(UrlStr);
458      PCrawlerHost Host=HostBs-&gt;AddGetHost(IpUrl-&gt;GetHostNm());
459      if (Host-&gt;IsIpNum()){
460        IpUrl-&gt;PutIpNum(Host-&gt;GetIpNum());}
461      int ConnId=FetchUrl(IpUrl);
462      PUrl Url=TUrl::New(UrlStr);
463      AddConn(ConnId, QUrlId, Url);
464      Host-&gt;GetActiveConns()++;
465    }
466    int QUrls=Queue-&gt;GetQUrls();
467    int MnQLen=Crawler-&gt;GetDef()-&gt;GetMnQLen();
468    if ((QUrls%100==0)&amp;&amp;(QUrls&lt;MnQLen)){
469      Queue-&gt;PushQUrlBs();
470    }
471  }
472  void TCrawlerFetcher::OnFetch(const int&amp; ConnId, const PWebPg&amp; WebPg){
473    PCrawlerDef Def=Crawler-&gt;GetDef();
474    PCrawlerUrlDescBs UrlDescBs=Crawler-&gt;GetUrlDescBs();
475    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
476    PCrawlerQueue Queue=Crawler-&gt;GetQueue();
477    PCrawlerDocBs DocBs=Crawler-&gt;GetDocBs();
478    int QUrlId; PUrl Url; int FetchMSecs; GetDelConn(ConnId, QUrlId, Url, FetchMSecs);
479    TMd5Sig UrlMd5Sig; int Lev; int Dep;
480    Queue-&gt;GetQUrl(QUrlId, UrlMd5Sig, Lev, Dep);
481    Queue-&gt;DelQUrl(QUrlId);
482    if (!UrlDescBs-&gt;IsUrl(UrlMd5Sig)){
483      /&amp;bsol;**IAssert(UrlMd5Sig==TCrawler::GetUrlMd5Sig(WebPg-&gt;GetUrlStr(0)));
484      if (UrlMd5Sig!=TCrawler::GetUrlMd5Sig(WebPg-&gt;GetUrlStr(0))){
485        SaveToErrLog(&quot;Begin:IAssert(UrlMd5Sig==TCrawler::GetUrlMd5Sig(WebPg-&gt;GetUrlStr(0)));&quot;);
486        SaveToErrLog(TStr::Fmt(&quot;Urls: %d&quot;, WebPg-&gt;GetUrls()).CStr());
487        SaveToErrLog(TStr::Fmt(&quot;Md5: %s&quot;, UrlMd5Sig.GetStr().CStr()).CStr());
488        for (int WebPgUrlN=0; WebPgUrlN&lt;WebPg-&gt;GetUrls(); WebPgUrlN++){
489          SaveToErrLog(TStr::Fmt(&quot;Url #%d: %s&quot;,
490           WebPgUrlN,
491           WebPg-&gt;GetUrlStr(WebPgUrlN).CStr()).CStr());
492        }
493        SaveToErrLog(&quot;End:IAssert(UrlMd5Sig==TCrawler::GetUrlMd5Sig(WebPg-&gt;GetUrlStr(0)));&quot;);
494      }
495      for (int WebPgUrlN=0; WebPgUrlN&lt;WebPg-&gt;GetUrls(); WebPgUrlN++){
496        TStr DocUrlStr=WebPg-&gt;GetUrlStr(WebPgUrlN);
497        TMd5Sig DocUrlMd5Sig=TCrawler::GetUrlMd5Sig(DocUrlStr);
498        if (!UrlDescBs-&gt;IsUrl(DocUrlMd5Sig)){
499          TBlobPt DocBlobPt; TMd5Sig DocMemMd5Sig;
500          TStr ContTypeNm=WebPg-&gt;GetHttpResp()-&gt;GetFldVal(THttp::ContTypeFldNm);
501          if (Def-&gt;IsContTypeNmOk(ContTypeNm)){
502            if (WebPgUrlN==WebPg-&gt;GetUrls()-1){
503              TMem DocMem; WebPg-&gt;GetHttpResp()-&gt;GetAsMem(DocMem);
504              DocMemMd5Sig=TMd5Sig(DocMem);
505              DocBlobPt=DocBs-&gt;AddDoc(DocUrlStr, DocMem);
506            } else {
507              TStr FinalUrlStr=WebPg-&gt;GetUrlStr(WebPg-&gt;GetUrls()-1);
508              PHttpResp RedirHttpResp=THttpResp::New(
509               THttp::RedirStatusCd, THttp::TextPlainFldVal, false, NULL, FinalUrlStr);
510              TMem DocMem; RedirHttpResp-&gt;GetAsMem(DocMem);
511              DocMemMd5Sig=TMd5Sig(DocMem);
512              DocBlobPt=DocBs-&gt;AddDoc(DocUrlStr, DocMem);
513            }
514          }
515          if (Def-&gt;IsRedirDmAllowed()){
516            PUrl Url=TUrl::New(DocUrlStr);
517            TStr HostNm=Url-&gt;GetHostNm();
518            Def-&gt;AddRqDmNm(HostNm);
519          }
520          TCrawlerUrlDesc UrlDesc(
521           DocBlobPt, DocMemMd5Sig, TSecTm::GetCurTm(), TUCh(Lev), TUCh(Dep));
522          UrlDescBs-&gt;AddUrlDesc(DocUrlMd5Sig, UrlDesc);
523        }
524      }
525    }
526    PCrawlerHost Host=HostBs-&gt;GetHost(Url-&gt;GetHostNm());
527    Host-&gt;GetIpNum()=WebPg-&gt;GetIpNum(0);
528    Host-&gt;GetActiveConns()--;
529    Host-&gt;GetFetchedUrls()++;
530    Host-&gt;GetTransferBytes()+=WebPg-&gt;GetHttpResp()-&gt;Len();
531    Host-&gt;GetTransferMSecs()+=int(WebPg-&gt;GetFetchMSecs());
532    Host-&gt;GetLastFetchTm()=TSecTm::GetCurTm();
533    TStr HostNm=Url-&gt;GetHostNm();
534    if (WebPg-&gt;GetHttpResp()-&gt;IsContType(THttp::TextFldVal)){
535      TUrlV OutUrlV; TUrlV OutRedirUrlV; WebPg-&gt;GetOutUrlV(OutUrlV, OutRedirUrlV);
536      if (Def-&gt;IsRedirDmAllowed()){
537        for (int UrlN=0; UrlN&lt;OutRedirUrlV.Len(); UrlN++){
538          TStr HostNm=OutRedirUrlV[UrlN]-&gt;GetHostNm();
539          Def-&gt;AddRqDmNm(HostNm);
540        }
541      }
542      for (int UrlN=0; UrlN&lt;OutUrlV.Len(); UrlN++){
543        TStr OutHostNm=OutUrlV[UrlN]-&gt;GetHostNm();
544        if (Def-&gt;IsHostNmOk(OutHostNm)){
545          if (Def-&gt;IsFExtOk(OutUrlV[UrlN])){
546            if (HostNm==OutHostNm){
547              Queue-&gt;PushQUrlToUrlQBs(OutUrlV[UrlN], Lev+1, Dep+1);
548            } else {
549              Queue-&gt;PushQUrlToUrlQBs(OutUrlV[UrlN], 0, Dep+1);
550            }
551          }
552        }
553      }
554    }
555    printf(&quot;Fetched [Lev:%d Dep:%d Queue:%d Fetched:%d Time:%d Size:%d]: %s\n&quot;,
556     Lev, Dep, Queue-&gt;GetQUrls(), UrlDescBs-&gt;GetUrls(), FetchMSecs,
557     WebPg-&gt;GetHttpResp()-&gt;Len(), WebPg-&gt;GetUrlStr().CStr());
558    Queue-&gt;ResetQUrlBs();
559    Queue-&gt;ShuffleUrlQ();
560    ClrZombies();
561    Fetch();
562    if (UrlDescBs-&gt;GetUrls()&gt;=Def-&gt;GetMxUrls()){
563      TSysMsg::Quit();
564    }
565  }
566  void TCrawlerFetcher::OnError(const int&amp; ConnId, const TStr&amp; MsgStr){
567    DelCrawlerFetcherConn(ConnId);
568    Fetch();
569    printf(&quot;Error: %s\n&quot;, MsgStr.CStr());
570  }
571  void TCrawlerTimer::OnTimeOut(){
572    PCrawlerDef Def=Crawler-&gt;GetDef();
573    PCrawlerFetcher Fetcher=Crawler-&gt;GetFetcher();
574    PCrawlerStat Stat=Crawler-&gt;GetStat();
575    uint64 CurEventMSecs=TTm::GetCurUniMSecs();
576    uint64 InterEventMSecs=CurEventMSecs-LastEventMSecs;
577    uint64 ToutMSecs=GetTimeOut();
578    double TimerEventPrecision=(ToutMSecs==0) ? 0 : double(InterEventMSecs)/ToutMSecs;
579    if (TimerEventPrecision&gt;1.01){
580      Fetcher-&gt;PutCurMxConns(int(Fetcher-&gt;GetCurMxConns()*0.90));
581    } else {
582      Fetcher-&gt;PutCurMxConns(Fetcher-&gt;GetCurMxConns()+1);
583    }
584    if (Fetcher-&gt;GetCurMxConns()&lt;Def-&gt;GetMnConns()){
585      Fetcher-&gt;PutCurMxConns(Def-&gt;GetMnConns());}
586    if (Fetcher-&gt;GetCurMxConns()&gt;Def-&gt;GetMxConns()){
587      Fetcher-&gt;PutCurMxConns(Def-&gt;GetMxConns());}
588    printf(&quot;---------------------------------------------------------------\n&quot;); 
589    printf(&quot;*** Crawler-Timer: Timeout-Precision=%.3f CurMxConns=%d\n&quot;, 
590     TimerEventPrecision, Fetcher-&gt;GetCurMxConns());
591    if (Crawler-&gt;GetFetcher()-&gt;Empty()&amp;&amp;Crawler-&gt;GetQueue()-&gt;Empty()){
592      Crawler-&gt;GetQueue()-&gt;PushQUrlBs();
593      if (Crawler-&gt;GetQueue()-&gt;Empty()){
594        TSysMsg::Quit();
595      }
596    } else {
597      int QUrls=Crawler-&gt;GetQueue()-&gt;GetQUrls();
598      int MnQLen=Crawler-&gt;GetDef()-&gt;GetMnQLen();
599      if ((QUrls%100==0)&amp;&amp;(QUrls&lt;MnQLen)){
600        Crawler-&gt;GetQueue()-&gt;PushQUrlBs();
601      }
602      Crawler-&gt;GetFetcher()-&gt;Fetch();
603    }
604    if (Last100SecsEventMSecs==0){
605      Last100SecsEventMSecs=CurEventMSecs;
606    } else 
607    if (CurEventMSecs-Last100SecsEventMSecs&gt;=100000){
608      Stat-&gt;On100Secs();
609      Last100SecsEventMSecs=CurEventMSecs;
610    }
611    if (Last1000SecsEventMSecs==0){
612      Last1000SecsEventMSecs=CurEventMSecs;
613    } else 
614    if (CurEventMSecs-Last1000SecsEventMSecs&gt;=1000000){
615      Stat-&gt;On1000Secs();
616      Last1000SecsEventMSecs=CurEventMSecs;
617    }
618    LastEventMSecs=CurEventMSecs;
619  }
620  TStr TCrawlerWebSrv::GetUrlStr(const int&amp; RefreshSecs, const TStr&amp; SortOrderNm){
621    TChA UrlChA;
622    UrlChA+=&#x27;/&#x27;;
623    UrlChA+=&#x27;?&#x27;;
624    UrlChA+=TStr::Fmt(&quot;Refresh=%d&quot;, RefreshSecs);
625    UrlChA+=&#x27;&amp;&#x27;;
626    UrlChA+=TStr::Fmt(&quot;Sort=%s&quot;, SortOrderNm.CStr());
627    return UrlChA;
628  }
629  TStr TCrawlerWebSrv::GetAnchorStr(const TStr&amp; DescStr, 
630   const int&amp; RefreshSecs, const TStr&amp; SortOrderNm){
631    TChA AnchorChA;
632    TStr UrlStr=GetUrlStr(RefreshSecs, SortOrderNm);
633    AnchorChA+=TStr::Fmt(&quot;&lt;a href=\&quot;%s\&quot;&gt;&quot;, UrlStr.CStr());
634    AnchorChA+=DescStr;
635    AnchorChA+=&quot;&lt;/a&gt;&quot;;
636    return AnchorChA;
637  }
638  void TCrawlerWebSrv::OnHttpRq(const int&amp; SockId, const PHttpRq&amp; HttpRq){
639    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
640    PCrawlerUrlDescBs UrlDescBs=Crawler-&gt;GetUrlDescBs();
641    PCrawlerFetcher Fetcher=Crawler-&gt;GetFetcher();
642    PCrawlerQueue Queue=Crawler-&gt;GetQueue();
643    PCrawlerStat Stat=Crawler-&gt;GetStat();
644    TStr UrlStr=HttpRq-&gt;GetUrl()-&gt;GetUrlStr();
645    TStr UrlPathStr=HttpRq-&gt;GetUrl()-&gt;GetPathStr();
646    PUrlEnv UrlEnv=HttpRq-&gt;GetUrlEnv();
647    bool StopCrawlingP=false;
648    if (UrlPathStr==&quot;/Stop&quot;){
649      StopCrawlingP=true;
650      TSysMsg::Quit();
651    }
652    int RefreshSecs=UrlEnv-&gt;GetVal(&quot;Refresh&quot;).GetInt(100);
653    TStr SortOrderNm=UrlEnv-&gt;GetVal(&quot;Sort&quot;);
654    TChA HtmlChA;
655    int ActiveConns; int FetchedUrls; int FetchErrors; int QueueUrls;
656    double TransferBytes; double TransferMSecs; 
657    double AvgHttpRespLen; double AvgTransferBps;
658    HostBs-&gt;GetSummaryInfo(ActiveConns, FetchedUrls, FetchErrors, QueueUrls, 
659     TransferBytes, TransferMSecs, AvgHttpRespLen, AvgTransferBps);
660    {HtmlChA+=&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Crawling&lt;/title&gt;&quot;;
661    if ((!StopCrawlingP)&amp;&amp;(RefreshSecs&gt;0)){
662      HtmlChA+=TStr::Fmt(&quot;&lt;meta http-equiv=\&quot;refresh\&quot; content=\&quot;%d\&quot;&gt;&quot;, RefreshSecs);}
663    HtmlChA+=&quot;&lt;/head&gt;&lt;body&gt;&quot;;
664    HtmlChA+=&quot;&lt;h1&gt;WebBird-Crawler&lt;/h1&gt;&quot;;
665    HtmlChA+=TSecTm::GetCurTm().GetStr(); HtmlChA+=&quot;&lt;br&gt;&quot;;
666    HtmlChA+=&quot;&lt;form method=get action=\&quot;/Stop\&quot;&gt;&quot;;
667    HtmlChA+=&quot;&lt;input type=submit value=Stop&gt;&quot;;
668    HtmlChA+=&quot;&lt;/form&gt;&quot;;
669    HtmlChA+=&quot;&lt;form method=get action=\&quot;/\&quot;&gt;&quot;;
670    HtmlChA+=&quot;&lt;input type=submit value=\&quot;Refresh Seconds\&quot;&gt;&quot;;
671    HtmlChA+=TStr::Fmt(&quot;&lt;input type=text name=\&quot;Refresh\&quot; value=\&quot;%d\&quot; size=2&gt;&quot;, RefreshSecs);
672    HtmlChA+=&quot;&lt;/form&gt;&quot;;}
673    {HtmlChA+=&quot;&lt;h2&gt;General Info&lt;/h2&gt;\n&quot;;
674    uint64 StartMSecs=TTm::GetMSecsFromTm(Crawler-&gt;GetStartTm());
675    uint64 CurMSecs=TTm::GetCurUniMSecs();
676    uint64 CrawlingMSecs=CurMSecs-StartMSecs;
677    double CrawlingSecs=CrawlingMSecs/1000.0;
678    double CrawlingPpsSpeed=CrawlingSecs&lt;=0 ? 0 : FetchedUrls/CrawlingSecs;
679    double AvgPgLen=(FetchedUrls&gt;0)&amp;&amp;(TransferBytes&gt;0) ? TransferBytes/FetchedUrls : 0;
680    HtmlChA+=&quot;&lt;table border=1&gt;\n&quot;;
681    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Urls Fetched&lt;td align=right&gt;%d&lt;/tr&gt;\n&quot;, UrlDescBs-&gt;GetUrls());
682    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Queue Length&lt;td align=right&gt;%d&lt;/tr&gt;\n&quot;, Queue-&gt;GetQUrls());
683    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Crawling Time&lt;td align=right&gt;%.0fs&lt;/tr&gt;\n&quot;, CrawlingSecs);
684    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Crawling Speed&lt;td align=right&gt;%.3fpps&lt;/tr&gt;\n&quot;, CrawlingPpsSpeed);
685    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Crawling Speed (last 1000secs)&lt;td align=right&gt;%.3fpps&lt;/tr&gt;\n&quot;, 
686      Stat-&gt;GetLast1000SecsCrawlingSpeed());
687    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Crawling Speed (last 100secs)&lt;td align=right&gt;%.3fpps&lt;/tr&gt;\n&quot;, 
688      Stat-&gt;GetLast100SecsCrawlingSpeed());
689    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Avg. Page Length&lt;td align=right&gt;%sb&lt;/tr&gt;\n&quot;, 
690     TFlt::GetGigaStr(AvgPgLen).CStr());
691    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Cleaned Zombies&lt;td align=right&gt;%d&lt;/tr&gt;\n&quot;, Fetcher-&gt;GetZombies());
692    HtmlChA+=&quot;&lt;/table&gt;\n&quot;;}
693    {HtmlChA+=&quot;&lt;h2&gt;Hosts&lt;/h2&gt;\n&quot;;
694    HtmlChA+=&quot;&lt;table border=1&gt;\n&quot;;
695    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;th&gt;%s (%d)&lt;th&gt;%s&lt;th&gt;%s&lt;th&gt;%s&lt;th&gt;%s&lt;th&gt;%s&lt;th&gt;%s&lt;th&gt;%s&lt;th&gt;%s&lt;/tr&gt;\n&quot;, 
696     GetAnchorStr(&quot;Hosts&quot;, RefreshSecs, &quot;Host&quot;).CStr(),
697     HostBs-&gt;GetHosts(),
698     GetAnchorStr(&quot;Active&quot;, RefreshSecs, &quot;Active&quot;).CStr(),
699     GetAnchorStr(&quot;Fetched&quot;, RefreshSecs, &quot;Fetched&quot;).CStr(),
700     GetAnchorStr(&quot;Errors&quot;, RefreshSecs, &quot;Errors&quot;).CStr(),
701     GetAnchorStr(&quot;Queue&quot;, RefreshSecs, &quot;Queue&quot;).CStr(),
702     GetAnchorStr(&quot;Bytes&quot;, RefreshSecs, &quot;Bytes&quot;).CStr(),
703     GetAnchorStr(&quot;Time&quot;, RefreshSecs, &quot;Time&quot;).CStr(),
704     GetAnchorStr(&quot;PageLen&quot;, RefreshSecs, &quot;PageLen&quot;).CStr(),
705     GetAnchorStr(&quot;Speed&quot;, RefreshSecs, &quot;Speed&quot;).CStr());
706    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Summary&lt;/b&gt;&quot;
707      &quot;&lt;td align=right&gt;&lt;b&gt;%d&lt;/b&gt;&lt;td align=right&gt;&lt;b&gt;%d&lt;/b&gt;&lt;td align=right&gt;&lt;b&gt;%d&lt;/b&gt;&lt;td align=right&gt;&lt;b&gt;%d&lt;/b&gt;&quot;
708      &quot;&lt;td align=right&gt;&lt;b&gt;%sb&lt;/b&gt;&lt;td align=right&gt;&lt;b&gt;%ss&lt;/b&gt;&lt;td align=right&gt;&lt;b&gt;%sb&lt;/b&gt;&lt;td align=right&gt;&lt;b&gt;%sbps&lt;/b&gt;&lt;/tr&gt;\n&quot;,
709     ActiveConns, FetchedUrls, FetchErrors, QueueUrls, 
710     TFlt::GetGigaStr(TransferBytes).CStr(), 
711     TFlt::GetGigaStr(TransferMSecs/1000).CStr(), 
712     TFlt::GetGigaStr(AvgHttpRespLen).CStr(),
713     TFlt::GetGigaStr(AvgTransferBps).CStr());
714    TCrawlerHostV HostV; HostBs-&gt;GetSortedHostV(HostV, SortOrderNm);
715    for (int HostN=0; HostN&lt;HostV.Len(); HostN++){
716      PCrawlerHost Host=HostV[HostN];
717      HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;a href=\&quot;http:&amp;bsol;&amp;bsol;%s\&quot;&gt;%s&lt;a&gt;&quot;
718       &quot;&lt;td align=right&gt;%d&lt;td align=right&gt;%d&lt;td align=right&gt;%d&lt;td align=right&gt;%d&quot;
719       &quot;&lt;td align=right&gt;%sb&lt;td align=right&gt;%ss&lt;td align=right&gt;%sb&lt;td align=right&gt;%sbps&lt;/tr&gt;\n&quot;,
720       Host-&gt;GetHostNm().CStr(), 
721       Host-&gt;GetHostNm().CStr(), 
722       Host-&gt;GetActiveConns(),
723       Host-&gt;GetFetchedUrls(), 
724       Host-&gt;GetFetchErrors(), 
725       Host-&gt;GetQueueUrls(),
726       TFlt::GetGigaStr(double(Host-&gt;GetTransferBytes())).CStr(), 
727       TFlt::GetGigaStr(Host-&gt;GetTransferMSecs()/1000).CStr(),
728       TFlt::GetGigaStr(Host-&gt;GetAvgHttpRespLen()).CStr(),
729       TFlt::GetGigaStr(Host-&gt;GetAvgTransferBps()).CStr()); 
730    }
731    HtmlChA+=&quot;&lt;/table&gt;&quot;;}
732    {HtmlChA+=&quot;&lt;h2&gt;Queue Levels&lt;/h2&gt;\n&quot;;
733    HtmlChA+=&quot;&lt;table border=1&gt;\n&quot;;
734    int AllQUrls=Queue-&gt;GetQUrls();
735    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;%s&lt;td align=right&gt;%d&lt;/tr&gt;\n&quot;,
736     &quot;All Queue Urls&quot;, AllQUrls);
737    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;%s&lt;td align=right&gt;%d&lt;/tr&gt;\n&quot;,
738      &quot;Unconn Queue Urls&quot;, Queue-&gt;GetUnconnQUrls());
739    for (int Lev=0; Lev&lt;Queue-&gt;GetQLevs(); Lev++){
740      HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;Level-%d Urls&lt;td align=right&gt;%d&lt;/tr&gt;\n&quot;,
741       Lev, Queue-&gt;GetQLevUrls(Lev));
742    }
743    HtmlChA+=&quot;&lt;/table&gt;&quot;;}
744    {HtmlChA+=&quot;&lt;h2&gt;Queue&lt;/h2&gt;\n&quot;;
745    TIntStrPrV QUrlsHostPrV; Queue-&gt;GetQUrlsHostPrV(QUrlsHostPrV);
746    HtmlChA+=&quot;&lt;table border=1&gt;\n&quot;;
747    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;th&gt;#&lt;th&gt;Host&lt;th&gt;Queue-Urls&lt;th&gt;%%&lt;/tr&gt;\n&quot;);
748    int AllQUrls=Queue-&gt;GetQUrls();
749    for (int HostN=0; HostN&lt;QUrlsHostPrV.Len(); HostN++){
750      TStr HostLevNm=QUrlsHostPrV[HostN].Val2;
751      TStr HostNm; TStr LevStr; HostLevNm.SplitOnCh(HostNm, &#x27;:&#x27;, LevStr);
752      int QUrls=QUrlsHostPrV[HostN].Val1;
753      double QUrlsPrc=double(QUrls)/double(AllQUrls);
754      HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;%d&lt;td align=right&gt;&lt;a href=\&quot;http:&amp;bsol;&amp;bsol;%s/\&quot;&gt;%s&lt;/a&gt; / %s&quot;
755       &quot;&lt;td align=right&gt;%d&lt;td align=right&gt;%.3f%%&lt;/tr&gt;\n&quot;,
756       1+HostN, HostNm.CStr(), HostNm.CStr(), LevStr.CStr(), QUrls, 100*QUrlsPrc);
757    }
758    HtmlChA+=&quot;&lt;/table&gt;&quot;;}
759    {TIntStrIntIntQuV ConnIdUrlStrMSecsSizeQuV;
760    Fetcher-&gt;GetConnV(ConnIdUrlStrMSecsSizeQuV);
761    int ConnIds=ConnIdUrlStrMSecsSizeQuV.Len();
762    HtmlChA+=&quot;&lt;h2&gt;Connections&lt;/h2&gt;\n&quot;;
763    HtmlChA+=&quot;&lt;table border=1&gt;\n&quot;;
764    HtmlChA+=&quot;&lt;tr&gt;&lt;th&gt;#&lt;th&gt;Connection&lt;th&gt;Time&lt;th&gt;Size&lt;th&gt;Url&lt;/tr&gt;\n&quot;;
765    for (int ConnN=0; ConnN&lt;ConnIds; ConnN++){
766      int ConnId=ConnIdUrlStrMSecsSizeQuV[ConnN].Val1;
767      TStr UrlStr=ConnIdUrlStrMSecsSizeQuV[ConnN].Val2;
768      int FetchMSecs=ConnIdUrlStrMSecsSizeQuV[ConnN].Val3;
769      int FetchSize=ConnIdUrlStrMSecsSizeQuV[ConnN].Val4;
770      HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td&gt;%d&lt;td&gt;%d&lt;td&gt;%ss&lt;td&gt;%sb&lt;td&gt;&lt;a href=\&quot;%s\&quot;&gt;%s&lt;/a&gt;&lt;/tr&gt;\n&quot;,
771       1+ConnN, ConnId, 
772       TFlt::GetGigaStr(FetchMSecs/1000).CStr(), TFlt::GetGigaStr(FetchSize).CStr(), 
773       UrlStr.CStr(), UrlStr.CStr());
774    }
775    HtmlChA+=&quot;&lt;/table&gt;\n&quot;;}
776    HtmlChA+=&quot;&lt;/body&gt;&lt;/html&gt;&quot;;
777    PSIn BodySIn=TMIn::New(HtmlChA);
778    PHttpResp HttpResp=THttpResp::New(
779     THttp::OkStatusCd, THttp::TextHtmlFldVal, false, BodySIn);
780    SendHttpResp(SockId, HttpResp);
781  }
782  TFAccess TCrawlerDocBs::Open(){
783    TFAccess DocBsFAccess=TFRnd::GetFAccessFromStr(DocBsFAccessNm);
784    IAssert((DocBsFAccess==faCreate)||(DocBsFAccess==faUpdate)||(DocBsFAccess==faRestore));
785    DocBBs=TMBlobBs::New(DocBsNrFPath+DocBsNm, DocBsFAccess, DocBsMxSegLen);
786    return DocBsFAccess;
787  }
788  void TCrawlerDocBs::Close(){
789    DocBBs=NULL;
790  }
791  TBlobPt TCrawlerDocBs::AddDoc(const TStr&amp; DocUrlStr, const TMem&amp; DocMem){
792    TMOut SOut(DocUrlStr.Len()+DocMem.Len()+100);
793    TTm::GetCurUniTm().GetWebLogDateTimeStr().Save(SOut);
794    DocUrlStr.Save(SOut);
795    DocMem.Save(SOut);
796    PSIn SIn=SOut.GetSIn();
797    TBlobPt BPt=DocBBs-&gt;PutBlob(SIn);
798    return BPt;
799  }
800  bool TCrawlerDocBs::FNextDocBlobPt(TBlobPt&amp; TrvDocBlobPt,
801   TBlobPt&amp; DocBlobPt, TStr&amp; DateTimeStr, TStr&amp; DocUrlStr, TMem&amp; DocMem){
802    PSIn DocBlobSIn;
803    if (DocBBs-&gt;FNextBlobPt(TrvDocBlobPt, DocBlobPt, DocBlobSIn)){
804      DateTimeStr=TStr(*DocBlobSIn); 
805      DocUrlStr=TStr(*DocBlobSIn); 
806      DocMem=TMem(*DocBlobSIn); 
807      return true;
808    } else {
809      return false;
810    }
811  }
812  void TCrawlerStat::On100Secs(){
813    uint64 CurEventMSecs=TTm::GetCurUniMSecs();
814    uint64 CurFetchedUrls=Crawler-&gt;GetUrlDescBs()-&gt;GetUrls();
815    double DiffSecs=(CurEventMSecs-Last100SecsEventMSecs)/double(1000);
816    if (DiffSecs&lt;1){
817      Last100SecsCrawlingSpeed=0;
818    } else {
819      Last100SecsCrawlingSpeed=(CurFetchedUrls-Last100SecsFetchedUrls)/DiffSecs;
820    }
821    Last100SecsEventMSecs=CurEventMSecs;
822    Last100SecsFetchedUrls=CurFetchedUrls;
823  }
824  void TCrawlerStat::On1000Secs(){
825    uint64 CurEventMSecs=TTm::GetCurUniMSecs();
826    uint64 CurFetchedUrls=Crawler-&gt;GetUrlDescBs()-&gt;GetUrls();
827    double DiffSecs=(CurEventMSecs-Last1000SecsEventMSecs)/double(1000);
828    if (DiffSecs&lt;1){
829      Last1000SecsCrawlingSpeed=0;
830    } else {
831      Last1000SecsCrawlingSpeed=(CurFetchedUrls-Last1000SecsFetchedUrls)/DiffSecs;
832    }
833    Last1000SecsEventMSecs=CurEventMSecs;
834    Last1000SecsFetchedUrls=CurFetchedUrls;
835  }
836  TCrawler::TCrawler():
837    Def(TCrawlerDef::New()),
838    UrlDescBs(), HostBs(), Queue(), Fetcher(), DocBs(), Timer(), WebSrv(),
839    StartTm(TTm::GetCurUniTm()){
840    DocBs=TCrawlerDocBs::New(this);
841  }
842  void TCrawler::DefCrawlBs(const TStr&amp; CrawlBsNm, const TStr&amp; CrawlBsFPath,
843   const TStr&amp; CrawlBsFAccessNm, const int&amp; CrawlBsMxSegLen){
844    PCrawlerDocBs DocBs=GetDocBs();
845    DocBs-&gt;PutDocBsNm(CrawlBsNm);
846    DocBs-&gt;PutDocBsNrFPath(TStr::GetNrFPath(CrawlBsFPath));
847    DocBs-&gt;PutDocBsFAccessNm(CrawlBsFAccessNm);
848    DocBs-&gt;PutDocBsMxSegLen(CrawlBsMxSegLen);
849  }
850  void TCrawler::StartCrawling(){
851    UrlDescBs=TCrawlerUrlDescBs::New(this);
852    HostBs=TCrawlerHostBs::New(this);
853    Queue=TCrawlerQueue::New(this);
854    Fetcher=TCrawlerFetcher::New(this);
855    Stat=TCrawlerStat::New(this);
856    TFAccess DocBsFAccess=GetDocBs()-&gt;Open();
857    if (DocBsFAccess==faCreate){
858      PCrawlerDef Def=GetDef();
859      int StartUrls=Def-&gt;GetStartUrls();
860      for (int UrlN=0; UrlN&lt;StartUrls; UrlN++){
861        Queue-&gt;PushQUrl(Def-&gt;GetStartUrl(UrlN), 0, 0);}
862    }
863    if (DocBsFAccess==faRestore){
864      printf(&quot;Restoring Crawled Documents...\n&quot;);
865      TBlobPt TrvDocBlobPt=GetDocBs()-&gt;FFirstDocBlobPt();
866      TBlobPt DocBlobPt; TStr DateTimeStr; TStr DocUrlStr; TMem DocMem; int DocN=0;
867      while (GetDocBs()-&gt;FNextDocBlobPt(TrvDocBlobPt, DocBlobPt, DateTimeStr, DocUrlStr, DocMem)){
868        DocN++; printf(&quot;%d\r&quot;, DocN);
869        TMd5Sig DocUrlMd5Sig=TCrawler::GetUrlMd5Sig(DocUrlStr);
870        TMd5Sig DocMemMd5Sig(DocMem);
871        TCrawlerUrlDesc UrlDesc(DocBlobPt, DocMemMd5Sig, TSecTm::GetCurTm(), TUCh(0), TUCh(0));
872        UrlDescBs-&gt;AddUrlDesc(DocUrlMd5Sig, UrlDesc);
873      }
874      printf(&quot;\nDone.\n&quot;);
875    }
876    if (DocBsFAccess==faUpdate){
877      GetUrlDescBs()-&gt;Load();
878    }
879    Timer=TCrawlerTimer::New(this, 1000);
880    WebSrv=TCrawlerWebSrv::New(this);
881    Fetcher-&gt;Fetch();
882  }
883  void TCrawler::StopCrawling(){
884    WebSrv=NULL;
885    Timer-&gt;StopTimer();
886    GetDocBs()-&gt;Close();
887    GetUrlDescBs()-&gt;Save();
888    GetQueue()-&gt;PopSaveQUrlBs();
889  }
890  TMd5Sig TCrawler::GetUrlMd5Sig(const TStr&amp; UrlStr){
891    TStr LcUrlStr=UrlStr.GetLc();
892    return TMd5Sig(LcUrlStr);
893  }
</code></pre>
        </div>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-crawler.cpp</h3>
            <pre><code>1  #include &quot;crawler.h&quot;
2  bool TCrawlerDef::IsHostNmOk(const TStr&amp; HostNm){
3    bool HostNmOkP=false;
4    if (RqDmNmV.Empty()){
5      HostNmOkP=true;
6    } else {
7      for (int RqDmNmN=0; RqDmNmN&lt;RqDmNmV.Len(); RqDmNmN++){
8        if (HostNm.IsSuffix(RqDmNmV[RqDmNmN])){
9          HostNmOkP=true; break;
10        }
11      }
12    }
13    if (HostNmOkP){
14      for (int BadDmNmN=0; BadDmNmN&lt;BadDmNmV.Len(); BadDmNmN++){
15        if (HostNm.IsSuffix(BadDmNmV[BadDmNmN])){
16          HostNmOkP=false; break;
17        }
18      }
19    }
20    return HostNmOkP;
21  }
22  bool TCrawlerDef::IsContTypeNmOk(const TStr&amp; ContTypeNm){
23    if (RqContTypeNmV.Empty()){
24      return true;
25    } else {
26      TStr LcContTypeNm=ContTypeNm.GetLc();
27      for (int ContTypeNmN=0; ContTypeNmN&lt;RqContTypeNmV.Len(); ContTypeNmN++){
28        if (LcContTypeNm.IsWcMatch(RqContTypeNmV[ContTypeNmN])){return true;}
29      }
30      return false;
31    }
32  }
33  bool TCrawlerDef::IsFExtOk(const PUrl&amp; Url) const {
34    if (BadFExtV.Empty()||(Url-&gt;GetPathSegs()==0)){
35      return true;
36    } else {
37      TStr UrlStr=Url-&gt;GetUrlStr();
38      TStr FBase=Url-&gt;GetPathSeg(Url-&gt;GetPathSegs()-1);
39      TStr FExt=FBase.GetFExt().GetUc();
40      return (!BadFExtH.IsKey(FExt));
41    }
42  }
43  void TCrawlerDef::OptHtmlCrawling(){
44    AddBadFExt(&quot;.JPEG&quot;); AddBadFExt(&quot;.JPG&quot;); AddBadFExt(&quot;.GIF&quot;); AddBadFExt(&quot;.BMP&quot;);
45    AddBadFExt(&quot;.MPEG&quot;); AddBadFExt(&quot;.MPG&quot;); AddBadFExt(&quot;.AVI&quot;); AddBadFExt(&quot;.MOV&quot;);
46    AddBadFExt(&quot;.MP3&quot;); AddBadFExt(&quot;.WAV&quot;); AddBadFExt(&quot;.MID&quot;); AddBadFExt(&quot;.RA&quot;);
47    AddBadFExt(&quot;.ZIP&quot;); AddBadFExt(&quot;.RAR&quot;); AddBadFExt(&quot;.GZ&quot;); AddBadFExt(&quot;.TAR&quot;);
48    AddBadFExt(&quot;.PDF&quot;); AddBadFExt(&quot;.DOC&quot;); AddBadFExt(&quot;.XSL&quot;); AddBadFExt(&quot;.PPT&quot;);
49    AddRqContTypeNm(&quot;text&amp;bsol;*&quot;);
50  }
51  void TCrawlerDef::AddSiteUrlStr(const TStr&amp; SiteUrlStr){
52    PUrl Url=TUrl::New(SiteUrlStr);
53    if (Url-&gt;IsOk(usHttp)){
54      AddRqDmNm(Url-&gt;GetHostNm());
55      AddStartUrlStr(SiteUrlStr);
56    }
57  }
58  void TCrawlerDef::AddSiteUrlStrV(const TStrV&amp; SiteUrlStrV){
59    for (int UrlStrN=0; UrlStrN&lt;SiteUrlStrV.Len(); UrlStrN++){
60      AddSiteUrlStr(SiteUrlStrV[UrlStrN]);
61    }
62  }
63  void TCrawlerDef::LoadUrlStrV(const TStr&amp; SiteUrlStrVFNm){
64    if (SiteUrlStrVFNm.Empty()){return;}
65    PSIn SIn=TFIn::New(SiteUrlStrVFNm);
66    TILx Lx(SIn);
67    while (Lx.GetSym(syLn, syEof)!=syEof){
68      TStr UrlStr=TStr(Lx.Str).GetTrunc();
69      AddSiteUrlStr(UrlStr);
70    }
71  }
72  TStr TCrawlerDef::GetStr(){
73    TChA ChA;
74    ChA+=TStr::Fmt(&quot;                  Max. Urls: %d\n&quot;, GetMxUrls());
75    ChA+=TStr::Fmt(&quot;           Min. Connections: %d\n&quot;, GetMnConns());
76    ChA+=TStr::Fmt(&quot;           Max. Connections: %d\n&quot;, GetMxConns());
77    ChA+=TStr::Fmt(&quot;Max. Connections Per Server: %d\n&quot;, GetMxConnsPerSrv());
78    ChA+=TStr::Fmt(&quot;          After Fetch Delay: %d\n&quot;, GetAfterFetchDelaySecs());
79    ChA+=TStr::Fmt(&quot;                 Max. Level: %d\n&quot;, GetMxLev());
80    ChA+=TStr::Fmt(&quot;                 Max. Depth: %d\n&quot;, GetMxDep());
81    ChA+=TStr::Fmt(&quot;        Max. Content Length: %d\n&quot;, GetMxContLen());
82    ChA+=TStr::Fmt(&quot;          Min. Queue Length: %d\n&quot;, GetMnQLen());
83    ChA+=TStr::Fmt(&quot;         Queue Reset Modulo: %d\n&quot;, GetQResetMod());
84    ChA+=TStr::Fmt(&quot;  Max. Queue Segment Length: %d\n&quot;, GetMxQSegLen());
85    ChA+=TStr::Fmt(&quot;               Max. Retries: %d\n&quot;, GetMxRetries());
86    ChA+=TStr::Fmt(&quot;           Revisits Seconds: %d\n&quot;, GetRevisitSecs());
87    ChA+=TStr::Fmt(&quot;Redirection Domains Allowed: %d\n&quot;, TBool::GetYesNoStr(IsRedirDmAllowed()));
88    ChA+=TStr::Fmt(&quot;                 Start Urls:&quot;);
89    for (int UrlN=0; UrlN&lt;GetStartUrls(); UrlN++){
90      ChA+=&quot; &quot;; ChA+=GetStartUrl(UrlN);}
91    ChA+=&quot;\n&quot;;
92    ChA+=TStr::Fmt(&quot;           Required Domains:&quot;);
93    for (int DmNmN=0; DmNmN&lt;RqDmNmV.Len(); DmNmN++){
94      ChA+=&quot; &quot;; ChA+=RqDmNmV[DmNmN];}
95    ChA+=&quot;\n&quot;;
96    ChA+=TStr::Fmt(&quot;                Bad Domains:&quot;);
97    for (int DmNmN=0; DmNmN&lt;BadDmNmV.Len(); DmNmN++){
98      ChA+=&quot; &quot;; ChA+=BadDmNmV[DmNmN];}
99    ChA+=&quot;\n&quot;;
100    ChA+=TStr::Fmt(&quot;                Geo-IP Base: %s\n&quot;, TBool::GetYesNoStr(IsGeoIpBs()).CStr());
101    ChA+=TStr::Fmt(&quot;                  Countries:&quot;);
102    for (int CountryNmN=0; CountryNmN&lt;RqCountryNmV.Len(); CountryNmN++){
103      ChA+=&quot; &quot;; ChA+=RqCountryNmV[CountryNmN];}
104    ChA+=&quot;\n&quot;;
105    ChA+=TStr::Fmt(&quot;              Content Types:&quot;);
106    for (int ContTypeNmN=0; ContTypeNmN&lt;RqContTypeNmV.Len(); ContTypeNmN++){
107      ChA+=&quot; &quot;; ChA+=RqContTypeNmV[ContTypeNmN];}
108    ChA+=&quot;\n&quot;;
109    ChA+=TStr::Fmt(&quot;        Bad File Extensions:&quot;);
110    for (int FExtN=0; FExtN&lt;BadFExtV.Len(); FExtN++){
111      ChA+=&quot; &quot;; ChA+=BadFExtV[FExtN];}
112    ChA+=&quot;\n&quot;;
113    return ChA;
114  }
115  TCrawlerUrlDescBs::TCrawlerUrlDescBs(TCrawler* _Crawler):
116    Crawler(_Crawler){
117    IAssert(Crawler-&gt;GetDef()-&gt;GetMxUrls()!=-1);
118    UrlMd5SigToDescH.Gen(Crawler-&gt;GetDef()-&gt;GetMxUrls());
119  }
120  TStr TCrawlerUrlDescBs::GetFNm() const {
121    return
122     Crawler-&gt;GetDocBs()-&gt;GetDocBsNrFPath()+
123     Crawler-&gt;GetDocBs()-&gt;GetDocBsNm()+&quot;.UrlBs&quot;;
124  }
125  void TCrawlerUrlDescBs::Load(){
126    TFIn SIn(GetFNm()); UrlMd5SigToDescH.Load(SIn);
127  }
128  void TCrawlerUrlDescBs::Save(){
129    TFOut SOut(GetFNm()); UrlMd5SigToDescH.Save(SOut);
130  }
131  TCrawlerHostBs::TCrawlerHostBs(TCrawler* _Crawler):
132    Crawler(_Crawler){
133  }
134  PCrawlerHost TCrawlerHostBs::AddGetHost(const TStr&amp; HostNm){
135    int HostId;
136    if (!NmToHostH.IsKey(HostNm, HostId)){
137      HostId=NmToHostH.AddKey(HostNm);
138      NmToHostH[HostId]=TCrawlerHost::New(HostNm);
139    }
140    return NmToHostH[HostId];
141  }
142  void TCrawlerHostBs::GetSortedHostV(TCrawlerHostV&amp; HostV, const TStr&amp; SortOrderNm){
143    typedef TKeyDat&lt;TStr, PCrawlerHost&gt; TNmHostKd;
144    TVec&lt;TNmHostKd&gt; NmHostKdV;
145    int Hosts=GetHosts(); bool SortAscP=true;
146    for (int HostN=0; HostN&lt;Hosts; HostN++){
147      PCrawlerHost Host=GetHost(HostN);
148      TStr KeyStr;
149      if (SortOrderNm==&quot;Host&quot;){KeyStr=Host-&gt;GetRevHostNm(); SortAscP=true;}
150      else if (SortOrderNm==&quot;Active&quot;){KeyStr=TInt::GetStr(Host-&gt;GetActiveConns(), &quot;%012d&quot;); SortAscP=false;}
151      else if (SortOrderNm==&quot;Fetched&quot;){KeyStr=TInt::GetStr(Host-&gt;GetFetchedUrls(), &quot;%012d&quot;); SortAscP=false;}
152      else if (SortOrderNm==&quot;Errors&quot;){KeyStr=TInt::GetStr(Host-&gt;GetFetchErrors(), &quot;%012d&quot;); SortAscP=false;}
153      else if (SortOrderNm==&quot;Queue&quot;){KeyStr=TInt::GetStr(Host-&gt;GetQueueUrls(), &quot;%012d&quot;); SortAscP=false;}
154      else if (SortOrderNm==&quot;Bytes&quot;){KeyStr=TFlt::GetStr(double(Host-&gt;GetTransferBytes()), &quot;%012.0f&quot;); SortAscP=false;}
155      else if (SortOrderNm==&quot;Time&quot;){KeyStr=TFlt::GetStr(Host-&gt;GetTransferMSecs(), &quot;%012.0f&quot;); SortAscP=false;}
156      else if (SortOrderNm==&quot;PageLen&quot;){KeyStr=TFlt::GetStr(Host-&gt;GetAvgHttpRespLen(), &quot;%012.0f&quot;); SortAscP=false;}
157      else if (SortOrderNm==&quot;Speed&quot;){KeyStr=TFlt::GetStr(Host-&gt;GetAvgTransferBps(), &quot;%012.0f&quot;); SortAscP=false;}
158      else {KeyStr=Host-&gt;GetRevHostNm(); SortAscP=true;}
159      NmHostKdV.Add(TNmHostKd(KeyStr, Host));
160    }
161    NmHostKdV.Sort(SortAscP);
162    HostV.Gen(NmHostKdV.Len(), 0);
163    for (int HostN=0; HostN&lt;NmHostKdV.Len(); HostN++){
164      HostV.Add(NmHostKdV[HostN].Dat);
165    }
166  }
167  void TCrawlerHostBs::GetSummaryInfo(
168   int&amp; ActiveConns, int&amp; FetchedUrls, int&amp; FetchErrors, int&amp; QueueUrls, 
169   double&amp; TransferBytes, double&amp; TransferMSecs, double&amp; AvgHttpRespLen, 
170   double&amp; AvgTransferBps){
171    ActiveConns=0; FetchedUrls=0; FetchErrors=0; QueueUrls=0;
172    TransferBytes=0; TransferMSecs=0; 
173    AvgHttpRespLen=0; AvgTransferBps=0;
174    int Hosts=GetHosts();
175    for (int HostN=0; HostN&lt;Hosts; HostN++){
176      PCrawlerHost Host=GetHost(HostN);
177      ActiveConns+=Host-&gt;GetActiveConns();
178      FetchedUrls+=Host-&gt;GetFetchedUrls();
179      FetchErrors+=Host-&gt;GetFetchErrors();
180      QueueUrls+=Host-&gt;GetQueueUrls();
181      TransferBytes+=Host-&gt;GetTransferBytes();
182      TransferMSecs+=Host-&gt;GetTransferMSecs();
183      AvgHttpRespLen+=Host-&gt;GetAvgHttpRespLen();
184      AvgTransferBps+=Host-&gt;GetAvgTransferBps();
185    }
186    if (Hosts&gt;0){
187      AvgHttpRespLen=AvgHttpRespLen/Hosts;
188      AvgTransferBps=AvgTransferBps/Hosts;
189    }
190  }
191  TCrawlerQueue::TCrawlerQueue(TCrawler* _Crawler):
192    Crawler(_Crawler), UrlMd5SigToUrlStrHostNmLevDepQuH(){
193  }
194  void TCrawlerQueue::GetQUrlsHostPrV(TIntStrPrV&amp; QUrlsHostPrV){
195    QUrlsHostPrV.Clr();
196    TStrIntH HostToQUrlsH;
197    int QUrlP=UrlMd5SigToUrlStrHostNmLevDepQuH.FFirstKeyId();
198    while (UrlMd5SigToUrlStrHostNmLevDepQuH.FNextKeyId(QUrlP)){
199      TStr HostNm=GetQHostNm(QUrlP);
200      int Lev=GetQUrlLev(QUrlP);
201      HostToQUrlsH.AddDat(HostNm+&quot;:&quot;+TInt::GetStr(Lev))++;
202    }
203    HostToQUrlsH.GetDatKeyPrV(QUrlsHostPrV);
204    QUrlsHostPrV.Sort(false);
205  }
206  void TCrawlerQueue::PushQUrl(const PUrl&amp; Url, const int&amp; Lev, const int&amp; Dep){
207    PCrawlerDef Def=Crawler-&gt;GetDef();
208    PCrawlerUrlDescBs UrlDescBs=Crawler-&gt;GetUrlDescBs();
209    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
210    IAssert(Url-&gt;IsOk(usHttp));
211    TMd5Sig UrlMd5Sig=TCrawler::GetUrlMd5Sig(Url-&gt;GetUrlStr());
212    if (UrlDescBs-&gt;IsUrl(UrlMd5Sig)){ 
213      if (UrlDescBs-&gt;GetUrlDesc(UrlMd5Sig).DocLev&gt;Lev){
214        UrlDescBs-&gt;GetUrlDesc(UrlMd5Sig).DocLev=Lev;}
215    } else
216    if (IsQUrl(UrlMd5Sig)){ 
217    } else
218    if ((Def-&gt;GetMxLev()==-1)||(Lev&lt;=Def-&gt;GetMxLev())&amp;&amp;
219     ((Def-&gt;GetMxDep()==-1)||(Dep&lt;=Def-&gt;GetMxDep()))){
220      int QUrlId=AddQUrl(UrlMd5Sig, Url-&gt;GetUrlStr(), Url-&gt;GetHostNm(), Lev, Dep);
221      while (LevUrlIdQV.Len()-1&lt;Lev){LevUrlIdQV.Add();}
222      LevUrlIdQV[Lev].Push(QUrlId);
223      HostBs-&gt;AddGetHost(Url-&gt;GetHostNm())-&gt;GetQueueUrls()++;
224    }
225  }
226  void TCrawlerQueue::PushQUrl(const TStr&amp; UrlStr, const int&amp; Lev, const int&amp; Dep){
227    PUrl Url=TUrl::New(UrlStr);
228    if (Url-&gt;IsOk(usHttp)){
229      PushQUrl(Url, Lev, Dep);
230    }
231  }
232  bool TCrawlerQueue::PopQUrl(int&amp; QUrlId, TStr&amp; UrlStr){
233    PCrawlerDef Def=Crawler-&gt;GetDef();
234    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
235    int MxCheckedUrlsPerLev=100; 
236    while (MxCheckedUrlsPerLev&lt;=100000){
237      for (int Lev=0; Lev&lt;LevUrlIdQV.Len(); Lev++){
238        int CheckedUrls=0;
239        if (!LevUrlIdQV[Lev].Empty()){
240          bool FirstP=true; int FirstQUrlId;
241          forever {
242            QUrlId=LevUrlIdQV[Lev].Top();
243            if (FirstP){FirstQUrlId=QUrlId; FirstP=false;}
244            else if (QUrlId==FirstQUrlId){break;}
245            CheckedUrls++;
246            if (CheckedUrls&gt;MxCheckedUrlsPerLev){break;}
247            LevUrlIdQV[Lev].Pop();
248            UrlStr=GetQUrlStr(QUrlId);
249            TStr HostNm=GetQHostNm(QUrlId);
250            PCrawlerHost Host=HostBs-&gt;AddGetHost(HostNm);
251            int ActiveConns=Host-&gt;GetActiveConns();
252            int MxConnsPerSrv=Def-&gt;GetMxConnsPerSrv();
253            TSecTm LastFetchTm=Host-&gt;GetLastFetchTm();
254            TSecTm CurTm=TSecTm::GetCurTm();
255            int AfterFetchDelaySecs=Def-&gt;GetAfterFetchDelaySecs();
256  		  int FetchDSecs=TInt::Abs(TSecTm::GetDSecs(LastFetchTm, CurTm));
257            if ((ActiveConns&lt;MxConnsPerSrv)&amp;&amp;(FetchDSecs&gt;=AfterFetchDelaySecs)){
258              Host-&gt;GetQueueUrls()--;
259              return true;
260            } else {
261              LevUrlIdQV[Lev].Push(QUrlId);
262            }
263          }
264        }
265      }
266      MxCheckedUrlsPerLev=MxCheckedUrlsPerLev*10;
267    }
268    return false;
269  }
270  void TCrawlerQueue::ShuffleUrlQ(){
271    if (Crawler-&gt;GetUrlDescBs()-&gt;GetUrls()%1000==0){
272      printf(&quot;*** Shuffle Queues\n&quot;);
273      for (int Lev=0; Lev&lt;LevUrlIdQV.Len(); Lev++){
274        TRnd Rnd(0); LevUrlIdQV[Lev].Shuffle(Rnd);
275        printf(&quot;    Queue Level %d: %d\n&quot;, Lev, LevUrlIdQV[Lev].Len());
276      }
277    }
278  }
279  void TCrawlerQueue::ResetQUrlBs(){
280    PCrawlerDef Def=Crawler-&gt;GetDef();
281    PCrawlerUrlDescBs UrlDescBs=Crawler-&gt;GetUrlDescBs();
282    if ((Def-&gt;GetQResetMod()&gt;0)&amp;&amp;(UrlDescBs-&gt;GetUrls()%Def-&gt;GetQResetMod()==0)){
283      PopSaveQUrlBs();
284      PushQUrlBs();
285    }
286  }
287  TStr TCrawlerQueue::GetUrlQBBsFNm() const {
288    TStr UrlQBBsFNm=
289     Crawler-&gt;GetDocBs()-&gt;GetDocBsNrFPath()+
290     Crawler-&gt;GetDocBs()-&gt;GetDocBsNm()+&quot;.&quot;+
291     TTm::GetUniqueCurUniTm().GetIdStr()+&quot;.UrlQBs&quot;;
292    return UrlQBBsFNm;
293  }
294  TStr TCrawlerQueue::GetUrlQBBsWcFNm() const {
295    TStr UrlQBBsFNm=
296     Crawler-&gt;GetDocBs()-&gt;GetDocBsNrFPath()+
297     Crawler-&gt;GetDocBs()-&gt;GetDocBsNm()+&quot;.*.UrlQBs&quot;;
298    return UrlQBBsFNm;
299  }
300  void TCrawlerQueue::PushQUrlBs(){
301    if (Empty()){
302      UrlMd5SigToUrlStrHostNmLevDepQuH.Clr(); 
303      LevUrlIdQV.Clr(); 
304    }
305    UrlQBBs=NULL; 
306    if (!ToDelUrlQBBsFNm.Empty()){ 
307      TFile::Del(ToDelUrlQBBsFNm); ToDelUrlQBBsFNm=&quot;&quot;;
308    }
309    TFFile FFile(GetUrlQBBsWcFNm(), false); TStr UrlQBBsFNm;
310    if (FFile.Next(UrlQBBsFNm)){
311      PBlobBs UrlQBBs=TGBlobBs::New(UrlQBBsFNm);
312      ToDelUrlQBBsFNm=UrlQBBsFNm;
313      TBlobPt TrvUrlQBlobPt=UrlQBBs-&gt;FFirstBlobPt();
314      TBlobPt UrlQBlobPt; PSIn UrlQBlobSIn;
315      while (UrlQBBs-&gt;FNextBlobPt(TrvUrlQBlobPt, UrlQBlobPt, UrlQBlobSIn)){
316        TStr UrlStr=TStr(*UrlQBlobSIn);
317        int Lev=TInt(*UrlQBlobSIn);
318        int Dep=TInt(*UrlQBlobSIn);
319        PushQUrl(UrlStr, Lev, Dep);
320      }
321    }
322  }
323  void TCrawlerQueue::PushQUrlToUrlQBs(const PUrl&amp; Url, const int&amp; Lev, const int&amp; Dep){
324    PCrawlerDef Def=Crawler-&gt;GetDef();
325    PCrawlerUrlDescBs UrlDescBs=Crawler-&gt;GetUrlDescBs();
326    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
327    IAssert(Url-&gt;IsOk(usHttp));
328    TMd5Sig UrlMd5Sig=TCrawler::GetUrlMd5Sig(Url-&gt;GetUrlStr());
329    if (UrlDescBs-&gt;IsUrl(UrlMd5Sig)){ 
330      if (UrlDescBs-&gt;GetUrlDesc(UrlMd5Sig).DocLev&gt;Lev){
331        UrlDescBs-&gt;GetUrlDesc(UrlMd5Sig).DocLev=Lev;}
332    } else
333    if (IsQUrl(UrlMd5Sig)){ 
334    } else
335    if ((Def-&gt;GetMxLev()==-1)||(Lev&lt;=Def-&gt;GetMxLev())&amp;&amp;
336     ((Def-&gt;GetMxDep()==-1)||(Dep&lt;=Def-&gt;GetMxDep()))){
337      if (UrlQBBs.Empty()){
338        TStr UrlQBBsFNm=GetUrlQBBsFNm(); printf(&quot;*** %s\n&quot;, UrlQBBsFNm.CStr());
339        UrlQBBs=TGBlobBs::New(UrlQBBsFNm, faCreate, Def-&gt;GetMxQSegLen());
340      }
341      TMOut UrlQSOut(Url-&gt;GetUrlStr().Len()+100);
342      Url-&gt;GetUrlStr().Save(UrlQSOut);
343      TInt(Lev).Save(UrlQSOut);
344      TInt(Dep).Save(UrlQSOut);
345      PSIn UrlQSIn=UrlQSOut.GetSIn();
346      TBlobPt UrlQBlobPt=UrlQBBs-&gt;PutBlob(UrlQSIn);
347      if (UrlQBlobPt.Empty()){
348        TStr UrlQBBsFNm=GetUrlQBBsFNm(); printf(&quot;*** %s\n&quot;, UrlQBBsFNm.CStr());
349        UrlQBBs=TGBlobBs::New(UrlQBBsFNm, faCreate, Def-&gt;GetMxQSegLen());
350        UrlQBlobPt=UrlQBBs-&gt;PutBlob(UrlQSIn);
351        IAssert(!UrlQBlobPt.Empty());
352      }
353    }
354  }
355  void TCrawlerQueue::PushQUrlToUrlQBs(const TStr&amp; UrlStr, const int&amp; Lev, const int&amp; Dep){
356    PUrl Url=TUrl::New(UrlStr);
357    if (Url-&gt;IsOk(usHttp)){
358      PushQUrlToUrlQBs(Url, Lev, Dep);
359    }
360  }
361  void TCrawlerQueue::PopSaveQUrlBs(){
362    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
363    PCrawlerFetcher Fetcher=Crawler-&gt;GetFetcher();
364    TStr UrlQBBsFNm=GetUrlQBBsFNm(); 
365    printf(&quot;*** Saving Active Queue-Url-Base To %s\n&quot;, UrlQBBsFNm.CStr());
366    UrlQBBs=TGBlobBs::New(UrlQBBsFNm, faCreate);
367    for (int Lev=0; Lev&lt;LevUrlIdQV.Len(); Lev++){
368      while (!LevUrlIdQV[Lev].Empty()){
369        int QUrlId=LevUrlIdQV[Lev].Top();
370        TStr HostNm=GetQHostNm(QUrlId);
371        PCrawlerHost Host=HostBs-&gt;GetHost(HostNm);
372        TStr UrlStr=GetQUrlStr(QUrlId);
373        int Dep=GetQUrlDep(QUrlId);
374        LevUrlIdQV[Lev].Pop();
375        Host-&gt;GetQueueUrls()--;
376        DelQUrl(QUrlId);
377        TMOut UrlQSOut(UrlStr.Len()+100);
378        UrlStr.Save(UrlQSOut);
379        TInt(Lev).Save(UrlQSOut);
<span onclick='openModal()' class='match'>380        TInt(Dep).Save(UrlQSOut);
381        PSIn UrlQSIn=UrlQSOut.GetSIn();
382        TBlobPt UrlQBlobPt=UrlQBBs-&gt;PutBlob(UrlQSIn);
383      }
</span>384    }
385  }
386  void TCrawlerFetcher::DelCrawlerFetcherConn(const int&amp; ConnId){
387    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
388    int QUrlId; PUrl Url; int FetchMSecs; GetDelConn(ConnId, QUrlId, Url, FetchMSecs);
389    Crawler-&gt;GetQueue()-&gt;DelQUrl(QUrlId);
390    PCrawlerHost Host=HostBs-&gt;GetHost(Url-&gt;GetHostNm());
391    Host-&gt;GetActiveConns()--;
392    Host-&gt;GetFetchErrors()++;
393    Host-&gt;GetLastFetchTm()=TSecTm::GetCurTm();
394  }
395  TCrawlerFetcher::TCrawlerFetcher(TCrawler* _Crawler):
396    TWebPgFetch(), Crawler(_Crawler), CurMxConns(-1), 
397    LastClrZombiesTm(), Zombies(0), ZombieConnIdToFetchSizeH(){
398    IAssert(Crawler-&gt;GetDef()-&gt;GetMxConns()!=-1);
399    PutMxConns(Crawler-&gt;GetDef()-&gt;GetMxConns());
400    CurMxConns=1;
401    PutMxContLen(Crawler-&gt;GetDef()-&gt;GetMxContLen());
402    PutMxRetries(Crawler-&gt;GetDef()-&gt;GetMxRetries());
403    if (Crawler-&gt;GetDef()-&gt;GetUserAgentStr()==&quot;ie8&quot;){
404      PutUserAgentStrIE8();
405    } else {
406      PutUserAgentStr(Crawler-&gt;GetDef()-&gt;GetUserAgentStr());
407    }
408  }
409  void TCrawlerFetcher::GetConnV(TIntStrIntIntQuV&amp; ConnIdUrlStrMSecsSizeQuV){
410    ConnIdUrlStrMSecsSizeQuV.Gen(GetConns(), 0);
411    int ConnP=ConnIdToQUrlIdUrlTmTrH.FFirstKeyId();
412    while (ConnIdToQUrlIdUrlTmTrH.FNextKeyId(ConnP)){
413      int ConnId=ConnIdToQUrlIdUrlTmTrH.GetKey(ConnP);
414      TStr UrlStr=ConnIdToQUrlIdUrlTmTrH[ConnP].Val2-&gt;GetUrlStr();
415      int FetchMSecs=int(TTm::GetCurUniMSecs()-ConnIdToQUrlIdUrlTmTrH[ConnP].Val3);
416      int FetchSize=GetConnBytesRead(ConnId);
417      ConnIdUrlStrMSecsSizeQuV.Add(TIntStrIntIntQu(ConnId, UrlStr, FetchMSecs, FetchSize));
418    }
419    ConnIdUrlStrMSecsSizeQuV.Sort();
420  }
421  void TCrawlerFetcher::ClrZombies(){
422    PCrawlerDef Def=Crawler-&gt;GetDef();
423    PCrawlerQueue Queue=Crawler-&gt;GetQueue();
424    if ((LastClrZombiesTm.IsDef())&amp;&amp;(TTm::GetDiffMSecs(LastClrZombiesTm, TTm::GetCurUniTm())&lt;100000)){return;}
425    LastClrZombiesTm=TTm::GetCurUniTm();
426    TIntStrIntIntQuV ConnIdUrlStrMSecsSizeQuV; GetConnV(ConnIdUrlStrMSecsSizeQuV);
427    int ConnIds=ConnIdUrlStrMSecsSizeQuV.Len();
428    for (int ConnN=0; ConnN&lt;ConnIds; ConnN++){
429      int ConnId=ConnIdUrlStrMSecsSizeQuV[ConnN].Val1;
430      TStr UrlStr=ConnIdUrlStrMSecsSizeQuV[ConnN].Val2;
431      int FetchSize=ConnIdUrlStrMSecsSizeQuV[ConnN].Val4;
432      if (ZombieConnIdToFetchSizeH.IsKey(ConnId)){
433        int PrevFetchSize=ZombieConnIdToFetchSizeH.GetDat(ConnId);
434        if (FetchSize==PrevFetchSize){
435          printf(&quot;*** Zombie: %s\n&quot;, UrlStr.CStr()); 
436          Zombies++; 
437          DelConn(ConnId); 
438          DelCrawlerFetcherConn(ConnId); 
439          Queue()-&gt;PushQUrl(UrlStr, 0, 0); 
440          PutCurMxConns(Def-&gt;GetMnConns()); 
441        }
442      }
443    }
444    ZombieConnIdToFetchSizeH.Clr(false);
445    for (int ConnN=0; ConnN&lt;ConnIds; ConnN++){
446      int ConnId=ConnIdUrlStrMSecsSizeQuV[ConnN].Val1;
447      int FetchSize=ConnIdUrlStrMSecsSizeQuV[ConnN].Val4;
448      ZombieConnIdToFetchSizeH.AddDat(ConnId)=FetchSize;
449    }
450  }
451  void TCrawlerFetcher::Fetch(){
452    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
453    PCrawlerQueue Queue=Crawler-&gt;GetQueue();
454    int QUrlId; TStr UrlStr;
455    while ((GetConns()&lt;=GetCurMxConns())&amp;&amp;(GetWaitUrls()==0)&amp;&amp;
456     (Queue-&gt;PopQUrl(QUrlId, UrlStr))){
457      PUrl IpUrl=TUrl::New(UrlStr);
458      PCrawlerHost Host=HostBs-&gt;AddGetHost(IpUrl-&gt;GetHostNm());
459      if (Host-&gt;IsIpNum()){
460        IpUrl-&gt;PutIpNum(Host-&gt;GetIpNum());}
461      int ConnId=FetchUrl(IpUrl);
462      PUrl Url=TUrl::New(UrlStr);
463      AddConn(ConnId, QUrlId, Url);
464      Host-&gt;GetActiveConns()++;
465    }
466    int QUrls=Queue-&gt;GetQUrls();
467    int MnQLen=Crawler-&gt;GetDef()-&gt;GetMnQLen();
468    if ((QUrls%100==0)&amp;&amp;(QUrls&lt;MnQLen)){
469      Queue-&gt;PushQUrlBs();
470    }
471  }
472  void TCrawlerFetcher::OnFetch(const int&amp; ConnId, const PWebPg&amp; WebPg){
473    PCrawlerDef Def=Crawler-&gt;GetDef();
474    PCrawlerUrlDescBs UrlDescBs=Crawler-&gt;GetUrlDescBs();
475    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
476    PCrawlerQueue Queue=Crawler-&gt;GetQueue();
477    PCrawlerDocBs DocBs=Crawler-&gt;GetDocBs();
478    int QUrlId; PUrl Url; int FetchMSecs; GetDelConn(ConnId, QUrlId, Url, FetchMSecs);
479    TMd5Sig UrlMd5Sig; int Lev; int Dep;
480    Queue-&gt;GetQUrl(QUrlId, UrlMd5Sig, Lev, Dep);
481    Queue-&gt;DelQUrl(QUrlId);
482    if (!UrlDescBs-&gt;IsUrl(UrlMd5Sig)){
483      /&amp;bsol;**IAssert(UrlMd5Sig==TCrawler::GetUrlMd5Sig(WebPg-&gt;GetUrlStr(0)));
484      if (UrlMd5Sig!=TCrawler::GetUrlMd5Sig(WebPg-&gt;GetUrlStr(0))){
485        SaveToErrLog(&quot;Begin:IAssert(UrlMd5Sig==TCrawler::GetUrlMd5Sig(WebPg-&gt;GetUrlStr(0)));&quot;);
486        SaveToErrLog(TStr::Fmt(&quot;Urls: %d&quot;, WebPg-&gt;GetUrls()).CStr());
487        SaveToErrLog(TStr::Fmt(&quot;Md5: %s&quot;, UrlMd5Sig.GetStr().CStr()).CStr());
488        for (int WebPgUrlN=0; WebPgUrlN&lt;WebPg-&gt;GetUrls(); WebPgUrlN++){
489          SaveToErrLog(TStr::Fmt(&quot;Url #%d: %s&quot;,
490           WebPgUrlN,
491           WebPg-&gt;GetUrlStr(WebPgUrlN).CStr()).CStr());
492        }
493        SaveToErrLog(&quot;End:IAssert(UrlMd5Sig==TCrawler::GetUrlMd5Sig(WebPg-&gt;GetUrlStr(0)));&quot;);
494      }
495      for (int WebPgUrlN=0; WebPgUrlN&lt;WebPg-&gt;GetUrls(); WebPgUrlN++){
496        TStr DocUrlStr=WebPg-&gt;GetUrlStr(WebPgUrlN);
497        TMd5Sig DocUrlMd5Sig=TCrawler::GetUrlMd5Sig(DocUrlStr);
498        if (!UrlDescBs-&gt;IsUrl(DocUrlMd5Sig)){
499          TBlobPt DocBlobPt; TMd5Sig DocMemMd5Sig;
500          TStr ContTypeNm=WebPg-&gt;GetHttpResp()-&gt;GetFldVal(THttp::ContTypeFldNm);
501          if (Def-&gt;IsContTypeNmOk(ContTypeNm)){
502            if (WebPgUrlN==WebPg-&gt;GetUrls()-1){
503              TMem DocMem; WebPg-&gt;GetHttpResp()-&gt;GetAsMem(DocMem);
504              DocMemMd5Sig=TMd5Sig(DocMem);
505              DocBlobPt=DocBs-&gt;AddDoc(DocUrlStr, DocMem);
506            } else {
507              TStr FinalUrlStr=WebPg-&gt;GetUrlStr(WebPg-&gt;GetUrls()-1);
508              PHttpResp RedirHttpResp=THttpResp::New(
509               THttp::RedirStatusCd, THttp::TextPlainFldVal, false, NULL, FinalUrlStr);
510              TMem DocMem; RedirHttpResp-&gt;GetAsMem(DocMem);
511              DocMemMd5Sig=TMd5Sig(DocMem);
512              DocBlobPt=DocBs-&gt;AddDoc(DocUrlStr, DocMem);
513            }
514          }
515          if (Def-&gt;IsRedirDmAllowed()){
516            PUrl Url=TUrl::New(DocUrlStr);
517            TStr HostNm=Url-&gt;GetHostNm();
518            Def-&gt;AddRqDmNm(HostNm);
519          }
520          TCrawlerUrlDesc UrlDesc(
521           DocBlobPt, DocMemMd5Sig, TSecTm::GetCurTm(), TUCh(Lev), TUCh(Dep));
522          UrlDescBs-&gt;AddUrlDesc(DocUrlMd5Sig, UrlDesc);
523        }
524      }
525    }
526    PCrawlerHost Host=HostBs-&gt;GetHost(Url-&gt;GetHostNm());
527    Host-&gt;GetIpNum()=WebPg-&gt;GetIpNum(0);
528    Host-&gt;GetActiveConns()--;
529    Host-&gt;GetFetchedUrls()++;
530    Host-&gt;GetTransferBytes()+=WebPg-&gt;GetHttpResp()-&gt;Len();
531    Host-&gt;GetTransferMSecs()+=int(WebPg-&gt;GetFetchMSecs());
532    Host-&gt;GetLastFetchTm()=TSecTm::GetCurTm();
533    TStr HostNm=Url-&gt;GetHostNm();
534    if (WebPg-&gt;GetHttpResp()-&gt;IsContType(THttp::TextFldVal)){
535      TUrlV OutUrlV; TUrlV OutRedirUrlV; WebPg-&gt;GetOutUrlV(OutUrlV, OutRedirUrlV);
536      if (Def-&gt;IsRedirDmAllowed()){
537        for (int UrlN=0; UrlN&lt;OutRedirUrlV.Len(); UrlN++){
538          TStr HostNm=OutRedirUrlV[UrlN]-&gt;GetHostNm();
539          Def-&gt;AddRqDmNm(HostNm);
540        }
541      }
542      for (int UrlN=0; UrlN&lt;OutUrlV.Len(); UrlN++){
543        TStr OutHostNm=OutUrlV[UrlN]-&gt;GetHostNm();
544        if (Def-&gt;IsHostNmOk(OutHostNm)){
545          if (Def-&gt;IsFExtOk(OutUrlV[UrlN])){
546            if (HostNm==OutHostNm){
547              Queue-&gt;PushQUrlToUrlQBs(OutUrlV[UrlN], Lev+1, Dep+1);
548            } else {
549              Queue-&gt;PushQUrlToUrlQBs(OutUrlV[UrlN], 0, Dep+1);
550            }
551          }
552        }
553      }
554    }
555    printf(&quot;Fetched [Lev:%d Dep:%d Queue:%d Fetched:%d Time:%d Size:%d]: %s\n&quot;,
556     Lev, Dep, Queue-&gt;GetQUrls(), UrlDescBs-&gt;GetUrls(), FetchMSecs,
557     WebPg-&gt;GetHttpResp()-&gt;Len(), WebPg-&gt;GetUrlStr().CStr());
558    Queue-&gt;ResetQUrlBs();
559    Queue-&gt;ShuffleUrlQ();
560    ClrZombies();
561    Fetch();
562    if (UrlDescBs-&gt;GetUrls()&gt;=Def-&gt;GetMxUrls()){
563      TSysMsg::Quit();
564    }
565  }
566  void TCrawlerFetcher::OnError(const int&amp; ConnId, const TStr&amp; MsgStr){
567    DelCrawlerFetcherConn(ConnId);
568    Fetch();
569    printf(&quot;Error: %s\n&quot;, MsgStr.CStr());
570  }
571  void TCrawlerTimer::OnTimeOut(){
572    PCrawlerDef Def=Crawler-&gt;GetDef();
573    PCrawlerFetcher Fetcher=Crawler-&gt;GetFetcher();
574    PCrawlerStat Stat=Crawler-&gt;GetStat();
575    uint64 CurEventMSecs=TTm::GetCurUniMSecs();
576    uint64 InterEventMSecs=CurEventMSecs-LastEventMSecs;
577    uint64 ToutMSecs=GetTimeOut();
578    double TimerEventPrecision=(ToutMSecs==0) ? 0 : double(InterEventMSecs)/ToutMSecs;
579    if (TimerEventPrecision&gt;1.01){
580      Fetcher-&gt;PutCurMxConns(int(Fetcher-&gt;GetCurMxConns()*0.90));
581    } else {
582      Fetcher-&gt;PutCurMxConns(Fetcher-&gt;GetCurMxConns()+1);
583    }
584    if (Fetcher-&gt;GetCurMxConns()&lt;Def-&gt;GetMnConns()){
585      Fetcher-&gt;PutCurMxConns(Def-&gt;GetMnConns());}
586    if (Fetcher-&gt;GetCurMxConns()&gt;Def-&gt;GetMxConns()){
587      Fetcher-&gt;PutCurMxConns(Def-&gt;GetMxConns());}
588    printf(&quot;---------------------------------------------------------------\n&quot;); 
589    printf(&quot;*** Crawler-Timer: Timeout-Precision=%.3f CurMxConns=%d\n&quot;, 
590     TimerEventPrecision, Fetcher-&gt;GetCurMxConns());
591    if (Crawler-&gt;GetFetcher()-&gt;Empty()&amp;&amp;Crawler-&gt;GetQueue()-&gt;Empty()){
592      Crawler-&gt;GetQueue()-&gt;PushQUrlBs();
593      if (Crawler-&gt;GetQueue()-&gt;Empty()){
594        TSysMsg::Quit();
595      }
596    } else {
597      int QUrls=Crawler-&gt;GetQueue()-&gt;GetQUrls();
598      int MnQLen=Crawler-&gt;GetDef()-&gt;GetMnQLen();
599      if ((QUrls%100==0)&amp;&amp;(QUrls&lt;MnQLen)){
600        Crawler-&gt;GetQueue()-&gt;PushQUrlBs();
601      }
602      Crawler-&gt;GetFetcher()-&gt;Fetch();
603    }
604    if (Last100SecsEventMSecs==0){
605      Last100SecsEventMSecs=CurEventMSecs;
606    } else 
607    if (CurEventMSecs-Last100SecsEventMSecs&gt;=100000){
608      Stat-&gt;On100Secs();
609      Last100SecsEventMSecs=CurEventMSecs;
610    }
611    if (Last1000SecsEventMSecs==0){
612      Last1000SecsEventMSecs=CurEventMSecs;
613    } else 
614    if (CurEventMSecs-Last1000SecsEventMSecs&gt;=1000000){
615      Stat-&gt;On1000Secs();
616      Last1000SecsEventMSecs=CurEventMSecs;
617    }
618    LastEventMSecs=CurEventMSecs;
619  }
620  TStr TCrawlerWebSrv::GetUrlStr(const int&amp; RefreshSecs, const TStr&amp; SortOrderNm){
621    TChA UrlChA;
622    UrlChA+=&#x27;/&#x27;;
623    UrlChA+=&#x27;?&#x27;;
624    UrlChA+=TStr::Fmt(&quot;Refresh=%d&quot;, RefreshSecs);
625    UrlChA+=&#x27;&amp;&#x27;;
626    UrlChA+=TStr::Fmt(&quot;Sort=%s&quot;, SortOrderNm.CStr());
627    return UrlChA;
628  }
629  TStr TCrawlerWebSrv::GetAnchorStr(const TStr&amp; DescStr, 
630   const int&amp; RefreshSecs, const TStr&amp; SortOrderNm){
631    TChA AnchorChA;
632    TStr UrlStr=GetUrlStr(RefreshSecs, SortOrderNm);
633    AnchorChA+=TStr::Fmt(&quot;&lt;a href=\&quot;%s\&quot;&gt;&quot;, UrlStr.CStr());
634    AnchorChA+=DescStr;
635    AnchorChA+=&quot;&lt;/a&gt;&quot;;
636    return AnchorChA;
637  }
638  void TCrawlerWebSrv::OnHttpRq(const int&amp; SockId, const PHttpRq&amp; HttpRq){
639    PCrawlerHostBs HostBs=Crawler-&gt;GetHostBs();
640    PCrawlerUrlDescBs UrlDescBs=Crawler-&gt;GetUrlDescBs();
641    PCrawlerFetcher Fetcher=Crawler-&gt;GetFetcher();
642    PCrawlerQueue Queue=Crawler-&gt;GetQueue();
643    PCrawlerStat Stat=Crawler-&gt;GetStat();
644    TStr UrlStr=HttpRq-&gt;GetUrl()-&gt;GetUrlStr();
645    TStr UrlPathStr=HttpRq-&gt;GetUrl()-&gt;GetPathStr();
646    PUrlEnv UrlEnv=HttpRq-&gt;GetUrlEnv();
647    bool StopCrawlingP=false;
648    if (UrlPathStr==&quot;/Stop&quot;){
649      StopCrawlingP=true;
650      TSysMsg::Quit();
651    }
652    int RefreshSecs=UrlEnv-&gt;GetVal(&quot;Refresh&quot;).GetInt(100);
653    TStr SortOrderNm=UrlEnv-&gt;GetVal(&quot;Sort&quot;);
654    TChA HtmlChA;
655    int ActiveConns; int FetchedUrls; int FetchErrors; int QueueUrls;
656    double TransferBytes; double TransferMSecs; 
657    double AvgHttpRespLen; double AvgTransferBps;
658    HostBs-&gt;GetSummaryInfo(ActiveConns, FetchedUrls, FetchErrors, QueueUrls, 
659     TransferBytes, TransferMSecs, AvgHttpRespLen, AvgTransferBps);
660    {HtmlChA+=&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Crawling&lt;/title&gt;&quot;;
661    if ((!StopCrawlingP)&amp;&amp;(RefreshSecs&gt;0)){
662      HtmlChA+=TStr::Fmt(&quot;&lt;meta http-equiv=\&quot;refresh\&quot; content=\&quot;%d\&quot;&gt;&quot;, RefreshSecs);}
663    HtmlChA+=&quot;&lt;/head&gt;&lt;body&gt;&quot;;
664    HtmlChA+=&quot;&lt;h1&gt;WebBird-Crawler&lt;/h1&gt;&quot;;
665    HtmlChA+=TSecTm::GetCurTm().GetStr(); HtmlChA+=&quot;&lt;br&gt;&quot;;
666    HtmlChA+=&quot;&lt;form method=get action=\&quot;/Stop\&quot;&gt;&quot;;
667    HtmlChA+=&quot;&lt;input type=submit value=Stop&gt;&quot;;
668    HtmlChA+=&quot;&lt;/form&gt;&quot;;
669    HtmlChA+=&quot;&lt;form method=get action=\&quot;/\&quot;&gt;&quot;;
670    HtmlChA+=&quot;&lt;input type=submit value=\&quot;Refresh Seconds\&quot;&gt;&quot;;
671    HtmlChA+=TStr::Fmt(&quot;&lt;input type=text name=\&quot;Refresh\&quot; value=\&quot;%d\&quot; size=2&gt;&quot;, RefreshSecs);
672    HtmlChA+=&quot;&lt;/form&gt;&quot;;}
673    {HtmlChA+=&quot;&lt;h2&gt;General Info&lt;/h2&gt;\n&quot;;
674    uint64 StartMSecs=TTm::GetMSecsFromTm(Crawler-&gt;GetStartTm());
675    uint64 CurMSecs=TTm::GetCurUniMSecs();
676    uint64 CrawlingMSecs=CurMSecs-StartMSecs;
677    double CrawlingSecs=CrawlingMSecs/1000.0;
678    double CrawlingPpsSpeed=CrawlingSecs&lt;=0 ? 0 : FetchedUrls/CrawlingSecs;
679    double AvgPgLen=(FetchedUrls&gt;0)&amp;&amp;(TransferBytes&gt;0) ? TransferBytes/FetchedUrls : 0;
680    HtmlChA+=&quot;&lt;table border=1&gt;\n&quot;;
681    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Urls Fetched&lt;td align=right&gt;%d&lt;/tr&gt;\n&quot;, UrlDescBs-&gt;GetUrls());
682    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Queue Length&lt;td align=right&gt;%d&lt;/tr&gt;\n&quot;, Queue-&gt;GetQUrls());
683    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Crawling Time&lt;td align=right&gt;%.0fs&lt;/tr&gt;\n&quot;, CrawlingSecs);
684    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Crawling Speed&lt;td align=right&gt;%.3fpps&lt;/tr&gt;\n&quot;, CrawlingPpsSpeed);
685    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Crawling Speed (last 1000secs)&lt;td align=right&gt;%.3fpps&lt;/tr&gt;\n&quot;, 
686      Stat-&gt;GetLast1000SecsCrawlingSpeed());
687    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Crawling Speed (last 100secs)&lt;td align=right&gt;%.3fpps&lt;/tr&gt;\n&quot;, 
688      Stat-&gt;GetLast100SecsCrawlingSpeed());
689    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Avg. Page Length&lt;td align=right&gt;%sb&lt;/tr&gt;\n&quot;, 
690     TFlt::GetGigaStr(AvgPgLen).CStr());
691    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Cleaned Zombies&lt;td align=right&gt;%d&lt;/tr&gt;\n&quot;, Fetcher-&gt;GetZombies());
692    HtmlChA+=&quot;&lt;/table&gt;\n&quot;;}
693    {HtmlChA+=&quot;&lt;h2&gt;Hosts&lt;/h2&gt;\n&quot;;
694    HtmlChA+=&quot;&lt;table border=1&gt;\n&quot;;
695    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;th&gt;%s (%d)&lt;th&gt;%s&lt;th&gt;%s&lt;th&gt;%s&lt;th&gt;%s&lt;th&gt;%s&lt;th&gt;%s&lt;th&gt;%s&lt;th&gt;%s&lt;/tr&gt;\n&quot;, 
696     GetAnchorStr(&quot;Hosts&quot;, RefreshSecs, &quot;Host&quot;).CStr(),
697     HostBs-&gt;GetHosts(),
698     GetAnchorStr(&quot;Active&quot;, RefreshSecs, &quot;Active&quot;).CStr(),
699     GetAnchorStr(&quot;Fetched&quot;, RefreshSecs, &quot;Fetched&quot;).CStr(),
700     GetAnchorStr(&quot;Errors&quot;, RefreshSecs, &quot;Errors&quot;).CStr(),
701     GetAnchorStr(&quot;Queue&quot;, RefreshSecs, &quot;Queue&quot;).CStr(),
702     GetAnchorStr(&quot;Bytes&quot;, RefreshSecs, &quot;Bytes&quot;).CStr(),
703     GetAnchorStr(&quot;Time&quot;, RefreshSecs, &quot;Time&quot;).CStr(),
704     GetAnchorStr(&quot;PageLen&quot;, RefreshSecs, &quot;PageLen&quot;).CStr(),
705     GetAnchorStr(&quot;Speed&quot;, RefreshSecs, &quot;Speed&quot;).CStr());
706    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;b&gt;Summary&lt;/b&gt;&quot;
707      &quot;&lt;td align=right&gt;&lt;b&gt;%d&lt;/b&gt;&lt;td align=right&gt;&lt;b&gt;%d&lt;/b&gt;&lt;td align=right&gt;&lt;b&gt;%d&lt;/b&gt;&lt;td align=right&gt;&lt;b&gt;%d&lt;/b&gt;&quot;
708      &quot;&lt;td align=right&gt;&lt;b&gt;%sb&lt;/b&gt;&lt;td align=right&gt;&lt;b&gt;%ss&lt;/b&gt;&lt;td align=right&gt;&lt;b&gt;%sb&lt;/b&gt;&lt;td align=right&gt;&lt;b&gt;%sbps&lt;/b&gt;&lt;/tr&gt;\n&quot;,
709     ActiveConns, FetchedUrls, FetchErrors, QueueUrls, 
710     TFlt::GetGigaStr(TransferBytes).CStr(), 
711     TFlt::GetGigaStr(TransferMSecs/1000).CStr(), 
712     TFlt::GetGigaStr(AvgHttpRespLen).CStr(),
713     TFlt::GetGigaStr(AvgTransferBps).CStr());
714    TCrawlerHostV HostV; HostBs-&gt;GetSortedHostV(HostV, SortOrderNm);
715    for (int HostN=0; HostN&lt;HostV.Len(); HostN++){
716      PCrawlerHost Host=HostV[HostN];
717      HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;&lt;a href=\&quot;http:&amp;bsol;&amp;bsol;%s\&quot;&gt;%s&lt;a&gt;&quot;
718       &quot;&lt;td align=right&gt;%d&lt;td align=right&gt;%d&lt;td align=right&gt;%d&lt;td align=right&gt;%d&quot;
719       &quot;&lt;td align=right&gt;%sb&lt;td align=right&gt;%ss&lt;td align=right&gt;%sb&lt;td align=right&gt;%sbps&lt;/tr&gt;\n&quot;,
720       Host-&gt;GetHostNm().CStr(), 
721       Host-&gt;GetHostNm().CStr(), 
722       Host-&gt;GetActiveConns(),
723       Host-&gt;GetFetchedUrls(), 
724       Host-&gt;GetFetchErrors(), 
725       Host-&gt;GetQueueUrls(),
726       TFlt::GetGigaStr(double(Host-&gt;GetTransferBytes())).CStr(), 
727       TFlt::GetGigaStr(Host-&gt;GetTransferMSecs()/1000).CStr(),
728       TFlt::GetGigaStr(Host-&gt;GetAvgHttpRespLen()).CStr(),
729       TFlt::GetGigaStr(Host-&gt;GetAvgTransferBps()).CStr()); 
730    }
731    HtmlChA+=&quot;&lt;/table&gt;&quot;;}
732    {HtmlChA+=&quot;&lt;h2&gt;Queue Levels&lt;/h2&gt;\n&quot;;
733    HtmlChA+=&quot;&lt;table border=1&gt;\n&quot;;
734    int AllQUrls=Queue-&gt;GetQUrls();
735    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;%s&lt;td align=right&gt;%d&lt;/tr&gt;\n&quot;,
736     &quot;All Queue Urls&quot;, AllQUrls);
737    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;%s&lt;td align=right&gt;%d&lt;/tr&gt;\n&quot;,
738      &quot;Unconn Queue Urls&quot;, Queue-&gt;GetUnconnQUrls());
739    for (int Lev=0; Lev&lt;Queue-&gt;GetQLevs(); Lev++){
740      HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;Level-%d Urls&lt;td align=right&gt;%d&lt;/tr&gt;\n&quot;,
741       Lev, Queue-&gt;GetQLevUrls(Lev));
742    }
743    HtmlChA+=&quot;&lt;/table&gt;&quot;;}
744    {HtmlChA+=&quot;&lt;h2&gt;Queue&lt;/h2&gt;\n&quot;;
745    TIntStrPrV QUrlsHostPrV; Queue-&gt;GetQUrlsHostPrV(QUrlsHostPrV);
746    HtmlChA+=&quot;&lt;table border=1&gt;\n&quot;;
747    HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;th&gt;#&lt;th&gt;Host&lt;th&gt;Queue-Urls&lt;th&gt;%%&lt;/tr&gt;\n&quot;);
748    int AllQUrls=Queue-&gt;GetQUrls();
749    for (int HostN=0; HostN&lt;QUrlsHostPrV.Len(); HostN++){
750      TStr HostLevNm=QUrlsHostPrV[HostN].Val2;
751      TStr HostNm; TStr LevStr; HostLevNm.SplitOnCh(HostNm, &#x27;:&#x27;, LevStr);
752      int QUrls=QUrlsHostPrV[HostN].Val1;
753      double QUrlsPrc=double(QUrls)/double(AllQUrls);
754      HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td align=right&gt;%d&lt;td align=right&gt;&lt;a href=\&quot;http:&amp;bsol;&amp;bsol;%s/\&quot;&gt;%s&lt;/a&gt; / %s&quot;
755       &quot;&lt;td align=right&gt;%d&lt;td align=right&gt;%.3f%%&lt;/tr&gt;\n&quot;,
756       1+HostN, HostNm.CStr(), HostNm.CStr(), LevStr.CStr(), QUrls, 100*QUrlsPrc);
757    }
758    HtmlChA+=&quot;&lt;/table&gt;&quot;;}
759    {TIntStrIntIntQuV ConnIdUrlStrMSecsSizeQuV;
760    Fetcher-&gt;GetConnV(ConnIdUrlStrMSecsSizeQuV);
761    int ConnIds=ConnIdUrlStrMSecsSizeQuV.Len();
762    HtmlChA+=&quot;&lt;h2&gt;Connections&lt;/h2&gt;\n&quot;;
763    HtmlChA+=&quot;&lt;table border=1&gt;\n&quot;;
764    HtmlChA+=&quot;&lt;tr&gt;&lt;th&gt;#&lt;th&gt;Connection&lt;th&gt;Time&lt;th&gt;Size&lt;th&gt;Url&lt;/tr&gt;\n&quot;;
765    for (int ConnN=0; ConnN&lt;ConnIds; ConnN++){
766      int ConnId=ConnIdUrlStrMSecsSizeQuV[ConnN].Val1;
767      TStr UrlStr=ConnIdUrlStrMSecsSizeQuV[ConnN].Val2;
768      int FetchMSecs=ConnIdUrlStrMSecsSizeQuV[ConnN].Val3;
769      int FetchSize=ConnIdUrlStrMSecsSizeQuV[ConnN].Val4;
770      HtmlChA+=TStr::Fmt(&quot;&lt;tr&gt;&lt;td&gt;%d&lt;td&gt;%d&lt;td&gt;%ss&lt;td&gt;%sb&lt;td&gt;&lt;a href=\&quot;%s\&quot;&gt;%s&lt;/a&gt;&lt;/tr&gt;\n&quot;,
771       1+ConnN, ConnId, 
772       TFlt::GetGigaStr(FetchMSecs/1000).CStr(), TFlt::GetGigaStr(FetchSize).CStr(), 
773       UrlStr.CStr(), UrlStr.CStr());
774    }
775    HtmlChA+=&quot;&lt;/table&gt;\n&quot;;}
776    HtmlChA+=&quot;&lt;/body&gt;&lt;/html&gt;&quot;;
777    PSIn BodySIn=TMIn::New(HtmlChA);
778    PHttpResp HttpResp=THttpResp::New(
779     THttp::OkStatusCd, THttp::TextHtmlFldVal, false, BodySIn);
780    SendHttpResp(SockId, HttpResp);
781  }
782  TFAccess TCrawlerDocBs::Open(){
783    TFAccess DocBsFAccess=TFRnd::GetFAccessFromStr(DocBsFAccessNm);
784    IAssert((DocBsFAccess==faCreate)||(DocBsFAccess==faUpdate)||(DocBsFAccess==faRestore));
785    DocBBs=TMBlobBs::New(DocBsNrFPath+DocBsNm, DocBsFAccess, DocBsMxSegLen);
786    return DocBsFAccess;
787  }
788  void TCrawlerDocBs::Close(){
789    DocBBs=NULL;
790  }
791  TBlobPt TCrawlerDocBs::AddDoc(const TStr&amp; DocUrlStr, const TMem&amp; DocMem){
792    TMOut SOut(DocUrlStr.Len()+DocMem.Len()+100);
793    TTm::GetCurUniTm().GetWebLogDateTimeStr().Save(SOut);
794    DocUrlStr.Save(SOut);
795    DocMem.Save(SOut);
796    PSIn SIn=SOut.GetSIn();
797    TBlobPt BPt=DocBBs-&gt;PutBlob(SIn);
798    return BPt;
799  }
800  bool TCrawlerDocBs::FNextDocBlobPt(TBlobPt&amp; TrvDocBlobPt,
801   TBlobPt&amp; DocBlobPt, TStr&amp; DateTimeStr, TStr&amp; DocUrlStr, TMem&amp; DocMem){
802    PSIn DocBlobSIn;
803    if (DocBBs-&gt;FNextBlobPt(TrvDocBlobPt, DocBlobPt, DocBlobSIn)){
804      DateTimeStr=TStr(*DocBlobSIn); 
805      DocUrlStr=TStr(*DocBlobSIn); 
806      DocMem=TMem(*DocBlobSIn); 
807      return true;
808    } else {
809      return false;
810    }
811  }
812  void TCrawlerStat::On100Secs(){
813    uint64 CurEventMSecs=TTm::GetCurUniMSecs();
814    uint64 CurFetchedUrls=Crawler-&gt;GetUrlDescBs()-&gt;GetUrls();
815    double DiffSecs=(CurEventMSecs-Last100SecsEventMSecs)/double(1000);
816    if (DiffSecs&lt;1){
817      Last100SecsCrawlingSpeed=0;
818    } else {
819      Last100SecsCrawlingSpeed=(CurFetchedUrls-Last100SecsFetchedUrls)/DiffSecs;
820    }
821    Last100SecsEventMSecs=CurEventMSecs;
822    Last100SecsFetchedUrls=CurFetchedUrls;
823  }
824  void TCrawlerStat::On1000Secs(){
825    uint64 CurEventMSecs=TTm::GetCurUniMSecs();
826    uint64 CurFetchedUrls=Crawler-&gt;GetUrlDescBs()-&gt;GetUrls();
827    double DiffSecs=(CurEventMSecs-Last1000SecsEventMSecs)/double(1000);
828    if (DiffSecs&lt;1){
829      Last1000SecsCrawlingSpeed=0;
830    } else {
831      Last1000SecsCrawlingSpeed=(CurFetchedUrls-Last1000SecsFetchedUrls)/DiffSecs;
832    }
833    Last1000SecsEventMSecs=CurEventMSecs;
834    Last1000SecsFetchedUrls=CurFetchedUrls;
835  }
836  TCrawler::TCrawler():
837    Def(TCrawlerDef::New()),
838    UrlDescBs(), HostBs(), Queue(), Fetcher(), DocBs(), Timer(), WebSrv(),
839    StartTm(TTm::GetCurUniTm()){
840    DocBs=TCrawlerDocBs::New(this);
841  }
842  void TCrawler::DefCrawlBs(const TStr&amp; CrawlBsNm, const TStr&amp; CrawlBsFPath,
843   const TStr&amp; CrawlBsFAccessNm, const int&amp; CrawlBsMxSegLen){
844    PCrawlerDocBs DocBs=GetDocBs();
845    DocBs-&gt;PutDocBsNm(CrawlBsNm);
846    DocBs-&gt;PutDocBsNrFPath(TStr::GetNrFPath(CrawlBsFPath));
847    DocBs-&gt;PutDocBsFAccessNm(CrawlBsFAccessNm);
848    DocBs-&gt;PutDocBsMxSegLen(CrawlBsMxSegLen);
849  }
850  void TCrawler::StartCrawling(){
851    UrlDescBs=TCrawlerUrlDescBs::New(this);
852    HostBs=TCrawlerHostBs::New(this);
853    Queue=TCrawlerQueue::New(this);
854    Fetcher=TCrawlerFetcher::New(this);
855    Stat=TCrawlerStat::New(this);
856    TFAccess DocBsFAccess=GetDocBs()-&gt;Open();
857    if (DocBsFAccess==faCreate){
858      PCrawlerDef Def=GetDef();
859      int StartUrls=Def-&gt;GetStartUrls();
860      for (int UrlN=0; UrlN&lt;StartUrls; UrlN++){
861        Queue-&gt;PushQUrl(Def-&gt;GetStartUrl(UrlN), 0, 0);}
862    }
863    if (DocBsFAccess==faRestore){
864      printf(&quot;Restoring Crawled Documents...\n&quot;);
865      TBlobPt TrvDocBlobPt=GetDocBs()-&gt;FFirstDocBlobPt();
866      TBlobPt DocBlobPt; TStr DateTimeStr; TStr DocUrlStr; TMem DocMem; int DocN=0;
867      while (GetDocBs()-&gt;FNextDocBlobPt(TrvDocBlobPt, DocBlobPt, DateTimeStr, DocUrlStr, DocMem)){
868        DocN++; printf(&quot;%d\r&quot;, DocN);
869        TMd5Sig DocUrlMd5Sig=TCrawler::GetUrlMd5Sig(DocUrlStr);
870        TMd5Sig DocMemMd5Sig(DocMem);
871        TCrawlerUrlDesc UrlDesc(DocBlobPt, DocMemMd5Sig, TSecTm::GetCurTm(), TUCh(0), TUCh(0));
872        UrlDescBs-&gt;AddUrlDesc(DocUrlMd5Sig, UrlDesc);
873      }
874      printf(&quot;\nDone.\n&quot;);
875    }
876    if (DocBsFAccess==faUpdate){
877      GetUrlDescBs()-&gt;Load();
878    }
879    Timer=TCrawlerTimer::New(this, 1000);
880    WebSrv=TCrawlerWebSrv::New(this);
881    Fetcher-&gt;Fetch();
882  }
883  void TCrawler::StopCrawling(){
884    WebSrv=NULL;
885    Timer-&gt;StopTimer();
886    GetDocBs()-&gt;Close();
887    GetUrlDescBs()-&gt;Save();
888    GetQueue()-&gt;PopSaveQUrlBs();
889  }
890  TMd5Sig TCrawler::GetUrlMd5Sig(const TStr&amp; UrlStr){
891    TStr LcUrlStr=UrlStr.GetLc();
892    return TMd5Sig(LcUrlStr);
893  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-crawler.cpp</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-crawler.cpp</div>
                </div>
                <div class="column column_space"><pre><code>344      TInt(Dep).Save(UrlQSOut);
345      PSIn UrlQSIn=UrlQSOut.GetSIn();
346      TBlobPt UrlQBlobPt=UrlQBBs-&gt;PutBlob(UrlQSIn);
347      if (UrlQBlobPt.Empty()){
</pre></code></div>
                <div class="column column_space"><pre><code>380        TInt(Dep).Save(UrlQSOut);
381        PSIn UrlQSIn=UrlQSOut.GetSIn();
382        TBlobPt UrlQBlobPt=UrlQBBs-&gt;PutBlob(UrlQSIn);
383      }
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    