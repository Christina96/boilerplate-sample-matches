
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 15, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>caffe-MDEwOlJlcG9zaXRvcnk2MTg3MDgwMw==-flat-test_scale_layer.cpp</h3>
            <pre><code>1  #include <algorithm>
2  #include <vector>
3  #include "gtest/gtest.h"
4  #include "caffe/blob.hpp"
5  #include "caffe/common.hpp"
6  #include "caffe/filler.hpp"
7  #include "caffe/layers/scale_layer.hpp"
8  #include "caffe/test/test_caffe_main.hpp"
9  #include "caffe/test/test_gradient_check_util.hpp"
10  namespace caffe {
11  template <typename TypeParam>
12  class ScaleLayerTest : public MultiDeviceTest<TypeParam> {
13    typedef typename TypeParam::Dtype Dtype;
14   protected:
15    ScaleLayerTest()
16        : blob_bottom_(new Blob<Dtype>(2, 3, 4, 5)),
17          blob_bottom_eltwise_(new Blob<Dtype>(2, 3, 4, 5)),
18          blob_bottom_broadcast_0_(new Blob<Dtype>()),
19          blob_bottom_broadcast_1_(new Blob<Dtype>()),
20          blob_bottom_broadcast_2_(new Blob<Dtype>()),
21          blob_bottom_scale_(new Blob<Dtype>(vector<int>())),
22          blob_top_(new Blob<Dtype>()) {
23      Caffe::set_random_seed(1701);
24      vector<int> broadcast_shape(2);
25      broadcast_shape[0] = 2; broadcast_shape[1] = 3;
26      this->blob_bottom_broadcast_0_->Reshape(broadcast_shape);
27      broadcast_shape[0] = 3; broadcast_shape[1] = 4;
28      this->blob_bottom_broadcast_1_->Reshape(broadcast_shape);
29      broadcast_shape[0] = 4; broadcast_shape[1] = 5;
30      this->blob_bottom_broadcast_2_->Reshape(broadcast_shape);
31      FillerParameter filler_param;
32      filler_param.set_min(1);
33      filler_param.set_max(10);
34      UniformFiller<Dtype> filler(filler_param);
35      filler.Fill(this->blob_bottom_);
36      filler.Fill(this->blob_bottom_eltwise_);
37      filler.Fill(this->blob_bottom_broadcast_0_);
38      filler.Fill(this->blob_bottom_broadcast_1_);
39      filler.Fill(this->blob_bottom_broadcast_2_);
40      filler.Fill(this->blob_bottom_scale_);
41      blob_bottom_vec_.push_back(blob_bottom_);
42      blob_top_vec_.push_back(blob_top_);
43    }
44    virtual ~ScaleLayerTest() {
45      delete blob_bottom_;
46      delete blob_bottom_eltwise_;
47      delete blob_bottom_broadcast_0_;
48      delete blob_bottom_broadcast_1_;
49      delete blob_bottom_broadcast_2_;
50      delete blob_bottom_scale_;
51      delete blob_top_;
52    }
53    Blob<Dtype>* const blob_bottom_;
54    Blob<Dtype>* const blob_bottom_eltwise_;
55    Blob<Dtype>* const blob_bottom_broadcast_0_;
56    Blob<Dtype>* const blob_bottom_broadcast_1_;
57    Blob<Dtype>* const blob_bottom_broadcast_2_;
58    Blob<Dtype>* const blob_bottom_scale_;
59    Blob<Dtype>* const blob_top_;
60    vector<Blob<Dtype>*> blob_bottom_vec_;
61    vector<Blob<Dtype>*> blob_top_vec_;
62  };
63  TYPED_TEST_CASE(ScaleLayerTest, TestDtypesAndDevices);
64  TYPED_TEST(ScaleLayerTest, TestForwardEltwise) {
65    typedef typename TypeParam::Dtype Dtype;
66    this->blob_bottom_vec_.push_back(this->blob_bottom_eltwise_);
67    LayerParameter layer_param;
68    layer_param.mutable_scale_param()->set_axis(0);
69    shared_ptr<ScaleLayer<Dtype> > layer(new ScaleLayer<Dtype>(layer_param));
70    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
71    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
72    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
73    const Dtype* data = this->blob_top_->cpu_data();
74    const int count = this->blob_top_->count();
75    const Dtype* in_data_a = this->blob_bottom_->cpu_data();
76    const Dtype* in_data_b = this->blob_bottom_eltwise_->cpu_data();
77    for (int i = 0; i < count; ++i) {
78      EXPECT_NEAR(data[i], in_data_a[i] * in_data_b[i], 1e-5);
79    }
80  }
81  TYPED_TEST(ScaleLayerTest, TestForwardEltwiseInPlace) {
82    typedef typename TypeParam::Dtype Dtype;
83    this->blob_top_vec_[0] = this->blob_bottom_;  
84    Blob<Dtype> orig_bottom(this->blob_bottom_->shape());
85    orig_bottom.CopyFrom(*this->blob_bottom_);
86    this->blob_bottom_vec_.push_back(this->blob_bottom_eltwise_);
87    LayerParameter layer_param;
88    layer_param.mutable_scale_param()->set_axis(0);
89    shared_ptr<ScaleLayer<Dtype> > layer(new ScaleLayer<Dtype>(layer_param));
90    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
91    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
92    const Dtype* data = this->blob_bottom_->cpu_data();
93    const int count = this->blob_bottom_->count();
94    const Dtype* in_data_a = orig_bottom.cpu_data();
95    const Dtype* in_data_b = this->blob_bottom_eltwise_->cpu_data();
96    for (int i = 0; i < count; ++i) {
97      EXPECT_NEAR(data[i], in_data_a[i] * in_data_b[i], 1e-5);
98    }
99  }
100  TYPED_TEST(ScaleLayerTest, TestBackwardEltwiseInPlace) {
101    typedef typename TypeParam::Dtype Dtype;
102    Blob<Dtype> orig_bottom(this->blob_bottom_->shape());
103    orig_bottom.CopyFrom(*this->blob_bottom_);
104    this->blob_bottom_vec_.push_back(this->blob_bottom_eltwise_);
105    LayerParameter layer_param;
106    layer_param.mutable_scale_param()->set_axis(0);
107    shared_ptr<ScaleLayer<Dtype> > layer(new ScaleLayer<Dtype>(layer_param));
<span onclick='openModal()' class='match'>108    Blob<Dtype> top_diff(this->blob_bottom_->shape());
109    FillerParameter filler_param;
</span>110    filler_param.set_type("gaussian");
111    filler_param.set_std(1);
112    GaussianFiller<Dtype> filler(filler_param);
113    filler.Fill(&top_diff);
114    vector<bool> propagate_down(2, true);
115    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
116    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
117    caffe_copy(top_diff.count(), top_diff.cpu_data(),
118               this->blob_top_->mutable_cpu_diff());
119    layer->Backward(this->blob_top_vec_, propagate_down, this->blob_bottom_vec_);
120    const bool kReshape = true;
121    const bool kCopyDiff = true;
122    Blob<Dtype> orig_bottom_diff;
123    orig_bottom_diff.CopyFrom(*this->blob_bottom_, kCopyDiff, kReshape);
124    Blob<Dtype> orig_scale_diff;
125    orig_scale_diff.CopyFrom(*this->blob_bottom_eltwise_,
126                              kCopyDiff, kReshape);
127    this->blob_top_vec_[0] = this->blob_bottom_;  
128    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
129    caffe_copy(top_diff.count(), top_diff.cpu_data(),
130               this->blob_bottom_->mutable_cpu_diff());
131    layer->Backward(this->blob_top_vec_, propagate_down, this->blob_bottom_vec_);
132    for (int i = 0; i < this->blob_bottom_->count(); ++i) {
133      EXPECT_NEAR(orig_bottom_diff.cpu_diff()[i],
134                  this->blob_bottom_->cpu_diff()[i], 1e-5);
135    }
136    for (int i = 0; i < this->blob_bottom_eltwise_->count(); ++i) {
137      EXPECT_NEAR(orig_scale_diff.cpu_diff()[i],
138                  this->blob_bottom_eltwise_->cpu_diff()[i], 1e-5);
139    }
140  }
141  TYPED_TEST(ScaleLayerTest, TestForwardEltwiseWithParam) {
142    typedef typename TypeParam::Dtype Dtype;
143    LayerParameter layer_param;
144    ScaleParameter* scale_param = layer_param.mutable_scale_param();
145    scale_param->set_axis(0);
146    scale_param->set_num_axes(-1);
147    scale_param->mutable_filler()->set_type("gaussian");
148    shared_ptr<ScaleLayer<Dtype> > layer(new ScaleLayer<Dtype>(layer_param));
149    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
150    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
151    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
152    const Dtype* data = this->blob_top_->cpu_data();
153    const int count = this->blob_top_->count();
154    const Dtype* in_data_a = this->blob_bottom_->cpu_data();
155    const Dtype* in_data_b = layer->blobs()[0]->cpu_data();
156    for (int i = 0; i < count; ++i) {
157      EXPECT_NEAR(data[i], in_data_a[i] * in_data_b[i], 1e-5);
158    }
159  }
160  TYPED_TEST(ScaleLayerTest, TestForwardBroadcastBegin) {
161    typedef typename TypeParam::Dtype Dtype;
162    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_0_);
163    LayerParameter layer_param;
164    layer_param.mutable_scale_param()->set_axis(0);
165    shared_ptr<ScaleLayer<Dtype> > layer(new ScaleLayer<Dtype>(layer_param));
166    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
167    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
168    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
169    for (int n = 0; n < this->blob_bottom_->num(); ++n) {
170      for (int c = 0; c < this->blob_bottom_->channels(); ++c) {
171        for (int h = 0; h < this->blob_bottom_->height(); ++h) {
172          for (int w = 0; w < this->blob_bottom_->width(); ++w) {
173            EXPECT_NEAR(this->blob_top_->data_at(n, c, h, w),
174                        this->blob_bottom_->data_at(n, c, h, w) *
175                        this->blob_bottom_broadcast_0_->data_at(n, c, 0, 0),
176                        1e-5);
177          }
178        }
179      }
180    }
181  }
182  TYPED_TEST(ScaleLayerTest, TestForwardBroadcastMiddle) {
183    typedef typename TypeParam::Dtype Dtype;
184    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_1_);
185    LayerParameter layer_param;
186    layer_param.mutable_scale_param()->set_axis(1);
187    shared_ptr<ScaleLayer<Dtype> > layer(new ScaleLayer<Dtype>(layer_param));
188    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
189    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
190    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
191    for (int n = 0; n < this->blob_bottom_->num(); ++n) {
192      for (int c = 0; c < this->blob_bottom_->channels(); ++c) {
193        for (int h = 0; h < this->blob_bottom_->height(); ++h) {
194          for (int w = 0; w < this->blob_bottom_->width(); ++w) {
195            EXPECT_NEAR(this->blob_top_->data_at(n, c, h, w),
196                        this->blob_bottom_->data_at(n, c, h, w) *
197                        this->blob_bottom_broadcast_1_->data_at(c, h, 0, 0),
198                        1e-5);
199          }
200        }
201      }
202    }
203  }
204  TYPED_TEST(ScaleLayerTest, TestForwardBroadcastMiddleInPlace) {
205    typedef typename TypeParam::Dtype Dtype;
206    this->blob_top_vec_[0] = this->blob_bottom_;  
207    Blob<Dtype> orig_bottom(this->blob_bottom_->shape());
208    orig_bottom.CopyFrom(*this->blob_bottom_);
209    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_1_);
210    LayerParameter layer_param;
211    layer_param.mutable_scale_param()->set_axis(1);
212    shared_ptr<ScaleLayer<Dtype> > layer(new ScaleLayer<Dtype>(layer_param));
213    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
214    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
215    for (int n = 0; n < this->blob_bottom_->num(); ++n) {
216      for (int c = 0; c < this->blob_bottom_->channels(); ++c) {
217        for (int h = 0; h < this->blob_bottom_->height(); ++h) {
218          for (int w = 0; w < this->blob_bottom_->width(); ++w) {
219            EXPECT_NEAR(this->blob_bottom_->data_at(n, c, h, w),
220                        orig_bottom.data_at(n, c, h, w) *
221                        this->blob_bottom_broadcast_1_->data_at(c, h, 0, 0),
222                        1e-5);
223          }
224        }
225      }
226    }
227  }
228  TYPED_TEST(ScaleLayerTest, TestBackwardBroadcastMiddleInPlace) {
229    typedef typename TypeParam::Dtype Dtype;
230    Blob<Dtype> orig_bottom(this->blob_bottom_->shape());
231    orig_bottom.CopyFrom(*this->blob_bottom_);
232    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_1_);
233    LayerParameter layer_param;
234    layer_param.mutable_scale_param()->set_axis(1);
235    shared_ptr<ScaleLayer<Dtype> > layer(new ScaleLayer<Dtype>(layer_param));
236    Blob<Dtype> top_diff(this->blob_bottom_->shape());
237    FillerParameter filler_param;
238    filler_param.set_type("gaussian");
239    filler_param.set_std(1);
240    GaussianFiller<Dtype> filler(filler_param);
241    filler.Fill(&top_diff);
242    vector<bool> propagate_down(2, true);
243    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
244    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
245    caffe_copy(top_diff.count(), top_diff.cpu_data(),
246               this->blob_top_->mutable_cpu_diff());
247    layer->Backward(this->blob_top_vec_, propagate_down, this->blob_bottom_vec_);
248    const bool kReshape = true;
249    const bool kCopyDiff = true;
250    Blob<Dtype> orig_bottom_diff;
251    orig_bottom_diff.CopyFrom(*this->blob_bottom_, kCopyDiff, kReshape);
252    Blob<Dtype> orig_scale_diff;
253    orig_scale_diff.CopyFrom(*this->blob_bottom_broadcast_1_,
254                              kCopyDiff, kReshape);
255    this->blob_top_vec_[0] = this->blob_bottom_;  
256    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
257    caffe_copy(top_diff.count(), top_diff.cpu_data(),
258               this->blob_bottom_->mutable_cpu_diff());
259    layer->Backward(this->blob_top_vec_, propagate_down, this->blob_bottom_vec_);
260    for (int i = 0; i < this->blob_bottom_->count(); ++i) {
261      EXPECT_NEAR(orig_bottom_diff.cpu_diff()[i],
262                  this->blob_bottom_->cpu_diff()[i], 1e-5);
263    }
264    for (int i = 0; i < this->blob_bottom_broadcast_1_->count(); ++i) {
265      EXPECT_NEAR(orig_scale_diff.cpu_diff()[i],
266                  this->blob_bottom_broadcast_1_->cpu_diff()[i], 1e-5);
267    }
268  }
269  TYPED_TEST(ScaleLayerTest, TestForwardBroadcastMiddleWithParam) {
270    typedef typename TypeParam::Dtype Dtype;
271    LayerParameter layer_param;
272    ScaleParameter* scale_param = layer_param.mutable_scale_param();
273    scale_param->set_axis(1);
274    scale_param->set_num_axes(2);
275    scale_param->mutable_filler()->set_type("gaussian");
276    shared_ptr<ScaleLayer<Dtype> > layer(new ScaleLayer<Dtype>(layer_param));
277    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
278    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
279    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
280    for (int n = 0; n < this->blob_bottom_->num(); ++n) {
281      for (int c = 0; c < this->blob_bottom_->channels(); ++c) {
282        for (int h = 0; h < this->blob_bottom_->height(); ++h) {
283          for (int w = 0; w < this->blob_bottom_->width(); ++w) {
284            EXPECT_NEAR(this->blob_top_->data_at(n, c, h, w),
285                        this->blob_bottom_->data_at(n, c, h, w) *
286                        layer->blobs()[0]->data_at(c, h, 0, 0), 1e-5);
287          }
288        }
289      }
290    }
291  }
292  TYPED_TEST(ScaleLayerTest, TestForwardBroadcastMiddleWithParamAndBias) {
293    typedef typename TypeParam::Dtype Dtype;
294    LayerParameter layer_param;
295    ScaleParameter* scale_param = layer_param.mutable_scale_param();
296    scale_param->set_axis(1);
297    scale_param->set_num_axes(2);
298    scale_param->mutable_filler()->set_type("gaussian");
299    scale_param->set_bias_term(true);
300    scale_param->mutable_bias_filler()->set_type("gaussian");
301    shared_ptr<ScaleLayer<Dtype> > layer(new ScaleLayer<Dtype>(layer_param));
302    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
303    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
304    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
305    for (int n = 0; n < this->blob_bottom_->num(); ++n) {
306      for (int c = 0; c < this->blob_bottom_->channels(); ++c) {
307        for (int h = 0; h < this->blob_bottom_->height(); ++h) {
308          for (int w = 0; w < this->blob_bottom_->width(); ++w) {
309            EXPECT_NEAR(this->blob_top_->data_at(n, c, h, w),
310                        this->blob_bottom_->data_at(n, c, h, w) *
311                        layer->blobs()[0]->data_at(c, h, 0, 0) +
312                        layer->blobs()[1]->data_at(c, h, 0, 0), 1e-5);
313          }
314        }
315      }
316    }
317  }
318  TYPED_TEST(ScaleLayerTest, TestForwardBroadcastEnd) {
319    typedef typename TypeParam::Dtype Dtype;
320    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_2_);
321    LayerParameter layer_param;
322    layer_param.mutable_scale_param()->set_axis(2);
323    shared_ptr<ScaleLayer<Dtype> > layer(new ScaleLayer<Dtype>(layer_param));
324    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
325    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
326    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
327    for (int n = 0; n < this->blob_bottom_->num(); ++n) {
328      for (int c = 0; c < this->blob_bottom_->channels(); ++c) {
329        for (int h = 0; h < this->blob_bottom_->height(); ++h) {
330          for (int w = 0; w < this->blob_bottom_->width(); ++w) {
331            EXPECT_NEAR(this->blob_top_->data_at(n, c, h, w),
332                        this->blob_bottom_->data_at(n, c, h, w) *
333                        this->blob_bottom_broadcast_2_->data_at(h, w, 0, 0),
334                        1e-5);
335          }
336        }
337      }
338    }
339  }
340  TYPED_TEST(ScaleLayerTest, TestForwardScale) {
341    typedef typename TypeParam::Dtype Dtype;
342    this->blob_bottom_vec_.push_back(this->blob_bottom_scale_);
343    LayerParameter layer_param;
344    shared_ptr<ScaleLayer<Dtype> > layer(new ScaleLayer<Dtype>(layer_param));
345    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
346    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
347    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
348    const Dtype* data = this->blob_top_->cpu_data();
349    const int count = this->blob_top_->count();
350    const Dtype* in_data = this->blob_bottom_->cpu_data();
351    const Dtype scale = *this->blob_bottom_scale_->cpu_data();
352    for (int i = 0; i < count; ++i) {
353      EXPECT_NEAR(data[i], in_data[i] * scale, 1e-5);
354    }
355  }
356  TYPED_TEST(ScaleLayerTest, TestForwardScaleAxis2) {
357    typedef typename TypeParam::Dtype Dtype;
358    this->blob_bottom_vec_.push_back(this->blob_bottom_scale_);
359    LayerParameter layer_param;
360    layer_param.mutable_scale_param()->set_axis(2);
361    shared_ptr<ScaleLayer<Dtype> > layer(new ScaleLayer<Dtype>(layer_param));
362    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
363    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
364    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
365    const Dtype* data = this->blob_top_->cpu_data();
366    const int count = this->blob_top_->count();
367    const Dtype* in_data = this->blob_bottom_->cpu_data();
368    const Dtype scale = *this->blob_bottom_scale_->cpu_data();
369    for (int i = 0; i < count; ++i) {
370      EXPECT_NEAR(data[i], in_data[i] * scale, 1e-5);
371    }
372  }
373  TYPED_TEST(ScaleLayerTest, TestGradientEltwise) {
374    typedef typename TypeParam::Dtype Dtype;
375    this->blob_bottom_vec_.push_back(this->blob_bottom_eltwise_);
376    LayerParameter layer_param;
377    layer_param.mutable_scale_param()->set_axis(0);
378    ScaleLayer<Dtype> layer(layer_param);
379    GradientChecker<Dtype> checker(1e-2, 1e-3);
380    checker.CheckGradientEltwise(&layer, this->blob_bottom_vec_,
381        this->blob_top_vec_);
382  }
383  TYPED_TEST(ScaleLayerTest, TestGradientEltwiseWithParam) {
384    typedef typename TypeParam::Dtype Dtype;
385    LayerParameter layer_param;
386    ScaleParameter* scale_param = layer_param.mutable_scale_param();
387    scale_param->set_axis(0);
388    scale_param->set_num_axes(-1);
389    scale_param->mutable_filler()->set_type("gaussian");
390    ScaleLayer<Dtype> layer(layer_param);
391    GradientChecker<Dtype> checker(1e-2, 1e-3);
392    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
393        this->blob_top_vec_);
394  }
395  TYPED_TEST(ScaleLayerTest, TestGradientBroadcastBegin) {
396    typedef typename TypeParam::Dtype Dtype;
397    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_0_);
398    LayerParameter layer_param;
399    layer_param.mutable_scale_param()->set_axis(0);
400    ScaleLayer<Dtype> layer(layer_param);
401    GradientChecker<Dtype> checker(1e-2, 1e-3);
402    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
403        this->blob_top_vec_);
404  }
405  TYPED_TEST(ScaleLayerTest, TestGradientBroadcastMiddle) {
406    typedef typename TypeParam::Dtype Dtype;
407    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_1_);
408    LayerParameter layer_param;
409    layer_param.mutable_scale_param()->set_axis(1);
410    ScaleLayer<Dtype> layer(layer_param);
411    GradientChecker<Dtype> checker(1e-2, 1e-3);
412    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
413        this->blob_top_vec_);
414  }
415  TYPED_TEST(ScaleLayerTest, TestGradientBroadcastMiddleWithParam) {
416    typedef typename TypeParam::Dtype Dtype;
417    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_1_);
418    LayerParameter layer_param;
419    ScaleParameter* scale_param = layer_param.mutable_scale_param();
420    scale_param->set_axis(1);
421    scale_param->set_num_axes(2);
422    scale_param->mutable_filler()->set_type("gaussian");
423    ScaleLayer<Dtype> layer(layer_param);
424    GradientChecker<Dtype> checker(1e-2, 1e-3);
425    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
426        this->blob_top_vec_);
427  }
428  TYPED_TEST(ScaleLayerTest, TestGradientBroadcastEnd) {
429    typedef typename TypeParam::Dtype Dtype;
430    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_2_);
431    LayerParameter layer_param;
432    layer_param.mutable_scale_param()->set_axis(2);
433    ScaleLayer<Dtype> layer(layer_param);
434    GradientChecker<Dtype> checker(1e-2, 1e-3);
435    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
436        this->blob_top_vec_);
437  }
438  TYPED_TEST(ScaleLayerTest, TestGradientScale) {
439    typedef typename TypeParam::Dtype Dtype;
440    this->blob_bottom_vec_.push_back(this->blob_bottom_scale_);
441    LayerParameter layer_param;
442    ScaleLayer<Dtype> layer(layer_param);
443    GradientChecker<Dtype> checker(1e-2, 1e-3);
444    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
445        this->blob_top_vec_);
446  }
447  TYPED_TEST(ScaleLayerTest, TestGradientScaleAndBias) {
448    typedef typename TypeParam::Dtype Dtype;
449    this->blob_bottom_vec_.push_back(this->blob_bottom_scale_);
450    LayerParameter layer_param;
451    ScaleParameter* scale_param = layer_param.mutable_scale_param();
452    scale_param->set_bias_term(true);
453    scale_param->mutable_bias_filler()->set_type("gaussian");
454    ScaleLayer<Dtype> layer(layer_param);
455    GradientChecker<Dtype> checker(1e-2, 1e-3);
456    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
457        this->blob_top_vec_);
458  }
459  TYPED_TEST(ScaleLayerTest, TestGradientScaleAxis2) {
460    typedef typename TypeParam::Dtype Dtype;
461    this->blob_bottom_vec_.push_back(this->blob_bottom_scale_);
462    LayerParameter layer_param;
463    layer_param.mutable_scale_param()->set_axis(2);
464    ScaleLayer<Dtype> layer(layer_param);
465    GradientChecker<Dtype> checker(1e-2, 1e-3);
466    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
467        this->blob_top_vec_);
468  }
469  }  
</code></pre>
        </div>
        <div class="column">
            <h3>caffe-MDEwOlJlcG9zaXRvcnk2MTg3MDgwMw==-flat-test_bias_layer.cpp</h3>
            <pre><code>1  #include <algorithm>
2  #include <vector>
3  #include "gtest/gtest.h"
4  #include "caffe/blob.hpp"
5  #include "caffe/common.hpp"
6  #include "caffe/filler.hpp"
7  #include "caffe/layers/bias_layer.hpp"
8  #include "caffe/test/test_caffe_main.hpp"
9  #include "caffe/test/test_gradient_check_util.hpp"
10  namespace caffe {
11  template <typename TypeParam>
12  class BiasLayerTest : public MultiDeviceTest<TypeParam> {
13    typedef typename TypeParam::Dtype Dtype;
14   protected:
15    BiasLayerTest()
16        : blob_bottom_(new Blob<Dtype>(2, 3, 4, 5)),
17          blob_bottom_eltwise_(new Blob<Dtype>(2, 3, 4, 5)),
18          blob_bottom_broadcast_0_(new Blob<Dtype>()),
19          blob_bottom_broadcast_1_(new Blob<Dtype>()),
20          blob_bottom_broadcast_2_(new Blob<Dtype>()),
21          blob_bottom_bias_(new Blob<Dtype>(vector<int>())),
22          blob_top_(new Blob<Dtype>()) {
23      Caffe::set_random_seed(1701);
24      vector<int> broadcast_shape(2);
25      broadcast_shape[0] = 2; broadcast_shape[1] = 3;
26      this->blob_bottom_broadcast_0_->Reshape(broadcast_shape);
27      broadcast_shape[0] = 3; broadcast_shape[1] = 4;
28      this->blob_bottom_broadcast_1_->Reshape(broadcast_shape);
29      broadcast_shape[0] = 4; broadcast_shape[1] = 5;
30      this->blob_bottom_broadcast_2_->Reshape(broadcast_shape);
31      FillerParameter filler_param;
32      filler_param.set_min(1);
33      filler_param.set_max(10);
34      UniformFiller<Dtype> filler(filler_param);
35      filler.Fill(this->blob_bottom_);
36      filler.Fill(this->blob_bottom_eltwise_);
37      filler.Fill(this->blob_bottom_broadcast_0_);
38      filler.Fill(this->blob_bottom_broadcast_1_);
39      filler.Fill(this->blob_bottom_broadcast_2_);
40      filler.Fill(this->blob_bottom_bias_);
41      blob_bottom_vec_.push_back(blob_bottom_);
42      blob_top_vec_.push_back(blob_top_);
43    }
44    virtual ~BiasLayerTest() {
45      delete blob_bottom_;
46      delete blob_bottom_eltwise_;
47      delete blob_bottom_broadcast_0_;
48      delete blob_bottom_broadcast_1_;
49      delete blob_bottom_broadcast_2_;
50      delete blob_bottom_bias_;
51      delete blob_top_;
52    }
53    Blob<Dtype>* const blob_bottom_;
54    Blob<Dtype>* const blob_bottom_eltwise_;
55    Blob<Dtype>* const blob_bottom_broadcast_0_;
56    Blob<Dtype>* const blob_bottom_broadcast_1_;
57    Blob<Dtype>* const blob_bottom_broadcast_2_;
58    Blob<Dtype>* const blob_bottom_bias_;
59    Blob<Dtype>* const blob_top_;
60    vector<Blob<Dtype>*> blob_bottom_vec_;
61    vector<Blob<Dtype>*> blob_top_vec_;
62  };
63  TYPED_TEST_CASE(BiasLayerTest, TestDtypesAndDevices);
64  TYPED_TEST(BiasLayerTest, TestForwardEltwise) {
65    typedef typename TypeParam::Dtype Dtype;
66    this->blob_bottom_vec_.push_back(this->blob_bottom_eltwise_);
67    LayerParameter layer_param;
68    layer_param.mutable_bias_param()->set_axis(0);
69    shared_ptr<BiasLayer<Dtype> > layer(new BiasLayer<Dtype>(layer_param));
70    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
71    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
72    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
73    const Dtype* data = this->blob_top_->cpu_data();
74    const int count = this->blob_top_->count();
75    const Dtype* in_data_a = this->blob_bottom_->cpu_data();
76    const Dtype* in_data_b = this->blob_bottom_eltwise_->cpu_data();
77    for (int i = 0; i < count; ++i) {
78      EXPECT_NEAR(data[i], in_data_a[i] + in_data_b[i], 1e-5);
79    }
80  }
81  TYPED_TEST(BiasLayerTest, TestForwardEltwiseInPlace) {
82    typedef typename TypeParam::Dtype Dtype;
83    this->blob_top_vec_[0] = this->blob_bottom_;  
84    Blob<Dtype> orig_bottom(this->blob_bottom_->shape());
85    orig_bottom.CopyFrom(*this->blob_bottom_);
86    this->blob_bottom_vec_.push_back(this->blob_bottom_eltwise_);
87    LayerParameter layer_param;
88    layer_param.mutable_bias_param()->set_axis(0);
89    shared_ptr<BiasLayer<Dtype> > layer(new BiasLayer<Dtype>(layer_param));
90    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
91    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
92    const Dtype* data = this->blob_bottom_->cpu_data();
93    const int count = this->blob_bottom_->count();
94    const Dtype* in_data_a = orig_bottom.cpu_data();
95    const Dtype* in_data_b = this->blob_bottom_eltwise_->cpu_data();
96    for (int i = 0; i < count; ++i) {
97      EXPECT_NEAR(data[i], in_data_a[i] + in_data_b[i], 1e-5);
98    }
99  }
100  TYPED_TEST(BiasLayerTest, TestBackwardEltwiseInPlace) {
101    typedef typename TypeParam::Dtype Dtype;
<span onclick='openModal()' class='match'>102    Blob<Dtype> orig_bottom(this->blob_bottom_->shape());
103    orig_bottom.CopyFrom(*this->blob_bottom_);
</span>104    this->blob_bottom_vec_.push_back(this->blob_bottom_eltwise_);
105    LayerParameter layer_param;
106    layer_param.mutable_bias_param()->set_axis(0);
107    shared_ptr<BiasLayer<Dtype> > layer(new BiasLayer<Dtype>(layer_param));
108    Blob<Dtype> top_diff(this->blob_bottom_->shape());
109    FillerParameter filler_param;
110    filler_param.set_type("gaussian");
111    filler_param.set_std(1);
112    GaussianFiller<Dtype> filler(filler_param);
113    filler.Fill(&top_diff);
114    vector<bool> propagate_down(2, true);
115    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
116    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
117    caffe_copy(top_diff.count(), top_diff.cpu_data(),
118               this->blob_top_->mutable_cpu_diff());
119    layer->Backward(this->blob_top_vec_, propagate_down, this->blob_bottom_vec_);
120    const bool kReshape = true;
121    const bool kCopyDiff = true;
122    Blob<Dtype> orig_bottom_diff;
123    orig_bottom_diff.CopyFrom(*this->blob_bottom_, kCopyDiff, kReshape);
124    Blob<Dtype> orig_bias_diff;
125    orig_bias_diff.CopyFrom(*this->blob_bottom_eltwise_,
126                              kCopyDiff, kReshape);
127    this->blob_top_vec_[0] = this->blob_bottom_;  
128    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
129    caffe_copy(top_diff.count(), top_diff.cpu_data(),
130               this->blob_bottom_->mutable_cpu_diff());
131    layer->Backward(this->blob_top_vec_, propagate_down, this->blob_bottom_vec_);
132    for (int i = 0; i < this->blob_bottom_->count(); ++i) {
133      EXPECT_NEAR(orig_bottom_diff.cpu_diff()[i],
134                  this->blob_bottom_->cpu_diff()[i], 1e-5);
135    }
136    for (int i = 0; i < this->blob_bottom_eltwise_->count(); ++i) {
137      EXPECT_NEAR(orig_bias_diff.cpu_diff()[i],
138                  this->blob_bottom_eltwise_->cpu_diff()[i], 1e-5);
139    }
140  }
141  TYPED_TEST(BiasLayerTest, TestForwardEltwiseWithParam) {
142    typedef typename TypeParam::Dtype Dtype;
143    LayerParameter layer_param;
144    BiasParameter* bias_param = layer_param.mutable_bias_param();
145    bias_param->set_axis(0);
146    bias_param->set_num_axes(-1);
147    bias_param->mutable_filler()->set_type("gaussian");
148    shared_ptr<BiasLayer<Dtype> > layer(new BiasLayer<Dtype>(layer_param));
149    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
150    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
151    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
152    const Dtype* data = this->blob_top_->cpu_data();
153    const int count = this->blob_top_->count();
154    const Dtype* in_data_a = this->blob_bottom_->cpu_data();
155    const Dtype* in_data_b = layer->blobs()[0]->cpu_data();
156    for (int i = 0; i < count; ++i) {
157      EXPECT_NEAR(data[i], in_data_a[i] + in_data_b[i], 1e-5);
158    }
159  }
160  TYPED_TEST(BiasLayerTest, TestForwardBroadcastBegin) {
161    typedef typename TypeParam::Dtype Dtype;
162    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_0_);
163    LayerParameter layer_param;
164    layer_param.mutable_bias_param()->set_axis(0);
165    shared_ptr<BiasLayer<Dtype> > layer(new BiasLayer<Dtype>(layer_param));
166    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
167    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
168    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
169    for (int n = 0; n < this->blob_bottom_->num(); ++n) {
170      for (int c = 0; c < this->blob_bottom_->channels(); ++c) {
171        for (int h = 0; h < this->blob_bottom_->height(); ++h) {
172          for (int w = 0; w < this->blob_bottom_->width(); ++w) {
173            EXPECT_NEAR(this->blob_top_->data_at(n, c, h, w),
174                        this->blob_bottom_->data_at(n, c, h, w) +
175                        this->blob_bottom_broadcast_0_->data_at(n, c, 0, 0),
176                        1e-5);
177          }
178        }
179      }
180    }
181  }
182  TYPED_TEST(BiasLayerTest, TestForwardBroadcastMiddle) {
183    typedef typename TypeParam::Dtype Dtype;
184    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_1_);
185    LayerParameter layer_param;
186    layer_param.mutable_bias_param()->set_axis(1);
187    shared_ptr<BiasLayer<Dtype> > layer(new BiasLayer<Dtype>(layer_param));
188    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
189    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
190    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
191    for (int n = 0; n < this->blob_bottom_->num(); ++n) {
192      for (int c = 0; c < this->blob_bottom_->channels(); ++c) {
193        for (int h = 0; h < this->blob_bottom_->height(); ++h) {
194          for (int w = 0; w < this->blob_bottom_->width(); ++w) {
195            EXPECT_NEAR(this->blob_top_->data_at(n, c, h, w),
196                        this->blob_bottom_->data_at(n, c, h, w) +
197                        this->blob_bottom_broadcast_1_->data_at(c, h, 0, 0),
198                        1e-5);
199          }
200        }
201      }
202    }
203  }
204  TYPED_TEST(BiasLayerTest, TestForwardBroadcastMiddleInPlace) {
205    typedef typename TypeParam::Dtype Dtype;
206    this->blob_top_vec_[0] = this->blob_bottom_;  
207    Blob<Dtype> orig_bottom(this->blob_bottom_->shape());
208    orig_bottom.CopyFrom(*this->blob_bottom_);
209    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_1_);
210    LayerParameter layer_param;
211    layer_param.mutable_bias_param()->set_axis(1);
212    shared_ptr<BiasLayer<Dtype> > layer(new BiasLayer<Dtype>(layer_param));
213    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
214    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
215    for (int n = 0; n < this->blob_bottom_->num(); ++n) {
216      for (int c = 0; c < this->blob_bottom_->channels(); ++c) {
217        for (int h = 0; h < this->blob_bottom_->height(); ++h) {
218          for (int w = 0; w < this->blob_bottom_->width(); ++w) {
219            EXPECT_NEAR(this->blob_bottom_->data_at(n, c, h, w),
220                        orig_bottom.data_at(n, c, h, w) +
221                        this->blob_bottom_broadcast_1_->data_at(c, h, 0, 0),
222                        1e-5);
223          }
224        }
225      }
226    }
227  }
228  TYPED_TEST(BiasLayerTest, TestBackwardBroadcastMiddleInPlace) {
229    typedef typename TypeParam::Dtype Dtype;
230    Blob<Dtype> orig_bottom(this->blob_bottom_->shape());
231    orig_bottom.CopyFrom(*this->blob_bottom_);
232    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_1_);
233    LayerParameter layer_param;
234    layer_param.mutable_bias_param()->set_axis(1);
235    shared_ptr<BiasLayer<Dtype> > layer(new BiasLayer<Dtype>(layer_param));
236    Blob<Dtype> top_diff(this->blob_bottom_->shape());
237    FillerParameter filler_param;
238    filler_param.set_type("gaussian");
239    filler_param.set_std(1);
240    GaussianFiller<Dtype> filler(filler_param);
241    filler.Fill(&top_diff);
242    vector<bool> propagate_down(2, true);
243    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
244    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
245    caffe_copy(top_diff.count(), top_diff.cpu_data(),
246               this->blob_top_->mutable_cpu_diff());
247    layer->Backward(this->blob_top_vec_, propagate_down, this->blob_bottom_vec_);
248    const bool kReshape = true;
249    const bool kCopyDiff = true;
250    Blob<Dtype> orig_bottom_diff;
251    orig_bottom_diff.CopyFrom(*this->blob_bottom_, kCopyDiff, kReshape);
252    Blob<Dtype> orig_bias_diff;
253    orig_bias_diff.CopyFrom(*this->blob_bottom_broadcast_1_,
254                              kCopyDiff, kReshape);
255    this->blob_top_vec_[0] = this->blob_bottom_;  
256    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
257    caffe_copy(top_diff.count(), top_diff.cpu_data(),
258               this->blob_bottom_->mutable_cpu_diff());
259    layer->Backward(this->blob_top_vec_, propagate_down, this->blob_bottom_vec_);
260    for (int i = 0; i < this->blob_bottom_->count(); ++i) {
261      EXPECT_NEAR(orig_bottom_diff.cpu_diff()[i],
262                  this->blob_bottom_->cpu_diff()[i], 1e-5);
263    }
264    for (int i = 0; i < this->blob_bottom_broadcast_1_->count(); ++i) {
265      EXPECT_NEAR(orig_bias_diff.cpu_diff()[i],
266                  this->blob_bottom_broadcast_1_->cpu_diff()[i], 1e-5);
267    }
268  }
269  TYPED_TEST(BiasLayerTest, TestForwardBroadcastMiddleWithParam) {
270    typedef typename TypeParam::Dtype Dtype;
271    LayerParameter layer_param;
272    BiasParameter* bias_param = layer_param.mutable_bias_param();
273    bias_param->set_axis(1);
274    bias_param->set_num_axes(2);
275    bias_param->mutable_filler()->set_type("gaussian");
276    shared_ptr<BiasLayer<Dtype> > layer(new BiasLayer<Dtype>(layer_param));
277    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
278    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
279    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
280    for (int n = 0; n < this->blob_bottom_->num(); ++n) {
281      for (int c = 0; c < this->blob_bottom_->channels(); ++c) {
282        for (int h = 0; h < this->blob_bottom_->height(); ++h) {
283          for (int w = 0; w < this->blob_bottom_->width(); ++w) {
284            EXPECT_NEAR(this->blob_top_->data_at(n, c, h, w),
285                        this->blob_bottom_->data_at(n, c, h, w) +
286                        layer->blobs()[0]->data_at(c, h, 0, 0), 1e-5);
287          }
288        }
289      }
290    }
291  }
292  TYPED_TEST(BiasLayerTest, TestForwardBroadcastEnd) {
293    typedef typename TypeParam::Dtype Dtype;
294    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_2_);
295    LayerParameter layer_param;
296    layer_param.mutable_bias_param()->set_axis(2);
297    shared_ptr<BiasLayer<Dtype> > layer(new BiasLayer<Dtype>(layer_param));
298    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
299    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
300    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
301    for (int n = 0; n < this->blob_bottom_->num(); ++n) {
302      for (int c = 0; c < this->blob_bottom_->channels(); ++c) {
303        for (int h = 0; h < this->blob_bottom_->height(); ++h) {
304          for (int w = 0; w < this->blob_bottom_->width(); ++w) {
305            EXPECT_NEAR(this->blob_top_->data_at(n, c, h, w),
306                        this->blob_bottom_->data_at(n, c, h, w) +
307                        this->blob_bottom_broadcast_2_->data_at(h, w, 0, 0),
308                        1e-5);
309          }
310        }
311      }
312    }
313  }
314  TYPED_TEST(BiasLayerTest, TestForwardBias) {
315    typedef typename TypeParam::Dtype Dtype;
316    this->blob_bottom_vec_.push_back(this->blob_bottom_bias_);
317    LayerParameter layer_param;
318    shared_ptr<BiasLayer<Dtype> > layer(new BiasLayer<Dtype>(layer_param));
319    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
320    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
321    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
322    const Dtype* data = this->blob_top_->cpu_data();
323    const int count = this->blob_top_->count();
324    const Dtype* in_data = this->blob_bottom_->cpu_data();
325    const Dtype bias = *this->blob_bottom_bias_->cpu_data();
326    for (int i = 0; i < count; ++i) {
327      EXPECT_NEAR(data[i], in_data[i] + bias, 1e-5);
328    }
329  }
330  TYPED_TEST(BiasLayerTest, TestForwardBiasAxis2) {
331    typedef typename TypeParam::Dtype Dtype;
332    this->blob_bottom_vec_.push_back(this->blob_bottom_bias_);
333    LayerParameter layer_param;
334    layer_param.mutable_bias_param()->set_axis(2);
335    shared_ptr<BiasLayer<Dtype> > layer(new BiasLayer<Dtype>(layer_param));
336    layer->SetUp(this->blob_bottom_vec_, this->blob_top_vec_);
337    ASSERT_EQ(this->blob_bottom_->shape(), this->blob_top_->shape());
338    layer->Forward(this->blob_bottom_vec_, this->blob_top_vec_);
339    const Dtype* data = this->blob_top_->cpu_data();
340    const int count = this->blob_top_->count();
341    const Dtype* in_data = this->blob_bottom_->cpu_data();
342    const Dtype bias = *this->blob_bottom_bias_->cpu_data();
343    for (int i = 0; i < count; ++i) {
344      EXPECT_NEAR(data[i], in_data[i] + bias, 1e-5);
345    }
346  }
347  TYPED_TEST(BiasLayerTest, TestGradientEltwise) {
348    typedef typename TypeParam::Dtype Dtype;
349    this->blob_bottom_vec_.push_back(this->blob_bottom_eltwise_);
350    LayerParameter layer_param;
351    layer_param.mutable_bias_param()->set_axis(0);
352    BiasLayer<Dtype> layer(layer_param);
353    GradientChecker<Dtype> checker(1e-2, 1e-3);
354    checker.CheckGradientEltwise(&layer, this->blob_bottom_vec_,
355        this->blob_top_vec_);
356  }
357  TYPED_TEST(BiasLayerTest, TestGradientEltwiseWithParam) {
358    typedef typename TypeParam::Dtype Dtype;
359    LayerParameter layer_param;
360    BiasParameter* bias_param = layer_param.mutable_bias_param();
361    bias_param->set_axis(0);
362    bias_param->set_num_axes(-1);
363    bias_param->mutable_filler()->set_type("gaussian");
364    BiasLayer<Dtype> layer(layer_param);
365    GradientChecker<Dtype> checker(1e-2, 1e-3);
366    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
367        this->blob_top_vec_);
368  }
369  TYPED_TEST(BiasLayerTest, TestGradientBroadcastBegin) {
370    typedef typename TypeParam::Dtype Dtype;
371    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_0_);
372    LayerParameter layer_param;
373    layer_param.mutable_bias_param()->set_axis(0);
374    BiasLayer<Dtype> layer(layer_param);
375    GradientChecker<Dtype> checker(1e-2, 1e-3);
376    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
377        this->blob_top_vec_);
378  }
379  TYPED_TEST(BiasLayerTest, TestGradientBroadcastMiddle) {
380    typedef typename TypeParam::Dtype Dtype;
381    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_1_);
382    LayerParameter layer_param;
383    layer_param.mutable_bias_param()->set_axis(1);
384    BiasLayer<Dtype> layer(layer_param);
385    GradientChecker<Dtype> checker(1e-2, 1e-3);
386    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
387        this->blob_top_vec_);
388  }
389  TYPED_TEST(BiasLayerTest, TestGradientBroadcastMiddleWithParam) {
390    typedef typename TypeParam::Dtype Dtype;
391    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_1_);
392    LayerParameter layer_param;
393    BiasParameter* bias_param = layer_param.mutable_bias_param();
394    bias_param->set_axis(1);
395    bias_param->set_num_axes(2);
396    bias_param->mutable_filler()->set_type("gaussian");
397    BiasLayer<Dtype> layer(layer_param);
398    GradientChecker<Dtype> checker(1e-2, 1e-3);
399    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
400        this->blob_top_vec_);
401  }
402  TYPED_TEST(BiasLayerTest, TestGradientBroadcastEnd) {
403    typedef typename TypeParam::Dtype Dtype;
404    this->blob_bottom_vec_.push_back(this->blob_bottom_broadcast_2_);
405    LayerParameter layer_param;
406    layer_param.mutable_bias_param()->set_axis(2);
407    BiasLayer<Dtype> layer(layer_param);
408    GradientChecker<Dtype> checker(1e-2, 1e-3);
409    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
410        this->blob_top_vec_);
411  }
412  TYPED_TEST(BiasLayerTest, TestGradientBias) {
413    typedef typename TypeParam::Dtype Dtype;
414    this->blob_bottom_vec_.push_back(this->blob_bottom_bias_);
415    LayerParameter layer_param;
416    BiasLayer<Dtype> layer(layer_param);
417    GradientChecker<Dtype> checker(1e-2, 1e-3);
418    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
419        this->blob_top_vec_);
420  }
421  TYPED_TEST(BiasLayerTest, TestGradientBiasAxis2) {
422    typedef typename TypeParam::Dtype Dtype;
423    this->blob_bottom_vec_.push_back(this->blob_bottom_bias_);
424    LayerParameter layer_param;
425    layer_param.mutable_bias_param()->set_axis(2);
426    BiasLayer<Dtype> layer(layer_param);
427    GradientChecker<Dtype> checker(1e-2, 1e-3);
428    checker.CheckGradientExhaustive(&layer, this->blob_bottom_vec_,
429        this->blob_top_vec_);
430  }
431  }  
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from caffe-MDEwOlJlcG9zaXRvcnk2MTg3MDgwMw==-flat-test_scale_layer.cpp</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from caffe-MDEwOlJlcG9zaXRvcnk2MTg3MDgwMw==-flat-test_bias_layer.cpp</div>
                </div>
                <div class="column column_space"><pre><code>108    Blob<Dtype> top_diff(this->blob_bottom_->shape());
109    FillerParameter filler_param;
</pre></code></div>
                <div class="column column_space"><pre><code>102    Blob<Dtype> orig_bottom(this->blob_bottom_->shape());
103    orig_bottom.CopyFrom(*this->blob_bottom_);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    