
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 20, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-bowbs.cpp</h3>
            <pre><code>1  void TBowKWordSet::GetWordStrV(TStrV&amp; WordStrV) const {
2    WordStrV.Clr(); int KWords=GetKWords();
3    for (int KWordN=0; KWordN&lt;KWords; KWordN++){
4      WordStrV.Add(GetKWordStr(KWordN));
5    }
6  }
7  TStr TBowKWordSet::GetKWordsStr() const {
8    TChA ResChA; int KWords=GetKWords();
9    for (int KWordN=0; KWordN&lt;KWords; KWordN++){
10      if (KWordN&gt;0){ResChA+=&quot;, &quot;;}
11      ResChA+=GetKWordStr(KWordN);
12    }
13    return ResChA;
14  }
15  void TBowKWordSet::SortByStr(){
16    TStrFltPrV WStrWWgtPrV;
17    WStrToWWgtH.GetKeyDatPrV(WStrWWgtPrV);
18    WStrWWgtPrV.Sort();
19    WStrToWWgtH.Clr();
20    for (int WordN=0; WordN&lt;WStrWWgtPrV.Len(); WordN++){
21      WStrToWWgtH.AddDat(WStrWWgtPrV[WordN].Val1, WStrWWgtPrV[WordN].Val2);
22    }
23  }
24  void TBowKWordSet::SortByWgt(){
25    TFltStrPrV WWgtWStrPrV;
26    WStrToWWgtH.GetDatKeyPrV(WWgtWStrPrV);
27    WWgtWStrPrV.Sort(false);
28    WStrToWWgtH.Clr();
29    for (int WordN=0; WordN&lt;WWgtWStrPrV.Len(); WordN++){
30      WStrToWWgtH.AddDat(WWgtWStrPrV[WordN].Val2, WWgtWStrPrV[WordN].Val1);
31    }
32  }
33  PBowKWordSet TBowKWordSet::GetTopKWords(const int&amp; MxKWords, const double&amp; WgtSumPrc) const {
34    TFltStrPrV WWgtWStrPrV;
35    WStrToWWgtH.GetDatKeyPrV(WWgtWStrPrV);
36    WWgtWStrPrV.Sort(false);
37    double WgtSum=0;
38    for (int WordN=0; WordN&lt;WWgtWStrPrV.Len(); WordN++){
39      WgtSum+=WWgtWStrPrV[WordN].Val1;
40    }
41    PBowKWordSet KWordSet=TBowKWordSet::New(GetNm());
42    double WgtSumSF=0;
43    for (int WordN=0; WordN&lt;WWgtWStrPrV.Len(); WordN++){
44      KWordSet-&gt;AddKWord(WWgtWStrPrV[WordN].Val2, WWgtWStrPrV[WordN].Val1);
45      WgtSumSF+=WWgtWStrPrV[WordN].Val1;
46      if ((MxKWords!=-1)&amp;&amp;(KWordSet-&gt;GetKWords()&gt;=MxKWords)){break;}
47      if ((WgtSum&gt;0)&amp;&amp;(WgtSumSF/WgtSum&gt;WgtSumPrc)){break;}
48    }
49    return KWordSet;
50  }
51  void TBowKWordSet::SaveTxt(const PSOut&amp; SOut) const {
52    SOut-&gt;PutStr(TStr::Fmt(&quot;&#x27;%s&#x27;:&quot;, GetNm().CStr()));
53    int KWords=GetKWords();
54    for (int KWordN=0; KWordN&lt;KWords; KWordN++){
55      TStr KWordStr=GetKWordStr(KWordN);
56      double KWordWgt=GetKWordWgt(KWordN);
57      SOut-&gt;PutStr(TStr::Fmt(&quot; [%s:%.5f]&quot;, KWordStr.CStr(), KWordWgt));
58    }
59  }
60  void TBowKWordSet::SaveXml(const PSOut&amp; SOut) const {
61    int KWords=GetKWords();
62    SOut-&gt;PutStr(TStr::Fmt(&quot;&lt;KeywordSet Nm=\&quot;%s\&quot;&gt;&quot;, TXmlLx::GetXmlStrFromPlainStr(GetNm()).CStr()));
63    for (int KWordN=0; KWordN&lt;KWords; KWordN++){
64      TStr KWordStr=GetKWordStr(KWordN);
65      TStr KWordXmlStr=TXmlLx::GetXmlStrFromPlainStr(KWordStr);
66      double KWordWgt=GetKWordWgt(KWordN);
67      SOut-&gt;PutStr(TStr::Fmt(&quot;&lt;Keyword Str=\&quot;%s\&quot; Wgt=\&quot;%g\&quot;/&gt;&quot;, KWordXmlStr.CStr(), KWordWgt));
68    }
69    SOut-&gt;PutStr(&quot;&lt;/KeywordSet&gt;&quot;);
70  }
71  void TBowKWordBs::SaveTxt(const PSOut&amp; SOut) const {
72    int KWordSets=GetKWordSets();
73    for (int KWordSetN=0; KWordSetN&lt;KWordSets; KWordSetN++){
74      PBowKWordSet KWordSet=GetKWordSet(KWordSetN);
75      KWordSet-&gt;SaveTxt(SOut);
76      SOut-&gt;PutLn();
77    }
78  }
79  void TBowKWordBs::SaveXml(const PSOut&amp; SOut) const {
80    SOut-&gt;PutStr(&quot;&lt;KeywordBase&gt;&quot;); SOut-&gt;PutLn();
81    int KWordSets=GetKWordSets();
82    for (int KWordSetN=0; KWordSetN&lt;KWordSets; KWordSetN++){
83      PBowKWordSet KWordSet=GetKWordSet(KWordSetN);
84      KWordSet-&gt;SaveXml(SOut);
85      SOut-&gt;PutLn();
86    }
87    SOut-&gt;PutStr(&quot;&lt;/KeywordBase&gt;&quot;);
88  }
89  TBowSpV::TBowSpV(const int&amp; _DId, const TFltV&amp; FullVec,
90          const double&amp; Eps): DId(_DId) {
91      double SqrSum = 0.0;
92      for (int EltN = 0; EltN &lt; FullVec.Len(); EltN++) {
93          const double EltVal = FullVec[EltN];
94          if (TFlt::Abs(EltVal) &gt; Eps) {
95              SqrSum += TMath::Sqr(EltVal);
96              WIdWgtKdV.Add(TIntSFltKd(EltN, (sdouble)EltVal));
97          }
98      }
99      Norm = sqrt(SqrSum);
100  }
101  TBowSpV::TBowSpV(const int&amp; DId, const TIntFltKdV&amp; SpV) {
102      double SqrSum = 0.0;
103      WIdWgtKdV.Gen(SpV.Len(), 0);
104      for (int WIdN = 0; WIdN &lt; SpV.Len(); WIdN++) {
105          WIdWgtKdV.Add(TIntSFltKd(SpV[WIdN].Key, sdouble(SpV[WIdN].Dat.Val)));
106      }
107      Norm = sqrt(SqrSum);
108  }
109  void TBowSpV::PutUnitNorm(){
110    int WIds=GetWIds();
111    double SqWgtSum=0;
112    for (int WIdN=0; WIdN&lt;WIds; WIdN++){
113      SqWgtSum+=TMath::Sqr(WIdWgtKdV[WIdN].Dat);
114    }
115    if (SqWgtSum&gt;0){
116      for (int WIdN=0; WIdN&lt;WIds; WIdN++){
117        WIdWgtKdV[WIdN].Dat=(sdouble)sqrt(TMath::Sqr(WIdWgtKdV[WIdN].Dat)/SqWgtSum);
118      }
119      Norm=1.0;
120    } else {
121      Norm=0.0;
122    }
123  }
124  double TBowSpV::GetNorm(){
125    if (double(Norm)==-1){
126      double SqWgtSum=0;
127      int WIds=GetWIds();
128      for (int WIdN=0; WIdN&lt;WIds; WIdN++){
129        SqWgtSum+=TMath::Sqr(WIdWgtKdV[WIdN].Dat);}
130      Norm=sqrt(SqWgtSum);
131    }
132    return Norm;
133  }
134  void TBowSpV::GetWordStrWgtPrV(const PBowDocBs&amp; BowDocBs,
135   const int&amp; TopWords, const double&amp; TopWordsWgtPrc,
136   TStrFltPrV&amp; WordStrWgtPrV) const {
137    int WIds=GetWIds(); double WordWgtSum=0;
138    TFltIntKdV WgtWIdKdV(WIds, 0);
139    for (int WIdN=0; WIdN&lt;WIds; WIdN++){
140      int WId; double Wgt; GetWIdWgt(WIdN, WId, Wgt);
141      WgtWIdKdV.Add(TFltIntKd(Wgt, WId));
142      WordWgtSum+=Wgt;
143    }
144    WgtWIdKdV.Sort(false);
145    WordStrWgtPrV.Clr();
146    double WordWgtSumSF=0;
147    {for (int WIdN=0; WIdN&lt;WIds; WIdN++){
148      if ((TopWords!=-1)&amp;&amp;(WIdN&gt;=TopWords)){break;}
149      if ((WordWgtSum&gt;0)&amp;&amp;(WordWgtSumSF/WordWgtSum&gt;TopWordsWgtPrc)){break;}
150      int WId=WgtWIdKdV[WIdN].Dat;
151      double WordWgt=WgtWIdKdV[WIdN].Key;
152      TStr WordStr;
153      if (BowDocBs.Empty()){WordStr=TInt::GetStr(WId);}
154      else {WordStr=BowDocBs-&gt;GetWordStr(WId);}
155      WordWgtSumSF+=WordWgt;
156      WordStrWgtPrV.Add(TStrFltPr(WordStr, WordWgt));
157    }}
158  }
159  PBowKWordSet TBowSpV::GetKWordSet(const PBowDocBs&amp; BowDocBs) const {
160    TStrFltPrV WordStrWgtPrV; GetWordStrWgtPrV(BowDocBs, -1, 1.0, WordStrWgtPrV);
161    PBowKWordSet KWordSet=TBowKWordSet::New();
162    for (int WordN=0; WordN&lt;WordStrWgtPrV.Len(); WordN++){
163      TStr WStr=WordStrWgtPrV[WordN].Val1;
164      double WWgt=WordStrWgtPrV[WordN].Val2;
165      KWordSet-&gt;AddKWord(WStr, WWgt);
166    }
167    return KWordSet;
168  }
169  void TBowSpV::GetIntFltKdV(TIntFltKdV&amp; SpV) const {
170      const int Wds = WIdWgtKdV.Len(); SpV.Gen(Wds, 0);
171      for (int WdN = 0; WdN &lt; Wds; WdN++) {
172          const TBowWIdWgtKd&amp; WIdWgt = WIdWgtKdV[WdN];
173          SpV.Add(TIntFltKd(WIdWgt.Key, WIdWgt.Dat.Val));
174      }
175  }
176  void TBowSpV::CutLowWgtWords(const double&amp; CutWordWgtSumPrc){
177    if (CutWordWgtSumPrc&lt;=0){return;}
178    int WIds=GetWIds();
179    double WgtSum=0; TFltV WgtV(WIds, 0);
180    for (int WIdN=0; WIdN&lt;WIds; WIdN++){
181      double Wgt=WIdWgtKdV[WIdN].Dat;
182      WgtSum+=Wgt; WgtV.Add(Wgt);
183    }
184    WgtV.Sort();
185    double CutWgtSum=CutWordWgtSumPrc*WgtSum;
186    double CutWgt=-1; int NonCutWgts=-1;
187    for (int WgtN=0; WgtN&lt;WIds; WgtN++){
188      CutWgtSum-=WgtV[WgtN];
189      if (CutWgtSum&lt;=0){
190        CutWgt=WgtV[WgtN]; NonCutWgts=WIds-WgtN; break;}
191    }
192    if (NonCutWgts!=-1){
193      TBowWIdWgtKdV NewWIdWgtKdV(NonCutWgts, 0);
194      for (int WIdN=0; WIdN&lt;WIds; WIdN++){
195        double Wgt=WIdWgtKdV[WIdN].Dat;
196        if (Wgt&gt;=CutWgt){
197          NewWIdWgtKdV.Add(WIdWgtKdV[WIdN]);
198        }
199      }
200      Norm=-1;
201      WIdWgtKdV.MoveFrom(NewWIdWgtKdV);
202    }
203  }
204  TStr TBowSpV::GetStr(const PBowDocBs&amp; BowDocBs,
205   const int&amp; TopWords, const double&amp; TopWordsWgtPrc, const TStr&amp; SepStr,
206   const bool&amp; ShowWeightsP, const bool&amp; KeepUndelineP) const {
207    TStrFltPrV WordStrWgtPrV;
208    GetWordStrWgtPrV(BowDocBs, TopWords, TopWordsWgtPrc, WordStrWgtPrV);
209    TChA ChA;
210    for (int WordN=0; WordN&lt;WordStrWgtPrV.Len(); WordN++){
211      TStr WordStr=WordStrWgtPrV[WordN].Val1;
212      if (!KeepUndelineP){
213        WordStr.ChangeChAll(&#x27;_&#x27;, &#x27; &#x27;);}
214      double WordWgt=WordStrWgtPrV[WordN].Val2;
215      if (!ShowWeightsP) WordStr.ToLc();
216      if (!ChA.Empty()){ChA+=SepStr;}
217      if (ShowWeightsP){ChA+=&#x27;[&#x27;;}
218      ChA+=WordStr;
219      if (ShowWeightsP) ChA+=TFlt::GetStr(WordWgt, &quot;:%g]&quot;);
220    }
221    return ChA;
222  }
223  void TBowSpV::SaveTxt(const PSOut&amp; SOut, const PBowDocBs&amp; BowDocBs,
224   const int&amp; TopWords, const double&amp; TopWordsWgtPrc, const char&amp; SepCh) const {
225    TChA SepStr; SepStr += SepCh; 
226    TStr Str=GetStr(BowDocBs, TopWords, TopWordsWgtPrc, SepStr);
227    SOut-&gt;PutStr(Str);
228    SOut-&gt;PutLn();
229  }
230  void TBowSpV::SaveXml(const PSOut&amp; SOut, const PBowDocBs&amp; BowDocBs) const {
231    int WIds=GetWIds();
232    TFltIntKdV WgtWIdKdV(WIds, 0);
233    for (int WIdN=0; WIdN&lt;WIds; WIdN++){
234      int WId; double Wgt; GetWIdWgt(WIdN, WId, Wgt);
235      WgtWIdKdV.Add(TFltIntKd(Wgt, WId));
236    }
237    WgtWIdKdV.Sort(false);
238    SOut-&gt;PutStr(&quot;&lt;SparseVec&gt;&quot;);
239    {for (int WIdN=0; WIdN&lt;WIds; WIdN++){
240      int WId=WgtWIdKdV[WIdN].Dat;
241      double Wgt=WgtWIdKdV[WIdN].Key;
242      TChA WordChA;
243      WordChA+=&quot;&lt;Word&quot;;
244      WordChA+=&quot; Id=\&quot;&quot;; WordChA+=TInt::GetStr(WId); WordChA+=&#x27;\&quot;&#x27;;
245      if (!BowDocBs.Empty()){
246        WordChA+=&quot; Str=\&quot;&quot;; WordChA+=BowDocBs-&gt;GetWordStr(WId); WordChA+=&#x27;\&quot;&#x27;;
247      }
248      WordChA+=&quot; Wgt=\&quot;&quot;; WordChA+=TFlt::GetStr(Wgt); WordChA+=&#x27;\&quot;&#x27;;
249      WordChA+=&quot;/&gt;&quot;;
250      SOut-&gt;PutStr(WordChA);
251    }}
252    SOut-&gt;PutStr(&quot;&lt;/SparseVec&gt;&quot;);
253  }
254  double TBowSimMtx::GetSim(const int&amp; DId1, const int&amp; DId2) const {
255    if ((DId1==-1)||(DId2==-1)){return 0;}
256    int MtxDId1=MtxDIdV[DId1]; int MtxDId2=MtxDIdV[DId2];
257    if (MtxDId1&gt;MtxDId2){TInt::Swap(MtxDId1, MtxDId2);}
258    TFlt Sim=0;
259    DIdPrToSimH.IsKeyGetDat(TIntPr(MtxDId1, MtxDId2), Sim);
260    return Sim;
261  }
262  PBowSimMtx TBowSimMtx::LoadTxt(const TStr&amp; FNm){
263    PBowSimMtx BowSimMtx=TBowSimMtx::New();
264    PSIn SIn=TFIn::New(FNm);
265    TIntH MtxDIdH;
266    TILx Lx(SIn, TFSet()|iloExcept);
267    while (Lx.GetSym(syLBracket, syEof)!=syEof){
268      int MtxDId1=Lx.GetInt(); Lx.GetSym(syColon);
269      int MtxDId2=Lx.GetInt(); Lx.GetSym(syEq);
270      double Sim=Lx.GetFlt(); Lx.GetSym(syRBracket);
271      if (MtxDId1&gt;MtxDId2){TInt::Swap(MtxDId1, MtxDId2);}
272      BowSimMtx-&gt;DIdPrToSimH.AddDat(TIntPr(MtxDId1, MtxDId2), Sim);
273      MtxDIdH.AddKey(MtxDId1); MtxDIdH.AddKey(MtxDId2);
274    }
275    int MtxDIds=MtxDIdH.Len();
276    BowSimMtx-&gt;MtxDIdV.Gen(MtxDIdH.Len(), 0);
277    for (int MtxDIdN=0; MtxDIdN&lt;MtxDIds; MtxDIdN++){
278      BowSimMtx-&gt;MtxDIdV.Add(MtxDIdH.GetKey(MtxDIdN));}
279    BowSimMtx-&gt;MtxDIdV.Sort();
280    return BowSimMtx;
281  }
282  double TBowSim::GetSim(const int&amp; DId1, const int&amp; DId2) const {
283    IAssert(SimType==bstMtx);
284    return SimMtx-&gt;GetSim(DId1, DId2);
285  }
286  double TBowSim::GetSim(const PBowSpV&amp; SpV1, const PBowSpV&amp; SpV2) const {
287    switch (SimType){
288      case bstBlock: return GetBlockSim(SpV1, SpV2);
289      case bstEucl: return GetEuclSim(SpV1, SpV2);
290      case bstCos: return GetCosSim(SpV1, SpV2);
291      case bstMtx: return SimMtx-&gt;GetSim(SpV1-&gt;GetDId(), SpV2-&gt;GetDId());
292      default: Fail; return 0;
293    }
294  }
295  double TBowSim::GetSim(const TBowSpVV&amp; SpVV1, const TBowSpVV&amp; SpVV2) const {
296    double Sim=0; int Sims=0;
297    PMom SimMom=TMom::New();
298    for (int SpVN1=0; SpVN1&lt;SpVV1.Len(); SpVN1++){
299      for (int SpVN2=0; SpVN2&lt;SpVV2.Len(); SpVN2++){
300        Sim+=GetSim(SpVV1[SpVN1], SpVV2[SpVN2]); Sims++;
301        SimMom-&gt;Add(GetSim(SpVV1[SpVN1], SpVV2[SpVN2]));
302      }
303    }
304    if (Sims&gt;0){Sim/=Sims;}
305    SimMom-&gt;Def();
306    Sim=SimMom-&gt;GetMn();
307    return Sim;
308  }
309  double TBowSim::GetBlockSim(const PBowSpV&amp; SpV1, const PBowSpV&amp; SpV2) {
310    double Sim=0;
311    int WIds1=SpV1-&gt;GetWIds();
312    int WIds2=SpV2-&gt;GetWIds();
313    int WIdN1=0; int WIdN2=0;
314    while ((WIdN1&lt;WIds1)&amp;&amp;(WIdN2&lt;WIds2)){
315      int WId1=SpV1-&gt;GetWId(WIdN1);
316      int WId2=-1;
317      forever {
318        if (WIdN2&gt;=WIds2){break;}
319        WId2=SpV2-&gt;GetWId(WIdN2);
320        if (WId2&gt;=WId1){break;}
321        WIdN2++;
322      }
323      if ((WIdN2&lt;WIds2)&amp;&amp;(WId1==WId2)){
324        double WordWgt1=SpV1-&gt;GetWgt(WIdN1); WIdN1++;
325        double WordWgt2=SpV2-&gt;GetWgt(WIdN2); WIdN2++;
326        if (WordWgt1==WordWgt2){Sim++;}
327      } else {
328        WIdN1++;
329      }
330    }
331    return Sim;
332  }
333  double TBowSim::GetEuclSim(const PBowSpV&amp; SpV1, const PBowSpV&amp; SpV2) {
334    int WIds1=SpV1-&gt;GetWIds();
335    int WIds2=SpV2-&gt;GetWIds();
336    double SqDifSum=0;
337    int WIdN1=0; int WIdN2=0;
338    while ((WIdN1&lt;WIds1)&amp;&amp;(WIdN2&lt;WIds2)){
339      int WId1=SpV1-&gt;GetWId(WIdN1);
340      int WId2=SpV2-&gt;GetWId(WIdN2);
341      if (WId1==WId2){
342        double WordWgt1=SpV1-&gt;GetWgt(WIdN1); WIdN1++;
343        double WordWgt2=SpV2-&gt;GetWgt(WIdN2); WIdN2++;
344        SqDifSum+=TMath::Sqr(WordWgt1-WordWgt2);
345      } else
346      if (WId1&lt;WId2){
347        double WordWgt1=SpV1-&gt;GetWgt(WIdN1); WIdN1++;
348        double WordWgt2=0;
349        SqDifSum+=TMath::Sqr(WordWgt1-WordWgt2);
350      } else {
351        double WordWgt1=0;
352        double WordWgt2=SpV2-&gt;GetWgt(WIdN2); WIdN2++;
353        SqDifSum+=TMath::Sqr(WordWgt1-WordWgt2);
354      }
355    }
356    for (int RestWIdN1=WIdN1; RestWIdN1&lt;WIds1; RestWIdN1++){
357      double WordWgt1=SpV1-&gt;GetWgt(RestWIdN1);
358      SqDifSum+=TMath::Sqr(WordWgt1);
359    }
360    for (int RestWIdN2=WIdN2; RestWIdN2&lt;WIds2; RestWIdN2++){
361      double WordWgt2=SpV2-&gt;GetWgt(RestWIdN2);
362      SqDifSum+=TMath::Sqr(WordWgt2);
363    }
364    double Sim=-sqrt(SqDifSum);
365    return Sim;
366  }
367  double TBowSim::GetCosSim(const PBowSpV&amp; SpV1, const PBowSpV&amp; SpV2) {
368    int WIds1=SpV1-&gt;GetWIds();
369    int WIds2=SpV2-&gt;GetWIds();
370    double WordWgtProdSum=0; int IntsWords=0;
371    int WIdN1=0; int WIdN2=0;
372    while ((WIdN1&lt;WIds1)&amp;&amp;(WIdN2&lt;WIds2)){
373      int WId1=SpV1-&gt;GetWId(WIdN1);
374      int WId2=-1;
375      forever {
376        if (WIdN2&gt;=WIds2){break;}
377        WId2=SpV2-&gt;GetWId(WIdN2);
378        if (WId2&gt;=WId1){break;}
379        WIdN2++;
380      }
381      if ((WIdN2&lt;WIds2)&amp;&amp;(WId1==WId2)){
382        double WordWgt1=SpV1-&gt;GetWgt(WIdN1); WIdN1++;
383        double WordWgt2=SpV2-&gt;GetWgt(WIdN2); WIdN2++;
384        double WordWgtProd=WordWgt1*WordWgt2;
385        WordWgtProdSum+=WordWgtProd; IntsWords++;
386      } else {
387        WIdN1++;
388      }
389    }
390    double Norm1=SpV1-&gt;GetNorm();
391    double Norm2=SpV2-&gt;GetNorm();
392    double Sim;
393    if (Norm1*Norm2==0){
394      Sim=0;
395    } else {
396      Sim=WordWgtProdSum/(Norm1*Norm2);
397    }
398    return Sim;
399  }
400  double TBowSim::GetCosSim(
401   const PBowSpV&amp; SpV1, const PBowSpV&amp; SpV2, TFltIntPrV&amp; WgtWIdPrV) {
402    int WIds1=SpV1-&gt;GetWIds();
403    int WIds2=SpV2-&gt;GetWIds();
404    double WordWgtProdSum=0; int IntsWords=0;
405    int WIdN1=0; int WIdN2=0; WgtWIdPrV.Clr();
406    while ((WIdN1&lt;WIds1)&amp;&amp;(WIdN2&lt;WIds2)){
407      int WId1=SpV1-&gt;GetWId(WIdN1);
408      int WId2=-1;
409      forever {
410        if (WIdN2&gt;=WIds2){break;}
411        WId2=SpV2-&gt;GetWId(WIdN2);
412        if (WId2&gt;=WId1){break;}
413        WIdN2++;
414      }
415      if ((WIdN2&lt;WIds2)&amp;&amp;(WId1==WId2)){
416        double WordWgt1=SpV1-&gt;GetWgt(WIdN1); WIdN1++;
417        double WordWgt2=SpV2-&gt;GetWgt(WIdN2); WIdN2++;
418        double WordWgtProd=WordWgt1*WordWgt2;
419        WordWgtProdSum+=WordWgtProd; IntsWords++;
420        WgtWIdPrV.Add(TFltIntPr(WordWgtProd, WId1));
421      } else {
422        WIdN1++;
423      }
424    }
425    double Norm1=SpV1-&gt;GetNorm();
426    double Norm2=SpV2-&gt;GetNorm();
427    double Sim;
428    if (Norm1*Norm2==0){
429      Sim=0;
430    } else {
431      Sim=WordWgtProdSum/(Norm1*Norm2);
432    }
433    return Sim;
434  }
435  TBowSimType TBowSim::GetSimType(const TStr&amp; Nm){
436    TStr UcNm=Nm.GetUc();
437    if (UcNm==&quot;UNDEF&quot;){return bstUndef;}
438    else if (UcNm==&quot;BLOCK&quot;){return bstBlock;}
439    else if (UcNm==&quot;EUCL&quot;){return bstEucl;}
440    else if (UcNm==&quot;COS&quot;){return bstCos;}
441    else if (UcNm==&quot;MTX&quot;){return bstMtx;}
442    else {return bstUndef;}
443  }
444  PBowDocWgtBs TBowDocWgtBs::New(
445   const PBowDocBs&amp; BowDocBs, const TBowWordWgtType&amp; _WordWgtType,
446   const double&amp; _CutWordWgtSumPrc, const int&amp; _MnWordFq,
447   const TIntV&amp; _DIdV, const TIntV&amp; _BaseDIdV, const PNotify&amp; Notify){
448    PBowDocWgtBs DocWgtBs=TBowDocWgtBs::New(BowDocBs-&gt;GetSig());
449    DocWgtBs-&gt;WordWgtType=_WordWgtType;
450    DocWgtBs-&gt;CutWordWgtSumPrc=_CutWordWgtSumPrc;
451    DocWgtBs-&gt;MnWordFq=_MnWordFq;
452    if (_DIdV.Empty()){BowDocBs-&gt;GetAllDIdV(DocWgtBs-&gt;DIdV);}
453    else {DocWgtBs-&gt;DIdV=_DIdV;}
454    int Docs=DocWgtBs-&gt;GetDocs();
455    int AllDocs=BowDocBs-&gt;GetDocs();
456    int AllWords=BowDocBs-&gt;GetWords();
457    if ((DocWgtBs-&gt;WordWgtType==bwwtEq)||(DocWgtBs-&gt;WordWgtType==bwwtNrmEq)){
458      DocWgtBs-&gt;WordFqV.Gen(AllWords);
459      DocWgtBs-&gt;DocSpVV.Gen(AllDocs);
460      for (int DIdN=0; DIdN&lt;Docs; DIdN++){
461        TNotify::OnNotify(Notify, ntInfo, TStr(&quot;Computing weights (&quot;)+TInt::GetStr(DIdN+1)+&quot;/&quot;+TInt::GetStr(Docs)+&quot;)...&quot;);
462        int DId=DocWgtBs-&gt;GetDId(DIdN);
463        int DocWIds=BowDocBs-&gt;GetDocWIds(DId);
464        DocWgtBs-&gt;DocSpVV[DId]=BowDocBs-&gt;GetDocSpV(DId);
465        for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
466          int DocWId; double DocWordFq;
467          BowDocBs-&gt;GetDocWIdFq(DId, DocWIdN, DocWId, DocWordFq);
468          DocWgtBs-&gt;WordFqV[DocWId]+=DocWordFq;
469        }
470        if (DocWgtBs-&gt;WordWgtType==bwwtNrmEq) {
471          DocWgtBs-&gt;DocSpVV[DId]-&gt;PutUnitNorm();
472        }
473      }
474    } else if ((DocWgtBs-&gt;WordWgtType==bwwtBin)||(DocWgtBs-&gt;WordWgtType==bwwtNrmBin)) {
475      DocWgtBs-&gt;WordFqV.Gen(AllWords);
476      DocWgtBs-&gt;DocSpVV.Gen(AllDocs);
477      for (int DIdN=0; DIdN&lt;Docs; DIdN++){
478        TNotify::OnNotify(Notify, ntInfo, TStr(&quot;Computing weights (&quot;)+TInt::GetStr(DIdN+1)+&quot;/&quot;+TInt::GetStr(Docs)+&quot;)...&quot;);
479        int DId=DocWgtBs-&gt;GetDId(DIdN);
480        int DocWIds=BowDocBs-&gt;GetDocWIds(DId);
481        DocWgtBs-&gt;DocSpVV[DId]=TBowSpV::New(DId, DocWIds);
482        for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
483          int DocWId; double DocWordFq;
484          BowDocBs-&gt;GetDocWIdFq(DId, DocWIdN, DocWId, DocWordFq);
485          DocWgtBs-&gt;WordFqV[DocWId]+=DocWordFq;
486          DocWgtBs-&gt;DocSpVV[DId]-&gt;AddWIdWgt(DocWId, 1.0);
487        }
488        if (DocWgtBs-&gt;WordWgtType==bwwtNrmBin) {
489          DocWgtBs-&gt;DocSpVV[DId]-&gt;PutUnitNorm();
490        }
491      }
492    } else if (DocWgtBs-&gt;WordWgtType==bwwtNrm01){
493      DocWgtBs-&gt;WordFqV.Gen(AllWords);
494      DocWgtBs-&gt;DocSpVV.Gen(AllDocs);
495      for (int DIdN=0; DIdN&lt;Docs; DIdN++){
496        TNotify::OnNotify(Notify, ntInfo, TStr(&quot;Computing weights (&quot;)+TInt::GetStr(DIdN+1)+&quot;/&quot;+TInt::GetStr(Docs)+&quot;)...&quot;);
497        int DId=DocWgtBs-&gt;GetDId(DIdN);
498        int DocWIds=BowDocBs-&gt;GetDocWIds(DId);
499        DocWgtBs-&gt;DocSpVV[DId]=TBowSpV::New(DId, DocWIds);
500        for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
501          int DocWId; double DocWordFq;
502          BowDocBs-&gt;GetDocWIdFq(DId, DocWIdN, DocWId, DocWordFq);
503          DocWgtBs-&gt;WordFqV[DocWId]+=DocWordFq;
504          double MnWIdFq=BowDocBs-&gt;GetWordMnVal(DocWId);
505          double MxWIdFq=BowDocBs-&gt;GetWordMxVal(DocWId);
506          if (MnWIdFq!=MxWIdFq){
507            double DocWordWgt=(DocWordFq-MnWIdFq)/(MxWIdFq-MnWIdFq);
508            DocWgtBs-&gt;DocSpVV[DId]-&gt;AddWIdWgt(DocWId, DocWordWgt);
509          }
510        }
511      }
512    } else if (
513     (DocWgtBs-&gt;WordWgtType==bwwtNrmTFIDF)||
514     (DocWgtBs-&gt;WordWgtType==bwwtLogDFNrmTFIDF)){
515      TIntV BaseDIdV;
516      if (_BaseDIdV.Empty()){BaseDIdV=DocWgtBs-&gt;DIdV;}
517      else {BaseDIdV=_BaseDIdV;}
518      int BaseDocs=BaseDIdV.Len();
519      int Words=BowDocBs-&gt;GetWords();
520      DocWgtBs-&gt;WordFqV.Gen(Words);
521      for (int DIdN=0; DIdN&lt;BaseDocs; DIdN++){
522        TNotify::OnNotify(Notify, ntInfo, TStr(&quot;Computing weights (&quot;)+TInt::GetStr(DIdN+1)+&quot;/&quot;+TInt::GetStr(BaseDocs)+&quot;)...&quot;);
523        int DId=BaseDIdV[DIdN];
524        int DocWIds=BowDocBs-&gt;GetDocWIds(DId);
525        for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
526          int DocWId; double DocWordFq;
527          BowDocBs-&gt;GetDocWIdFq(DId, DocWIdN, DocWId, DocWordFq);
528          DocWgtBs-&gt;WordFqV[DocWId]++;
529        }
530      }
531      TFltV WordIDFV(Words);
532      for (int WId=0; WId&lt;Words; WId++){
533        if (WId%100==0){
534          TNotify::OnNotify(Notify, ntInfo, TStr(&quot;Computing IDF values (&quot;)+TInt::GetStr(WId+1)+&quot;/&quot;+TInt::GetStr(Words)+&quot;)...&quot;);}
535        double WordDf=DocWgtBs-&gt;WordFqV[WId];
536        if (WordDf&gt;0){
537          WordIDFV[WId]=log(double(Docs)/WordDf);}
538      }
539      DocWgtBs-&gt;DocSpVV.Gen(AllDocs);
540      {for (int DIdN=0; DIdN&lt;Docs; DIdN++){
541        TNotify::OnNotify(Notify, ntInfo, TStr(&quot;Computing weights (&quot;)+TInt::GetStr(DIdN+1)+&quot;/&quot;+TInt::GetStr(BaseDocs)+&quot;)...&quot;);
542        int DId=DocWgtBs-&gt;GetDId(DIdN);
543        int DocWIds=BowDocBs-&gt;GetDocWIds(DId);
544        PBowSpV DocSpV=TBowSpV::New(DId, DocWIds);
545        DocWgtBs-&gt;DocSpVV[DId]=DocSpV;
546        for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
547          int DocWId; double DocWordFq;
548          BowDocBs-&gt;GetDocWIdFq(DId, DocWIdN, DocWId, DocWordFq);
549          TStr WordStr=BowDocBs-&gt;GetWordStr(DocWId); 
550          if (BowDocBs-&gt;GetWordFq(DocWId)&gt;=_MnWordFq){
551            double DocWordWgt=DocWordFq*WordIDFV[DocWId];
552            if (DocWgtBs-&gt;WordWgtType==bwwtLogDFNrmTFIDF){
553              double WordDf=DocWgtBs-&gt;WordFqV[DocWId];
554              DocWordWgt=log(1+WordDf)*DocWordWgt;
555            }
556            DocSpV-&gt;AddWIdWgt(DocWId, DocWordWgt);
557          }
558        }
559        DocSpV-&gt;CutLowWgtWords(_CutWordWgtSumPrc);
560        DocSpV-&gt;PutUnitNorm();
561      }}
562    } else if (DocWgtBs-&gt;WordWgtType==bwwtNrmTFICF){
563      TIntV BaseDIdV;
564      if (_BaseDIdV.Empty()){BaseDIdV=DocWgtBs-&gt;DIdV;}
565      else {BaseDIdV=_BaseDIdV;}
566      const int BaseDocs=BaseDIdV.Len();
567      const int Words=BowDocBs-&gt;GetWords();
568      TVec&lt;TIntH&gt; WordCIdHV(Words, 0);
569      for (int WId = 0; WId &lt; Words; WId++) { WordCIdHV.Add(TIntH()); }
570      for (int DIdN=0; DIdN&lt;BaseDocs; DIdN++){
571        const int DId=BaseDIdV[DIdN];
572        const int DocWIds=BowDocBs-&gt;GetDocWIds(DId);
573        const int DocCIds = BowDocBs-&gt;GetDocCIds(DId);
574        for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
575          int DocWId; double DocWordFq;
576          BowDocBs-&gt;GetDocWIdFq(DId, DocWIdN, DocWId, DocWordFq);
577          for (int DocCIdN = 0; DocCIdN &lt; DocCIds; DocCIdN++) {
578              const int DocCId = BowDocBs-&gt;GetDocCId(DId, DocCIdN);
579              if (!WordCIdHV[DocWId].IsKey(DocCId)) {
580                  WordCIdHV[DocWId].AddKey(DocCId);
581              }
582          }
583        }
584      }
585      const int Cats=BowDocBs-&gt;GetCats();
586      TFltV WordICFV(Words);
587      for (int WId=0; WId&lt;Words; WId++){
588        double WordCf=WordCIdHV[WId].Len();
589        if (WordCf&gt;0){
590          WordICFV[WId]=log(double(Cats)/WordCf);
591        } else {
592          WordICFV[WId]=0.0;
593        }
594      }
595      DocWgtBs-&gt;WordFqV.Gen(Words);
596      DocWgtBs-&gt;DocSpVV.Gen(AllDocs);
597      {for (int DIdN=0; DIdN&lt;Docs; DIdN++){
598        int DId=DocWgtBs-&gt;GetDId(DIdN);
599        int DocWIds=BowDocBs-&gt;GetDocWIds(DId);
600        PBowSpV DocSpV=TBowSpV::New(DId, DocWIds);
601        DocWgtBs-&gt;DocSpVV[DId]=DocSpV;
602        for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
603          int DocWId; double DocWordFq;
604          BowDocBs-&gt;GetDocWIdFq(DId, DocWIdN, DocWId, DocWordFq);
605          DocWgtBs-&gt;WordFqV[DocWId]+=DocWordFq;
606          TStr WordStr=BowDocBs-&gt;GetWordStr(DocWId); 
607          if (BowDocBs-&gt;GetWordFq(DocWId)&gt;=_MnWordFq){
608            double DocWordWgt=DocWordFq*WordICFV[DocWId];
609            DocSpV-&gt;AddWIdWgt(DocWId, DocWordWgt);
610          }
611        }
612        DocSpV-&gt;CutLowWgtWords(_CutWordWgtSumPrc);
613        DocSpV-&gt;PutUnitNorm();
614      }}
615    } else {
616      Fail;
617    }
618    return DocWgtBs;
619  }
620  PBowDocWgtBs TBowDocWgtBs::New(const TVec&lt;PBowSpV&gt;&amp; BowSpVV) {
621      PBowDocWgtBs DocWgtBs=TBowDocWgtBs::New(0);
622      DocWgtBs-&gt;WordWgtType=bwwtPreCalc;
623      DocWgtBs-&gt;CutWordWgtSumPrc=0.0;
624      DocWgtBs-&gt;MnWordFq=0;
625      int AllWords=0; DocWgtBs-&gt;DIdV.Gen(BowSpVV.Len(), 0);
626      for (int DocN = 0; DocN &lt; BowSpVV.Len(); DocN++) {
627          DocWgtBs-&gt;DIdV.Add(BowSpVV[DocN]-&gt;GetDId());
628          AllWords = TInt::GetMx(AllWords, BowSpVV[DocN]-&gt;GetLastWId());
629      }
630      DocWgtBs-&gt;WordFqV.Gen(AllWords); 
631      DocWgtBs-&gt;WordFqV.PutAll(0.0);
632      DocWgtBs-&gt;DocSpVV = BowSpVV;
633      return DocWgtBs;
634  }
635  PBowDocWgtBs TBowDocWgtBs::NewPreCalcWgt(const PBowDocBs&amp; BowDocBs,
636   const TFltV&amp; WordWgtV, const bool&amp; PutUniteNorm,
637   const double&amp; _CutWordWgtSumPrc, const int&amp; _MnWordFq,
638   const TIntV&amp; _DIdV) {
639      PBowDocWgtBs DocWgtBs=TBowDocWgtBs::New(BowDocBs-&gt;GetSig());
640      DocWgtBs-&gt;WordWgtType=bwwtPreCalc;
641      DocWgtBs-&gt;CutWordWgtSumPrc=_CutWordWgtSumPrc;
642      DocWgtBs-&gt;MnWordFq=_MnWordFq;
643      if (_DIdV.Empty()){BowDocBs-&gt;GetAllDIdV(DocWgtBs-&gt;DIdV);}
644      else {DocWgtBs-&gt;DIdV=_DIdV;}
645      int Docs=DocWgtBs-&gt;GetDocs();
646      int AllDocs=BowDocBs-&gt;GetDocs();
647      int AllWords=BowDocBs-&gt;GetWords();
648      EAssert(AllWords == WordWgtV.Len());
649      DocWgtBs-&gt;WordFqV.Gen(AllWords);
650      DocWgtBs-&gt;DocSpVV.Gen(AllDocs);
651      for (int DIdN=0; DIdN&lt;Docs; DIdN++) {
652          int DId=DocWgtBs-&gt;GetDId(DIdN);
653          int DocWIds=BowDocBs-&gt;GetDocWIds(DId);
654          PBowSpV DocSpV=TBowSpV::New(DId, DocWIds);
655          DocWgtBs-&gt;DocSpVV[DId]=DocSpV;
656          for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
657              int DocWId; double DocWordFq;
658              BowDocBs-&gt;GetDocWIdFq(DId, DocWIdN, DocWId, DocWordFq);
659              TStr WordStr=BowDocBs-&gt;GetWordStr(DocWId); 
660              if (BowDocBs-&gt;GetWordFq(DocWId)&gt;=_MnWordFq){
661                  DocSpV-&gt;AddWIdWgt(DocWId, DocWordFq*WordWgtV[DocWId]);
662              }
663              DocWgtBs-&gt;WordFqV[DocWId] += DocWordFq;
664          }
665          DocSpV-&gt;CutLowWgtWords(_CutWordWgtSumPrc);
666          if (PutUniteNorm) { DocSpV-&gt;PutUnitNorm(); }
667      }
668      return DocWgtBs;
669  }
670  PBowDocWgtBs TBowDocWgtBs::NewSvmWgt(
671     const PBowDocBs&amp; BowDocBs,
672     const PBowDocWgtBs&amp; BowDocWgtBs,
673     const TIntV&amp; _TrainDIdV,
674     const double&amp; SvmCostParam,
675     const int&amp; MxTimePerCat,
676     const bool&amp; NegFeaturesP,
677     const TIntV&amp; _DIdV,
678     const bool&amp; PutUniteNormP,
679     const double&amp; _CutWordWgtSumPrc,
680     const int&amp; _MnWordFq) {
681      PBowDocWgtBs DocWgtBs=TBowDocWgtBs::New(BowDocBs-&gt;GetSig());
682      DocWgtBs-&gt;WordWgtType=bwwtSvm;
683      DocWgtBs-&gt;CutWordWgtSumPrc=_CutWordWgtSumPrc;
684      DocWgtBs-&gt;MnWordFq=_MnWordFq;
685      if (_DIdV.Empty()){BowDocBs-&gt;GetAllDIdV(DocWgtBs-&gt;DIdV);}
686      else {DocWgtBs-&gt;DIdV=_DIdV;}
687      const int Docs=DocWgtBs-&gt;DIdV.Len();
688      const int AllDocs=BowDocBs-&gt;GetDocs();
689      const int AllWords=BowDocBs-&gt;GetWords();
690      EAssert(BowDocBs-&gt;IsCats());
691      const int Cats = BowDocBs-&gt;GetCats();
692      TIntV TrainDIdV;
693      if (_TrainDIdV.Empty()){
694          TrainDIdV.Gen(BowDocWgtBs-&gt;GetDocs(), 0);
695          for (int DIdN = 0; DIdN &lt; BowDocWgtBs-&gt;GetDocs(); DIdN++) {
696              TrainDIdV.Add(BowDocWgtBs-&gt;GetDId(DIdN));
697          }
698      } else { TrainDIdV = TrainDIdV; }
699      TVec&lt;TFltV&gt; CatWgtVV(Cats);
700      for (int CId = 0; CId &lt; Cats; CId++) {
701          printf(&quot;Cat %d/%d\r&quot;, CId+1, Cats);
702          PSVMTrainSet CatTrainSet = TBowDocBs2TrainSet::NewBowAllCat(
703              BowDocBs, BowDocWgtBs, CId, TrainDIdV);
704          TIntFltKdV PPCatWIdWgtV, NNCatWIdWgtV;
705          if (CatTrainSet-&gt;HasPosNegVecs(5)) {
706              const double SvmUnbalanceParam = 5.0;
707              PSVMModel CatSvmModel = TSVMModel::NewClsLinear(
708                  CatTrainSet, SvmCostParam, SvmUnbalanceParam,
709                  TIntV(), TSVMLearnParam::Lin(MxTimePerCat));
710              TFltV NormalV; CatSvmModel-&gt;GetWgtV(NormalV);
711              CatTrainSet-&gt;GetKeywords(NormalV, PPCatWIdWgtV, TIntV(), -1, 1.0, 1.0, true);
712              CatTrainSet-&gt;GetKeywords(NormalV, NNCatWIdWgtV, TIntV(), -1, -1.0, -1.0, true);
713              TLinAlg::NormalizeLinf(PPCatWIdWgtV); TLinAlg::NormalizeLinf(NNCatWIdWgtV);
714          }
715          TFltV&amp; CatWgtV = CatWgtVV[CId];
716          CatWgtV.Gen(AllWords); CatWgtV.PutAll(0.0);
717          for (int WdN = 0; WdN &lt; PPCatWIdWgtV.Len(); WdN++) {
718              const int CatWId = PPCatWIdWgtV[WdN].Key;
719              const double CatWordWgt = pow(2*PPCatWIdWgtV[WdN].Dat+1.0, 1.0/4.0);
720              CatWgtV[CatWId] += CatWordWgt;
721          }
722          if (NegFeaturesP) {
723              for (int WdN = 0; WdN &lt; NNCatWIdWgtV.Len(); WdN++) {
724                  const int CatWId = NNCatWIdWgtV[WdN].Key;
725                  const double CatWordWgt = pow(2*NNCatWIdWgtV[WdN].Dat+1.0, 1.0/4.0);
726                  CatWgtV[CatWId] += CatWordWgt;
727              }
728          }
729          TLinAlg::Normalize(CatWgtV);
730      }
731      printf(&quot;\n&quot;);
732      DocWgtBs-&gt;WordFqV.Gen(AllWords);
733      DocWgtBs-&gt;DocSpVV.Gen(AllDocs);
734      for (int DIdN=0; DIdN&lt;Docs; DIdN++) {
735          printf(&quot;Doc %d/%d\r&quot;, DIdN+1, Docs);
736          const int DId=DocWgtBs-&gt;GetDId(DIdN);
737          const int DocWIds=BowDocBs-&gt;GetDocWIds(DId);
738          PBowSpV DocSpV=TBowSpV::New(DId, DocWIds);
739          DocWgtBs-&gt;DocSpVV[DId]=DocSpV;
740          const int DocCIds = BowDocBs-&gt;GetDocCIds(DId);
741          for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
742              int DocWId; double DocWordFq;
743              BowDocBs-&gt;GetDocWIdFq(DId, DocWIdN, DocWId, DocWordFq);
744              TStr WordStr=BowDocBs-&gt;GetWordStr(DocWId); 
745              if (BowDocBs-&gt;GetWordFq(DocWId)&gt;=_MnWordFq){
746                  double WordWgt = 0.0;
747                  for (int DocCatN = 0; DocCatN &lt; DocCIds; DocCatN++) {
748                      const int DocCatId = BowDocBs-&gt;GetDocCId(DId, DocCatN);
749                      WordWgt += CatWgtVV[DocCatId][DocWId];
750                  }
751                  DocSpV-&gt;AddWIdWgt(DocWId, DocWordFq*WordWgt);
752              }
753              DocWgtBs-&gt;WordFqV[DocWId] += DocWordFq;
754          }
755          DocSpV-&gt;CutLowWgtWords(_CutWordWgtSumPrc);
756          if (PutUniteNormP) { DocSpV-&gt;PutUnitNorm(); }
757      }
758      printf(&quot;\n&quot;);
759      return DocWgtBs;
760  }
761  PBowDocWgtBs TBowDocWgtBs::NewBinSvmWgt(
762     const PBowDocBs&amp; BowDocBs,
763     const PBowDocWgtBs&amp; BowDocWgtBs,
764     const TStr&amp; CatNm,
765     const TIntV&amp; TrainDIdV,
766     const double&amp; SvmCostParam,
767     const double&amp; SvmUnbalanceParam,
768     const double&amp; MnWgt,
769     const bool&amp; NegFeaturesP,
770     const bool&amp; PutUniteNormP,
771     const bool&amp; AvgNormalP,
772     const TIntV&amp; _DIdV,
773     const double&amp; _CutWordWgtSumPrc,
774     const int&amp; _MnWordFq) {
775      PBowDocWgtBs DocWgtBs=TBowDocWgtBs::New(BowDocBs-&gt;GetSig());
776      DocWgtBs-&gt;WordWgtType=bwwtSvm;
777      DocWgtBs-&gt;CutWordWgtSumPrc=_CutWordWgtSumPrc;
778      DocWgtBs-&gt;MnWordFq=_MnWordFq;
779      if (_DIdV.Empty()){BowDocBs-&gt;GetAllDIdV(DocWgtBs-&gt;DIdV);}
780      else {DocWgtBs-&gt;DIdV=_DIdV;}
781      const int Docs=DocWgtBs-&gt;DIdV.Len();
782      const int AllDocs=BowDocBs-&gt;GetDocs();
783      const int AllWords=BowDocBs-&gt;GetWords();
784      EAssert(BowDocBs-&gt;IsCatNm(CatNm));
785      const int CId = BowDocBs-&gt;GetCId(CatNm);
786      PSVMTrainSet CatTrainSet = TBowDocBs2TrainSet::NewBowAllCat(
787          BowDocBs, BowDocWgtBs, CId, TrainDIdV);
788      TIntFltKdV PPCatWIdWgtV, NNCatWIdWgtV;
789      EAssert(CatTrainSet-&gt;HasPosNegVecs(5));
790      PSVMModel CatSvmModel = TSVMModel::NewClsLinear(
791          CatTrainSet, SvmCostParam, SvmUnbalanceParam);
792      TFltV NormalV; CatSvmModel-&gt;GetWgtV(NormalV);
793      CatTrainSet-&gt;GetKeywords(NormalV, PPCatWIdWgtV, TIntV(), -1, 1.0, 1.0, AvgNormalP);
794      CatTrainSet-&gt;GetKeywords(NormalV, NNCatWIdWgtV, TIntV(), -1, -1.0, -1.0, AvgNormalP);
795      TLinAlg::NormalizeLinf(PPCatWIdWgtV); TLinAlg::NormalizeLinf(NNCatWIdWgtV);
796      TFltV CatWgtV; CatWgtV.Gen(AllWords); CatWgtV.PutAll(MnWgt);
797      for (int WdN = 0; WdN &lt; PPCatWIdWgtV.Len(); WdN++) {
798          const int CatWId = PPCatWIdWgtV[WdN].Key;
799          const double CatWordWgt = pow(2*PPCatWIdWgtV[WdN].Dat+1.0, 1.0/4.0);
800          CatWgtV[CatWId] += CatWordWgt;
801      }
802      if (NegFeaturesP) {
803          for (int WdN = 0; WdN &lt; NNCatWIdWgtV.Len(); WdN++) {
804              const int CatWId = NNCatWIdWgtV[WdN].Key;
805              const double CatWordWgt = pow(2*NNCatWIdWgtV[WdN].Dat+1.0, 1.0/4.0);
806              CatWgtV[CatWId] += CatWordWgt;
807          }
808      }
809      DocWgtBs-&gt;WordFqV.Gen(AllWords);
810      DocWgtBs-&gt;DocSpVV.Gen(AllDocs);
811      for (int DIdN=0; DIdN&lt;Docs; DIdN++) {
812          const int DId=DocWgtBs-&gt;GetDId(DIdN);
813          const int DocWIds=BowDocBs-&gt;GetDocWIds(DId);
814          PBowSpV DocSpV=TBowSpV::New(DId, DocWIds);
815          DocWgtBs-&gt;DocSpVV[DId]=DocSpV;
816          for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
817              int DocWId; double DocWordFq;
818              BowDocBs-&gt;GetDocWIdFq(DId, DocWIdN, DocWId, DocWordFq);
819              TStr WordStr=BowDocBs-&gt;GetWordStr(DocWId); 
820              const double WordWgt = CatWgtV[DocWId];
821              DocSpV-&gt;AddWIdWgt(DocWId, DocWordFq*WordWgt);
822              DocWgtBs-&gt;WordFqV[DocWId] += DocWordFq;
823          }
824          DocSpV-&gt;CutLowWgtWords(_CutWordWgtSumPrc);
825          if (PutUniteNormP) { DocSpV-&gt;PutUnitNorm(); }
826      }
827      return DocWgtBs;
828  }
829  TBowWordWgtType TBowDocWgtBs::GetWordWgtTypeFromStr(const TStr&amp; Nm){
830    TStr UcNm=Nm.GetUc();
831    if (UcNm==&quot;UNDEF&quot;){return bwwtUndef;}
832    else if (UcNm==&quot;EQ&quot;){return bwwtEq;}
833    else if (UcNm==&quot;NRMEQ&quot;){return bwwtNrmEq;}
834    else if (UcNm==&quot;BIN&quot;){return bwwtNrmBin;}
835    else if (UcNm==&quot;NRM01&quot;){return bwwtNrm01;}
836    else if (UcNm==&quot;NRMTFIDF&quot;){return bwwtNrmTFIDF;}
837    else if (UcNm==&quot;LOGDFNRMTFIDF&quot;){return bwwtLogDFNrmTFIDF;}
838    else if (UcNm==&quot;NRMTFICF&quot;){return bwwtNrmTFICF;}
839    else if (UcNm==&quot;PRECALC&quot;){return bwwtPreCalc;}
840    else if (UcNm==&quot;SVM&quot;){return bwwtSvm;}
841    else {return bwwtUndef;}
842  }
843  void TBowDocWgtBs::GetSimDIdV(
844   const PBowSpV&amp; RefBowSpV, const PBowSim&amp; BowSim,
845   TFltIntKdV&amp; SimDIdKdV, const bool&amp; RefBowSpVInclude) const {
846    int Docs=GetDocs();
847    SimDIdKdV.Gen(Docs, 0);
848    for (int DIdN=0; DIdN&lt;Docs; DIdN++){
849      int DId=GetDId(DIdN);
850      PBowSpV DocBowSpV=GetSpV(DId);
851      if ((RefBowSpVInclude)||(!RefBowSpV-&gt;IsDId())||(RefBowSpV-&gt;GetDId()!=DocBowSpV-&gt;GetDId())){
852        double Sim=BowSim-&gt;GetSim(RefBowSpV, DocBowSpV);
853        SimDIdKdV.Add(TFltIntKd(Sim, DId));
854      }
855    }
856    SimDIdKdV.Sort(false);
857  }
858  void TBowDocWgtBs::SaveTxtSimDIdV(
859   const PSOut&amp; SOut, const PBowDocBs&amp; BowDocBs,
860   const PBowSpV&amp; RefBowSpV, const TFltIntKdV&amp; SimDIdKdV,
861   const int&amp; TopHits, const double&amp; MnSim, const int&amp; TopDocWords,
862   const char&amp; SepCh) const {
863    SOut-&gt;PutStr(&quot;Query Document:\n&quot;);
864    if (RefBowSpV-&gt;IsDId()){
865      int RefDId=RefBowSpV-&gt;GetDId();
866      TStr RefDocNm=BowDocBs-&gt;GetDocNm(RefDId);
867      SOut-&gt;PutStr(RefDocNm, &quot;   Document &#x27;%s&#x27;&quot;);
868      SOut-&gt;PutLn();
869    }
870    RefBowSpV-&gt;SaveTxt(SOut, BowDocBs, TopDocWords, SepCh);
871    SOut-&gt;PutLn();
872    int OutDocs=TopHits;
873    if ((OutDocs==-1)||(OutDocs&gt;=SimDIdKdV.Len())){OutDocs=SimDIdKdV.Len();}
874    for (int OutDocN=0; OutDocN&lt;OutDocs; OutDocN++){
875      double Sim=SimDIdKdV[OutDocN].Key;
876      int DId=SimDIdKdV[OutDocN].Dat;
877      TStr DocNm=BowDocBs-&gt;GetDocNm(DId);
878      PBowSpV DocSpV=GetSpV(DId);
879      if (Sim&lt;MnSim){break;}
880      SOut-&gt;PutInt(OutDocN+1, &quot;%d.&quot;);
881      SOut-&gt;PutStr(DocNm, &quot;   Document &#x27;%s&#x27;&quot;);
882      SOut-&gt;PutFlt(Sim, &quot;   Similarity: %g&quot;);
883      SOut-&gt;PutLn();
884      DocSpV-&gt;SaveTxt(SOut, BowDocBs, TopDocWords, SepCh);
885      SOut-&gt;PutLn();
886    }
887  }
888  void TBowDocWgtBs::SaveXmlSimDIdV(
889   const PSOut&amp; SOut, const PBowDocBs&amp; BowDocBs,
890   const PBowSpV&amp; RefBowSpV, const TFltIntKdV&amp; SimDIdKdV,
891   const int&amp; TopHits, const double&amp; MnSim) const {
892    SOut-&gt;PutStr(&quot;&lt;SimilaritySearchResults&gt;&quot;);
893    SOut-&gt;PutStr(&quot;&lt;QueryDocument&quot;);
894    if (RefBowSpV-&gt;IsDId()){
895      int RefDId=RefBowSpV-&gt;GetDId();
896      TStr RefDocNm=BowDocBs-&gt;GetDocNm(RefDId);
897      SOut-&gt;PutStr(TInt::GetStr(RefDId, &quot;  DocId=\&quot;%d\&quot;&quot;));
898      SOut-&gt;PutStr(TStr::GetStr(RefDocNm, &quot;  DocNm=\&quot;%s\&quot;&quot;));
899    }
900    SOut-&gt;PutStr(&quot;&gt;&quot;); SOut-&gt;PutLn();
901    RefBowSpV-&gt;SaveXml(SOut, BowDocBs);
902    SOut-&gt;PutStr(&quot;&lt;/QueryDocument&gt;&quot;); SOut-&gt;PutLn();
903    int OutDocs=TopHits;
904    if ((OutDocs==-1)||(OutDocs&gt;=SimDIdKdV.Len())){OutDocs=SimDIdKdV.Len();}
905    for (int OutDocN=0; OutDocN&lt;OutDocs; OutDocN++){
<span onclick='openModal()' class='match'>906      double Sim=SimDIdKdV[OutDocN].Key;
907      int DId=SimDIdKdV[OutDocN].Dat;
908      TStr DocNm=BowDocBs-&gt;GetDocNm(DId);
</span>909      PBowSpV DocSpV=GetSpV(DId);
910      if (Sim&lt;MnSim){break;}
911      SOut-&gt;PutStr(&quot;&lt;Hit&quot;);
912      SOut-&gt;PutStr(TInt::GetStr(OutDocN+1, &quot; Num=\&quot;%d\&quot;&quot;));
913      SOut-&gt;PutStr(TInt::GetStr(DId, &quot;  DocId=\&quot;%d\&quot;&quot;));
914      SOut-&gt;PutStr(TStr::GetStr(DocNm, &quot;  DocNm=\&quot;%s\&quot;&quot;));
915      SOut-&gt;PutStr(TFlt::GetStr(Sim, &quot;  Sim=\&quot;%g\&quot;&quot;));
916      SOut-&gt;PutStr(&quot;&gt;&quot;); SOut-&gt;PutLn();
917      DocSpV-&gt;SaveXml(SOut, BowDocBs);
918      SOut-&gt;PutStr(&quot;&lt;/Hit&gt;&quot;); SOut-&gt;PutLn();
919    }
920    SOut-&gt;PutStr(&quot;&lt;/SimilaritySearchResults&gt;&quot;);
921  }
922  void TBowDocWgtBs::SaveTxtStat(
923   const TStr&amp; StatFNm, const PBowDocBs&amp; BowDocBs,
924   const bool&amp; SaveWordsP, const bool&amp; SaveCatsP, const bool&amp; SaveDocsP) const {
925    TFOut StatSOut(StatFNm); FILE* fStat=StatSOut.GetFileId();
926    if (SaveWordsP){
927      int DIds=GetDocs();
928      int WIds=GetWords();
929      TIntIntFltPrH WIdToWFqWWgtPrH(WIds);
930      for (int DIdN=0; DIdN&lt;DIds; DIdN++){
931        int DId=GetDId(DIdN);
932        PBowSpV DocSpV=GetSpV(DId);
933        int DocWIds=DocSpV-&gt;GetWIds();
934        for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
935          int DocWId; double DocWgt;
936          DocSpV-&gt;GetWIdWgt(DocWIdN, DocWId, DocWgt);
937          TIntFltPr&amp; WFqWWgtPr=WIdToWFqWWgtPrH.AddDat(DocWId);
938          WFqWWgtPr.Val1++; WFqWWgtPr.Val2+=DocWgt;
939        }
940      }
941      TFltIntPrV AvgWWgtWIdPrV(WIdToWFqWWgtPrH.Len(), 0);
942      for (int WIdN=0; WIdN&lt;WIdToWFqWWgtPrH.Len(); WIdN++){
943        int WId=WIdToWFqWWgtPrH.GetKey(WIdN);
944        TIntFltPr&amp; WFqWWgtPr=WIdToWFqWWgtPrH.AddDat(WId);
945        double AvgWWgt=0;
946        if (WFqWWgtPr.Val1&gt;0){AvgWWgt=WFqWWgtPr.Val2/WFqWWgtPr.Val1;}
947        AvgWWgtWIdPrV.Add(TFltIntPr(AvgWWgt, WId));
948      }
949      AvgWWgtWIdPrV.Sort(false);
950      fprintf(fStat, &quot;\nRank Word-Weight Document-Frequency Word-String\n\n&quot;);
951      {for (int WIdN=0; WIdN&lt;AvgWWgtWIdPrV.Len(); WIdN++){
952        double AvgWWgt=AvgWWgtWIdPrV[WIdN].Val1;
953        int WId=AvgWWgtWIdPrV[WIdN].Val2;
954        TStr WordStr=BowDocBs-&gt;GetWordStr(AvgWWgtWIdPrV[WIdN].Val2);
955        double WordDFq=GetWordFq(WId);
956        fprintf(fStat, &quot;%d.\t%.3f\t%g\t&#x27;%s&#x27;\n&quot;,
957         1+WIdN, AvgWWgt, WordDFq, WordStr.CStr());
958      }}
959    }
960    if (SaveCatsP){}
961    if (SaveDocsP){
962      fprintf(fStat, &quot;\n\nDocument-Statistics\n\n&quot;);
963      int Docs=GetDocs();
964      for (int DIdN=0; DIdN&lt;Docs; DIdN++){
965        int DId=GetDId(DIdN);
966        TStr DocNm=BowDocBs-&gt;GetDocNm(DId);
967        PBowSpV DocSpV=GetSpV(DId);
968        int DocWIds=DocSpV-&gt;GetWIds();
969        fprintf(fStat, &quot;DId:%d   Name:&#x27;%s&#x27; (%d Words):&quot;, DId, DocNm.CStr(), DocWIds);
970        for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
971          int DocWId; double DocWgt;
972          DocSpV-&gt;GetWIdWgt(DocWIdN, DocWId, DocWgt);
973          TStr WordStr=BowDocBs-&gt;GetWordStr(DocWId);
974          fprintf(fStat, &quot; &#x27;%s&#x27;:%.3f&quot;, WordStr.CStr(), DocWgt);
975        }
976        fprintf(fStat, &quot;\n&quot;);
977      }
978    }
979  }
980  const TStr TBowDocWgtBs::BowDocWgtBsFExt=&quot;.Boww&quot;;
981  PBowDocBs TBowDocBs::New(
982   const PSwSet&amp; SwSet, const PStemmer&amp; Stemmer, const PNGramBs&amp; NGramBs){
983    PBowDocBs BowDocBs=New();
984    if (NGramBs.Empty()){
985      BowDocBs-&gt;PutSwSet(SwSet); BowDocBs-&gt;PutStemmer(Stemmer);
986    } else {
987      BowDocBs-&gt;PutNGramBs(NGramBs);
988    }
989    return BowDocBs;
990  }
991  void TBowDocBs::AddDocs(const PBowDocBs&amp; BowDocBs)
992  {
993    for (int WordN = 0; WordN &lt; BowDocBs-&gt;GetWords(); WordN++)
994    {
995      TStr WordStr = BowDocBs-&gt;GetWordStr(WordN);
996      int WordId = -1;
997      if (!this-&gt;IsWordStr(WordStr, WordId))
998      {
999        this-&gt;AddWordStr(WordStr);
1000      }
1001    }
1002    for (int DocId = 0; DocId &lt; BowDocBs-&gt;GetDocs(); DocId++)
1003    {
1004      TIntFltPrV NewDoc;
1005      for (int WIdN = 0; WIdN &lt; BowDocBs-&gt;GetDocWIds(DocId); WIdN++)
1006      {
1007        int WId = BowDocBs-&gt;GetDocWId(DocId, WIdN);
1008        double WFq = BowDocBs-&gt;GetDocWFq(DocId, WIdN);
1009        TStr WordStr = BowDocBs-&gt;GetWordStr(WId);
1010        int WIdCmn = this-&gt;GetWId(WordStr);
1011        NewDoc.Add(TIntFltPr(WIdCmn, WFq));
1012      }
1013      this-&gt;AddDoc(&quot;&quot;, TStrV(), NewDoc);
1014    }
1015  }
1016  void TBowDocBs::AssertOk() const {
1017    int Docs=GetDocs();
1018    for (int DId=0; DId&lt;Docs; DId++){
1019      PBowSpV DocSpV=GetDocSpV(DId);
1020      IAssert(DId==DocSpV-&gt;GetDId());
1021      TStr DocNm=GetDocNm(DId);
1022      for (int WIdN=0; WIdN&lt;DocSpV-&gt;GetWIds(); WIdN++){
1023        int WId; double Wgt; DocSpV-&gt;GetWIdWgt(WIdN, WId, Wgt);
1024        TStr WordStr=GetWordStr(WId);
1025      }
1026      int CIds=GetDocCIds(DId);
1027      for (int CIdN=0; CIdN&lt;CIds; CIdN++){
1028        int CId=GetDocCId(DId, CIdN);
1029        TStr CatNm=GetCatNm(CId);
1030      }
1031    }
1032    int TrainDocs=GetTrainDocs();
1033    for (int TrainDIdN=0; TrainDIdN&lt;TrainDocs; TrainDIdN++){
1034      int TrainDId=GetTrainDId(TrainDIdN);
1035      PBowSpV TrainDocSpV=GetDocSpV(TrainDId);
1036    }
1037    int TestDocs=GetTestDocs();
1038    for (int TestDIdN=0; TestDIdN&lt;TestDocs; TestDIdN++){
1039      int TestDId=GetTestDId(TestDIdN);
1040      PBowSpV TestDocSpV=GetDocSpV(TestDId);
1041    }
1042  }
1043  void TBowDocBs::GetWordStrVFromHtml(const TStr&amp; HtmlStr, TStrV&amp; WordStrV) const {
1044    WordStrV.Clr();
1045    if (!NGramBs.Empty()){
1046      NGramBs-&gt;GetNGramStrV(HtmlStr, WordStrV);
1047    } else {
1048      PSIn HtmlSIn=TStrIn::New(HtmlStr);
1049      THtmlLx HtmlLx(HtmlSIn);
1050      while (HtmlLx.Sym!=hsyEof){
1051        if (HtmlLx.Sym==hsyStr){
1052          TStr WordStr=HtmlLx.UcChA;
1053          if ((SwSet.Empty())||(!SwSet-&gt;IsIn(WordStr))){
1054            if (!Stemmer.Empty()){
1055              WordStr=Stemmer-&gt;GetStem(WordStr);}
1056            WordStrV.Add(WordStr);
1057          }
1058        }
1059        HtmlLx.GetSym();
1060      }
1061    }
1062  }
1063  int TBowDocBs::AddDoc(const TStr&amp; _DocNm,
1064   const TStrV&amp; CatNmV, const TIntFltPrV&amp; WIdWgtPrV){
1065    TStr DocNm=_DocNm;
1066    if (DocNm.Empty()){DocNm=TInt::GetStr(GetDocs());}
1067    int DId=-1;
1068    if (!DocNmToDescStrH.IsKey(DocNm, DId)){
1069      DId=DocNmToDescStrH.AddKey(DocNm);
1070      DocSpVV.Add(TBowSpV::New(DId)); IAssert(DId==DocSpVV.Len()-1);
1071      DocStrV.Add();
1072      DocCIdVV.Add(); IAssert(DId==DocCIdVV.Len()-1);
1073    }
1074    TIntV&amp; DocCIdV=DocCIdVV[DId];
1075    DocCIdV.Gen(CatNmV.Len(), 0);
1076    for (int CatNmN=0; CatNmN&lt;CatNmV.Len(); CatNmN++){
1077      int CId=CatNmToFqH.AddKey(CatNmV[CatNmN]);
1078      CatNmToFqH[CId]++; DocCIdV.Add(CId);
1079    }
1080    DocCIdV.Sort();
1081    TIntFltH DocWIdToWgtH;
1082    for (int WordN=0; WordN&lt;WIdWgtPrV.Len(); WordN++){
1083      int WId=WIdWgtPrV[WordN].Val1;
1084      IAssert(IsWId(WId));
1085      DocWIdToWgtH.AddDat(WId, WIdWgtPrV[WordN].Val2);
1086    }
1087    PBowSpV DocSpV=DocSpVV[DId];
1088    DocSpV-&gt;GenMx(DocWIdToWgtH.Len());
1089    for (int DocWordN=0; DocWordN&lt;DocWIdToWgtH.Len(); DocWordN++){
1090      int WId=DocWIdToWgtH.GetKey(DocWordN);
1091      double Wgt=DocWIdToWgtH[DocWordN];
1092      WordStrToDescH[WId].Fq++;
1093      DocSpV-&gt;AddWIdWgt(WId, Wgt);
1094    }
1095    DocSpV-&gt;Sort();
1096    return DId;
1097  }
1098  int TBowDocBs::AddDoc(const TStr&amp; _DocNm,
1099   const TStrV&amp; CatNmV, const TStrV&amp; WordStrV, const TStr&amp; DocStr){
1100    TStr DocNm=_DocNm;
1101    if (DocNm.Empty()){DocNm=TInt::GetStr(GetDocs());}
1102    int DId=-1;
1103    if (!DocNmToDescStrH.IsKey(DocNm, DId)){
1104      DId=DocNmToDescStrH.AddKey(DocNm);
1105      DocSpVV.Add(TBowSpV::New(DId)); IAssert(DId==DocSpVV.Len()-1);
1106      DocStrV.Add(DocStr);
1107      DocCIdVV.Add(); IAssert(DId==DocCIdVV.Len()-1);
1108    }
1109    TIntV&amp; DocCIdV=DocCIdVV[DId];
1110    DocCIdV.Gen(CatNmV.Len(), 0);
1111    for (int CatNmN=0; CatNmN&lt;CatNmV.Len(); CatNmN++){
1112      int CId=CatNmToFqH.AddKey(CatNmV[CatNmN]);
1113      CatNmToFqH[CId]++; DocCIdV.Add(CId);
1114    }
1115    DocCIdV.Sort();
1116    TStrIntH DocWordStrToFqH;
1117    for (int WordStrN=0; WordStrN&lt;WordStrV.Len(); WordStrN++){
1118      DocWordStrToFqH.AddDat(WordStrV[WordStrN])++;}
1119    PBowSpV DocSpV=DocSpVV[DId];
1120    DocSpV-&gt;GenMx(DocWordStrToFqH.Len());
1121    for (int DocWordStrN=0; DocWordStrN&lt;DocWordStrToFqH.Len(); DocWordStrN++){
1122      TStr WordStr=DocWordStrToFqH.GetKey(DocWordStrN);
1123      int Fq=DocWordStrToFqH[DocWordStrN];
1124      int WId=WordStrToDescH.AddKey(WordStr);
1125      WordStrToDescH[WId].Fq++;
1126      DocSpV-&gt;AddWIdWgt(WId, Fq);
1127    }
1128    DocSpV-&gt;Sort();
1129    return DId;
1130  }
1131  int TBowDocBs::AddHtmlDoc(const TStr&amp; DocNm, const TStrV&amp; CatNmV,
1132   const TStr&amp; HtmlDocStr, const bool&amp; SaveDocP){
1133    TStrV WordStrV; GetWordStrVFromHtml(HtmlDocStr, WordStrV);
1134    int DocId;
1135    if (SaveDocP){DocId=AddDoc(DocNm, CatNmV, WordStrV, HtmlDocStr);}
1136    else {DocId=AddDoc(DocNm, CatNmV, WordStrV, &quot;&quot;);}
1137    return DocId;
1138  }
1139  void TBowDocBs::GetAllDIdV(TIntV&amp; DIdV) const {
1140    int Docs=GetDocs();
1141    DIdV.Gen(Docs);
1142    for (int DId=0; DId&lt;Docs; DId++){
1143      DIdV[DId]=DId;}
1144  }
1145  bool TBowDocBs::IsDocWordStr(const int&amp; DId, const TStr&amp; WordStr) const {
1146    int WId;
1147    if (IsWordStr(WordStr, WId)){
1148      return DocSpVV[DId]-&gt;IsWId(WId);
1149    } else {
1150      return false;
1151    }
1152  }
1153  void TBowDocBs::GetTopCatV(const int&amp; TopCats, TIntStrPrV&amp; FqCatNmPrV) const {
1154    CatNmToFqH.GetDatKeyPrV(FqCatNmPrV);
1155    FqCatNmPrV.Sort(false);
1156    FqCatNmPrV.Trunc(TopCats);
1157  }
1158  void TBowDocBs::SetHOTrainTestDIdV(
1159   const double&amp; TestDocsPrc, TRnd&amp; Rnd){
1160    TIntV AllDIdV; GetAllDIdV(AllDIdV);
1161    AllDIdV.Shuffle(Rnd);
1162    int TestDocs=int(AllDIdV.Len()*TestDocsPrc);
1163    int MxTrainDIdN=AllDIdV.Len()-1-TestDocs;
1164    AllDIdV.GetSubValV(0, MxTrainDIdN, TrainDIdV);
1165    AllDIdV.GetSubValV(MxTrainDIdN+1, AllDIdV.Len()-1, TestDIdV);
1166  }
1167  void TBowDocBs::SetCVTrainTestDIdV(
1168   const int&amp; Folds, const int&amp; FoldN, TRnd&amp; Rnd){
1169    TIntV AllDIdV; GetAllDIdV(AllDIdV);
1170    if (Folds==1){
1171      TrainDIdV=AllDIdV;
1172      TestDIdV=AllDIdV;
1173    } else {
1174      AllDIdV.Shuffle(Rnd);
1175      int MnTestDIdN=(FoldN*AllDIdV.Len())/Folds;
1176      int MxTestDIdN=(((FoldN+1)*AllDIdV.Len())/Folds)-1;
1177      AllDIdV.GetSubValV(0, MnTestDIdN-1, TrainDIdV);
1178      TIntV UpTrainDIdV;
1179      AllDIdV.GetSubValV(MxTestDIdN+1, AllDIdV.Len()-1, UpTrainDIdV);
1180      TrainDIdV.AddV(UpTrainDIdV);
1181      AllDIdV.GetSubValV(MnTestDIdN, MxTestDIdN, TestDIdV);
1182    }
1183  }
1184  PBowDocBs TBowDocBs::GetLimWordRelFqDocBs(
1185   const double&amp; MnWordFqPrc, const double&amp; MxWordFqPrc) const {
1186    PBowDocBs BowDocBs=TBowDocBs::New();
1187    BowDocBs-&gt;DocNmToDescStrH=DocNmToDescStrH;
1188    BowDocBs-&gt;CatNmToFqH=CatNmToFqH;
1189    BowDocBs-&gt;DocCIdVV=DocCIdVV;
1190    BowDocBs-&gt;TrainDIdV=TrainDIdV;
1191    BowDocBs-&gt;TestDIdV=TestDIdV;
1192    int Docs=GetDocs();
1193    int Words=GetWords();
1194    for (int WId=0; WId&lt;Words; WId++){
1195      TStr WordStr=GetWordStr(WId);
1196      int WordFq=GetWordFq(WId);
1197      double WordFqPrc=double(WordFq)/double(Docs);
1198      if ((MnWordFqPrc&lt;WordFqPrc)&amp;&amp;(WordFqPrc&lt;MxWordFqPrc)){
1199        BowDocBs-&gt;WordStrToDescH.AddDat(WordStr).Fq=WordFq;
1200      }
1201    }
1202    for (int DId=0; DId&lt;Docs; DId++){
1203      PBowSpV DocSpV=DocSpVV[DId]; int WIds=DocSpV-&gt;GetWIds();
1204      BowDocBs-&gt;DocSpVV.Add(TBowSpV::New(DId));
1205      for (int WIdN=0; WIdN&lt;WIds; WIdN++){
1206        int WId; double WordFq; DocSpV-&gt;GetWIdWgt(WIdN, WId, WordFq);
1207        TStr WordStr=GetWordStr(WId);
1208        int NewWId;
1209        if (BowDocBs-&gt;IsWordStr(WordStr, NewWId)){
1210          BowDocBs-&gt;DocSpVV.Last()-&gt;AddWIdWgt(NewWId, WordFq);
1211        }
1212      }
1213      BowDocBs-&gt;DocSpVV.Last()-&gt;Trunc();
1214    }
1215    return BowDocBs;
1216  }
1217  PBowDocBs TBowDocBs::GetLimWordAbsFqDocBs(const int&amp; MnWordFq) const {
1218    PBowDocBs BowDocBs=TBowDocBs::New();
1219    BowDocBs-&gt;DocNmToDescStrH=DocNmToDescStrH;
1220    BowDocBs-&gt;CatNmToFqH=CatNmToFqH;
1221    BowDocBs-&gt;DocCIdVV=DocCIdVV;
1222    BowDocBs-&gt;TrainDIdV=TrainDIdV;
1223    BowDocBs-&gt;TestDIdV=TestDIdV;
1224    int Docs=GetDocs();
1225    int Words=GetWords();
1226    for (int WId=0; WId&lt;Words; WId++){
1227      TStr WordStr=GetWordStr(WId);
1228      int WordFq=GetWordFq(WId);
1229      if (MnWordFq&lt;=WordFq){
1230        BowDocBs-&gt;WordStrToDescH.AddDat(WordStr).Fq=WordFq;
1231      }
1232    }
1233    for (int DId=0; DId&lt;Docs; DId++){
1234      PBowSpV DocSpV=DocSpVV[DId]; int WIds=DocSpV-&gt;GetWIds();
1235      BowDocBs-&gt;DocSpVV.Add(TBowSpV::New(DId));
1236      for (int WIdN=0; WIdN&lt;WIds; WIdN++){
1237        int WId; double WordFq; DocSpV-&gt;GetWIdWgt(WIdN, WId, WordFq);
1238        TStr WordStr=GetWordStr(WId);
1239        int NewWId;
1240        if (BowDocBs-&gt;IsWordStr(WordStr, NewWId)){
1241          BowDocBs-&gt;DocSpVV.Last()-&gt;AddWIdWgt(NewWId, WordFq);
1242        }
1243      }
1244      BowDocBs-&gt;DocSpVV.Last()-&gt;Trunc();
1245    }
1246    return BowDocBs;
1247  }
1248  PBowDocBs TBowDocBs::GetSubDocSet(const TIntV&amp; DIdV) const {
1249    PBowDocBs BowDocBs=TBowDocBs::New();
1250    BowDocBs-&gt;DocSpVV.Gen(DIdV.Len(), 0);
1251    BowDocBs-&gt;DocCIdVV.Gen(DIdV.Len(), 0);
1252    int Docs=DIdV.Len();
1253    for (int DIdN=0; DIdN&lt;Docs; DIdN++){
1254      int DId=DIdV[DIdN];
1255      TStr DocNm=DocNmToDescStrH.GetKey(DId);
1256      PBowSpV SpV=DocSpVV[DId]; int WIds=SpV-&gt;GetWIds();
1257      const TIntV&amp; DocCIdV=DocCIdVV[DId];
1258      int NewDId=BowDocBs-&gt;DocNmToDescStrH.AddKey(DocNm);
1259      PBowSpV NewSpV=TBowSpV::New(NewDId, WIds);
1260      BowDocBs-&gt;DocSpVV.Add(NewSpV); IAssert(NewDId==BowDocBs-&gt;DocSpVV.Len()-1);
1261      for (int WIdN=0; WIdN&lt;WIds; WIdN++){
1262        int WId; double WordFq; SpV-&gt;GetWIdWgt(WIdN, WId, WordFq);
1263        TStr WordStr=GetWordStr(WId);
1264        int NewWId=BowDocBs-&gt;WordStrToDescH.AddKey(WordStr);
1265        BowDocBs-&gt;WordStrToDescH[NewWId].Fq++;
1266        NewSpV-&gt;AddWIdWgt(NewWId, WordFq);
1267      }
1268      NewSpV-&gt;Sort();
1269      BowDocBs-&gt;DocCIdVV.Add(); IAssert(NewDId+1==BowDocBs-&gt;DocCIdVV.Len());
1270      BowDocBs-&gt;DocCIdVV.Last().Gen(DocCIdV.Len(), 0);
1271      for (int DocCIdN=0; DocCIdN&lt;DocCIdV.Len(); DocCIdN++){
1272        int CId=DocCIdV[DocCIdN];
1273        TStr CatNm=GetCatNm(CId);
1274        const int NewCId=BowDocBs-&gt;CatNmToFqH.AddKey(CatNm);
1275        BowDocBs-&gt;CatNmToFqH[NewCId]++;
1276        BowDocBs-&gt;DocCIdVV.Last().Add(NewCId);
1277      }
1278    }
1279    return BowDocBs;
1280  }
1281  PBowDocBs TBowDocBs::GetInvDocBs() const {
1282    int Docs=GetDocs();
1283    int Words=GetWords();
1284    PBowDocBs InvBowDocBs=TBowDocBs::New();
1285    InvBowDocBs-&gt;WordStrToDescH.Gen(Docs);
1286    TIntV WordFqV(Words);
1287    for (int DId=0; DId&lt;Docs; DId++){
1288      TStr DocNm=GetDocNm(DId);
1289      PBowSpV DocSpV=GetDocSpV(DId);
1290      int DocWIds=DocSpV-&gt;GetWIds();
1291      InvBowDocBs-&gt;WordStrToDescH.AddDat(DocNm)=TBowWordDesc(DocWIds, 1, 1);
1292      for (int WIdN=0; WIdN&lt;DocWIds; WIdN++){
1293        int WId; double Wgt; DocSpV-&gt;GetWIdWgt(WIdN, WId, Wgt);
1294        WordFqV[WId]++;
1295      }
1296    }
1297    InvBowDocBs-&gt;DocNmToDescStrH.Gen(Words);
1298    InvBowDocBs-&gt;DocSpVV.Gen(Words, 0);
1299    InvBowDocBs-&gt;DocCIdVV.Gen(Words, 0);
1300    for (int WId=0; WId&lt;Words; WId++){
1301      TStr WordStr=GetWordStr(WId);
1302      int InvDId=InvBowDocBs-&gt;DocNmToDescStrH.AddKey(WordStr); IAssert(WId==InvDId);
1303      int InvDocWIds=WordFqV[WId];
1304      PBowSpV BowSpV=TBowSpV::New(InvDId, InvDocWIds);
1305      InvBowDocBs-&gt;DocSpVV.Add(BowSpV);
1306    }
1307    {for (int DId=0; DId&lt;Docs; DId++){
1308      PBowSpV DocSpV=GetDocSpV(DId);
1309      int DocWIds=DocSpV-&gt;GetWIds();
1310      for (int WIdN=0; WIdN&lt;DocWIds; WIdN++){
1311        int WId; double Wgt; DocSpV-&gt;GetWIdWgt(WIdN, WId, Wgt);
1312        InvBowDocBs-&gt;DocSpVV[WId]-&gt;AddWIdWgt(DId, 1);
1313      }
1314    }}
1315    {for (int WId=0; WId&lt;Words; WId++){
1316      InvBowDocBs-&gt;DocSpVV[WId]-&gt;Sort();
1317      IAssert(InvBowDocBs-&gt;DocSpVV[WId]-&gt;Len()==InvBowDocBs-&gt;DocSpVV[WId]-&gt;Reserved());
1318    }}
1319    InvBowDocBs-&gt;AssertOk();
1320    return InvBowDocBs;
1321  }
1322  void TBowDocBs::SaveTxtStat(const TStr&amp; StatFNm,
1323   const bool&amp; SaveWordsP, const bool&amp; SaveCatsP, const bool&amp; SaveDocsP) const {
1324    TFOut StatSOut(StatFNm); FILE* fStat=StatSOut.GetFileId();
1325    if (SaveWordsP){
1326      fprintf(fStat, &quot;\nDocument-Frequency Word-Statistics\n\n&quot;);
1327      TBowWordDescStrPrV WordDescStrPrV;
1328      WordStrToDescH.GetDatKeyPrV(WordDescStrPrV);
1329      WordDescStrPrV.Sort(false);
1330      for (int WordN=0; WordN&lt;WordDescStrPrV.Len(); WordN++){
1331        fprintf(fStat, &quot;%d.\t%d\t&#x27;%s&#x27;\n&quot;,
1332         1+WordN, (int)WordDescStrPrV[WordN].Val1.Fq, WordDescStrPrV[WordN].Val2.CStr());
1333      }
1334    }
1335    if (SaveCatsP){
1336      fprintf(fStat, &quot;\nCategory-Statistics\n\n&quot;);
1337      TIntStrPrV FqCatNmPrV; CatNmToFqH.GetDatKeyPrV(FqCatNmPrV);
1338      FqCatNmPrV.Sort(false);
1339      for (int FqCatNmPrN=0; FqCatNmPrN&lt;FqCatNmPrV.Len(); FqCatNmPrN++){
1340        fprintf(fStat, &quot;%d\t&#x27;%s&#x27;\n&quot;,
1341         (int)FqCatNmPrV[FqCatNmPrN].Val1, FqCatNmPrV[FqCatNmPrN].Val2.CStr());
1342      }
1343    }
1344    if (SaveDocsP){
1345      fprintf(fStat, &quot;Document-Statistics\n\n&quot;);
1346      int Docs=GetDocs();
1347      for (int DId=0; DId&lt;Docs; DId++){
1348        TStr DocNm=GetDocNm(DId);
1349        TStr DescStr=GetDocDescStr(DId);
1350        int DocWIds=GetDocWIds(DId);
1351        fprintf(fStat, &quot;DId:%d   Name:&#x27;%s&#x27; Desc: &#x27;%s&#x27; (%d Words):&quot;,
1352         DId, DocNm.CStr(), DescStr.CStr(), DocWIds);
1353        int DocCIds=GetDocCIds(DId);
1354        if (DocCIds&gt;0){
1355          fprintf(fStat, &quot;Cats:[&quot;);
1356          for (int DocCIdN=0; DocCIdN&lt;DocCIds; DocCIdN++){
1357            int CId=GetDocCId(DId, DocCIdN);
1358            TStr CatNm=GetCatNm(CId);
1359            if (DocCIdN&gt;0){fprintf(fStat, &quot;, &quot;);}
1360            fprintf(fStat, &quot;&#x27;%s&#x27;&quot;, CatNm.CStr());
1361          }
1362          fprintf(fStat, &quot;] &quot;);
1363        }
1364        for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
1365          int WId; double WordFq;
1366          GetDocWIdFq(DId, DocWIdN, WId, WordFq);
1367          TStr WordStr=GetWordStr(WId);
1368          fprintf(fStat, &quot; &#x27;%s&#x27;:%g&quot;, WordStr.CStr(), WordFq);
1369        }
1370        fprintf(fStat, &quot;\n&quot;);
1371      }
1372    }
1373  }
1374  PBowSpV TBowDocBs::GetSpVFromHtmlStr(
1375   const TStr&amp; HtmlStr, const PBowDocWgtBs&amp; BowDocWgtBs) const {
1376    TStrV WordStrV; GetWordStrVFromHtml(HtmlStr, WordStrV);
1377    TIntH DocWIdToFqH(100);
1378    for (int WordStrN=0; WordStrN&lt;WordStrV.Len(); WordStrN++){
1379      int WId;
1380      if (IsWordStr(WordStrV[WordStrN], WId)){
1381        DocWIdToFqH.AddDat(WId)++;
1382      }
1383    }
1384    PBowSpV DocSpV;
1385    if (BowDocWgtBs.Empty()){
1386      int DocWIds=DocWIdToFqH.Len();
1387      DocSpV=TBowSpV::New(-1, DocWIds);
1388      TInt DocWId; TInt DocWordFq;
1389      for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
1390        DocWIdToFqH.GetKeyDat(DocWIdN, DocWId, DocWordFq);
1391        DocSpV-&gt;AddWIdWgt(DocWId, DocWordFq);
1392      }
1393      DocSpV-&gt;Sort();
1394    } else {
1395      int MnWordFq=BowDocWgtBs-&gt;GetMnWordFq();
1396      int Docs=BowDocWgtBs-&gt;GetDocs();
1397      int DocWIds=DocWIdToFqH.Len();
1398      DocSpV=TBowSpV::New(-1, DocWIds);
1399      TInt DocWId; TInt DocWordFq;
1400      for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
1401        DocWIdToFqH.GetKeyDat(DocWIdN, DocWId, DocWordFq);
1402        if (GetWordFq(DocWId)&gt;=MnWordFq){
1403          double WordDf=BowDocWgtBs-&gt;GetWordFq(DocWId);
1404          double WordIDf=0;
1405          if (WordDf&gt;0){WordIDf=log(double(Docs)/WordDf);}
1406          double DocWordWgt=DocWordFq*WordIDf;
1407          DocSpV-&gt;AddWIdWgt(DocWId, DocWordWgt);
1408        }
1409      }
1410      DocSpV-&gt;Sort();
1411      DocSpV-&gt;CutLowWgtWords(BowDocWgtBs-&gt;GetCutWordWgtSumPrc());
1412      DocSpV-&gt;PutUnitNorm();
1413    }
1414    return DocSpV;
1415  }
1416  PBowSpV TBowDocBs::GetSpVFromHtmlFile(
1417   const TStr&amp; HtmlFNm, const PBowDocWgtBs&amp; BowDocWgtBs) const {
1418    PSIn HtmlSIn=TFIn::New(HtmlFNm);
1419    TStr HtmlStr=TStr::LoadTxt(HtmlSIn);
1420    return GetSpVFromHtmlStr(HtmlStr, BowDocWgtBs);
1421  }
1422  PBowSpV TBowDocBs::GetSpVFromWIdWgtPrV(
1423   const TIntFltPrV&amp; WIdWgtPrV, const PBowDocWgtBs&amp; BowDocWgtBs) const {
1424    PBowSpV DocSpV;
1425    if (BowDocWgtBs.Empty()){
1426      int DocWIds=WIdWgtPrV.Len();
1427      DocSpV=TBowSpV::New(-1, DocWIds);
1428      TInt DocWId; TInt DocWordFq;
1429      for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
1430        DocSpV-&gt;AddWIdWgt(WIdWgtPrV[DocWIdN].Val1, WIdWgtPrV[DocWIdN].Val2);
1431      }
1432      DocSpV-&gt;Sort();
1433    } else {
1434      int MnWordFq=BowDocWgtBs-&gt;GetMnWordFq();
1435      int Docs=BowDocWgtBs-&gt;GetDocs();
1436      int DocWIds=WIdWgtPrV.Len();
1437      DocSpV=TBowSpV::New(-1, DocWIds);
1438      TInt DocWId; double DocWordFq;
1439      for (int DocWIdN=0; DocWIdN&lt;DocWIds; DocWIdN++){
1440        DocWId=WIdWgtPrV[DocWIdN].Val1;
1441        DocWordFq=WIdWgtPrV[DocWIdN].Val2;
1442        if (GetWordFq(DocWId)&gt;=MnWordFq){
1443          double WordDf=BowDocWgtBs-&gt;GetWordFq(DocWId);
1444          double WordIDf=0;
1445          if (WordDf&gt;0){WordIDf=log(double(Docs)/WordDf);}
1446          double DocWordWgt=DocWordFq*WordIDf;
1447          DocSpV-&gt;AddWIdWgt(DocWId, DocWordWgt);
1448        }
1449      }
1450      DocSpV-&gt;Sort();
1451      DocSpV-&gt;CutLowWgtWords(BowDocWgtBs-&gt;GetCutWordWgtSumPrc());
1452      DocSpV-&gt;PutUnitNorm();
1453    }
1454    return DocSpV;
1455  }
1456  const TStr TBowDocBs::BowDocBsFExt=&quot;.Bow&quot;;
</code></pre>
        </div>
        <div class="column">
            <h3>snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-bowclust.cpp</h3>
            <pre><code>1  void TBowDocPartClust::CalcEntropy(const PBowDocBs&amp; BowDocBs){
2    int Docs=GetDocs();
3    int Cats=BowDocBs-&gt;GetCats();
4    TFltV CatWgtV(Cats);
5    double SumCatWgt=0;
6    for (int DIdN=0; DIdN&lt;Docs; DIdN++){
7      int DId=DIdV[DIdN];
8      int DocCats=BowDocBs-&gt;GetDocCIds(DId);
9      for (int DocCIdN=0; DocCIdN&lt;DocCats; DocCIdN++){
10        int CId=BowDocBs-&gt;GetDocCId(DId, DocCIdN);
11        double CatWgt=1/double(DocCats);
12        CatWgtV[CId]+=CatWgt; SumCatWgt+=CatWgt;
13      }
14    }
15    int NonZeroCatWgts=0;
16    if (SumCatWgt&gt;0){
17      for (int CId=0; CId&lt;Cats; CId++){
18        CatWgtV[CId]/=SumCatWgt;
19        if (double(CatWgtV[CId])!=0){NonZeroCatWgts++;}
20      }
21    }
22    CIdPrbKdV.Gen(NonZeroCatWgts, 0); Entropy=0;
23    for (int CId=0; CId&lt;Cats; CId++){
24      double Prb=CatWgtV[CId];
25      if (Prb&gt;0){
26        Entropy-=Prb*log(Prb);
27        CIdPrbKdV.Add(TIntFltKd(CId, Prb));
28      }
29    }
30  }
31  void TBowDocPartClust::GetTopWordStrWgtPrV(
32   const PBowDocBs&amp; BowDocBs,
33   const int&amp; TopWords, const double&amp; TopWordsWgtPrc,
34   TStrFltPrV&amp; WordStrWgtPrV) const {
35    int WIds=GetConceptWords();
36    TFltIntKdV WordWgtIdKdV(WIds); double WordWgtSum=0;
37    for (int WIdN=0; WIdN&lt;WIds; WIdN++){
38      int WId; double WordWgt;
39      GetConceptSpV()-&gt;GetWIdWgt(WIdN, WId, WordWgt);
40      WordWgtSum+=WordWgt;
41      WordWgtIdKdV[WIdN]=TFltIntKd(WordWgt, WId);
42    }
43    WordWgtIdKdV.Sort(false);
44    double CutWordWgtSum=TopWordsWgtPrc*WordWgtSum;
45    WordStrWgtPrV.Clr();
46    {for (int WIdN=0; WIdN&lt;WIds; WIdN++){
47      double WordWgt=WordWgtIdKdV[WIdN].Key;
48      int WId=WordWgtIdKdV[WIdN].Dat;
49      TStr WordStr=BowDocBs-&gt;GetWordStr(WId);
50      WordStrWgtPrV.Add(TStrFltPr(WordStr, WordWgt));
51      if ((TopWords!=-1)&amp;&amp;(1+WIdN&gt;=TopWords)){break;}
52      CutWordWgtSum-=WordWgt; if (CutWordWgtSum&lt;0){break;}
53    }}
54  }
55  double TBowDocPartClust::GetCatPrb(const int&amp; CId) const {
56    int CatN;
57    if (CIdPrbKdV.IsIn(TIntFltKd(CId, 0), CatN)){
58      return CIdPrbKdV[CatN].Dat;
59    } else {
60      return 0;
61    }
62  }
63  int TBowDocPartClust::GetMxPrbCId() const {
64    int MxCId=-1; double MxPrb=0;
65    int CIdPrbs=GetCIdPrbs();
66    for (int CIdPrbN=0; CIdPrbN&lt;CIdPrbs; CIdPrbN++){
67      int CId; double Prb; GetCIdPrb(CIdPrbN, CId, Prb);
68      if ((CIdPrbN==0)||(Prb&gt;MxPrb)){MxCId=CId; MxPrb=Prb;}
69    }
70    return MxCId;
71  }
72  void TBowDocPart::GetTopClustSimV(
73   const double&amp; ClustSimSumPrc, TFltIntIntTrV&amp; ClustSimN1N2TrV) const {
74    ClustSimN1N2TrV.Clr();
75    int Clusts=GetClusts();
76    double ClustSimSum=0;
77    for (int ClustN1=0; ClustN1&lt;Clusts; ClustN1++){
78      for (int ClustN2=ClustN1+1; ClustN2&lt;Clusts; ClustN2++){
79        double ClustSim=GetClustSim(ClustN1, ClustN2);
80        ClustSimN1N2TrV.Add(TFltIntIntTr(ClustSim, ClustN1, ClustN2));
81        ClustSimSum+=ClustSim;
82      }
83    }
84    ClustSimN1N2TrV.Sort(false);
85    double CutClustSimSum=(1-ClustSimSumPrc)*ClustSimSum;
86    while (!ClustSimN1N2TrV.Empty()){
87      CutClustSimSum-=ClustSimN1N2TrV.Last().Val1;
88      if (CutClustSimSum&lt;=0){
89        break;
90      } else {
91        ClustSimN1N2TrV.DelLast();
92      }
93    }
94  }
95  int TBowDocPart::GetDocs() const {
96    int Docs=0;
97    int Clusts=GetClusts();
98    for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
99      Docs+=GetClust(ClustN)-&gt;GetDocs();}
100    return Docs;
101  }
102  void TBowDocPart::GetDIdV(TIntV&amp; DIdV) const {
103    DIdV.Gen(GetDocs(), 0);
104    int Clusts=GetClusts();
105    for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
106      TIntV DIdV; GetClust(ClustN)-&gt;GetDIdV(DIdV);
107      DIdV.AddV(DIdV);
108    }
109  }
110  int TBowDocPart::GetBestClust(const PBowSpV&amp; SpV, const PBowSim&amp; BowSim) const {
111    int BestClustN=-1; double BestSim=0;
112    int Clusts=GetClusts(); IAssert(Clusts&gt;0);
113    for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
114      PBowDocPartClust Clust=GetClust(ClustN);
115      IAssert(Clust-&gt;IsConceptSpV());
116      double Sim=BowSim-&gt;GetSim(SpV, Clust-&gt;GetConceptSpV());
117      if ((BestClustN==-1)||(Sim&gt;BestSim)){
118        BestClustN=ClustN; BestSim=Sim;
119      }
120    }
121    return BestClustN;
122  }
123  int TBowDocPart::GetBestCId(const PBowSpV&amp; SpV, const PBowSim&amp; BowSim) const {
124    int BestClustN=GetBestClust(SpV, BowSim);
125    PBowDocPartClust BestClust=GetClust(BestClustN);
126    int BestCId=-1;
127    if (BestClust-&gt;IsSubPart()){
128      BestCId=BestClust-&gt;GetSubPart()-&gt;GetBestCId(SpV, BowSim);
129    } else {
130      BestCId=BestClust-&gt;GetMxPrbCId();
131    }
132    return BestCId;
133  }
134  void TBowDocPart::GetClustSimV(
135   const PBowSpV&amp; SpV, const PBowSim&amp; BowSim, TIntFltKdV&amp; ClustSimV) const {
136    int Clusts=GetClusts(); IAssert(Clusts&gt;0);
137    ClustSimV.Gen(Clusts, 0);
138    for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
139      PBowDocPartClust Clust=GetClust(ClustN);
140      IAssert(Clust-&gt;IsConceptSpV());
141      double Sim=BowSim-&gt;GetSim(SpV, Clust-&gt;GetConceptSpV());
142      ClustSimV.Add(TIntFltKd(ClustN, Sim));
143    }
144    IAssert(ClustSimV.Len() == Clusts);
145  }
146  void TBowDocPart::GetDefClustNmV(const TStr&amp; ClustNmPfx, TStrV&amp; ClustNmV) const {
147    for (int ClustN=0; ClustN&lt;GetClusts(); ClustN++){
148      TStr ClustNm=ClustNmPfx+&quot;_&quot;+TInt::GetStr(ClustN);
149      ClustNmV.Add(ClustNm);
150      PBowDocPartClust Clust=GetClust(ClustN);
151      if (Clust-&gt;IsSubPart()){
152        PBowDocPart SubPart=Clust-&gt;GetSubPart();
153        SubPart-&gt;GetDefClustNmV(ClustNm, ClustNmV);
154      }
155    }
156  }
157  void TBowDocPart::GetDefClustNmV(TStrV&amp; ClustNmV) const {
158    ClustNmV.Clr();
159    for (int ClustN=0; ClustN&lt;GetClusts(); ClustN++){
160      TStr ClustNm=TStr(&quot;C&quot;)+TInt::GetStr(ClustN);
161      ClustNmV.Add(ClustNm);
162      PBowDocPartClust Clust=GetClust(ClustN);
163      if (Clust-&gt;IsSubPart()){
164        PBowDocPart SubPart=Clust-&gt;GetSubPart();
165        SubPart-&gt;GetDefClustNmV(ClustNm, ClustNmV);
166      }
167    }
168  }
169  void TBowDocPart::GetCfClustNmV(
170   const PBowSpV TestDocSpV, const PBowSim&amp; BowSim, TStrV&amp; ClustNmV) const {
171    int ClustN=GetBestClust(TestDocSpV, BowSim);
172    PBowDocPartClust Clust=GetClust(ClustN);
173    TStr ClustNm=ClustNmV.Last()+&quot;_&quot;+TInt::GetStr(ClustN);
174    ClustNmV.Add(ClustNm);
175    if (Clust-&gt;IsSubPart()){
176      PBowDocPart SubPart=Clust-&gt;GetSubPart();
177      SubPart-&gt;GetCfClustNmV(TestDocSpV, BowSim, ClustNmV);
178    }
179  }
180  void TBowDocPart::GetCfClustNmVV(
181   const PBowDocBs&amp; BowDocBs, const TBowWordWgtType&amp; WordWgtType,
182   const PBowSim&amp; BowSim, const TIntV&amp; TrainDIdV, const TIntV&amp; TestDIdV,
183   TVec&lt;TStrV&gt;&amp; ClustNmVV, TVec&lt;TBowDocPartClustV&gt;&amp; ClustVV) const {
184    PBowDocWgtBs TrainDocWgtBs=
185     TBowDocWgtBs::New(BowDocBs, WordWgtType, 0, 0, TrainDIdV);
186    PBowDocWgtBs TestDocWgtBs=
187     TBowDocWgtBs::New(BowDocBs, WordWgtType, 0, 0, TestDIdV, TrainDIdV);
188    int TestDocs=TestDocWgtBs-&gt;GetDocs();
189    ClustNmVV.Clr(); ClustVV.Clr();
190    for (int TestDIdN=0; TestDIdN&lt;TestDocs; TestDIdN++){
191      int TestDId=TestDIdV[TestDIdN];
192      PBowSpV TestDocSpV=TestDocWgtBs-&gt;GetSpV(TestDId);
193      TStrV ClustNmV;
194      int ClustN=GetBestClust(TestDocSpV, BowSim);
195      PBowDocPartClust Clust=GetClust(ClustN);
196      TStr ClustNm=TStr(&quot;C&quot;)+TInt::GetStr(ClustN);
197      ClustNmV.Add(ClustNm);
198      if (Clust-&gt;IsSubPart()){
199        PBowDocPart SubPart=Clust-&gt;GetSubPart();
200        SubPart-&gt;GetCfClustNmV(TestDocSpV, BowSim, ClustNmV);
201      }
202      ClustNmVV.Add(ClustNmV); ClustVV.Add(ClustV);
203    }
204  }
205  void TBowDocPart::SaveXmlCfClustNmVV(
206   const PBowDocBs&amp; BowDocBs, const TBowWordWgtType&amp; WordWgtType,
207   const PBowSim&amp; BowSim, const TIntV&amp; TrainDIdV, const TIntV&amp; _TestDIdV,
208   const TStr&amp; FNm){
209    TIntV TestDIdV;
210    if (_TestDIdV.Empty()){BowDocBs-&gt;GetAllDIdV(TestDIdV);}
211    else {TestDIdV=_TestDIdV;}
212    TVec&lt;TStrV&gt; CfClustNmVV; TVec&lt;TBowDocPartClustV&gt; CfClustVV;
213    GetCfClustNmVV(
214     BowDocBs, WordWgtType, BowSim, TrainDIdV, TestDIdV, CfClustNmVV, CfClustVV);
215    TFOut SOut(FNm); TFileId OutFId=SOut.GetFileId();
216    fprintf(OutFId, &quot;&lt;DocClusterCf&gt;\n&quot;);
217    fprintf(OutFId, &quot;&lt;ClusterDefs&gt;\n&quot;);
218    TStrV DefClustNmV; GetDefClustNmV(DefClustNmV);
219    for (int DefClustNmN=0; DefClustNmN&lt;DefClustNmV.Len(); DefClustNmN++){
220      fprintf(OutFId, &quot;&lt;ClusterDef&gt;%s&lt;/ClusterDef&gt;\n&quot;, DefClustNmV[DefClustNmN].CStr());}
221    fprintf(OutFId, &quot;&lt;/ClusterDefs&gt;\n&quot;);
222    fprintf(OutFId, &quot;&lt;DocCfs&gt;\n&quot;);
223    int TestDocs=TestDIdV.Len();
224    for (int TestDIdN=0; TestDIdN&lt;TestDocs; TestDIdN++){
225      int TestDId=TestDIdV[TestDIdN];
226      TStr TestDocNm=BowDocBs-&gt;GetDocNm(TestDId);
227      fprintf(OutFId, &quot;&lt;DocCf Nm=\&quot;%s\&quot;&gt;&quot;, TestDocNm.CStr());
228      TStrV&amp; CfClustNmV=CfClustNmVV[TestDIdN];
229      for (int CfClustNmN=0; CfClustNmN&lt;CfClustNmV.Len(); CfClustNmN++){
230        fprintf(OutFId, &quot;&lt;ClusterCf&gt;%s&lt;/ClusterCf&gt;&quot;, CfClustNmV[CfClustNmN].CStr());
231      }
232      fprintf(OutFId, &quot;&lt;/DocCf&gt;\n&quot;);
233    }
234    fprintf(OutFId, &quot;&lt;/DocCfs&gt;\n&quot;);
235    fprintf(OutFId, &quot;&lt;/DocClusterCf&gt;\n&quot;);
236  }
237  void TBowDocPart::GetAreaPart(
238   const TFltRect&amp; Rect, TClustRectPrV&amp; ClustRectPrV, const bool&amp; ShuffleP) const {
239    int Clusts=GetClusts(); int Docs=GetDocs();
240    if ((Clusts==0)||(Docs==0)){return;}
241    double PrevMxX=Rect.MnX; double PrevMxY=Rect.MnY;
242    TIntV ClustNV(Clusts, 0);
243    for (int ClustN=0; ClustN&lt;Clusts; ClustN++){ClustNV.Add(ClustN);}
244    if (ShuffleP){TRnd Rnd; ClustNV.Shuffle(Rnd);}
245    for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
246      PBowDocPartClust Clust=GetClust(ClustNV[ClustN]);
247      int ClustDocs=Clust-&gt;GetDocs();
248      TFltRect SubRect;
249      if (Rect.GetXLen()&gt;=Rect.GetYLen()){
250        SubRect.MnX=PrevMxX;
251        SubRect.MxX=PrevMxX=PrevMxX+(ClustDocs/double(Docs))*Rect.GetXLen();
252        SubRect.MnY=Rect.MnY;
253        SubRect.MxY=Rect.MxY;
254      } else {
255        SubRect.MnX=Rect.MnX;
256        SubRect.MxX=Rect.MxX;
257        SubRect.MnY=PrevMxY;
258        SubRect.MxY=PrevMxY=PrevMxY+(ClustDocs/double(Docs))*Rect.GetYLen();
259      }
260      ClustRectPrV.Add(TClustRectPr(Clust, SubRect));
261      if (Clust-&gt;IsSubPart()){
262        PBowDocPart SubPart=Clust-&gt;GetSubPart();
263        SubPart-&gt;GetAreaPart(SubRect, ClustRectPrV);
264      }
265    }
266  }
267  void TBowDocPart::GetClustAtXY(const double&amp; X, const double Y,
268   const TClustRectPrV&amp; ClustRectPrV, const bool&amp; LeafPartP,
269   TBowDocPartClustV&amp; ClustV){
270    ClustV.Clr();
271    for (int ClustRectPrN=0; ClustRectPrN&lt;ClustRectPrV.Len(); ClustRectPrN++){
272      PBowDocPartClust Clust=ClustRectPrV[ClustRectPrN].Val1;
273      TFltRect Rect=ClustRectPrV[ClustRectPrN].Val2;
274      if (Rect.IsXYIn(X, Y)){
275        if (((LeafPartP)&amp;&amp;(!Clust-&gt;IsSubPart()))||(!LeafPartP)){
276          ClustV.Add(Clust);
277        }
278      }
279    }
280  }
281  void TBowDocPart::SavePartEntropyTxt(
282   const PSOut&amp; SOut, const PBowDocBs&amp; BowDocBs) const {
283    int Clusts=GetClusts();
284    SOut-&gt;PutStr(&quot;----------------------------\n&quot;);
285    SOut-&gt;PutStr(&quot;Inter Cluster Similarity\n&quot;);
286    for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
287      SOut-&gt;PutInt(ClustN, &quot;\tC-%d&quot;);}
288    SOut-&gt;PutLn();
289    for (int ClustN1=0; ClustN1&lt;Clusts; ClustN1++){
290      SOut-&gt;PutInt(ClustN1, &quot;C-%d&quot;);
291      for (int ClustN2=0; ClustN2&lt;Clusts; ClustN2++){
292        if (ClustN1&gt;=ClustN2){
293          SOut-&gt;PutStr(&quot;\t.&quot;);
294        } else {
295          double Sim=GetClustSim(ClustN1, ClustN2);
296          SOut-&gt;PutFlt(Sim, &quot;\t%.3f&quot;);
297        }
298      }
299      SOut-&gt;PutLn();
300    }
301    SOut-&gt;PutStr(&quot;----------------------------\n&quot;);
302    SOut-&gt;PutStr(&quot;Cluster Summaries\n&quot;);
303    {for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
304      PBowDocPartClust Clust=GetClust(ClustN);
305      SOut-&gt;PutInt(ClustN, &quot;C-%d:&quot;);
306      SOut-&gt;PutFlt(Clust-&gt;GetEntropy(), &quot; [Entropy %0.3f]&quot;);
307      SOut-&gt;PutFlt(Clust-&gt;GetMeanSim(), &quot; [Mean Sim. %0.2f]&quot;);
308      SOut-&gt;PutInt(Clust-&gt;GetDocs(), &quot; [%d Docs.]&quot;);
309      SOut-&gt;PutInt(Clust-&gt;GetConceptWords(), &quot; [%d Words]\n&quot;);
310    }}
311    SOut-&gt;PutStr(&quot;----------------------------\n&quot;);
312    SOut-&gt;PutStr(&quot;Category/Cluster Probabilities\n&quot;);
313    SOut-&gt;PutStr(&quot; &quot;, &quot;%20s&quot;);
314    {for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
315      SOut-&gt;PutInt(ClustN, &quot;\tC-%d&quot;);
316    }}
317    SOut-&gt;PutLn();
318    for (int CId=0; CId&lt;BowDocBs-&gt;GetCats(); CId++){
319      SOut-&gt;PutStr(BowDocBs-&gt;GetCatNm(CId), &quot;%20s&quot;);
320      for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
321        PBowDocPartClust Clust=GetClust(ClustN);
322        SOut-&gt;PutStr(&quot;\t&quot;);
323        double CatPrb=Clust-&gt;GetCatPrb(CId);
324        if (CatPrb&gt;0){
325          int MxPrbCId=Clust-&gt;GetMxPrbCId();
326          SOut-&gt;PutFlt(CatPrb, &quot;%0.3f&quot;);
327          if (MxPrbCId==CId){SOut-&gt;PutStr(&quot;!&quot;);}
328        } else {SOut-&gt;PutStr(&quot;.&quot;);}
329      }
330      SOut-&gt;PutLn();
331    }
332  }
333  void TBowDocPart::SaveTxt(
334   const PSOut&amp; SOut, const PBowDocBs&amp; BowDocBs,
335   const bool&amp; SaveWordsP, const int&amp; TopWords, const double&amp; TopWordsWgtPrc,
336   const bool&amp; SaveDocsP, const TStr&amp; PathStr) const {
337    SOut-&gt;PutStr(&quot;***********************************\n&quot;);
338    SOut-&gt;PutStr(PathStr, &quot;Path: %s\n&quot;);
339    SOut-&gt;PutInt(GetClusts(), &quot;Clusters: %d\n&quot;);
340    SOut-&gt;PutInt(GetDocs(), &quot;Documents: %d\n&quot;);
341    SOut-&gt;PutFlt(GetQual(), &quot;Quality: %g\n&quot;);
342    SOut-&gt;PutFlt(GetMeanSim(), &quot;Mean Similarity: %.3f\n&quot;);
343    if (!GetNm().Empty()){
344      SOut-&gt;PutStr(GetNm(), &quot;Name: \&quot;%s\&quot;\n&quot;);}
345    SOut-&gt;Flush();
346    for (int ClustN=0; ClustN&lt;GetClusts(); ClustN++){
347      PBowDocPartClust Clust=GetClust(ClustN);
348      SOut-&gt;PutStr(&quot;===================================\n&quot;);
349      SOut-&gt;PutInt(ClustN, &quot;Cluster-%d: &quot;);
350      SOut-&gt;PutFlt(Clust-&gt;GetMeanSim(), &quot; [Mean Sim. %0.3f]&quot;);
351      SOut-&gt;PutInt(Clust-&gt;GetDocs(), &quot; [%d Docs.]&quot;);
352      SOut-&gt;PutInt(Clust-&gt;GetConceptWords(), &quot; [%d Words]\n&quot;);
353      if (!Clust-&gt;GetNm().Empty()){
354        SOut-&gt;PutStr(Clust-&gt;GetNm(), &quot;[Name: \&quot;%s\&quot;]\n&quot;);}
355      if ((SaveWordsP)&amp;&amp;(!BowDocBs.Empty())){
356        SOut-&gt;PutStr(&quot;---Words------------------------\n&quot;);
357        int WIds=Clust-&gt;GetConceptWords();
358        TFltIntKdV WordWgtIdKdV(WIds); double WordWgtSum=0;
359        for (int WIdN=0; WIdN&lt;WIds; WIdN++){
360          int WId; double WordWgt;
361          Clust-&gt;GetConceptSpV()-&gt;GetWIdWgt(WIdN, WId, WordWgt);
362          WordWgtSum+=WordWgt;
363          WordWgtIdKdV[WIdN]=TFltIntKd(WordWgt, WId);
364        }
365        WordWgtIdKdV.Sort(false);
366        double WordWgtSumSF=0;
367        {for (int WIdN=0; WIdN&lt;WIds; WIdN++){
368          if (TopWords==WIdN){break;}
369          if ((WordWgtSum&gt;0)&amp;&amp;(WordWgtSumSF/WordWgtSum&gt;TopWordsWgtPrc)){break;}
370          double WordWgt=WordWgtIdKdV[WIdN].Key;
371          WordWgtSumSF+=WordWgt;
372          int WId=WordWgtIdKdV[WIdN].Dat;
373          TStr WordStr=BowDocBs-&gt;GetWordStr(WId);
374          SOut-&gt;PutStr(WordStr, &quot;&#x27;%s&#x27;:&quot;);
375          SOut-&gt;PutFlt(WordWgt, &quot;%.3f\n&quot;);
376        }}
377      }
378      SOut-&gt;Flush();
379      if (SaveDocsP){
380        SOut-&gt;PutStr(&quot;---Documents--------------------\n&quot;);
381        int Docs=Clust-&gt;GetDocs();
382        if (Clust-&gt;IsDCSimV()){
383          TFltIntPrV DCSimDIdPrV(Docs, 0);
384          for (int DIdN=0; DIdN&lt;Docs; DIdN++){
385            DCSimDIdPrV.Add(TFltIntPr(Clust-&gt;GetDCSim(DIdN), Clust-&gt;GetDId(DIdN)));
386          }
387          DCSimDIdPrV.Sort(false);
388          {for (int DIdN=0; DIdN&lt;Docs; DIdN++){
389            double DCSim=DCSimDIdPrV[DIdN].Val1;
390            int DId=DCSimDIdPrV[DIdN].Val2;
391            SOut-&gt;PutStr(BowDocBs-&gt;GetDocNm(DId), &quot;&#x27;%s&#x27;&quot;);
392            SOut-&gt;PutFlt(DCSim, &quot; : %g&quot;);
393            if (!BowDocBs-&gt;GetDocDescStr(DId).Empty()){
394              SOut-&gt;PutStr(BowDocBs-&gt;GetDocDescStr(DId), &quot; [%s]&quot;);}
395            SOut-&gt;PutStr(&quot;\n&quot;);
396          }}
397        } else {
398          for (int DIdN=0; DIdN&lt;Docs; DIdN++){
399            int DId=Clust-&gt;GetDId(DIdN);
400            SOut-&gt;PutStr(BowDocBs-&gt;GetDocNm(DId), &quot;&#x27;%s&#x27;&quot;);
401            if (!BowDocBs-&gt;GetDocDescStr(DId).Empty()){
402              SOut-&gt;PutStr(BowDocBs-&gt;GetDocDescStr(DId), &quot; [%s]&quot;);}
403            SOut-&gt;PutStr(&quot;\n&quot;);
404          }
405        }
406        if (Clust-&gt;IsDDSimVV()){
407          SOut-&gt;PutStr(&quot;---Intra-Document-Similarity----\n&quot;);
408          for (int DIdN1=0; DIdN1&lt;Docs; DIdN1++){
409            int DId1=Clust-&gt;GetDId(DIdN1);
410            SOut-&gt;PutStr(BowDocBs-&gt;GetDocNm(DId1), &quot;&#x27;%s&#x27;: &quot;);
411            for (int DIdN2=0; DIdN2&lt;Docs; DIdN2++){
412              double DDSim=Clust-&gt;GetDDSim(DIdN1, DIdN2);
413              SOut-&gt;PutFlt(DDSim, &quot; %.4f&quot;);
414            }
415            SOut-&gt;PutLn();
416          }
417        }
418      }
419    }
420    if (BowDocBs-&gt;GetCats()&gt;0){
421      SavePartEntropyTxt(SOut, BowDocBs);}
422    {for (int ClustN=0; ClustN&lt;GetClusts(); ClustN++){
423      PBowDocPart SubPart=GetClust(ClustN)-&gt;GetSubPart();
424      if (!SubPart.Empty()){
425        TStr NewPathStr=PathStr+&quot;|&quot;+TInt::GetStr(ClustN);
426        SubPart-&gt;SaveTxt(SOut, BowDocBs,
427         SaveWordsP, TopWords, TopWordsWgtPrc, SaveDocsP, NewPathStr);
428      }
429    }}
430    SOut-&gt;Flush();
431  }
432  void TBowDocPart::SaveXml(
433   const PSOut&amp; SOut, const PBowDocBs&amp; BowDocBs, const TStr&amp; PathStr) const {
434    SOut-&gt;PutStr(&quot;&lt;Partition&quot;);
435    SOut-&gt;PutStr(PathStr, &quot; Path=\&quot;%s\&quot;&quot;);
436    SOut-&gt;PutInt(GetClusts(), &quot; Clusts=\&quot;%d\&quot;&quot;);
437    SOut-&gt;PutInt(GetDocs(), &quot; Documents=\&quot;%d\&quot;&quot;);
438    SOut-&gt;PutFlt(GetQual(), &quot; Quality=\&quot;%g\&quot;&quot;);
439    SOut-&gt;PutFlt(GetMeanSim(), &quot; MeanSimilarity=\&quot;%g\&quot;&quot;);
440    if (!GetNm().Empty()){
441      SOut-&gt;PutStr(GetNm(), &quot; Name=\&quot;%s\&quot;&quot;);}
442    SOut-&gt;PutStr(&quot;&gt;\n&quot;);
443    for (int ClustN=0; ClustN&lt;GetClusts(); ClustN++){
444      PBowDocPartClust Clust=GetClust(ClustN);
445      SOut-&gt;PutStr(&quot;&lt;Cluster&quot;);
446      SOut-&gt;PutInt(ClustN, &quot; Id=\&quot;%d\&quot;&quot;);
447      SOut-&gt;PutFlt(Clust-&gt;GetQual(), &quot; Quality=\&quot;%g\&quot;&quot;);
448      SOut-&gt;PutFlt(Clust-&gt;GetMeanSim(), &quot; MeanSimilarity=\&quot;%g\&quot;&quot;);
449      SOut-&gt;PutFlt(Clust-&gt;GetEntropy(), &quot; Entropy=\&quot;%g\&quot;&quot;);
450      if (!Clust-&gt;GetNm().Empty()){
451        SOut-&gt;PutStr(Clust-&gt;GetNm(), &quot; Name=\&quot;%s\&quot;&quot;);}
452      SOut-&gt;PutStr(&quot;&gt;\n&quot;);
453      if (BowDocBs-&gt;GetCats()&gt;0){
454        int MxPrbCId=Clust-&gt;GetMxPrbCId();
455        SOut-&gt;PutStr(&quot;&lt;ClassDistr&quot;);
456        SOut-&gt;PutInt(MxPrbCId, &quot; BestId=\&quot;%d\&quot;&quot;);
457        SOut-&gt;PutStr(&quot;&gt;&quot;);
458        for (int CId=0; CId&lt;BowDocBs-&gt;GetCats(); CId++){
459          SOut-&gt;PutStr(&quot;&lt;Class&quot;);
460          SOut-&gt;PutInt(CId, &quot; Id=\&quot;%d\&quot;&quot;);
461          SOut-&gt;PutStr(BowDocBs-&gt;GetCatNm(CId), &quot; Name=\&quot;%s\&quot;&quot;);
462          double CatPrb=Clust-&gt;GetCatPrb(CId);
463          SOut-&gt;PutFlt(CatPrb, &quot; Prob=\&quot;%g\&quot;&quot;);
464          SOut-&gt;PutStr(&quot;/&gt;&quot;);
465        }
466        SOut-&gt;PutStr(&quot;&lt;/ClassDistr&gt;&quot;);
467      }
468      int Docs=Clust-&gt;GetDocs();
469      SOut-&gt;PutInt(Docs, &quot;&lt;Documents Count=\&quot;%d\&quot;&gt;\n&quot;);
470      for (int DIdN=0; DIdN&lt;Docs; DIdN++){
471        int DId=Clust-&gt;GetDId(DIdN);
472        SOut-&gt;PutStr(BowDocBs-&gt;GetDocNm(DId), &quot;&lt;D Nm=\&quot;%s\&quot;&quot;);
473        SOut-&gt;PutInt(DId, &quot; Id=\&quot;%d\&quot;&quot;);
474        if (!BowDocBs-&gt;GetDocDescStr(DId).Empty()){
475          SOut-&gt;PutStr(BowDocBs-&gt;GetDocDescStr(DId), &quot; Desc=\&quot;%s\&quot;&quot;);}
476        SOut-&gt;PutStr(&quot;/&gt;&quot;);
477      }
478      SOut-&gt;PutStr(&quot;&lt;/Documents&gt;\n&quot;);
479      SOut-&gt;PutInt(Clust-&gt;GetConceptWords(), &quot;&lt;Words Count=\&quot;%d\&quot;&gt;\n&quot;);
480      if (!BowDocBs.Empty()){
481        int WIds=Clust-&gt;GetConceptWords();
482        TFltIntKdV WordWgtIdKdV(WIds);
483        for (int WIdN=0; WIdN&lt;WIds; WIdN++){
484          int WId; double WordWgt;
485          Clust-&gt;GetConceptSpV()-&gt;GetWIdWgt(WIdN, WId, WordWgt);
486          WordWgtIdKdV[WIdN]=TFltIntKd(WordWgt, WId);
487        }
488        WordWgtIdKdV.Sort(false);
489        {for (int WIdN=0; WIdN&lt;WIds; WIdN++){
<span onclick='openModal()' class='match'>490          double WordWgt=WordWgtIdKdV[WIdN].Key;
491          int WId=WordWgtIdKdV[WIdN].Dat;
492          SOut-&gt;PutStr(BowDocBs-&gt;GetWordStr(WId), &quot;&lt;W Nm=\&quot;%s\&quot; &quot;);
</span>493          SOut-&gt;PutInt(WId, &quot;Id=\&quot;%d\&quot; &quot;);
494          SOut-&gt;PutFlt(WordWgt, &quot;Wgt=\&quot;%g\&quot;/&gt;&quot;);
495        }}
496        SOut-&gt;PutLn();
497      }
498      SOut-&gt;PutStr(&quot;&lt;/Words&gt;\n&quot;);
499      SOut-&gt;PutStr(&quot;&lt;/Cluster&gt;\n&quot;);
500    }
501    {for (int ClustN=0; ClustN&lt;GetClusts(); ClustN++){
502      PBowDocPart SubPart=GetClust(ClustN)-&gt;GetSubPart();
503      if (!SubPart.Empty()){
504        TStr NewPathStr=PathStr+&quot;|&quot;+TInt::GetStr(ClustN);
505        SubPart-&gt;SaveXml(SOut, BowDocBs, NewPathStr);
506      }
507    }}
508    SOut-&gt;Flush();
509    SOut-&gt;PutStr(&quot;&lt;/Partition&gt;\n&quot;);
510  }
511  void TBowDocPart::SaveRdfClusts(const PSOut&amp; SOut, const PBowDocBs&amp; BowDocBs, 
512          TIntIntVH&amp; DIdClustIdVH, const int&amp; FatherId, int&amp; ClustId) const {
513      for (int ClustN=0; ClustN&lt;GetClusts(); ClustN++) {
514          PBowDocPartClust Clust=GetClust(ClustN);
515          TStr CptNm, KeyWdStr;
516          if (!Clust-&gt;GetNm().Empty()){
517              CptNm = Clust-&gt;GetNm(); }
518          if (Clust-&gt;IsConceptSpV()) {
519              KeyWdStr = Clust-&gt;GetConceptSpV()-&gt;GetStr(BowDocBs, 20); 
520              if (CptNm.Empty()) {
521                  CptNm = Clust-&gt;GetConceptSpV()-&gt;GetStr(BowDocBs, 5, 1, &quot;, &quot;, false); }
522          }
523          if (CptNm.Empty()) {
524              CptNm = TStr::Fmt(&quot;Clust%d&quot;, ClustId); }
525          SOut-&gt;PutStrLn(TStr::Fmt(&quot;&lt;ptop:Topic rdf:about=\&quot;#TOP_%d\&quot;&gt;&quot;, ClustId));
526          SOut-&gt;PutStrLn(TStr::Fmt(&quot;  &lt;psys:description&gt;%s&lt;/psys:description&gt;&quot;, CptNm.CStr()));
527          if (FatherId != -1) {
528              SOut-&gt;PutStrLn(
529                  TStr::Fmt(&quot;  &lt;ptop:subTopicOf rdf:resource=\&quot;#TOP_%d\&quot; /&gt;&quot;, FatherId));
530          }
531          if (!KeyWdStr.Empty()) {
532              SOut-&gt;PutStrLn(TStr::Fmt(&quot;  &lt;jsikm:hasOntoGenClassProperties rdf:resource=\&quot;#CLS_PROP_%d\&quot; /&gt;&quot;, ClustId)); }
533          SOut-&gt;PutStrLn(&quot;&lt;/ptop:Topic&gt;&quot;);
534          if (!KeyWdStr.Empty()) {
535              SOut-&gt;PutStrLn(TStr::Fmt(&quot;&lt;jsikm:OntoGenClassProperties rdf:about=\&quot;#CLS_PROP_%d\&quot;&gt;&quot;, ClustId));
536              SOut-&gt;PutStrLn(TStr::Fmt(&quot;  &lt;jsikm:hasCentroidKeywords&gt;%s&lt;/jsikm:hasCentroidKeywords&gt;&quot;, KeyWdStr.CStr()));
537              SOut-&gt;PutStrLn(&quot;&lt;/jsikm:OntoGenClassProperties&gt;&quot;);
538          }
539          SOut-&gt;PutStrLn(&quot;&quot;);
540          int Docs=Clust-&gt;GetDocs();
541          for (int DIdN=0; DIdN&lt;Docs; DIdN++){
542              int DId=Clust-&gt;GetDId(DIdN);
543              if (DIdClustIdVH.IsKey(DId)) {
544                  DIdClustIdVH.GetDat(DId).Add(ClustId);
545              } else {
546                  DIdClustIdVH.AddDat(DId, TIntV::GetV(ClustId));
547              }
548          }
549          PBowDocPart SubPart=GetClust(ClustN)-&gt;GetSubPart();
550          const int MyId = ClustId; ClustId++;
551          if (!SubPart.Empty()){
552              SubPart-&gt;SaveRdfClusts(SOut, BowDocBs, DIdClustIdVH, MyId, ClustId);
553          }
554      }
555      SOut-&gt;Flush();
556  }
557  void TBowDocPart::SaveRdf(const TStr&amp; FNm, const PBowDocBs&amp; BowDocBs) const {
558      PSOut SOut=TFOut::New(FNm);
559      SOut-&gt;PutStrLn(&quot;&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;&quot;);
560      SOut-&gt;PutStrLn(&quot;&quot;);
561      SOut-&gt;PutStrLn(&quot;&lt;!DOCTYPE rdf:RDF [&quot;);
562      SOut-&gt;PutStrLn(&quot;    &lt;!ENTITY rdf  &#x27;http:&amp;bsol;&amp;bsol;www.w3.org/1999/02/22-rdf-syntax-ns#&#x27;&gt;&quot;);
563      SOut-&gt;PutStrLn(&quot;    &lt;!ENTITY rdfs &#x27;http:&amp;bsol;&amp;bsol;www.w3.org/TR/1999/PR-rdf-schema-19990303#&#x27;&gt;&quot;);
564      SOut-&gt;PutStrLn(&quot;    &lt;!ENTITY owl  &#x27;http:&amp;bsol;&amp;bsol;www.w3.org/2002/07/owl#&#x27;&gt;&quot;);
565      SOut-&gt;PutStrLn(&quot;    &lt;!ENTITY ptop &#x27;http:&amp;bsol;&amp;bsol;proton.semanticweb.org/2005/04/protont#&#x27;&gt;&quot;);
566      SOut-&gt;PutStrLn(&quot;    &lt;!ENTITY psys &#x27;http:&amp;bsol;&amp;bsol;proton.semanticweb.org/2005/04/protons#&#x27;&gt;&quot;);
567      SOut-&gt;PutStrLn(&quot;    &lt;!ENTITY pupp  &#x27;http:&amp;bsol;&amp;bsol;proton.semanticweb.org/2005/04/protonu#&#x27;&gt;&quot;);
568      SOut-&gt;PutStrLn(&quot;    &lt;!ENTITY protonkm  &#x27;http:&amp;bsol;&amp;bsol;proton.semanticweb.org/2005/04/protonkm#&#x27;&gt;&quot;);
569      SOut-&gt;PutStrLn(&quot;    &lt;!ENTITY jsikm  &#x27;http:&amp;bsol;&amp;bsol;kt.ijs.si/blazf/jsikm#&#x27;&gt;&quot;);
570      SOut-&gt;PutStrLn(&quot;]&gt;&quot;);
571      SOut-&gt;PutStrLn(&quot;&quot;);
572      SOut-&gt;PutStrLn(&quot;&lt;rdf:RDF&quot;);
573      SOut-&gt;PutStrLn(&quot;    xmlns:rdf=\&quot;&amp;rdf;\&quot;&quot;);
574      SOut-&gt;PutStrLn(&quot;    xmlns:rdfs=\&quot;&amp;rdfs;\&quot;&quot;);
575      SOut-&gt;PutStrLn(&quot;    xmlns:owl=\&quot;&amp;owl;\&quot;&quot;);
576      SOut-&gt;PutStrLn(&quot;    xmlns:protonkm=\&quot;&amp;protonkm;\&quot;&quot;);
577      SOut-&gt;PutStrLn(&quot;    xmlns:psys=\&quot;&amp;psys;\&quot;&quot;);
578      SOut-&gt;PutStrLn(&quot;    xmlns:pupp=\&quot;&amp;pupp;\&quot;&quot;);
579      SOut-&gt;PutStrLn(&quot;    xmlns:jsikm=\&quot;&amp;jsikm;\&quot;&quot;);
580      SOut-&gt;PutStrLn(&quot;    xmlns=\&quot;&amp;jsikm;\&quot;&quot;);
581      SOut-&gt;PutStrLn(&quot;    xmlns:ptop=\&quot;&amp;ptop;\&quot;&quot;);
582      SOut-&gt;PutStrLn(&quot;    xml:base=\&quot;&amp;jsikm;\&quot;&quot;);
583      SOut-&gt;PutStrLn(&quot;&gt;&quot;);
584      SOut-&gt;PutStrLn(&quot;&quot;);
585      SOut-&gt;PutStrLn(&quot;&lt;owl:Ontology rdf:about=\&quot;\&quot;&gt;&quot;);
586      SOut-&gt;PutStrLn(&quot;  &lt;rdfs:comment&gt;PROTON Topics (from Inspec Thesaurus) ordered by algorithm X&lt;/rdfs:comment&gt;&quot;);
587      SOut-&gt;PutStrLn(&quot;  &lt;owl:imports rdf:resource=\&quot;http:&amp;bsol;&amp;bsol;proton.semanticweb.org/2005/04/protons\&quot;/&gt;&quot;);
588      SOut-&gt;PutStrLn(&quot;  &lt;owl:imports rdf:resource=\&quot;http:&amp;bsol;&amp;bsol;proton.semanticweb.org/2005/04/protont\&quot;/&gt;&quot;);
589      SOut-&gt;PutStrLn(&quot;  &lt;owl:imports rdf:resource=\&quot;http:&amp;bsol;&amp;bsol;proton.semanticweb.org/2005/04/protonu\&quot;/&gt;&quot;);
590      SOut-&gt;PutStrLn(&quot;  &lt;owl:imports rdf:resource=\&quot;http:&amp;bsol;&amp;bsol;proton.semanticweb.org/2005/04/protonkm\&quot;/&gt;&quot;);
591      SOut-&gt;PutStrLn(&quot;  &lt;owl:imports rdf:resource=\&quot;http:&amp;bsol;&amp;bsol;kt.ijs.si/blazf/jsikm\&quot;/&gt;&quot;);
592      SOut-&gt;PutStrLn(&quot;  &lt;owl:versionInfo&gt;\&quot;0.1\&quot;&lt;/owl:versionInfo&gt;&quot;);
593      SOut-&gt;PutStrLn(&quot;&lt;/owl:Ontology&gt;&quot;);
594      SOut-&gt;PutStrLn(&quot;&quot;);
595      TIntIntVH DIdClustIdVH; int ClustId = 0;
596      SaveRdfClusts(SOut, BowDocBs, DIdClustIdVH, -1, ClustId);  
597      TIntV AllDIdV; BowDocBs-&gt;GetAllDIdV(AllDIdV);
598      TStr BowFNm = TStr::PutFExt(FNm, &quot;_docs.bow&quot;);
599      TStr ShortBowFNm = BowFNm.GetFMid() + BowFNm.GetFExt();
600      BowDocBs-&gt;SaveBin(BowFNm);
601      for (int DocN = 0; DocN &lt; AllDIdV.Len(); DocN++) {
602          const int DId = AllDIdV[DocN];
603          SOut-&gt;PutStrLn(TStr::Fmt(&quot;&lt;ptop:Document rdf:about=\&quot;#DOC_%d\&quot;&gt;&quot;, DId));
604          if (DIdClustIdVH.IsKey(DId)) {
605              const TIntV&amp; DocCptV = DIdClustIdVH.GetDat(DId);
606              for (int CptN = 0; CptN &lt; DocCptV.Len(); CptN++) {
607                  const int FthCptId = DocCptV[CptN];
608                  SOut-&gt;PutStrLn(TStr::Fmt(&quot;  &lt;ptop:hasSubject rdf:resource=\&quot;#TOP_%d\&quot; /&gt;&quot;, FthCptId));
609              }
610          }
611          SOut-&gt;PutStrLn(TStr::Fmt(&quot;  &lt;jsikm:hasOntoGenInstanceProperties rdf:resource=\&quot;#INST_PROP_%d\&quot; /&gt;&quot;, DId));
612          SOut-&gt;PutStrLn(&quot;&lt;/ptop:Topic&gt;&quot;);
613          SOut-&gt;PutStrLn(TStr::Fmt(&quot;&lt;jsikm:hasOntoGenInstanceProperties rdf:about=\&quot;#INST_PROP_%d\&quot;&gt;&quot;, DId));
614          SOut-&gt;PutStrLn(TStr::Fmt(&quot;  &lt;jsikm:locationOfInstance&gt;%s#%d&lt;/jsikm:locationOfInstance&gt;&quot;, ShortBowFNm.CStr(), DId));
615          SOut-&gt;PutStrLn(&quot;&lt;/jsikm:OntoGenClassProperties&gt;&quot;);
616          SOut-&gt;PutStrLn(&quot;&quot;);
617      }        
618      SOut-&gt;PutStrLn(&quot;&lt;/rdf:RDF&gt;&quot;);
619      SOut-&gt;Flush();
620  }
621  const TStr TBowDocPart::BowDocPartFExt=&quot;.BowPart&quot;;
622  PBowSpV TBowClust::GetConceptSpV(
623   const PBowDocWgtBs&amp; BowDocWgtBs, const PBowSim&amp; BowSim, const TIntV&amp; DIdV,
624   const double&amp; CutWordWgtSumPrc, const TIntFltPrV&amp; DocIdWgtPrV){
625    PBowSpV ConceptSpV;
626    if (DIdV.Empty()){
627      ConceptSpV=TBowSpV::New();
628    } else
629    if ((!BowSim.Empty())&amp;&amp;(BowSim-&gt;GetSimType()==bstMtx)){
630      int DIds=DIdV.Len(); int DIdGran=1;
631      int BestDId=DIdV[0]; double BestAvgSim=0;
632      for (int DIdN1=0; DIdN1&lt;DIds; DIdN1+=DIdGran){
633        int DId1=DIdV[DIdN1];
634        double SumSim=0; int TestDIds=0;
635        for (int DIdN2=0; DIdN2&lt;DIds; DIdN2+=DIdGran){
636          if (DIdN1==DIdN2){continue;}
637          int DId2=DIdV[DIdN2];
638          SumSim+=BowSim-&gt;GetSim(DId1, DId2); TestDIds++;
639        }
640        if (TestDIds&gt;0){
641          double AvgSim=SumSim/TestDIds;
642          if (AvgSim&gt;BestAvgSim){BestDId=DId1;}
643        }
644      }
645      ConceptSpV=BowDocWgtBs-&gt;GetSpV(BestDId);
646    } else {
647      int Words=BowDocWgtBs-&gt;GetWords();
648      TFltV WordWgtSumV(Words); double WordWgtSum=0;
649      int DIds=DIdV.Len();
650      TIntFltH DocIdToWgtH(DIds); 
651      for (int DIdN=0; DIdN&lt;DocIdWgtPrV.Len(); DIdN++){
652        DocIdToWgtH.AddDat(DocIdWgtPrV[DIdN].Val1, DocIdWgtPrV[DIdN].Val2);
653      }
654      for (int DIdN=0; DIdN&lt;DIds; DIdN++){
655        int DId=DIdV[DIdN];
656        TFlt DocWgt=1.0;
657        if (DocIdWgtPrV.Len()&gt;0){
658          DocIdToWgtH.IsKeyGetDat(DId, DocWgt);}
659        PBowSpV SpV=BowDocWgtBs-&gt;GetSpV(DId);
660        int WIds=SpV-&gt;GetWIds();
661        for (int WIdN=0; WIdN&lt;WIds; WIdN++){
662          int WId; double WordWgt; SpV-&gt;GetWIdWgt(WIdN, WId, WordWgt);
663          WordWgtSumV[WId]+=DocWgt.Val*WordWgt; WordWgtSum+=DocWgt.Val*WordWgt;
664        }
665      }
666      ConceptSpV=TBowSpV::New(-1, Words/10);
667      for (int WId=0; WId&lt;Words; WId++){
668        if (double(WordWgtSumV[WId])&gt;0){
669          double WordWgtMean=WordWgtSumV[WId]/DIds;
670          ConceptSpV-&gt;AddWIdWgt(WId, WordWgtMean);
671        }
672      }
673      if (CutWordWgtSumPrc&lt;1.0){
674        ConceptSpV-&gt;CutLowWgtWords(CutWordWgtSumPrc);}
675      ConceptSpV-&gt;PutUnitNorm();
676      ConceptSpV-&gt;Trunc();
677    }
678    return ConceptSpV;
679  }
680  void TBowClust::GetConceptSpVV(const PBowSim&amp; &amp;bsol;*BowSim*/,
681   const TBowSpVV&amp; SpVV1, const TBowSpVV&amp; SpVV2, TBowSpVV&amp; ConceptSpVV){
682    ConceptSpVV.Gen(SpVV1.Len()+SpVV2.Len(), 0);
683    ConceptSpVV.AddV(SpVV1);
684    ConceptSpVV.AddV(SpVV2);
685  }
686  double TBowClust::GetClustQual(
687   const PBowDocWgtBs&amp; BowDocWgtBs,
688   const TIntV&amp; DIdV, const PBowSpV&amp; ConceptSpV, const PBowSim&amp; BowSim){
689    double Qual=0;
690    int DIds=DIdV.Len();
691    for (int DIdN=0; DIdN&lt;DIds; DIdN++){
692      int DId=DIdV[DIdN];
693      Qual+=BowSim-&gt;GetSim(ConceptSpV, BowDocWgtBs-&gt;GetSpV(DId));
694    }
695    return Qual;
696  }
697  void TBowClust::GetPartQual(
698   const PBowDocWgtBs&amp; BowDocWgtBs,
699   const TVec&lt;TIntV&gt;&amp; DIdVV, const TBowSpVV&amp; ConceptSpVV,
700   const PBowSim&amp; BowSim, double&amp; PartQual, TFltV&amp; ClustQualV){
701    int Clusts=DIdVV.Len();
702    PartQual=0;
703    ClustQualV.Gen(Clusts);
704    for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
705      double ClustQual=
706       GetClustQual(BowDocWgtBs, DIdVV[ClustN], ConceptSpVV[ClustN], BowSim);
707      PartQual+=ClustQual;
708      ClustQualV[ClustN]=ClustQual;
709    }
710  }
711  PBowDocPart TBowClust::GetKMeansPartForDocWgtBs(
712   const PNotify&amp; Notify,
713   const PBowDocWgtBs&amp; BowDocWgtBs,
714   const PBowDocBs&amp; BowDocBs, const PBowSim&amp; BowSim, TRnd&amp; Rnd,
715   const int&amp; Clusts, const int&amp; ClustTrials,
716   const double&amp; ConvergEps, const int&amp; MnDocsPerClust,
717   const TIntFltPrV&amp; DocIdWgtPrV){
718    int Docs=BowDocWgtBs-&gt;GetDocs();
719    int Words=BowDocWgtBs-&gt;GetWords();
720    TNotify::OnNotify(Notify, ntInfo, &quot;-----------------------&quot;);
721    TNotify::OnNotify(Notify, ntInfo, TInt::GetStr(Docs, &quot;Docs: %d&quot;));
722    TNotify::OnNotify(Notify, ntInfo, TInt::GetStr(Words, &quot;Words: %d&quot;));
723    PBowDocPart BestPart=TBowDocPart::New();
724    int ClustTrialN=0; int AddClustTrials=0;
725    while (ClustTrialN&lt;ClustTrials+AddClustTrials){
726      ClustTrialN++;
727      TNotify::OnNotify(Notify, ntInfo,
728       TInt::GetStr(ClustTrialN, &quot;Clustering Trial %d&quot;));
729      TBowSpVV ConceptSpVV(Clusts);
730      double BestStartConceptMeanSim=0;
731      TBowSpVV BestStartConceptSpVV(Clusts);
732      for (int CVTrialN=0; CVTrialN&lt;3; CVTrialN++){
733        for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
734          int DIdN=Rnd.GetUniDevInt(Docs);
735          int DId=BowDocWgtBs-&gt;GetDId(DIdN);
736          ConceptSpVV[ClustN]=BowDocWgtBs-&gt;GetSpV(DId);
737        }
738        PMom SimMom=TMom::New();
739        for (int ClustN1=0; ClustN1&lt;Clusts; ClustN1++){
740          for (int ClustN2=ClustN1+1; ClustN2&lt;Clusts; ClustN2++){
741            double Sim=BowSim-&gt;GetSim(ConceptSpVV[ClustN1], ConceptSpVV[ClustN2]);
742            SimMom-&gt;Add(Sim);
743          }
744        }
745        SimMom-&gt;Def();
746        double ConceptMeanSim=SimMom-&gt;GetMean();
747        if ((CVTrialN==0)||(ConceptMeanSim&lt;BestStartConceptMeanSim)){
748          BestStartConceptMeanSim=ConceptMeanSim;
749          BestStartConceptSpVV=ConceptSpVV;
750        }
751      }
752      ConceptSpVV=BestStartConceptSpVV;
753      double PrevPartQual=0; 
754      double PartQual=0; 
755      TFltV ClustQualV; 
756      TVec&lt;TIntV&gt; DIdVV; 
757      int ClustIters=0; 
758      forever {
759        ClustIters++;
760        bool EmptyClustP;
761        do {
762          DIdVV.Gen(Clusts);
763          for (int DIdN=0; DIdN&lt;Docs; DIdN++){
764            int DId=BowDocWgtBs-&gt;GetDId(DIdN);
765            PBowSpV DocSpV=BowDocWgtBs-&gt;GetSpV(DId);
766            TFltIntKdV SimClustNKdV(Clusts);
767            for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
768              double Sim=BowSim-&gt;GetSim(ConceptSpVV[ClustN], DocSpV);
769              SimClustNKdV[ClustN]=TFltIntKd(Sim, ClustN);
770            }
771            SimClustNKdV.Sort(false); 
772            int BestClustN=SimClustNKdV[0].Dat; 
773            if ((SimClustNKdV.Len()&gt;0)&amp;&amp;(SimClustNKdV[0].Key==SimClustNKdV[1].Key)){
774              int BestClusts=1;
775              for (int ClustN=1; ClustN&lt;Clusts; ClustN++){
776                if (SimClustNKdV[0].Key==SimClustNKdV[ClustN].Key){
777                  BestClusts++;
778                } else {break;}
779              }
780              BestClustN=Rnd.GetUniDevInt(BestClusts);
781            }
782            DIdVV[BestClustN].Add(DId);
783          }
784          EmptyClustP=false;
785          for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
786            if ((MnDocsPerClust!=-1)&amp;&amp;(DIdVV[ClustN].Len()&lt;MnDocsPerClust)){
787              int DId=BowDocWgtBs-&gt;GetDId(Rnd.GetUniDevInt(Docs));
788              ConceptSpVV[ClustN]=BowDocWgtBs-&gt;GetSpV(DId);
789              PrevPartQual=0; PartQual=0; ClustIters=1;
790              EmptyClustP=true; break;
791            } else {
792              ConceptSpVV[ClustN]=
793               TBowClust::GetConceptSpV(BowDocWgtBs, BowSim, DIdVV[ClustN], 1, DocIdWgtPrV);
794            }
795          }
796        } while (EmptyClustP);
797        PrevPartQual=PartQual;
798        GetPartQual(BowDocWgtBs, DIdVV, ConceptSpVV, BowSim, PartQual, ClustQualV);
799        TStr MsgStr=
800         TInt::GetStr(ClustIters, &quot;  Iteration %d:&quot;)+
801         TFlt::GetStr(PartQual, &quot; [Quality: %g]&quot;);
802        TNotify::OnNotify(Notify, ntInfo, MsgStr);
803        if (fabs(PartQual-PrevPartQual)&lt;ConvergEps){break;}
804      }
805      if ((ClustTrialN==1)||(PartQual&gt;BestPart-&gt;GetQual())){
806        BestPart=TBowDocPart::New();
807        BestPart-&gt;PutQual(PartQual);
808        for (int ClustN=0; ClustN&lt;Clusts; ClustN++){
809          PBowDocPartClust Clust=TBowDocPartClust::New(BowDocBs,
810           &quot;&quot;, ClustQualV[ClustN], DIdVV[ClustN], ConceptSpVV[ClustN], NULL);
811          BestPart-&gt;AddClust(Clust);
812          {TIntV&amp; DIdV=DIdVV[ClustN]; int Docs=DIdV.Len(); TFltV DCSimV(Docs, 0);
813          for (int DIdN=0; DIdN&lt;Docs; DIdN++){
814            PBowSpV DocSpV=BowDocWgtBs-&gt;GetSpV(DIdV[DIdN]);
815            double Sim=BowSim-&gt;GetSim(ConceptSpVV[ClustN], DocSpV);
816            DCSimV.Add(Sim);
817          }
818          Clust-&gt;AddDCSimV(DCSimV);}
819          {TIntV&amp; DIdV=DIdVV[ClustN]; int Docs=DIdV.Len();
820          if (Docs&lt;=200){
821            TFltVV DDSimVV(Docs, Docs);
822            for (int DIdN1=0; DIdN1&lt;Docs; DIdN1++){
823              PBowSpV DocSpV1=BowDocWgtBs-&gt;GetSpV(DIdV[DIdN1]);
824              for (int DIdN2=0; DIdN2&lt;Docs; DIdN2++){
825                PBowSpV DocSpV2=BowDocWgtBs-&gt;GetSpV(DIdV[DIdN2]);
826                double Sim=BowSim-&gt;GetSim(DocSpV1, DocSpV2);
827                DDSimVV.At(DIdN1, DIdN2)=Sim;
828              }
829            }
830            Clust-&gt;AddDDSimVV(DDSimVV);
831          }}
832        }
833        TFltVV ClustSimVV(Clusts, Clusts);
834        for (int ClustN1=0; ClustN1&lt;Clusts; ClustN1++){
835          ClustSimVV.At(ClustN1, ClustN1)=
836           BowSim-&gt;GetSim(ConceptSpVV[ClustN1], ConceptSpVV[ClustN1]);
837          for (int ClustN2=ClustN1+1; ClustN2&lt;Clusts; ClustN2++){
838            double Sim=BowSim-&gt;GetSim(ConceptSpVV[ClustN1], ConceptSpVV[ClustN2]);
839            ClustSimVV.At(ClustN1, ClustN2)=Sim;
840            ClustSimVV.At(ClustN2, ClustN1)=Sim;
841          }
842        }
843        BestPart-&gt;PutClustSim(ClustSimVV);
844      }
845    }
846    TNotify::OnNotify(Notify, ntInfo,
847     TFlt::GetStr(BestPart-&gt;GetQual(), &quot;Final Quality: %g&quot;));
848    return BestPart;
849  }
850  PBowDocPart TBowClust::GetHPartForDocWgtBs(
851   const PNotify&amp; Notify,
852   const PBowDocWgtBs&amp; BowDocWgtBs,
853   const PBowDocBs&amp; BowDocBs, const PBowSim&amp; BowSim, TRnd&amp; &amp;bsol;*Rnd*/){
854    int Docs=BowDocWgtBs-&gt;GetDocs();
855    TFltVV SimVV(Docs, Docs); SimVV.PutAll(-1);
856    TVec&lt;TBowSpVV&gt; ClustSpVVV(Docs, 0);
857    TBowDocPartV PartV(Docs, 0);
858    for (int DIdN1=0; DIdN1&lt;Docs; DIdN1++){
859      int DId1=BowDocWgtBs-&gt;GetDId(DIdN1);
860      TBowSpVV ClustSpVV(1); ClustSpVV[0]=BowDocWgtBs-&gt;GetSpV(DId1);
861      ClustSpVVV.Add(ClustSpVV);
862      TIntV ClustDIdV(1); ClustDIdV[0]=DId1;
863      PBowDocPartClust Clust=
864       TBowDocPartClust::New(BowDocBs, &quot;&quot;, 0, ClustDIdV, NULL, NULL);
865      PBowDocPart Part=TBowDocPart::New();
866      Part-&gt;AddClust(Clust);
867      PartV.Add(Part);
868      for (int DIdN2=DIdN1+1; DIdN2&lt;Docs; DIdN2++){
869        int DId2=BowDocWgtBs-&gt;GetDId(DIdN2);
870        double Sim=
871         BowSim-&gt;GetSim(BowDocWgtBs-&gt;GetSpV(DId1), BowDocWgtBs-&gt;GetSpV(DId2));
872        SimVV.At(DIdN1, DIdN2)=Sim;
873        SimVV.At(DIdN2, DIdN1)=Sim;
874      }
875    }
876    int Clusts=Docs;
877    while (Clusts&gt;1){
878      int DIdN1; int DIdN2; SimVV.GetMxValXY(DIdN1, DIdN2);
879      SimVV.PutX(DIdN1, -1); SimVV.PutY(DIdN1, -1);
880      SimVV.PutX(DIdN2, -1); SimVV.PutY(DIdN2, -1);
881      TBowSpVV ConceptSpVV;
882      GetConceptSpVV(BowSim, ClustSpVVV[DIdN1], ClustSpVVV[DIdN2], ConceptSpVV);
883      ClustSpVVV[DIdN1]=ConceptSpVV;
884      ClustSpVVV[DIdN2].Clr();
885      for (int DIdN=0; DIdN&lt;Docs; DIdN++){
886        if ((ClustSpVVV[DIdN].Len()&gt;0)&amp;&amp;(DIdN!=DIdN1)){
887          double Sim=BowSim-&gt;GetSim(ConceptSpVV, ClustSpVVV[DIdN]);
888          SimVV.At(DIdN1, DIdN)=Sim;
889          SimVV.At(DIdN, DIdN1)=Sim;
890        }
891      }
892      PBowDocPart Part1=PartV[DIdN1];
893      PBowDocPart Part2=PartV[DIdN2];
894      TIntV PartDIdV1; Part1-&gt;GetDIdV(PartDIdV1);
895      TIntV PartDIdV2; Part2-&gt;GetDIdV(PartDIdV2);
896      PBowDocPartClust Clust1=TBowDocPartClust::New(BowDocBs, &quot;&quot;, 0, PartDIdV1, NULL, Part1);
897      PBowDocPartClust Clust2=TBowDocPartClust::New(BowDocBs, &quot;&quot;, 0, PartDIdV2, NULL, Part2);
898      PBowDocPart Part=TBowDocPart::New();
899      Part-&gt;AddClust(Clust1);
900      Part-&gt;AddClust(Clust2);
901      PartV[DIdN1]=Part;
902      PartV[DIdN2]=NULL;
903      Clusts--;
904      TNotify::OnStatus(Notify, TInt::GetStr(Clusts, &quot;Clusts: %4d\r&quot;));
905    }
906    return PartV[0];
907  }
908  PBowDocPart TBowClust::GetKMeansPart(
909   const PNotify&amp; Notify,
910   const PBowDocBs&amp; BowDocBs, const PBowSim&amp; BowSim, TRnd&amp; Rnd,
911   const int&amp; Clusts, const int&amp; ClustTrials,
912   const double&amp; ConvergEps, const int&amp; MnDocsPerClust,
913   const TBowWordWgtType&amp; WordWgtType, const double&amp; CutWordWgtSumPrc,
914   const int&amp; MnWordFq, const TIntV&amp; _DIdV){
915    TIntV DIdV;
916    if (_DIdV.Empty()){BowDocBs-&gt;GetAllDIdV(DIdV);} else {DIdV=_DIdV;}
917    PBowDocWgtBs BowDocWgtBs=
918     TBowDocWgtBs::New(BowDocBs, WordWgtType, CutWordWgtSumPrc, MnWordFq, DIdV);
919    PBowDocPart BowDocPart=TBowClust::GetKMeansPartForDocWgtBs(
920     Notify, BowDocWgtBs, BowDocBs, BowSim,
921     Rnd, Clusts, ClustTrials, ConvergEps, MnDocsPerClust);
922    return BowDocPart;
923  }
924  PBowDocPart TBowClust::GetHKMeansPart(
925   const PNotify&amp; Notify,
926   const PBowDocBs&amp; BowDocBs, const PBowSim&amp; BowSim, TRnd&amp; Rnd,
927   const int&amp; MxDocsPerLeafClust, const int&amp; ClustTrials,
928   const double&amp; ConvergEps, const int&amp; MnDocsPerClust,
929   const TBowWordWgtType&amp; WordWgtType, const double&amp; CutWordWgtSumPrc,
930   const int&amp; MnWordFq, const TIntV&amp; _DIdV,
931   const bool&amp; PropBowDocWgtBsP, const PBowDocWgtBs&amp; _BowDocWgtBs){
932    TIntV DIdV;
933    if (_DIdV.Empty()){BowDocBs-&gt;GetAllDIdV(DIdV);} else {DIdV=_DIdV;}
934    PBowDocWgtBs BowDocWgtBs;
935    if ((PropBowDocWgtBsP)||(_BowDocWgtBs.Empty())){
936     BowDocWgtBs=TBowDocWgtBs::New(BowDocBs, WordWgtType, CutWordWgtSumPrc, MnWordFq, DIdV);
937    } else {
938      BowDocWgtBs=_BowDocWgtBs;
939    }
940    int BowDocWgtBsDocs=BowDocWgtBs-&gt;GetDocs();
941    PBowDocPart DocPart=TBowClust::GetKMeansPartForDocWgtBs(
942     Notify, BowDocWgtBs, BowDocBs, BowSim,
943     Rnd, 2, ClustTrials, ConvergEps, MnDocsPerClust);
944    if (!PropBowDocWgtBsP){
945      BowDocWgtBs=NULL;}
946    for (int ClustN=0; ClustN&lt;DocPart-&gt;GetClusts(); ClustN++){
947      PBowDocPartClust Clust=DocPart-&gt;GetClust(ClustN);
948      int ClustDocs=Clust-&gt;GetDocs();
949      if ((ClustDocs&gt;MxDocsPerLeafClust)||(ClustDocs==BowDocWgtBsDocs)){
950        TIntV ClustDIdV; Clust-&gt;GetDIdV(ClustDIdV);
951        PBowDocPart SubDocPart=GetHKMeansPart(Notify,
952         BowDocBs, BowSim, Rnd, MxDocsPerLeafClust, ClustTrials, ConvergEps,
953         MnDocsPerClust, WordWgtType, CutWordWgtSumPrc, MnWordFq, ClustDIdV,
954         PropBowDocWgtBsP, BowDocWgtBs);
955        Clust-&gt;PutSubPart(SubDocPart);
956      }
957    }
958    return DocPart;
959  }
960  PBowDocPart TBowClust::GetHPart(
961   const PNotify&amp; Notify,
962   const PBowDocBs&amp; BowDocBs, const PBowSim&amp; BowSim, TRnd&amp; Rnd,
963   const TBowWordWgtType&amp; WordWgtType, const double&amp; CutWordWgtSumPrc,
964   const int&amp; MnWordFq, const TIntV&amp; DIdV){
965    PBowDocWgtBs BowDocWgtBs=
966     TBowDocWgtBs::New(BowDocBs, WordWgtType, CutWordWgtSumPrc, MnWordFq, DIdV);
967    PBowDocPart BowDocPart=
968     GetHPartForDocWgtBs(Notify, BowDocWgtBs, BowDocBs, BowSim, Rnd);
969    return BowDocPart;
970  }
971  double TBowClust::GetNNbrCfAcc(
972   const PNotify&amp; Notify,
973   const PBowDocBs&amp; BowDocBs, const PBowSim&amp; BowSim,
974   const TBowWordWgtType&amp; WordWgtType, const int&amp; KNbrs,
975   const TIntV&amp; TrainDIdV, const TIntV&amp; TestDIdV){
976    PBowDocWgtBs TrainDocWgtBs=
977     TBowDocWgtBs::New(BowDocBs, WordWgtType, 0, 0, TrainDIdV);
978    PBowDocWgtBs TestDocWgtBs=
979     TBowDocWgtBs::New(BowDocBs, WordWgtType, 0, 0, TestDIdV, TrainDIdV);
980    int TrainDocs=TrainDocWgtBs-&gt;GetDocs();
981    int TestDocs=TestDocWgtBs-&gt;GetDocs();
982    int AllCfs=0; int CorrectCfs=0;
983    for (int TestDIdN=0; TestDIdN&lt;TestDocs; TestDIdN++){
984      int TestDId=TestDIdV[TestDIdN];
985      PBowSpV TestDocSpV=TestDocWgtBs-&gt;GetSpV(TestDId);
986      TFltIntKdV SimDIdKdV(TrainDocs, 0);
987      for (int TrainDIdN=0; TrainDIdN&lt;TrainDocs; TrainDIdN++){
988        int TrainDId=TrainDIdV[TrainDIdN];
989        PBowSpV TrainDocSpV=TrainDocWgtBs-&gt;GetSpV(TrainDId);
990        double Sim=BowSim-&gt;GetSim(TestDocSpV, TrainDocSpV);
991        SimDIdKdV.Add(TFltIntKd(Sim, TrainDId));
992      }
993      SimDIdKdV.Sort(false);
994      int Cats=BowDocBs-&gt;GetCats();
995      TFltV CatWgtV(Cats);
996      double SumCatWgt=0;
997      int NrKNbrs=TInt::GetMn(KNbrs, SimDIdKdV.Len());
998      for (int KNbrN=0; KNbrN&lt;NrKNbrs; KNbrN++){
999        int DId=SimDIdKdV[KNbrN].Dat;
1000        int DocCats=BowDocBs-&gt;GetDocCIds(DId);
1001        for (int DocCIdN=0; DocCIdN&lt;DocCats; DocCIdN++){
1002          int CId=BowDocBs-&gt;GetDocCId(DId, DocCIdN);
1003          double CatWgt=1/double(DocCats);
1004          CatWgtV[CId]+=CatWgt; SumCatWgt+=CatWgt;
1005        }
1006      }
1007      if (SumCatWgt&gt;0){
1008        for (int CId=0; CId&lt;Cats; CId++){
1009          CatWgtV[CId]=CatWgtV[CId]/SumCatWgt;
1010        }
1011      }
1012      int BestCId=CatWgtV.GetMxValN();
1013      if (BowDocBs-&gt;IsCatInDoc(TestDId, BestCId)){
1014        printf(&quot;+&quot;); CorrectCfs++;} else {printf(&quot;-&quot;);}
1015      AllCfs++;
1016    }
1017    double CfAcc=double(CorrectCfs)/AllCfs;
1018    TStr MsgStr=TStr(&quot;NNbr:&quot;)+TInt::GetStr(CorrectCfs)+&quot;/&quot;+
1019     TInt::GetStr(AllCfs)+&quot;=&quot;+TFlt::GetStr(CfAcc, &quot;%.3f&quot;);
1020    TNotify::OnNotify(Notify, ntInfo, MsgStr);
1021    return CfAcc;
1022  }
1023  double TBowClust::GetClustCfAcc(
1024   const PNotify&amp; Notify,
1025   const PBowDocBs&amp; BowDocBs, const PBowDocPart&amp; Part, const PBowSim&amp; BowSim,
1026   const TBowWordWgtType&amp; WordWgtType,
1027   const TIntV&amp; TrainDIdV, const TIntV&amp; TestDIdV){
1028    PBowDocWgtBs TrainDocWgtBs=
1029     TBowDocWgtBs::New(BowDocBs, WordWgtType, 0, 0, TrainDIdV);
1030    PBowDocWgtBs TestDocWgtBs=
1031     TBowDocWgtBs::New(BowDocBs, WordWgtType, 0, 0, TestDIdV, TrainDIdV);
1032    int TestDocs=TestDocWgtBs-&gt;GetDocs();
1033    int AllCfs=0; int CorrectCfs=0;
1034    for (int DIdN=0; DIdN&lt;TestDocs; DIdN++){
1035      int DId=TestDIdV[DIdN];
1036      PBowSpV DocSpV=TestDocWgtBs-&gt;GetSpV(DId);
1037      int BestCId=Part-&gt;GetBestCId(DocSpV, BowSim);
1038      if (BowDocBs-&gt;IsCatInDoc(DId, BestCId)){printf(&quot;+&quot;); CorrectCfs++;}
1039      else {printf(&quot;-&quot;);}
1040      AllCfs++;
1041    }
1042    double CfAcc=double(CorrectCfs)/AllCfs;
1043    TStr MsgStr=TStr(&quot;Clust:&quot;)+TInt::GetStr(CorrectCfs)+&quot;/&quot;+
1044     TInt::GetStr(AllCfs)+&quot;=&quot;+TFlt::GetStr(CfAcc, &quot;%.3f&quot;);
1045    TNotify::OnNotify(Notify, ntInfo, MsgStr);
1046    return CfAcc;
1047  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-bowbs.cpp</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from snap-MDEwOlJlcG9zaXRvcnk0Mjg4MzU3-flat-bowclust.cpp</div>
                </div>
                <div class="column column_space"><pre><code>906      double Sim=SimDIdKdV[OutDocN].Key;
907      int DId=SimDIdKdV[OutDocN].Dat;
908      TStr DocNm=BowDocBs-&gt;GetDocNm(DId);
</pre></code></div>
                <div class="column column_space"><pre><code>490          double WordWgt=WordWgtIdKdV[WIdN].Key;
491          int WId=WordWgtIdKdV[WIdN].Dat;
492          SOut-&gt;PutStr(BowDocBs-&gt;GetWordStr(WId), &quot;&lt;W Nm=\&quot;%s\&quot; &quot;);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    