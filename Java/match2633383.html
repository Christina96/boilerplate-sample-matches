<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for ExpressionToColumnIdentVisitor.java & FulltextITest.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for ExpressionToColumnIdentVisitor.java & FulltextITest.java
      </h3>
      <h1 align="center">
        8.6%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>ExpressionToColumnIdentVisitor.java (12.280702%)<TH>FulltextITest.java (6.6350713%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match2633383-0.html#0',2,'match2633383-1.html#0',3)" NAME="0">(24-40)<TD><A HREF="javascript:ZweiFrames('match2633383-0.html#0',2,'match2633383-1.html#0',3)" NAME="0">(27-45)</A><TD ALIGN=center><FONT COLOR="#ff0000">14</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>ExpressionToColumnIdentVisitor.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial agreement.
 */
<A NAME="0"></A>
package io.crate.analyze.expressions;

<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match2633383-1.html#0',3,'match2633383-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>import io.crate.metadata.ColumnIdent;
import io.crate.sql.tree.AstVisitor;
import io.crate.sql.tree.Node;
import io.crate.sql.tree.QualifiedNameReference;
import io.crate.sql.tree.StringLiteral;
import io.crate.sql.tree.SubscriptExpression;

import javax.annotation.Nullable;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

public class ExpressionToColumnIdentVisitor extends AstVisitor&lt;ColumnIdent, List&lt;String&gt;&gt; {

    private static final ExpressionToColumnIdentVisitor INSTANCE = new ExpressionToColumnIdentVisitor();

    privat</B></FONT>e ExpressionToColumnIdentVisitor() {
    }

    public static ColumnIdent convert(Node node) {
        return node.accept(INSTANCE, null);
    }

    @Override
    protected ColumnIdent visitQualifiedNameReference(QualifiedNameReference node, @Nullable List&lt;String&gt; context) {
        if (node.getName().getParts().size() &gt; 1) {
            throw new IllegalArgumentException(String.format(
                Locale.ENGLISH,
                &quot;Qualified name references are not allowed to contain paths ('%s')&quot;,
                node.getName().toString()
            ));
        }
        if (context != null) {
            return ColumnIdent.fromNameAndPathSafe(node.getName().toString(), context);
        }
        return ColumnIdent.fromNameSafe(node.getName().toString());
    }

    @Override
    protected ColumnIdent visitStringLiteral(StringLiteral node, List&lt;String&gt; context) {
        if (context == null) {
            // TopLevel doesn't allow string literals.
            throw new IllegalArgumentException(String.format(
                Locale.ENGLISH,
                &quot;String literal '%s' is not allowed as column identifier&quot;,
                node.getValue()
            ));
        }

        ColumnIdent.validateObjectKey(node.getValue());
        context.add(node.getValue());
        return null;
    }

    @Override
    protected ColumnIdent visitSubscriptExpression(SubscriptExpression node, List&lt;String&gt; context) {
        if (node.index() instanceof QualifiedNameReference) {
            throw new IllegalArgumentException(&quot;Key of subscript must not be a reference&quot;);
        }
        if (context == null) {
            context = new ArrayList&lt;&gt;();
        }
        ColumnIdent colIdent = node.base().accept(this, context);
        node.index().accept(this, context);


        return colIdent;
    }

    @Override
    protected ColumnIdent visitNode(Node node, List&lt;String&gt; context) {
        throw new UnsupportedOperationException(String.format(Locale.ENGLISH, &quot;Can't handle %s.&quot;, node));
    }
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>FulltextITest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial agreement.
 */

package io.crate.analysis.common;

<A NAME="0"></A>import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
import static io.crate.testing.Asserts.assertThrowsMatches;
import static io.crate.testing.SQLErrorMatcher.isSQLError;
<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match2633383-0.html#0',2,'match2633383-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>import static io.netty.handler.codec.http.HttpResponseStatus.BAD_REQUEST;
import static org.hamcrest.Matchers.is;

import java.util.ArrayList;
import java.util.Collection;

import org.elasticsearch.analysis.common.CommonAnalysisPlugin;
import org.elasticsearch.plugins.Plugin;
import org.junit.Test;

import io.crate.integrationtests.SQLIntegrationTestCase;
import io.crate.integrationtests.Setup;
import io.crate.testing.TestingHelpers;

public class FulltextITest extends SQLIntegrationTestCase{

    private Setup setup = new Setup(sqlExecutor);

    @Override</B></FONT>
    protected Collection&lt;Class&lt;? extends Plugin&gt;&gt; nodePlugins() {
        var plugins = new ArrayList&lt;&gt;(super.nodePlugins());
        plugins.add(CommonAnalysisPlugin.class);
        return plugins;
    }

    @Test
    public void testMatchOptions() throws Exception {
        this.setup.setUpLocationsWithFTIndex();
        refresh();

        execute(&quot;select name, _score from locations where match((kind, name_description_ft), 'galaxy') &quot; +
                &quot;using best_fields with (analyzer='english') order by _score desc&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()),
            is(&quot;End of the Galaxy| 0.74187315\n&quot; +
               &quot;Altair| 0.63013375\n&quot; +
               &quot;Outer Eastern Rim| 0.39226836\n&quot; +
               &quot;North West Ripple| 0.38249224\n&quot;));

        execute(&quot;select name, _score from locations where match((kind, name_description_ft), 'galaxy') &quot; +
                &quot;using best_fields with (fuzziness=0.5) order by _score desc&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()),
            is(&quot;End of the Galaxy| 0.74187315\n&quot; +
               &quot;Altair| 0.63013375\n&quot; +
               &quot;Outer Eastern Rim| 0.39226836\n&quot; +
               &quot;North West Ripple| 0.38249224\n&quot;));

        execute(&quot;select name, _score from locations where match((kind, name_description_ft), 'galay') &quot; +
                &quot;using best_fields with (fuzziness='AUTO') order by _score desc&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()),
                   is(&quot;End of the Galaxy| 0.5934985\n&quot; +
                      &quot;Altair| 0.504107\n&quot; +
                      &quot;Outer Eastern Rim| 0.3138147\n&quot; +
                      &quot;North West Ripple| 0.3059938\n&quot;)
        );

        execute(&quot;select name, _score from locations where match((kind, name_description_ft), 'gala') &quot; +
                &quot;using best_fields with (operator='or', minimum_should_match=2) order by _score desc&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()),
            is(&quot;&quot;));

        execute(&quot;select name, _score from locations where match((kind, name_description_ft), 'gala') &quot; +
                &quot;using phrase_prefix with (slop=1) order by _score desc&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()),
            is(&quot;Outer Eastern Rim| 1.1364496\n&quot; +
               &quot;Algol| 0.8532188\n&quot; +
               &quot;Galactic Sector QQ7 Active J Gamma| 0.7837707\n&quot; +
               &quot;End of the Galaxy| 0.74187315\n&quot; +
               &quot;Altair| 0.63013375\n&quot; +
               &quot;North West Ripple| 0.38249224\n&quot;));

        execute(&quot;select name, _score from locations where match((kind, name_description_ft), 'galaxy') &quot; +
                &quot;using phrase with (tie_breaker=1.0) order by _score desc&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()),
            is(&quot;End of the Galaxy| 0.74187315\n&quot; +
               &quot;Altair| 0.63013375\n&quot; +
               &quot;Outer Eastern Rim| 0.39226836\n&quot; +
               &quot;North West Ripple| 0.38249224\n&quot;));

        execute(&quot;select name, _score from locations where match((kind, name_description_ft), 'galaxy') &quot; +
                &quot;using best_fields with (zero_terms_query='all') order by _score desc&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()),
            is(&quot;End of the Galaxy| 0.74187315\n&quot; +
               &quot;Altair| 0.63013375\n&quot; +
               &quot;Outer Eastern Rim| 0.39226836\n&quot; +
               &quot;North West Ripple| 0.38249224\n&quot;));
    }

    @Test
    public void testMatchNotOnSubColumn() throws Exception {
        execute(&quot;create table matchbox (&quot; +
                &quot;  s string index using fulltext with (analyzer='german'),&quot; +
                &quot;  o object as (&quot; +
                &quot;    s string index using fulltext with (analyzer='german'),&quot; +
                &quot;    m string index using fulltext with (analyzer='german')&quot; +
                &quot;  ),&quot; +
                &quot;  o_ignored object(ignored)&quot; +
                &quot;) with (number_of_replicas=0)&quot;);
        execute(&quot;insert into matchbox (s, o) values ('Arthur Dent', {s='Zaphod Beeblebroox', m='Ford Prefect'})&quot;);
        refresh();
        execute(&quot;select * from matchbox where match(s, 'Arthur')&quot;);
        assertThat(response.rowCount(), is(1L));

        execute(&quot;select * from matchbox where match(o['s'], 'Arthur')&quot;);
        assertThat(response.rowCount(), is(0L));

        execute(&quot;select * from matchbox where match(o['s'], 'Zaphod')&quot;);
        assertThat(response.rowCount(), is(1L));

        execute(&quot;select * from matchbox where match(s, 'Zaphod')&quot;);
        assertThat(response.rowCount(), is(0L));

        execute(&quot;select * from matchbox where match(o['m'], 'Ford')&quot;);
        assertThat(response.rowCount(), is(1L));

        assertThrowsMatches(() -&gt; execute(&quot;select * from matchbox where match(o_ignored['a'], 'Ford')&quot;),
                     isSQLError(is(&quot;Can only use MATCH on columns of type STRING or GEO_SHAPE, not on 'undefined'&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000));
    }

    @Test
    public void testMatchTypes() throws Exception {
        this.setup.setUpLocationsWithFTIndex();
        refresh();

        execute(&quot;select name, _score from locations where match((kind 0.8, name_description_ft 0.6), 'planet earth') &quot; +
                &quot;using best_fields order by _score desc&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()),
            is(&quot;Alpha Centauri| 0.62114334\n&quot; +
               &quot;Bartledan| 0.45822048\n&quot; +
               &quot;| 0.2120642\n&quot; +
               &quot;Allosimanius Syneca| 0.1592113\n&quot; +
               &quot;Galactic Sector QQ7 Active J Gamma| 0.12744746\n&quot;));

        execute(&quot;select name, _score from locations where match((kind 0.6, name_description_ft 0.8), 'planet earth') using most_fields order by _score desc&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()),
            is(&quot;Alpha Centauri| 0.8281911\nBartledan| 0.6109606\n| 0.28275228\nAllosimanius Syneca| 0.21228172\nGalactic Sector QQ7 Active J Gamma| 0.16992995\n&quot;));

        execute(&quot;select name, _score from locations where match((kind 0.4, name_description_ft 1.0), 'planet earth') using cross_fields order by _score desc&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()),
            is(&quot;Alpha Centauri| 1.0352387\nBartledan| 0.7637007\n| 0.35344034\nAllosimanius Syneca| 0.26535213\nGalactic Sector QQ7 Active J Gamma| 0.21241242\n&quot;));

        execute(&quot;select name, _score from locations where match((kind 1.0, name_description_ft 0.4), 'Alpha Centauri') using phrase&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()),
            is(&quot;Alpha Centauri| 0.8281911\n&quot;));

        execute(&quot;select name, _score from locations where match(name_description_ft, 'Alpha Centauri') using phrase_prefix&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()),
            is(&quot;Alpha Centauri| 2.0704775\n&quot;));
    }

    @Test
    public void testSelectWhereMultiColumnMatchDifferentTypesDifferentScore() throws Exception {
        this.setup.setUpLocationsWithFTIndex();
        refresh();
        execute(&quot;select name, description, kind, _score from locations &quot; +
                &quot;where match((kind, name_description_ft 0.5), 'Planet earth') using most_fields with (analyzer='english') order by _score desc&quot;);
        assertThat(response.rowCount(), is(5L));
        assertThat(TestingHelpers.printedTable(response.rows()),
            is(&quot;Alpha Centauri| 4.1 light-years northwest of earth| Star System| 0.5176194\n&quot; +
               &quot;Bartledan| An Earthlike planet on which Arthur Dent lived for a short time, Bartledan is inhabited by Bartledanians, a race that appears human but only physically.| Planet| 0.38185036\n&quot; +
               &quot;| This Planet doesn't really exist| Planet| 0.17672017\n&quot; +
               &quot;Allosimanius Syneca| Allosimanius Syneca is a planet noted for ice, snow, mind-hurtling beauty and stunning cold.| Planet| 0.13267606\n&quot; +
               &quot;Galactic Sector QQ7 Active J Gamma| Galactic Sector QQ7 Active J Gamma contains the Sun Zarss, the planet Preliumtarn of the famed Sevorbeupstry and Quentulus Quazgar Mountains.| Galaxy| 0.10620621\n&quot;));

        execute(&quot;select name, description, kind, _score from locations &quot; +
                &quot;where match((kind, name_description_ft 0.5), 'Planet earth') using cross_fields order by _score desc&quot;);
        assertThat(response.rowCount(), is(5L));
        assertThat(TestingHelpers.printedTable(response.rows()),
            is(&quot;Alpha Centauri| 4.1 light-years northwest of earth| Star System| 1.0352387\n&quot; +
               &quot;Bartledan| An Earthlike planet on which Arthur Dent lived for a short time, Bartledan is inhabited by Bartledanians, a race that appears human but only physically.| Planet| 0.7637007\n&quot; +
               &quot;| This Planet doesn't really exist| Planet| 0.35344034\n&quot; +
               &quot;Allosimanius Syneca| Allosimanius Syneca is a planet noted for ice, snow, mind-hurtling beauty and stunning cold.| Planet| 0.26535213\n&quot; +
               &quot;Galactic Sector QQ7 Active J Gamma| Galactic Sector QQ7 Active J Gamma contains the Sun Zarss, the planet Preliumtarn of the famed Sevorbeupstry and Quentulus Quazgar Mountains.| Galaxy| 0.21241242\n&quot;));
    }

    @Test
    public void testSelectMatchAnd() throws Exception {
        execute(&quot;create table quotes (id int, quote string, &quot; +
                &quot;index quote_fulltext using fulltext(quote) with (analyzer='english')) with (number_of_replicas = 0)&quot;);
        execute(&quot;insert into quotes (id, quote) values (?, ?), (?, ?)&quot;,
            new Object[]{
                1, &quot;Would it save you a lot of time if I just gave up and went mad now?&quot;,
                2, &quot;Time is an illusion. Lunchtime doubly so&quot;}
        );
        execute(&quot;refresh table quotes&quot;);

        execute(&quot;select quote from quotes where match(quote_fulltext, 'time') and id = 1&quot;);
        assertEquals(1L, response.rowCount());
    }

    @Test
    public void testSimpleMatchWithBoost() throws Exception {
        execute(&quot;create table characters ( &quot; +
                &quot;  id int primary key, &quot; +
                &quot;  name string, &quot; +
                &quot;  quote string, &quot; +
                &quot;  INDEX name_ft using fulltext(name) with (analyzer = 'english'), &quot; +
                &quot;  INDEX quote_ft using fulltext(quote) with (analyzer = 'english') &quot; +
                &quot;) clustered into 5 shards &quot;);
        ensureYellow();
        execute(&quot;insert into characters (id, name, quote) values (?, ?, ?)&quot;, new Object[][]{
            new Object[]{1, &quot;Arthur&quot;, &quot;What a country. It's terribly small, tiny little country.&quot;},
            new Object[]{2, &quot;Trillian&quot;, &quot; No, it's a country. Off the coast of Africa.&quot;},
            new Object[]{3, &quot;Marvin&quot;, &quot; It won't work, I have an exceptionally large mind.&quot;}
        });
        refresh();
        execute(&quot;select characters.name AS characters_name, _score &quot; +
                &quot;from characters &quot; +
                &quot;where match(characters.quote_ft 2.0, 'country') order by _score desc&quot;);
        System.out.println(TestingHelpers.printedTable(response.rows()));
        assertThat(response.rows().length, is(2));
        assertThat(response.rows()[0][0], is(&quot;Arthur&quot;));
        assertThat(response.rows()[0][1], is(0.3596026F));
        assertThat(response.rows()[1][0], is(&quot;Trillian&quot;));
        assertThat(response.rows()[1][1], is(0.26152915F));
    }
}
</PRE>
</div>
  </div>
</body>
</html>
