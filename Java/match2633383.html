<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for ExpressionToColumnIdentVisitor.java &amp; FulltextITest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for ExpressionToColumnIdentVisitor.java &amp; FulltextITest.java
      </h3>
<h1 align="center">
        8.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>ExpressionToColumnIdentVisitor.java (12.280702%)<th>FulltextITest.java (6.6350713%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(24-40)<td><a href="#" name="0">(27-45)</a><td align="center"><font color="#ff0000">14</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>ExpressionToColumnIdentVisitor.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19  * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 <a name="0"></a>
22 package io.crate.analyze.expressions;
23 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import io.crate.metadata.ColumnIdent;
24 import io.crate.sql.tree.AstVisitor;
25 import io.crate.sql.tree.Node;
26 import io.crate.sql.tree.QualifiedNameReference;
27 import io.crate.sql.tree.StringLiteral;
28 import io.crate.sql.tree.SubscriptExpression;
29 import javax.annotation.Nullable;
30 import java.util.ArrayList;
31 import java.util.List;
32 import java.util.Locale;
33 public class ExpressionToColumnIdentVisitor extends AstVisitor&lt;ColumnIdent, List&lt;String&gt;&gt; {
34     private static final ExpressionToColumnIdentVisitor INSTANCE = new ExpressionToColumnIdentVisitor();
35     privat</b></font>e ExpressionToColumnIdentVisitor() {
36     }
37     public static ColumnIdent convert(Node node) {
38         return node.accept(INSTANCE, null);
39     }
40     @Override
41     protected ColumnIdent visitQualifiedNameReference(QualifiedNameReference node, @Nullable List&lt;String&gt; context) {
42         if (node.getName().getParts().size() &gt; 1) {
43             throw new IllegalArgumentException(String.format(
44                 Locale.ENGLISH,
45                 "Qualified name references are not allowed to contain paths ('%s')",
46                 node.getName().toString()
47             ));
48         }
49         if (context != null) {
50             return ColumnIdent.fromNameAndPathSafe(node.getName().toString(), context);
51         }
52         return ColumnIdent.fromNameSafe(node.getName().toString());
53     }
54     @Override
55     protected ColumnIdent visitStringLiteral(StringLiteral node, List&lt;String&gt; context) {
56         if (context == null) {
57             throw new IllegalArgumentException(String.format(
58                 Locale.ENGLISH,
59                 "String literal '%s' is not allowed as column identifier",
60                 node.getValue()
61             ));
62         }
63         ColumnIdent.validateObjectKey(node.getValue());
64         context.add(node.getValue());
65         return null;
66     }
67     @Override
68     protected ColumnIdent visitSubscriptExpression(SubscriptExpression node, List&lt;String&gt; context) {
69         if (node.index() instanceof QualifiedNameReference) {
70             throw new IllegalArgumentException("Key of subscript must not be a reference");
71         }
72         if (context == null) {
73             context = new ArrayList&lt;&gt;();
74         }
75         ColumnIdent colIdent = node.base().accept(this, context);
76         node.index().accept(this, context);
77         return colIdent;
78     }
79     @Override
80     protected ColumnIdent visitNode(Node node, List&lt;String&gt; context) {
81         throw new UnsupportedOperationException(String.format(Locale.ENGLISH, "Can't handle %s.", node));
82     }
83 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>FulltextITest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19  * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 package io.crate.analysis.common;
22 <a name="0"></a>import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
23 import static io.crate.testing.Asserts.assertThrowsMatches;
24 import static io.crate.testing.SQLErrorMatcher.isSQLError;
25 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import static io.netty.handler.codec.http.HttpResponseStatus.BAD_REQUEST;
26 import static org.hamcrest.Matchers.is;
27 import java.util.ArrayList;
28 import java.util.Collection;
29 import org.elasticsearch.analysis.common.CommonAnalysisPlugin;
30 import org.elasticsearch.plugins.Plugin;
31 import org.junit.Test;
32 import io.crate.integrationtests.SQLIntegrationTestCase;
33 import io.crate.integrationtests.Setup;
34 import io.crate.testing.TestingHelpers;
35 public class FulltextITest extends SQLIntegrationTestCase{
36     private Setup setup = new Setup(sqlExecutor);
37     @Override</b></font>
38     protected Collection&lt;Class&lt;? extends Plugin&gt;&gt; nodePlugins() {
39         var plugins = new ArrayList&lt;&gt;(super.nodePlugins());
40         plugins.add(CommonAnalysisPlugin.class);
41         return plugins;
42     }
43     @Test
44     public void testMatchOptions() throws Exception {
45         this.setup.setUpLocationsWithFTIndex();
46         refresh();
47         execute("select name, _score from locations where match((kind, name_description_ft), 'galaxy') " +
48                 "using best_fields with (analyzer='english') order by _score desc");
49         assertThat(TestingHelpers.printedTable(response.rows()),
50             is("End of the Galaxy| 0.74187315\n" +
51                "Altair| 0.63013375\n" +
52                "Outer Eastern Rim| 0.39226836\n" +
53                "North West Ripple| 0.38249224\n"));
54         execute("select name, _score from locations where match((kind, name_description_ft), 'galaxy') " +
55                 "using best_fields with (fuzziness=0.5) order by _score desc");
56         assertThat(TestingHelpers.printedTable(response.rows()),
57             is("End of the Galaxy| 0.74187315\n" +
58                "Altair| 0.63013375\n" +
59                "Outer Eastern Rim| 0.39226836\n" +
60                "North West Ripple| 0.38249224\n"));
61         execute("select name, _score from locations where match((kind, name_description_ft), 'galay') " +
62                 "using best_fields with (fuzziness='AUTO') order by _score desc");
63         assertThat(TestingHelpers.printedTable(response.rows()),
64                    is("End of the Galaxy| 0.5934985\n" +
65                       "Altair| 0.504107\n" +
66                       "Outer Eastern Rim| 0.3138147\n" +
67                       "North West Ripple| 0.3059938\n")
68         );
69         execute("select name, _score from locations where match((kind, name_description_ft), 'gala') " +
70                 "using best_fields with (operator='or', minimum_should_match=2) order by _score desc");
71         assertThat(TestingHelpers.printedTable(response.rows()),
72             is(""));
73         execute("select name, _score from locations where match((kind, name_description_ft), 'gala') " +
74                 "using phrase_prefix with (slop=1) order by _score desc");
75         assertThat(TestingHelpers.printedTable(response.rows()),
76             is("Outer Eastern Rim| 1.1364496\n" +
77                "Algol| 0.8532188\n" +
78                "Galactic Sector QQ7 Active J Gamma| 0.7837707\n" +
79                "End of the Galaxy| 0.74187315\n" +
80                "Altair| 0.63013375\n" +
81                "North West Ripple| 0.38249224\n"));
82         execute("select name, _score from locations where match((kind, name_description_ft), 'galaxy') " +
83                 "using phrase with (tie_breaker=1.0) order by _score desc");
84         assertThat(TestingHelpers.printedTable(response.rows()),
85             is("End of the Galaxy| 0.74187315\n" +
86                "Altair| 0.63013375\n" +
87                "Outer Eastern Rim| 0.39226836\n" +
88                "North West Ripple| 0.38249224\n"));
89         execute("select name, _score from locations where match((kind, name_description_ft), 'galaxy') " +
90                 "using best_fields with (zero_terms_query='all') order by _score desc");
91         assertThat(TestingHelpers.printedTable(response.rows()),
92             is("End of the Galaxy| 0.74187315\n" +
93                "Altair| 0.63013375\n" +
94                "Outer Eastern Rim| 0.39226836\n" +
95                "North West Ripple| 0.38249224\n"));
96     }
97     @Test
98     public void testMatchNotOnSubColumn() throws Exception {
99         execute("create table matchbox (" +
100                 "  s string index using fulltext with (analyzer='german')," +
101                 "  o object as (" +
102                 "    s string index using fulltext with (analyzer='german')," +
103                 "    m string index using fulltext with (analyzer='german')" +
104                 "  )," +
105                 "  o_ignored object(ignored)" +
106                 ") with (number_of_replicas=0)");
107         execute("insert into matchbox (s, o) values ('Arthur Dent', {s='Zaphod Beeblebroox', m='Ford Prefect'})");
108         refresh();
109         execute("select * from matchbox where match(s, 'Arthur')");
110         assertThat(response.rowCount(), is(1L));
111         execute("select * from matchbox where match(o['s'], 'Arthur')");
112         assertThat(response.rowCount(), is(0L));
113         execute("select * from matchbox where match(o['s'], 'Zaphod')");
114         assertThat(response.rowCount(), is(1L));
115         execute("select * from matchbox where match(s, 'Zaphod')");
116         assertThat(response.rowCount(), is(0L));
117         execute("select * from matchbox where match(o['m'], 'Ford')");
118         assertThat(response.rowCount(), is(1L));
119         assertThrowsMatches(() -&gt; execute("select * from matchbox where match(o_ignored['a'], 'Ford')"),
120                      isSQLError(is("Can only use MATCH on columns of type STRING or GEO_SHAPE, not on 'undefined'"),
121                                 INTERNAL_ERROR,
122                                 BAD_REQUEST,
123                                 4000));
124     }
125     @Test
126     public void testMatchTypes() throws Exception {
127         this.setup.setUpLocationsWithFTIndex();
128         refresh();
129         execute("select name, _score from locations where match((kind 0.8, name_description_ft 0.6), 'planet earth') " +
130                 "using best_fields order by _score desc");
131         assertThat(TestingHelpers.printedTable(response.rows()),
132             is("Alpha Centauri| 0.62114334\n" +
133                "Bartledan| 0.45822048\n" +
134                "| 0.2120642\n" +
135                "Allosimanius Syneca| 0.1592113\n" +
136                "Galactic Sector QQ7 Active J Gamma| 0.12744746\n"));
137         execute("select name, _score from locations where match((kind 0.6, name_description_ft 0.8), 'planet earth') using most_fields order by _score desc");
138         assertThat(TestingHelpers.printedTable(response.rows()),
139             is("Alpha Centauri| 0.8281911\nBartledan| 0.6109606\n| 0.28275228\nAllosimanius Syneca| 0.21228172\nGalactic Sector QQ7 Active J Gamma| 0.16992995\n"));
140         execute("select name, _score from locations where match((kind 0.4, name_description_ft 1.0), 'planet earth') using cross_fields order by _score desc");
141         assertThat(TestingHelpers.printedTable(response.rows()),
142             is("Alpha Centauri| 1.0352387\nBartledan| 0.7637007\n| 0.35344034\nAllosimanius Syneca| 0.26535213\nGalactic Sector QQ7 Active J Gamma| 0.21241242\n"));
143         execute("select name, _score from locations where match((kind 1.0, name_description_ft 0.4), 'Alpha Centauri') using phrase");
144         assertThat(TestingHelpers.printedTable(response.rows()),
145             is("Alpha Centauri| 0.8281911\n"));
146         execute("select name, _score from locations where match(name_description_ft, 'Alpha Centauri') using phrase_prefix");
147         assertThat(TestingHelpers.printedTable(response.rows()),
148             is("Alpha Centauri| 2.0704775\n"));
149     }
150     @Test
151     public void testSelectWhereMultiColumnMatchDifferentTypesDifferentScore() throws Exception {
152         this.setup.setUpLocationsWithFTIndex();
153         refresh();
154         execute("select name, description, kind, _score from locations " +
155                 "where match((kind, name_description_ft 0.5), 'Planet earth') using most_fields with (analyzer='english') order by _score desc");
156         assertThat(response.rowCount(), is(5L));
157         assertThat(TestingHelpers.printedTable(response.rows()),
158             is("Alpha Centauri| 4.1 light-years northwest of earth| Star System| 0.5176194\n" +
159                "Bartledan| An Earthlike planet on which Arthur Dent lived for a short time, Bartledan is inhabited by Bartledanians, a race that appears human but only physically.| Planet| 0.38185036\n" +
160                "| This Planet doesn't really exist| Planet| 0.17672017\n" +
161                "Allosimanius Syneca| Allosimanius Syneca is a planet noted for ice, snow, mind-hurtling beauty and stunning cold.| Planet| 0.13267606\n" +
162                "Galactic Sector QQ7 Active J Gamma| Galactic Sector QQ7 Active J Gamma contains the Sun Zarss, the planet Preliumtarn of the famed Sevorbeupstry and Quentulus Quazgar Mountains.| Galaxy| 0.10620621\n"));
163         execute("select name, description, kind, _score from locations " +
164                 "where match((kind, name_description_ft 0.5), 'Planet earth') using cross_fields order by _score desc");
165         assertThat(response.rowCount(), is(5L));
166         assertThat(TestingHelpers.printedTable(response.rows()),
167             is("Alpha Centauri| 4.1 light-years northwest of earth| Star System| 1.0352387\n" +
168                "Bartledan| An Earthlike planet on which Arthur Dent lived for a short time, Bartledan is inhabited by Bartledanians, a race that appears human but only physically.| Planet| 0.7637007\n" +
169                "| This Planet doesn't really exist| Planet| 0.35344034\n" +
170                "Allosimanius Syneca| Allosimanius Syneca is a planet noted for ice, snow, mind-hurtling beauty and stunning cold.| Planet| 0.26535213\n" +
171                "Galactic Sector QQ7 Active J Gamma| Galactic Sector QQ7 Active J Gamma contains the Sun Zarss, the planet Preliumtarn of the famed Sevorbeupstry and Quentulus Quazgar Mountains.| Galaxy| 0.21241242\n"));
172     }
173     @Test
174     public void testSelectMatchAnd() throws Exception {
175         execute("create table quotes (id int, quote string, " +
176                 "index quote_fulltext using fulltext(quote) with (analyzer='english')) with (number_of_replicas = 0)");
177         execute("insert into quotes (id, quote) values (?, ?), (?, ?)",
178             new Object[]{
179                 1, "Would it save you a lot of time if I just gave up and went mad now?",
180                 2, "Time is an illusion. Lunchtime doubly so"}
181         );
182         execute("refresh table quotes");
183         execute("select quote from quotes where match(quote_fulltext, 'time') and id = 1");
184         assertEquals(1L, response.rowCount());
185     }
186     @Test
187     public void testSimpleMatchWithBoost() throws Exception {
188         execute("create table characters ( " +
189                 "  id int primary key, " +
190                 "  name string, " +
191                 "  quote string, " +
192                 "  INDEX name_ft using fulltext(name) with (analyzer = 'english'), " +
193                 "  INDEX quote_ft using fulltext(quote) with (analyzer = 'english') " +
194                 ") clustered into 5 shards ");
195         ensureYellow();
196         execute("insert into characters (id, name, quote) values (?, ?, ?)", new Object[][]{
197             new Object[]{1, "Arthur", "What a country. It's terribly small, tiny little country."},
198             new Object[]{2, "Trillian", " No, it's a country. Off the coast of Africa."},
199             new Object[]{3, "Marvin", " It won't work, I have an exceptionally large mind."}
200         });
201         refresh();
202         execute("select characters.name AS characters_name, _score " +
203                 "from characters " +
204                 "where match(characters.quote_ft 2.0, 'country') order by _score desc");
205         System.out.println(TestingHelpers.printedTable(response.rows()));
206         assertThat(response.rows().length, is(2));
207         assertThat(response.rows()[0][0], is("Arthur"));
208         assertThat(response.rows()[0][1], is(0.3596026F));
209         assertThat(response.rows()[1][0], is("Trillian"));
210         assertThat(response.rows()[1][1], is(0.26152915F));
211     }
212 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
