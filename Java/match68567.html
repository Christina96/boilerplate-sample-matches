<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for FunctionsTest.java &amp; MapMakerInternalMapTest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for FunctionsTest.java &amp; MapMakerInternalMapTest.java
      </h3>
<h1 align="center">
        31.2%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>FunctionsTest.java (48.16587%)<th>MapMakerInternalMapTest.java (23.124043%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(194-206)<td><a href="#" name="0">(494-506)</a><td align="center"><font color="#ff0000">20</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(119-127)<td><a href="#" name="1">(293-310)</a><td align="center"><font color="#f20000">19</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(309-322)<td><a href="#" name="2">(343-355)</a><td align="center"><font color="#e50000">18</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(286-299)<td><a href="#" name="3">(810-827)</a><td align="center"><font color="#e50000">18</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(139-146)<td><a href="#" name="4">(366-385)</a><td align="center"><font color="#d80000">17</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(53-61)<td><a href="#" name="5">(108-122)</a><td align="center"><font color="#bf0000">15</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(231-244)<td><a href="#" name="6">(604-612)</a><td align="center"><font color="#b20000">14</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(88-96)<td><a href="#" name="7">(272-279)</a><td align="center"><font color="#b20000">14</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(395-401)<td><a href="#" name="8">(316-325)</a><td align="center"><font color="#a50000">13</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(246-255)<td><a href="#" name="9">(453-464)</a><td align="center"><font color="#a50000">13</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(19-37)<td><a href="#" name="10">(20-34)</a><td align="center"><font color="#a50000">13</font>
<tr onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b041ff"><font color="#b041ff">-</font><td><a href="#" name="11">(343-349)<td><a href="#" name="11">(671-679)</a><td align="center"><font color="#990000">12</font>
<tr onclick='openModal("#571b7e")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#571b7e"><font color="#571b7e">-</font><td><a href="#" name="12">(128-138)<td><a href="#" name="12">(689-696)</a><td align="center"><font color="#990000">12</font>
<tr onclick='openModal("#3b9c9c")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3b9c9c"><font color="#3b9c9c">-</font><td><a href="#" name="13">(41-48)<td><a href="#" name="13">(192-199)</a><td align="center"><font color="#990000">12</font>
<tr onclick='openModal("#842dce")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#842dce"><font color="#842dce">-</font><td><a href="#" name="14">(337-342)<td><a href="#" name="14">(432-438)</a><td align="center"><font color="#8c0000">11</font>
<tr onclick='openModal("#f52887")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f52887"><font color="#f52887">-</font><td><a href="#" name="15">(323-328)<td><a href="#" name="15">(54-59)</a><td align="center"><font color="#8c0000">11</font>
<tr onclick='openModal("#2981b2")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#2981b2"><font color="#2981b2">-</font><td><a href="#" name="16">(176-183)<td><a href="#" name="16">(238-246)</a><td align="center"><font color="#8c0000">11</font>
<tr onclick='openModal("#3090c7")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3090c7"><font color="#3090c7">-</font><td><a href="#" name="17">(161-168)<td><a href="#" name="17">(223-230)</a><td align="center"><font color="#8c0000">11</font>
<tr onclick='openModal("#800517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#800517"><font color="#800517">-</font><td><a href="#" name="18">(112-118)<td><a href="#" name="18">(393-399)</a><td align="center"><font color="#8c0000">11</font>
<tr onclick='openModal("#f62817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f62817"><font color="#f62817">-</font><td><a href="#" name="19">(184-192)<td><a href="#" name="19">(466-471)</a><td align="center"><font color="#7f0000">10</font>
<tr onclick='openModal("#4e9258")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4e9258"><font color="#4e9258">-</font><td><a href="#" name="20">(448-451)<td><a href="#" name="20">(167-176)</a><td align="center"><font color="#720000">9</font>
<tr onclick='openModal("#947010")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#947010"><font color="#947010">-</font><td><a href="#" name="21">(349-356)<td><a href="#" name="21">(478-488)</a><td align="center"><font color="#720000">9</font>
<tr onclick='openModal("#4cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4cc417"><font color="#4cc417">-</font><td><a href="#" name="22">(258-267)<td><a href="#" name="22">(555-561)</a><td align="center"><font color="#720000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>FunctionsTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <a name="10"></a>
2 package com.google.common.base;
3 <font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import com.google.common.annotations.GwtCompatible;
4 import com.google.common.annotations.GwtIncompatible;
5 import com.google.common.collect.ImmutableMap;
6 import com.google.common.collect.Maps;
7 import com.google.common.testing.ClassSanityTester;
8 import com.google.common.testing.EqualsTester;
9 import com.google.common.testing.NullPointerTester;
10 import com.google.common.testing.SerializableTester;
11 import java.io.Serializable;
12 import java.util.Map;
13 import junit.framework.TestCase;
14 @</b></font>GwtCompatible(emulated = true)
15 <a name="13"></a>public class FunctionsTest extends TestCase {
16   public void testIdentity_same() {
17     Function&lt;String, String&gt; identity = <font color="#3b9c9c"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Functions.identity();
18     assertNull(identity.apply(null));
19     assertSame("foo", identity.apply("foo"));
20   }
21   public void testIdentity_notSame() {
22     Function&lt;Long, Long&gt; identity = Functions.identity();
23     assertNotSame</b></font>(new Long(135135L), identity.apply(new Long(135135L)));
24   }
25 <a name="5"></a>
26   @GwtIncompatible   public void testIdentitySerializable() {
27     <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>checkCanReserializeSingleton(Functions.identity());
28   }
29   public void testToStringFunction_apply() {
30     assertEquals("3", Functions.toStringFunction().apply(3));
31     assertEquals("hiya", Functions.toStringFunction().apply("hiya"));
32     assertEquals(
33         "I'm a string",
34         Functions.toStringFunction</b></font>()
35             .apply(
36                 new Object() {
37                   @Override
38                   public String toString() {
39                     return "I'm a string";
40                   }
41                 }));
42     try {
43       Functions.toStringFunction().apply(null);
44       fail("expected NullPointerException");
45     } catch (NullPointerException expected) {
46     }
47   }
48   @GwtIncompatible   public void testToStringFunctionSerializable() {
49     checkCanReserializeSingleton(Functions.toStringFunction());
50   }
51   @GwtIncompatible   public void testNullPointerExceptions() {
52     NullPointerTester tester = new NullPointerTester();
53     tester.testAllPublicStaticMethods(Functions.class);
54 <a name="7"></a>  }
55   public void testForMapWithoutDefault() {
56     Map&lt;String, Integer&gt; map = <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Maps.newHashMap();
57     map.put("One", 1);
58     map.put("Three", 3);
59     map.put("Null", null);
60     Function&lt;String, Integer&gt; function = Functions.forMap(map);
61     assertEquals(1, function.apply("One").intValue());
62     assertEquals(3, function.apply("Three").intValue());
63     assertNull(function.apply</b></font>("Null"));
64     try {
65       function.apply("Two");
66       fail();
67     } catch (IllegalArgumentException expected) {
68     }
69     new EqualsTester()
70         .addEqualityGroup(function, Functions.forMap(map))
71         .addEqualityGroup(Functions.forMap(map, 42))
72         .testEquals();
73   }
74 <a name="18"></a>
75   @GwtIncompatible   public void testForMapWithoutDefaultSerializable() {
76     <font color="#800517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>checkCanReserialize(Functions.forMap(ImmutableMap.of(1, 2)));
77   }
78   public void testForMapWithDefault() {
79 <a name="1"></a>    Map&lt;String, Integer&gt; map = Maps.newHashMap();
80     map.put("One", 1);
81     map.put</b></font>("Three", 3);
82     <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>map.put("Null", null);
83     Function&lt;String, Integer&gt; function = Functions.forMap(map, 42);
84     assertEquals(1, function.apply("One").intValue());
85     assertEquals(42, function.apply("Two").intValue());
86     assertEquals(3, function.apply("Three").intValue());
87 <a name="12"></a>    assertNull(function.apply("Null"));
88     new EqualsTester()</b></font>
89         .addEqualityGroup(function, <font color="#571b7e"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Functions.forMap(map, 42))
90         .addEqualityGroup(Functions.forMap(map))
91         .addEqualityGroup(Functions.forMap(map, null))
92         .addEqualityGroup(Functions.forMap(map, 43))
93         .testEquals();
94   }
95   @GwtIncompatible <a name="4"></a>  public void testForMapWithDefault_includeSerializable() {
96     Map&lt;String, Integer&gt; map = Maps.newHashMap();
97     map.put</b></font>("One", 1);
98     <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>map.put("Three", 3);
99     Function&lt;String, Integer&gt; function = Functions.forMap(map, 42);
100     assertEquals(1, function.apply("One").intValue());
101     assertEquals(42, function.apply("Two").intValue());
102     assertEquals(3, function.apply("Three").intValue());
103     new EqualsTester()</b></font>
104         .addEqualityGroup(
105             function, Functions.forMap(map, 42), SerializableTester.reserialize(function))
106         .addEqualityGroup(Functions.forMap(map))
107         .addEqualityGroup(Functions.forMap(map, null))
108         .addEqualityGroup(Functions.forMap(map, 43))
109         .testEquals();
110   }
111   @GwtIncompatible   public void testForMapWithDefaultSerializable() {
112     checkCanReserialize(Functions.forMap(ImmutableMap.of(1, 2), 3));
113 <a name="17"></a>  }
114   public void testForMapWithDefault_null() {
115     <font color="#3090c7"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>ImmutableMap&lt;String, Integer&gt; map = ImmutableMap.of("One", 1);
116     Function&lt;String, Integer&gt; function = Functions.forMap(map, null);
117     assertEquals((Integer) 1, function.apply("One"));
118     assertNull(function.apply("Two"));
119     new EqualsTester()</b></font>
120         .addEqualityGroup(function)
121         .addEqualityGroup(Functions.forMap(map, 1))
122         .testEquals();
123   }
124 <a name="16"></a>
125   @GwtIncompatible   public void testForMapWithDefault_null_compareWithSerializable() {
126     <font color="#2981b2"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>ImmutableMap&lt;String, Integer&gt; map = ImmutableMap.of("One", 1);
127     Function&lt;String, Integer&gt; function = Functions.forMap(map, null);
128     assertEquals((Integer) 1, function.apply("One"));
129     assertNull(function.apply("Two"));
130 <a name="19"></a>
131     new EqualsTester()</b></font>
132         .addEqualityGroup(function, <font color="#f62817"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>SerializableTester.reserialize(function))
133         .addEqualityGroup(Functions.forMap(map, 1))
134         .testEquals();
135   }
136   public void testForMapWildCardWithDefault() {
137     Map&lt;String, Integer&gt; map = Maps.newHashMap();
138 <a name="0"></a>    map.put("One", 1);
139     map.put</b></font>("Three", 3);
140     Number number = Double.valueOf(42);
141     Function&lt;String, Number&gt; function = <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Functions.forMap(map, number);
142     assertEquals(1, function.apply("One").intValue());
143     assertEquals(number, function.apply("Two"));
144     assertEquals(3L, function.apply("Three").longValue());
145   }
146   public void testComposition() {
147     Map&lt;String, Integer&gt; mJapaneseToInteger = Maps.newHashMap();
148     mJapaneseToInteger.put("Ichi", 1);
149     mJapaneseToInteger.put("Ni", 2);
150     mJapaneseToInteger.put("San", 3);
151     Function&lt;String, Integer&gt; japaneseToInteger = Functions.forMap</b></font>(mJapaneseToInteger);
152     Map&lt;Integer, String&gt; mIntegerToSpanish = Maps.newHashMap();
153     mIntegerToSpanish.put(1, "Uno");
154     mIntegerToSpanish.put(3, "Tres");
155     mIntegerToSpanish.put(4, "Cuatro");
156     Function&lt;Integer, String&gt; integerToSpanish = Functions.forMap(mIntegerToSpanish);
157     Function&lt;String, String&gt; japaneseToSpanish =
158         Functions.compose(integerToSpanish, japaneseToInteger);
159     assertEquals("Uno", japaneseToSpanish.apply("Ichi"));
160     try {
161       japaneseToSpanish.apply("Ni");
162       fail();
163     } catch (IllegalArgumentException e) {
164     }
165     assertEquals("Tres", japaneseToSpanish.apply("San"));
166     try {
167       japaneseToSpanish.apply("Shi");
168       fail();
169     } catch (IllegalArgumentException e) {
170 <a name="6"></a>    }
171     new EqualsTester()
172         .addEqualityGroup(japaneseToSpanish, <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Functions.compose(integerToSpanish, japaneseToInteger))
173         .addEqualityGroup(japaneseToInteger)
174         .addEqualityGroup(integerToSpanish)
175         .addEqualityGroup(Functions.compose(japaneseToInteger, integerToSpanish))
176         .testEquals();
177   }
178   @GwtIncompatible   public void testComposition_includeReserializabled() {
179     Map&lt;String, Integer&gt; mJapaneseToInteger = Maps.newHashMap();
180     mJapaneseToInteger.put("Ichi", 1);
181     mJapaneseToInteger.put("Ni", 2);
182 <a name="9"></a>    mJapaneseToInteger.put("San", 3);
183     Function&lt;String, Integer&gt; japaneseToInteger = Functions.forMap</b></font>(mJapaneseToInteger);
184     Map&lt;Integer, String&gt; mIntegerToSpanish = <font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Maps.newHashMap();
185     mIntegerToSpanish.put(1, "Uno");
186     mIntegerToSpanish.put(3, "Tres");
187     mIntegerToSpanish.put(4, "Cuatro");
188     Function&lt;Integer, String&gt; integerToSpanish = Functions.forMap(mIntegerToSpanish);
189     Function&lt;String, String&gt; japaneseToSpanish =
190         Functions.compose(integerToSpanish, japaneseToInteger);
191 <a name="22"></a>    new EqualsTester()</b></font>
192         .addEqualityGroup(
193             japaneseToSpanish,
194             <font color="#4cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Functions.compose(integerToSpanish, japaneseToInteger),
195             SerializableTester.reserialize(japaneseToSpanish))
196         .addEqualityGroup(japaneseToInteger)
197         .addEqualityGroup(integerToSpanish)
198         .addEqualityGroup(Functions.compose(japaneseToInteger, integerToSpanish))
199         .testEquals();
200   }
201   public void testCompositionWildcard() {
202     Map&lt;String, Integer&gt; mapJapaneseToInteger = Maps.newHashMap</b></font>();
203     Function&lt;String, Integer&gt; japaneseToInteger = Functions.forMap(mapJapaneseToInteger);
204     Function&lt;Object, String&gt; numberToSpanish = Functions.constant("Yo no se");
205     Function&lt;String, String&gt; japaneseToSpanish =
206         Functions.compose(numberToSpanish, japaneseToInteger);
207   }
208   private static class HashCodeFunction implements Function&lt;Object, Integer&gt; {
209     @Override
210     public Integer apply(Object o) {
211       return (o == null) ? 0 : o.hashCode();
212     }
213   }
214 <a name="3"></a>  public void testComposeOfFunctionsIsAssociative() {
215     Map&lt;Float, String&gt; m = ImmutableMap.of(4.0f, "A", 3.0f, "B", 2.0f, "C", 1.0f, "D");
216     Function&lt;? super Integer, Boolean&gt; h = Functions.constant(Boolean.TRUE);
217     <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Function&lt;? super String, Integer&gt; g = new HashCodeFunction();
218     Function&lt;Float, String&gt; f = Functions.forMap(m, "F");
219     Function&lt;Float, Boolean&gt; c1 = Functions.compose(Functions.compose(h, g), f);
220     Function&lt;Float, Boolean&gt; c2 = Functions.compose(h, Functions.compose(g, f));
221     assertEquals(c1.hashCode(), c2.hashCode());
222     assertEquals(c1.apply(1.0f), c2.apply(1.0f));
223     assertEquals(c1.apply</b></font>(5.0f), c2.apply(5.0f));
224   }
225   public void testComposeOfPredicateAndFunctionIsAssociative() {
226     Map&lt;Float, String&gt; m = ImmutableMap.of(4.0f, "A", 3.0f, "B", 2.0f, "C", 1.0f, "D");
227     Predicate&lt;? super Integer&gt; h = Predicates.equalTo(42);
228     Function&lt;? super String, Integer&gt; g = new HashCodeFunction();
229 <a name="2"></a>    Function&lt;Float, String&gt; f = Functions.forMap(m, "F");
230     Predicate&lt;Float&gt; p1 = Predicates.compose(Predicates.compose(h, g), f);
231     Predicate&lt;Float&gt; p2 = <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Predicates.compose(h, Functions.compose(g, f));
232     assertEquals(p1.hashCode(), p2.hashCode());
233     assertEquals(p1.apply(1.0f), p2.apply(1.0f));
234     assertEquals(p1.apply(5.0f), p2.apply(5.0f));
235   }
236 <a name="15"></a>
237   public void testForPredicate() {
238     Function&lt;Object, Boolean&gt; alwaysTrue = Functions.forPredicate(Predicates.alwaysTrue</b></font>());
239     <font color="#f52887"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Function&lt;Object, Boolean&gt; alwaysFalse = Functions.forPredicate(Predicates.alwaysFalse());
240     assertTrue(alwaysTrue.apply(0));
241     assertFalse(alwaysFalse.apply(0));
242     new EqualsTester()</b></font>
243         .addEqualityGroup(alwaysTrue, Functions.forPredicate(Predicates.alwaysTrue()))
244         .addEqualityGroup(alwaysFalse)
245         .addEqualityGroup(Functions.identity())
246         .testEquals();
247   }
248 <a name="14"></a>
249   @GwtIncompatible   public void testForPredicateSerializable() {
250     <font color="#842dce"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>checkCanReserialize(Functions.forPredicate(Predicates.equalTo(5)));
251   }
252 <a name="11"></a>  public void testConstant() {
253     Function&lt;Object, Object&gt; f = Functions.&lt;Object&gt;constant("correct");
254     assertEquals("correct", f.apply</b></font>(new Object()));
255     <font color="#b041ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertEquals("correct", f.apply(null));
256     Function&lt;Object, String&gt; g = Functions.constant(null);
257 <a name="21"></a>    assertEquals(null, g.apply(2));
258     assertEquals(null, g.apply(null));
259     <font color="#947010"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>new EqualsTester()</b></font>
260         .addEqualityGroup(f, Functions.constant("correct"))
261         .addEqualityGroup(Functions.constant("incorrect"))
262         .addEqualityGroup(Functions.toStringFunction())
263         .addEqualityGroup(g)
264         .testEquals();
265     new EqualsTester()</b></font>
266         .addEqualityGroup(g, Functions.constant(null))
267         .addEqualityGroup(Functions.constant("incorrect"))
268         .addEqualityGroup(Functions.toStringFunction())
269         .addEqualityGroup(f)
270         .testEquals();
271   }
272   @GwtIncompatible   public void testConstantSerializable() {
273     checkCanReserialize(Functions.constant(5));
274   }
275   private static class CountingSupplier implements Supplier&lt;Integer&gt;, Serializable {
276     private static final long serialVersionUID = 0;
277     private int value;
278     @Override
279     public Integer get() {
280       return ++value;
281     }
282     @Override
283     public boolean equals(Object obj) {
284       if (obj instanceof CountingSupplier) {
285         return this.value == ((CountingSupplier) obj).value;
286       }
287       return false;
288     }
289     @Override
290     public int hashCode() {
291       return value;
292     }
293 <a name="8"></a>  }
294   public void testForSupplier() {
295     <font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Supplier&lt;Integer&gt; supplier = new CountingSupplier();
296     Function&lt;Object, Integer&gt; function = Functions.forSupplier(supplier);
297     assertEquals(1, (int) function.apply(null));
298     assertEquals(2, (int) function.apply("foo"));
299     new EqualsTester()</b></font>
300         .addEqualityGroup(function, Functions.forSupplier(supplier))
301         .addEqualityGroup(Functions.forSupplier(new CountingSupplier()))
302         .addEqualityGroup(Functions.forSupplier(Suppliers.ofInstance(12)))
303         .addEqualityGroup(Functions.toStringFunction())
304         .testEquals();
305   }
306   @GwtIncompatible   public void testForSupplierSerializable() {
307     checkCanReserialize(Functions.forSupplier(new CountingSupplier()));
308   }
309   @GwtIncompatible   public void testNulls() throws Exception {
310     new ClassSanityTester().forAllPublicStaticMethods(Functions.class).testNulls();
311   }
312   @GwtIncompatible   @AndroidIncompatible   public void testEqualsAndSerializable() throws Exception {
313     new ClassSanityTester().forAllPublicStaticMethods(Functions.class).testEqualsAndSerializable();
314   }
315   @GwtIncompatible   private static &lt;Y&gt; void checkCanReserialize(Function&lt;? super Integer, Y&gt; f) {
316     Function&lt;? super Integer, Y&gt; g = SerializableTester.reserializeAndAssert(f);
317     for (int i = 1; i &lt; 5; i++) {
318       Y expected = null;
319       try {
320         expected = f.apply(i);
321       } catch (IllegalArgumentException e) {
322         try {
323           g.apply(i);
324           fail();
325         } catch (IllegalArgumentException ok) {
326           continue;
327         }
328       }
329       assertEquals(expected, g.apply(i));
330     }
331   }
332 <a name="20"></a>
333   @GwtIncompatible   private static &lt;Y&gt; void checkCanReserializeSingleton(Function&lt;? super String, Y&gt; f) {
334     Function&lt;? super String, Y&gt; g = <font color="#4e9258"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>SerializableTester.reserializeAndAssert(f);
335     assertSame(f, g);
336     for (Integer i = 1; i &lt; 5; i++) {
337       assertEquals(f.apply(i.toString()), g.apply</b></font>(i.toString()));
338     }
339   }
340 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>MapMakerInternalMapTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Copyright (C) 2011 The Guava Authors
3  *
4  * Licensed under the Apache License, Version 2.0 (the "License");
5  * you may not use this file except in compliance with the License.
6  * You may obtain a copy of the License at
7  *
8  * http://www.apache.org/licenses/LICENSE-2.0
9  *
10  * Unless required by applicable law or agreed to in writing, software
11  * distributed under the License is distributed on an "AS IS" BASIS,
12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
13  * See the License for the specific language governing permissions and
14  * limitations under the License.
15  */
16 <a name="10"></a>package com.google.common.collect;
17 import static com.google.common.collect.MapMakerInternalMap.DRAIN_THRESHOLD;
18 <font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import static com.google.common.truth.Truth.assertThat;
19 import com.google.common.base.Equivalence;
20 import com.google.common.collect.MapMakerInternalMap.InternalEntry;
21 import com.google.common.collect.MapMakerInternalMap.Segment;
22 import com.google.common.collect.MapMakerInternalMap.Strength;
23 import com.google.common.collect.MapMakerInternalMap.WeakValueEntry;
24 import com.google.common.collect.MapMakerInternalMap.WeakValueReference;
25 import com.google.common.testing.NullPointerTester;
26 import java.lang.ref.Reference;
27 import java.util.concurrent.atomic.AtomicReferenceArray;
28 import junit.framework.TestCase;
29 @</b></font>SuppressWarnings("deprecation") public class MapMakerInternalMapTest extends TestCase {
30   static final int SMALL_MAX_SIZE = DRAIN_THRESHOLD * 5;
31   private static &lt;K, V&gt;
32       MapMakerInternalMap&lt;K, V, ? extends InternalEntry&lt;K, V, ?&gt;, ? extends Segment&lt;K, V, ?, ?&gt;&gt;
33           makeMap(MapMaker maker) {
34     return MapMakerInternalMap.create(maker);
35   }
36   private static MapMaker createMapMaker() {
37     MapMaker maker = new MapMaker();
38     maker.useCustomMap = true;
39     return maker;
40   }
41 <a name="15"></a>  
42   public void testDefaults() {
43     <font color="#f52887"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map = makeMap(createMapMaker());
44     assertSame(Strength.STRONG, map.keyStrength());
45     assertSame(Strength.STRONG, map.valueStrength());
46     assertSame(map.keyStrength().defaultEquivalence(), map.keyEquivalence);
47     assertSame</b></font>(map.valueStrength().defaultEquivalence(), map.valueEquivalence());
48     assertThat(map.entryHelper)
49         .isInstanceOf(MapMakerInternalMap.StrongKeyStrongValueEntry.Helper.class);
50     assertEquals(4, map.concurrencyLevel);
51     assertThat(map.segments).hasLength(4);
52     assertEquals(16 / map.segments.length, map.segments[0].table.length());
53   }
54   public void testSetKeyEquivalence() {
55     Equivalence&lt;Object&gt; testEquivalence =
56         new Equivalence&lt;Object&gt;() {
57           @Override
58           protected boolean doEquivalent(Object a, Object b) {
59             return false;
60           }
61           @Override
62           protected int doHash(Object t) {
63             return 0;
64           }
65         };
66     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
67         makeMap(createMapMaker().keyEquivalence(testEquivalence));
68     assertSame(testEquivalence, map.keyEquivalence);
69     assertSame(map.valueStrength().defaultEquivalence(), map.valueEquivalence());
70   }
71   public void testSetConcurrencyLevel() {
72     checkConcurrencyLevel(1, 1);
73     checkConcurrencyLevel(2, 2);
74     checkConcurrencyLevel(3, 4);
75     checkConcurrencyLevel(4, 4);
76     checkConcurrencyLevel(5, 8);
77     checkConcurrencyLevel(6, 8);
78     checkConcurrencyLevel(7, 8);
79     checkConcurrencyLevel(8, 8);
80   }
81 <a name="5"></a>  private static void checkConcurrencyLevel(int concurrencyLevel, int segmentCount) {
82     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
83         makeMap(createMapMaker().concurrencyLevel(concurrencyLevel));
84     <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertThat(map.segments).hasLength(segmentCount);
85   }
86   public void testSetInitialCapacity() {
87     checkInitialCapacity(1, 0, 1);
88     checkInitialCapacity(1, 1, 1);
89     checkInitialCapacity(1, 2, 2);
90     checkInitialCapacity(1, 3, 4);
91     checkInitialCapacity(1, 4, 4);
92     checkInitialCapacity(1, 5, 8);
93     checkInitialCapacity(1, 6, 8);
94     checkInitialCapacity(1, 7, 8);
95     checkInitialCapacity</b></font>(1, 8, 8);
96     checkInitialCapacity(2, 0, 1);
97     checkInitialCapacity(2, 1, 1);
98     checkInitialCapacity(2, 2, 1);
99     checkInitialCapacity(2, 3, 2);
100     checkInitialCapacity(2, 4, 2);
101     checkInitialCapacity(2, 5, 4);
102     checkInitialCapacity(2, 6, 4);
103     checkInitialCapacity(2, 7, 4);
104     checkInitialCapacity(2, 8, 4);
105     checkInitialCapacity(4, 0, 1);
106     checkInitialCapacity(4, 1, 1);
107     checkInitialCapacity(4, 2, 1);
108     checkInitialCapacity(4, 3, 1);
109     checkInitialCapacity(4, 4, 1);
110     checkInitialCapacity(4, 5, 2);
111     checkInitialCapacity(4, 6, 2);
112     checkInitialCapacity(4, 7, 2);
113     checkInitialCapacity(4, 8, 2);
114   }
115   private static void checkInitialCapacity(
116       int concurrencyLevel, int initialCapacity, int segmentSize) {
117     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
118         makeMap(
119             createMapMaker().concurrencyLevel(concurrencyLevel).initialCapacity(initialCapacity));
120     for (int i = 0; i &lt; map.segments.length; i++) {
121       assertEquals(segmentSize, map.segments[i].table.length());
122     }
123   }
124   public void testSetMaximumSize() {
125     for (int maxSize = 1; maxSize &lt; 8; maxSize++) {
126       checkMaximumSize(1, 8, maxSize);
127       checkMaximumSize(2, 8, maxSize);
128       checkMaximumSize(4, 8, maxSize);
129       checkMaximumSize(8, 8, maxSize);
130     }
131 <a name="20"></a>
132     checkMaximumSize(1, 8, Integer.MAX_VALUE);
133     checkMaximumSize(2, 8, Integer.MAX_VALUE);
134     <font color="#4e9258"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>checkMaximumSize(4, 8, Integer.MAX_VALUE);
135     checkMaximumSize(8, 8, Integer.MAX_VALUE);
136     for (int capacity = 0; capacity &lt; 8; capacity++) {
137       checkMaximumSize(1, capacity, 4);
138       checkMaximumSize(2, capacity, 4);
139       checkMaximumSize(4, capacity, 4);
140       checkMaximumSize</b></font>(8, capacity, 4);
141     }
142   }
143   private static void checkMaximumSize(int concurrencyLevel, int initialCapacity, int maxSize) {
144     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
145         makeMap(
146             createMapMaker().concurrencyLevel(concurrencyLevel).initialCapacity(initialCapacity));
147     int totalCapacity = 0;
148     for (int i = 0; i &lt; map.segments.length; i++) {
149       totalCapacity += map.segments[i].maxSegmentSize;
150     }
151     assertTrue("totalCapcity=" + totalCapacity + ", maxSize=" + maxSize, totalCapacity &lt;= maxSize);
152 <a name="13"></a>  }
153   public void testSetWeakKeys() {
154     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map = makeMap(<font color="#3b9c9c"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>createMapMaker().weakKeys());
155     checkStrength(map, Strength.WEAK, Strength.STRONG);
156     assertThat(map.entryHelper)
157         .isInstanceOf(MapMakerInternalMap.WeakKeyStrongValueEntry.Helper.class);
158   }
159   public void testSetWeakValues() {
160     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map = makeMap(createMapMaker().weakValues</b></font>());
161     checkStrength(map, Strength.STRONG, Strength.WEAK);
162     assertThat(map.entryHelper)
163         .isInstanceOf(MapMakerInternalMap.StrongKeyWeakValueEntry.Helper.class);
164   }
165   private static void checkStrength(
166       MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map, Strength keyStrength, Strength valueStrength) {
167     assertSame(keyStrength, map.keyStrength());
168     assertSame(valueStrength, map.valueStrength());
169     assertSame(keyStrength.defaultEquivalence(), map.keyEquivalence);
170     assertSame(valueStrength.defaultEquivalence(), map.valueEquivalence());
171   }
172   public void testNewEntry() {
173     for (MapMaker maker : allWeakValueStrengthMakers()) {
174       MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map = makeMap(maker);
175       Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
176 <a name="17"></a>      Object keyOne = new Object();
177       Object valueOne = new Object();
178       int hashOne = map.hash(keyOne);
179       <font color="#3090c7"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>InternalEntry&lt;Object, Object, ?&gt; entryOne = segment.newEntryForTesting(keyOne, hashOne, null);
180       WeakValueReference&lt;Object, Object, ?&gt; valueRefOne =
181           segment.newWeakValueReferenceForTesting(entryOne, valueOne);
182       assertSame(valueOne, valueRefOne.get());
183       segment.setWeakValueReferenceForTesting(entryOne, valueRefOne);
184       assertSame(keyOne, entryOne.getKey());
185       assertEquals(hashOne, entryOne.getHash</b></font>());
186       assertNull(entryOne.getNext());
187       assertSame(valueRefOne, segment.getWeakValueReferenceForTesting(entryOne));
188       Object keyTwo = new Object();
189 <a name="16"></a>      Object valueTwo = new Object();
190       int hashTwo = map.hash(keyTwo);
191       <font color="#2981b2"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>InternalEntry&lt;Object, Object, ?&gt; entryTwo =
192           segment.newEntryForTesting(keyTwo, hashTwo, entryOne);
193       WeakValueReference&lt;Object, Object, ?&gt; valueRefTwo =
194           segment.newWeakValueReferenceForTesting(entryTwo, valueTwo);
195       assertSame(valueTwo, valueRefTwo.get());
196       segment.setWeakValueReferenceForTesting(entryTwo, valueRefTwo);
197       assertSame(keyTwo, entryTwo.getKey());
198       assertEquals(hashTwo, entryTwo.getHash</b></font>());
199       assertSame(entryOne, entryTwo.getNext());
200       assertSame(valueRefTwo, segment.getWeakValueReferenceForTesting(entryTwo));
201     }
202   }
203   public void testCopyEntry() {
204     for (MapMaker maker : allWeakValueStrengthMakers()) {
205       MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map = makeMap(maker);
206       Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
207       Object keyOne = new Object();
208       Object valueOne = new Object();
209       int hashOne = map.hash(keyOne);
210       InternalEntry&lt;Object, Object, ?&gt; entryOne = segment.newEntryForTesting(keyOne, hashOne, null);
211       segment.setValueForTesting(entryOne, valueOne);
212       Object keyTwo = new Object();
213       Object valueTwo = new Object();
214       int hashTwo = map.hash(keyTwo);
215       InternalEntry&lt;Object, Object, ?&gt; entryTwo = segment.newEntryForTesting(keyTwo, hashTwo, null);
216       segment.setValueForTesting(entryTwo, valueTwo);
217 <a name="7"></a>      InternalEntry&lt;Object, Object, ?&gt; copyOne = segment.copyForTesting(entryOne, null);
218       assertSame(keyOne, entryOne.getKey());
219       assertEquals(hashOne, entryOne.getHash());
220       <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertNull(entryOne.getNext());
221       assertSame(valueOne, copyOne.getValue());
222       InternalEntry&lt;Object, Object, ?&gt; copyTwo = segment.copyForTesting(entryTwo, copyOne);
223       assertSame(keyTwo, copyTwo.getKey());
224       assertEquals(hashTwo, copyTwo.getHash());
225       assertSame(copyOne, copyTwo.getNext());
226       assertSame(valueTwo, copyTwo.getValue</b></font>());
227     }
228   }
229   public void testSegmentGetAndContains() {
230     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
231         makeMap(createMapMaker().concurrencyLevel(1).weakValues());
232     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
233     Object key = new Object();
234 <a name="1"></a>    int hash = map.hash(key);
235     Object value = new Object();
236     AtomicReferenceArray&lt;? extends InternalEntry&lt;Object, Object, ?&gt;&gt; table = segment.table;
237     int index = hash &amp; (<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>table.length() - 1);
238     InternalEntry&lt;Object, Object, ?&gt; entry = segment.newEntryForTesting(key, hash, null);
239     segment.setValueForTesting(entry, value);
240     assertNull(segment.get(key, hash));
241     segment.setTableEntryForTesting(index, entry);
242     assertNull(segment.get(key, hash));
243     assertFalse(segment.containsKey(key, hash));
244     assertFalse(segment.containsValue(value));
245     segment.count++;
246     assertSame(value, segment.get(key, hash));
247     assertTrue(segment.containsKey(key, hash));
248     assertTrue(segment.containsValue</b></font>(value));
249     assertNull(segment.get(new Object(), hash));
250 <a name="8"></a>
251     InternalEntry&lt;Object, Object, ?&gt; nullEntry = segment.newEntryForTesting(null, hash, entry);
252     <font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>Object nullValue = new Object();
253     WeakValueReference&lt;Object, Object, ?&gt; nullValueRef =
254         segment.newWeakValueReferenceForTesting(nullEntry, nullValue);
255     segment.setWeakValueReferenceForTesting(nullEntry, nullValueRef);
256     segment.setTableEntryForTesting(index, nullEntry);
257     assertSame(value, segment.get(key, hash));
258     assertTrue(segment.containsKey(key, hash));
259     assertTrue(segment.containsValue(value));
260     assertFalse</b></font>(segment.containsValue(nullValue));
261     InternalEntry&lt;Object, Object, ?&gt; dummyEntry =
262         segment.newEntryForTesting(new Object(), hash, entry);
263     Object dummyValue = new Object();
264     WeakValueReference&lt;Object, Object, ?&gt; dummyValueRef =
265         segment.newWeakValueReferenceForTesting(dummyEntry, dummyValue);
266     segment.setWeakValueReferenceForTesting(dummyEntry, dummyValueRef);
267     segment.setTableEntryForTesting(index, dummyEntry);
268     assertSame(value, segment.get(key, hash));
269     assertTrue(segment.containsKey(key, hash));
270     assertTrue(segment.containsValue(value));
271     assertTrue(segment.containsValue(dummyValue));
272 <a name="2"></a>        dummyEntry = segment.newEntryForTesting(key, hash, entry);
273     dummyValue = new Object();
274     dummyValueRef = <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>segment.newWeakValueReferenceForTesting(dummyEntry, dummyValue);
275     segment.setWeakValueReferenceForTesting(dummyEntry, dummyValueRef);
276     segment.setTableEntryForTesting(index, dummyEntry);
277     assertSame(dummyValue, segment.get(key, hash));
278     assertTrue(segment.containsKey(key, hash));
279     assertTrue(segment.containsValue(value));
280     assertTrue(segment.containsValue(dummyValue));
281   }
282   public void testSegmentReplaceValue() {
283     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
284         makeMap(createMapMaker().concurrencyLevel(1).weakValues</b></font>());
285     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
286     Object key = new Object();
287     int hash = map.hash(key);
288     Object oldValue = new Object();
289     Object newValue = new Object();
290 <a name="4"></a>    AtomicReferenceArray&lt;? extends InternalEntry&lt;Object, Object, ?&gt;&gt; table = segment.table;
291     int index = hash &amp; (table.length() - 1);
292     InternalEntry&lt;Object, Object, ?&gt; entry = <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>segment.newEntryForTesting(key, hash, null);
293     WeakValueReference&lt;Object, Object, ?&gt; oldValueRef =
294         segment.newWeakValueReferenceForTesting(entry, oldValue);
295     segment.setWeakValueReferenceForTesting(entry, oldValueRef);
296     assertFalse(segment.replace(key, hash, oldValue, newValue));
297     assertEquals(0, segment.count);
298     segment.setTableEntryForTesting(index, entry);
299     segment.count++;
300     assertEquals(1, segment.count);
301     assertSame(oldValue, segment.get(key, hash));
302     assertTrue(segment.replace(key, hash, oldValue, newValue));
303     assertEquals(1, segment.count);
304     assertSame(newValue, segment.get(key, hash));
305     assertFalse</b></font>(segment.replace(key, hash, oldValue, newValue));
306     assertEquals(1, segment.count);
307     assertSame(newValue, segment.get(key, hash));
308 <a name="18"></a>    segment.setWeakValueReferenceForTesting(entry, oldValueRef);
309     oldValueRef.clear();
310     assertFalse(segment.replace(key, hash, oldValue, newValue));
311     <font color="#800517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(0, segment.count);
312     assertNull(segment.get(key, hash));
313   }
314   public void testSegmentReplace() {
315     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
316         makeMap(createMapMaker().concurrencyLevel</b></font>(1).weakValues());
317     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
318     Object key = new Object();
319     int hash = map.hash(key);
320     Object oldValue = new Object();
321     Object newValue = new Object();
322     AtomicReferenceArray&lt;? extends InternalEntry&lt;Object, Object, ?&gt;&gt; table = segment.table;
323     int index = hash &amp; (table.length() - 1);
324     InternalEntry&lt;Object, Object, ?&gt; entry = segment.newEntryForTesting(key, hash, null);
325     WeakValueReference&lt;Object, Object, ?&gt; oldValueRef =
326         segment.newWeakValueReferenceForTesting(entry, oldValue);
327     segment.setWeakValueReferenceForTesting(entry, oldValueRef);
328     assertNull(segment.replace(key, hash, newValue));
329     assertEquals(0, segment.count);
330     segment.setTableEntryForTesting(index, entry);
331     segment.count++;
332     assertEquals(1, segment.count);
333     assertSame(oldValue, segment.get(key, hash));
334     assertSame(oldValue, segment.replace(key, hash, newValue));
335     assertEquals(1, segment.count);
336     assertSame(newValue, segment.get(key, hash));
337 <a name="14"></a>    segment.setWeakValueReferenceForTesting(entry, oldValueRef);
338     oldValueRef.clear();
339     assertNull(segment.replace(key, hash, newValue));
340     <font color="#842dce"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(0, segment.count);
341     assertNull(segment.get(key, hash));
342   }
343   public void testSegmentPut() {
344     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
345         makeMap(createMapMaker().concurrencyLevel</b></font>(1).weakValues());
346     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
347     Object key = new Object();
348     int hash = map.hash(key);
349     Object oldValue = new Object();
350     Object newValue = new Object();
351     assertEquals(0, segment.count);
352     assertNull(segment.put(key, hash, oldValue, false));
353 <a name="9"></a>    assertEquals(1, segment.count);
354     assertSame(oldValue, <font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>segment.put(key, hash, newValue, false));
355     assertEquals(1, segment.count);
356     assertSame(newValue, segment.get(key, hash));
357     InternalEntry&lt;Object, Object, ?&gt; entry = segment.getEntry(key, hash);
358     WeakValueReference&lt;Object, Object, ?&gt; oldValueRef =
359         segment.newWeakValueReferenceForTesting(entry, oldValue);
360     segment.setWeakValueReferenceForTesting(entry, oldValueRef);
361     assertSame(oldValue, segment.get(key, hash));
362 <a name="19"></a>    oldValueRef.clear();
363     assertNull</b></font>(segment.put(key, hash, newValue, false));
364     assertEquals(1, segment.count);
365     <font color="#f62817"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertSame(newValue, segment.get(key, hash));
366   }
367   public void testSegmentPutIfAbsent() {
368     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
369         makeMap(createMapMaker().concurrencyLevel</b></font>(1).weakValues());
370     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
371 <a name="21"></a>    Object key = new Object();
372     int hash = map.hash(key);
373     Object oldValue = new Object();
374     Object newValue = <font color="#947010"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>new Object();
375     assertEquals(0, segment.count);
376     assertNull(segment.put(key, hash, oldValue, true));
377     assertEquals(1, segment.count);
378     assertSame(oldValue, segment.put(key, hash, newValue, true));
379     assertEquals(1, segment.count);
380     assertSame</b></font>(oldValue, segment.get(key, hash));
381 <a name="0"></a>    InternalEntry&lt;Object, Object, ?&gt; entry = segment.getEntry(key, hash);
382     WeakValueReference&lt;Object, Object, ?&gt; oldValueRef =
383         segment.newWeakValueReferenceForTesting(entry, oldValue);
384     <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>segment.setWeakValueReferenceForTesting(entry, oldValueRef);
385     assertSame(oldValue, segment.get(key, hash));
386     oldValueRef.clear();
387     assertNull(segment.put(key, hash, newValue, true));
388     assertEquals(1, segment.count);
389     assertSame(newValue, segment.get(key, hash));
390   }
391   public void testSegmentPut_expand() {
392     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
393         makeMap(createMapMaker().concurrencyLevel(1).initialCapacity(1));
394     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
395     assertEquals</b></font>(1, segment.table.length());
396     int count = 1024;
397     for (int i = 0; i &lt; count; i++) {
398       Object key = new Object();
399       Object value = new Object();
400       int hash = map.hash(key);
401       assertNull(segment.put(key, hash, value, false));
402       assertTrue(segment.table.length() &gt; i);
403     }
404   }
405   public void testSegmentRemove() {
406     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
407         makeMap(createMapMaker().concurrencyLevel(1).weakValues());
408     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
409     Object key = new Object();
410     int hash = map.hash(key);
411     Object oldValue = new Object();
412     AtomicReferenceArray&lt;? extends InternalEntry&lt;Object, Object, ?&gt;&gt; table = segment.table;
413     int index = hash &amp; (table.length() - 1);
414     InternalEntry&lt;Object, Object, ?&gt; entry = segment.newEntryForTesting(key, hash, null);
415     WeakValueReference&lt;Object, Object, ?&gt; oldValueRef =
416         segment.newWeakValueReferenceForTesting(entry, oldValue);
417     segment.setWeakValueReferenceForTesting(entry, oldValueRef);
418     assertEquals(0, segment.count);
419     assertNull(segment.remove(key, hash));
420     assertEquals(0, segment.count);
421     segment.setTableEntryForTesting(index, entry);
422     segment.count++;
423     assertEquals(1, segment.count);
424     assertSame(oldValue, segment.get(key, hash));
425     assertSame(oldValue, segment.remove(key, hash));
426     assertEquals(0, segment.count);
427     assertNull(segment.get(key, hash));
428     segment.setTableEntryForTesting(index, entry);
429     segment.count++;
430     assertEquals(1, segment.count);
431 <a name="22"></a>    assertSame(oldValue, segment.get(key, hash));
432     oldValueRef.clear();
433     assertNull(segment.remove(key, hash));
434     <font color="#4cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(0, segment.count);
435     assertNull(segment.get(key, hash));
436   }
437   public void testSegmentRemoveValue() {
438     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
439         makeMap</b></font>(createMapMaker().concurrencyLevel(1).weakValues());
440     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
441     Object key = new Object();
442     int hash = map.hash(key);
443     Object oldValue = new Object();
444     Object newValue = new Object();
445     AtomicReferenceArray&lt;? extends InternalEntry&lt;Object, Object, ?&gt;&gt; table = segment.table;
446     int index = hash &amp; (table.length() - 1);
447     InternalEntry&lt;Object, Object, ?&gt; entry = segment.newEntryForTesting(key, hash, null);
448     WeakValueReference&lt;Object, Object, ?&gt; oldValueRef =
449         segment.newWeakValueReferenceForTesting(entry, oldValue);
450     segment.setWeakValueReferenceForTesting(entry, oldValueRef);
451     assertEquals(0, segment.count);
452     assertNull(segment.remove(key, hash));
453     assertEquals(0, segment.count);
454     segment.setTableEntryForTesting(index, entry);
455     segment.count++;
456     assertEquals(1, segment.count);
457     assertSame(oldValue, segment.get(key, hash));
458     assertTrue(segment.remove(key, hash, oldValue));
459     assertEquals(0, segment.count);
460     assertNull(segment.get(key, hash));
461     segment.setTableEntryForTesting(index, entry);
462     segment.count++;
463     assertEquals(1, segment.count);
464     assertSame(oldValue, segment.get(key, hash));
465     assertFalse(segment.remove(key, hash, newValue));
466     assertEquals(1, segment.count);
467     assertSame(oldValue, segment.get(key, hash));
468     assertSame(oldValue, segment.get(key, hash));
469 <a name="6"></a>    oldValueRef.clear();
470     assertFalse(segment.remove(key, hash, oldValue));
471     assertEquals(0, segment.count);
472     <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertNull(segment.get(key, hash));
473   }
474   @SuppressWarnings("GuardedBy")
475   public void testExpand() {
476     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
477         makeMap(createMapMaker().concurrencyLevel(1).initialCapacity(1));
478     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
479     assertEquals</b></font>(1, segment.table.length());
480     int originalCount = 1024;
481     InternalEntry&lt;Object, Object, ?&gt; entry = null;
482     for (int i = 0; i &lt; originalCount; i++) {
483       Object key = new Object();
484       Object value = new Object();
485       int hash = map.hash(key);
486       entry = segment.newEntryForTesting(key, hash, entry);
487       segment.setValueForTesting(entry, value);
488     }
489     segment.setTableEntryForTesting(0, entry);
490     segment.count = originalCount;
491     ImmutableMap&lt;Object, Object&gt; originalMap = ImmutableMap.copyOf(map);
492     assertEquals(originalCount, originalMap.size());
493     assertEquals(originalMap, map);
494     for (int i = 1; i &lt;= originalCount * 2; i *= 2) {
495       if (i &gt; 1) {
496         segment.expand();
497       }
498       assertEquals(i, segment.table.length());
499       assertEquals(originalCount, countLiveEntries(map));
500       assertEquals(originalCount, segment.count);
501       assertEquals(originalMap, map);
502     }
503   }
504   public void testRemoveFromChain() {
505     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map = makeMap(createMapMaker().concurrencyLevel(1));
506     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
507     Object keyOne = new Object();
508     Object valueOne = new Object();
509     int hashOne = map.hash(keyOne);
510     InternalEntry&lt;Object, Object, ?&gt; entryOne = segment.newEntryForTesting(keyOne, hashOne, null);
511     segment.setValueForTesting(entryOne, valueOne);
512     Object keyTwo = new Object();
513     Object valueTwo = new Object();
514     int hashTwo = map.hash(keyTwo);
515     InternalEntry&lt;Object, Object, ?&gt; entryTwo =
516         segment.newEntryForTesting(keyTwo, hashTwo, entryOne);
517     segment.setValueForTesting(entryTwo, valueTwo);
518     Object keyThree = new Object();
519     Object valueThree = new Object();
520     int hashThree = map.hash(keyThree);
521     InternalEntry&lt;Object, Object, ?&gt; entryThree =
522         segment.newEntryForTesting(keyThree, hashThree, entryTwo);
523     segment.setValueForTesting(entryThree, valueThree);
524 <a name="11"></a>    assertNull(segment.removeFromChainForTesting(entryOne, entryOne));
525     <font color="#b041ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertSame(entryOne, segment.removeFromChainForTesting(entryTwo, entryTwo));
526     InternalEntry&lt;Object, Object, ?&gt; newFirst =
527         segment.removeFromChainForTesting(entryThree, entryTwo);
528     assertSame(keyThree, newFirst.getKey());
529     assertSame(valueThree, newFirst.getValue());
530     assertEquals(hashThree, newFirst.getHash());
531     assertSame(entryOne, newFirst.getNext</b></font>());
532     newFirst = segment.removeFromChainForTesting(entryThree, entryOne);
533     assertSame(keyTwo, newFirst.getKey());
534     assertSame(valueTwo, newFirst.getValue());
535     assertEquals(hashTwo, newFirst.getHash());
536 <a name="12"></a>    newFirst = newFirst.getNext();
537     assertSame(keyThree, newFirst.getKey());
538     assertSame(valueThree, newFirst.getValue());
539     <font color="#571b7e"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(hashThree, newFirst.getHash());
540     assertNull(newFirst.getNext());
541   }
542   @SuppressWarnings("GuardedBy")
543   public void testExpand_cleanup() {
544     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
545         makeMap(createMapMaker().concurrencyLevel(1).initialCapacity</b></font>(1));
546     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
547     assertEquals(1, segment.table.length());
548     int originalCount = 1024;
549     InternalEntry&lt;Object, Object, ?&gt; entry = null;
550     for (int i = 0; i &lt; originalCount; i++) {
551       Object key = new Object();
552       Object value = (i % 3 == 0) ? null : new Object();
553       int hash = map.hash(key);
554       if (i % 3 == 1) {
555         key = null;
556       }
557       entry = segment.newEntryForTesting(key, hash, entry);
558       segment.setValueForTesting(entry, value);
559     }
560     segment.setTableEntryForTesting(0, entry);
561     segment.count = originalCount;
562     int liveCount = originalCount / 3;
563     assertEquals(1, segment.table.length());
564     assertEquals(liveCount, countLiveEntries(map));
565     ImmutableMap&lt;Object, Object&gt; originalMap = ImmutableMap.copyOf(map);
566     assertEquals(liveCount, originalMap.size());
567     for (int i = 1; i &lt;= originalCount * 2; i *= 2) {
568       if (i &gt; 1) {
569         segment.expand();
570       }
571       assertEquals(i, segment.table.length());
572       assertEquals(liveCount, countLiveEntries(map));
573       assertTrue(segment.count &gt;= liveCount);
574       assertTrue(segment.count &lt;= originalCount);
575       assertEquals(originalMap, ImmutableMap.copyOf(map));
576     }
577   }
578   private static &lt;K, V&gt; int countLiveEntries(MapMakerInternalMap&lt;K, V, ?, ?&gt; map) {
579     int result = 0;
580     for (Segment&lt;K, V, ?, ?&gt; segment : map.segments) {
581       AtomicReferenceArray&lt;? extends InternalEntry&lt;K, V, ?&gt;&gt; table = segment.table;
582       for (int i = 0; i &lt; table.length(); i++) {
583         for (InternalEntry&lt;K, V, ?&gt; e = table.get(i); e != null; e = e.getNext()) {
584           if (map.isLiveForTesting(e)) {
585             result++;
586           }
587         }
588       }
589     }
590     return result;
591   }
592   public void testClear() {
593     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
594         makeMap(createMapMaker().concurrencyLevel(1).initialCapacity(1));
595     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
596     AtomicReferenceArray&lt;? extends InternalEntry&lt;Object, Object, ?&gt;&gt; table = segment.table;
597     assertEquals(1, table.length());
598     Object key = new Object();
599     Object value = new Object();
600     int hash = map.hash(key);
601     InternalEntry&lt;Object, Object, ?&gt; entry = segment.newEntryForTesting(key, hash, null);
602     segment.setValueForTesting(entry, value);
603     segment.setTableEntryForTesting(0, entry);
604     segment.readCount.incrementAndGet();
605     segment.count = 1;
606     assertSame(entry, table.get(0));
607     segment.clear();
608     assertNull(table.get(0));
609     assertEquals(0, segment.readCount.get());
610     assertEquals(0, segment.count);
611   }
612   public void testRemoveEntry() {
613     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
614         makeMap(createMapMaker().concurrencyLevel(1).initialCapacity(1));
615     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
616     AtomicReferenceArray&lt;? extends InternalEntry&lt;Object, Object, ?&gt;&gt; table = segment.table;
617     assertEquals(1, table.length());
618     Object key = new Object();
619     Object value = new Object();
620     int hash = map.hash(key);
621     InternalEntry&lt;Object, Object, ?&gt; entry = segment.newEntryForTesting(key, hash, null);
622     segment.setValueForTesting(entry, value);
623     assertFalse(segment.removeTableEntryForTesting(entry));
624     segment.setTableEntryForTesting(0, entry);
625     segment.count = 1;
626     assertTrue(segment.removeTableEntryForTesting(entry));
627     assertEquals(0, segment.count);
628     assertNull(table.get(0));
629   }
630   public void testClearValue() {
631     MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map =
632         makeMap(createMapMaker().concurrencyLevel(1).initialCapacity(1).weakValues());
633     Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
634     AtomicReferenceArray&lt;? extends InternalEntry&lt;Object, Object, ?&gt;&gt; table = segment.table;
635 <a name="3"></a>    assertEquals(1, table.length());
636     Object key = new Object();
637     <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>Object value = new Object();
638     int hash = map.hash(key);
639     InternalEntry&lt;Object, Object, ?&gt; entry = segment.newEntryForTesting(key, hash, null);
640     segment.setValueForTesting(entry, value);
641     WeakValueReference&lt;Object, Object, ?&gt; valueRef = segment.getWeakValueReferenceForTesting(entry);
642     assertFalse(segment.clearValueForTesting(key, hash, valueRef));
643     segment.setTableEntryForTesting(0, entry);
644     assertTrue(segment.clearValueForTesting(key, hash, valueRef));
645     assertEquals(0, segment.count);
646     assertNull(table.get(0));
647     segment.setTableEntryForTesting</b></font>(0, entry);
648     WeakValueReference&lt;Object, Object, ?&gt; otherValueRef =
649         segment.newWeakValueReferenceForTesting(entry, value);
650     segment.setWeakValueReferenceForTesting(entry, otherValueRef);
651     assertFalse(segment.clearValueForTesting(key, hash, valueRef));
652     segment.setWeakValueReferenceForTesting(entry, valueRef);
653     assertTrue(segment.clearValueForTesting(key, hash, valueRef));
654   }
655   public void testDrainKeyReferenceQueueOnWrite() {
656     for (MapMaker maker : allWeakKeyStrengthMakers()) {
657       MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map = makeMap(maker.concurrencyLevel(1));
658       if (maker.getKeyStrength() == Strength.WEAK) {
659         Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
660         Object keyOne = new Object();
661         int hashOne = map.hash(keyOne);
662         Object valueOne = new Object();
663         Object keyTwo = new Object();
664         Object valueTwo = new Object();
665         map.put(keyOne, valueOne);
666         InternalEntry&lt;Object, Object, ?&gt; entry = segment.getEntry(keyOne, hashOne);
667         @SuppressWarnings("unchecked")
668         Reference&lt;Object&gt; reference = (Reference&lt;Object&gt;) entry;
669         reference.enqueue();
670         map.put(keyTwo, valueTwo);
671         assertFalse(map.containsKey(keyOne));
672         assertFalse(map.containsValue(valueOne));
673         assertNull(map.get(keyOne));
674         assertEquals(1, map.size());
675         assertNull(segment.getKeyReferenceQueueForTesting().poll());
676       }
677     }
678   }
679   public void testDrainValueReferenceQueueOnWrite() {
680     for (MapMaker maker : allWeakValueStrengthMakers()) {
681       MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map = makeMap(maker.concurrencyLevel(1));
682       if (maker.getValueStrength() == Strength.WEAK) {
683         Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
684         Object keyOne = new Object();
685         int hashOne = map.hash(keyOne);
686         Object valueOne = new Object();
687         Object keyTwo = new Object();
688         Object valueTwo = new Object();
689         map.put(keyOne, valueOne);
690         @SuppressWarnings("unchecked")
691         WeakValueEntry&lt;Object, Object, ?&gt; entry =
692             (WeakValueEntry&lt;Object, Object, ?&gt;) segment.getEntry(keyOne, hashOne);
693         WeakValueReference&lt;Object, Object, ?&gt; valueReference = entry.getValueReference();
694         @SuppressWarnings("unchecked")
695         Reference&lt;Object&gt; reference = (Reference&lt;Object&gt;) valueReference;
696         reference.enqueue();
697         map.put(keyTwo, valueTwo);
698         assertFalse(map.containsKey(keyOne));
699         assertFalse(map.containsValue(valueOne));
700         assertNull(map.get(keyOne));
701         assertEquals(1, map.size());
702         assertNull(segment.getValueReferenceQueueForTesting().poll());
703       }
704     }
705   }
706   public void testDrainKeyReferenceQueueOnRead() {
707     for (MapMaker maker : allWeakKeyStrengthMakers()) {
708       MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map = makeMap(maker.concurrencyLevel(1));
709       if (maker.getKeyStrength() == Strength.WEAK) {
710         Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
711         Object keyOne = new Object();
712         int hashOne = map.hash(keyOne);
713         Object valueOne = new Object();
714         Object keyTwo = new Object();
715         map.put(keyOne, valueOne);
716         InternalEntry&lt;Object, Object, ?&gt; entry = segment.getEntry(keyOne, hashOne);
717         @SuppressWarnings("unchecked")
718         Reference&lt;Object&gt; reference = (Reference&lt;Object&gt;) entry;
719         reference.enqueue();
720         for (int i = 0; i &lt; SMALL_MAX_SIZE; i++) {
721           Object unused = map.get(keyTwo);
722         }
723         assertFalse(map.containsKey(keyOne));
724         assertFalse(map.containsValue(valueOne));
725         assertNull(map.get(keyOne));
726         assertEquals(0, map.size());
727         assertNull(segment.getKeyReferenceQueueForTesting().poll());
728       }
729     }
730   }
731   public void testDrainValueReferenceQueueOnRead() {
732     for (MapMaker maker : allWeakValueStrengthMakers()) {
733       MapMakerInternalMap&lt;Object, Object, ?, ?&gt; map = makeMap(maker.concurrencyLevel(1));
734       if (maker.getValueStrength() == Strength.WEAK) {
735         Segment&lt;Object, Object, ?, ?&gt; segment = map.segments[0];
736         Object keyOne = new Object();
737         int hashOne = map.hash(keyOne);
738         Object valueOne = new Object();
739         Object keyTwo = new Object();
740         map.put(keyOne, valueOne);
741         @SuppressWarnings("unchecked")
742         WeakValueEntry&lt;Object, Object, ?&gt; entry =
743             (WeakValueEntry&lt;Object, Object, ?&gt;) segment.getEntry(keyOne, hashOne);
744         WeakValueReference&lt;Object, Object, ?&gt; valueReference = entry.getValueReference();
745         @SuppressWarnings("unchecked")
746         Reference&lt;Object&gt; reference = (Reference&lt;Object&gt;) valueReference;
747         reference.enqueue();
748         for (int i = 0; i &lt; SMALL_MAX_SIZE; i++) {
749           Object unused = map.get(keyTwo);
750         }
751         assertFalse(map.containsKey(keyOne));
752         assertFalse(map.containsValue(valueOne));
753         assertNull(map.get(keyOne));
754         assertEquals(0, map.size());
755         assertNull(segment.getValueReferenceQueueForTesting().poll());
756       }
757     }
758   }
759   private static Iterable&lt;MapMaker&gt; allWeakKeyStrengthMakers() {
760     return ImmutableList.of(createMapMaker().weakKeys(), createMapMaker().weakKeys().weakValues());
761   }
762   private static Iterable&lt;MapMaker&gt; allWeakValueStrengthMakers() {
763     return ImmutableList.of(
764         createMapMaker().weakValues(), createMapMaker().weakKeys().weakValues());
765   }
766   public void testNullParameters() throws Exception {
767     NullPointerTester tester = new NullPointerTester();
768     tester.testAllPublicInstanceMethods(makeMap(createMapMaker()));
769   }
770 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
