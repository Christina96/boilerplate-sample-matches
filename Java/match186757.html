<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for QuantilesTest.java &amp; CacheLoadingTest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for QuantilesTest.java &amp; CacheLoadingTest.java
      </h3>
<h1 align="center">
        21.1%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>QuantilesTest.java (54.701717%)<th>CacheLoadingTest.java (13.115151%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(19-78)<td><a href="#" name="0">(31-64)</a><td align="center"><font color="#ff0000">28</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(187-198)<td><a href="#" name="1">(815-824)</a><td align="center"><font color="#ad0000">19</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(206-214)<td><a href="#" name="2">(324-335)</a><td align="center"><font color="#a30000">18</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(307-323)<td><a href="#" name="3">(836-845)</a><td align="center"><font color="#9a0000">17</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(335-348)<td><a href="#" name="4">(1758-1771)</a><td align="center"><font color="#880000">15</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(589-594)<td><a href="#" name="5">(2289-2301)</a><td align="center"><font color="#7f0000">14</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(348-360)<td><a href="#" name="6">(2233-2247)</a><td align="center"><font color="#7f0000">14</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(158-167)<td><a href="#" name="7">(1839-1854)</a><td align="center"><font color="#7f0000">14</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(144-151)<td><a href="#" name="8">(1820-1830)</a><td align="center"><font color="#7f0000">14</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(384-397)<td><a href="#" name="9">(451-456)</a><td align="center"><font color="#760000">13</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(294-306)<td><a href="#" name="10">(372-379)</a><td align="center"><font color="#760000">13</font>
<tr onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b041ff"><font color="#b041ff">-</font><td><a href="#" name="11">(132-137)<td><a href="#" name="11">(153-160)</a><td align="center"><font color="#760000">13</font>
<tr onclick='openModal("#571b7e")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#571b7e"><font color="#571b7e">-</font><td><a href="#" name="12">(573-579)<td><a href="#" name="12">(262-269)</a><td align="center"><font color="#6d0000">12</font>
<tr onclick='openModal("#3b9c9c")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3b9c9c"><font color="#3b9c9c">-</font><td><a href="#" name="13">(323-335)<td><a href="#" name="13">(201-208)</a><td align="center"><font color="#6d0000">12</font>
<tr onclick='openModal("#842dce")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#842dce"><font color="#842dce">-</font><td><a href="#" name="14">(663-667)<td><a href="#" name="14">(564-568)</a><td align="center"><font color="#640000">11</font>
<tr onclick='openModal("#f52887")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f52887"><font color="#f52887">-</font><td><a href="#" name="15">(654-658)<td><a href="#" name="15">(524-528)</a><td align="center"><font color="#640000">11</font>
<tr onclick='openModal("#2981b2")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#2981b2"><font color="#2981b2">-</font><td><a href="#" name="16">(370-383)<td><a href="#" name="16">(708-714)</a><td align="center"><font color="#640000">11</font>
<tr onclick='openModal("#3090c7")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3090c7"><font color="#3090c7">-</font><td><a href="#" name="17">(228-242)<td><a href="#" name="17">(663-669)</a><td align="center"><font color="#640000">11</font>
<tr onclick='openModal("#800517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#800517"><font color="#800517">-</font><td><a href="#" name="18">(214-221)<td><a href="#" name="18">(1951-1959)</a><td align="center"><font color="#640000">11</font>
<tr onclick='openModal("#f62817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f62817"><font color="#f62817">-</font><td><a href="#" name="19">(180-186)<td><a href="#" name="19">(573-578)</a><td align="center"><font color="#640000">11</font>
<tr onclick='openModal("#4e9258")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4e9258"><font color="#4e9258">-</font><td><a href="#" name="20">(168-174)<td><a href="#" name="20">(94-98)</a><td align="center"><font color="#640000">11</font>
<tr onclick='openModal("#947010")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#947010"><font color="#947010">-</font><td><a href="#" name="21">(152-158)<td><a href="#" name="21">(533-538)</a><td align="center"><font color="#640000">11</font>
<tr onclick='openModal("#4cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4cc417"><font color="#4cc417">-</font><td><a href="#" name="22">(138-144)<td><a href="#" name="22">(419-425)</a><td align="center"><font color="#640000">11</font>
<tr onclick='openModal("#f660ab")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f660ab"><font color="#f660ab">-</font><td><a href="#" name="23">(671-675)<td><a href="#" name="23">(1749-1754)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#79764d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#79764d"><font color="#79764d">-</font><td><a href="#" name="24">(618-622)<td><a href="#" name="24">(2117-2121)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#5eac10")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#5eac10"><font color="#5eac10">-</font><td><a href="#" name="25">(609-613)<td><a href="#" name="25">(2067-2071)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#68818b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#68818b"><font color="#68818b">-</font><td><a href="#" name="26">(601-605)<td><a href="#" name="26">(2024-2028)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#e77471")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#e77471"><font color="#e77471">-</font><td><a href="#" name="27">(546-550)<td><a href="#" name="27">(1320-1325)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#717d7d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#717d7d"><font color="#717d7d">-</font><td><a href="#" name="28">(534-538)<td><a href="#" name="28">(104-108)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#af7a82")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#af7a82"><font color="#af7a82">-</font><td><a href="#" name="29">(522-524)<td><a href="#" name="29">(2059-2063)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#ae694a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ae694a"><font color="#ae694a">-</font><td><a href="#" name="30">(498-502)<td><a href="#" name="30">(2180-2184)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#3ea99f")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3ea99f"><font color="#3ea99f">-</font><td><a href="#" name="31">(474-485)<td><a href="#" name="31">(1273-1278)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#5b8daf")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#5b8daf"><font color="#5b8daf">-</font><td><a href="#" name="32">(459-473)<td><a href="#" name="32">(1197-1202)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#736aff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#736aff"><font color="#736aff">-</font><td><a href="#" name="33">(438-452)<td><a href="#" name="33">(1129-1134)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#827d6b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#827d6b"><font color="#827d6b">-</font><td><a href="#" name="34">(417-431)<td><a href="#" name="34">(1105-1110)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#41a317")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#41a317"><font color="#41a317">-</font><td><a href="#" name="35">(361-368)<td><a href="#" name="35">(1042-1047)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#ff00ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ff00ff"><font color="#ff00ff">-</font><td><a href="#" name="36">(283-293)<td><a href="#" name="36">(995-1000)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#810541")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#810541"><font color="#810541">-</font><td><a href="#" name="37">(271-281)<td><a href="#" name="37">(948-953)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#348781")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#348781"><font color="#348781">-</font><td><a href="#" name="38">(262-269)<td><a href="#" name="38">(873-878)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#152dc6")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#152dc6"><font color="#152dc6">-</font><td><a href="#" name="39">(245-257)<td><a href="#" name="39">(2372-2379)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#347235")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#347235"><font color="#347235">-</font><td><a href="#" name="40">(198-205)<td><a href="#" name="40">(755-761)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#f87a17")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f87a17"><font color="#f87a17">-</font><td><a href="#" name="41">(126-132)<td><a href="#" name="41">(493-498)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#c57717")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c57717"><font color="#c57717">-</font><td><a href="#" name="42">(763-766)<td><a href="#" name="42">(599-602)</a><td align="center"><font color="#510000">9</font>
<tr onclick='openModal("#c22817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c22817"><font color="#c22817">-</font><td><a href="#" name="43">(567-571)<td><a href="#" name="43">(2018-2021)</a><td align="center"><font color="#510000">9</font>
<tr onclick='openModal("#a057a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#a057a5"><font color="#a057a5">-</font><td><a href="#" name="44">(454-458)<td><a href="#" name="44">(1430-1435)</a><td align="center"><font color="#510000">9</font>
<tr onclick='openModal("#549748")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#549748"><font color="#549748">-</font><td><a href="#" name="45">(433-437)<td><a href="#" name="45">(1367-1372)</a><td align="center"><font color="#510000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>QuantilesTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <a name="0"></a>
2 package com.google.common.math;
3 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import static com.google.common.math.Quantiles.median;
4 import static com.google.common.math.Quantiles.percentiles;
5 import static com.google.common.math.Quantiles.quartiles;
6 import static com.google.common.truth.Truth.assertThat;
7 import static com.google.common.truth.Truth.assertWithMessage;
8 import static java.lang.Double.NEGATIVE_INFINITY;
9 import static java.lang.Double.NaN;
10 import static java.lang.Double.POSITIVE_INFINITY;
11 import static java.math.RoundingMode.CEILING;
12 import static java.math.RoundingMode.FLOOR;
13 import static java.math.RoundingMode.UNNECESSARY;
14 import com.google.common.collect.ImmutableList;
15 import com.google.common.collect.ImmutableMap;
16 import com.google.common.collect.Ordering;
17 import com.google.common.math.Quantiles.ScaleAndIndexes;
18 import com.google.common.primitives.Doubles;
19 import com.google.common.primitives.Ints;
20 import com.google.common.primitives.Longs;
21 import com.google.common.truth.Correspondence;
22 import com.google.common.truth.Correspondence.BinaryPredicate;
23 import java.util.ArrayList;
24 import java.util.Collections;
25 import java.util.List;
26 import java.util.Random;
27 import junit.framework.TestCase;
28 import org.checkerframework.checker.nullness.qual.Nullable;
29 public class QuantilesTest extends TestCase {
30   private static final double ALLOWED_ERROR = 1.0e-10</b></font>;
31   private static final Correspondence&lt;Number, Number&gt; FINITE_QUANTILE_CORRESPONDENCE =
32       Correspondence.tolerance(ALLOWED_ERROR);
33   private static final Correspondence&lt;Double, Double&gt; QUANTILE_CORRESPONDENCE =
34       Correspondence.from(
35           new BinaryPredicate&lt;Double, Double&gt;() {
36             @Override
37             public boolean apply(@Nullable Double actual, @Nullable Double expected) {
38               return actual.equals(expected)
39                   || FINITE_QUANTILE_CORRESPONDENCE.compare(actual, expected);
40             }
41           },
42           "is identical to or " + FINITE_QUANTILE_CORRESPONDENCE);
43   private static final ImmutableList&lt;Double&gt; SIXTEEN_SQUARES_DOUBLES =
44       ImmutableList.of(
45           25.0, 100.0, 0.0, 144.0, 9.0, 121.0, 4.0, 225.0, 169.0, 64.0, 49.0, 16.0, 36.0, 1.0, 81.0,
46           196.0);
47   private static final ImmutableList&lt;Long&gt; SIXTEEN_SQUARES_LONGS =
48       ImmutableList.of(
49           25L, 100L, 0L, 144L, 9L, 121L, 4L, 225L, 169L, 64L, 49L, 16L, 36L, 1L, 81L, 196L);
50   private static final ImmutableList&lt;Integer&gt; SIXTEEN_SQUARES_INTEGERS =
51       ImmutableList.of(25, 100, 0, 144, 9, 121, 4, 225, 169, 64, 49, 16, 36, 1, 81, 196);
52   private static final double SIXTEEN_SQUARES_MIN = 0.0;
53   private static final double SIXTEEN_SQUARES_DECILE_1 = 0.5 * (1.0 + 4.0);
54   private static final double SIXTEEN_SQUARES_QUARTILE_1 = 0.25 * 9.0 + 0.75 * 16.0;
55   private static final double SIXTEEN_SQUARES_MEDIAN = 0.5 * (49.0 + 64.0);
56   private static final double SIXTEEN_SQUARES_QUARTILE_3 = 0.75 * 121.0 + 0.25 * 144.0;
57   private static final double SIXTEEN_SQUARES_DECILE_8 = 144.0;
58 <a name="41"></a>  private static final double SIXTEEN_SQUARES_MAX = 225.0;
59   public void testMedian_compute_doubleCollection() {
60     <font color="#f87a17"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(median().compute(SIXTEEN_SQUARES_DOUBLES))
61         .isWithin(ALLOWED_ERROR)
62         .of(SIXTEEN_SQUARES_MEDIAN);
63 <a name="11"></a>  }
64   public void testMedian_computeInPlace() {
65     double[] dataset = <font color="#b041ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Doubles.toArray(SIXTEEN_SQUARES_DOUBLES)</b></font>;
66     assertThat(median().computeInPlace(dataset)).isWithin(ALLOWED_ERROR).of(SIXTEEN_SQUARES_MEDIAN);
67     assertThat(dataset).usingExactEquality().containsExactlyElementsIn(SIXTEEN_SQUARES_DOUBLES);
68 <a name="22"></a>  }
69   public void testQuartiles_index_compute_doubleCollection() {</b></font>
70     <font color="#4cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(quartiles().index(1).compute(SIXTEEN_SQUARES_DOUBLES))
71         .isWithin(ALLOWED_ERROR)
72         .of(SIXTEEN_SQUARES_QUARTILE_1);
73 <a name="8"></a>  }
74   public void testQuartiles_index_computeInPlace() {
75     double[] dataset = <font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Doubles.toArray(SIXTEEN_SQUARES_DOUBLES)</b></font>;
76     assertThat(quartiles().index(1).computeInPlace(dataset))
77         .isWithin(ALLOWED_ERROR)
78         .of(SIXTEEN_SQUARES_QUARTILE_1);
79     assertThat(dataset).usingExactEquality().containsExactlyElementsIn(SIXTEEN_SQUARES_DOUBLES);
80 <a name="21"></a>  }
81   public void testQuartiles_indexes_varargs_compute_doubleCollection() {</b></font>
82     <font color="#947010"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(quartiles().indexes(1, 3).compute(SIXTEEN_SQUARES_DOUBLES))
83         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
84         .containsExactly(1, SIXTEEN_SQUARES_QUARTILE_1, 3, SIXTEEN_SQUARES_QUARTILE_3);
85 <a name="7"></a>  }
86   public void testQuartiles_indexes_varargs_computeInPlace() {
87     double[] dataset = <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Doubles.toArray(SIXTEEN_SQUARES_DOUBLES)</b></font>;
88     assertThat(quartiles().indexes(1, 3).computeInPlace(dataset))
89         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
90         .containsExactly(
91             1, SIXTEEN_SQUARES_QUARTILE_1,
92             3, SIXTEEN_SQUARES_QUARTILE_3);
93     assertThat(dataset).usingExactEquality().containsExactlyElementsIn(SIXTEEN_SQUARES_DOUBLES);
94 <a name="20"></a>  }
95   public void testScale_index_compute_doubleCollection() {</b></font>
96     <font color="#4e9258"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).index(1).compute(SIXTEEN_SQUARES_DOUBLES))
97         .isWithin(ALLOWED_ERROR)
98         .of(SIXTEEN_SQUARES_DECILE_1);
99   }
100   public void testScale_index_compute_longCollection() {
101     assertThat</b></font>(Quantiles.scale(10).index(1).compute(SIXTEEN_SQUARES_LONGS))
102         .isWithin(ALLOWED_ERROR)
103         .of(SIXTEEN_SQUARES_DECILE_1);
104 <a name="19"></a>  }
105   public void testScale_index_compute_integerCollection() {
106     <font color="#f62817"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).index(1).compute(SIXTEEN_SQUARES_INTEGERS))
107         .isWithin(ALLOWED_ERROR)
108         .of(SIXTEEN_SQUARES_DECILE_1);
109   }
110 <a name="1"></a>
111   public void testScale_index_compute_doubleVarargs() {
112     double[] dataset = Doubles.toArray(SIXTEEN_SQUARES_DOUBLES)</b></font>;
113     <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).index(1).compute(dataset))
114         .isWithin(ALLOWED_ERROR)
115         .of(SIXTEEN_SQUARES_DECILE_1);
116     assertThat(dataset)
117         .usingExactEquality()
118         .containsExactlyElementsIn(SIXTEEN_SQUARES_DOUBLES)
119         .inOrder();
120   }
121 <a name="40"></a>
122   public void testScale_index_compute_longVarargs() {
123     long[] dataset = Longs.toArray(SIXTEEN_SQUARES_LONGS);
124     assertThat(<font color="#347235"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Quantiles.scale(10).index(1).compute</b></font>(dataset))
125         .isWithin(ALLOWED_ERROR)
126         .of(SIXTEEN_SQUARES_DECILE_1);
127     assertThat(dataset).asList().isEqualTo(SIXTEEN_SQUARES_LONGS);
128   }
129 <a name="2"></a>
130   public void testScale_index_compute_intVarargs() {
131     int[] dataset = Ints.toArray(SIXTEEN_SQUARES_INTEGERS)</b></font>;
132     <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).index(1).compute(dataset))
133         .isWithin(ALLOWED_ERROR)
134         .of(SIXTEEN_SQUARES_DECILE_1);
135     assertThat(dataset).asList().isEqualTo(SIXTEEN_SQUARES_INTEGERS);
136   }
137 <a name="18"></a>
138   public void testScale_index_computeInPlace() {
139     double[] dataset = Doubles.toArray(SIXTEEN_SQUARES_DOUBLES);
140     assertThat</b></font>(<font color="#800517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Quantiles.scale(10).index(1).computeInPlace(dataset))
141         .isWithin(ALLOWED_ERROR)
142         .of(SIXTEEN_SQUARES_DECILE_1);
143     assertThat(dataset).usingExactEquality().containsExactlyElementsIn(SIXTEEN_SQUARES_DOUBLES);
144   }
145   public void testScale_index_computeInPlace_explicitVarargs() {
146     assertThat</b></font>(Quantiles.scale(10).index(5).computeInPlace(78.9, 12.3, 45.6))
147         .isWithin(ALLOWED_ERROR)
148         .of(45.6);
149   }
150 <a name="17"></a>
151   public void testScale_indexes_varargs_compute_doubleCollection() {
152     <font color="#3090c7"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).indexes(0, 10, 5, 1, 8, 1).compute(SIXTEEN_SQUARES_DOUBLES))
153         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
154         .containsExactly(
155             0, SIXTEEN_SQUARES_MIN,
156             10, SIXTEEN_SQUARES_MAX,
157             5, SIXTEEN_SQUARES_MEDIAN,
158             1, SIXTEEN_SQUARES_DECILE_1,
159             8, SIXTEEN_SQUARES_DECILE_8);
160   }
161   public void testScale_indexes_varargs_compute_doubleCollection_snapshotsIndexes() {
162 <a name="39"></a>    int[] indexes = {0, 10, 5, 1, 8, 10}</b></font>;
163     ScaleAndIndexes intermediate = Quantiles.scale(10).indexes(indexes);
164     indexes[0] = 3;
165     <font color="#152dc6"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(intermediate.compute(SIXTEEN_SQUARES_DOUBLES))
166         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
167         .containsExactly(
168             0, SIXTEEN_SQUARES_MIN,
169             10, SIXTEEN_SQUARES_MAX,
170             5, SIXTEEN_SQUARES_MEDIAN,
171             1, SIXTEEN_SQUARES_DECILE_1,
172             8, SIXTEEN_SQUARES_DECILE_8);
173   }
174   public void testScale_indexes_largeVarargs_compute_doubleCollection() {
175     int scale = Integer.MAX_VALUE;
176     int otherIndex = (Integer.MAX_VALUE - 1) / 3</b></font>; <a name="38"></a>        double otherValue = 16.0 * 5.0 / Integer.MAX_VALUE + 25.0 * (1.0 - 5.0 / Integer.MAX_VALUE);
177     <font color="#348781"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(
178             Quantiles.scale(scale).indexes(0, scale, otherIndex).compute(SIXTEEN_SQUARES_DOUBLES))
179         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
180         .containsExactly(
181             0, SIXTEEN_SQUARES_MIN, scale, SIXTEEN_SQUARES_MAX, otherIndex, otherValue);
182   }
183 <a name="37"></a>
184   public void testScale_indexes_varargs_compute_longCollection() {</b></font>
185     <font color="#810541"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).indexes(0, 10, 5, 1, 8, 1).compute(SIXTEEN_SQUARES_LONGS))
186         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
187         .containsExactly(
188             0, SIXTEEN_SQUARES_MIN,
189             10, SIXTEEN_SQUARES_MAX,
190             5, SIXTEEN_SQUARES_MEDIAN,
191             1, SIXTEEN_SQUARES_DECILE_1,
192             8, SIXTEEN_SQUARES_DECILE_8);
193   }
194 <a name="36"></a>
195   public void testScale_indexes_varargs_compute_integerCollection() {</b></font>
196     <font color="#ff00ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).indexes(0, 10, 5, 1, 8, 1).compute(SIXTEEN_SQUARES_INTEGERS))
197         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
198         .containsExactly(
199             0, SIXTEEN_SQUARES_MIN,
200             10, SIXTEEN_SQUARES_MAX,
201             5, SIXTEEN_SQUARES_MEDIAN,
202             1, SIXTEEN_SQUARES_DECILE_1,
203             8, SIXTEEN_SQUARES_DECILE_8);
204 <a name="10"></a>  }
205   public void testScale_indexes_varargs_compute_indexOrderIsMaintained() {</b></font>
206     <font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).indexes(0, 10, 5, 1, 8, 1).compute(SIXTEEN_SQUARES_INTEGERS))
207         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
208         .containsExactly(
209             0, SIXTEEN_SQUARES_MIN,
210             10, SIXTEEN_SQUARES_MAX,
211             5, SIXTEEN_SQUARES_MEDIAN,
212             1, SIXTEEN_SQUARES_DECILE_1,
213             8, SIXTEEN_SQUARES_DECILE_8)
214         .inOrder();
215   }
216 <a name="3"></a>
217   public void testScale_indexes_varargs_compute_doubleVarargs() {
218     double[] dataset = Doubles.toArray</b></font>(SIXTEEN_SQUARES_DOUBLES);
219     <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).indexes(0, 10, 5, 1, 8, 1).compute(dataset))
220         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
221         .containsExactly(
222             0, SIXTEEN_SQUARES_MIN,
223             10, SIXTEEN_SQUARES_MAX,
224             5, SIXTEEN_SQUARES_MEDIAN,
225             1, SIXTEEN_SQUARES_DECILE_1,
226             8, SIXTEEN_SQUARES_DECILE_8);
227     assertThat(dataset)
228         .usingExactEquality()
229         .containsExactlyElementsIn(SIXTEEN_SQUARES_DOUBLES)
230         .inOrder();
231   }
232 <a name="13"></a>
233   public void testScale_indexes_varargs_compute_longVarargs() {
234     long[] dataset = Longs.toArray(SIXTEEN_SQUARES_LONGS);
235     <font color="#3b9c9c"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).indexes(0, 10, 5, 1, 8, 1).compute(dataset))</b></font>
236         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
237         .containsExactly(
238             0, SIXTEEN_SQUARES_MIN,
239             10, SIXTEEN_SQUARES_MAX,
240             5, SIXTEEN_SQUARES_MEDIAN,
241             1, SIXTEEN_SQUARES_DECILE_1,
242             8, SIXTEEN_SQUARES_DECILE_8);
243     assertThat(dataset).asList().isEqualTo(SIXTEEN_SQUARES_LONGS);
244 <a name="4"></a>  }
245   public void testScale_indexes_varargs_compute_intVarargs() {
246     int[] dataset = <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Ints.toArray(SIXTEEN_SQUARES_INTEGERS)</b></font>;
247     assertThat(Quantiles.scale(10).indexes(0, 10, 5, 1, 8, 1).compute(dataset))
248         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
249         .containsExactly(
250             0, SIXTEEN_SQUARES_MIN,
251             10, SIXTEEN_SQUARES_MAX,
252             5, SIXTEEN_SQUARES_MEDIAN,
253             1, SIXTEEN_SQUARES_DECILE_1,
254             8, SIXTEEN_SQUARES_DECILE_8);
255     assertThat(dataset).asList().isEqualTo(SIXTEEN_SQUARES_INTEGERS);
256 <a name="6"></a>  }
257   public void testScale_indexes_varargs_computeInPlace() {
258     double[] dataset = <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Doubles.toArray(SIXTEEN_SQUARES_DOUBLES)</b></font>;
259     assertThat(Quantiles.scale(10).indexes(0, 10, 5, 1, 8, 1).computeInPlace(dataset))
260         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
261         .containsExactly(
262             0, SIXTEEN_SQUARES_MIN,
263             10, SIXTEEN_SQUARES_MAX,
264             5, SIXTEEN_SQUARES_MEDIAN,
265             1, SIXTEEN_SQUARES_DECILE_1,
266             8, SIXTEEN_SQUARES_DECILE_8);
267     assertThat(dataset).usingExactEquality().containsExactlyElementsIn(SIXTEEN_SQUARES_DOUBLES);
268 <a name="35"></a>  }
269   public void testScale_indexes_varargs_computeInPlace_explicitVarargs() {</b></font>
270     <font color="#41a317"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).indexes(0, 10).computeInPlace(78.9, 12.3, 45.6))
271         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
272         .containsExactly(
273             0, 12.3,
274             10, 78.9);
275   }
276 <a name="16"></a>
277   public void testScale_indexes_collection_compute_doubleCollection() {</b></font>
278     <font color="#2981b2"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(
279             Quantiles.scale(10)
280                 .indexes(ImmutableList.of(0, 10, 5, 1, 8, 1))
281                 .compute(SIXTEEN_SQUARES_DOUBLES))
282         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
283         .containsExactly(
284             0, SIXTEEN_SQUARES_MIN,
285             10, SIXTEEN_SQUARES_MAX,
286             5, SIXTEEN_SQUARES_MEDIAN,
287             1, SIXTEEN_SQUARES_DECILE_1,
288             8, SIXTEEN_SQUARES_DECILE_8);
289 <a name="9"></a>  }
290   public void testScale_indexes_collection_computeInPlace() {</b></font>
291     <font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>double[] dataset = Doubles.toArray(SIXTEEN_SQUARES_DOUBLES);
292     assertThat(
293             Quantiles.scale(10)
294                 .indexes(ImmutableList.of(0, 10, 5, 1, 8, 1))
295                 .computeInPlace(dataset))
296         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
297         .containsExactly(
298             0, SIXTEEN_SQUARES_MIN,
299             10, SIXTEEN_SQUARES_MAX,
300             5, SIXTEEN_SQUARES_MEDIAN,
301             1, SIXTEEN_SQUARES_DECILE_1,
302             8, SIXTEEN_SQUARES_DECILE_8);
303     assertThat(dataset).usingExactEquality().containsExactlyElementsIn(SIXTEEN_SQUARES_DOUBLES);
304   }</b></font>
305   private static final ImmutableList&lt;Double&gt; ONE_TO_FIVE_AND_POSITIVE_INFINITY =
306       ImmutableList.of(3.0, 5.0, POSITIVE_INFINITY, 1.0, 4.0, 2.0);
307   private static final ImmutableList&lt;Double&gt; ONE_TO_FIVE_AND_NEGATIVE_INFINITY =
308       ImmutableList.of(3.0, 5.0, NEGATIVE_INFINITY, 1.0, 4.0, 2.0);
309   private static final ImmutableList&lt;Double&gt; NEGATIVE_INFINITY_AND_FIVE_POSITIVE_INFINITIES =
310       ImmutableList.of(
311           POSITIVE_INFINITY,
312           POSITIVE_INFINITY,
313           NEGATIVE_INFINITY,
314           POSITIVE_INFINITY,
315           POSITIVE_INFINITY,
316           POSITIVE_INFINITY);
317   private static final ImmutableList&lt;Double&gt; ONE_TO_FIVE_AND_NAN =
318 <a name="34"></a>      ImmutableList.of(3.0, 5.0, NaN, 1.0, 4.0, 2.0);
319   public void testScale_indexes_varargs_compute_doubleCollection_positiveInfinity() {
320     <font color="#827d6b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(
321             Quantiles.scale(10)
322                 .indexes(0, 1, 2, 8, 9, 10)
323                 .compute(ONE_TO_FIVE_AND_POSITIVE_INFINITY))
324         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
325         .containsExactly(
326             0, 1.0,
327             1, 1.5,
328             2, 2.0,
329             8, 5.0,
330             9, POSITIVE_INFINITY,             10, POSITIVE_INFINITY);
331   }
332 <a name="45"></a>
333   public void testScale_index_compute_doubleCollection_positiveInfinity() {</b></font>
334     <font color="#549748"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).index(9).compute(ONE_TO_FIVE_AND_POSITIVE_INFINITY))
335         .isPositiveInfinity();
336 <a name="33"></a>  }
337   public void testScale_indexes_varargs_compute_doubleCollection_negativeInfinity() {</b></font>
338     <font color="#736aff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(
339             Quantiles.scale(10)
340                 .indexes(0, 1, 2, 8, 9, 10)
341                 .compute(ONE_TO_FIVE_AND_NEGATIVE_INFINITY))
342         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
343         .containsExactly(
344             0, NEGATIVE_INFINITY,
345             1, NEGATIVE_INFINITY,             2, 1.0,
346             8, 4.0,
347             9, 4.5,
348             10, 5.0);
349   }
350 <a name="44"></a>
351   public void testScale_index_compute_doubleCollection_negativeInfinity() {</b></font>
352     <font color="#a057a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).index(1).compute(ONE_TO_FIVE_AND_NEGATIVE_INFINITY))
353         .isNegativeInfinity();
354 <a name="32"></a>  }
355   public void testScale_indexes_varargs_compute_doubleCollection_bothInfinities() {</b></font>
356     <font color="#5b8daf"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(
357             Quantiles.scale(10)
358                 .indexes(0, 1, 2, 8, 9, 10)
359                 .compute(NEGATIVE_INFINITY_AND_FIVE_POSITIVE_INFINITIES))
360         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
361         .containsExactly(
362             0, NEGATIVE_INFINITY,
363             1, NaN,             2, POSITIVE_INFINITY,
364             8, POSITIVE_INFINITY,
365             9, POSITIVE_INFINITY,             10, POSITIVE_INFINITY);
366 <a name="31"></a>  }
367   public void testScale_indexes_varargs_compute_doubleCollection_nan() {</b></font>
368     <font color="#3ea99f"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(Quantiles.scale(10).indexes(0, 1, 2, 8, 9, 10).compute(ONE_TO_FIVE_AND_NAN))
369         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
370         .containsExactly(
371             0, NaN,
372             1, NaN,
373             2, NaN,
374             8, NaN,
375             9, NaN,
376             10, NaN);
377   }
378   public void testScale_index_compute_doubleCollection_nan() {</b></font>
379     assertThat(Quantiles.scale(10).index(5).compute(ONE_TO_FIVE_AND_NAN)).isNaN();
380   }
381   private static final int PSEUDORANDOM_DATASET_SIZE = 9951;
382   private static final ImmutableList&lt;Double&gt; PSEUDORANDOM_DATASET = generatePseudorandomDataset();
383   private static final ImmutableList&lt;Double&gt; PSEUDORANDOM_DATASET_SORTED =
384       Ordering.natural().immutableSortedCopy(PSEUDORANDOM_DATASET);
385 <a name="30"></a>
386   private static ImmutableList&lt;Double&gt; generatePseudorandomDataset() {
387     Random random = new Random(2211275185798966364L);
388     <font color="#ae694a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>ImmutableList.Builder&lt;Double&gt; largeDatasetBuilder = ImmutableList.builder();
389     for (int i = 0; i &lt; PSEUDORANDOM_DATASET_SIZE; i++) {
390       largeDatasetBuilder.add(random.nextGaussian());
391     }
392     return</b></font> largeDatasetBuilder.build();
393   }
394   private static double expectedLargeDatasetPercentile(int index) {
395     if (index % 2 == 0) {
396       int position = IntMath.divide(199 * index, 2, UNNECESSARY);
397       return PSEUDORANDOM_DATASET_SORTED.get(position);
398     } else {
399       int positionFloor = IntMath.divide(199 * index, 2, FLOOR);
400       int positionCeil = IntMath.divide(199 * index, 2, CEILING);
401       double lowerValue = PSEUDORANDOM_DATASET_SORTED.get(positionFloor);
402       double upperValue = PSEUDORANDOM_DATASET_SORTED.get(positionCeil);
403       return (lowerValue + upperValue) / 2.0;
404     }
405 <a name="29"></a>  }
406   public void testPercentiles_index_compute_doubleCollection() {
407     <font color="#af7a82"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>for (int index = 0; index &lt;= 100; index++) {
408       assertWithMessage("quantile at index " + index)
409           .that(percentiles</b></font>().index(index).compute(PSEUDORANDOM_DATASET))
410           .isWithin(ALLOWED_ERROR)
411           .of(expectedLargeDatasetPercentile(index));
412     }
413   }
414   @AndroidIncompatible <a name="28"></a>  public void testPercentiles_index_computeInPlace() {
415     for (int index = 0; index &lt;= 100; index++) {
416       <font color="#717d7d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>double[] dataset = Doubles.toArray(PSEUDORANDOM_DATASET);
417       assertWithMessage("quantile at index " + index)
418           .that(percentiles().index(index).computeInPlace(dataset))
419           .isWithin(ALLOWED_ERROR)
420           .of(expectedLargeDatasetPercentile</b></font>(index));
421     }
422 <a name="27"></a>        double[] dataset = Doubles.toArray(PSEUDORANDOM_DATASET);
423     @SuppressWarnings("unused")
424     double actual = <font color="#e77471"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>percentiles().index(33).computeInPlace(dataset);
425     assertThat(dataset).usingExactEquality().containsExactlyElementsIn(PSEUDORANDOM_DATASET);
426   }
427   public void testPercentiles_indexes_varargsPairs_compute_doubleCollection() {</b></font>
428     for (int index1 = 0; index1 &lt;= 100; index1++) {
429       for (int index2 = 0; index2 &lt;= 100; index2++) {
430         ImmutableMap.Builder&lt;Integer, Double&gt; expectedBuilder = ImmutableMap.builder();
431         expectedBuilder.put(index1, expectedLargeDatasetPercentile(index1));
432         if (index2 != index1) {
433           expectedBuilder.put(index2, expectedLargeDatasetPercentile(index2));
434         }
435         assertThat(percentiles().indexes(index1, index2).compute(PSEUDORANDOM_DATASET))
436             .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
437             .containsExactlyEntriesIn(expectedBuilder.buildOrThrow());
438       }
439     }
440   }
441 <a name="43"></a>
442   public void testPercentiles_indexes_varargsAll_compute_doubleCollection() {
443     ArrayList&lt;Integer&gt; indexes = new ArrayList&lt;&gt;();
444     ImmutableMap.Builder&lt;Integer, Double&gt; expectedBuilder = <font color="#c22817"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>ImmutableMap.builder();
445     for (int index = 0; index &lt;= 100; index++) {
446       indexes.add(index);
447 <a name="12"></a>      expectedBuilder.put(index, expectedLargeDatasetPercentile(index));
448     }</b></font>
449     Random random = new Random(770683168895677741L);
450     <font color="#571b7e"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Collections.shuffle(indexes, random);
451     assertThat(percentiles().indexes(Ints.toArray(indexes)).compute(PSEUDORANDOM_DATASET))
452         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
453         .containsExactlyEntriesIn(expectedBuilder.buildOrThrow());
454   }
455   @AndroidIncompatible   public void testPercentiles_indexes_varargsAll_computeInPlace() {
456     double[] dataset = Doubles.toArray(PSEUDORANDOM_DATASET);
457     List&lt;Integer&gt; indexes = new ArrayList&lt;&gt;();
458     ImmutableMap.Builder&lt;Integer, Double&gt; expectedBuilder = ImmutableMap.builder();
459     for (int index = 0; index &lt;= 100; index++) {
460       indexes.add(index);
461 <a name="5"></a>      expectedBuilder.put(index, expectedLargeDatasetPercentile(index));
462     }
463     Random random = new Random(770683168895677741L);
464     <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Collections.shuffle(indexes, random);
465     assertThat(percentiles().indexes(Ints.toArray(indexes)).computeInPlace(dataset))
466         .comparingValuesUsing(QUANTILE_CORRESPONDENCE)
467         .containsExactlyEntriesIn(expectedBuilder.buildOrThrow());
468     assertThat(dataset).usingExactEquality().containsExactlyElementsIn(PSEUDORANDOM_DATASET);
469   }</b></font>
470 <a name="26"></a>  private static final ImmutableList&lt;Double&gt; EMPTY_DATASET = ImmutableList.of();
471   public void testScale_zero() {
472     <font color="#68818b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>try {
473       Quantiles.scale(0);
474       fail("Expected IllegalArgumentException");
475     } catch (IllegalArgumentException expected) {
476     }</b></font>
477 <a name="25"></a>  }
478   public void testScale_negative() {
479     <font color="#5eac10"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>try {
480       Quantiles.scale(-4);
481       fail("Expected IllegalArgumentException");
482     } catch (IllegalArgumentException expected) {
483     }</b></font>
484   }
485 <a name="24"></a>
486   public void testScale_index_negative() {
487     Quantiles.Scale intermediate = Quantiles.scale(10);
488     <font color="#79764d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>try {
489       intermediate.index(-1);
490       fail("Expected IllegalArgumentException");
491     } catch (IllegalArgumentException expected) {
492     }</b></font>
493   }
494   public void testScale_index_tooHigh() {
495     Quantiles.Scale intermediate = Quantiles.scale(10);
496     try {
497       intermediate.index(11);
498       fail("Expected IllegalArgumentException");
499     } catch (IllegalArgumentException expected) {
500     }
501   }
502   public void testScale_indexes_varargs_negative() {
503     Quantiles.Scale intermediate = Quantiles.scale(10);
504     try {
505       intermediate.indexes(1, -1, 3);
506       fail("Expected IllegalArgumentException");
507     } catch (IllegalArgumentException expected) {
508     }
509   }
510   public void testScale_indexes_varargs_tooHigh() {
511     Quantiles.Scale intermediate = Quantiles.scale(10);
512     try {
513       intermediate.indexes(1, 11, 3);
514       fail("Expected IllegalArgumentException");
515     } catch (IllegalArgumentException expected) {
516     }
517   }
518 <a name="15"></a>
519   public void testScale_indexes_collection_negative() {
520     Quantiles.Scale intermediate = Quantiles.scale(10);
521     <font color="#f52887"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>try {
522       intermediate.indexes(ImmutableList.of(1, -1, 3));
523       fail("Expected IllegalArgumentException");
524     } catch (IllegalArgumentException expected) {
525     }</b></font>
526   }
527 <a name="14"></a>
528   public void testScale_indexes_collection_tooHigh() {
529     Quantiles.Scale intermediate = Quantiles.scale(10);
530     <font color="#842dce"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>try {
531       intermediate.indexes(ImmutableList.of(1, 11, 3));
532       fail("Expected IllegalArgumentException");
533     } catch (IllegalArgumentException expected) {
534     }</b></font>
535 <a name="23"></a>  }
536   public void testScale_index_compute_doubleCollection_empty() {
537     Quantiles.ScaleAndIndex intermediate = <font color="#f660ab"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Quantiles.scale(10).index(3);
538     try {
539       intermediate.compute(EMPTY_DATASET);
540       fail("Expected IllegalArgumentException");
541     } catch (IllegalArgumentException expected) {</b></font>
542     }
543   }
544   public void testScale_index_compute_doubleVarargs_empty() {
545     Quantiles.ScaleAndIndex intermediate = Quantiles.scale(10).index(3);
546     try {
547       intermediate.compute(new double[] {});
548       fail("Expected IllegalArgumentException");
549     } catch (IllegalArgumentException expected) {
550     }
551   }
552   public void testScale_index_compute_longVarargs_empty() {
553     Quantiles.ScaleAndIndex intermediate = Quantiles.scale(10).index(3);
554     try {
555       intermediate.compute(new long[] {});
556       fail("Expected IllegalArgumentException");
557     } catch (IllegalArgumentException expected) {
558     }
559   }
560   public void testScale_index_compute_intVarargs_empty() {
561     Quantiles.ScaleAndIndex intermediate = Quantiles.scale(10).index(3);
562     try {
563       intermediate.compute(new int[] {});
564       fail("Expected IllegalArgumentException");
565     } catch (IllegalArgumentException expected) {
566     }
567   }
568   public void testScale_index_computeInPlace_empty() {
569     Quantiles.ScaleAndIndex intermediate = Quantiles.scale(10).index(3);
570     try {
571       intermediate.computeInPlace(new double[] {});
572       fail("Expected IllegalArgumentException");
573     } catch (IllegalArgumentException expected) {
574     }
575   }
576   public void testScale_indexes_varargs_compute_doubleCollection_empty() {
577     Quantiles.ScaleAndIndexes intermediate = Quantiles.scale(10).indexes(1, 3, 5);
578     try {
579       intermediate.compute(EMPTY_DATASET);
580       fail("Expected IllegalArgumentException");
581     } catch (IllegalArgumentException expected) {
582     }
583   }
584   public void testScale_indexes_varargs_compute_doubleVarargs_empty() {
585     Quantiles.ScaleAndIndexes intermediate = Quantiles.scale(10).indexes(1, 3, 5);
586     try {
587       intermediate.compute(new double[] {});
588       fail("Expected IllegalArgumentException");
589     } catch (IllegalArgumentException expected) {
590     }
591   }
592   public void testScale_indexes_varargs_compute_longVarargs_empty() {
593     Quantiles.ScaleAndIndexes intermediate = Quantiles.scale(10).indexes(1, 3, 5);
594     try {
595       intermediate.compute(new long[] {});
596       fail("Expected IllegalArgumentException");
597     } catch (IllegalArgumentException expected) {
598     }
599   }
600   public void testScale_indexes_varargs_compute_intVarargs_empty() {
601     Quantiles.ScaleAndIndexes intermediate = Quantiles.scale(10).indexes(1, 3, 5);
602     try {
603       intermediate.compute(new int[] {});
604       fail("Expected IllegalArgumentException");
605     } catch (IllegalArgumentException expected) {
606     }
607   }
608   public void testScale_indexes_varargs_computeInPlace_empty() {
609     Quantiles.ScaleAndIndexes intermediate = Quantiles.scale(10).indexes(1, 3, 5);
610     try {
611       intermediate.computeInPlace(new double[] {});
612       fail("Expected IllegalArgumentException");
613     } catch (IllegalArgumentException expected) {
614     }
615   }
616 <a name="42"></a>  public void testScale_indexes_indexes_computeInPlace_empty() {
617     int[] emptyIndexes = {};
618     try {
619       Quantiles.ScaleAndIndexes unused = <font color="#c57717"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Quantiles.scale(10).indexes(emptyIndexes);
620       fail("Expected IllegalArgumentException");
621     } catch (IllegalArgumentException expected) {
622     }</b></font>
623   }
624 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>CacheLoadingTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 package com.google.common.cache;
2 import static com.google.common.cache.TestingCacheLoaders.bulkLoader;
3 import static com.google.common.cache.TestingCacheLoaders.constantLoader;
4 import static com.google.common.cache.TestingCacheLoaders.errorLoader;
5 import static com.google.common.cache.TestingCacheLoaders.exceptionLoader;
6 import static com.google.common.cache.TestingCacheLoaders.identityLoader;
7 import static com.google.common.cache.TestingRemovalListeners.countingRemovalListener;
8 import static com.google.common.truth.Truth.assertThat;
9 import static java.lang.Thread.currentThread;
10 import static java.util.Arrays.asList;
11 import static java.util.concurrent.TimeUnit.MILLISECONDS;
12 <a name="0"></a>import com.google.common.cache.CacheLoader.InvalidCacheLoadException;
13 import com.google.common.cache.TestingCacheLoaders.CountingLoader;
14 import com.google.common.cache.TestingCacheLoaders.IdentityLoader;
15 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import com.google.common.cache.TestingRemovalListeners.CountingRemovalListener;
16 import com.google.common.collect.ImmutableList;
17 import com.google.common.collect.ImmutableMap;
18 import com.google.common.collect.Lists;
19 import com.google.common.collect.Maps;
20 import com.google.common.testing.FakeTicker;
21 import com.google.common.testing.TestLogHandler;
22 import com.google.common.util.concurrent.Callables;
23 import com.google.common.util.concurrent.ExecutionError;
24 import com.google.common.util.concurrent.Futures;
25 import com.google.common.util.concurrent.ListenableFuture;
26 import com.google.common.util.concurrent.UncheckedExecutionException;
27 import java.io.IOException;
28 import java.lang.ref.WeakReference;
29 import java.util.List;
30 import java.util.Map;
31 import java.util.Map.Entry;
32 import java.util.concurrent.Callable;
33 import java.util.concurrent.ConcurrentMap;
34 import java.util.concurrent.CountDownLatch;
35 import java.util.concurrent.ExecutionException;
36 import java.util.concurrent.TimeUnit;
37 import java.util.concurrent.atomic.AtomicInteger;
38 import java.util.concurrent.atomic.AtomicReferenceArray;
39 import java.util.logging.LogRecord;
40 import junit.framework.TestCase;
41 public class CacheLoadingTest extends TestCase {
42   TestLogHandler logHandler</b></font>;
43   @Override
44   public void setUp() throws Exception {
45     super.setUp();
46     logHandler = new TestLogHandler();
47     LocalCache.logger.addHandler(logHandler);
48   }
49   @Override
50   public void tearDown() throws Exception {
51     super.tearDown();
52     currentThread().interrupted();
53     LocalCache.logger.removeHandler(logHandler);
54   }
55   private Throwable popLoggedThrowable() {
56     List&lt;LogRecord&gt; logRecords = logHandler.getStoredLogRecords();
57     assertEquals(1, logRecords.size());
58     LogRecord logRecord = logRecords.get(0);
59     logHandler.clear();
60     return logRecord.getThrown();
61   }
62   private void checkNothingLogged() {
63     assertThat(logHandler.getStoredLogRecords()).isEmpty();
64 <a name="20"></a>  }
65   private void checkLoggedCause(Throwable t) {
66     <font color="#4e9258"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertThat(popLoggedThrowable()).hasCauseThat().isSameInstanceAs(t);
67   }
68   private void checkLoggedInvalidLoad() {
69     assertThat(popLoggedThrowable</b></font>()).isInstanceOf(InvalidCacheLoadException.class);
70   }
71 <a name="28"></a>  public void testLoad() throws ExecutionException {
72     LoadingCache&lt;Object, Object&gt; cache =
73         CacheBuilder.newBuilder().recordStats().build(identityLoader());
74     <font color="#717d7d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>CacheStats stats = cache.stats();
75     assertEquals(0, stats.missCount());
76     assertEquals(0, stats.loadSuccessCount());
77     assertEquals(0, stats.loadExceptionCount());
78     assertEquals(0, stats.hitCount</b></font>());
79     Object key = new Object();
80     assertSame(key, cache.get(key));
81     stats = cache.stats();
82     assertEquals(1, stats.missCount());
83     assertEquals(1, stats.loadSuccessCount());
84     assertEquals(0, stats.loadExceptionCount());
85     assertEquals(0, stats.hitCount());
86     key = new Object();
87     assertSame(key, cache.getUnchecked(key));
88     stats = cache.stats();
89     assertEquals(2, stats.missCount());
90     assertEquals(2, stats.loadSuccessCount());
91     assertEquals(0, stats.loadExceptionCount());
92     assertEquals(0, stats.hitCount());
93     key = new Object();
94     cache.refresh(key);
95     checkNothingLogged();
96     stats = cache.stats();
97     assertEquals(2, stats.missCount());
98     assertEquals(3, stats.loadSuccessCount());
99     assertEquals(0, stats.loadExceptionCount());
100     assertEquals(0, stats.hitCount());
101     assertSame(key, cache.get(key));
102     stats = cache.stats();
103     assertEquals(2, stats.missCount());
104     assertEquals(3, stats.loadSuccessCount());
105     assertEquals(0, stats.loadExceptionCount());
106     assertEquals(1, stats.hitCount());
107     Object value = new Object();
108     assertSame(key, cache.get(key, throwing(new Exception())));
109     stats = cache.stats();
110     assertEquals(2, stats.missCount());
111     assertEquals(3, stats.loadSuccessCount());
112     assertEquals(0, stats.loadExceptionCount());
113     assertEquals(2, stats.hitCount());
114 <a name="11"></a>
115     key = new Object();
116     assertSame(value, cache.get(key, Callables.returning(value)));
117     stats = <font color="#b041ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>cache.stats();
118     assertEquals(3, stats.missCount());
119     assertEquals(4, stats.loadSuccessCount());
120     assertEquals(0, stats.loadExceptionCount());
121     assertEquals(2, stats.hitCount());
122   }
123   public void testReload() throws ExecutionException {</b></font>
124     final Object one = new Object();
125     final Object two = new Object();
126     CacheLoader&lt;Object, Object&gt; loader =
127         new CacheLoader&lt;Object, Object&gt;() {
128           @Override
129           public Object load(Object key) {
130             return one;
131           }
132           @Override
133           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) {
134             return Futures.immediateFuture(two);
135           }
136         };
137     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
138     Object key = new Object();
139     CacheStats stats = cache.stats();
140     assertEquals(0, stats.missCount());
141     assertEquals(0, stats.loadSuccessCount());
142     assertEquals(0, stats.loadExceptionCount());
143     assertEquals(0, stats.hitCount());
144     assertSame(one, cache.getUnchecked(key));
145     stats = cache.stats();
146     assertEquals(1, stats.missCount());
147     assertEquals(1, stats.loadSuccessCount());
148     assertEquals(0, stats.loadExceptionCount());
149     assertEquals(0, stats.hitCount());
150     cache.refresh(key);
151     checkNothingLogged();
152     stats = cache.stats();
153     assertEquals(1, stats.missCount());
154     assertEquals(2, stats.loadSuccessCount());
155     assertEquals(0, stats.loadExceptionCount());
156     assertEquals(0, stats.hitCount());
157 <a name="13"></a>
158     assertSame(two, cache.getUnchecked(key));
159     stats = cache.stats();
160     assertEquals(1, <font color="#3b9c9c"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>stats.missCount());
161     assertEquals(2, stats.loadSuccessCount());
162     assertEquals(0, stats.loadExceptionCount());
163     assertEquals(1, stats.hitCount());
164   }
165   public void testRefresh() {
166     final Object one = new Object()</b></font>;
167     final Object two = new Object();
168     FakeTicker ticker = new FakeTicker();
169     CacheLoader&lt;Object, Object&gt; loader =
170         new CacheLoader&lt;Object, Object&gt;() {
171           @Override
172           public Object load(Object key) {
173             return one;
174           }
175           @Override
176           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) {
177             return Futures.immediateFuture(two);
178           }
179         };
180     LoadingCache&lt;Object, Object&gt; cache =
181         CacheBuilder.newBuilder()
182             .recordStats()
183             .ticker(ticker)
184             .refreshAfterWrite(1, MILLISECONDS)
185             .build(loader);
186     Object key = new Object();
187     CacheStats stats = cache.stats();
188     assertEquals(0, stats.missCount());
189     assertEquals(0, stats.loadSuccessCount());
190     assertEquals(0, stats.loadExceptionCount());
191     assertEquals(0, stats.hitCount());
192     assertSame(one, cache.getUnchecked(key));
193     stats = cache.stats();
194     assertEquals(1, stats.missCount());
195     assertEquals(1, stats.loadSuccessCount());
196     assertEquals(0, stats.loadExceptionCount());
197     assertEquals(0, stats.hitCount());
198     ticker.advance(1, MILLISECONDS);
199     assertSame(one, cache.getUnchecked(key));
200     stats = cache.stats();
201     assertEquals(1, stats.missCount());
202     assertEquals(1, stats.loadSuccessCount());
203     assertEquals(0, stats.loadExceptionCount());
204     assertEquals(1, stats.hitCount());
205     ticker.advance(1, MILLISECONDS);
206     assertSame(two, cache.getUnchecked(key));
207     stats = cache.stats();
208     assertEquals(1, stats.missCount());
209     assertEquals(2, stats.loadSuccessCount());
210     assertEquals(0, stats.loadExceptionCount());
211     assertEquals(2, stats.hitCount());
212 <a name="12"></a>
213     ticker.advance(1, MILLISECONDS);
214     assertSame(two, cache.getUnchecked(key));
215     stats = <font color="#571b7e"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>cache.stats();
216     assertEquals(1, stats.missCount());
217     assertEquals(2, stats.loadSuccessCount());
218     assertEquals(0, stats.loadExceptionCount());
219     assertEquals(3, stats.hitCount());
220   }
221   public void testRefresh_</b></font>getIfPresent() {
222     final Object one = new Object();
223     final Object two = new Object();
224     FakeTicker ticker = new FakeTicker();
225     CacheLoader&lt;Object, Object&gt; loader =
226         new CacheLoader&lt;Object, Object&gt;() {
227           @Override
228           public Object load(Object key) {
229             return one;
230           }
231           @Override
232           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) {
233             return Futures.immediateFuture(two);
234           }
235         };
236     LoadingCache&lt;Object, Object&gt; cache =
237         CacheBuilder.newBuilder()
238             .recordStats()
239             .ticker(ticker)
240             .refreshAfterWrite(1, MILLISECONDS)
241             .build(loader);
242     Object key = new Object();
243     CacheStats stats = cache.stats();
244     assertEquals(0, stats.missCount());
245     assertEquals(0, stats.loadSuccessCount());
246     assertEquals(0, stats.loadExceptionCount());
247     assertEquals(0, stats.hitCount());
248     assertSame(one, cache.getUnchecked(key));
249     stats = cache.stats();
250     assertEquals(1, stats.missCount());
251     assertEquals(1, stats.loadSuccessCount());
252     assertEquals(0, stats.loadExceptionCount());
253     assertEquals(0, stats.hitCount());
254     ticker.advance(1, MILLISECONDS);
255     assertSame(one, cache.getIfPresent(key));
256     stats = cache.stats();
257     assertEquals(1, stats.missCount());
258     assertEquals(1, stats.loadSuccessCount());
259     assertEquals(0, stats.loadExceptionCount());
260     assertEquals(1, stats.hitCount());
261     ticker.advance(1, MILLISECONDS);
262     assertSame(two, cache.getIfPresent(key));
263     stats = cache.stats();
264     assertEquals(1, stats.missCount());
265     assertEquals(2, stats.loadSuccessCount());
266     assertEquals(0, stats.loadExceptionCount());
267     assertEquals(2, stats.hitCount());
268 <a name="2"></a>
269     ticker.advance(1, MILLISECONDS);
270     assertSame(two, cache.getIfPresent(key));
271     stats = <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>cache.stats();
272     assertEquals(1, stats.missCount());
273     assertEquals(2, stats.loadSuccessCount());
274     assertEquals(0, stats.loadExceptionCount());
275     assertEquals(3, stats.hitCount());
276   }
277   public void testBulkLoad_default() throws ExecutionException {
278     LoadingCache&lt;Integer, Integer&gt; cache =
279         CacheBuilder.newBuilder()
280             .recordStats()
281             .build(TestingCacheLoaders.&lt;Integer&gt;identityLoader</b></font>());
282     CacheStats stats = cache.stats();
283     assertEquals(0, stats.missCount());
284     assertEquals(0, stats.loadSuccessCount());
285     assertEquals(0, stats.loadExceptionCount());
286     assertEquals(0, stats.hitCount());
287     assertEquals(ImmutableMap.of(), cache.getAll(ImmutableList.&lt;Integer&gt;of()));
288     assertEquals(0, stats.missCount());
289     assertEquals(0, stats.loadSuccessCount());
290     assertEquals(0, stats.loadExceptionCount());
291     assertEquals(0, stats.hitCount());
292     assertEquals(ImmutableMap.of(1, 1), cache.getAll(asList(1)));
293     stats = cache.stats();
294     assertEquals(1, stats.missCount());
295     assertEquals(1, stats.loadSuccessCount());
296     assertEquals(0, stats.loadExceptionCount());
297     assertEquals(0, stats.hitCount());
298     assertEquals(ImmutableMap.of(1, 1, 2, 2, 3, 3, 4, 4), cache.getAll(asList(1, 2, 3, 4)));
299     stats = cache.stats();
300     assertEquals(4, stats.missCount());
301     assertEquals(4, stats.loadSuccessCount());
302     assertEquals(0, stats.loadExceptionCount());
303     assertEquals(1, stats.hitCount());
304     assertEquals(ImmutableMap.of(2, 2, 3, 3), cache.getAll(asList(2, 3)));
305     stats = cache.stats();
306     assertEquals(4, stats.missCount());
307     assertEquals(4, stats.loadSuccessCount());
308     assertEquals(0, stats.loadExceptionCount());
309     assertEquals(3, stats.hitCount());
310 <a name="10"></a>        assertEquals(ImmutableMap.of(4, 4, 5, 5), cache.getAll(asList(4, 5)));
311     stats = cache.stats();
312     assertEquals(5, <font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>stats.missCount());
313     assertEquals(5, stats.loadSuccessCount());
314     assertEquals(0, stats.loadExceptionCount());
315     assertEquals(4, stats.hitCount());
316   }
317   public void testBulkLoad_loadAll() throws ExecutionException {
318     IdentityLoader&lt;Integer&gt; backingLoader = identityLoader</b></font>();
319     CacheLoader&lt;Integer, Integer&gt; loader = bulkLoader(backingLoader);
320     LoadingCache&lt;Integer, Integer&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
321     CacheStats stats = cache.stats();
322     assertEquals(0, stats.missCount());
323     assertEquals(0, stats.loadSuccessCount());
324     assertEquals(0, stats.loadExceptionCount());
325     assertEquals(0, stats.hitCount());
326     assertEquals(ImmutableMap.of(), cache.getAll(ImmutableList.&lt;Integer&gt;of()));
327     assertEquals(0, stats.missCount());
328     assertEquals(0, stats.loadSuccessCount());
329     assertEquals(0, stats.loadExceptionCount());
330     assertEquals(0, stats.hitCount());
331     assertEquals(ImmutableMap.of(1, 1), cache.getAll(asList(1)));
332     stats = cache.stats();
333     assertEquals(1, stats.missCount());
334     assertEquals(1, stats.loadSuccessCount());
335     assertEquals(0, stats.loadExceptionCount());
336     assertEquals(0, stats.hitCount());
337     assertEquals(ImmutableMap.of(1, 1, 2, 2, 3, 3, 4, 4), cache.getAll(asList(1, 2, 3, 4)));
338     stats = cache.stats();
339     assertEquals(4, stats.missCount());
340     assertEquals(2, stats.loadSuccessCount());
341     assertEquals(0, stats.loadExceptionCount());
342     assertEquals(1, stats.hitCount());
343     assertEquals(ImmutableMap.of(2, 2, 3, 3), cache.getAll(asList(2, 3)));
344     stats = cache.stats();
345     assertEquals(4, stats.missCount());
346     assertEquals(2, stats.loadSuccessCount());
347     assertEquals(0, stats.loadExceptionCount());
348     assertEquals(3, stats.hitCount());
349 <a name="22"></a>    assertEquals(ImmutableMap.of(4, 4, 5, 5), cache.getAll(asList(4, 5)));
350     stats = cache.stats();
351     assertEquals(5, stats.missCount());
352     <font color="#4cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(3, stats.loadSuccessCount());
353     assertEquals(0, stats.loadExceptionCount());
354     assertEquals(4, stats.hitCount());
355   }
356   public void testBulkLoad_extra() throws ExecutionException {
357     CacheLoader&lt;Object, Object&gt; loader =</b></font>
358         new CacheLoader&lt;Object, Object&gt;() {
359           @Override
360           public Object load(Object key) throws Exception {
361             return new Object();
362           }
363           @Override
364           public Map&lt;Object, Object&gt; loadAll(Iterable&lt;?&gt; keys) throws Exception {
365             Map&lt;Object, Object&gt; result = Maps.newHashMap();
366             for (Object key : keys) {
367               Object value = new Object();
368               result.put(key, value);
369               result.put(value, key);
370             }
371             return result;
372           }
373         };
374     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().build(loader);
375     Object[] lookupKeys = new Object[] {new Object(), new Object(), new Object()};
376     Map&lt;Object, Object&gt; result = cache.getAll(asList(lookupKeys));
377 <a name="9"></a>    assertThat(result.keySet()).containsExactlyElementsIn(asList(lookupKeys));
378     for (Entry&lt;Object, Object&gt; entry : result.entrySet()) {
379       Object key = entry.getKey();
380       <font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>Object value = entry.getValue();
381       assertSame(value, result.get(key));
382       assertNull(result.get(value));
383       assertSame(value, cache.asMap().get(key));
384       assertSame(key, cache.asMap().get(value));
385     }</b></font>
386   }
387   public void testBulkLoad_clobber() throws ExecutionException {
388     final Object extraKey = new Object();
389     final Object extraValue = new Object();
390     CacheLoader&lt;Object, Object&gt; loader =
391         new CacheLoader&lt;Object, Object&gt;() {
392           @Override
393           public Object load(Object key) throws Exception {
394             throw new AssertionError();
395           }
396           @Override
397           public Map&lt;Object, Object&gt; loadAll(Iterable&lt;?&gt; keys) throws Exception {
398             Map&lt;Object, Object&gt; result = Maps.newHashMap();
399             for (Object key : keys) {
400               Object value = new Object();
401               result.put(key, value);
402             }
403             result.put(extraKey, extraValue);
404             return result;
405           }
406         };
407     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().build(loader);
408     cache.asMap().put(extraKey, extraKey);
409     assertSame(extraKey, cache.asMap().get(extraKey));
410     Object[] lookupKeys = new Object[] {new Object(), new Object(), new Object()};
411     Map&lt;Object, Object&gt; result = cache.getAll(asList(lookupKeys));
412     assertThat(result.keySet()).containsExactlyElementsIn(asList(lookupKeys));
413     for (Entry&lt;Object, Object&gt; entry : result.entrySet()) {
414       Object key = entry.getKey();
415       Object value = entry.getValue();
416 <a name="41"></a>      assertSame(value, result.get(key));
417       assertSame(value, cache.asMap().get(key));
418     }
419     <font color="#f87a17"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertNull(result.get(extraKey));
420     assertSame(extraValue, cache.asMap().get(extraKey));
421   }
422   public void testBulkLoad_clobberNullValue() throws ExecutionException {
423     final Object extraKey = new Object()</b></font>;
424     final Object extraValue = new Object();
425     CacheLoader&lt;Object, Object&gt; loader =
426         new CacheLoader&lt;Object, Object&gt;() {
427           @Override
428           public Object load(Object key) throws Exception {
429             throw new AssertionError();
430           }
431           @Override
432           public Map&lt;Object, Object&gt; loadAll(Iterable&lt;?&gt; keys) throws Exception {
433             Map&lt;Object, Object&gt; result = Maps.newHashMap();
434             for (Object key : keys) {
435               Object value = new Object();
436               result.put(key, value);
437             }
438             result.put(extraKey, extraValue);
439             result.put(extraValue, null);
440             return result;
441           }
442         };
443     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().build(loader);
444     cache.asMap().put(extraKey, extraKey);
445 <a name="15"></a>    assertSame(extraKey, cache.asMap().get(extraKey));
446     Object[] lookupKeys = new Object[] {new Object(), new Object(), new Object()};
447     <font color="#f52887"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>try {
448       cache.getAll(asList(lookupKeys));
449       fail();
450     } catch (InvalidCacheLoadException expected) {
451     }</b></font>
452 <a name="21"></a>    for (Object key : lookupKeys) {
453       assertTrue(cache.asMap().containsKey(key));
454     }
455     <font color="#947010"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertSame(extraValue, cache.asMap().get(extraKey));
456     assertFalse(cache.asMap().containsKey(extraValue));
457   }
458   public void testBulkLoad_clobberNullKey() throws ExecutionException {
459     final Object extraKey = new Object()</b></font>;
460     final Object extraValue = new Object();
461     CacheLoader&lt;Object, Object&gt; loader =
462         new CacheLoader&lt;Object, Object&gt;() {
463           @Override
464           public Object load(Object key) throws Exception {
465             throw new AssertionError();
466           }
467           @Override
468           public Map&lt;Object, Object&gt; loadAll(Iterable&lt;?&gt; keys) throws Exception {
469             Map&lt;Object, Object&gt; result = Maps.newHashMap();
470             for (Object key : keys) {
471               Object value = new Object();
472               result.put(key, value);
473             }
474             result.put(extraKey, extraValue);
475             result.put(null, extraKey);
476             return result;
477           }
478         };
479     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().build(loader);
480     cache.asMap().put(extraKey, extraKey);
481 <a name="14"></a>    assertSame(extraKey, cache.asMap().get(extraKey));
482     Object[] lookupKeys = new Object[] {new Object(), new Object(), new Object()};
483     <font color="#842dce"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>try {
484       cache.getAll(asList(lookupKeys));
485       fail();
486     } catch (InvalidCacheLoadException expected) {
487     }</b></font>
488 <a name="19"></a>    for (Object key : lookupKeys) {
489       assertTrue(cache.asMap().containsKey(key));
490     }
491     <font color="#f62817"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertSame(extraValue, cache.asMap().get(extraKey));
492     assertFalse(cache.asMap().containsValue(extraKey));
493   }
494   public void testBulkLoad_partial() throws ExecutionException {
495     final Object extraKey = new Object()</b></font>;
496     final Object extraValue = new Object();
497     CacheLoader&lt;Object, Object&gt; loader =
498         new CacheLoader&lt;Object, Object&gt;() {
499           @Override
500           public Object load(Object key) throws Exception {
501             throw new AssertionError();
502           }
503           @Override
504           public Map&lt;Object, Object&gt; loadAll(Iterable&lt;?&gt; keys) throws Exception {
505             Map&lt;Object, Object&gt; result = Maps.newHashMap();
506             result.put(extraKey, extraValue);
507             return result;
508           }
509         };
510     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().build(loader);
511 <a name="42"></a>
512     Object[] lookupKeys = new Object[] {new Object(), new Object(), new Object()};
513     try {
514       <font color="#c57717"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>cache.getAll(asList(lookupKeys));
515       fail();
516     } catch (InvalidCacheLoadException expected) {
517     }</b></font>
518     assertSame(extraValue, cache.asMap().get(extraKey));
519   }
520   public void testLoadNull() throws ExecutionException {
521     LoadingCache&lt;Object, Object&gt; cache =
522         CacheBuilder.newBuilder().recordStats().build(constantLoader(null));
523     CacheStats stats = cache.stats();
524     assertEquals(0, stats.missCount());
525     assertEquals(0, stats.loadSuccessCount());
526     assertEquals(0, stats.loadExceptionCount());
527     assertEquals(0, stats.hitCount());
528     try {
529       cache.get(new Object());
530       fail();
531     } catch (InvalidCacheLoadException expected) {
532     }
533     stats = cache.stats();
534     assertEquals(1, stats.missCount());
535     assertEquals(0, stats.loadSuccessCount());
536     assertEquals(1, stats.loadExceptionCount());
537     assertEquals(0, stats.hitCount());
538     try {
539       cache.getUnchecked(new Object());
540       fail();
541     } catch (InvalidCacheLoadException expected) {
542     }
543     stats = cache.stats();
544     assertEquals(2, stats.missCount());
545     assertEquals(0, stats.loadSuccessCount());
546     assertEquals(2, stats.loadExceptionCount());
547     assertEquals(0, stats.hitCount());
548     cache.refresh(new Object());
549     checkLoggedInvalidLoad();
550     stats = cache.stats();
551     assertEquals(2, stats.missCount());
552     assertEquals(0, stats.loadSuccessCount());
553     assertEquals(3, stats.loadExceptionCount());
554     assertEquals(0, stats.hitCount());
555     try {
556       cache.get(new Object(), Callables.returning(null));
557       fail();
558     } catch (InvalidCacheLoadException expected) {
559     }
560     stats = cache.stats();
561     assertEquals(3, stats.missCount());
562     assertEquals(0, stats.loadSuccessCount());
563     assertEquals(4, stats.loadExceptionCount());
564     assertEquals(0, stats.hitCount());
565     try {
566       cache.getAll(asList(new Object()));
567       fail();
568     } catch (InvalidCacheLoadException expected) {
569 <a name="17"></a>    }
570     stats = cache.stats();
571     assertEquals(4, stats.missCount());
572     <font color="#3090c7"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(0, stats.loadSuccessCount());
573     assertEquals(5, stats.loadExceptionCount());
574     assertEquals(0, stats.hitCount());
575   }
576   public void testReloadNull() throws ExecutionException {
577     final Object one = new Object()</b></font>;
578     CacheLoader&lt;Object, Object&gt; loader =
579         new CacheLoader&lt;Object, Object&gt;() {
580           @Override
581           public Object load(Object key) {
582             return one;
583           }
584           @Override
585           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) {
586             return null;
587           }
588         };
589     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
590     Object key = new Object();
591     CacheStats stats = cache.stats();
592     assertEquals(0, stats.missCount());
593     assertEquals(0, stats.loadSuccessCount());
594     assertEquals(0, stats.loadExceptionCount());
595     assertEquals(0, stats.hitCount());
596     assertSame(one, cache.getUnchecked(key));
597     stats = cache.stats();
598     assertEquals(1, stats.missCount());
599     assertEquals(1, stats.loadSuccessCount());
600     assertEquals(0, stats.loadExceptionCount());
601     assertEquals(0, stats.hitCount());
602     cache.refresh(key);
603     checkLoggedInvalidLoad();
604     stats = cache.stats();
605     assertEquals(1, stats.missCount());
606     assertEquals(1, stats.loadSuccessCount());
607     assertEquals(1, stats.loadExceptionCount());
608     assertEquals(0, stats.hitCount());
609 <a name="16"></a>
610     assertSame(one, cache.getUnchecked(key));
611     stats = cache.stats();
612     assertEquals(1, <font color="#2981b2"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>stats.missCount());
613     assertEquals(1, stats.loadSuccessCount());
614     assertEquals(1, stats.loadExceptionCount());
615     assertEquals(1, stats.hitCount());
616   }
617   public void testReloadNullFuture() throws ExecutionException {</b></font>
618     final Object one = new Object();
619     CacheLoader&lt;Object, Object&gt; loader =
620         new CacheLoader&lt;Object, Object&gt;() {
621           @Override
622           public Object load(Object key) {
623             return one;
624           }
625           @Override
626           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) {
627             return Futures.immediateFuture(null);
628           }
629         };
630     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
631     Object key = new Object();
632     CacheStats stats = cache.stats();
633     assertEquals(0, stats.missCount());
634     assertEquals(0, stats.loadSuccessCount());
635     assertEquals(0, stats.loadExceptionCount());
636     assertEquals(0, stats.hitCount());
637     assertSame(one, cache.getUnchecked(key));
638     stats = cache.stats();
639     assertEquals(1, stats.missCount());
640     assertEquals(1, stats.loadSuccessCount());
641     assertEquals(0, stats.loadExceptionCount());
642     assertEquals(0, stats.hitCount());
643     cache.refresh(key);
644     checkLoggedInvalidLoad();
645     stats = cache.stats();
646     assertEquals(1, stats.missCount());
647     assertEquals(1, stats.loadSuccessCount());
648     assertEquals(1, stats.loadExceptionCount());
649     assertEquals(0, stats.hitCount());
650 <a name="40"></a>    assertSame(one, cache.getUnchecked(key));
651     stats = cache.stats();
652     assertEquals(1, stats.missCount());
653     assertEquals(1, <font color="#347235"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>stats.loadSuccessCount());
654     assertEquals(1, stats.loadExceptionCount());
655     assertEquals(1, stats.hitCount());
656   }
657   public void testRefreshNull() {
658     final Object one = new Object()</b></font>;
659     FakeTicker ticker = new FakeTicker();
660     CacheLoader&lt;Object, Object&gt; loader =
661         new CacheLoader&lt;Object, Object&gt;() {
662           @Override
663           public Object load(Object key) {
664             return one;
665           }
666           @Override
667           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) {
668             return Futures.immediateFuture(null);
669           }
670         };
671     LoadingCache&lt;Object, Object&gt; cache =
672         CacheBuilder.newBuilder()
673             .recordStats()
674             .ticker(ticker)
675             .refreshAfterWrite(1, MILLISECONDS)
676             .build(loader);
677     Object key = new Object();
678     CacheStats stats = cache.stats();
679     assertEquals(0, stats.missCount());
680     assertEquals(0, stats.loadSuccessCount());
681     assertEquals(0, stats.loadExceptionCount());
682     assertEquals(0, stats.hitCount());
683     assertSame(one, cache.getUnchecked(key));
684     stats = cache.stats();
685     assertEquals(1, stats.missCount());
686     assertEquals(1, stats.loadSuccessCount());
687     assertEquals(0, stats.loadExceptionCount());
688     assertEquals(0, stats.hitCount());
689     ticker.advance(1, MILLISECONDS);
690     assertSame(one, cache.getUnchecked(key));
691     stats = cache.stats();
692     assertEquals(1, stats.missCount());
693     assertEquals(1, stats.loadSuccessCount());
694     assertEquals(0, stats.loadExceptionCount());
695     assertEquals(1, stats.hitCount());
696     ticker.advance(1, MILLISECONDS);
697     assertSame(one, cache.getUnchecked(key));
698     stats = cache.stats();
699     assertEquals(1, stats.missCount());
700     assertEquals(1, stats.loadSuccessCount());
701     assertEquals(1, stats.loadExceptionCount());
702     assertEquals(2, stats.hitCount());
703 <a name="1"></a>
704     ticker.advance(1, MILLISECONDS);
705     assertSame(one, cache.getUnchecked(key));
706     stats = <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>cache.stats();
707     assertEquals(1, stats.missCount());
708     assertEquals(1, stats.loadSuccessCount());
709     assertEquals(2, stats.loadExceptionCount());
710     assertEquals(3, stats.hitCount());
711   }
712   public void testBulkLoadNull() throws ExecutionException {
713     LoadingCache&lt;Object, Object&gt; cache =
714         CacheBuilder.newBuilder().recordStats().build(bulkLoader(constantLoader</b></font>(null)));
715     CacheStats stats = cache.stats();
716     assertEquals(0, stats.missCount());
717     assertEquals(0, stats.loadSuccessCount());
718     assertEquals(0, stats.loadExceptionCount());
719     assertEquals(0, stats.hitCount());
720     try {
721       cache.getAll(asList(new Object()));
722 <a name="3"></a>      fail();
723     } catch (InvalidCacheLoadException expected) {
724     }
725     stats = <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>cache.stats();
726     assertEquals(1, stats.missCount());
727     assertEquals(0, stats.loadSuccessCount());
728     assertEquals(1, stats.loadExceptionCount());
729     assertEquals(0, stats.hitCount());
730   }
731   public void testBulkLoadNullMap() throws ExecutionException {
732     LoadingCache&lt;Object, Object&gt; cache =
733         CacheBuilder.newBuilder</b></font>()
734             .recordStats()
735             .build(
736                 new CacheLoader&lt;Object, Object&gt;() {
737                   @Override
738                   public Object load(Object key) {
739                     throw new AssertionError();
740                   }
741                   @Override
742                   public Map&lt;Object, Object&gt; loadAll(Iterable&lt;?&gt; keys) {
743                     return null;
744                   }
745                 });
746     CacheStats stats = cache.stats();
747     assertEquals(0, stats.missCount());
748     assertEquals(0, stats.loadSuccessCount());
749     assertEquals(0, stats.loadExceptionCount());
750     assertEquals(0, stats.hitCount());
751     try {
752       cache.getAll(asList(new Object()));
753       fail();
754     } catch (InvalidCacheLoadException expected) {
755 <a name="38"></a>    }
756     stats = cache.stats();
757     assertEquals(1, stats.missCount());
758     <font color="#348781"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(0, stats.loadSuccessCount());
759     assertEquals(1, stats.loadExceptionCount());
760     assertEquals(0, stats.hitCount());
761   }
762   public void testLoadError() throws ExecutionException {</b></font>
763     Error e = new Error();
764     CacheLoader&lt;Object, Object&gt; loader = errorLoader(e);
765     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
766     CacheStats stats = cache.stats();
767     assertEquals(0, stats.missCount());
768     assertEquals(0, stats.loadSuccessCount());
769     assertEquals(0, stats.loadExceptionCount());
770     assertEquals(0, stats.hitCount());
771     try {
772       cache.get(new Object());
773       fail();
774     } catch (ExecutionError expected) {
775       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
776     }
777     stats = cache.stats();
778     assertEquals(1, stats.missCount());
779     assertEquals(0, stats.loadSuccessCount());
780     assertEquals(1, stats.loadExceptionCount());
781     assertEquals(0, stats.hitCount());
782     try {
783       cache.getUnchecked(new Object());
784       fail();
785     } catch (ExecutionError expected) {
786       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
787     }
788     stats = cache.stats();
789     assertEquals(2, stats.missCount());
790     assertEquals(0, stats.loadSuccessCount());
791     assertEquals(2, stats.loadExceptionCount());
792     assertEquals(0, stats.hitCount());
793     cache.refresh(new Object());
794     checkLoggedCause(e);
795     stats = cache.stats();
796     assertEquals(2, stats.missCount());
797     assertEquals(0, stats.loadSuccessCount());
798     assertEquals(3, stats.loadExceptionCount());
799     assertEquals(0, stats.hitCount());
800     final Error callableError = new Error();
801     try {
802       cache.get(
803           new Object(),
804           new Callable&lt;Object&gt;() {
805             @Override
806             public Object call() {
807               throw callableError;
808             }
809           });
810       fail();
811     } catch (ExecutionError expected) {
812       assertThat(expected).hasCauseThat().isSameInstanceAs(callableError);
813     }
814     stats = cache.stats();
815     assertEquals(3, stats.missCount());
816     assertEquals(0, stats.loadSuccessCount());
817     assertEquals(4, stats.loadExceptionCount());
818     assertEquals(0, stats.hitCount());
819     try {
820       cache.getAll(asList(new Object()));
821       fail();
822     } catch (ExecutionError expected) {
823       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
824 <a name="37"></a>    }
825     stats = cache.stats();
826     assertEquals(4, stats.missCount());
827     <font color="#810541"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(0, stats.loadSuccessCount());
828     assertEquals(5, stats.loadExceptionCount());
829     assertEquals(0, stats.hitCount());
830   }
831   public void testReloadError() throws ExecutionException {</b></font>
832     final Object one = new Object();
833     final Error e = new Error();
834     CacheLoader&lt;Object, Object&gt; loader =
835         new CacheLoader&lt;Object, Object&gt;() {
836           @Override
837           public Object load(Object key) {
838             return one;
839           }
840           @Override
841           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) {
842             throw e;
843           }
844         };
845     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
846     Object key = new Object();
847     CacheStats stats = cache.stats();
848     assertEquals(0, stats.missCount());
849     assertEquals(0, stats.loadSuccessCount());
850     assertEquals(0, stats.loadExceptionCount());
851     assertEquals(0, stats.hitCount());
852     assertSame(one, cache.getUnchecked(key));
853     stats = cache.stats();
854     assertEquals(1, stats.missCount());
855     assertEquals(1, stats.loadSuccessCount());
856     assertEquals(0, stats.loadExceptionCount());
857     assertEquals(0, stats.hitCount());
858     cache.refresh(key);
859     checkLoggedCause(e);
860     stats = cache.stats();
861     assertEquals(1, stats.missCount());
862     assertEquals(1, stats.loadSuccessCount());
863     assertEquals(1, stats.loadExceptionCount());
864     assertEquals(0, stats.hitCount());
865 <a name="36"></a>    assertSame(one, cache.getUnchecked(key));
866     stats = cache.stats();
867     assertEquals(1, stats.missCount());
868     <font color="#ff00ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(1, stats.loadSuccessCount());
869     assertEquals(1, stats.loadExceptionCount());
870     assertEquals(1, stats.hitCount());
871   }
872   public void testReloadFutureError() throws ExecutionException {</b></font>
873     final Object one = new Object();
874     final Error e = new Error();
875     CacheLoader&lt;Object, Object&gt; loader =
876         new CacheLoader&lt;Object, Object&gt;() {
877           @Override
878           public Object load(Object key) {
879             return one;
880           }
881           @Override
882           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) {
883             return Futures.immediateFailedFuture(e);
884           }
885         };
886     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
887     Object key = new Object();
888     CacheStats stats = cache.stats();
889     assertEquals(0, stats.missCount());
890     assertEquals(0, stats.loadSuccessCount());
891     assertEquals(0, stats.loadExceptionCount());
892     assertEquals(0, stats.hitCount());
893     assertSame(one, cache.getUnchecked(key));
894     stats = cache.stats();
895     assertEquals(1, stats.missCount());
896     assertEquals(1, stats.loadSuccessCount());
897     assertEquals(0, stats.loadExceptionCount());
898     assertEquals(0, stats.hitCount());
899     cache.refresh(key);
900     checkLoggedCause(e);
901     stats = cache.stats();
902     assertEquals(1, stats.missCount());
903     assertEquals(1, stats.loadSuccessCount());
904     assertEquals(1, stats.loadExceptionCount());
905     assertEquals(0, stats.hitCount());
906 <a name="35"></a>    assertSame(one, cache.getUnchecked(key));
907     stats = cache.stats();
908     assertEquals(1, stats.missCount());
909     <font color="#41a317"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(1, stats.loadSuccessCount());
910     assertEquals(1, stats.loadExceptionCount());
911     assertEquals(1, stats.hitCount());
912   }
913   public void testRefreshError() {</b></font>
914     final Object one = new Object();
915     final Error e = new Error();
916     FakeTicker ticker = new FakeTicker();
917     CacheLoader&lt;Object, Object&gt; loader =
918         new CacheLoader&lt;Object, Object&gt;() {
919           @Override
920           public Object load(Object key) {
921             return one;
922           }
923           @Override
924           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) {
925             return Futures.immediateFailedFuture(e);
926           }
927         };
928     LoadingCache&lt;Object, Object&gt; cache =
929         CacheBuilder.newBuilder()
930             .recordStats()
931             .ticker(ticker)
932             .refreshAfterWrite(1, MILLISECONDS)
933             .build(loader);
934     Object key = new Object();
935     CacheStats stats = cache.stats();
936     assertEquals(0, stats.missCount());
937     assertEquals(0, stats.loadSuccessCount());
938     assertEquals(0, stats.loadExceptionCount());
939     assertEquals(0, stats.hitCount());
940     assertSame(one, cache.getUnchecked(key));
941     stats = cache.stats();
942     assertEquals(1, stats.missCount());
943     assertEquals(1, stats.loadSuccessCount());
944     assertEquals(0, stats.loadExceptionCount());
945     assertEquals(0, stats.hitCount());
946     ticker.advance(1, MILLISECONDS);
947     assertSame(one, cache.getUnchecked(key));
948     stats = cache.stats();
949     assertEquals(1, stats.missCount());
950     assertEquals(1, stats.loadSuccessCount());
951     assertEquals(0, stats.loadExceptionCount());
952     assertEquals(1, stats.hitCount());
953     ticker.advance(1, MILLISECONDS);
954     assertSame(one, cache.getUnchecked(key));
955     stats = cache.stats();
956     assertEquals(1, stats.missCount());
957     assertEquals(1, stats.loadSuccessCount());
958     assertEquals(1, stats.loadExceptionCount());
959     assertEquals(2, stats.hitCount());
960     ticker.advance(1, MILLISECONDS);
961 <a name="34"></a>    assertSame(one, cache.getUnchecked(key));
962     stats = cache.stats();
963     assertEquals(1, stats.missCount());
964     <font color="#827d6b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(1, stats.loadSuccessCount());
965     assertEquals(2, stats.loadExceptionCount());
966     assertEquals(3, stats.hitCount());
967   }
968   public void testBulkLoadError() throws ExecutionException {</b></font>
969     Error e = new Error();
970     CacheLoader&lt;Object, Object&gt; loader = errorLoader(e);
971     LoadingCache&lt;Object, Object&gt; cache =
972         CacheBuilder.newBuilder().recordStats().build(bulkLoader(loader));
973     CacheStats stats = cache.stats();
974     assertEquals(0, stats.missCount());
975     assertEquals(0, stats.loadSuccessCount());
976     assertEquals(0, stats.loadExceptionCount());
977     assertEquals(0, stats.hitCount());
978     try {
979       cache.getAll(asList(new Object()));
980       fail();
981     } catch (ExecutionError expected) {
982       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
983 <a name="33"></a>    }
984     stats = cache.stats();
985     assertEquals(1, stats.missCount());
986     <font color="#736aff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(0, stats.loadSuccessCount());
987     assertEquals(1, stats.loadExceptionCount());
988     assertEquals(0, stats.hitCount());
989   }
990   public void testLoadCheckedException() {</b></font>
991     Exception e = new Exception();
992     CacheLoader&lt;Object, Object&gt; loader = exceptionLoader(e);
993     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
994     CacheStats stats = cache.stats();
995     assertEquals(0, stats.missCount());
996     assertEquals(0, stats.loadSuccessCount());
997     assertEquals(0, stats.loadExceptionCount());
998     assertEquals(0, stats.hitCount());
999     try {
1000       cache.get(new Object());
1001       fail();
1002     } catch (ExecutionException expected) {
1003       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
1004     }
1005     stats = cache.stats();
1006     assertEquals(1, stats.missCount());
1007     assertEquals(0, stats.loadSuccessCount());
1008     assertEquals(1, stats.loadExceptionCount());
1009     assertEquals(0, stats.hitCount());
1010     try {
1011       cache.getUnchecked(new Object());
1012       fail();
1013     } catch (UncheckedExecutionException expected) {
1014       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
1015     }
1016     stats = cache.stats();
1017     assertEquals(2, stats.missCount());
1018     assertEquals(0, stats.loadSuccessCount());
1019     assertEquals(2, stats.loadExceptionCount());
1020     assertEquals(0, stats.hitCount());
1021     cache.refresh(new Object());
1022     checkLoggedCause(e);
1023     stats = cache.stats();
1024     assertEquals(2, stats.missCount());
1025     assertEquals(0, stats.loadSuccessCount());
1026     assertEquals(3, stats.loadExceptionCount());
1027     assertEquals(0, stats.hitCount());
1028     Exception callableException = new Exception();
1029     try {
1030       cache.get(new Object(), throwing(callableException));
1031       fail();
1032     } catch (ExecutionException expected) {
1033       assertThat(expected).hasCauseThat().isSameInstanceAs(callableException);
1034     }
1035     stats = cache.stats();
1036     assertEquals(3, stats.missCount());
1037     assertEquals(0, stats.loadSuccessCount());
1038     assertEquals(4, stats.loadExceptionCount());
1039     assertEquals(0, stats.hitCount());
1040     try {
1041       cache.getAll(asList(new Object()));
1042       fail();
1043     } catch (ExecutionException expected) {
1044       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
1045 <a name="32"></a>    }
1046     stats = cache.stats();
1047     assertEquals(4, stats.missCount());
1048     <font color="#5b8daf"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(0, stats.loadSuccessCount());
1049     assertEquals(5, stats.loadExceptionCount());
1050     assertEquals(0, stats.hitCount());
1051   }
1052   public void testLoadInterruptedException() {</b></font>
1053     Exception e = new InterruptedException();
1054     CacheLoader&lt;Object, Object&gt; loader = exceptionLoader(e);
1055     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
1056     CacheStats stats = cache.stats();
1057     assertEquals(0, stats.missCount());
1058     assertEquals(0, stats.loadSuccessCount());
1059     assertEquals(0, stats.loadExceptionCount());
1060     assertEquals(0, stats.hitCount());
1061     assertFalse(currentThread().interrupted());
1062     try {
1063       cache.get(new Object());
1064       fail();
1065     } catch (ExecutionException expected) {
1066       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
1067     }
1068     assertTrue(currentThread().interrupted());
1069     stats = cache.stats();
1070     assertEquals(1, stats.missCount());
1071     assertEquals(0, stats.loadSuccessCount());
1072     assertEquals(1, stats.loadExceptionCount());
1073     assertEquals(0, stats.hitCount());
1074     try {
1075       cache.getUnchecked(new Object());
1076       fail();
1077     } catch (UncheckedExecutionException expected) {
1078       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
1079     }
1080     assertTrue(currentThread().interrupted());
1081     stats = cache.stats();
1082     assertEquals(2, stats.missCount());
1083     assertEquals(0, stats.loadSuccessCount());
1084     assertEquals(2, stats.loadExceptionCount());
1085     assertEquals(0, stats.hitCount());
1086     cache.refresh(new Object());
1087     assertTrue(currentThread().interrupted());
1088     checkLoggedCause(e);
1089     stats = cache.stats();
1090     assertEquals(2, stats.missCount());
1091     assertEquals(0, stats.loadSuccessCount());
1092     assertEquals(3, stats.loadExceptionCount());
1093     assertEquals(0, stats.hitCount());
1094     Exception callableException = new InterruptedException();
1095     try {
1096       cache.get(new Object(), throwing(callableException));
1097       fail();
1098     } catch (ExecutionException expected) {
1099       assertThat(expected).hasCauseThat().isSameInstanceAs(callableException);
1100     }
1101     assertTrue(currentThread().interrupted());
1102     stats = cache.stats();
1103     assertEquals(3, stats.missCount());
1104     assertEquals(0, stats.loadSuccessCount());
1105     assertEquals(4, stats.loadExceptionCount());
1106     assertEquals(0, stats.hitCount());
1107     try {
1108       cache.getAll(asList(new Object()));
1109       fail();
1110     } catch (ExecutionException expected) {
1111       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
1112     }
1113 <a name="31"></a>    assertTrue(currentThread().interrupted());
1114     stats = cache.stats();
1115     assertEquals(4, stats.missCount());
1116     <font color="#3ea99f"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(0, stats.loadSuccessCount());
1117     assertEquals(5, stats.loadExceptionCount());
1118     assertEquals(0, stats.hitCount());
1119   }
1120   public void testReloadCheckedException() {</b></font>
1121     final Object one = new Object();
1122     final Exception e = new Exception();
1123     CacheLoader&lt;Object, Object&gt; loader =
1124         new CacheLoader&lt;Object, Object&gt;() {
1125           @Override
1126           public Object load(Object key) {
1127             return one;
1128           }
1129           @Override
1130           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) throws Exception {
1131             throw e;
1132           }
1133         };
1134     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
1135     Object key = new Object();
1136     CacheStats stats = cache.stats();
1137     assertEquals(0, stats.missCount());
1138     assertEquals(0, stats.loadSuccessCount());
1139     assertEquals(0, stats.loadExceptionCount());
1140     assertEquals(0, stats.hitCount());
1141     assertSame(one, cache.getUnchecked(key));
1142     stats = cache.stats();
1143     assertEquals(1, stats.missCount());
1144     assertEquals(1, stats.loadSuccessCount());
1145     assertEquals(0, stats.loadExceptionCount());
1146     assertEquals(0, stats.hitCount());
1147     cache.refresh(key);
1148     checkLoggedCause(e);
1149     stats = cache.stats();
1150     assertEquals(1, stats.missCount());
1151     assertEquals(1, stats.loadSuccessCount());
1152     assertEquals(1, stats.loadExceptionCount());
1153     assertEquals(0, stats.hitCount());
1154 <a name="27"></a>    assertSame(one, cache.getUnchecked(key));
1155     stats = cache.stats();
1156     assertEquals(1, stats.missCount());
1157     <font color="#e77471"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(1, stats.loadSuccessCount());
1158     assertEquals(1, stats.loadExceptionCount());
1159     assertEquals(1, stats.hitCount());
1160   }
1161   public void testReloadFutureCheckedException() {</b></font>
1162     final Object one = new Object();
1163     final Exception e = new Exception();
1164     CacheLoader&lt;Object, Object&gt; loader =
1165         new CacheLoader&lt;Object, Object&gt;() {
1166           @Override
1167           public Object load(Object key) {
1168             return one;
1169           }
1170           @Override
1171           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) {
1172             return Futures.immediateFailedFuture(e);
1173           }
1174         };
1175     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
1176     Object key = new Object();
1177     CacheStats stats = cache.stats();
1178     assertEquals(0, stats.missCount());
1179     assertEquals(0, stats.loadSuccessCount());
1180     assertEquals(0, stats.loadExceptionCount());
1181     assertEquals(0, stats.hitCount());
1182     assertSame(one, cache.getUnchecked(key));
1183     stats = cache.stats();
1184     assertEquals(1, stats.missCount());
1185     assertEquals(1, stats.loadSuccessCount());
1186     assertEquals(0, stats.loadExceptionCount());
1187     assertEquals(0, stats.hitCount());
1188     cache.refresh(key);
1189     checkLoggedCause(e);
1190     stats = cache.stats();
1191     assertEquals(1, stats.missCount());
1192     assertEquals(1, stats.loadSuccessCount());
1193     assertEquals(1, stats.loadExceptionCount());
1194     assertEquals(0, stats.hitCount());
1195 <a name="45"></a>    assertSame(one, cache.getUnchecked(key));
1196     stats = cache.stats();
1197     assertEquals(1, stats.missCount());
1198     assertEquals(1, <font color="#549748"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>stats.loadSuccessCount());
1199     assertEquals(1, stats.loadExceptionCount());
1200     assertEquals(1, stats.hitCount());
1201   }
1202   public void testRefreshCheckedException() {</b></font>
1203     final Object one = new Object();
1204     final Exception e = new Exception();
1205     FakeTicker ticker = new FakeTicker();
1206     CacheLoader&lt;Object, Object&gt; loader =
1207         new CacheLoader&lt;Object, Object&gt;() {
1208           @Override
1209           public Object load(Object key) {
1210             return one;
1211           }
1212           @Override
1213           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) {
1214             return Futures.immediateFailedFuture(e);
1215           }
1216         };
1217     LoadingCache&lt;Object, Object&gt; cache =
1218         CacheBuilder.newBuilder()
1219             .recordStats()
1220             .ticker(ticker)
1221             .refreshAfterWrite(1, MILLISECONDS)
1222             .build(loader);
1223     Object key = new Object();
1224     CacheStats stats = cache.stats();
1225     assertEquals(0, stats.missCount());
1226     assertEquals(0, stats.loadSuccessCount());
1227     assertEquals(0, stats.loadExceptionCount());
1228     assertEquals(0, stats.hitCount());
1229     assertSame(one, cache.getUnchecked(key));
1230     stats = cache.stats();
1231     assertEquals(1, stats.missCount());
1232     assertEquals(1, stats.loadSuccessCount());
1233     assertEquals(0, stats.loadExceptionCount());
1234     assertEquals(0, stats.hitCount());
1235     ticker.advance(1, MILLISECONDS);
1236     assertSame(one, cache.getUnchecked(key));
1237     stats = cache.stats();
1238     assertEquals(1, stats.missCount());
1239     assertEquals(1, stats.loadSuccessCount());
1240     assertEquals(0, stats.loadExceptionCount());
1241     assertEquals(1, stats.hitCount());
1242     ticker.advance(1, MILLISECONDS);
1243     assertSame(one, cache.getUnchecked(key));
1244     stats = cache.stats();
1245     assertEquals(1, stats.missCount());
1246     assertEquals(1, stats.loadSuccessCount());
1247     assertEquals(1, stats.loadExceptionCount());
1248     assertEquals(2, stats.hitCount());
1249     ticker.advance(1, MILLISECONDS);
1250 <a name="44"></a>    assertSame(one, cache.getUnchecked(key));
1251     stats = cache.stats();
1252     assertEquals(1, stats.missCount());
1253     assertEquals(1, <font color="#a057a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>stats.loadSuccessCount());
1254     assertEquals(2, stats.loadExceptionCount());
1255     assertEquals(3, stats.hitCount());
1256   }
1257   public void testBulkLoadCheckedException() {</b></font>
1258     Exception e = new Exception();
1259     CacheLoader&lt;Object, Object&gt; loader = exceptionLoader(e);
1260     LoadingCache&lt;Object, Object&gt; cache =
1261         CacheBuilder.newBuilder().recordStats().build(bulkLoader(loader));
1262     CacheStats stats = cache.stats();
1263     assertEquals(0, stats.missCount());
1264     assertEquals(0, stats.loadSuccessCount());
1265     assertEquals(0, stats.loadExceptionCount());
1266     assertEquals(0, stats.hitCount());
1267     try {
1268       cache.getAll(asList(new Object()));
1269       fail();
1270     } catch (ExecutionException expected) {
1271       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
1272     }
1273     stats = cache.stats();
1274     assertEquals(1, stats.missCount());
1275     assertEquals(0, stats.loadSuccessCount());
1276     assertEquals(1, stats.loadExceptionCount());
1277     assertEquals(0, stats.hitCount());
1278   }
1279   public void testBulkLoadInterruptedException() {
1280     Exception e = new InterruptedException();
1281     CacheLoader&lt;Object, Object&gt; loader = exceptionLoader(e);
1282     LoadingCache&lt;Object, Object&gt; cache =
1283         CacheBuilder.newBuilder().recordStats().build(bulkLoader(loader));
1284     CacheStats stats = cache.stats();
1285     assertEquals(0, stats.missCount());
1286     assertEquals(0, stats.loadSuccessCount());
1287     assertEquals(0, stats.loadExceptionCount());
1288     assertEquals(0, stats.hitCount());
1289     try {
1290       cache.getAll(asList(new Object()));
1291       fail();
1292     } catch (ExecutionException expected) {
1293       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
1294     }
1295     assertTrue(currentThread().interrupted());
1296     stats = cache.stats();
1297     assertEquals(1, stats.missCount());
1298     assertEquals(0, stats.loadSuccessCount());
1299     assertEquals(1, stats.loadExceptionCount());
1300     assertEquals(0, stats.hitCount());
1301   }
1302   public void testLoadUncheckedException() throws ExecutionException {
1303     Exception e = new RuntimeException();
1304     CacheLoader&lt;Object, Object&gt; loader = exceptionLoader(e);
1305     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
1306     CacheStats stats = cache.stats();
1307     assertEquals(0, stats.missCount());
1308     assertEquals(0, stats.loadSuccessCount());
1309     assertEquals(0, stats.loadExceptionCount());
1310     assertEquals(0, stats.hitCount());
1311     try {
1312       cache.get(new Object());
1313       fail();
1314     } catch (UncheckedExecutionException expected) {
1315       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
1316     }
1317     stats = cache.stats();
1318     assertEquals(1, stats.missCount());
1319     assertEquals(0, stats.loadSuccessCount());
1320     assertEquals(1, stats.loadExceptionCount());
1321     assertEquals(0, stats.hitCount());
1322     try {
1323       cache.getUnchecked(new Object());
1324       fail();
1325     } catch (UncheckedExecutionException expected) {
1326       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
1327     }
1328     stats = cache.stats();
1329     assertEquals(2, stats.missCount());
1330     assertEquals(0, stats.loadSuccessCount());
1331     assertEquals(2, stats.loadExceptionCount());
1332     assertEquals(0, stats.hitCount());
1333     cache.refresh(new Object());
1334     checkLoggedCause(e);
1335     stats = cache.stats();
1336     assertEquals(2, stats.missCount());
1337     assertEquals(0, stats.loadSuccessCount());
1338     assertEquals(3, stats.loadExceptionCount());
1339     assertEquals(0, stats.hitCount());
1340     Exception callableException = new RuntimeException();
1341     try {
1342       cache.get(new Object(), throwing(callableException));
1343       fail();
1344     } catch (UncheckedExecutionException expected) {
1345       assertThat(expected).hasCauseThat().isSameInstanceAs(callableException);
1346     }
1347     stats = cache.stats();
1348     assertEquals(3, stats.missCount());
1349     assertEquals(0, stats.loadSuccessCount());
1350     assertEquals(4, stats.loadExceptionCount());
1351     assertEquals(0, stats.hitCount());
1352     try {
1353       cache.getAll(asList(new Object()));
1354       fail();
1355     } catch (UncheckedExecutionException expected) {
1356       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
1357     }
1358     stats = cache.stats();
1359     assertEquals(4, stats.missCount());
1360     assertEquals(0, stats.loadSuccessCount());
1361     assertEquals(5, stats.loadExceptionCount());
1362     assertEquals(0, stats.hitCount());
1363   }
1364   public void testReloadUncheckedException() throws ExecutionException {
1365     final Object one = new Object();
1366     final Exception e = new RuntimeException();
1367     CacheLoader&lt;Object, Object&gt; loader =
1368         new CacheLoader&lt;Object, Object&gt;() {
1369           @Override
1370           public Object load(Object key) {
1371             return one;
1372           }
1373           @Override
1374           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) throws Exception {
1375             throw e;
1376           }
1377         };
1378     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
1379     Object key = new Object();
1380     CacheStats stats = cache.stats();
1381     assertEquals(0, stats.missCount());
1382     assertEquals(0, stats.loadSuccessCount());
1383     assertEquals(0, stats.loadExceptionCount());
1384     assertEquals(0, stats.hitCount());
1385     assertSame(one, cache.getUnchecked(key));
1386     stats = cache.stats();
1387     assertEquals(1, stats.missCount());
1388     assertEquals(1, stats.loadSuccessCount());
1389     assertEquals(0, stats.loadExceptionCount());
1390     assertEquals(0, stats.hitCount());
1391     cache.refresh(key);
1392     checkLoggedCause(e);
1393     stats = cache.stats();
1394     assertEquals(1, stats.missCount());
1395     assertEquals(1, stats.loadSuccessCount());
1396     assertEquals(1, stats.loadExceptionCount());
1397     assertEquals(0, stats.hitCount());
1398     assertSame(one, cache.getUnchecked(key));
1399     stats = cache.stats();
1400     assertEquals(1, stats.missCount());
1401     assertEquals(1, stats.loadSuccessCount());
1402     assertEquals(1, stats.loadExceptionCount());
1403     assertEquals(1, stats.hitCount());
1404   }
1405   public void testReloadFutureUncheckedException() throws ExecutionException {
1406     final Object one = new Object();
1407     final Exception e = new RuntimeException();
1408     CacheLoader&lt;Object, Object&gt; loader =
1409         new CacheLoader&lt;Object, Object&gt;() {
1410           @Override
1411           public Object load(Object key) {
1412             return one;
1413           }
1414           @Override
1415           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) {
1416             return Futures.immediateFailedFuture(e);
1417           }
1418         };
1419     LoadingCache&lt;Object, Object&gt; cache = CacheBuilder.newBuilder().recordStats().build(loader);
1420     Object key = new Object();
1421     CacheStats stats = cache.stats();
1422     assertEquals(0, stats.missCount());
1423     assertEquals(0, stats.loadSuccessCount());
1424     assertEquals(0, stats.loadExceptionCount());
1425     assertEquals(0, stats.hitCount());
1426     assertSame(one, cache.getUnchecked(key));
1427     stats = cache.stats();
1428     assertEquals(1, stats.missCount());
1429     assertEquals(1, stats.loadSuccessCount());
1430     assertEquals(0, stats.loadExceptionCount());
1431     assertEquals(0, stats.hitCount());
1432     cache.refresh(key);
1433     checkLoggedCause(e);
1434     stats = cache.stats();
1435     assertEquals(1, stats.missCount());
1436     assertEquals(1, stats.loadSuccessCount());
1437     assertEquals(1, stats.loadExceptionCount());
1438     assertEquals(0, stats.hitCount());
1439     assertSame(one, cache.getUnchecked(key));
1440     stats = cache.stats();
1441     assertEquals(1, stats.missCount());
1442     assertEquals(1, stats.loadSuccessCount());
1443     assertEquals(1, stats.loadExceptionCount());
1444     assertEquals(1, stats.hitCount());
1445   }
1446   public void testRefreshUncheckedException() {
1447     final Object one = new Object();
1448     final Exception e = new RuntimeException();
1449     FakeTicker ticker = new FakeTicker();
1450     CacheLoader&lt;Object, Object&gt; loader =
1451         new CacheLoader&lt;Object, Object&gt;() {
1452           @Override
1453           public Object load(Object key) {
1454             return one;
1455           }
1456           @Override
1457           public ListenableFuture&lt;Object&gt; reload(Object key, Object oldValue) {
1458             return Futures.immediateFailedFuture(e);
1459           }
1460         };
1461     LoadingCache&lt;Object, Object&gt; cache =
1462         CacheBuilder.newBuilder()
1463             .recordStats()
1464             .ticker(ticker)
1465             .refreshAfterWrite(1, MILLISECONDS)
1466             .build(loader);
1467     Object key = new Object();
1468     CacheStats stats = cache.stats();
1469     assertEquals(0, stats.missCount());
1470     assertEquals(0, stats.loadSuccessCount());
1471     assertEquals(0, stats.loadExceptionCount());
1472     assertEquals(0, stats.hitCount());
1473     assertSame(one, cache.getUnchecked(key));
1474     stats = cache.stats();
1475     assertEquals(1, stats.missCount());
1476     assertEquals(1, stats.loadSuccessCount());
1477     assertEquals(0, stats.loadExceptionCount());
1478     assertEquals(0, stats.hitCount());
1479     ticker.advance(1, MILLISECONDS);
1480     assertSame(one, cache.getUnchecked(key));
1481     stats = cache.stats();
1482     assertEquals(1, stats.missCount());
1483     assertEquals(1, stats.loadSuccessCount());
1484     assertEquals(0, stats.loadExceptionCount());
1485     assertEquals(1, stats.hitCount());
1486     ticker.advance(1, MILLISECONDS);
1487     assertSame(one, cache.getUnchecked(key));
1488     stats = cache.stats();
1489     assertEquals(1, stats.missCount());
1490     assertEquals(1, stats.loadSuccessCount());
1491     assertEquals(1, stats.loadExceptionCount());
1492     assertEquals(2, stats.hitCount());
1493     ticker.advance(1, MILLISECONDS);
1494     assertSame(one, cache.getUnchecked(key));
1495     stats = cache.stats();
1496     assertEquals(1, stats.missCount());
1497     assertEquals(1, stats.loadSuccessCount());
1498     assertEquals(2, stats.loadExceptionCount());
1499     assertEquals(3, stats.hitCount());
1500   }
1501   public void testBulkLoadUncheckedException() throws ExecutionException {
1502     Exception e = new RuntimeException();
1503     CacheLoader&lt;Object, Object&gt; loader = exceptionLoader(e);
1504     LoadingCache&lt;Object, Object&gt; cache =
1505         CacheBuilder.newBuilder().recordStats().build(bulkLoader(loader));
1506     CacheStats stats = cache.stats();
1507     assertEquals(0, stats.missCount());
1508     assertEquals(0, stats.loadSuccessCount());
1509     assertEquals(0, stats.loadExceptionCount());
1510     assertEquals(0, stats.hitCount());
1511     try {
1512       cache.getAll(asList(new Object()));
1513       fail();
1514     } catch (UncheckedExecutionException expected) {
1515       assertThat(expected).hasCauseThat().isSameInstanceAs(e);
1516     }
1517     stats = cache.stats();
1518     assertEquals(1, stats.missCount());
1519     assertEquals(0, stats.loadSuccessCount());
1520     assertEquals(1, stats.loadExceptionCount());
1521     assertEquals(0, stats.hitCount());
1522   }
1523   public void testReloadAfterFailure() throws ExecutionException {
1524     final AtomicInteger count = new AtomicInteger();
1525     final Exception e = new IllegalStateException("exception to trigger failure on first load()");
1526     CacheLoader&lt;Integer, String&gt; failOnceFunction =
1527         new CacheLoader&lt;Integer, String&gt;() {
1528           @Override
1529           public String load(Integer key) throws Exception {
1530             if (count.getAndIncrement() == 0) {
1531               throw e;
1532             }
1533             return key.toString();
1534           }
1535 <a name="23"></a>        };
1536     CountingRemovalListener&lt;Integer, String&gt; removalListener = countingRemovalListener();
1537     LoadingCache&lt;Integer, String&gt; cache =
1538         <font color="#f660ab"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>CacheBuilder.newBuilder().removalListener(removalListener).build(failOnceFunction);
1539     try {
1540       cache.getUnchecked(1);
1541       fail();
1542     } catch (UncheckedExecutionException ue) {</b></font>
1543 <a name="4"></a>      assertThat(ue).hasCauseThat().isSameInstanceAs(e);
1544     }
1545     assertEquals("1", <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>cache.getUnchecked(1));
1546     assertEquals(0, removalListener.getCount());
1547     count.set(0);
1548     cache.refresh(2);
1549     checkLoggedCause(e);
1550     assertEquals("2", cache.getUnchecked(2));
1551     assertEquals(0, removalListener.getCount());
1552   }
1553   public void testReloadAfterValueReclamation() throws InterruptedException, ExecutionException {
1554     CountingLoader countingLoader = new CountingLoader()</b></font>;
1555     LoadingCache&lt;Object, Object&gt; cache =
1556         CacheBuilder.newBuilder().weakValues().build(countingLoader);
1557     ConcurrentMap&lt;Object, Object&gt; map = cache.asMap();
1558     int iterations = 10;
1559     WeakReference&lt;Object&gt; ref = new WeakReference&lt;&gt;(null);
1560     int expectedComputations = 0;
1561     for (int i = 0; i &lt; iterations; i++) {
1562       Object oldValue = ref.get();
1563       if (oldValue == null) {
1564         expectedComputations++;
1565       }
1566       ref = new WeakReference&lt;&gt;(cache.getUnchecked(1));
1567       oldValue = null;
1568       Thread.sleep(i);
1569       System.gc();
1570     }
1571     assertEquals(expectedComputations, countingLoader.getCount());
1572     for (int i = 0; i &lt; iterations; i++) {
1573       Object oldValue = ref.get();
1574       if (oldValue == null) {
1575         expectedComputations++;
1576       }
1577       cache.refresh(1);
1578       checkNothingLogged();
1579       ref = new WeakReference&lt;&gt;(map.get(1));
1580       oldValue = null;
1581       Thread.sleep(i);
1582       System.gc();
1583     }
1584     assertEquals(expectedComputations, countingLoader.getCount());
1585   }
1586   public void testReloadAfterSimulatedValueReclamation() throws ExecutionException {
1587     CountingLoader countingLoader = new CountingLoader();
1588     LoadingCache&lt;Object, Object&gt; cache =
1589         CacheBuilder.newBuilder().concurrencyLevel(1).weakValues().build(countingLoader);
1590     Object key = new Object();
1591     assertNotNull(cache.getUnchecked(key));
1592     CacheTesting.simulateValueReclamation(cache, key);
1593 <a name="8"></a>
1594     assertNotNull(cache.getUnchecked(key));
1595     assertEquals(1, <font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>cache.size());
1596     assertEquals(2, countingLoader.getCount());
1597     CacheTesting.simulateValueReclamation(cache, key);
1598     cache.refresh(key);
1599     checkNothingLogged();
1600     assertEquals(1, cache.size());
1601     assertEquals(3, countingLoader.getCount());
1602   }
1603   public void testReloadAfterSimulatedKeyReclamation() throws ExecutionException {</b></font>
1604     CountingLoader countingLoader = new CountingLoader();
1605     LoadingCache&lt;Object, Object&gt; cache =
1606         CacheBuilder.newBuilder().concurrencyLevel(1).weakKeys().build(countingLoader);
1607     Object key = new Object();
1608 <a name="7"></a>    assertNotNull(cache.getUnchecked(key));
1609     assertEquals(1, cache.size());
1610     <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>CacheTesting.simulateKeyReclamation(cache, key);
1611     assertNotNull(cache.getUnchecked(key));
1612     assertEquals(2, countingLoader.getCount());
1613     CacheTesting.simulateKeyReclamation(cache, key);
1614     cache.refresh(key);
1615     checkNothingLogged();
1616     assertEquals(3, countingLoader.getCount());
1617   }
1618   public void testLoadingExceptionWithCause() {</b></font>
1619     final Exception cause = new Exception();
1620     final UncheckedExecutionException uee = new UncheckedExecutionException(cause);
1621     final ExecutionException ee = new ExecutionException(cause);
1622     LoadingCache&lt;Object, Object&gt; cacheUnchecked =
1623         CacheBuilder.newBuilder().build(exceptionLoader(uee));
1624     LoadingCache&lt;Object, Object&gt; cacheChecked =
1625         CacheBuilder.newBuilder().build(exceptionLoader(ee));
1626     try {
1627       cacheUnchecked.get(new Object());
1628       fail();
1629     } catch (ExecutionException e) {
1630       fail();
1631     } catch (UncheckedExecutionException caughtEe) {
1632       assertThat(caughtEe).hasCauseThat().isSameInstanceAs(uee);
1633     }
1634     try {
1635       cacheUnchecked.getUnchecked(new Object());
1636       fail();
1637     } catch (UncheckedExecutionException caughtUee) {
1638       assertThat(caughtUee).hasCauseThat().isSameInstanceAs(uee);
1639     }
1640     cacheUnchecked.refresh(new Object());
1641     checkLoggedCause(uee);
1642     try {
1643       cacheUnchecked.getAll(asList(new Object()));
1644       fail();
1645     } catch (ExecutionException e) {
1646       fail();
1647     } catch (UncheckedExecutionException caughtEe) {
1648       assertThat(caughtEe).hasCauseThat().isSameInstanceAs(uee);
1649     }
1650     try {
1651       cacheChecked.get(new Object());
1652       fail();
1653     } catch (ExecutionException caughtEe) {
1654       assertThat(caughtEe).hasCauseThat().isSameInstanceAs(ee);
1655     }
1656     try {
1657       cacheChecked.getUnchecked(new Object());
1658       fail();
1659     } catch (UncheckedExecutionException caughtUee) {
1660       assertThat(caughtUee).hasCauseThat().isSameInstanceAs(ee);
1661     }
1662     cacheChecked.refresh(new Object());
1663     checkLoggedCause(ee);
1664     try {
1665       cacheChecked.getAll(asList(new Object()));
1666       fail();
1667     } catch (ExecutionException caughtEe) {
1668       assertThat(caughtEe).hasCauseThat().isSameInstanceAs(ee);
1669     }
1670   }
1671   public void testBulkLoadingExceptionWithCause() {
1672     final Exception cause = new Exception();
1673     final UncheckedExecutionException uee = new UncheckedExecutionException(cause);
1674     final ExecutionException ee = new ExecutionException(cause);
1675     LoadingCache&lt;Object, Object&gt; cacheUnchecked =
1676         CacheBuilder.newBuilder().build(bulkLoader(exceptionLoader(uee)));
1677     LoadingCache&lt;Object, Object&gt; cacheChecked =
1678         CacheBuilder.newBuilder().build(bulkLoader(exceptionLoader(ee)));
1679     try {
1680       cacheUnchecked.getAll(asList(new Object()));
1681       fail();
1682     } catch (ExecutionException e) {
1683       fail();
1684     } catch (UncheckedExecutionException caughtEe) {
1685       assertThat(caughtEe).hasCauseThat().isSameInstanceAs(uee);
1686     }
1687     try {
1688       cacheChecked.getAll(asList(new Object()));
1689       fail();
1690     } catch (ExecutionException caughtEe) {
1691       assertThat(caughtEe).hasCauseThat().isSameInstanceAs(ee);
1692     }
1693   }
1694   public void testConcurrentLoading() throws InterruptedException {
1695     testConcurrentLoading(CacheBuilder.newBuilder());
1696   }
1697 <a name="18"></a>
1698   private static void testConcurrentLoading(CacheBuilder&lt;Object, Object&gt; builder)
1699       throws InterruptedException {
1700     <font color="#800517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>testConcurrentLoadingDefault(builder);
1701     testConcurrentLoadingNull(builder);
1702     testConcurrentLoadingUncheckedException(builder);
1703     testConcurrentLoadingCheckedException(builder);
1704   }
1705   public void testConcurrentExpirationLoading() throws InterruptedException {
1706     testConcurrentLoading(CacheBuilder.newBuilder</b></font>().expireAfterWrite(10, TimeUnit.SECONDS));
1707   }
1708   private static void testConcurrentLoadingDefault(CacheBuilder&lt;Object, Object&gt; builder)
1709       throws InterruptedException {
1710     int count = 10;
1711     final AtomicInteger callCount = new AtomicInteger();
1712     final CountDownLatch startSignal = new CountDownLatch(count + 1);
1713     final Object result = new Object();
1714     LoadingCache&lt;String, Object&gt; cache =
1715         builder.build(
1716             new CacheLoader&lt;String, Object&gt;() {
1717               @Override
1718               public Object load(String key) throws InterruptedException {
1719                 callCount.incrementAndGet();
1720                 startSignal.await();
1721                 return result;
1722               }
1723             });
1724     List&lt;Object&gt; resultArray = doConcurrentGet(cache, "bar", count, startSignal);
1725     assertEquals(1, callCount.get());
1726     for (int i = 0; i &lt; count; i++) {
1727       assertSame("result(" + i + ") didn't match expected", result, resultArray.get(i));
1728     }
1729   }
1730   private static void testConcurrentLoadingNull(CacheBuilder&lt;Object, Object&gt; builder)
1731       throws InterruptedException {
1732     int count = 10;
1733     final AtomicInteger callCount = new AtomicInteger();
1734     final CountDownLatch startSignal = new CountDownLatch(count + 1);
1735     LoadingCache&lt;String, String&gt; cache =
1736         builder.build(
1737             new CacheLoader&lt;String, String&gt;() {
1738               @Override
1739               public String load(String key) throws InterruptedException {
1740                 callCount.incrementAndGet();
1741                 startSignal.await();
1742                 return null;
1743               }
1744             });
1745 <a name="43"></a>
1746     List&lt;Object&gt; result = doConcurrentGet(cache, "bar", count, startSignal);
1747     assertEquals(1, <font color="#c22817"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>callCount.get());
1748     for (int i = 0; i &lt; count; i++) {
1749       assertThat(result.get(i)).isInstanceOf(InvalidCacheLoadException.class);
1750 <a name="26"></a>    }</b></font>
1751     <font color="#68818b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>try {
1752       cache.getUnchecked("bar");
1753       fail();
1754     } catch (InvalidCacheLoadException expected) {
1755     }</b></font>
1756     assertEquals(2, callCount.get());
1757   }
1758   private static void testConcurrentLoadingUncheckedException(CacheBuilder&lt;Object, Object&gt; builder)
1759       throws InterruptedException {
1760     int count = 10;
1761     final AtomicInteger callCount = new AtomicInteger();
1762     final CountDownLatch startSignal = new CountDownLatch(count + 1);
1763     final RuntimeException e = new RuntimeException();
1764     LoadingCache&lt;String, String&gt; cache =
1765         builder.build(
1766             new CacheLoader&lt;String, String&gt;() {
1767               @Override
1768               public String load(String key) throws InterruptedException {
1769                 callCount.incrementAndGet();
1770                 startSignal.await();
1771                 throw e;
1772               }
1773             });
1774 <a name="29"></a>    List&lt;Object&gt; result = doConcurrentGet(cache, "bar", count, startSignal);
1775     assertEquals(1, callCount.get());
1776     <font color="#af7a82"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>for (int i = 0; i &lt; count; i++) {
1777       assertThat(result.get(i)).isInstanceOf(UncheckedExecutionException.class);
1778       assertThat(((UncheckedExecutionException) result.get</b></font>(i))).hasCauseThat().isSameInstanceAs(e);
1779 <a name="25"></a>    }
1780     <font color="#5eac10"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>try {
1781       cache.getUnchecked("bar");
1782       fail();
1783     } catch (UncheckedExecutionException expected) {
1784     }</b></font>
1785     assertEquals(2, callCount.get());
1786   }
1787   private static void testConcurrentLoadingCheckedException(CacheBuilder&lt;Object, Object&gt; builder)
1788       throws InterruptedException {
1789     int count = 10;
1790     final AtomicInteger callCount = new AtomicInteger();
1791     final CountDownLatch startSignal = new CountDownLatch(count + 1);
1792     final IOException e = new IOException();
1793     LoadingCache&lt;String, String&gt; cache =
1794         builder.build(
1795             new CacheLoader&lt;String, String&gt;() {
1796               @Override
1797               public String load(String key) throws IOException, InterruptedException {
1798                 callCount.incrementAndGet();
1799                 startSignal.await();
1800                 throw e;
1801               }
1802             });
1803     List&lt;Object&gt; result = doConcurrentGet(cache, "bar", count, startSignal);
1804     assertEquals(1, callCount.get());
1805     for (int i = 0; i &lt; count; i++) {
1806       int mod = i % 3;
1807       if (mod == 0 || mod == 2) {
1808         assertThat(result.get(i)).isInstanceOf(ExecutionException.class);
1809         assertThat((ExecutionException) result.get(i)).hasCauseThat().isSameInstanceAs(e);
1810       } else {
1811         assertThat(result.get(i)).isInstanceOf(UncheckedExecutionException.class);
1812         assertThat((UncheckedExecutionException) result.get(i)).hasCauseThat().isSameInstanceAs(e);
1813       }
1814 <a name="24"></a>    }
1815     <font color="#79764d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>try {
1816       cache.getUnchecked("bar");
1817       fail();
1818     } catch (UncheckedExecutionException expected) {
1819     }</b></font>
1820     assertEquals(2, callCount.get());
1821   }
1822   private static &lt;K&gt; List&lt;Object&gt; doConcurrentGet(
1823       final LoadingCache&lt;K, ?&gt; cache,
1824       final K key,
1825       int nThreads,
1826       final CountDownLatch gettersStartedSignal)
1827       throws InterruptedException {
1828     final AtomicReferenceArray&lt;Object&gt; result = new AtomicReferenceArray&lt;&gt;(nThreads);
1829     final CountDownLatch gettersComplete = new CountDownLatch(nThreads);
1830     for (int i = 0; i &lt; nThreads; i++) {
1831       final int index = i;
1832       Thread thread =
1833           new Thread(
1834               new Runnable() {
1835                 @Override
1836                 public void run() {
1837                   gettersStartedSignal.countDown();
1838                   Object value = null;
1839                   try {
1840                     int mod = index % 3;
1841                     if (mod == 0) {
1842                       value = cache.get(key);
1843                     } else if (mod == 1) {
1844                       value = cache.getUnchecked(key);
1845                     } else {
1846                       cache.refresh(key);
1847                       value = cache.get(key);
1848                     }
1849                     result.set(index, value);
1850                   } catch (Throwable t) {
1851                     result.set(index, t);
1852                   }
1853                   gettersComplete.countDown();
1854                 }
1855               });
1856       thread.start();
1857       while (thread.isAlive() &amp;&amp; thread.getState() != Thread.State.WAITING) {
1858         Thread.yield();
1859       }
1860     }
1861 <a name="30"></a>    gettersStartedSignal.countDown();
1862     gettersComplete.await();
1863     <font color="#ae694a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>List&lt;Object&gt; resultList = Lists.newArrayListWithExpectedSize(nThreads);
1864     for (int i = 0; i &lt; nThreads; i++) {
1865       resultList.add(result.get(i));
1866     }
1867     return</b></font> resultList;
1868   }
1869   public void testAsMapDuringLoading() throws InterruptedException, ExecutionException {
1870     final CountDownLatch getStartedSignal = new CountDownLatch(2);
1871     final CountDownLatch letGetFinishSignal = new CountDownLatch(1);
1872     final CountDownLatch getFinishedSignal = new CountDownLatch(2);
1873     final String getKey = "get";
1874     final String refreshKey = "refresh";
1875     final String suffix = "Suffix";
1876     CacheLoader&lt;String, String&gt; computeFunction =
1877         new CacheLoader&lt;String, String&gt;() {
1878           @Override
1879           public String load(String key) throws InterruptedException {
1880             getStartedSignal.countDown();
1881             letGetFinishSignal.await();
1882             return key + suffix;
1883           }
1884         };
1885     final LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder().build(computeFunction);
1886     ConcurrentMap&lt;String, String&gt; map = cache.asMap();
1887     map.put(refreshKey, refreshKey);
1888     assertEquals(1, map.size());
1889     assertFalse(map.containsKey(getKey));
1890     assertSame(refreshKey, map.get(refreshKey));
1891     new Thread() {
1892       @Override
1893       public void run() {
1894         cache.getUnchecked(getKey);
1895         getFinishedSignal.countDown();
1896       }
1897     }.start();
1898     new Thread() {
1899       @Override
1900       public void run() {
1901         cache.refresh(refreshKey);
1902         getFinishedSignal.countDown();
1903       }
1904     }.start();
1905     getStartedSignal.await();
1906 <a name="6"></a>        assertEquals(1, map.size());
1907     assertFalse(map.containsKey(getKey));
1908     assertSame(refreshKey, <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>map.get(refreshKey));
1909     letGetFinishSignal.countDown();
1910     getFinishedSignal.await();
1911     checkNothingLogged();
1912     assertEquals(2, cache.size());
1913     assertEquals(getKey + suffix, map.get(getKey));
1914     assertEquals(refreshKey + suffix, map.get(refreshKey));
1915   }
1916   public void testInvalidateDuringLoading() throws InterruptedException, ExecutionException {</b></font>
1917     final CountDownLatch computationStarted = new CountDownLatch(2);
1918     final CountDownLatch letGetFinishSignal = new CountDownLatch(1);
1919     final CountDownLatch getFinishedSignal = new CountDownLatch(2);
1920     final String getKey = "get";
1921     final String refreshKey = "refresh";
1922     final String suffix = "Suffix";
1923     CacheLoader&lt;String, String&gt; computeFunction =
1924         new CacheLoader&lt;String, String&gt;() {
1925           @Override
1926           public String load(String key) throws InterruptedException {
1927             computationStarted.countDown();
1928             letGetFinishSignal.await();
1929             return key + suffix;
1930           }
1931         };
1932     final LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder().build(computeFunction);
1933     ConcurrentMap&lt;String, String&gt; map = cache.asMap();
1934     map.put(refreshKey, refreshKey);
1935     new Thread() {
1936       @Override
1937       public void run() {
1938         cache.getUnchecked(getKey);
1939         getFinishedSignal.countDown();
1940       }
1941     }.start();
1942     new Thread() {
1943       @Override
1944       public void run() {
1945         cache.refresh(refreshKey);
1946         getFinishedSignal.countDown();
1947       }
1948     }.start();
1949     computationStarted.await();
1950 <a name="5"></a>    cache.invalidate(getKey);
1951     cache.invalidate(refreshKey);
1952     assertFalse(map.containsKey(getKey));
1953     assertFalse(<font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>map.containsKey(refreshKey));
1954     letGetFinishSignal.countDown();
1955     getFinishedSignal.await();
1956     checkNothingLogged();
1957     assertEquals(2, cache.size());
1958     assertEquals(getKey + suffix, map.get(getKey));
1959     assertEquals(refreshKey + suffix, map.get(refreshKey));
1960     assertEquals(2, cache.size());
1961   }</b></font>
1962   public void testInvalidateAndReloadDuringLoading()
1963       throws InterruptedException, ExecutionException {
1964     final CountDownLatch computationStarted = new CountDownLatch(2);
1965     final CountDownLatch letGetFinishSignal = new CountDownLatch(1);
1966     final CountDownLatch getFinishedSignal = new CountDownLatch(4);
1967     final String getKey = "get";
1968     final String refreshKey = "refresh";
1969     final String suffix = "Suffix";
1970     CacheLoader&lt;String, String&gt; computeFunction =
1971         new CacheLoader&lt;String, String&gt;() {
1972           @Override
1973           public String load(String key) throws InterruptedException {
1974             computationStarted.countDown();
1975             letGetFinishSignal.await();
1976             return key + suffix;
1977           }
1978         };
1979     final LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder().build(computeFunction);
1980     ConcurrentMap&lt;String, String&gt; map = cache.asMap();
1981     map.put(refreshKey, refreshKey);
1982     new Thread() {
1983       @Override
1984       public void run() {
1985         cache.getUnchecked(getKey);
1986         getFinishedSignal.countDown();
1987       }
1988     }.start();
1989     new Thread() {
1990       @Override
1991       public void run() {
1992         cache.refresh(refreshKey);
1993         getFinishedSignal.countDown();
1994       }
1995     }.start();
1996     computationStarted.await();
1997     cache.invalidate(getKey);
1998     cache.invalidate(refreshKey);
1999     assertFalse(map.containsKey(getKey));
2000     assertFalse(map.containsKey(refreshKey));
2001     new Thread() {
2002       @Override
2003       public void run() {
2004         cache.getUnchecked(getKey);
2005         getFinishedSignal.countDown();
2006       }
2007     }.start();
2008     new Thread() {
2009       @Override
2010       public void run() {
2011         cache.refresh(refreshKey);
2012         getFinishedSignal.countDown();
2013       }
2014     }.start();
2015     letGetFinishSignal.countDown();
2016     getFinishedSignal.await();
2017     checkNothingLogged();
2018 <a name="39"></a>
2019     assertEquals(2, cache.size());
2020     <font color="#152dc6"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(getKey + suffix, map.get(getKey));
2021     assertEquals(refreshKey + suffix, map.get(refreshKey));
2022   }
2023   public void testExpandDuringLoading() throws InterruptedException {
2024     final int count = 3;
2025     final AtomicInteger callCount = new AtomicInteger()</b></font>;
2026     final CountDownLatch computeSignal = new CountDownLatch(1);
2027     final CountDownLatch secondSignal = new CountDownLatch(1);
2028     final CountDownLatch thirdSignal = new CountDownLatch(1);
2029     final CountDownLatch fourthSignal = new CountDownLatch(1);
2030     final CountDownLatch doneSignal = new CountDownLatch(count);
2031     CacheLoader&lt;String, String&gt; computeFunction =
2032         new CacheLoader&lt;String, String&gt;() {
2033           @Override
2034           public String load(String key) throws InterruptedException {
2035             callCount.incrementAndGet();
2036             secondSignal.countDown();
2037             computeSignal.await();
2038             return key + "foo";
2039           }
2040         };
2041     final LoadingCache&lt;String, String&gt; cache =
2042         CacheBuilder.newBuilder().weakKeys().build(computeFunction);
2043     final AtomicReferenceArray&lt;String&gt; result = new AtomicReferenceArray&lt;&gt;(count);
2044     final String key = "bar";
2045     new Thread() {
2046       @Override
2047       public void run() {
2048         result.set(0, cache.getUnchecked(key));
2049         doneSignal.countDown();
2050       }
2051     }.start();
2052     secondSignal.await();
2053     new Thread() {
2054       @Override
2055       public void run() {
2056         thirdSignal.countDown();
2057         result.set(1, cache.getUnchecked(key));
2058         doneSignal.countDown();
2059       }
2060     }.start();
2061     thirdSignal.await();
2062     Thread.yield();
2063     CacheTesting.forceExpandSegment(cache, key);
2064     new Thread() {
2065       @Override
2066       public void run() {
2067         fourthSignal.countDown();
2068         result.set(2, cache.getUnchecked(key));
2069         doneSignal.countDown();
2070       }
2071     }.start();
2072     fourthSignal.await();
2073     Thread.yield();
2074     computeSignal.countDown();
2075     doneSignal.await();
2076     assertTrue(callCount.get() == 1);
2077     assertEquals("barfoo", result.get(0));
2078     assertEquals("barfoo", result.get(1));
2079     assertEquals("barfoo", result.get(2));
2080     assertEquals("barfoo", cache.getUnchecked(key));
2081   }
2082   public void
2083       ignoreTestExpandDuringRefresh()
2084       throws InterruptedException, ExecutionException {
2085     final AtomicInteger callCount = new AtomicInteger();
2086     final CountDownLatch computeSignal = new CountDownLatch(1);
2087     final CountDownLatch secondSignal = new CountDownLatch(1);
2088     final CountDownLatch thirdSignal = new CountDownLatch(1);
2089     final CountDownLatch fourthSignal = new CountDownLatch(1);
2090     final CountDownLatch doneSignal = new CountDownLatch(3);
2091     final String suffix = "Suffix";
2092     CacheLoader&lt;String, String&gt; computeFunction =
2093         new CacheLoader&lt;String, String&gt;() {
2094           @Override
2095           public String load(String key) throws InterruptedException {
2096             callCount.incrementAndGet();
2097             secondSignal.countDown();
2098             computeSignal.await();
2099             return key + suffix;
2100           }
2101         };
2102     final AtomicReferenceArray&lt;String&gt; result = new AtomicReferenceArray&lt;&gt;(2);
2103     final LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder().build(computeFunction);
2104     final String key = "bar";
2105     cache.asMap().put(key, key);
2106     new Thread() {
2107       @Override
2108       public void run() {
2109         cache.refresh(key);
2110         doneSignal.countDown();
2111       }
2112     }.start();
2113     secondSignal.await();
2114     checkNothingLogged();
2115     new Thread() {
2116       @Override
2117       public void run() {
2118         thirdSignal.countDown();
2119         result.set(0, cache.getUnchecked(key));
2120         doneSignal.countDown();
2121       }
2122     }.start();
2123     thirdSignal.await();
2124     Thread.yield();
2125     CacheTesting.forceExpandSegment(cache, key);
2126     new Thread() {
2127       @Override
2128       public void run() {
2129         fourthSignal.countDown();
2130         result.set(1, cache.getUnchecked(key));
2131         doneSignal.countDown();
2132       }
2133     }.start();
2134     fourthSignal.await();
2135     Thread.yield();
2136     computeSignal.countDown();
2137     doneSignal.await();
2138     assertTrue(callCount.get() == 1);
2139     assertEquals(key, result.get(0));
2140     assertEquals(key, result.get(1));
2141     assertEquals(key + suffix, cache.getUnchecked(key));
2142   }
2143   static &lt;T&gt; Callable&lt;T&gt; throwing(final Exception exception) {
2144     return new Callable&lt;T&gt;() {
2145       @Override
2146       public T call() throws Exception {
2147         throw exception;
2148       }
2149     };
2150   }
2151 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
