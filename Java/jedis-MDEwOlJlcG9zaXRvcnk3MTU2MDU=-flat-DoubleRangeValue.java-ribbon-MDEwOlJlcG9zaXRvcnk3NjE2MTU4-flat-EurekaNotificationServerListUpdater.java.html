
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 7.722007722007722%, Tokens: 10</h2>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-DoubleRangeValue.java</h3>
            <pre><code>1  package redis.clients.jedis.search.querybuilder;
2  public class DoubleRangeValue extends RangeValue {
3    private final double from;
4    private final double to;
5    private static void appendNum(StringBuilder sb, double n, boolean inclusive) {
6      if (!inclusive) {
7        sb.append("(");
8      }
9      if (n == Double.NEGATIVE_INFINITY) {
10        sb.append("-inf");
11      } else if (n == Double.POSITIVE_INFINITY) {
12        sb.append("inf");
13      } else {
14        sb.append(n);
15      }
<span onclick='openModal()' class='match'>16    }
17    public DoubleRangeValue(double from, double to) {
18      this.from = from;
19      this.to = to;
20    }
21    @Override
22    protected void appendFrom(StringBuilder sb, boolean inclusive) {
</span>23      appendNum(sb, from, inclusive);
24    }
25    @Override
26    protected void appendTo(StringBuilder sb, boolean inclusive) {
27      appendNum(sb, to, inclusive);
28    }
29  }
</code></pre>
        </div>
        <div class="column">
            <h3>ribbon-MDEwOlJlcG9zaXRvcnk3NjE2MTU4-flat-EurekaNotificationServerListUpdater.java</h3>
            <pre><code>1  package com.netflix.niws.loadbalancer;
2  import com.google.common.util.concurrent.ThreadFactoryBuilder;
3  import com.netflix.config.DynamicIntProperty;
4  import com.netflix.discovery.CacheRefreshedEvent;
5  import com.netflix.discovery.EurekaClient;
6  import com.netflix.discovery.EurekaEvent;
7  import com.netflix.discovery.EurekaEventListener;
8  import com.netflix.loadbalancer.*;
9  import org.slf4j.Logger;
10  import org.slf4j.LoggerFactory;
11  import javax.inject.Provider;
12  import java.util.Date;
13  import java.util.concurrent.ArrayBlockingQueue;
14  import java.util.concurrent.ExecutorService;
15  import java.util.concurrent.ThreadPoolExecutor;
16  import java.util.concurrent.TimeUnit;
17  import java.util.concurrent.atomic.AtomicBoolean;
18  import java.util.concurrent.atomic.AtomicLong;
19  public class EurekaNotificationServerListUpdater implements ServerListUpdater {
20      private static final Logger logger = LoggerFactory.getLogger(EurekaNotificationServerListUpdater.class);
21      private static class LazyHolder {
22          private final static String CORE_THREAD = "EurekaNotificationServerListUpdater.ThreadPoolSize";
23          private final static String QUEUE_SIZE = "EurekaNotificationServerListUpdater.queueSize";
24          private final static LazyHolder SINGLETON = new LazyHolder();
25          private final DynamicIntProperty poolSizeProp = new DynamicIntProperty(CORE_THREAD, 2);
26          private final DynamicIntProperty queueSizeProp = new DynamicIntProperty(QUEUE_SIZE, 1000);
27          private final ThreadPoolExecutor defaultServerListUpdateExecutor;
28          private final Thread shutdownThread;
29          private LazyHolder() {
30              int corePoolSize = getCorePoolSize();
31              defaultServerListUpdateExecutor = new ThreadPoolExecutor(
32                      corePoolSize,
33                      corePoolSize * 5,
34                      0,
35                      TimeUnit.NANOSECONDS,
36                      new ArrayBlockingQueue<Runnable>(queueSizeProp.get()),
37                      new ThreadFactoryBuilder()
38                              .setNameFormat("EurekaNotificationServerListUpdater-%d")
39                              .setDaemon(true)
40                              .build()
41              );
42              poolSizeProp.addCallback(new Runnable() {
43                  @Override
44                  public void run() {
45                      int corePoolSize = getCorePoolSize();
46                      defaultServerListUpdateExecutor.setCorePoolSize(corePoolSize);
47                      defaultServerListUpdateExecutor.setMaximumPoolSize(corePoolSize * 5);
48                  }
49              });
50              shutdownThread = new Thread(new Runnable() {
51                  @Override
52                  public void run() {
53                      logger.info("Shutting down the Executor for EurekaNotificationServerListUpdater");
54                      try {
55                          defaultServerListUpdateExecutor.shutdown();
56                          Runtime.getRuntime().removeShutdownHook(shutdownThread);
57                      } catch (Exception e) {
58                      }
59                  }
60              });
61              Runtime.getRuntime().addShutdownHook(shutdownThread);
62          }
63          private int getCorePoolSize() {
64              int propSize = poolSizeProp.get();
65              if (propSize > 0) {
66                  return propSize;
67              }
68              return 2; 
69          }        
70      }
71      public static ExecutorService getDefaultRefreshExecutor() {
72          return LazyHolder.SINGLETON.defaultServerListUpdateExecutor;
73      }
74       final AtomicBoolean updateQueued = new AtomicBoolean(false);
75      private final AtomicBoolean isActive = new AtomicBoolean(false);
76      private final AtomicLong lastUpdated = new AtomicLong(System.currentTimeMillis());
77      private final Provider<EurekaClient> eurekaClientProvider;
78      private final ExecutorService refreshExecutor;
79      private volatile EurekaEventListener updateListener;
80      private volatile EurekaClient eurekaClient;
81      public EurekaNotificationServerListUpdater() {
82          this(new LegacyEurekaClientProvider());
83      }
84      public EurekaNotificationServerListUpdater(final Provider<EurekaClient> eurekaClientProvider) {
85          this(eurekaClientProvider, getDefaultRefreshExecutor());
<span onclick='openModal()' class='match'>86      }
87      public EurekaNotificationServerListUpdater(final Provider<EurekaClient> eurekaClientProvider, ExecutorService refreshExecutor) {
88          this.eurekaClientProvider = eurekaClientProvider;
89          this.refreshExecutor = refreshExecutor;
90      }
91      @Override
92      public synchronized void start(final UpdateAction updateAction) {
</span>93          if (isActive.compareAndSet(false, true)) {
94              this.updateListener = new EurekaEventListener() {
95                  @Override
96                  public void onEvent(EurekaEvent event) {
97                      if (event instanceof CacheRefreshedEvent) {
98                          if (!updateQueued.compareAndSet(false, true)) {  
99                              logger.info("an update action is already queued, returning as no-op");
100                              return;
101                          }
102                          if (!refreshExecutor.isShutdown()) {
103                              try {
104                                  refreshExecutor.submit(new Runnable() {
105                                      @Override
106                                      public void run() {
107                                          try {
108                                              updateAction.doUpdate();
109                                              lastUpdated.set(System.currentTimeMillis());
110                                          } catch (Exception e) {
111                                              logger.warn("Failed to update serverList", e);
112                                          } finally {
113                                              updateQueued.set(false);
114                                          }
115                                      }
116                                  });  
117                              } catch (Exception e) {
118                                  logger.warn("Error submitting update task to executor, skipping one round of updates", e);
119                                  updateQueued.set(false);  
120                              }
121                          }
122                          else {
123                              logger.debug("stopping EurekaNotificationServerListUpdater, as refreshExecutor has been shut down");
124                              stop();
125                          }
126                      }
127                  }
128              };
129              if (eurekaClient == null) {
130                  eurekaClient = eurekaClientProvider.get();
131              }
132              if (eurekaClient != null) {
133                  eurekaClient.registerEventListener(updateListener);
134              } else {
135                  logger.error("Failed to register an updateListener to eureka client, eureka client is null");
136                  throw new IllegalStateException("Failed to start the updater, unable to register the update listener due to eureka client being null.");
137              }
138          } else {
139              logger.info("Update listener already registered, no-op");
140          }
141      }
142      @Override
143      public synchronized void stop() {
144          if (isActive.compareAndSet(true, false)) {
145              if (eurekaClient != null) {
146                  eurekaClient.unregisterEventListener(updateListener);
147              }
148          } else {
149              logger.info("Not currently active, no-op");
150          }
151      }
152      @Override
153      public String getLastUpdate() {
154          return new Date(lastUpdated.get()).toString();
155      }
156      @Override
157      public long getDurationSinceLastUpdateMs() {
158          return System.currentTimeMillis() - lastUpdated.get();
159      }
160      @Override
161      public int getNumberMissedCycles() {
162          return 0;
163      }
164      @Override
165      public int getCoreThreads() {
166          if (isActive.get()) {
167              if (refreshExecutor != null && refreshExecutor instanceof ThreadPoolExecutor) {
168                  return ((ThreadPoolExecutor) refreshExecutor).getCorePoolSize();
169              }
170          }
171          return 0;
172      }
173  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-DoubleRangeValue.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from ribbon-MDEwOlJlcG9zaXRvcnk3NjE2MTU4-flat-EurekaNotificationServerListUpdater.java</div>
                </div>
                <div class="column column_space"><pre><code>16    }
17    public DoubleRangeValue(double from, double to) {
18      this.from = from;
19      this.to = to;
20    }
21    @Override
22    protected void appendFrom(StringBuilder sb, boolean inclusive) {
</pre></code></div>
                <div class="column column_space"><pre><code>86      }
87      public EurekaNotificationServerListUpdater(final Provider<EurekaClient> eurekaClientProvider, ExecutorService refreshExecutor) {
88          this.eurekaClientProvider = eurekaClientProvider;
89          this.refreshExecutor = refreshExecutor;
90      }
91      @Override
92      public synchronized void start(final UpdateAction updateAction) {
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    