<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for ArrayMapperITest.java &amp; TransportSQLActionTest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for ArrayMapperITest.java &amp; TransportSQLActionTest.java
      </h3>
<h1 align="center">
        2.8%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>ArrayMapperITest.java (82.608696%)<th>TransportSQLActionTest.java (1.4318011%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(38-61)<td><a href="#" name="0">(825-851)</a><td align="center"><font color="#ff0000">29</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(31-38)<td><a href="#" name="1">(196-202)</a><td align="center"><font color="#4f0000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>ArrayMapperITest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 package io.crate.integrationtests;
2 import org.hamcrest.Matchers;
3 import org.junit.Test;
4 import java.util.List;
5 <a name="1"></a>
6 public class ArrayMapperITest extends SQLIntegrationTestCase {
7     <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>@Test
8     public void testInsertGetArray() throws Exception {
9         execute("create table t (id int primary key, xs array(double))");
10         execute("insert into t (id, xs) values (1, [0.0, 99.9, -100.5678])");
11 <a name="0"></a>        execute("refresh table t");
12         execute("select xs from t where id = 1");         assertThat((List&lt;Object&gt;) response.rows</b></font>()[0][0], <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Matchers.contains(0.0d, 99.9d, -100.5678d));
13         execute("select xs from t");
14         assertThat((List&lt;Object&gt;) response.rows()[0][0], Matchers.contains(0.0d, 99.9d, -100.5678d));
15     }
16     @Test
17     public void testInsertSearchArray() throws Exception {
18         execute("create table t (xs array(double))");
19         execute("insert into t (xs) values ([0.0, 99.9, -100.5678])");
20         execute("refresh table t");
21         execute("select xs from t where 0.0 = any (xs)");
22         assertThat((List&lt;Object&gt;) response.rows()[0][0], Matchers.contains(0.0d, 99.9d, -100.5678d));
23     }
24     @Test
25     public void testEmptyArray() throws Exception {
26         execute("create table t (xs array(double))");
27         execute("insert into t (xs) values ([])");
28         execute("refresh table t");
29         execute("select xs from t");
30         assertThat((List&lt;Object&gt;) response.rows()[0][0], Matchers.empty</b></font>());
31     }
32 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>TransportSQLActionTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 package io.crate.integrationtests;
2 import com.carrotsearch.randomizedtesting.RandomizedContext;
3 import com.carrotsearch.randomizedtesting.generators.RandomPicks;
4 import io.crate.common.collections.Lists2;
5 import io.crate.exceptions.SQLExceptions;
6 import io.crate.testing.DataTypeTesting;
7 import io.crate.testing.TestingHelpers;
8 import io.crate.testing.UseJdbc;
9 import io.crate.testing.UseRandomizedSchema;
10 import io.crate.types.DataType;
11 import io.crate.types.DataTypes;
12 import org.elasticsearch.common.xcontent.DeprecationHandler;
13 import org.elasticsearch.common.xcontent.NamedXContentRegistry;
14 import org.elasticsearch.common.xcontent.json.JsonXContent;
15 import org.elasticsearch.index.IndexNotFoundException;
16 import org.elasticsearch.test.ESIntegTestCase;
17 import org.hamcrest.Matchers;
18 import org.junit.Rule;
19 import org.junit.Test;
20 import org.junit.rules.TemporaryFolder;
21 import org.locationtech.spatial4j.shape.Point;
22 import java.io.File;
23 import java.nio.file.Paths;
24 import java.sql.DriverManager;
25 import java.sql.ResultSet;
26 import java.sql.Statement;
27 import java.util.ArrayList;
28 import java.util.Arrays;
29 import java.util.HashMap;
30 import java.util.List;
31 import java.util.Locale;
32 import java.util.Map;
33 import java.util.Properties;
34 import java.util.Random;
35 import java.util.UUID;
36 import java.util.stream.Collectors;
37 import static com.carrotsearch.randomizedtesting.RandomizedTest.$;
38 import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
39 import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_TABLE;
40 import static io.crate.testing.Asserts.assertThrowsMatches;
41 import static io.crate.testing.SQLErrorMatcher.isSQLError;
42 import static io.crate.testing.TestingHelpers.printedTable;
43 import static io.netty.handler.codec.http.HttpResponseStatus.BAD_REQUEST;
44 import static io.netty.handler.codec.http.HttpResponseStatus.NOT_FOUND;
45 import static org.hamcrest.Matchers.arrayContaining;
46 import static org.hamcrest.Matchers.closeTo;
47 import static org.hamcrest.Matchers.containsInAnyOrder;
48 import static org.hamcrest.Matchers.containsString;
49 import static org.hamcrest.Matchers.greaterThan;
50 import static org.hamcrest.Matchers.hasItems;
51 import static org.hamcrest.Matchers.instanceOf;
52 import static org.hamcrest.Matchers.lessThanOrEqualTo;
53 import static org.hamcrest.Matchers.nullValue;
54 import static org.hamcrest.core.Is.is;
55 @ESIntegTestCase.ClusterScope(minNumDataNodes = 2)
56 public class TransportSQLActionTest extends SQLIntegrationTestCase {
57     private Setup setup = new Setup(sqlExecutor);
58     @Rule
59     public TemporaryFolder folder = new TemporaryFolder();
60     private &lt;T&gt; List&lt;T&gt; getCol(Object[][] result, int idx) {
61         ArrayList&lt;T&gt; res = new ArrayList&lt;&gt;(result.length);
62         for (Object[] row : result) {
63             res.add((T) row[idx]);
64         }
65         return res;
66     }
67     @Test
68     public void testSelectResultContainsColumnsInTheOrderOfTheSelectListInTheQuery() throws Exception {
69         execute("create table test (id string primary key)");
70         execute("insert into test (id) values ('id1')");
71         execute("refresh table test");
72         execute("select \"_id\" as b, \"_version\" as a from test");
73         assertArrayEquals(new String[]{"b", "a"}, response.cols());
74         assertEquals(1, response.rowCount());
75     }
76     @Test
77     public void testIndexNotFoundExceptionIsRaisedIfDeletedAfterPlan() throws Throwable {
78         execute("create table t (name string)");
79         ensureYellow();
80         PlanForNode plan = plan("select * from t");
81         execute("drop table t");
82         assertThrowsMatches(() -&gt; execute(plan).getResult(), instanceOf(IndexNotFoundException.class));
83     }
84     @Test
85     public void testDeletePartitionAfterPlan() throws Throwable {
86         execute("CREATE TABLE parted_table (id long, text string, day timestamp with time zone) " +
87                 "PARTITIONED BY (day)");
88         execute("INSERT INTO parted_table (id, text, day) values(1, 'test', '2016-06-07')");
89         ensureYellow();
90         PlanForNode plan = plan("delete from parted_table where day='2016-06-07'");
91         execute("delete from parted_table where day='2016-06-07'");
92         try {
93             execute(plan).getResult();
94         } catch (Throwable t) {
95             throw SQLExceptions.unwrap(t);
96         }
97     }
98     @Test
99     public void testSelectCountStar() throws Exception {
100         execute("create table test (name string) with (number_of_replicas=0)");
101         ensureYellow();
102         execute("insert into test (name) values (?)", new Object[]{"Arthur"});
103         execute("insert into test (name) values (?)", new Object[]{"Trillian"});
104         refresh();
105         execute("select count(*) from test");
106         assertEquals(1, response.rowCount());
107         assertEquals(2L, response.rows()[0][0]);
108     }
109     @Test
110     public void testSelectZeroLimit() throws Exception {
111         execute("create table test (name string) with (number_of_replicas=0)");
112         ensureYellow();
113         execute("insert into test (name) values (?)", new Object[]{"Arthur"});
114         execute("insert into test (name) values (?)", new Object[]{"Trillian"});
115         refresh();
116         execute("select * from test limit 0");
117         assertEquals(0L, response.rowCount());
118     }
119     @Test
120     public void testSelectZeroLimitOrderBy() throws Exception {
121         execute("create table test (name string) with (number_of_replicas=0)");
122         ensureYellow();
123         execute("insert into test (name) values (?)", new Object[]{"Arthur"});
124         execute("insert into test (name) values (?)", new Object[]{"Trillian"});
125         refresh();
126         execute("select * from test order by name limit 0");
127         assertEquals(0L, response.rowCount());
128     }
129     @Test
130     public void testSelectCountStarWithWhereClause() throws Exception {
131         execute("create table test (name string) with (number_of_replicas=0)");
132         ensureYellow();
133         execute("insert into test (name) values (?)", new Object[]{"Arthur"});
134         execute("insert into test (name) values (?)", new Object[]{"Trillian"});
135         refresh();
136         execute("select count(*) from test where name = 'Trillian'");
137         assertEquals(1, response.rowCount());
138         assertEquals(1L, response.rows()[0][0]);
139     }
140     @Test
141     public void testSelectStar() throws Exception {
142         execute("create table test (\"firstName\" string, \"lastName\" string)");
143         ensureYellow();
144         execute("select * from test");
145         assertArrayEquals(new String[]{"firstName", "lastName"}, response.cols());
146         assertEquals(0, response.rowCount());
147     }
148     @Test
149     public void testSelectStarEmptyMapping() throws Exception {
150         execute("select * from unnest()");
151         assertArrayEquals(new String[]{}, response.cols());
152 <a name="1"></a>        assertEquals(0, response.rowCount());
153     }
154     <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>@Test
155     public void testGroupByOnAnalyzedColumn() throws Exception {
156         execute("create table test1 (col1 string index using fulltext)");
157         execute("insert into test1 (col1) values ('abc def, ghi. jkl')");
158         refresh();
159         assertThat(
160             printedTable(execute("select count(col1) from test1 group by col1").rows</b></font>()),
161             is("1\n")
162         );
163     }
164     @Test
165     public void testSelectStarWithOther() throws Exception {
166         execute("create table test (id string primary key, first_name string, last_name string)");
167         execute("insert into test (id, first_name, last_name) values ('id1', 'Youri', 'Zoon')");
168         execute("refresh table test");
169         execute("select \"_version\", *, \"_id\" from test");
170         assertThat(response.cols(), arrayContaining("_version", "id", "first_name", "last_name", "_id"));
171         assertEquals(1, response.rowCount());
172         assertArrayEquals(new Object[]{1L, "id1", "Youri", "Zoon", "id1"}, response.rows()[0]);
173     }
174     @Test
175     @UseJdbc(0)     public void testSelectWithParams() throws Exception {
176         execute("create table test (id string primary key, first_name string, last_name string, age double) " +
177                 "with (number_of_replicas = 0)");
178         execute("insert into test (id, first_name, last_name, age) values ('id1', 'Youri', 'Zoon', 38)");
179         execute("refresh table test");
180         Object[] args = new Object[]{"id1"};
181         execute("select first_name, last_name from test where \"_id\" = $1", args);
182         assertArrayEquals(new Object[]{"Youri", "Zoon"}, response.rows()[0]);
183         args = new Object[]{"Zoon"};
184         execute("select first_name, last_name from test where last_name = $1", args);
185         assertArrayEquals(new Object[]{"Youri", "Zoon"}, response.rows()[0]);
186         args = new Object[]{38, "Zoon"};
187         execute("select first_name, last_name from test where age = $1 and last_name = $2", args);
188         assertArrayEquals(new Object[]{"Youri", "Zoon"}, response.rows()[0]);
189         args = new Object[]{38, "Zoon"};
190         execute("select first_name, last_name from test where age = ? and last_name = ?", args);
191         assertArrayEquals(new Object[]{"Youri", "Zoon"}, response.rows()[0]);
192     }
193     @Test
194     public void testSelectStarWithOtherAndAlias() throws Exception {
195         execute("create table test (first_name string, last_name string)");
196         execute("insert into test (first_name, last_name) values ('Youri', 'Zoon')");
197         execute("refresh table test");
198         execute("select *, \"_version\", \"_version\" as v from test");
199         assertArrayEquals(new String[]{"first_name", "last_name", "_version", "v"}, response.cols());
200         assertEquals(1, response.rowCount());
201         assertArrayEquals(new Object[]{"Youri", "Zoon", 1L, 1L}, response.rows()[0]);
202     }
203     @Test
204     public void testFilterByEmptyString() throws Exception {
205         execute("create table test (name string)");
206         execute("insert into test (name) values (''), ('Ruben Lenten')");
207         execute("refresh table test");
208         execute("select name from test where name = ''");
209         assertEquals(1, response.rowCount());
210         assertEquals("", response.rows()[0][0]);
211         execute("select name from test where name != ''");
212         assertEquals(1, response.rowCount());
213         assertEquals("Ruben Lenten", response.rows()[0][0]);
214     }
215     @Test
216     public void testFilterByNull() throws Exception {
217         execute("create table test (id int, name string, o object(ignored))");
218         ensureYellow();
219         execute("insert into test (id) values (1)");
220         execute("insert into test (id, name) values (2, 'Ruben Lenten'), (3, '')");
221         refresh();
222         execute("select id from test where name is null");
223         assertEquals(1, response.rowCount());
224         assertEquals(1, response.rows()[0][0]);
225         execute("select id from test where name is not null order by id");
226         assertEquals(2, response.rowCount());
227         assertEquals(2, response.rows()[0][0]);
228         execute("select id from test where o['invalid'] is null");
229         assertEquals(3, response.rowCount());
230         execute("select name from test where name is not null and name != ''");
231         assertEquals(1, response.rowCount());
232         assertEquals("Ruben Lenten", response.rows()[0][0]);
233     }
234     @Test
235     public void testFilterByBoolean() throws Exception {
236         execute("create table test (sunshine boolean)");
237         execute("insert into test values (?)", new Object[]{true});
238         refresh();
239         execute("select sunshine from test where sunshine = true");
240         assertEquals(1, response.rowCount());
241         assertEquals(true, response.rows()[0][0]);
242         execute("update test set sunshine=false where sunshine = true");
243         assertEquals(1, response.rowCount());
244         refresh();
245         execute("select sunshine from test where sunshine = ?", new Object[]{false});
246         assertEquals(1, response.rowCount());
247         assertEquals(false, response.rows()[0][0]);
248     }
249     @Test
250     public void testColsAreCaseSensitive() throws Exception {
251         execute("create table test (\"firstname\" string, \"firstName\" string) " +
252                 "with (number_of_replicas = 0)");
253         ensureYellow();
254         execute("insert into test (\"firstname\", \"firstName\") values ('LowerCase', 'CamelCase')");
255         refresh();
256         execute("select FIRSTNAME, \"firstname\", \"firstName\" from test");
257         assertArrayEquals(new String[]{"firstname", "firstname", "firstName"}, response.cols());
258         assertEquals(1, response.rowCount());
259         assertEquals("LowerCase", response.rows()[0][0]);
260         assertEquals("LowerCase", response.rows()[0][1]);
261         assertEquals("CamelCase", response.rows()[0][2]);
262     }
263     @Test
264     public void testIdSelectWithResult() throws Exception {
265         execute("create table test (id string primary key)");
266         execute("insert into test (id) values ('id1')");
267         execute("refresh table test");
268         execute("select \"_id\" from test");
269         assertArrayEquals(new String[]{"_id"}, response.cols());
270         assertEquals(1, response.rowCount());
271         assertEquals(1, response.rows()[0].length);
272         assertEquals("id1", response.rows()[0][0]);
273     }
274     @Test
275     public void testSqlRequestWithLimit() throws Exception {
276         execute("create table test (id string primary key)");
277         execute("insert into test (id) values ('id1'), ('id2')");
278         execute("refresh table test");
279         execute("select \"_id\" from test limit 1");
280         assertEquals(1, response.rowCount());
281     }
282     @Test
283     public void testSqlRequestWithLimitAndOffset() throws Exception {
284         execute("create table test (id string primary key) with (number_of_replicas=0)");
285         ensureYellow();
286         execute("insert into test (id) values (?), (?), (?)", new Object[]{"id1", "id2", "id3"});
287         refresh();
288         execute("select \"id\" from test order by id limit 1 offset 1");
289         assertEquals(1, response.rowCount());
290         assertThat(
291             printedTable(response.rows()),
292             is("id2\n")
293         );
294     }
295     @Test
296     public void testSqlRequestWithFilter() throws Exception {
297         execute("create table test (id string primary key)");
298         execute("insert into test (id) values ('id1'), ('id2')");
299         execute("select _id from test where id = 'id1'");
300         assertEquals(1, response.rowCount());
301         assertThat(
302             printedTable(response.rows()),
303             is("id1\n")
304         );
305     }
306     @Test
307     public void testSqlRequestWithNotEqual() throws Exception {
308         execute("create table test (id string primary key) with (number_of_replicas = 0)");
309         ensureYellow();
310         execute("insert into test (id) values (?)", new Object[][]{
311             new Object[]{"id1"},
312             new Object[]{"id2"}
313         });
314         refresh();
315         execute("select id from test where id != 'id1'");
316         assertEquals(1, response.rowCount());
317         assertEquals("id2", response.rows()[0][0]);
318     }
319     @Test
320     public void testSqlRequestWithOneOrFilter() throws Exception {
321         execute("create table test (id string) with (number_of_replicas = 0)");
322         ensureYellow();
323         execute("insert into test (id) values ('id1'), ('id2'), ('id3')");
324         refresh();
325         execute("select id from test where id='id1' or id='id3'");
326         assertEquals(2, response.rowCount());
327         assertThat(this.&lt;String&gt;getCol(response.rows(), 0), containsInAnyOrder("id1", "id3"));
328     }
329     @Test
330     public void testSqlRequestWithOneMultipleOrFilter() throws Exception {
331         execute("create table test (id string) with (number_of_replicas = 0)");
332         ensureYellow();
333         execute("insert into test (id) values ('id1'), ('id2'), ('id3'), ('id4')");
334         refresh();
335         execute("select id from test where id='id1' or id='id2' or id='id4'");
336         assertEquals(3, response.rowCount());
337         List&lt;String&gt; col1 = this.getCol(response.rows(), 0);
338         assertThat(col1, containsInAnyOrder("id1", "id2", "id4"));
339     }
340     @Test
341     public void testSqlRequestWithDateFilter() {
342         execute("create table test (date timestamp with time zone)");
343         execute("insert into test (date) values ('2013-10-01'), ('2013-10-02')");
344         execute("refresh table test");
345         execute("select date from test where date = '2013-10-01'");
346         assertEquals(1, response.rowCount());
347         assertEquals(1380585600000L, response.rows()[0][0]);
348     }
349     @Test
350     public void testSqlRequestWithDateGtFilter() {
351         execute("create table test (date timestamp with time zone)");
352         execute("insert into test (date) values ('2013-10-01'), ('2013-10-02')");
353         execute("refresh table test");
354         execute(
355             "select date from test where date &gt; '2013-10-01'");
356         assertEquals(1, response.rowCount());
357         assertEquals(1380672000000L, response.rows()[0][0]);
358     }
359     @Test
360     public void testSqlRequestWithNumericGtFilter() throws Exception {
361         execute("create table test (i long)");
362         execute("insert into test (i) values (10), (20)");
363         execute("refresh table test");
364         execute(
365             "select i from test where i &gt; 10");
366         assertEquals(1, response.rowCount());
367         assertEquals(20L, response.rows()[0][0]);
368     }
369     @Test
370     public void testArraySupport() throws Exception {
371         execute("create table t1 (id int primary key, strings array(string), integers array(integer)) with (number_of_replicas=0)");
372         ensureYellow();
373         execute("insert into t1 (id, strings, integers) values (?, ?, ?)",
374             new Object[]{
375                 1,
376                 new String[]{"foo", "bar"},
377                 new Integer[]{1, 2, 3}
378             }
379         );
380         refresh();
381         execute("select id, strings, integers from t1");
382         assertThat(response.rowCount(), is(1L));
383         assertThat(response.rows()[0][0], is(1));
384         assertThat(((List) response.rows()[0][1]).get(0), is("foo"));
385         assertThat(((List) response.rows()[0][1]).get(1), is("bar"));
386         assertThat(((List) response.rows()[0][2]).get(0), is(1));
387         assertThat(((List) response.rows()[0][2]).get(1), is(2));
388         assertThat(((List) response.rows()[0][2]).get(2), is(3));
389     }
390     @Test
391     @SuppressWarnings("unchecked")
392     public void testArrayInsideObject() throws Exception {
393         execute("create table t1 (id int primary key, details object as (names array(string))) with (number_of_replicas=0)");
394         ensureYellow();
395         Map&lt;String, Object&gt; details = new HashMap&lt;&gt;();
396         details.put("names", new Object[]{"Arthur", "Trillian"});
397         execute("insert into t1 (id, details) values (?, ?)", new Object[]{1, details});
398         refresh();
399         execute("select details['names'] from t1");
400         assertThat(response.rowCount(), is(1L));
401         assertThat(((List) response.rows()[0][0]).get(0), is("Arthur"));
402         assertThat(((List) response.rows()[0][0]).get(1), is("Trillian"));
403     }
404     @Test
405     public void testArrayInsideObjectArrayOutputAndQueryBehaviour() throws Exception {
406         execute("create table t1 (id int primary key, details array(object as (names array(string)))) with (number_of_replicas=0)");
407         ensureYellow();
408         Map&lt;String, Object&gt; detail1 = new HashMap&lt;&gt;();
409         detail1.put("names", new Object[]{"Arthur", "Trillian"});
410         Map&lt;String, Object&gt; detail2 = new HashMap&lt;&gt;();
411         detail2.put("names", new Object[]{"Ford", "Slarti", "Ford"});
412         List&lt;Map&lt;String, Object&gt;&gt; details = Arrays.asList(detail1, detail2);
413         execute("insert into t1 (id, details) values (?, ?)", new Object[]{1, details});
414         refresh();
415         execute("select " +
416                 "details['names'], ['Arthur', 'Trillian'] = ANY (details['names']) " +
417                 "from t1 " +
418                 "where ['Ford', 'Slarti', 'Ford'] = ANY (details['names'])");
419         assertThat(
420             printedTable(response.rows()),
421             is("[[Arthur, Trillian], [Ford, Slarti, Ford]]| true\n")
422         );
423     }
424     @Test
425     public void testFullPathRequirement() throws Exception {
426         execute("create table t1 (id int primary key, details object as (id int, more_details object as (id int))) with (number_of_replicas=0)");
427         ensureYellow();
428         Map&lt;String, Object&gt; more_details = new HashMap&lt;&gt;();
429         more_details.put("id", 2);
430         Map&lt;String, Object&gt; details = new HashMap&lt;&gt;();
431         details.put("id", 1);
432         details.put("more_details", more_details);
433         execute("insert into t1 (id, details) values (2, ?)", new Object[]{details});
434         execute("refresh table t1");
435         execute("select details from t1 where details['id'] = 2");
436         assertThat(response.rowCount(), is(0L));
437     }
438     @Test
439     @SuppressWarnings("unchecked")
440     public void testArraySupportWithNullValues() throws Exception {
441         execute("create table t1 (id int primary key, strings array(string)) with (number_of_replicas=0)");
442         ensureYellow();
443         execute("insert into t1 (id, strings) values (?, ?)",
444             new Object[]{
445                 1,
446                 new String[]{"foo", null, "bar"},
447             }
448         );
449         refresh();
450         execute("select id, strings from t1");
451         assertThat(response.rowCount(), is(1L));
452         assertThat(response.rows()[0][0], is(1));
453         assertThat(((List) response.rows()[0][1]).get(0), is("foo"));
454         assertThat(((List) response.rows()[0][1]).get(1), nullValue());
455         assertThat(((List) response.rows()[0][1]).get(2), is("bar"));
456     }
457     @Test
458     public void testObjectArrayInsertAndSelect() throws Exception {
459         execute("create table t1 (" +
460                 "  id int primary key, " +
461                 "  objects array(" +
462                 "   object as (" +
463                 "     name string, " +
464                 "     age int" +
465                 "   )" +
466                 "  )" +
467                 ") with (number_of_replicas=0)");
468         ensureYellow();
469         Map&lt;String, Object&gt; obj1 = Map.of("name", "foo", "age", 1);
470         Map&lt;String, Object&gt; obj2 = Map.of("name", "bar", "age", 2);
471         Object[] args = new Object[]{1, new Object[]{obj1, obj2}};
472         execute("insert into t1 (id, objects) values (?, ?)", args);
473         refresh();
474         execute("select objects from t1");
475         assertThat(response.rowCount(), is(1L));
476         List objResults = (List) response.rows()[0][0];
477         Map&lt;String, Object&gt; obj1Result = (Map) objResults.get(0);
478         assertThat(obj1Result.get("name"), is("foo"));
479         assertThat(obj1Result.get("age"), is(1));
480         Map&lt;String, Object&gt; obj2Result = (Map) objResults.get(1);
481         assertThat(obj2Result.get("name"), is("bar"));
482         assertThat(obj2Result.get("age"), is(2));
483         execute("select objects['name'] from t1");
484         assertThat(response.rowCount(), is(1L));
485         List names = (List) response.rows()[0][0];
486         assertThat(names.get(0), is("foo"));
487         assertThat(names.get(1), is("bar"));
488         execute("select objects['name'] from t1 where ? = ANY (objects['name'])", new Object[]{"foo"});
489         assertThat(response.rowCount(), is(1L));
490     }
491     @Test
492     public void testGetResponseWithObjectColumn() throws Exception {
493         execute("create table test (" +
494                 "   id text primary key," +
495                 "   data object " +
496                 ")");
497         Map&lt;String, Object&gt; data = new HashMap&lt;&gt;();
498         data.put("foo", "bar");
499         execute("insert into test (id, data) values (?, ?)", new Object[]{"1", data});
500         refresh();
501         execute("select data from test where id = ?", new Object[]{"1"});
502         assertEquals(data, response.rows()[0][0]);
503     }
504     @Test
505     public void testSelectToGetRequestByPlanner() throws Exception {
506         this.setup.createTestTableWithPrimaryKey();
507         execute("insert into test (pk_col, message) values ('124', 'bar1')");
508         assertEquals(1, response.rowCount());
509         refresh();
510         waitNoPendingTasksOnAll(); 
511         execute("select pk_col, message from test where pk_col='124'");
512         assertEquals(1, response.rowCount());
513         assertEquals("124", response.rows()[0][0]);
514     }
515     @Test
516     public void testSelectToRoutedRequestByPlanner() throws Exception {
517         this.setup.createTestTableWithPrimaryKey();
518         execute("insert into test (pk_col, message) values ('1', 'foo')");
519         execute("insert into test (pk_col, message) values ('2', 'bar')");
520         execute("insert into test (pk_col, message) values ('3', 'baz')");
521         execute("SELECT * FROM test WHERE pk_col='1' OR pk_col='2'");
522         assertThat(response.rowCount(), is(2L));
523         execute("SELECT * FROM test WHERE pk_col=? OR pk_col=?", new Object[]{"1", "2"});
524         assertThat(response.rowCount(), is(2L));
525         execute("SELECT * FROM test WHERE (pk_col=? OR pk_col=?) OR pk_col=?", new Object[]{"1", "2", "3"});
526         assertThat(response.rowCount(), is(3L));
527         assertThat(String.join(", ", List.of(response.cols())), is("pk_col, message"));
528     }
529     @Test
530     public void testSelectToRoutedRequestByPlannerMissingDocuments() throws Exception {
531         this.setup.createTestTableWithPrimaryKey();
532         execute("insert into test (pk_col, message) values ('1', 'foo')");
533         execute("insert into test (pk_col, message) values ('2', 'bar')");
534         execute("insert into test (pk_col, message) values ('3', 'baz')");
535         refresh();
536         execute("SELECT pk_col, message FROM test WHERE pk_col='4' OR pk_col='3'");
537         assertEquals(1, response.rowCount());
538         assertThat(Arrays.asList(response.rows()[0]), hasItems(new Object[]{"3", "baz"}));
539         execute("SELECT pk_col, message FROM test WHERE pk_col='4' OR pk_col='99'");
540         assertEquals(0, response.rowCount());
541     }
542     @Test
543     public void testSelectToRoutedRequestByPlannerWhereIn() throws Exception {
544         this.setup.createTestTableWithPrimaryKey();
545         execute("insert into test (pk_col, message) values ('1', 'foo')");
546         execute("insert into test (pk_col, message) values ('2', 'bar')");
547         execute("insert into test (pk_col, message) values ('3', 'baz')");
548         refresh();
549         execute("SELECT * FROM test WHERE pk_col IN (?,?,?)", new Object[]{"1", "2", "3"});
550         assertEquals(3, response.rowCount());
551     }
552     @Test
553     public void testUpdateToRoutedRequestByPlannerWhereOr() throws Exception {
554         this.setup.createTestTableWithPrimaryKey();
555         execute("insert into test (pk_col, message) values ('1', 'foo'), ('2', 'bar'), ('3', 'baz')");
556         refresh();
557         execute("update test set message='new' WHERE pk_col='1' or pk_col='2' or pk_col='4'");
558         assertThat(response.rowCount(), is(2L));
559         refresh();
560         execute("SELECT distinct message FROM test");
561         assertThat(response.rowCount(), is(2L));
562     }
563     @Test
564     public void testSelectWithWhereLike() throws Exception {
565         this.setup.groupBySetup();
566         execute("select name from characters where name like '%ltz'");
567         assertEquals(2L, response.rowCount());
568         execute("select count(*) from characters where name like 'Jeltz'");
569         assertEquals(1L, response.rows()[0][0]);
570         execute("select count(*) from characters where race like '%o%'");
571         assertEquals(3L, response.rows()[0][0]);
572         Map&lt;String, Object&gt; emptyMap = new HashMap&lt;&gt;();
573         Map&lt;String, Object&gt; details = new HashMap&lt;&gt;();
574         details.put("age", 30);
575         details.put("job", "soldier");
576         execute("insert into characters (race, gender, name, details) values (?, ?, ?, ?)",
577             new Object[]{"Vo*", "male", "Kwaltzz", emptyMap}
578         );
579         execute("insert into characters (race, gender, name, details) values (?, ?, ?, ?)",
580             new Object[]{"Vo?", "male", "Kwaltzzz", emptyMap}
581         );
582         execute("insert into characters (race, gender, name, details) values (?, ?, ?, ?)",
583             new Object[]{"Vo!", "male", "Kwaltzzzz", details}
584         );
585         execute("insert into characters (race, gender, name, details) values (?, ?, ?, ?)",
586             new Object[]{"Vo%", "male", "Kwaltzzzz", details}
587         );
588         refresh();
589         execute("select race from characters where race like 'Vo*'");
590         assertEquals(1L, response.rowCount());
591         assertEquals("Vo*", response.rows()[0][0]);
592         execute("select race from characters where race like ?", new Object[]{"Vo?"});
593         assertEquals(1L, response.rowCount());
594         assertEquals("Vo?", response.rows()[0][0]);
595         execute("select race from characters where race like 'Vo!'");
596         assertEquals(1L, response.rowCount());
597         assertEquals("Vo!", response.rows()[0][0]);
598         execute("select race from characters where race like 'Vo\\%'");
599         assertEquals(1L, response.rowCount());
600         assertEquals("Vo%", response.rows()[0][0]);
601         execute("select race from characters where race like 'Vo_'");
602         assertEquals(4L, response.rowCount());
603         execute("select race from characters where details['job'] like 'sol%'");
604         assertEquals(2L, response.rowCount());
605     }
606     private void nonExistingColumnSetup() {
607         execute("create table quotes (" +
608                 "id integer primary key, " +
609                 "quote string index off, " +
610                 "o object(ignored) " +
611                 ") clustered by (id) into 3 shards with (number_of_replicas = 0)");
612         execute("insert into quotes (id, quote) values (1, '\"Nothing particularly exciting," +
613                 "\" it admitted, \"but they are alternatives.\"')");
614         execute("insert into quotes (id, quote) values (2, '\"Have another drink," +
615                 "\" said Trillian. \"Enjoy yourself.\"')");
616         refresh();
617     }
618     @Test
619     public void selectNonExistingColumn() throws Exception {
620         nonExistingColumnSetup();
621         execute("select o['notExisting'] from quotes");
622         assertEquals(2L, response.rowCount());
623         assertEquals("o['notExisting']", response.cols()[0]);
624         assertNull(response.rows()[0][0]);
625         assertNull(response.rows()[1][0]);
626     }
627     @Test
628     public void selectNonExistingAndExistingColumns() throws Exception {
629         nonExistingColumnSetup();
630         execute("select o['unknown'], id from quotes order by id asc");
631         assertEquals(2L, response.rowCount());
632         assertEquals("o['unknown']", response.cols()[0]);
633         assertEquals("id", response.cols()[1]);
634         assertNull(response.rows()[0][0]);
635         assertEquals(1, response.rows()[0][1]);
636         assertNull(response.rows()[1][0]);
637         assertEquals(2, response.rows()[1][1]);
638     }
639     @Test
640     public void selectWhereNonExistingColumn() throws Exception {
641         nonExistingColumnSetup();
642         execute("select * from quotes where o['something'] &gt; 0");
643         assertEquals(0L, response.rowCount());
644     }
645     @Test
646     public void selectWhereDynamicColumnIsNull() throws Exception {
647         nonExistingColumnSetup();
648         execute("select * from quotes where o['something'] IS NULL");
649         assertEquals(2, response.rowCount());
650     }
651     @Test
652     public void selectWhereNonExistingColumnWhereIn() throws Exception {
653         nonExistingColumnSetup();
654         execute("select * from quotes where o['something'] IN (1,2,3)");
655         assertEquals(0L, response.rowCount());
656     }
657     @Test
658     public void selectWhereNonExistingColumnLike() throws Exception {
659         nonExistingColumnSetup();
660         execute("select * from quotes where o['something'] Like '%bla'");
661         assertEquals(0L, response.rowCount());
662     }
663 <a name="0"></a>
664     @Test
665     public void selectWhereNonExistingColumnMatchFunction() throws Exception {
666         <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>nonExistingColumnSetup();
667         assertThrowsMatches(() -&gt; execute("select * from quotes where match(o['something'], 'bla')"),
668                      isSQLError(is("Can only use MATCH on columns of type STRING or GEO_SHAPE, not on 'undefined'"),
669                                 INTERNAL_ERROR,
670                                 BAD_REQUEST,
671                                 4000));
672     }
673     @Test
674     public void testSelectCountDistinctZero() throws Exception {
675         execute("create table test (col1 int) with (number_of_replicas=0)");
676         ensureYellow();
677         execute("select count(distinct col1) from test");
678         assertEquals(1, response.rowCount());
679         assertEquals(0L, response.rows()[0][0]);
680     }
681     @Test
682     public void testRefresh() throws Exception {
683         execute("create table test (id int primary key, name string) with (refresh_interval = 0)");
684         ensureYellow();
685         execute("insert into test (id, name) values (0, 'Trillian'), (1, 'Ford'), (2, 'Zaphod')");
686         execute("select count(*) from test");
687         assertThat((long) response.rows()[0][0], lessThanOrEqualTo</b></font>(3L));
688         execute("refresh table test");
689         assertThat(response.rowCount(), is(1L));
690         execute("select count(*) from test");
691         assertThat((Long) response.rows()[0][0], is(3L));
692     }
693     @Test
694     public void testInsertSelectWithClusteredBy() throws Exception {
695         execute("create table quotes (id integer, quote string) clustered by(id) " +
696                 "with (number_of_replicas=0)");
697         ensureYellow();
698         execute("insert into quotes (id, quote) values(?, ?)",
699             new Object[]{1, "I'd far rather be happy than right any day."});
700         assertEquals(1L, response.rowCount());
701         refresh();
702         execute("select \"_id\", id, quote from quotes where id=1");
703         assertEquals(1L, response.rowCount());
704         assertNotNull(response.rows()[0][0]);
705         assertThat(((String) response.rows()[0][0]).length(), greaterThan(0));
706     }
707     @Test
708     public void testInsertSelectWithAutoGeneratedId() throws Exception {
709         execute("create table quotes (id integer, quote string)" +
710                 "with (number_of_replicas=0)");
711         ensureYellow();
712         execute("insert into quotes (id, quote) values(?, ?)",
713             new Object[]{1, "I'd far rather be happy than right any day."});
714         assertEquals(1L, response.rowCount());
715         refresh();
716         execute("select \"_id\", id, quote from quotes where id=1");
717         assertEquals(1L, response.rowCount());
718         assertNotNull(response.rows()[0][0]);
719         assertThat(((String) response.rows()[0][0]).length(), greaterThan(0));
720     }
721     @Test
722     public void testInsertSelectWithPrimaryKey() throws Exception {
723         execute("create table quotes (id integer primary key, quote string)" +
724                 "with (number_of_replicas=0)");
725         ensureYellow();
726         execute("insert into quotes (id, quote) values(?, ?)",
727             new Object[]{1, "I'd far rather be happy than right any day."});
728         assertEquals(1L, response.rowCount());
729         refresh();
730         execute("select \"_id\", id, quote from quotes where id=1");
731         assertEquals(1L, response.rowCount());
732         String _id = (String) response.rows()[0][0];
733         Integer id = (Integer) response.rows()[0][1];
734         assertEquals(id.toString(), _id);
735     }
736     @Test
737     public void testInsertSelectWithMultiplePrimaryKey() throws Exception {
738         execute("create table quotes (id integer primary key, author string primary key, " +
739                 "quote string) with (number_of_replicas=0)");
740         ensureYellow();
741         execute("insert into quotes (id, author, quote) values(?, ?, ?)",
742             new Object[]{1, "Ford", "I'd far rather be happy than right any day."});
743         assertEquals(1L, response.rowCount());
744         refresh();
745         execute("select \"_id\", id from quotes where id=1 and author='Ford'");
746         assertEquals(1L, response.rowCount());
747         assertThat((String) response.rows()[0][0], is("AgExBEZvcmQ="));
748         assertThat((Integer) response.rows()[0][1], is(1));
749     }
750     @Test
751     public void testInsertSelectWithMultiplePrimaryKeyAndClusteredBy() throws Exception {
752         execute("create table quotes (id integer primary key, author string primary key, " +
753                 "quote string) clustered by(author) with (number_of_replicas=0)");
754         ensureYellow();
755         execute("insert into quotes (id, author, quote) values(?, ?, ?)",
756             new Object[]{1, "Ford", "I'd far rather be happy than right any day."});
757         assertEquals(1L, response.rowCount());
758         refresh();
759         execute("select \"_id\", id from quotes where id=1 and author='Ford'");
760         assertEquals(1L, response.rowCount());
761         assertThat((String) response.rows()[0][0], is("AgRGb3JkATE="));
762         assertThat((Integer) response.rows()[0][1], is(1));
763     }
764     @Test
765     public void testInsertSelectWithMultiplePrimaryOnePkSame() throws Exception {
766         execute("create table quotes (id integer primary key, author string primary key, " +
767                 "quote string) clustered by(author) with (number_of_replicas=0)");
768         ensureYellow();
769         execute("insert into quotes (id, author, quote) values (?, ?, ?), (?, ?, ?)",
770             new Object[]{1, "Ford", "I'd far rather be happy than right any day.",
771                 1, "Douglas", "Don't panic"}
772         );
773         assertEquals(2L, response.rowCount());
774         refresh();
775         execute("select \"_id\", id from quotes where id=1 order by author");
776         assertEquals(2L, response.rowCount());
777         assertThat((String) response.rows()[0][0], is("AgdEb3VnbGFzATE="));
778         assertThat((Integer) response.rows()[0][1], is(1));
779         assertThat((String) response.rows()[1][0], is("AgRGb3JkATE="));
780         assertThat((Integer) response.rows()[1][1], is(1));
781     }
782     @Test
783     public void testSelectWhereBoolean() {
784         execute("create table a (v boolean)");
785         ensureYellow();
786         execute("insert into a values (true)");
787         execute("insert into a values (true)");
788         execute("insert into a values (true)");
789         execute("insert into a values (false)");
790         execute("insert into a values (false)");
791         refresh();
792         execute("select v from a where v");
793         assertEquals(3L, response.rowCount());
794         execute("select v from a where not v");
795         assertEquals(2L, response.rowCount());
796         execute("select v from a where v or not v");
797         assertEquals(5L, response.rowCount());
798         execute("select v from a where v and not v");
799         assertEquals(0L, response.rowCount());
800     }
801     @Test
802     public void testSelectWhereBooleanPK() {
803         execute("create table b (v boolean primary key) clustered by (v)");
804         ensureYellow();
805         execute("insert into b values (true)");
806         execute("insert into b values (false)");
807         refresh();
808         execute("select v from b where v");
809         assertEquals(1L, response.rowCount());
810         execute("select v from b where not v");
811         assertEquals(1L, response.rowCount());
812         execute("select v from b where v or not v");
813         assertEquals(2L, response.rowCount());
814         execute("select v from b where v and not v");
815         assertEquals(0L, response.rowCount());
816     }
817     @Test
818     public void testBulkOperations() throws Exception {
819         execute("create table test (id integer primary key, name string) with (number_of_replicas = 0)");
820         ensureYellow();
821         long[] rowCounts = execute("insert into test (id, name) values (?, ?), (?, ?)",
822             new Object[][]{
823                 {1, "Earth", 2, "Saturn"},                    {3, "Moon", 4, "Mars"}                    });
824         assertThat(rowCounts.length, is(2));
825         for (long rowCount : rowCounts) {
826             assertThat(rowCount, is(2L));
827         }
828         refresh();
829         rowCounts = execute("insert into test (id, name) values (?, ?), (?, ?)",
830             new Object[][]{
831                 {1, "Earth", 2, "Saturn"},                    {3, "Moon", 4, "Mars"}                    });
832         assertThat(rowCounts.length, is(2));
833         for (long rowCount : rowCounts) {
834             assertThat(rowCount, is(-2L));
835         }
836         execute("select name from test order by id asc");
837         assertEquals("Earth\nSaturn\nMoon\nMars\n", printedTable(response.rows()));
838         rowCounts = execute("update test set name = concat(name, '-updated') where id = ?", new Object[][]{
839             new Object[]{2},
840             new Object[]{3},
841             new Object[]{4},
842         });
843         assertThat(rowCounts.length, is(3));
844         for (long rowCount : rowCounts) {
845             assertThat(rowCount, is(1L));
846         }
847         refresh();
848         execute("select count(*) from test where name like '%-updated'");
849         assertThat(response.rows()[0][0], is(3L));
850         rowCounts = execute("delete from test where id = ?", new Object[][]{
851             new Object[]{1},
852             new Object[]{3}
853         });
854         assertThat(rowCounts.length, is(2));
855         for (long rowCount : rowCounts) {
856             assertThat(rowCount, is(1L));
857         }
858         refresh();
859         execute("select count(*) from test");
860         assertThat(response.rows()[0][0], is(2L));
861         rowCounts = execute("delete from test where name = ?", new Object[][]{
862             new Object[]{"Saturn-updated"},
863             new Object[]{"Mars-updated"}
864         });
865         assertThat(rowCounts.length, is(2));
866         for (long rowCount : rowCounts) {
867             assertThat(rowCount, is(1L));
868         }
869         refresh();
870         execute("select count(*) from test");
871         assertThat(response.rows()[0][0], is(0L));
872     }
873     @Test
874     public void testSelectFormatFunction() throws Exception {
875         execute("create table tbl (name text, kind text)");
876         execute("insert into tbl (name, kind) values ('', 'Planet'), ('Aldebaran', 'Star System'), ('Algol', 'Star System')");
877         execute("refresh table tbl");
878         execute("select format('%s is a %s', name, kind) as sentence from tbl order by name");
879         assertThat(response.cols(), Matchers.arrayContaining("sentence"));
880         assertThat(printedTable(response.rows()), is(
881             " is a Planet\n" +
882             "Aldebaran is a Star System\n" +
883             "Algol is a Star System\n"
884         ));
885     }
886     @Test
887     public void testAnyArray() throws Exception {
888         this.setup.setUpArrayTables();
889         execute("select count(*) from any_table where 'Berlin' = ANY (names)");
890         assertThat((Long) response.rows()[0][0], is(2L));
891         execute("select id, names from any_table where 'Berlin' = ANY (names) order by id");
892         assertThat(response.rowCount(), is(2L));
893         assertThat((Integer) response.rows()[0][0], is(1));
894         assertThat((Integer) response.rows()[1][0], is(3));
895         execute("select id from any_table where 'Berlin' != ANY (names) order by id");
896         assertThat(response.rowCount(), is(3L));
897         assertThat((Integer) response.rows()[0][0], is(1));
898         assertThat((Integer) response.rows()[1][0], is(2));
899         assertThat((Integer) response.rows()[2][0], is(3));
900         execute("select count(id) from any_table where 0.0 &lt; ANY (temps)");
901         assertThat((Long) response.rows()[0][0], is(2L));
902         execute("select id, names from any_table where 0.0 &lt; ANY (temps) order by id");
903         assertThat(response.rowCount(), is(2L));
904         assertThat((Integer) response.rows()[0][0], is(2));
905         assertThat((Integer) response.rows()[1][0], is(3));
906         execute("select count(*) from any_table where 0.0 &gt; ANY (temps)");
907         assertThat((Long) response.rows()[0][0], is(2L));
908         execute("select id, names from any_table where 0.0 &gt; ANY (temps) order by id");
909         assertThat(response.rowCount(), is(2L));
910         assertThat((Integer) response.rows()[0][0], is(2));
911         assertThat((Integer) response.rows()[1][0], is(3));
912         execute("select id, names from any_table where 'Ber%' LIKE ANY (names) order by id");
913         assertThat(response.rowCount(), is(2L));
914         assertThat((Integer) response.rows()[0][0], is(1));
915         assertThat((Integer) response.rows()[1][0], is(3));
916     }
917     @Test
918     public void testNotAnyArray() throws Exception {
919         this.setup.setUpArrayTables();
920         execute("select id from any_table where NOT 'Hangelsberg' = ANY (names) order by id");
921         assertThat(response.rowCount(), is(2L));
922         assertThat((Integer) response.rows()[0][0], is(1));
923         assertThat((Integer) response.rows()[1][0], is(2));
924         execute("select id from any_table where 'Hangelsberg' != ANY (names) order by id");
925         assertThat(response.rowCount(), is(3L));
926         assertThat((Integer) response.rows()[0][0], is(1));
927         assertThat((Integer) response.rows()[1][0], is(2));
928         assertThat((Integer) response.rows()[2][0], is(3));
929     }
930     @Test
931     public void testAnyLike() throws Exception {
932         this.setup.setUpArrayTables();
933         execute("select id from any_table where 'kuh%' LIKE ANY (tags) order by id");
934         assertThat(response.rowCount(), is(2L));
935         assertThat((Integer) response.rows()[0][0], is(3));
936         assertThat((Integer) response.rows()[1][0], is(4));
937         execute("select id from any_table where 'kuh%' NOT LIKE ANY (tags) order by id");
938         assertThat(response.rowCount(), is(3L));
939         assertThat((Integer) response.rows()[0][0], is(1));
940         assertThat((Integer) response.rows()[1][0], is(2));
941         assertThat((Integer) response.rows()[2][0], is(3));
942     }
943     @Test
944     public void testInsertAndSelectIpType() throws Exception {
945         execute("create table ip_table (fqdn string, addr ip) with (number_of_replicas=0)");
946         ensureYellow();
947         execute("insert into ip_table (fqdn, addr) values ('localhost', '127.0.0.1'), ('crate.io', '23.235.33.143')");
948         execute("refresh table ip_table");
949         execute("select addr from ip_table where addr = '23.235.33.143'");
950         assertThat(response.rowCount(), is(1L));
951         assertThat((String) response.rows()[0][0], is("23.235.33.143"));
952         execute("select addr from ip_table where addr &gt; '127.0.0.1'");
953         assertThat(response.rowCount(), is(0L));
954         execute("select addr from ip_table where addr &gt; 2130706433");         assertThat(response.rowCount(), is(0L));
955         execute("select addr from ip_table where addr &lt; '127.0.0.1'");
956         assertThat(response.rowCount(), is(1L));
957         assertThat((String) response.rows()[0][0], is("23.235.33.143"));
958         execute("select addr from ip_table where addr &lt; 2130706433");         assertThat(response.rowCount(), is(1L));
959         assertThat((String) response.rows()[0][0], is("23.235.33.143"));
960         execute("select addr from ip_table where addr &lt;= '127.0.0.1'");
961         assertThat(response.rowCount(), is(2L));
962         execute("select addr from ip_table where addr &gt;= '23.235.33.143'");
963         assertThat(response.rowCount(), is(2L));
964         execute("select addr from ip_table where addr IS NULL");
965         assertThat(response.rowCount(), is(0L));
966         execute("select addr from ip_table where addr IS NOT NULL");
967         assertThat(response.rowCount(), is(2L));
968     }
969     @Test
970     public void testGroupByOnIpType() throws Exception {
971         execute("create table t (i ip) with (number_of_replicas=0)");
972         ensureYellow();
973         execute("insert into t (i) values ('192.168.1.2'), ('192.168.1.2'), ('192.168.1.3')");
974         execute("refresh table t");
975         execute("select i, count(*) from t group by 1 order by count(*) desc");
976         assertThat(response.rowCount(), is(2L));
977         assertThat((String) response.rows()[0][0], is("192.168.1.2"));
978         assertThat((Long) response.rows()[0][1], is(2L));
979         assertThat((String) response.rows()[1][0], is("192.168.1.3"));
980         assertThat((Long) response.rows()[1][1], is(1L));
981     }
982     @Test
983     public void testInsertAndSelectGeoType() throws Exception {
984         execute("create table geo_point_table (id int primary key, p geo_point) with (number_of_replicas=0)");
985         ensureYellow();
986         execute("insert into geo_point_table (id, p) values (?, ?)", new Object[]{1, new Double[]{47.22, 12.09}});
987         execute("insert into geo_point_table (id, p) values (?, ?)", new Object[]{2, new Double[]{57.22, 7.12}});
988         refresh();
989         execute("select p from geo_point_table order by id desc");
990         assertThat(response.rowCount(), is(2L));
991         Point p1 = (Point) response.rows()[0][0];
992         assertThat(p1.getX(), closeTo(57.22, 0.01));
993         assertThat(p1.getY(), closeTo(7.12, 0.01));
994         Point p2 = (Point) response.rows()[1][0];
995         assertThat(p2.getX(), closeTo(47.22, 0.01));
996         assertThat(p2.getY(), closeTo(12.09, 0.01));
997     }
998     @Test
999     public void testGeoTypeQueries() throws Exception {
1000         execute("create table t (id int primary key, i int, p geo_point) " +
1001                 "clustered into 1 shards " +
1002                 "with (number_of_replicas=0)");
1003         ensureYellow();
1004         execute("insert into t (id, i, p) values (1, 1, 'POINT (10 20)')");
1005         execute("insert into t (id, i, p) values (2, 1, 'POINT (11 21)')");
1006         refresh();
1007         execute("select distance(p, 'POINT (11 21)') from t order by 1");
1008         assertThat(response.rowCount(), is(2L));
1009         Double result1 = (Double) response.rows()[0][0];
1010         Double result2 = (Double) response.rows()[1][0];
1011         assertThat(result1, is(0.0d));
1012         assertThat(result2, is(152354.32308347954));
1013         String stmtOrderBy = "SELECT id " +
1014                              "FROM t " +
1015                              "ORDER BY distance(p, 'POINT(30.0 30.0)')";
1016         execute(stmtOrderBy);
1017         assertThat(response.rowCount(), is(2L));
1018         String expectedOrderBy =
1019             "2\n" +
1020             "1\n";
1021         assertEquals(expectedOrderBy, printedTable(response.rows()));
1022         String stmtAggregate = "SELECT i, max(distance(p, 'POINT(30.0 30.0)')) " +
1023                                "FROM t " +
1024                                "GROUP BY i";
1025         execute(stmtAggregate);
1026         assertThat(response.rowCount(), is(1L));
1027         String expectedAggregate = "1| 2296582.8899438097\n";
1028         assertEquals(expectedAggregate, printedTable(response.rows()));
1029         Point point;
1030         execute("select p from t where distance(p, 'POINT (11 21)') &gt; 0.0");
1031         assertThat(response.rowCount(), is(1L));
1032         point = (Point) response.rows()[0][0];
1033         assertThat(point.getX(), closeTo(10.0d, 0.01));
1034         assertThat(point.getY(), closeTo(20.0d, 0.02));
1035         execute("select p from t where distance(p, 'POINT (11 21)') &lt; 10.0");
1036         assertThat(response.rowCount(), is(1L));
1037         point = (Point) response.rows()[0][0];
1038         assertThat(point.getX(), closeTo(11.0d, 0.01));
1039         assertThat(point.getY(), closeTo(21.0d, 0.01));
1040         execute("select p from t where distance(p, 'POINT (11 21)') &lt; 10.0 or distance(p, 'POINT (11 21)') &gt; 10.0");
1041         assertThat(response.rowCount(), is(2L));
1042         execute("select p from t where distance(p, 'POINT (10 20)') &gt;= 0.0 and distance(p, 'POINT (10 20)') &lt;= 0.1");
1043         assertThat(response.rowCount(), is(1L));
1044         point = (Point) response.rows()[0][0];
1045         assertThat(point.getX(), closeTo(10.0d, 0.01));
1046         assertThat(point.getY(), closeTo(20.0d, 0.01));
1047         execute("select p from t where distance(p, 'POINT (10 20)') = 0.0");
1048         assertThat(response.rowCount(), is(1L));
1049         point = (Point) response.rows()[0][0];
1050         assertThat(point.getX(), closeTo(10.0d, 0.01));
1051         assertThat(point.getY(), closeTo(20.0d, 0.01));
1052         execute("select p from t where distance(p, 'POINT (10 20)') = 152354.3209044634");
1053         Point p = (Point) response.rows()[0][0];
1054         assertThat(p.getX(), closeTo(11.0, 0.01));
1055         assertThat(p.getY(), closeTo(21.0, 0.01));
1056     }
1057     @Test
1058     @UseJdbc(0)     public void testWithinQuery() throws Exception {
1059         execute("create table t (id int primary key, p geo_point) " +
1060                 "clustered into 1 shards " +
1061                 "with (number_of_replicas=0)");
1062         ensureYellow();
1063         execute("insert into t (id, p) values (1, 'POINT (10 10)')");
1064         refresh();
1065         execute("select within(p, 'POLYGON (( 5 5, 30 5, 30 30, 5 30, 5 5 ))') from t");
1066         assertThat((Boolean) response.rows()[0][0], is(true));
1067         execute("select * from t where within(p, 'POLYGON (( 5 5, 30 5, 30 30, 5 30, 5 5 ))')");
1068         assertThat(response.rowCount(), is(1L));
1069         execute("select * from t where within(p, ?)", $(Map.of(
1070             "type", "Polygon",
1071             "coordinates", new double[][][]{
1072                 {
1073                     {5.0, 5.0},
1074                     {30.0, 5.0},
1075                     {30.0, 30.0},
1076                     {5.0, 30.0},
1077                     {5.0, 5.0}
1078                 }
1079             }
1080         )));
1081         assertThat(response.rowCount(), is(1L));
1082         execute("select * from t where within(p, 'POLYGON (( 5 5, 30 5, 30 30, 5 30, 5 5 ))') = false");
1083         assertThat(response.rowCount(), is(0L));
1084     }
1085     @Test
1086     public void testTwoSubStrOnSameColumn() throws Exception {
1087         execute("select substr(name, 0, 4), substr(name, 4, 8) from sys.cluster");
1088         assertThat(printedTable(response.rows()), is("SUIT| TE-TEST_\n"));
1089     }
1090     @Test
1091     public void testSelectArithMetricOperatorInOrderBy() throws Exception {
1092         execute("create table t (i integer, l long, d double) clustered into 3 shards with (number_of_replicas=0)");
1093         ensureYellow();
1094         execute("insert into t (i, l, d) values (1, 2, 90.5), (2, 5, 90.5), (193384, 31234594433, 99.0), (10, 21, 99.0), (-1, 4, 99.0)");
1095         refresh();
1096         execute("select i, i%3 from t order by i%3, l");
1097         assertThat(response.rowCount(), is(5L));
1098         assertThat(printedTable(response.rows()), is(
1099             "-1| -1\n" +
1100             "1| 1\n" +
1101             "10| 1\n" +
1102             "193384| 1\n" +
1103             "2| 2\n"));
1104     }
1105     @Test
1106     public void testSelectFailingSearchScript() throws Exception {
1107         execute("create table t (i integer, l long, d double) clustered into 1 shards with (number_of_replicas=0)");
1108         ensureYellow();
1109         execute("insert into t (i, l, d) values (1, 2, 90.5)");
1110         refresh();
1111         assertThrowsMatches(() -&gt; execute("select log(d, l) from t where log(d, -1) &gt;= 0"),
1112                      isSQLError(is("log(x, b): given arguments would result in: 'NaN'"),
1113                                 INTERNAL_ERROR,
1114                                 BAD_REQUEST,
1115                                 4000));
1116     }
1117     @Test
1118     public void testSelectGroupByFailingSearchScript() throws Exception {
1119         execute("create table t (i integer, l long, d double) with (number_of_replicas=0)");
1120         ensureYellow();
1121         execute("insert into t (i, l, d) values (1, 2, 90.5), (0, 4, 100)");
1122         execute("refresh table t");
1123         assertThrowsMatches(() -&gt; execute("select log(d, l) from t where log(d, -1) &gt;= 0 group by log(d, l)"),
1124                      isSQLError(is("log(x, b): given arguments would result in: 'NaN'"),
1125                                 INTERNAL_ERROR,
1126                                 BAD_REQUEST,
1127                                 4000));
1128     }
1129     @Test
1130     public void testNumericScriptOnAllTypes() {
1131         execute(
1132             "create table t (" +
1133             "   b byte," +
1134             "   s short," +
1135             "   i integer," +
1136             "   l long," +
1137             "   f float," +
1138             "   d double," +
1139             "   t timestamp with time zone" +
1140             ") with (number_of_replicas=0)");
1141         ensureYellow();
1142         execute("insert into t (b, s, i, l, f, d, t) values (1, 2, 3, 4, 5.7, 6.3, '2014-07-30')");
1143         refresh();
1144         String[] functionCalls = new String[]{
1145             "abs(%s)",
1146             "ceil(%s)",
1147             "floor(%s)",
1148             "ln(%s)",
1149             "log(%s)",
1150             "log(%s, 2)",
1151             "random()",
1152             "round(%s)",
1153             "sqrt(%s)"
1154         };
1155         for (String functionCall : functionCalls) {
1156             String byteCall = String.format(Locale.ENGLISH, functionCall, "b");
1157             execute(String.format(Locale.ENGLISH, "select %s, b from t where %s &lt; 2", byteCall, byteCall));
1158             String shortCall = String.format(Locale.ENGLISH, functionCall, "s");
1159             execute(String.format(Locale.ENGLISH, "select %s, s from t where %s &lt; 2", shortCall, shortCall));
1160             String intCall = String.format(Locale.ENGLISH, functionCall, "i");
1161             execute(String.format(Locale.ENGLISH, "select %s, i from t where %s &lt; 2", intCall, intCall));
1162             String longCall = String.format(Locale.ENGLISH, functionCall, "l");
1163             execute(String.format(Locale.ENGLISH, "select %s, l from t where %s &lt; 2", longCall, longCall));
1164             String floatCall = String.format(Locale.ENGLISH, functionCall, "f");
1165             execute(String.format(Locale.ENGLISH, "select %s, f from t where %s &lt; 2", floatCall, floatCall));
1166             String doubleCall = String.format(Locale.ENGLISH, functionCall, "d");
1167             execute(String.format(Locale.ENGLISH, "select %s, d from t where %s &lt; 2", doubleCall, doubleCall));
1168         }
1169     }
1170     @Test
1171     public void testWhereColumnEqColumnAndFunctionEqFunction() throws Exception {
1172         execute("create table tbl (name text)");
1173         execute("insert into tbl (name) values ('Arthur'), ('Trillian')");
1174         execute("refresh table tbl");
1175         execute("select name from tbl where name = name");
1176         assertThat(response.rowCount(), is(2L));
1177         execute("select name from tbl where substr(name, 1, 1) = substr(name, 1, 1)");
1178         assertThat(response.rowCount(), is(2L));
1179     }
1180     @Test
1181     public void testNewColumn() throws Exception {
1182         execute("create table t (name string) with (number_of_replicas=0, column_policy = 'dynamic')");
1183         execute("insert into t (name, score) values ('Ford', 1.2)");
1184     }
1185     @Test
1186     public void testESGetSourceColumns() throws Exception {
1187         this.setup.setUpLocations();
1188         ensureYellow();
1189         refresh();
1190         execute("select _id, _version from locations where id=2");
1191         assertNotNull(response.rows()[0][0]);
1192         assertNotNull(response.rows()[0][1]);
1193         execute("select _id, name from locations where id=2");
1194         assertNotNull(response.rows()[0][0]);
1195         assertNotNull(response.rows()[0][1]);
1196         execute("select _id, _doc from locations where id=2");
1197         assertNotNull(response.rows()[0][0]);
1198         assertNotNull(response.rows()[0][1]);
1199         execute("select _doc, id from locations where id in (2,3) order by id");
1200         Map&lt;String, Object&gt; _doc1 = (Map&lt;String, Object&gt;) response.rows()[0][0];
1201         Map&lt;String, Object&gt; _doc2 = (Map&lt;String, Object&gt;) response.rows()[1][0];
1202         assertEquals(_doc1.get("id"), "2");
1203         assertEquals(_doc2.get("id"), "3");
1204         execute("select name, kind from locations where id in (2,3) order by id");
1205         assertEquals(printedTable(response.rows()), "Outer Eastern Rim| Galaxy\n" +
1206                                                     "Galactic Sector QQ7 Active J Gamma| Galaxy\n");
1207         execute("select name, kind, _id from locations where id in (2,3) order by id");
1208         assertEquals(printedTable(response.rows()), "Outer Eastern Rim| Galaxy| 2\n" +
1209                                                     "Galactic Sector QQ7 Active J Gamma| Galaxy| 3\n");
1210         execute("select _raw, id from locations where id in (2,3) order by id");
1211         Map&lt;String, Object&gt; firstRaw = JsonXContent.JSON_XCONTENT.createParser(
1212             NamedXContentRegistry.EMPTY,
1213             DeprecationHandler.THROW_UNSUPPORTED_OPERATION,
1214             (String) response.rows()[0][0]).map();
1215         assertThat(response.rows()[0][1], is("2"));
1216         assertThat(firstRaw.get("id"), is("2"));
1217         assertThat(firstRaw.get("name"), is("Outer Eastern Rim"));
1218         assertThat(firstRaw.get("date"), is(308534400000L));
1219         assertThat(firstRaw.get("kind"), is("Galaxy"));
1220         Map&lt;String, Object&gt; secondRaw = JsonXContent.JSON_XCONTENT.createParser(
1221             NamedXContentRegistry.EMPTY,
1222             DeprecationHandler.THROW_UNSUPPORTED_OPERATION,
1223             (String) response.rows()[1][0]).map();
1224         assertThat(response.rows()[1][1], is("3"));
1225         assertThat(secondRaw.get("id"), is("3"));
1226         assertThat(secondRaw.get("name"), is("Galactic Sector QQ7 Active J Gamma"));
1227         assertThat(secondRaw.get("date"), is(1367366400000L));
1228         assertThat(secondRaw.get("kind"), is("Galaxy"));
1229     }
1230     @Test
1231     @UseRandomizedSchema(random = false)
1232     public void testUnknownTableJobGetsRemoved() throws Exception {
1233         String uniqueId = UUID.randomUUID().toString();
1234         String stmtStr = "select '" + uniqueId + "' from foobar";
1235         String stmtStrWhere = "select ''" + uniqueId + "'' from foobar";
1236         assertThrowsMatches(() -&gt; execute(stmtStr),
1237                      isSQLError(containsString("Relation 'foobar' unknown"),
1238                                 UNDEFINED_TABLE,
1239                                 NOT_FOUND,
1240                                 4041));
1241         execute("select stmt from sys.jobs where stmt='" + stmtStrWhere + "'");
1242         assertEquals(response.rowCount(), 0L);
1243     }
1244     @Test
1245     public void testInsertAndCopyHaveSameIdGeneration() throws Exception {
1246         execute("create table t (" +
1247                 "id1 long primary key," +
1248                 "id2 long primary key," +
1249                 "ts timestamp with time zone primary key," +
1250                 "n string) " +
1251                 "clustered by (id2)");
1252         ensureYellow();
1253         execute("insert into t (id1, id2, ts, n) values (176406344, 1825712027, 1433635200000, 'foo')");
1254         try {
1255             execute("insert into t (id1, id2, ts, n) values (176406344, 1825712027, 1433635200000, 'bar')");
1256             fail("should fail because document exists already");
1257         } catch (Exception e) {
1258         }
1259         execute("refresh table t");
1260         File file = folder.newFolder();
1261         String uriTemplate = Paths.get(file.toURI()).toUri().toString();
1262         execute("copy t to directory ?", new Object[]{uriTemplate});
1263         execute("copy t from ? with (shared=true)", new Object[]{uriTemplate + "/*"});
1264         execute("refresh table t");
1265         execute("select _id, * from t");
1266         assertThat(response.rowCount(), is(1L));
1267     }
1268     @Test
1269     public void testSelectFrom_Doc() throws Exception {
1270         execute("create table t (name string) with (number_of_replicas = 0)");
1271         ensureYellow();
1272         execute("insert into t (name) values ('Marvin')");
1273         execute("refresh table t");
1274         execute("select _doc['name'] from t");
1275         assertThat(((String) response.rows()[0][0]), is("Marvin"));
1276     }
1277     @Test
1278     public void testSelectWithSingleBulkArgRaisesUnsupportedError() {
1279         assertThrowsMatches(() -&gt;  execute("select * from sys.cluster", new Object[0][]),
1280                      isSQLError(is("Bulk operations for statements that return result sets is not supported"),
1281                                 INTERNAL_ERROR,
1282                                 BAD_REQUEST,
1283                                 4004));
1284     }
1285     @Test
1286     public void testSelectWithBulkArgsRaisesUnsupportedError() {
1287         assertThrowsMatches(() -&gt; execute("select * from sys.cluster", new Object[][]{new Object[]{1}, new Object[]{2}}),
1288                      isSQLError(is("Bulk operations for statements that return result sets is not supported"),
1289                                 INTERNAL_ERROR,
1290                                 BAD_REQUEST,
1291                                 4004));
1292     }
1293     @Test
1294     public void testWeirdIdentifiersAndLiterals() throws Exception {
1295         execute("CREATE TABLE with_quote (\"\"\"\" string) clustered into 1 shards with (number_of_replicas=0)");
1296         ensureYellow();
1297         execute("INSERT INTO with_quote (\"\"\"\") VALUES ('''')");
1298         execute("REFRESH TABLE with_quote");
1299         execute("SELECT * FROM with_quote");
1300         assertThat(response.rowCount(), is(1L));
1301         assertThat(response.cols(), is(arrayContaining("\"")));
1302         assertThat((String) response.rows()[0][0], is("'"));
1303     }
1304     @Test
1305     public void testWhereNotNull() throws Exception {
1306         execute("create table t (b boolean, i int) with (number_of_replicas=0)");
1307         execute("insert into t (b, i) values (true, 1), (false, 2), (null, null)");
1308         execute("refresh table t");
1309         execute("select b, not b, not (b &gt; i::boolean) from t order by b");
1310         Object[][] rows = response.rows();
1311         assertThat((Boolean) rows[0][0], is(false));
1312         assertThat((Boolean) rows[0][1], is(true));
1313         assertThat((Boolean) rows[0][2], is(true));
1314         assertThat((Boolean) rows[1][0], is(true));
1315         assertThat((Boolean) rows[1][1], is(false));
1316         assertThat((Boolean) rows[1][2], is(true));
1317         assertThat(rows[2][0], nullValue());
1318         assertThat(rows[2][1], nullValue());
1319         assertThat(rows[2][2], nullValue());
1320         execute("select b, i from t where not b");
1321         assertThat(response.rowCount(), is(1L));
1322         execute("select b, i from t where not b &gt; i::boolean");
1323         assertThat(response.rowCount(), is(2L));
1324         execute("SELECt b, i FROM t WHERE NOT (i = 1 AND b = TRUE)");
1325         assertThat(response.rowCount(), is(1L));
1326         execute("SELECT b, i FROM t WHERE NOT (i IS NULL OR b IS NULL)");
1327         assertThat(response.rowCount(), is(2L));
1328         execute("SELECT b FROM t WHERE NOT (coalesce(b, true))");
1329         assertThat(response.rowCount(), is(1L));
1330         execute("SELECT b, i FROM t WHERE NOT (coalesce(b, false) = true AND i IS NULL)");
1331         assertThat(response.rowCount(), is(2L));
1332     }
1333     @Test
1334     public void testScalarEvaluatesInErrorOnDocTable() throws Exception {
1335         execute("create table t1 (id int) with (number_of_replicas=0)");
1336         ensureYellow();
1337         execute("insert into t1 (id) values (1)");
1338         refresh();
1339         assertThrowsMatches(() -&gt; execute("select 1/0 from t1"),
1340                      isSQLError(is("/ by zero"),
1341                                 INTERNAL_ERROR,
1342                                 BAD_REQUEST,
1343                                 4000));
1344     }
1345     @Test
1346     public void testScalarEvaluatesInErrorOnDocTableNoMatch() throws Exception {
1347         execute("create table t1 (id int) with (number_of_replicas=0)");
1348         ensureYellow();
1349         execute("select 1/0 from t1 where true = false");
1350         assertThat(response.rowCount(), is(0L));
1351     }
1352     @Test
1353     public void testOrderByWorksOnSymbolWithLateNormalization() throws Exception {
1354         execute("create table t (x int) with (number_of_replicas = 0)");
1355         ensureYellow();
1356         execute("insert into t (x) values (5), (10), (3)");
1357         execute("refresh table t");
1358         execute("select cast((select 2) as integer) * x from t order by 1");
1359         assertThat(printedTable(response.rows()),
1360             is("6\n" +
1361                "10\n" +
1362                "20\n"));
1363     }
1364     @Test
1365     public void testOrderOnAnalyzedColumn() {
1366         execute("create table t (text string index using fulltext) with (number_of_replicas = 0)");
1367         execute("insert into t (text) values ('Hello World'), ('The End')");
1368         execute("refresh table t");
1369         assertThat(
1370             printedTable(execute("select text from t order by 1 desc").rows()),
1371             is("The End\n" +
1372                "Hello World\n")
1373         );
1374     }
1375     @Test
1376     public void test_values_as_top_level_relation() {
1377         execute("VALUES (1, 'a'), (2, 'b'), (3, (SELECT 'c'))");
1378         assertThat(
1379             printedTable(response.rows()),
1380             is("1| a\n" +
1381                "2| b\n" +
1382                "3| c\n")
1383         );
1384     }
1385     @Test
1386     public void test_select_with_explicit_high_limit_and_query_that_does_not_match_anything_to_trigger_batch_size_optimization() {
1387         execute("create table tbl (x int) clustered into 1 shards");
1388         Object[][] values = new Object[1001][];
1389         for (int i = 0; i &lt; values.length; i++) {
1390             values[i] = new Object[] { i };
1391         }
1392         execute("insert into tbl (x) values (?)", values);
1393         execute("refresh table tbl");
1394         execute("select x from tbl where x &gt; 5000 order by x limit 1500");
1395     }
1396     @Test
1397     public void test_select_from_virtual_table_with_window_function_and_column_pruning() throws Exception {
1398         execute("create table doc.metrics (id int primary key, x int)");
1399         execute("SELECT"
1400             + "    * "
1401             + " FROM ("
1402             + "     SELECT"
1403             + "         n.nspname,"
1404             + "         c.relname,"
1405             + "         a.attname,"
1406             + "         a.atttypid,"
1407             + "         a.attnotnull"
1408             + "         OR (t.typtype = 'd'"
1409             + "             AND t.typnotnull) AS attnotnull,"
1410             + "         a.atttypmod,"
1411             + "         a.attlen,"
1412             + "         row_number() OVER (PARTITION BY a.attrelid ORDER BY a.attnum) AS attnum,"
1413             + "         pg_catalog.pg_get_expr(def.adbin, def.adrelid) AS adsrc,"
1414             + "         dsc.description,"
1415             + "         t.typbasetype,"
1416             + "         t.typtype"
1417             + "     FROM"
1418             + "         pg_catalog.pg_namespace n"
1419             + "         JOIN pg_catalog.pg_class c ON (c.relnamespace = n.oid)"
1420             + "         JOIN pg_catalog.pg_attribute a ON (a.attrelid = c.oid)"
1421             + "         JOIN pg_catalog.pg_type t ON (a.atttypid = t.oid)"
1422             + "         LEFT JOIN pg_catalog.pg_attrdef def ON (a.attrelid = def.adrelid"
1423             + "                 AND a.attnum = def.adnum)"
1424             + "         LEFT JOIN pg_catalog.pg_description dsc ON (c.oid = dsc.objoid"
1425             + "                 AND a.attnum = dsc.objsubid)"
1426             + "         LEFT JOIN pg_catalog.pg_class dc ON (dc.oid = dsc.classoid"
1427             + "                 AND dc.relname = 'pg_class')"
1428             + "         LEFT JOIN pg_catalog.pg_namespace dn ON (dc.relnamespace = dn.oid"
1429             + "                 AND dn.nspname = 'pg_catalog')"
1430             + "     WHERE"
1431             + "         c.relkind IN ('r', 'v', 'f', 'm')"
1432             + "         AND a.attnum &gt; 0"
1433             + "         AND NOT a.attisdropped"
1434             + "         AND c.relname LIKE E'metrics') c"
1435             + " WHERE"
1436             + "     TRUE"
1437             + " ORDER BY"
1438             + "     nspname,"
1439             + "     c.relname,"
1440             + "     attnum");
1441         assertThat(printedTable(response.rows()),
1442             is("doc| metrics| id| 23| false| -1| 4| 1| NULL| NULL| 0| b\n" +
1443                "doc| metrics| x| 23| false| -1| 4| 2| NULL| NULL| 0| b\n")
1444         );
1445     }
1446     @Test
1447     public void test_subscript_on_ignored_object_does_not_raise_missing_key_error() throws Exception {
1448         execute("create table tbl (obj object (ignored))");
1449         execute("insert into tbl (obj) values ({a = 10})");
1450         execute("refresh table tbl");
1451         execute("select * from tbl where obj['b'] = 10");
1452         assertThat(printedTable(response.rows()), is(""));
1453         execute("select * from (select * from tbl) as t where obj['b'] = 10");
1454         assertThat(printedTable(response.rows()), is(""));
1455     }
1456     @Test
1457     public void test_primary_key_lookup_on_multiple_columns() throws Exception {
1458         execute(
1459             "CREATE TABLE doc.test (" +
1460             "   id TEXT, " +
1461             "   region_level_1 TEXT, " +
1462             "   marker_type TEXT, " +
1463             "   is_auto BOOLEAN," +
1464             "   PRIMARY KEY (id, region_level_1, marker_type, is_auto) " +
1465             ") clustered into 1 shards "
1466         );
1467         execute("insert into doc.test (id, region_level_1, marker_type, is_auto) values ('1', '2', '3', false)");
1468         execute("refresh table doc.test");
1469         execute("explain select id from doc.test where id = '1' and region_level_1 = '2' and marker_type = '3' and is_auto = false;");
1470         assertThat(printedTable(response.rows()), is(
1471             "Get[doc.test | id | DocKeys{'1', '2', '3', false} | ((((id = '1') AND (region_level_1 = '2')) AND (marker_type = '3')) AND (is_auto = false))]\n"
1472         ));
1473         execute("select id from doc.test where id = '1' and region_level_1 = '2' and marker_type = '3' and is_auto = false;");
1474         assertThat(printedTable(response.rows()), is(
1475             "1\n"
1476         ));
1477     }
1478     @Test
1479     public void test_primary_key_lookup_with_param_that_requires_cast_to_column_type() throws Exception {
1480         execute("create table tbl (ts timestamp with time zone primary key, path text primary key)");
1481         execute("INSERT INTO tbl (ts, path) VALUES ('2017-06-21T00:00:00.000000Z', 'c1')");
1482         execute("select _id, path from tbl where ts = '2017-06-21' and path = 'c1'");
1483         assertThat(printedTable(response.rows()), is(
1484             "Ag0xNDk4MDAzMjAwMDAwAmMx| c1\n"
1485         ));
1486         execute("select _id, path from tbl where ts = ? and path = ?", new Object[] { "2017-06-21", "c1" });
1487         assertThat(printedTable(response.rows()), is(
1488             "Ag0xNDk4MDAzMjAwMDAwAmMx| c1\n"
1489         ));
1490     }
1491     @Test
1492     public void test_primary_key_lookups_returns_inserted_records() throws Exception {
1493         int numKeys = randomIntBetween(1, 3);
1494         Random random = RandomizedContext.current().getRandom();
1495         StringBuilder createTable = new StringBuilder("CREATE TABLE tbl (");
1496         ArrayList&lt;DataType&lt;?&gt;&gt; types = new ArrayList&lt;&gt;();
1497         List&lt;DataType&lt;?&gt;&gt; typeCandidates = DataTypes.PRIMITIVE_TYPES.stream()
1498             .filter(x -&gt; x.storageSupport() != null)
1499             .collect(Collectors.toList());
1500         for (int i = 0; i &lt; numKeys; i++) {
1501             var type = RandomPicks.randomFrom(random, typeCandidates);
1502             types.add(type);
1503             createTable.append("col");
1504             createTable.append(i);
1505             createTable.append(' ');
1506             createTable.append(type.getName());
1507             createTable.append(" PRIMARY KEY");
1508             if (i + 1 &lt; numKeys) {
1509                 createTable.append(", ");
1510             }
1511         }
1512         createTable.append(")");
1513         execute(createTable.toString());
1514         String insert = "INSERT INTO tbl VALUES ("
1515             + String.join(", ", Lists2.map(types, ignored -&gt; "?"))
1516             + ")";
1517         Object[] args = new Object[types.size()];
1518         for (int i = 0; i &lt; types.size(); i++) {
1519             var type = types.get(i);
1520             args[i] = DataTypeTesting.getDataGenerator(type).get();
1521         }
1522         execute(insert, args);
1523         StringBuilder selectInlineValues = new StringBuilder("SELECT 1 FROM tbl WHERE ");
1524         StringBuilder selectParams = new StringBuilder("SELECT 1 FROM tbl WHERE ");
1525         for (int i = 0; i &lt; args.length; i++) {
1526             var arg = args[i];
1527             selectInlineValues.append("col");
1528             selectParams.append("col");
1529             selectInlineValues.append(i);
1530             selectParams.append(i);
1531             selectInlineValues.append(" = ");
1532             if (arg instanceof String) {
1533                 selectInlineValues.append("'");
1534                 selectInlineValues.append(arg);
1535                 selectInlineValues.append("'");
1536             } else {
1537                 selectInlineValues.append(arg);
1538             }
1539             selectParams.append(" = ?");
1540             if (i + 1 &lt; args.length) {
1541                 selectInlineValues.append(" AND ");
1542                 selectParams.append(" AND ");
1543             }
1544         }
1545         execute(selectParams.toString(), args);
1546         assertThat(
1547             selectParams.toString() + " with values " + Arrays.toString(args) + " must return a record",
1548             response.rowCount(),
1549             is(1L)
1550         );
1551         execute(selectInlineValues.toString());
1552         assertThat(
1553             selectInlineValues.toString() + " must return a record",
1554             response.rowCount(),
1555             is(1L)
1556         );
1557     }
1558     @Test
1559     public void test_query_then_fetch_result_order_of_all_columns_matches() throws Exception {
1560         int numItems = 40;
1561         Object[][] args = new Object[numItems][];
1562         for (int i = 0; i &lt; numItems; i++) {
1563             args[i] = new Object[] { Integer.toString(i), i };
1564         }
1565         execute("create table tbl (x text, y int) clustered into 2 shards");
1566         execute("insert into tbl (x, y) values (?, ?)", args);
1567         execute("refresh table tbl");
1568         Object[][] rows = execute("select x, y from tbl order by y desc").rows();
1569         assertThat(
1570             rows[0],
1571             Matchers.arrayContaining(Integer.toString(numItems - 1), numItems - 1)
1572         );
1573         assertThat(
1574             rows[1],
1575             Matchers.arrayContaining(Integer.toString(numItems - 2), numItems - 2)
1576         );
1577     }
1578     @Test
1579     @UseJdbc(0)
1580     @UseRandomizedSchema(random = false)
1581     public void test_bit_string_can_be_inserted_and_queried() throws Exception {
1582         execute("create table tbl (xs bit(4))");
1583         execute("insert into tbl (xs) values (B'0000'), (B'0001'), (B'0011'), (B'0111'), (B'1111'), (B'1001')");
1584         assertThat(response.rowCount(), is(6L));
1585         execute("refresh table tbl");
1586         execute("SELECT _doc['xs'], xs, _raw, xs::bit(3) FROM tbl WHERE xs = B'1001'");
1587         assertThat(TestingHelpers.printedTable(response.rows()), is(
1588             "B'1001'| B'1001'| {\"xs\":\"CQ==\"}| B'100'\n"
1589         ));
1590         execute("SELECT _doc['xs'], xs, _raw, xs::bit(3) FROM tbl WHERE xs = B'1001' LIMIT 1");
1591         assertThat(TestingHelpers.printedTable(response.rows()), is(
1592             "B'1001'| B'1001'| {\"xs\":\"CQ==\"}| B'100'\n"
1593         ));
1594         var properties = new Properties();
1595         properties.put("user", "crate");
1596         properties.put("password", "");
1597         ArrayList&lt;String&gt; results = new ArrayList&lt;&gt;();
1598         try (var conn = DriverManager.getConnection(sqlExecutor.jdbcUrl(), properties)) {
1599             Statement stmt = conn.createStatement();
1600             ResultSet result = stmt.executeQuery("select xs from tbl order by xs");
1601             while (result.next()) {
1602                 String string = result.getString(1);
1603                 results.add(string);
1604             }
1605         }
1606         assertThat(results, Matchers.contains(
1607             "B'0000'",
1608             "B'0001'",
1609             "B'0011'",
1610             "B'0111'",
1611             "B'1001'",
1612             "B'1111'"
1613         ));
1614     }
1615     @Test
1616     public void test_can_insert_and_select_bit_string_arrays() throws Exception {
1617         execute("create table tbl (xs array(bit(3)))");
1618         execute("insert into tbl (xs) values ([B'010', B'110'])");
1619         execute("refresh table tbl");
1620         execute("select xs from tbl");
1621         assertThat(TestingHelpers.printedTable(response.rows()), is(
1622             "[B'010', B'110']\n"
1623         ));
1624     }
1625     @Test
1626     public void test_can_select_and_order_by_doc_expression() throws Exception {
1627         execute("create table tbl (x int)");
1628         execute("insert into tbl (x) values (1), (2), (3)");
1629         execute("refresh table tbl");
1630         execute("select _doc['x'] from tbl order by 1");
1631         assertThat(printedTable(response.rows()), is(
1632             "1\n" +
1633             "2\n" +
1634             "3\n"
1635         ));
1636     }
1637     @Test
1638     public void test_can_use_object_with_inner_column_containing_spaces_and_quotes() {
1639         execute("CREATE TABLE t1 (o object as (\"my first \"\" field\" text))");
1640         execute("INSERT INTO t1 (o) VALUES ({\"my first \"\" field\" = 'foo'})");
1641         refresh();
1642         execute("SELECT o FROM t1");
1643         assertThat(printedTable(response.rows()), Matchers.is("{my first \" field=foo}\n"));
1644         execute("SELECT o['my first \" field'] FROM t1");
1645         assertThat(printedTable(response.rows()), Matchers.is("foo\n"));
1646     }
1647     @Test
1648     public void test_subcolumn_can_contain_brackets_in_inserts() {
1649         execute("create table doc.obj (obj OBJECT);");
1650         execute("insert into doc.obj (obj) VALUES ('{\"(\": 1.0}');");
1651         execute("insert into doc.obj (obj) VALUES ('{\"(\": 1.0}');");
1652         refresh();
1653         execute("SELECT count(*) FROM doc.obj");
1654         assertThat(printedTable(response.rows()), Matchers.is("2\n"));
1655         execute("SELECT obj FROM doc.obj limit 1");
1656         assertThat(printedTable(response.rows()), Matchers.is("{(=1.0}\n"));
1657     }
1658     @Test
1659     public void test_double_quotes_in_column_names_and_insert_values() {
1660         execute("create table doc.test (\"\"\"\" text);");
1661         execute("insert into doc.test VALUES ('\"\"')");
1662         refresh();
1663         execute("SELECT \"\"\"\" FROM doc.test");
1664         assertThat(printedTable(response.rows()), Matchers.is("\"\"\n"));
1665     }
1666 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
