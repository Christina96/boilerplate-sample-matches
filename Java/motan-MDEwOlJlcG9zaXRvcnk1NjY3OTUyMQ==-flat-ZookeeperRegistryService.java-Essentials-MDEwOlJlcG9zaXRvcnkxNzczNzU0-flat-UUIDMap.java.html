
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 7.017543859649122%, Tokens: 12</h2>
        <div class="column">
            <h3>motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-ZookeeperRegistryService.java</h3>
            <pre><code><span onclick='openModal()' class='match'>1  package com.weibo.service.impl;
2  import com.alibaba.fastjson.JSONObject;
3  import com.weibo.api.motan.common.MotanConstants;
4  import com.weibo.service.RegistryService;
5  import com.weibo.utils.ZkClientWrapper;
6  import org.I0Itec.zkclient.ZkClient;
7  import org.springframework.beans.factory.annotation.Autowired;
8  import org.springframework.context.annotation.Lazy;
9  import org.springframework.stereotype.Service;
10  import javax.annotation.PostConstruct;
11  import java.util.ArrayList;
12  import java.util.List;
</span>13  @Service
14  @Lazy
15  public class ZookeeperRegistryService implements RegistryService {
16      @Autowired
17      private ZkClientWrapper clientWrapper;
18      private ZkClient zkClient;
19      public ZookeeperRegistryService() {
20      }
21      public ZookeeperRegistryService(ZkClient zkClient) {
22          this.zkClient = zkClient;
23      }
24      @PostConstruct
25      void init() {
26          zkClient = clientWrapper.getZkClient();
27      }
28      @Override
29      public List<String> getGroups() {
30          return getChildren(MotanConstants.ZOOKEEPER_REGISTRY_NAMESPACE);
31      }
32      @Override
33      public List<String> getServicesByGroup(String group) {
34          List<String> services = getChildren(toGroupPath(group));
35          services.remove("command");
36          return services;
37      }
38      @Override
39      public List<JSONObject> getNodes(String group, String service, String nodeType) {
40          List<JSONObject> result = new ArrayList<JSONObject>();
41          List<String> nodes = getChildren(toNodeTypePath(group, service, nodeType));
42          for (String nodeName : nodes) {
43              JSONObject node = new JSONObject();
44              String info = zkClient.readData(toNodePath(group, service, nodeType, nodeName), true);
45              node.put("host", nodeName);
46              node.put("info", info);
47              result.add(node);
48          }
49          return result;
50      }
51      @Override
52      public List<JSONObject> getAllNodes(String group) {
53          List<JSONObject> results = new ArrayList<JSONObject>();
54          List<String> services = getServicesByGroup(group);
55          for (String serviceName : services) {
56              JSONObject service = new JSONObject();
57              service.put("service", serviceName);
58              List<JSONObject> availableServer = getNodes(group, serviceName, "server");
59              service.put("server", availableServer);
60              List<JSONObject> unavailableServer = getNodes(group, serviceName, "unavailableServer");
61              service.put("unavailableServer", unavailableServer);
62              List<JSONObject> clientNode = getNodes(group, serviceName, "client");
63              service.put("client", clientNode);
64              results.add(service);
65          }
66          return results;
67      }
68      private String toGroupPath(String group) {
69          return MotanConstants.ZOOKEEPER_REGISTRY_NAMESPACE + MotanConstants.PATH_SEPARATOR + group;
70      }
71      private String toServicePath(String group, String service) {
72          return toGroupPath(group) + MotanConstants.PATH_SEPARATOR + service;
73      }
74      private String toNodeTypePath(String group, String service, String nodeType) {
75          return toServicePath(group, service) + MotanConstants.PATH_SEPARATOR + nodeType;
76      }
77      private String toNodePath(String group, String service, String nodeType, String node) {
78          return toNodeTypePath(group, service, nodeType) + MotanConstants.PATH_SEPARATOR + node;
79      }
80      private List<String> getChildren(String path) {
81          List<String> children = new ArrayList<String>();
82          if (zkClient.exists(path)) {
83              children = zkClient.getChildren(path);
84          }
85          return children;
86      }
87  }
</code></pre>
        </div>
        <div class="column">
            <h3>Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-UUIDMap.java</h3>
            <pre><code><span onclick='openModal()' class='match'>1  package com.earth2me.essentials;
2  import com.google.common.io.Files;
3  import java.io.BufferedReader;
4  import java.io.BufferedWriter;
5  import java.io.File;
6  import java.io.FileReader;
7  import java.io.FileWriter;
8  import java.io.IOException;
9  import java.util.ArrayList;
10  import java.util.Map;
11  import java.util.UUID;
12  import java.util.concurrent.ConcurrentSkipListMap;
</span>13  import java.util.concurrent.ExecutionException;
14  import java.util.concurrent.ExecutorService;
15  import java.util.concurrent.Executors;
16  import java.util.concurrent.Future;
17  import java.util.concurrent.atomic.AtomicInteger;
18  import java.util.logging.Level;
19  import java.util.regex.Pattern;
20  import org.bukkit.Bukkit;
21  public class UUIDMap
22  {
23  	private final transient net.ess3.api.IEssentials ess;
24  	private File userList;
25  	private final transient Pattern splitPattern = Pattern.compile(",");
26  	private static final ExecutorService EXECUTOR_SERVICE = Executors.newSingleThreadExecutor();
27  	private final AtomicInteger pendingDiskWrites = new AtomicInteger(0);
28  	public UUIDMap(final net.ess3.api.IEssentials ess)
29  	{
30  		this.ess = ess;
31  		userList = new File(ess.getDataFolder(), "usermap.csv");
32  	}
33  	public void loadAllUsers(final ConcurrentSkipListMap<String, UUID> names, final ConcurrentSkipListMap<UUID, ArrayList<String>> history)
34  	{
35  		try
36  		{
37  			if (!userList.exists())
38  			{
39  				userList.createNewFile();
40  			}
41  			synchronized (pendingDiskWrites)
42  			{
43  				if (ess.getSettings().isDebug())
44  				{
45  					ess.getLogger().log(Level.INFO, "Reading usermap from disk");
46  				}
47  				names.clear();
48  				history.clear();
49  				final BufferedReader reader = new BufferedReader(new FileReader(userList));
50  				try
51  				{
52  					while (true)
53  					{
54  						final String line = reader.readLine();
55  						if (line == null)
56  						{
57  							break;
58  						}
59  						else
60  						{
61  							final String[] values = splitPattern.split(line);
62  							if (values.length == 2)
63  							{
64  								final String name = values[0];
65  								final UUID uuid = UUID.fromString(values[1]);
66  								names.put(name, uuid);
67  								if (!history.containsKey(uuid))
68  								{
69  									final ArrayList<String> list = new ArrayList<String>();
70  									list.add(name);
71  									history.put(uuid, list);
72  								}
73  								else
74  								{
75  									final ArrayList<String> list = history.get(uuid);
76  									if (!list.contains(name))
77  									{
78  										list.add(name);
79  									}
80  								}
81  							}
82  						}
83  					}
84  				}
85  				finally
86  				{
87  					reader.close();
88  				}
89  			}
90  		}
91  		catch (IOException ex)
92  		{
93  			Bukkit.getLogger().log(Level.SEVERE, ex.getMessage(), ex);
94  		}
95  	}
96  	public void writeUUIDMap()
97  	{
98  		_writeUUIDMap();
99  	}
100  	public void forceWriteUUIDMap()
101  	{
102  		if (ess.getSettings().isDebug())
103  		{
104  			ess.getLogger().log(Level.INFO, "Forcing usermap write to disk");
105  		}
106  		try
107  		{
108  			Future<?> future = _writeUUIDMap();;
109  			if (future != null)
110  			{
111  				future.get();
112  			}
113  		}
114  		catch (InterruptedException ex)
115  		{
116  			ess.getLogger().log(Level.SEVERE, ex.getMessage(), ex);
117  		}
118  		catch (ExecutionException ex)
119  		{
120  			ess.getLogger().log(Level.SEVERE, ex.getMessage(), ex);
121  		}
122  	}
123  	public Future<?> _writeUUIDMap()
124  	{
125  		final ConcurrentSkipListMap<String, UUID> names = ess.getUserMap().getNames();
126  		if (names.size() < 1)
127  		{
128  			return null;
129  		}
130  		pendingDiskWrites.incrementAndGet();
131  		Future<?> future = EXECUTOR_SERVICE.submit(new WriteRunner(ess.getDataFolder(), userList, names, pendingDiskWrites));
132  		return future;
133  	}
134  	private static class WriteRunner implements Runnable
135  	{
136  		private final File location;
137  		private final File endFile;
138  		private final ConcurrentSkipListMap<String, UUID> names;
139  		private final AtomicInteger pendingDiskWrites;
140  		private WriteRunner(final File location, final File endFile, final ConcurrentSkipListMap<String, UUID> names, final AtomicInteger pendingDiskWrites)
141  		{
142  			this.location = location;
143  			this.endFile = endFile;
144  			this.names = names;
145  			this.pendingDiskWrites = pendingDiskWrites;
146  		}
147  		@Override
148  		public void run()
149  		{
150  			synchronized (pendingDiskWrites)
151  			{
152  				if (pendingDiskWrites.get() > 1)
153  				{
154  					pendingDiskWrites.decrementAndGet();
155  					return;
156  				}
157  				File configFile = null;
158  				try
159  				{
160  					configFile = File.createTempFile("usermap", ".tmp.csv", location);
161  					final BufferedWriter bWriter = new BufferedWriter(new FileWriter(configFile));
162  					for (Map.Entry<String, UUID> entry : names.entrySet())
163  					{
164  						bWriter.write(entry.getKey() + "," + entry.getValue().toString());
165  						bWriter.newLine();
166  					}
167  					bWriter.close();
168  					Files.move(configFile, endFile);
169  				}
170  				catch (IOException ex)
171  				{
172  					try
173  					{
174  						if (configFile != null && configFile.exists())
175  						{
176  							Files.move(configFile, new File(endFile.getParentFile(), "usermap.bak.csv"));
177  						}
178  					}
179  					catch (Exception ex2)
180  					{
181  						Bukkit.getLogger().log(Level.SEVERE, ex2.getMessage(), ex2);
182  					}
183  					Bukkit.getLogger().log(Level.WARNING, ex.getMessage(), ex);
184  				}
185  				finally
186  				{
187  					pendingDiskWrites.decrementAndGet();
188  				}
189  			}
190  		}
191  	}
192  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-ZookeeperRegistryService.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-UUIDMap.java</div>
                </div>
                <div class="column column_space"><pre><code>1  package com.weibo.service.impl;
2  import com.alibaba.fastjson.JSONObject;
3  import com.weibo.api.motan.common.MotanConstants;
4  import com.weibo.service.RegistryService;
5  import com.weibo.utils.ZkClientWrapper;
6  import org.I0Itec.zkclient.ZkClient;
7  import org.springframework.beans.factory.annotation.Autowired;
8  import org.springframework.context.annotation.Lazy;
9  import org.springframework.stereotype.Service;
10  import javax.annotation.PostConstruct;
11  import java.util.ArrayList;
12  import java.util.List;
</pre></code></div>
                <div class="column column_space"><pre><code>1  package com.earth2me.essentials;
2  import com.google.common.io.Files;
3  import java.io.BufferedReader;
4  import java.io.BufferedWriter;
5  import java.io.File;
6  import java.io.FileReader;
7  import java.io.FileWriter;
8  import java.io.IOException;
9  import java.util.ArrayList;
10  import java.util.Map;
11  import java.util.UUID;
12  import java.util.concurrent.ConcurrentSkipListMap;
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    