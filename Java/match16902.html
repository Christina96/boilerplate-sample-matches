<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for HttpRequestDecoderTest.java &amp; DefaultHttp2ConnectionEncoderTest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for HttpRequestDecoderTest.java &amp; DefaultHttp2ConnectionEncoderTest.java
      </h3>
<h1 align="center">
        39.3%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>HttpRequestDecoderTest.java (62.264153%)<th>DefaultHttp2ConnectionEncoderTest.java (28.767124%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(354-380)<td><a href="#" name="0">(471-495)</a><td align="center"><font color="#ff0000">36</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(386-414)<td><a href="#" name="1">(555-579)</a><td align="center"><font color="#e20000">32</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(305-321)<td><a href="#" name="2">(442-456)</a><td align="center"><font color="#b80000">26</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(88-101)<td><a href="#" name="3">(362-374)</a><td align="center"><font color="#9b0000">22</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(223-238)<td><a href="#" name="4">(401-412)</a><td align="center"><font color="#940000">21</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(257-268)<td><a href="#" name="5">(620-629)</a><td align="center"><font color="#8d0000">20</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(18-40)<td><a href="#" name="6">(59-82)</a><td align="center"><font color="#8d0000">20</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(326-335)<td><a href="#" name="7">(682-693)</a><td align="center"><font color="#860000">19</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(559-565)<td><a href="#" name="8">(780-787)</a><td align="center"><font color="#7f0000">18</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(169-179)<td><a href="#" name="9">(391-399)</a><td align="center"><font color="#7f0000">18</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(69-82)<td><a href="#" name="10">(228-241)</a><td align="center"><font color="#7f0000">18</font>
<tr onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b041ff"><font color="#b041ff">-</font><td><a href="#" name="11">(541-548)<td><a href="#" name="11">(333-339)</a><td align="center"><font color="#780000">17</font>
<tr onclick='openModal("#571b7e")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#571b7e"><font color="#571b7e">-</font><td><a href="#" name="12">(339-348)<td><a href="#" name="12">(743-753)</a><td align="center"><font color="#780000">17</font>
<tr onclick='openModal("#3b9c9c")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3b9c9c"><font color="#3b9c9c">-</font><td><a href="#" name="13">(119-131)<td><a href="#" name="13">(524-536)</a><td align="center"><font color="#780000">17</font>
<tr onclick='openModal("#842dce")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#842dce"><font color="#842dce">-</font><td><a href="#" name="14">(287-292)<td><a href="#" name="14">(204-208)</a><td align="center"><font color="#710000">16</font>
<tr onclick='openModal("#f52887")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f52887"><font color="#f52887">-</font><td><a href="#" name="15">(190-198)<td><a href="#" name="15">(804-811)</a><td align="center"><font color="#710000">16</font>
<tr onclick='openModal("#2981b2")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#2981b2"><font color="#2981b2">-</font><td><a href="#" name="16">(577-582)<td><a href="#" name="16">(630-635)</a><td align="center"><font color="#6a0000">15</font>
<tr onclick='openModal("#3090c7")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3090c7"><font color="#3090c7">-</font><td><a href="#" name="17">(277-282)<td><a href="#" name="17">(264-270)</a><td align="center"><font color="#630000">14</font>
<tr onclick='openModal("#800517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#800517"><font color="#800517">-</font><td><a href="#" name="18">(420-434)<td><a href="#" name="18">(656-662)</a><td align="center"><font color="#5c0000">13</font>
<tr onclick='openModal("#f62817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f62817"><font color="#f62817">-</font><td><a href="#" name="19">(209-215)<td><a href="#" name="19">(711-716)</a><td align="center"><font color="#550000">12</font>
<tr onclick='openModal("#4e9258")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4e9258"><font color="#4e9258">-</font><td><a href="#" name="20">(153-160)<td><a href="#" name="20">(583-588)</a><td align="center"><font color="#550000">12</font>
<tr onclick='openModal("#947010")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#947010"><font color="#947010">-</font><td><a href="#" name="21">(111-117)<td><a href="#" name="21">(612-619)</a><td align="center"><font color="#550000">12</font>
<tr onclick='openModal("#4cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4cc417"><font color="#4cc417">-</font><td><a href="#" name="22">(293-300)<td><a href="#" name="22">(344-351)</a><td align="center"><font color="#4d0000">11</font>
<tr onclick='openModal("#f660ab")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f660ab"><font color="#f660ab">-</font><td><a href="#" name="23">(162-167)<td><a href="#" name="23">(700-704)</a><td align="center"><font color="#4d0000">11</font>
<tr onclick='openModal("#79764d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#79764d"><font color="#79764d">-</font><td><a href="#" name="24">(248-253)<td><a href="#" name="24">(717-723)</a><td align="center"><font color="#460000">10</font>
<tr onclick='openModal("#5eac10")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#5eac10"><font color="#5eac10">-</font><td><a href="#" name="25">(102-110)<td><a href="#" name="25">(255-261)</a><td align="center"><font color="#460000">10</font>
<tr onclick='openModal("#68818b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#68818b"><font color="#68818b">-</font><td><a href="#" name="26">(510-517)<td><a href="#" name="26">(647-652)</a><td align="center"><font color="#3f0000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>HttpRequestDecoderTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 package io.netty.handler.codec.http;
2 <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import io.netty.buffer.ByteBuf;
3 import io.netty.buffer.Unpooled;
4 import io.netty.channel.embedded.EmbeddedChannel;
5 import io.netty.util.AsciiString;
6 import io.netty.util.CharsetUtil;
7 import org.junit.jupiter.api.Test;
8 import java.util.List;
9 import static io.netty.handler.codec.http.HttpHeaderNames.*;
10 import static io.netty.handler.codec.http.HttpHeadersTestUtils.of;
11 import static org.hamcrest.CoreMatchers.instanceOf;
12 import static org.hamcrest.CoreMatchers.is;
13 import static org.hamcrest.CoreMatchers.nullValue;
14 import static org.hamcrest.MatcherAssert.assertThat;
15 import static org.junit.jupiter.api.Assertions.assertEquals;
16 import static org.junit.jupiter.api.Assertions.assertFalse;
17 import static org.junit.jupiter.api.Assertions.assertNotNull;
18 import static org.junit.jupiter.api.Assertions.assertNull;
19 import static org.junit.jupiter.api.Assertions.assertTrue;
20 public class HttpRequestDecoderTest {
21     private static final byte[] CONTENT_CRLF_DELIMITERS = createContent("\r\n")</b></font>;
22     private static final byte[] CONTENT_LF_DELIMITERS = createContent("\n");
23     private static final byte[] CONTENT_MIXED_DELIMITERS = createContent("\r\n", "\n");
24     private static final int CONTENT_LENGTH = 8;
25     private static byte[] createContent(String... lineDelimiters) {
26         String lineDelimiter;
27         String lineDelimiter2;
28         if (lineDelimiters.length == 2) {
29             lineDelimiter = lineDelimiters[0];
30             lineDelimiter2 = lineDelimiters[1];
31         } else {
32             lineDelimiter = lineDelimiters[0];
33             lineDelimiter2 = lineDelimiters[0];
34         }
35         return ("GET /some/path?foo=bar&amp;wibble=eek HTTP/1.1" + "\r\n" +
36                 "Upgrade: WebSocket" + lineDelimiter2 +
37                 "Connection: Upgrade" + lineDelimiter +
38                 "Host: localhost" + lineDelimiter2 +
39                 "Origin: http://localhost:8080" + lineDelimiter +
40                 "Sec-WebSocket-Key1: 10  28 8V7 8 48     0" + lineDelimiter2 +
41                 "Sec-WebSocket-Key2: 8 Xt754O3Q3QW 0   _60" + lineDelimiter +
42                 "Content-Length: " + CONTENT_LENGTH + lineDelimiter2 +
43                 "\r\n"  +
44                 "12345678").getBytes(CharsetUtil.US_ASCII);
45     }
46 <a name="10"></a>
47     @Test
48     public void testDecodeWholeRequestAtOnceCRLFDelimiters() {
49         <font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>testDecodeWholeRequestAtOnce(CONTENT_CRLF_DELIMITERS);
50     }
51     @Test
52     public void testDecodeWholeRequestAtOnceLFDelimiters() {
53         testDecodeWholeRequestAtOnce(CONTENT_LF_DELIMITERS);
54     }
55     @Test
56     public void testDecodeWholeRequestAtOnceMixedDelimiters() {
57         testDecodeWholeRequestAtOnce(CONTENT_MIXED_DELIMITERS);
58     }
59     private static void testDecodeWholeRequestAtOnce(byte[] content) {</b></font>
60         EmbeddedChannel channel = new EmbeddedChannel(new HttpRequestDecoder());
61         assertTrue(channel.writeInbound(Unpooled.copiedBuffer(content)));
62 <a name="3"></a>        HttpRequest req = channel.readInbound();
63         assertNotNull(req);
64         checkHeaders(req.headers());
65         LastHttpContent c = <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>channel.readInbound();
66         assertEquals(CONTENT_LENGTH, c.content().readableBytes());
67         assertEquals(
68                 Unpooled.wrappedBuffer(content, content.length - CONTENT_LENGTH, CONTENT_LENGTH),
69                 c.content().readSlice(CONTENT_LENGTH));
70         c.release();
71         assertFalse(channel.finish());
72         assertNull(channel.readInbound());
73     }
74 <a name="25"></a>    private static void checkHeaders(HttpHeaders headers) {
75         assertEquals(7, headers.names().size());
76         checkHeader</b></font>(headers, "Upgrade", "WebSocket");
77         <font color="#5eac10"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>checkHeader(headers, "Connection", "Upgrade");
78         checkHeader(headers, "Host", "localhost");
79         checkHeader(headers, "Origin", "http://localhost:8080");
80         checkHeader(headers, "Sec-WebSocket-Key1", "10  28 8V7 8 48     0");
81         checkHeader(headers, "Sec-WebSocket-Key2", "8 Xt754O3Q3QW 0   _60");
82         checkHeader(headers, "Content-Length", String.valueOf(CONTENT_LENGTH));
83 <a name="21"></a>    }
84     private sta</b></font>tic void checkHeader(HttpHeaders headers, String name, String value) {
85         <font color="#947010"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>List&lt;String&gt; header1 = headers.getAll(of(name));
86         assertEquals(1, header1.size());
87         assertEquals(value, header1.get(0));
88     }
89 <a name="13"></a>    @Test
90     public void testDecodeWholeRequestInMultipleStepsCRLFDelimiters() {</b></font>
91         testDecodeWholeRequestInMultipleSteps(CONTENT_CRLF_DELIMITERS);
92     <font color="#3b9c9c"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
93     @Test
94     public void testDecodeWholeRequestInMultipleStepsLFDelimiters() {
95         testDecodeWholeRequestInMultipleSteps(CONTENT_LF_DELIMITERS);
96     }
97     @Test
98     public void testDecodeWholeRequestInMultipleStepsMixedDelimiters() {
99         testDecodeWholeRequestInMultipleSteps(CONTENT_MIXED_DELIMITERS);
100     }
101     private static void testDecodeWholeRequestInMultipleSteps(byte[] content) {</b></font>
102         for (int i = 1; i &lt; content.length; i++) {
103             testDecodeWholeRequestInMultipleSteps(content, i);
104         }
105     }
106     private static void testDecodeWholeRequestInMultipleSteps(byte[] content, int fragmentSize) {
107         EmbeddedChannel channel = new EmbeddedChannel(new HttpRequestDecoder());
108         int headerLength = content.length - CONTENT_LENGTH;
109         for (int a = 0; a &lt; headerLength;) {
110             int amount = fragmentSize;
111             if (a + amount &gt; headerLength) {
112                 amount = headerLength -  a;
113             }
114             channel.writeInbound(Unpooled.copiedBuffer(content, a, amount));
115 <a name="20"></a>            a += amount;
116         }
117         <font color="#4e9258"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>for (int i = CONTENT_LENGTH; i &gt; 0; i --) {
118             channel.writeInbound(Unpooled.copiedBuffer(content, content.length - i, 1));
119         }
120         HttpRequest req = channel.readInbound();
121 <a name="23"></a>        assertNotNull(req);
122         checkHeaders(req.headers</b></font>());
123         for (int i = CONTENT_LENGTH; i &gt; 1; i --) <font color="#f660ab"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
124             HttpContent c = channel.readInbound();
125             assertEquals(1, c.content().readableBytes());
126             assertEquals(content[content.length - i], c.content().readByte());
127 <a name="9"></a>            c.release();
128         }</b></font>
129         <font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>LastHttpContent c = channel.readInbound();
130         assertEquals(1, c.content().readableBytes());
131         assertEquals(content[content.length - 1], c.content().readByte());
132         c.release();
133         assertFalse(channel.finish());
134         assertNull(channel.readInbound());
135     }
136     @Test
137     public void testMultiLineHeader() {</b></font>
138         EmbeddedChannel channel = new EmbeddedChannel(new HttpRequestDecoder());
139         String crlf = "\r\n";
140         String request =  "GET /some/path HTTP/1.1" + crlf +
141                 "Host: localhost" + crlf +
142                 "MyTestHeader: part1" + crlf +
143                 "              newLinePart2" + crlf +
144                 "MyTestHeader2: part21" + crlf +
145 <a name="15"></a>                "\t            newLinePart22"
146                 + crlf + crlf;
147         assertTrue(channel.writeInbound(Unpooled.copiedBuffer(request, CharsetUtil.US_ASCII)));
148         HttpRequest req = <font color="#f52887"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>channel.readInbound();
149         assertEquals("part1 newLinePart2", req.headers().get(of("MyTestHeader")));
150         assertEquals("part21 newLinePart22", req.headers().get(of("MyTestHeader2")));
151         LastHttpContent c = channel.readInbound();
152         c.release();
153         assertFalse(channel.finish());
154         assertNull(channel.readInbound</b></font>());
155     }
156     @Test
157     public void testEmptyHeaderValue() {
158         EmbeddedChannel channel = new EmbeddedChannel(new HttpRequestDecoder());
159         String crlf = "\r\n";
160         String request =  "GET /some/path HTTP/1.1" + crlf +
161 <a name="19"></a>                "Host: localhost" + crlf +
162                 "EmptyHeader:" + crlf + crlf;
163         channel.writeInbound(Unpooled.copiedBuffer(request, CharsetUtil.US_ASCII));
164         HttpRequest req = <font color="#f62817"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>channel.readInbound();
165         assertEquals("", req.headers().get(of("EmptyHeader")));
166     }
167     @Test
168     public void test100Continue() {
169         HttpRequestDecoder decoder = new</b></font> HttpRequestDecoder();
170         EmbeddedChannel channel = new EmbeddedChannel(decoder);
171         String oversized =
172                 "PUT /file HTTP/1.1\r\n" +
173                 "Expect: 100-continue\r\n" +
174 <a name="4"></a>                "Content-Length: 1048576000\r\n\r\n";
175         channel.writeInbound(Unpooled.copiedBuffer(oversized, CharsetUtil.US_ASCII));
176         assertThat(channel.readInbound(), is(<font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>instanceOf(HttpRequest.class)));
177         decoder.reset();
178         String query = "GET /max-file-size HTTP/1.1\r\n\r\n";
179         channel.writeInbound(Unpooled.copiedBuffer(query, CharsetUtil.US_ASCII));
180         assertThat(channel.readInbound(), is(instanceOf(HttpRequest.class)));
181         assertThat(channel.readInbound(), is(instanceOf(LastHttpContent.class)));
182         assertThat(channel.finish(), is(false));
183     }
184     @Test
185     public void test100ContinueWithBadClient() {</b></font>
186         HttpRequestDecoder decoder = new HttpRequestDecoder();
187         EmbeddedChannel channel = new EmbeddedChannel(decoder);
188         String oversized =
189                 "PUT /file HTTP/1.1\r\n" +
190                 "Expect: 100-continue\r\n" +
191                 "Content-Length: 1048576000\r\n\r\n" +
192 <a name="24"></a>                "WAY_TOO_LARGE_DATA_BEGINS";
193         channel.writeInbound(Unpooled.copiedBuffer(oversized, CharsetUtil.US_ASCII));
194         assertThat(<font color="#79764d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>channel.readInbound(), is(instanceOf(HttpRequest.class)));
195         HttpContent prematureData = channel.readInbound();
196         prematureData.release();
197         assertThat(channel.readInbound(), is(nullValue</b></font>()));
198 <a name="5"></a>
199         <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>decoder.reset();
200         String query = "GET /max-file-size HTTP/1.1\r\n\r\n";
201         channel.writeInbound(Unpooled.copiedBuffer(query, CharsetUtil.US_ASCII));
202         assertThat(channel.readInbound(), is(instanceOf(HttpRequest.class)));
203         assertThat(channel.readInbound(), is(instanceOf(LastHttpContent.class)));
204         assertThat(channel.finish(), is(false));
205     }
206     @Test
207     public void testMessagesSplitBetweenMultipleBuffers() {</b></font>
208         EmbeddedChannel channel = new EmbeddedChannel(new HttpRequestDecoder());
209         String crlf = "\r\n";
210         String str1 = "GET /some/path HTTP/1.1" + crlf +
211                 "Host: localhost1" + crlf + crlf +
212                 "GET /some/other/path HTTP/1.0" + crlf +
213 <a name="17"></a>                "Hos";
214         String str2 = "t: localhost2" + crlf +
215                 "content-length: 0" + crlf + crlf;
216         channel.writeInbound(<font color="#3090c7"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Unpooled.copiedBuffer(str1, CharsetUtil.US_ASCII));
217         HttpRequest req = channel.readInbound();
218         assertEquals(HttpVersion.HTTP_1_1, req.protocolVersion());
219         assertEquals("/some/path", req.uri());
220         assertEquals(1, req.headers().size());
221         assertTrue(AsciiString.contentEqualsIgnoreCase("localhost1", req.headers</b></font>().get(HOST)));
222         LastHttpContent cnt = channel.readInbound();
223 <a name="14"></a>        cnt.release();
224         channel.writeInbound(Unpooled.copiedBuffer(str2, CharsetUtil.US_ASCII));
225         <font color="#842dce"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>req = channel.readInbound();
226         assertEquals(HttpVersion.HTTP_1_0, req.protocolVersion());
227         assertEquals("/some/other/path", req.uri());
228 <a name="22"></a>        assertEquals(2, req.headers().size());
229         assertTrue(AsciiString.contentEqualsIgnoreCase("localhost2", req.headers().get(HOST)));
230         assertTrue(AsciiString.contentEqualsIgnoreCase("0", req.headers().get</b></font>(HttpHeaderNames.CONTENT_LENGTH)));
231         cnt = <font color="#4cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>channel.readInbound();
232         cnt.release();
233         assertFalse(channel.finishAndReleaseAll());
234     }
235     @Test
236     public void testTooLargeInitialLine() {
237         EmbeddedChannel channel = new</b></font> EmbeddedChannel(new HttpRequestDecoder(10, 1024, 1024));
238         String requestStr = "GET /some/path HTTP/1.1\r\n" +
239 <a name="2"></a>                "Host: localhost1\r\n\r\n";
240         assertTrue(channel.writeInbound(Unpooled.copiedBuffer(requestStr, CharsetUtil.US_ASCII)));
241         HttpRequest request = <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>channel.readInbound();
242         assertTrue(request.decoderResult().isFailure());
243         assertTrue(request.decoderResult().cause() instanceof TooLongHttpLineException);
244         assertFalse(channel.finish());
245     }
246     @Test
247     public void testTooLargeInitialLineWithWSOnly() {
248         testTooLargeInitialLineWithControlCharsOnly("                    ");
249     }
250     @Test
251     public void testTooLargeInitialLineWithCRLFOnly() {
252         testTooLargeInitialLineWithControlCharsOnly("\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n");
253     }
254     private static void testTooLargeInitialLineWithControlCharsOnly(String controlChars) {</b></font>
255         EmbeddedChannel channel = new EmbeddedChannel(new HttpRequestDecoder(15, 1024, 1024));
256 <a name="7"></a>        String requestStr = controlChars + "GET / HTTP/1.1\r\n" +
257                 "Host: localhost1\r\n\r\n";
258         <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertTrue(channel.writeInbound(Unpooled.copiedBuffer(requestStr, CharsetUtil.US_ASCII)));
259         HttpRequest request = channel.readInbound();
260         assertTrue(request.decoderResult().isFailure());
261         assertTrue(request.decoderResult().cause() instanceof TooLongHttpLineException);
262         assertFalse(channel.finish());
263     }
264     @Test
265     public void testInitialLineWithLeadingControlChars() {
266         EmbeddedChannel channel = new EmbeddedChannel(new HttpRequestDecoder())</b></font>;
267 <a name="12"></a>        String crlf = "\r\n";
268         String request =  crlf + "GET /some/path HTTP/1.1" + crlf +
269                 "Host: localhost" + crlf + crlf;
270         assertTrue(<font color="#571b7e"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>channel.writeInbound(Unpooled.copiedBuffer(request, CharsetUtil.US_ASCII)));
271         HttpRequest req = channel.readInbound();
272         assertEquals(HttpMethod.GET, req.method());
273         assertEquals("/some/path", req.uri());
274         assertEquals(HttpVersion.HTTP_1_1, req.protocolVersion());
275         assertTrue(channel.finishAndReleaseAll());
276     }
277     @Test
278     public void testTooLargeHeaders() {</b></font>
279         EmbeddedChannel channel = new EmbeddedChannel(new HttpRequestDecoder(1024, 10, 1024));
280         String requestStr = "GET /some/path HTTP/1.1\r\n" +
281 <a name="0"></a>                "Host: localhost1\r\n\r\n";
282         assertTrue(channel.writeInbound(Unpooled.copiedBuffer(requestStr, CharsetUtil.US_ASCII)));
283         HttpRequest request = <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>channel.readInbound();
284         assertTrue(request.decoderResult().isFailure());
285         assertTrue(request.decoderResult().cause() instanceof TooLongHttpHeaderException);
286         assertFalse(channel.finish());
287     }
288     @Test
289     public void testHeaderNameStartsWithControlChar1c() {
290         testHeaderNameStartsWithControlChar(0x1c);
291     }
292     @Test
293     public void testHeaderNameStartsWithControlChar1d() {
294         testHeaderNameStartsWithControlChar(0x1d);
295     }
296     @Test
297     public void testHeaderNameStartsWithControlChar1e() {
298         testHeaderNameStartsWithControlChar(0x1e);
299     }
300     @Test
301     public void testHeaderNameStartsWithControlChar1f() {
302         testHeaderNameStartsWithControlChar(0x1f);
303     }
304     @Test</b></font>
305     public void testHeaderNameStartsWithControlChar0c() {
306         testHeaderNameStartsWithControlChar(0x0c);
307 <a name="1"></a>    }
308     private void testHeaderNameStartsWithControlChar(int controlChar) {
309         ByteBuf requestBuffer = <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Unpooled.buffer();
310         requestBuffer.writeCharSequence("GET /some/path HTTP/1.1\r\n" +
311                 "Host: netty.io\r\n", CharsetUtil.US_ASCII);
312         requestBuffer.writeByte(controlChar);
313         requestBuffer.writeCharSequence("Transfer-Encoding: chunked\r\n\r\n", CharsetUtil.US_ASCII);
314         testInvalidHeaders0(requestBuffer);
315     }
316     @Test
317     public void testHeaderNameEndsWithControlChar1c() {
318         testHeaderNameEndsWithControlChar(0x1c);
319     }
320     @Test
321     public void testHeaderNameEndsWithControlChar1d() {
322         testHeaderNameEndsWithControlChar(0x1d);
323     }
324     @Test
325     public void testHeaderNameEndsWithControlChar1e() {
326         testHeaderNameEndsWithControlChar(0x1e);
327     }
328     @Test
329     public void testHeaderNameEndsWithControlChar1f() {
330         testHeaderNameEndsWithControlChar(0x1f);
331     }
332     @Test</b></font>
333     public void testHeaderNameEndsWithControlChar0c() {
334         testHeaderNameEndsWithControlChar(0x0c);
335 <a name="18"></a>    }
336     private void testHeaderNameEndsWithControlChar(int controlChar) {
337         ByteBuf requestBuffer = <font color="#800517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Unpooled.buffer();
338         requestBuffer.writeCharSequence("GET /some/path HTTP/1.1\r\n" +
339                 "Host: netty.io\r\n", CharsetUtil.US_ASCII);
340         requestBuffer.writeCharSequence("Transfer-Encoding", CharsetUtil.US_ASCII);
341         requestBuffer.writeByte(controlChar);
342         requestBuffer.writeCharSequence(": chunked\r\n\r\n", CharsetUtil.US_ASCII);
343         testInvalidHeaders0(requestBuffer);
344     }
345     @Test
346     public void testWhitespace() {
347         String requestStr = "GET /some/path HTTP/1.1\r\n" +
348                 "Transfer-Encoding : chunked\r\n" +
349                 "Host: netty.io\r\n\r\n";
350         testInvalidHeaders0</b></font>(requestStr);
351     }
352     @Test
353     public void testWhitespaceInTransferEncoding01() {
354         String requestStr = "GET /some/path HTTP/1.1\r\n" +
355                 "Transfer-Encoding : chunked\r\n" +
356                 "Content-Length: 1\r\n" +
357                 "Host: netty.io\r\n\r\n" +
358                 "a";
359         testInvalidHeaders0(requestStr);
360     }
361     @Test
362     public void testWhitespaceInTransferEncoding02() {
363         String requestStr = "POST / HTTP/1.1" +
364                 "Transfer-Encoding : chunked\r\n" +
365                 "Host: target.com" +
366                 "Content-Length: 65\r\n\r\n" +
367                 "0\r\n\r\n" +
368                 "GET /maliciousRequest HTTP/1.1\r\n" +
369                 "Host: evilServer.com\r\n" +
370                 "Foo: x";
371         testInvalidHeaders0(requestStr);
372     }
373     @Test
374     public void testHeaderWithNoValueAndMissingColon() {
375         String requestStr = "GET /some/path HTTP/1.1\r\n" +
376                 "Content-Length: 0\r\n" +
377                 "Host:\r\n" +
378                 "netty.io\r\n\r\n";
379         testInvalidHeaders0(requestStr);
380     }
381     @Test
382     public void testMultipleContentLengthHeaders() {
383         String requestStr = "GET /some/path HTTP/1.1\r\n" +
384                 "Content-Length: 1\r\n" +
385                 "Content-Length: 0\r\n\r\n" +
386                 "b";
387         testInvalidHeaders0(requestStr);
388     }
389     @Test
390     public void testMultipleContentLengthHeaders2() {
391         String requestStr = "GET /some/path HTTP/1.1\r\n" +
392                 "Content-Length: 1\r\n" +
393                 "Connection: close\r\n" +
394                 "Content-Length: 0\r\n\r\n" +
395                 "b";
396         testInvalidHeaders0(requestStr);
397     }
398     @Test
399     public void testContentLengthHeaderWithCommaValue() {
400         String requestStr = "GET /some/path HTTP/1.1\r\n" +
401                 "Content-Length: 1,1\r\n\r\n" +
402                 "b";
403         testInvalidHeaders0(requestStr);
404     }
405     @Test
406     public void testMultipleContentLengthHeadersWithFolding() {
407         String requestStr = "POST / HTTP/1.1\r\n" +
408                 "Host: example.com\r\n" +
409                 "Connection: close\r\n" +
410                 "Content-Length: 5\r\n" +
411                 "Content-Length:\r\n" +
412                 "\t6\r\n\r\n" +
413                 "123456";
414         testInvalidHeaders0(requestStr);
415     }
416 <a name="26"></a>
417     @Test
418     public void testContentLengthAndTransferEncodingHeadersWithVerticalTab() {
419         <font color="#68818b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>testContentLengthAndTransferEncodingHeadersWithInvalidSeparator((char) 0x0b, false);
420         testContentLengthAndTransferEncodingHeadersWithInvalidSeparator((char) 0x0b, true);
421     }
422     @Test
423     public void testContentLengthAndTransferEncodingHeadersWithCR() {
424         testContentLengthAndTransferEncodingHeadersWithInvalidSeparator((char) 0x0d, false);
425         testContentLengthAndTransferEncodingHeadersWithInvalidSeparator</b></font>((char) 0x0d, true);
426     }
427     private static void testContentLengthAndTransferEncodingHeadersWithInvalidSeparator(
428             char separator, boolean extraLine) {
429         String requestStr = "POST / HTTP/1.1\r\n" +
430                 "Host: example.com\r\n" +
431                 "Connection: close\r\n" +
432                 "Content-Length: 9\r\n" +
433                 "Transfer-Encoding:" + separator + "chunked\r\n\r\n" +
434                 (extraLine ? "0\r\n\r\n" : "") +
435                 "something\r\n\r\n";
436         testInvalidHeaders0(requestStr);
437     }
438     @Test
439     public void testContentLengthHeaderAndChunked() {
440         String requestStr = "POST / HTTP/1.1\r\n" +
441                 "Host: example.com\r\n" +
442                 "Connection: close\r\n" +
443                 "Content-Length: 5\r\n" +
444 <a name="11"></a>                "Transfer-Encoding: chunked\r\n\r\n" +
445                 "0\r\n\r\n";
446         EmbeddedChannel channel = new EmbeddedChannel(new HttpRequestDecoder());
447         assertTrue(channel.writeInbound(<font color="#b041ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Unpooled.copiedBuffer(requestStr, CharsetUtil.US_ASCII)));
448         HttpRequest request = channel.readInbound();
449         assertFalse(request.decoderResult().isFailure());
450         assertTrue(request.headers().contains("Transfer-Encoding", "chunked", false));
451         assertFalse(request.headers().contains("Content-Length"));
452         LastHttpContent c = channel.readInbound();
453         c.release();
454         assertFalse(channel.finish</b></font>());
455     }
456     @Test
457     public void testHttpMessageDecoderResult() {
458         String requestStr = "PUT /some/path HTTP/1.1\r\n" +
459                 "Content-Length: 11\r\n" +
460                 "Connection: close\r\n\r\n" +
461 <a name="8"></a>                "Lorem ipsum";
462         EmbeddedChannel channel = new EmbeddedChannel(new HttpRequestDecoder());
463         assertTrue(channel.writeInbound(Unpooled.copiedBuffer(requestStr, CharsetUtil.US_ASCII)));
464         HttpRequest request = <font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>channel.readInbound();
465         assertTrue(request.decoderResult().isSuccess());
466         assertThat(request.decoderResult(), instanceOf(HttpMessageDecoderResult.class));
467         HttpMessageDecoderResult decoderResult = (HttpMessageDecoderResult) request.decoderResult();
468         assertThat(decoderResult.initialLineLength(), is(23));
469         assertThat(decoderResult.headerSize(), is(35));
470         assertThat(decoderResult.totalSize(), is</b></font>(58));
471         HttpContent c = channel.readInbound();
472         c.release();
473         assertFalse(channel.finish());
474     }
475     private static void testInvalidHeaders0(String requestStr) {
476         testInvalidHeaders0(Unpooled.copiedBuffer(requestStr, CharsetUtil.US_ASCII));
477     }
478 <a name="16"></a>
479     private static void testInvalidHeaders0(ByteBuf requestBuffer) {
480         EmbeddedChannel channel = new EmbeddedChannel(new HttpRequestDecoder());
481         <font color="#2981b2"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertTrue(channel.writeInbound(requestBuffer));
482         HttpRequest request = channel.readInbound();
483         assertThat(request.decoderResult().cause(), instanceOf(IllegalArgumentException.class));
484         assertTrue(request.decoderResult().isFailure());
485         assertFalse(channel.finish());
486     }</b></font>
487 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>DefaultHttp2ConnectionEncoderTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 package io.netty.handler.codec.http2;
2 import io.netty.buffer.ByteBuf;
3 import io.netty.buffer.PooledByteBufAllocator;
4 import io.netty.buffer.Unpooled;
5 import io.netty.buffer.UnpooledByteBufAllocator;
6 import io.netty.channel.Channel;
7 import io.netty.channel.ChannelConfig;
8 import io.netty.channel.ChannelFuture;
9 import io.netty.channel.ChannelHandlerContext;
10 import io.netty.channel.ChannelMetadata;
11 import io.netty.channel.ChannelPipeline;
12 import io.netty.channel.ChannelPromise;
13 import io.netty.channel.DefaultChannelConfig;
14 import io.netty.channel.DefaultChannelPromise;
15 import io.netty.handler.codec.http.HttpResponseStatus;
16 import io.netty.handler.codec.http2.Http2RemoteFlowController.FlowControlled;
17 import io.netty.util.concurrent.ImmediateEventExecutor;
18 import junit.framework.AssertionFailedError;
19 import org.junit.jupiter.api.BeforeEach;
20 import org.junit.jupiter.api.Test;
21 import org.mockito.ArgumentCaptor;
22 import org.mockito.InOrder;
23 import org.mockito.Mock;
24 import org.mockito.MockitoAnnotations;
25 import org.mockito.invocation.InvocationOnMock;
26 import org.mockito.stubbing.Answer;
27 import java.util.ArrayList;
28 import java.util.List;
29 import static io.netty.buffer.Unpooled.EMPTY_BUFFER;
30 import static io.netty.buffer.Unpooled.wrappedBuffer;
31 import static io.netty.handler.codec.http2.Http2CodecUtil.DEFAULT_PRIORITY_WEIGHT;
32 import static io.netty.handler.codec.http2.Http2Error.PROTOCOL_ERROR;
33 import static io.netty.handler.codec.http2.Http2Stream.State.HALF_CLOSED_REMOTE;
34 import static io.netty.handler.codec.http2.Http2Stream.State.RESERVED_LOCAL;
35 import static io.netty.handler.codec.http2.Http2TestUtil.newVoidPromise;
36 import static io.netty.util.CharsetUtil.UTF_8;
37 import static org.hamcrest.MatcherAssert.assertThat;
38 import static org.hamcrest.CoreMatchers.instanceOf;
39 <a name="6"></a>import static org.junit.jupiter.api.Assertions.assertEquals;
40 import static org.junit.jupiter.api.Assertions.assertFalse;
41 import static org.junit.jupiter.api.Assertions.assertNull;
42 <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import static org.junit.jupiter.api.Assertions.assertSame;
43 import static org.junit.jupiter.api.Assertions.assertTrue;
44 import static org.junit.jupiter.api.Assertions.fail;
45 import static org.mockito.Mockito.any;
46 import static org.mockito.Mockito.anyBoolean;
47 import static org.mockito.Mockito.anyInt;
48 import static org.mockito.Mockito.anyLong;
49 import static org.mockito.Mockito.anyShort;
50 import static org.mockito.Mockito.doAnswer;
51 import static org.mockito.Mockito.doNothing;
52 import static org.mockito.Mockito.eq;
53 import static org.mockito.Mockito.inOrder;
54 import static org.mockito.Mockito.mock;
55 import static org.mockito.Mockito.never;
56 import static org.mockito.Mockito.times;
57 import static org.mockito.Mockito.verify;
58 import static org.mockito.Mockito.verifyNoMoreInteractions;
59 import static org.mockito.Mockito.when;
60 public class DefaultHttp2ConnectionEncoderTest {
61     private static final int STREAM_ID = 2</b></font>;
62     private static final int PUSH_STREAM_ID = 4;
63     @Mock
64     private Http2RemoteFlowController remoteFlow;
65     @Mock
66     private ChannelHandlerContext ctx;
67     @Mock
68     private Channel channel;
69     @Mock
70     private Channel.Unsafe unsafe;
71     @Mock
72     private ChannelPipeline pipeline;
73     @Mock
74     private Http2FrameWriter writer;
75     @Mock
76     private Http2FrameWriter.Configuration writerConfig;
77     @Mock
78     private Http2FrameSizePolicy frameSizePolicy;
79     @Mock
80     private Http2LifecycleManager lifecycleManager;
81     private DefaultHttp2ConnectionEncoder encoder;
82     private Http2Connection connection;
83     private ArgumentCaptor&lt;Http2RemoteFlowController.FlowControlled&gt; payloadCaptor;
84     private List&lt;String&gt; writtenData;
85     private List&lt;Integer&gt; writtenPadding;
86     private boolean streamClosed;
87     @BeforeEach
88     public void setup() throws Exception {
89         MockitoAnnotations.initMocks(this);
90         ChannelMetadata metadata = new ChannelMetadata(false, 16);
91         when(channel.isActive()).thenReturn(true);
92         when(channel.pipeline()).thenReturn(pipeline);
93         when(channel.metadata()).thenReturn(metadata);
94         when(channel.unsafe()).thenReturn(unsafe);
95         ChannelConfig config = new DefaultChannelConfig(channel);
96         when(channel.config()).thenReturn(config);
97         doAnswer(new Answer&lt;ChannelFuture&gt;() {
98             @Override
99             public ChannelFuture answer(InvocationOnMock in) {
100                 return newPromise().setFailure((Throwable) in.getArgument(0));
101             }
102         }).when(channel).newFailedFuture(any(Throwable.class));
103         when(writer.configuration()).thenReturn(writerConfig);
104         when(writerConfig.frameSizePolicy()).thenReturn(frameSizePolicy);
105         when(frameSizePolicy.maxFrameSize()).thenReturn(64);
106         doAnswer(new Answer&lt;ChannelFuture&gt;() {
107             @Override
108             public ChannelFuture answer(InvocationOnMock in) throws Throwable {
109                 return ((ChannelPromise) in.getArguments()[2]).setSuccess();
110             }
111         }).when(writer).writeSettings(eq(ctx), any(Http2Settings.class), any(ChannelPromise.class));
112         doAnswer(new Answer&lt;ChannelFuture&gt;() {
113             @Override
114             public ChannelFuture answer(InvocationOnMock in) throws Throwable {
115                 ((ByteBuf) in.getArguments()[3]).release();
116                 return ((ChannelPromise) in.getArguments()[4]).setSuccess();
117             }
118         }).when(writer).writeGoAway(eq(ctx), anyInt(), anyInt(), any(ByteBuf.class), any(ChannelPromise.class));
119         writtenData = new ArrayList&lt;String&gt;();
120         writtenPadding = new ArrayList&lt;Integer&gt;();
121         when(writer.writeData(eq(ctx), anyInt(), any(ByteBuf.class), anyInt(), anyBoolean(),
122                 any(ChannelPromise.class))).then(new Answer&lt;ChannelFuture&gt;() {
123                     @Override
124                     public ChannelFuture answer(InvocationOnMock in) throws Throwable {
125                         ChannelPromise promise = (ChannelPromise) in.getArguments()[5];
126                         if (streamClosed) {
127                             fail("Stream already closed");
128                         } else {
129                             streamClosed = (Boolean) in.getArguments()[4];
130                         }
131                         writtenPadding.add((Integer) in.getArguments()[3]);
132                         ByteBuf data = (ByteBuf) in.getArguments()[2];
133                         writtenData.add(data.toString(UTF_8));
134                         data.release();
135                         return promise.setSuccess();
136                     }
137                 });
138         when(writer.writeHeaders(eq(ctx), anyInt(), any(Http2Headers.class), anyInt(), anyShort(), anyBoolean(),
139                 anyInt(), anyBoolean(), any(ChannelPromise.class)))
140                 .then(new Answer&lt;ChannelFuture&gt;() {
141                     @Override
142                     public ChannelFuture answer(InvocationOnMock invocationOnMock) {
143                         ChannelPromise promise = invocationOnMock.getArgument(8);
144                         if (streamClosed) {
145                             fail("Stream already closed");
146                         } else {
147                             streamClosed = invocationOnMock.getArgument(5);
148                         }
149                         return promise.setSuccess();
150                     }
151                 });
152         when(writer.writeHeaders(eq(ctx), anyInt(), any(Http2Headers.class),
153                 anyInt(), anyBoolean(), any(ChannelPromise.class)))
154                 .then(new Answer&lt;ChannelFuture&gt;() {
155                     @Override
156                     public ChannelFuture answer(InvocationOnMock invocationOnMock) {
157                         ChannelPromise promise = invocationOnMock.getArgument(5);
158                         if (streamClosed) {
159                             fail("Stream already closed");
160                         } else {
161                             streamClosed = invocationOnMock.getArgument(4);
162                         }
163 <a name="14"></a>                        return promise.setSuccess();
164                     }
165                 });
166         <font color="#842dce"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>payloadCaptor = ArgumentCaptor.forClass(Http2RemoteFlowController.FlowControlled.class);
167         doNothing().when(remoteFlow).addFlowControlled(any(Http2Stream.class), payloadCaptor.capture());
168         when(ctx.alloc()).thenReturn(UnpooledByteBufAllocator.DEFAULT);
169         when(ctx.channel()).thenReturn(channel);
170         doAnswer</b></font>(new Answer&lt;ChannelPromise&gt;() {
171             @Override
172             public ChannelPromise answer(InvocationOnMock in) throws Throwable {
173                 return newPromise();
174             }
175         }).when(ctx).newPromise();
176         doAnswer(new Answer&lt;ChannelFuture&gt;() {
177             @Override
178             public ChannelFuture answer(InvocationOnMock in) throws Throwable {
179                 return newSucceededFuture();
180             }
181         }).when(ctx).newSucceededFuture();
182         when(ctx.flush()).thenThrow(new AssertionFailedError("forbidden"));
183         when(channel.alloc()).thenReturn(PooledByteBufAllocator.DEFAULT);
184         connection = new DefaultHttp2Connection(true);
185 <a name="10"></a>        connection.remote().flowController(remoteFlow);
186         encoder = new DefaultHttp2ConnectionEncoder(connection, writer);
187         <font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>encoder.lifecycleManager(lifecycleManager);
188     }
189     @Test
190     public void dataWithEndOfStreamWriteShouldSignalThatFrameWasConsumedOnError() throws Exception {
191         dataWriteShouldSignalThatFrameWasConsumedOnError0(true);
192     }
193     @Test
194     public void dataWriteShouldSignalThatFrameWasConsumedOnError() throws Exception {
195         dataWriteShouldSignalThatFrameWasConsumedOnError0(false);
196     }
197     private void dataWriteShouldSignalThatFrameWasConsumedOnError0(boolean endOfStream) throws Exception {</b></font>
198         createStream(STREAM_ID, false);
199         final ByteBuf data = dummyData();
200         ChannelPromise p = newPromise();
201         encoder.writeData(ctx, STREAM_ID, data, 0, endOfStream, p);
202         FlowControlled controlled = payloadCaptor.getValue();
203         assertEquals(8, controlled.size());
204         payloadCaptor.getValue().write(ctx, 4);
205         assertEquals(4, controlled.size());
206 <a name="25"></a>        Throwable error = new IllegalStateException();
207         payloadCaptor.getValue().error(ctx, error);
208         payloadCaptor.getValue().write(ctx, 8);
209         assertEquals(0, <font color="#5eac10"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>controlled.size());
210         assertEquals("abcd", writtenData.get(0));
211         assertEquals(0, data.refCnt());
212         assertSame(error, p.cause());
213     }
214 <a name="17"></a>    @Test</b></font>
215     public void dataWriteShouldSucceed() throws Exception {
216         createStream(STREAM_ID, false);
217         final ByteBuf data = <font color="#3090c7"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>dummyData();
218         ChannelPromise p = newPromise();
219         encoder.writeData(ctx, STREAM_ID, data, 0, true, p);
220         assertEquals(8, payloadCaptor.getValue().size());
221         payloadCaptor.getValue().write(ctx, 8);
222         assertEquals(0, payloadCaptor.getValue().size());
223         assertEquals("abcdefgh", writtenData.get</b></font>(0));
224         assertEquals(0, data.refCnt());
225         assertTrue(p.isSuccess());
226     }
227     @Test
228     public void dataFramesShouldMerge() throws Exception {
229         createStream(STREAM_ID, false);
230         final ByteBuf data = dummyData().retain();
231         ChannelPromise promise1 = newPromise();
232         encoder.writeData(ctx, STREAM_ID, data, 0, true, promise1);
233         ChannelPromise promise2 = newPromise();
234         encoder.writeData(ctx, STREAM_ID, data, 0, true, promise2);
235         List&lt;FlowControlled&gt; capturedWrites = payloadCaptor.getAllValues();
236         FlowControlled mergedPayload = capturedWrites.get(0);
237         mergedPayload.merge(ctx, capturedWrites.get(1));
238         assertEquals(16, mergedPayload.size());
239         assertFalse(promise1.isDone());
240         assertFalse(promise2.isDone());
241         mergedPayload.write(ctx, 16);
242         assertEquals(0, mergedPayload.size());
243         assertEquals("abcdefghabcdefgh", writtenData.get(0));
244         assertEquals(0, data.refCnt());
245         assertTrue(promise1.isSuccess());
246         assertTrue(promise2.isSuccess());
247     }
248     @Test
249     public void dataFramesShouldMergeUseVoidPromise() throws Exception {
250         createStream(STREAM_ID, false);
251         final ByteBuf data = dummyData().retain();
252         ChannelPromise promise1 = newVoidPromise(channel);
253         encoder.writeData(ctx, STREAM_ID, data, 0, true, promise1);
254         ChannelPromise promise2 = newVoidPromise(channel);
255         encoder.writeData(ctx, STREAM_ID, data, 0, true, promise2);
256         List&lt;FlowControlled&gt; capturedWrites = payloadCaptor.getAllValues();
257         FlowControlled mergedPayload = capturedWrites.get(0);
258         mergedPayload.merge(ctx, capturedWrites.get(1));
259         assertEquals(16, mergedPayload.size());
260         assertFalse(promise1.isSuccess());
261         assertFalse(promise2.isSuccess());
262         mergedPayload.write(ctx, 16);
263         assertEquals(0, mergedPayload.size());
264         assertEquals("abcdefghabcdefgh", writtenData.get(0));
265         assertEquals(0, data.refCnt());
266         assertFalse(promise1.isSuccess());
267         assertFalse(promise2.isSuccess());
268     }
269 <a name="11"></a>
270     @Test
271     public void dataFramesDontMergeWithHeaders() throws Exception {
272         <font color="#b041ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>createStream(STREAM_ID, false);
273         final ByteBuf data = dummyData().retain();
274         encoder.writeData(ctx, STREAM_ID, data, 0, false, newPromise());
275         when(remoteFlow.hasFlowControlled(any(Http2Stream.class))).thenReturn(true);
276         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, newPromise());
277         List&lt;FlowControlled&gt; capturedWrites = payloadCaptor.getAllValues();
278         assertFalse(capturedWrites.get</b></font>(0).merge(ctx, capturedWrites.get(1)));
279     }
280 <a name="22"></a>
281     @Test
282     public void emptyFrameShouldSplitPadding() throws Exception {
283         ByteBuf data = <font color="#4cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>Unpooled.buffer(0);
284         assertSplitPaddingOnEmptyBuffer(data);
285         assertEquals(0, data.refCnt());
286     }
287     @Test
288     public void writeHeadersUsingVoidPromise() throws Exception {
289         final Throwable cause = new</b></font> RuntimeException("fake exception");
290         when(writer.writeHeaders(eq(ctx), eq(STREAM_ID), any(Http2Headers.class),
291                                  anyInt(), anyBoolean(), any(ChannelPromise.class)))
292                 .then(new Answer&lt;ChannelFuture&gt;() {
293                     @Override
294                     public ChannelFuture answer(InvocationOnMock invocationOnMock) throws Throwable {
295                         ChannelPromise promise = invocationOnMock.getArgument(5);
296                         assertFalse(promise.isVoid());
297 <a name="3"></a>                        return promise.setFailure(cause);
298                     }
299                 });
300         <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>createStream(STREAM_ID, false);
301         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, newVoidPromise(channel));
302         verify(writer).writeHeaders(eq(ctx), eq(STREAM_ID), any(Http2Headers.class),
303                                     anyInt(), anyBoolean(), any(ChannelPromise.class));
304         verify(pipeline).fireExceptionCaught(cause);
305     }
306     private void assertSplitPaddingOnEmptyBuffer(ByteBuf data) throws Exception {
307         createStream(STREAM_ID, false);
308         when(frameSizePolicy.maxFrameSize</b></font>()).thenReturn(5);
309         ChannelPromise p = newPromise();
310         encoder.writeData(ctx, STREAM_ID, data, 10, true, p);
311         assertEquals(10, payloadCaptor.getValue().size());
312         payloadCaptor.getValue().write(ctx, 10);
313         assertEquals(1, writtenData.size());
314         assertEquals("", writtenData.get(0));
315         assertEquals(10, (int) writtenPadding.get(0));
316         assertEquals(0, data.refCnt());
317         assertTrue(p.isSuccess());
318     }
319     @Test
320 <a name="9"></a>    public void headersWriteForUnknownStreamShouldCreateStream() throws Exception {
321         writeAllFlowControlledFrames();
322         final int streamId = 6;
323         <font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>ChannelPromise promise = newPromise();
324         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
325         verify(writer).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE), eq(0),
326                 eq(false), eq(promise));
327         assertTrue(promise.isSuccess());
328     }
329 <a name="4"></a>    @Test
330     public void headersWriteShouldOpenStreamForPush() throws Exception {</b></font>
331         writeAllFlowControlledFrames();
332         Http2Stream parent = <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>createStream(STREAM_ID, false);
333         reservePushStream(PUSH_STREAM_ID, parent);
334         ChannelPromise promise = newPromise();
335         encoder.writeHeaders(ctx, PUSH_STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, false, promise);
336         assertEquals(HALF_CLOSED_REMOTE, stream(PUSH_STREAM_ID).state());
337         verify(writer).writeHeaders(eq(ctx), eq(PUSH_STREAM_ID), eq(EmptyHttp2Headers.INSTANCE),
338                 eq(0), eq(false), eq(promise));
339     }
340     @Test
341     public void trailersDoNotEndStreamThrows() {</b></font>
342         writeAllFlowControlledFrames();
343         final int streamId = 6;
344         ChannelPromise promise = newPromise();
345         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
346         ChannelPromise promise2 = newPromise();
347         ChannelFuture future = encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise2);
348         assertTrue(future.isDone());
349         assertFalse(future.isSuccess());
350         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
351                 eq(0), eq(false), eq(promise));
352     }
353     @Test
354     public void trailersDoNotEndStreamWithDataThrows() {
355         writeAllFlowControlledFrames();
356         final int streamId = 6;
357         ChannelPromise promise = newPromise();
358         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
359         Http2Stream stream = connection.stream(streamId);
360         when(remoteFlow.hasFlowControlled(eq(stream))).thenReturn(true);
361         ChannelPromise promise2 = newPromise();
362         ChannelFuture future = encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise2);
363 <a name="2"></a>        assertTrue(future.isDone());
364         assertFalse(future.isSuccess());
365         <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
366                 eq(0), eq(false), eq(promise));
367     }
368     @Test
369     public void tooManyHeadersNoEOSThrows() {
370         tooManyHeadersThrows(false);
371     }
372     @Test
373     public void tooManyHeadersEOSThrows() {
374         tooManyHeadersThrows(true);
375     }
376     private void tooManyHeadersThrows(boolean eos) {</b></font>
377         writeAllFlowControlledFrames();
378         final int streamId = 6;
379         ChannelPromise promise = newPromise();
380         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
381         ChannelPromise promise2 = newPromise();
382         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, true, promise2);
383         ChannelPromise promise3 = newPromise();
384         ChannelFuture future = encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, eos, promise3);
385         assertTrue(future.isDone());
386         assertFalse(future.isSuccess());
387 <a name="0"></a>
388         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
389                 eq(0), eq(false), eq(promise));
390         <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
391                 eq(0), eq(true), eq(promise2));
392     }
393     @Test
394     public void infoHeadersAndTrailersAllowed() throws Exception {
395         infoHeadersAndTrailers(true, 1);
396     }
397     @Test
398     public void multipleInfoHeadersAndTrailersAllowed() throws Exception {
399         infoHeadersAndTrailers(true, 10);
400     }
401     @Test
402     public void infoHeadersAndTrailersNoEOSThrows() throws Exception {
403         infoHeadersAndTrailers(false, 1);
404     }
405     @Test
406     public void multipleInfoHeadersAndTrailersNoEOSThrows() throws Exception {
407         infoHeadersAndTrailers(false, 10);
408     }
409     private void infoHeade</b></font>rsAndTrailers(boolean eos, int infoHeaderCount) {
410         writeAllFlowControlledFrames();
411         final int streamId = 6;
412         Http2Headers infoHeaders = informationalHeaders();
413         for (int i = 0; i &lt; infoHeaderCount; ++i) {
414             encoder.writeHeaders(ctx, streamId, infoHeaders, 0, false, newPromise());
415         }
416         ChannelPromise promise2 = newPromise();
417         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise2);
418         ChannelPromise promise3 = newPromise();
419         ChannelFuture future = encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, eos, promise3);
420         assertTrue(future.isDone());
421         assertEquals(eos, future.isSuccess());
422         verify(writer, times(infoHeaderCount)).writeHeaders(eq(ctx), eq(streamId), eq(infoHeaders),
423                 eq(0), eq(false), any(ChannelPromise.class));
424         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
425                 eq(0), eq(false), eq(promise2));
426         if (eos) {
427             verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
428                     eq(0), eq(true), eq(promise3));
429         }
430     }
431     private static Http2Headers informationalHeaders() {
432 <a name="13"></a>        Http2Headers headers = new DefaultHttp2Headers();
433         headers.status(HttpResponseStatus.CONTINUE.codeAsText());
434         return headers;
435     <font color="#3b9c9c"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}
436     @Test
437     public void tooManyHeadersWithDataNoEOSThrows() {
438         tooManyHeadersWithDataThrows(false);
439     }
440     @Test
441     public void tooManyHeadersWithDataEOSThrows() {
442         tooManyHeadersWithDataThrows(true);
443     }
444     private void tooManyHeadersWithDataThrows(boolean eos) {</b></font>
445         writeAllFlowControlledFrames();
446         final int streamId = 6;
447         ChannelPromise promise = newPromise();
448         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
449         Http2Stream stream = connection.stream(streamId);
450         when(remoteFlow.hasFlowControlled(eq(stream))).thenReturn(true);
451         ChannelPromise promise2 = newPromise();
452         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, true, promise2);
453         ChannelPromise promise3 = newPromise();
454         ChannelFuture future = encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, eos, promise3);
455         assertTrue(future.isDone());
456         assertFalse(future.isSuccess());
457 <a name="1"></a>
458         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
459                 eq(0), eq(false), eq(promise));
460         verify(writer, times(1)).writeHeaders(eq(ctx), <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
461                 eq(0), eq(true), eq(promise2));
462     }
463     @Test
464     public void infoHeadersAndTrailersWithDataAllowed() {
465         infoHeadersAndTrailersWithData(true, 1);
466     }
467     @Test
468     public void multipleInfoHeadersAndTrailersWithDataAllowed() {
469         infoHeadersAndTrailersWithData(true, 10);
470     }
471     @Test
472     public void infoHeadersAndTrailersWithDataNoEOSThrows() {
473         infoHeadersAndTrailersWithData(false, 1);
474     }
475     @Test
476     public void multipleInfoHeadersAndTrailersWithDataNoEOSThrows() {
477         infoHeadersAndTrailersWithData(false, 10);
478     }
479     private void infoHeadersAndTra</b></font>ilersWithData(boolean eos, int infoHeaderCount) {
480 <a name="20"></a>        writeAllFlowControlledFrames();
481         final int streamId = 6;
482         Http2Headers infoHeaders = informationalHeaders();
483         <font color="#4e9258"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>for (int i = 0; i &lt; infoHeaderCount; ++i) {
484             encoder.writeHeaders(ctx, streamId, infoHeaders, 0, false, newPromise());
485         }
486         Http2Stream stream = connection.stream(streamId);
487         when(remoteFlow.hasFlowControlled</b></font>(eq(stream))).thenReturn(true);
488         ChannelPromise promise2 = newPromise();
489         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise2);
490         ChannelPromise promise3 = newPromise();
491         ChannelFuture future = encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, eos, promise3);
492         assertTrue(future.isDone());
493         assertEquals(eos, future.isSuccess());
494         verify(writer, times(infoHeaderCount)).writeHeaders(eq(ctx), eq(streamId), eq(infoHeaders),
495                 eq(0), eq(false), any(ChannelPromise.class));
496         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
497                 eq(0), eq(false), eq(promise2));
498         if (eos) {
499             verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
500                     eq(0), eq(true), eq(promise3));
501         }
502     }
503     @Test
504 <a name="21"></a>    public void pushPromiseWriteAfterGoAwayReceivedShouldFail() throws Exception {
505         createStream(STREAM_ID, false);
506         goAwayReceived(0);
507         <font color="#947010"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>ChannelFuture future = encoder.writePushPromise(ctx, STREAM_ID, PUSH_STREAM_ID, EmptyHttp2Headers.INSTANCE, 0,
508                 newPromise());
509         assertTrue(future.isDone());
510         assertFalse(future.isSuccess());
511     }
512 <a name="5"></a>
513     @Test
514     public void pushPromiseWriteShouldReserveStream() throws Exception {</b></font>
515         <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>createStream(STREAM_ID, false);
516         ChannelPromise promise = newPromise();
517         encoder.writePushPromise(ctx, STREAM_ID, PUSH_STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, promise);
518         assertEquals(RESERVED_LOCAL, stream(PUSH_STREAM_ID).state());
519         verify(writer).writePushPromise(eq(ctx), eq(STREAM_ID), eq(PUSH_STREAM_ID),
520                 eq(EmptyHttp2Headers.INSTANCE), eq(0), eq(promise));
521     }
522 <a name="16"></a>
523     @Test
524     public void priorityWriteAfterGoAwayShouldSucceed() throws Exception {</b></font>
525         <font color="#2981b2"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>createStream(STREAM_ID, false);
526         goAwayReceived(Integer.MAX_VALUE);
527         ChannelPromise promise = newPromise();
528         encoder.writePriority(ctx, STREAM_ID, 0, (short) 255, true, promise);
529         verify(writer).writePriority(eq(ctx), eq(STREAM_ID), eq(0), eq((short) 255), eq(true), eq(promise));
530     }</b></font>
531     @Test
532     public void priorityWriteShouldSetPriorityForStream() throws Exception {
533         ChannelPromise promise = newPromise();
534         short weight = 255;
535         encoder.writePriority(ctx, STREAM_ID, 0, weight, true, promise);
536 <a name="26"></a>        Http2Stream stream = stream(STREAM_ID);
537         assertNull(stream);
538         verify(writer).writePriority(eq(ctx), eq(STREAM_ID), eq(0), eq((short) 255), <font color="#68818b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>eq(true), eq(promise));
539     }
540     @Test
541     public void priorityWriteOnPreviouslyExistingStreamShouldSucceed() throws Exception {
542         createStream</b></font>(STREAM_ID, false).close();
543 <a name="18"></a>        ChannelPromise promise = newPromise();
544         short weight = 255;
545         encoder.writePriority(ctx, STREAM_ID, 0, weight, true, promise);
546         verify(writer).writePriority(<font color="#800517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>eq(ctx), eq(STREAM_ID), eq(0), eq(weight), eq(true), eq(promise));
547     }
548     @Test
549     public void priorityWriteOnPreviouslyExistingParentStreamShouldSucceed() throws Exception {
550         final int parentStreamId = STREAM_ID + 2;
551         createStream</b></font>(STREAM_ID, false);
552         createStream(parentStreamId, false).close();
553         ChannelPromise promise = newPromise();
554         short weight = 255;
555         encoder.writePriority(ctx, STREAM_ID, parentStreamId, weight, true, promise);
556         verify(writer).writePriority(eq(ctx), eq(STREAM_ID), eq(parentStreamId), eq(weight), eq(true), eq(promise));
557     }
558     @Test
559     public void rstStreamWriteForUnknownStreamShouldIgnore() throws Exception {
560         ChannelPromise promise = newPromise();
561         encoder.writeRstStream(ctx, 5, PROTOCOL_ERROR.code(), promise);
562         verify(writer, never()).writeRstStream(eq(ctx), anyInt(), anyLong(), eq(promise));
563     }
564     @Test
565 <a name="7"></a>    public void rstStreamShouldCloseStream() throws Exception {
566         writeAllFlowControlledFrames();
567         <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, newPromise());
568         stream(STREAM_ID);
569         ChannelPromise promise = newPromise();
570         encoder.writeRstStream(ctx, STREAM_ID, PROTOCOL_ERROR.code(), promise);
571         verify(lifecycleManager).resetStream(eq(ctx), eq(STREAM_ID), anyLong(), eq(promise));
572     }
573     @Test
574     public void pingWriteAfterGoAwayShouldSucceed() throws Exception {
575         ChannelPromise promise = newPromise()</b></font>;
576         goAwayReceived(0);
577         encoder.writePing(ctx, false, 0L, promise);
578         verify(writer).writePing(eq(ctx), eq(false), eq(0L), eq(promise));
579 <a name="23"></a>    }
580     @Test
581     public void pingWriteShouldSucceed() throws Exception <font color="#f660ab"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
582         ChannelPromise promise = newPromise();
583         encoder.writePing(ctx, false, 0L, promise);
584         verify(writer).writePing(eq(ctx), eq(false), eq(0L), eq(promise));
585     }</b></font>
586     @Test
587     public void settingsWriteAfterGoAwayShouldSucceed() throws Exception {
588 <a name="19"></a>        goAwayReceived(0);
589         ChannelPromise promise = newPromise();
590         encoder.writeSettings(ctx, new Http2Settings(), promise);
591         <font color="#f62817"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>verify(writer).writeSettings(eq(ctx), any(Http2Settings.class), eq(promise));
592     }
593 <a name="24"></a>    @Test
594     public void settingsWriteShouldNotUpdateSettings() throws Exception {
595         Http2Settings settings = new</b></font> Http2Settings();
596         <font color="#79764d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>settings.initialWindowSize(100);
597         settings.maxConcurrentStreams(1000);
598         settings.headerTableSize(2000);
599         ChannelPromise promise = newPromise();
600         encoder.writeSettings(ctx, settings, promise);
601         verify(writer).writeSettings(eq(ctx), eq</b></font>(settings), eq(promise));
602     }
603     @Test
604     public void dataWriteShouldCreateHalfClosedStream() throws Exception {
605         writeAllFlowControlledFrames();
606         Http2Stream stream = createStream(STREAM_ID, false);
607         ByteBuf data = dummyData();
608         ChannelPromise promise = newPromise();
609         encoder.writeData(ctx, STREAM_ID, data.retain(), 0, true, promise);
610         assertTrue(promise.isSuccess());
611         verify(remoteFlow).addFlowControlled(eq(stream), any(FlowControlled.class));
612         verify(lifecycleManager).closeStreamLocal(stream, promise);
613         assertEquals(data.toString(UTF_8), writtenData.get(0));
614         data.release();
615     }
616 <a name="12"></a>
617     @Test
618     public void headersWriteShouldHalfCloseStream() throws Exception {
619         <font color="#571b7e"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>writeAllFlowControlledFrames();
620         createStream(STREAM_ID, false);
621         ChannelPromise promise = newPromise();
622         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, promise);
623         assertTrue(promise.isSuccess());
624         verify(lifecycleManager).closeStreamLocal(eq(stream(STREAM_ID)), eq(promise));
625     }
626     @Test
627     public void headersWriteShouldHalfClosePushStream() throws Exception {</b></font>
628         writeAllFlowControlledFrames();
629         Http2Stream parent = createStream(STREAM_ID, false);
630         Http2Stream stream = reservePushStream(PUSH_STREAM_ID, parent);
631         ChannelPromise promise = newPromise();
632         encoder.writeHeaders(ctx, PUSH_STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, promise);
633         assertEquals(HALF_CLOSED_REMOTE, stream.state());
634         assertTrue(promise.isSuccess());
635         verify(lifecycleManager).closeStreamLocal(eq(stream), eq(promise));
636     }
637     @Test
638     public void headersWriteShouldHalfCloseAfterOnErrorForPreCreatedStream() throws Exception {
639         final ChannelPromise promise = newPromise();
640         final Throwable ex = new RuntimeException();
641         when(writer.writeHeaders(eq(ctx), eq(STREAM_ID), eq(EmptyHttp2Headers.INSTANCE), eq(0), eq(true), eq(promise)))
642             .thenAnswer(new Answer&lt;ChannelFuture&gt;() {
643                 @Override
644                 public ChannelFuture answer(InvocationOnMock invocation) {
645                     promise.setFailure(ex);
646                     return promise;
647                 }
648             });
649 <a name="8"></a>
650         writeAllFlowControlledFrames();
651         Http2Stream stream = createStream(STREAM_ID, false);
652         <font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, promise);
653         assertTrue(promise.isDone());
654         assertFalse(promise.isSuccess());
655         assertFalse(stream.isHeadersSent());
656         InOrder inOrder = inOrder(lifecycleManager);
657         inOrder.verify(lifecycleManager).onError(eq(ctx), eq(true), eq(ex));
658         inOrder.verify(lifecycleManager).closeStreamLocal(eq(stream</b></font>(STREAM_ID)), eq(promise));
659     }
660     @Test
661     public void headersWriteShouldHalfCloseAfterOnErrorForImplicitlyCreatedStream() throws Exception {
662         final ChannelPromise promise = newPromise();
663         final Throwable ex = new RuntimeException();
664         when(writer.writeHeaders(eq(ctx), eq(STREAM_ID), eq(EmptyHttp2Headers.INSTANCE), eq(0), eq(true), eq(promise)))
665             .thenAnswer(new Answer&lt;ChannelFuture&gt;() {
666                 @Override
667                 public ChannelFuture answer(InvocationOnMock invocation) {
668                     promise.setFailure(ex);
669                     return promise;
670 <a name="15"></a>                }
671             });
672         <font color="#f52887"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>writeAllFlowControlledFrames();
673         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, promise);
674         assertTrue(promise.isDone());
675         assertFalse(promise.isSuccess());
676         assertFalse(stream(STREAM_ID).isHeadersSent());
677         InOrder inOrder = inOrder(lifecycleManager);
678         inOrder.verify(lifecycleManager).onError(eq(ctx), eq(true), eq</b></font>(ex));
679         inOrder.verify(lifecycleManager).closeStreamLocal(eq(stream(STREAM_ID)), eq(promise));
680     }
681     @Test
682     public void encoderDelegatesGoAwayToLifeCycleManager() {
683         ChannelPromise promise = newPromise();
684         encoder.writeGoAway(ctx, STREAM_ID, Http2Error.INTERNAL_ERROR.code(), null, promise);
685         verify(lifecycleManager).goAway(eq(ctx), eq(STREAM_ID), eq(Http2Error.INTERNAL_ERROR.code()),
686                 eq((ByteBuf) null), eq(promise));
687         verifyNoMoreInteractions(writer);
688     }
689     @Test
690     public void dataWriteToClosedStreamShouldFail() throws Exception {
691         createStream(STREAM_ID, false).close();
692         ByteBuf data = mock(ByteBuf.class);
693         ChannelPromise promise = newPromise();
694         encoder.writeData(ctx, STREAM_ID, data, 0, false, promise);
695         assertTrue(promise.isDone());
696         assertFalse(promise.isSuccess());
697         assertThat(promise.cause(), instanceOf(IllegalArgumentException.class));
698         verify(data).release();
699     }
700     @Test
701     public void dataWriteToHalfClosedLocalStreamShouldFail() throws Exception {
702         createStream(STREAM_ID, true);
703         ByteBuf data = mock(ByteBuf.class);
704         ChannelPromise promise = newPromise();
705         encoder.writeData(ctx, STREAM_ID, data, 0, false, promise);
706         assertTrue(promise.isDone());
707         assertFalse(promise.isSuccess());
708         assertThat(promise.cause(), instanceOf(IllegalStateException.class));
709         verify(data).release();
710     }
711     @Test
712     public void canWriteDataFrameAfterGoAwaySent() throws Exception {
713         Http2Stream stream = createStream(STREAM_ID, false);
714         connection.goAwaySent(0, 0, EMPTY_BUFFER);
715         ByteBuf data = mock(ByteBuf.class);
716         encoder.writeData(ctx, STREAM_ID, data, 0, false, newPromise());
717         verify(remoteFlow).addFlowControlled(eq(stream), any(FlowControlled.class));
718     }
719     @Test
720     public void canWriteHeaderFrameAfterGoAwaySent() throws Exception {
721         writeAllFlowControlledFrames();
722         createStream(STREAM_ID, false);
723         goAwaySent(0);
724         ChannelPromise promise = newPromise();
725         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, false, promise);
726         verify(writer).writeHeaders(eq(ctx), eq(STREAM_ID), eq(EmptyHttp2Headers.INSTANCE),
727                 eq(0), eq(false), eq(promise));
728     }
729     @Test
730     public void canWriteDataFrameAfterGoAwayReceived() throws Exception {
731         Http2Stream stream = createStream(STREAM_ID, false);
732         goAwayReceived(STREAM_ID);
733         ByteBuf data = mock(ByteBuf.class);
734         encoder.writeData(ctx, STREAM_ID, data, 0, false, newPromise());
735         verify(remoteFlow).addFlowControlled(eq(stream), any(FlowControlled.class));
736     }
737     @Test
738     public void canWriteHeaderFrameAfterGoAwayReceived() throws Http2Exception {
739         writeAllFlowControlledFrames();
740         goAwayReceived(STREAM_ID);
741         ChannelPromise promise = newPromise();
742         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, false, promise);
743         verify(writer).writeHeaders(eq(ctx), eq(STREAM_ID), eq(EmptyHttp2Headers.INSTANCE),
744                 eq(0), eq(false), eq(promise));
745     }
746     @Test
747     public void headersWithNoPriority() {
748         writeAllFlowControlledFrames();
749         final int streamId = 6;
750         ChannelPromise promise = newPromise();
751         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
752         verify(writer).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
753                 eq(0), eq(false), eq(promise));
754     }
755     @Test
756     public void headersWithPriority() {
757         writeAllFlowControlledFrames();
758         final int streamId = 6;
759         ChannelPromise promise = newPromise();
760         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 10, DEFAULT_PRIORITY_WEIGHT,
761                 true, 1, false, promise);
762         verify(writer).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE), eq(10),
763                 eq(DEFAULT_PRIORITY_WEIGHT), eq(true), eq(1), eq(false), eq(promise));
764     }
765     private void writeAllFlowControlledFrames() {
766         doAnswer(new Answer&lt;Void&gt;() {
767             @Override
768             public Void answer(InvocationOnMock invocationOnMock) throws Throwable {
769                 FlowControlled flowControlled = (FlowControlled) invocationOnMock.getArguments()[1];
770                 flowControlled.write(ctx, Integer.MAX_VALUE);
771                 flowControlled.writeComplete();
772                 return null;
773             }
774         }).when(remoteFlow).addFlowControlled(any(Http2Stream.class), payloadCaptor.capture());
775     }
776     private Http2Stream createStream(int streamId, boolean halfClosed) throws Http2Exception {
777         return connection.local().createStream(streamId, halfClosed);
778     }
779     private Http2Stream reservePushStream(int pushStreamId, Http2Stream parent) throws Http2Exception {
780         return connection.local().reservePushStream(pushStreamId, parent);
781     }
782     private Http2Stream stream(int streamId) {
783         return connection.stream(streamId);
784     }
785     private void goAwayReceived(int lastStreamId) throws Http2Exception {
786         connection.goAwayReceived(lastStreamId, 0, EMPTY_BUFFER);
787     }
788     private void goAwaySent(int lastStreamId) throws Http2Exception {
789         connection.goAwaySent(lastStreamId, 0, EMPTY_BUFFER);
790     }
791     private ChannelPromise newPromise() {
792         return new DefaultChannelPromise(channel, ImmediateEventExecutor.INSTANCE);
793     }
794     private ChannelFuture newSucceededFuture() {
795         return newPromise().setSuccess();
796     }
797     private static ByteBuf dummyData() {
798         return wrappedBuffer("abcdefgh".getBytes(UTF_8));
799     }
800 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
