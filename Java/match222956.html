<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for BitStringQueryTest.java & LocalFsFileInputTest.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for BitStringQueryTest.java & LocalFsFileInputTest.java
      </h3>
      <h1 align="center">
        29.7%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>BitStringQueryTest.java (30.0%)<TH>LocalFsFileInputTest.java (29.545454%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match222956-0.html#0',2,'match222956-1.html#0',3)" NAME="0">(27-46)<TD><A HREF="javascript:ZweiFrames('match222956-0.html#0',2,'match222956-1.html#0',3)" NAME="0">(25-44)</A><TD ALIGN=center><FONT COLOR="#ff0000">18</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match222956-0.html#1',2,'match222956-1.html#1',3)" NAME="1">(92-99)<TD><A HREF="javascript:ZweiFrames('match222956-0.html#1',2,'match222956-1.html#1',3)" NAME="1">(85-87)</A><TD ALIGN=center><FONT COLOR="#9b0000">11</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match222956-0.html#2',2,'match222956-1.html#2',3)" NAME="2">(63-68)<TD><A HREF="javascript:ZweiFrames('match222956-0.html#2',2,'match222956-1.html#2',3)" NAME="2">(95-98)</A><TD ALIGN=center><FONT COLOR="#8d0000">10</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>BitStringQueryTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial agreement.
 */

package io.crate.lucene;

<A NAME="0"></A>import static org.hamcrest.CoreMatchers.instanceOf;
import static org.hamcrest.CoreMatchers.is;

<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match222956-1.html#0',3,'match222956-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>import java.io.IOException;
import java.util.List;
import java.util.function.Supplier;

import org.apache.lucene.search.Query;
import org.apache.lucene.search.TermInSetQuery;
import org.apache.lucene.search.TermQuery;
import org.elasticsearch.Version;
import org.hamcrest.Matchers;
import org.junit.Test;

import io.crate.sql.tree.BitString;
import io.crate.test.integration.CrateDummyClusterServiceUnitTest;
import io.crate.testing.DataTypeTesting;
import io.crate.testing.QueryTester;
import io.crate.types.BitStringType;

public class BitStringQueryTest extends CrateDummyClusterServiceUnitTest {

    private QueryTester.Builder builder(String createTable) throws IOException {</B></FONT>
        return new QueryTester.Builder(
            createTempDir(),
            THREAD_POOL,
            clusterService,
            Version.CURRENT,
            createTable
        );
    }

    @Test
    public void test_eq_any_on_bits_uses_termset_query() throws Exception {
        var builder = builder(&quot;create table tbl (bits bit(8))&quot;);
        BitString bits1 = BitString.ofRawBits(&quot;00010110&quot;);
<A NAME="2"></A>        BitString bits2 = BitString.ofRawBits(&quot;01110000&quot;);
        builder.indexValues(&quot;bits&quot;, bits1, bits2);

        try (var tester = builder.build()) <FONT color="#980517"><A HREF="javascript:ZweiFrames('match222956-1.html#2',3,'match222956-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
            Query query = tester.toQuery(&quot;bits = ANY([B'01001110', B'11111111'])&quot;);
            assertThat(query, instanceOf(TermInSetQuery.class));
            assertThat(query.toString(), is(&quot;bits:(r [ff])&quot;));

            List&lt;Object&gt; result = tester.runQuery</B></FONT>(&quot;bits&quot;, &quot;bits = ANY([B'01001110', B'11111111'])&quot;);
            assertThat(result, Matchers.empty());

            result = tester.runQuery(&quot;bits&quot;, &quot;bits = ANY([B'00010110', B'11111111'])&quot;);
            assertThat(result, Matchers.contains(bits1));

            result = tester.runQuery(&quot;bits&quot;, &quot;bits = ANY([B'00010110', B'01110000'])&quot;);
            assertThat(result, Matchers.contains(bits1, bits2));
        }

    }

    @Test
    public void test_eq_on_bits_uses_term_query() throws Exception {
        var builder = builder(&quot;create table tbl (bits bit(8))&quot;);
        BitStringType bitStringType = new BitStringType(8);
        Supplier&lt;BitString&gt; dataGenerator = DataTypeTesting.getDataGenerator(bitStringType);
        BitString bits1 = dataGenerator.get();
        BitString bitsNoMatch = dataGenerator.get();
        while (bits1.equals(bitsNoMatch)) {
            bitsNoMatch = dataGenerator.get();
<A NAME="1"></A>        }
        builder.indexValues(&quot;bits&quot;, bits1);

        try (<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match222956-1.html#1',3,'match222956-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>var tester = builder.build()) {
            Query query = tester.toQuery(&quot;bits = ?&quot;, bits1);
            assertThat(query, instanceOf(TermQuery.class));
            assertThat(
                tester.runQuery(&quot;bits&quot;, &quot;bits = ?&quot;, bits1),
                Matchers.contains(bits1)
            );
            assertThat</B></FONT>(
                tester.runQuery(&quot;bits&quot;, &quot;bits = ?&quot;, bitsNoMatch),
                Matchers.empty()
            );
        }
    }

    @Test
    public void test_is_not_null_on_bit_column_uses_doc_values_field_exists_query() throws Exception {
        try (var tester = builder(&quot;create table tbl (bits bit(8))&quot;).build()) {
            Query query = tester.toQuery(&quot;bits is not null&quot;);
            assertThat(query.toString(), is(&quot;ConstantScore(DocValuesFieldExistsQuery [field=bits])&quot;));
        }
    }

    @Test
    public void test_range_query_on_bit_type_is_not_supported() throws Exception {
        try (var tester = builder(&quot;create table tbl (bits bit(8))&quot;).build()) {
            assertThrows(
                UnsupportedOperationException.class,
                () -&gt; tester.toQuery(&quot;bits &gt; B'01'&quot;));
        }
    }

}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>LocalFsFileInputTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate under one or more contributor license agreements.
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.  Crate licenses this file
 * to you under the Apache License, Version 2.0 (the &quot;License&quot;); you may
 * not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
 * implied.  See the License for the specific language governing
 * permissions and limitations under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial
 * agreement.
 */
<A NAME="0"></A>
package io.crate.execution.engine.collect.files;

<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match222956-0.html#0',2,'match222956-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>import io.crate.common.collections.Lists2;
import org.elasticsearch.test.ESTestCase;
import org.junit.Test;

import java.io.IOException;
import java.net.URI;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.function.Function;
import java.util.stream.Collectors;

import static org.hamcrest.Matchers.is;

public class LocalFsFileInputTest extends ESTestCase {

    private List&lt;String&gt; helper_ListUris(String originalUri) throws Exception {</B></FONT>
        URI uri = URI.create(originalUri);
        return Lists2.map(new LocalFsFileInput(uri).expandUri(), URI::toString);
    }

    @Test
    public void test_listUris_with_fileUri_containing_links() throws Exception {
        final String PREFIX = Paths.get(getClass().getResource(&quot;/essetup/data/&quot;).toURI()).toUri().toString();
        Files.deleteIfExists(Path.of(new URI(PREFIX + &quot;linked/a/b/c/symlink_to_a&quot;)));
        Files.deleteIfExists(Path.of(new URI(PREFIX + &quot;linked/a/b/c/symlink_to_e&quot;)));
        Files.createSymbolicLink(
            Path.of(new URI(PREFIX + &quot;linked/a/b/c/symlink_to_a&quot;)), Path.of(new URI(PREFIX + &quot;linked/a&quot;)));
        Files.createSymbolicLink(
            Path.of(new URI(PREFIX + &quot;linked/a/b/c/symlink_to_e&quot;)), Path.of(new URI(PREFIX + &quot;linked/a/b/c/d/e&quot;)));

        Map&lt;String, List&lt;String&gt;&gt; userInputToExpectedUris = Map.ofEntries(
            Map.entry(PREFIX + &quot;linked/*/*.json&quot;,
                      List.of(PREFIX + &quot;linked/a/a.json&quot;)
            ),
            Map.entry(PREFIX + &quot;linked/*/*/*/*.json&quot;,
                      List.of(PREFIX + &quot;linked/a/b/c/c.json&quot;)
            ),
            Map.entry(PREFIX + &quot;linked/*/*/*/*/*.json&quot;,
                      List.of(PREFIX + &quot;linked/a/b/c/d/hardlink_to_b.json&quot;,
                              PREFIX + &quot;linked/a/b/c/symlink_to_a/a.json&quot;,
                              PREFIX + &quot;linked/a/b/c/symlink_to_e/e.json&quot;)
            ),
            Map.entry(PREFIX + &quot;linked/a/b/c/*/*/*/*/*/*.json&quot;,
                      List.of(PREFIX + &quot;linked/a/b/c/symlink_to_a/b/c/d/e/e.json&quot;,
                              PREFIX + &quot;linked/a/b/c/symlink_to_a/b/c/symlink_to_a/b/b.json&quot;,
                              PREFIX + &quot;linked/a/b/c/symlink_to_a/b/c/symlink_to_e/f/f.json&quot;)
            ),
            Map.entry(PREFIX + &quot;*/*/*/*/*/*/*/*/*/*.json&quot;,
                      List.of(PREFIX + &quot;linked/a/b/c/symlink_to_a/b/c/d/e/e.json&quot;,
                              PREFIX + &quot;linked/a/b/c/symlink_to_a/b/c/symlink_to_a/b/b.json&quot;,
                              PREFIX + &quot;linked/a/b/c/symlink_to_a/b/c/symlink_to_e/f/f.json&quot;)
            ),
            Map.entry(PREFIX + &quot;*/*/*/*/*/*/*/*/*/f.json&quot;,
<A NAME="1"></A>                      List.of(PREFIX + &quot;linked/a/b/c/symlink_to_a/b/c/symlink_to_e/f/f.json&quot;)
            )
        );
        for (<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match222956-0.html#1',2,'match222956-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>var e : userInputToExpectedUris.entrySet()) {
            var actual = helper_ListUris(e.getKey()).stream()
                .collect(Collectors.groupingBy(Function.identity(), Collectors.counting</B></FONT>()));
            var expected = e.getValue().stream()
                .collect(Collectors.groupingBy(Function.identity(), Collectors.counting()));
            assertEquals(expected, actual);
        }
<A NAME="2"></A>    }

    @Test
    public void test_toPreGlobUri() throws Exception <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match222956-0.html#2',2,'match222956-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>{
        String path = Paths.get(getClass().getResource(&quot;/essetup/data/&quot;).toURI()).toUri().toString();
        List&lt;String&gt; uris =
            List.of</B></FONT>(
                path + &quot;nested_dir/*.json&quot;,
                path + &quot;nested_dir/*_1.json&quot;,
                path + &quot;nested_dir/*/2_*&quot;,
                path + &quot;nested_dir/nested_dir_2/*/sub.json&quot;,
                path + &quot;nested_dir/nested_dir_*/*/sub.json&quot;
            );
            List&lt;String&gt; preGlobURIs = uris.stream()
                .map(URI::create)
                .map(uri -&gt; {
                    try {
                        return new LocalFsFileInput(uri);
                    } catch (IOException e) {
                        return null;
                    }
                })
                .filter(Objects::nonNull)
                .map(fi -&gt; fi.preGlobUri.toString())
                .toList();
        assertThat(preGlobURIs, is(List.of(
            path + &quot;nested_dir/&quot;,
            path + &quot;nested_dir/&quot;,
            path + &quot;nested_dir/&quot;,
            path + &quot;nested_dir/nested_dir_2/&quot;,
            path + &quot;nested_dir/&quot;
        )));
    }
}
</PRE>
</div>
  </div>
</body>
</html>
