<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for MetadataToASTNodeResolverTest.java &amp; RetentionLeaseIT.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for MetadataToASTNodeResolverTest.java &amp; RetentionLeaseIT.java
      </h3>
<h1 align="center">
        17.7%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>MetadataToASTNodeResolverTest.java (64.28571%)<th>RetentionLeaseIT.java (10.29552%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(24-37)<td><a href="#" name="0">(56-69)</a><td align="center"><font color="#ff0000">12</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(38-71)<td><a href="#" name="1">(188-194)</a><td align="center"><font color="#e90000">11</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(271-288)<td><a href="#" name="2">(564-572)</a><td align="center"><font color="#d40000">10</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(223-238)<td><a href="#" name="3">(518-526)</a><td align="center"><font color="#d40000">10</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(171-188)<td><a href="#" name="4">(404-412)</a><td align="center"><font color="#d40000">10</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(120-125)<td><a href="#" name="5">(74-80)</a><td align="center"><font color="#d40000">10</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(506-511)<td><a href="#" name="6">(145-148)</a><td align="center"><font color="#bf0000">9</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(496-501)<td><a href="#" name="7">(95-98)</a><td align="center"><font color="#bf0000">9</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(446-450)<td><a href="#" name="8">(321-326)</a><td align="center"><font color="#bf0000">9</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(398-402)<td><a href="#" name="9">(263-268)</a><td align="center"><font color="#bf0000">9</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(322-327)<td><a href="#" name="10">(127-132)</a><td align="center"><font color="#bf0000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>MetadataToASTNodeResolverTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19  * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 <a name="0"></a>
22 package io.crate.analyze;
23 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import io.crate.metadata.doc.DocTableInfo;
24 import io.crate.sql.SqlFormatter;
25 import io.crate.sql.tree.CreateTable;
26 import io.crate.test.integration.CrateDummyClusterServiceUnitTest;
27 import io.crate.testing.SQLExecutor;
28 import org.hamcrest.Matchers;
29 import org.junit.Test;
30 public class MetadataToASTNodeResolverTest extends CrateDummyClusterServiceUnitTest {
31 <a name="1"></a>    @Override
32     protected boolean enableWarningsCheck() {
33         return</b></font> false;
34     <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
35     @Test
36     public void testBuildCreateTableColumns() throws Exception {
37         SQLExecutor e = SQLExecutor.builder(clusterService)
38             .addTable("create table doc.test (" +
39                       " bools boolean," +
40                       " bytes byte," +
41                       " strings string," +
42                       " shorts short," +
43                       " floats float," +
44                       " doubles double," +
45                       " ints integer," +
46                       " longs long," +
47                       " timestamp timestamp with time zone," +
48                       " ip_addr ip," +
49                       " arr_simple array(string)," +
50                       " arr_geo_point array(geo_point)," +
51                       " arr_obj array(object(strict) as (" +
52                       "  col_1 long," +
53                       "  col_2 string" +
54                       " ))," +
55                       " obj object as (" +
56                       "  col_1 long," +
57                       "  col_2 string" +
58                       " )" +
59                       ") " +
60                       "clustered into 5 shards " +
61                       "with (" +
62                       " number_of_replicas = '0-all'," +
63                       " \"merge.scheduler.max_thread_count\" = 1" +
64                       ")")
65             .build();
66         DocTableInfo tableInfo = e.resolveTableInfo</b></font>("doc.test");
67         CreateTable node = MetadataToASTNodeResolver.resolveCreateTable(tableInfo);
68         assertEquals("CREATE TABLE IF NOT EXISTS \"doc\".\"test\" (\n" +
69                      "   \"bools\" BOOLEAN,\n" +
70                      "   \"bytes\" CHAR,\n" +
71                      "   \"strings\" TEXT,\n" +
72                      "   \"shorts\" SMALLINT,\n" +
73                      "   \"floats\" REAL,\n" +
74                      "   \"doubles\" DOUBLE PRECISION,\n" +
75                      "   \"ints\" INTEGER,\n" +
76                      "   \"longs\" BIGINT,\n" +
77                      "   \"timestamp\" TIMESTAMP WITH TIME ZONE,\n" +
78                      "   \"ip_addr\" IP,\n" +
79                      "   \"arr_simple\" ARRAY(TEXT),\n" +
80                      "   \"arr_geo_point\" ARRAY(GEO_POINT),\n" +
81                      "   \"arr_obj\" ARRAY(OBJECT(STRICT) AS (\n" +
82                      "      \"col_1\" BIGINT,\n" +
83                      "      \"col_2\" TEXT\n" +
84                      "   )),\n" +
85                      "   \"obj\" OBJECT(DYNAMIC) AS (\n" +
86                      "      \"col_1\" BIGINT,\n" +
87                      "      \"col_2\" TEXT\n" +
88                      "   )\n" +
89                      ")\n" +
90                      "CLUSTERED INTO 5 SHARDS\n" +
91                      "WITH (\n" +
92                      "   \"allocation.max_retries\" = 5,\n" +
93                      "   \"blocks.metadata\" = false,\n" +
94                      "   \"blocks.read\" = false,\n" +
95                      "   \"blocks.read_only\" = false,\n" +
96                      "   \"blocks.read_only_allow_delete\" = false,\n" +
97                      "   \"blocks.write\" = false,\n" +
98                      "   codec = 'default',\n" +
99                      "   column_policy = 'strict',\n" +
100                      "   \"mapping.total_fields.limit\" = 1000,\n" +
101                      "   max_ngram_diff = 1,\n" +
102                      "   max_shingle_diff = 3,\n" +
103                      "   \"merge.scheduler.max_thread_count\" = 1,\n" +
104                      "   number_of_replicas = '0-all',\n" +
105                      "   \"routing.allocation.enable\" = 'all',\n" +
106                      "   \"routing.allocation.total_shards_per_node\" = -1,\n" +
107                      "   \"store.type\" = 'fs',\n" +
108                      "   \"translog.durability\" = 'REQUEST',\n" +
109                      "   \"translog.flush_threshold_size\" = 536870912,\n" +
110                      "   \"translog.sync_interval\" = 5000,\n" +
111 <a name="5"></a>                     "   \"unassigned.node_left.delayed_timeout\" = 60000,\n" +
112                      "   \"write.wait_for_active_shards\" = '1'\n" +
113                      ")",
114             <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>SqlFormatter.formatSql(node));
115     }
116     @Test
117     public void testBuildCreateTablePrimaryKey() throws Exception {
118         SQLExecutor e = SQLExecutor.builder</b></font>(clusterService)
119             .addTable("create table myschema.test (" +
120                       " pk_col_one long," +
121                       " pk_col_two long," +
122                       " primary key (pk_col_one, pk_col_two)" +
123                       ") " +
124                       "clustered into 5 shards " +
125                       "with (" +
126                       " number_of_replicas = '0-all'," +
127                       " column_policy = 'strict'," +
128                       " \"merge.scheduler.max_thread_count\" = 1" +
129                       ")")
130             .build();
131         DocTableInfo tableInfo = e.resolveTableInfo("myschema.test");
132         CreateTable node = MetadataToASTNodeResolver.resolveCreateTable(tableInfo);
133         assertEquals("CREATE TABLE IF NOT EXISTS \"myschema\".\"test\" (\n" +
134                      "   \"pk_col_one\" BIGINT,\n" +
135                      "   \"pk_col_two\" BIGINT,\n" +
136                      "   PRIMARY KEY (\"pk_col_one\", \"pk_col_two\")\n" +
137                      ")\n" +
138                      "CLUSTERED INTO 5 SHARDS\n" +
139                      "WITH (\n" +
140                      "   \"allocation.max_retries\" = 5,\n" +
141                      "   \"blocks.metadata\" = false,\n" +
142                      "   \"blocks.read\" = false,\n" +
143                      "   \"blocks.read_only\" = false,\n" +
144                      "   \"blocks.read_only_allow_delete\" = false,\n" +
145                      "   \"blocks.write\" = false,\n" +
146                      "   codec = 'default',\n" +
147                      "   column_policy = 'strict',\n" +
148                      "   \"mapping.total_fields.limit\" = 1000,\n" +
149                      "   max_ngram_diff = 1,\n" +
150                      "   max_shingle_diff = 3,\n" +
151                      "   \"merge.scheduler.max_thread_count\" = 1,\n" +
152                      "   number_of_replicas = '0-all',\n" +
153                      "   \"routing.allocation.enable\" = 'all',\n" +
154                      "   \"routing.allocation.total_shards_per_node\" = -1,\n" +
155                      "   \"store.type\" = 'fs',\n" +
156                      "   \"translog.durability\" = 'REQUEST',\n" +
157                      "   \"translog.flush_threshold_size\" = 536870912,\n" +
158                      "   \"translog.sync_interval\" = 5000,\n" +
159                      "   \"unassigned.node_left.delayed_timeout\" = 60000,\n" +
160 <a name="4"></a>                     "   \"write.wait_for_active_shards\" = '1'\n" +
161                      ")",
162             SqlFormatter.formatSql(node));
163     <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
164     @Test
165     public void testBuildCreateTableNotNull() throws Exception {
166         SQLExecutor e = SQLExecutor.builder(clusterService)
167             .addTable("create table myschema.test (" +
168                       " col_a string," +
169                       " col_b string not null index using fulltext," +
170                       " primary key (col_a)" +
171                       ") " +
172                       "clustered into 5 shards " +
173                       "with (" +
174                       " number_of_replicas = '0-all'," +
175                       " column_policy = 'strict'," +
176                       " \"merge.scheduler.max_thread_count\" = 1" +
177                       ")")
178             .build();
179         DocTableInfo tableInfo = e.resolveTableInfo("myschema.test")</b></font>;
180         CreateTable node = MetadataToASTNodeResolver.resolveCreateTable(tableInfo);
181         assertEquals("CREATE TABLE IF NOT EXISTS \"myschema\".\"test\" (\n" +
182                      "   \"col_a\" TEXT,\n" +
183                      "   \"col_b\" TEXT NOT NULL INDEX USING FULLTEXT WITH (\n" +
184                      "      analyzer = 'standard'\n" +
185                      "   ),\n" +
186                      "   PRIMARY KEY (\"col_a\")\n" +
187                      ")\n" +
188                      "CLUSTERED BY (\"col_a\") INTO 5 SHARDS\n" +
189                      "WITH (\n" +
190                      "   \"allocation.max_retries\" = 5,\n" +
191                      "   \"blocks.metadata\" = false,\n" +
192                      "   \"blocks.read\" = false,\n" +
193                      "   \"blocks.read_only\" = false,\n" +
194                      "   \"blocks.read_only_allow_delete\" = false,\n" +
195                      "   \"blocks.write\" = false,\n" +
196                      "   codec = 'default',\n" +
197                      "   column_policy = 'strict',\n" +
198                      "   \"mapping.total_fields.limit\" = 1000,\n" +
199                      "   max_ngram_diff = 1,\n" +
200                      "   max_shingle_diff = 3,\n" +
201                      "   \"merge.scheduler.max_thread_count\" = 1,\n" +
202                      "   number_of_replicas = '0-all',\n" +
203                      "   \"routing.allocation.enable\" = 'all',\n" +
204                      "   \"routing.allocation.total_shards_per_node\" = -1,\n" +
205                      "   \"store.type\" = 'fs',\n" +
206                      "   \"translog.durability\" = 'REQUEST',\n" +
207                      "   \"translog.flush_threshold_size\" = 536870912,\n" +
208                      "   \"translog.sync_interval\" = 5000,\n" +
209                      "   \"unassigned.node_left.delayed_timeout\" = 60000,\n" +
210 <a name="3"></a>                     "   \"write.wait_for_active_shards\" = '1'\n" +
211                      ")",
212             SqlFormatter.formatSql(node));
213     <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
214     @Test
215     public void testBuildCreateTableCheckConstraints() throws Exception {
216         SQLExecutor e = SQLExecutor.builder(clusterService)
217             .addTable("create table doc.test (" +
218                       " floats float constraint test_floats_check check (floats != -1)," +
219                       " shorts short," +
220                       " constraint test_shorts_check check (shorts &gt;= 0)" +
221                       ") " +
222                       "clustered into 5 shards " +
223                       "with (" +
224                       " number_of_replicas = '0-all'" +
225                       ")")
226             .build();
227         DocTableInfo tableInfo = e.resolveTableInfo("doc.test")</b></font>;
228         CreateTable node = MetadataToASTNodeResolver.resolveCreateTable(tableInfo);
229         assertEquals("CREATE TABLE IF NOT EXISTS \"doc\".\"test\" (\n" +
230                      "   \"floats\" REAL,\n" +
231                      "   \"shorts\" SMALLINT,\n" +
232                      "   CONSTRAINT test_floats_check CHECK(\"floats\" &lt;&gt; - 1),\n" +
233                      "   CONSTRAINT test_shorts_check CHECK(\"shorts\" &gt;= 0)\n" +
234                      ")\n" +
235                      "CLUSTERED INTO 5 SHARDS\n" +
236                      "WITH (\n" +
237                      "   \"allocation.max_retries\" = 5,\n" +
238                      "   \"blocks.metadata\" = false,\n" +
239                      "   \"blocks.read\" = false,\n" +
240                      "   \"blocks.read_only\" = false,\n" +
241                      "   \"blocks.read_only_allow_delete\" = false,\n" +
242                      "   \"blocks.write\" = false,\n" +
243                      "   codec = 'default',\n" +
244                      "   column_policy = 'strict',\n" +
245                      "   \"mapping.total_fields.limit\" = 1000,\n" +
246                      "   max_ngram_diff = 1,\n" +
247                      "   max_shingle_diff = 3,\n" +
248                      "   number_of_replicas = '0-all',\n" +
249                      "   \"routing.allocation.enable\" = 'all',\n" +
250                      "   \"routing.allocation.total_shards_per_node\" = -1,\n" +
251                      "   \"store.type\" = 'fs',\n" +
252                      "   \"translog.durability\" = 'REQUEST',\n" +
253                      "   \"translog.flush_threshold_size\" = 536870912,\n" +
254                      "   \"translog.sync_interval\" = 5000,\n" +
255                      "   \"unassigned.node_left.delayed_timeout\" = 60000,\n" +
256 <a name="2"></a>                     "   \"write.wait_for_active_shards\" = '1'\n" +
257                      ")",
258                      SqlFormatter.formatSql(node));
259     <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
260     @Test
261     public void testBuildCreateTableClusteredByPartitionedBy() throws Exception {
262         SQLExecutor e = SQLExecutor.builder(clusterService)
263             .addPartitionedTable("create table myschema.test (" +
264                       " id long," +
265                       " partition_column string," +
266                       " cluster_column string" +
267                       ") " +
268                       "partitioned by (partition_column) " +
269                       "clustered by (cluster_column) into 5 shards " +
270                       "with (" +
271                       " number_of_replicas = '0-all'," +
272                       " \"merge.scheduler.max_thread_count\" = 1" +
273                       ")")
274             .build();
275         DocTableInfo tableInfo = e.resolveTableInfo("myschema.test")</b></font>;
276         CreateTable node = MetadataToASTNodeResolver.resolveCreateTable(tableInfo);
277         assertEquals("CREATE TABLE IF NOT EXISTS \"myschema\".\"test\" (\n" +
278                      "   \"id\" BIGINT,\n" +
279                      "   \"partition_column\" TEXT,\n" +
280                      "   \"cluster_column\" TEXT\n" +
281                      ")\n" +
282                      "CLUSTERED BY (\"cluster_column\") INTO 5 SHARDS\n" +
283                      "PARTITIONED BY (\"partition_column\")\n" +
284                      "WITH (\n" +
285                      "   \"allocation.max_retries\" = 5,\n" +
286                      "   \"blocks.metadata\" = false,\n" +
287                      "   \"blocks.read\" = false,\n" +
288                      "   \"blocks.read_only\" = false,\n" +
289                      "   \"blocks.read_only_allow_delete\" = false,\n" +
290                      "   \"blocks.write\" = false,\n" +
291                      "   codec = 'default',\n" +
292                      "   column_policy = 'strict',\n" +
293                      "   \"mapping.total_fields.limit\" = 1000,\n" +
294                      "   max_ngram_diff = 1,\n" +
295                      "   max_shingle_diff = 3,\n" +
296                      "   \"merge.scheduler.max_thread_count\" = 1,\n" +
297                      "   number_of_replicas = '0-all',\n" +
298                      "   \"routing.allocation.enable\" = 'all',\n" +
299                      "   \"routing.allocation.total_shards_per_node\" = -1,\n" +
300                      "   \"store.type\" = 'fs',\n" +
301                      "   \"translog.durability\" = 'REQUEST',\n" +
302                      "   \"translog.flush_threshold_size\" = 536870912,\n" +
303                      "   \"translog.sync_interval\" = 5000,\n" +
304                      "   \"unassigned.node_left.delayed_timeout\" = 60000,\n" +
305 <a name="10"></a>                     "   \"write.wait_for_active_shards\" = '1'\n" +
306                      ")",
307             SqlFormatter.formatSql(node));
308     <font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
309     @Test
310     public void testBuildCreateTableIndexes() throws Exception {
311         SQLExecutor e = SQLExecutor.builder</b></font>(clusterService)
312             .addTable("create table myschema.test (" +
313                       " id long," +
314                       " col_a string," +
315                       " col_b string index using fulltext," +
316                       " col_c string index off," +
317                       " col_d object as (" +
318                       "  a string" +
319                       " )," +
320                       " index col_a_col_b_ft using fulltext (col_a, col_b) with (" +
321                       "  analyzer= 'english'" +
322                       " )," +
323                       " index col_d_a_ft using fulltext (col_d['a']) with (" +
324                       "  analyzer= 'custom_analyzer'" +
325                       " )," +
326                       " index col_a_col_b_plain using plain (col_a, col_b)" +
327                       ") " +
328                       "clustered into 5 shards " +
329                       "with (" +
330                       " number_of_replicas = '0-all'," +
331                       " \"merge.scheduler.max_thread_count\" = 1" +
332                       ")")
333             .build();
334         DocTableInfo tableInfo = e.resolveTableInfo("myschema.test");
335         CreateTable node = MetadataToASTNodeResolver.resolveCreateTable(tableInfo);
336         assertEquals("CREATE TABLE IF NOT EXISTS \"myschema\".\"test\" (\n" +
337                      "   \"id\" BIGINT,\n" +
338                      "   \"col_a\" TEXT,\n" +
339                      "   \"col_b\" TEXT INDEX USING FULLTEXT WITH (\n" +
340                      "      analyzer = 'standard'\n" +
341                      "   ),\n" +
342                      "   \"col_c\" TEXT INDEX OFF,\n" +
343                      "   \"col_d\" OBJECT(DYNAMIC) AS (\n" +
344                      "      \"a\" TEXT\n" +
345                      "   ),\n" +
346                      "   INDEX \"col_a_col_b_ft\" USING FULLTEXT (\"col_a\", \"col_b\") WITH (\n" +
347                      "      analyzer = 'english'\n" +
348                      "   ),\n" +
349                      "   INDEX \"col_d_a_ft\" USING FULLTEXT (\"col_d\"['a']) WITH (\n" +
350                      "      analyzer = 'custom_analyzer'\n" +
351                      "   ),\n" +
352                      "   INDEX \"col_a_col_b_plain\" USING FULLTEXT (\"col_a\", \"col_b\") WITH (\n" +
353                      "      analyzer = 'keyword'\n" +
354                      "   )\n" +
355                      ")\n" +
356                      "CLUSTERED INTO 5 SHARDS\n" +
357                      "WITH (\n" +
358                      "   \"allocation.max_retries\" = 5,\n" +
359                      "   \"blocks.metadata\" = false,\n" +
360                      "   \"blocks.read\" = false,\n" +
361                      "   \"blocks.read_only\" = false,\n" +
362                      "   \"blocks.read_only_allow_delete\" = false,\n" +
363                      "   \"blocks.write\" = false,\n" +
364                      "   codec = 'default',\n" +
365                      "   column_policy = 'strict',\n" +
366                      "   \"mapping.total_fields.limit\" = 1000,\n" +
367                      "   max_ngram_diff = 1,\n" +
368                      "   max_shingle_diff = 3,\n" +
369                      "   \"merge.scheduler.max_thread_count\" = 1,\n" +
370                      "   number_of_replicas = '0-all',\n" +
371                      "   \"routing.allocation.enable\" = 'all',\n" +
372                      "   \"routing.allocation.total_shards_per_node\" = -1,\n" +
373                      "   \"store.type\" = 'fs',\n" +
374                      "   \"translog.durability\" = 'REQUEST',\n" +
375                      "   \"translog.flush_threshold_size\" = 536870912,\n" +
376                      "   \"translog.sync_interval\" = 5000,\n" +
377                      "   \"unassigned.node_left.delayed_timeout\" = 60000,\n" +
378 <a name="9"></a>                     "   \"write.wait_for_active_shards\" = '1'\n" +
379                      ")",
380             SqlFormatter.formatSql(node));
381     <font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
382     @Test
383     public void testBuildCreateTableStorageDefinitions() throws Exception {
384         SQLExecutor e = SQLExecutor.builder</b></font>(clusterService)
385             .addTable("create table myschema.test (" +
386                       " s string storage with (columnstore =false)" +
387                       ") " +
388                       "clustered into 5 shards " +
389                       "with (" +
390                       " number_of_replicas = '0-all'," +
391                       " column_policy = 'strict'," +
392                       " \"merge.scheduler.max_thread_count\" = 1" +
393                       ")")
394             .build();
395         DocTableInfo tableInfo = e.resolveTableInfo("myschema.test");
396         CreateTable node = MetadataToASTNodeResolver.resolveCreateTable(tableInfo);
397         assertEquals("CREATE TABLE IF NOT EXISTS \"myschema\".\"test\" (\n" +
398                      "   \"s\" TEXT STORAGE WITH (\n" +
399                      "      columnstore = false\n" +
400                      "   )\n" +
401                      ")\n" +
402                      "CLUSTERED INTO 5 SHARDS\n" +
403                      "WITH (\n" +
404                      "   \"allocation.max_retries\" = 5,\n" +
405                      "   \"blocks.metadata\" = false,\n" +
406                      "   \"blocks.read\" = false,\n" +
407                      "   \"blocks.read_only\" = false,\n" +
408                      "   \"blocks.read_only_allow_delete\" = false,\n" +
409                      "   \"blocks.write\" = false,\n" +
410                      "   codec = 'default',\n" +
411                      "   column_policy = 'strict',\n" +
412                      "   \"mapping.total_fields.limit\" = 1000,\n" +
413                      "   max_ngram_diff = 1,\n" +
414                      "   max_shingle_diff = 3,\n" +
415                      "   \"merge.scheduler.max_thread_count\" = 1,\n" +
416                      "   number_of_replicas = '0-all',\n" +
417                      "   \"routing.allocation.enable\" = 'all',\n" +
418                      "   \"routing.allocation.total_shards_per_node\" = -1,\n" +
419                      "   \"store.type\" = 'fs',\n" +
420                      "   \"translog.durability\" = 'REQUEST',\n" +
421                      "   \"translog.flush_threshold_size\" = 536870912,\n" +
422                      "   \"translog.sync_interval\" = 5000,\n" +
423                      "   \"unassigned.node_left.delayed_timeout\" = 60000,\n" +
424 <a name="8"></a>                     "   \"write.wait_for_active_shards\" = '1'\n" +
425                      ")",
426             SqlFormatter.formatSql(node));
427     <font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
428     @Test
429     public void testBuildCreateTableColumnDefaultClause() throws Exception {
430         SQLExecutor e = SQLExecutor.builder</b></font>(clusterService)
431             .addTable("CREATE TABLE test (" +
432                       "   col1 TEXT," +
433                       "   col2 INTEGER DEFAULT 1 + 1," +
434                       "   col3 TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP(3)," +
435                       "   col4 TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP(3)" +
436                       ") with (" +
437                       " \"merge.scheduler.max_thread_count\" = 1" +
438                       ")")
439             .build();
440         DocTableInfo tableInfo = e.resolveTableInfo("test");
441         CreateTable&lt;?&gt; node = MetadataToASTNodeResolver.resolveCreateTable(tableInfo);
442         assertEquals("CREATE TABLE IF NOT EXISTS \"doc\".\"test\" (\n" +
443                      "   \"col1\" TEXT,\n" +
444                      "   \"col2\" INTEGER DEFAULT 2,\n" +
445                      "   \"col3\" TIMESTAMP WITH TIME ZONE DEFAULT current_timestamp(3),\n" +
446                      "   \"col4\" TIMESTAMP WITHOUT TIME ZONE DEFAULT _cast(current_timestamp(3), 'timestamp without time zone')\n" +
447                      ")\n" +
448                      "CLUSTERED INTO 4 SHARDS\n" +
449                      "WITH (\n" +
450                      "   \"allocation.max_retries\" = 5,\n" +
451                      "   \"blocks.metadata\" = false,\n" +
452                      "   \"blocks.read\" = false,\n" +
453                      "   \"blocks.read_only\" = false,\n" +
454                      "   \"blocks.read_only_allow_delete\" = false,\n" +
455                      "   \"blocks.write\" = false,\n" +
456                      "   codec = 'default',\n" +
457                      "   column_policy = 'strict',\n" +
458                      "   \"mapping.total_fields.limit\" = 1000,\n" +
459                      "   max_ngram_diff = 1,\n" +
460                      "   max_shingle_diff = 3,\n" +
461                      "   \"merge.scheduler.max_thread_count\" = 1,\n" +
462                      "   number_of_replicas = '0-1',\n" +
463                      "   \"routing.allocation.enable\" = 'all',\n" +
464                      "   \"routing.allocation.total_shards_per_node\" = -1,\n" +
465                      "   \"store.type\" = 'fs',\n" +
466                      "   \"translog.durability\" = 'REQUEST',\n" +
467                      "   \"translog.flush_threshold_size\" = 536870912,\n" +
468                      "   \"translog.sync_interval\" = 5000,\n" +
469                      "   \"unassigned.node_left.delayed_timeout\" = 60000,\n" +
470                      "   \"write.wait_for_active_shards\" = '1'\n" +
471                      ")",
472                      SqlFormatter.formatSql(node));
473 <a name="7"></a>    }
474     @Test
475     public void test_varchar_with_length_limit_is_printed_as_varchar_with_length_in_show_create_table() throws Exception <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
476         SQLExecutor e = SQLExecutor.builder(clusterService)
477             .addTable("create table tbl (name varchar(10))")
478             .build();
479         DocTableInfo table = e.resolveTableInfo("tbl");
480         CreateTable&lt;?&gt; node = MetadataToASTNodeResolver.resolveCreateTable</b></font>(table);
481         assertThat(SqlFormatter.formatSql(node), Matchers.containsString("\"name\" VARCHAR(10)"));
482 <a name="6"></a>    }
483     @Test
484     public void test_bit_string_length_is_shown_in_show_create_table_output() throws Exception <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
485         SQLExecutor e = SQLExecutor.builder(clusterService)
486             .addTable("create table tbl (xs bit(8))")
487             .build();
488         DocTableInfo table = e.resolveTableInfo("tbl");
489         CreateTable&lt;?&gt; node = MetadataToASTNodeResolver.resolveCreateTable</b></font>(table);
490         assertThat(SqlFormatter.formatSql(node), Matchers.containsString("\"xs\" BIT(8)"));
491     }
492 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>RetentionLeaseIT.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Elasticsearch under one or more contributor
3  * license agreements. See the NOTICE file distributed with
4  * this work for additional information regarding copyright
5  * ownership. Elasticsearch licenses this file to you under
6  * the Apache License, Version 2.0 (the "License"); you may
7  * not use this file except in compliance with the License.
8  * You may obtain a copy of the License at
9  *
10  *    http://www.apache.org/licenses/LICENSE-2.0
11  *
12  * Unless required by applicable law or agreed to in writing,
13  * software distributed under the License is distributed on an
14  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
15  * KIND, either express or implied.  See the License for the
16  * specific language governing permissions and limitations
17  * under the License.
18  */
19 package org.elasticsearch.index.seqno;
20 import static org.hamcrest.Matchers.anyOf;
21 import static org.hamcrest.Matchers.contains;
22 import static org.hamcrest.Matchers.empty;
23 import static org.hamcrest.Matchers.equalTo;
24 import java.io.Closeable;
25 import java.util.ArrayList;
26 import java.util.Collection;
27 import java.util.HashMap;
28 import java.util.LinkedHashMap;
29 import java.util.List;
30 import java.util.Map;
31 import java.util.concurrent.CountDownLatch;
32 import java.util.concurrent.Semaphore;
33 import java.util.concurrent.TimeUnit;
34 import java.util.concurrent.atomic.AtomicBoolean;
35 import java.util.concurrent.atomic.AtomicReference;
36 import java.util.function.BiConsumer;
37 import java.util.function.Consumer;
38 import org.elasticsearch.ElasticsearchException;
39 import org.elasticsearch.action.ActionListener;
40 import org.elasticsearch.action.support.replication.ReplicationResponse;
41 import org.elasticsearch.cluster.node.DiscoveryNode;
42 import org.elasticsearch.cluster.routing.ShardRouting;
43 import org.elasticsearch.common.settings.Settings;
44 import org.elasticsearch.index.engine.Engine;
45 import org.elasticsearch.index.shard.IndexShard;
46 import org.elasticsearch.index.shard.ShardId;
47 import org.elasticsearch.indices.IndicesService;
48 import org.elasticsearch.indices.recovery.PeerRecoveryTargetService;
49 <a name="0"></a>import org.elasticsearch.plugins.Plugin;
50 import org.elasticsearch.test.transport.MockTransportService;
51 import org.elasticsearch.threadpool.ThreadPool;
52 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import org.elasticsearch.transport.AbstractSimpleTransportTestCase;
53 import org.elasticsearch.transport.TransportService;
54 import org.junit.After;
55 import org.junit.Test;
56 import io.crate.common.collections.Lists2;
57 import io.crate.common.unit.TimeValue;
58 import io.crate.integrationtests.SQLIntegrationTestCase;
59 public class RetentionLeaseIT extends SQLIntegrationTestCase  {
60     @Override
61     protected Collection&lt;Class&lt;? extends Plugin&gt;&gt; nodePlugins() {
62         return</b></font> Lists2.concat(super.nodePlugins(), MockTransportService.TestPlugin.class);
63     }
64 <a name="5"></a>
65     @After
66     public void resetSettings() {
67         <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>execute("reset global \"indices.recovery.retry_delay_network\"");
68     }
69     @Test
70     public void testRetentionLeasesSyncedOnAdd() throws Exception {
71         final int numberOfReplicas = 2 - scaledRandomIntBetween(0, 2);
72         internalCluster</b></font>().ensureAtLeastNumDataNodes(1 + numberOfReplicas);
73         execute(
74             "create table doc.tbl (x int) clustered into 1 shards " +
75             "with (number_of_replicas = ?, \"soft_deletes.enabled\" = true)",
76             new Object[] { numberOfReplicas }
77         );
78         ensureGreen("tbl");
79         final String primaryShardNodeId = clusterService().state().routingTable().index("tbl").shard(0).primaryShard().currentNodeId();
80         final String primaryShardNodeName = clusterService().state().nodes().get(primaryShardNodeId).getName();
81         final IndexShard primary = internalCluster()
82             .getInstance(IndicesService.class, primaryShardNodeName)
83             .getShardOrNull(new ShardId(resolveIndex("tbl"), 0));
84 <a name="7"></a>                final int length = randomIntBetween(1, 8);
85         final Map&lt;String, RetentionLease&gt; currentRetentionLeases = new HashMap&lt;&gt;();
86         for (int i = 0; i &lt; length; i++) <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
87             final String id = randomValueOtherThanMany(currentRetentionLeases.keySet()::contains, () -&gt; randomAlphaOfLength(8));
88             final long retainingSequenceNumber = randomLongBetween(0, Long.MAX_VALUE);
89             final String source = randomAlphaOfLength</b></font>(8);
90             final CountDownLatch latch = new CountDownLatch(1);
91             final ActionListener&lt;ReplicationResponse&gt; listener = ActionListener.wrap(r -&gt; latch.countDown(), e -&gt; fail(e.toString()));
92             final Closeable retentionLock = randomBoolean() ? primary.acquireHistoryRetentionLock(Engine.HistorySource.INDEX) : () -&gt; {};
93             currentRetentionLeases.put(id, primary.addRetentionLease(id, retainingSequenceNumber, source, listener));
94             latch.await();
95             retentionLock.close();
96             assertThat(currentRetentionLeases,
97                 equalTo(RetentionLeaseUtils.toMapExcludingPeerRecoveryRetentionLeases(primary.loadRetentionLeases())));
98             for (final ShardRouting replicaShard : clusterService().state().routingTable().index("tbl").shard(0).replicaShards()) {
99                 final String replicaShardNodeId = replicaShard.currentNodeId();
100                 final String replicaShardNodeName = clusterService().state().nodes().get(replicaShardNodeId).getName();
101                 final IndexShard replica = internalCluster()
102                     .getInstance(IndicesService.class, replicaShardNodeName)
103                     .getShardOrNull(new ShardId(resolveIndex("tbl"), 0));
104                 final Map&lt;String, RetentionLease&gt; retentionLeasesOnReplica =
105                     RetentionLeaseUtils.toMapExcludingPeerRecoveryRetentionLeases(replica.getRetentionLeases());
106                 assertThat(retentionLeasesOnReplica, equalTo(currentRetentionLeases));
107                 assertThat(currentRetentionLeases,
108 <a name="10"></a>                    equalTo(RetentionLeaseUtils.toMapExcludingPeerRecoveryRetentionLeases(replica.loadRetentionLeases())));
109             }
110         }
111     <font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}
112     @Test
113     public void testRetentionLeaseSyncedOnRemove() throws Exception {
114         final int numberOfReplicas = 2 - scaledRandomIntBetween(0, 2);
115         internalCluster</b></font>().ensureAtLeastNumDataNodes(1 + numberOfReplicas);
116         execute("create table doc.tbl (x int) clustered into 1 shards with (number_of_replicas = ?)",
117                 new Object[]{numberOfReplicas});
118         ensureGreen("tbl");
119         final String primaryShardNodeId = clusterService().state().routingTable().index("tbl").shard(0).primaryShard().currentNodeId();
120         final String primaryShardNodeName = clusterService().state().nodes().get(primaryShardNodeId).getName();
121         final IndexShard primary = internalCluster()
122             .getInstance(IndicesService.class, primaryShardNodeName)
123 <a name="6"></a>            .getShardOrNull(new ShardId(resolveIndex("tbl"), 0));
124         final int length = randomIntBetween(1, 8);
125         final Map&lt;String, RetentionLease&gt; currentRetentionLeases = new LinkedHashMap&lt;&gt;();
126         for (int i = 0; i &lt; length; i++) <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
127             final String id = randomValueOtherThanMany(currentRetentionLeases.keySet()::contains, () -&gt; randomAlphaOfLength(8));
128             final long retainingSequenceNumber = randomLongBetween(0, Long.MAX_VALUE);
129             final String source = randomAlphaOfLength</b></font>(8);
130             final CountDownLatch latch = new CountDownLatch(1);
131             final ActionListener&lt;ReplicationResponse&gt; listener = countDownLatchListener(latch);
132             final Closeable retentionLock = randomBoolean() ? primary.acquireHistoryRetentionLock(Engine.HistorySource.INDEX) : () -&gt; {};
133             currentRetentionLeases.put(id, primary.addRetentionLease(id, retainingSequenceNumber, source, listener));
134             latch.await();
135             retentionLock.close();
136         }
137         for (int i = 0; i &lt; length; i++) {
138             final String id = randomFrom(currentRetentionLeases.keySet());
139             final CountDownLatch latch = new CountDownLatch(1);
140             primary.removeRetentionLease(id, countDownLatchListener(latch));
141             final Closeable retentionLock = randomBoolean() ? primary.acquireHistoryRetentionLock(Engine.HistorySource.INDEX) : () -&gt; {};
142             currentRetentionLeases.remove(id);
143             latch.await();
144             retentionLock.close();
145             assertThat(currentRetentionLeases,
146                        equalTo(RetentionLeaseUtils.toMapExcludingPeerRecoveryRetentionLeases(primary.loadRetentionLeases())));
147             for (final ShardRouting replicaShard : clusterService().state().routingTable().index("tbl").shard(0).replicaShards()) {
148                 final String replicaShardNodeId = replicaShard.currentNodeId();
149                 final String replicaShardNodeName = clusterService().state().nodes().get(replicaShardNodeId).getName();
150                 final IndexShard replica = internalCluster()
151                     .getInstance(IndicesService.class, replicaShardNodeName)
152                     .getShardOrNull(new ShardId(resolveIndex("tbl"), 0));
153                 final Map&lt;String, RetentionLease&gt; retentionLeasesOnReplica =
154                     RetentionLeaseUtils.toMapExcludingPeerRecoveryRetentionLeases(replica.getRetentionLeases());
155                 assertThat(retentionLeasesOnReplica, equalTo(currentRetentionLeases));
156                 assertThat(currentRetentionLeases,
157 <a name="1"></a>                           equalTo(RetentionLeaseUtils.toMapExcludingPeerRecoveryRetentionLeases(replica.loadRetentionLeases())));
158             }
159         }
160     <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}
161     @Test
162     public void testRetentionLeasesSyncOnExpiration() throws Exception {
163         final int numberOfReplicas = 2 - scaledRandomIntBetween(0, 2);
164         internalCluster().ensureAtLeastNumDataNodes(1 + numberOfReplicas);
165         final long estimatedTimeIntervalMillis = ThreadPool.ESTIMATED_TIME_INTERVAL_SETTING.get(Settings.EMPTY).millis</b></font>();
166         final TimeValue retentionLeaseTimeToLive =
167                 TimeValue.timeValueMillis(randomLongBetween(estimatedTimeIntervalMillis, 2 * estimatedTimeIntervalMillis));
168         execute(
169             "create table doc.tbl (x int) clustered into 1 shards " +
170             "with (" +
171             "   number_of_replicas = ?, " +
172             "   \"soft_deletes.enabled\" = true, " +
173             "   \"soft_deletes.retention_lease.sync_interval\" = ?)",
174             new Object[] {
175                 numberOfReplicas,
176                 retentionLeaseTimeToLive.getStringRep()
177             }
178         );
179         ensureGreen("tbl");
180         final String primaryShardNodeId = clusterService().state().routingTable().index("tbl").shard(0).primaryShard().currentNodeId();
181         final String primaryShardNodeName = clusterService().state().nodes().get(primaryShardNodeId).getName();
182         final IndexShard primary = internalCluster()
183                 .getInstance(IndicesService.class, primaryShardNodeName)
184                 .getShardOrNull(new ShardId(resolveIndex("tbl"), 0));
185         final int length = randomIntBetween(1, 8);
186         for (int i = 0; i &lt; length; i++) {
187             execute("alter table doc.tbl reset (\"soft_deletes.retention_lease.period\")");
188             final String id = randomAlphaOfLength(8);
189             final long retainingSequenceNumber = randomLongBetween(0, Long.MAX_VALUE);
190             final String source = randomAlphaOfLength(8);
191             final CountDownLatch latch = new CountDownLatch(1);
192             final ActionListener&lt;ReplicationResponse&gt; listener = ActionListener.wrap(r -&gt; latch.countDown(), e -&gt; fail(e.toString()));
193             final RetentionLease currentRetentionLease = primary.addRetentionLease(id, retainingSequenceNumber, source, listener);
194             final long now = System.nanoTime();
195             latch.await();
196             for (final ShardRouting replicaShard : clusterService().state().routingTable().index("tbl").shard(0).replicaShards()) {
197                 final String replicaShardNodeId = replicaShard.currentNodeId();
198                 final String replicaShardNodeName = clusterService().state().nodes().get(replicaShardNodeId).getName();
199                 final IndexShard replica = internalCluster()
200                         .getInstance(IndicesService.class, replicaShardNodeName)
201                         .getShardOrNull(new ShardId(resolveIndex("tbl"), 0));
202                 assertThat(RetentionLeaseUtils.toMapExcludingPeerRecoveryRetentionLeases(replica.getRetentionLeases()).values(),
203                     anyOf(empty(), contains(currentRetentionLease)));
204             }
205             execute("alter table doc.tbl set (\"soft_deletes.retention_lease.period\" = ?)", new Object[] { retentionLeaseTimeToLive.getStringRep() });
206             final long later = System.nanoTime();
207             Thread.sleep(Math.max(0, retentionLeaseTimeToLive.millis() - TimeUnit.NANOSECONDS.toMillis(later - now)));
208             assertBusy(() -&gt; assertThat(
209                 RetentionLeaseUtils.toMapExcludingPeerRecoveryRetentionLeases(primary.getRetentionLeases()).entrySet(), empty()));
210             assertBusy(() -&gt; {
211                 for (final ShardRouting replicaShard : clusterService().state().routingTable().index("tbl").shard(0).replicaShards()) {
212                     final String replicaShardNodeId = replicaShard.currentNodeId();
213                     final String replicaShardNodeName = clusterService().state().nodes().get(replicaShardNodeId).getName();
214                     final IndexShard replica = internalCluster()
215                         .getInstance(IndicesService.class, replicaShardNodeName)
216                         .getShardOrNull(new ShardId(resolveIndex("tbl"), 0));
217                     assertThat(
218                         RetentionLeaseUtils.toMapExcludingPeerRecoveryRetentionLeases(replica.getRetentionLeases()).entrySet(), empty());
219 <a name="9"></a>                }
220             });
221         }
222     <font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}
223     @Test
224     public void testBackgroundRetentionLeaseSync() throws Exception {
225         final int numberOfReplicas = 2 - scaledRandomIntBetween(0, 2);
226         internalCluster</b></font>().ensureAtLeastNumDataNodes(1 + numberOfReplicas);
227         execute(
228             "create table doc.tbl (x int) clustered into 1 shards " +
229             "with (" +
230             "   number_of_replicas = ?, " +
231             "   \"soft_deletes.retention_lease.sync_interval\" = '1s')",
232             new Object[] {
233                 numberOfReplicas,
234             }
235         );
236         ensureGreen("tbl");
237         final String primaryShardNodeId = clusterService().state().routingTable().index("tbl").shard(0).primaryShard().currentNodeId();
238         final String primaryShardNodeName = clusterService().state().nodes().get(primaryShardNodeId).getName();
239         final IndexShard primary = internalCluster()
240                 .getInstance(IndicesService.class, primaryShardNodeName)
241                 .getShardOrNull(new ShardId(resolveIndex("tbl"), 0));
242         final int length = randomIntBetween(1, 8);
243         final Map&lt;String, RetentionLease&gt; currentRetentionLeases = new LinkedHashMap&lt;&gt;(length);
244         final List&lt;String&gt; ids = new ArrayList&lt;&gt;(length);
245         for (int i = 0; i &lt; length; i++) {
246             final String id = randomValueOtherThanMany(currentRetentionLeases.keySet()::contains, () -&gt; randomAlphaOfLength(8));
247             ids.add(id);
248             final long retainingSequenceNumber = randomLongBetween(0, Long.MAX_VALUE);
249             final String source = randomAlphaOfLength(8);
250             final CountDownLatch latch = new CountDownLatch(1);
251             currentRetentionLeases.put(
252                     id,
253                     primary.addRetentionLease(id, retainingSequenceNumber, source, ActionListener.wrap(latch::countDown)));
254             latch.await();
255             for (int j = 0; j &lt;= i; j++) {
256                 currentRetentionLeases.put(
257                         ids.get(j),
258                         primary.renewRetentionLease(
259                                 ids.get(j),
260                                 randomLongBetween(currentRetentionLeases.get(ids.get(j)).retainingSequenceNumber(), Long.MAX_VALUE),
261                                 source));
262             }
263             assertBusy(() -&gt; {
264                 for (final ShardRouting replicaShard : clusterService().state().routingTable().index("tbl").shard(0).replicaShards()) {
265                     final String replicaShardNodeId = replicaShard.currentNodeId();
266                     final String replicaShardNodeName = clusterService().state().nodes().get(replicaShardNodeId).getName();
267                     final IndexShard replica = internalCluster()
268                             .getInstance(IndicesService.class, replicaShardNodeName)
269                             .getShardOrNull(new ShardId(resolveIndex("tbl"), 0));
270                     assertThat(replica.getRetentionLeases(), equalTo(primary.getRetentionLeases()));
271 <a name="8"></a>                }
272             });
273         }
274     <font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}
275     @Test
276     public void testRetentionLeasesSyncOnRecovery() throws Exception {
277         final int numberOfReplicas = 2 - scaledRandomIntBetween(0, 2);
278         internalCluster</b></font>().ensureAtLeastNumDataNodes(1 + numberOfReplicas);
279         /*
280          * We effectively disable the background sync to ensure that the retention leases are not synced in the background so that the only
281          * source of retention leases on the replicas would be from recovery.
282          */
283         execute(
284             "create table doc.tbl (x int) clustered into 1 shards " +
285             "with (" +
286             "   number_of_replicas = 0, " +
287             "   \"soft_deletes.enabled\" = true, " +
288             "   \"soft_deletes.retention_lease.sync_interval\" = ?)",
289             new Object[] {
290                 TimeValue.timeValueHours(24).getStringRep()
291             }
292         );
293         allowNodes("tbl", 1);
294         ensureYellow("tbl");
295         execute("alter table doc.tbl set (number_of_replicas = ?)", new Object[] { numberOfReplicas });
296         final String primaryShardNodeId = clusterService().state().routingTable().index("tbl").shard(0).primaryShard().currentNodeId();
297         final String primaryShardNodeName = clusterService().state().nodes().get(primaryShardNodeId).getName();
298         final IndexShard primary = internalCluster()
299             .getInstance(IndicesService.class, primaryShardNodeName)
300             .getShardOrNull(new ShardId(resolveIndex("tbl"), 0));
301         final int length = randomIntBetween(1, 8);
302         final Map&lt;String, RetentionLease&gt; currentRetentionLeases = new HashMap&lt;&gt;();
303         for (int i = 0; i &lt; length; i++) {
304             final String id = randomValueOtherThanMany(currentRetentionLeases.keySet()::contains, () -&gt; randomAlphaOfLength(8));
305             final long retainingSequenceNumber = randomLongBetween(0, Long.MAX_VALUE);
306             final String source = randomAlphaOfLength(8);
307             final CountDownLatch latch = new CountDownLatch(1);
308             final ActionListener&lt;ReplicationResponse&gt; listener = ActionListener.wrap(r -&gt; latch.countDown(), e -&gt; fail(e.toString()));
309             currentRetentionLeases.put(id, primary.addRetentionLease(id, retainingSequenceNumber, source, listener));
310             latch.await();
311         }
312         //
313         execute("set global persistent \"indices.recovery.retry_delay_network\" = '100ms'");
314         final Semaphore recoveriesToDisrupt = new Semaphore(scaledRandomIntBetween(0, 4));
315         final MockTransportService primaryTransportService
316             = (MockTransportService) internalCluster().getInstance(TransportService.class, primaryShardNodeName);
317         primaryTransportService.addSendBehavior((connection, requestId, action, request, options) -&gt; {
318             if (action.equals(PeerRecoveryTargetService.Actions.FINALIZE) &amp;&amp; recoveriesToDisrupt.tryAcquire()) {
319                 if (randomBoolean()) {
320                     final TransportService replicaTransportService
321                         = internalCluster().getInstance(TransportService.class, connection.getNode().getName());
322                     final DiscoveryNode primaryNode = primaryTransportService.getLocalNode();
323                     replicaTransportService.disconnectFromNode(primaryNode);
324                     AbstractSimpleTransportTestCase.connectToNode(replicaTransportService, primaryNode);
325                 } else {
326                     throw new ElasticsearchException("failing recovery for test purposes");
327                 }
328             }
329             connection.sendRequest(requestId, action, request, options);
330         });
331         allowNodes("tbl", 1 + numberOfReplicas);
332         ensureGreen("tbl");
333         for (final ShardRouting replicaShard : clusterService().state().routingTable().index("tbl").shard(0).replicaShards()) {
334             final String replicaShardNodeId = replicaShard.currentNodeId();
335             final String replicaShardNodeName = clusterService().state().nodes().get(replicaShardNodeId).getName();
336             final IndexShard replica = internalCluster()
337                 .getInstance(IndicesService.class, replicaShardNodeName)
338                 .getShardOrNull(new ShardId(resolveIndex("tbl"), 0));
339             final Map&lt;String, RetentionLease&gt; retentionLeasesOnReplica
340                 = RetentionLeaseUtils.toMapExcludingPeerRecoveryRetentionLeases(replica.getRetentionLeases());
341             assertThat(retentionLeasesOnReplica, equalTo(currentRetentionLeases));
342 <a name="4"></a>            assertThat(currentRetentionLeases,
343                 equalTo(RetentionLeaseUtils.toMapExcludingPeerRecoveryRetentionLeases(replica.loadRetentionLeases())));
344         }
345     <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}
346     @Test
347     public void testCanAddRetentionLeaseUnderBlock() throws InterruptedException {
348         final String idForInitialRetentionLease = randomAlphaOfLength(8);
349         runUnderBlockTest(
350                 idForInitialRetentionLease,
351                 randomLongBetween(0, Long.MAX_VALUE),
352                 (primary, listener) </b></font>-&gt; {
353                     final String nextId = randomValueOtherThan(idForInitialRetentionLease, () -&gt; randomAlphaOfLength(8));
354                     final long nextRetainingSequenceNumber = randomLongBetween(0, Long.MAX_VALUE);
355                     final String nextSource = randomAlphaOfLength(8);
356                     primary.addRetentionLease(nextId, nextRetainingSequenceNumber, nextSource, listener);
357                 },
358                 primary -&gt; {});
359     }
360     @Test
361     public void testCanRenewRetentionLeaseUnderBlock() throws InterruptedException {
362         final String idForInitialRetentionLease = randomAlphaOfLength(8);
363         final long initialRetainingSequenceNumber = randomLongBetween(0, Long.MAX_VALUE);
364         final AtomicReference&lt;RetentionLease&gt; retentionLease = new AtomicReference&lt;&gt;();
365         runUnderBlockTest(
366                 idForInitialRetentionLease,
367                 initialRetainingSequenceNumber,
368                 (primary, listener) -&gt; {
369                     final long nextRetainingSequenceNumber = randomLongBetween(initialRetainingSequenceNumber, Long.MAX_VALUE);
370                     final String nextSource = randomAlphaOfLength(8);
371                     retentionLease.set(primary.renewRetentionLease(idForInitialRetentionLease, nextRetainingSequenceNumber, nextSource));
372                     listener.onResponse(new ReplicationResponse());
373                 },
374                 primary -&gt; {
375                     try {
376                         /*
377                          * If the background renew was able to execute, then the retention leases were persisted to disk. There is no other
378                          * way for the current retention leases to end up written to disk so we assume that if they are written to disk, it
379                          * implies that the background sync was able to execute under a block.
380                          */
381                         assertBusy(() -&gt; assertThat(
382                             RetentionLeaseUtils.toMapExcludingPeerRecoveryRetentionLeases(primary.loadRetentionLeases()).values(),
383                             contains(retentionLease.get())));
384                     } catch (final Exception e) {
385                         fail(e.toString());
386                     }
387                 });
388     }
389     public void testCanRemoveRetentionLeasesUnderBlock() throws InterruptedException {
390         final String idForInitialRetentionLease = randomAlphaOfLength(8);
391         runUnderBlockTest(
392                 idForInitialRetentionLease,
393                 randomLongBetween(0, Long.MAX_VALUE),
394                 (primary, listener) -&gt; primary.removeRetentionLease(idForInitialRetentionLease, listener),
395                 indexShard -&gt; {});
396     }
397     private void runUnderBlockTest(
398             final String idForInitialRetentionLease,
399             final long initialRetainingSequenceNumber,
400             final BiConsumer&lt;IndexShard, ActionListener&lt;ReplicationResponse&gt;&gt; primaryConsumer,
401             final Consumer&lt;IndexShard&gt; afterSync) throws InterruptedException {
402         execute(
403             "create table doc.tbl (x int) clustered into 1 shards " +
404             "with (" +
405             "   number_of_replicas = 0, " +
406             "   \"soft_deletes.enabled\" = true, " +
407             "   \"soft_deletes.retention_lease.sync_interval\" = '1s' " +
408             ")"
409         );
410         ensureGreen("tbl");
411         final String primaryShardNodeId = clusterService().state().routingTable().index("tbl").shard(0).primaryShard().currentNodeId();
412         final String primaryShardNodeName = clusterService().state().nodes().get(primaryShardNodeId).getName();
413         final IndexShard primary = internalCluster()
414             .getInstance(IndicesService.class, primaryShardNodeName)
415             .getShardOrNull(new ShardId(resolveIndex("tbl"), 0));
416         final String source = randomAlphaOfLength(8);
417         final CountDownLatch latch = new CountDownLatch(1);
418         final ActionListener&lt;ReplicationResponse&gt; listener = ActionListener.wrap(r -&gt; latch.countDown(), e -&gt; fail(e.toString()));
419         primary.addRetentionLease(idForInitialRetentionLease, initialRetainingSequenceNumber, source, listener);
420         latch.await();
421         final String block = randomFrom("read_only", "read_only_allow_delete", "read", "write", "metadata");
422         execute("alter table doc.tbl set (\"blocks." + block + "\" = true)");
423         try {
424             final CountDownLatch actionLatch = new CountDownLatch(1);
425             final AtomicBoolean success = new AtomicBoolean();
426             primaryConsumer.accept(
427                 primary,
428                 new ActionListener&lt;ReplicationResponse&gt;() {
429                     @Override
430                     public void onResponse(final ReplicationResponse replicationResponse) {
431                         success.set(true);
432                         actionLatch.countDown();
433                     }
434                     @Override
435                     public void onFailure(final Exception e) {
436                         fail(e.toString());
437                     }
438                 }
439             );
440             actionLatch.await();
441             assertTrue(success.get());
442             afterSync.accept(primary);
443 <a name="3"></a>        } finally {
444             execute("alter table doc.tbl reset (\"blocks." + block + "\")");
445         }
446     <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}
447     @Test
448     public void testCanAddRetentionLeaseWithoutWaitingForShards() throws InterruptedException {
449         final String idForInitialRetentionLease = randomAlphaOfLength(8);
450         runWaitForShardsTest(
451                 idForInitialRetentionLease,
452                 randomLongBetween(0, Long.MAX_VALUE),
453                 (primary, listener) </b></font>-&gt; {
454                     final String nextId = randomValueOtherThan(idForInitialRetentionLease, () -&gt; randomAlphaOfLength(8));
455                     final long nextRetainingSequenceNumber = randomLongBetween(0, Long.MAX_VALUE);
456                     final String nextSource = randomAlphaOfLength(8);
457                     primary.addRetentionLease(nextId, nextRetainingSequenceNumber, nextSource, listener);
458                 },
459                 primary -&gt; {});
460     }
461     @Test
462     public void testCanRenewRetentionLeaseWithoutWaitingForShards() throws InterruptedException {
463         final String idForInitialRetentionLease = randomAlphaOfLength(8);
464         final long initialRetainingSequenceNumber = randomLongBetween(0, Long.MAX_VALUE);
465         final AtomicReference&lt;RetentionLease&gt; retentionLease = new AtomicReference&lt;&gt;();
466         runWaitForShardsTest(
467                 idForInitialRetentionLease,
468                 initialRetainingSequenceNumber,
469                 (primary, listener) -&gt; {
470                     final long nextRetainingSequenceNumber = randomLongBetween(initialRetainingSequenceNumber, Long.MAX_VALUE);
471                     final String nextSource = randomAlphaOfLength(8);
472                     retentionLease.set(primary.renewRetentionLease(idForInitialRetentionLease, nextRetainingSequenceNumber, nextSource));
473                     listener.onResponse(new ReplicationResponse());
474                 },
475                 primary -&gt; {
476                     try {
477                         /*
478                          * If the background renew was able to execute, then the retention leases were persisted to disk. There is no other
479                          * way for the current retention leases to end up written to disk so we assume that if they are written to disk, it
480                          * implies that the background sync was able to execute despite wait for shards being set on the index.
481                          */
482                         assertBusy(() -&gt; assertThat(
483                             RetentionLeaseUtils.toMapExcludingPeerRecoveryRetentionLeases(primary.loadRetentionLeases()).values(),
484                             contains(retentionLease.get())));
485                     } catch (final Exception e) {
486                         fail(e.toString());
487 <a name="2"></a>                    }
488                 });
489     <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}
490     @Test
491     public void testCanRemoveRetentionLeasesWithoutWaitingForShards() throws InterruptedException {
492         final String idForInitialRetentionLease = randomAlphaOfLength(8);
493         runWaitForShardsTest(
494                 idForInitialRetentionLease,
495                 randomLongBetween(0, Long.MAX_VALUE),
496                 (primary, listener) </b></font>-&gt; primary.removeRetentionLease(idForInitialRetentionLease, listener),
497                 primary -&gt; {});
498     }
499     private void runWaitForShardsTest(
500             final String idForInitialRetentionLease,
501             final long initialRetainingSequenceNumber,
502             final BiConsumer&lt;IndexShard, ActionListener&lt;ReplicationResponse&gt;&gt; primaryConsumer,
503             final Consumer&lt;IndexShard&gt; afterSync) throws InterruptedException {
504         final int numDataNodes = internalCluster().numDataNodes();
505         execute(
506             "create table doc.tbl (x int) clustered into 1 shards " +
507             "with (" +
508             "   number_of_replicas = ?, " +
509             "   \"soft_deletes.enabled\" = true," +
510             "   \"soft_deletes.retention_lease.sync_interval\" = ?)",
511             new Object[] {
512                 numDataNodes == 1 ? 0 : numDataNodes - 1,
513                 TimeValue.timeValueSeconds(1).getStringRep()
514             }
515         );
516         ensureYellowAndNoInitializingShards("tbl");
517         assertFalse(client().admin().cluster().prepareHealth("tbl").setWaitForActiveShards(numDataNodes).get().isTimedOut());
518         final String primaryShardNodeId = clusterService().state().routingTable().index("tbl").shard(0).primaryShard().currentNodeId();
519         final String primaryShardNodeName = clusterService().state().nodes().get(primaryShardNodeId).getName();
520         final IndexShard primary = internalCluster()
521                 .getInstance(IndicesService.class, primaryShardNodeName)
522                 .getShardOrNull(new ShardId(resolveIndex("tbl"), 0));
523         final String source = randomAlphaOfLength(8);
524         final CountDownLatch latch = new CountDownLatch(1);
525         final ActionListener&lt;ReplicationResponse&gt; listener = ActionListener.wrap(r -&gt; latch.countDown(), e -&gt; fail(e.toString()));
526         primary.addRetentionLease(idForInitialRetentionLease, initialRetainingSequenceNumber, source, listener);
527         latch.await();
528         final String waitForActiveValue = randomBoolean() ? "all" : Integer.toString(numDataNodes);
529         execute("alter table doc.tbl set (\"write.wait_for_active_shards\" = ?)", new Object[] { waitForActiveValue });
530         final CountDownLatch actionLatch = new CountDownLatch(1);
531         final AtomicBoolean success = new AtomicBoolean();
532         primaryConsumer.accept(
533                 primary,
534                 new ActionListener&lt;ReplicationResponse&gt;() {
535                     @Override
536                     public void onResponse(final ReplicationResponse replicationResponse) {
537                         success.set(true);
538                         actionLatch.countDown();
539                     }
540                     @Override
541                     public void onFailure(final Exception e) {
542                         fail(e.toString());
543                     }
544                 });
545         actionLatch.await();
546         assertTrue(success.get());
547         afterSync.accept(primary);
548     }
549     private static void failWithException(Exception e) {
550         throw new AssertionError("unexpected", e);
551     }
552     private static ActionListener&lt;ReplicationResponse&gt; countDownLatchListener(CountDownLatch latch) {
553         return ActionListener.wrap(r -&gt; latch.countDown(), RetentionLeaseIT::failWithException);
554     }
555 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
