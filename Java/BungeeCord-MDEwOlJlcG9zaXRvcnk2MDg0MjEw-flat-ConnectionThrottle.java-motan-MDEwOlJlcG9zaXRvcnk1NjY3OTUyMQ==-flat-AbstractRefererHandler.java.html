
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 6.145251396648044%, Tokens: 11, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>BungeeCord-MDEwOlJlcG9zaXRvcnk2MDg0MjEw-flat-ConnectionThrottle.java</h3>
            <pre><code><span onclick='openModal()' class='match'>1  package net.md_5.bungee;
2  import com.google.common.annotations.VisibleForTesting;
3  import com.google.common.base.Ticker;
4  import com.google.common.cache.CacheBuilder;
5  import com.google.common.cache.CacheLoader;
6  import com.google.common.cache.LoadingCache;
7  import java.net.InetAddress;
8  import java.net.InetSocketAddress;
9  import java.net.SocketAddress;
10  import java.util.concurrent.TimeUnit;
11  import java.util.concurrent.atomic.AtomicInteger;
</span>12  public class ConnectionThrottle
13  {
14      private final LoadingCache<InetAddress, AtomicInteger> throttle;
15      private final int throttleLimit;
16      public ConnectionThrottle(int throttleTime, int throttleLimit)
17      {
18          this( Ticker.systemTicker(), throttleTime, throttleLimit );
19      }
20      @VisibleForTesting
21      ConnectionThrottle(Ticker ticker, int throttleTime, int throttleLimit)
22      {
23          this.throttle = CacheBuilder.newBuilder()
24                  .ticker( ticker )
25                  .concurrencyLevel( Runtime.getRuntime().availableProcessors() )
26                  .initialCapacity( 100 )
27                  .expireAfterWrite( throttleTime, TimeUnit.MILLISECONDS )
28                  .build( new CacheLoader<InetAddress, AtomicInteger>()
29                  {
30                      @Override
31                      public AtomicInteger load(InetAddress key) throws Exception
32                      {
33                          return new AtomicInteger();
34                      }
35                  } );
36          this.throttleLimit = throttleLimit;
37      }
38      public void unthrottle(SocketAddress socketAddress)
39      {
40          if ( !( socketAddress instanceof InetSocketAddress ) )
41          {
42              return;
43          }
44          InetAddress address = ( (InetSocketAddress) socketAddress ).getAddress();
45          AtomicInteger throttleCount = throttle.getIfPresent( address );
46          if ( throttleCount != null )
47          {
48              throttleCount.decrementAndGet();
49          }
50      }
51      public boolean throttle(SocketAddress socketAddress)
52      {
53          if ( !( socketAddress instanceof InetSocketAddress ) )
54          {
55              return false;
56          }
57          InetAddress address = ( (InetSocketAddress) socketAddress ).getAddress();
58          int throttleCount = throttle.getUnchecked( address ).incrementAndGet();
59          return throttleCount > throttleLimit;
60      }
61  }
</code></pre>
        </div>
        <div class="column">
            <h3>motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-AbstractRefererHandler.java</h3>
            <pre><code><span onclick='openModal()' class='match'>1  package com.weibo.api.motan.proxy;
2  import com.weibo.api.motan.cluster.Cluster;
3  import com.weibo.api.motan.common.MotanConstants;
4  import com.weibo.api.motan.common.URLParamType;
5  import com.weibo.api.motan.core.extension.ExtensionLoader;
6  import com.weibo.api.motan.exception.MotanErrorMsgConstant;
7  import com.weibo.api.motan.exception.MotanFrameworkException;
8  import com.weibo.api.motan.exception.MotanServiceException;
9  import com.weibo.api.motan.rpc.*;
10  import com.weibo.api.motan.serialize.DeserializableObject;
11  import com.weibo.api.motan.switcher.Switcher;
</span>12  import com.weibo.api.motan.switcher.SwitcherService;
13  import com.weibo.api.motan.util.*;
14  import org.apache.commons.lang3.StringUtils;
15  import java.io.IOException;
16  import java.lang.reflect.Method;
17  import java.util.HashMap;
18  import java.util.List;
19  import java.util.Map;
20  public class AbstractRefererHandler<T> {
21      protected List<Cluster<T>> clusters;
22      protected Class<T> clz;
23      protected SwitcherService switcherService = null;
24      protected String interfaceName;
25      void init() {
26          String switchName = this.clusters.get(0).getUrl().getParameter(URLParamType.switcherService.getName(), URLParamType.switcherService.getValue());
27          switcherService = ExtensionLoader.getExtensionLoader(SwitcherService.class).getExtension(switchName);
28      }
29      Object invokeRequest(Request request, Class<?> returnType, boolean async) throws Throwable {
30          fillWithContext(request, async);
31          for (Cluster<T> cluster : clusters) {
32              String protocolSwitcher = MotanConstants.PROTOCOL_SWITCHER_PREFIX + cluster.getUrl().getProtocol();
33              Switcher switcher = switcherService.getSwitcher(protocolSwitcher);
34              if (switcher != null && !switcher.isOn()) {
35                  continue;
36              }
37              request.setAttachment(URLParamType.version.getName(), cluster.getUrl().getVersion());
38              request.setAttachment(URLParamType.clientGroup.getName(), cluster.getUrl().getGroup());
39              request.setAttachment(URLParamType.application.getName(), cluster.getUrl().getApplication());
40              request.setAttachment(URLParamType.module.getName(), cluster.getUrl().getModule());
41              return call(cluster, cluster.getUrl(), request, returnType, async);
42          }
43          throw new MotanServiceException("Referer call Error: cluster not exist, interface=" + interfaceName + " " + MotanFrameworkUtil.toString(request), MotanErrorMsgConstant.SERVICE_UNFOUND, false);
44      }
45      protected Object call(Caller<T> caller, URL refUrl, Request request, Class<?> returnType, boolean async) throws Throwable {
46          Response response;
47          boolean throwException = Boolean.parseBoolean(refUrl.getParameter(URLParamType.throwException.getName(), URLParamType.throwException.getValue()));
48          try {
49              MotanFrameworkUtil.logEvent(request, MotanConstants.TRACE_INVOKE);
50              response = caller.call(request);
51              if (async) {
52                  if (response instanceof ResponseFuture) {
53                      ((ResponseFuture) response).setReturnType(returnType);
54                      return response;
55                  } else {
56                      ResponseFuture responseFuture = new DefaultResponseFuture(request, 0, refUrl);
57                      if (response.getException() != null) {
58                          responseFuture.onFailure(response);
59                      } else {
60                          responseFuture.onSuccess(response);
61                      }
62                      responseFuture.setReturnType(returnType);
63                      return responseFuture;
64                  }
65              } else {
66                  Object value = response.getValue();
67                  if (value instanceof DeserializableObject) {
68                      try {
69                          value = ((DeserializableObject) value).deserialize(returnType);
70                      } catch (IOException e) {
71                          LoggerUtil.error("deserialize response value fail! deserialize type:" + returnType, e);
72                          throw new MotanFrameworkException("deserialize return value fail! deserialize type:" + returnType, e);
73                      }
74                  }
75                  return value;
76              }
77          } catch (RuntimeException e) {
78              if (ExceptionUtil.isBizException(e)) {
79                  Throwable t = e.getCause();
80                  if (t instanceof Exception) {
81                      throw t;
82                  } else {
83                      String msg = t == null ? "biz exception cause is null. origin error msg : " + e.getMessage() : ("biz exception cause is throwable error:" + t.getClass() + ", errMsg:" + t.getMessage());
84                      throw new MotanServiceException(msg);
85                  }
86              } else if (!throwException) {
87                  LoggerUtil.warn("RefererInvocationHandler invoke false, so return default value: uri=" + refUrl.getUri() + " " + MotanFrameworkUtil.toString(request), e);
88                  return getDefaultReturnValue(returnType);
89              } else {
90                  LoggerUtil.error("RefererInvocationHandler invoke Error: uri=" + refUrl.getUri() + " " + MotanFrameworkUtil.toString(request), e);
91                  throw e;
92              }
93          }
94      }
95      protected boolean isLocalMethod(Method method) {
96          if (method.getDeclaringClass().equals(Object.class)) {
97              try {
98                  clz.getDeclaredMethod(method.getName(), method.getParameterTypes());
99                  return false;
100              } catch (Exception e) {
101                  return true;
102              }
103          }
104          return false;
105      }
106      protected boolean fillDefaultRequest(DefaultRequest request, Method method, Object[] args) {
107          request.setRequestId(RequestIdGenerator.getRequestId());
108          request.setArguments(args);
109          String methodName = method.getName();
110          boolean async = false;
111          if (methodName.endsWith(MotanConstants.ASYNC_SUFFIX) && method.getReturnType().equals(ResponseFuture.class)) {
112              methodName = MotanFrameworkUtil.removeAsyncSuffix(methodName);
113              async = true;
114          }
115          request.setMethodName(methodName);
116          request.setParamtersDesc(ReflectUtil.getMethodParamDesc(method));
117          request.setInterfaceName(interfaceName);
118          return async;
119      }
120      protected Class<?> getRealReturnType(boolean asyncCall, Class<?> clazz, Method method, String methodName) {
121          if (asyncCall) {
122              try {
123                  Method m = clazz.getMethod(methodName, method.getParameterTypes());
124                  return m.getReturnType();
125              } catch (Exception e) {
126                  LoggerUtil.warn("RefererInvocationHandler get real return type fail. err:" + e.getMessage());
127                  return method.getReturnType();
128              }
129          } else {
130              return method.getReturnType();
131          }
132      }
133      protected void fillWithContext(Request request, boolean async) {
134          RpcContext curContext = RpcContext.getContext();
135          curContext.putAttribute(MotanConstants.ASYNC_SUFFIX, async);
136          Map<String, String> attachments = curContext.getRpcAttachments();
137          if (!attachments.isEmpty()) {
138              for (Map.Entry<String, String> entry : attachments.entrySet()) {
139                  request.setAttachment(entry.getKey(), entry.getValue());
140              }
141          }
142          if (StringUtils.isNotBlank(curContext.getClientRequestId())) {
143              request.setAttachment(URLParamType.requestIdFromClient.getName(), curContext.getClientRequestId());
144          }
145      }
146      protected Object getDefaultReturnValue(Class<?> returnType) {
147          if (returnType != null && returnType.isPrimitive()) {
148              return PrimitiveDefault.getDefaultReturnValue(returnType);
149          }
150          return null;
151      }
152      private static class PrimitiveDefault {
153          private static boolean defaultBoolean;
154          private static char defaultChar;
155          private static byte defaultByte;
156          private static short defaultShort;
157          private static int defaultInt;
158          private static long defaultLong;
159          private static float defaultFloat;
160          private static double defaultDouble;
161          private static final Map<Class<?>, Object> primitiveValues = new HashMap<>();
162          static {
163              primitiveValues.put(boolean.class, defaultBoolean);
164              primitiveValues.put(char.class, defaultChar);
165              primitiveValues.put(byte.class, defaultByte);
166              primitiveValues.put(short.class, defaultShort);
167              primitiveValues.put(int.class, defaultInt);
168              primitiveValues.put(long.class, defaultLong);
169              primitiveValues.put(float.class, defaultFloat);
170              primitiveValues.put(double.class, defaultDouble);
171          }
172          public static Object getDefaultReturnValue(Class<?> returnType) {
173              return primitiveValues.get(returnType);
174          }
175      }
176  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from BungeeCord-MDEwOlJlcG9zaXRvcnk2MDg0MjEw-flat-ConnectionThrottle.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-AbstractRefererHandler.java</div>
                </div>
                <div class="column column_space"><pre><code>1  package net.md_5.bungee;
2  import com.google.common.annotations.VisibleForTesting;
3  import com.google.common.base.Ticker;
4  import com.google.common.cache.CacheBuilder;
5  import com.google.common.cache.CacheLoader;
6  import com.google.common.cache.LoadingCache;
7  import java.net.InetAddress;
8  import java.net.InetSocketAddress;
9  import java.net.SocketAddress;
10  import java.util.concurrent.TimeUnit;
11  import java.util.concurrent.atomic.AtomicInteger;
</pre></code></div>
                <div class="column column_space"><pre><code>1  package com.weibo.api.motan.proxy;
2  import com.weibo.api.motan.cluster.Cluster;
3  import com.weibo.api.motan.common.MotanConstants;
4  import com.weibo.api.motan.common.URLParamType;
5  import com.weibo.api.motan.core.extension.ExtensionLoader;
6  import com.weibo.api.motan.exception.MotanErrorMsgConstant;
7  import com.weibo.api.motan.exception.MotanFrameworkException;
8  import com.weibo.api.motan.exception.MotanServiceException;
9  import com.weibo.api.motan.rpc.*;
10  import com.weibo.api.motan.serialize.DeserializableObject;
11  import com.weibo.api.motan.switcher.Switcher;
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    