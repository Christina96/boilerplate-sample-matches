
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 7.3131955484896665%, Tokens: 12</h2>
        <div class="column">
            <h3>Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-EssentialsChatPlayerListenerLowest.java</h3>
            <pre><code>1  package com.earth2me.essentials.chat;
2  import com.earth2me.essentials.User;
3  import com.earth2me.essentials.utils.FormatUtil;
4  import net.ess3.api.IEssentials;
5  import java.util.Locale;
6  import java.util.Map;
7  import org.bukkit.Server;
8  import org.bukkit.event.EventHandler;
9  import org.bukkit.event.EventPriority;
10  import org.bukkit.event.player.AsyncPlayerChatEvent;
11  import org.bukkit.scoreboard.Team;
12  public class EssentialsChatPlayerListenerLowest extends EssentialsChatPlayer
13  {
14  	public EssentialsChatPlayerListenerLowest(final Server server,
15  											  final IEssentials ess,
16  											  final Map<AsyncPlayerChatEvent, ChatStore> chatStorage)
17  	{
18  		super(server, ess, chatStorage);
19  	}
20  	@EventHandler(priority = EventPriority.LOWEST)
21  	@Override
22  	public void onPlayerChat(final AsyncPlayerChatEvent event)
23  	{
24  		if (isAborted(event))
25  		{
26  			return;
27  		}
28  		final User user = ess.getUser(event.getPlayer());
29  		if (user == null)
30  		{
31  			event.setCancelled(true);
32  			return;
33  		}
<span onclick='openModal()' class='match'>34  		final ChatStore chatStore = new ChatStore(ess, user, getChatType(event.getMessage()));
35  		setChatStore(event, chatStore);
36  		event.setMessage(FormatUtil.formatMessage(user, "essentials.chat", event.getMessage()));
37  		String group = user.getGroup();
38  		String world = user.getWorld().getName();
</span>39  		Team team = user.getBase().getScoreboard().getPlayerTeam(user.getBase());
40  		String format = ess.getSettings().getChatFormat(group);
41  		format = format.replace("{0}", group);
42  		format = format.replace("{1}", world);
43  		format = format.replace("{2}", world.substring(0, 1).toUpperCase(Locale.ENGLISH));
44  		format = format.replace("{3}", team == null ? "" : team.getPrefix());
45  		format = format.replace("{4}", team == null ? "" : team.getSuffix());
46  		format = format.replace("{5}", team == null ? "" : team.getDisplayName());
47  		synchronized (format)
48  		{
49  			event.setFormat(format);
50  		}
51  	}
52  }
</code></pre>
        </div>
        <div class="column">
            <h3>Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-Metrics.java</h3>
            <pre><code>1  package com.earth2me.essentials.metrics;
2  import com.earth2me.essentials.IEssentials;
3  import java.io.*;
4  import java.net.Proxy;
5  import java.net.URL;
6  import java.net.URLConnection;
7  import java.net.URLEncoder;
8  import java.util.*;
9  import java.util.logging.Level;
10  import java.util.zip.GZIPOutputStream;
11  import org.bukkit.Bukkit;
12  import org.bukkit.configuration.InvalidConfigurationException;
13  import org.bukkit.configuration.file.YamlConfiguration;
14  import org.bukkit.plugin.Plugin;
15  import org.bukkit.plugin.PluginDescriptionFile;
16  import org.bukkit.scheduler.BukkitTask;
17  public class Metrics
18  {
19  	private static final int REVISION = 7;
20  	private static final String BASE_URL = "http:&bsol;&bsol;report-metrics.essentials3.net";
21  	private static final String REPORT_URL = "/plugin/%s";
22  	private static final int PING_INTERVAL = 15;
23  	private final Plugin plugin;
24  	private final Set<Graph> graphs = Collections.synchronizedSet(new HashSet<Graph>());
25  	private final YamlConfiguration configuration;
26  	private final File configurationFile;
27  	private final String guid;
28  	private final boolean debug;
29  	private final Object optOutLock = new Object();
30  	private volatile BukkitTask task = null;
31  	public Metrics(final Plugin plugin) throws IOException
32  	{
33  		if (plugin == null)
34  		{
35  			throw new IllegalArgumentException("Plugin cannot be null");
36  		}
37  		this.plugin = plugin;
38  		configurationFile = getConfigFile();
39  		configuration = YamlConfiguration.loadConfiguration(configurationFile);
40  		configuration.addDefault("opt-out", false);
41  		configuration.addDefault("guid", UUID.randomUUID().toString());
42  		configuration.addDefault("debug", false);
43  		if (configuration.get("guid", null) == null)
44  		{
45  			configuration.options().header("http:&bsol;&bsol;mcstats.org").copyDefaults(true);
46  			configuration.save(configurationFile);
47  		}
48  		guid = configuration.getString("guid");
49  		debug = configuration.getBoolean("debug", false);
50  	}
51  	public Graph createGraph(final String name)
52  	{
53  		if (name == null)
54  		{
55  			throw new IllegalArgumentException("Graph name cannot be null");
56  		}
57  		final Graph graph = new Graph(name);
58  		graphs.add(graph);
59  		return graph;
60  	}
61  	public void addGraph(final Graph graph)
62  	{
63  		if (graph == null)
64  		{
65  			throw new IllegalArgumentException("Graph cannot be null");
66  		}
67  		graphs.add(graph);
68  	}
69  	public void start()
70  	{
71  		synchronized (optOutLock)
72  		{
73  			if (isOptOut())
74  			{
75  				return;
76  			}
77  			if (task != null)
78  			{
79  				return;
80  			}
81  			task = plugin.getServer().getScheduler().runTaskTimerAsynchronously(plugin, new Runnable()
82  			{
83  				private boolean firstPost = true;
84  				public void run()
85  				{
86  					try
87  					{
88  						synchronized (optOutLock)
89  						{
90  							if (isOptOut() && task != null)
91  							{
92  								task.cancel();
93  								task = null;
94  								for (Graph graph : graphs)
95  								{
96  									graph.onOptOut();
97  								}
98  							}
99  						}
100  						postPlugin(!firstPost);
101  						firstPost = false;
102  					}
103  					catch (IOException e)
104  					{
105  						if (debug)
106  						{
107  							Bukkit.getLogger().log(Level.INFO, "[Metrics] " + e.getMessage());
108  						}
109  					}
110  				}
111  			}, 0, PING_INTERVAL * 1200);
112  		}
113  	}
114  	public boolean isOptOut()
115  	{
116  		synchronized (optOutLock)
117  		{
118  			try
119  			{
120  				configuration.load(getConfigFile());
121  			}
122  			catch (IOException ex)
123  			{
124  				if (debug)
125  				{
126  					Bukkit.getLogger().log(Level.INFO, "[Metrics] " + ex.getMessage());
127  				}
128  				return true;
129  			}
130  			catch (InvalidConfigurationException ex)
131  			{
132  				if (debug)
133  				{
134  					Bukkit.getLogger().log(Level.INFO, "[Metrics] " + ex.getMessage());
135  				}
136  				return true;
137  			}
138  			return configuration.getBoolean("opt-out", false);
139  		}
140  	}
141  	public void enable() throws IOException
142  	{
143  		synchronized (optOutLock)
144  		{
145  			if (isOptOut())
146  			{
147  				configuration.set("opt-out", false);
148  				configuration.save(configurationFile);
149  			}
150  			if (task == null)
151  			{
152  				start();
153  			}
154  		}
155  	}
156  	public void disable() throws IOException
157  	{
158  		synchronized (optOutLock)
159  		{
160  			if (!isOptOut())
161  			{
162  				configuration.set("opt-out", true);
163  				configuration.save(configurationFile);
164  			}
165  			if (task != null)
166  			{
167  				task.cancel();
168  				task = null;
169  			}
170  		}
171  	}
172  	public File getConfigFile()
173  	{
174  		File pluginsFolder = plugin.getDataFolder().getParentFile();
175  		return new File(new File(pluginsFolder, "PluginMetrics"), "config.yml");
176  	}
177  	private void postPlugin(final boolean isPing) throws IOException
178  	{
179  		PluginDescriptionFile description = plugin.getDescription();
180  		String pluginName = description.getName();
181  		boolean onlineMode = Bukkit.getServer().getOnlineMode(); 
182  		String pluginVersion = description.getVersion();
183  		String serverVersion = Bukkit.getVersion();
184  		int playersOnline = ((IEssentials)plugin).getOnlinePlayers().size();
<span onclick='openModal()' class='match'>185  		StringBuilder json = new StringBuilder(1024);
186  		json.append('{');
187  		appendJSONPair(json, "guid", guid);
188  		appendJSONPair(json, "plugin_version", pluginVersion);
189  		appendJSONPair(json, "server_version", serverVersion);
190  		appendJSONPair(json, "players_online", Integer.toString(playersOnline));
191  		String osname = System.getProperty("os.name");
192  		String osarch = System.getProperty("os.arch");
</span>193  		String osversion = System.getProperty("os.version");
194  		String java_version = System.getProperty("java.version");
195  		int coreCount = Runtime.getRuntime().availableProcessors();
196  		if (osarch.equals("amd64"))
197  		{
198  			osarch = "x86_64";
199  		}
200  		appendJSONPair(json, "osname", osname);
201  		appendJSONPair(json, "osarch", osarch);
202  		appendJSONPair(json, "osversion", osversion);
203  		appendJSONPair(json, "cores", Integer.toString(coreCount));
204  		appendJSONPair(json, "auth_mode", onlineMode ? "1" : "0");
205  		appendJSONPair(json, "java_version", java_version);
206  		if (isPing)
207  		{
208  			appendJSONPair(json, "ping", "1");
209  		}
210  		if (graphs.size() > 0)
211  		{
212  			synchronized (graphs)
213  			{
214  				json.append(',');
215  				json.append('"');
216  				json.append("graphs");
217  				json.append('"');
218  				json.append(':');
219  				json.append('{');
220  				boolean firstGraph = true;
221  				final Iterator<Graph> iter = graphs.iterator();
222  				while (iter.hasNext())
223  				{
224  					Graph graph = iter.next();
225  					StringBuilder graphJson = new StringBuilder();
226  					graphJson.append('{');
227  					for (Plotter plotter : graph.getPlotters())
228  					{
229  						appendJSONPair(graphJson, plotter.getColumnName(), Integer.toString(plotter.getValue()));
230  					}
231  					graphJson.append('}');
232  					if (!firstGraph)
233  					{
234  						json.append(',');
235  					}
236  					json.append(escapeJSON(graph.getName()));
237  					json.append(':');
238  					json.append(graphJson);
239  					firstGraph = false;
240  				}
241  				json.append('}');
242  			}
243  		}
244  		json.append('}');
245  		URL url = new URL(BASE_URL + String.format(REPORT_URL, urlEncode(pluginName)));
246  		URLConnection connection;
247  		if (isMineshafterPresent())
248  		{
249  			connection = url.openConnection(Proxy.NO_PROXY);
250  		}
251  		else
252  		{
253  			connection = url.openConnection();
254  		}
255  		byte[] uncompressed = json.toString().getBytes();
256  		byte[] compressed = gzip(json.toString());
257  		connection.addRequestProperty("User-Agent", "MCStats/" + REVISION);
258  		connection.addRequestProperty("Content-Type", "application/json");
259  		connection.addRequestProperty("Content-Encoding", "gzip");
260  		connection.addRequestProperty("Content-Length", Integer.toString(compressed.length));
261  		connection.addRequestProperty("Accept", "application/json");
262  		connection.addRequestProperty("Connection", "close");
263  		connection.setDoOutput(true);
264  		if (debug)
265  		{
266  			System.out.println("[Metrics] Prepared request for " + pluginName + " uncompressed=" + uncompressed.length + " compressed=" + compressed.length);
267  		}
268  		OutputStream os = connection.getOutputStream();
269  		os.write(compressed);
270  		os.flush();
271  		final BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream()));
272  		String response = reader.readLine();
273  		os.close();
274  		reader.close();
275  		if (response == null || response.startsWith("ERR") || response.startsWith("7"))
276  		{
277  			if (response == null)
278  			{
279  				response = "null";
280  			}
281  			else if (response.startsWith("7"))
282  			{
283  				response = response.substring(response.startsWith("7,") ? 2 : 1);
284  			}
285  			throw new IOException(response);
286  		}
287  		else
288  		{
289  			if (response.equals("1") || response.contains("This is your first update this hour"))
290  			{
291  				synchronized (graphs)
292  				{
293  					final Iterator<Graph> iter = graphs.iterator();
294  					while (iter.hasNext())
295  					{
296  						final Graph graph = iter.next();
297  						for (Plotter plotter : graph.getPlotters())
298  						{
299  							plotter.reset();
300  						}
301  					}
302  				}
303  			}
304  		}
305  	}
306  	public static byte[] gzip(String input)
307  	{
308  		ByteArrayOutputStream baos = new ByteArrayOutputStream();
309  		GZIPOutputStream gzos = null;
310  		try
311  		{
312  			gzos = new GZIPOutputStream(baos);
313  			gzos.write(input.getBytes("UTF-8"));
314  		}
315  		catch (IOException e)
316  		{
317  			e.printStackTrace();
318  		}
319  		finally
320  		{
321  			if (gzos != null)
322  			{
323  				try
324  				{
325  					gzos.close();
326  				}
327  				catch (IOException ignore)
328  				{
329  				}
330  			}
331  		}
332  		return baos.toByteArray();
333  	}
334  	private boolean isMineshafterPresent()
335  	{
336  		try
337  		{
338  			Class.forName("mineshafter.MineServer");
339  			return true;
340  		}
341  		catch (Exception e)
342  		{
343  			return false;
344  		}
345  	}
346  	private static void appendJSONPair(StringBuilder json, String key, String value) throws UnsupportedEncodingException
347  	{
348  		boolean isValueNumeric;
349  		try
350  		{
351  			Double.parseDouble(value);
352  			isValueNumeric = true;
353  		}
354  		catch (NumberFormatException e)
355  		{
356  			isValueNumeric = false;
357  		}
358  		if (json.charAt(json.length() - 1) != '{')
359  		{
360  			json.append(',');
361  		}
362  		json.append(escapeJSON(key));
363  		json.append(':');
364  		if (isValueNumeric)
365  		{
366  			json.append(value);
367  		}
368  		else
369  		{
370  			json.append(escapeJSON(value));
371  		}
372  	}
373  	private static String escapeJSON(String text)
374  	{
375  		StringBuilder builder = new StringBuilder();
376  		builder.append('"');
377  		for (int index = 0; index < text.length(); index++)
378  		{
379  			char chr = text.charAt(index);
380  			switch (chr)
381  			{
382  			case '"':
383  			case '\\':
384  				builder.append('\\');
385  				builder.append(chr);
386  				break;
387  			case '\b':
388  				builder.append("\\b");
389  				break;
390  			case '\t':
391  				builder.append("\\t");
392  				break;
393  			case '\n':
394  				builder.append("\\n");
395  				break;
396  			case '\r':
397  				builder.append("\\r");
398  				break;
399  			default:
400  				if (chr < ' ')
401  				{
402  					String t = "000" + Integer.toHexString(chr);
403  					builder.append("\\u" + t.substring(t.length() - 4));
404  				}
405  				else
406  				{
407  					builder.append(chr);
408  				}
409  				break;
410  			}
411  		}
412  		builder.append('"');
413  		return builder.toString();
414  	}
415  	private static String urlEncode(final String text) throws UnsupportedEncodingException
416  	{
417  		return URLEncoder.encode(text, "UTF-8");
418  	}
419  	public static class Graph
420  	{
421  		private final String name;
422  		private final Set<Plotter> plotters = new LinkedHashSet<Plotter>();
423  		private Graph(final String name)
424  		{
425  			this.name = name;
426  		}
427  		public String getName()
428  		{
429  			return name;
430  		}
431  		public void addPlotter(final Plotter plotter)
432  		{
433  			plotters.add(plotter);
434  		}
435  		public void removePlotter(final Plotter plotter)
436  		{
437  			plotters.remove(plotter);
438  		}
439  		public Set<Plotter> getPlotters()
440  		{
441  			return Collections.unmodifiableSet(plotters);
442  		}
443  		@Override
444  		public int hashCode()
445  		{
446  			return name.hashCode();
447  		}
448  		@Override
449  		public boolean equals(final Object object)
450  		{
451  			if (!(object instanceof Graph))
452  			{
453  				return false;
454  			}
455  			final Graph graph = (Graph)object;
456  			return graph.name.equals(name);
457  		}
458  		protected void onOptOut()
459  		{
460  		}
461  	}
462  	public static abstract class Plotter
463  	{
464  		private final String name;
465  		public Plotter()
466  		{
467  			this("Default");
468  		}
469  		public Plotter(final String name)
470  		{
471  			this.name = name;
472  		}
473  		public abstract int getValue();
474  		public String getColumnName()
475  		{
476  			return name;
477  		}
478  		public void reset()
479  		{
480  		}
481  		@Override
482  		public int hashCode()
483  		{
484  			return getColumnName().hashCode();
485  		}
486  		@Override
487  		public boolean equals(final Object object)
488  		{
489  			if (!(object instanceof Plotter))
490  			{
491  				return false;
492  			}
493  			final Plotter plotter = (Plotter)object;
494  			return plotter.name.equals(name) && plotter.getValue() == getValue();
495  		}
496  	}
497  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-EssentialsChatPlayerListenerLowest.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-Metrics.java</div>
                </div>
                <div class="column column_space"><pre><code>34  		final ChatStore chatStore = new ChatStore(ess, user, getChatType(event.getMessage()));
35  		setChatStore(event, chatStore);
36  		event.setMessage(FormatUtil.formatMessage(user, "essentials.chat", event.getMessage()));
37  		String group = user.getGroup();
38  		String world = user.getWorld().getName();
</pre></code></div>
                <div class="column column_space"><pre><code>185  		StringBuilder json = new StringBuilder(1024);
186  		json.append('{');
187  		appendJSONPair(json, "guid", guid);
188  		appendJSONPair(json, "plugin_version", pluginVersion);
189  		appendJSONPair(json, "server_version", serverVersion);
190  		appendJSONPair(json, "players_online", Integer.toString(playersOnline));
191  		String osname = System.getProperty("os.name");
192  		String osarch = System.getProperty("os.arch");
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    