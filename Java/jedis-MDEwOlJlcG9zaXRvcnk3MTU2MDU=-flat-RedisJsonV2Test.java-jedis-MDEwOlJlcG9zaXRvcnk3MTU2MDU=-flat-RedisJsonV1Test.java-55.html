
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 29, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-RedisJsonV2Test.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.json;
2  import static java.util.Collections.singletonList;
3  import static org.junit.Assert.*;
4  import static redis.clients.jedis.json.Path2.ROOT_PATH;
5  import static redis.clients.jedis.modules.json.JsonObjects.*;
6  import com.google.gson.Gson;
7  import java.util.Arrays;
8  import java.util.Collections;
9  import java.util.List;
10  import org.hamcrest.MatcherAssert;
11  import org.hamcrest.Matchers;
12  import org.json.JSONArray;
13  import org.json.JSONObject;
14  import org.junit.Before;
15  import org.junit.BeforeClass;
16  import org.junit.Test;
17  import redis.clients.jedis.exceptions.JedisDataException;
18  import redis.clients.jedis.json.JsonSetParams;
19  import redis.clients.jedis.json.Path2;
20  import redis.clients.jedis.json.commands.RedisJsonV2Commands;
21  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
22  public class RedisJsonV2Test extends RedisModuleCommandsTestBase {
23    private static final Gson gson = new Gson();
24    private RedisJsonV2Commands jsonClient;
25    @BeforeClass
26    public static void prepare() {
27      RedisModuleCommandsTestBase.prepare();
28    }
29    @Before
30    @Override
31    public void setUp() {
32      super.setUp();
33      this.jsonClient = super.client;
34    }
35    @Test
36    public void basicSetGetShouldSucceed() {
37      jsonClient.jsonSetWithEscape(&quot;null&quot;, ROOT_PATH, (Object) null);
38      assertJsonArrayEquals(jsonArray((Object) null), jsonClient.jsonGet(&quot;null&quot;, ROOT_PATH));
39      jsonClient.jsonSetWithEscape(&quot;str&quot;, &quot;strong&quot;);
40      assertEquals(&quot;strong&quot;, jsonClient.jsonGet(&quot;str&quot;));
41      IRLObject obj = new IRLObject();
42      jsonClient.jsonSetWithEscape(&quot;obj&quot;, obj);
43      Object expected = gson.fromJson(gson.toJson(obj), Object.class);
44      assertTrue(expected.equals(jsonClient.jsonGet(&quot;obj&quot;)));
45      Path2 p = Path2.of(&quot;.str&quot;);
46      jsonClient.jsonSet(&quot;obj&quot;, p, gson.toJson(&quot;strung&quot;));
47      assertJsonArrayEquals(jsonArray(&quot;strung&quot;), jsonClient.jsonGet(&quot;obj&quot;, p));
48    }
49    @Test
50    public void setExistingPathOnlyIfExistsShouldSucceed() {
51      jsonClient.jsonSetWithEscape(&quot;obj&quot;, new IRLObject());
52      Path2 p = Path2.of(&quot;.str&quot;);
53      jsonClient.jsonSetWithEscape(&quot;obj&quot;, p, &quot;strangle&quot;, JsonSetParams.jsonSetParams().xx());
54      assertJsonArrayEquals(jsonArray(&quot;strangle&quot;), jsonClient.jsonGet(&quot;obj&quot;, p));
55    }
56    @Test
57    public void setNonExistingOnlyIfNotExistsShouldSucceed() {
58      jsonClient.jsonSet(&quot;obj&quot;, gson.toJson(new IRLObject()));
59      Path2 p = Path2.of(&quot;.none&quot;);
60      jsonClient.jsonSet(&quot;obj&quot;, p, gson.toJson(&quot;strangle&quot;), JsonSetParams.jsonSetParams().nx());
61      assertJsonArrayEquals(jsonArray(&quot;strangle&quot;), jsonClient.jsonGet(&quot;obj&quot;, p));
62    }
63    @Test
64    public void setWithoutAPathDefaultsToRootPath() {
65      String objStr = gson.toJson(new IRLObject());
66      jsonClient.jsonSet(&quot;obj1&quot;, new JSONObject(objStr));
67      jsonClient.jsonSetWithEscape(&quot;obj1&quot;, (Object) &quot;strangle&quot;, JsonSetParams.jsonSetParams().xx());
68      assertJsonArrayEquals(jsonArray(&quot;strangle&quot;), jsonClient.jsonGet(&quot;obj1&quot;, ROOT_PATH));
69    }
70    @Test
71    public void setExistingPathOnlyIfNotExistsShouldFail() {
72      jsonClient.jsonSetWithEscape(&quot;obj&quot;, new IRLObject());
73      Path2 p = Path2.of(&quot;.str&quot;);
74      assertNull(jsonClient.jsonSetWithEscape(&quot;obj&quot;, p, &quot;strangle&quot;, JsonSetParams.jsonSetParams().nx()));
75    }
76    @Test
77    public void setNonExistingPathOnlyIfExistsShouldFail() {
78      jsonClient.jsonSetWithEscape(&quot;obj&quot;, new IRLObject());
79      Path2 p = Path2.of(&quot;.none&quot;);
80      assertNull(jsonClient.jsonSetWithEscape(&quot;obj&quot;, p, &quot;strangle&quot;, JsonSetParams.jsonSetParams().xx()));
81    }
82    @Test(expected = JedisDataException.class)
83    public void setException() {
84      jsonClient.jsonSet(&quot;test&quot;, Path2.of(&quot;.foo&quot;), &quot;bar&quot;);
85    }
86    @Test
87    public void getMultiplePathsShouldSucceed() {
88      IRLObject obj = new IRLObject();
89      jsonClient.jsonSetWithEscape(&quot;obj&quot;, obj);
90      JSONObject result = (JSONObject) jsonClient.jsonGet(&quot;obj&quot;, Path2.of(&quot;bool&quot;), Path2.of(&quot;str&quot;));
91      assertJsonArrayEquals(jsonArray(true), result.get(&quot;$.bool&quot;));
92      assertJsonArrayEquals(jsonArray(&quot;string&quot;), result.get(&quot;$.str&quot;));
93    }
94    @Test
95    public void getMultiLevels() {
96      JSONObject obj = new JSONObject();
97      obj.put(&quot;foo&quot;, &quot;John&quot;);
98      JSONObject inner = new JSONObject();
99      inner.put(&quot;foo&quot;, &quot;Jane&quot;);
100      obj.put(&quot;bar&quot;, inner);
101      jsonClient.jsonSet(&quot;multi&quot;, obj);
102      assertJsonArrayEquals(jsonArray(&quot;John&quot;, &quot;Jane&quot;), jsonClient.jsonGet(&quot;multi&quot;, new Path2(&quot;..foo&quot;)));
103    }
104    @Test
105    public void toggle() {
106      IRLObject obj = new IRLObject();
107      jsonClient.jsonSetWithEscape(&quot;obj&quot;, obj);
108      Path2 pbool = Path2.of(&quot;.bool&quot;);
109      assertJsonArrayEquals(jsonArray(true), jsonClient.jsonGet(&quot;obj&quot;, pbool));
110      jsonClient.jsonToggle(&quot;obj&quot;, pbool);
111      assertJsonArrayEquals(jsonArray(false), jsonClient.jsonGet(&quot;obj&quot;, pbool));
112      jsonClient.jsonToggle(&quot;obj&quot;, pbool);
113      assertJsonArrayEquals(jsonArray(true), jsonClient.jsonGet(&quot;obj&quot;, pbool));
114      Path2 pstr = Path2.of(&quot;.str&quot;);
115      assertEquals(singletonList(null), jsonClient.jsonToggle(&quot;obj&quot;, pstr));
116      assertJsonArrayEquals(jsonArray(&quot;string&quot;), jsonClient.jsonGet(&quot;obj&quot;, pstr));
117    }
118    @Test
119    public void getAbsent() {
120      jsonClient.jsonSetWithEscape(&quot;test&quot;, ROOT_PATH, &quot;foo&quot;);
121      assertJsonArrayEquals(jsonArray(), jsonClient.jsonGet(&quot;test&quot;, Path2.of(&quot;.bar&quot;)));
122    }
123    @Test
124    public void delValidShouldSucceed() {
125      jsonClient.jsonSetWithEscape(&quot;obj&quot;, ROOT_PATH, new IRLObject());
126      assertEquals(1L, jsonClient.jsonDel(&quot;obj&quot;, Path2.of(&quot;.str&quot;)));
127      assertTrue(client.exists(&quot;obj&quot;));
128      assertEquals(1L, jsonClient.jsonDel(&quot;obj&quot;));
129      assertFalse(client.exists(&quot;obj&quot;));
130    }
131    @Test
132    public void delNonExistingPathsAreIgnored() {
133      jsonClient.jsonSetWithEscape(&quot;foobar&quot;, ROOT_PATH, new FooBarObject());
134      assertEquals(0L, jsonClient.jsonDel(&quot;foobar&quot;, Path2.of(&quot;.foo[1]&quot;)));
135    }
136    @Test
137    public void typeChecksShouldSucceed() {
138      jsonClient.jsonSet(&quot;foobar&quot;, ROOT_PATH, new JSONObject(gson.toJson(new FooBarObject())));
139      assertEquals(singletonList(Object.class), jsonClient.jsonType(&quot;foobar&quot;, ROOT_PATH));
140      assertEquals(singletonList(String.class), jsonClient.jsonType(&quot;foobar&quot;, Path2.of(&quot;.foo&quot;)));
141      assertEquals(singletonList(int.class), jsonClient.jsonType(&quot;foobar&quot;, Path2.of(&quot;.fooI&quot;)));
142      assertEquals(singletonList(float.class), jsonClient.jsonType(&quot;foobar&quot;, Path2.of(&quot;.fooF&quot;)));
143      assertEquals(singletonList(List.class), jsonClient.jsonType(&quot;foobar&quot;, Path2.of(&quot;.fooArr&quot;)));
144      assertEquals(singletonList(boolean.class), jsonClient.jsonType(&quot;foobar&quot;, Path2.of(&quot;.fooB&quot;)));
145      assertEquals(Collections.emptyList(), jsonClient.jsonType(&quot;foobar&quot;, Path2.of(&quot;.fooErr&quot;)));
146    }
147    @Test
148    public void testJsonMerge() {
149      JSONObject json = new JSONObject(&quot;{\&quot;person\&quot;:{\&quot;name\&quot;:\&quot;John Doe\&quot;,\&quot;age\&quot;:25,\&quot;address\&quot;:{\&quot;home\&quot;:\&quot;123 Main Street\&quot;},\&quot;phone\&quot;:\&quot;123-456-7890\&quot;}}&quot;);
150      assertEquals(&quot;OK&quot;, jsonClient.jsonSet(&quot;test_merge&quot;, json));
151      json = new JSONObject(&quot;{\&quot;person\&quot;:{\&quot;name\&quot;:\&quot;John Doe\&quot;,\&quot;age\&quot;:30,\&quot;address\&quot;:{\&quot;home\&quot;:\&quot;123 Main Street\&quot;},\&quot;phone\&quot;:\&quot;123-456-7890\&quot;}}&quot;);
152      assertEquals(&quot;OK&quot;, jsonClient.jsonMerge(&quot;test_merge&quot;, Path2.of(&quot;$&quot;), &quot;{\&quot;person\&quot;:{\&quot;age\&quot;:30}}&quot;));
153      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet(&quot;test_merge&quot;, Path2.of(&quot;$&quot;)));
154      assertEquals(&quot;OK&quot;, jsonClient.jsonMerge(&quot;test_merge&quot;, Path2.of(&quot;$.person.address&quot;), &quot;{\&quot;work\&quot;:\&quot;Redis office\&quot;}&quot;));
155      json = new JSONObject(&quot;{\&quot;person\&quot;:{\&quot;name\&quot;:\&quot;John Doe\&quot;,\&quot;age\&quot;:30,\&quot;address\&quot;:{\&quot;home\&quot;:\&quot;123 Main Street\&quot;,\&quot;work\&quot;:\&quot;Redis office\&quot;},\&quot;phone\&quot;:\&quot;123-456-7890\&quot;}}&quot;);
156      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet(&quot;test_merge&quot;, Path2.of(&quot;$&quot;)));
157      assertEquals(&quot;OK&quot;, jsonClient.jsonMerge(&quot;test_merge&quot;, Path2.of(&quot;$.person&quot;), &quot;{\&quot;age\&quot;:null}&quot;));
158      json = new JSONObject(&quot;{\&quot;person\&quot;:{\&quot;name\&quot;:\&quot;John Doe\&quot;,\&quot;address\&quot;:{\&quot;home\&quot;:\&quot;123 Main Street\&quot;,\&quot;work\&quot;:\&quot;Redis office\&quot;},\&quot;phone\&quot;:\&quot;123-456-7890\&quot;}}&quot;);
159      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet(&quot;test_merge&quot;, Path2.of(&quot;$&quot;)));
160      assertEquals(1L, client.del(&quot;test_merge&quot;));
161    }
162    @Test
163    public void testJsonMergeArray()
164    {
165      JSONObject json = new JSONObject(&quot;{\&quot;a\&quot;:{\&quot;b\&quot;:{\&quot;c\&quot;:[\&quot;d\&quot;,\&quot;e\&quot;]}}}&quot;);
166      assertEquals(&quot;OK&quot;, jsonClient.jsonSet(&quot;test_merge_array&quot;, Path2.of(&quot;$&quot;), json));
167      assertEquals(&quot;OK&quot;, jsonClient.jsonMerge(&quot;test_merge_array&quot;, Path2.of(&quot;$.a.b.c&quot;), &quot;[\&quot;f\&quot;]&quot;));
168      json = new JSONObject(&quot;{\&quot;a\&quot;:{\&quot;b\&quot;:{\&quot;c\&quot;:[\&quot;f\&quot;]}}}&quot;);
169      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet(&quot;test_merge_array&quot;, Path2.of(&quot;$&quot;)));
170      assertEquals(&quot;OK&quot;, jsonClient.jsonSet(&quot;test_merge_array&quot;, Path2.of(&quot;$&quot;), &quot;{\&quot;a\&quot;:{\&quot;b\&quot;:{\&quot;c\&quot;:\&quot;d\&quot;}}}&quot;));
171      assertEquals(&quot;OK&quot;, jsonClient.jsonMerge(&quot;test_merge_array&quot;, Path2.of(&quot;$.a.b.c&quot;), &quot;[\&quot;f\&quot;]&quot;));
172      json = new JSONObject(&quot;{\&quot;a\&quot;:{\&quot;b\&quot;:{\&quot;c\&quot;:[\&quot;f\&quot;]}}}&quot;);
173      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet(&quot;test_merge_array&quot;, Path2.of(&quot;$&quot;)));
174      assertEquals(&quot;OK&quot;, jsonClient.jsonSet(&quot;test_merge_array&quot;, Path2.of(&quot;$&quot;), &quot;{\&quot;a\&quot;:{\&quot;b\&quot;:{\&quot;c\&quot;:[\&quot;d\&quot;,\&quot;e\&quot;]}}}&quot;));
175      assertEquals(&quot;OK&quot;, jsonClient.jsonMerge(&quot;test_merge_array&quot;, Path2.of(&quot;$.a.b&quot;), &quot;{\&quot;c\&quot;:null}&quot;));
176      json = new JSONObject(&quot;{\&quot;a\&quot;:{\&quot;b\&quot;:{}}}&quot;);
177      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet(&quot;test_merge_array&quot;, Path2.of(&quot;$&quot;)));
178    }
179    @Test
180    public void mgetWithPathWithAllKeysExist() {
181      Baz baz1 = new Baz(&quot;quuz1&quot;, &quot;grault1&quot;, &quot;waldo1&quot;);
182      Baz baz2 = new Baz(&quot;quuz2&quot;, &quot;grault2&quot;, &quot;waldo2&quot;);
183      Qux qux1 = new Qux(&quot;quux1&quot;, &quot;corge1&quot;, &quot;garply1&quot;, baz1);
184      Qux qux2 = new Qux(&quot;quux2&quot;, &quot;corge2&quot;, &quot;garply2&quot;, baz2);
185      jsonClient.jsonSet(&quot;qux1&quot;, new JSONObject(gson.toJson(qux1)));
186      jsonClient.jsonSet(&quot;qux2&quot;, new JSONObject(gson.toJson(qux2)));
187      List&lt;JSONArray&gt; list = jsonClient.jsonMGet(Path2.of(&quot;baz&quot;), &quot;qux1&quot;, &quot;qux2&quot;);
188      assertEquals(2, list.size());
189      assertJsonArrayEquals(jsonArray(new JSONObject(gson.toJson(baz1))), list.get(0));
190      assertJsonArrayEquals(jsonArray(new JSONObject(gson.toJson(baz2))), list.get(1));
191    }
192    @Test
193    public void mgetAtRootPathWithMissingKeys() {
194      Baz baz1 = new Baz(&quot;quuz1&quot;, &quot;grault1&quot;, &quot;waldo1&quot;);
195      Baz baz2 = new Baz(&quot;quuz2&quot;, &quot;grault2&quot;, &quot;waldo2&quot;);
196      Qux qux1 = new Qux(&quot;quux1&quot;, &quot;corge1&quot;, &quot;garply1&quot;, baz1);
197      Qux qux2 = new Qux(&quot;quux2&quot;, &quot;corge2&quot;, &quot;garply2&quot;, baz2);
198      jsonClient.jsonSetWithEscape(&quot;qux1&quot;, qux1);
199      jsonClient.jsonSetWithEscape(&quot;qux2&quot;, qux2);
200      List&lt;JSONArray&gt; list = jsonClient.jsonMGet(&quot;qux1&quot;, &quot;qux2&quot;, &quot;qux3&quot;);
201      assertEquals(3, list.size());
202      assertNull(list.get(2));
203      list.removeAll(singletonList(null));
204      assertEquals(2, list.size());
205    }
206    @Test
207    public void arrLen() {
208      jsonClient.jsonSet(&quot;arr&quot;, ROOT_PATH, new JSONArray(new int[]{0, 1, 2, 3, 4}));
209      assertEquals(singletonList(5L), jsonClient.jsonArrLen(&quot;arr&quot;, ROOT_PATH));
210    }
211    @Test
212    public void clearArray() {
213      jsonClient.jsonSet(&quot;foobar&quot;, ROOT_PATH, gson.toJson(new FooBarObject()));
214      Path2 arrPath = Path2.of(&quot;.fooArr&quot;);
215      assertEquals(singletonList(3L), jsonClient.jsonArrLen(&quot;foobar&quot;, arrPath));
216      assertEquals(1L, jsonClient.jsonClear(&quot;foobar&quot;, arrPath));
217      assertEquals(singletonList(0L), jsonClient.jsonArrLen(&quot;foobar&quot;, arrPath));
218      Path2 strPath = Path2.of(&quot;.foo&quot;);
219      assertEquals(0L, jsonClient.jsonClear(&quot;foobar&quot;, strPath));
220      assertJsonArrayEquals(jsonArray(&quot;bar&quot;), jsonClient.jsonGet(&quot;foobar&quot;, strPath));
221    }
222    @Test
223    public void clearObject() {
224      Baz baz = new Baz(&quot;quuz&quot;, &quot;grault&quot;, &quot;waldo&quot;);
225      Qux qux = new Qux(&quot;quux&quot;, &quot;corge&quot;, &quot;garply&quot;, baz);
226      jsonClient.jsonSet(&quot;qux&quot;, gson.toJson(qux));
227      Path2 objPath = Path2.of(&quot;.baz&quot;);
228      assertEquals(1L, jsonClient.jsonClear(&quot;qux&quot;, objPath));
229      assertJsonArrayEquals(jsonArray(new JSONObject()), jsonClient.jsonGet(&quot;qux&quot;, objPath));
230    }
231    @Test
232    public void arrAppendSameType() {
233      String json = &quot;{ a: &#x27;hello&#x27;, b: [1, 2, 3], c: { d: [&#x27;ello&#x27;] }}&quot;;
234      jsonClient.jsonSet(&quot;test_arrappend&quot;, ROOT_PATH, new JSONObject(json));
235      assertEquals(singletonList(6L), jsonClient.jsonArrAppend(&quot;test_arrappend&quot;, Path2.of(&quot;.b&quot;), 4, 5, 6));
236      assertJsonArrayEquals(jsonArray(jsonArray(1, 2, 3, 4, 5, 6)), jsonClient.jsonGet(&quot;test_arrappend&quot;, Path2.of(&quot;.b&quot;)));
237    }
238    @Test
239    public void arrAppendMultipleTypes() {
240      Object fooObject = gson.toJson(&quot;foo&quot;);
241      Object trueObject = gson.toJson(true);
242      Object nullObject = gson.toJson(null);
243      String json = &quot;{ a: &#x27;hello&#x27;, b: [1, 2, 3], c: { d: [&#x27;ello&#x27;] }}&quot;;
244      jsonClient.jsonSet(&quot;test_arrappend&quot;, ROOT_PATH, new JSONObject(json));
245      assertEquals(singletonList(6L), jsonClient.jsonArrAppend(&quot;test_arrappend&quot;, Path2.of(&quot;.b&quot;), fooObject, trueObject, nullObject));
246      assertJsonArrayEquals(jsonArray(jsonArray(1, 2, 3, &quot;foo&quot;, true, null)), jsonClient.jsonGet(&quot;test_arrappend&quot;, Path2.of(&quot;.b&quot;)));
247    }
248    @Test
249    public void arrAppendMultipleTypesWithDeepPath() {
250      String json = &quot;{ a: &#x27;hello&#x27;, b: [1, 2, 3], c: { d: [&#x27;ello&#x27;] }}&quot;;
251      jsonClient.jsonSet(&quot;test_arrappend&quot;, ROOT_PATH, new JSONObject(json));
252      assertEquals(singletonList(4L), jsonClient.jsonArrAppendWithEscape(&quot;test_arrappend&quot;, Path2.of(&quot;.c.d&quot;), &quot;foo&quot;, true, null));
253      assertJsonArrayEquals(jsonArray(jsonArray(&quot;ello&quot;, &quot;foo&quot;, true, null)), jsonClient.jsonGet(&quot;test_arrappend&quot;, Path2.of(&quot;.c.d&quot;)));
254    }
255    @Test
256    public void arrAppendAgaintsEmptyArray() {
257      String json = &quot;{ a: &#x27;hello&#x27;, b: [1, 2, 3], c: { d: [] }}&quot;;
258      jsonClient.jsonSet(&quot;test_arrappend&quot;, ROOT_PATH, new JSONObject(json));
259      assertEquals(singletonList(3L), jsonClient.jsonArrAppendWithEscape(&quot;test_arrappend&quot;, Path2.of(&quot;.c.d&quot;), &quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
260      assertJsonArrayEquals(jsonArray(jsonArray(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)), jsonClient.jsonGet(&quot;test_arrappend&quot;, Path2.of(&quot;.c.d&quot;)));
261    }
262    @Test
263    public void arrAppendPathIsNotArray() {
264      String json = &quot;{ a: &#x27;hello&#x27;, b: [1, 2, 3], c: { d: [&#x27;ello&#x27;] }}&quot;;
265      jsonClient.jsonSet(&quot;test_arrappend&quot;, ROOT_PATH, new JSONObject(json));
266      assertEquals(singletonList(null), jsonClient.jsonArrAppend(&quot;test_arrappend&quot;, Path2.of(&quot;.a&quot;), 1));
267      assertEquals(singletonList(null), jsonClient.jsonArrAppend(&quot;test_arrappend&quot;, Path2.of(&quot;.a&quot;), gson.toJson(1)));
268      assertEquals(singletonList(null), jsonClient.jsonArrAppendWithEscape(&quot;test_arrappend&quot;, Path2.of(&quot;.a&quot;), 1));
269    }
270    @Test(expected = JedisDataException.class)
271    public void arrIndexAbsentKey() {
272      jsonClient.jsonArrIndexWithEscape(&quot;quxquux&quot;, ROOT_PATH, new JSONObject());
273    }
274    @Test
275    public void arrIndexWithInts() {
<span onclick='openModal()' class='match'>276      jsonClient.jsonSetWithEscape(&quot;quxquux&quot;, ROOT_PATH, new int[]{8, 6, 7, 5, 3, 0, 9});
277      assertEquals(singletonList(2L), jsonClient.jsonArrIndexWithEscape(&quot;quxquux&quot;, ROOT_PATH, 7));
</span>278      assertEquals(singletonList(-1L), jsonClient.jsonArrIndexWithEscape(&quot;quxquux&quot;, ROOT_PATH, &quot;7&quot;));
279    }
280    @Test
281    public void arrIndexWithStrings() {
282      jsonClient.jsonSetWithEscape(&quot;quxquux&quot;, ROOT_PATH, new String[]{&quot;8&quot;, &quot;6&quot;, &quot;7&quot;, &quot;5&quot;, &quot;3&quot;, &quot;0&quot;, &quot;9&quot;});
283      assertEquals(singletonList(2L), jsonClient.jsonArrIndexWithEscape(&quot;quxquux&quot;, ROOT_PATH, &quot;7&quot;));
284    }
285    @Test
286    public void arrIndexWithStringsAndPath() {
287      jsonClient.jsonSetWithEscape(&quot;foobar&quot;, ROOT_PATH, new FooBarObject());
288      assertEquals(singletonList(1L), jsonClient.jsonArrIndexWithEscape(&quot;foobar&quot;, Path2.of(&quot;.fooArr&quot;), &quot;b&quot;));
289    }
290    @Test
291    public void arrIndexNonExistentPath() {
292      jsonClient.jsonSet(&quot;foobar&quot;, ROOT_PATH, gson.toJson(new FooBarObject()));
293      assertEquals(Collections.emptyList(), jsonClient.jsonArrIndex(&quot;foobar&quot;, Path2.of(&quot;.barArr&quot;), gson.toJson(&quot;x&quot;)));
294    }
295    @Test
296    public void arrInsert() {
297      String json = &quot;[&#x27;hello&#x27;, &#x27;world&#x27;, true, 1, 3, null, false]&quot;;
298      jsonClient.jsonSet(&quot;test_arrinsert&quot;, ROOT_PATH, new JSONArray(json));
299      assertEquals(singletonList(8L), jsonClient.jsonArrInsertWithEscape(&quot;test_arrinsert&quot;, ROOT_PATH, 1, &quot;foo&quot;));
300      assertJsonArrayEquals(jsonArray(jsonArray(&quot;hello&quot;, &quot;foo&quot;, &quot;world&quot;, true, 1, 3, null, false)),
301          jsonClient.jsonGet(&quot;test_arrinsert&quot;, ROOT_PATH));
302    }
303    @Test
304    public void arrInsertWithNegativeIndex() {
305      String json = &quot;[&#x27;hello&#x27;, &#x27;world&#x27;, true, 1, 3, null, false]&quot;;
306      jsonClient.jsonSet(&quot;test_arrinsert&quot;, ROOT_PATH, new JSONArray(json));
307      assertEquals(singletonList(8L), jsonClient.jsonArrInsertWithEscape(&quot;test_arrinsert&quot;, ROOT_PATH, -1, &quot;foo&quot;));
308      assertJsonArrayEquals(jsonArray(jsonArray(&quot;hello&quot;, &quot;world&quot;, true, 1, 3, null, &quot;foo&quot;, false)),
309          jsonClient.jsonGet(&quot;test_arrinsert&quot;, ROOT_PATH));
310    }
311    @Test
312    public void arrPop() {
313      jsonClient.jsonSet(&quot;arr&quot;, ROOT_PATH, new JSONArray(new int[]{0, 1, 2, 3, 4}));
314      assertEquals(singletonList(4d), jsonClient.jsonArrPop(&quot;arr&quot;, ROOT_PATH));
315      assertEquals(singletonList(3d), jsonClient.jsonArrPop(&quot;arr&quot;, ROOT_PATH, -1));
316      assertEquals(singletonList(0d), jsonClient.jsonArrPop(&quot;arr&quot;, ROOT_PATH, 0));
317    }
318    @Test
319    public void arrTrim() {
320      jsonClient.jsonSet(&quot;arr&quot;, ROOT_PATH, new JSONArray(new int[]{0, 1, 2, 3, 4}));
321      assertEquals(singletonList(3L), jsonClient.jsonArrTrim(&quot;arr&quot;, ROOT_PATH, 1, 3));
322      assertJsonArrayEquals(jsonArray(jsonArray(1, 2, 3)), jsonClient.jsonGet(&quot;arr&quot;, ROOT_PATH));
323    }
324    @Test
325    public void strAppend() {
326      jsonClient.jsonSet(&quot;str&quot;, ROOT_PATH, gson.toJson(&quot;foo&quot;));
327      assertEquals(singletonList(6L), jsonClient.jsonStrAppend(&quot;str&quot;, ROOT_PATH, &quot;bar&quot;));
328      assertEquals(&quot;foobar&quot;, jsonClient.jsonGet(&quot;str&quot;));
329    }
330    @Test
331    public void strLen() {
332      jsonClient.jsonSetWithEscape(&quot;str&quot;, &quot;foobar&quot;);
333      assertEquals(singletonList(6L), jsonClient.jsonStrLen(&quot;str&quot;, ROOT_PATH));
334    }
335    @Test
336    public void numIncrBy() {
337      jsonClient.jsonSet(&quot;doc&quot;, &quot;{\&quot;a\&quot;:\&quot;b\&quot;,\&quot;b\&quot;:[{\&quot;a\&quot;:2}, {\&quot;a\&quot;:5}, {\&quot;a\&quot;:\&quot;c\&quot;}]}&quot;);
338      assertJsonArrayEquals(jsonArray((Object) null), jsonClient.jsonNumIncrBy(&quot;doc&quot;, Path2.of(&quot;.a&quot;), 1d));
339      assertJsonArrayEquals(jsonArray(null, 4, 7, null), jsonClient.jsonNumIncrBy(&quot;doc&quot;, Path2.of(&quot;..a&quot;), 2d));
340      assertJsonArrayEquals(jsonArray((Object) null), jsonClient.jsonNumIncrBy(&quot;doc&quot;, Path2.of(&quot;..b&quot;), 0d));
341      assertJsonArrayEquals(jsonArray(), jsonClient.jsonNumIncrBy(&quot;doc&quot;, Path2.of(&quot;..c&quot;), 0d));
342    }
343    @Test
344    public void obj() {
345      String json = &quot;{\&quot;a\&quot;:[3], \&quot;nested\&quot;: {\&quot;a\&quot;: {\&quot;b\&quot;:2, \&quot;c\&quot;: 1}}}&quot;;
346      jsonClient.jsonSet(&quot;doc&quot;, ROOT_PATH, json);
347      assertEquals(Arrays.asList(2L), jsonClient.jsonObjLen(&quot;doc&quot;, ROOT_PATH));
348      assertEquals(Arrays.asList(Arrays.asList(&quot;a&quot;, &quot;nested&quot;)), jsonClient.jsonObjKeys(&quot;doc&quot;, ROOT_PATH));
349      assertEquals(Arrays.asList(null, 2L), jsonClient.jsonObjLen(&quot;doc&quot;, Path2.of(&quot;..a&quot;)));
350      assertEquals(Arrays.asList(null, Arrays.asList(&quot;b&quot;, &quot;c&quot;)), jsonClient.jsonObjKeys(&quot;doc&quot;, Path2.of(&quot;..a&quot;)));
351    }
352    @Test
353    public void debugMemory() {
354      assertEquals(Collections.emptyList(), jsonClient.jsonDebugMemory(&quot;json&quot;, ROOT_PATH));
355      jsonClient.jsonSet(&quot;json&quot;, new JSONObject(&quot;{ foo: &#x27;bar&#x27;, bar: { foo: 10 }}&quot;));
356      assertEquals(1, jsonClient.jsonDebugMemory(&quot;json&quot;, ROOT_PATH).size());
357      assertEquals(2, jsonClient.jsonDebugMemory(&quot;json&quot;, Path2.of(&quot;$..foo&quot;)).size());
358      assertEquals(1, jsonClient.jsonDebugMemory(&quot;json&quot;, Path2.of(&quot;$..bar&quot;)).size());
359    }
360    @Test
361    public void resp() {
362      assertNull(jsonClient.jsonResp(&quot;resp&quot;, ROOT_PATH));
363      String json = &quot;{\&quot;foo\&quot;: {\&quot;hello\&quot;:\&quot;world\&quot;}, \&quot;bar\&quot;: [null, 3, 2.5, true]}&quot;;
364      jsonClient.jsonSet(&quot;resp&quot;, ROOT_PATH, json);
365      List&lt;List&lt;Object&gt;&gt; fullResp = jsonClient.jsonResp(&quot;resp&quot;, ROOT_PATH);
366      assertEquals(1, fullResp.size());
367      List&lt;Object&gt; resp = fullResp.get(0);
368      assertEquals(&quot;{&quot;, resp.get(0));
369      assertEquals(&quot;foo&quot;, resp.get(1));
370      assertEquals(Arrays.asList(&quot;{&quot;, &quot;hello&quot;, &quot;world&quot;), resp.get(2));
371      assertEquals(&quot;bar&quot;, resp.get(3));
372      List&lt;Object&gt; arr = (List&lt;Object&gt;) resp.get(4);
373      assertEquals(&quot;[&quot;, arr.get(0));
374      assertNull(arr.get(1));
375      assertEquals(Long.valueOf(3), arr.get(2));
376      MatcherAssert.assertThat(arr.get(3), Matchers.isOneOf(&quot;2.5&quot;, 2.5));
377      assertEquals(&quot;true&quot;, arr.get(4));
378    }
379    private void assertJsonArrayEquals(JSONArray a, Object _b) {
380      if (!(_b instanceof JSONArray)) {
381        fail(&quot;Actual value is not JSONArray.&quot;);
382      }
383      JSONArray b = (JSONArray) _b;
384      assertEquals(&quot;JSONArray length mismatch&quot;, a.length(), b.length());
385      int length = a.length();
386      for (int index = 0; index &lt; length; index++) {
387        if (a.isNull(index)) {
388          assertTrue(index + &quot;&#x27;th element is not null&quot;, b.isNull(index));
389          continue;
390        }
391        Object ia = a.get(index);
392        Object ib = b.get(index);
393        if (ia instanceof JSONArray) {
394          assertJsonArrayEquals((JSONArray) ia, ib);
395        } else if (ia instanceof JSONObject) {
396          assertJsonObjectEquals((JSONObject) ia, ib);
397        } else if (ia instanceof Number &amp;&amp; ib instanceof Number) {
398          assertEquals(index + &quot;&#x27;th element mismatch&quot;, ((Number) ia).doubleValue(), ((Number) ib).doubleValue(), 0d);
399        } else {
400          assertEquals(index + &quot;&#x27;th element mismatch&quot;, ia, ib);
401        }
402      }
403    }
404    private void assertJsonObjectEquals(JSONObject a, Object _b) {
405      if (!(_b instanceof JSONObject)) {
406        fail(&quot;Actual value is not JSONObject.&quot;);
407      }
408      JSONObject b = (JSONObject) _b;
409      assertEquals(&quot;JSONObject length mismatch&quot;, a.length(), b.length());
410      assertEquals(a.keySet(), b.keySet());
411      for (String key : a.keySet()) {
412        if (a.isNull(key)) {
413          assertTrue(key + &quot;&#x27;s value is not null&quot;, b.isNull(key));
414          continue;
415        }
416        Object oa = a.get(key);
417        Object ob = b.get(key);
418        if (oa instanceof JSONArray) {
419          assertJsonArrayEquals((JSONArray) oa, ob);
420        } else if (oa instanceof JSONObject) {
421          assertJsonObjectEquals((JSONObject) oa, ob);
422        } else {
423          assertEquals(key + &quot;&#x27;s value mismatch&quot;, oa, ob);
424        }
425      }
426    }
427    private static JSONArray jsonArray(Object... objects) {
428      JSONArray arr = new JSONArray();
429      for (Object o : objects) {
430        arr.put(o);
431      }
432      return arr;
433    }
434  }
</code></pre>
        </div>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-RedisJsonV1Test.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.json;
2  import static org.junit.Assert.*;
3  import static redis.clients.jedis.json.Path.ROOT_PATH;
4  import static redis.clients.jedis.modules.json.JsonObjects.*;
5  import com.google.gson.Gson;
6  import com.google.gson.JsonArray;
7  import com.google.gson.JsonObject;
8  import java.time.Instant;
9  import java.util.ArrayList;
10  import java.util.Arrays;
11  import java.util.Collections;
12  import java.util.List;
13  import org.hamcrest.MatcherAssert;
14  import org.hamcrest.Matchers;
15  import org.junit.Before;
16  import org.junit.BeforeClass;
17  import org.junit.Test;
18  import redis.clients.jedis.exceptions.JedisDataException;
19  import redis.clients.jedis.json.JsonSetParams;
20  import redis.clients.jedis.json.Path;
21  import redis.clients.jedis.json.commands.RedisJsonV1Commands;
22  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
23  import redis.clients.jedis.util.JsonObjectMapperTestUtil;
24  public class RedisJsonV1Test extends RedisModuleCommandsTestBase {
25    private final Gson gson = new Gson();
26    private RedisJsonV1Commands jsonClient;
27    @BeforeClass
28    public static void prepare() {
29      RedisModuleCommandsTestBase.prepare();
30    }
31    @Before
32    @Override
33    public void setUp() {
34      super.setUp();
35      this.jsonClient = super.client;
36    }
37    @Test
38    public void basicSetGetShouldSucceed() {
39      jsonClient.jsonSet(&quot;null&quot;, ROOT_PATH, (Object) null);
40      assertNull(client.jsonGet(&quot;null&quot;, String.class, ROOT_PATH));
41      jsonClient.jsonSet(&quot;str&quot;, ROOT_PATH, &quot;strong&quot;);
42      assertEquals(&quot;strong&quot;, jsonClient.jsonGet(&quot;str&quot;));
43      IRLObject obj = new IRLObject();
44      jsonClient.jsonSet(&quot;obj&quot;, ROOT_PATH, obj);
45      Object expected = gson.fromJson(gson.toJson(obj), Object.class);
46      assertTrue(expected.equals(client.jsonGet(&quot;obj&quot;)));
47      Path p = Path.of(&quot;.str&quot;);
48      jsonClient.jsonSet(&quot;obj&quot;, p, &quot;strung&quot;);
49      assertEquals(&quot;strung&quot;, jsonClient.jsonGet(&quot;obj&quot;, String.class, p));
50    }
51    @Test
52    public void setExistingPathOnlyIfExistsShouldSucceed() {
53      jsonClient.jsonSet(&quot;obj&quot;, ROOT_PATH, new IRLObject());
54      Path p = Path.of(&quot;.str&quot;);
55      jsonClient.jsonSet(&quot;obj&quot;, p, &quot;strangle&quot;, JsonSetParams.jsonSetParams().xx());
56      assertEquals(&quot;strangle&quot;, jsonClient.jsonGet(&quot;obj&quot;, String.class, p));
57    }
58    @Test
59    public void setNonExistingOnlyIfNotExistsShouldSucceed() {
60      jsonClient.jsonSet(&quot;obj&quot;, ROOT_PATH, new IRLObject());
61      Path p = Path.of(&quot;.none&quot;);
62      jsonClient.jsonSet(&quot;obj&quot;, p, &quot;strangle&quot;, JsonSetParams.jsonSetParams().nx());
63      assertEquals(&quot;strangle&quot;, jsonClient.jsonGet(&quot;obj&quot;, String.class, p));
64    }
65    @Test
66    public void setWithoutAPathDefaultsToRootPath() {
67      jsonClient.jsonSet(&quot;obj1&quot;, ROOT_PATH, new IRLObject());
68      jsonClient.jsonSetLegacy(&quot;obj1&quot;, (Object) &quot;strangle&quot;, JsonSetParams.jsonSetParams().xx());
69      assertEquals(&quot;strangle&quot;, jsonClient.jsonGet(&quot;obj1&quot;, String.class, ROOT_PATH));
70    }
71    @Test
72    public void setExistingPathOnlyIfNotExistsShouldFail() {
73      jsonClient.jsonSet(&quot;obj&quot;, ROOT_PATH, new IRLObject());
74      Path p = Path.of(&quot;.str&quot;);
75      assertNull(client.jsonSet(&quot;obj&quot;, p, &quot;strangle&quot;, JsonSetParams.jsonSetParams().nx()));
76    }
77    @Test
78    public void setNonExistingPathOnlyIfExistsShouldFail() {
79      jsonClient.jsonSet(&quot;obj&quot;, ROOT_PATH, new IRLObject());
80      Path p = Path.of(&quot;.none&quot;);
81      assertNull(client.jsonSet(&quot;obj&quot;, p, &quot;strangle&quot;, JsonSetParams.jsonSetParams().xx()));
82    }
83    @Test(expected = JedisDataException.class)
84    public void setException() {
85      jsonClient.jsonSet(&quot;test&quot;, Path.of(&quot;.foo&quot;), &quot;bar&quot;);
86    }
87    @Test
88    public void getMultiplePathsShouldSucceed() {
89      IRLObject obj = new IRLObject();
90      jsonClient.jsonSetLegacy(&quot;obj&quot;, obj);
91      Object expected = gson.fromJson(gson.toJson(obj), Object.class);
92      assertTrue(expected.equals(client.jsonGet(&quot;obj&quot;, Object.class, Path.of(&quot;bool&quot;), Path.of(&quot;str&quot;))));
93    }
94    @Test
95    public void getMultiplePathsShouldSucceedWithLegacy() {
96      IRLObject obj = new IRLObject();
97      jsonClient.jsonSetLegacy(&quot;obj&quot;, obj);
98      Object expected = gson.fromJson(gson.toJson(obj), Object.class);
99      assertTrue(expected.equals(client.jsonGet(&quot;obj&quot;, Object.class, Path.of(&quot;bool&quot;), Path.of(&quot;str&quot;))));
100    }
101    @Test
102    public void toggle() {
103      IRLObject obj = new IRLObject();
104      jsonClient.jsonSetLegacy(&quot;obj&quot;, obj);
105      Path pbool = Path.of(&quot;.bool&quot;);
106      assertTrue(client.jsonGet(&quot;obj&quot;, Boolean.class, pbool));
107      jsonClient.jsonToggle(&quot;obj&quot;, pbool);
108      assertFalse(client.jsonGet(&quot;obj&quot;, Boolean.class, pbool));
109      jsonClient.jsonToggle(&quot;obj&quot;, pbool);
110      assertTrue(client.jsonGet(&quot;obj&quot;, Boolean.class, pbool));
111      Path pstr = Path.of(&quot;.str&quot;);
112      try {
113        jsonClient.jsonToggle(&quot;obj&quot;, pstr);
114        fail(&quot;String not a bool&quot;);
115      } catch (JedisDataException jde) {
116        assertTrue(jde.getMessage().contains(&quot;not a bool&quot;));
117      }
118      assertEquals(&quot;string&quot;, jsonClient.jsonGet(&quot;obj&quot;, String.class, pstr));
119    }
120    @Test(expected = JedisDataException.class)
121    public void getAbsent() {
122      jsonClient.jsonSet(&quot;test&quot;, ROOT_PATH, &quot;foo&quot;);
123      jsonClient.jsonGet(&quot;test&quot;, String.class, Path.of(&quot;.bar&quot;));
124    }
125    @Test
126    public void delValidShouldSucceed() {
127      jsonClient.jsonSet(&quot;obj&quot;, ROOT_PATH, new IRLObject());
128      assertEquals(1L, jsonClient.jsonDel(&quot;obj&quot;, Path.of(&quot;.str&quot;)));
129      assertTrue(client.exists(&quot;obj&quot;));
130      assertEquals(1L, jsonClient.jsonDel(&quot;obj&quot;));
131      assertFalse(client.exists(&quot;obj&quot;));
132    }
133    @Test
134    public void delNonExistingPathsAreIgnored() {
135      jsonClient.jsonSet(&quot;foobar&quot;, ROOT_PATH, new FooBarObject());
136      assertEquals(0L, jsonClient.jsonDel(&quot;foobar&quot;, Path.of(&quot;.foo[1]&quot;)));
137    }
138    @Test
139    public void typeChecksShouldSucceed() {
140      assertNull(client.jsonType(&quot;foobar&quot;));
141      jsonClient.jsonSet(&quot;foobar&quot;, ROOT_PATH, new FooBarObject());
142      assertSame(Object.class, jsonClient.jsonType(&quot;foobar&quot;));
143      assertSame(Object.class, jsonClient.jsonType(&quot;foobar&quot;, ROOT_PATH));
144      assertSame(String.class, jsonClient.jsonType(&quot;foobar&quot;, Path.of(&quot;.foo&quot;)));
145      assertSame(int.class, jsonClient.jsonType(&quot;foobar&quot;, Path.of(&quot;.fooI&quot;)));
146      assertSame(float.class, jsonClient.jsonType(&quot;foobar&quot;, Path.of(&quot;.fooF&quot;)));
147      assertSame(List.class, jsonClient.jsonType(&quot;foobar&quot;, Path.of(&quot;.fooArr&quot;)));
148      assertSame(boolean.class, jsonClient.jsonType(&quot;foobar&quot;, Path.of(&quot;.fooB&quot;)));
149      assertNull(client.jsonType(&quot;foobar&quot;, Path.of(&quot;.fooErr&quot;)));
150    }
151    @Test
152    public void testJsonMerge() {
153      List&lt;String&gt; childrens = new ArrayList&lt;&gt;();
154      childrens.add(&quot;Child 1&quot;);
155      Person person = new Person(&quot;John Doe&quot;, 25, &quot;123 Main Street&quot;, &quot;123-456-7890&quot;, childrens);
156      assertEquals(&quot;OK&quot;, jsonClient.jsonSet(&quot;test_merge&quot;, ROOT_PATH, person));
157      person.age = 30;
158      person.childrens.add(&quot;Child 2&quot;);
159      person.childrens.add(&quot;Child 3&quot;);
160      assertEquals(&quot;OK&quot;, jsonClient.jsonMerge(&quot;test_merge&quot;, Path.of((&quot;.childrens&quot;)), person.childrens));
161      assertEquals(&quot;OK&quot;, jsonClient.jsonMerge(&quot;test_merge&quot;, Path.of((&quot;.age&quot;)), person.age));
162      assertEquals(person, jsonClient.jsonGet(&quot;test_merge&quot;, Person.class));
163    }
164    @Test
165    public void mgetWithPathWithAllKeysExist() {
166      Baz baz1 = new Baz(&quot;quuz1&quot;, &quot;grault1&quot;, &quot;waldo1&quot;);
167      Baz baz2 = new Baz(&quot;quuz2&quot;, &quot;grault2&quot;, &quot;waldo2&quot;);
168      Qux qux1 = new Qux(&quot;quux1&quot;, &quot;corge1&quot;, &quot;garply1&quot;, baz1);
169      Qux qux2 = new Qux(&quot;quux2&quot;, &quot;corge2&quot;, &quot;garply2&quot;, baz2);
170      jsonClient.jsonSetLegacy(&quot;qux1&quot;, qux1);
171      jsonClient.jsonSetLegacy(&quot;qux2&quot;, qux2);
172      List&lt;Baz&gt; allBaz = jsonClient.jsonMGet(Path.of(&quot;baz&quot;), Baz.class, &quot;qux1&quot;, &quot;qux2&quot;);
173      assertEquals(2, allBaz.size());
174      Baz testBaz1 = allBaz.stream() 
175          .filter(b -&gt; b.quuz.equals(&quot;quuz1&quot;)) 
176          .findFirst() 
177          .orElseThrow(() -&gt; new NullPointerException(&quot;&quot;));
178      Baz testBaz2 = allBaz.stream() 
179          .filter(q -&gt; q.quuz.equals(&quot;quuz2&quot;)) 
180          .findFirst() 
181          .orElseThrow(() -&gt; new NullPointerException(&quot;&quot;));
182      assertEquals(baz1, testBaz1);
183      assertEquals(baz2, testBaz2);
184    }
185    @Test
186    public void mgetAtRootPathWithMissingKeys() {
187      Baz baz1 = new Baz(&quot;quuz1&quot;, &quot;grault1&quot;, &quot;waldo1&quot;);
188      Baz baz2 = new Baz(&quot;quuz2&quot;, &quot;grault2&quot;, &quot;waldo2&quot;);
189      Qux qux1 = new Qux(&quot;quux1&quot;, &quot;corge1&quot;, &quot;garply1&quot;, baz1);
190      Qux qux2 = new Qux(&quot;quux2&quot;, &quot;corge2&quot;, &quot;garply2&quot;, baz2);
191      jsonClient.jsonSetLegacy(&quot;qux1&quot;, qux1);
192      jsonClient.jsonSetLegacy(&quot;qux2&quot;, qux2);
193      List&lt;Qux&gt; allQux = jsonClient.jsonMGet(Qux.class, &quot;qux1&quot;, &quot;qux2&quot;, &quot;qux3&quot;);
194      assertEquals(3, allQux.size());
195      assertNull(allQux.get(2));
196      allQux.removeAll(Collections.singleton(null));
197      assertEquals(2, allQux.size());
198    }
199    @Test
200    public void arrLen() {
201      jsonClient.jsonSet(&quot;foobar&quot;, ROOT_PATH, new FooBarObject());
202      assertEquals(Long.valueOf(3), jsonClient.jsonArrLen(&quot;foobar&quot;, Path.of(&quot;.fooArr&quot;)));
203    }
204    @Test
205    public void arrLenDefaultPath() {
206      assertNull(client.jsonArrLen(&quot;array&quot;));
207      jsonClient.jsonSetLegacy(&quot;array&quot;, new int[]{1, 2, 3});
208      assertEquals(Long.valueOf(3), jsonClient.jsonArrLen(&quot;array&quot;));
209    }
210    @Test
211    public void clearArray() {
212      jsonClient.jsonSet(&quot;foobar&quot;, ROOT_PATH, new FooBarObject());
213      Path arrPath = Path.of(&quot;.fooArr&quot;);
214      assertEquals(Long.valueOf(3), jsonClient.jsonArrLen(&quot;foobar&quot;, arrPath));
215      assertEquals(1L, jsonClient.jsonClear(&quot;foobar&quot;, arrPath));
216      assertEquals(Long.valueOf(0), jsonClient.jsonArrLen(&quot;foobar&quot;, arrPath));
217      Path strPath = Path.of(&quot;foo&quot;);
218      assertEquals(0L, jsonClient.jsonClear(&quot;foobar&quot;, strPath));
219      assertEquals(&quot;bar&quot;, jsonClient.jsonGet(&quot;foobar&quot;, String.class, strPath));
220    }
221    @Test
222    public void clearObject() {
223      Baz baz = new Baz(&quot;quuz&quot;, &quot;grault&quot;, &quot;waldo&quot;);
224      Qux qux = new Qux(&quot;quux&quot;, &quot;corge&quot;, &quot;garply&quot;, baz);
225      jsonClient.jsonSetLegacy(&quot;qux&quot;, qux);
226      Path objPath = Path.of(&quot;baz&quot;);
227      assertEquals(baz, jsonClient.jsonGet(&quot;qux&quot;, Baz.class, objPath));
228      assertEquals(1L, jsonClient.jsonClear(&quot;qux&quot;, objPath));
229      assertEquals(new Baz(null, null, null), jsonClient.jsonGet(&quot;qux&quot;, Baz.class, objPath));
230    }
231    @Test
232    public void arrAppendSameType() {
233      String json = &quot;{ a: &#x27;hello&#x27;, b: [1, 2, 3], c: { d: [&#x27;ello&#x27;] }}&quot;;
234      JsonObject jsonObject = gson.fromJson(json, JsonObject.class);
235      jsonClient.jsonSet(&quot;test_arrappend&quot;, ROOT_PATH, jsonObject);
236      assertEquals(Long.valueOf(6), jsonClient.jsonArrAppend(&quot;test_arrappend&quot;, Path.of(&quot;.b&quot;), 4, 5, 6));
237      Integer[] array = jsonClient.jsonGet(&quot;test_arrappend&quot;, Integer[].class, Path.of(&quot;.b&quot;));
238      assertArrayEquals(new Integer[]{1, 2, 3, 4, 5, 6}, array);
239    }
240    @Test
241    public void arrAppendMultipleTypes() {
242      String json = &quot;{ a: &#x27;hello&#x27;, b: [1, 2, 3], c: { d: [&#x27;ello&#x27;] }}&quot;;
243      JsonObject jsonObject = gson.fromJson(json, JsonObject.class);
244      jsonClient.jsonSet(&quot;test_arrappend&quot;, ROOT_PATH, jsonObject);
245      assertEquals(Long.valueOf(6), jsonClient.jsonArrAppend(&quot;test_arrappend&quot;, Path.of(&quot;.b&quot;), &quot;foo&quot;, true, null));
246      Object[] array = jsonClient.jsonGet(&quot;test_arrappend&quot;, Object[].class, Path.of(&quot;.b&quot;));
247      assertArrayEquals(new Object[]{1.0, 2.0, 3.0, &quot;foo&quot;, true, null}, array);
248    }
249    @Test
250    public void arrAppendMultipleTypesWithDeepPath() {
251      String json = &quot;{ a: &#x27;hello&#x27;, b: [1, 2, 3], c: { d: [&#x27;ello&#x27;] }}&quot;;
252      JsonObject jsonObject = gson.fromJson(json, JsonObject.class);
253      jsonClient.jsonSet(&quot;test_arrappend&quot;, ROOT_PATH, jsonObject);
254      assertEquals(Long.valueOf(4), jsonClient.jsonArrAppend(&quot;test_arrappend&quot;, Path.of(&quot;.c.d&quot;), &quot;foo&quot;, true, null));
255      Object[] array = jsonClient.jsonGet(&quot;test_arrappend&quot;, Object[].class, Path.of(&quot;.c.d&quot;));
256      assertArrayEquals(new Object[]{&quot;ello&quot;, &quot;foo&quot;, true, null}, array);
257    }
258    @Test
259    public void arrAppendAgaintsEmptyArray() {
260      String json = &quot;{ a: &#x27;hello&#x27;, b: [1, 2, 3], c: { d: [] }}&quot;;
261      JsonObject jsonObject = gson.fromJson(json, JsonObject.class);
262      jsonClient.jsonSet(&quot;test_arrappend&quot;, ROOT_PATH, jsonObject);
263      assertEquals(Long.valueOf(3), jsonClient.jsonArrAppend(&quot;test_arrappend&quot;, Path.of(&quot;.c.d&quot;), &quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
264      String[] array = jsonClient.jsonGet(&quot;test_arrappend&quot;, String[].class, Path.of(&quot;.c.d&quot;));
265      assertArrayEquals(new String[]{&quot;a&quot;, &quot;b&quot;, &quot;c&quot;}, array);
266    }
267    @Test(expected = JedisDataException.class)
268    public void arrAppendPathIsNotArray() {
269      String json = &quot;{ a: &#x27;hello&#x27;, b: [1, 2, 3], c: { d: [&#x27;ello&#x27;] }}&quot;;
270      JsonObject jsonObject = gson.fromJson(json, JsonObject.class);
271      jsonClient.jsonSet(&quot;test_arrappend&quot;, ROOT_PATH, jsonObject);
272      jsonClient.jsonArrAppend(&quot;test_arrappend&quot;, Path.of(&quot;.a&quot;), 1);
273    }
274    @Test(expected = JedisDataException.class)
275    public void arrIndexAbsentKey() {
276      jsonClient.jsonArrIndex(&quot;quxquux&quot;, ROOT_PATH, gson.toJson(new Object()));
277    }
278    @Test
279    public void arrIndexWithInts() {
<span onclick='openModal()' class='match'>280      jsonClient.jsonSet(&quot;quxquux&quot;, ROOT_PATH, new int[]{8, 6, 7, 5, 3, 0, 9});
281      assertEquals(2L, jsonClient.jsonArrIndex(&quot;quxquux&quot;, ROOT_PATH, 7));
</span>282      assertEquals(-1L, jsonClient.jsonArrIndex(&quot;quxquux&quot;, ROOT_PATH, &quot;7&quot;));
283    }
284    @Test
285    public void arrIndexWithStrings() {
286      jsonClient.jsonSet(&quot;quxquux&quot;, ROOT_PATH, new String[]{&quot;8&quot;, &quot;6&quot;, &quot;7&quot;, &quot;5&quot;, &quot;3&quot;, &quot;0&quot;, &quot;9&quot;});
287      assertEquals(2L, jsonClient.jsonArrIndex(&quot;quxquux&quot;, ROOT_PATH, &quot;7&quot;));
288    }
289    @Test
290    public void arrIndexWithStringsAndPath() {
291      jsonClient.jsonSet(&quot;foobar&quot;, ROOT_PATH, new FooBarObject());
292      assertEquals(1L, jsonClient.jsonArrIndex(&quot;foobar&quot;, Path.of(&quot;.fooArr&quot;), &quot;b&quot;));
293    }
294    @Test(expected = JedisDataException.class)
295    public void arrIndexNonExistentPath() {
296      jsonClient.jsonSet(&quot;foobar&quot;, ROOT_PATH, new FooBarObject());
297      assertEquals(1L, jsonClient.jsonArrIndex(&quot;foobar&quot;, Path.of(&quot;.barArr&quot;), &quot;x&quot;));
298    }
299    @Test
300    public void arrInsert() {
301      String json = &quot;[&#x27;hello&#x27;, &#x27;world&#x27;, true, 1, 3, null, false]&quot;;
302      JsonArray jsonArray = gson.fromJson(json, JsonArray.class);
303      jsonClient.jsonSet(&quot;test_arrinsert&quot;, ROOT_PATH, jsonArray);
304      assertEquals(8L, jsonClient.jsonArrInsert(&quot;test_arrinsert&quot;, ROOT_PATH, 1, &quot;foo&quot;));
305      Object[] array = jsonClient.jsonGet(&quot;test_arrinsert&quot;, Object[].class, ROOT_PATH);
306      assertArrayEquals(new Object[]{&quot;hello&quot;, &quot;foo&quot;, &quot;world&quot;, true, 1.0, 3.0, null, false}, array);
307    }
308    @Test
309    public void arrInsertWithNegativeIndex() {
310      String json = &quot;[&#x27;hello&#x27;, &#x27;world&#x27;, true, 1, 3, null, false]&quot;;
311      JsonArray jsonArray = gson.fromJson(json, JsonArray.class);
312      jsonClient.jsonSet(&quot;test_arrinsert&quot;, ROOT_PATH, jsonArray);
313      assertEquals(8L, jsonClient.jsonArrInsert(&quot;test_arrinsert&quot;, ROOT_PATH, -1, &quot;foo&quot;));
314      Object[] array = jsonClient.jsonGet(&quot;test_arrinsert&quot;, Object[].class, ROOT_PATH);
315      assertArrayEquals(new Object[]{&quot;hello&quot;, &quot;world&quot;, true, 1.0, 3.0, null, &quot;foo&quot;, false}, array);
316    }
317    @Test
318    public void testArrayPop() {
319      jsonClient.jsonSet(&quot;arr&quot;, ROOT_PATH, new int[]{0, 1, 2, 3, 4});
320      assertEquals(Long.valueOf(4), jsonClient.jsonArrPop(&quot;arr&quot;, Long.class, ROOT_PATH));
321      assertEquals(Long.valueOf(3), jsonClient.jsonArrPop(&quot;arr&quot;, Long.class, ROOT_PATH, -1));
322      assertEquals(Long.valueOf(2), jsonClient.jsonArrPop(&quot;arr&quot;, Long.class));
323      assertEquals(Long.valueOf(0), jsonClient.jsonArrPop(&quot;arr&quot;, Long.class, ROOT_PATH, 0));
324      assertEquals(Double.valueOf(1), jsonClient.jsonArrPop(&quot;arr&quot;));
325    }
326    @Test
327    public void arrTrim() {
328      jsonClient.jsonSet(&quot;arr&quot;, ROOT_PATH, new int[]{0, 1, 2, 3, 4});
329      assertEquals(Long.valueOf(3), jsonClient.jsonArrTrim(&quot;arr&quot;, ROOT_PATH, 1, 3));
330      assertArrayEquals(new Integer[]{1, 2, 3}, jsonClient.jsonGet(&quot;arr&quot;, Integer[].class, ROOT_PATH));
331    }
332    @Test
333    public void strAppend() {
334      jsonClient.jsonSet(&quot;str&quot;, ROOT_PATH, &quot;foo&quot;);
335      assertEquals(6L, jsonClient.jsonStrAppend(&quot;str&quot;, ROOT_PATH, &quot;bar&quot;));
336      assertEquals(&quot;foobar&quot;, jsonClient.jsonGet(&quot;str&quot;, String.class, ROOT_PATH));
337      assertEquals(8L, jsonClient.jsonStrAppend(&quot;str&quot;, &quot;ed&quot;));
338      assertEquals(&quot;foobared&quot;, jsonClient.jsonGet(&quot;str&quot;));
339    }
340    @Test
341    public void strLen() {
342      assertNull(client.jsonStrLen(&quot;str&quot;));
343      jsonClient.jsonSet(&quot;str&quot;, ROOT_PATH, &quot;foo&quot;);
344      assertEquals(Long.valueOf(3), jsonClient.jsonStrLen(&quot;str&quot;));
345      assertEquals(Long.valueOf(3), jsonClient.jsonStrLen(&quot;str&quot;, ROOT_PATH));
346    }
347    @Test
348    public void numIncrBy() {
349      jsonClient.jsonSetLegacy(&quot;doc&quot;, gson.fromJson(&quot;{a:3}&quot;, JsonObject.class));
350      assertEquals(5d, jsonClient.jsonNumIncrBy(&quot;doc&quot;, Path.of(&quot;.a&quot;), 2), 0d);
351    }
352    @Test
353    public void obj() {
354      assertNull(client.jsonObjLen(&quot;doc&quot;));
355      assertNull(client.jsonObjKeys(&quot;doc&quot;));
356      assertNull(client.jsonObjLen(&quot;doc&quot;, ROOT_PATH));
357      assertNull(client.jsonObjKeys(&quot;doc&quot;, ROOT_PATH));
358      String json = &quot;{\&quot;a\&quot;:[3], \&quot;nested\&quot;: {\&quot;a\&quot;: {\&quot;b\&quot;:2, \&quot;c\&quot;: 1}}}&quot;;
359      jsonClient.jsonSetWithPlainString(&quot;doc&quot;, ROOT_PATH, json);
360      assertEquals(Long.valueOf(2), jsonClient.jsonObjLen(&quot;doc&quot;));
361      assertEquals(Arrays.asList(&quot;a&quot;, &quot;nested&quot;), jsonClient.jsonObjKeys(&quot;doc&quot;));
362      assertEquals(Long.valueOf(2), jsonClient.jsonObjLen(&quot;doc&quot;, Path.of(&quot;.nested.a&quot;)));
363      assertEquals(Arrays.asList(&quot;b&quot;, &quot;c&quot;), jsonClient.jsonObjKeys(&quot;doc&quot;, Path.of(&quot;.nested.a&quot;)));
364    }
365    @Test
366    public void debugMemory() {
367      assertEquals(0L, jsonClient.jsonDebugMemory(&quot;json&quot;));
368      assertEquals(0L, jsonClient.jsonDebugMemory(&quot;json&quot;, ROOT_PATH));
369      String json = &quot;{ foo: &#x27;bar&#x27;, bar: { foo: 10 }}&quot;;
370      JsonObject jsonObject = gson.fromJson(json, JsonObject.class);
371      jsonClient.jsonSet(&quot;json&quot;, ROOT_PATH, jsonObject);
372      jsonClient.jsonDebugMemory(&quot;json&quot;);
373      jsonClient.jsonDebugMemory(&quot;json&quot;, ROOT_PATH);
374      jsonClient.jsonDebugMemory(&quot;json&quot;, Path.of(&quot;.bar&quot;));
375    }
376    @Test
377    public void plainString() {
378      String json = &quot;{\&quot;foo\&quot;:\&quot;bar\&quot;,\&quot;bar\&quot;:{\&quot;foo\&quot;:10}}&quot;;
379      assertEquals(&quot;OK&quot;, jsonClient.jsonSetWithPlainString(&quot;plain&quot;, ROOT_PATH, json));
380      assertEquals(json, jsonClient.jsonGetAsPlainString(&quot;plain&quot;, ROOT_PATH));
381    }
382    @Test
383    public void resp() {
384      assertNull(client.jsonResp(&quot;resp&quot;));
385      assertNull(client.jsonResp(&quot;resp&quot;, ROOT_PATH));
386      String json = &quot;{\&quot;foo\&quot;: {\&quot;hello\&quot;:\&quot;world\&quot;}, \&quot;bar\&quot;: [null, 3, 2.5, true]}&quot;;
387      jsonClient.jsonSetWithPlainString(&quot;resp&quot;, ROOT_PATH, json);
388      List&lt;Object&gt; resp = jsonClient.jsonResp(&quot;resp&quot;);
389      assertEquals(&quot;{&quot;, resp.get(0));
390      assertEquals(&quot;foo&quot;, resp.get(1));
391      assertEquals(Arrays.asList(&quot;{&quot;, &quot;hello&quot;, &quot;world&quot;), resp.get(2));
392      assertEquals(&quot;bar&quot;, resp.get(3));
393      List&lt;Object&gt; arr = (List&lt;Object&gt;) resp.get(4);
394      assertEquals(&quot;[&quot;, arr.get(0));
395      assertNull(arr.get(1));
396      assertEquals(Long.valueOf(3), arr.get(2));
397      MatcherAssert.assertThat(arr.get(3), Matchers.isOneOf(&quot;2.5&quot;, 2.5));
398      assertEquals(&quot;true&quot;, arr.get(4));
399      arr = jsonClient.jsonResp(&quot;resp&quot;, Path.of(&quot;.bar&quot;));
400      assertEquals(&quot;[&quot;, arr.get(0));
401      assertNull(arr.get(1));
402      assertEquals(Long.valueOf(3), arr.get(2));
403      MatcherAssert.assertThat(arr.get(3), Matchers.isOneOf(&quot;2.5&quot;, 2.5));
404      assertEquals(&quot;true&quot;, arr.get(4));
405    }
406    @Test
407    public void testJsonGsonParser() {
408      Tick person = new Tick(&quot;foo&quot;, Instant.now());
409      client.setJsonObjectMapper(JsonObjectMapperTestUtil.getCustomGsonObjectMapper());
410      jsonClient.jsonSet(person.getId(), ROOT_PATH, person);
411      String valueExpected = jsonClient.jsonGet(person.getId(), String.class, Path.of(&quot;.created&quot;));
412      assertEquals(valueExpected, person.getCreated().toString());
413    }
414    @Test
415    public void testDefaultJsonGsonParserStringsMustBeDifferent() {
416      Tick person = new Tick(&quot;foo&quot;, Instant.now());
417      jsonClient.jsonSet(person.getId(), ROOT_PATH, person);
418      Object valueExpected = jsonClient.jsonGet(person.getId(), Path.of(&quot;.created&quot;));
419      assertNotEquals(valueExpected, person.getCreated().toString());
420    }
421    @Test
422    public void testJsonJacksonParser() {
423      Tick person = new Tick(&quot;foo&quot;, Instant.now());
424      client.setJsonObjectMapper(JsonObjectMapperTestUtil.getCustomJacksonObjectMapper());
425      jsonClient.jsonSet(person.getId(), ROOT_PATH, person);
426      String valueExpected = jsonClient.jsonGet(person.getId(), String.class, Path.of(&quot;.created&quot;));
427      assertEquals(valueExpected, person.getCreated().toString());
428    }
429  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-RedisJsonV2Test.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-RedisJsonV1Test.java</div>
                </div>
                <div class="column column_space"><pre><code>276      jsonClient.jsonSetWithEscape(&quot;quxquux&quot;, ROOT_PATH, new int[]{8, 6, 7, 5, 3, 0, 9});
277      assertEquals(singletonList(2L), jsonClient.jsonArrIndexWithEscape(&quot;quxquux&quot;, ROOT_PATH, 7));
</pre></code></div>
                <div class="column column_space"><pre><code>280      jsonClient.jsonSet(&quot;quxquux&quot;, ROOT_PATH, new int[]{8, 6, 7, 5, 3, 0, 9});
281      assertEquals(2L, jsonClient.jsonArrIndex(&quot;quxquux&quot;, ROOT_PATH, 7));
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    