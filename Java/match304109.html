<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for UserAuthenticationMethodTest.java & DocTableInfoTest.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for UserAuthenticationMethodTest.java & DocTableInfoTest.java
      </h3>
      <h1 align="center">
        26.6%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>UserAuthenticationMethodTest.java (29.565218%)<TH>DocTableInfoTest.java (24.285715%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match304109-0.html#0',2,'match304109-1.html#0',3)" NAME="0">(58-67)<TD><A HREF="javascript:ZweiFrames('match304109-0.html#0',2,'match304109-1.html#0',3)" NAME="0">(108-117)</A><TD ALIGN=center><FONT COLOR="#ff0000">13</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match304109-0.html#1',2,'match304109-1.html#1',3)" NAME="1">(24-38)<TD><A HREF="javascript:ZweiFrames('match304109-0.html#1',2,'match304109-1.html#1',3)" NAME="1">(37-50)</A><TD ALIGN=center><FONT COLOR="#d70000">11</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match304109-0.html#2',2,'match304109-1.html#2',3)" NAME="2">(67-73)<TD><A HREF="javascript:ZweiFrames('match304109-0.html#2',2,'match304109-1.html#2',3)" NAME="2">(160-177)</A><TD ALIGN=center><FONT COLOR="#c40000">10</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>UserAuthenticationMethodTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial agreement.
 */
<A NAME="1"></A>
package io.crate.auth;

<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match304109-1.html#1',3,'match304109-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>import io.crate.user.User;
import org.elasticsearch.test.ESTestCase;
import io.crate.user.SecureHash;
import org.elasticsearch.common.settings.SecureString;
import org.junit.Test;

import java.security.NoSuchAlgorithmException;
import java.security.spec.InvalidKeySpecException;
import java.util.Collections;

import static org.hamcrest.core.Is.is;

public class UserAuthenticationMethodTest extends ESTestCase {

    private Us</B></FONT>er userLookup(String userName) {
        if (userName.equals(&quot;crate&quot;)) {
            User user = null;
            try {
                SecureHash pwHash = SecureHash.of(new SecureString(&quot;pw&quot;.toCharArray()));
                user = User.of(&quot;crate&quot;, Collections.emptySet(), pwHash);
            } catch (NoSuchAlgorithmException | InvalidKeySpecException e) {
                // do nothing
            }
            assertNotNull(user);
            return user;
        }
        return null;
    }

    @Test
    public void testTrustAuthentication() throws Exception {
<A NAME="0"></A>        TrustAuthenticationMethod trustAuth = new TrustAuthenticationMethod(this::userLookup);
        assertThat(trustAuth.name(), is(&quot;trust&quot;));

        assertThat(<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match304109-1.html#0',3,'match304109-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>trustAuth.authenticate(&quot;crate&quot;, null, null).name(), is(&quot;crate&quot;));

        expectedException.expectMessage(&quot;trust authentication failed for user \&quot;cr8\&quot;&quot;);
        trustAuth.authenticate(&quot;cr8&quot;, null, null);
    }

<A NAME="2"></A>    @Test
    public void testAlwaysOKAuthentication() throws Exception {
        AlwaysOKAuthentication alwaysOkAuth = new AlwaysOKAuthentication(this::userLookup);
        AuthenticationMethod alwaysOkAuthMethod = <FONT color="#980517"><A HREF="javascript:ZweiFrames('match304109-1.html#2',3,'match304109-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>alwaysOkAuth.resolveAuthenticationType(&quot;crate&quot;, null)</B></FONT>;

        assertThat(alwaysOkAuthMethod.name(), is(&quot;trust&quot;));
        assertThat(alwaysOkAuthMethod.authenticate(&quot;crate&quot;, null, null).name(), is(&quot;crate&quot;));

        expectedException.expectMessage(&quot;authentication failed for user \&quot;cr8\&quot;&quot;);
        alwaysOkAuthMethod.authenticate</B></FONT>(&quot;cr8&quot;, null, null);
    }

    public void testPasswordAuthentication() throws Exception {
        PasswordAuthenticationMethod pwAuth = new PasswordAuthenticationMethod(this::userLookup);
        assertThat(pwAuth.name(), is(&quot;password&quot;));

        assertThat(pwAuth.authenticate(&quot;crate&quot;, new SecureString(&quot;pw&quot;.toCharArray()), null).name(), is(&quot;crate&quot;));
    }

    @Test
    public void testPasswordAuthenticationWrongPassword() throws Exception {
        PasswordAuthenticationMethod pwAuth = new PasswordAuthenticationMethod(this::userLookup);
        assertThat(pwAuth.name(), is(&quot;password&quot;));

        expectedException.expectMessage(&quot;password authentication failed for user \&quot;crate\&quot;&quot;);
        pwAuth.authenticate(&quot;crate&quot;, new SecureString(&quot;wrong&quot;.toCharArray()), null);
    }

    @Test
    public void testPasswordAuthenticationForNonExistingUser() throws Exception {
        PasswordAuthenticationMethod pwAuth = new PasswordAuthenticationMethod(this::userLookup);
        expectedException.expectMessage(&quot;password authentication failed for user \&quot;cr8\&quot;&quot;);
        pwAuth.authenticate(&quot;cr8&quot;, new SecureString(&quot;pw&quot;.toCharArray()), null);
    }
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>DocTableInfoTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial agreement.
 */

package io.crate.metadata.doc;

import io.crate.exceptions.ColumnUnknownException;
import io.crate.expression.symbol.DynamicReference;
import io.crate.expression.symbol.VoidReference;
import io.crate.metadata.ColumnIdent;
import io.crate.metadata.Reference;
import io.crate.metadata.ReferenceIdent;
import io.crate.metadata.RelationName;
import io.crate.metadata.RowGranularity;
import io.crate.metadata.Schemas;
import io.crate.metadata.table.Operation;
<A NAME="1"></A>import io.crate.sql.tree.ColumnPolicy;
import io.crate.testing.Asserts;
import org.elasticsearch.test.ESTestCase;
<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match304109-0.html#1',2,'match304109-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>import io.crate.types.DataTypes;
import org.elasticsearch.Version;
import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;
import org.elasticsearch.common.settings.Settings;
import org.junit.Test;

import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Map;

public class DocTableInfoTest extends ESTestCase {

    @Test</B></FONT>
    public void testGetColumnInfo() throws Exception {
        RelationName relationName = new RelationName(Schemas.DOC_SCHEMA_NAME, &quot;dummy&quot;);

        DocTableInfo info = new DocTableInfo(
            relationName,
            List.of(
                new Reference(
                    new ReferenceIdent(relationName, new ColumnIdent(&quot;o&quot;, List.of())),
                    RowGranularity.DOC,
                    DataTypes.UNTYPED_OBJECT,
                    1,
                    null
                )
            ),
            List.of(),
            List.of(),
            List.of(),
            Map.of(),
            Map.of(),
            Map.of(),
            List.of(),
            List.of(),
            null,
            true,
            new String[0],
            new String[0],
            new IndexNameExpressionResolver(),
            5,
            &quot;0&quot;,
            Settings.EMPTY,
            List.of(),
            List.of(),
            ColumnPolicy.DYNAMIC,
            Version.CURRENT,
            null,
            false,
            Operation.ALL
        );
        final ColumnIdent col = new ColumnIdent(&quot;o&quot;, List.of(&quot;foobar&quot;));
        Reference foobar = info.getReference(col);
        assertNull(foobar);

        // forWrite: false, errorOnUnknownObjectKey: true, parentPolicy: dynamic
        DynamicReference reference = info.getDynamic(col, false, true);
        assertNull(reference);

        // forWrite: true, errorOnUnknownObjectKey: true, parentPolicy: dynamic
        reference = info.getDynamic(col, true, true);
        assertNotNull(reference);
        assertSame(reference.valueType(), DataTypes.UNDEFINED);

        // forWrite: true, errorOnUnknownObjectKey: false, parentPolicy: dynamic
        reference = info.getDynamic(col, true, false);
        assertNotNull(reference);
<A NAME="0"></A>        assertSame(reference.valueType(), DataTypes.UNDEFINED);

        // forWrite: false, errorOnUnknownObjectKey: false, parentPolicy: dynamic
        reference = <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match304109-0.html#0',2,'match304109-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>info.getDynamic(col, false, false);
        assertNotNull(reference);
        assertTrue(reference instanceof VoidReference);
        assertSame(reference.valueType(), DataTypes.UNDEFINED);
    }

    @Test
    public void testGetColumnInfoStrictParent() throws Exception {
        RelationName dummy = new RelationName(Schemas.DOC_SCHEMA_NAME, &quot;dummy&quot;);
        ReferenceIdent foobarIdent = new ReferenceIdent(dummy, new ColumnIdent(&quot;foobar&quot;))</B></FONT>;
        Reference strictParent = new Reference(
            foobarIdent,
            RowGranularity.DOC,
            DataTypes.UNTYPED_OBJECT,
            ColumnPolicy.STRICT,
            Reference.IndexType.PLAIN,
            true,
            false,
            1,
            null
        );

        Map&lt;ColumnIdent, Reference&gt; references = Map.of(new ColumnIdent(&quot;foobar&quot;), strictParent);

        DocTableInfo info = new DocTableInfo(
            dummy,
            List.of(strictParent),
            List.of(),
            List.of(),
            List.of(),
            Map.of(),
            references,
            Map.of(),
            List.of(),
            List.of(),
            null,
            true,
            new String[0],
            new String[0],
            new IndexNameExpressionResolver(),
            5,
            &quot;0&quot;,
            Settings.EMPTY,
            List.of(),
            List.of(),
            ColumnPolicy.DYNAMIC,
            Version.CURRENT,
            null,
            false,
<A NAME="2"></A>            Operation.ALL
        );

        final ColumnIdent columnIdent = new ColumnIdent(&quot;foobar&quot;, <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match304109-0.html#2',2,'match304109-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>Arrays.asList(&quot;foo&quot;, &quot;bar&quot;));
        assertNull(info.getReference(columnIdent));

        // forWrite: false, errorOnUnknownObjectKey: true, parentPolicy: strict
        assertNull(info.getDynamic(columnIdent, false, true));

        // forWrite: true, errorOnUnknownObjectKey: true, parentPolicy: strict
        Asserts.assertThrowsMatches(
            () -&gt; info.getDynamic(columnIdent, true, true),
            ColumnUnknownException.class,
            &quot;Column foobar['foo']['bar'] unknown&quot;
        );

        // forWrite: false, errorOnUnknownObjectKey: false, parentPolicy: strict
        assertNull(info.getDynamic(columnIdent, false, false));

        // forWrite: true, errorOnUnknownObjectKey: false, parentPolicy: strict
        Asserts.assertThrowsMatches</B></FONT>(
            () -&gt; assertNull(info.getDynamic(columnIdent, true, false)),
            ColumnUnknownException.class,
            &quot;Column foobar['foo']['bar'] unknown&quot;
        );

        final ColumnIdent columnIdent2 = new ColumnIdent(&quot;foobar&quot;, Collections.singletonList(&quot;foo&quot;));
        assertNull(info.getReference(columnIdent2));

        // forWrite: false, errorOnUnknownObjectKey: true, parentPolicy: strict
        assertNull(info.getDynamic(columnIdent2, false, true));

        // forWrite: true, errorOnUnknownObjectKey: true, parentPolicy: strict
        Asserts.assertThrowsMatches(
            () -&gt; assertNull(info.getDynamic(columnIdent2, true, true)),
            ColumnUnknownException.class,
            &quot;Column foobar['foo'] unknown&quot;
        );

        // forWrite: false, errorOnUnknownObjectKey: false, parentPolicy: strict
        assertNull(info.getDynamic(columnIdent2, false, false));

        // forWrite: true, errorOnUnknownObjectKey: false, parentPolicy: strict
        Asserts.assertThrowsMatches(
            () -&gt; assertNull(info.getDynamic(columnIdent2, true, false)),
            ColumnUnknownException.class,
            &quot;Column foobar['foo'] unknown&quot;
        );

        Reference colInfo = info.getReference(new ColumnIdent(&quot;foobar&quot;));
        assertNotNull(colInfo);
    }
}
</PRE>
</div>
  </div>
</body>
</html>
