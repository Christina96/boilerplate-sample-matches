
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 17, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-ScriptingCommandsTest.java</h3>
            <pre><code>1  package redis.clients.jedis.commands.jedis;
2  import static org.junit.Assert.*;
3  import java.util.ArrayList;
4  import java.util.Arrays;
5  import java.util.Collections;
6  import java.util.List;
7  import java.util.Map;
8  import org.hamcrest.MatcherAssert;
9  import org.hamcrest.Matchers;
10  import org.junit.Before;
11  import org.junit.Test;
12  import redis.clients.jedis.Jedis;
13  import redis.clients.jedis.RedisProtocol;
14  import redis.clients.jedis.args.FlushMode;
15  import redis.clients.jedis.args.FunctionRestorePolicy;
16  import redis.clients.jedis.exceptions.JedisConnectionException;
17  import redis.clients.jedis.exceptions.JedisDataException;
18  import redis.clients.jedis.exceptions.JedisNoScriptException;
19  import redis.clients.jedis.resps.FunctionStats;
20  import redis.clients.jedis.resps.LibraryInfo;
21  import redis.clients.jedis.util.ClientKillerUtil;
22  import redis.clients.jedis.util.KeyValue;
23  import redis.clients.jedis.util.RedisProtocolUtil;
24  import redis.clients.jedis.util.SafeEncoder;
25  public class ScriptingCommandsTest extends JedisCommandsTestBase {
26    @Before
27    @Override
28    public void setUp() throws Exception {
29      super.setUp();
30      jedis.functionFlush();
31    }
32    final byte[] bfoo = { 0x01, 0x02, 0x03, 0x04 };
33    final byte[] bfoo1 = { 0x01, 0x02, 0x03, 0x04, 0x0A };
34    final byte[] bfoo2 = { 0x01, 0x02, 0x03, 0x04, 0x0B };
35    final byte[] bfoo3 = { 0x01, 0x02, 0x03, 0x04, 0x0C };
36    final byte[] bbar = { 0x05, 0x06, 0x07, 0x08 };
37    final byte[] bbar1 = { 0x05, 0x06, 0x07, 0x08, 0x0A };
38    final byte[] bbar2 = { 0x05, 0x06, 0x07, 0x08, 0x0B };
39    final byte[] bbar3 = { 0x05, 0x06, 0x07, 0x08, 0x0C };
40    final byte[] bfoobar = { 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08 };
41    @SuppressWarnings("unchecked")
42    @Test
43    public void evalMultiBulk() {
44      String script = "return {KEYS[1],KEYS[2],ARGV[1],ARGV[2],ARGV[3]}";
45      List<String> keys = new ArrayList<String>();
46      keys.add("key1");
47      keys.add("key2");
48      List<String> args = new ArrayList<String>();
49      args.add("first");
50      args.add("second");
51      args.add("third");
52      List<String> response = (List<String>) jedis.eval(script, keys, args);
53      assertEquals(5, response.size());
54      assertEquals("key1", response.get(0));
55      assertEquals("key2", response.get(1));
56      assertEquals("first", response.get(2));
57      assertEquals("second", response.get(3));
58      assertEquals("third", response.get(4));
59    }
60    @SuppressWarnings("unchecked")
61    @Test
62    public void evalMultiBulkWithBinaryJedis() {
63      String script = "return {KEYS[1],KEYS[2],ARGV[1],ARGV[2],ARGV[3]}";
64      List<byte[]> keys = new ArrayList<byte[]>();
65      keys.add("key1".getBytes());
66      keys.add("key2".getBytes());
67      List<byte[]> args = new ArrayList<byte[]>();
68      args.add("first".getBytes());
69      args.add("second".getBytes());
70      args.add("third".getBytes());
71      List<byte[]> responses = (List<byte[]>) jedis.eval(script.getBytes(), keys, args);
72      assertEquals(5, responses.size());
73      assertEquals("key1", new String(responses.get(0)));
74      assertEquals("key2", new String(responses.get(1)));
75      assertEquals("first", new String(responses.get(2)));
76      assertEquals("second", new String(responses.get(3)));
77      assertEquals("third", new String(responses.get(4)));
78    }
79    @Test
80    public void evalBulk() {
81      String script = "return KEYS[1]";
82      List<String> keys = new ArrayList<String>();
83      keys.add("key1");
84      List<String> args = new ArrayList<String>();
85      args.add("first");
<span onclick='openModal()' class='match'>86      String response = (String) jedis.eval(script, keys, args);
87      assertEquals("key1", response);
</span>88    }
89    @Test
90    public void evalInt() {
91      String script = "return 2";
92      List<String> keys = new ArrayList<String>();
93      keys.add("key1");
94      Long response = (Long) jedis.eval(script, keys, new ArrayList<String>());
95      assertEquals(Long.valueOf(2), response);
96    }
97    @Test
98    public void evalNestedLists() {
99      String script = "return { {KEYS[1]} , {2} }";
100      List<?> results = (List<?>) jedis.eval(script, 1, "key1");
101      MatcherAssert.assertThat((List<String>) results.get(0), Matchers.hasItem("key1"));
102      MatcherAssert.assertThat((List<Long>) results.get(1), Matchers.hasItem(2L));
103    }
104    @Test
105    public void evalNoArgs() {
106      String script = "return KEYS[1]";
107      List<String> keys = new ArrayList<String>();
108      keys.add("key1");
109      String response = (String) jedis.eval(script, keys, new ArrayList<String>());
110      assertEquals("key1", response);
111    }
112    @Test
113    public void evalReadonly() {
114      String script = "return KEYS[1]";
115      List<String> keys = new ArrayList<String>();
116      keys.add("key1");
117      List<String> args = new ArrayList<String>();
118      args.add("first");
119      String response = (String) jedis.evalReadonly(script, keys, args);
120      assertEquals("key1", response);
121    }
122    @Test
123    public void evalsha() {
124      jedis.set("foo", "bar");
125      jedis.eval("return redis.call('get','foo')");
126      String result = (String) jedis.evalsha("6b1bf486c81ceb7edf3c093f4c48582e38c0e791");
127      assertEquals("bar", result);
128    }
129    @Test
130    public void evalshaReadonly() {
131      jedis.set("foo", "bar");
132      jedis.eval("return redis.call('get','foo')");
133      String result = (String) jedis.evalshaReadonly("6b1bf486c81ceb7edf3c093f4c48582e38c0e791",
134              Collections.emptyList(), Collections.emptyList());
135      assertEquals("bar", result);
136    }
137    @Test
138    public void evalshaBinary() {
139      jedis.set(SafeEncoder.encode("foo"), SafeEncoder.encode("bar"));
140      jedis.eval(SafeEncoder.encode("return redis.call('get','foo')"));
141      byte[] result = (byte[]) jedis.evalsha(SafeEncoder
142          .encode("6b1bf486c81ceb7edf3c093f4c48582e38c0e791"));
143      assertArrayEquals(SafeEncoder.encode("bar"), result);
144    }
145    @Test
146    public void evalshaReadonlyBinary() {
147      jedis.set(SafeEncoder.encode("foo"), SafeEncoder.encode("bar"));
148      jedis.eval(SafeEncoder.encode("return redis.call('get','foo')"));
149      byte[] result = (byte[]) jedis.evalshaReadonly(SafeEncoder.encode("6b1bf486c81ceb7edf3c093f4c48582e38c0e791"),
150              Collections.emptyList(), Collections.emptyList());
151      assertArrayEquals(SafeEncoder.encode("bar"), result);
152    }
153    @Test(expected = JedisNoScriptException.class)
154    public void evalshaShaNotFound() {
155      jedis.evalsha("ffffffffffffffffffffffffffffffffffffffff");
156    }
157    @Test
158    public void scriptFlush() {
159      jedis.set("foo", "bar");
160      jedis.eval("return redis.call('get','foo')");
161      jedis.scriptFlush();
162      assertFalse(jedis.scriptExists("6b1bf486c81ceb7edf3c093f4c48582e38c0e791"));
163    }
164    @Test
165    public void scriptFlushMode() {
166      jedis.set("foo", "bar");
167      jedis.eval("return redis.call('get','foo')");
168      String sha1 = "6b1bf486c81ceb7edf3c093f4c48582e38c0e791";
169      assertTrue(jedis.scriptExists(sha1));
170      jedis.scriptFlush(FlushMode.SYNC);
171      assertFalse(jedis.scriptExists(sha1));
172    }
173    @Test
174    public void scriptExists() {
175      jedis.scriptLoad("return redis.call('get','foo')");
176      List<Boolean> exists = jedis.scriptExists("ffffffffffffffffffffffffffffffffffffffff",
177        "6b1bf486c81ceb7edf3c093f4c48582e38c0e791");
178      assertFalse(exists.get(0));
179      assertTrue(exists.get(1));
180    }
181    @Test
182    public void scriptExistsBinary() {
183      jedis.scriptLoad(SafeEncoder.encode("return redis.call('get','foo')"));
184      List<Boolean> exists = jedis.scriptExists(
185        SafeEncoder.encode("ffffffffffffffffffffffffffffffffffffffff"),
186        SafeEncoder.encode("6b1bf486c81ceb7edf3c093f4c48582e38c0e791"));
187      assertFalse(exists.get(0));
188      assertTrue(exists.get(1));
189    }
190    @Test
191    public void scriptLoad() {
192      jedis.scriptLoad("return redis.call('get','foo')");
193      assertTrue(jedis.scriptExists("6b1bf486c81ceb7edf3c093f4c48582e38c0e791"));
194    }
195    @Test
196    public void scriptLoadBinary() {
197      jedis.scriptLoad(SafeEncoder.encode("return redis.call('get','foo')"));
198      assertTrue(jedis.scriptExists(SafeEncoder.encode("6b1bf486c81ceb7edf3c093f4c48582e38c0e791")));
199    }
200    @Test
201    public void scriptKill() {
202      try {
203        jedis.scriptKill();
204      } catch (JedisDataException e) {
205        assertTrue(e.getMessage().contains("No scripts in execution right now."));
206      }
207    }
208    @Test
209    public void scriptEvalReturnNullValues() {
210      jedis.del("key1");
211      jedis.del("key2");
212      String script = "return {redis.call('hget',KEYS[1],ARGV[1]),redis.call('hget',KEYS[2],ARGV[2])}";
213      List<String> results = (List<String>) jedis.eval(script, 2, "key1", "key2", "1", "2");
214      assertEquals(2, results.size());
215      assertNull(results.get(0));
216      assertNull(results.get(1));
217    }
218    @Test
219    public void scriptEvalShaReturnNullValues() {
220      jedis.del("key1");
221      jedis.del("key2");
222      String script = "return {redis.call('hget',KEYS[1],ARGV[1]),redis.call('hget',KEYS[2],ARGV[2])}";
223      String sha = jedis.scriptLoad(script);
224      List<String> results = (List<String>) jedis.evalsha(sha, 2, "key1", "key2", "1", "2");
225      assertEquals(2, results.size());
226      assertNull(results.get(0));
227      assertNull(results.get(1));
228    }
229    @Test
230    public void scriptEvalShaReturnValues() {
231      jedis.hset("foo", "foo1", "bar1");
232      jedis.hset("foobar", "foo2", "bar2");
233      String script = "return {redis.call('hget',KEYS[1],ARGV[1]),redis.call('hget',KEYS[2],ARGV[2])}";
234      String sha = jedis.scriptLoad(script);
235      List<String> results = (List<String>) jedis.evalsha(sha, Arrays.asList("foo", "foobar"), Arrays.asList("foo1", "foo2"));
236      assertEquals(2, results.size());
237      assertEquals("bar1", results.get(0));
238      assertEquals("bar2", results.get(1));
239    }
240    @Test
241    public void scriptEvalShaReturnValuesBinary() {
242      jedis.hset(bfoo, bfoo1, bbar1);
243      jedis.hset(bfoobar, bfoo2, bbar2);
244      byte[] script = "return {redis.call('hget',KEYS[1],ARGV[1]),redis.call('hget',KEYS[2],ARGV[2])}".getBytes();
245      byte[] sha = jedis.scriptLoad(script);
246      List<byte[]> results = (List<byte[]>) jedis.evalsha(sha, Arrays.asList(bfoo, bfoobar), Arrays.asList(bfoo1, bfoo2));
247      assertEquals(2, results.size());
248      assertArrayEquals(bbar1, results.get(0));
249      assertArrayEquals(bbar2, results.get(1));
250    }
251    @Test
252    public void scriptExistsWithBrokenConnection() {
253      Jedis deadClient = createJedis();
254      deadClient.clientSetname("DEAD");
255      ClientKillerUtil.killClient(deadClient, "DEAD");
256      try {
257        deadClient.scriptExists("abcdefg");
258      } catch (JedisConnectionException e) {
259      }
260      assertEquals(true, deadClient.isBroken());
261      deadClient.close();
262    }
263    @Test
264    public void functionLoadAndDelete() {
265      String engine = "Lua";
266      String library = "mylib";
267      String function = "redis.register_function('myfunc', function(keys, args) return args[1] end)";
268      String functionCode = String.format("#!%s name=%s \n %s", engine, library, function);
269      assertEquals(library, jedis.functionLoad(functionCode));
270      assertEquals(library, jedis.functionLoadReplace(functionCode));
271      assertEquals("OK", jedis.functionDelete(library));
272      assertEquals(library, jedis.functionLoad(functionCode.getBytes()));
273      assertEquals(library, jedis.functionLoadReplace(functionCode.getBytes()));
274      assertEquals("OK", jedis.functionDelete(library.getBytes()));
275    }
276    @Test
277    public void functionFlush() {
278      String engine = "Lua";
279      String library = "mylib";
280      String function = "redis.register_function('myfunc', function(keys, args) return args[1] end)";
281      String functionCode = String.format("#!%s name=%s \n %s", engine, library, function);
282      assertEquals(library, jedis.functionLoad(functionCode));
283      jedis.functionFlush();
284      assertEquals(library, jedis.functionLoad(functionCode));
285      jedis.functionFlush(FlushMode.ASYNC);
286      assertEquals(library, jedis.functionLoad(functionCode));
287      jedis.functionFlush(FlushMode.SYNC);
288    }
289    @Test
290    public void functionList() {
291      String engine = "LUA";
292      String library = "mylib";
293      String function = "redis.register_function('myfunc', function(keys, args) return args[1] end)";
294      String functionCode = String.format("#!%s name=%s \n %s", engine, library, function);
295      jedis.functionLoad(functionCode);
296      LibraryInfo response = jedis.functionList().get(0);
297      assertEquals(library, response.getLibraryName());
298      assertEquals(engine, response.getEngine());
299      assertEquals(1, response.getFunctions().size());
300      Map func = response.getFunctions().get(0);
301      assertEquals("myfunc", func.get("name"));
302      assertNull(func.get("description"));
303      assertTrue(((List) func.get("flags")).isEmpty());
304      response = jedis.functionListWithCode().get(0);
305      assertEquals("myfunc", func.get("name"));
306      assertEquals(functionCode, response.getLibraryCode());
307      response = jedis.functionList(library).get(0);
308      assertEquals(library, response.getLibraryName());
309      response = jedis.functionListWithCode(library).get(0);
310      assertEquals(library, response.getLibraryName());
311      assertEquals(functionCode, response.getLibraryCode());
312      if (RedisProtocolUtil.getRedisProtocol() != RedisProtocol.RESP3) {
313        List<Object> bresponse = (List<Object>) jedis.functionListBinary().get(0);
314        assertArrayEquals(library.getBytes(), (byte[]) bresponse.get(1));
315        bresponse = (List<Object>) jedis.functionListWithCodeBinary().get(0);
316        assertArrayEquals(library.getBytes(), (byte[]) bresponse.get(1));
317        assertNotNull(bresponse.get(7));
318        bresponse = (List<Object>) jedis.functionList(library.getBytes()).get(0);
319        assertArrayEquals(library.getBytes(), (byte[]) bresponse.get(1));
320        bresponse = (List<Object>) jedis.functionListWithCode(library.getBytes()).get(0);
321        assertArrayEquals(library.getBytes(), (byte[]) bresponse.get(1));
322        assertNotNull(bresponse.get(7));
323      } else {
324        List<KeyValue> bresponse = (List<KeyValue>) jedis.functionListBinary().get(0);
325        assertArrayEquals(library.getBytes(), (byte[]) bresponse.get(0).getValue());
326        bresponse = (List<KeyValue>) jedis.functionListWithCodeBinary().get(0);
327        assertArrayEquals(library.getBytes(), (byte[]) bresponse.get(0).getValue());
328        assertNotNull(bresponse.get(3));
329        bresponse = (List<KeyValue>) jedis.functionList(library.getBytes()).get(0);
330        assertArrayEquals(library.getBytes(), (byte[]) bresponse.get(0).getValue());
331        bresponse = (List<KeyValue>) jedis.functionListWithCode(library.getBytes()).get(0);
332        assertArrayEquals(library.getBytes(), (byte[]) bresponse.get(0).getValue());
333        assertNotNull(bresponse.get(3));
334      }
335    }
336    @Test
337    public void functionDumpRestore() {
338      String engine = "Lua";
339      String library = "mylib";
340      String function = "redis.register_function('myfunc', function(keys, args) return args[1] end)";
341      jedis.functionLoad(String.format("#!%s name=%s \n %s", engine, library, function));
342      byte[] payload = jedis.functionDump();
343      jedis.functionFlush();
344      assertEquals("OK", jedis.functionRestore(payload));
345      jedis.functionFlush();
346      assertEquals("OK", jedis.functionRestore(payload, FunctionRestorePolicy.FLUSH));
347      jedis.functionFlush();
348      assertEquals("OK", jedis.functionRestore(payload, FunctionRestorePolicy.APPEND));
349      jedis.functionFlush();
350      assertEquals("OK", jedis.functionRestore(payload, FunctionRestorePolicy.REPLACE));
351      jedis.functionFlush();
352    }
353    @Test
354    public void functionStatsWithoutRunning() {
355      String engine = "Lua";
356      String library = "mylib";
357      String function = "redis.register_function('myfunc', function(keys, args) return args[1] end)";
358      jedis.functionLoad(String.format("#!%s name=%s \n %s", engine, library, function));
359      FunctionStats stats = jedis.functionStats();
360      assertNull(stats.getRunningScript());
361      assertEquals(1, stats.getEngines().size());
362    }
363    @Test
364    public void functionKillWithoutRunningFunction() {
365      String engine = "Lua";
366      String library = "mylib";
367      String function = "redis.register_function('myfunc', function(keys, args)\n local a = 1 while true do a = a + 1 end \nend)";
368      jedis.functionLoad(String.format("#!%s name=%s \n %s", engine, library, function));
369      try {
370        jedis.functionKill();
371        fail("Should get NOTBUSY error.");
372      } catch (JedisDataException jde) {
373        assertEquals("NOTBUSY No scripts in execution right now.", jde.getMessage());
374      }
375    }
376    @Test
377    public void fcall() {
378      String engine = "Lua";
379      String library = "mylib";
380      String function = "redis.register_function('myfunc', function(keys, args) return args end)";
381      jedis.functionLoad(String.format("#!%s name=%s \n %s", engine, library, function));
382      List<String> args = Arrays.asList("hello");
383      assertEquals(args, jedis.fcall("myfunc", Collections.emptyList(), args));
384    }
385    @Test
386    public void fcallBinary() {
387      String engine = "Lua";
388      String library = "mylib";
389      String function = "redis.register_function('myfunc', function(keys, args) return args[1] end)";
390      jedis.functionLoad(String.format("#!%s name=%s \n %s", engine, library, function));
391      List<byte[]> bargs = Arrays.asList("hello".getBytes());
392      assertArrayEquals("hello".getBytes(), (byte[]) jedis.fcall("myfunc".getBytes(), Collections.emptyList(), bargs));
393    }
394    @Test
395    public void fcallReadonly() {
396      String engine = "Lua";
397      String library = "mylib";
398      String function = "redis.register_function{function_name='noop', callback=function() return 1 end, flags={ 'no-writes' }}";
399      jedis.functionLoad(String.format("#!%s name=%s \n %s", engine, library, function));
400      assertEquals(Long.valueOf(1), jedis.fcallReadonly("noop", Collections.emptyList(), Collections.emptyList()));
401      assertEquals(Long.valueOf(1), jedis.fcallReadonly("noop".getBytes(), Collections.emptyList(), Collections.emptyList()));
402    }
403  }
</code></pre>
        </div>
        <div class="column">
            <h3>motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-RefererInvocationHandlerTest.java</h3>
            <pre><code>1  package com.weibo.api.motan.proxy;
2  import com.weibo.api.motan.BaseTestCase;
3  import com.weibo.api.motan.cluster.Cluster;
4  import com.weibo.api.motan.common.MotanConstants;
5  import com.weibo.api.motan.common.URLParamType;
6  import com.weibo.api.motan.exception.MotanBizException;
7  import com.weibo.api.motan.exception.MotanServiceException;
8  import com.weibo.api.motan.rpc.*;
9  import org.jmock.Expectations;
10  import org.junit.Test;
11  import java.lang.reflect.Method;
12  import java.util.ArrayList;
13  import java.util.List;
14  public class RefererInvocationHandlerTest extends BaseTestCase {
15      @SuppressWarnings({"rawtypes", "unchecked"})
16      @Test
17      public void testInvokeException() throws Throwable {
18          final Cluster cluster = mockery.mock(Cluster.class);
19          final URL u = new URL("motan", "local", 80, "test");
20          u.addParameter(URLParamType.nodeType.getName(), MotanConstants.NODE_TYPE_REFERER);
21          mockery.checking(new Expectations() {
22              {
23                  one(cluster).call(with(any(Request.class)));
24                  will(throwException(new MotanBizException("just test", new StackOverflowError())));
25                  allowing(cluster).getUrl();
26                  will(returnValue(u));
27              }
28          });
29          List<Cluster> clus = new ArrayList<Cluster>();
30          clus.add(cluster);
31          RefererInvocationHandler handler = new RefererInvocationHandler(String.class, clus);
32          Method[] methods = String.class.getMethods();
33          try {
34              handler.invoke(null, methods[1], null);
35          } catch (Exception e) {
36              assertTrue(e instanceof MotanServiceException);
37              assertTrue(e.getMessage().contains("StackOverflowError"));
38          }
39      }
40      @SuppressWarnings({"rawtypes", "unchecked"})
41      @Test
42      public void testLocalMehtod() throws Exception{
43          final Cluster cluster = mockery.mock(Cluster.class);
44          final URL u = new URL("motan", "local", 80, "test");
45          final List<Referer> referers = new ArrayList<Referer>();
46          final Referer referer = mockery.mock(Referer.class);
47          referers.add(referer);
48          mockery.checking(new Expectations() {
49              {
50                  allowing(cluster).getUrl();
51                  will(returnValue(u));
52                  allowing(referer).getUrl();
53                  will(returnValue(u));
54                  allowing(referer).isAvailable();
55                  will(returnValue(true));
56                  allowing(cluster).getReferers();
57                  will(returnValue(referers));
58              }
59          });
60          List<Cluster> clusters = new ArrayList<>();
61          clusters.add(cluster);
62          RefererInvocationHandler handler = new RefererInvocationHandler(TestService.class, clusters);
63          Method method = TestServiceImpl.class.getMethod("toString");
64          assertTrue(handler.isLocalMethod(method));
65          try {
<span onclick='openModal()' class='match'>66              String result = (String)handler.invoke(null, method, null);
67              assertEquals("{protocol:motan[motan:&bsol;&bsol;local:80/test?group=default_rpc, available:true]}", result);
</span>68          } catch (Throwable e) {
69              assertTrue(false);
70          }
71          method = TestServiceImpl.class.getMethod("hashCode");
72          assertTrue(handler.isLocalMethod(method));
73          method = TestServiceImpl.class.getMethod("hello");
74          assertFalse(handler.isLocalMethod(method));
75          method = TestServiceImpl.class.getMethod("equals", Object.class);
76          assertFalse(handler.isLocalMethod(method));
77      }
78      @Test
79      @SuppressWarnings({"rawtypes", "unchecked"})
80      public void testAsync() {
81          final Cluster cluster = mockery.mock(Cluster.class);
82          final URL u = new URL("motan", "local", 80, "test");
83          u.addParameter(URLParamType.nodeType.getName(), MotanConstants.NODE_TYPE_REFERER);
84          final ResponseFuture response = mockery.mock(ResponseFuture.class);
85          mockery.checking(new Expectations() {
86              {
87                  one(cluster).call(with(any(Request.class)));
88                  will(returnValue(response));
89                  allowing(cluster).getUrl();
90                  will(returnValue(u));
91                  allowing(response).setReturnType(with(any(Class.class)));
92                  allowing(response).setAttachment(with(any(String.class)), with(any(String.class)));
93              }
94          });
95          List<Cluster> clus = new ArrayList<Cluster>();
96          clus.add(cluster);
97          RefererInvocationHandler handler = new RefererInvocationHandler(String.class, clus);
98          Method method;
99          try {
100              method = TestService.class.getMethod("helloAsync", new Class<?>[] {});
101              ResponseFuture res = (ResponseFuture) handler.invoke(null, method, null);
102              assertEquals(response, res);
103              assertTrue((Boolean) RpcContext.getContext().getAttribute(MotanConstants.ASYNC_SUFFIX));
104          } catch (Throwable e) {
105              e.printStackTrace();
106              assertTrue(false);
107          }
108      }
109      interface TestService {
110          String hello();
111          ResponseFuture helloAsync();
112          boolean equals(Object o);
113      }
114      class TestServiceImpl implements TestService {
115          @Override
116          public String hello() {
117              return "hello";
118          }
119          @Override
120          public ResponseFuture helloAsync() {
121              return null;
122          }
123      }
124  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-ScriptingCommandsTest.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-RefererInvocationHandlerTest.java</div>
                </div>
                <div class="column column_space"><pre><code>86      String response = (String) jedis.eval(script, keys, args);
87      assertEquals("key1", response);
</pre></code></div>
                <div class="column column_space"><pre><code>66              String result = (String)handler.invoke(null, method, null);
67              assertEquals("{protocol:motan[motan:&bsol;&bsol;local:80/test?group=default_rpc, available:true]}", result);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    