<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for ClusterInfoServiceIT.java &amp; ShardUpsertRequest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for ClusterInfoServiceIT.java &amp; ShardUpsertRequest.java
      </h3>
<h1 align="center">
        8.4%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>ClusterInfoServiceIT.java (21.830986%)<th>ShardUpsertRequest.java (5.245347%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(20-45)<td><a href="#" name="0">(22-45)</a><td align="center"><font color="#ff0000">22</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(79-81)<td><a href="#" name="1">(168-175)</a><td align="center"><font color="#680000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>ClusterInfoServiceIT.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>package org.elasticsearch.cluster;
2 import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;
3 import static org.hamcrest.Matchers.greaterThan;
4 import static org.hamcrest.Matchers.greaterThanOrEqualTo;
5 import com.carrotsearch.hppc.cursors.ObjectCursor;
6 import org.elasticsearch.cluster.metadata.IndexMetadata;
7 import org.elasticsearch.cluster.node.DiscoveryNode;
8 import org.elasticsearch.cluster.routing.ShardRouting;
9 import org.elasticsearch.cluster.routing.allocation.decider.EnableAllocationDecider;
10 import org.elasticsearch.cluster.service.ClusterService;
11 import org.elasticsearch.common.collect.ImmutableOpenMap;
12 import org.elasticsearch.common.settings.Settings;
13 import org.elasticsearch.index.IndexService;
14 import org.elasticsearch.index.shard.IndexShard;
15 import org.elasticsearch.index.store.Store;
16 import org.elasticsearch.indices.IndicesService;
17 import org.elasticsearch.test.ESIntegTestCase;
18 import org.elasticsearch.test.InternalTestCluster;
19 import org.hamcrest.Matchers;
20 import org.junit.Test;
21 import io.crate.common.unit.TimeValue;
22 import</b></font> io.crate.integrationtests.SQLIntegrationTestCase;
23 import io.crate.testing.UseRandomizedSchema;
24 @ESIntegTestCase.ClusterScope(scope = ESIntegTestCase.Scope.TEST, numDataNodes = 0)
25 public class ClusterInfoServiceIT extends SQLIntegrationTestCase {
26     @Test
27     @UseRandomizedSchema(random = false)
28     public void testClusterInfoServiceCollectsInformation() throws Exception {
29         internalCluster().startNodes(2);
30         assertAcked(prepareCreate("test").setSettings(Settings.builder()
31                                                           .put(Store.INDEX_STORE_STATS_REFRESH_INTERVAL_SETTING.getKey(), 0)
32                                                           .put(IndexMetadata.INDEX_NUMBER_OF_SHARDS_SETTING.getKey(), 1)
33                                                           .put(EnableAllocationDecider.INDEX_ROUTING_REBALANCE_ENABLE_SETTING.getKey(),
34                                                                EnableAllocationDecider.Rebalance.NONE).build()));
35         if (randomBoolean()) {
36             execute("alter table test close");
37         }
38         ensureGreen("test");
39         InternalTestCluster internalTestCluster = internalCluster();
40         final InternalClusterInfoService infoService = (InternalClusterInfoService) internalTestCluster
41             .getInstance(ClusterInfoService.class, internalTestCluster.getMasterName());
42         infoService.setUpdateFrequency(TimeValue.timeValueMillis(200));
43         ClusterInfo info = infoService.refresh();
44         assertNotNull("info should not be null", info);
45         ImmutableOpenMap&lt;String, DiskUsage&gt; leastUsages = info.getNodeLeastAvailableDiskUsages();
46         ImmutableOpenMap&lt;String, DiskUsage&gt; mostUsages = info.getNodeMostAvailableDiskUsages();
47 <a name="1"></a>        ImmutableOpenMap&lt;String, Long&gt; shardSizes = info.shardSizes;
48         assertNotNull(leastUsages);
49         assertNotNull(shardSizes);
50         assertThat("some usages are populated", <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>leastUsages.values().size(), Matchers.equalTo(2));
51         assertThat("some shard sizes are populated", shardSizes.values().size(), greaterThan(0));
52         for (ObjectCursor&lt;DiskUsage&gt; usage</b></font> : leastUsages.values()) {
53             logger.info("--&gt; usage: {}", usage.value);
54             assertThat("usage has be retrieved", usage.value.getFreeBytes(), greaterThan(0L));
55         }
56         for (ObjectCursor&lt;DiskUsage&gt; usage : mostUsages.values()) {
57             logger.info("--&gt; usage: {}", usage.value);
58             assertThat("usage has be retrieved", usage.value.getFreeBytes(), greaterThan(0L));
59         }
60         for (ObjectCursor&lt;Long&gt; size : shardSizes.values()) {
61             logger.info("--&gt; shard size: {}", size.value);
62             assertThat("shard size is greater than 0", size.value, greaterThanOrEqualTo(0L));
63         }
64         ClusterService clusterService = internalTestCluster.getInstance(ClusterService.class, internalTestCluster.getMasterName());
65         ClusterState state = clusterService.state();
66         for (ShardRouting shard : state.routingTable().allShards()) {
67             String dataPath = info.getDataPath(shard);
68             assertNotNull(dataPath);
69             String nodeId = shard.currentNodeId();
70             DiscoveryNode discoveryNode = state.getNodes().get(nodeId);
71             IndicesService indicesService = internalTestCluster.getInstance(IndicesService.class, discoveryNode.getName());
72             IndexService indexService = indicesService.indexService(shard.index());
73             IndexShard indexShard = indexService.getShardOrNull(shard.id());
74             assertEquals(indexShard.shardPath().getRootDataPath().toString(), dataPath);
75         }
76     }
77 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>ShardUpsertRequest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>package io.crate.execution.dml.upsert;
2 import io.crate.Streamer;
3 import io.crate.execution.dml.ShardRequest;
4 import io.crate.expression.symbol.Symbol;
5 import io.crate.expression.symbol.Symbols;
6 import io.crate.metadata.Reference;
7 import io.crate.metadata.settings.SessionSettings;
8 import org.elasticsearch.Version;
9 import org.elasticsearch.common.bytes.BytesReference;
10 import org.elasticsearch.common.io.stream.StreamInput;
11 import org.elasticsearch.common.io.stream.StreamOutput;
12 import org.elasticsearch.common.lucene.uid.Versions;
13 import io.crate.common.unit.TimeValue;
14 import org.elasticsearch.index.seqno.SequenceNumbers;
15 import org.elasticsearch.index.shard.ShardId;
16 import javax.annotation.Nullable;
17 import java.io.IOException;
18 import java.util.ArrayList;
19 import java.util.Arrays;
20 import java.util.List;
21 import java.util.Objects;
22 import</b></font> java.util.UUID;
23 public final class ShardUpsertRequest extends ShardRequest&lt;ShardUpsertRequest, ShardUpsertRequest.Item&gt; {
24     public enum DuplicateKeyAction {
25         UPDATE_OR_FAIL,
26         OVERWRITE,
27         IGNORE
28     }
29     private final DuplicateKeyAction duplicateKeyAction;
30     private final boolean continueOnError;
31     private final boolean validation;
32     private boolean isRetry = false;
33     private final SessionSettings sessionSettings;
34     @Nullable
35     private String[] updateColumns;
36     @Nullable
37     private Reference[] insertColumns;
38     @Nullable
39     private Symbol[] returnValues;
40     public ShardUpsertRequest(
41         ShardId shardId,
42         UUID jobId,
43         boolean continueOnError,
44         boolean validation,
45         DuplicateKeyAction duplicateKeyAction,
46         SessionSettings sessionSettings,
47         @Nullable String[] updateColumns,
48         @Nullable Reference[] insertColumns,
49         @Nullable Symbol[] returnValues) {
50         super(shardId, jobId);
51         assert updateColumns != null || insertColumns != null : "Missing updateAssignments, whether for update nor for insert";
52         this.continueOnError = continueOnError;
53         this.validation = validation;
54         this.duplicateKeyAction = duplicateKeyAction;
55         this.sessionSettings = sessionSettings;
56         this.updateColumns = updateColumns;
57         this.insertColumns = insertColumns;
58         this.returnValues = returnValues;
59     }
60     public ShardUpsertRequest(StreamInput in) throws IOException {
61         super(in);
62         int assignmentsColumnsSize = in.readVInt();
63         if (assignmentsColumnsSize &gt; 0) {
64             updateColumns = new String[assignmentsColumnsSize];
65             for (int i = 0; i &lt; assignmentsColumnsSize; i++) {
66                 updateColumns[i] = in.readString();
67             }
68         }
69         int missingAssignmentsColumnsSize = in.readVInt();
70         Streamer[] insertValuesStreamer = null;
71         if (missingAssignmentsColumnsSize &gt; 0) {
72             insertColumns = new Reference[missingAssignmentsColumnsSize];
73             for (int i = 0; i &lt; missingAssignmentsColumnsSize; i++) {
74                 insertColumns[i] = Reference.fromStream(in);
75             }
76             insertValuesStreamer = Symbols.streamerArray(List.of(insertColumns));
77         }
78         continueOnError = in.readBoolean();
79         duplicateKeyAction = DuplicateKeyAction.values()[in.readVInt()];
80         validation = in.readBoolean();
81         sessionSettings = new SessionSettings(in);
82         int numItems = in.readVInt();
83         items = new ArrayList&lt;&gt;(numItems);
84         for (int i = 0; i &lt; numItems; i++) {
85             items.add(new Item(in, insertValuesStreamer));
86         }
87         if (in.getVersion().onOrAfter(Version.V_4_2_0)) {
88             int returnValuesSize = in.readVInt();
89             if (returnValuesSize &gt; 0) {
90                 returnValues = new Symbol[returnValuesSize];
91                 for (int i = 0; i &lt; returnValuesSize; i++) {
92                     returnValues[i] = Symbols.fromStream(in);
93                 }
94             }
95         }
96         if (in.getVersion().onOrAfter(Version.V_4_8_0)) {
97             isRetry = in.readBoolean();
98         } else {
99             isRetry = false;
100         }
101     }
102     @Override
103     public void writeTo(StreamOutput out) throws IOException {
104         super.writeTo(out);
105         if (updateColumns != null) {
106             out.writeVInt(updateColumns.length);
107             for (String column : updateColumns) {
108                 out.writeString(column);
109             }
110         } else {
111             out.writeVInt(0);
112         }
113         Streamer[] insertValuesStreamer = null;
114         if (insertColumns != null) {
115             out.writeVInt(insertColumns.length);
116             for (Reference reference : insertColumns) {
117                 Reference.toStream(reference, out);
118             }
119             insertValuesStreamer = Symbols.streamerArray(List.of(insertColumns));
120         } else {
121 <a name="1"></a>            out.writeVInt(0);
122         }
123         <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>out.writeBoolean(continueOnError);
124         out.writeVInt(duplicateKeyAction.ordinal());
125         out.writeBoolean(validation);
126         sessionSettings.writeTo(out);
127         out.writeVInt(items.size());
128         for (Item item</b></font> : items) {
129             item.writeTo(out, insertValuesStreamer);
130         }
131         if (out.getVersion().onOrAfter(Version.V_4_2_0)) {
132             if (returnValues != null) {
133                 out.writeVInt(returnValues.length);
134                 for (Symbol returnValue : returnValues) {
135                     Symbols.toStream(returnValue, out);
136                 }
137             } else {
138                 out.writeVInt(0);
139             }
140         }
141         if (out.getVersion().onOrAfter(Version.V_4_8_0)) {
142             out.writeBoolean(isRetry);
143         }
144     }
145     @Override
146     public void onRetry() {
147         this.isRetry = true;
148     }
149     public boolean isRetry() {
150         return isRetry;
151     }
152     @Nullable
153     public SessionSettings sessionSettings() {
154         return sessionSettings;
155     }
156     @Nullable
157     public Symbol[] returnValues() {
158         return returnValues;
159     }
160     @Nullable
161     public String[] updateColumns() {
162         return updateColumns;
163     }
164     @Nullable
165     public Reference[] insertColumns() {
166         return insertColumns;
167     }
168     public boolean continueOnError() {
169         return continueOnError;
170     }
171     public boolean validation() {
172         return validation;
173     }
174     public DuplicateKeyAction duplicateKeyAction() {
175         return duplicateKeyAction;
176     }
177     @Override
178     public boolean equals(Object o) {
179         if (this == o) {
180             return true;
181         }
182         if (o == null || getClass() != o.getClass()) {
183             return false;
184         }
185         if (!super.equals(o)) {
186             return false;
187         }
188         ShardUpsertRequest items = (ShardUpsertRequest) o;
189         return continueOnError == items.continueOnError &amp;&amp;
190                validation == items.validation &amp;&amp;
191                Objects.equals(sessionSettings, items.sessionSettings) &amp;&amp;
192                duplicateKeyAction == items.duplicateKeyAction &amp;&amp;
193                Arrays.equals(updateColumns, items.updateColumns) &amp;&amp;
194                Arrays.equals(insertColumns, items.insertColumns) &amp;&amp;
195                Arrays.equals(returnValues, items.returnValues);
196     }
197     @Override
198     public int hashCode() {
199         int result = Objects.hash(super.hashCode(),
200                                   sessionSettings,
201                                   duplicateKeyAction,
202                                   continueOnError,
203                                   validation);
204         result = 31 * result + Arrays.hashCode(updateColumns);
205         result = 31 * result + Arrays.hashCode(insertColumns);
206         result = 31 * result + Arrays.hashCode(returnValues);
207         return result;
208     }
209     public static final class Item extends ShardRequest.Item {
210         @Nullable
211         private BytesReference source;
212         @Nullable
213         private Symbol[] updateAssignments;
214         @Nullable
215         private Object[] insertValues;
216         public Item(String id,
217                     @Nullable Symbol[] updateAssignments,
218                     @Nullable Object[] insertValues,
219                     @Nullable Long version,
220                     @Nullable Long seqNo,
221                     @Nullable Long primaryTerm
222         ) {
223             super(id);
224             this.updateAssignments = updateAssignments;
225             if (version != null) {
226                 this.version = version;
227             }
228             if (seqNo != null) {
229                 this.seqNo = seqNo;
230             }
231             if (primaryTerm != null) {
232                 this.primaryTerm = primaryTerm;
233             }
234             this.insertValues = insertValues;
235         }
236         @Nullable
237         public BytesReference source() {
238             return source;
239         }
240         public void source(BytesReference source) {
241             this.source = source;
242         }
243         boolean retryOnConflict() {
244             return seqNo == SequenceNumbers.UNASSIGNED_SEQ_NO &amp;&amp; version == Versions.MATCH_ANY;
245         }
246         @Nullable
247         Symbol[] updateAssignments() {
248             return updateAssignments;
249         }
250         @Nullable
251         public Object[] insertValues() {
252             return insertValues;
253         }
254         public Item(StreamInput in, @Nullable Streamer[] insertValueStreamers) throws IOException {
255             super(in);
256             if (in.readBoolean()) {
257                 int assignmentsSize = in.readVInt();
258                 updateAssignments = new Symbol[assignmentsSize];
259                 for (int i = 0; i &lt; assignmentsSize; i++) {
260                     updateAssignments[i] = Symbols.fromStream(in);
261                 }
262             }
263             int missingAssignmentsSize = in.readVInt();
264             if (missingAssignmentsSize &gt; 0) {
265                 assert insertValueStreamers != null : "streamers are required if reading insert values";
266                 this.insertValues = new Object[missingAssignmentsSize];
267                 for (int i = 0; i &lt; missingAssignmentsSize; i++) {
268                     insertValues[i] = insertValueStreamers[i].readValueFrom(in);
269                 }
270             }
271             if (in.readBoolean()) {
272                 source = in.readBytesReference();
273             }
274         }
275         public void writeTo(StreamOutput out, @Nullable Streamer[] insertValueStreamers) throws IOException {
276             super.writeTo(out);
277             if (updateAssignments != null) {
278                 out.writeBoolean(true);
279                 out.writeVInt(updateAssignments.length);
280                 for (Symbol updateAssignment : updateAssignments) {
281                     Symbols.toStream(updateAssignment, out);
282                 }
283             } else {
284                 out.writeBoolean(false);
285             }
286             if (insertValues != null) {
287                 assert insertValueStreamers != null : "streamers are required to stream insert values";
288                 out.writeVInt(insertValues.length);
289                 for (int i = 0; i &lt; insertValues.length; i++) {
290                     insertValueStreamers[i].writeValueTo(out, insertValues[i]);
291                 }
292             } else {
293                 out.writeVInt(0);
294             }
295             boolean sourceAvailable = source != null;
296             out.writeBoolean(sourceAvailable);
297             if (sourceAvailable) {
298                 out.writeBytesReference(source);
299             }
300         }
301         @Override
302         public boolean equals(Object o) {
303             if (this == o) {
304                 return true;
305             }
306             if (o == null || getClass() != o.getClass()) {
307                 return false;
308             }
309             if (!super.equals(o)) {
310                 return false;
311             }
312             Item item = (Item) o;
313             return Objects.equals(source, item.source) &amp;&amp;
314                    Arrays.equals(updateAssignments, item.updateAssignments) &amp;&amp;
315                    Arrays.equals(insertValues, item.insertValues);
316         }
317         @Override
318         public int hashCode() {
319             int result = Objects.hash(super.hashCode(), source);
320             result = 31 * result + Arrays.hashCode(updateAssignments);
321             result = 31 * result + Arrays.hashCode(insertValues);
322             return result;
323         }
324     }
325     public static class Builder {
326         private final SessionSettings sessionSettings;
327         private final TimeValue timeout;
328         private final DuplicateKeyAction duplicateKeyAction;
329         private final boolean continueOnError;
330         @Nullable
331         private final String[] assignmentsColumns;
332         @Nullable
333         private final Reference[] missingAssignmentsColumns;
334         private final UUID jobId;
335         private final boolean validation;
336         @Nullable
337         private final Symbol[] returnValues;
338         public Builder(SessionSettings sessionSettings,
339                        TimeValue timeout,
340                        DuplicateKeyAction duplicateKeyAction,
341                        boolean continueOnError,
342                        @Nullable String[] assignmentsColumns,
343                        @Nullable Reference[] missingAssignmentsColumns,
344                        @Nullable Symbol[] returnValue,
345                        UUID jobId,
346                        boolean validation) {
347             this.sessionSettings = sessionSettings;
348             this.timeout = timeout;
349             this.duplicateKeyAction = duplicateKeyAction;
350             this.continueOnError = continueOnError;
351             this.assignmentsColumns = assignmentsColumns;
352             this.missingAssignmentsColumns = missingAssignmentsColumns;
353             this.jobId = jobId;
354             this.returnValues = returnValue;
355             this.validation = validation;
356         }
357         public ShardUpsertRequest newRequest(ShardId shardId) {
358             return new ShardUpsertRequest(
359                 shardId,
360                 jobId,
361                 continueOnError,
362                 validation,
363                 duplicateKeyAction,
364                 sessionSettings,
365                 assignmentsColumns,
366                 missingAssignmentsColumns,
367                 returnValues
368             ).timeout(timeout);
369         }
370     }
371 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
