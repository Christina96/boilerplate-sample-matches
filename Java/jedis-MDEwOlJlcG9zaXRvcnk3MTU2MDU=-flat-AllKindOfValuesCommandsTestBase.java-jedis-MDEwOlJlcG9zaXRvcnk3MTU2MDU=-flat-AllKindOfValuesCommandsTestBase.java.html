
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 31, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-AllKindOfValuesCommandsTestBase.java</h3>
            <pre><code>1  package redis.clients.jedis.commands.unified;
2  import static org.hamcrest.MatcherAssert.assertThat;
3  import static org.junit.Assert.assertArrayEquals;
4  import static org.junit.Assert.assertEquals;
5  import static org.junit.Assert.assertFalse;
6  import static org.junit.Assert.assertTrue;
7  import static org.junit.Assert.assertNotNull;
8  import static org.junit.Assert.assertNull;
9  import static org.junit.Assert.fail;
10  import static redis.clients.jedis.Protocol.Command.BLPOP;
11  import static redis.clients.jedis.Protocol.Command.GET;
12  import static redis.clients.jedis.Protocol.Command.HGETALL;
13  import static redis.clients.jedis.Protocol.Command.LRANGE;
14  import static redis.clients.jedis.Protocol.Command.PING;
15  import static redis.clients.jedis.Protocol.Command.RPUSH;
16  import static redis.clients.jedis.Protocol.Command.SET;
17  import static redis.clients.jedis.Protocol.Command.XINFO;
18  import static redis.clients.jedis.util.SafeEncoder.encode;
19  import static redis.clients.jedis.util.SafeEncoder.encodeObject;
20  import static redis.clients.jedis.params.ScanParams.SCAN_POINTER_START;
21  import static redis.clients.jedis.params.ScanParams.SCAN_POINTER_START_BINARY;
22  import java.util.ArrayList;
23  import java.util.Arrays;
24  import java.util.Collections;
25  import java.util.HashMap;
26  import java.util.HashSet;
27  import java.util.List;
28  import java.util.Set;
29  import org.hamcrest.Matchers;
30  import org.junit.Assume;
31  import org.junit.Test;
32  import redis.clients.jedis.RedisProtocol;
33  import redis.clients.jedis.ScanIteration;
34  import redis.clients.jedis.StreamEntryID;
35  import redis.clients.jedis.args.ExpiryOption;
36  import redis.clients.jedis.params.ScanParams;
37  import redis.clients.jedis.resps.ScanResult;
38  import redis.clients.jedis.params.RestoreParams;
39  import redis.clients.jedis.exceptions.JedisDataException;
40  import redis.clients.jedis.params.SetParams;
41  import redis.clients.jedis.util.AssertUtil;
42  import redis.clients.jedis.util.KeyValue;
43  import redis.clients.jedis.util.RedisProtocolUtil;
44  import redis.clients.jedis.util.SafeEncoder;
45  public abstract class AllKindOfValuesCommandsTestBase extends UnifiedJedisCommandsTestBase {
46    protected final byte[] bfoo = { 0x01, 0x02, 0x03, 0x04 };
47    protected final byte[] bfoo1 = { 0x01, 0x02, 0x03, 0x04, 0x0A };
48    protected final byte[] bfoo2 = { 0x01, 0x02, 0x03, 0x04, 0x0B };
49    protected final byte[] bfoo3 = { 0x01, 0x02, 0x03, 0x04, 0x0C };
50    protected final byte[] bbar = { 0x05, 0x06, 0x07, 0x08 };
51    protected final byte[] bbar1 = { 0x05, 0x06, 0x07, 0x08, 0x0A };
52    protected final byte[] bbar2 = { 0x05, 0x06, 0x07, 0x08, 0x0B };
53    protected final byte[] bbar3 = { 0x05, 0x06, 0x07, 0x08, 0x0C };
54    protected final byte[] bfoobar = { 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08 };
55    protected final byte[] bfoostar = { 0x01, 0x02, 0x03, 0x04, '*' };
56    protected final byte[] bbarstar = { 0x05, 0x06, 0x07, 0x08, '*' };
57    protected final byte[] bnx = { 0x6E, 0x78 };
58    protected final byte[] bex = { 0x65, 0x78 };
59    final int expireSeconds = 2;
60    @Test
61    public void exists() {
62      String status = jedis.set("foo", "bar");
63      assertEquals("OK", status);
64      status = jedis.set(bfoo, bbar);
65      assertEquals("OK", status);
66      assertTrue(jedis.exists("foo"));
67      assertTrue(jedis.exists(bfoo));
68      assertEquals(1L, jedis.del("foo"));
69      assertEquals(1L, jedis.del(bfoo));
70      assertFalse(jedis.exists("foo"));
71      assertFalse(jedis.exists(bfoo));
72    }
73    @Test
74    public void existsMany() {
75      String status = jedis.set("foo1", "bar1");
76      assertEquals("OK", status);
77      status = jedis.set("foo2", "bar2");
78      assertEquals("OK", status);
79      assertEquals(2L, jedis.exists("foo1", "foo2"));
80      assertEquals(1L, jedis.del("foo1"));
81      assertEquals(1L, jedis.exists("foo1", "foo2"));
82    }
83    @Test
84    public void del() {
85      jedis.set("foo1", "bar1");
86      jedis.set("foo2", "bar2");
87      jedis.set("foo3", "bar3");
88      assertEquals(3L, jedis.del("foo1", "foo2", "foo3"));
89      assertFalse(jedis.exists("foo1"));
90      assertFalse(jedis.exists("foo2"));
91      assertFalse(jedis.exists("foo3"));
92      jedis.set("foo1", "bar1");
93      assertEquals(1L, jedis.del("foo1", "foo2"));
94      assertEquals(0L, jedis.del("foo1", "foo2"));
95      jedis.set(bfoo1, bbar1);
96      jedis.set(bfoo2, bbar2);
97      jedis.set(bfoo3, bbar3);
98      assertEquals(3L, jedis.del(bfoo1, bfoo2, bfoo3));
99      assertFalse(jedis.exists(bfoo1));
100      assertFalse(jedis.exists(bfoo2));
101      assertFalse(jedis.exists(bfoo3));
102      jedis.set(bfoo1, bbar1);
103      assertEquals(1, jedis.del(bfoo1, bfoo2));
104      assertEquals(0, jedis.del(bfoo1, bfoo2));
105    }
106    @Test
107    public void unlink() {
108      jedis.set("foo1", "bar1");
109      jedis.set("foo2", "bar2");
110      jedis.set("foo3", "bar3");
111      assertEquals(3, jedis.unlink("foo1", "foo2", "foo3"));
112      assertEquals(0, jedis.exists("foo1", "foo2", "foo3"));
113      jedis.set("foo1", "bar1");
114      assertEquals(1, jedis.unlink("foo1", "foo2"));
115      assertEquals(0, jedis.unlink("foo1", "foo2"));
116      jedis.set("foo", "bar");
117      assertEquals(1, jedis.unlink("foo"));
118      assertFalse(jedis.exists("foo"));
119      jedis.set(bfoo1, bbar1);
120      jedis.set(bfoo2, bbar2);
121      jedis.set(bfoo3, bbar3);
122      assertEquals(3, jedis.unlink(bfoo1, bfoo2, bfoo3));
123      assertEquals(0, jedis.exists(bfoo1, bfoo2, bfoo3));
124      jedis.set(bfoo1, bbar1);
125      assertEquals(1, jedis.unlink(bfoo1, bfoo2));
126      assertEquals(0, jedis.unlink(bfoo1, bfoo2));
127      jedis.set(bfoo, bbar);
128      assertEquals(1, jedis.unlink(bfoo));
129      assertFalse(jedis.exists(bfoo));
130    }
131    @Test
132    public void type() {
133      jedis.set("foo", "bar");
134      assertEquals("string", jedis.type("foo"));
135      jedis.set(bfoo, bbar);
136      assertEquals("string", jedis.type(bfoo));
137    }
138    @Test
139    public void keys() {
140      jedis.set("foo", "bar");
141      jedis.set("foobar", "bar");
142      Set<String> keys = jedis.keys("foo*");
143      AssertUtil.assertCollectionContains(keys, "foo");
144      AssertUtil.assertCollectionContains(keys, "foobar");
145      assertEquals(Collections.emptySet(), jedis.keys("bar*"));
146      jedis.set(bfoo, bbar);
147      jedis.set(bfoobar, bbar);
148      Set<byte[]> bkeys = jedis.keys(bfoostar);
149      AssertUtil.assertByteArrayCollectionContains(bkeys, bfoo);
150      AssertUtil.assertByteArrayCollectionContains(bkeys, bfoobar);
151      assertEquals(Collections.emptySet(), jedis.keys(bbarstar));
152    }
153    @Test
154    public void randomKey() {
155      assertNull(jedis.randomKey());
156      for (int i = 0; i < 100; i++) {
157        jedis.set("foo" + i, "bar"+i);
158      }
159      String key = jedis.randomKey();
160      assertNotNull(key);
161      assertTrue(key.startsWith("foo"));
162      assertEquals(key.replace("foo", "bar"), jedis.get(key));
163    }
164    @Test
165    public void rename() {
166      jedis.set("foo", "bar");
167      String status = jedis.rename("foo", "bar");
168      assertEquals("OK", status);
169      assertNull(jedis.get("foo"));
170      assertEquals("bar", jedis.get("bar"));
171      jedis.set(bfoo, bbar);
172      String bstatus = jedis.rename(bfoo, bbar);
173      assertEquals("OK", bstatus);
174      assertNull(jedis.get(bfoo));
175      assertArrayEquals(bbar, jedis.get(bbar));
176    }
177    @Test
178    public void renameOldAndNewAreTheSame() {
179      assertEquals("OK", jedis.set("foo", "bar"));
180      assertEquals("OK", jedis.rename("foo", "foo"));
181      assertEquals("OK", jedis.set(bfoo, bbar));
182      assertEquals("OK", jedis.rename(bfoo, bfoo));
183    }
184    @Test
185    public void renamenx() {
186      jedis.set("foo", "bar");
187      assertEquals(1, jedis.renamenx("foo", "bar"));
188      jedis.set("foo", "bar");
189      assertEquals(0, jedis.renamenx("foo", "bar"));
190      jedis.set(bfoo, bbar);
191      assertEquals(1, jedis.renamenx(bfoo, bbar));
192      jedis.set(bfoo, bbar);
193      assertEquals(0, jedis.renamenx(bfoo, bbar));
194    }
195    @Test
196    public void dbSize() {
197      assertEquals(0, jedis.dbSize());
198      jedis.set("foo", "bar");
199      assertEquals(1, jedis.dbSize());
200      jedis.set(bfoo, bbar);
201      assertEquals(2, jedis.dbSize());
202    }
203    @Test
204    public void expire() {
205      assertEquals(0, jedis.expire("foo", 20L));
206      jedis.set("foo", "bar");
207      assertEquals(1, jedis.expire("foo", 20L));
208      assertEquals(0, jedis.expire("foo", 20L, ExpiryOption.NX));
209      assertEquals(0, jedis.expire(bfoo, 20L));
210      jedis.set(bfoo, bbar);
211      assertEquals(1, jedis.expire(bfoo, 20L));
212      assertEquals(0, jedis.expire(bfoo, 20L, ExpiryOption.NX));
213    }
214    @Test
215    public void expireAt() {
216      long unixTime = (System.currentTimeMillis() / 1000L) + 20;
217      assertEquals(0, jedis.expireAt("foo", unixTime));
218      jedis.set("foo", "bar");
219      unixTime = (System.currentTimeMillis() / 1000L) + 20;
220      assertEquals(1, jedis.expireAt("foo", unixTime));
221      assertEquals(1, jedis.expireAt("foo", unixTime, ExpiryOption.XX));
222      assertEquals(0, jedis.expireAt(bfoo, unixTime));
223      jedis.set(bfoo, bbar);
224      unixTime = (System.currentTimeMillis() / 1000L) + 20;
225      assertEquals(1, jedis.expireAt(bfoo, unixTime));
226      assertEquals(1, jedis.expireAt(bfoo, unixTime, ExpiryOption.XX));
227    }
228    @Test
229    public void expireTime() {
230      long unixTime;
231      jedis.set("foo", "bar");
232      unixTime = (System.currentTimeMillis() / 1000L) + 20;
233      jedis.expireAt("foo", unixTime);
234      assertEquals(unixTime, jedis.expireTime("foo"), 0.0001);
235      jedis.set(bfoo, bbar);
236      unixTime = (System.currentTimeMillis() / 1000L) + 20;
237      jedis.expireAt(bfoo, unixTime);
238      assertEquals(unixTime, jedis.expireTime(bfoo), 0.0001);
239    }
240    @Test
241    public void ttl() {
242      assertEquals(-2, jedis.ttl("foo"));
243      jedis.set("foo", "bar");
244      assertEquals(-1, jedis.ttl("foo"));
245      jedis.expire("foo", 20);
246      long ttl = jedis.ttl("foo");
247      assertTrue(ttl >= 0 && ttl <= 20);
248      assertEquals(-2, jedis.ttl(bfoo));
249      jedis.set(bfoo, bbar);
250      assertEquals(-1, jedis.ttl(bfoo));
251      jedis.expire(bfoo, 20);
252      long bttl = jedis.ttl(bfoo);
253      assertTrue(bttl >= 0 && bttl <= 20);
254    }
255    @Test
256    public void touch() throws Exception {
257      assertEquals(0, jedis.touch("foo1", "foo2", "foo3"));
258      jedis.set("foo1", "bar1");
259      Thread.sleep(1100); 
260      assertTrue(jedis.objectIdletime("foo1") > 0);
261      assertEquals(1, jedis.touch("foo1"));
262      assertEquals(0L, jedis.objectIdletime("foo1").longValue());
263      assertEquals(1, jedis.touch("foo1", "foo2", "foo3"));
264      jedis.set("foo2", "bar2");
265      jedis.set("foo3", "bar3");
266      assertEquals(3, jedis.touch("foo1", "foo2", "foo3"));
267      assertEquals(0, jedis.touch(bfoo1, bfoo2, bfoo3));
268      jedis.set(bfoo1, bbar1);
269      Thread.sleep(1100); 
270      assertTrue(jedis.objectIdletime(bfoo1) > 0);
271      assertEquals(1, jedis.touch(bfoo1));
272      assertEquals(0L, jedis.objectIdletime(bfoo1).longValue());
273      assertEquals(1, jedis.touch(bfoo1, bfoo2, bfoo3));
274      jedis.set(bfoo2, bbar2);
275      jedis.set(bfoo3, bbar3);
276      assertEquals(3, jedis.touch(bfoo1, bfoo2, bfoo3));
277    }
278    @Test
279    public void persist() {
280      jedis.setex("foo", 60 * 60, "bar");
281      assertTrue(jedis.ttl("foo") > 0);
282      assertEquals(1, jedis.persist("foo"));
283      assertEquals(-1, jedis.ttl("foo"));
284      jedis.setex(bfoo, 60 * 60, bbar);
285      assertTrue(jedis.ttl(bfoo) > 0);
286      assertEquals(1, jedis.persist(bfoo));
287      assertEquals(-1, jedis.ttl(bfoo));
288    }
289    @Test
290    public void dumpAndRestore() {
291      jedis.set("foo1", "bar");
292      byte[] sv = jedis.dump("foo1");
293      jedis.restore("foo2", 0, sv);
294      assertEquals("bar", jedis.get("foo2"));
295      jedis.set(bfoo1, bbar);
296      sv = jedis.dump(bfoo1);
297      jedis.restore(bfoo2, 0, sv);
298      assertArrayEquals(bbar, jedis.get(bfoo2));
299    }
300    @Test
301    public void restoreParams() {
302      jedis.set("foo", "bar");
303      jedis.set("from", "a");
304      byte[] serialized = jedis.dump("from");
305      try {
306        jedis.restore("foo", 0, serialized);
307        fail("Simple restore on a existing key should fail");
308      } catch (JedisDataException e) {
309      }
310      try {
311        jedis.restore("foo", 0, serialized, RestoreParams.restoreParams());
312        fail("Simple restore on a existing key should fail");
313      } catch (JedisDataException e) {
314      }
315      assertEquals("bar", jedis.get("foo"));
316      jedis.restore("foo", 1000, serialized, RestoreParams.restoreParams().replace());
317      assertEquals("a", jedis.get("foo"));
318      assertTrue(jedis.pttl("foo") <= 1000);
319      jedis.restore("bar", System.currentTimeMillis() + 1000, serialized, RestoreParams.restoreParams().replace().absTtl());
320      assertTrue(jedis.pttl("bar") <= 1000);
321      jedis.restore("bar1", 1000, serialized, RestoreParams.restoreParams().replace().idleTime(1000));
322      assertEquals(1000, jedis.objectIdletime("bar1").longValue());
323    }
324    @Test
325    public void pexpire() {
326      assertEquals(0, jedis.pexpire("foo", 10000));
327      jedis.set("foo1", "bar1");
328      assertEquals(1, jedis.pexpire("foo1", 10000));
329      jedis.set("foo2", "bar2");
330      assertEquals(1, jedis.pexpire("foo2", 200000000000L));
331      assertEquals(0, jedis.pexpire("foo2", 10000000, ExpiryOption.NX));
332      assertEquals(1, jedis.pexpire("foo2", 10000000, ExpiryOption.XX));
333      assertEquals(0, jedis.pexpire("foo2", 10000, ExpiryOption.GT));
334      assertEquals(1, jedis.pexpire("foo2", 10000, ExpiryOption.LT));
335      long pttl = jedis.pttl("foo2");
336      assertTrue(pttl > 100L);
337      assertEquals(0, jedis.pexpire(bfoo, 10000));
338      jedis.set(bfoo, bbar);
339      assertEquals(1, jedis.pexpire(bfoo, 10000));
340      assertEquals(0, jedis.pexpire(bfoo, 10000, ExpiryOption.NX));
341    }
342    @Test
343    public void pexpireAt() {
344      long unixTime = (System.currentTimeMillis()) + 10000;
345      assertEquals(0, jedis.pexpireAt("foo", unixTime));
346      jedis.set("foo", "bar");
347      assertEquals(1, jedis.pexpireAt("foo", unixTime));
348      assertEquals(0, jedis.pexpireAt(bfoo, unixTime));
349      jedis.set(bfoo, bbar);
350      assertEquals(1, jedis.pexpireAt(bfoo, unixTime));
351    }
352    @Test
353    public void pexpireTime() {
354      long unixTime = (System.currentTimeMillis()) + 10000;
355      jedis.set("foo", "bar");
356      jedis.pexpireAt("foo", unixTime);
357      assertEquals(unixTime, jedis.pexpireTime("foo"), 0.0001);
358      jedis.set(bfoo, bbar);
359      jedis.pexpireAt(bfoo, unixTime);
360      assertEquals(unixTime, jedis.pexpireTime(bfoo), 0.0001);
361    }
362    @Test
363    public void pttl() {
364      assertEquals(-2, jedis.pttl("foo"));
365      jedis.set("foo", "bar");
366      assertEquals(-1, jedis.pttl("foo"));
367      jedis.pexpire("foo", 20000);
368      long pttl = jedis.pttl("foo");
369      assertTrue(pttl >= 0 && pttl <= 20000);
370      assertEquals(-2, jedis.pttl(bfoo));
<span onclick='openModal()' class='match'>371      jedis.set(bfoo, bbar);
372      assertEquals(-1, jedis.pttl(bfoo));
373      jedis.pexpire(bfoo, 20000);
374      pttl = jedis.pttl(bfoo);
</span>375      assertTrue(pttl >= 0 && pttl <= 20000);
376    }
377    @Test
378    public void psetex() {
379      long pttl;
380      jedis.psetex("foo", 200000000000L, "bar");
381      pttl = jedis.pttl("foo");
382      assertTrue(pttl > 100000000000L);
383      jedis.psetex(bfoo, 200000000000L, bbar);
384      pttl = jedis.pttl(bfoo);
385      assertTrue(pttl > 100000000000L);
386    }
387    @Test
388    public void scan() {
389      jedis.set("b", "b");
390      jedis.set("a", "a");
391      ScanResult<String> result = jedis.scan(SCAN_POINTER_START);
392      assertEquals(SCAN_POINTER_START, result.getCursor());
393      assertFalse(result.getResult().isEmpty());
394      ScanResult<byte[]> bResult = jedis.scan(SCAN_POINTER_START_BINARY);
395      assertArrayEquals(SCAN_POINTER_START_BINARY, bResult.getCursorAsBytes());
396      assertFalse(bResult.getResult().isEmpty());
397    }
398    @Test
399    public void scanMatch() {
400      ScanParams params = new ScanParams();
401      params.match("a*");
402      jedis.set("b", "b");
403      jedis.set("a", "a");
404      jedis.set("aa", "aa");
405      ScanResult<String> result = jedis.scan(SCAN_POINTER_START, params);
406      assertEquals(SCAN_POINTER_START, result.getCursor());
407      assertFalse(result.getResult().isEmpty());
408      params = new ScanParams();
409      params.match(bfoostar);
410      jedis.set(bfoo1, bbar);
411      jedis.set(bfoo2, bbar);
412      jedis.set(bfoo3, bbar);
413      ScanResult<byte[]> bResult = jedis.scan(SCAN_POINTER_START_BINARY, params);
414      assertArrayEquals(SCAN_POINTER_START_BINARY, bResult.getCursorAsBytes());
415      assertFalse(bResult.getResult().isEmpty());
416    }
417    @Test
418    public void scanCount() {
419      ScanParams params = new ScanParams();
420      params.count(2);
421      for (int i = 0; i < 10; i++) {
422        jedis.set("a" + i, "a" + i);
423      }
424      ScanResult<String> result = jedis.scan(SCAN_POINTER_START, params);
425      assertFalse(result.getResult().isEmpty());
426      params = new ScanParams();
427      params.count(2);
428      jedis.set(bfoo1, bbar);
429      jedis.set(bfoo2, bbar);
430      jedis.set(bfoo3, bbar);
431      ScanResult<byte[]> bResult = jedis.scan(SCAN_POINTER_START_BINARY, params);
432      assertFalse(bResult.getResult().isEmpty());
433    }
434    @Test
435    public void scanType() {
436      ScanParams noParams = new ScanParams();
437      ScanParams pagingParams = new ScanParams().count(4);
438      jedis.set("a", "a");
439      jedis.hset("b", "b", "b");
440      jedis.set("c", "c");
441      jedis.sadd("d", "d");
442      jedis.set("e", "e");
443      jedis.zadd("f", 0d, "f");
444      jedis.set("g", "g");
445      ScanResult<String> scanResult;
446      scanResult = jedis.scan(SCAN_POINTER_START, pagingParams, "string");
447      assertFalse(scanResult.isCompleteIteration());
448      int page1Count = scanResult.getResult().size();
449      scanResult = jedis.scan(scanResult.getCursor(), pagingParams, "string");
450      assertTrue(scanResult.isCompleteIteration());
451      int page2Count = scanResult.getResult().size();
452      assertEquals(4, page1Count + page2Count);
453      scanResult = jedis.scan(SCAN_POINTER_START, noParams, "hash");
454      assertEquals(Collections.singletonList("b"), scanResult.getResult());
455      scanResult = jedis.scan(SCAN_POINTER_START, noParams, "set");
456      assertEquals(Collections.singletonList("d"), scanResult.getResult());
457      scanResult = jedis.scan(SCAN_POINTER_START, noParams, "zset");
458      assertEquals(Collections.singletonList("f"), scanResult.getResult());
459      final byte[] string = "string".getBytes();
460      final byte[] hash = "hash".getBytes();
461      final byte[] set = "set".getBytes();
462      final byte[] zset = "zset".getBytes();
463      ScanResult<byte[]> binaryResult;
464      jedis.set("a", "a");
465      jedis.hset("b", "b", "b");
466      jedis.set("c", "c");
467      jedis.sadd("d", "d");
468      jedis.set("e", "e");
469      jedis.zadd("f", 0d, "f");
470      jedis.set("g", "g");
471      binaryResult = jedis.scan(SCAN_POINTER_START_BINARY, pagingParams, string);
472      assertFalse(binaryResult.isCompleteIteration());
473      page1Count = binaryResult.getResult().size();
474      binaryResult = jedis.scan(binaryResult.getCursorAsBytes(), pagingParams, string);
475      assertTrue(binaryResult.isCompleteIteration());
476      page2Count = binaryResult.getResult().size();
477      assertEquals(4, page1Count + page2Count);
478      binaryResult = jedis.scan(SCAN_POINTER_START_BINARY, noParams, hash);
479      AssertUtil.assertByteArrayListEquals(Collections.singletonList(new byte[]{98}), binaryResult.getResult());
480      binaryResult = jedis.scan(SCAN_POINTER_START_BINARY, noParams, set);
481      AssertUtil.assertByteArrayListEquals(Collections.singletonList(new byte[]{100}), binaryResult.getResult());
482      binaryResult = jedis.scan(SCAN_POINTER_START_BINARY, noParams, zset);
483      AssertUtil.assertByteArrayListEquals(Collections.singletonList(new byte[]{102}), binaryResult.getResult());
484    }
485    @Test
486    public void scanIsCompleteIteration() {
487      for (int i = 0; i < 100; i++) {
488        jedis.set("a" + i, "a" + i);
489      }
490      ScanResult<String> result = jedis.scan(SCAN_POINTER_START);
491      assertFalse(result.isCompleteIteration());
492      result = scanCompletely(result.getCursor());
493      assertNotNull(result);
494      assertTrue(result.isCompleteIteration());
495    }
496    private ScanResult<String> scanCompletely(String cursor) {
497      ScanResult<String> scanResult;
498      do {
499        scanResult = jedis.scan(cursor);
500        cursor = scanResult.getCursor();
501      } while (!SCAN_POINTER_START.equals(scanResult.getCursor()));
502      return scanResult;
503    }
504    @Test
505    public void setNxExAndGet() {
506      assertEquals("OK", jedis.set("hello", "world", SetParams.setParams().nx().ex(expireSeconds)));
507      assertEquals("world", jedis.get("hello"));
508      assertNull(jedis.set("hello", "bar", SetParams.setParams().nx().ex(expireSeconds)));
509      assertEquals("world", jedis.get("hello"));
510      long ttl = jedis.ttl("hello");
511      assertTrue(ttl > 0 && ttl <= expireSeconds);
512      byte[] bworld = { 0x77, 0x6F, 0x72, 0x6C, 0x64 };
513      byte[] bhello = { 0x68, 0x65, 0x6C, 0x6C, 0x6F };
514      assertEquals("OK", jedis.set(bworld, bhello, SetParams.setParams().nx().ex(expireSeconds)));
515      assertArrayEquals(bhello, jedis.get(bworld));
516      assertNull(jedis.set(bworld, bbar, SetParams.setParams().nx().ex(expireSeconds)));
517      assertArrayEquals(bhello, jedis.get(bworld));
518      long bttl = jedis.ttl(bworld);
519      assertTrue(bttl > 0 && bttl <= expireSeconds);
520    }
521    @Test
522    public void setGetOptionTest() {
523      assertEquals("OK", jedis.set("hello", "world"));
524      assertEquals("world", jedis.setGet("hello", "jedis"));
525      assertEquals("jedis", jedis.get("hello"));
526      assertNull(jedis.setGet("key", "value"));
527    }
528    @Test
529    public void setGet() {
530      assertEquals("OK", jedis.set("hello", "world"));
531      assertEquals("world", jedis.setGet("hello", "jedis", SetParams.setParams()));
532      assertEquals("jedis", jedis.get("hello"));
533      assertNull(jedis.setGet("key", "value", SetParams.setParams()));
534    }
535    @Test
536    public void sendCommandTest() {
537      Object obj = jedis.sendCommand(SET, "x", "1");
538      String returnValue = encode((byte[]) obj);
539      assertEquals("OK", returnValue);
540      obj = jedis.sendCommand(GET, "x");
541      returnValue = encode((byte[]) obj);
542      assertEquals("1", returnValue);
543      jedis.sendCommand(RPUSH, "foo", "a");
544      jedis.sendCommand(RPUSH, "foo", "b");
545      jedis.sendCommand(RPUSH, "foo", "c");
546      obj = jedis.sendCommand(LRANGE, "foo", "0", "2");
547      List<byte[]> list = (List<byte[]>) obj;
548      List<byte[]> expected = new ArrayList<>(3);
549      expected.add("a".getBytes());
550      expected.add("b".getBytes());
551      expected.add("c".getBytes());
552      for (int i = 0; i < 3; i++)
553        assertArrayEquals(expected.get(i), list.get(i));
554      assertEquals("PONG", encode((byte[]) jedis.sendCommand(PING)));
555    }
556    @Test
557    public void sendBlockingCommandTest() {
558      assertNull(jedis.sendBlockingCommand(BLPOP, "foo", Long.toString(1L)));
559      jedis.sendCommand(RPUSH, "foo", "bar");
560      assertEquals(Arrays.asList("foo", "bar"),
561        encodeObject(jedis.sendBlockingCommand(BLPOP, "foo", Long.toString(1L))));
562      assertNull(jedis.sendBlockingCommand(BLPOP, "foo", Long.toString(1L)));
563    }
564    @Test
565    public void encodeCompleteResponsePing() {
566      assertEquals("PONG", SafeEncoder.encodeObject(jedis.sendCommand(PING)));
567    }
568    @Test
569    public void encodeCompleteResponseHgetall() {
570      Assume.assumeFalse(RedisProtocolUtil.getRedisProtocol() == RedisProtocol.RESP3);
571      HashMap<String, String> entries = new HashMap<>();
572      entries.put("foo", "bar");
573      entries.put("foo2", "bar2");
574      jedis.hset("hash:test:encode", entries);
575      List encodeObj = (List) SafeEncoder.encodeObject(jedis.sendCommand(HGETALL, "hash:test:encode"));
576      assertEquals(4, encodeObj.size());
577      entries.forEach((k, v) -> {
578        assertThat((Iterable<String>) encodeObj, Matchers.hasItem(k));
579        assertEquals(v, findValueFromMapAsList(encodeObj, k));
580      });
581    }
582    @Test
583    public void encodeCompleteResponseHgetallResp3() {
584      Assume.assumeTrue(RedisProtocolUtil.getRedisProtocol() == RedisProtocol.RESP3);
585      HashMap<String, String> entries = new HashMap<>();
586      entries.put("foo", "bar");
587      entries.put("foo2", "bar2");
588      jedis.hset("hash:test:encode", entries);
589      List<KeyValue> encodeObj = (List<KeyValue>) SafeEncoder.encodeObject(jedis.sendCommand(HGETALL, "hash:test:encode"));
590      assertEquals(2, encodeObj.size());
591      encodeObj.forEach(kv -> {
592        assertThat(entries, Matchers.hasEntry(kv.getKey(), kv.getValue()));
593      });
594    }
595    @Test
596    public void encodeCompleteResponseXinfoStream() {
597      Assume.assumeFalse(RedisProtocolUtil.getRedisProtocol() == RedisProtocol.RESP3);
598      HashMap<String, String> entry = new HashMap<>();
599      entry.put("foo", "bar");
600      StreamEntryID entryID = jedis.xadd("mystream", StreamEntryID.NEW_ENTRY, entry);
601      jedis.xgroupCreate("mystream", "mygroup", null, false);
602      Object obj = jedis.sendCommand(XINFO, "STREAM", "mystream");
603      List encodeObj = (List) SafeEncoder.encodeObject(obj);
604      assertThat(encodeObj.size(), Matchers.greaterThanOrEqualTo(14));
605      assertEquals("must have even number of elements", 0, encodeObj.size() % 2); 
606      assertEquals(1L, findValueFromMapAsList(encodeObj, "length"));
607      assertEquals(entryID.toString(), findValueFromMapAsList(encodeObj, "last-generated-id"));
608      List<String> entryAsList = new ArrayList<>(2);
609      entryAsList.add("foo");
610      entryAsList.add("bar");
611      assertEquals(entryAsList, ((List) findValueFromMapAsList(encodeObj, "first-entry")).get(1));
612      assertEquals(entryAsList, ((List) findValueFromMapAsList(encodeObj, "last-entry")).get(1));
613    }
614    @Test
615    public void encodeCompleteResponseXinfoStreamResp3() {
616      Assume.assumeTrue(RedisProtocolUtil.getRedisProtocol() == RedisProtocol.RESP3);
617      HashMap<String, String> entry = new HashMap<>();
618      entry.put("foo", "bar");
619      StreamEntryID entryID = jedis.xadd("mystream", StreamEntryID.NEW_ENTRY, entry);
620      jedis.xgroupCreate("mystream", "mygroup", null, false);
621      Object obj = jedis.sendCommand(XINFO, "STREAM", "mystream");
622      List<KeyValue> encodeObj = (List<KeyValue>) SafeEncoder.encodeObject(obj);
623      assertThat(encodeObj.size(), Matchers.greaterThanOrEqualTo(7));
624      assertEquals(1L, findValueFromMapAsKeyValueList(encodeObj, "length"));
625      assertEquals(entryID.toString(), findValueFromMapAsKeyValueList(encodeObj, "last-generated-id"));
626      List<String> entryAsList = new ArrayList<>(2);
627      entryAsList.add("foo");
628      entryAsList.add("bar");
629      assertEquals(entryAsList, ((List) findValueFromMapAsKeyValueList(encodeObj, "first-entry")).get(1));
630      assertEquals(entryAsList, ((List) findValueFromMapAsKeyValueList(encodeObj, "last-entry")).get(1));
631    }
632    private Object findValueFromMapAsList(List list, Object key) {
633      for (int i = 0; i < list.size(); i += 2) {
634        if (key.equals(list.get(i))) {
635          return list.get(i + 1);
636        }
637      }
638      return null;
639    }
640    private Object findValueFromMapAsKeyValueList(List<KeyValue> list, Object key) {
641      for (KeyValue kv : list) {
642        if (key.equals(kv.getKey())) {
643          return kv.getValue();
644        }
645      }
646      return null;
647    }
648    @Test
649    public void copy() {
650      assertFalse(jedis.copy("unknown", "foo", false));
651      jedis.set("foo1", "bar");
652      assertTrue(jedis.copy("foo1", "foo2", false));
653      assertEquals("bar", jedis.get("foo2"));
654      jedis.set("foo1", "bar1");
655      assertTrue(jedis.copy("foo1", "foo2", true));
656      assertEquals("bar1", jedis.get("foo2"));
657      assertFalse(jedis.copy(bfoobar, bfoo, false));
658      jedis.set(bfoo1, bbar);
659      assertTrue(jedis.copy(bfoo1, bfoo2, false));
660      assertArrayEquals(bbar, jedis.get(bfoo2));
661      jedis.set(bfoo1, bbar1);
662      assertTrue(jedis.copy(bfoo1, bfoo2, true));
663      assertArrayEquals(bbar1, jedis.get(bfoo2));
664    }
665    @Test
666    public void scanIteration() {
667      Set<String> allIn = new HashSet<>(26 * 26);
668      char[] arr = new char[2];
669      for (int i = 0; i < 26; i++) {
670        arr[0] = (char) ('a' + i);
671        for (int j = 0; j < 26; j++) {
672          arr[1] = (char) ('a' + j);
673          String str = new String(arr);
674          jedis.incr(str);
675          allIn.add(str);
676        }
677      }
678      Set<String> allScan = new HashSet<>();
679      ScanIteration scan = jedis.scanIteration(10, "*");
680      while (!scan.isIterationCompleted()) {
681        ScanResult<String> batch = scan.nextBatch();
682        allScan.addAll(batch.getResult());
683      }
684      assertEquals(allIn, allScan);
685    }
686  }
</code></pre>
        </div>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-AllKindOfValuesCommandsTestBase.java</h3>
            <pre><code>1  package redis.clients.jedis.commands.unified;
2  import static org.hamcrest.MatcherAssert.assertThat;
3  import static org.junit.Assert.assertArrayEquals;
4  import static org.junit.Assert.assertEquals;
5  import static org.junit.Assert.assertFalse;
6  import static org.junit.Assert.assertTrue;
7  import static org.junit.Assert.assertNotNull;
8  import static org.junit.Assert.assertNull;
9  import static org.junit.Assert.fail;
10  import static redis.clients.jedis.Protocol.Command.BLPOP;
11  import static redis.clients.jedis.Protocol.Command.GET;
12  import static redis.clients.jedis.Protocol.Command.HGETALL;
13  import static redis.clients.jedis.Protocol.Command.LRANGE;
14  import static redis.clients.jedis.Protocol.Command.PING;
15  import static redis.clients.jedis.Protocol.Command.RPUSH;
16  import static redis.clients.jedis.Protocol.Command.SET;
17  import static redis.clients.jedis.Protocol.Command.XINFO;
18  import static redis.clients.jedis.util.SafeEncoder.encode;
19  import static redis.clients.jedis.util.SafeEncoder.encodeObject;
20  import static redis.clients.jedis.params.ScanParams.SCAN_POINTER_START;
21  import static redis.clients.jedis.params.ScanParams.SCAN_POINTER_START_BINARY;
22  import java.util.ArrayList;
23  import java.util.Arrays;
24  import java.util.Collections;
25  import java.util.HashMap;
26  import java.util.HashSet;
27  import java.util.List;
28  import java.util.Set;
29  import org.hamcrest.Matchers;
30  import org.junit.Assume;
31  import org.junit.Test;
32  import redis.clients.jedis.RedisProtocol;
33  import redis.clients.jedis.ScanIteration;
34  import redis.clients.jedis.StreamEntryID;
35  import redis.clients.jedis.args.ExpiryOption;
36  import redis.clients.jedis.params.ScanParams;
37  import redis.clients.jedis.resps.ScanResult;
38  import redis.clients.jedis.params.RestoreParams;
39  import redis.clients.jedis.exceptions.JedisDataException;
40  import redis.clients.jedis.params.SetParams;
41  import redis.clients.jedis.util.AssertUtil;
42  import redis.clients.jedis.util.KeyValue;
43  import redis.clients.jedis.util.RedisProtocolUtil;
44  import redis.clients.jedis.util.SafeEncoder;
45  public abstract class AllKindOfValuesCommandsTestBase extends UnifiedJedisCommandsTestBase {
46    protected final byte[] bfoo = { 0x01, 0x02, 0x03, 0x04 };
47    protected final byte[] bfoo1 = { 0x01, 0x02, 0x03, 0x04, 0x0A };
48    protected final byte[] bfoo2 = { 0x01, 0x02, 0x03, 0x04, 0x0B };
49    protected final byte[] bfoo3 = { 0x01, 0x02, 0x03, 0x04, 0x0C };
50    protected final byte[] bbar = { 0x05, 0x06, 0x07, 0x08 };
51    protected final byte[] bbar1 = { 0x05, 0x06, 0x07, 0x08, 0x0A };
52    protected final byte[] bbar2 = { 0x05, 0x06, 0x07, 0x08, 0x0B };
53    protected final byte[] bbar3 = { 0x05, 0x06, 0x07, 0x08, 0x0C };
54    protected final byte[] bfoobar = { 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08 };
55    protected final byte[] bfoostar = { 0x01, 0x02, 0x03, 0x04, '*' };
56    protected final byte[] bbarstar = { 0x05, 0x06, 0x07, 0x08, '*' };
57    protected final byte[] bnx = { 0x6E, 0x78 };
58    protected final byte[] bex = { 0x65, 0x78 };
59    final int expireSeconds = 2;
60    @Test
61    public void exists() {
62      String status = jedis.set("foo", "bar");
63      assertEquals("OK", status);
64      status = jedis.set(bfoo, bbar);
65      assertEquals("OK", status);
66      assertTrue(jedis.exists("foo"));
67      assertTrue(jedis.exists(bfoo));
68      assertEquals(1L, jedis.del("foo"));
69      assertEquals(1L, jedis.del(bfoo));
70      assertFalse(jedis.exists("foo"));
71      assertFalse(jedis.exists(bfoo));
72    }
73    @Test
74    public void existsMany() {
75      String status = jedis.set("foo1", "bar1");
76      assertEquals("OK", status);
77      status = jedis.set("foo2", "bar2");
78      assertEquals("OK", status);
79      assertEquals(2L, jedis.exists("foo1", "foo2"));
80      assertEquals(1L, jedis.del("foo1"));
81      assertEquals(1L, jedis.exists("foo1", "foo2"));
82    }
83    @Test
84    public void del() {
85      jedis.set("foo1", "bar1");
86      jedis.set("foo2", "bar2");
87      jedis.set("foo3", "bar3");
88      assertEquals(3L, jedis.del("foo1", "foo2", "foo3"));
89      assertFalse(jedis.exists("foo1"));
90      assertFalse(jedis.exists("foo2"));
91      assertFalse(jedis.exists("foo3"));
92      jedis.set("foo1", "bar1");
93      assertEquals(1L, jedis.del("foo1", "foo2"));
94      assertEquals(0L, jedis.del("foo1", "foo2"));
95      jedis.set(bfoo1, bbar1);
96      jedis.set(bfoo2, bbar2);
97      jedis.set(bfoo3, bbar3);
98      assertEquals(3L, jedis.del(bfoo1, bfoo2, bfoo3));
99      assertFalse(jedis.exists(bfoo1));
100      assertFalse(jedis.exists(bfoo2));
101      assertFalse(jedis.exists(bfoo3));
102      jedis.set(bfoo1, bbar1);
103      assertEquals(1, jedis.del(bfoo1, bfoo2));
104      assertEquals(0, jedis.del(bfoo1, bfoo2));
105    }
106    @Test
107    public void unlink() {
108      jedis.set("foo1", "bar1");
109      jedis.set("foo2", "bar2");
110      jedis.set("foo3", "bar3");
111      assertEquals(3, jedis.unlink("foo1", "foo2", "foo3"));
112      assertEquals(0, jedis.exists("foo1", "foo2", "foo3"));
113      jedis.set("foo1", "bar1");
114      assertEquals(1, jedis.unlink("foo1", "foo2"));
115      assertEquals(0, jedis.unlink("foo1", "foo2"));
116      jedis.set("foo", "bar");
117      assertEquals(1, jedis.unlink("foo"));
118      assertFalse(jedis.exists("foo"));
119      jedis.set(bfoo1, bbar1);
120      jedis.set(bfoo2, bbar2);
121      jedis.set(bfoo3, bbar3);
122      assertEquals(3, jedis.unlink(bfoo1, bfoo2, bfoo3));
123      assertEquals(0, jedis.exists(bfoo1, bfoo2, bfoo3));
124      jedis.set(bfoo1, bbar1);
125      assertEquals(1, jedis.unlink(bfoo1, bfoo2));
126      assertEquals(0, jedis.unlink(bfoo1, bfoo2));
127      jedis.set(bfoo, bbar);
128      assertEquals(1, jedis.unlink(bfoo));
129      assertFalse(jedis.exists(bfoo));
130    }
131    @Test
132    public void type() {
133      jedis.set("foo", "bar");
134      assertEquals("string", jedis.type("foo"));
135      jedis.set(bfoo, bbar);
136      assertEquals("string", jedis.type(bfoo));
137    }
138    @Test
139    public void keys() {
140      jedis.set("foo", "bar");
141      jedis.set("foobar", "bar");
142      Set<String> keys = jedis.keys("foo*");
143      AssertUtil.assertCollectionContains(keys, "foo");
144      AssertUtil.assertCollectionContains(keys, "foobar");
145      assertEquals(Collections.emptySet(), jedis.keys("bar*"));
146      jedis.set(bfoo, bbar);
147      jedis.set(bfoobar, bbar);
148      Set<byte[]> bkeys = jedis.keys(bfoostar);
149      AssertUtil.assertByteArrayCollectionContains(bkeys, bfoo);
150      AssertUtil.assertByteArrayCollectionContains(bkeys, bfoobar);
151      assertEquals(Collections.emptySet(), jedis.keys(bbarstar));
152    }
153    @Test
154    public void randomKey() {
155      assertNull(jedis.randomKey());
156      for (int i = 0; i < 100; i++) {
157        jedis.set("foo" + i, "bar"+i);
158      }
159      String key = jedis.randomKey();
160      assertNotNull(key);
161      assertTrue(key.startsWith("foo"));
162      assertEquals(key.replace("foo", "bar"), jedis.get(key));
163    }
164    @Test
165    public void rename() {
166      jedis.set("foo", "bar");
167      String status = jedis.rename("foo", "bar");
168      assertEquals("OK", status);
169      assertNull(jedis.get("foo"));
170      assertEquals("bar", jedis.get("bar"));
171      jedis.set(bfoo, bbar);
172      String bstatus = jedis.rename(bfoo, bbar);
173      assertEquals("OK", bstatus);
174      assertNull(jedis.get(bfoo));
175      assertArrayEquals(bbar, jedis.get(bbar));
176    }
177    @Test
178    public void renameOldAndNewAreTheSame() {
179      assertEquals("OK", jedis.set("foo", "bar"));
180      assertEquals("OK", jedis.rename("foo", "foo"));
181      assertEquals("OK", jedis.set(bfoo, bbar));
182      assertEquals("OK", jedis.rename(bfoo, bfoo));
183    }
184    @Test
185    public void renamenx() {
186      jedis.set("foo", "bar");
187      assertEquals(1, jedis.renamenx("foo", "bar"));
188      jedis.set("foo", "bar");
189      assertEquals(0, jedis.renamenx("foo", "bar"));
190      jedis.set(bfoo, bbar);
191      assertEquals(1, jedis.renamenx(bfoo, bbar));
192      jedis.set(bfoo, bbar);
193      assertEquals(0, jedis.renamenx(bfoo, bbar));
194    }
195    @Test
196    public void dbSize() {
197      assertEquals(0, jedis.dbSize());
198      jedis.set("foo", "bar");
199      assertEquals(1, jedis.dbSize());
200      jedis.set(bfoo, bbar);
201      assertEquals(2, jedis.dbSize());
202    }
203    @Test
204    public void expire() {
205      assertEquals(0, jedis.expire("foo", 20L));
206      jedis.set("foo", "bar");
207      assertEquals(1, jedis.expire("foo", 20L));
208      assertEquals(0, jedis.expire("foo", 20L, ExpiryOption.NX));
209      assertEquals(0, jedis.expire(bfoo, 20L));
210      jedis.set(bfoo, bbar);
211      assertEquals(1, jedis.expire(bfoo, 20L));
212      assertEquals(0, jedis.expire(bfoo, 20L, ExpiryOption.NX));
213    }
214    @Test
215    public void expireAt() {
216      long unixTime = (System.currentTimeMillis() / 1000L) + 20;
217      assertEquals(0, jedis.expireAt("foo", unixTime));
218      jedis.set("foo", "bar");
219      unixTime = (System.currentTimeMillis() / 1000L) + 20;
220      assertEquals(1, jedis.expireAt("foo", unixTime));
221      assertEquals(1, jedis.expireAt("foo", unixTime, ExpiryOption.XX));
222      assertEquals(0, jedis.expireAt(bfoo, unixTime));
223      jedis.set(bfoo, bbar);
224      unixTime = (System.currentTimeMillis() / 1000L) + 20;
225      assertEquals(1, jedis.expireAt(bfoo, unixTime));
226      assertEquals(1, jedis.expireAt(bfoo, unixTime, ExpiryOption.XX));
227    }
228    @Test
229    public void expireTime() {
230      long unixTime;
231      jedis.set("foo", "bar");
232      unixTime = (System.currentTimeMillis() / 1000L) + 20;
233      jedis.expireAt("foo", unixTime);
234      assertEquals(unixTime, jedis.expireTime("foo"), 0.0001);
235      jedis.set(bfoo, bbar);
236      unixTime = (System.currentTimeMillis() / 1000L) + 20;
237      jedis.expireAt(bfoo, unixTime);
238      assertEquals(unixTime, jedis.expireTime(bfoo), 0.0001);
239    }
240    @Test
241    public void ttl() {
242      assertEquals(-2, jedis.ttl("foo"));
243      jedis.set("foo", "bar");
244      assertEquals(-1, jedis.ttl("foo"));
245      jedis.expire("foo", 20);
246      long ttl = jedis.ttl("foo");
247      assertTrue(ttl >= 0 && ttl <= 20);
248      assertEquals(-2, jedis.ttl(bfoo));
<span onclick='openModal()' class='match'>249      jedis.set(bfoo, bbar);
250      assertEquals(-1, jedis.ttl(bfoo));
251      jedis.expire(bfoo, 20);
252      long bttl = jedis.ttl(bfoo);
</span>253      assertTrue(bttl >= 0 && bttl <= 20);
254    }
255    @Test
256    public void touch() throws Exception {
257      assertEquals(0, jedis.touch("foo1", "foo2", "foo3"));
258      jedis.set("foo1", "bar1");
259      Thread.sleep(1100); 
260      assertTrue(jedis.objectIdletime("foo1") > 0);
261      assertEquals(1, jedis.touch("foo1"));
262      assertEquals(0L, jedis.objectIdletime("foo1").longValue());
263      assertEquals(1, jedis.touch("foo1", "foo2", "foo3"));
264      jedis.set("foo2", "bar2");
265      jedis.set("foo3", "bar3");
266      assertEquals(3, jedis.touch("foo1", "foo2", "foo3"));
267      assertEquals(0, jedis.touch(bfoo1, bfoo2, bfoo3));
268      jedis.set(bfoo1, bbar1);
269      Thread.sleep(1100); 
270      assertTrue(jedis.objectIdletime(bfoo1) > 0);
271      assertEquals(1, jedis.touch(bfoo1));
272      assertEquals(0L, jedis.objectIdletime(bfoo1).longValue());
273      assertEquals(1, jedis.touch(bfoo1, bfoo2, bfoo3));
274      jedis.set(bfoo2, bbar2);
275      jedis.set(bfoo3, bbar3);
276      assertEquals(3, jedis.touch(bfoo1, bfoo2, bfoo3));
277    }
278    @Test
279    public void persist() {
280      jedis.setex("foo", 60 * 60, "bar");
281      assertTrue(jedis.ttl("foo") > 0);
282      assertEquals(1, jedis.persist("foo"));
283      assertEquals(-1, jedis.ttl("foo"));
284      jedis.setex(bfoo, 60 * 60, bbar);
285      assertTrue(jedis.ttl(bfoo) > 0);
286      assertEquals(1, jedis.persist(bfoo));
287      assertEquals(-1, jedis.ttl(bfoo));
288    }
289    @Test
290    public void dumpAndRestore() {
291      jedis.set("foo1", "bar");
292      byte[] sv = jedis.dump("foo1");
293      jedis.restore("foo2", 0, sv);
294      assertEquals("bar", jedis.get("foo2"));
295      jedis.set(bfoo1, bbar);
296      sv = jedis.dump(bfoo1);
297      jedis.restore(bfoo2, 0, sv);
298      assertArrayEquals(bbar, jedis.get(bfoo2));
299    }
300    @Test
301    public void restoreParams() {
302      jedis.set("foo", "bar");
303      jedis.set("from", "a");
304      byte[] serialized = jedis.dump("from");
305      try {
306        jedis.restore("foo", 0, serialized);
307        fail("Simple restore on a existing key should fail");
308      } catch (JedisDataException e) {
309      }
310      try {
311        jedis.restore("foo", 0, serialized, RestoreParams.restoreParams());
312        fail("Simple restore on a existing key should fail");
313      } catch (JedisDataException e) {
314      }
315      assertEquals("bar", jedis.get("foo"));
316      jedis.restore("foo", 1000, serialized, RestoreParams.restoreParams().replace());
317      assertEquals("a", jedis.get("foo"));
318      assertTrue(jedis.pttl("foo") <= 1000);
319      jedis.restore("bar", System.currentTimeMillis() + 1000, serialized, RestoreParams.restoreParams().replace().absTtl());
320      assertTrue(jedis.pttl("bar") <= 1000);
321      jedis.restore("bar1", 1000, serialized, RestoreParams.restoreParams().replace().idleTime(1000));
322      assertEquals(1000, jedis.objectIdletime("bar1").longValue());
323    }
324    @Test
325    public void pexpire() {
326      assertEquals(0, jedis.pexpire("foo", 10000));
327      jedis.set("foo1", "bar1");
328      assertEquals(1, jedis.pexpire("foo1", 10000));
329      jedis.set("foo2", "bar2");
330      assertEquals(1, jedis.pexpire("foo2", 200000000000L));
331      assertEquals(0, jedis.pexpire("foo2", 10000000, ExpiryOption.NX));
332      assertEquals(1, jedis.pexpire("foo2", 10000000, ExpiryOption.XX));
333      assertEquals(0, jedis.pexpire("foo2", 10000, ExpiryOption.GT));
334      assertEquals(1, jedis.pexpire("foo2", 10000, ExpiryOption.LT));
335      long pttl = jedis.pttl("foo2");
336      assertTrue(pttl > 100L);
337      assertEquals(0, jedis.pexpire(bfoo, 10000));
338      jedis.set(bfoo, bbar);
339      assertEquals(1, jedis.pexpire(bfoo, 10000));
340      assertEquals(0, jedis.pexpire(bfoo, 10000, ExpiryOption.NX));
341    }
342    @Test
343    public void pexpireAt() {
344      long unixTime = (System.currentTimeMillis()) + 10000;
345      assertEquals(0, jedis.pexpireAt("foo", unixTime));
346      jedis.set("foo", "bar");
347      assertEquals(1, jedis.pexpireAt("foo", unixTime));
348      assertEquals(0, jedis.pexpireAt(bfoo, unixTime));
349      jedis.set(bfoo, bbar);
350      assertEquals(1, jedis.pexpireAt(bfoo, unixTime));
351    }
352    @Test
353    public void pexpireTime() {
354      long unixTime = (System.currentTimeMillis()) + 10000;
355      jedis.set("foo", "bar");
356      jedis.pexpireAt("foo", unixTime);
357      assertEquals(unixTime, jedis.pexpireTime("foo"), 0.0001);
358      jedis.set(bfoo, bbar);
359      jedis.pexpireAt(bfoo, unixTime);
360      assertEquals(unixTime, jedis.pexpireTime(bfoo), 0.0001);
361    }
362    @Test
363    public void pttl() {
364      assertEquals(-2, jedis.pttl("foo"));
365      jedis.set("foo", "bar");
366      assertEquals(-1, jedis.pttl("foo"));
367      jedis.pexpire("foo", 20000);
368      long pttl = jedis.pttl("foo");
369      assertTrue(pttl >= 0 && pttl <= 20000);
370      assertEquals(-2, jedis.pttl(bfoo));
371      jedis.set(bfoo, bbar);
372      assertEquals(-1, jedis.pttl(bfoo));
373      jedis.pexpire(bfoo, 20000);
374      pttl = jedis.pttl(bfoo);
375      assertTrue(pttl >= 0 && pttl <= 20000);
376    }
377    @Test
378    public void psetex() {
379      long pttl;
380      jedis.psetex("foo", 200000000000L, "bar");
381      pttl = jedis.pttl("foo");
382      assertTrue(pttl > 100000000000L);
383      jedis.psetex(bfoo, 200000000000L, bbar);
384      pttl = jedis.pttl(bfoo);
385      assertTrue(pttl > 100000000000L);
386    }
387    @Test
388    public void scan() {
389      jedis.set("b", "b");
390      jedis.set("a", "a");
391      ScanResult<String> result = jedis.scan(SCAN_POINTER_START);
392      assertEquals(SCAN_POINTER_START, result.getCursor());
393      assertFalse(result.getResult().isEmpty());
394      ScanResult<byte[]> bResult = jedis.scan(SCAN_POINTER_START_BINARY);
395      assertArrayEquals(SCAN_POINTER_START_BINARY, bResult.getCursorAsBytes());
396      assertFalse(bResult.getResult().isEmpty());
397    }
398    @Test
399    public void scanMatch() {
400      ScanParams params = new ScanParams();
401      params.match("a*");
402      jedis.set("b", "b");
403      jedis.set("a", "a");
404      jedis.set("aa", "aa");
405      ScanResult<String> result = jedis.scan(SCAN_POINTER_START, params);
406      assertEquals(SCAN_POINTER_START, result.getCursor());
407      assertFalse(result.getResult().isEmpty());
408      params = new ScanParams();
409      params.match(bfoostar);
410      jedis.set(bfoo1, bbar);
411      jedis.set(bfoo2, bbar);
412      jedis.set(bfoo3, bbar);
413      ScanResult<byte[]> bResult = jedis.scan(SCAN_POINTER_START_BINARY, params);
414      assertArrayEquals(SCAN_POINTER_START_BINARY, bResult.getCursorAsBytes());
415      assertFalse(bResult.getResult().isEmpty());
416    }
417    @Test
418    public void scanCount() {
419      ScanParams params = new ScanParams();
420      params.count(2);
421      for (int i = 0; i < 10; i++) {
422        jedis.set("a" + i, "a" + i);
423      }
424      ScanResult<String> result = jedis.scan(SCAN_POINTER_START, params);
425      assertFalse(result.getResult().isEmpty());
426      params = new ScanParams();
427      params.count(2);
428      jedis.set(bfoo1, bbar);
429      jedis.set(bfoo2, bbar);
430      jedis.set(bfoo3, bbar);
431      ScanResult<byte[]> bResult = jedis.scan(SCAN_POINTER_START_BINARY, params);
432      assertFalse(bResult.getResult().isEmpty());
433    }
434    @Test
435    public void scanType() {
436      ScanParams noParams = new ScanParams();
437      ScanParams pagingParams = new ScanParams().count(4);
438      jedis.set("a", "a");
439      jedis.hset("b", "b", "b");
440      jedis.set("c", "c");
441      jedis.sadd("d", "d");
442      jedis.set("e", "e");
443      jedis.zadd("f", 0d, "f");
444      jedis.set("g", "g");
445      ScanResult<String> scanResult;
446      scanResult = jedis.scan(SCAN_POINTER_START, pagingParams, "string");
447      assertFalse(scanResult.isCompleteIteration());
448      int page1Count = scanResult.getResult().size();
449      scanResult = jedis.scan(scanResult.getCursor(), pagingParams, "string");
450      assertTrue(scanResult.isCompleteIteration());
451      int page2Count = scanResult.getResult().size();
452      assertEquals(4, page1Count + page2Count);
453      scanResult = jedis.scan(SCAN_POINTER_START, noParams, "hash");
454      assertEquals(Collections.singletonList("b"), scanResult.getResult());
455      scanResult = jedis.scan(SCAN_POINTER_START, noParams, "set");
456      assertEquals(Collections.singletonList("d"), scanResult.getResult());
457      scanResult = jedis.scan(SCAN_POINTER_START, noParams, "zset");
458      assertEquals(Collections.singletonList("f"), scanResult.getResult());
459      final byte[] string = "string".getBytes();
460      final byte[] hash = "hash".getBytes();
461      final byte[] set = "set".getBytes();
462      final byte[] zset = "zset".getBytes();
463      ScanResult<byte[]> binaryResult;
464      jedis.set("a", "a");
465      jedis.hset("b", "b", "b");
466      jedis.set("c", "c");
467      jedis.sadd("d", "d");
468      jedis.set("e", "e");
469      jedis.zadd("f", 0d, "f");
470      jedis.set("g", "g");
471      binaryResult = jedis.scan(SCAN_POINTER_START_BINARY, pagingParams, string);
472      assertFalse(binaryResult.isCompleteIteration());
473      page1Count = binaryResult.getResult().size();
474      binaryResult = jedis.scan(binaryResult.getCursorAsBytes(), pagingParams, string);
475      assertTrue(binaryResult.isCompleteIteration());
476      page2Count = binaryResult.getResult().size();
477      assertEquals(4, page1Count + page2Count);
478      binaryResult = jedis.scan(SCAN_POINTER_START_BINARY, noParams, hash);
479      AssertUtil.assertByteArrayListEquals(Collections.singletonList(new byte[]{98}), binaryResult.getResult());
480      binaryResult = jedis.scan(SCAN_POINTER_START_BINARY, noParams, set);
481      AssertUtil.assertByteArrayListEquals(Collections.singletonList(new byte[]{100}), binaryResult.getResult());
482      binaryResult = jedis.scan(SCAN_POINTER_START_BINARY, noParams, zset);
483      AssertUtil.assertByteArrayListEquals(Collections.singletonList(new byte[]{102}), binaryResult.getResult());
484    }
485    @Test
486    public void scanIsCompleteIteration() {
487      for (int i = 0; i < 100; i++) {
488        jedis.set("a" + i, "a" + i);
489      }
490      ScanResult<String> result = jedis.scan(SCAN_POINTER_START);
491      assertFalse(result.isCompleteIteration());
492      result = scanCompletely(result.getCursor());
493      assertNotNull(result);
494      assertTrue(result.isCompleteIteration());
495    }
496    private ScanResult<String> scanCompletely(String cursor) {
497      ScanResult<String> scanResult;
498      do {
499        scanResult = jedis.scan(cursor);
500        cursor = scanResult.getCursor();
501      } while (!SCAN_POINTER_START.equals(scanResult.getCursor()));
502      return scanResult;
503    }
504    @Test
505    public void setNxExAndGet() {
506      assertEquals("OK", jedis.set("hello", "world", SetParams.setParams().nx().ex(expireSeconds)));
507      assertEquals("world", jedis.get("hello"));
508      assertNull(jedis.set("hello", "bar", SetParams.setParams().nx().ex(expireSeconds)));
509      assertEquals("world", jedis.get("hello"));
510      long ttl = jedis.ttl("hello");
511      assertTrue(ttl > 0 && ttl <= expireSeconds);
512      byte[] bworld = { 0x77, 0x6F, 0x72, 0x6C, 0x64 };
513      byte[] bhello = { 0x68, 0x65, 0x6C, 0x6C, 0x6F };
514      assertEquals("OK", jedis.set(bworld, bhello, SetParams.setParams().nx().ex(expireSeconds)));
515      assertArrayEquals(bhello, jedis.get(bworld));
516      assertNull(jedis.set(bworld, bbar, SetParams.setParams().nx().ex(expireSeconds)));
517      assertArrayEquals(bhello, jedis.get(bworld));
518      long bttl = jedis.ttl(bworld);
519      assertTrue(bttl > 0 && bttl <= expireSeconds);
520    }
521    @Test
522    public void setGetOptionTest() {
523      assertEquals("OK", jedis.set("hello", "world"));
524      assertEquals("world", jedis.setGet("hello", "jedis"));
525      assertEquals("jedis", jedis.get("hello"));
526      assertNull(jedis.setGet("key", "value"));
527    }
528    @Test
529    public void setGet() {
530      assertEquals("OK", jedis.set("hello", "world"));
531      assertEquals("world", jedis.setGet("hello", "jedis", SetParams.setParams()));
532      assertEquals("jedis", jedis.get("hello"));
533      assertNull(jedis.setGet("key", "value", SetParams.setParams()));
534    }
535    @Test
536    public void sendCommandTest() {
537      Object obj = jedis.sendCommand(SET, "x", "1");
538      String returnValue = encode((byte[]) obj);
539      assertEquals("OK", returnValue);
540      obj = jedis.sendCommand(GET, "x");
541      returnValue = encode((byte[]) obj);
542      assertEquals("1", returnValue);
543      jedis.sendCommand(RPUSH, "foo", "a");
544      jedis.sendCommand(RPUSH, "foo", "b");
545      jedis.sendCommand(RPUSH, "foo", "c");
546      obj = jedis.sendCommand(LRANGE, "foo", "0", "2");
547      List<byte[]> list = (List<byte[]>) obj;
548      List<byte[]> expected = new ArrayList<>(3);
549      expected.add("a".getBytes());
550      expected.add("b".getBytes());
551      expected.add("c".getBytes());
552      for (int i = 0; i < 3; i++)
553        assertArrayEquals(expected.get(i), list.get(i));
554      assertEquals("PONG", encode((byte[]) jedis.sendCommand(PING)));
555    }
556    @Test
557    public void sendBlockingCommandTest() {
558      assertNull(jedis.sendBlockingCommand(BLPOP, "foo", Long.toString(1L)));
559      jedis.sendCommand(RPUSH, "foo", "bar");
560      assertEquals(Arrays.asList("foo", "bar"),
561        encodeObject(jedis.sendBlockingCommand(BLPOP, "foo", Long.toString(1L))));
562      assertNull(jedis.sendBlockingCommand(BLPOP, "foo", Long.toString(1L)));
563    }
564    @Test
565    public void encodeCompleteResponsePing() {
566      assertEquals("PONG", SafeEncoder.encodeObject(jedis.sendCommand(PING)));
567    }
568    @Test
569    public void encodeCompleteResponseHgetall() {
570      Assume.assumeFalse(RedisProtocolUtil.getRedisProtocol() == RedisProtocol.RESP3);
571      HashMap<String, String> entries = new HashMap<>();
572      entries.put("foo", "bar");
573      entries.put("foo2", "bar2");
574      jedis.hset("hash:test:encode", entries);
575      List encodeObj = (List) SafeEncoder.encodeObject(jedis.sendCommand(HGETALL, "hash:test:encode"));
576      assertEquals(4, encodeObj.size());
577      entries.forEach((k, v) -> {
578        assertThat((Iterable<String>) encodeObj, Matchers.hasItem(k));
579        assertEquals(v, findValueFromMapAsList(encodeObj, k));
580      });
581    }
582    @Test
583    public void encodeCompleteResponseHgetallResp3() {
584      Assume.assumeTrue(RedisProtocolUtil.getRedisProtocol() == RedisProtocol.RESP3);
585      HashMap<String, String> entries = new HashMap<>();
586      entries.put("foo", "bar");
587      entries.put("foo2", "bar2");
588      jedis.hset("hash:test:encode", entries);
589      List<KeyValue> encodeObj = (List<KeyValue>) SafeEncoder.encodeObject(jedis.sendCommand(HGETALL, "hash:test:encode"));
590      assertEquals(2, encodeObj.size());
591      encodeObj.forEach(kv -> {
592        assertThat(entries, Matchers.hasEntry(kv.getKey(), kv.getValue()));
593      });
594    }
595    @Test
596    public void encodeCompleteResponseXinfoStream() {
597      Assume.assumeFalse(RedisProtocolUtil.getRedisProtocol() == RedisProtocol.RESP3);
598      HashMap<String, String> entry = new HashMap<>();
599      entry.put("foo", "bar");
600      StreamEntryID entryID = jedis.xadd("mystream", StreamEntryID.NEW_ENTRY, entry);
601      jedis.xgroupCreate("mystream", "mygroup", null, false);
602      Object obj = jedis.sendCommand(XINFO, "STREAM", "mystream");
603      List encodeObj = (List) SafeEncoder.encodeObject(obj);
604      assertThat(encodeObj.size(), Matchers.greaterThanOrEqualTo(14));
605      assertEquals("must have even number of elements", 0, encodeObj.size() % 2); 
606      assertEquals(1L, findValueFromMapAsList(encodeObj, "length"));
607      assertEquals(entryID.toString(), findValueFromMapAsList(encodeObj, "last-generated-id"));
608      List<String> entryAsList = new ArrayList<>(2);
609      entryAsList.add("foo");
610      entryAsList.add("bar");
611      assertEquals(entryAsList, ((List) findValueFromMapAsList(encodeObj, "first-entry")).get(1));
612      assertEquals(entryAsList, ((List) findValueFromMapAsList(encodeObj, "last-entry")).get(1));
613    }
614    @Test
615    public void encodeCompleteResponseXinfoStreamResp3() {
616      Assume.assumeTrue(RedisProtocolUtil.getRedisProtocol() == RedisProtocol.RESP3);
617      HashMap<String, String> entry = new HashMap<>();
618      entry.put("foo", "bar");
619      StreamEntryID entryID = jedis.xadd("mystream", StreamEntryID.NEW_ENTRY, entry);
620      jedis.xgroupCreate("mystream", "mygroup", null, false);
621      Object obj = jedis.sendCommand(XINFO, "STREAM", "mystream");
622      List<KeyValue> encodeObj = (List<KeyValue>) SafeEncoder.encodeObject(obj);
623      assertThat(encodeObj.size(), Matchers.greaterThanOrEqualTo(7));
624      assertEquals(1L, findValueFromMapAsKeyValueList(encodeObj, "length"));
625      assertEquals(entryID.toString(), findValueFromMapAsKeyValueList(encodeObj, "last-generated-id"));
626      List<String> entryAsList = new ArrayList<>(2);
627      entryAsList.add("foo");
628      entryAsList.add("bar");
629      assertEquals(entryAsList, ((List) findValueFromMapAsKeyValueList(encodeObj, "first-entry")).get(1));
630      assertEquals(entryAsList, ((List) findValueFromMapAsKeyValueList(encodeObj, "last-entry")).get(1));
631    }
632    private Object findValueFromMapAsList(List list, Object key) {
633      for (int i = 0; i < list.size(); i += 2) {
634        if (key.equals(list.get(i))) {
635          return list.get(i + 1);
636        }
637      }
638      return null;
639    }
640    private Object findValueFromMapAsKeyValueList(List<KeyValue> list, Object key) {
641      for (KeyValue kv : list) {
642        if (key.equals(kv.getKey())) {
643          return kv.getValue();
644        }
645      }
646      return null;
647    }
648    @Test
649    public void copy() {
650      assertFalse(jedis.copy("unknown", "foo", false));
651      jedis.set("foo1", "bar");
652      assertTrue(jedis.copy("foo1", "foo2", false));
653      assertEquals("bar", jedis.get("foo2"));
654      jedis.set("foo1", "bar1");
655      assertTrue(jedis.copy("foo1", "foo2", true));
656      assertEquals("bar1", jedis.get("foo2"));
657      assertFalse(jedis.copy(bfoobar, bfoo, false));
658      jedis.set(bfoo1, bbar);
659      assertTrue(jedis.copy(bfoo1, bfoo2, false));
660      assertArrayEquals(bbar, jedis.get(bfoo2));
661      jedis.set(bfoo1, bbar1);
662      assertTrue(jedis.copy(bfoo1, bfoo2, true));
663      assertArrayEquals(bbar1, jedis.get(bfoo2));
664    }
665    @Test
666    public void scanIteration() {
667      Set<String> allIn = new HashSet<>(26 * 26);
668      char[] arr = new char[2];
669      for (int i = 0; i < 26; i++) {
670        arr[0] = (char) ('a' + i);
671        for (int j = 0; j < 26; j++) {
672          arr[1] = (char) ('a' + j);
673          String str = new String(arr);
674          jedis.incr(str);
675          allIn.add(str);
676        }
677      }
678      Set<String> allScan = new HashSet<>();
679      ScanIteration scan = jedis.scanIteration(10, "*");
680      while (!scan.isIterationCompleted()) {
681        ScanResult<String> batch = scan.nextBatch();
682        allScan.addAll(batch.getResult());
683      }
684      assertEquals(allIn, allScan);
685    }
686  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-AllKindOfValuesCommandsTestBase.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-AllKindOfValuesCommandsTestBase.java</div>
                </div>
                <div class="column column_space"><pre><code>371      jedis.set(bfoo, bbar);
372      assertEquals(-1, jedis.pttl(bfoo));
373      jedis.pexpire(bfoo, 20000);
374      pttl = jedis.pttl(bfoo);
</pre></code></div>
                <div class="column column_space"><pre><code>249      jedis.set(bfoo, bbar);
250      assertEquals(-1, jedis.ttl(bfoo));
251      jedis.expire(bfoo, 20);
252      long bttl = jedis.ttl(bfoo);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    