<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for IndexSettingsTests.java & PostgresITest.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for IndexSettingsTests.java & PostgresITest.java
      </h3>
      <h1 align="center">
        30.6%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>IndexSettingsTests.java (41.641937%)<TH>PostgresITest.java (24.293133%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#0',2,'match203567-1.html#0',3)" NAME="0">(22-52)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#0',2,'match203567-1.html#0',3)" NAME="0">(22-50)</A><TD ALIGN=center><FONT COLOR="#ff0000">27</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#1',2,'match203567-1.html#1',3)" NAME="1">(159-178)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#1',2,'match203567-1.html#1',3)" NAME="1">(743-759)</A><TD ALIGN=center><FONT COLOR="#ec0000">25</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#2',2,'match203567-1.html#2',3)" NAME="2">(78-89)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#2',2,'match203567-1.html#2',3)" NAME="2">(822-825)</A><TD ALIGN=center><FONT COLOR="#a00000">17</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#3',2,'match203567-1.html#3',3)" NAME="3">(434-442)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#3',2,'match203567-1.html#3',3)" NAME="3">(677-684)</A><TD ALIGN=center><FONT COLOR="#970000">16</FONT>
<TR><TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#4',2,'match203567-1.html#4',3)" NAME="4">(280-292)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#4',2,'match203567-1.html#4',3)" NAME="4">(288-294)</A><TD ALIGN=center><FONT COLOR="#970000">16</FONT>
<TR><TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#5',2,'match203567-1.html#5',3)" NAME="5">(460-465)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#5',2,'match203567-1.html#5',3)" NAME="5">(217-223)</A><TD ALIGN=center><FONT COLOR="#8d0000">15</FONT>
<TR><TD BGCOLOR="#8c8774"><FONT COLOR="#8c8774">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#6',2,'match203567-1.html#6',3)" NAME="6">(588-595)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#6',2,'match203567-1.html#6',3)" NAME="6">(311-316)</A><TD ALIGN=center><FONT COLOR="#840000">14</FONT>
<TR><TD BGCOLOR="#38a4a5"><FONT COLOR="#38a4a5">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#7',2,'match203567-1.html#7',3)" NAME="7">(423-432)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#7',2,'match203567-1.html#7',3)" NAME="7">(608-623)</A><TD ALIGN=center><FONT COLOR="#840000">14</FONT>
<TR><TD BGCOLOR="#c58917"><FONT COLOR="#c58917">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#8',2,'match203567-1.html#8',3)" NAME="8">(351-363)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#8',2,'match203567-1.html#8',3)" NAME="8">(458-465)</A><TD ALIGN=center><FONT COLOR="#840000">14</FONT>
<TR><TD BGCOLOR="#83a33a"><FONT COLOR="#83a33a">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#9',2,'match203567-1.html#9',3)" NAME="9">(69-77)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#9',2,'match203567-1.html#9',3)" NAME="9">(632-643)</A><TD ALIGN=center><FONT COLOR="#840000">14</FONT>
<TR><TD BGCOLOR="#ad5910"><FONT COLOR="#ad5910">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#10',2,'match203567-1.html#10',3)" NAME="10">(205-214)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#10',2,'match203567-1.html#10',3)" NAME="10">(272-277)</A><TD ALIGN=center><FONT COLOR="#7a0000">13</FONT>
<TR><TD BGCOLOR="#b041ff"><FONT COLOR="#b041ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#11',2,'match203567-1.html#11',3)" NAME="11">(183-187)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#11',2,'match203567-1.html#11',3)" NAME="11">(860-868)</A><TD ALIGN=center><FONT COLOR="#7a0000">13</FONT>
<TR><TD BGCOLOR="#571b7e"><FONT COLOR="#571b7e">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#12',2,'match203567-1.html#12',3)" NAME="12">(127-140)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#12',2,'match203567-1.html#12',3)" NAME="12">(846-854)</A><TD ALIGN=center><FONT COLOR="#7a0000">13</FONT>
<TR><TD BGCOLOR="#3b9c9c"><FONT COLOR="#3b9c9c">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#13',2,'match203567-1.html#13',3)" NAME="13">(614-625)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#13',2,'match203567-1.html#13',3)" NAME="13">(236-243)</A><TD ALIGN=center><FONT COLOR="#710000">12</FONT>
<TR><TD BGCOLOR="#842dce"><FONT COLOR="#842dce">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#14',2,'match203567-1.html#14',3)" NAME="14">(248-258)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#14',2,'match203567-1.html#14',3)" NAME="14">(806-812)</A><TD ALIGN=center><FONT COLOR="#710000">12</FONT>
<TR><TD BGCOLOR="#f52887"><FONT COLOR="#f52887">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#15',2,'match203567-1.html#15',3)" NAME="15">(226-238)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#15',2,'match203567-1.html#15',3)" NAME="15">(704-713)</A><TD ALIGN=center><FONT COLOR="#710000">12</FONT>
<TR><TD BGCOLOR="#2981b2"><FONT COLOR="#2981b2">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#16',2,'match203567-1.html#16',3)" NAME="16">(606-609)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#16',2,'match203567-1.html#16',3)" NAME="16">(658-667)</A><TD ALIGN=center><FONT COLOR="#670000">11</FONT>
<TR><TD BGCOLOR="#3090c7"><FONT COLOR="#3090c7">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#17',2,'match203567-1.html#17',3)" NAME="17">(448-456)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#17',2,'match203567-1.html#17',3)" NAME="17">(725-734)</A><TD ALIGN=center><FONT COLOR="#670000">11</FONT>
<TR><TD BGCOLOR="#800517"><FONT COLOR="#800517">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#18',2,'match203567-1.html#18',3)" NAME="18">(272-278)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#18',2,'match203567-1.html#18',3)" NAME="18">(939-948)</A><TD ALIGN=center><FONT COLOR="#670000">11</FONT>
<TR><TD BGCOLOR="#f62817"><FONT COLOR="#f62817">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#19',2,'match203567-1.html#19',3)" NAME="19">(686-691)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#19',2,'match203567-1.html#19',3)" NAME="19">(1120-1124)</A><TD ALIGN=center><FONT COLOR="#5e0000">10</FONT>
<TR><TD BGCOLOR="#4e9258"><FONT COLOR="#4e9258">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#20',2,'match203567-1.html#20',3)" NAME="20">(513-519)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#20',2,'match203567-1.html#20',3)" NAME="20">(363-368)</A><TD ALIGN=center><FONT COLOR="#5e0000">10</FONT>
<TR><TD BGCOLOR="#947010"><FONT COLOR="#947010">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#21',2,'match203567-1.html#21',3)" NAME="21">(484-490)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#21',2,'match203567-1.html#21',3)" NAME="21">(259-263)</A><TD ALIGN=center><FONT COLOR="#5e0000">10</FONT>
<TR><TD BGCOLOR="#4cc417"><FONT COLOR="#4cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#22',2,'match203567-1.html#22',3)" NAME="22">(379-382)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#22',2,'match203567-1.html#22',3)" NAME="22">(326-343)</A><TD ALIGN=center><FONT COLOR="#5e0000">10</FONT>
<TR><TD BGCOLOR="#f660ab"><FONT COLOR="#f660ab">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#23',2,'match203567-1.html#23',3)" NAME="23">(340-344)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#23',2,'match203567-1.html#23',3)" NAME="23">(303-307)</A><TD ALIGN=center><FONT COLOR="#5e0000">10</FONT>
<TR><TD BGCOLOR="#79764d"><FONT COLOR="#79764d">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#24',2,'match203567-1.html#24',3)" NAME="24">(322-328)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#24',2,'match203567-1.html#24',3)" NAME="24">(759-763)</A><TD ALIGN=center><FONT COLOR="#5e0000">10</FONT>
<TR><TD BGCOLOR="#5eac10"><FONT COLOR="#5eac10">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#25',2,'match203567-1.html#25',3)" NAME="25">(658-661)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#25',2,'match203567-1.html#25',3)" NAME="25">(895-899)</A><TD ALIGN=center><FONT COLOR="#550000">9</FONT>
<TR><TD BGCOLOR="#68818b"><FONT COLOR="#68818b">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#26',2,'match203567-1.html#26',3)" NAME="26">(646-649)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#26',2,'match203567-1.html#26',3)" NAME="26">(250-253)</A><TD ALIGN=center><FONT COLOR="#550000">9</FONT>
<TR><TD BGCOLOR="#e77471"><FONT COLOR="#e77471">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#27',2,'match203567-1.html#27',3)" NAME="27">(597-600)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#27',2,'match203567-1.html#27',3)" NAME="27">(876-880)</A><TD ALIGN=center><FONT COLOR="#550000">9</FONT>
<TR><TD BGCOLOR="#717d7d"><FONT COLOR="#717d7d">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#28',2,'match203567-1.html#28',3)" NAME="28">(582-585)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#28',2,'match203567-1.html#28',3)" NAME="28">(646-649)</A><TD ALIGN=center><FONT COLOR="#550000">9</FONT>
<TR><TD BGCOLOR="#af7a82"><FONT COLOR="#af7a82">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#29',2,'match203567-1.html#29',3)" NAME="29">(544-552)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#29',2,'match203567-1.html#29',3)" NAME="29">(525-528)</A><TD ALIGN=center><FONT COLOR="#550000">9</FONT>
<TR><TD BGCOLOR="#ae694a"><FONT COLOR="#ae694a">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#30',2,'match203567-1.html#30',3)" NAME="30">(443-447)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#30',2,'match203567-1.html#30',3)" NAME="30">(224-230)</A><TD ALIGN=center><FONT COLOR="#550000">9</FONT>
<TR><TD BGCOLOR="#3ea99f"><FONT COLOR="#3ea99f">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#31',2,'match203567-1.html#31',3)" NAME="31">(300-305)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#31',2,'match203567-1.html#31',3)" NAME="31">(376-379)</A><TD ALIGN=center><FONT COLOR="#550000">9</FONT>
<TR><TD BGCOLOR="#5b8daf"><FONT COLOR="#5b8daf">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#32',2,'match203567-1.html#32',3)" NAME="32">(120-125)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#32',2,'match203567-1.html#32',3)" NAME="32">(424-426)</A><TD ALIGN=center><FONT COLOR="#550000">9</FONT>
<TR><TD BGCOLOR="#736aff"><FONT COLOR="#736aff">-</FONT><TD><A HREF="javascript:ZweiFrames('match203567-0.html#33',2,'match203567-1.html#33',3)" NAME="33">(116-120)<TD><A HREF="javascript:ZweiFrames('match203567-0.html#33',2,'match203567-1.html#33',3)" NAME="33">(398-400)</A><TD ALIGN=center><FONT COLOR="#550000">9</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>IndexSettingsTests.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<A NAME="0"></A> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match203567-1.html#0',3,'match203567-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>package org.elasticsearch.index;

import io.crate.common.unit.TimeValue;
import io.crate.types.DataTypes;

import org.elasticsearch.Version;
import org.elasticsearch.cluster.metadata.IndexMetadata;
import org.elasticsearch.common.settings.AbstractScopedSettings;
import org.elasticsearch.common.settings.IndexScopedSettings;
import org.elasticsearch.common.settings.Setting;
import org.elasticsearch.common.settings.Setting.Property;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.common.unit.ByteSizeUnit;
import org.elasticsearch.common.unit.ByteSizeValue;
import org.elasticsearch.index.translog.Translog;
import org.elasticsearch.test.ESTestCase;
import org.elasticsearch.test.VersionUtils;
import org.junit.Test;

import java.util.Arrays;
import java.util.Collections;
import java.util.HashSet;
import java.util.Set;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.function.Function;

import static org.hamcrest.CoreMatchers.equalTo;
import static org.hamcrest.Matchers.is;
import static org.hamcrest.core.StringContains.containsString;
import</B></FONT> static org.hamcrest.object.HasToString.hasToString;

public class IndexSettingsTests extends ESTestCase {

    @Test
    public void testRunListener() {
        Version version = VersionUtils.getPreviousVersion();
        Settings theSettings = Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, version)
            .put(IndexMetadata.SETTING_INDEX_UUID, &quot;0xdeadbeef&quot;).build();
        final AtomicInteger integer = new AtomicInteger(0);
        Setting&lt;Integer&gt; integerSetting = Setting.intSetting(
            &quot;index.test.setting.int&quot;,
            -1,
<A NAME="9"></A>            Property.Dynamic,
            Property.IndexScope
        );
        IndexMetadata metaData = <FONT color="#83a33a"><A HREF="javascript:ZweiFrames('match203567-1.html#9',3,'match203567-top.html#9',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>newIndexMeta(&quot;index&quot;, theSettings);
        IndexSettings settings = newIndexSettings(
            newIndexMeta(&quot;index&quot;, theSettings), Settings.EMPTY, integerSetting);
        settings.getScopedSettings().addSettingsUpdateConsumer(integerSetting, integer::set);

        assertThat(settings.getIndexVersionCreated(), is(version));
<A NAME="2"></A>        assertThat(settings.getUUID(), is(&quot;0xdeadbeef&quot;));

        assertFalse(settings.updateIndexMetadata</B></FONT>(metaData));
        assertThat(<FONT color="#980517"><A HREF="javascript:ZweiFrames('match203567-1.html#2',3,'match203567-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>settings.getSettings(), is(metaData.getSettings()));
        assertThat(integer.get(), is(0));
        assertTrue(
            settings.updateIndexMetadata(
                newIndexMeta(
                    &quot;index&quot;,
                    Settings.builder()
                        .put(theSettings)
                        .put(&quot;index.test.setting.int&quot;, 42)
                        .build())));
        assertThat(integer.get(), is(42));
    }</B></FONT>

    @Test
    public void testSettingsUpdateValidator() {
        Version version = VersionUtils.getPreviousVersion();
        Settings theSettings = Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, version)
            .put(IndexMetadata.SETTING_INDEX_UUID, &quot;0xdeadbeef&quot;)
            .build();
        final AtomicInteger integer = new AtomicInteger(0);
        Setting&lt;Integer&gt; integerSetting = Setting.intSetting(
            &quot;index.test.setting.int&quot;,
            -1,
            Property.Dynamic,
            Property.IndexScope
        );
        IndexMetadata metaData = newIndexMeta(&quot;index&quot;, theSettings);
        IndexSettings settings = newIndexSettings(
            newIndexMeta(&quot;index&quot;, theSettings), Settings.EMPTY, integerSetting);
        settings.getScopedSettings().addSettingsUpdateConsumer(
            integerSetting, integer::set,
            (i) -&gt; {
                if (i == 42) {
                    throw new AssertionError(&quot;boom&quot;);
<A NAME="33"></A>                }
            });

        <FONT color="#736aff"><A HREF="javascript:ZweiFrames('match203567-1.html#33',3,'match203567-top.html#33',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(settings.getIndexVersionCreated(), is(version));
<A NAME="32"></A>        assertThat(settings.getUUID(), is(&quot;0xdeadbeef&quot;));

        assertFalse(settings.updateIndexMetadata(metaData));
        assertThat</B></FONT>(<FONT color="#5b8daf"><A HREF="javascript:ZweiFrames('match203567-1.html#32',3,'match203567-top.html#32',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>settings.getSettings(), is(metaData.getSettings()));
        assertThat(integer.get(), is(0));
        expectThrows(
            IllegalArgumentException.class,
<A NAME="12"></A>            () -&gt; settings.updateIndexMetadata(
                newIndexMeta</B></FONT>(
                    &quot;index&quot;,
                    <FONT color="#571b7e"><A HREF="javascript:ZweiFrames('match203567-1.html#12',3,'match203567-top.html#12',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Settings.builder()
                        .put(theSettings)
                        .put(&quot;index.test.setting.int&quot;, 42)
                        .build())));
        assertTrue(
            settings.updateIndexMetadata(
                newIndexMeta(
                    &quot;index&quot;,
                    Settings.builder()
                        .put(theSettings)
                        .put(&quot;index.test.setting.int&quot;, 41)
                        .build())));
        assertThat(integer.get(), is(41));
    }</B></FONT>

    @Test
    public void testMergedSettingsArePassed() {
        Version version = VersionUtils.getPreviousVersion();
        Settings theSettings = Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, version)
            .put(IndexMetadata.SETTING_INDEX_UUID, &quot;0xdeadbeef&quot;)
            .build();
        final AtomicInteger integer = new AtomicInteger(0);
        final StringBuilder builder = new StringBuilder();
        Setting&lt;Integer&gt; integerSetting = Setting.intSetting(
            &quot;index.test.setting.int&quot;,
            -1,
            Property.Dynamic,
            Property.IndexScope);
<A NAME="1"></A>        Setting&lt;String&gt; notUpdated = new Setting&lt;&gt;(
            &quot;index.not.updated&quot;,
            &quot;&quot;,
            <FONT color="#f63526"><A HREF="javascript:ZweiFrames('match203567-1.html#1',3,'match203567-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Function.identity(),
            DataTypes.STRING,
            Property.Dynamic,
            Property.IndexScope);

        IndexSettings settings = newIndexSettings(
            newIndexMeta(&quot;index&quot;, theSettings), Settings.EMPTY, integerSetting, notUpdated);
        settings.getScopedSettings().addSettingsUpdateConsumer(integerSetting, integer::set);
        settings.getScopedSettings().addSettingsUpdateConsumer(notUpdated, builder::append);
        assertThat(integer.get(), is(0));
        assertThat(builder.toString(), is(&quot;&quot;));
        IndexMetadata newMetaData = newIndexMeta(
            &quot;index&quot;,
            Settings.builder()
                .put(settings.getIndexMetadata().getSettings())
                .put(&quot;index.test.setting.int&quot;, 42)
                .build()
        );
        assertTrue(settings.updateIndexMetadata(newMetaData));
        assertSame</B></FONT>(settings.getIndexMetadata(), newMetaData);
        assertThat(integer.get(), is(42));
<A NAME="11"></A>        assertThat(builder.toString(), is(&quot;&quot;));
        integer.set(0);
        assertTrue(settings.updateIndexMetadata(
            newIndexMeta(&quot;index&quot;, <FONT color="#b041ff"><A HREF="javascript:ZweiFrames('match203567-1.html#11',3,'match203567-top.html#11',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Settings.builder().put(settings.getIndexMetadata().getSettings())
                .put(&quot;index.not.updated&quot;, &quot;boom&quot;).build())));
        assertThat(builder.toString(), is(&quot;boom&quot;));
        assertThat(&quot;not updated - we preserve the old settings&quot;, integer.get(), is(0));
    }</B></FONT>

    @Test
    public void testSettingsConsistency() {
        Version version = VersionUtils.getPreviousVersion();
        IndexMetadata metaData = newIndexMeta(
            &quot;index&quot;,
            Settings.builder()
                .put(IndexMetadata.SETTING_VERSION_CREATED, version)
                .build()
        );
        IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(settings.getIndexVersionCreated(), is(version));
        assertThat(settings.getUUID(), is(&quot;_na_&quot;));
        try {
<A NAME="10"></A>            settings.updateIndexMetadata(
                newIndexMeta(
                    &quot;index&quot;,
                    <FONT color="#ad5910"><A HREF="javascript:ZweiFrames('match203567-1.html#10',3,'match203567-top.html#10',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Settings.builder()
                        .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
                        .put(&quot;index.test.setting.int&quot;, 42)
                        .build()
                )
            );
            fail(&quot;version has changed&quot;);
        } catch (IllegalArgumentException ex) {
            assertTrue(ex.getMessage(), ex.getMessage().startsWith(&quot;version mismatch on settings update expected: &quot;));
        }</B></FONT>

        // use version number that is unknown
        int unknownVersion = Version.CURRENT.internalId + 200;
        metaData = newIndexMeta(
            &quot;index&quot;,
            Settings.builder()
                .put(
                    IndexMetadata.SETTING_VERSION_CREATED, Version.fromId(unknownVersion))
<A NAME="15"></A>                .build());
        settings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(settings.getIndexVersionCreated(), is(Version.fromId(unknownVersion)));
        assertThat(settings.getUUID(), <FONT color="#f52887"><A HREF="javascript:ZweiFrames('match203567-1.html#15',3,'match203567-top.html#15',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>is(&quot;_na_&quot;));
        settings.updateIndexMetadata(
            newIndexMeta(
                &quot;index&quot;,
                Settings.builder()
                    .put(IndexMetadata.SETTING_VERSION_CREATED, Version.fromId(unknownVersion))
                    .put(&quot;index.test.setting.int&quot;, 42)
                    .build()
            )
        );
        metaData = newIndexMeta(
            &quot;index&quot;,
            Settings.builder()</B></FONT>
                .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
                .put(IndexMetadata.SETTING_INDEX_UUID, &quot;0xdeadbeef&quot;)
                .build()
        );
        settings = new IndexSettings(metaData, Settings.EMPTY);
        try {
<A NAME="14"></A>            settings.updateIndexMetadata(
                newIndexMeta(
                    &quot;index&quot;,
                    <FONT color="#842dce"><A HREF="javascript:ZweiFrames('match203567-1.html#14',3,'match203567-top.html#14',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Settings.builder()
                        .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
                        .put(&quot;index.test.setting.int&quot;, 42)
                        .build()
                )
            );
            fail(&quot;uuid missing/change&quot;);
        } catch (IllegalArgumentException ex) {
            assertThat(ex.getMessage(), is(&quot;uuid mismatch on settings update expected: 0xdeadbeef but was: _na_&quot;));
        }
        assertThat</B></FONT>(settings.getSettings(), is(metaData.getSettings()));
    }

    public IndexSettings newIndexSettings(IndexMetadata metaData, Settings nodeSettings, Setting&lt;?&gt;... settings) {
        Set&lt;Setting&lt;?&gt;&gt; settingSet = new HashSet&lt;&gt;(IndexScopedSettings.BUILT_IN_INDEX_SETTINGS);
        if (settings.length &gt; 0) {
            settingSet.addAll(Arrays.asList(settings));
        }
        return new IndexSettings(metaData, nodeSettings, new IndexScopedSettings(Settings.EMPTY, settingSet));
    }

<A NAME="18"></A>    @Test
    public void testNodeSettingsAreContained() {
        final int numShards = randomIntBetween(1, 10);
        final int numReplicas = <FONT color="#800517"><A HREF="javascript:ZweiFrames('match203567-1.html#18',3,'match203567-top.html#18',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>randomIntBetween(0, 10);
        Settings theSettings = Settings.builder().
            put(&quot;index.foo.bar&quot;, 0)
            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, numReplicas)
            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, numShards).build();
<A NAME="4"></A>
        Settings nodeSettings = Settings.builder</B></FONT>().put(&quot;index.foo.bar&quot;, 43).build();
        final AtomicInteger indexValue = new AtomicInteger(0);
        Setting&lt;Integer&gt; integerSetting = <FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match203567-1.html#4',3,'match203567-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Setting.intSetting(
            &quot;index.foo.bar&quot;,
            -1,
            Property.Dynamic,
            Property.IndexScope);
        IndexSettings settings = newIndexSettings(
            newIndexMeta(&quot;index&quot;, theSettings), nodeSettings, integerSetting);
        settings.getScopedSettings().addSettingsUpdateConsumer(integerSetting, indexValue::set);
        assertThat(settings.getNumberOfReplicas(), is(numReplicas));
        assertThat(settings.getNumberOfShards(), is(numShards));
        assertThat(indexValue.get(), is(0));

        assertTrue</B></FONT>(settings.updateIndexMetadata(newIndexMeta(&quot;index&quot;, Settings.builder().
            put(&quot;index.foo.bar&quot;, 42)
            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, numReplicas + 1)
            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, numShards).build())));

<A NAME="31"></A>        assertThat(indexValue.get(), is(42));
        assertSame(nodeSettings, settings.getNodeSettings());

        assertTrue(settings.updateIndexMetadata(<FONT color="#3ea99f"><A HREF="javascript:ZweiFrames('match203567-1.html#31',3,'match203567-top.html#31',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>newIndexMeta(&quot;index&quot;, Settings.builder()
            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, numReplicas + 1)
            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, numShards).build())));
        assertThat(indexValue.get(), is(43));

    }</B></FONT>

    public static IndexMetadata newIndexMeta(String name, Settings indexSettings) {
        Settings build = Settings.builder().put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 1)
            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, 1)
            .put(indexSettings)
            .build();
        return IndexMetadata.builder(name).settings(build).build();
    }

    @Test
    public void testUpdateDurability() {
        IndexMetadata metaData = newIndexMeta(&quot;index&quot;, Settings.builder()
<A NAME="24"></A>            .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
            .put(IndexSettings.INDEX_TRANSLOG_DURABILITY_SETTING.getKey(), &quot;async&quot;)
            .build());
        IndexSettings settings = <FONT color="#79764d"><A HREF="javascript:ZweiFrames('match203567-1.html#24',3,'match203567-top.html#24',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>new IndexSettings(metaData, Settings.EMPTY);
        assertThat(settings.getTranslogDurability(), is(Translog.Durability.ASYNC));
        settings.updateIndexMetadata(
            newIndexMeta(
                &quot;index&quot;,
                Settings.builder()
                    .put(IndexSettings.INDEX_TRANSLOG_DURABILITY_SETTING.getKey</B></FONT>(), &quot;request&quot;)
                    .build()));
        assertThat(settings.getTranslogDurability(), is(Translog.Durability.REQUEST));

        metaData = newIndexMeta(&quot;index&quot;, Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
            .build());
        settings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(settings.getTranslogDurability(), is(Translog.Durability.REQUEST)); // test default
<A NAME="23"></A>    }

    @Test
    public void testRefreshInterval() <FONT color="#f660ab"><A HREF="javascript:ZweiFrames('match203567-1.html#23',3,'match203567-top.html#23',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
        String refreshInterval = getRandomTimeString();
        IndexMetadata metaData = newIndexMeta(&quot;index&quot;, Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
            .put(IndexSettings.INDEX_REFRESH_INTERVAL_SETTING.getKey</B></FONT>(), refreshInterval)
            .build());
        IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(
<A NAME="8"></A>            TimeValue.parseTimeValue(
                refreshInterval,
                new TimeValue(1, TimeUnit.DAYS),
                <FONT color="#c58917"><A HREF="javascript:ZweiFrames('match203567-1.html#8',3,'match203567-top.html#8',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>IndexSettings.INDEX_REFRESH_INTERVAL_SETTING.getKey()),
            is(settings.getRefreshInterval()));
        String newRefreshInterval = getRandomTimeString();
        settings.updateIndexMetadata(
            newIndexMeta(
                &quot;index&quot;,
                Settings.builder()
                    .put(IndexSettings.INDEX_REFRESH_INTERVAL_SETTING.getKey(), newRefreshInterval)
                    .build()));
        assertThat(
            TimeValue.parseTimeValue(
                newRefreshInterval,
                new</B></FONT> TimeValue(1, TimeUnit.DAYS),
                IndexSettings.INDEX_REFRESH_INTERVAL_SETTING.getKey()),
            is(settings.getRefreshInterval()));
    }

    private String getRandomTimeString() {
        int refreshIntervalInt = randomFrom(-1, Math.abs(randomInt()));
        String refreshInterval = Integer.toString(refreshIntervalInt);
        if (refreshIntervalInt &gt;= 0) {
            refreshInterval += randomFrom(&quot;s&quot;, &quot;ms&quot;, &quot;h&quot;);
        }
        return refreshInterval;
    }
<A NAME="22"></A>
    @Test
    public void testGCDeletesSetting() {
        TimeValue gcDeleteSetting = new TimeValue(<FONT color="#4cc417"><A HREF="javascript:ZweiFrames('match203567-1.html#22',3,'match203567-top.html#22',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Math.abs(randomInt()), TimeUnit.MILLISECONDS);
        IndexMetadata metaData = newIndexMeta(&quot;index&quot;, Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
            .put(IndexSettings.INDEX_GC_DELETES_SETTING.getKey(), gcDeleteSetting.getStringRep</B></FONT>())
            .build());
        IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(
            TimeValue.parseTimeValue(
                gcDeleteSetting.getStringRep(),
                new TimeValue(1, TimeUnit.DAYS),
                IndexSettings.INDEX_GC_DELETES_SETTING.getKey()).getMillis(),
            is(settings.getGcDeletesInMillis())
        );
        TimeValue newGCDeleteSetting = new TimeValue(Math.abs(randomInt()), TimeUnit.MILLISECONDS);
        settings.updateIndexMetadata(
            newIndexMeta(
                &quot;index&quot;,
                Settings.builder()
                    .put(IndexSettings.INDEX_GC_DELETES_SETTING.getKey(), newGCDeleteSetting.getStringRep())
                    .build()
            )
        );
        assertThat(
            TimeValue.parseTimeValue(
                newGCDeleteSetting.getStringRep(),
                new TimeValue(1, TimeUnit.DAYS),
                IndexSettings.INDEX_GC_DELETES_SETTING.getKey()).getMillis(),
            is(settings.getGcDeletesInMillis())
        );
        settings.updateIndexMetadata(
            newIndexMeta(
                &quot;index&quot;,
                Settings.builder()
                    .put(
                        IndexSettings.INDEX_GC_DELETES_SETTING.getKey(),
                        (randomBoolean() ? -1 : new TimeValue(-1, TimeUnit.MILLISECONDS)).toString()
                    ).build()
            )
        );
        assertThat(settings.getGcDeletesInMillis(), is(-1L));
    }
<A NAME="7"></A>
    @Test
    public void testTranslogFlushSizeThreshold() {
        ByteSizeValue translogFlushThresholdSize = new ByteSizeValue(Math.abs(<FONT color="#38a4a5"><A HREF="javascript:ZweiFrames('match203567-1.html#7',3,'match203567-top.html#7',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>randomInt()));
        ByteSizeValue actualValue = ByteSizeValue.parseBytesSizeValue(
            translogFlushThresholdSize.getBytes() + &quot;B&quot;,
            IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey());
        IndexMetadata metaData = newIndexMeta(&quot;index&quot;, Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
            .put(IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey(),
                 translogFlushThresholdSize.getBytes() + &quot;B&quot;)
<A NAME="3"></A>            .build());
        IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY)</B></FONT>;
        assertThat(actualValue, is(settings.getFlushThresholdSize()));
        ByteSizeValue newTranslogFlushThresholdSize = new ByteSizeValue(<FONT color="#53858b"><A HREF="javascript:ZweiFrames('match203567-1.html#3',3,'match203567-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Math.abs(randomInt()));
        ByteSizeValue actualNewTranslogFlushThresholdSize = ByteSizeValue.parseBytesSizeValue(
            newTranslogFlushThresholdSize.getBytes() + &quot;B&quot;,
            IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey());
        settings.updateIndexMetadata(newIndexMeta(&quot;index&quot;, Settings.builder()
            .put(IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey(),
<A NAME="30"></A>                 newTranslogFlushThresholdSize.getBytes() + &quot;B&quot;)
            .build()));
        assertThat(actualNewTranslogFlushThresholdSize, equalTo(settings.getFlushThresholdSize</B></FONT>()));
    <FONT color="#ae694a"><A HREF="javascript:ZweiFrames('match203567-1.html#30',3,'match203567-top.html#30',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>}

<A NAME="17"></A>    @Test
    public void testTranslogGenerationSizeThreshold() {
        final ByteSizeValue size = new ByteSizeValue(Math.abs(randomInt</B></FONT>()));
        final String key = <FONT color="#3090c7"><A HREF="javascript:ZweiFrames('match203567-1.html#17',3,'match203567-top.html#17',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>IndexSettings.INDEX_TRANSLOG_GENERATION_THRESHOLD_SIZE_SETTING.getKey();
        final ByteSizeValue actualValue =
            ByteSizeValue.parseBytesSizeValue(size.getBytes() + &quot;B&quot;, key);
        final IndexMetadata metaData =
            newIndexMeta(
                &quot;index&quot;,
                Settings.builder()
                    .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
                    .put(key, size.getBytes</B></FONT>() + &quot;B&quot;)
<A NAME="5"></A>                    .build());
        final IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(actualValue, is(settings.getGenerationThresholdSize()));
        final ByteSizeValue newSize = new ByteSizeValue(<FONT color="#151b8d"><A HREF="javascript:ZweiFrames('match203567-1.html#5',3,'match203567-top.html#5',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Math.abs(randomInt()));
        final ByteSizeValue actual = ByteSizeValue.parseBytesSizeValue(newSize.getBytes() + &quot;B&quot;, key);
        settings.updateIndexMetadata(
            newIndexMeta(&quot;index&quot;, Settings.builder().put(key, newSize.getBytes() + &quot;B&quot;).build()));
        assertThat(actual, is(settings.getGenerationThresholdSize()));
    }</B></FONT>

    @Test
    public void testPrivateSettingsValidation() {
        final Settings settings = Settings.builder()
            .put(IndexMetadata.SETTING_CREATION_DATE, System.currentTimeMillis())
            .build();
        final IndexScopedSettings indexScopedSettings = new IndexScopedSettings(
            settings,
            IndexScopedSettings.BUILT_IN_INDEX_SETTINGS);

        {
            // validation should fail since we are not ignoring private settings
            final IllegalArgumentException e = expectThrows(
                IllegalArgumentException.class,
                () -&gt; indexScopedSettings.validate(settings, randomBoolean()));
<A NAME="21"></A>            assertThat(e, hasToString(containsString(&quot;unknown setting [index.creation_date]&quot;)));
        }

        <FONT color="#947010"><A HREF="javascript:ZweiFrames('match203567-1.html#21',3,'match203567-top.html#21',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
            // validation should fail since we are not ignoring private settings
            final IllegalArgumentException e = expectThrows(
                IllegalArgumentException.class,
                () -&gt; indexScopedSettings.validate(settings, randomBoolean(), false, randomBoolean()));
            assertThat(e, hasToString(containsString(&quot;unknown setting [index.creation_date]&quot;)));
        }</B></FONT>

        // nothing should happen since we are ignoring private settings
        indexScopedSettings.validate(settings, randomBoolean(), true, randomBoolean());
    }

    @Test
    public void testArchivedSettingsValidation() {
        final Settings settings = Settings.builder()
            .put(AbstractScopedSettings.ARCHIVED_SETTINGS_PREFIX + &quot;foo&quot;, System.currentTimeMillis())
            .build();
        final IndexScopedSettings indexScopedSettings = new IndexScopedSettings(
            settings,
            IndexScopedSettings.BUILT_IN_INDEX_SETTINGS
        );
        {
            // validation should fail since we are not ignoring archived settings
            final IllegalArgumentException e = expectThrows(
                IllegalArgumentException.class,
                () -&gt; indexScopedSettings.validate(settings, randomBoolean()));
<A NAME="20"></A>            assertThat(e, hasToString(containsString(&quot;unknown setting [archived.foo]&quot;)));
        }

        <FONT color="#4e9258"><A HREF="javascript:ZweiFrames('match203567-1.html#20',3,'match203567-top.html#20',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
            // validation should fail since we are not ignoring archived settings
            final IllegalArgumentException e = expectThrows(
                IllegalArgumentException.class,
                () -&gt; indexScopedSettings.validate(settings, randomBoolean(), randomBoolean(), false));
            assertThat(e, hasToString(containsString(&quot;unknown setting [archived.foo]&quot;)));
        }</B></FONT>

        // nothing should happen since we are ignoring archived settings
        indexScopedSettings.validate(settings, randomBoolean(), randomBoolean(), true);
    }

    @Test
    public void testArchiveBrokenIndexSettings() {
        Settings settings =
            IndexScopedSettings.DEFAULT_SCOPED_SETTINGS.archiveUnknownOrInvalidSettings(
                Settings.EMPTY,
                e -&gt; {
                    assert false : &quot;should not have been invoked, no unknown settings&quot;;
                },
                (e, ex) -&gt; {
                    assert false : &quot;should not have been invoked, no invalid settings&quot;;
                });
        assertSame(settings, Settings.EMPTY);
        settings =
            IndexScopedSettings.DEFAULT_SCOPED_SETTINGS.archiveUnknownOrInvalidSettings(
                Settings.builder().put(&quot;index.refresh_interval&quot;, &quot;-200&quot;).build(),
                e -&gt; {
<A NAME="29"></A>                    assert false : &quot;should not have been invoked, no invalid settings&quot;;
                },
                (e, ex) -&gt; {
                    assertThat(<FONT color="#af7a82"><A HREF="javascript:ZweiFrames('match203567-1.html#29',3,'match203567-top.html#29',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>e.getKey(), equalTo(&quot;index.refresh_interval&quot;));
                    assertThat(e.getValue(), equalTo(&quot;-200&quot;));
                    assertThat(
                        ex,
                        hasToString(containsString(
                            &quot;failed to parse value [-200] for setting [index.refresh_interval], must be &gt;= [-1]&quot;)
                        )
                    );
                }</B></FONT>);
        assertThat(settings.get(&quot;archived.index.refresh_interval&quot;), is(&quot;-200&quot;));
        assertNull(settings.get(&quot;index.refresh_interval&quot;));

        Settings prevSettings = settings; // no double archive
        settings =
            IndexScopedSettings.DEFAULT_SCOPED_SETTINGS.archiveUnknownOrInvalidSettings(
                prevSettings,
                e -&gt; {
                    assert false : &quot;should not have been invoked, no unknown settings&quot;;
                },
                (e, ex) -&gt; {
                    assert false : &quot;should not have been invoked, no invalid settings&quot;;
                });
        assertSame(prevSettings, settings);

        settings =
            IndexScopedSettings.DEFAULT_SCOPED_SETTINGS.archiveUnknownOrInvalidSettings(
                Settings.builder()
                    .put(&quot;index.version.created&quot;, Version.CURRENT.internalId) // private setting
                    .put(&quot;index.unknown&quot;, &quot;foo&quot;)
                    .put(&quot;index.refresh_interval&quot;, &quot;2s&quot;).build(),
                e -&gt; {
                    assertThat(e.getKey(), equalTo(&quot;index.unknown&quot;));
                    assertThat(e.getValue(), equalTo(&quot;foo&quot;));
                },
                (e, ex) -&gt; {
<A NAME="28"></A>                    assert false : &quot;should not have been invoked, no invalid settings&quot;;
                });

        assertThat(settings.get(&quot;archived.index.unknown&quot;), <FONT color="#717d7d"><A HREF="javascript:ZweiFrames('match203567-1.html#28',3,'match203567-top.html#28',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>is(&quot;foo&quot;));
        assertThat(settings.get(&quot;index.version.created&quot;), is(Integer.toString(Version.CURRENT.internalId)));
        assertThat(settings.get(&quot;index.refresh_interval&quot;), is(&quot;2s&quot;));
<A NAME="6"></A>    }</B></FONT>

    public void testQueryDefaultField() {
        IndexSettings index = <FONT color="#8c8774"><A HREF="javascript:ZweiFrames('match203567-1.html#6',3,'match203567-top.html#6',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>newIndexSettings(
            newIndexMeta(&quot;index&quot;, Settings.EMPTY), Settings.EMPTY
        );
        assertThat(index.getDefaultFields(), equalTo(Collections.singletonList(&quot;*&quot;)));
        index = newIndexSettings(
            newIndexMeta(&quot;index&quot;, Settings.EMPTY), Settings.builder().put(&quot;index.query.default_field&quot;, &quot;body&quot;).build()
<A NAME="27"></A>        );
        assertThat(index.getDefaultFields</B></FONT>(), equalTo(Collections.singletonList(&quot;body&quot;)));
        index.updateIndexMetadata(
            <FONT color="#e77471"><A HREF="javascript:ZweiFrames('match203567-1.html#27',3,'match203567-top.html#27',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>newIndexMeta(&quot;index&quot;, Settings.builder().putList(&quot;index.query.default_field&quot;, &quot;body&quot;, &quot;title&quot;).build())
        );
        assertThat(index.getDefaultFields(), equalTo(Arrays.asList(&quot;body&quot;, &quot;title&quot;)));
    }</B></FONT>

    @Test
<A NAME="16"></A>    public void testUpdateSoftDeletesFails() {
        IndexScopedSettings settings = new IndexScopedSettings(Settings.EMPTY,
                                                               IndexScopedSettings.BUILT_IN_INDEX_SETTINGS);
        <FONT color="#2981b2"><A HREF="javascript:ZweiFrames('match203567-1.html#16',3,'match203567-top.html#16',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>IllegalArgumentException error = expectThrows(IllegalArgumentException.class, () -&gt;
            settings.updateSettings(Settings.builder().put(&quot;index.soft_deletes.enabled&quot;, randomBoolean()).build(),
                                    Settings.builder(), Settings.builder(), &quot;index&quot;));
        assertThat(error.getMessage</B></FONT>(), equalTo(&quot;final index setting [index.soft_deletes.enabled], not updateable&quot;));
    }
<A NAME="13"></A>
    @Test
    public void testSoftDeletesDefaultSetting() {
        Version createdVersion = <FONT color="#3b9c9c"><A HREF="javascript:ZweiFrames('match203567-1.html#13',3,'match203567-top.html#13',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>VersionUtils.randomVersionBetween(
            random(),
            Version.CURRENT.minimumIndexCompatibilityVersion(),
            Version.CURRENT
        );

        Settings settings = Settings.builder()
            .put(IndexMetadata.SETTING_INDEX_VERSION_CREATED.getKey(), createdVersion)
            .build();

        boolean isEnabled = createdVersion.onOrAfter(Version.V_4_3_0);
        assertThat(IndexSettings.INDEX_SOFT_DELETES_SETTING.get</B></FONT>(settings), is(isEnabled));
    }

    @Test
    public void testUpdateTranslogRetentionSettingsWithSoftDeletesDisabled() {
        Settings.Builder settings = Settings.builder()
            .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), false)
            .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT);

        TimeValue ageSetting = TimeValue.timeValueHours(12);
        if (randomBoolean()) {
            ageSetting = randomBoolean() ? TimeValue.MINUS_ONE : TimeValue.timeValueSeconds(randomIntBetween(0, 60));
            settings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), ageSetting);
        }
        ByteSizeValue sizeSetting = new ByteSizeValue(512, ByteSizeUnit.MB);
        if (randomBoolean()) {
            sizeSetting = randomBoolean() ? new ByteSizeValue(-1) : new ByteSizeValue(randomIntBetween(0, 1024));
            settings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), sizeSetting);
<A NAME="26"></A>        }
        IndexMetadata metaData = newIndexMeta(&quot;index&quot;, settings.build());
        IndexSettings indexSettings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(<FONT color="#68818b"><A HREF="javascript:ZweiFrames('match203567-1.html#26',3,'match203567-top.html#26',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>indexSettings.getTranslogRetentionAge(), equalTo(ageSetting));
        assertThat(indexSettings.getTranslogRetentionSize(), equalTo(sizeSetting));

        Settings.Builder newSettings = Settings.builder().put(settings.build</B></FONT>());
        if (randomBoolean()) {
            ageSetting = randomBoolean() ? TimeValue.MINUS_ONE : TimeValue.timeValueSeconds(randomIntBetween(0, 60));
            newSettings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), ageSetting);
        }
        if (randomBoolean()) {
<A NAME="25"></A>            sizeSetting = randomBoolean() ? new ByteSizeValue(-1) : new ByteSizeValue(randomIntBetween(0, 1024));
            newSettings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), sizeSetting);
        }
        indexSettings.updateIndexMetadata(<FONT color="#5eac10"><A HREF="javascript:ZweiFrames('match203567-1.html#25',3,'match203567-top.html#25',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>newIndexMeta(&quot;index&quot;, newSettings.build()));
        assertThat(indexSettings.getTranslogRetentionAge(), equalTo(ageSetting));
        assertThat(indexSettings.getTranslogRetentionSize(), equalTo(sizeSetting));
    }</B></FONT>

    @Test
    public void testIgnoreTranslogRetentionSettingsIfSoftDeletesEnabled() {
        Settings.Builder settings = Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, VersionUtils.randomVersionBetween(random(), Version.V_4_3_0, Version.CURRENT));
        if (randomBoolean()) {
            settings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), randomPositiveTimeValue());
        }
        if (randomBoolean()) {
            settings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), between(1, 1024) + &quot;b&quot;);
        }
        IndexMetadata metaData = newIndexMeta(&quot;index&quot;, settings.build());
        IndexSettings indexSettings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(indexSettings.getTranslogRetentionAge().millis(), equalTo(-1L));
        assertThat(indexSettings.getTranslogRetentionSize().getBytes(), equalTo(-1L));

        Settings.Builder newSettings = Settings.builder().put(settings.build());
        if (randomBoolean()) {
            newSettings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), randomPositiveTimeValue());
        }
        if (randomBoolean()) {
<A NAME="19"></A>            newSettings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), between(1, 1024) + &quot;b&quot;);
        }
        indexSettings.updateIndexMetadata(newIndexMeta(&quot;index&quot;, newSettings.build()));
        assertThat(<FONT color="#f62817"><A HREF="javascript:ZweiFrames('match203567-1.html#19',3,'match203567-top.html#19',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>indexSettings.getTranslogRetentionAge().millis(), equalTo(-1L));
        assertThat(indexSettings.getTranslogRetentionSize().getBytes(), equalTo(-1L));
    }


}</B></FONT>
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>PostgresITest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<A NAME="0"></A> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#0',2,'match203567-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>package io.crate.integrationtests;

import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_TABLE;
import static io.crate.protocols.postgres.PostgresNetty.PSQL_PORT_SETTING;
import static io.crate.testing.Asserts.assertThrowsMatches;
import static io.crate.testing.SQLErrorMatcher.isPGError;
import static org.hamcrest.Matchers.arrayContaining;
import static org.hamcrest.Matchers.containsString;
import static org.hamcrest.Matchers.emptyIterable;
import static org.hamcrest.Matchers.emptyOrNullString;
import static org.hamcrest.Matchers.greaterThan;
import static org.hamcrest.Matchers.not;
import static org.hamcrest.core.Is.is;

import java.sql.Array;
import java.sql.BatchUpdateException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import</B></FONT> java.util.Locale;
import java.util.Map;
import java.util.Properties;
import java.util.StringJoiner;
import java.util.UUID;

import org.elasticsearch.Version;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.test.ESIntegTestCase;
import org.elasticsearch.test.junit.annotations.TestLogging;
import org.hamcrest.Matchers;
import org.junit.Before;
import org.junit.BeforeClass;
import org.junit.Test;
import org.junit.jupiter.api.Assertions;
import org.postgresql.PGProperty;
import org.postgresql.geometric.PGpoint;
import org.postgresql.jdbc.PreferQueryMode;
import org.postgresql.util.PGobject;
import org.postgresql.util.PSQLException;
import org.postgresql.util.PSQLState;

import io.crate.action.sql.SQLOperations;
import io.crate.exceptions.SQLParseException;
import io.crate.execution.engine.collect.stats.JobsLogService;
import io.crate.execution.engine.collect.stats.JobsLogs;
import io.crate.protocols.postgres.PostgresNetty;
import io.crate.testing.DataTypeTesting;
import io.crate.testing.UseJdbc;
import io.crate.types.DataTypes;
import static org.junit.jupiter.api.Assertions.assertThrows;

@ESIntegTestCase.ClusterScope(numDataNodes = 2, numClientNodes = 0, supportsDedicatedMasters = false)
public class PostgresITest extends SQLIntegrationTestCase {

    private static final String NO_IPV6 = &quot;CRATE_TESTS_NO_IPV6&quot;;
    private static final String RO = &quot;node_s0&quot;;
    private static final String RW = &quot;node_s1&quot;;

    private Properties properties = new Properties();
    private static boolean useIPv6;

    @BeforeClass
    public static void setupClass() {
        useIPv6 = randomBoolean() &amp;&amp; !&quot;true&quot;.equalsIgnoreCase(System.getenv(NO_IPV6));
    }

    private String url(String nodeName) {
        PostgresNetty postgresNetty = internalCluster().getInstance(PostgresNetty.class, nodeName);
        int port = postgresNetty.boundAddress().publishAddress().getPort();
        if (useIPv6) {
            return &quot;jdbc:postgresql://::1:&quot; + port + '/';
        }
        return &quot;jdbc:postgresql://127.0.0.1:&quot; + port + '/';
    }

    @Override
    protected Settings nodeSettings(int nodeOrdinal) {
        Settings.Builder builder = Settings.builder();
        builder.put(super.nodeSettings(nodeOrdinal));

        if (useIPv6) {
            builder.put(&quot;network.host&quot;, &quot;::1&quot;);
        } else {
            builder.put(&quot;network.host&quot;, &quot;127.0.0.1&quot;);
        }

        if ((nodeOrdinal + 1) % 2 != 0) {
            builder.put(PSQL_PORT_SETTING.getKey(), &quot;5432-5532&quot;);
            builder.put(SQLOperations.NODE_READ_ONLY_SETTING.getKey(), true);
        } else {
            builder.put(PSQL_PORT_SETTING.getKey(), &quot;5533-5633&quot;);
        }
        return builder.build();
    }

    @Before
    public void initProperties() throws Exception {
        if (randomBoolean()) {
            // force binary transfer &amp; use server-side prepared statements
            properties.setProperty(&quot;prepareThreshold&quot;, &quot;-1&quot;);
        }
        properties.setProperty(&quot;user&quot;, &quot;crate&quot;);
    }

    @Test
    public void testGetTransactionIsolation() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            int var = conn.getTransactionIsolation();
            assertThat(var, is(Connection.TRANSACTION_READ_UNCOMMITTED));
        }
    }

    @Test
    public void test_simple_mode_can_handle_npgsql_startup_query() throws Exception {
        String query = &quot;&quot;&quot;
            SELECT version();
            SELECT ns.nspname, t.oid, t.typname, t.typtype, t.typnotnull, t.elemtypoid
            FROM (
                -- Arrays have typtype=b - this subquery identifies them by their typreceive and converts their typtype to a
                -- We first do this for the type (innerest-most subquery), and then for its element type
                -- This also returns the array element, range subtype and domain base type as elemtypoid
                SELECT
                    typ.oid, typ.typnamespace, typ.typname, typ.typtype, typ.typrelid, typ.typnotnull, typ.relkind,
                    elemtyp.oid AS elemtypoid, elemtyp.typname AS elemtypname, elemcls.relkind AS elemrelkind,
                    CASE WHEN elemproc.proname='array_recv' THEN 'a' ELSE elemtyp.typtype END AS elemtyptype
                FROM (
                    SELECT typ.oid, typnamespace, typname, typrelid, typnotnull, relkind, typelem AS elemoid,
                        CASE WHEN proc.proname='array_recv' THEN 'a' ELSE typ.typtype END AS typtype,
                        CASE
                            WHEN proc.proname='array_recv' THEN typ.typelem
                            WHEN typ.typtype='r' THEN rngsubtype

                            WHEN typ.typtype='d' THEN typ.typbasetype
                        END AS elemtypoid
                    FROM pg_type AS typ
                    LEFT JOIN pg_class AS cls ON (cls.oid = typ.typrelid)
                    LEFT JOIN pg_proc AS proc ON proc.oid = typ.typreceive
                    LEFT JOIN pg_range ON (pg_range.rngtypid = typ.oid)
                ) AS typ
                LEFT JOIN pg_type AS elemtyp ON elemtyp.oid = elemtypoid
                LEFT JOIN pg_class AS elemcls ON (elemcls.oid = elemtyp.typrelid)
                LEFT JOIN pg_proc AS elemproc ON elemproc.oid = elemtyp.typreceive
            ) AS t
            JOIN pg_namespace AS ns ON (ns.oid = typnamespace)
            WHERE
                typtype IN ('b', 'r', 'm', 'e', 'd') OR -- Base, range, multirange, enum, domain
                (typtype = 'c' AND relkind='c') OR -- User-defined free-standing composites (not table composites) by default
                (typtype = 'p' AND typname IN ('record', 'void')) OR -- Some special supported pseudo-types
                (typtype = 'a' AND (  -- Array of...
                    elemtyptype IN ('b', 'r', 'm', 'e', 'd') OR -- Array of base, range, multirange, enum, domain
                    (elemtyptype = 'p' AND elemtypname IN ('record', 'void')) OR -- Arrays of special supported pseudo-types
                    (elemtyptype = 'c' AND elemrelkind='c') -- Array of user-defined free-standing composites (not table composites) by default
                ))
            ORDER BY CASE
                   WHEN typtype IN ('b', 'e', 'p') THEN 0           -- First base types, enums, pseudo-types
                   WHEN typtype = 'r' THEN 1                        -- Ranges after
                   WHEN typtype = 'm' THEN 2                        -- Multiranges after
                   WHEN typtype = 'c' THEN 3                        -- Composites after
                   WHEN typtype = 'd' AND elemtyptype &lt;&gt; 'a' THEN 4 -- Domains over non-arrays after
                   WHEN typtype = 'a' THEN 5                        -- Arrays after
                   WHEN typtype = 'd' AND elemtyptype = 'a' THEN 6  -- Domains over arrays last
            END;

            -- Load field definitions for (free-standing) composite types
            SELECT typ.oid, att.attname, att.atttypid
            FROM pg_type AS typ
            JOIN pg_namespace AS ns ON (ns.oid = typ.typnamespace)
            JOIN pg_class AS cls ON (cls.oid = typ.typrelid)
            JOIN pg_attribute AS att ON (att.attrelid = typ.typrelid)
            WHERE
              (typ.typtype = 'c' AND cls.relkind='c') AND
              attnum &gt; 0 AND     -- Don't load system attributes
              NOT attisdropped
            ORDER BY typ.oid, att.attnum;

            -- Load enum fields
            SELECT pg_type.oid, enumlabel
            FROM pg_enum
            JOIN pg_type ON pg_type.oid=enumtypid
            ORDER BY oid, enumsortorder;
        &quot;&quot;&quot;;

        Properties properties = new Properties();
<A NAME="5"></A>        properties.setProperty(&quot;user&quot;, &quot;crate&quot;);
        properties.setProperty(PGProperty.PREFER_QUERY_MODE.getName(), PreferQueryMode.SIMPLE.value());
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            Statement statement = <FONT color="#151b8d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#5',2,'match203567-top.html#5',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.createStatement();
            statement.execute(query);
            ResultSet resultSet = statement.getResultSet();
            assertThat(resultSet.next(), is(true));
<A NAME="30"></A>            assertThat(resultSet.getString(1), Matchers.containsString(&quot;CrateDB &quot; + Version.CURRENT.toString()));
            assertThat(statement.getMoreResults(), is(true));
        }</B></FONT>
    <FONT color="#ae694a"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#30',2,'match203567-top.html#30',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>}

    @Test
    public void testMultidimensionalArrayWithDifferentSizedArrays() throws Exception {
        Properties properties = new Properties();
        properties.setProperty(&quot;user&quot;, &quot;crate&quot;);
        properties.setProperty</B></FONT>(PGProperty.PREFER_QUERY_MODE.getName(), PreferQueryMode.SIMPLE.value());
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            Statement statement = conn.createStatement();
<A NAME="13"></A>            statement.executeUpdate(&quot;create table t (o1 array(object as (o2 array(object as (x int)))))&quot;);
            ensureYellow();

            <FONT color="#3b9c9c"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#13',2,'match203567-top.html#13',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>statement.setEscapeProcessing(false);
            statement.executeUpdate(&quot;insert into t (o1) values ( [ {o2=[{x=1}, {x=2}]}, {o2=[{x=3}]} ] )&quot;);
            statement.executeUpdate(&quot;refresh table t&quot;);

            ResultSet resultSet = statement.executeQuery(&quot;select o1['o2']['x'] from t&quot;);
            assertThat(resultSet.next(), is(true));
            String array = resultSet.getString(1);
            assertThat(array, is</B></FONT>(&quot;[[1,2],[3]]&quot;));
        }

        properties = new Properties();
<A NAME="26"></A>        properties.setProperty(&quot;user&quot;, &quot;crate&quot;);
        properties.setProperty(&quot;prepareThreshold&quot;, &quot;-1&quot;); // force binary transfer
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            ResultSet resultSet = <FONT color="#68818b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#26',2,'match203567-top.html#26',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.createStatement().executeQuery(&quot;select o1['o2']['x'] from t&quot;);
            assertThat(resultSet.next(), is(true));
            String array = resultSet.getString(1);
            assertThat(array, is</B></FONT>(&quot;[[1,2],[3]]&quot;));
        }
    }
<A NAME="21"></A>
    @Test
    public void testUseOfUnsupportedType() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) <FONT color="#947010"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#21',2,'match203567-top.html#21',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>{
            PreparedStatement stmt = conn.prepareStatement(&quot;select ? from sys.cluster&quot;);
            stmt.setObject(1, UUID.randomUUID());
            assertThrowsMatches(() -&gt; stmt.executeQuery(), isPGError(is(&quot;Can't map PGType with oid=2950 to Crate type&quot;), INTERNAL_ERROR));
        }</B></FONT>
    }

    @Test
    public void testEmptyStatement() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
<A NAME="10"></A>            assertThat(conn.createStatement().execute(&quot;&quot;), is(false));

            try {
                <FONT color="#ad5910"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#10',2,'match203567-top.html#10',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.createStatement().executeQuery(&quot;&quot;);
                fail(&quot;executeQuery with empty query should throw a 'No results were returned by the query' error&quot;);
            } catch (PSQLException e) {
                // can't use expectedException.expectMessage because error messages are localized and locale is randomized
                assertThat(e.getSQLState(), is(PSQLState.NO_DATA.getState()));
            }</B></FONT>
        }
    }

    @Test
    public void testSimpleQuery() throws Exception {
        properties.setProperty(PGProperty.PREFER_QUERY_MODE.getName(), PreferQueryMode.SIMPLE.value());
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
<A NAME="4"></A>            conn.setAutoCommit(true);
            conn.createStatement().executeUpdate(&quot;create table t (x int) with (number_of_replicas = 0)&quot;);
            conn.createStatement().executeUpdate(&quot;insert into t (x) values (1), (2)&quot;);
            <FONT color="#6cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#4',2,'match203567-top.html#4',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.createStatement().executeUpdate(&quot;refresh table t&quot;);

            ResultSet resultSet = conn.createStatement().executeQuery(&quot;select * from t order by x&quot;);
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is(1));
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is</B></FONT>(2));
        }
    }

    @Test
    public void testPreparedStatementHandling() throws Exception {
<A NAME="23"></A>        Properties properties = new Properties();
        properties.setProperty(&quot;user&quot;, &quot;crate&quot;);
        properties.setProperty(&quot;prepareThreshold&quot;, &quot;-1&quot;);
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) <FONT color="#f660ab"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#23',2,'match203567-top.html#23',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>{
            PreparedStatement p1 = conn.prepareStatement(&quot;select 1 from sys.cluster&quot;);
            ResultSet resultSet = p1.executeQuery();
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt</B></FONT>(1), is(1));
<A NAME="6"></A>
            PreparedStatement p2 = conn.prepareStatement(&quot;select 2 from sys.cluster&quot;);
            resultSet = p2.executeQuery();
            <FONT color="#8c8774"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#6',2,'match203567-top.html#6',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is(2));

            resultSet = p1.executeQuery();
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is</B></FONT>(1));
        }
    }

    @Test
    public void testPreparedSelectStatementWithParametersCanBeDescribed() throws Exception {
        Properties properties = new Properties();
<A NAME="22"></A>        properties.setProperty(&quot;user&quot;, &quot;crate&quot;);
        properties.setProperty(&quot;prepareThreshold&quot;, &quot;-1&quot;);
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            PreparedStatement p1 = <FONT color="#4cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#22',2,'match203567-top.html#22',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.prepareStatement(&quot;select ? from sys.cluster&quot;);
            p1.setInt(1, 20);
            ResultSet resultSet = p1.executeQuery();
            /*
             * This execute results in the following messages:
             *
             *      method=parse stmtName=S_1 query=select $1 from sys.cluster paramTypes=[integer]
             *      method=describe type=S portalOrStatement=S_1
             *      method=sync
             *      method=bind portalName= statementName=S_1 params=[20]
             *      method=describe type=P portalOrStatement=
             *      method=execute portalName= maxRows=0
             *      method=sync
             *
             * The tests makes sure that it works even though the describe can't analyze the statement (because of missing params)
             */
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is</B></FONT>(20));
        }
    }

    @Test
    public void testWriteOperationsWithoutAutocommitAndCommitAndRollback() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(false);
            try (Statement statement = conn.createStatement()) {
                statement.executeUpdate(&quot;create table t (x int) with (number_of_replicas = 0)&quot;);
            }
            try (PreparedStatement stmt = conn.prepareStatement(&quot;insert into t (x) values (1), (2)&quot;)) {
                stmt.executeUpdate();
            }
            try (Statement statement = conn.createStatement()) {
                statement.executeUpdate(&quot;refresh table t&quot;);
            }
<A NAME="20"></A>
            conn.commit();

            try (Statement statement = conn.createStatement()) <FONT color="#4e9258"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#20',2,'match203567-top.html#20',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>{
                // no error because table was created
                ResultSet resultSet = statement.executeQuery(&quot;select * from t&quot;);
                assertThat(resultSet.next(), is(true));
                assertThat(resultSet.next(), is(true));
            }</B></FONT>
        }
    }

    @Test
<A NAME="31"></A>    public void testNoAutoCommit() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(false);
            ResultSet resultSet = <FONT color="#3ea99f"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#31',2,'match203567-top.html#31',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.prepareStatement(&quot;select name from sys.cluster&quot;).executeQuery();
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getString(1), Matchers.startsWith(&quot;SUITE-TEST_WORKER&quot;));
        }</B></FONT>
    }

    @Test
    public void test_char_types_arrays() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.createStatement().executeUpdate(
                &quot;CREATE TABLE t (&quot; +
                &quot;   chars array(byte),&quot; +
                &quot;   strings array(text)) &quot; +
                &quot;WITH (number_of_replicas = 0)&quot;);

            PreparedStatement preparedStatement = conn.prepareStatement(
                &quot;INSERT INTO t (chars, strings) VALUES (?, ?)&quot;);
            preparedStatement.setArray(1, conn.createArrayOf(&quot;char&quot;, new Byte[]{'c', '3'}));
            preparedStatement.setArray(2, conn.createArrayOf(&quot;varchar&quot;, new String[]{&quot;fo,o&quot;, &quot;bar&quot;}));
<A NAME="33"></A>            preparedStatement.executeUpdate();
            conn.createStatement().execute(&quot;REFRESH TABLE t&quot;);

            ResultSet resultSet = <FONT color="#736aff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#33',2,'match203567-top.html#33',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.createStatement().executeQuery(&quot;SELECT chars, strings FROM t&quot;);
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getArray(1).getArray(), is</B></FONT>(new String[]{&quot;99&quot;, &quot;51&quot;}));
            assertThat(resultSet.getArray(2).getArray(), is(new String[]{&quot;fo,o&quot;, &quot;bar&quot;}));
        } catch (BatchUpdateException e) {
            throw e.getNextException();
        }
    }

    @Test
    public void test_numeric_types_arrays() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.createStatement().executeUpdate(
                &quot;CREATE TABLE t (&quot; +
                &quot;   ints array(int),&quot; +
                &quot;   floats array(float)&quot; +
                &quot;) &quot; +
                &quot;WITH (number_of_replicas = 0)&quot;);

            PreparedStatement preparedStatement = conn.prepareStatement(
                &quot;INSERT INTO t (ints, floats) VALUES (?, ?)&quot;);
            preparedStatement.setArray(1, conn.createArrayOf(&quot;int4&quot;, new Integer[]{10, 20}));
            preparedStatement.setArray(2, conn.createArrayOf(&quot;float4&quot;, new Float[]{1.2f, 3.5f}));
<A NAME="32"></A>            preparedStatement.executeUpdate();
            conn.createStatement().execute(&quot;REFRESH TABLE t&quot;);

            ResultSet rs = <FONT color="#5b8daf"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#32',2,'match203567-top.html#32',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.createStatement().executeQuery(&quot;SELECT ints, floats FROM t&quot;);
            assertThat(rs.next(), is(true));
            assertThat(rs.getArray(1).getArray(), is</B></FONT>(new Integer[]{10, 20}));
            assertThat(rs.getArray(2).getArray(), is(new Float[]{1.2f, 3.5f}));
        } catch (BatchUpdateException e) {
            throw e.getNextException();
        }
    }

    @Test
    public void test_geo_types_arrays() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.createStatement().execute(
                &quot;CREATE TABLE t (&quot; +
                &quot;   geo_points array(geo_point),&quot; +
                &quot;   geo_shapes array(geo_shape)&quot; +
                &quot;) &quot; +
                &quot;WITH (number_of_replicas = 0)&quot;);

            PreparedStatement preparedStatement = conn.prepareStatement(
                &quot;INSERT INTO t (geo_points, geo_shapes) VALUES (?, ?)&quot;);
            preparedStatement.setArray(1, conn.createArrayOf(
                &quot;point&quot;,
                new PGpoint[]{new PGpoint(1.1, 2.2), new PGpoint(3.3, 4.4)}));
            preparedStatement.setArray(2, conn.createArrayOf(
                &quot;json&quot;,
                new Object[]{
                    DataTypes.STRING.implicitCast(
                        Map.of(
                            &quot;coordinates&quot;, new double[][]{{0, 0}, {1, 1}},
                            &quot;type&quot;, &quot;LineString&quot;
<A NAME="8"></A>                        )
                    )
                }));
            <FONT color="#c58917"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#8',2,'match203567-top.html#8',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>preparedStatement.executeUpdate();
            conn.createStatement().execute(&quot;REFRESH TABLE t&quot;);

            ResultSet rs = conn.createStatement().executeQuery(&quot;SELECT geo_points, geo_shapes FROM t&quot;);
            assertThat(rs.next(), is(true));
            assertThat(
                (Object[]) rs.getArray(1).getArray(),
                arrayContaining(new</B></FONT> PGpoint(1.1, 2.2), new PGpoint(3.3, 4.4)));

            var shapeObject = new PGobject();
            shapeObject.setType(&quot;json&quot;);
            String shape = &quot;{\&quot;coordinates\&quot;:[[0.0,0.0],[1.0,1.0]],\&quot;type\&quot;:\&quot;LineString\&quot;}&quot;;
            shapeObject.setValue(shape);
            assertThat((Object[]) rs.getArray(2).getArray(), arrayContaining(shape));
        } catch (BatchUpdateException e) {
            throw e.getNextException();
        }
    }

    @Test
    public void testFetchSize() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.createStatement().executeUpdate(&quot;create table t (x int) with (number_of_replicas = 0)&quot;);
            ensureGreen();

            PreparedStatement preparedStatement = conn.prepareStatement(&quot;insert into t (x) values (?)&quot;);
            for (int i = 0; i &lt; 20; i++) {
                preparedStatement.setInt(1, i);
                preparedStatement.addBatch();
            }
            preparedStatement.executeBatch();

            conn.createStatement().executeUpdate(&quot;refresh table t&quot;);
            conn.setAutoCommit(false);
            try (Statement st = conn.createStatement()) {
                st.setFetchSize(2);
                try (ResultSet resultSet = st.executeQuery(&quot;select x from t&quot;)) {
                    List&lt;Integer&gt; result = new ArrayList&lt;&gt;();
                    while (resultSet.next()) {
                        result.add(resultSet.getInt(1));
                    }
                    Collections.sort(result);
                    assertThat(result, Matchers.contains(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19));
                }
            }
        }
    }

    @Test
    public void test_query_inbetween_suspended_fetch_operation() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.createStatement().executeUpdate(&quot;create table t (x int) with (number_of_replicas = 0)&quot;);
            PreparedStatement preparedStatement = conn.prepareStatement(&quot;insert into t (x) values (?)&quot;);
            for (int i = 0; i &lt; 6; i++) {
                preparedStatement.setInt(1, i);
                preparedStatement.addBatch();
            }
            preparedStatement.executeBatch();

            conn.createStatement().executeUpdate(&quot;refresh table t&quot;);
            conn.setAutoCommit(false);
            try (Statement st = conn.createStatement()) {
                st.setFetchSize(2);
                try (ResultSet xResults = st.executeQuery(&quot;select x from t&quot;)) {
<A NAME="29"></A>                    List&lt;Integer&gt; result = new ArrayList&lt;&gt;();
                    while (xResults.next()) {
                        if (result.size() == 3) {
                            var select30Result = <FONT color="#af7a82"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#29',2,'match203567-top.html#29',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.createStatement().executeQuery(&quot;select 30&quot;);
                            assertThat(select30Result.next(), is(true));
                            assertThat(select30Result.getInt(1), is(30));
                        }</B></FONT>
                        result.add(xResults.getInt(1));
                    }
                    Collections.sort(result);
                    assertThat(result, Matchers.contains(0, 1, 2, 3, 4, 5));
                }
            }
        }
    }

    @Test
    public void testCloseConnectionWithUnfinishedResultSetDoesNotLeaveAnyPendingOperations() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(false);
            try (Statement statement = conn.createStatement()) {
                statement.setFetchSize(2);
                try (ResultSet resultSet = statement.executeQuery(&quot;select mountain from sys.summits&quot;)) {
                    resultSet.next();
                    resultSet.next();
                }
            }
        }

        // The client closes connections lazy, so the statement issued below may arrive on the server *before*
        // the previous connection is closed, so it may see the previous operation -&gt; use assertBusy
        assertBusy(() -&gt; {
            try {
                try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
                    String q =
                        &quot;SELECT j.stmt || '-' || o.name FROM sys.operations AS o, sys.jobs AS j WHERE o.job_id = j.id&quot; +
                        &quot; and j.stmt = ?&quot;;
                    PreparedStatement statement = conn.prepareStatement(q);
                    statement.setString(1, &quot;select mountain from sys.summits&quot;);
                    ResultSet rs = statement.executeQuery();
                    List&lt;String&gt; operations = new ArrayList&lt;&gt;();
                    while (rs.next()) {
                        operations.add(rs.getString(1));
                    }
                    assertThat(operations, Matchers.empty());
                }
            } catch (SQLException e) {
                throw new RuntimeException(e);
            }
        });
    }

    @Test
    public void testCreateNewStatementAfterUnfinishedResultSet() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties);
            Statement statement = conn.createStatement()) {
            conn.setAutoCommit(false);
            statement.setFetchSize(2);
            try (ResultSet resultSet = statement.executeQuery(&quot;select mountain from sys.summits&quot;)) {
                resultSet.next();
                resultSet.next();
            }
            conn.setAutoCommit(true);
            statement.setFetchSize(0);
            try (ResultSet resultSet = statement.executeQuery(&quot;select mountain from sys.summits&quot;)) {
                while (resultSet.next()) {
                    assertFalse(resultSet.getString(1).isEmpty());
                }
            }
        }
    }

    @Test
    public void testSelectPreparedStatement() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(true);
            PreparedStatement preparedStatement = conn.prepareStatement(&quot;select name from sys.cluster&quot;);
            ResultSet resultSet = preparedStatement.executeQuery();
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getString(1), Matchers.startsWith(&quot;SUITE-TEST_WORKER&quot;));
        }
    }

<A NAME="7"></A>    @Test
    public void testExecuteBatch() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            <FONT color="#38a4a5"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#7',2,'match203567-top.html#7',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.setAutoCommit(true);

            Statement stmt = conn.createStatement();
            stmt.executeUpdate(&quot;create table t (x string, b boolean) with (number_of_replicas = 0)&quot;);
            ensureYellow();

            PreparedStatement preparedStatement = conn.prepareStatement(&quot;insert into t (x, b) values (?, ?)&quot;);
            preparedStatement.setString(1, &quot;Arthur&quot;);
            preparedStatement.setBoolean(2, true);
            preparedStatement.addBatch();

            preparedStatement.setString(1, &quot;Trillian&quot;);
            preparedStatement.setBoolean(2, false);
            preparedStatement.addBatch();

            int[] results = preparedStatement.executeBatch()</B></FONT>;
            assertThat(results, is(new int[]{1, 1}));
        }
    }

    @Test
<A NAME="9"></A>    public void testExecuteBatchWithOneFailingAndNothingExecuted() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            Statement stmt = conn.createStatement();
            <FONT color="#83a33a"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#9',2,'match203567-top.html#9',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>stmt.executeUpdate(&quot;create table t (x int) with (number_of_replicas = 0)&quot;);
            PreparedStatement preparedStatement = conn.prepareStatement(&quot;insert into t (x) values (cast(? as integer))&quot;);
            preparedStatement.setString(1, Integer.toString(1));
            preparedStatement.addBatch();

            preparedStatement.setString(1, &quot;foobar&quot;);
            preparedStatement.addBatch();

            preparedStatement.setString(1, Integer.toString(3));
            preparedStatement.addBatch();

<A NAME="28"></A>            assertThat(preparedStatement.executeBatch(), is</B></FONT>(new int[]{0, 0, 0}));

            conn.createStatement().executeUpdate(&quot;refresh table t&quot;);
            ResultSet rs = <FONT color="#717d7d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#28',2,'match203567-top.html#28',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.createStatement().executeQuery(&quot;select count(*) from t&quot;);
            assertThat(rs.next(), is(true));
            assertThat(rs.getInt(1), is(0));
        }</B></FONT>
    }

    @Test
    public void testExecuteBatchWithOneRuntimeFailure() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
<A NAME="16"></A>            Statement stmt = conn.createStatement();
            stmt.executeUpdate(&quot;create table t (id int primary key, x int) with (number_of_replicas = 0)&quot;);
            ensureYellow();
            <FONT color="#2981b2"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#16',2,'match203567-top.html#16',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>PreparedStatement preparedStatement = conn.prepareStatement(&quot;insert into t (id, x) values (?, ?)&quot;);
            preparedStatement.setInt(1, 1);
            preparedStatement.setInt(2, 0);
            preparedStatement.addBatch();

            preparedStatement.setInt(1, 2);
            preparedStatement.setInt(2, 10);
            preparedStatement.addBatch();

            assertThat(preparedStatement.executeBatch(), is</B></FONT>(new int[]{1, 1}));
            conn.createStatement().executeUpdate(&quot;refresh table t&quot;);

            preparedStatement = conn.prepareStatement(&quot;update t set x = log(x) where id = ?&quot;);
            preparedStatement.setInt(1, 1);
            preparedStatement.addBatch();

<A NAME="3"></A>            preparedStatement.setInt(1, 2);
            preparedStatement.addBatch();
            assertThat(preparedStatement.executeBatch(), is(new int[]{0, 1}));
            <FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#3',2,'match203567-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.createStatement().executeUpdate(&quot;refresh table t&quot;);

            ResultSet rs = conn.createStatement().executeQuery(&quot;select x from t order by id&quot;);
            assertThat(rs.next(), is(true));
            assertThat(rs.getInt(1), is(0)); // log(0) is an error - the update failed and the value remains unchanged

            assertThat(rs.next(), is(true));
            assertThat(rs.getInt</B></FONT>(1), is(1)); // log(10) -&gt; 1
        }
    }

    @Test
    public void testExecuteBatchWithDifferentStatements() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(true);
            Statement stmt = conn.createStatement();
            stmt.executeUpdate(&quot;create table t (x int) with (number_of_replicas = 0)&quot;);
            ensureYellow();

            Statement statement = conn.createStatement();
            statement.addBatch(&quot;insert into t (x) values (1)&quot;);
            statement.addBatch(&quot;insert into t (x) values (2), (3)&quot;);

            int[] results = statement.executeBatch();
<A NAME="15"></A>            assertThat(results, is(new int[]{1, 2}));

            statement.executeUpdate(&quot;refresh table t&quot;);
            ResultSet resultSet = <FONT color="#f52887"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#15',2,'match203567-top.html#15',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>statement.executeQuery(&quot;select * from t order by x&quot;);
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is(1));

            // add another batch
            statement.addBatch(&quot;insert into t (x) values (3)&quot;);

            // only the batches after last execution will be executed
            results = statement.executeBatch();
            assertThat(results, is</B></FONT>(new int[]{1}));

            statement.executeUpdate(&quot;refresh table t&quot;);
            resultSet = statement.executeQuery(&quot;select * from t order by x desc&quot;);
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is(3));
        }
    }

<A NAME="17"></A>    @Test
    public void test_execute_batch_fails_with_read_operations() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            <FONT color="#3090c7"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#17',2,'match203567-top.html#17',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.setAutoCommit(true);
            Statement stmt = conn.createStatement();
            stmt.executeUpdate(&quot;create table t (x int) with (number_of_replicas = 0)&quot;);
            Statement statement = conn.createStatement();
            statement.addBatch(&quot;insert into t(x) values(1), (2)&quot;);
            statement.addBatch(&quot;refresh table t&quot;);
            statement.addBatch(&quot;select count(*) from t&quot;);

            Assertions.assertThrows(BatchUpdateException.class,
                                    () -&gt; statement.executeBatch</B></FONT>(),
                                    &quot;Only write operations are allowed in Batch statements&quot;
            );
        }
    }

<A NAME="1"></A>    @Test
    public void testCreateInsertSelectStringAndTimestamp() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#1',2,'match203567-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.setAutoCommit(true);
            Statement statement = conn.createStatement();
            assertThat(statement.executeUpdate(
                &quot;create table t (&quot; +
                &quot;   x string,&quot; +
                &quot;   ts timestamp with time zone&quot; +
                &quot;) with (number_of_replicas = 0)&quot;), is(1));
            ensureYellow();

            assertThat(statement.executeUpdate(&quot;insert into t (x, ts) values ('Marvin', '2016-05-14'), ('Trillian', '2016-06-28')&quot;), is(2));
            assertThat(statement.executeUpdate(&quot;refresh table t&quot;), is(1));

            statement.executeQuery(&quot;select x, ts from t order by x&quot;);
<A NAME="24"></A>            ResultSet resultSet = statement.getResultSet();
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getString(1), is(&quot;Marvin&quot;));
            assertThat(resultSet.getTimestamp(2), is</B></FONT>(<FONT color="#79764d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#24',2,'match203567-top.html#24',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>new Timestamp(1463184000000L)));

            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getString(1), is(&quot;Trillian&quot;));
            assertThat(resultSet.getTimestamp(2), is</B></FONT>(new Timestamp(1467072000000L)));
        }
    }

    @Test
    public void testSelectWithParameters() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(true);
            PreparedStatement preparedStatement = conn.prepareStatement(&quot;select name from sys.cluster where name like ?&quot;);
            preparedStatement.setString(1, &quot;SUITE%&quot;);
            ResultSet resultSet = preparedStatement.executeQuery();
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getString(1), Matchers.startsWith(&quot;SUITE-TEST_WORKER&quot;));
        }
    }

    @Test
    public void testStatementThatResultsInParseError() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(true);
            PreparedStatement stmt = conn.prepareStatement(&quot;select name fro sys.cluster&quot;);
            assertThrowsMatches(() -&gt; stmt.executeQuery(),
                         isPGError(containsString(&quot;mismatched input 'sys'&quot;), INTERNAL_ERROR));
        }
    }

    @Test
    public void testStatementReadOnlyFailure() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RO), properties)) {
            conn.setAutoCommit(true);
            PreparedStatement stmt = conn.prepareStatement(&quot;create table test(a integer)&quot;);
            assertThrowsMatches(() -&gt; stmt.executeQuery(),
                         isPGError(containsString(&quot;Only read operations allowed on this node&quot;), INTERNAL_ERROR));
        }
    }

    @Test
    public void testErrorRecoveryFromErrorsOutsideSqlOperations() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(true);
<A NAME="14"></A>            PreparedStatement stmt = conn.prepareStatement(&quot;select cast([10.3, 20.2] as integer) &quot; +
                                                           &quot;from information_schema.tables&quot;);
            try {
                <FONT color="#842dce"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#14',2,'match203567-top.html#14',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>stmt.executeQuery();
                fail(&quot;Should've raised PSQLException&quot;);
            } catch (PSQLException e) {
                assertThat(e.getMessage(), containsString(&quot;Cannot cast expressions from type `double precision_array` to type `integer`&quot;));
            }

            assertSelectNameFromSysClusterWorks</B></FONT>(conn);
        }
    }

    @Test
    public void testErrorDetailsFromStackTraceInErrorResponse() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
<A NAME="2"></A>            conn.setAutoCommit(true);
            conn.createStatement().executeUpdate(&quot;select sqrt('abcd') from sys.cluster&quot;);
        } catch (PSQLException e) {
            <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#2',2,'match203567-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertThat(e.getServerErrorMessage().getFile(), not(is(emptyOrNullString())));
            assertThat(e.getServerErrorMessage().getRoutine(), not(is(emptyOrNullString())));
            assertThat(e.getServerErrorMessage().getLine(), greaterThan(0));
        }</B></FONT>
    }

    @Test
    public void testGetPostgresPort() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            ResultSet resultSet = conn.createStatement().executeQuery(&quot;select port['psql'] from sys.nodes limit 1&quot;);
            assertThat(resultSet.next(), is(true));
            Integer port = resultSet.getInt(1);

            ArrayList&lt;Integer&gt; actualPorts = new ArrayList&lt;&gt;();
            for (PostgresNetty postgresNetty : internalCluster().getInstances(PostgresNetty.class)) {
                actualPorts.add(postgresNetty.boundAddress().publishAddress().getPort());
            }
            assertThat(port, Matchers.isOneOf(actualPorts.toArray(new Integer[0])));
        }
    }

<A NAME="12"></A>    @Test
    public void testSetSchemaOnSession() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            <FONT color="#571b7e"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#12',2,'match203567-top.html#12',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.setAutoCommit(true);

            conn.createStatement().execute(&quot;set session search_path to bar&quot;);
            conn.createStatement().executeUpdate(&quot;create table foo (id int) with (number_of_replicas=0)&quot;);

            conn.createStatement().execute(&quot;set session search_path to DEFAULT&quot;);
            assertThrowsMatches(() -&gt; conn.createStatement().execute(&quot;select * from foo&quot;),
                         isPGError(is(&quot;Relation 'foo' unknown&quot;), UNDEFINED_TABLE));
        }</B></FONT>
    }

<A NAME="11"></A>    @Test
    public void testSetMultipleSchemasOnSession() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            <FONT color="#b041ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#11',2,'match203567-top.html#11',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.setAutoCommit(true);

            conn.createStatement().execute(&quot;set session search_path to bar ,custom&quot;);
            conn.createStatement().executeUpdate(&quot;create table foo (id int) with (number_of_replicas=0)&quot;);
            conn.createStatement().executeQuery(&quot;select * from bar.foo&quot;);

            assertThrowsMatches(() -&gt; conn.createStatement().execute(&quot;select * from custom.foo&quot;),
                         isPGError(is(&quot;Schema 'custom' unknown&quot;), INTERNAL_ERROR));
        }</B></FONT>
    }

    @Test
    public void testCountDistinctFromJoin() throws Exception {
<A NAME="27"></A>        // Regression test for a bug where the Postgres-ResultReceiver received types which were a view on symbols which
        // were mutated during analysis/planning of a join - due to that the types changed which led to a ClassCastException
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            ResultSet resultSet = <FONT color="#e77471"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#27',2,'match203567-top.html#27',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.createStatement().executeQuery(
                &quot;select count (distinct 74) from unnest([1, 2]) t1 cross join unnest([2, 3]) t2&quot;);
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getLong(1), is(1L));
        }</B></FONT>
    }

    @Test
    public void testMultiStatementQuery() throws Exception {
        Properties properties = new Properties(this.properties);
        // multi query support is only available in simple query mode
        properties.setProperty(&quot;preferQueryMode&quot;, &quot;simple&quot;);
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            Statement statement = conn.createStatement();
            statement.execute(&quot;set search_path to 'hoschi';&quot; +
                              &quot;create table t (id int);&quot; +
<A NAME="25"></A>                              &quot;insert into t values (42);&quot; +
                              &quot;refresh table t&quot;);
            statement = conn.createStatement();
            ResultSet resultSet = <FONT color="#5eac10"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#25',2,'match203567-top.html#25',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>statement.executeQuery(&quot;select * from hoschi.t&quot;);
            resultSet.next();
            assertThat(resultSet.getInt(1), is(42));
            assertThat(resultSet.isLast(), is(true));
        }</B></FONT>
    }

    @Test
    public void testRepeatedFetchDoesNotLeakSysJobsLog() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.prepareStatement(
                &quot;create table t (&quot; +
                &quot;   x int, ts timestamp with time zone&quot; +
                &quot;) clustered into 1 shards &quot; +
                &quot;with (number_of_replicas = 0)&quot;).execute();
            PreparedStatement preparedStatement = conn.prepareStatement(&quot;insert into t (x, ts) values (?, ?)&quot;);
            for (int i = 0; i &lt; 20; i++) {
                preparedStatement.setInt(1, i);
                preparedStatement.setLong(2, 1541548800000L);
                preparedStatement.addBatch();
            }
            preparedStatement.executeBatch();
            conn.prepareStatement(&quot;refresh table t&quot;).execute();

            conn.setAutoCommit(false);
            PreparedStatement stmt = conn.prepareStatement(&quot;SELECT x FROM t WHERE ts &gt; ? ORDER BY ts ASC LIMIT 5&quot;);
            for (int i = 0; i &lt; 5; i++) {
                stmt.setInt(1, i);
                stmt.setFetchSize(5);
                ResultSet resultSet = stmt.executeQuery();
                while (resultSet.next()) {
                    resultSet.getInt(1);
                }
            }
        }
        for (JobsLogService jobsLogService : internalCluster().getDataNodeInstances(JobsLogService.class)) {
            assertBusy(() -&gt; assertThat(jobsLogService.get().activeJobs(), emptyIterable()));
        }
    }

    @Test
<A NAME="18"></A>    public void test_insert_with_on_conflict_do_nothing_batch_error_resp_is_0_for_conflicting_items() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.prepareStatement(&quot;create table t (id int primary key) clustered into 1 shards&quot;).execute();
            <FONT color="#800517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#18',2,'match203567-top.html#18',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>conn.prepareStatement(&quot;insert into t (id) (select col1 from generate_series(1, 3))&quot;).execute();

            PreparedStatement stmt = conn.prepareStatement(&quot;insert into t (id) values (?) on conflict (id) do nothing&quot;);
            stmt.setInt(1, 4);
            stmt.addBatch();
            stmt.setInt(1, 1);
            stmt.addBatch();

            int[] result = stmt.executeBatch();
            assertThat(result.length, is</B></FONT>(2));
            assertThat(result[0], is(1));
            assertThat(result[1], is(0));
        }
    }

    @Test
    public void test_all_system_columns_can_be_queried_via_postgres() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            // Create a table to also have some shards and sys.allocations, sys.heatlh, sys.shards, etc are not empty.
            conn.prepareStatement(&quot;create table tbl (x int)&quot;).execute();

            ResultSet result = conn.prepareStatement(
                &quot;SELECT &quot; +
                &quot;   table_schema, &quot; +
                &quot;   table_name,&quot; +
                &quot;   collect_set(column_name) as columns &quot; +
                &quot;FROM &quot; +
                &quot;   information_schema.columns &quot; +
                &quot;WHERE &quot; +
                &quot;   table_schema IN ('sys', 'pg_catalog', 'information_schema') &quot; +
                &quot;GROUP BY &quot; +
                &quot;   1, 2&quot;).executeQuery();
            while (result.next()) {
                String schema = result.getString(1);
                String table = result.getString(2);

                Array columns = result.getArray(3);
                StringJoiner columnList = new StringJoiner(&quot;, &quot;);
                for (String column : ((String[]) columns.getArray())) {
                    if (column.contains(&quot;[&quot;)) {
                        columnList.add(column);
                    } else {
                        columnList.add('&quot;' + column + '&quot;');
                    }
                }
                String statement = String.format(
                    Locale.ENGLISH,
                    &quot;SELECT %s FROM \&quot;%s\&quot;.\&quot;%s\&quot;&quot;,
                    columnList.toString(),
                    schema,
                    table
                );
                // This must not throw a ClassCastException
                conn.prepareStatement(statement).executeQuery();
            }
        }
    }

    @Test
    @UseJdbc(0) // Simulate explicit call by a user through HTTP iface
    public void test_proper_termination_of_deallocate_through_http_call() throws Exception {
       execute(&quot;DEALLOCATE ALL&quot;);
       assertThat(response.rowCount(), is (0L));
    }

    @Test
    public void test_getProcedureColumns() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            var results = conn.getMetaData().getProcedureColumns(&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;);
            assertThat(results.next(), is(true));
            assertThat(results.getString(3), is(&quot;_pg_expandarray&quot;));
        }
    }

    @Test
    public void test_each_non_array_pg_type_entry_can_be_joined_with_pg_proc() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            PreparedStatement stmt = conn.prepareStatement(
                &quot;SELECT pg_type.oid, pg_type.typname, pg_proc.proname &quot; +
                &quot;FROM pg_catalog.pg_type LEFT OUTER JOIN pg_catalog.pg_proc ON pg_proc.oid = pg_type.typreceive &quot; +
                &quot;WHERE pg_type.typarray &lt;&gt; 0&quot;);
            ResultSet result = stmt.executeQuery();
            while (result.next()) {
                assertThat(
                    &quot;There must be an entry for `&quot; + result.getInt(1) + &quot;/&quot; + result.getString(2) + &quot;` in pg_proc&quot;,
                    result.getString(3),
                    Matchers.notNullValue(String.class)
                );
            }
        }
    }

    @Test
    public void test_parse_failures_in_simple_protocol_mode_are_propagated_to_client() throws Exception {
        // regression test; used to get stuck
        Properties properties = new Properties();
        properties.setProperty(&quot;user&quot;, &quot;crate&quot;);
        properties.setProperty(PGProperty.PREFER_QUERY_MODE.getName(), PreferQueryMode.SIMPLE.value());
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            Statement statement = conn.createStatement();
            assertThrows(PSQLException.class, () -&gt; statement.execute(&quot;create index invalid_statement&quot;));
            ResultSet result = statement.executeQuery(&quot;select 1&quot;);
            assertThat(result.next(), is(true));
            assertThat(result.getInt(1), is(1));
        }
    }

    @Test
    public void test_insert_from_unnest_returning_which_inserts_duplicate_keys() throws Exception {
        Properties properties = new Properties();
        properties.setProperty(&quot;user&quot;, &quot;crate&quot;);
        try (var conn = DriverManager.getConnection(url(RW), properties)) {
            var statement = conn.createStatement();
            statement.execute(&quot;create table tbl (id bigint primary key, val text)&quot;);
            var textGenerator = DataTypeTesting.getDataGenerator(DataTypes.STRING);
            var insertUnnest = conn.prepareStatement(
                &quot;insert into tbl (id, val) (select id, val from unnest(?, ?) as t (id, val)) returning _id&quot;);

            for (int iteration = 0; iteration &lt; 2; iteration++) {
                var ids = new Object[10];
                var values = new Object[10];
                for (int i = 0; i &lt; 10; i++) {
                    ids[i] = i;
                    values[i] = textGenerator.get();
                }
                insertUnnest.setObject(1, conn.createArrayOf(&quot;bigint&quot;, ids));
                insertUnnest.setObject(2, conn.createArrayOf(&quot;text&quot;, values));
                var result = insertUnnest.executeQuery();
                int numResults = 0;
                while (result.next()) {
                    numResults++;
                }
                if (iteration == 0) {
                    assertThat(numResults, is(10));
                } else {
                    assertThat(numResults, is(0));
                }
            }
        }
    }

    @Test
    public void test_metadata_calls_do_not_query_pg_catalog_tables_repeatedly() throws Exception {
        var properties = new Properties();
        properties.put(&quot;user&quot;, &quot;crate&quot;);
        properties.put(&quot;password&quot;, &quot;&quot;);
        try (var conn = DriverManager.getConnection(url(RW), properties)) {
            var stmt = conn.createStatement();
            stmt.execute(&quot;create table uservisits (\&quot;adRevenue\&quot; float, \&quot;cCode\&quot; text, \&quot;duration\&quot; float)&quot;);

            conn.setAutoCommit(false);
            stmt = conn.createStatement();
            stmt.setFetchSize(101);
            ResultSet result = stmt.executeQuery(
                    &quot;select avg(\&quot;adRevenue\&quot;) from uservisits group by \&quot;cCode\&quot;, \&quot;duration\&quot; limit 100&quot;);

            long numQueries = getNumQueriesFromJobsLogs();
            ResultSetMetaData metaData = result.getMetaData();
            for (int i = 0; i &lt; 50; i++) {
                // These calls must not invoke extra queries
                metaData.isAutoIncrement(1);
            }
            assertThat(getNumQueriesFromJobsLogs(), is(numQueries));
            result.close();
        }
    }

    private long getNumQueriesFromJobsLogs() {
        long result = 0;
        Iterable&lt;JobsLogs&gt; jobLogs = internalCluster().getInstances(JobsLogs.class);
        for (JobsLogs jobsLogs : jobLogs) {
            for (var metrics : jobsLogs.metrics()) {
                result += metrics.totalCount();
            }
        }
        return result;
    }

<A NAME="19"></A>    private void assertSelectNameFromSysClusterWorks(Connection conn) throws SQLException {
        PreparedStatement stmt;// verify that queries can be made after an error occurred
        stmt = conn.prepareStatement(&quot;select name from sys.cluster&quot;);
        ResultSet resultSet = <FONT color="#f62817"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match203567-0.html#19',2,'match203567-top.html#19',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>stmt.executeQuery();
        assertThat(resultSet.next(), is(true));
        assertThat(resultSet.getString(1), Matchers.startsWith(&quot;SUITE-TEST_WORKER&quot;));
    }
}</B></FONT>
</PRE>
</div>
  </div>
</body>
</html>
