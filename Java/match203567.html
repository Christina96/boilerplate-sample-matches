<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for IndexSettingsTests.java &amp; PostgresITest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for IndexSettingsTests.java &amp; PostgresITest.java
      </h3>
<h1 align="center">
        30.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>IndexSettingsTests.java (41.641937%)<th>PostgresITest.java (24.293133%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(22-52)<td><a href="#" name="0">(22-50)</a><td align="center"><font color="#ff0000">27</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(159-178)<td><a href="#" name="1">(743-759)</a><td align="center"><font color="#ec0000">25</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(78-89)<td><a href="#" name="2">(822-825)</a><td align="center"><font color="#a00000">17</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(434-442)<td><a href="#" name="3">(677-684)</a><td align="center"><font color="#970000">16</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(280-292)<td><a href="#" name="4">(288-294)</a><td align="center"><font color="#970000">16</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(460-465)<td><a href="#" name="5">(217-223)</a><td align="center"><font color="#8d0000">15</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(588-595)<td><a href="#" name="6">(311-316)</a><td align="center"><font color="#840000">14</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(423-432)<td><a href="#" name="7">(608-623)</a><td align="center"><font color="#840000">14</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(351-363)<td><a href="#" name="8">(458-465)</a><td align="center"><font color="#840000">14</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(69-77)<td><a href="#" name="9">(632-643)</a><td align="center"><font color="#840000">14</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(205-214)<td><a href="#" name="10">(272-277)</a><td align="center"><font color="#7a0000">13</font>
<tr onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b041ff"><font color="#b041ff">-</font><td><a href="#" name="11">(183-187)<td><a href="#" name="11">(860-868)</a><td align="center"><font color="#7a0000">13</font>
<tr onclick='openModal("#571b7e")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#571b7e"><font color="#571b7e">-</font><td><a href="#" name="12">(127-140)<td><a href="#" name="12">(846-854)</a><td align="center"><font color="#7a0000">13</font>
<tr onclick='openModal("#3b9c9c")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3b9c9c"><font color="#3b9c9c">-</font><td><a href="#" name="13">(614-625)<td><a href="#" name="13">(236-243)</a><td align="center"><font color="#710000">12</font>
<tr onclick='openModal("#842dce")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#842dce"><font color="#842dce">-</font><td><a href="#" name="14">(248-258)<td><a href="#" name="14">(806-812)</a><td align="center"><font color="#710000">12</font>
<tr onclick='openModal("#f52887")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f52887"><font color="#f52887">-</font><td><a href="#" name="15">(226-238)<td><a href="#" name="15">(704-713)</a><td align="center"><font color="#710000">12</font>
<tr onclick='openModal("#2981b2")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#2981b2"><font color="#2981b2">-</font><td><a href="#" name="16">(606-609)<td><a href="#" name="16">(658-667)</a><td align="center"><font color="#670000">11</font>
<tr onclick='openModal("#3090c7")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3090c7"><font color="#3090c7">-</font><td><a href="#" name="17">(448-456)<td><a href="#" name="17">(725-734)</a><td align="center"><font color="#670000">11</font>
<tr onclick='openModal("#800517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#800517"><font color="#800517">-</font><td><a href="#" name="18">(272-278)<td><a href="#" name="18">(939-948)</a><td align="center"><font color="#670000">11</font>
<tr onclick='openModal("#f62817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f62817"><font color="#f62817">-</font><td><a href="#" name="19">(686-691)<td><a href="#" name="19">(1120-1124)</a><td align="center"><font color="#5e0000">10</font>
<tr onclick='openModal("#4e9258")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4e9258"><font color="#4e9258">-</font><td><a href="#" name="20">(513-519)<td><a href="#" name="20">(363-368)</a><td align="center"><font color="#5e0000">10</font>
<tr onclick='openModal("#947010")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#947010"><font color="#947010">-</font><td><a href="#" name="21">(484-490)<td><a href="#" name="21">(259-263)</a><td align="center"><font color="#5e0000">10</font>
<tr onclick='openModal("#4cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4cc417"><font color="#4cc417">-</font><td><a href="#" name="22">(379-382)<td><a href="#" name="22">(326-343)</a><td align="center"><font color="#5e0000">10</font>
<tr onclick='openModal("#f660ab")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f660ab"><font color="#f660ab">-</font><td><a href="#" name="23">(340-344)<td><a href="#" name="23">(303-307)</a><td align="center"><font color="#5e0000">10</font>
<tr onclick='openModal("#79764d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#79764d"><font color="#79764d">-</font><td><a href="#" name="24">(322-328)<td><a href="#" name="24">(759-763)</a><td align="center"><font color="#5e0000">10</font>
<tr onclick='openModal("#5eac10")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#5eac10"><font color="#5eac10">-</font><td><a href="#" name="25">(658-661)<td><a href="#" name="25">(895-899)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#68818b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#68818b"><font color="#68818b">-</font><td><a href="#" name="26">(646-649)<td><a href="#" name="26">(250-253)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#e77471")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#e77471"><font color="#e77471">-</font><td><a href="#" name="27">(597-600)<td><a href="#" name="27">(876-880)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#717d7d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#717d7d"><font color="#717d7d">-</font><td><a href="#" name="28">(582-585)<td><a href="#" name="28">(646-649)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#af7a82")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#af7a82"><font color="#af7a82">-</font><td><a href="#" name="29">(544-552)<td><a href="#" name="29">(525-528)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#ae694a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ae694a"><font color="#ae694a">-</font><td><a href="#" name="30">(443-447)<td><a href="#" name="30">(224-230)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#3ea99f")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3ea99f"><font color="#3ea99f">-</font><td><a href="#" name="31">(300-305)<td><a href="#" name="31">(376-379)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#5b8daf")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#5b8daf"><font color="#5b8daf">-</font><td><a href="#" name="32">(120-125)<td><a href="#" name="32">(424-426)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#736aff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#736aff"><font color="#736aff">-</font><td><a href="#" name="33">(116-120)<td><a href="#" name="33">(398-400)</a><td align="center"><font color="#550000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>IndexSettingsTests.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19 <a name="0"></a> * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>package org.elasticsearch.index;
22 import io.crate.common.unit.TimeValue;
23 import io.crate.types.DataTypes;
24 import org.elasticsearch.Version;
25 import org.elasticsearch.cluster.metadata.IndexMetadata;
26 import org.elasticsearch.common.settings.AbstractScopedSettings;
27 import org.elasticsearch.common.settings.IndexScopedSettings;
28 import org.elasticsearch.common.settings.Setting;
29 import org.elasticsearch.common.settings.Setting.Property;
30 import org.elasticsearch.common.settings.Settings;
31 import org.elasticsearch.common.unit.ByteSizeUnit;
32 import org.elasticsearch.common.unit.ByteSizeValue;
33 import org.elasticsearch.index.translog.Translog;
34 import org.elasticsearch.test.ESTestCase;
35 import org.elasticsearch.test.VersionUtils;
36 import org.junit.Test;
37 import java.util.Arrays;
38 import java.util.Collections;
39 import java.util.HashSet;
40 import java.util.Set;
41 import java.util.concurrent.TimeUnit;
42 import java.util.concurrent.atomic.AtomicInteger;
43 import java.util.function.Function;
44 import static org.hamcrest.CoreMatchers.equalTo;
45 import static org.hamcrest.Matchers.is;
46 import static org.hamcrest.core.StringContains.containsString;
47 import</b></font> static org.hamcrest.object.HasToString.hasToString;
48 public class IndexSettingsTests extends ESTestCase {
49     @Test
50     public void testRunListener() {
51         Version version = VersionUtils.getPreviousVersion();
52         Settings theSettings = Settings.builder()
53             .put(IndexMetadata.SETTING_VERSION_CREATED, version)
54             .put(IndexMetadata.SETTING_INDEX_UUID, "0xdeadbeef").build();
55         final AtomicInteger integer = new AtomicInteger(0);
56         Setting&lt;Integer&gt; integerSetting = Setting.intSetting(
57             "index.test.setting.int",
58             -1,
59 <a name="9"></a>            Property.Dynamic,
60             Property.IndexScope
61         );
62         IndexMetadata metaData = <font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newIndexMeta("index", theSettings);
63         IndexSettings settings = newIndexSettings(
64             newIndexMeta("index", theSettings), Settings.EMPTY, integerSetting);
65         settings.getScopedSettings().addSettingsUpdateConsumer(integerSetting, integer::set);
66         assertThat(settings.getIndexVersionCreated(), is(version));
67 <a name="2"></a>        assertThat(settings.getUUID(), is("0xdeadbeef"));
68         assertFalse(settings.updateIndexMetadata</b></font>(metaData));
69         assertThat(<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>settings.getSettings(), is(metaData.getSettings()));
70         assertThat(integer.get(), is(0));
71         assertTrue(
72             settings.updateIndexMetadata(
73                 newIndexMeta(
74                     "index",
75                     Settings.builder()
76                         .put(theSettings)
77                         .put("index.test.setting.int", 42)
78                         .build())));
79         assertThat(integer.get(), is(42));
80     }</b></font>
81     @Test
82     public void testSettingsUpdateValidator() {
83         Version version = VersionUtils.getPreviousVersion();
84         Settings theSettings = Settings.builder()
85             .put(IndexMetadata.SETTING_VERSION_CREATED, version)
86             .put(IndexMetadata.SETTING_INDEX_UUID, "0xdeadbeef")
87             .build();
88         final AtomicInteger integer = new AtomicInteger(0);
89         Setting&lt;Integer&gt; integerSetting = Setting.intSetting(
90             "index.test.setting.int",
91             -1,
92             Property.Dynamic,
93             Property.IndexScope
94         );
95         IndexMetadata metaData = newIndexMeta("index", theSettings);
96         IndexSettings settings = newIndexSettings(
97             newIndexMeta("index", theSettings), Settings.EMPTY, integerSetting);
98         settings.getScopedSettings().addSettingsUpdateConsumer(
99             integerSetting, integer::set,
100             (i) -&gt; {
101                 if (i == 42) {
102                     throw new AssertionError("boom");
103 <a name="33"></a>                }
104             });
105         <font color="#736aff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(settings.getIndexVersionCreated(), is(version));
106 <a name="32"></a>        assertThat(settings.getUUID(), is("0xdeadbeef"));
107         assertFalse(settings.updateIndexMetadata(metaData));
108         assertThat</b></font>(<font color="#5b8daf"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>settings.getSettings(), is(metaData.getSettings()));
109         assertThat(integer.get(), is(0));
110         expectThrows(
111             IllegalArgumentException.class,
112 <a name="12"></a>            () -&gt; settings.updateIndexMetadata(
113                 newIndexMeta</b></font>(
114                     "index",
115                     <font color="#571b7e"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Settings.builder()
116                         .put(theSettings)
117                         .put("index.test.setting.int", 42)
118                         .build())));
119         assertTrue(
120             settings.updateIndexMetadata(
121                 newIndexMeta(
122                     "index",
123                     Settings.builder()
124                         .put(theSettings)
125                         .put("index.test.setting.int", 41)
126                         .build())));
127         assertThat(integer.get(), is(41));
128     }</b></font>
129     @Test
130     public void testMergedSettingsArePassed() {
131         Version version = VersionUtils.getPreviousVersion();
132         Settings theSettings = Settings.builder()
133             .put(IndexMetadata.SETTING_VERSION_CREATED, version)
134             .put(IndexMetadata.SETTING_INDEX_UUID, "0xdeadbeef")
135             .build();
136         final AtomicInteger integer = new AtomicInteger(0);
137         final StringBuilder builder = new StringBuilder();
138         Setting&lt;Integer&gt; integerSetting = Setting.intSetting(
139             "index.test.setting.int",
140             -1,
141             Property.Dynamic,
142             Property.IndexScope);
143 <a name="1"></a>        Setting&lt;String&gt; notUpdated = new Setting&lt;&gt;(
144             "index.not.updated",
145             "",
146             <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Function.identity(),
147             DataTypes.STRING,
148             Property.Dynamic,
149             Property.IndexScope);
150         IndexSettings settings = newIndexSettings(
151             newIndexMeta("index", theSettings), Settings.EMPTY, integerSetting, notUpdated);
152         settings.getScopedSettings().addSettingsUpdateConsumer(integerSetting, integer::set);
153         settings.getScopedSettings().addSettingsUpdateConsumer(notUpdated, builder::append);
154         assertThat(integer.get(), is(0));
155         assertThat(builder.toString(), is(""));
156         IndexMetadata newMetaData = newIndexMeta(
157             "index",
158             Settings.builder()
159                 .put(settings.getIndexMetadata().getSettings())
160                 .put("index.test.setting.int", 42)
161                 .build()
162         );
163         assertTrue(settings.updateIndexMetadata(newMetaData));
164         assertSame</b></font>(settings.getIndexMetadata(), newMetaData);
165         assertThat(integer.get(), is(42));
166 <a name="11"></a>        assertThat(builder.toString(), is(""));
167         integer.set(0);
168         assertTrue(settings.updateIndexMetadata(
169             newIndexMeta("index", <font color="#b041ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Settings.builder().put(settings.getIndexMetadata().getSettings())
170                 .put("index.not.updated", "boom").build())));
171         assertThat(builder.toString(), is("boom"));
172         assertThat("not updated - we preserve the old settings", integer.get(), is(0));
173     }</b></font>
174     @Test
175     public void testSettingsConsistency() {
176         Version version = VersionUtils.getPreviousVersion();
177         IndexMetadata metaData = newIndexMeta(
178             "index",
179             Settings.builder()
180                 .put(IndexMetadata.SETTING_VERSION_CREATED, version)
181                 .build()
182         );
183         IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY);
184         assertThat(settings.getIndexVersionCreated(), is(version));
185         assertThat(settings.getUUID(), is("_na_"));
186         try {
187 <a name="10"></a>            settings.updateIndexMetadata(
188                 newIndexMeta(
189                     "index",
190                     <font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Settings.builder()
191                         .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
192                         .put("index.test.setting.int", 42)
193                         .build()
194                 )
195             );
196             fail("version has changed");
197         } catch (IllegalArgumentException ex) {
198             assertTrue(ex.getMessage(), ex.getMessage().startsWith("version mismatch on settings update expected: "));
199         }</b></font>
200         int unknownVersion = Version.CURRENT.internalId + 200;
201         metaData = newIndexMeta(
202             "index",
203             Settings.builder()
204                 .put(
205                     IndexMetadata.SETTING_VERSION_CREATED, Version.fromId(unknownVersion))
206 <a name="15"></a>                .build());
207         settings = new IndexSettings(metaData, Settings.EMPTY);
208         assertThat(settings.getIndexVersionCreated(), is(Version.fromId(unknownVersion)));
209         assertThat(settings.getUUID(), <font color="#f52887"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>is("_na_"));
210         settings.updateIndexMetadata(
211             newIndexMeta(
212                 "index",
213                 Settings.builder()
214                     .put(IndexMetadata.SETTING_VERSION_CREATED, Version.fromId(unknownVersion))
215                     .put("index.test.setting.int", 42)
216                     .build()
217             )
218         );
219         metaData = newIndexMeta(
220             "index",
221             Settings.builder()</b></font>
222                 .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
223                 .put(IndexMetadata.SETTING_INDEX_UUID, "0xdeadbeef")
224                 .build()
225         );
226         settings = new IndexSettings(metaData, Settings.EMPTY);
227         try {
228 <a name="14"></a>            settings.updateIndexMetadata(
229                 newIndexMeta(
230                     "index",
231                     <font color="#842dce"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Settings.builder()
232                         .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
233                         .put("index.test.setting.int", 42)
234                         .build()
235                 )
236             );
237             fail("uuid missing/change");
238         } catch (IllegalArgumentException ex) {
239             assertThat(ex.getMessage(), is("uuid mismatch on settings update expected: 0xdeadbeef but was: _na_"));
240         }
241         assertThat</b></font>(settings.getSettings(), is(metaData.getSettings()));
242     }
243     public IndexSettings newIndexSettings(IndexMetadata metaData, Settings nodeSettings, Setting&lt;?&gt;... settings) {
244         Set&lt;Setting&lt;?&gt;&gt; settingSet = new HashSet&lt;&gt;(IndexScopedSettings.BUILT_IN_INDEX_SETTINGS);
245         if (settings.length &gt; 0) {
246             settingSet.addAll(Arrays.asList(settings));
247         }
248         return new IndexSettings(metaData, nodeSettings, new IndexScopedSettings(Settings.EMPTY, settingSet));
249     }
250 <a name="18"></a>    @Test
251     public void testNodeSettingsAreContained() {
252         final int numShards = randomIntBetween(1, 10);
253         final int numReplicas = <font color="#800517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>randomIntBetween(0, 10);
254         Settings theSettings = Settings.builder().
255             put("index.foo.bar", 0)
256             .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, numReplicas)
257             .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, numShards).build();
258 <a name="4"></a>
259         Settings nodeSettings = Settings.builder</b></font>().put("index.foo.bar", 43).build();
260         final AtomicInteger indexValue = new AtomicInteger(0);
261         Setting&lt;Integer&gt; integerSetting = <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Setting.intSetting(
262             "index.foo.bar",
263             -1,
264             Property.Dynamic,
265             Property.IndexScope);
266         IndexSettings settings = newIndexSettings(
267             newIndexMeta("index", theSettings), nodeSettings, integerSetting);
268         settings.getScopedSettings().addSettingsUpdateConsumer(integerSetting, indexValue::set);
269         assertThat(settings.getNumberOfReplicas(), is(numReplicas));
270         assertThat(settings.getNumberOfShards(), is(numShards));
271         assertThat(indexValue.get(), is(0));
272         assertTrue</b></font>(settings.updateIndexMetadata(newIndexMeta("index", Settings.builder().
273             put("index.foo.bar", 42)
274             .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, numReplicas + 1)
275             .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, numShards).build())));
276 <a name="31"></a>        assertThat(indexValue.get(), is(42));
277         assertSame(nodeSettings, settings.getNodeSettings());
278         assertTrue(settings.updateIndexMetadata(<font color="#3ea99f"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newIndexMeta("index", Settings.builder()
279             .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, numReplicas + 1)
280             .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, numShards).build())));
281         assertThat(indexValue.get(), is(43));
282     }</b></font>
283     public static IndexMetadata newIndexMeta(String name, Settings indexSettings) {
284         Settings build = Settings.builder().put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
285             .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 1)
286             .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, 1)
287             .put(indexSettings)
288             .build();
289         return IndexMetadata.builder(name).settings(build).build();
290     }
291     @Test
292     public void testUpdateDurability() {
293         IndexMetadata metaData = newIndexMeta("index", Settings.builder()
294 <a name="24"></a>            .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
295             .put(IndexSettings.INDEX_TRANSLOG_DURABILITY_SETTING.getKey(), "async")
296             .build());
297         IndexSettings settings = <font color="#79764d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>new IndexSettings(metaData, Settings.EMPTY);
298         assertThat(settings.getTranslogDurability(), is(Translog.Durability.ASYNC));
299         settings.updateIndexMetadata(
300             newIndexMeta(
301                 "index",
302                 Settings.builder()
303                     .put(IndexSettings.INDEX_TRANSLOG_DURABILITY_SETTING.getKey</b></font>(), "request")
304                     .build()));
305         assertThat(settings.getTranslogDurability(), is(Translog.Durability.REQUEST));
306         metaData = newIndexMeta("index", Settings.builder()
307             .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
308             .build());
309         settings = new IndexSettings(metaData, Settings.EMPTY);
310         assertThat(settings.getTranslogDurability(), is(Translog.Durability.REQUEST)); <a name="23"></a>    }
311     @Test
312     public void testRefreshInterval() <font color="#f660ab"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
313         String refreshInterval = getRandomTimeString();
314         IndexMetadata metaData = newIndexMeta("index", Settings.builder()
315             .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
316             .put(IndexSettings.INDEX_REFRESH_INTERVAL_SETTING.getKey</b></font>(), refreshInterval)
317             .build());
318         IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY);
319         assertThat(
320 <a name="8"></a>            TimeValue.parseTimeValue(
321                 refreshInterval,
322                 new TimeValue(1, TimeUnit.DAYS),
323                 <font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>IndexSettings.INDEX_REFRESH_INTERVAL_SETTING.getKey()),
324             is(settings.getRefreshInterval()));
325         String newRefreshInterval = getRandomTimeString();
326         settings.updateIndexMetadata(
327             newIndexMeta(
328                 "index",
329                 Settings.builder()
330                     .put(IndexSettings.INDEX_REFRESH_INTERVAL_SETTING.getKey(), newRefreshInterval)
331                     .build()));
332         assertThat(
333             TimeValue.parseTimeValue(
334                 newRefreshInterval,
335                 new</b></font> TimeValue(1, TimeUnit.DAYS),
336                 IndexSettings.INDEX_REFRESH_INTERVAL_SETTING.getKey()),
337             is(settings.getRefreshInterval()));
338     }
339     private String getRandomTimeString() {
340         int refreshIntervalInt = randomFrom(-1, Math.abs(randomInt()));
341         String refreshInterval = Integer.toString(refreshIntervalInt);
342         if (refreshIntervalInt &gt;= 0) {
343             refreshInterval += randomFrom("s", "ms", "h");
344         }
345         return refreshInterval;
346     }
347 <a name="22"></a>
348     @Test
349     public void testGCDeletesSetting() {
350         TimeValue gcDeleteSetting = new TimeValue(<font color="#4cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Math.abs(randomInt()), TimeUnit.MILLISECONDS);
351         IndexMetadata metaData = newIndexMeta("index", Settings.builder()
352             .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
353             .put(IndexSettings.INDEX_GC_DELETES_SETTING.getKey(), gcDeleteSetting.getStringRep</b></font>())
354             .build());
355         IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY);
356         assertThat(
357             TimeValue.parseTimeValue(
358                 gcDeleteSetting.getStringRep(),
359                 new TimeValue(1, TimeUnit.DAYS),
360                 IndexSettings.INDEX_GC_DELETES_SETTING.getKey()).getMillis(),
361             is(settings.getGcDeletesInMillis())
362         );
363         TimeValue newGCDeleteSetting = new TimeValue(Math.abs(randomInt()), TimeUnit.MILLISECONDS);
364         settings.updateIndexMetadata(
365             newIndexMeta(
366                 "index",
367                 Settings.builder()
368                     .put(IndexSettings.INDEX_GC_DELETES_SETTING.getKey(), newGCDeleteSetting.getStringRep())
369                     .build()
370             )
371         );
372         assertThat(
373             TimeValue.parseTimeValue(
374                 newGCDeleteSetting.getStringRep(),
375                 new TimeValue(1, TimeUnit.DAYS),
376                 IndexSettings.INDEX_GC_DELETES_SETTING.getKey()).getMillis(),
377             is(settings.getGcDeletesInMillis())
378         );
379         settings.updateIndexMetadata(
380             newIndexMeta(
381                 "index",
382                 Settings.builder()
383                     .put(
384                         IndexSettings.INDEX_GC_DELETES_SETTING.getKey(),
385                         (randomBoolean() ? -1 : new TimeValue(-1, TimeUnit.MILLISECONDS)).toString()
386                     ).build()
387             )
388         );
389         assertThat(settings.getGcDeletesInMillis(), is(-1L));
390     }
391 <a name="7"></a>
392     @Test
393     public void testTranslogFlushSizeThreshold() {
394         ByteSizeValue translogFlushThresholdSize = new ByteSizeValue(Math.abs(<font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>randomInt()));
395         ByteSizeValue actualValue = ByteSizeValue.parseBytesSizeValue(
396             translogFlushThresholdSize.getBytes() + "B",
397             IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey());
398         IndexMetadata metaData = newIndexMeta("index", Settings.builder()
399             .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
400             .put(IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey(),
401                  translogFlushThresholdSize.getBytes() + "B")
402 <a name="3"></a>            .build());
403         IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY)</b></font>;
404         assertThat(actualValue, is(settings.getFlushThresholdSize()));
405         ByteSizeValue newTranslogFlushThresholdSize = new ByteSizeValue(<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Math.abs(randomInt()));
406         ByteSizeValue actualNewTranslogFlushThresholdSize = ByteSizeValue.parseBytesSizeValue(
407             newTranslogFlushThresholdSize.getBytes() + "B",
408             IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey());
409         settings.updateIndexMetadata(newIndexMeta("index", Settings.builder()
410             .put(IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey(),
411 <a name="30"></a>                 newTranslogFlushThresholdSize.getBytes() + "B")
412             .build()));
413         assertThat(actualNewTranslogFlushThresholdSize, equalTo(settings.getFlushThresholdSize</b></font>()));
414     <font color="#ae694a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
415 <a name="17"></a>    @Test
416     public void testTranslogGenerationSizeThreshold() {
417         final ByteSizeValue size = new ByteSizeValue(Math.abs(randomInt</b></font>()));
418         final String key = <font color="#3090c7"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>IndexSettings.INDEX_TRANSLOG_GENERATION_THRESHOLD_SIZE_SETTING.getKey();
419         final ByteSizeValue actualValue =
420             ByteSizeValue.parseBytesSizeValue(size.getBytes() + "B", key);
421         final IndexMetadata metaData =
422             newIndexMeta(
423                 "index",
424                 Settings.builder()
425                     .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
426                     .put(key, size.getBytes</b></font>() + "B")
427 <a name="5"></a>                    .build());
428         final IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY);
429         assertThat(actualValue, is(settings.getGenerationThresholdSize()));
430         final ByteSizeValue newSize = new ByteSizeValue(<font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Math.abs(randomInt()));
431         final ByteSizeValue actual = ByteSizeValue.parseBytesSizeValue(newSize.getBytes() + "B", key);
432         settings.updateIndexMetadata(
433             newIndexMeta("index", Settings.builder().put(key, newSize.getBytes() + "B").build()));
434         assertThat(actual, is(settings.getGenerationThresholdSize()));
435     }</b></font>
436     @Test
437     public void testPrivateSettingsValidation() {
438         final Settings settings = Settings.builder()
439             .put(IndexMetadata.SETTING_CREATION_DATE, System.currentTimeMillis())
440             .build();
441         final IndexScopedSettings indexScopedSettings = new IndexScopedSettings(
442             settings,
443             IndexScopedSettings.BUILT_IN_INDEX_SETTINGS);
444         {
445             final IllegalArgumentException e = expectThrows(
446                 IllegalArgumentException.class,
447                 () -&gt; indexScopedSettings.validate(settings, randomBoolean()));
448 <a name="21"></a>            assertThat(e, hasToString(containsString("unknown setting [index.creation_date]")));
449         }
450         <font color="#947010"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
451             final IllegalArgumentException e = expectThrows(
452                 IllegalArgumentException.class,
453                 () -&gt; indexScopedSettings.validate(settings, randomBoolean(), false, randomBoolean()));
454             assertThat(e, hasToString(containsString("unknown setting [index.creation_date]")));
455         }</b></font>
456         indexScopedSettings.validate(settings, randomBoolean(), true, randomBoolean());
457     }
458     @Test
459     public void testArchivedSettingsValidation() {
460         final Settings settings = Settings.builder()
461             .put(AbstractScopedSettings.ARCHIVED_SETTINGS_PREFIX + "foo", System.currentTimeMillis())
462             .build();
463         final IndexScopedSettings indexScopedSettings = new IndexScopedSettings(
464             settings,
465             IndexScopedSettings.BUILT_IN_INDEX_SETTINGS
466         );
467         {
468             final IllegalArgumentException e = expectThrows(
469                 IllegalArgumentException.class,
470                 () -&gt; indexScopedSettings.validate(settings, randomBoolean()));
471 <a name="20"></a>            assertThat(e, hasToString(containsString("unknown setting [archived.foo]")));
472         }
473         <font color="#4e9258"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
474             final IllegalArgumentException e = expectThrows(
475                 IllegalArgumentException.class,
476                 () -&gt; indexScopedSettings.validate(settings, randomBoolean(), randomBoolean(), false));
477             assertThat(e, hasToString(containsString("unknown setting [archived.foo]")));
478         }</b></font>
479         indexScopedSettings.validate(settings, randomBoolean(), randomBoolean(), true);
480     }
481     @Test
482     public void testArchiveBrokenIndexSettings() {
483         Settings settings =
484             IndexScopedSettings.DEFAULT_SCOPED_SETTINGS.archiveUnknownOrInvalidSettings(
485                 Settings.EMPTY,
486                 e -&gt; {
487                     assert false : "should not have been invoked, no unknown settings";
488                 },
489                 (e, ex) -&gt; {
490                     assert false : "should not have been invoked, no invalid settings";
491                 });
492         assertSame(settings, Settings.EMPTY);
493         settings =
494             IndexScopedSettings.DEFAULT_SCOPED_SETTINGS.archiveUnknownOrInvalidSettings(
495                 Settings.builder().put("index.refresh_interval", "-200").build(),
496                 e -&gt; {
497 <a name="29"></a>                    assert false : "should not have been invoked, no invalid settings";
498                 },
499                 (e, ex) -&gt; {
500                     assertThat(<font color="#af7a82"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>e.getKey(), equalTo("index.refresh_interval"));
501                     assertThat(e.getValue(), equalTo("-200"));
502                     assertThat(
503                         ex,
504                         hasToString(containsString(
505                             "failed to parse value [-200] for setting [index.refresh_interval], must be &gt;= [-1]")
506                         )
507                     );
508                 }</b></font>);
509         assertThat(settings.get("archived.index.refresh_interval"), is("-200"));
510         assertNull(settings.get("index.refresh_interval"));
511         Settings prevSettings = settings;         settings =
512             IndexScopedSettings.DEFAULT_SCOPED_SETTINGS.archiveUnknownOrInvalidSettings(
513                 prevSettings,
514                 e -&gt; {
515                     assert false : "should not have been invoked, no unknown settings";
516                 },
517                 (e, ex) -&gt; {
518                     assert false : "should not have been invoked, no invalid settings";
519                 });
520         assertSame(prevSettings, settings);
521         settings =
522             IndexScopedSettings.DEFAULT_SCOPED_SETTINGS.archiveUnknownOrInvalidSettings(
523                 Settings.builder()
524                     .put("index.version.created", Version.CURRENT.internalId)                     .put("index.unknown", "foo")
525                     .put("index.refresh_interval", "2s").build(),
526                 e -&gt; {
527                     assertThat(e.getKey(), equalTo("index.unknown"));
528                     assertThat(e.getValue(), equalTo("foo"));
529                 },
530                 (e, ex) -&gt; {
531 <a name="28"></a>                    assert false : "should not have been invoked, no invalid settings";
532                 });
533         assertThat(settings.get("archived.index.unknown"), <font color="#717d7d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>is("foo"));
534         assertThat(settings.get("index.version.created"), is(Integer.toString(Version.CURRENT.internalId)));
535         assertThat(settings.get("index.refresh_interval"), is("2s"));
536 <a name="6"></a>    }</b></font>
537     public void testQueryDefaultField() {
538         IndexSettings index = <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newIndexSettings(
539             newIndexMeta("index", Settings.EMPTY), Settings.EMPTY
540         );
541         assertThat(index.getDefaultFields(), equalTo(Collections.singletonList("*")));
542         index = newIndexSettings(
543             newIndexMeta("index", Settings.EMPTY), Settings.builder().put("index.query.default_field", "body").build()
544 <a name="27"></a>        );
545         assertThat(index.getDefaultFields</b></font>(), equalTo(Collections.singletonList("body")));
546         index.updateIndexMetadata(
547             <font color="#e77471"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newIndexMeta("index", Settings.builder().putList("index.query.default_field", "body", "title").build())
548         );
549         assertThat(index.getDefaultFields(), equalTo(Arrays.asList("body", "title")));
550     }</b></font>
551     @Test
552 <a name="16"></a>    public void testUpdateSoftDeletesFails() {
553         IndexScopedSettings settings = new IndexScopedSettings(Settings.EMPTY,
554                                                                IndexScopedSettings.BUILT_IN_INDEX_SETTINGS);
555         <font color="#2981b2"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>IllegalArgumentException error = expectThrows(IllegalArgumentException.class, () -&gt;
556             settings.updateSettings(Settings.builder().put("index.soft_deletes.enabled", randomBoolean()).build(),
557                                     Settings.builder(), Settings.builder(), "index"));
558         assertThat(error.getMessage</b></font>(), equalTo("final index setting [index.soft_deletes.enabled], not updateable"));
559     }
560 <a name="13"></a>
561     @Test
562     public void testSoftDeletesDefaultSetting() {
563         Version createdVersion = <font color="#3b9c9c"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>VersionUtils.randomVersionBetween(
564             random(),
565             Version.CURRENT.minimumIndexCompatibilityVersion(),
566             Version.CURRENT
567         );
568         Settings settings = Settings.builder()
569             .put(IndexMetadata.SETTING_INDEX_VERSION_CREATED.getKey(), createdVersion)
570             .build();
571         boolean isEnabled = createdVersion.onOrAfter(Version.V_4_3_0);
572         assertThat(IndexSettings.INDEX_SOFT_DELETES_SETTING.get</b></font>(settings), is(isEnabled));
573     }
574     @Test
575     public void testUpdateTranslogRetentionSettingsWithSoftDeletesDisabled() {
576         Settings.Builder settings = Settings.builder()
577             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), false)
578             .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT);
579         TimeValue ageSetting = TimeValue.timeValueHours(12);
580         if (randomBoolean()) {
581             ageSetting = randomBoolean() ? TimeValue.MINUS_ONE : TimeValue.timeValueSeconds(randomIntBetween(0, 60));
582             settings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), ageSetting);
583         }
584         ByteSizeValue sizeSetting = new ByteSizeValue(512, ByteSizeUnit.MB);
585         if (randomBoolean()) {
586             sizeSetting = randomBoolean() ? new ByteSizeValue(-1) : new ByteSizeValue(randomIntBetween(0, 1024));
587             settings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), sizeSetting);
588 <a name="26"></a>        }
589         IndexMetadata metaData = newIndexMeta("index", settings.build());
590         IndexSettings indexSettings = new IndexSettings(metaData, Settings.EMPTY);
591         assertThat(<font color="#68818b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>indexSettings.getTranslogRetentionAge(), equalTo(ageSetting));
592         assertThat(indexSettings.getTranslogRetentionSize(), equalTo(sizeSetting));
593         Settings.Builder newSettings = Settings.builder().put(settings.build</b></font>());
594         if (randomBoolean()) {
595             ageSetting = randomBoolean() ? TimeValue.MINUS_ONE : TimeValue.timeValueSeconds(randomIntBetween(0, 60));
596             newSettings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), ageSetting);
597         }
598         if (randomBoolean()) {
599 <a name="25"></a>            sizeSetting = randomBoolean() ? new ByteSizeValue(-1) : new ByteSizeValue(randomIntBetween(0, 1024));
600             newSettings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), sizeSetting);
601         }
602         indexSettings.updateIndexMetadata(<font color="#5eac10"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newIndexMeta("index", newSettings.build()));
603         assertThat(indexSettings.getTranslogRetentionAge(), equalTo(ageSetting));
604         assertThat(indexSettings.getTranslogRetentionSize(), equalTo(sizeSetting));
605     }</b></font>
606     @Test
607     public void testIgnoreTranslogRetentionSettingsIfSoftDeletesEnabled() {
608         Settings.Builder settings = Settings.builder()
609             .put(IndexMetadata.SETTING_VERSION_CREATED, VersionUtils.randomVersionBetween(random(), Version.V_4_3_0, Version.CURRENT));
610         if (randomBoolean()) {
611             settings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), randomPositiveTimeValue());
612         }
613         if (randomBoolean()) {
614             settings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), between(1, 1024) + "b");
615         }
616         IndexMetadata metaData = newIndexMeta("index", settings.build());
617         IndexSettings indexSettings = new IndexSettings(metaData, Settings.EMPTY);
618         assertThat(indexSettings.getTranslogRetentionAge().millis(), equalTo(-1L));
619         assertThat(indexSettings.getTranslogRetentionSize().getBytes(), equalTo(-1L));
620         Settings.Builder newSettings = Settings.builder().put(settings.build());
621         if (randomBoolean()) {
622             newSettings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), randomPositiveTimeValue());
623         }
624         if (randomBoolean()) {
625 <a name="19"></a>            newSettings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), between(1, 1024) + "b");
626         }
627         indexSettings.updateIndexMetadata(newIndexMeta("index", newSettings.build()));
628         assertThat(<font color="#f62817"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>indexSettings.getTranslogRetentionAge().millis(), equalTo(-1L));
629         assertThat(indexSettings.getTranslogRetentionSize().getBytes(), equalTo(-1L));
630     }
631 }</b></font>
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>PostgresITest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19 <a name="0"></a> * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>package io.crate.integrationtests;
22 import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
23 import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_TABLE;
24 import static io.crate.protocols.postgres.PostgresNetty.PSQL_PORT_SETTING;
25 import static io.crate.testing.Asserts.assertThrowsMatches;
26 import static io.crate.testing.SQLErrorMatcher.isPGError;
27 import static org.hamcrest.Matchers.arrayContaining;
28 import static org.hamcrest.Matchers.containsString;
29 import static org.hamcrest.Matchers.emptyIterable;
30 import static org.hamcrest.Matchers.emptyOrNullString;
31 import static org.hamcrest.Matchers.greaterThan;
32 import static org.hamcrest.Matchers.not;
33 import static org.hamcrest.core.Is.is;
34 import java.sql.Array;
35 import java.sql.BatchUpdateException;
36 import java.sql.Connection;
37 import java.sql.DriverManager;
38 import java.sql.PreparedStatement;
39 import java.sql.ResultSet;
40 import java.sql.ResultSetMetaData;
41 import java.sql.SQLException;
42 import java.sql.Statement;
43 import java.sql.Timestamp;
44 import java.util.ArrayList;
45 import java.util.Collections;
46 import java.util.List;
47 import</b></font> java.util.Locale;
48 import java.util.Map;
49 import java.util.Properties;
50 import java.util.StringJoiner;
51 import java.util.UUID;
52 import org.elasticsearch.Version;
53 import org.elasticsearch.common.settings.Settings;
54 import org.elasticsearch.test.ESIntegTestCase;
55 import org.elasticsearch.test.junit.annotations.TestLogging;
56 import org.hamcrest.Matchers;
57 import org.junit.Before;
58 import org.junit.BeforeClass;
59 import org.junit.Test;
60 import org.junit.jupiter.api.Assertions;
61 import org.postgresql.PGProperty;
62 import org.postgresql.geometric.PGpoint;
63 import org.postgresql.jdbc.PreferQueryMode;
64 import org.postgresql.util.PGobject;
65 import org.postgresql.util.PSQLException;
66 import org.postgresql.util.PSQLState;
67 import io.crate.action.sql.SQLOperations;
68 import io.crate.exceptions.SQLParseException;
69 import io.crate.execution.engine.collect.stats.JobsLogService;
70 import io.crate.execution.engine.collect.stats.JobsLogs;
71 import io.crate.protocols.postgres.PostgresNetty;
72 import io.crate.testing.DataTypeTesting;
73 import io.crate.testing.UseJdbc;
74 import io.crate.types.DataTypes;
75 import static org.junit.jupiter.api.Assertions.assertThrows;
76 @ESIntegTestCase.ClusterScope(numDataNodes = 2, numClientNodes = 0, supportsDedicatedMasters = false)
77 public class PostgresITest extends SQLIntegrationTestCase {
78     private static final String NO_IPV6 = "CRATE_TESTS_NO_IPV6";
79     private static final String RO = "node_s0";
80     private static final String RW = "node_s1";
81     private Properties properties = new Properties();
82     private static boolean useIPv6;
83     @BeforeClass
84     public static void setupClass() {
85         useIPv6 = randomBoolean() &amp;&amp; !"true".equalsIgnoreCase(System.getenv(NO_IPV6));
86     }
87     private String url(String nodeName) {
88         PostgresNetty postgresNetty = internalCluster().getInstance(PostgresNetty.class, nodeName);
89         int port = postgresNetty.boundAddress().publishAddress().getPort();
90         if (useIPv6) {
91             return "jdbc:postgresql://::1:" + port + '/';
92         }
93         return "jdbc:postgresql://127.0.0.1:" + port + '/';
94     }
95     @Override
96     protected Settings nodeSettings(int nodeOrdinal) {
97         Settings.Builder builder = Settings.builder();
98         builder.put(super.nodeSettings(nodeOrdinal));
99         if (useIPv6) {
100             builder.put("network.host", "::1");
101         } else {
102             builder.put("network.host", "127.0.0.1");
103         }
104         if ((nodeOrdinal + 1) % 2 != 0) {
105             builder.put(PSQL_PORT_SETTING.getKey(), "5432-5532");
106             builder.put(SQLOperations.NODE_READ_ONLY_SETTING.getKey(), true);
107         } else {
108             builder.put(PSQL_PORT_SETTING.getKey(), "5533-5633");
109         }
110         return builder.build();
111     }
112     @Before
113     public void initProperties() throws Exception {
114         if (randomBoolean()) {
115             properties.setProperty("prepareThreshold", "-1");
116         }
117         properties.setProperty("user", "crate");
118     }
119     @Test
120     public void testGetTransactionIsolation() throws Exception {
121         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
122             int var = conn.getTransactionIsolation();
123             assertThat(var, is(Connection.TRANSACTION_READ_UNCOMMITTED));
124         }
125     }
126     @Test
127     public void test_simple_mode_can_handle_npgsql_startup_query() throws Exception {
128         String query = """
129             SELECT version();
130             SELECT ns.nspname, t.oid, t.typname, t.typtype, t.typnotnull, t.elemtypoid
131             FROM (
132                 -- Arrays have typtype=b - this subquery identifies them by their typreceive and converts their typtype to a
133                 -- We first do this for the type (innerest-most subquery), and then for its element type
134                 -- This also returns the array element, range subtype and domain base type as elemtypoid
135                 SELECT
136                     typ.oid, typ.typnamespace, typ.typname, typ.typtype, typ.typrelid, typ.typnotnull, typ.relkind,
137                     elemtyp.oid AS elemtypoid, elemtyp.typname AS elemtypname, elemcls.relkind AS elemrelkind,
138                     CASE WHEN elemproc.proname='array_recv' THEN 'a' ELSE elemtyp.typtype END AS elemtyptype
139                 FROM (
140                     SELECT typ.oid, typnamespace, typname, typrelid, typnotnull, relkind, typelem AS elemoid,
141                         CASE WHEN proc.proname='array_recv' THEN 'a' ELSE typ.typtype END AS typtype,
142                         CASE
143                             WHEN proc.proname='array_recv' THEN typ.typelem
144                             WHEN typ.typtype='r' THEN rngsubtype
145                             WHEN typ.typtype='d' THEN typ.typbasetype
146                         END AS elemtypoid
147                     FROM pg_type AS typ
148                     LEFT JOIN pg_class AS cls ON (cls.oid = typ.typrelid)
149                     LEFT JOIN pg_proc AS proc ON proc.oid = typ.typreceive
150                     LEFT JOIN pg_range ON (pg_range.rngtypid = typ.oid)
151                 ) AS typ
152                 LEFT JOIN pg_type AS elemtyp ON elemtyp.oid = elemtypoid
153                 LEFT JOIN pg_class AS elemcls ON (elemcls.oid = elemtyp.typrelid)
154                 LEFT JOIN pg_proc AS elemproc ON elemproc.oid = elemtyp.typreceive
155             ) AS t
156             JOIN pg_namespace AS ns ON (ns.oid = typnamespace)
157             WHERE
158                 typtype IN ('b', 'r', 'm', 'e', 'd') OR -- Base, range, multirange, enum, domain
159                 (typtype = 'c' AND relkind='c') OR -- User-defined free-standing composites (not table composites) by default
160                 (typtype = 'p' AND typname IN ('record', 'void')) OR -- Some special supported pseudo-types
161                 (typtype = 'a' AND (  -- Array of...
162                     elemtyptype IN ('b', 'r', 'm', 'e', 'd') OR -- Array of base, range, multirange, enum, domain
163                     (elemtyptype = 'p' AND elemtypname IN ('record', 'void')) OR -- Arrays of special supported pseudo-types
164                     (elemtyptype = 'c' AND elemrelkind='c') -- Array of user-defined free-standing composites (not table composites) by default
165                 ))
166             ORDER BY CASE
167                    WHEN typtype IN ('b', 'e', 'p') THEN 0           -- First base types, enums, pseudo-types
168                    WHEN typtype = 'r' THEN 1                        -- Ranges after
169                    WHEN typtype = 'm' THEN 2                        -- Multiranges after
170                    WHEN typtype = 'c' THEN 3                        -- Composites after
171                    WHEN typtype = 'd' AND elemtyptype &lt;&gt; 'a' THEN 4 -- Domains over non-arrays after
172                    WHEN typtype = 'a' THEN 5                        -- Arrays after
173                    WHEN typtype = 'd' AND elemtyptype = 'a' THEN 6  -- Domains over arrays last
174             END;
175             -- Load field definitions for (free-standing) composite types
176             SELECT typ.oid, att.attname, att.atttypid
177             FROM pg_type AS typ
178             JOIN pg_namespace AS ns ON (ns.oid = typ.typnamespace)
179             JOIN pg_class AS cls ON (cls.oid = typ.typrelid)
180             JOIN pg_attribute AS att ON (att.attrelid = typ.typrelid)
181             WHERE
182               (typ.typtype = 'c' AND cls.relkind='c') AND
183               attnum &gt; 0 AND     -- Don't load system attributes
184               NOT attisdropped
185             ORDER BY typ.oid, att.attnum;
186             -- Load enum fields
187             SELECT pg_type.oid, enumlabel
188             FROM pg_enum
189             JOIN pg_type ON pg_type.oid=enumtypid
190             ORDER BY oid, enumsortorder;
191         """;
192         Properties properties = new Properties();
193 <a name="5"></a>        properties.setProperty("user", "crate");
194         properties.setProperty(PGProperty.PREFER_QUERY_MODE.getName(), PreferQueryMode.SIMPLE.value());
195         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
196             Statement statement = <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement();
197             statement.execute(query);
198             ResultSet resultSet = statement.getResultSet();
199             assertThat(resultSet.next(), is(true));
200 <a name="30"></a>            assertThat(resultSet.getString(1), Matchers.containsString("CrateDB " + Version.CURRENT.toString()));
201             assertThat(statement.getMoreResults(), is(true));
202         }</b></font>
203     <font color="#ae694a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}
204     @Test
205     public void testMultidimensionalArrayWithDifferentSizedArrays() throws Exception {
206         Properties properties = new Properties();
207         properties.setProperty("user", "crate");
208         properties.setProperty</b></font>(PGProperty.PREFER_QUERY_MODE.getName(), PreferQueryMode.SIMPLE.value());
209         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
210             Statement statement = conn.createStatement();
211 <a name="13"></a>            statement.executeUpdate("create table t (o1 array(object as (o2 array(object as (x int)))))");
212             ensureYellow();
213             <font color="#3b9c9c"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>statement.setEscapeProcessing(false);
214             statement.executeUpdate("insert into t (o1) values ( [ {o2=[{x=1}, {x=2}]}, {o2=[{x=3}]} ] )");
215             statement.executeUpdate("refresh table t");
216             ResultSet resultSet = statement.executeQuery("select o1['o2']['x'] from t");
217             assertThat(resultSet.next(), is(true));
218             String array = resultSet.getString(1);
219             assertThat(array, is</b></font>("[[1,2],[3]]"));
220         }
221         properties = new Properties();
222 <a name="26"></a>        properties.setProperty("user", "crate");
223         properties.setProperty("prepareThreshold", "-1");         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
224             ResultSet resultSet = <font color="#68818b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery("select o1['o2']['x'] from t");
225             assertThat(resultSet.next(), is(true));
226             String array = resultSet.getString(1);
227             assertThat(array, is</b></font>("[[1,2],[3]]"));
228         }
229     }
230 <a name="21"></a>
231     @Test
232     public void testUseOfUnsupportedType() throws Exception {
233         try (Connection conn = DriverManager.getConnection(url(RW), properties)) <font color="#947010"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
234             PreparedStatement stmt = conn.prepareStatement("select ? from sys.cluster");
235             stmt.setObject(1, UUID.randomUUID());
236             assertThrowsMatches(() -&gt; stmt.executeQuery(), isPGError(is("Can't map PGType with oid=2950 to Crate type"), INTERNAL_ERROR));
237         }</b></font>
238     }
239     @Test
240     public void testEmptyStatement() throws Exception {
241         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
242 <a name="10"></a>            assertThat(conn.createStatement().execute(""), is(false));
243             try {
244                 <font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery("");
245                 fail("executeQuery with empty query should throw a 'No results were returned by the query' error");
246             } catch (PSQLException e) {
247                 assertThat(e.getSQLState(), is(PSQLState.NO_DATA.getState()));
248             }</b></font>
249         }
250     }
251     @Test
252     public void testSimpleQuery() throws Exception {
253         properties.setProperty(PGProperty.PREFER_QUERY_MODE.getName(), PreferQueryMode.SIMPLE.value());
254         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
255 <a name="4"></a>            conn.setAutoCommit(true);
256             conn.createStatement().executeUpdate("create table t (x int) with (number_of_replicas = 0)");
257             conn.createStatement().executeUpdate("insert into t (x) values (1), (2)");
258             <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeUpdate("refresh table t");
259             ResultSet resultSet = conn.createStatement().executeQuery("select * from t order by x");
260             assertThat(resultSet.next(), is(true));
261             assertThat(resultSet.getInt(1), is(1));
262             assertThat(resultSet.next(), is(true));
263             assertThat(resultSet.getInt(1), is</b></font>(2));
264         }
265     }
266     @Test
267     public void testPreparedStatementHandling() throws Exception {
268 <a name="23"></a>        Properties properties = new Properties();
269         properties.setProperty("user", "crate");
270         properties.setProperty("prepareThreshold", "-1");
271         try (Connection conn = DriverManager.getConnection(url(RW), properties)) <font color="#f660ab"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
272             PreparedStatement p1 = conn.prepareStatement("select 1 from sys.cluster");
273             ResultSet resultSet = p1.executeQuery();
274             assertThat(resultSet.next(), is(true));
275             assertThat(resultSet.getInt</b></font>(1), is(1));
276 <a name="6"></a>
277             PreparedStatement p2 = conn.prepareStatement("select 2 from sys.cluster");
278             resultSet = p2.executeQuery();
279             <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertThat(resultSet.next(), is(true));
280             assertThat(resultSet.getInt(1), is(2));
281             resultSet = p1.executeQuery();
282             assertThat(resultSet.next(), is(true));
283             assertThat(resultSet.getInt(1), is</b></font>(1));
284         }
285     }
286     @Test
287     public void testPreparedSelectStatementWithParametersCanBeDescribed() throws Exception {
288         Properties properties = new Properties();
289 <a name="22"></a>        properties.setProperty("user", "crate");
290         properties.setProperty("prepareThreshold", "-1");
291         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
292             PreparedStatement p1 = <font color="#4cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.prepareStatement("select ? from sys.cluster");
293             p1.setInt(1, 20);
294             ResultSet resultSet = p1.executeQuery();
295             /*
296              * This execute results in the following messages:
297              *
298              *      method=parse stmtName=S_1 query=select $1 from sys.cluster paramTypes=[integer]
299              *      method=describe type=S portalOrStatement=S_1
300              *      method=sync
301              *      method=bind portalName= statementName=S_1 params=[20]
302              *      method=describe type=P portalOrStatement=
303              *      method=execute portalName= maxRows=0
304              *      method=sync
305              *
306              * The tests makes sure that it works even though the describe can't analyze the statement (because of missing params)
307              */
308             assertThat(resultSet.next(), is(true));
309             assertThat(resultSet.getInt(1), is</b></font>(20));
310         }
311     }
312     @Test
313     public void testWriteOperationsWithoutAutocommitAndCommitAndRollback() throws Exception {
314         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
315             conn.setAutoCommit(false);
316             try (Statement statement = conn.createStatement()) {
317                 statement.executeUpdate("create table t (x int) with (number_of_replicas = 0)");
318             }
319             try (PreparedStatement stmt = conn.prepareStatement("insert into t (x) values (1), (2)")) {
320                 stmt.executeUpdate();
321             }
322             try (Statement statement = conn.createStatement()) {
323                 statement.executeUpdate("refresh table t");
324             }
325 <a name="20"></a>
326             conn.commit();
327             try (Statement statement = conn.createStatement()) <font color="#4e9258"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
328                 ResultSet resultSet = statement.executeQuery("select * from t");
329                 assertThat(resultSet.next(), is(true));
330                 assertThat(resultSet.next(), is(true));
331             }</b></font>
332         }
333     }
334     @Test
335 <a name="31"></a>    public void testNoAutoCommit() throws Exception {
336         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
337             conn.setAutoCommit(false);
338             ResultSet resultSet = <font color="#3ea99f"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.prepareStatement("select name from sys.cluster").executeQuery();
339             assertThat(resultSet.next(), is(true));
340             assertThat(resultSet.getString(1), Matchers.startsWith("SUITE-TEST_WORKER"));
341         }</b></font>
342     }
343     @Test
344     public void test_char_types_arrays() throws Exception {
345         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
346             conn.createStatement().executeUpdate(
347                 "CREATE TABLE t (" +
348                 "   chars array(byte)," +
349                 "   strings array(text)) " +
350                 "WITH (number_of_replicas = 0)");
351             PreparedStatement preparedStatement = conn.prepareStatement(
352                 "INSERT INTO t (chars, strings) VALUES (?, ?)");
353             preparedStatement.setArray(1, conn.createArrayOf("char", new Byte[]{'c', '3'}));
354             preparedStatement.setArray(2, conn.createArrayOf("varchar", new String[]{"fo,o", "bar"}));
355 <a name="33"></a>            preparedStatement.executeUpdate();
356             conn.createStatement().execute("REFRESH TABLE t");
357             ResultSet resultSet = <font color="#736aff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery("SELECT chars, strings FROM t");
358             assertThat(resultSet.next(), is(true));
359             assertThat(resultSet.getArray(1).getArray(), is</b></font>(new String[]{"99", "51"}));
360             assertThat(resultSet.getArray(2).getArray(), is(new String[]{"fo,o", "bar"}));
361         } catch (BatchUpdateException e) {
362             throw e.getNextException();
363         }
364     }
365     @Test
366     public void test_numeric_types_arrays() throws Exception {
367         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
368             conn.createStatement().executeUpdate(
369                 "CREATE TABLE t (" +
370                 "   ints array(int)," +
371                 "   floats array(float)" +
372                 ") " +
373                 "WITH (number_of_replicas = 0)");
374             PreparedStatement preparedStatement = conn.prepareStatement(
375                 "INSERT INTO t (ints, floats) VALUES (?, ?)");
376             preparedStatement.setArray(1, conn.createArrayOf("int4", new Integer[]{10, 20}));
377             preparedStatement.setArray(2, conn.createArrayOf("float4", new Float[]{1.2f, 3.5f}));
378 <a name="32"></a>            preparedStatement.executeUpdate();
379             conn.createStatement().execute("REFRESH TABLE t");
380             ResultSet rs = <font color="#5b8daf"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery("SELECT ints, floats FROM t");
381             assertThat(rs.next(), is(true));
382             assertThat(rs.getArray(1).getArray(), is</b></font>(new Integer[]{10, 20}));
383             assertThat(rs.getArray(2).getArray(), is(new Float[]{1.2f, 3.5f}));
384         } catch (BatchUpdateException e) {
385             throw e.getNextException();
386         }
387     }
388     @Test
389     public void test_geo_types_arrays() throws Exception {
390         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
391             conn.createStatement().execute(
392                 "CREATE TABLE t (" +
393                 "   geo_points array(geo_point)," +
394                 "   geo_shapes array(geo_shape)" +
395                 ") " +
396                 "WITH (number_of_replicas = 0)");
397             PreparedStatement preparedStatement = conn.prepareStatement(
398                 "INSERT INTO t (geo_points, geo_shapes) VALUES (?, ?)");
399             preparedStatement.setArray(1, conn.createArrayOf(
400                 "point",
401                 new PGpoint[]{new PGpoint(1.1, 2.2), new PGpoint(3.3, 4.4)}));
402             preparedStatement.setArray(2, conn.createArrayOf(
403                 "json",
404                 new Object[]{
405                     DataTypes.STRING.implicitCast(
406                         Map.of(
407                             "coordinates", new double[][]{{0, 0}, {1, 1}},
408                             "type", "LineString"
409 <a name="8"></a>                        )
410                     )
411                 }));
412             <font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>preparedStatement.executeUpdate();
413             conn.createStatement().execute("REFRESH TABLE t");
414             ResultSet rs = conn.createStatement().executeQuery("SELECT geo_points, geo_shapes FROM t");
415             assertThat(rs.next(), is(true));
416             assertThat(
417                 (Object[]) rs.getArray(1).getArray(),
418                 arrayContaining(new</b></font> PGpoint(1.1, 2.2), new PGpoint(3.3, 4.4)));
419             var shapeObject = new PGobject();
420             shapeObject.setType("json");
421             String shape = "{\"coordinates\":[[0.0,0.0],[1.0,1.0]],\"type\":\"LineString\"}";
422             shapeObject.setValue(shape);
423             assertThat((Object[]) rs.getArray(2).getArray(), arrayContaining(shape));
424         } catch (BatchUpdateException e) {
425             throw e.getNextException();
426         }
427     }
428     @Test
429     public void testFetchSize() throws Exception {
430         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
431             conn.createStatement().executeUpdate("create table t (x int) with (number_of_replicas = 0)");
432             ensureGreen();
433             PreparedStatement preparedStatement = conn.prepareStatement("insert into t (x) values (?)");
434             for (int i = 0; i &lt; 20; i++) {
435                 preparedStatement.setInt(1, i);
436                 preparedStatement.addBatch();
437             }
438             preparedStatement.executeBatch();
439             conn.createStatement().executeUpdate("refresh table t");
440             conn.setAutoCommit(false);
441             try (Statement st = conn.createStatement()) {
442                 st.setFetchSize(2);
443                 try (ResultSet resultSet = st.executeQuery("select x from t")) {
444                     List&lt;Integer&gt; result = new ArrayList&lt;&gt;();
445                     while (resultSet.next()) {
446                         result.add(resultSet.getInt(1));
447                     }
448                     Collections.sort(result);
449                     assertThat(result, Matchers.contains(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19));
450                 }
451             }
452         }
453     }
454     @Test
455     public void test_query_inbetween_suspended_fetch_operation() throws Exception {
456         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
457             conn.createStatement().executeUpdate("create table t (x int) with (number_of_replicas = 0)");
458             PreparedStatement preparedStatement = conn.prepareStatement("insert into t (x) values (?)");
459             for (int i = 0; i &lt; 6; i++) {
460                 preparedStatement.setInt(1, i);
461                 preparedStatement.addBatch();
462             }
463             preparedStatement.executeBatch();
464             conn.createStatement().executeUpdate("refresh table t");
465             conn.setAutoCommit(false);
466             try (Statement st = conn.createStatement()) {
467                 st.setFetchSize(2);
468                 try (ResultSet xResults = st.executeQuery("select x from t")) {
469 <a name="29"></a>                    List&lt;Integer&gt; result = new ArrayList&lt;&gt;();
470                     while (xResults.next()) {
471                         if (result.size() == 3) {
472                             var select30Result = <font color="#af7a82"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery("select 30");
473                             assertThat(select30Result.next(), is(true));
474                             assertThat(select30Result.getInt(1), is(30));
475                         }</b></font>
476                         result.add(xResults.getInt(1));
477                     }
478                     Collections.sort(result);
479                     assertThat(result, Matchers.contains(0, 1, 2, 3, 4, 5));
480                 }
481             }
482         }
483     }
484     @Test
485     public void testCloseConnectionWithUnfinishedResultSetDoesNotLeaveAnyPendingOperations() throws Exception {
486         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
487             conn.setAutoCommit(false);
488             try (Statement statement = conn.createStatement()) {
489                 statement.setFetchSize(2);
490                 try (ResultSet resultSet = statement.executeQuery("select mountain from sys.summits")) {
491                     resultSet.next();
492                     resultSet.next();
493                 }
494             }
495         }
496         assertBusy(() -&gt; {
497             try {
498                 try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
499                     String q =
500                         "SELECT j.stmt || '-' || o.name FROM sys.operations AS o, sys.jobs AS j WHERE o.job_id = j.id" +
501                         " and j.stmt = ?";
502                     PreparedStatement statement = conn.prepareStatement(q);
503                     statement.setString(1, "select mountain from sys.summits");
504                     ResultSet rs = statement.executeQuery();
505                     List&lt;String&gt; operations = new ArrayList&lt;&gt;();
506                     while (rs.next()) {
507                         operations.add(rs.getString(1));
508                     }
509                     assertThat(operations, Matchers.empty());
510                 }
511             } catch (SQLException e) {
512                 throw new RuntimeException(e);
513             }
514         });
515     }
516     @Test
517     public void testCreateNewStatementAfterUnfinishedResultSet() throws Exception {
518         try (Connection conn = DriverManager.getConnection(url(RW), properties);
519             Statement statement = conn.createStatement()) {
520             conn.setAutoCommit(false);
521             statement.setFetchSize(2);
522             try (ResultSet resultSet = statement.executeQuery("select mountain from sys.summits")) {
523                 resultSet.next();
524                 resultSet.next();
525             }
526             conn.setAutoCommit(true);
527             statement.setFetchSize(0);
528             try (ResultSet resultSet = statement.executeQuery("select mountain from sys.summits")) {
529                 while (resultSet.next()) {
530                     assertFalse(resultSet.getString(1).isEmpty());
531                 }
532             }
533         }
534     }
535     @Test
536     public void testSelectPreparedStatement() throws Exception {
537         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
538             conn.setAutoCommit(true);
539             PreparedStatement preparedStatement = conn.prepareStatement("select name from sys.cluster");
540             ResultSet resultSet = preparedStatement.executeQuery();
541             assertThat(resultSet.next(), is(true));
542             assertThat(resultSet.getString(1), Matchers.startsWith("SUITE-TEST_WORKER"));
543         }
544     }
545 <a name="7"></a>    @Test
546     public void testExecuteBatch() throws Exception {
547         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
548             <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.setAutoCommit(true);
549             Statement stmt = conn.createStatement();
550             stmt.executeUpdate("create table t (x string, b boolean) with (number_of_replicas = 0)");
551             ensureYellow();
552             PreparedStatement preparedStatement = conn.prepareStatement("insert into t (x, b) values (?, ?)");
553             preparedStatement.setString(1, "Arthur");
554             preparedStatement.setBoolean(2, true);
555             preparedStatement.addBatch();
556             preparedStatement.setString(1, "Trillian");
557             preparedStatement.setBoolean(2, false);
558             preparedStatement.addBatch();
559             int[] results = preparedStatement.executeBatch()</b></font>;
560             assertThat(results, is(new int[]{1, 1}));
561         }
562     }
563     @Test
564 <a name="9"></a>    public void testExecuteBatchWithOneFailingAndNothingExecuted() throws Exception {
565         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
566             Statement stmt = conn.createStatement();
567             <font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>stmt.executeUpdate("create table t (x int) with (number_of_replicas = 0)");
568             PreparedStatement preparedStatement = conn.prepareStatement("insert into t (x) values (cast(? as integer))");
569             preparedStatement.setString(1, Integer.toString(1));
570             preparedStatement.addBatch();
571             preparedStatement.setString(1, "foobar");
572             preparedStatement.addBatch();
573             preparedStatement.setString(1, Integer.toString(3));
574             preparedStatement.addBatch();
575 <a name="28"></a>            assertThat(preparedStatement.executeBatch(), is</b></font>(new int[]{0, 0, 0}));
576             conn.createStatement().executeUpdate("refresh table t");
577             ResultSet rs = <font color="#717d7d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery("select count(*) from t");
578             assertThat(rs.next(), is(true));
579             assertThat(rs.getInt(1), is(0));
580         }</b></font>
581     }
582     @Test
583     public void testExecuteBatchWithOneRuntimeFailure() throws Exception {
584         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
585 <a name="16"></a>            Statement stmt = conn.createStatement();
586             stmt.executeUpdate("create table t (id int primary key, x int) with (number_of_replicas = 0)");
587             ensureYellow();
588             <font color="#2981b2"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>PreparedStatement preparedStatement = conn.prepareStatement("insert into t (id, x) values (?, ?)");
589             preparedStatement.setInt(1, 1);
590             preparedStatement.setInt(2, 0);
591             preparedStatement.addBatch();
592             preparedStatement.setInt(1, 2);
593             preparedStatement.setInt(2, 10);
594             preparedStatement.addBatch();
595             assertThat(preparedStatement.executeBatch(), is</b></font>(new int[]{1, 1}));
596             conn.createStatement().executeUpdate("refresh table t");
597             preparedStatement = conn.prepareStatement("update t set x = log(x) where id = ?");
598             preparedStatement.setInt(1, 1);
599             preparedStatement.addBatch();
600 <a name="3"></a>            preparedStatement.setInt(1, 2);
601             preparedStatement.addBatch();
602             assertThat(preparedStatement.executeBatch(), is(new int[]{0, 1}));
603             <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeUpdate("refresh table t");
604             ResultSet rs = conn.createStatement().executeQuery("select x from t order by id");
605             assertThat(rs.next(), is(true));
606             assertThat(rs.getInt(1), is(0)); 
607             assertThat(rs.next(), is(true));
608             assertThat(rs.getInt</b></font>(1), is(1));         }
609     }
610     @Test
611     public void testExecuteBatchWithDifferentStatements() throws Exception {
612         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
613             conn.setAutoCommit(true);
614             Statement stmt = conn.createStatement();
615             stmt.executeUpdate("create table t (x int) with (number_of_replicas = 0)");
616             ensureYellow();
617             Statement statement = conn.createStatement();
618             statement.addBatch("insert into t (x) values (1)");
619             statement.addBatch("insert into t (x) values (2), (3)");
620             int[] results = statement.executeBatch();
621 <a name="15"></a>            assertThat(results, is(new int[]{1, 2}));
622             statement.executeUpdate("refresh table t");
623             ResultSet resultSet = <font color="#f52887"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>statement.executeQuery("select * from t order by x");
624             assertThat(resultSet.next(), is(true));
625             assertThat(resultSet.getInt(1), is(1));
626             statement.addBatch("insert into t (x) values (3)");
627             results = statement.executeBatch();
628             assertThat(results, is</b></font>(new int[]{1}));
629             statement.executeUpdate("refresh table t");
630             resultSet = statement.executeQuery("select * from t order by x desc");
631             assertThat(resultSet.next(), is(true));
632             assertThat(resultSet.getInt(1), is(3));
633         }
634     }
635 <a name="17"></a>    @Test
636     public void test_execute_batch_fails_with_read_operations() throws Exception {
637         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
638             <font color="#3090c7"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.setAutoCommit(true);
639             Statement stmt = conn.createStatement();
640             stmt.executeUpdate("create table t (x int) with (number_of_replicas = 0)");
641             Statement statement = conn.createStatement();
642             statement.addBatch("insert into t(x) values(1), (2)");
643             statement.addBatch("refresh table t");
644             statement.addBatch("select count(*) from t");
645             Assertions.assertThrows(BatchUpdateException.class,
646                                     () -&gt; statement.executeBatch</b></font>(),
647                                     "Only write operations are allowed in Batch statements"
648             );
649         }
650     }
651 <a name="1"></a>    @Test
652     public void testCreateInsertSelectStringAndTimestamp() throws Exception {
653         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
654             <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.setAutoCommit(true);
655             Statement statement = conn.createStatement();
656             assertThat(statement.executeUpdate(
657                 "create table t (" +
658                 "   x string," +
659                 "   ts timestamp with time zone" +
660                 ") with (number_of_replicas = 0)"), is(1));
661             ensureYellow();
662             assertThat(statement.executeUpdate("insert into t (x, ts) values ('Marvin', '2016-05-14'), ('Trillian', '2016-06-28')"), is(2));
663             assertThat(statement.executeUpdate("refresh table t"), is(1));
664             statement.executeQuery("select x, ts from t order by x");
665 <a name="24"></a>            ResultSet resultSet = statement.getResultSet();
666             assertThat(resultSet.next(), is(true));
667             assertThat(resultSet.getString(1), is("Marvin"));
668             assertThat(resultSet.getTimestamp(2), is</b></font>(<font color="#79764d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>new Timestamp(1463184000000L)));
669             assertThat(resultSet.next(), is(true));
670             assertThat(resultSet.getString(1), is("Trillian"));
671             assertThat(resultSet.getTimestamp(2), is</b></font>(new Timestamp(1467072000000L)));
672         }
673     }
674     @Test
675     public void testSelectWithParameters() throws Exception {
676         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
677             conn.setAutoCommit(true);
678             PreparedStatement preparedStatement = conn.prepareStatement("select name from sys.cluster where name like ?");
679             preparedStatement.setString(1, "SUITE%");
680             ResultSet resultSet = preparedStatement.executeQuery();
681             assertThat(resultSet.next(), is(true));
682             assertThat(resultSet.getString(1), Matchers.startsWith("SUITE-TEST_WORKER"));
683         }
684     }
685     @Test
686     public void testStatementThatResultsInParseError() throws Exception {
687         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
688             conn.setAutoCommit(true);
689             PreparedStatement stmt = conn.prepareStatement("select name fro sys.cluster");
690             assertThrowsMatches(() -&gt; stmt.executeQuery(),
691                          isPGError(containsString("mismatched input 'sys'"), INTERNAL_ERROR));
692         }
693     }
694     @Test
695     public void testStatementReadOnlyFailure() throws Exception {
696         try (Connection conn = DriverManager.getConnection(url(RO), properties)) {
697             conn.setAutoCommit(true);
698             PreparedStatement stmt = conn.prepareStatement("create table test(a integer)");
699             assertThrowsMatches(() -&gt; stmt.executeQuery(),
700                          isPGError(containsString("Only read operations allowed on this node"), INTERNAL_ERROR));
701         }
702     }
703     @Test
704     public void testErrorRecoveryFromErrorsOutsideSqlOperations() throws Exception {
705         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
706             conn.setAutoCommit(true);
707 <a name="14"></a>            PreparedStatement stmt = conn.prepareStatement("select cast([10.3, 20.2] as integer) " +
708                                                            "from information_schema.tables");
709             try {
710                 <font color="#842dce"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>stmt.executeQuery();
711                 fail("Should've raised PSQLException");
712             } catch (PSQLException e) {
713                 assertThat(e.getMessage(), containsString("Cannot cast expressions from type `double precision_array` to type `integer`"));
714             }
715             assertSelectNameFromSysClusterWorks</b></font>(conn);
716         }
717     }
718     @Test
719     public void testErrorDetailsFromStackTraceInErrorResponse() throws Exception {
720         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
721 <a name="2"></a>            conn.setAutoCommit(true);
722             conn.createStatement().executeUpdate("select sqrt('abcd') from sys.cluster");
723         } catch (PSQLException e) {
724             <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertThat(e.getServerErrorMessage().getFile(), not(is(emptyOrNullString())));
725             assertThat(e.getServerErrorMessage().getRoutine(), not(is(emptyOrNullString())));
726             assertThat(e.getServerErrorMessage().getLine(), greaterThan(0));
727         }</b></font>
728     }
729     @Test
730     public void testGetPostgresPort() throws Exception {
731         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
732             ResultSet resultSet = conn.createStatement().executeQuery("select port['psql'] from sys.nodes limit 1");
733             assertThat(resultSet.next(), is(true));
734             Integer port = resultSet.getInt(1);
735             ArrayList&lt;Integer&gt; actualPorts = new ArrayList&lt;&gt;();
736             for (PostgresNetty postgresNetty : internalCluster().getInstances(PostgresNetty.class)) {
737                 actualPorts.add(postgresNetty.boundAddress().publishAddress().getPort());
738             }
739             assertThat(port, Matchers.isOneOf(actualPorts.toArray(new Integer[0])));
740         }
741     }
742 <a name="12"></a>    @Test
743     public void testSetSchemaOnSession() throws Exception {
744         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
745             <font color="#571b7e"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.setAutoCommit(true);
746             conn.createStatement().execute("set session search_path to bar");
747             conn.createStatement().executeUpdate("create table foo (id int) with (number_of_replicas=0)");
748             conn.createStatement().execute("set session search_path to DEFAULT");
749             assertThrowsMatches(() -&gt; conn.createStatement().execute("select * from foo"),
750                          isPGError(is("Relation 'foo' unknown"), UNDEFINED_TABLE));
751         }</b></font>
752     }
753 <a name="11"></a>    @Test
754     public void testSetMultipleSchemasOnSession() throws Exception {
755         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
756             <font color="#b041ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.setAutoCommit(true);
757             conn.createStatement().execute("set session search_path to bar ,custom");
758             conn.createStatement().executeUpdate("create table foo (id int) with (number_of_replicas=0)");
759             conn.createStatement().executeQuery("select * from bar.foo");
760             assertThrowsMatches(() -&gt; conn.createStatement().execute("select * from custom.foo"),
761                          isPGError(is("Schema 'custom' unknown"), INTERNAL_ERROR));
762         }</b></font>
763     }
764     @Test
765     public void testCountDistinctFromJoin() throws Exception {
766 <a name="27"></a>                try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
767             ResultSet resultSet = <font color="#e77471"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery(
768                 "select count (distinct 74) from unnest([1, 2]) t1 cross join unnest([2, 3]) t2");
769             assertThat(resultSet.next(), is(true));
770             assertThat(resultSet.getLong(1), is(1L));
771         }</b></font>
772     }
773     @Test
774     public void testMultiStatementQuery() throws Exception {
775         Properties properties = new Properties(this.properties);
776         properties.setProperty("preferQueryMode", "simple");
777         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
778             Statement statement = conn.createStatement();
779             statement.execute("set search_path to 'hoschi';" +
780                               "create table t (id int);" +
781 <a name="25"></a>                              "insert into t values (42);" +
782                               "refresh table t");
783             statement = conn.createStatement();
784             ResultSet resultSet = <font color="#5eac10"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>statement.executeQuery("select * from hoschi.t");
785             resultSet.next();
786             assertThat(resultSet.getInt(1), is(42));
787             assertThat(resultSet.isLast(), is(true));
788         }</b></font>
789     }
790     @Test
791     public void testRepeatedFetchDoesNotLeakSysJobsLog() throws Exception {
792         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
793             conn.prepareStatement(
794                 "create table t (" +
795                 "   x int, ts timestamp with time zone" +
796                 ") clustered into 1 shards " +
797                 "with (number_of_replicas = 0)").execute();
798             PreparedStatement preparedStatement = conn.prepareStatement("insert into t (x, ts) values (?, ?)");
799             for (int i = 0; i &lt; 20; i++) {
800                 preparedStatement.setInt(1, i);
801                 preparedStatement.setLong(2, 1541548800000L);
802                 preparedStatement.addBatch();
803             }
804             preparedStatement.executeBatch();
805             conn.prepareStatement("refresh table t").execute();
806             conn.setAutoCommit(false);
807             PreparedStatement stmt = conn.prepareStatement("SELECT x FROM t WHERE ts &gt; ? ORDER BY ts ASC LIMIT 5");
808             for (int i = 0; i &lt; 5; i++) {
809                 stmt.setInt(1, i);
810                 stmt.setFetchSize(5);
811                 ResultSet resultSet = stmt.executeQuery();
812                 while (resultSet.next()) {
813                     resultSet.getInt(1);
814                 }
815             }
816         }
817         for (JobsLogService jobsLogService : internalCluster().getDataNodeInstances(JobsLogService.class)) {
818             assertBusy(() -&gt; assertThat(jobsLogService.get().activeJobs(), emptyIterable()));
819         }
820     }
821     @Test
822 <a name="18"></a>    public void test_insert_with_on_conflict_do_nothing_batch_error_resp_is_0_for_conflicting_items() throws Exception {
823         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
824             conn.prepareStatement("create table t (id int primary key) clustered into 1 shards").execute();
825             <font color="#800517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.prepareStatement("insert into t (id) (select col1 from generate_series(1, 3))").execute();
826             PreparedStatement stmt = conn.prepareStatement("insert into t (id) values (?) on conflict (id) do nothing");
827             stmt.setInt(1, 4);
828             stmt.addBatch();
829             stmt.setInt(1, 1);
830             stmt.addBatch();
831             int[] result = stmt.executeBatch();
832             assertThat(result.length, is</b></font>(2));
833             assertThat(result[0], is(1));
834             assertThat(result[1], is(0));
835         }
836     }
837     @Test
838     public void test_all_system_columns_can_be_queried_via_postgres() throws Exception {
839         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
840             conn.prepareStatement("create table tbl (x int)").execute();
841             ResultSet result = conn.prepareStatement(
842                 "SELECT " +
843                 "   table_schema, " +
844                 "   table_name," +
845                 "   collect_set(column_name) as columns " +
846                 "FROM " +
847                 "   information_schema.columns " +
848                 "WHERE " +
849                 "   table_schema IN ('sys', 'pg_catalog', 'information_schema') " +
850                 "GROUP BY " +
851                 "   1, 2").executeQuery();
852             while (result.next()) {
853                 String schema = result.getString(1);
854                 String table = result.getString(2);
855                 Array columns = result.getArray(3);
856                 StringJoiner columnList = new StringJoiner(", ");
857                 for (String column : ((String[]) columns.getArray())) {
858                     if (column.contains("[")) {
859                         columnList.add(column);
860                     } else {
861                         columnList.add('"' + column + '"');
862                     }
863                 }
864                 String statement = String.format(
865                     Locale.ENGLISH,
866                     "SELECT %s FROM \"%s\".\"%s\"",
867                     columnList.toString(),
868                     schema,
869                     table
870                 );
871                 conn.prepareStatement(statement).executeQuery();
872             }
873         }
874     }
875     @Test
876     @UseJdbc(0)     public void test_proper_termination_of_deallocate_through_http_call() throws Exception {
877        execute("DEALLOCATE ALL");
878        assertThat(response.rowCount(), is (0L));
879     }
880     @Test
881     public void test_getProcedureColumns() throws Exception {
882         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
883             var results = conn.getMetaData().getProcedureColumns("", "", "", "");
884             assertThat(results.next(), is(true));
885             assertThat(results.getString(3), is("_pg_expandarray"));
886         }
887     }
888     @Test
889     public void test_each_non_array_pg_type_entry_can_be_joined_with_pg_proc() throws Exception {
890         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
891             PreparedStatement stmt = conn.prepareStatement(
892                 "SELECT pg_type.oid, pg_type.typname, pg_proc.proname " +
893                 "FROM pg_catalog.pg_type LEFT OUTER JOIN pg_catalog.pg_proc ON pg_proc.oid = pg_type.typreceive " +
894                 "WHERE pg_type.typarray &lt;&gt; 0");
895             ResultSet result = stmt.executeQuery();
896             while (result.next()) {
897                 assertThat(
898                     "There must be an entry for `" + result.getInt(1) + "/" + result.getString(2) + "` in pg_proc",
899                     result.getString(3),
900                     Matchers.notNullValue(String.class)
901                 );
902             }
903         }
904     }
905     @Test
906     public void test_parse_failures_in_simple_protocol_mode_are_propagated_to_client() throws Exception {
907         Properties properties = new Properties();
908         properties.setProperty("user", "crate");
909         properties.setProperty(PGProperty.PREFER_QUERY_MODE.getName(), PreferQueryMode.SIMPLE.value());
910         try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
911             Statement statement = conn.createStatement();
912             assertThrows(PSQLException.class, () -&gt; statement.execute("create index invalid_statement"));
913             ResultSet result = statement.executeQuery("select 1");
914             assertThat(result.next(), is(true));
915             assertThat(result.getInt(1), is(1));
916         }
917     }
918     @Test
919     public void test_insert_from_unnest_returning_which_inserts_duplicate_keys() throws Exception {
920         Properties properties = new Properties();
921         properties.setProperty("user", "crate");
922         try (var conn = DriverManager.getConnection(url(RW), properties)) {
923             var statement = conn.createStatement();
924             statement.execute("create table tbl (id bigint primary key, val text)");
925             var textGenerator = DataTypeTesting.getDataGenerator(DataTypes.STRING);
926             var insertUnnest = conn.prepareStatement(
927                 "insert into tbl (id, val) (select id, val from unnest(?, ?) as t (id, val)) returning _id");
928             for (int iteration = 0; iteration &lt; 2; iteration++) {
929                 var ids = new Object[10];
930                 var values = new Object[10];
931                 for (int i = 0; i &lt; 10; i++) {
932                     ids[i] = i;
933                     values[i] = textGenerator.get();
934                 }
935                 insertUnnest.setObject(1, conn.createArrayOf("bigint", ids));
936                 insertUnnest.setObject(2, conn.createArrayOf("text", values));
937                 var result = insertUnnest.executeQuery();
938                 int numResults = 0;
939                 while (result.next()) {
940                     numResults++;
941                 }
942                 if (iteration == 0) {
943                     assertThat(numResults, is(10));
944                 } else {
945                     assertThat(numResults, is(0));
946                 }
947             }
948         }
949     }
950     @Test
951     public void test_metadata_calls_do_not_query_pg_catalog_tables_repeatedly() throws Exception {
952         var properties = new Properties();
953         properties.put("user", "crate");
954         properties.put("password", "");
955         try (var conn = DriverManager.getConnection(url(RW), properties)) {
956             var stmt = conn.createStatement();
957             stmt.execute("create table uservisits (\"adRevenue\" float, \"cCode\" text, \"duration\" float)");
958             conn.setAutoCommit(false);
959             stmt = conn.createStatement();
960             stmt.setFetchSize(101);
961             ResultSet result = stmt.executeQuery(
962                     "select avg(\"adRevenue\") from uservisits group by \"cCode\", \"duration\" limit 100");
963             long numQueries = getNumQueriesFromJobsLogs();
964             ResultSetMetaData metaData = result.getMetaData();
965             for (int i = 0; i &lt; 50; i++) {
966                 metaData.isAutoIncrement(1);
967             }
968             assertThat(getNumQueriesFromJobsLogs(), is(numQueries));
969             result.close();
970         }
971     }
972     private long getNumQueriesFromJobsLogs() {
973         long result = 0;
974         Iterable&lt;JobsLogs&gt; jobLogs = internalCluster().getInstances(JobsLogs.class);
975         for (JobsLogs jobsLogs : jobLogs) {
976             for (var metrics : jobsLogs.metrics()) {
977                 result += metrics.totalCount();
978             }
979         }
980         return result;
981     }
982 <a name="19"></a>    private void assertSelectNameFromSysClusterWorks(Connection conn) throws SQLException {
983         PreparedStatement stmt;        stmt = conn.prepareStatement("select name from sys.cluster");
984         ResultSet resultSet = <font color="#f62817"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>stmt.executeQuery();
985         assertThat(resultSet.next(), is(true));
986         assertThat(resultSet.getString(1), Matchers.startsWith("SUITE-TEST_WORKER"));
987     }
988 }</b></font>
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
