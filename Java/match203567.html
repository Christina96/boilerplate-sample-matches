<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html><head><title>Matches for IndexSettingsTests.java &amp; PostgresITest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for IndexSettingsTests.java &amp; PostgresITest.java
      </h3>
<h1 align="center">
        30.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>IndexSettingsTests.java (41.641937%)<th>PostgresITest.java (24.293133%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(22-52)<td><a href="#" name="0">(22-50)</a><td align="center"><font color="#ff0000">27</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(159-178)<td><a href="#" name="1">(743-759)</a><td align="center"><font color="#ec0000">25</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(78-89)<td><a href="#" name="2">(822-825)</a><td align="center"><font color="#a00000">17</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(434-442)<td><a href="#" name="3">(677-684)</a><td align="center"><font color="#970000">16</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(280-292)<td><a href="#" name="4">(288-294)</a><td align="center"><font color="#970000">16</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(460-465)<td><a href="#" name="5">(217-223)</a><td align="center"><font color="#8d0000">15</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(588-595)<td><a href="#" name="6">(311-316)</a><td align="center"><font color="#840000">14</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(423-432)<td><a href="#" name="7">(608-623)</a><td align="center"><font color="#840000">14</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(351-363)<td><a href="#" name="8">(458-465)</a><td align="center"><font color="#840000">14</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(69-77)<td><a href="#" name="9">(632-643)</a><td align="center"><font color="#840000">14</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(205-214)<td><a href="#" name="10">(272-277)</a><td align="center"><font color="#7a0000">13</font>
<tr onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b041ff"><font color="#b041ff">-</font><td><a href="#" name="11">(183-187)<td><a href="#" name="11">(860-868)</a><td align="center"><font color="#7a0000">13</font>
<tr onclick='openModal("#571b7e")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#571b7e"><font color="#571b7e">-</font><td><a href="#" name="12">(127-140)<td><a href="#" name="12">(846-854)</a><td align="center"><font color="#7a0000">13</font>
<tr onclick='openModal("#3b9c9c")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3b9c9c"><font color="#3b9c9c">-</font><td><a href="#" name="13">(614-625)<td><a href="#" name="13">(236-243)</a><td align="center"><font color="#710000">12</font>
<tr onclick='openModal("#842dce")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#842dce"><font color="#842dce">-</font><td><a href="#" name="14">(248-258)<td><a href="#" name="14">(806-812)</a><td align="center"><font color="#710000">12</font>
<tr onclick='openModal("#f52887")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f52887"><font color="#f52887">-</font><td><a href="#" name="15">(226-238)<td><a href="#" name="15">(704-713)</a><td align="center"><font color="#710000">12</font>
<tr onclick='openModal("#2981b2")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#2981b2"><font color="#2981b2">-</font><td><a href="#" name="16">(606-609)<td><a href="#" name="16">(658-667)</a><td align="center"><font color="#670000">11</font>
<tr onclick='openModal("#3090c7")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3090c7"><font color="#3090c7">-</font><td><a href="#" name="17">(448-456)<td><a href="#" name="17">(725-734)</a><td align="center"><font color="#670000">11</font>
<tr onclick='openModal("#800517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#800517"><font color="#800517">-</font><td><a href="#" name="18">(272-278)<td><a href="#" name="18">(939-948)</a><td align="center"><font color="#670000">11</font>
<tr onclick='openModal("#f62817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f62817"><font color="#f62817">-</font><td><a href="#" name="19">(686-691)<td><a href="#" name="19">(1120-1124)</a><td align="center"><font color="#5e0000">10</font>
<tr onclick='openModal("#4e9258")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4e9258"><font color="#4e9258">-</font><td><a href="#" name="20">(513-519)<td><a href="#" name="20">(363-368)</a><td align="center"><font color="#5e0000">10</font>
<tr onclick='openModal("#947010")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#947010"><font color="#947010">-</font><td><a href="#" name="21">(484-490)<td><a href="#" name="21">(259-263)</a><td align="center"><font color="#5e0000">10</font>
<tr onclick='openModal("#4cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4cc417"><font color="#4cc417">-</font><td><a href="#" name="22">(379-382)<td><a href="#" name="22">(326-343)</a><td align="center"><font color="#5e0000">10</font>
<tr onclick='openModal("#f660ab")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f660ab"><font color="#f660ab">-</font><td><a href="#" name="23">(340-344)<td><a href="#" name="23">(303-307)</a><td align="center"><font color="#5e0000">10</font>
<tr onclick='openModal("#79764d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#79764d"><font color="#79764d">-</font><td><a href="#" name="24">(322-328)<td><a href="#" name="24">(759-763)</a><td align="center"><font color="#5e0000">10</font>
<tr onclick='openModal("#5eac10")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#5eac10"><font color="#5eac10">-</font><td><a href="#" name="25">(658-661)<td><a href="#" name="25">(895-899)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#68818b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#68818b"><font color="#68818b">-</font><td><a href="#" name="26">(646-649)<td><a href="#" name="26">(250-253)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#e77471")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#e77471"><font color="#e77471">-</font><td><a href="#" name="27">(597-600)<td><a href="#" name="27">(876-880)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#717d7d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#717d7d"><font color="#717d7d">-</font><td><a href="#" name="28">(582-585)<td><a href="#" name="28">(646-649)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#af7a82")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#af7a82"><font color="#af7a82">-</font><td><a href="#" name="29">(544-552)<td><a href="#" name="29">(525-528)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#ae694a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ae694a"><font color="#ae694a">-</font><td><a href="#" name="30">(443-447)<td><a href="#" name="30">(224-230)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#3ea99f")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3ea99f"><font color="#3ea99f">-</font><td><a href="#" name="31">(300-305)<td><a href="#" name="31">(376-379)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#5b8daf")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#5b8daf"><font color="#5b8daf">-</font><td><a href="#" name="32">(120-125)<td><a href="#" name="32">(424-426)</a><td align="center"><font color="#550000">9</font>
<tr onclick='openModal("#736aff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#736aff"><font color="#736aff">-</font><td><a href="#" name="33">(116-120)<td><a href="#" name="33">(398-400)</a><td align="center"><font color="#550000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>IndexSettingsTests.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
/*
 * Licensed to Crate.io GmbH ("Crate") under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<a name="0"></a> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>package org.elasticsearch.index;

import io.crate.common.unit.TimeValue;
import io.crate.types.DataTypes;

import org.elasticsearch.Version;
import org.elasticsearch.cluster.metadata.IndexMetadata;
import org.elasticsearch.common.settings.AbstractScopedSettings;
import org.elasticsearch.common.settings.IndexScopedSettings;
import org.elasticsearch.common.settings.Setting;
import org.elasticsearch.common.settings.Setting.Property;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.common.unit.ByteSizeUnit;
import org.elasticsearch.common.unit.ByteSizeValue;
import org.elasticsearch.index.translog.Translog;
import org.elasticsearch.test.ESTestCase;
import org.elasticsearch.test.VersionUtils;
import org.junit.Test;

import java.util.Arrays;
import java.util.Collections;
import java.util.HashSet;
import java.util.Set;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.function.Function;

import static org.hamcrest.CoreMatchers.equalTo;
import static org.hamcrest.Matchers.is;
import static org.hamcrest.core.StringContains.containsString;
import</b></font> static org.hamcrest.object.HasToString.hasToString;

public class IndexSettingsTests extends ESTestCase {

    @Test
    public void testRunListener() {
        Version version = VersionUtils.getPreviousVersion();
        Settings theSettings = Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, version)
            .put(IndexMetadata.SETTING_INDEX_UUID, "0xdeadbeef").build();
        final AtomicInteger integer = new AtomicInteger(0);
        Setting&lt;Integer&gt; integerSetting = Setting.intSetting(
            "index.test.setting.int",
            -1,
<a name="9"></a>            Property.Dynamic,
            Property.IndexScope
        );
        IndexMetadata metaData = <font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newIndexMeta("index", theSettings);
        IndexSettings settings = newIndexSettings(
            newIndexMeta("index", theSettings), Settings.EMPTY, integerSetting);
        settings.getScopedSettings().addSettingsUpdateConsumer(integerSetting, integer::set);

        assertThat(settings.getIndexVersionCreated(), is(version));
<a name="2"></a>        assertThat(settings.getUUID(), is("0xdeadbeef"));

        assertFalse(settings.updateIndexMetadata</b></font>(metaData));
        assertThat(<font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>settings.getSettings(), is(metaData.getSettings()));
        assertThat(integer.get(), is(0));
        assertTrue(
            settings.updateIndexMetadata(
                newIndexMeta(
                    "index",
                    Settings.builder()
                        .put(theSettings)
                        .put("index.test.setting.int", 42)
                        .build())));
        assertThat(integer.get(), is(42));
    }</b></font>

    @Test
    public void testSettingsUpdateValidator() {
        Version version = VersionUtils.getPreviousVersion();
        Settings theSettings = Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, version)
            .put(IndexMetadata.SETTING_INDEX_UUID, "0xdeadbeef")
            .build();
        final AtomicInteger integer = new AtomicInteger(0);
        Setting&lt;Integer&gt; integerSetting = Setting.intSetting(
            "index.test.setting.int",
            -1,
            Property.Dynamic,
            Property.IndexScope
        );
        IndexMetadata metaData = newIndexMeta("index", theSettings);
        IndexSettings settings = newIndexSettings(
            newIndexMeta("index", theSettings), Settings.EMPTY, integerSetting);
        settings.getScopedSettings().addSettingsUpdateConsumer(
            integerSetting, integer::set,
            (i) -&gt; {
                if (i == 42) {
                    throw new AssertionError("boom");
<a name="33"></a>                }
            });

        <font color="#736aff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(settings.getIndexVersionCreated(), is(version));
<a name="32"></a>        assertThat(settings.getUUID(), is("0xdeadbeef"));

        assertFalse(settings.updateIndexMetadata(metaData));
        assertThat</b></font>(<font color="#5b8daf"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>settings.getSettings(), is(metaData.getSettings()));
        assertThat(integer.get(), is(0));
        expectThrows(
            IllegalArgumentException.class,
<a name="12"></a>            () -&gt; settings.updateIndexMetadata(
                newIndexMeta</b></font>(
                    "index",
                    <font color="#571b7e"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Settings.builder()
                        .put(theSettings)
                        .put("index.test.setting.int", 42)
                        .build())));
        assertTrue(
            settings.updateIndexMetadata(
                newIndexMeta(
                    "index",
                    Settings.builder()
                        .put(theSettings)
                        .put("index.test.setting.int", 41)
                        .build())));
        assertThat(integer.get(), is(41));
    }</b></font>

    @Test
    public void testMergedSettingsArePassed() {
        Version version = VersionUtils.getPreviousVersion();
        Settings theSettings = Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, version)
            .put(IndexMetadata.SETTING_INDEX_UUID, "0xdeadbeef")
            .build();
        final AtomicInteger integer = new AtomicInteger(0);
        final StringBuilder builder = new StringBuilder();
        Setting&lt;Integer&gt; integerSetting = Setting.intSetting(
            "index.test.setting.int",
            -1,
            Property.Dynamic,
            Property.IndexScope);
<a name="1"></a>        Setting&lt;String&gt; notUpdated = new Setting&lt;&gt;(
            "index.not.updated",
            "",
            <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Function.identity(),
            DataTypes.STRING,
            Property.Dynamic,
            Property.IndexScope);

        IndexSettings settings = newIndexSettings(
            newIndexMeta("index", theSettings), Settings.EMPTY, integerSetting, notUpdated);
        settings.getScopedSettings().addSettingsUpdateConsumer(integerSetting, integer::set);
        settings.getScopedSettings().addSettingsUpdateConsumer(notUpdated, builder::append);
        assertThat(integer.get(), is(0));
        assertThat(builder.toString(), is(""));
        IndexMetadata newMetaData = newIndexMeta(
            "index",
            Settings.builder()
                .put(settings.getIndexMetadata().getSettings())
                .put("index.test.setting.int", 42)
                .build()
        );
        assertTrue(settings.updateIndexMetadata(newMetaData));
        assertSame</b></font>(settings.getIndexMetadata(), newMetaData);
        assertThat(integer.get(), is(42));
<a name="11"></a>        assertThat(builder.toString(), is(""));
        integer.set(0);
        assertTrue(settings.updateIndexMetadata(
            newIndexMeta("index", <font color="#b041ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Settings.builder().put(settings.getIndexMetadata().getSettings())
                .put("index.not.updated", "boom").build())));
        assertThat(builder.toString(), is("boom"));
        assertThat("not updated - we preserve the old settings", integer.get(), is(0));
    }</b></font>

    @Test
    public void testSettingsConsistency() {
        Version version = VersionUtils.getPreviousVersion();
        IndexMetadata metaData = newIndexMeta(
            "index",
            Settings.builder()
                .put(IndexMetadata.SETTING_VERSION_CREATED, version)
                .build()
        );
        IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(settings.getIndexVersionCreated(), is(version));
        assertThat(settings.getUUID(), is("_na_"));
        try {
<a name="10"></a>            settings.updateIndexMetadata(
                newIndexMeta(
                    "index",
                    <font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Settings.builder()
                        .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
                        .put("index.test.setting.int", 42)
                        .build()
                )
            );
            fail("version has changed");
        } catch (IllegalArgumentException ex) {
            assertTrue(ex.getMessage(), ex.getMessage().startsWith("version mismatch on settings update expected: "));
        }</b></font>

        // use version number that is unknown
        int unknownVersion = Version.CURRENT.internalId + 200;
        metaData = newIndexMeta(
            "index",
            Settings.builder()
                .put(
                    IndexMetadata.SETTING_VERSION_CREATED, Version.fromId(unknownVersion))
<a name="15"></a>                .build());
        settings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(settings.getIndexVersionCreated(), is(Version.fromId(unknownVersion)));
        assertThat(settings.getUUID(), <font color="#f52887"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>is("_na_"));
        settings.updateIndexMetadata(
            newIndexMeta(
                "index",
                Settings.builder()
                    .put(IndexMetadata.SETTING_VERSION_CREATED, Version.fromId(unknownVersion))
                    .put("index.test.setting.int", 42)
                    .build()
            )
        );
        metaData = newIndexMeta(
            "index",
            Settings.builder()</b></font>
                .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
                .put(IndexMetadata.SETTING_INDEX_UUID, "0xdeadbeef")
                .build()
        );
        settings = new IndexSettings(metaData, Settings.EMPTY);
        try {
<a name="14"></a>            settings.updateIndexMetadata(
                newIndexMeta(
                    "index",
                    <font color="#842dce"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Settings.builder()
                        .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
                        .put("index.test.setting.int", 42)
                        .build()
                )
            );
            fail("uuid missing/change");
        } catch (IllegalArgumentException ex) {
            assertThat(ex.getMessage(), is("uuid mismatch on settings update expected: 0xdeadbeef but was: _na_"));
        }
        assertThat</b></font>(settings.getSettings(), is(metaData.getSettings()));
    }

    public IndexSettings newIndexSettings(IndexMetadata metaData, Settings nodeSettings, Setting&lt;?&gt;... settings) {
        Set&lt;Setting&lt;?&gt;&gt; settingSet = new HashSet&lt;&gt;(IndexScopedSettings.BUILT_IN_INDEX_SETTINGS);
        if (settings.length &gt; 0) {
            settingSet.addAll(Arrays.asList(settings));
        }
        return new IndexSettings(metaData, nodeSettings, new IndexScopedSettings(Settings.EMPTY, settingSet));
    }

<a name="18"></a>    @Test
    public void testNodeSettingsAreContained() {
        final int numShards = randomIntBetween(1, 10);
        final int numReplicas = <font color="#800517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>randomIntBetween(0, 10);
        Settings theSettings = Settings.builder().
            put("index.foo.bar", 0)
            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, numReplicas)
            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, numShards).build();
<a name="4"></a>
        Settings nodeSettings = Settings.builder</b></font>().put("index.foo.bar", 43).build();
        final AtomicInteger indexValue = new AtomicInteger(0);
        Setting&lt;Integer&gt; integerSetting = <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Setting.intSetting(
            "index.foo.bar",
            -1,
            Property.Dynamic,
            Property.IndexScope);
        IndexSettings settings = newIndexSettings(
            newIndexMeta("index", theSettings), nodeSettings, integerSetting);
        settings.getScopedSettings().addSettingsUpdateConsumer(integerSetting, indexValue::set);
        assertThat(settings.getNumberOfReplicas(), is(numReplicas));
        assertThat(settings.getNumberOfShards(), is(numShards));
        assertThat(indexValue.get(), is(0));

        assertTrue</b></font>(settings.updateIndexMetadata(newIndexMeta("index", Settings.builder().
            put("index.foo.bar", 42)
            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, numReplicas + 1)
            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, numShards).build())));

<a name="31"></a>        assertThat(indexValue.get(), is(42));
        assertSame(nodeSettings, settings.getNodeSettings());

        assertTrue(settings.updateIndexMetadata(<font color="#3ea99f"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newIndexMeta("index", Settings.builder()
            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, numReplicas + 1)
            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, numShards).build())));
        assertThat(indexValue.get(), is(43));

    }</b></font>

    public static IndexMetadata newIndexMeta(String name, Settings indexSettings) {
        Settings build = Settings.builder().put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 1)
            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, 1)
            .put(indexSettings)
            .build();
        return IndexMetadata.builder(name).settings(build).build();
    }

    @Test
    public void testUpdateDurability() {
        IndexMetadata metaData = newIndexMeta("index", Settings.builder()
<a name="24"></a>            .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
            .put(IndexSettings.INDEX_TRANSLOG_DURABILITY_SETTING.getKey(), "async")
            .build());
        IndexSettings settings = <font color="#79764d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>new IndexSettings(metaData, Settings.EMPTY);
        assertThat(settings.getTranslogDurability(), is(Translog.Durability.ASYNC));
        settings.updateIndexMetadata(
            newIndexMeta(
                "index",
                Settings.builder()
                    .put(IndexSettings.INDEX_TRANSLOG_DURABILITY_SETTING.getKey</b></font>(), "request")
                    .build()));
        assertThat(settings.getTranslogDurability(), is(Translog.Durability.REQUEST));

        metaData = newIndexMeta("index", Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
            .build());
        settings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(settings.getTranslogDurability(), is(Translog.Durability.REQUEST)); // test default
<a name="23"></a>    }

    @Test
    public void testRefreshInterval() <font color="#f660ab"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
        String refreshInterval = getRandomTimeString();
        IndexMetadata metaData = newIndexMeta("index", Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
            .put(IndexSettings.INDEX_REFRESH_INTERVAL_SETTING.getKey</b></font>(), refreshInterval)
            .build());
        IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(
<a name="8"></a>            TimeValue.parseTimeValue(
                refreshInterval,
                new TimeValue(1, TimeUnit.DAYS),
                <font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>IndexSettings.INDEX_REFRESH_INTERVAL_SETTING.getKey()),
            is(settings.getRefreshInterval()));
        String newRefreshInterval = getRandomTimeString();
        settings.updateIndexMetadata(
            newIndexMeta(
                "index",
                Settings.builder()
                    .put(IndexSettings.INDEX_REFRESH_INTERVAL_SETTING.getKey(), newRefreshInterval)
                    .build()));
        assertThat(
            TimeValue.parseTimeValue(
                newRefreshInterval,
                new</b></font> TimeValue(1, TimeUnit.DAYS),
                IndexSettings.INDEX_REFRESH_INTERVAL_SETTING.getKey()),
            is(settings.getRefreshInterval()));
    }

    private String getRandomTimeString() {
        int refreshIntervalInt = randomFrom(-1, Math.abs(randomInt()));
        String refreshInterval = Integer.toString(refreshIntervalInt);
        if (refreshIntervalInt &gt;= 0) {
            refreshInterval += randomFrom("s", "ms", "h");
        }
        return refreshInterval;
    }
<a name="22"></a>
    @Test
    public void testGCDeletesSetting() {
        TimeValue gcDeleteSetting = new TimeValue(<font color="#4cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Math.abs(randomInt()), TimeUnit.MILLISECONDS);
        IndexMetadata metaData = newIndexMeta("index", Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
            .put(IndexSettings.INDEX_GC_DELETES_SETTING.getKey(), gcDeleteSetting.getStringRep</b></font>())
            .build());
        IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(
            TimeValue.parseTimeValue(
                gcDeleteSetting.getStringRep(),
                new TimeValue(1, TimeUnit.DAYS),
                IndexSettings.INDEX_GC_DELETES_SETTING.getKey()).getMillis(),
            is(settings.getGcDeletesInMillis())
        );
        TimeValue newGCDeleteSetting = new TimeValue(Math.abs(randomInt()), TimeUnit.MILLISECONDS);
        settings.updateIndexMetadata(
            newIndexMeta(
                "index",
                Settings.builder()
                    .put(IndexSettings.INDEX_GC_DELETES_SETTING.getKey(), newGCDeleteSetting.getStringRep())
                    .build()
            )
        );
        assertThat(
            TimeValue.parseTimeValue(
                newGCDeleteSetting.getStringRep(),
                new TimeValue(1, TimeUnit.DAYS),
                IndexSettings.INDEX_GC_DELETES_SETTING.getKey()).getMillis(),
            is(settings.getGcDeletesInMillis())
        );
        settings.updateIndexMetadata(
            newIndexMeta(
                "index",
                Settings.builder()
                    .put(
                        IndexSettings.INDEX_GC_DELETES_SETTING.getKey(),
                        (randomBoolean() ? -1 : new TimeValue(-1, TimeUnit.MILLISECONDS)).toString()
                    ).build()
            )
        );
        assertThat(settings.getGcDeletesInMillis(), is(-1L));
    }
<a name="7"></a>
    @Test
    public void testTranslogFlushSizeThreshold() {
        ByteSizeValue translogFlushThresholdSize = new ByteSizeValue(Math.abs(<font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>randomInt()));
        ByteSizeValue actualValue = ByteSizeValue.parseBytesSizeValue(
            translogFlushThresholdSize.getBytes() + "B",
            IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey());
        IndexMetadata metaData = newIndexMeta("index", Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
            .put(IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey(),
                 translogFlushThresholdSize.getBytes() + "B")
<a name="3"></a>            .build());
        IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY)</b></font>;
        assertThat(actualValue, is(settings.getFlushThresholdSize()));
        ByteSizeValue newTranslogFlushThresholdSize = new ByteSizeValue(<font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Math.abs(randomInt()));
        ByteSizeValue actualNewTranslogFlushThresholdSize = ByteSizeValue.parseBytesSizeValue(
            newTranslogFlushThresholdSize.getBytes() + "B",
            IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey());
        settings.updateIndexMetadata(newIndexMeta("index", Settings.builder()
            .put(IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey(),
<a name="30"></a>                 newTranslogFlushThresholdSize.getBytes() + "B")
            .build()));
        assertThat(actualNewTranslogFlushThresholdSize, equalTo(settings.getFlushThresholdSize</b></font>()));
    <font color="#ae694a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}

<a name="17"></a>    @Test
    public void testTranslogGenerationSizeThreshold() {
        final ByteSizeValue size = new ByteSizeValue(Math.abs(randomInt</b></font>()));
        final String key = <font color="#3090c7"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>IndexSettings.INDEX_TRANSLOG_GENERATION_THRESHOLD_SIZE_SETTING.getKey();
        final ByteSizeValue actualValue =
            ByteSizeValue.parseBytesSizeValue(size.getBytes() + "B", key);
        final IndexMetadata metaData =
            newIndexMeta(
                "index",
                Settings.builder()
                    .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT)
                    .put(key, size.getBytes</b></font>() + "B")
<a name="5"></a>                    .build());
        final IndexSettings settings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(actualValue, is(settings.getGenerationThresholdSize()));
        final ByteSizeValue newSize = new ByteSizeValue(<font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Math.abs(randomInt()));
        final ByteSizeValue actual = ByteSizeValue.parseBytesSizeValue(newSize.getBytes() + "B", key);
        settings.updateIndexMetadata(
            newIndexMeta("index", Settings.builder().put(key, newSize.getBytes() + "B").build()));
        assertThat(actual, is(settings.getGenerationThresholdSize()));
    }</b></font>

    @Test
    public void testPrivateSettingsValidation() {
        final Settings settings = Settings.builder()
            .put(IndexMetadata.SETTING_CREATION_DATE, System.currentTimeMillis())
            .build();
        final IndexScopedSettings indexScopedSettings = new IndexScopedSettings(
            settings,
            IndexScopedSettings.BUILT_IN_INDEX_SETTINGS);

        {
            // validation should fail since we are not ignoring private settings
            final IllegalArgumentException e = expectThrows(
                IllegalArgumentException.class,
                () -&gt; indexScopedSettings.validate(settings, randomBoolean()));
<a name="21"></a>            assertThat(e, hasToString(containsString("unknown setting [index.creation_date]")));
        }

        <font color="#947010"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
            // validation should fail since we are not ignoring private settings
            final IllegalArgumentException e = expectThrows(
                IllegalArgumentException.class,
                () -&gt; indexScopedSettings.validate(settings, randomBoolean(), false, randomBoolean()));
            assertThat(e, hasToString(containsString("unknown setting [index.creation_date]")));
        }</b></font>

        // nothing should happen since we are ignoring private settings
        indexScopedSettings.validate(settings, randomBoolean(), true, randomBoolean());
    }

    @Test
    public void testArchivedSettingsValidation() {
        final Settings settings = Settings.builder()
            .put(AbstractScopedSettings.ARCHIVED_SETTINGS_PREFIX + "foo", System.currentTimeMillis())
            .build();
        final IndexScopedSettings indexScopedSettings = new IndexScopedSettings(
            settings,
            IndexScopedSettings.BUILT_IN_INDEX_SETTINGS
        );
        {
            // validation should fail since we are not ignoring archived settings
            final IllegalArgumentException e = expectThrows(
                IllegalArgumentException.class,
                () -&gt; indexScopedSettings.validate(settings, randomBoolean()));
<a name="20"></a>            assertThat(e, hasToString(containsString("unknown setting [archived.foo]")));
        }

        <font color="#4e9258"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
            // validation should fail since we are not ignoring archived settings
            final IllegalArgumentException e = expectThrows(
                IllegalArgumentException.class,
                () -&gt; indexScopedSettings.validate(settings, randomBoolean(), randomBoolean(), false));
            assertThat(e, hasToString(containsString("unknown setting [archived.foo]")));
        }</b></font>

        // nothing should happen since we are ignoring archived settings
        indexScopedSettings.validate(settings, randomBoolean(), randomBoolean(), true);
    }

    @Test
    public void testArchiveBrokenIndexSettings() {
        Settings settings =
            IndexScopedSettings.DEFAULT_SCOPED_SETTINGS.archiveUnknownOrInvalidSettings(
                Settings.EMPTY,
                e -&gt; {
                    assert false : "should not have been invoked, no unknown settings";
                },
                (e, ex) -&gt; {
                    assert false : "should not have been invoked, no invalid settings";
                });
        assertSame(settings, Settings.EMPTY);
        settings =
            IndexScopedSettings.DEFAULT_SCOPED_SETTINGS.archiveUnknownOrInvalidSettings(
                Settings.builder().put("index.refresh_interval", "-200").build(),
                e -&gt; {
<a name="29"></a>                    assert false : "should not have been invoked, no invalid settings";
                },
                (e, ex) -&gt; {
                    assertThat(<font color="#af7a82"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>e.getKey(), equalTo("index.refresh_interval"));
                    assertThat(e.getValue(), equalTo("-200"));
                    assertThat(
                        ex,
                        hasToString(containsString(
                            "failed to parse value [-200] for setting [index.refresh_interval], must be &gt;= [-1]")
                        )
                    );
                }</b></font>);
        assertThat(settings.get("archived.index.refresh_interval"), is("-200"));
        assertNull(settings.get("index.refresh_interval"));

        Settings prevSettings = settings; // no double archive
        settings =
            IndexScopedSettings.DEFAULT_SCOPED_SETTINGS.archiveUnknownOrInvalidSettings(
                prevSettings,
                e -&gt; {
                    assert false : "should not have been invoked, no unknown settings";
                },
                (e, ex) -&gt; {
                    assert false : "should not have been invoked, no invalid settings";
                });
        assertSame(prevSettings, settings);

        settings =
            IndexScopedSettings.DEFAULT_SCOPED_SETTINGS.archiveUnknownOrInvalidSettings(
                Settings.builder()
                    .put("index.version.created", Version.CURRENT.internalId) // private setting
                    .put("index.unknown", "foo")
                    .put("index.refresh_interval", "2s").build(),
                e -&gt; {
                    assertThat(e.getKey(), equalTo("index.unknown"));
                    assertThat(e.getValue(), equalTo("foo"));
                },
                (e, ex) -&gt; {
<a name="28"></a>                    assert false : "should not have been invoked, no invalid settings";
                });

        assertThat(settings.get("archived.index.unknown"), <font color="#717d7d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>is("foo"));
        assertThat(settings.get("index.version.created"), is(Integer.toString(Version.CURRENT.internalId)));
        assertThat(settings.get("index.refresh_interval"), is("2s"));
<a name="6"></a>    }</b></font>

    public void testQueryDefaultField() {
        IndexSettings index = <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newIndexSettings(
            newIndexMeta("index", Settings.EMPTY), Settings.EMPTY
        );
        assertThat(index.getDefaultFields(), equalTo(Collections.singletonList("*")));
        index = newIndexSettings(
            newIndexMeta("index", Settings.EMPTY), Settings.builder().put("index.query.default_field", "body").build()
<a name="27"></a>        );
        assertThat(index.getDefaultFields</b></font>(), equalTo(Collections.singletonList("body")));
        index.updateIndexMetadata(
            <font color="#e77471"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newIndexMeta("index", Settings.builder().putList("index.query.default_field", "body", "title").build())
        );
        assertThat(index.getDefaultFields(), equalTo(Arrays.asList("body", "title")));
    }</b></font>

    @Test
<a name="16"></a>    public void testUpdateSoftDeletesFails() {
        IndexScopedSettings settings = new IndexScopedSettings(Settings.EMPTY,
                                                               IndexScopedSettings.BUILT_IN_INDEX_SETTINGS);
        <font color="#2981b2"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>IllegalArgumentException error = expectThrows(IllegalArgumentException.class, () -&gt;
            settings.updateSettings(Settings.builder().put("index.soft_deletes.enabled", randomBoolean()).build(),
                                    Settings.builder(), Settings.builder(), "index"));
        assertThat(error.getMessage</b></font>(), equalTo("final index setting [index.soft_deletes.enabled], not updateable"));
    }
<a name="13"></a>
    @Test
    public void testSoftDeletesDefaultSetting() {
        Version createdVersion = <font color="#3b9c9c"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>VersionUtils.randomVersionBetween(
            random(),
            Version.CURRENT.minimumIndexCompatibilityVersion(),
            Version.CURRENT
        );

        Settings settings = Settings.builder()
            .put(IndexMetadata.SETTING_INDEX_VERSION_CREATED.getKey(), createdVersion)
            .build();

        boolean isEnabled = createdVersion.onOrAfter(Version.V_4_3_0);
        assertThat(IndexSettings.INDEX_SOFT_DELETES_SETTING.get</b></font>(settings), is(isEnabled));
    }

    @Test
    public void testUpdateTranslogRetentionSettingsWithSoftDeletesDisabled() {
        Settings.Builder settings = Settings.builder()
            .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), false)
            .put(IndexMetadata.SETTING_VERSION_CREATED, Version.CURRENT);

        TimeValue ageSetting = TimeValue.timeValueHours(12);
        if (randomBoolean()) {
            ageSetting = randomBoolean() ? TimeValue.MINUS_ONE : TimeValue.timeValueSeconds(randomIntBetween(0, 60));
            settings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), ageSetting);
        }
        ByteSizeValue sizeSetting = new ByteSizeValue(512, ByteSizeUnit.MB);
        if (randomBoolean()) {
            sizeSetting = randomBoolean() ? new ByteSizeValue(-1) : new ByteSizeValue(randomIntBetween(0, 1024));
            settings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), sizeSetting);
<a name="26"></a>        }
        IndexMetadata metaData = newIndexMeta("index", settings.build());
        IndexSettings indexSettings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(<font color="#68818b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>indexSettings.getTranslogRetentionAge(), equalTo(ageSetting));
        assertThat(indexSettings.getTranslogRetentionSize(), equalTo(sizeSetting));

        Settings.Builder newSettings = Settings.builder().put(settings.build</b></font>());
        if (randomBoolean()) {
            ageSetting = randomBoolean() ? TimeValue.MINUS_ONE : TimeValue.timeValueSeconds(randomIntBetween(0, 60));
            newSettings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), ageSetting);
        }
        if (randomBoolean()) {
<a name="25"></a>            sizeSetting = randomBoolean() ? new ByteSizeValue(-1) : new ByteSizeValue(randomIntBetween(0, 1024));
            newSettings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), sizeSetting);
        }
        indexSettings.updateIndexMetadata(<font color="#5eac10"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newIndexMeta("index", newSettings.build()));
        assertThat(indexSettings.getTranslogRetentionAge(), equalTo(ageSetting));
        assertThat(indexSettings.getTranslogRetentionSize(), equalTo(sizeSetting));
    }</b></font>

    @Test
    public void testIgnoreTranslogRetentionSettingsIfSoftDeletesEnabled() {
        Settings.Builder settings = Settings.builder()
            .put(IndexMetadata.SETTING_VERSION_CREATED, VersionUtils.randomVersionBetween(random(), Version.V_4_3_0, Version.CURRENT));
        if (randomBoolean()) {
            settings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), randomPositiveTimeValue());
        }
        if (randomBoolean()) {
            settings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), between(1, 1024) + "b");
        }
        IndexMetadata metaData = newIndexMeta("index", settings.build());
        IndexSettings indexSettings = new IndexSettings(metaData, Settings.EMPTY);
        assertThat(indexSettings.getTranslogRetentionAge().millis(), equalTo(-1L));
        assertThat(indexSettings.getTranslogRetentionSize().getBytes(), equalTo(-1L));

        Settings.Builder newSettings = Settings.builder().put(settings.build());
        if (randomBoolean()) {
            newSettings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), randomPositiveTimeValue());
        }
        if (randomBoolean()) {
<a name="19"></a>            newSettings.put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), between(1, 1024) + "b");
        }
        indexSettings.updateIndexMetadata(newIndexMeta("index", newSettings.build()));
        assertThat(<font color="#f62817"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>indexSettings.getTranslogRetentionAge().millis(), equalTo(-1L));
        assertThat(indexSettings.getTranslogRetentionSize().getBytes(), equalTo(-1L));
    }


}</b></font>
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>PostgresITest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
/*
 * Licensed to Crate.io GmbH ("Crate") under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<a name="0"></a> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>package io.crate.integrationtests;

import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_TABLE;
import static io.crate.protocols.postgres.PostgresNetty.PSQL_PORT_SETTING;
import static io.crate.testing.Asserts.assertThrowsMatches;
import static io.crate.testing.SQLErrorMatcher.isPGError;
import static org.hamcrest.Matchers.arrayContaining;
import static org.hamcrest.Matchers.containsString;
import static org.hamcrest.Matchers.emptyIterable;
import static org.hamcrest.Matchers.emptyOrNullString;
import static org.hamcrest.Matchers.greaterThan;
import static org.hamcrest.Matchers.not;
import static org.hamcrest.core.Is.is;

import java.sql.Array;
import java.sql.BatchUpdateException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import</b></font> java.util.Locale;
import java.util.Map;
import java.util.Properties;
import java.util.StringJoiner;
import java.util.UUID;

import org.elasticsearch.Version;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.test.ESIntegTestCase;
import org.elasticsearch.test.junit.annotations.TestLogging;
import org.hamcrest.Matchers;
import org.junit.Before;
import org.junit.BeforeClass;
import org.junit.Test;
import org.junit.jupiter.api.Assertions;
import org.postgresql.PGProperty;
import org.postgresql.geometric.PGpoint;
import org.postgresql.jdbc.PreferQueryMode;
import org.postgresql.util.PGobject;
import org.postgresql.util.PSQLException;
import org.postgresql.util.PSQLState;

import io.crate.action.sql.SQLOperations;
import io.crate.exceptions.SQLParseException;
import io.crate.execution.engine.collect.stats.JobsLogService;
import io.crate.execution.engine.collect.stats.JobsLogs;
import io.crate.protocols.postgres.PostgresNetty;
import io.crate.testing.DataTypeTesting;
import io.crate.testing.UseJdbc;
import io.crate.types.DataTypes;
import static org.junit.jupiter.api.Assertions.assertThrows;

@ESIntegTestCase.ClusterScope(numDataNodes = 2, numClientNodes = 0, supportsDedicatedMasters = false)
public class PostgresITest extends SQLIntegrationTestCase {

    private static final String NO_IPV6 = "CRATE_TESTS_NO_IPV6";
    private static final String RO = "node_s0";
    private static final String RW = "node_s1";

    private Properties properties = new Properties();
    private static boolean useIPv6;

    @BeforeClass
    public static void setupClass() {
        useIPv6 = randomBoolean() &amp;&amp; !"true".equalsIgnoreCase(System.getenv(NO_IPV6));
    }

    private String url(String nodeName) {
        PostgresNetty postgresNetty = internalCluster().getInstance(PostgresNetty.class, nodeName);
        int port = postgresNetty.boundAddress().publishAddress().getPort();
        if (useIPv6) {
            return "jdbc:postgresql://::1:" + port + '/';
        }
        return "jdbc:postgresql://127.0.0.1:" + port + '/';
    }

    @Override
    protected Settings nodeSettings(int nodeOrdinal) {
        Settings.Builder builder = Settings.builder();
        builder.put(super.nodeSettings(nodeOrdinal));

        if (useIPv6) {
            builder.put("network.host", "::1");
        } else {
            builder.put("network.host", "127.0.0.1");
        }

        if ((nodeOrdinal + 1) % 2 != 0) {
            builder.put(PSQL_PORT_SETTING.getKey(), "5432-5532");
            builder.put(SQLOperations.NODE_READ_ONLY_SETTING.getKey(), true);
        } else {
            builder.put(PSQL_PORT_SETTING.getKey(), "5533-5633");
        }
        return builder.build();
    }

    @Before
    public void initProperties() throws Exception {
        if (randomBoolean()) {
            // force binary transfer &amp; use server-side prepared statements
            properties.setProperty("prepareThreshold", "-1");
        }
        properties.setProperty("user", "crate");
    }

    @Test
    public void testGetTransactionIsolation() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            int var = conn.getTransactionIsolation();
            assertThat(var, is(Connection.TRANSACTION_READ_UNCOMMITTED));
        }
    }

    @Test
    public void test_simple_mode_can_handle_npgsql_startup_query() throws Exception {
        String query = """
            SELECT version();
            SELECT ns.nspname, t.oid, t.typname, t.typtype, t.typnotnull, t.elemtypoid
            FROM (
                -- Arrays have typtype=b - this subquery identifies them by their typreceive and converts their typtype to a
                -- We first do this for the type (innerest-most subquery), and then for its element type
                -- This also returns the array element, range subtype and domain base type as elemtypoid
                SELECT
                    typ.oid, typ.typnamespace, typ.typname, typ.typtype, typ.typrelid, typ.typnotnull, typ.relkind,
                    elemtyp.oid AS elemtypoid, elemtyp.typname AS elemtypname, elemcls.relkind AS elemrelkind,
                    CASE WHEN elemproc.proname='array_recv' THEN 'a' ELSE elemtyp.typtype END AS elemtyptype
                FROM (
                    SELECT typ.oid, typnamespace, typname, typrelid, typnotnull, relkind, typelem AS elemoid,
                        CASE WHEN proc.proname='array_recv' THEN 'a' ELSE typ.typtype END AS typtype,
                        CASE
                            WHEN proc.proname='array_recv' THEN typ.typelem
                            WHEN typ.typtype='r' THEN rngsubtype

                            WHEN typ.typtype='d' THEN typ.typbasetype
                        END AS elemtypoid
                    FROM pg_type AS typ
                    LEFT JOIN pg_class AS cls ON (cls.oid = typ.typrelid)
                    LEFT JOIN pg_proc AS proc ON proc.oid = typ.typreceive
                    LEFT JOIN pg_range ON (pg_range.rngtypid = typ.oid)
                ) AS typ
                LEFT JOIN pg_type AS elemtyp ON elemtyp.oid = elemtypoid
                LEFT JOIN pg_class AS elemcls ON (elemcls.oid = elemtyp.typrelid)
                LEFT JOIN pg_proc AS elemproc ON elemproc.oid = elemtyp.typreceive
            ) AS t
            JOIN pg_namespace AS ns ON (ns.oid = typnamespace)
            WHERE
                typtype IN ('b', 'r', 'm', 'e', 'd') OR -- Base, range, multirange, enum, domain
                (typtype = 'c' AND relkind='c') OR -- User-defined free-standing composites (not table composites) by default
                (typtype = 'p' AND typname IN ('record', 'void')) OR -- Some special supported pseudo-types
                (typtype = 'a' AND (  -- Array of...
                    elemtyptype IN ('b', 'r', 'm', 'e', 'd') OR -- Array of base, range, multirange, enum, domain
                    (elemtyptype = 'p' AND elemtypname IN ('record', 'void')) OR -- Arrays of special supported pseudo-types
                    (elemtyptype = 'c' AND elemrelkind='c') -- Array of user-defined free-standing composites (not table composites) by default
                ))
            ORDER BY CASE
                   WHEN typtype IN ('b', 'e', 'p') THEN 0           -- First base types, enums, pseudo-types
                   WHEN typtype = 'r' THEN 1                        -- Ranges after
                   WHEN typtype = 'm' THEN 2                        -- Multiranges after
                   WHEN typtype = 'c' THEN 3                        -- Composites after
                   WHEN typtype = 'd' AND elemtyptype &lt;&gt; 'a' THEN 4 -- Domains over non-arrays after
                   WHEN typtype = 'a' THEN 5                        -- Arrays after
                   WHEN typtype = 'd' AND elemtyptype = 'a' THEN 6  -- Domains over arrays last
            END;

            -- Load field definitions for (free-standing) composite types
            SELECT typ.oid, att.attname, att.atttypid
            FROM pg_type AS typ
            JOIN pg_namespace AS ns ON (ns.oid = typ.typnamespace)
            JOIN pg_class AS cls ON (cls.oid = typ.typrelid)
            JOIN pg_attribute AS att ON (att.attrelid = typ.typrelid)
            WHERE
              (typ.typtype = 'c' AND cls.relkind='c') AND
              attnum &gt; 0 AND     -- Don't load system attributes
              NOT attisdropped
            ORDER BY typ.oid, att.attnum;

            -- Load enum fields
            SELECT pg_type.oid, enumlabel
            FROM pg_enum
            JOIN pg_type ON pg_type.oid=enumtypid
            ORDER BY oid, enumsortorder;
        """;

        Properties properties = new Properties();
<a name="5"></a>        properties.setProperty("user", "crate");
        properties.setProperty(PGProperty.PREFER_QUERY_MODE.getName(), PreferQueryMode.SIMPLE.value());
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            Statement statement = <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement();
            statement.execute(query);
            ResultSet resultSet = statement.getResultSet();
            assertThat(resultSet.next(), is(true));
<a name="30"></a>            assertThat(resultSet.getString(1), Matchers.containsString("CrateDB " + Version.CURRENT.toString()));
            assertThat(statement.getMoreResults(), is(true));
        }</b></font>
    <font color="#ae694a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}

    @Test
    public void testMultidimensionalArrayWithDifferentSizedArrays() throws Exception {
        Properties properties = new Properties();
        properties.setProperty("user", "crate");
        properties.setProperty</b></font>(PGProperty.PREFER_QUERY_MODE.getName(), PreferQueryMode.SIMPLE.value());
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            Statement statement = conn.createStatement();
<a name="13"></a>            statement.executeUpdate("create table t (o1 array(object as (o2 array(object as (x int)))))");
            ensureYellow();

            <font color="#3b9c9c"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>statement.setEscapeProcessing(false);
            statement.executeUpdate("insert into t (o1) values ( [ {o2=[{x=1}, {x=2}]}, {o2=[{x=3}]} ] )");
            statement.executeUpdate("refresh table t");

            ResultSet resultSet = statement.executeQuery("select o1['o2']['x'] from t");
            assertThat(resultSet.next(), is(true));
            String array = resultSet.getString(1);
            assertThat(array, is</b></font>("[[1,2],[3]]"));
        }

        properties = new Properties();
<a name="26"></a>        properties.setProperty("user", "crate");
        properties.setProperty("prepareThreshold", "-1"); // force binary transfer
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            ResultSet resultSet = <font color="#68818b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery("select o1['o2']['x'] from t");
            assertThat(resultSet.next(), is(true));
            String array = resultSet.getString(1);
            assertThat(array, is</b></font>("[[1,2],[3]]"));
        }
    }
<a name="21"></a>
    @Test
    public void testUseOfUnsupportedType() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) <font color="#947010"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
            PreparedStatement stmt = conn.prepareStatement("select ? from sys.cluster");
            stmt.setObject(1, UUID.randomUUID());
            assertThrowsMatches(() -&gt; stmt.executeQuery(), isPGError(is("Can't map PGType with oid=2950 to Crate type"), INTERNAL_ERROR));
        }</b></font>
    }

    @Test
    public void testEmptyStatement() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
<a name="10"></a>            assertThat(conn.createStatement().execute(""), is(false));

            try {
                <font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery("");
                fail("executeQuery with empty query should throw a 'No results were returned by the query' error");
            } catch (PSQLException e) {
                // can't use expectedException.expectMessage because error messages are localized and locale is randomized
                assertThat(e.getSQLState(), is(PSQLState.NO_DATA.getState()));
            }</b></font>
        }
    }

    @Test
    public void testSimpleQuery() throws Exception {
        properties.setProperty(PGProperty.PREFER_QUERY_MODE.getName(), PreferQueryMode.SIMPLE.value());
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
<a name="4"></a>            conn.setAutoCommit(true);
            conn.createStatement().executeUpdate("create table t (x int) with (number_of_replicas = 0)");
            conn.createStatement().executeUpdate("insert into t (x) values (1), (2)");
            <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeUpdate("refresh table t");

            ResultSet resultSet = conn.createStatement().executeQuery("select * from t order by x");
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is(1));
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is</b></font>(2));
        }
    }

    @Test
    public void testPreparedStatementHandling() throws Exception {
<a name="23"></a>        Properties properties = new Properties();
        properties.setProperty("user", "crate");
        properties.setProperty("prepareThreshold", "-1");
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) <font color="#f660ab"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
            PreparedStatement p1 = conn.prepareStatement("select 1 from sys.cluster");
            ResultSet resultSet = p1.executeQuery();
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt</b></font>(1), is(1));
<a name="6"></a>
            PreparedStatement p2 = conn.prepareStatement("select 2 from sys.cluster");
            resultSet = p2.executeQuery();
            <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is(2));

            resultSet = p1.executeQuery();
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is</b></font>(1));
        }
    }

    @Test
    public void testPreparedSelectStatementWithParametersCanBeDescribed() throws Exception {
        Properties properties = new Properties();
<a name="22"></a>        properties.setProperty("user", "crate");
        properties.setProperty("prepareThreshold", "-1");
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            PreparedStatement p1 = <font color="#4cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.prepareStatement("select ? from sys.cluster");
            p1.setInt(1, 20);
            ResultSet resultSet = p1.executeQuery();
            /*
             * This execute results in the following messages:
             *
             *      method=parse stmtName=S_1 query=select $1 from sys.cluster paramTypes=[integer]
             *      method=describe type=S portalOrStatement=S_1
             *      method=sync
             *      method=bind portalName= statementName=S_1 params=[20]
             *      method=describe type=P portalOrStatement=
             *      method=execute portalName= maxRows=0
             *      method=sync
             *
             * The tests makes sure that it works even though the describe can't analyze the statement (because of missing params)
             */
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is</b></font>(20));
        }
    }

    @Test
    public void testWriteOperationsWithoutAutocommitAndCommitAndRollback() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(false);
            try (Statement statement = conn.createStatement()) {
                statement.executeUpdate("create table t (x int) with (number_of_replicas = 0)");
            }
            try (PreparedStatement stmt = conn.prepareStatement("insert into t (x) values (1), (2)")) {
                stmt.executeUpdate();
            }
            try (Statement statement = conn.createStatement()) {
                statement.executeUpdate("refresh table t");
            }
<a name="20"></a>
            conn.commit();

            try (Statement statement = conn.createStatement()) <font color="#4e9258"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
                // no error because table was created
                ResultSet resultSet = statement.executeQuery("select * from t");
                assertThat(resultSet.next(), is(true));
                assertThat(resultSet.next(), is(true));
            }</b></font>
        }
    }

    @Test
<a name="31"></a>    public void testNoAutoCommit() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(false);
            ResultSet resultSet = <font color="#3ea99f"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.prepareStatement("select name from sys.cluster").executeQuery();
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getString(1), Matchers.startsWith("SUITE-TEST_WORKER"));
        }</b></font>
    }

    @Test
    public void test_char_types_arrays() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.createStatement().executeUpdate(
                "CREATE TABLE t (" +
                "   chars array(byte)," +
                "   strings array(text)) " +
                "WITH (number_of_replicas = 0)");

            PreparedStatement preparedStatement = conn.prepareStatement(
                "INSERT INTO t (chars, strings) VALUES (?, ?)");
            preparedStatement.setArray(1, conn.createArrayOf("char", new Byte[]{'c', '3'}));
            preparedStatement.setArray(2, conn.createArrayOf("varchar", new String[]{"fo,o", "bar"}));
<a name="33"></a>            preparedStatement.executeUpdate();
            conn.createStatement().execute("REFRESH TABLE t");

            ResultSet resultSet = <font color="#736aff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery("SELECT chars, strings FROM t");
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getArray(1).getArray(), is</b></font>(new String[]{"99", "51"}));
            assertThat(resultSet.getArray(2).getArray(), is(new String[]{"fo,o", "bar"}));
        } catch (BatchUpdateException e) {
            throw e.getNextException();
        }
    }

    @Test
    public void test_numeric_types_arrays() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.createStatement().executeUpdate(
                "CREATE TABLE t (" +
                "   ints array(int)," +
                "   floats array(float)" +
                ") " +
                "WITH (number_of_replicas = 0)");

            PreparedStatement preparedStatement = conn.prepareStatement(
                "INSERT INTO t (ints, floats) VALUES (?, ?)");
            preparedStatement.setArray(1, conn.createArrayOf("int4", new Integer[]{10, 20}));
            preparedStatement.setArray(2, conn.createArrayOf("float4", new Float[]{1.2f, 3.5f}));
<a name="32"></a>            preparedStatement.executeUpdate();
            conn.createStatement().execute("REFRESH TABLE t");

            ResultSet rs = <font color="#5b8daf"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery("SELECT ints, floats FROM t");
            assertThat(rs.next(), is(true));
            assertThat(rs.getArray(1).getArray(), is</b></font>(new Integer[]{10, 20}));
            assertThat(rs.getArray(2).getArray(), is(new Float[]{1.2f, 3.5f}));
        } catch (BatchUpdateException e) {
            throw e.getNextException();
        }
    }

    @Test
    public void test_geo_types_arrays() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.createStatement().execute(
                "CREATE TABLE t (" +
                "   geo_points array(geo_point)," +
                "   geo_shapes array(geo_shape)" +
                ") " +
                "WITH (number_of_replicas = 0)");

            PreparedStatement preparedStatement = conn.prepareStatement(
                "INSERT INTO t (geo_points, geo_shapes) VALUES (?, ?)");
            preparedStatement.setArray(1, conn.createArrayOf(
                "point",
                new PGpoint[]{new PGpoint(1.1, 2.2), new PGpoint(3.3, 4.4)}));
            preparedStatement.setArray(2, conn.createArrayOf(
                "json",
                new Object[]{
                    DataTypes.STRING.implicitCast(
                        Map.of(
                            "coordinates", new double[][]{{0, 0}, {1, 1}},
                            "type", "LineString"
<a name="8"></a>                        )
                    )
                }));
            <font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>preparedStatement.executeUpdate();
            conn.createStatement().execute("REFRESH TABLE t");

            ResultSet rs = conn.createStatement().executeQuery("SELECT geo_points, geo_shapes FROM t");
            assertThat(rs.next(), is(true));
            assertThat(
                (Object[]) rs.getArray(1).getArray(),
                arrayContaining(new</b></font> PGpoint(1.1, 2.2), new PGpoint(3.3, 4.4)));

            var shapeObject = new PGobject();
            shapeObject.setType("json");
            String shape = "{\"coordinates\":[[0.0,0.0],[1.0,1.0]],\"type\":\"LineString\"}";
            shapeObject.setValue(shape);
            assertThat((Object[]) rs.getArray(2).getArray(), arrayContaining(shape));
        } catch (BatchUpdateException e) {
            throw e.getNextException();
        }
    }

    @Test
    public void testFetchSize() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.createStatement().executeUpdate("create table t (x int) with (number_of_replicas = 0)");
            ensureGreen();

            PreparedStatement preparedStatement = conn.prepareStatement("insert into t (x) values (?)");
            for (int i = 0; i &lt; 20; i++) {
                preparedStatement.setInt(1, i);
                preparedStatement.addBatch();
            }
            preparedStatement.executeBatch();

            conn.createStatement().executeUpdate("refresh table t");
            conn.setAutoCommit(false);
            try (Statement st = conn.createStatement()) {
                st.setFetchSize(2);
                try (ResultSet resultSet = st.executeQuery("select x from t")) {
                    List&lt;Integer&gt; result = new ArrayList&lt;&gt;();
                    while (resultSet.next()) {
                        result.add(resultSet.getInt(1));
                    }
                    Collections.sort(result);
                    assertThat(result, Matchers.contains(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19));
                }
            }
        }
    }

    @Test
    public void test_query_inbetween_suspended_fetch_operation() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.createStatement().executeUpdate("create table t (x int) with (number_of_replicas = 0)");
            PreparedStatement preparedStatement = conn.prepareStatement("insert into t (x) values (?)");
            for (int i = 0; i &lt; 6; i++) {
                preparedStatement.setInt(1, i);
                preparedStatement.addBatch();
            }
            preparedStatement.executeBatch();

            conn.createStatement().executeUpdate("refresh table t");
            conn.setAutoCommit(false);
            try (Statement st = conn.createStatement()) {
                st.setFetchSize(2);
                try (ResultSet xResults = st.executeQuery("select x from t")) {
<a name="29"></a>                    List&lt;Integer&gt; result = new ArrayList&lt;&gt;();
                    while (xResults.next()) {
                        if (result.size() == 3) {
                            var select30Result = <font color="#af7a82"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery("select 30");
                            assertThat(select30Result.next(), is(true));
                            assertThat(select30Result.getInt(1), is(30));
                        }</b></font>
                        result.add(xResults.getInt(1));
                    }
                    Collections.sort(result);
                    assertThat(result, Matchers.contains(0, 1, 2, 3, 4, 5));
                }
            }
        }
    }

    @Test
    public void testCloseConnectionWithUnfinishedResultSetDoesNotLeaveAnyPendingOperations() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(false);
            try (Statement statement = conn.createStatement()) {
                statement.setFetchSize(2);
                try (ResultSet resultSet = statement.executeQuery("select mountain from sys.summits")) {
                    resultSet.next();
                    resultSet.next();
                }
            }
        }

        // The client closes connections lazy, so the statement issued below may arrive on the server *before*
        // the previous connection is closed, so it may see the previous operation -&gt; use assertBusy
        assertBusy(() -&gt; {
            try {
                try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
                    String q =
                        "SELECT j.stmt || '-' || o.name FROM sys.operations AS o, sys.jobs AS j WHERE o.job_id = j.id" +
                        " and j.stmt = ?";
                    PreparedStatement statement = conn.prepareStatement(q);
                    statement.setString(1, "select mountain from sys.summits");
                    ResultSet rs = statement.executeQuery();
                    List&lt;String&gt; operations = new ArrayList&lt;&gt;();
                    while (rs.next()) {
                        operations.add(rs.getString(1));
                    }
                    assertThat(operations, Matchers.empty());
                }
            } catch (SQLException e) {
                throw new RuntimeException(e);
            }
        });
    }

    @Test
    public void testCreateNewStatementAfterUnfinishedResultSet() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties);
            Statement statement = conn.createStatement()) {
            conn.setAutoCommit(false);
            statement.setFetchSize(2);
            try (ResultSet resultSet = statement.executeQuery("select mountain from sys.summits")) {
                resultSet.next();
                resultSet.next();
            }
            conn.setAutoCommit(true);
            statement.setFetchSize(0);
            try (ResultSet resultSet = statement.executeQuery("select mountain from sys.summits")) {
                while (resultSet.next()) {
                    assertFalse(resultSet.getString(1).isEmpty());
                }
            }
        }
    }

    @Test
    public void testSelectPreparedStatement() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(true);
            PreparedStatement preparedStatement = conn.prepareStatement("select name from sys.cluster");
            ResultSet resultSet = preparedStatement.executeQuery();
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getString(1), Matchers.startsWith("SUITE-TEST_WORKER"));
        }
    }

<a name="7"></a>    @Test
    public void testExecuteBatch() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.setAutoCommit(true);

            Statement stmt = conn.createStatement();
            stmt.executeUpdate("create table t (x string, b boolean) with (number_of_replicas = 0)");
            ensureYellow();

            PreparedStatement preparedStatement = conn.prepareStatement("insert into t (x, b) values (?, ?)");
            preparedStatement.setString(1, "Arthur");
            preparedStatement.setBoolean(2, true);
            preparedStatement.addBatch();

            preparedStatement.setString(1, "Trillian");
            preparedStatement.setBoolean(2, false);
            preparedStatement.addBatch();

            int[] results = preparedStatement.executeBatch()</b></font>;
            assertThat(results, is(new int[]{1, 1}));
        }
    }

    @Test
<a name="9"></a>    public void testExecuteBatchWithOneFailingAndNothingExecuted() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            Statement stmt = conn.createStatement();
            <font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>stmt.executeUpdate("create table t (x int) with (number_of_replicas = 0)");
            PreparedStatement preparedStatement = conn.prepareStatement("insert into t (x) values (cast(? as integer))");
            preparedStatement.setString(1, Integer.toString(1));
            preparedStatement.addBatch();

            preparedStatement.setString(1, "foobar");
            preparedStatement.addBatch();

            preparedStatement.setString(1, Integer.toString(3));
            preparedStatement.addBatch();

<a name="28"></a>            assertThat(preparedStatement.executeBatch(), is</b></font>(new int[]{0, 0, 0}));

            conn.createStatement().executeUpdate("refresh table t");
            ResultSet rs = <font color="#717d7d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery("select count(*) from t");
            assertThat(rs.next(), is(true));
            assertThat(rs.getInt(1), is(0));
        }</b></font>
    }

    @Test
    public void testExecuteBatchWithOneRuntimeFailure() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
<a name="16"></a>            Statement stmt = conn.createStatement();
            stmt.executeUpdate("create table t (id int primary key, x int) with (number_of_replicas = 0)");
            ensureYellow();
            <font color="#2981b2"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>PreparedStatement preparedStatement = conn.prepareStatement("insert into t (id, x) values (?, ?)");
            preparedStatement.setInt(1, 1);
            preparedStatement.setInt(2, 0);
            preparedStatement.addBatch();

            preparedStatement.setInt(1, 2);
            preparedStatement.setInt(2, 10);
            preparedStatement.addBatch();

            assertThat(preparedStatement.executeBatch(), is</b></font>(new int[]{1, 1}));
            conn.createStatement().executeUpdate("refresh table t");

            preparedStatement = conn.prepareStatement("update t set x = log(x) where id = ?");
            preparedStatement.setInt(1, 1);
            preparedStatement.addBatch();

<a name="3"></a>            preparedStatement.setInt(1, 2);
            preparedStatement.addBatch();
            assertThat(preparedStatement.executeBatch(), is(new int[]{0, 1}));
            <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeUpdate("refresh table t");

            ResultSet rs = conn.createStatement().executeQuery("select x from t order by id");
            assertThat(rs.next(), is(true));
            assertThat(rs.getInt(1), is(0)); // log(0) is an error - the update failed and the value remains unchanged

            assertThat(rs.next(), is(true));
            assertThat(rs.getInt</b></font>(1), is(1)); // log(10) -&gt; 1
        }
    }

    @Test
    public void testExecuteBatchWithDifferentStatements() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(true);
            Statement stmt = conn.createStatement();
            stmt.executeUpdate("create table t (x int) with (number_of_replicas = 0)");
            ensureYellow();

            Statement statement = conn.createStatement();
            statement.addBatch("insert into t (x) values (1)");
            statement.addBatch("insert into t (x) values (2), (3)");

            int[] results = statement.executeBatch();
<a name="15"></a>            assertThat(results, is(new int[]{1, 2}));

            statement.executeUpdate("refresh table t");
            ResultSet resultSet = <font color="#f52887"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>statement.executeQuery("select * from t order by x");
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is(1));

            // add another batch
            statement.addBatch("insert into t (x) values (3)");

            // only the batches after last execution will be executed
            results = statement.executeBatch();
            assertThat(results, is</b></font>(new int[]{1}));

            statement.executeUpdate("refresh table t");
            resultSet = statement.executeQuery("select * from t order by x desc");
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getInt(1), is(3));
        }
    }

<a name="17"></a>    @Test
    public void test_execute_batch_fails_with_read_operations() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            <font color="#3090c7"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.setAutoCommit(true);
            Statement stmt = conn.createStatement();
            stmt.executeUpdate("create table t (x int) with (number_of_replicas = 0)");
            Statement statement = conn.createStatement();
            statement.addBatch("insert into t(x) values(1), (2)");
            statement.addBatch("refresh table t");
            statement.addBatch("select count(*) from t");

            Assertions.assertThrows(BatchUpdateException.class,
                                    () -&gt; statement.executeBatch</b></font>(),
                                    "Only write operations are allowed in Batch statements"
            );
        }
    }

<a name="1"></a>    @Test
    public void testCreateInsertSelectStringAndTimestamp() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.setAutoCommit(true);
            Statement statement = conn.createStatement();
            assertThat(statement.executeUpdate(
                "create table t (" +
                "   x string," +
                "   ts timestamp with time zone" +
                ") with (number_of_replicas = 0)"), is(1));
            ensureYellow();

            assertThat(statement.executeUpdate("insert into t (x, ts) values ('Marvin', '2016-05-14'), ('Trillian', '2016-06-28')"), is(2));
            assertThat(statement.executeUpdate("refresh table t"), is(1));

            statement.executeQuery("select x, ts from t order by x");
<a name="24"></a>            ResultSet resultSet = statement.getResultSet();
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getString(1), is("Marvin"));
            assertThat(resultSet.getTimestamp(2), is</b></font>(<font color="#79764d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>new Timestamp(1463184000000L)));

            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getString(1), is("Trillian"));
            assertThat(resultSet.getTimestamp(2), is</b></font>(new Timestamp(1467072000000L)));
        }
    }

    @Test
    public void testSelectWithParameters() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(true);
            PreparedStatement preparedStatement = conn.prepareStatement("select name from sys.cluster where name like ?");
            preparedStatement.setString(1, "SUITE%");
            ResultSet resultSet = preparedStatement.executeQuery();
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getString(1), Matchers.startsWith("SUITE-TEST_WORKER"));
        }
    }

    @Test
    public void testStatementThatResultsInParseError() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(true);
            PreparedStatement stmt = conn.prepareStatement("select name fro sys.cluster");
            assertThrowsMatches(() -&gt; stmt.executeQuery(),
                         isPGError(containsString("mismatched input 'sys'"), INTERNAL_ERROR));
        }
    }

    @Test
    public void testStatementReadOnlyFailure() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RO), properties)) {
            conn.setAutoCommit(true);
            PreparedStatement stmt = conn.prepareStatement("create table test(a integer)");
            assertThrowsMatches(() -&gt; stmt.executeQuery(),
                         isPGError(containsString("Only read operations allowed on this node"), INTERNAL_ERROR));
        }
    }

    @Test
    public void testErrorRecoveryFromErrorsOutsideSqlOperations() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.setAutoCommit(true);
<a name="14"></a>            PreparedStatement stmt = conn.prepareStatement("select cast([10.3, 20.2] as integer) " +
                                                           "from information_schema.tables");
            try {
                <font color="#842dce"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>stmt.executeQuery();
                fail("Should've raised PSQLException");
            } catch (PSQLException e) {
                assertThat(e.getMessage(), containsString("Cannot cast expressions from type `double precision_array` to type `integer`"));
            }

            assertSelectNameFromSysClusterWorks</b></font>(conn);
        }
    }

    @Test
    public void testErrorDetailsFromStackTraceInErrorResponse() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
<a name="2"></a>            conn.setAutoCommit(true);
            conn.createStatement().executeUpdate("select sqrt('abcd') from sys.cluster");
        } catch (PSQLException e) {
            <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertThat(e.getServerErrorMessage().getFile(), not(is(emptyOrNullString())));
            assertThat(e.getServerErrorMessage().getRoutine(), not(is(emptyOrNullString())));
            assertThat(e.getServerErrorMessage().getLine(), greaterThan(0));
        }</b></font>
    }

    @Test
    public void testGetPostgresPort() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            ResultSet resultSet = conn.createStatement().executeQuery("select port['psql'] from sys.nodes limit 1");
            assertThat(resultSet.next(), is(true));
            Integer port = resultSet.getInt(1);

            ArrayList&lt;Integer&gt; actualPorts = new ArrayList&lt;&gt;();
            for (PostgresNetty postgresNetty : internalCluster().getInstances(PostgresNetty.class)) {
                actualPorts.add(postgresNetty.boundAddress().publishAddress().getPort());
            }
            assertThat(port, Matchers.isOneOf(actualPorts.toArray(new Integer[0])));
        }
    }

<a name="12"></a>    @Test
    public void testSetSchemaOnSession() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            <font color="#571b7e"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.setAutoCommit(true);

            conn.createStatement().execute("set session search_path to bar");
            conn.createStatement().executeUpdate("create table foo (id int) with (number_of_replicas=0)");

            conn.createStatement().execute("set session search_path to DEFAULT");
            assertThrowsMatches(() -&gt; conn.createStatement().execute("select * from foo"),
                         isPGError(is("Relation 'foo' unknown"), UNDEFINED_TABLE));
        }</b></font>
    }

<a name="11"></a>    @Test
    public void testSetMultipleSchemasOnSession() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            <font color="#b041ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.setAutoCommit(true);

            conn.createStatement().execute("set session search_path to bar ,custom");
            conn.createStatement().executeUpdate("create table foo (id int) with (number_of_replicas=0)");
            conn.createStatement().executeQuery("select * from bar.foo");

            assertThrowsMatches(() -&gt; conn.createStatement().execute("select * from custom.foo"),
                         isPGError(is("Schema 'custom' unknown"), INTERNAL_ERROR));
        }</b></font>
    }

    @Test
    public void testCountDistinctFromJoin() throws Exception {
<a name="27"></a>        // Regression test for a bug where the Postgres-ResultReceiver received types which were a view on symbols which
        // were mutated during analysis/planning of a join - due to that the types changed which led to a ClassCastException
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            ResultSet resultSet = <font color="#e77471"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.createStatement().executeQuery(
                "select count (distinct 74) from unnest([1, 2]) t1 cross join unnest([2, 3]) t2");
            assertThat(resultSet.next(), is(true));
            assertThat(resultSet.getLong(1), is(1L));
        }</b></font>
    }

    @Test
    public void testMultiStatementQuery() throws Exception {
        Properties properties = new Properties(this.properties);
        // multi query support is only available in simple query mode
        properties.setProperty("preferQueryMode", "simple");
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            Statement statement = conn.createStatement();
            statement.execute("set search_path to 'hoschi';" +
                              "create table t (id int);" +
<a name="25"></a>                              "insert into t values (42);" +
                              "refresh table t");
            statement = conn.createStatement();
            ResultSet resultSet = <font color="#5eac10"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>statement.executeQuery("select * from hoschi.t");
            resultSet.next();
            assertThat(resultSet.getInt(1), is(42));
            assertThat(resultSet.isLast(), is(true));
        }</b></font>
    }

    @Test
    public void testRepeatedFetchDoesNotLeakSysJobsLog() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.prepareStatement(
                "create table t (" +
                "   x int, ts timestamp with time zone" +
                ") clustered into 1 shards " +
                "with (number_of_replicas = 0)").execute();
            PreparedStatement preparedStatement = conn.prepareStatement("insert into t (x, ts) values (?, ?)");
            for (int i = 0; i &lt; 20; i++) {
                preparedStatement.setInt(1, i);
                preparedStatement.setLong(2, 1541548800000L);
                preparedStatement.addBatch();
            }
            preparedStatement.executeBatch();
            conn.prepareStatement("refresh table t").execute();

            conn.setAutoCommit(false);
            PreparedStatement stmt = conn.prepareStatement("SELECT x FROM t WHERE ts &gt; ? ORDER BY ts ASC LIMIT 5");
            for (int i = 0; i &lt; 5; i++) {
                stmt.setInt(1, i);
                stmt.setFetchSize(5);
                ResultSet resultSet = stmt.executeQuery();
                while (resultSet.next()) {
                    resultSet.getInt(1);
                }
            }
        }
        for (JobsLogService jobsLogService : internalCluster().getDataNodeInstances(JobsLogService.class)) {
            assertBusy(() -&gt; assertThat(jobsLogService.get().activeJobs(), emptyIterable()));
        }
    }

    @Test
<a name="18"></a>    public void test_insert_with_on_conflict_do_nothing_batch_error_resp_is_0_for_conflicting_items() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            conn.prepareStatement("create table t (id int primary key) clustered into 1 shards").execute();
            <font color="#800517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>conn.prepareStatement("insert into t (id) (select col1 from generate_series(1, 3))").execute();

            PreparedStatement stmt = conn.prepareStatement("insert into t (id) values (?) on conflict (id) do nothing");
            stmt.setInt(1, 4);
            stmt.addBatch();
            stmt.setInt(1, 1);
            stmt.addBatch();

            int[] result = stmt.executeBatch();
            assertThat(result.length, is</b></font>(2));
            assertThat(result[0], is(1));
            assertThat(result[1], is(0));
        }
    }

    @Test
    public void test_all_system_columns_can_be_queried_via_postgres() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            // Create a table to also have some shards and sys.allocations, sys.heatlh, sys.shards, etc are not empty.
            conn.prepareStatement("create table tbl (x int)").execute();

            ResultSet result = conn.prepareStatement(
                "SELECT " +
                "   table_schema, " +
                "   table_name," +
                "   collect_set(column_name) as columns " +
                "FROM " +
                "   information_schema.columns " +
                "WHERE " +
                "   table_schema IN ('sys', 'pg_catalog', 'information_schema') " +
                "GROUP BY " +
                "   1, 2").executeQuery();
            while (result.next()) {
                String schema = result.getString(1);
                String table = result.getString(2);

                Array columns = result.getArray(3);
                StringJoiner columnList = new StringJoiner(", ");
                for (String column : ((String[]) columns.getArray())) {
                    if (column.contains("[")) {
                        columnList.add(column);
                    } else {
                        columnList.add('"' + column + '"');
                    }
                }
                String statement = String.format(
                    Locale.ENGLISH,
                    "SELECT %s FROM \"%s\".\"%s\"",
                    columnList.toString(),
                    schema,
                    table
                );
                // This must not throw a ClassCastException
                conn.prepareStatement(statement).executeQuery();
            }
        }
    }

    @Test
    @UseJdbc(0) // Simulate explicit call by a user through HTTP iface
    public void test_proper_termination_of_deallocate_through_http_call() throws Exception {
       execute("DEALLOCATE ALL");
       assertThat(response.rowCount(), is (0L));
    }

    @Test
    public void test_getProcedureColumns() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            var results = conn.getMetaData().getProcedureColumns("", "", "", "");
            assertThat(results.next(), is(true));
            assertThat(results.getString(3), is("_pg_expandarray"));
        }
    }

    @Test
    public void test_each_non_array_pg_type_entry_can_be_joined_with_pg_proc() throws Exception {
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            PreparedStatement stmt = conn.prepareStatement(
                "SELECT pg_type.oid, pg_type.typname, pg_proc.proname " +
                "FROM pg_catalog.pg_type LEFT OUTER JOIN pg_catalog.pg_proc ON pg_proc.oid = pg_type.typreceive " +
                "WHERE pg_type.typarray &lt;&gt; 0");
            ResultSet result = stmt.executeQuery();
            while (result.next()) {
                assertThat(
                    "There must be an entry for `" + result.getInt(1) + "/" + result.getString(2) + "` in pg_proc",
                    result.getString(3),
                    Matchers.notNullValue(String.class)
                );
            }
        }
    }

    @Test
    public void test_parse_failures_in_simple_protocol_mode_are_propagated_to_client() throws Exception {
        // regression test; used to get stuck
        Properties properties = new Properties();
        properties.setProperty("user", "crate");
        properties.setProperty(PGProperty.PREFER_QUERY_MODE.getName(), PreferQueryMode.SIMPLE.value());
        try (Connection conn = DriverManager.getConnection(url(RW), properties)) {
            Statement statement = conn.createStatement();
            assertThrows(PSQLException.class, () -&gt; statement.execute("create index invalid_statement"));
            ResultSet result = statement.executeQuery("select 1");
            assertThat(result.next(), is(true));
            assertThat(result.getInt(1), is(1));
        }
    }

    @Test
    public void test_insert_from_unnest_returning_which_inserts_duplicate_keys() throws Exception {
        Properties properties = new Properties();
        properties.setProperty("user", "crate");
        try (var conn = DriverManager.getConnection(url(RW), properties)) {
            var statement = conn.createStatement();
            statement.execute("create table tbl (id bigint primary key, val text)");
            var textGenerator = DataTypeTesting.getDataGenerator(DataTypes.STRING);
            var insertUnnest = conn.prepareStatement(
                "insert into tbl (id, val) (select id, val from unnest(?, ?) as t (id, val)) returning _id");

            for (int iteration = 0; iteration &lt; 2; iteration++) {
                var ids = new Object[10];
                var values = new Object[10];
                for (int i = 0; i &lt; 10; i++) {
                    ids[i] = i;
                    values[i] = textGenerator.get();
                }
                insertUnnest.setObject(1, conn.createArrayOf("bigint", ids));
                insertUnnest.setObject(2, conn.createArrayOf("text", values));
                var result = insertUnnest.executeQuery();
                int numResults = 0;
                while (result.next()) {
                    numResults++;
                }
                if (iteration == 0) {
                    assertThat(numResults, is(10));
                } else {
                    assertThat(numResults, is(0));
                }
            }
        }
    }

    @Test
    public void test_metadata_calls_do_not_query_pg_catalog_tables_repeatedly() throws Exception {
        var properties = new Properties();
        properties.put("user", "crate");
        properties.put("password", "");
        try (var conn = DriverManager.getConnection(url(RW), properties)) {
            var stmt = conn.createStatement();
            stmt.execute("create table uservisits (\"adRevenue\" float, \"cCode\" text, \"duration\" float)");

            conn.setAutoCommit(false);
            stmt = conn.createStatement();
            stmt.setFetchSize(101);
            ResultSet result = stmt.executeQuery(
                    "select avg(\"adRevenue\") from uservisits group by \"cCode\", \"duration\" limit 100");

            long numQueries = getNumQueriesFromJobsLogs();
            ResultSetMetaData metaData = result.getMetaData();
            for (int i = 0; i &lt; 50; i++) {
                // These calls must not invoke extra queries
                metaData.isAutoIncrement(1);
            }
            assertThat(getNumQueriesFromJobsLogs(), is(numQueries));
            result.close();
        }
    }

    private long getNumQueriesFromJobsLogs() {
        long result = 0;
        Iterable&lt;JobsLogs&gt; jobLogs = internalCluster().getInstances(JobsLogs.class);
        for (JobsLogs jobsLogs : jobLogs) {
            for (var metrics : jobsLogs.metrics()) {
                result += metrics.totalCount();
            }
        }
        return result;
    }

<a name="19"></a>    private void assertSelectNameFromSysClusterWorks(Connection conn) throws SQLException {
        PreparedStatement stmt;// verify that queries can be made after an error occurred
        stmt = conn.prepareStatement("select name from sys.cluster");
        ResultSet resultSet = <font color="#f62817"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>stmt.executeQuery();
        assertThat(resultSet.next(), is(true));
        assertThat(resultSet.getString(1), Matchers.startsWith("SUITE-TEST_WORKER"));
    }
}</b></font>
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
