
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 19, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-Settings.java</h3>
            <pre><code>1  package com.earth2me.essentials;
2  import static com.earth2me.essentials.I18n.tl;
3  import com.earth2me.essentials.commands.IEssentialsCommand;
4  import com.earth2me.essentials.signs.EssentialsSign;
5  import com.earth2me.essentials.signs.Signs;
6  import com.earth2me.essentials.textreader.IText;
7  import com.earth2me.essentials.textreader.SimpleTextInput;
8  import com.earth2me.essentials.utils.FormatUtil;
9  import java.io.File;
10  import java.math.BigDecimal;
11  import java.util.*;
12  import java.util.logging.Level;
13  import java.util.logging.Logger;
14  import net.ess3.api.IEssentials;
15  import org.bukkit.ChatColor;
16  import org.bukkit.command.PluginCommand;
17  import org.bukkit.configuration.ConfigurationSection;
18  import org.bukkit.configuration.MemoryConfiguration;
19  import org.bukkit.event.EventPriority;
20  import org.bukkit.inventory.ItemStack;
21  public class Settings implements net.ess3.api.ISettings
22  {
23  	private final transient EssentialsConf config;
24  	private static final Logger logger = Logger.getLogger("Essentials");
25  	private final transient IEssentials ess;
26  	private boolean metricsEnabled = true;
27  	public Settings(IEssentials ess)
28  	{
29  		this.ess = ess;
30  		config = new EssentialsConf(new File(ess.getDataFolder(), "config.yml"));
31  		config.setTemplateName("/config.yml");
32  		reloadConfig();
33  	}
34  	@Override
35  	public boolean getRespawnAtHome()
36  	{
37  		return config.getBoolean("respawn-at-home", false);
38  	}
39  	@Override
40  	public boolean getUpdateBedAtDaytime()
41  	{
42  		return config.getBoolean("update-bed-at-daytime", true);
43  	}
44  	@Override
45  	public Set<String> getMultipleHomes()
46  	{
47  		final ConfigurationSection section = config.getConfigurationSection("sethome-multiple");
48  		return section == null ? null : section.getKeys(false);
49  	}
50  	@Override
51  	public int getHomeLimit(final User user)
52  	{
53  		int limit = 1;
54  		if (user.isAuthorized("essentials.sethome.multiple"))
55  		{
56  			limit = getHomeLimit("default");
57  		}
58  		final Set<String> homeList = getMultipleHomes();
59  		if (homeList != null)
60  		{
61  			for (String set : homeList)
62  			{
63  				if (user.isAuthorized("essentials.sethome.multiple." + set) && (limit < getHomeLimit(set)))
64  				{
65  					limit = getHomeLimit(set);
66  				}
67  			}
68  		}
69  		return limit;
70  	}
71  	@Override
72  	public int getHomeLimit(final String set)
73  	{
74  		return config.getInt("sethome-multiple." + set, config.getInt("sethome-multiple.default", 3));
75  	}
76  	private int chatRadius = 0;
77  	private int _getChatRadius()
78  	{
79  		return config.getInt("chat.radius", config.getInt("chat-radius", 0));
80  	}
81  	@Override
82  	public int getChatRadius()
83  	{
84  		return chatRadius;
85  	}
86  	private char chatShout = '!';
87  	private char _getChatShout()
88  	{
89  		return config.getString("chat.shout", "!").charAt(0);
90  	}
91  	@Override
92  	public char getChatShout()
93  	{
94  		return chatShout;
95  	}
96  	private char chatQuestion = '?';
97  	private char _getChatQuestion()
98  	{
99  		return config.getString("chat.question", "?").charAt(0);
100  	}
101  	@Override
102  	public char getChatQuestion()
103  	{
104  		return chatQuestion;
105  	}
106  	private boolean teleportSafety;
107  	public boolean _isTeleportSafetyEnabled()
108  	{
109  		return config.getBoolean("teleport-safety", true);
110  	}
111  	@Override
112  	public boolean isTeleportSafetyEnabled()
113  	{
114  		return teleportSafety;
115  	}
116  	@Override
117  	public double getTeleportDelay()
118  	{
119  		return config.getDouble("teleport-delay", 0);
120  	}
121  	@Override
122  	public int getOversizedStackSize()
123  	{
124  		return config.getInt("oversized-stacksize", 64);
125  	}
126  	@Override
127  	public int getDefaultStackSize()
128  	{
129  		return config.getInt("default-stack-size", -1);
130  	}
131  	@Override
132  	public BigDecimal getStartingBalance()
133  	{
134  		return config.getBigDecimal("starting-balance", BigDecimal.ZERO);
135  	}
136  	@Override
137  	public boolean isCommandDisabled(final IEssentialsCommand cmd)
138  	{
139  		return isCommandDisabled(cmd.getName());
140  	}
141  	private Set<String> disabledCommands = new HashSet<String>();
142  	@Override
143  	public boolean isCommandDisabled(String label)
144  	{
145  		return disabledCommands.contains(label);
146  	}
147  	private Set<String> getDisabledCommands()
148  	{
149  		Set<String> disCommands = new HashSet<String>();
150  		for (String c : config.getStringList("disabled-commands"))
151  		{
152  			disCommands.add(c.toLowerCase(Locale.ENGLISH));
153  		}
154  		for (String c : config.getKeys(false))
155  		{
156  			if (c.startsWith("disable-"))
157  			{
158  				disCommands.add(c.substring(8).toLowerCase(Locale.ENGLISH));
159  			}
160  		}
161  		return disCommands;
162  	}
163  	@Override
164  	public boolean isPlayerCommand(String label)
165  	{
166  		for (String c : config.getStringList("player-commands"))
167  		{
168  			if (!c.equalsIgnoreCase(label))
169  			{
170  				continue;
171  			}
172  			return true;
173  		}
174  		return false;
175  	}
176  	@Override
177  	public boolean isCommandOverridden(String name)
178  	{
179  		for (String c : config.getStringList("overridden-commands"))
180  		{
181  			if (!c.equalsIgnoreCase(name))
182  			{
183  				continue;
184  			}
185  			return true;
186  		}
187  		return config.getBoolean("override-" + name.toLowerCase(Locale.ENGLISH), false);
188  	}
189  	private ConfigurationSection commandCosts;
190  	@Override
191  	public BigDecimal getCommandCost(IEssentialsCommand cmd)
192  	{
193  		return getCommandCost(cmd.getName());
194  	}
195  	private ConfigurationSection _getCommandCosts()
196  	{
197  		if (config.isConfigurationSection("command-costs"))
198  		{
199  			final ConfigurationSection section = config.getConfigurationSection("command-costs");
200  			final ConfigurationSection newSection = new MemoryConfiguration();
201  			for (String command : section.getKeys(false))
202  			{
203  				if (command.charAt(0) == '/')
204  				{
205  					ess.getLogger().warning("Invalid command cost. '" + command + "' should not start with '/'.");
206  				}
207  				if (section.isDouble(command))
208  				{
209  					newSection.set(command.toLowerCase(Locale.ENGLISH), section.getDouble(command));
210  				}
211  				else if (section.isInt(command))
212  				{
213  					newSection.set(command.toLowerCase(Locale.ENGLISH), (double)section.getInt(command));
214  				}
215  				else if (section.isString(command))
216  				{
217  					String costString = section.getString(command);
218  					try
219  					{
220  						double cost = Double.parseDouble(costString.trim().replace(getCurrencySymbol(), "").replaceAll("\\W", ""));
221  						newSection.set(command.toLowerCase(Locale.ENGLISH), cost);
222  					}
223  					catch (NumberFormatException ex)
224  					{
<span onclick='openModal()' class='match'>225  						ess.getLogger().warning("Invalid command cost for: " + command + " (" + costString + ")");
226  					}
</span>227  				}
228  				else
229  				{
230  					ess.getLogger().warning("Invalid command cost for: " + command);
231  				}
232  			}
233  			return newSection;
234  		}
235  		return null;
236  	}
237  	@Override
238  	public BigDecimal getCommandCost(String name)
239  	{
240  		name = name.replace('.', '_').replace('/', '_');
241  		if (commandCosts != null)
242  		{
243  			return EssentialsConf.toBigDecimal(commandCosts.getString(name), BigDecimal.ZERO);
244  		}
245  		return BigDecimal.ZERO;
246  	}
247  	private Set<String> socialSpyCommands = new HashSet<String>();
248  	private Set<String> _getSocialSpyCommands()
249  	{
250  		Set<String> socialspyCommands = new HashSet<String>();
251  		if (config.isList("socialspy-commands"))
252  		{
253  			for (String c : config.getStringList("socialspy-commands"))
254  			{
255  				socialspyCommands.add(c.toLowerCase(Locale.ENGLISH));
256  			}
257  		}
258  		else
259  		{
260  			socialspyCommands.addAll(Arrays.asList("msg", "r", "mail", "m", "whisper", "emsg", "t", "tell", "er", "reply", "ereply", "email", "action", "describe", "eme", "eaction", "edescribe", "etell", "ewhisper", "pm"));
261  		}
262  		return socialspyCommands;
263  	}
264  	@Override
265  	public Set<String> getSocialSpyCommands()
266  	{
267  		return socialSpyCommands;
268  	}
269  	private String nicknamePrefix = "~";
270  	private String _getNicknamePrefix()
271  	{
272  		return config.getString("nickname-prefix", "~");
273  	}
274  	@Override
275  	public String getNicknamePrefix()
276  	{
277  		return nicknamePrefix;
278  	}
279  	@Override
280  	public double getTeleportCooldown()
281  	{
282  		return config.getDouble("teleport-cooldown", 0);
283  	}
284  	@Override
285  	public double getHealCooldown()
286  	{
287  		return config.getDouble("heal-cooldown", 0);
288  	}
289  	private ConfigurationSection kits;
290  	private ConfigurationSection _getKits()
291  	{
292  		if (config.isConfigurationSection("kits"))
293  		{
294  			final ConfigurationSection section = config.getConfigurationSection("kits");
295  			final ConfigurationSection newSection = new MemoryConfiguration();
296  			for (String kitItem : section.getKeys(false))
297  			{
298  				if (section.isConfigurationSection(kitItem))
299  				{
300  					newSection.set(kitItem.toLowerCase(Locale.ENGLISH), section.getConfigurationSection(kitItem));
301  				}
302  			}
303  			return newSection;
304  		}
305  		return null;
306  	}
307  	@Override
308  	public ConfigurationSection getKits()
309  	{
310  		return kits;
311  	}
312  	@Override
313  	public Map<String, Object> getKit(String name)
314  	{
315  		name = name.replace('.', '_').replace('/', '_');
316  		if (getKits() != null)
317  		{
318  			final ConfigurationSection kits = getKits();
319  			if (kits.isConfigurationSection(name))
320  			{
321  				return kits.getConfigurationSection(name).getValues(true);
322  			}
323  		}
324  		return null;
325  	}
326  	private ChatColor operatorColor = null;
327  	@Override
328  	public ChatColor getOperatorColor()
329  	{
330  		return operatorColor;
331  	}
332  	private ChatColor _getOperatorColor()
333  	{
334  		String colorName = config.getString("ops-name-color", null);
335  		if (colorName == null)
336  		{
337  			return ChatColor.DARK_RED;
338  		}
339  		if ("none".equalsIgnoreCase(colorName) || colorName.isEmpty())
340  		{
341  			return null;
342  		}
343  		try
344  		{
345  			return ChatColor.valueOf(colorName.toUpperCase(Locale.ENGLISH));
346  		}
347  		catch (IllegalArgumentException ex)
348  		{
349  		}
350  		return ChatColor.getByChar(colorName);
351  	}
352  	@Override
353  	public int getSpawnMobLimit()
354  	{
355  		return config.getInt("spawnmob-limit", 10);
356  	}
357  	@Override
358  	public boolean showNonEssCommandsInHelp()
359  	{
360  		return config.getBoolean("non-ess-in-help", true);
361  	}
362  	@Override
363  	public boolean hidePermissionlessHelp()
364  	{
365  		return config.getBoolean("hide-permissionless-help", true);
366  	}
367  	@Override
368  	public int getProtectCreeperMaxHeight()
369  	{
370  		return config.getInt("protect.creeper.max-height", -1);
371  	}
372  	@Override
373  	public boolean areSignsDisabled()
374  	{
375  		return !signsEnabled;
376  	}
377  	@Override
378  	public long getBackupInterval()
379  	{
380  		return config.getInt("backup.interval", 1440); 
381  	}
382  	@Override
383  	public String getBackupCommand()
384  	{
385  		return config.getString("backup.command", null);
386  	}
387  	private final Map<String, String> chatFormats = Collections.synchronizedMap(new HashMap<String, String>());
388  	@Override
389  	public String getChatFormat(String group)
390  	{
391  		String mFormat = chatFormats.get(group);
392  		if (mFormat == null)
393  		{
394  			mFormat = config.getString("chat.group-formats." + (group == null ? "Default" : group),
395  									   config.getString("chat.format", "&7[{GROUP}]&r {DISPLAYNAME}&7:&r {MESSAGE}"));
396  			mFormat = FormatUtil.replaceFormat(mFormat);
397  			mFormat = mFormat.replace("{DISPLAYNAME}", "%1$s");
398  			mFormat = mFormat.replace("{MESSAGE}", "%2$s");
399  			mFormat = mFormat.replace("{GROUP}", "{0}");
400  			mFormat = mFormat.replace("{WORLD}", "{1}");
401  			mFormat = mFormat.replace("{WORLDNAME}", "{1}");
402  			mFormat = mFormat.replace("{SHORTWORLDNAME}", "{2}");
403  			mFormat = mFormat.replace("{TEAMPREFIX}", "{3}");
404  			mFormat = mFormat.replace("{TEAMSUFFIX}", "{4}");
405  			mFormat = mFormat.replace("{TEAMNAME}", "{5}");
406  			mFormat = "§r".concat(mFormat);
407  			chatFormats.put(group, mFormat);
408  		}
409  		return mFormat;
410  	}
411  	@Override
412  	public boolean getAnnounceNewPlayers()
413  	{
414  		return !config.getString("newbies.announce-format", "-").isEmpty();
415  	}
416  	@Override
417  	public IText getAnnounceNewPlayerFormat()
418  	{
419  		return new SimpleTextInput(FormatUtil.replaceFormat(config.getString("newbies.announce-format", "&dWelcome {DISPLAYNAME} to the server!")));
420  	}
421  	@Override
422  	public String getNewPlayerKit()
423  	{
424  		return config.getString("newbies.kit", "");
425  	}
426  	@Override
427  	public String getNewbieSpawn()
428  	{
429  		return config.getString("newbies.spawnpoint", "default");
430  	}
431  	@Override
432  	public boolean getPerWarpPermission()
433  	{
434  		return config.getBoolean("per-warp-permission", false);
435  	}
436  	@Override
437  	public Map<String, Object> getListGroupConfig()
438  	{
439  		if (config.isConfigurationSection("list"))
440  		{
441  			Map<String, Object> values = config.getConfigurationSection("list").getValues(false);
442  			if (!values.isEmpty())
443  			{
444  				return values;
445  			}
446  		}
447  		Map<String, Object> defaultMap = new HashMap<String, Object>();
448  		if (config.getBoolean("sort-list-by-groups", false))
449  		{
450  			defaultMap.put("ListByGroup", "ListByGroup");
451  		}
452  		else
453  		{
454  			defaultMap.put("Players", "*");
455  		}
456  		return defaultMap;
457  	}
458  	@Override
459  	public void reloadConfig()
460  	{
461  		config.load();
462  		noGodWorlds = new HashSet<String>(config.getStringList("no-god-in-worlds"));
463  		enabledSigns = _getEnabledSigns();
464  		teleportSafety = _isTeleportSafetyEnabled();
465  		teleportInvulnerabilityTime = _getTeleportInvulnerability();
466  		teleportInvulnerability = _isTeleportInvulnerability();
467  		disableItemPickupWhileAfk = _getDisableItemPickupWhileAfk();
468  		registerBackInListener = _registerBackInListener();
469  		cancelAfkOnInteract = _cancelAfkOnInteract();
470  		cancelAfkOnMove = _cancelAfkOnMove() && cancelAfkOnInteract;
471  		getFreezeAfkPlayers = _getFreezeAfkPlayers();
472  		itemSpawnBl = _getItemSpawnBlacklist();
473  		loginAttackDelay = _getLoginAttackDelay();
474  		signUsePerSecond = _getSignUsePerSecond();
475  		kits = _getKits();
476  		chatFormats.clear();
477  		changeDisplayName = _changeDisplayName();
478  		disabledCommands = getDisabledCommands();
479  		nicknamePrefix = _getNicknamePrefix();
480  		operatorColor = _getOperatorColor();
481  		changePlayerListName = _changePlayerListName();
482  		configDebug = _isDebug();
483  		prefixsuffixconfigured = _isPrefixSuffixConfigured();
484  		addprefixsuffix = _addPrefixSuffix();
485  		disablePrefix = _disablePrefix();
486  		disableSuffix = _disableSuffix();
487  		chatRadius = _getChatRadius();
488  		chatShout = _getChatShout();
489  		chatQuestion = _getChatQuestion();
490  		commandCosts = _getCommandCosts();
491  		socialSpyCommands = _getSocialSpyCommands();
492  		warnOnBuildDisallow = _warnOnBuildDisallow();
493  		mailsPerMinute = _getMailsPerMinute();
494  		maxMoney = _getMaxMoney();
495  		minMoney = _getMinMoney();
496  		permissionsLagWarning = _getPermissionsLagWarning();
497  		economyLagWarning = _getEconomyLagWarning();
498  		economyLog = _isEcoLogEnabled();
499  		economyLogUpdate = _isEcoLogUpdateEnabled();
500  		economyDisabled = _isEcoDisabled();
501  		allowSilentJoin = _allowSilentJoinQuit();
502  		customJoinMessage = _getCustomJoinMessage();
503  		isCustomJoinMessage = !customJoinMessage.equals("none");
504  		customQuitMessage = _getCustomQuitMessage();
505  		isCustomQuitMessage = !customQuitMessage.equals("none");
506  	}
507  	private List<Integer> itemSpawnBl = new ArrayList<Integer>();
508  	@Override
509  	public List<Integer> itemSpawnBlacklist()
510  	{
511  		return itemSpawnBl;
512  	}
513  	private List<Integer> _getItemSpawnBlacklist()
514  	{
515  		final List<Integer> epItemSpwn = new ArrayList<Integer>();
516  		if (ess.getItemDb() == null)
517  		{
518  			logger.log(Level.FINE, "Aborting ItemSpawnBL read, itemDB not yet loaded.");
519  			return epItemSpwn;
520  		}
521  		for (String itemName : config.getString("item-spawn-blacklist", "").split(","))
522  		{
523  			itemName = itemName.trim();
524  			if (itemName.isEmpty())
525  			{
526  				continue;
527  			}
528  			try
529  			{
530  				final ItemStack iStack = ess.getItemDb().get(itemName);
531  				epItemSpwn.add(iStack.getTypeId());
532  			}
533  			catch (Exception ex)
534  			{
535  				logger.log(Level.SEVERE, tl("unknownItemInList", itemName, "item-spawn-blacklist"));
536  			}
537  		}
538  		return epItemSpwn;
539  	}
540  	private List<EssentialsSign> enabledSigns = new ArrayList<EssentialsSign>();
541  	private boolean signsEnabled = false;
542  	@Override
543  	public List<EssentialsSign> enabledSigns()
544  	{
545  		return enabledSigns;
546  	}
547  	private List<EssentialsSign> _getEnabledSigns()
548  	{
549  		List<EssentialsSign> newSigns = new ArrayList<EssentialsSign>();
550  		for (String signName : config.getStringList("enabledSigns"))
551  		{
552  			signName = signName.trim().toUpperCase(Locale.ENGLISH);
553  			if (signName.isEmpty())
554  			{
555  				continue;
556  			}
557  			if (signName.equals("COLOR") || signName.equals("COLOUR"))
558  			{
559  				signsEnabled = true;
560  				continue;
561  			}
562  			try
563  			{
564  				newSigns.add(Signs.valueOf(signName).getSign());
565  			}
566  			catch (Exception ex)
567  			{
568  				logger.log(Level.SEVERE, tl("unknownItemInList", signName, "enabledSigns"));
569  				continue;
570  			}
571  			signsEnabled = true;
572  		}
573  		return newSigns;
574  	}
575  	private boolean warnOnBuildDisallow;
576  	private boolean _warnOnBuildDisallow()
577  	{
578  		return config.getBoolean("protect.disable.warn-on-build-disallow", false);
579  	}
580  	@Override
581  	public boolean warnOnBuildDisallow()
582  	{
583  		return warnOnBuildDisallow;
584  	}
585  	private boolean debug = false;
586  	private boolean configDebug = false;
587  	private boolean _isDebug()
588  	{
589  		return config.getBoolean("debug", false);
590  	}
591  	@Override
592  	public boolean isDebug()
593  	{
594  		return debug || configDebug;
595  	}
596  	@Override
597  	public boolean warnOnSmite()
598  	{
599  		return config.getBoolean("warn-on-smite", true);
600  	}
601  	@Override
602  	public boolean permissionBasedItemSpawn()
603  	{
604  		return config.getBoolean("permission-based-item-spawn", false);
605  	}
606  	@Override
607  	public String getLocale()
608  	{
609  		return config.getString("locale", "");
610  	}
611  	@Override
612  	public String getCurrencySymbol()
613  	{
614  		return config.getString("currency-symbol", "$").concat("$").substring(0, 1).replaceAll("[0-9]", "$");
615  	}
616  	@Override
617  	public boolean isTradeInStacks(int id)
618  	{
619  		return config.getBoolean("trade-in-stacks-" + id, false);
620  	}
621  	private boolean economyDisabled = false;
622  	public boolean _isEcoDisabled()
623  	{
624  		return config.getBoolean("disable-eco", false);
625  	}
626  	@Override
627  	public boolean isEcoDisabled()
628  	{
629  		return economyDisabled;
630  	}
631  	@Override
632  	public boolean getProtectPreventSpawn(final String creatureName)
633  	{
634  		return config.getBoolean("protect.prevent.spawn." + creatureName, false);
635  	}
636  	@Override
637  	public List<Integer> getProtectList(final String configName)
638  	{
639  		final List<Integer> list = new ArrayList<Integer>();
640  		for (String itemName : config.getString(configName, "").split(","))
641  		{
642  			itemName = itemName.trim();
643  			if (itemName.isEmpty())
644  			{
645  				continue;
646  			}
647  			ItemStack itemStack;
648  			try
649  			{
650  				itemStack = ess.getItemDb().get(itemName);
651  				list.add(itemStack.getTypeId());
652  			}
653  			catch (Exception ex)
654  			{
655  				logger.log(Level.SEVERE, tl("unknownItemInList", itemName, configName));
656  			}
657  		}
658  		return list;
659  	}
660  	@Override
661  	public String getProtectString(final String configName)
662  	{
663  		return config.getString(configName, null);
664  	}
665  	@Override
666  	public boolean getProtectBoolean(final String configName, boolean def)
667  	{
668  		return config.getBoolean(configName, def);
669  	}
670  	private static final BigDecimal MAXMONEY = new BigDecimal("10000000000000");
671  	private BigDecimal maxMoney = MAXMONEY;
672  	private BigDecimal _getMaxMoney()
673  	{
674  		return config.getBigDecimal("max-money", MAXMONEY);
675  	}
676  	@Override
677  	public BigDecimal getMaxMoney()
678  	{
679  		return maxMoney;
680  	}
681  	private static final BigDecimal MINMONEY = new BigDecimal("-10000000000000");
682  	private BigDecimal minMoney = MINMONEY;
683  	private BigDecimal _getMinMoney()
684  	{
685  		BigDecimal min = config.getBigDecimal("min-money", MINMONEY);
686  		if (min.signum() > 0)
687  		{
688  			min = min.negate();
689  		}
690  		return min;
691  	}
692  	@Override
693  	public BigDecimal getMinMoney()
694  	{
695  		return minMoney;
696  	}
697  	private boolean economyLog = false;
698  	@Override
699  	public boolean isEcoLogEnabled()
700  	{
701  		return economyLog;
702  	}
703  	public boolean _isEcoLogEnabled()
704  	{
705  		return config.getBoolean("economy-log-enabled", false);
706  	}
707  	private boolean economyLogUpdate = false;
708  	@Override
709  	public boolean isEcoLogUpdateEnabled()
710  	{
711  		return economyLogUpdate;
712  	}
713  	public boolean _isEcoLogUpdateEnabled()
714  	{
715  		return config.getBoolean("economy-log-update-enabled", false);
716  	}
717  	@Override
718  	public boolean removeGodOnDisconnect()
719  	{
720  		return config.getBoolean("remove-god-on-disconnect", false);
721  	}
722  	private boolean changeDisplayName = true;
723  	private boolean _changeDisplayName()
724  	{
725  		return config.getBoolean("change-displayname", true);
726  	}
727  	@Override
728  	public boolean changeDisplayName()
729  	{
730  		return changeDisplayName;
731  	}
732  	private boolean changePlayerListName = false;
733  	private boolean _changePlayerListName()
734  	{
735  		return config.getBoolean("change-playerlist", false);
736  	}
737  	@Override
738  	public boolean changePlayerListName()
739  	{
740  		return changePlayerListName;
741  	}
742  	@Override
743  	public boolean useBukkitPermissions()
744  	{
745  		return config.getBoolean("use-bukkit-permissions", false);
746  	}
747  	private boolean prefixsuffixconfigured = false;
748  	private boolean addprefixsuffix = false;
749  	private boolean essentialsChatActive = false;
750  	private boolean _addPrefixSuffix()
751  	{
752  		return config.getBoolean("add-prefix-suffix", false);
753  	}
754  	private boolean _isPrefixSuffixConfigured()
755  	{
756  		return config.hasProperty("add-prefix-suffix");
757  	}
758  	@Override
759  	public void setEssentialsChatActive(boolean essentialsChatActive)
760  	{
761  		this.essentialsChatActive = essentialsChatActive;
762  	}
763  	@Override
764  	public boolean addPrefixSuffix()
765  	{
766  		return prefixsuffixconfigured ? addprefixsuffix : essentialsChatActive;
767  	}
768  	private boolean disablePrefix = false;
769  	private boolean _disablePrefix()
770  	{
771  		return config.getBoolean("disablePrefix", false);
772  	}
773  	@Override
774  	public boolean disablePrefix()
775  	{
776  		return disablePrefix;
777  	}
778  	private boolean disableSuffix = false;
779  	private boolean _disableSuffix()
780  	{
781  		return config.getBoolean("disableSuffix", false);
782  	}
783  	@Override
784  	public boolean disableSuffix()
785  	{
786  		return disableSuffix;
787  	}
788  	@Override
789  	public long getAutoAfk()
790  	{
791  		return config.getLong("auto-afk", 300);
792  	}
793  	@Override
794  	public long getAutoAfkKick()
795  	{
796  		return config.getLong("auto-afk-kick", -1);
797  	}
798  	private boolean getFreezeAfkPlayers;
799  	@Override
800  	public boolean getFreezeAfkPlayers()
801  	{
802  		return getFreezeAfkPlayers;
803  	}
804  	private boolean _getFreezeAfkPlayers()
805  	{
806  		return config.getBoolean("freeze-afk-players", false);
807  	}
808  	private boolean cancelAfkOnMove;
809  	@Override
810  	public boolean cancelAfkOnMove()
811  	{
812  		return cancelAfkOnMove;
813  	}
814  	private boolean _cancelAfkOnMove()
815  	{
816  		return config.getBoolean("cancel-afk-on-move", true);
817  	}
818  	private boolean cancelAfkOnInteract;
819  	@Override
820  	public boolean cancelAfkOnInteract()
821  	{
822  		return cancelAfkOnInteract;
823  	}
824  	private boolean _cancelAfkOnInteract()
825  	{
826  		return config.getBoolean("cancel-afk-on-interact", true);
827  	}
828  	@Override
829  	public boolean areDeathMessagesEnabled()
830  	{
831  		return config.getBoolean("death-messages", true);
832  	}
833  	private Set<String> noGodWorlds = new HashSet<String>();
834  	@Override
835  	public Set<String> getNoGodWorlds()
836  	{
837  		return noGodWorlds;
838  	}
839  	@Override
840  	public void setDebug(final boolean debug)
841  	{
842  		this.debug = debug;
843  	}
844  	@Override
845  	public boolean getRepairEnchanted()
846  	{
847  		return config.getBoolean("repair-enchanted", true);
848  	}
849  	@Override
850  	public boolean allowUnsafeEnchantments()
851  	{
852  		return config.getBoolean("unsafe-enchantments", false);
853  	}
854  	@Override
855  	public boolean isWorldTeleportPermissions()
856  	{
857  		return config.getBoolean("world-teleport-permissions", false);
858  	}
859  	@Override
860  	public boolean isWorldHomePermissions()
861  	{
862  		return config.getBoolean("world-home-permissions", false);
863  	}
864  	private boolean registerBackInListener;
865  	@Override
866  	public boolean registerBackInListener()
867  	{
868  		return registerBackInListener;
869  	}
870  	private boolean _registerBackInListener()
871  	{
872  		return config.getBoolean("register-back-in-listener", false);
873  	}
874  	private boolean disableItemPickupWhileAfk;
875  	@Override
876  	public boolean getDisableItemPickupWhileAfk()
877  	{
878  		return disableItemPickupWhileAfk;
879  	}
880  	private boolean _getDisableItemPickupWhileAfk()
881  	{
882  		return config.getBoolean("disable-item-pickup-while-afk", false);
883  	}
884  	@Override
885  	public EventPriority getRespawnPriority()
886  	{
887  		String priority = config.getString("respawn-listener-priority", "normal").toLowerCase(Locale.ENGLISH);
888  		if ("lowest".equals(priority))
889  		{
890  			return EventPriority.LOWEST;
891  		}
892  		if ("low".equals(priority))
893  		{
894  			return EventPriority.LOW;
895  		}
896  		if ("normal".equals(priority))
897  		{
898  			return EventPriority.NORMAL;
899  		}
900  		if ("high".equals(priority))
901  		{
902  			return EventPriority.HIGH;
903  		}
904  		if ("highest".equals(priority))
905  		{
906  			return EventPriority.HIGHEST;
907  		}
908  		return EventPriority.NORMAL;
909  	}
910  	@Override
911  	public long getTpaAcceptCancellation()
912  	{
913  		return config.getLong("tpa-accept-cancellation", 120);
914  	}
915  	@Override
916  	public boolean isMetricsEnabled()
917  	{
918  		return metricsEnabled;
919  	}
920  	@Override
921  	public void setMetricsEnabled(boolean metricsEnabled)
922  	{
923  		this.metricsEnabled = metricsEnabled;
924  	}
925  	private long teleportInvulnerabilityTime;
926  	private long _getTeleportInvulnerability()
927  	{
928  		return config.getLong("teleport-invulnerability", 0) * 1000;
929  	}
930  	@Override
931  	public long getTeleportInvulnerability()
932  	{
933  		return teleportInvulnerabilityTime;
934  	}
935  	private boolean teleportInvulnerability;
936  	private boolean _isTeleportInvulnerability()
937  	{
938  		return (config.getLong("teleport-invulnerability", 0) > 0);
939  	}
940  	@Override
941  	public boolean isTeleportInvulnerability()
942  	{
943  		return teleportInvulnerability;
944  	}
945  	private long loginAttackDelay;
946  	private long _getLoginAttackDelay()
947  	{
948  		return config.getLong("login-attack-delay", 0) * 1000;
949  	}
950  	@Override
951  	public long getLoginAttackDelay()
952  	{
953  		return loginAttackDelay;
954  	}
955  	private int signUsePerSecond;
956  	private int _getSignUsePerSecond()
957  	{
958  		final int perSec = config.getInt("sign-use-per-second", 4);
959  		return perSec > 0 ? perSec : 1;
960  	}
961  	@Override
962  	public int getSignUsePerSecond()
963  	{
964  		return signUsePerSecond;
965  	}
966  	@Override
967  	public double getMaxFlySpeed()
968  	{
969  		double maxSpeed = config.getDouble("max-fly-speed", 0.8);
970  		return maxSpeed > 1.0 ? 1.0 : Math.abs(maxSpeed);
971  	}
972  	@Override
973  	public double getMaxWalkSpeed()
974  	{
975  		double maxSpeed = config.getDouble("max-walk-speed", 0.8);
976  		return maxSpeed > 1.0 ? 1.0 : Math.abs(maxSpeed);
977  	}
978  	private int mailsPerMinute;
979  	private int _getMailsPerMinute()
980  	{
981  		return config.getInt("mails-per-minute", 1000);
982  	}
983  	@Override
984  	public int getMailsPerMinute()
985  	{
986  		return mailsPerMinute;
987  	}
988  	private long economyLagWarning;
989  	private long _getEconomyLagWarning()
990  	{
991  		final long value = (long)(config.getDouble("economy-lag-warning", 25.0) * 1000000);
992  		return value;
993  	}
994  	@Override
995  	public long getEconomyLagWarning()
996  	{
997  		return economyLagWarning;
998  	}
999  	private long permissionsLagWarning;
1000  	private long _getPermissionsLagWarning()
1001  	{
1002  		final long value = (long)(config.getDouble("permissions-lag-warning", 25.0) * 1000000);
1003  		return value;
1004  	}
1005  	@Override
1006  	public long getPermissionsLagWarning()
1007  	{
1008  		return permissionsLagWarning;
1009  	}
1010  	@Override
1011  	public long getMaxTempban()
1012  	{
1013  		return config.getLong("max-tempban-time", -1);
1014  	}
1015  	@Override
1016  	public int getMaxNickLength()
1017  	{
1018  		return config.getInt("max-nick-length", 30);
1019  	}
1020  	private boolean allowSilentJoin;
1021  	public boolean _allowSilentJoinQuit()
1022  	{
1023  		return config.getBoolean("allow-silent-join-quit", false);
1024  	}
1025  	@Override
1026  	public boolean allowSilentJoinQuit()
1027  	{
1028  		return allowSilentJoin;
1029  	}
1030  	private String customJoinMessage;
1031  	private boolean isCustomJoinMessage;
1032  	public String _getCustomJoinMessage()
1033  	{
1034  		return FormatUtil.replaceFormat(config.getString("custom-join-message", "none"));
1035  	}
1036  	@Override
1037  	public String getCustomJoinMessage()
1038  	{
1039  		return customJoinMessage;
1040  	}
1041  	@Override
1042  	public boolean isCustomJoinMessage()
1043  	{
1044  		return isCustomJoinMessage;
1045  	}
1046  	private String customQuitMessage;
1047  	private boolean isCustomQuitMessage;
1048  	public String _getCustomQuitMessage()
1049  	{
1050  		return FormatUtil.replaceFormat(config.getString("custom-quit-message", "none"));
1051  	}
1052  	@Override
1053  	public String getCustomQuitMessage()
1054  	{
1055  		return customQuitMessage;
1056  	}
1057  	@Override
1058  	public boolean isCustomQuitMessage()
1059  	{
1060  		return isCustomQuitMessage;
1061  	}
1062  	@Override
1063  	public int getMaxUserCacheCount()
1064  	{
1065  		long count = Runtime.getRuntime().maxMemory() / 1024 / 96;
1066  		return config.getInt("max-user-cache-count", (int)count);
1067  	}
1068  }
</code></pre>
        </div>
        <div class="column">
            <h3>Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-EssentialsUpgrade.java</h3>
            <pre><code>1  package com.earth2me.essentials;
2  import static com.earth2me.essentials.I18n.tl;
3  import com.earth2me.essentials.craftbukkit.BanLookup;
4  import com.earth2me.essentials.craftbukkit.FakeWorld;
5  import com.earth2me.essentials.settings.Spawns;
6  import com.earth2me.essentials.storage.YamlStorageWriter;
7  import com.earth2me.essentials.utils.StringUtil;
8  import com.google.common.base.Charsets;
9  import java.io.*;
10  import java.math.BigInteger;
11  import java.security.DigestInputStream;
12  import java.security.MessageDigest;
13  import java.util.*;
14  import java.util.logging.Level;
15  import java.util.logging.Logger;
16  import net.ess3.api.IEssentials;
17  import org.bukkit.BanList;
18  import org.bukkit.Bukkit;
19  import org.bukkit.Location;
20  import org.bukkit.World;
21  public class EssentialsUpgrade
22  {
23  	private final static Logger LOGGER = Logger.getLogger("Essentials");
24  	private final transient IEssentials ess;
25  	private final transient EssentialsConf doneFile;
26  	EssentialsUpgrade(final IEssentials essentials)
27  	{
28  		ess = essentials;
29  		if (!ess.getDataFolder().exists())
30  		{
31  			ess.getDataFolder().mkdirs();
32  		}
33  		doneFile = new EssentialsConf(new File(ess.getDataFolder(), "upgrades-done.yml"));
34  		doneFile.load();
35  	}
36  	private void moveMotdRulesToFile(String name)
37  	{
38  		if (doneFile.getBoolean("move" + name + "ToFile", false))
39  		{
40  			return;
41  		}
42  		try
43  		{
44  			final File file = new File(ess.getDataFolder(), name + ".txt");
45  			if (file.exists())
46  			{
47  				return;
48  			}
49  			final File configFile = new File(ess.getDataFolder(), "config.yml");
50  			if (!configFile.exists())
51  			{
52  				return;
53  			}
54  			final EssentialsConf conf = new EssentialsConf(configFile);
55  			conf.load();
56  			List<String> lines = conf.getStringList(name);
57  			if (lines != null && !lines.isEmpty())
58  			{
59  				if (!file.createNewFile())
60  				{
61  					throw new IOException("Failed to create file " + file);
62  				}
63  				PrintWriter writer = new PrintWriter(file);
64  				for (String line : lines)
65  				{
66  					writer.println(line);
67  				}
68  				writer.close();
69  			}
70  			doneFile.setProperty("move" + name + "ToFile", true);
71  			doneFile.save();
72  		}
73  		catch (IOException e)
74  		{
75  			LOGGER.log(Level.SEVERE, tl("upgradingFilesError"), e);
76  		}
77  	}
78  	private void removeLinesFromConfig(File file, String regex, String info) throws Exception
79  	{
80  		boolean needUpdate = false;
81  		final BufferedReader bReader = new BufferedReader(new FileReader(file));
82  		final File tempFile = File.createTempFile("essentialsupgrade", ".tmp.yml", ess.getDataFolder());
83  		final BufferedWriter bWriter = new BufferedWriter(new FileWriter(tempFile));
84  		do
85  		{
86  			final String line = bReader.readLine();
87  			if (line == null)
88  			{
89  				break;
90  			}
91  			if (line.matches(regex))
92  			{
93  				if (!needUpdate && info != null)
94  				{
95  					bWriter.write(info, 0, info.length());
96  					bWriter.newLine();
97  				}
98  				needUpdate = true;
99  			}
100  			else
101  			{
102  				if (line.endsWith("\r\n"))
103  				{
104  					bWriter.write(line, 0, line.length() - 2);
105  				}
106  				else if (line.endsWith("\r") || line.endsWith("\n"))
107  				{
108  					bWriter.write(line, 0, line.length() - 1);
109  				}
110  				else
111  				{
112  					bWriter.write(line, 0, line.length());
113  				}
114  				bWriter.newLine();
115  			}
116  		}
117  		while (true);
118  		bReader.close();
119  		bWriter.close();
120  		if (needUpdate)
121  		{
122  			if (!file.renameTo(new File(file.getParentFile(), file.getName().concat("." + System.currentTimeMillis() + ".upgradebackup"))))
123  			{
124  				throw new Exception(tl("configFileMoveError"));
125  			}
126  			if (!tempFile.renameTo(file))
127  			{
128  				throw new Exception(tl("configFileRenameError"));
129  			}
130  		}
131  		else
132  		{
133  			tempFile.delete();
134  		}
135  	}
136  	private void updateUsersPowerToolsFormat()
137  	{
138  		if (doneFile.getBoolean("updateUsersPowerToolsFormat", false))
139  		{
140  			return;
141  		}
142  		final File userdataFolder = new File(ess.getDataFolder(), "userdata");
143  		if (!userdataFolder.exists() || !userdataFolder.isDirectory())
144  		{
145  			return;
146  		}
147  		final File[] userFiles = userdataFolder.listFiles();
148  		for (File file : userFiles)
149  		{
150  			if (!file.isFile() || !file.getName().endsWith(".yml"))
151  			{
152  				continue;
153  			}
154  			final EssentialsConf config = new EssentialsConf(file);
155  			try
156  			{
157  				config.load();
158  				if (config.hasProperty("powertools"))
159  				{
160  					@SuppressWarnings("unchecked")
161  					final Map<String, Object> powertools = config.getConfigurationSection("powertools").getValues(false);
162  					if (powertools == null)
163  					{
164  						continue;
165  					}
166  					for (Map.Entry<String, Object> entry : powertools.entrySet())
167  					{
168  						if (entry.getValue() instanceof String)
169  						{
170  							List<String> temp = new ArrayList<String>();
171  							temp.add((String)entry.getValue());
172  							((Map<String, Object>)powertools).put(entry.getKey(), temp);
173  						}
174  					}
175  					config.forceSave();
176  				}
177  			}
178  			catch (RuntimeException ex)
179  			{
180  				LOGGER.log(Level.INFO, "File: " + file.toString());
181  				throw ex;
182  			}
183  		}
184  		doneFile.setProperty("updateUsersPowerToolsFormat", true);
185  		doneFile.save();
186  	}
187  	private void updateUsersHomesFormat()
188  	{
189  		if (doneFile.getBoolean("updateUsersHomesFormat", false))
190  		{
191  			return;
192  		}
193  		final File userdataFolder = new File(ess.getDataFolder(), "userdata");
194  		if (!userdataFolder.exists() || !userdataFolder.isDirectory())
195  		{
196  			return;
197  		}
198  		final File[] userFiles = userdataFolder.listFiles();
199  		for (File file : userFiles)
200  		{
201  			if (!file.isFile() || !file.getName().endsWith(".yml"))
202  			{
203  				continue;
204  			}
205  			final EssentialsConf config = new EssentialsConf(file);
206  			try
207  			{
208  				config.load();
209  				if (config.hasProperty("home") && config.hasProperty("home.default"))
210  				{
211  					@SuppressWarnings("unchecked")
212  					final String defworld = (String)config.getProperty("home.default");
213  					final Location defloc = getFakeLocation(config, "home.worlds." + defworld);
214  					if (defloc != null)
215  					{
216  						config.setProperty("homes.home", defloc);
217  					}
218  					Set<String> worlds = config.getConfigurationSection("home.worlds").getKeys(false);
219  					Location loc;
220  					String worldName;
221  					if (worlds == null)
222  					{
223  						continue;
224  					}
225  					for (String world : worlds)
226  					{
227  						if (defworld.equalsIgnoreCase(world))
228  						{
229  							continue;
230  						}
231  						loc = getFakeLocation(config, "home.worlds." + world);
232  						if (loc == null)
233  						{
234  							continue;
235  						}
236  						worldName = loc.getWorld().getName().toLowerCase(Locale.ENGLISH);
237  						if (worldName != null && !worldName.isEmpty())
238  						{
239  							config.setProperty("homes." + worldName, loc);
240  						}
241  					}
242  					config.removeProperty("home");
243  					config.forceSave();
244  				}
245  			}
246  			catch (RuntimeException ex)
247  			{
248  				LOGGER.log(Level.INFO, "File: " + file.toString());
249  				throw ex;
250  			}
251  		}
252  		doneFile.setProperty("updateUsersHomesFormat", true);
253  		doneFile.save();
254  	}
255  	private void sanitizeAllUserFilenames()
256  	{
257  		if (doneFile.getBoolean("sanitizeAllUserFilenames", false))
258  		{
259  			return;
260  		}
261  		final File usersFolder = new File(ess.getDataFolder(), "userdata");
262  		if (!usersFolder.exists())
263  		{
264  			return;
265  		}
266  		final File[] listOfFiles = usersFolder.listFiles();
267  		for (File listOfFile : listOfFiles)
268  		{
269  			final String filename = listOfFile.getName();
270  			if (!listOfFile.isFile() || !filename.endsWith(".yml"))
271  			{
272  				continue;
273  			}
274  			final String sanitizedFilename = StringUtil.sanitizeFileName(filename.substring(0, filename.length() - 4)) + ".yml";
275  			if (sanitizedFilename.equals(filename))
276  			{
277  				continue;
278  			}
279  			final File tmpFile = new File(listOfFile.getParentFile(), sanitizedFilename + ".tmp");
280  			final File newFile = new File(listOfFile.getParentFile(), sanitizedFilename);
281  			if (!listOfFile.renameTo(tmpFile))
282  			{
283  				LOGGER.log(Level.WARNING, tl("userdataMoveError", filename, sanitizedFilename));
284  				continue;
285  			}
286  			if (newFile.exists())
287  			{
288  				LOGGER.log(Level.WARNING, tl("duplicatedUserdata", filename, sanitizedFilename));
289  				continue;
290  			}
291  			if (!tmpFile.renameTo(newFile))
292  			{
293  				LOGGER.log(Level.WARNING, tl("userdataMoveBackError", sanitizedFilename, sanitizedFilename));
294  			}
295  		}
296  		doneFile.setProperty("sanitizeAllUserFilenames", true);
297  		doneFile.save();
298  	}
299  	private World getFakeWorld(final String name)
300  	{
301  		final File bukkitDirectory = ess.getDataFolder().getParentFile().getParentFile();
302  		final File worldDirectory = new File(bukkitDirectory, name);
303  		if (worldDirectory.exists() && worldDirectory.isDirectory())
304  		{
305  			return new FakeWorld(worldDirectory.getName(), World.Environment.NORMAL);
306  		}
307  		return null;
308  	}
309  	public Location getFakeLocation(EssentialsConf config, String path)
310  	{
311  		String worldName = config.getString((path != null ? path + "." : "") + "world");
312  		if (worldName == null || worldName.isEmpty())
313  		{
314  			return null;
315  		}
316  		World world = getFakeWorld(worldName);
317  		if (world == null)
318  		{
319  			return null;
320  		}
321  		return new Location(world,
322  							config.getDouble((path != null ? path + "." : "") + "x", 0),
323  							config.getDouble((path != null ? path + "." : "") + "y", 0),
324  							config.getDouble((path != null ? path + "." : "") + "z", 0),
325  							(float)config.getDouble((path != null ? path + "." : "") + "yaw", 0),
326  							(float)config.getDouble((path != null ? path + "." : "") + "pitch", 0));
327  	}
328  	private void deleteOldItemsCsv()
329  	{
330  		if (doneFile.getBoolean("deleteOldItemsCsv", false))
331  		{
332  			return;
333  		}
334  		final File file = new File(ess.getDataFolder(), "items.csv");
335  		if (file.exists())
336  		{
337  			try
338  			{
339  				final Set<BigInteger> oldconfigs = new HashSet<BigInteger>();
340  				oldconfigs.add(new BigInteger("66ec40b09ac167079f558d1099e39f10", 16)); 
341  				oldconfigs.add(new BigInteger("34284de1ead43b0bee2aae85e75c041d", 16)); 
342  				oldconfigs.add(new BigInteger("c33bc9b8ee003861611bbc2f48eb6f4f", 16)); 
343  				oldconfigs.add(new BigInteger("6ff17925430735129fc2a02f830c1daa", 16)); 
344  				MessageDigest digest = ManagedFile.getDigest();
345  				final BufferedInputStream bis = new BufferedInputStream(new FileInputStream(file));
346  				final DigestInputStream dis = new DigestInputStream(bis, digest);
347  				final byte[] buffer = new byte[1024];
348  				try
349  				{
350  					while (dis.read(buffer) != -1)
351  					{
352  					}
353  				}
354  				finally
355  				{
356  					dis.close();
357  				}
358  				BigInteger hash = new BigInteger(1, digest.digest());
359  				if (oldconfigs.contains(hash) && !file.delete())
360  				{
361  					throw new IOException("Could not delete file " + file.toString());
362  				}
363  				doneFile.setProperty("deleteOldItemsCsv", true);
364  				doneFile.save();
365  			}
366  			catch (IOException ex)
367  			{
368  				Bukkit.getLogger().log(Level.SEVERE, ex.getMessage(), ex);
369  			}
370  		}
371  	}
372  	private void updateSpawnsToNewSpawnsConfig()
373  	{
374  		if (doneFile.getBoolean("updateSpawnsToNewSpawnsConfig", false))
375  		{
376  			return;
377  		}
378  		final File configFile = new File(ess.getDataFolder(), "spawn.yml");
379  		if (configFile.exists())
380  		{
381  			final EssentialsConf config = new EssentialsConf(configFile);
382  			try
383  			{
384  				config.load();
385  				if (!config.hasProperty("spawns"))
386  				{
387  					final Spawns spawns = new Spawns();
388  					Set<String> keys = config.getKeys(false);
389  					for (String group : keys)
390  					{
391  						Location loc = getFakeLocation(config, group);
392  						spawns.getSpawns().put(group.toLowerCase(Locale.ENGLISH), loc);
393  					}
394  					if (!configFile.renameTo(new File(ess.getDataFolder(), "spawn.yml.old")))
395  					{
396  						throw new Exception(tl("fileRenameError", "spawn.yml"));
397  					}
398  					PrintWriter writer = new PrintWriter(configFile);
399  					try
400  					{
401  						new YamlStorageWriter(writer).save(spawns);
402  					}
403  					finally
404  					{
405  						writer.close();
406  					}
407  				}
408  			}
409  			catch (Exception ex)
410  			{
411  				Bukkit.getLogger().log(Level.SEVERE, ex.getMessage(), ex);
412  			}
413  		}
414  		doneFile.setProperty("updateSpawnsToNewSpawnsConfig", true);
415  		doneFile.save();
416  	}
417  	private void updateJailsToNewJailsConfig()
418  	{
419  		if (doneFile.getBoolean("updateJailsToNewJailsConfig", false))
420  		{
421  			return;
422  		}
423  		final File configFile = new File(ess.getDataFolder(), "jail.yml");
424  		if (configFile.exists())
425  		{
426  			final EssentialsConf config = new EssentialsConf(configFile);
427  			try
428  			{
429  				config.load();
430  				if (!config.hasProperty("jails"))
431  				{
432  					final com.earth2me.essentials.settings.Jails jails = new com.earth2me.essentials.settings.Jails();
433  					Set<String> keys = config.getKeys(false);
434  					for (String jailName : keys)
435  					{
436  						Location loc = getFakeLocation(config, jailName);
437  						jails.getJails().put(jailName.toLowerCase(Locale.ENGLISH), loc);
438  					}
439  					if (!configFile.renameTo(new File(ess.getDataFolder(), "jail.yml.old")))
440  					{
441  						throw new Exception(tl("fileRenameError", "jail.yml"));
442  					}
443  					PrintWriter writer = new PrintWriter(configFile);
444  					try
445  					{
446  						new YamlStorageWriter(writer).save(jails);
447  					}
448  					finally
449  					{
450  						writer.close();
451  					}
452  				}
453  			}
454  			catch (Exception ex)
455  			{
456  				Bukkit.getLogger().log(Level.SEVERE, ex.getMessage(), ex);
457  			}
458  		}
459  		doneFile.setProperty("updateJailsToNewJailsConfig", true);
460  		doneFile.save();
461  	}
462  	private void warnMetrics()
463  	{
464  		if (doneFile.getBoolean("warnMetrics", false))
465  		{
466  			return;
467  		}
468  		ess.getSettings().setMetricsEnabled(false);
469  		doneFile.setProperty("warnMetrics", true);
470  		doneFile.save();
471  	}
472  	private void uuidFileChange()
473  	{
474  		if (doneFile.getBoolean("uuidFileChange", false))
475  		{
476  			return;
477  		}
478  		Boolean ignoreUFCache = doneFile.getBoolean("ignore-userfiles-cache", false);
479  		final File userdir = new File(ess.getDataFolder(), "userdata");
480  		if (!userdir.exists())
481  		{
482  			return;
483  		}
484  		int countFiles = 0;
485  		int countReqFiles = 0;
486  		for (String string : userdir.list())
487  		{
488  			if (!string.endsWith(".yml") || string.length() < 5)
489  			{
490  				continue;
491  			}
492  			countFiles++;
493  			final String name = string.substring(0, string.length() - 4);
494  			UUID uuid = null;
495  			try
496  			{
497  				uuid = UUID.fromString(name);
498  			}
499  			catch (IllegalArgumentException ex)
500  			{
501  				countReqFiles++;
502  			}
503  			if (countFiles > 100)
504  			{
505  				break;
506  			}
507  		}
508  		if (countReqFiles < 1)
509  		{
510  			return;
511  		}
512  		ess.getLogger().info("#### Starting Essentials UUID userdata conversion in a few seconds. ####");
513  		ess.getLogger().info("We recommend you take a backup of your server before upgrading from the old username system.");
514  		try
515  		{
516  			Thread.sleep(15000);
517  		}
518  		catch (InterruptedException ex)
519  		{
520  		}
521  		uuidFileConvert(ess, ignoreUFCache);
522  		doneFile.setProperty("uuidFileChange", true);
523  		doneFile.save();
524  	}
525  	public static void uuidFileConvert(IEssentials ess, Boolean ignoreUFCache)
526  	{
527  		ess.getLogger().info("Starting Essentials UUID userdata conversion");
528  		final File userdir = new File(ess.getDataFolder(), "userdata");
529  		if (!userdir.exists())
530  		{
531  			return;
532  		}
533  		int countFiles = 0;
534  		int countFails = 0;
535  		int countEssCache = 0;
536  		int countBukkit = 0;
537  		ess.getLogger().info("Found " + userdir.list().length + " files to convert...");
538  		for (String string : userdir.list())
539  		{
540  			if (!string.endsWith(".yml") || string.length() < 5)
541  			{
542  				continue;
543  			}
544  			final int showProgress = countFiles % 250;
545  			if (showProgress == 0)
546  			{
547  				ess.getUserMap().getUUIDMap().forceWriteUUIDMap();
548  				ess.getLogger().info("Converted " + countFiles + "/" + userdir.list().length);
549  			}
550  			countFiles++;
551  			String name = string.substring(0, string.length() - 4);
552  			EssentialsUserConf config;
553  			UUID uuid = null;
554  			try
555  			{
556  				uuid = UUID.fromString(name);
557  			}
558  			catch (IllegalArgumentException ex)
559  			{
560  				File file = new File(userdir, string);
561  				EssentialsConf conf = new EssentialsConf(file);
562  				conf.load();
563  				conf.setProperty("lastAccountName", name);
564  				conf.save();
565  				String uuidConf = ignoreUFCache ? "force-uuid" : "uuid";
566  				String uuidString = conf.getString(uuidConf, null);
567  				for (int i = 0; i < 4; i++)
568  				{
569  					try
570  					{
571  						uuid = UUID.fromString(uuidString);
572  						countEssCache++;
573  						break;
574  					}
575  					catch (Exception ex2)
576  					{
577  						if (conf.getBoolean("npc", false))
578  						{
579  							uuid = UUID.nameUUIDFromBytes(("NPC:" + name).getBytes(Charsets.UTF_8));
580  							break;
581  						}
582  						org.bukkit.OfflinePlayer player = ess.getServer().getOfflinePlayer(name);
583  						uuid = player.getUniqueId();
584  					}
585  					if (uuid != null)
586  					{
587  						countBukkit++;
588  						break;
589  					}
590  				}
591  				if (uuid != null)
592  				{
593  					conf.forceSave();
594  					config = new EssentialsUserConf(name, uuid, new File(userdir, uuid + ".yml"));
595  					config.convertLegacyFile();
596  					ess.getUserMap().trackUUID(uuid, name, false);
597  					continue;
598  				}
599  				countFails++;
600  			}
601  		}
602  		ess.getUserMap().getUUIDMap().forceWriteUUIDMap();
<span onclick='openModal()' class='match'>603  		ess.getLogger().info("Converted " + countFiles + "/" + countFiles + ".  Conversion complete.");
604  		ess.getLogger().info("Converted via cache: " + countEssCache + " :: Converted via lookup: " + countBukkit + " :: Failed to convert: " + countFails);
</span>605  		ess.getLogger().info("To rerun the conversion type /essentials uuidconvert");
606  	}
607  	public void banFormatChange()
608  	{
609  		if (doneFile.getBoolean("banFormatChange", false))
610  		{
611  			return;
612  		}
613  		ess.getLogger().info("Starting Essentials ban format conversion");
614  		final File userdir = new File(ess.getDataFolder(), "userdata");
615  		if (!userdir.exists())
616  		{
617  			return;
618  		}
619  		int countFiles = 0;
620  		ess.getLogger().info("Found " + userdir.list().length + " files to convert...");
621  		for (String string : userdir.list())
622  		{
623  			if (!string.endsWith(".yml") || string.length() < 5)
624  			{
625  				continue;
626  			}
627  			final int showProgress = countFiles % 250;
628  			if (showProgress == 0)
629  			{
630  				ess.getLogger().info("Converted " + countFiles + "/" + userdir.list().length);
631  			}
632  			countFiles++;
633  			final File pFile = new File(userdir, string);
634  			final EssentialsConf conf = new EssentialsConf(pFile);
635  			conf.load();
636  			String banReason;
637  			Long banTimeout;
638  			try
639  			{
640  				banReason = conf.getConfigurationSection("ban").getString("reason");
641  			}
642  			catch (NullPointerException n)
643  			{
644  				banReason = null;
645  			}
646  			final String playerName = conf.getString("lastAccountName");
647  			if (playerName != null && playerName.length() > 1 && banReason != null && banReason.length() > 1)
648  			{
649  				try
650  				{
651  					if (conf.getConfigurationSection("ban").contains("timeout"))
652  					{
653  						banTimeout = Long.parseLong(conf.getConfigurationSection("ban").getString("timeout"));
654  					}
655  					else
656  					{
657  						banTimeout = 0L;
658  					}
659  				}
660  				catch (NumberFormatException n)
661  				{
662  					banTimeout = 0L;
663  				}
664  				if (BanLookup.isBanned(ess, playerName))
665  				{
666  					updateBan(playerName, banReason, banTimeout);
667  				}
668  			}
669  			conf.removeProperty("ban");
670  			conf.save();
671  		}
672  		doneFile.setProperty("banFormatChange", true);
673  		doneFile.save();
674  		ess.getLogger().info("Ban format update complete.");
675  	}
676  	private void updateBan(String playerName, String banReason, Long banTimeout)
677  	{
678  		if (banTimeout == 0)
679  		{
680  			Bukkit.getBanList(BanList.Type.NAME).addBan(playerName, banReason, null, Console.NAME);
681  		}
682  		else
683  		{
684  			Bukkit.getBanList(BanList.Type.NAME).addBan(playerName, banReason, new Date(banTimeout), Console.NAME);
685  		}
686  	}
687  	public void beforeSettings()
688  	{
689  		if (!ess.getDataFolder().exists())
690  		{
691  			ess.getDataFolder().mkdirs();
692  		}
693  		moveMotdRulesToFile("motd");
694  		moveMotdRulesToFile("rules");
695  	}
696  	public void afterSettings()
697  	{
698  		sanitizeAllUserFilenames();
699  		updateUsersPowerToolsFormat();
700  		updateUsersHomesFormat();
701  		deleteOldItemsCsv();
702  		updateSpawnsToNewSpawnsConfig();
703  		updateJailsToNewJailsConfig();
704  		uuidFileChange();
705  		banFormatChange();
706  		warnMetrics();
707  	}
708  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-Settings.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-EssentialsUpgrade.java</div>
                </div>
                <div class="column column_space"><pre><code>225  						ess.getLogger().warning("Invalid command cost for: " + command + " (" + costString + ")");
226  					}
</pre></code></div>
                <div class="column column_space"><pre><code>603  		ess.getLogger().info("Converted " + countFiles + "/" + countFiles + ".  Conversion complete.");
604  		ess.getLogger().info("Converted via cache: " + countEssCache + " :: Converted via lookup: " + countBukkit + " :: Failed to convert: " + countFails);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    