<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for TransportVerifyShardBeforeCloseActionTests.java & SettingsTests.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for TransportVerifyShardBeforeCloseActionTests.java & SettingsTests.java
      </h3>
      <h1 align="center">
        23.2%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>TransportVerifyShardBeforeCloseActionTests.java (35.192307%)<TH>SettingsTests.java (17.362429%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#0',2,'match438370-1.html#0',3)" NAME="0">(21-50)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#0',2,'match438370-1.html#0',3)" NAME="0">(22-53)</A><TD ALIGN=center><FONT COLOR="#ff0000">29</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#1',2,'match438370-1.html#1',3)" NAME="1">(333-339)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#1',2,'match438370-1.html#1',3)" NAME="1">(140-148)</A><TD ALIGN=center><FONT COLOR="#830000">15</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#2',2,'match438370-1.html#2',3)" NAME="2">(251-259)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#2',2,'match438370-1.html#2',3)" NAME="2">(508-517)</A><TD ALIGN=center><FONT COLOR="#830000">15</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#3',2,'match438370-1.html#3',3)" NAME="3">(224-231)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#3',2,'match438370-1.html#3',3)" NAME="3">(479-490)</A><TD ALIGN=center><FONT COLOR="#830000">15</FONT>
<TR><TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#4',2,'match438370-1.html#4',3)" NAME="4">(234-242)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#4',2,'match438370-1.html#4',3)" NAME="4">(265-272)</A><TD ALIGN=center><FONT COLOR="#7b0000">14</FONT>
<TR><TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#5',2,'match438370-1.html#5',3)" NAME="5">(209-215)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#5',2,'match438370-1.html#5',3)" NAME="5">(110-117)</A><TD ALIGN=center><FONT COLOR="#7b0000">14</FONT>
<TR><TD BGCOLOR="#8c8774"><FONT COLOR="#8c8774">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#6',2,'match438370-1.html#6',3)" NAME="6">(243-249)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#6',2,'match438370-1.html#6',3)" NAME="6">(61-70)</A><TD ALIGN=center><FONT COLOR="#720000">13</FONT>
<TR><TD BGCOLOR="#38a4a5"><FONT COLOR="#38a4a5">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#7',2,'match438370-1.html#7',3)" NAME="7">(319-322)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#7',2,'match438370-1.html#7',3)" NAME="7">(118-127)</A><TD ALIGN=center><FONT COLOR="#600000">11</FONT>
<TR><TD BGCOLOR="#c58917"><FONT COLOR="#c58917">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#8',2,'match438370-1.html#8',3)" NAME="8">(202-207)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#8',2,'match438370-1.html#8',3)" NAME="8">(99-103)</A><TD ALIGN=center><FONT COLOR="#600000">11</FONT>
<TR><TD BGCOLOR="#83a33a"><FONT COLOR="#83a33a">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#9',2,'match438370-1.html#9',3)" NAME="9">(312-315)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#9',2,'match438370-1.html#9',3)" NAME="9">(536-539)</A><TD ALIGN=center><FONT COLOR="#570000">10</FONT>
<TR><TD BGCOLOR="#ad5910"><FONT COLOR="#ad5910">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#10',2,'match438370-1.html#10',3)" NAME="10">(263-267)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#10',2,'match438370-1.html#10',3)" NAME="10">(431-436)</A><TD ALIGN=center><FONT COLOR="#4f0000">9</FONT>
<TR><TD BGCOLOR="#b041ff"><FONT COLOR="#b041ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#11',2,'match438370-1.html#11',3)" NAME="11">(216-221)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#11',2,'match438370-1.html#11',3)" NAME="11">(75-81)</A><TD ALIGN=center><FONT COLOR="#4f0000">9</FONT>
<TR><TD BGCOLOR="#571b7e"><FONT COLOR="#571b7e">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#12',2,'match438370-1.html#12',3)" NAME="12">(162-169)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#12',2,'match438370-1.html#12',3)" NAME="12">(454-460)</A><TD ALIGN=center><FONT COLOR="#4f0000">9</FONT>
<TR><TD BGCOLOR="#3b9c9c"><FONT COLOR="#3b9c9c">-</FONT><TD><A HREF="javascript:ZweiFrames('match438370-0.html#13',2,'match438370-1.html#13',3)" NAME="13">(122-128)<TD><A HREF="javascript:ZweiFrames('match438370-0.html#13',2,'match438370-1.html#13',3)" NAME="13">(544-548)</A><TD ALIGN=center><FONT COLOR="#4f0000">9</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>TransportVerifyShardBeforeCloseActionTests.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
<A NAME="0"></A> * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial agreement.
 */
<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match438370-1.html#0',3,'match438370-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>package org.elasticsearch.action.admin.indices.close;

import org.apache.lucene.util.SetOnce;
import org.elasticsearch.action.ActionListener;
import org.elasticsearch.action.admin.indices.flush.FlushRequest;
import org.elasticsearch.action.support.PlainActionFuture;
import org.elasticsearch.action.support.replication.ReplicationOperation;
import org.elasticsearch.action.support.replication.ReplicationResponse;
import org.elasticsearch.action.support.replication.TransportReplicationAction;
import org.elasticsearch.action.support.replication.TransportReplicationAction.ConcreteShardRequest;
import org.elasticsearch.cluster.ClusterName;
import org.elasticsearch.cluster.ClusterState;
import org.elasticsearch.cluster.action.shard.ShardStateAction;
import org.elasticsearch.cluster.block.ClusterBlock;
import org.elasticsearch.cluster.block.ClusterBlockLevel;
import org.elasticsearch.cluster.block.ClusterBlocks;
import org.elasticsearch.cluster.metadata.IndexMetadata;
import org.elasticsearch.cluster.routing.IndexShardRoutingTable;
import org.elasticsearch.cluster.routing.ShardRouting;
import org.elasticsearch.cluster.routing.ShardRoutingState;
import org.elasticsearch.cluster.service.ClusterService;
import org.elasticsearch.common.UUIDs;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.index.engine.Engine;
import org.elasticsearch.index.shard.IndexShard;
import org.elasticsearch.index.shard.ReplicationGroup;
import org.elasticsearch.index.shard.ShardId;
import org.elasticsearch.indices.IndicesService;
import org.elasticsearch.rest.RestStatus;
import</B></FONT> org.elasticsearch.test.ESTestCase;
import org.elasticsearch.test.transport.CapturingTransport;
import org.elasticsearch.threadpool.TestThreadPool;
import org.elasticsearch.threadpool.ThreadPool;
import org.elasticsearch.transport.TransportResponse;
import org.elasticsearch.transport.TransportService;
import org.junit.After;
import org.junit.AfterClass;
import org.junit.Before;
import org.junit.BeforeClass;
import org.junit.Test;
import org.mockito.ArgumentCaptor;

import java.util.Arrays;
import java.util.EnumSet;
import java.util.List;
import java.util.Set;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.TimeUnit;

import static io.crate.execution.ddl.tables.TransportCloseTable.INDEX_CLOSED_BLOCK_ID;
import static org.elasticsearch.action.support.replication.ClusterStateCreationUtils.state;
import static org.elasticsearch.test.ClusterServiceUtils.createClusterService;
import static org.elasticsearch.test.ClusterServiceUtils.setState;
import static org.hamcrest.Matchers.arrayWithSize;
import static org.hamcrest.Matchers.equalTo;
import static org.hamcrest.Matchers.greaterThan;
import static org.hamcrest.Matchers.instanceOf;
import static org.hamcrest.Matchers.is;
import static org.mockito.Matchers.any;
import static org.mockito.Mockito.doThrow;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

public class TransportVerifyShardBeforeCloseActionTests extends ESTestCase {

    private static ThreadPool threadPool;

    private IndexShard indexShard;
    private TransportVerifyShardBeforeCloseAction action;
    private ClusterService clusterService;
    private ClusterBlock clusterBlock;
    private CapturingTransport transport;

    @BeforeClass
    public static void beforeClass() {
        threadPool = new TestThreadPool(getTestClass().getName());
    }

    @Override
    @Before
    public void setUp() throws Exception {
        super.setUp();

        indexShard = mock(IndexShard.class);
        when(indexShard.getActiveOperationsCount()).thenReturn(IndexShard.OPERATIONS_BLOCKED);

        ShardId shardId = new ShardId(&quot;index&quot;, &quot;_na_&quot;, randomIntBetween(0, 3));
        when(indexShard.shardId()).thenReturn(shardId);

        clusterService = createClusterService(threadPool);
        clusterBlock = new ClusterBlock(
            INDEX_CLOSED_BLOCK_ID,
            UUIDs.randomBase64UUID(),
            &quot;index preparing to close. Reopen the index to allow &quot; +
            &quot;writes again or retry closing the index to fully close the index.&quot;,
            false,
<A NAME="13"></A>            false,
            false,
            RestStatus.FORBIDDEN,
            <FONT color="#3b9c9c"><A HREF="javascript:ZweiFrames('match438370-1.html#13',3,'match438370-top.html#13',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>EnumSet.of(ClusterBlockLevel.WRITE));

        setState(
            clusterService,
            new ClusterState.Builder(clusterService.state())
                .blocks(
                    ClusterBlocks</B></FONT>
                        .builder().blocks(clusterService.state().blocks())
                        .addIndexBlock(&quot;index&quot;, clusterBlock)
                        .build())
                .build()
        );

        transport = new CapturingTransport();
        TransportService transportService = transport.createTransportService(
            Settings.EMPTY,
            threadPool,
            x -&gt; clusterService.localNode(),
            null
        );
        transportService.start();
        transportService.acceptIncomingRequests();

        ShardStateAction shardStateAction = new ShardStateAction(
            clusterService,
            transportService,
            null,
            null);
        action = new TransportVerifyShardBeforeCloseAction(
            Settings.EMPTY,
            transportService,
            clusterService,
            mock(
                IndicesService.class),
            mock(ThreadPool.class),
            shardStateAction
        );
<A NAME="12"></A>    }

    @Override
    <FONT color="#571b7e"><A HREF="javascript:ZweiFrames('match438370-1.html#12',3,'match438370-top.html#12',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>@After
    public void tearDown() throws Exception {
        super.tearDown();
        clusterService.close();
    }

    @AfterClass
    public static void afterClass() {</B></FONT>
        ThreadPool.terminate(threadPool, 30, TimeUnit.SECONDS);
        threadPool = null;
    }

    public void executeOnPrimaryOrReplica() throws Throwable {
        executeOnPrimaryOrReplica(false);
    }

    public void executeOnPrimaryOrReplica(boolean phase1) throws Throwable {
        var request = new TransportVerifyShardBeforeCloseAction.ShardRequest(
            indexShard.shardId(),
            phase1,
            clusterBlock
        );
        PlainActionFuture&lt;Void&gt; res = PlainActionFuture.newFuture();
        action.shardOperationOnPrimary(
            request,
            indexShard,
            ActionListener.wrap(
                r -&gt; {
                    assertNotNull(r);
                    res.onResponse(null);
                },
                res::onFailure
            ));
        try {
            res.get();
        } catch (InterruptedException e) {
            throw new AssertionError(e);
<A NAME="8"></A>        } catch (ExecutionException e) {
            throw e.getCause();
        }
    <FONT color="#c58917"><A HREF="javascript:ZweiFrames('match438370-1.html#8',3,'match438370-top.html#8',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>}

    @Test
    public void testShardIsFlushed() throws Throwable {
<A NAME="5"></A>        final ArgumentCaptor&lt;FlushRequest&gt; flushRequest = ArgumentCaptor.forClass(FlushRequest.class);
        when(indexShard.flush(flushRequest.capture</B></FONT>())).thenReturn(new Engine.CommitId(new byte[0]));

        <FONT color="#151b8d"><A HREF="javascript:ZweiFrames('match438370-1.html#5',3,'match438370-top.html#5',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>executeOnPrimaryOrReplica();
        verify(indexShard, times(1)).flush(any(FlushRequest.class));
        assertThat(flushRequest.getValue().force(), is(true));
    }
<A NAME="11"></A>
    @Test
    public void testShardIsSynced() throws Throwable {</B></FONT>
        <FONT color="#b041ff"><A HREF="javascript:ZweiFrames('match438370-1.html#11',3,'match438370-top.html#11',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>executeOnPrimaryOrReplica(true);
        verify(indexShard, times(1)).sync();
    }

    @Test
<A NAME="3"></A>    public void testOperationFailsWhenNotBlocked() {</B></FONT>
        when(indexShard.getActiveOperationsCount()).thenReturn(randomIntBetween(0, 10));

        <FONT color="#53858b"><A HREF="javascript:ZweiFrames('match438370-1.html#3',3,'match438370-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>IllegalStateException exception = expectThrows(IllegalStateException.class, this::executeOnPrimaryOrReplica);
        assertThat(exception.getMessage(),
                   equalTo(&quot;Index shard &quot; + indexShard.shardId() + &quot; is not blocking all operations during closing&quot;));
        verify(indexShard, times(0)).flush(any(FlushRequest.class));
    }

    @Test
<A NAME="4"></A>    public void testOperationFailsWithNoBlock() {</B></FONT>
        setState(clusterService, new ClusterState.Builder(new ClusterName(&quot;test&quot;)).build());

        IllegalStateException exception = <FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match438370-1.html#4',3,'match438370-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>expectThrows(IllegalStateException.class, this::executeOnPrimaryOrReplica);
        assertThat(exception.getMessage(),
                   equalTo(&quot;Index shard &quot; + indexShard.shardId() + &quot; must be blocked by &quot; + clusterBlock +
                           &quot; before closing&quot;));
        verify(indexShard, times(0)).flush(any(FlushRequest.class));
    }
<A NAME="6"></A>
    @Test
    public void testVerifyShardBeforeIndexClosing() throws Throwable {</B></FONT>
        <FONT color="#8c8774"><A HREF="javascript:ZweiFrames('match438370-1.html#6',3,'match438370-top.html#6',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>executeOnPrimaryOrReplica();
        verify(indexShard, times(1)).verifyShardBeforeIndexClosing();
        verify(indexShard, times(1)).flush(any(FlushRequest.class));
    }

<A NAME="2"></A>    @Test
    public void testVerifyShardBeforeIndexClosingFailed() {</B></FONT>
        doThrow(new IllegalStateException(&quot;test&quot;)).when(indexShard).verifyShardBeforeIndexClosing();
        <FONT color="#980517"><A HREF="javascript:ZweiFrames('match438370-1.html#2',3,'match438370-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>expectThrows(IllegalStateException.class, this::executeOnPrimaryOrReplica);
        verify(indexShard, times(1)).verifyShardBeforeIndexClosing();
        verify(indexShard, times(0)).flush(any(FlushRequest.class));
    }

    @Test
    public void testUnavailableShardsMarkedAsStale() throws Exception {
        String index = &quot;test&quot;;
        ShardId shardId = new ShardId(index, &quot;_na_&quot;, 0)</B></FONT>;
<A NAME="10"></A>
        int nbReplicas = randomIntBetween(1, 10);
        ShardRoutingState[] replicaStates = new ShardRoutingState[nbReplicas];
        <FONT color="#ad5910"><A HREF="javascript:ZweiFrames('match438370-1.html#10',3,'match438370-top.html#10',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Arrays.fill(replicaStates, ShardRoutingState.STARTED);
        final ClusterState clusterState = state(index, true, ShardRoutingState.STARTED, replicaStates);
        setState(clusterService, clusterState);

        IndexShardRoutingTable shardRoutingTable = clusterState.routingTable().index(index).shard(shardId.id</B></FONT>());
        IndexMetadata indexMetaData = clusterState.getMetadata().index(index);
        ShardRouting primaryRouting = shardRoutingTable.primaryShard();
        long primaryTerm = indexMetaData.primaryTerm(0);

        Set&lt;String&gt; inSyncAllocationIds = indexMetaData.inSyncAllocationIds(0);
        Set&lt;String&gt; trackedShards = shardRoutingTable.getAllAllocationIds();

        List&lt;ShardRouting&gt; unavailableShards = randomSubsetOf(
            randomIntBetween(1, nbReplicas),
            shardRoutingTable.replicaShards());
        IndexShardRoutingTable.Builder shardRoutingTableBuilder = new IndexShardRoutingTable.Builder(shardRoutingTable);
        unavailableShards.forEach(shardRoutingTableBuilder::removeShard);
        shardRoutingTable = shardRoutingTableBuilder.build();

        ReplicationGroup replicationGroup = new ReplicationGroup(
            shardRoutingTable,
            inSyncAllocationIds,
            trackedShards);
        assertThat(replicationGroup.getUnavailableInSyncShards().size(), greaterThan(0));

        PlainActionFuture&lt;PrimaryResult&gt; listener = new PlainActionFuture&lt;&gt;();
        TransportVerifyShardBeforeCloseAction.ShardRequest request =
            new TransportVerifyShardBeforeCloseAction.ShardRequest(shardId, false, clusterBlock);
        ReplicationOperation.Replicas&lt;TransportVerifyShardBeforeCloseAction.ShardRequest&gt; proxy =
            action.newReplicasProxy();
        ReplicationOperation&lt;TransportVerifyShardBeforeCloseAction.ShardRequest,
            TransportVerifyShardBeforeCloseAction.ShardRequest, PrimaryResult&gt; operation = new ReplicationOperation&lt;&gt;(
            request,
            createPrimary(primaryRouting, replicationGroup),
            listener,
            proxy,
            logger,
            &quot;test&quot;,
            primaryTerm
        );
        operation.execute();

        CapturingTransport.CapturedRequest[] capturedRequests = transport.getCapturedRequestsAndClear();
        assertThat(capturedRequests.length, equalTo(nbReplicas));

        for (CapturingTransport.CapturedRequest capturedRequest : capturedRequests) {
<A NAME="9"></A>            String actionName = capturedRequest.action;
            if (actionName.startsWith(ShardStateAction.SHARD_FAILED_ACTION_NAME)) {
                assertThat(capturedRequest.request, instanceOf(ShardStateAction.FailedShardEntry.class));
                <FONT color="#83a33a"><A HREF="javascript:ZweiFrames('match438370-1.html#9',3,'match438370-top.html#9',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>String allocationId = ((ShardStateAction.FailedShardEntry) capturedRequest.request).getAllocationId();
                assertTrue(unavailableShards.stream()
                               .anyMatch(shardRouting -&gt; shardRouting.allocationId().getId().equals(allocationId)));
                transport.handleResponse</B></FONT>(capturedRequest.requestId, TransportResponse.Empty.INSTANCE);
<A NAME="7"></A>
            } else if (actionName.startsWith(TransportVerifyShardBeforeCloseAction.NAME)) {
                assertThat(capturedRequest.request, instanceOf(ConcreteShardRequest.class));
                String allocationId = <FONT color="#38a4a5"><A HREF="javascript:ZweiFrames('match438370-1.html#7',3,'match438370-top.html#7',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>((ConcreteShardRequest) capturedRequest.request).getTargetAllocationID();
                assertFalse(unavailableShards.stream()
                                .anyMatch(shardRouting -&gt; shardRouting.allocationId().getId().equals(allocationId)));
                assertTrue(inSyncAllocationIds.stream</B></FONT>()
                               .anyMatch(inSyncAllocationId -&gt; inSyncAllocationId.equals(allocationId)));
                transport.handleResponse(
                    capturedRequest.requestId,
                    new TransportReplicationAction.ReplicaResponse(0L, 0L));

            } else {
                fail(&quot;Test does not support action &quot; + capturedRequest.action);
<A NAME="1"></A>            }
        }

        ReplicationResponse.ShardInfo shardInfo = <FONT color="#f63526"><A HREF="javascript:ZweiFrames('match438370-1.html#1',3,'match438370-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>listener.get().getShardInfo();
        assertThat(shardInfo.getFailed(), equalTo(0));
        assertThat(shardInfo.getFailures(), arrayWithSize(0));
        assertThat(shardInfo.getSuccessful(), equalTo(1 + nbReplicas - unavailableShards.size()));
    }

    private stati</B></FONT>c ReplicationOperation.Primary&lt;
        TransportVerifyShardBeforeCloseAction.ShardRequest,
        TransportVerifyShardBeforeCloseAction.ShardRequest,
        PrimaryResult&gt;
    createPrimary(final ShardRouting primary, final ReplicationGroup replicationGroup) {
        return new ReplicationOperation.Primary&lt;&gt;() {
            @Override
            public ShardRouting routingEntry() {
                return primary;
            }

            @Override
            public ReplicationGroup getReplicationGroup() {
                return replicationGroup;
            }

            @Override
            public void perform(
                TransportVerifyShardBeforeCloseAction.ShardRequest request, ActionListener&lt;PrimaryResult&gt; listener) {
                listener.onResponse(new PrimaryResult(request));
            }

            @Override
            public void failShard(String message, Exception exception) {

            }

            @Override
            public void updateLocalCheckpointForShard(String allocationId, long checkpoint) {
            }

            @Override
            public void updateGlobalCheckpointForShard(String allocationId, long globalCheckpoint) {
            }

            @Override
            public long localCheckpoint() {
                return 0;
            }

            @Override
            public long computedGlobalCheckpoint() {
                return 0;
            }

            @Override
            public long globalCheckpoint() {
                return 0;
            }

            @Override
            public long maxSeqNoOfUpdatesOrDeletes() {
                return 0;
            }
        };
    }

    private static class PrimaryResult implements ReplicationOperation.PrimaryResult&lt;TransportVerifyShardBeforeCloseAction.ShardRequest&gt; {

        private final TransportVerifyShardBeforeCloseAction.ShardRequest replicaRequest;
        private final SetOnce&lt;ReplicationResponse.ShardInfo&gt; shardInfo;

        private PrimaryResult(final TransportVerifyShardBeforeCloseAction.ShardRequest replicaRequest) {
            this.replicaRequest = replicaRequest;
            this.shardInfo = new SetOnce&lt;&gt;();
        }

        @Override
        public TransportVerifyShardBeforeCloseAction.ShardRequest replicaRequest() {
            return replicaRequest;
        }

        @Override
        public void setShardInfo(ReplicationResponse.ShardInfo shardInfo) {
            this.shardInfo.set(shardInfo);
        }

        @Override
        public void runPostReplicationActions(ActionListener&lt;Void&gt; listener) {
            listener.onResponse(null);
        }

        public ReplicationResponse.ShardInfo getShardInfo() {
            return shardInfo.get();
        }
    }
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>SettingsTests.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<A NAME="0"></A> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#0',2,'match438370-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>package org.elasticsearch.common.settings;

import org.elasticsearch.Version;
import org.elasticsearch.common.Strings;
import org.elasticsearch.common.bytes.BytesReference;
import org.elasticsearch.common.io.stream.BytesStreamOutput;
import org.elasticsearch.common.io.stream.StreamInput;
import org.elasticsearch.common.xcontent.ToXContent;
import org.elasticsearch.common.xcontent.XContentBuilder;
import org.elasticsearch.common.xcontent.XContentParser;
import org.elasticsearch.common.xcontent.XContentType;
import org.elasticsearch.test.ESTestCase;
import org.junit.Test;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.util.Arrays;
import java.util.Collections;
import java.util.Iterator;
import java.util.Map;
import java.util.NoSuchElementException;
import java.util.Set;

import static org.hamcrest.Matchers.contains;
import static org.hamcrest.Matchers.containsInAnyOrder;
import static org.hamcrest.Matchers.containsString;
import static org.hamcrest.Matchers.equalTo;
import static org.hamcrest.Matchers.hasEntry;
import static org.hamcrest.Matchers.hasToString;
import static org.hamcrest.Matchers.is;
import static org.hamcrest.Matchers.notNullValue;
import</B></FONT> static org.hamcrest.Matchers.nullValue;

public class SettingsTests extends ESTestCase {

    @Test
<A NAME="6"></A>    public void testReplacePropertiesPlaceholderSystemProperty() {
        String value = System.getProperty(&quot;java.home&quot;);
        assertFalse(value.isEmpty());
        Settings settings = <FONT color="#8c8774"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#6',2,'match438370-top.html#6',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>Settings.builder()
            .put(&quot;property.placeholder&quot;, value)
            .put(&quot;setting1&quot;, &quot;${property.placeholder}&quot;)
            .replacePropertyPlaceholders()
            .build();
        assertThat(settings.get(&quot;setting1&quot;), equalTo(value));
    }

    @Test
    public void testReplacePropertiesPlaceholderSystemPropertyList() {</B></FONT>
        final String hostname = randomAlphaOfLength(16);
<A NAME="11"></A>        final String hostip = randomAlphaOfLength(16);
        final Settings settings = Settings.builder()
            .putList(&quot;setting1&quot;, &quot;${HOSTNAME}&quot;, &quot;${HOSTIP}&quot;)
            .replacePropertyPlaceholders(name -&gt; name.equals(&quot;HOSTNAME&quot;) ? hostname : <FONT color="#b041ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#11',2,'match438370-top.html#11',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>name.equals(&quot;HOSTIP&quot;) ? hostip : null)
            .build();
        assertThat(settings.getAsList(&quot;setting1&quot;), contains(hostname, hostip));
    }

    @Test
    public void testReplacePropertiesPlaceholderSystemVariablesHaveNoEffect() {</B></FONT>
        final String value = System.getProperty(&quot;java.home&quot;);
        assertNotNull(value);
        final IllegalArgumentException e = expectThrows(IllegalArgumentException.class, () -&gt; Settings.builder()
            .put(&quot;setting1&quot;, &quot;${java.home}&quot;)
            .replacePropertyPlaceholders()
            .build());
        assertThat(e, hasToString(containsString(&quot;Could not resolve placeholder 'java.home'&quot;)));
    }

    @Test
    public void testReplacePropertiesPlaceholderByEnvironmentVariables() {
        final String hostname = randomAlphaOfLength(16);
        final Settings implicitEnvSettings = Settings.builder()
            .put(&quot;setting1&quot;, &quot;${HOSTNAME}&quot;)
<A NAME="8"></A>            .replacePropertyPlaceholders(name -&gt; &quot;HOSTNAME&quot;.equals(name) ? hostname : null)
            .build();
        assertThat(implicitEnvSettings.get(&quot;setting1&quot;), equalTo(hostname));
    <FONT color="#c58917"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#8',2,'match438370-top.html#8',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>}

    @Test
    public void testGetAsSettings() {
        Settings settings = Settings.builder()</B></FONT>
            .put(&quot;bar&quot;, &quot;hello world&quot;)
            .put(&quot;foo&quot;, &quot;abc&quot;)
            .put(&quot;foo.bar&quot;, &quot;def&quot;)
<A NAME="5"></A>            .put(&quot;foo.baz&quot;, &quot;ghi&quot;).build();

        Settings fooSettings = settings.getAsSettings(&quot;foo&quot;);
        assertFalse(<FONT color="#151b8d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#5',2,'match438370-top.html#5',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>fooSettings.isEmpty());
        assertEquals(2, fooSettings.size());
        assertThat(fooSettings.get(&quot;bar&quot;), equalTo(&quot;def&quot;));
        assertThat(fooSettings.get(&quot;baz&quot;), equalTo(&quot;ghi&quot;));
    }
<A NAME="7"></A>
    @Test
    public void testMultLevelGetPrefix() {</B></FONT>
        Settings settings = <FONT color="#38a4a5"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#7',2,'match438370-top.html#7',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>Settings.builder()
            .put(&quot;1.2.3&quot;, &quot;hello world&quot;)
            .put(&quot;1.2.3.4&quot;, &quot;abc&quot;)
            .put(&quot;2.3.4&quot;, &quot;def&quot;)
            .put(&quot;3.4&quot;, &quot;ghi&quot;).build();

        Settings firstLevelSettings = settings.getByPrefix(&quot;1.&quot;);
        assertFalse(firstLevelSettings.isEmpty());
        assertEquals(2, firstLevelSettings.size());
        assertThat</B></FONT>(firstLevelSettings.get(&quot;2.3.4&quot;), equalTo(&quot;abc&quot;));
        assertThat(firstLevelSettings.get(&quot;2.3&quot;), equalTo(&quot;hello world&quot;));

        Settings secondLevelSetting = firstLevelSettings.getByPrefix(&quot;2.&quot;);
        assertFalse(secondLevelSetting.isEmpty());
        assertEquals(2, secondLevelSetting.size());
        assertNull(secondLevelSetting.get(&quot;2.3.4&quot;));
        assertNull(secondLevelSetting.get(&quot;1.2.3.4&quot;));
        assertNull(secondLevelSetting.get(&quot;1.2.3&quot;));
        assertThat(secondLevelSetting.get(&quot;3.4&quot;), equalTo(&quot;abc&quot;));
<A NAME="1"></A>        assertThat(secondLevelSetting.get(&quot;3&quot;), equalTo(&quot;hello world&quot;));

        Settings thirdLevelSetting = secondLevelSetting.getByPrefix(&quot;3.&quot;);
        assertFalse(<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#1',2,'match438370-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>thirdLevelSetting.isEmpty());
        assertEquals(1, thirdLevelSetting.size());
        assertNull(thirdLevelSetting.get(&quot;2.3.4&quot;));
        assertNull(thirdLevelSetting.get(&quot;3.4&quot;));
        assertNull(thirdLevelSetting.get(&quot;1.2.3&quot;));
        assertThat(thirdLevelSetting.get(&quot;4&quot;), equalTo(&quot;abc&quot;));
    }

    @Test</B></FONT>
    public void testNames() {
        Settings settings = Settings.builder()
            .put(&quot;bar&quot;, &quot;baz&quot;)
            .put(&quot;foo&quot;, &quot;abc&quot;)
            .put(&quot;foo.bar&quot;, &quot;def&quot;)
            .put(&quot;foo.baz&quot;, &quot;ghi&quot;).build();

        Set&lt;String&gt; names = settings.names();
        assertThat(names.size(), equalTo(2));
        assertTrue(names.contains(&quot;bar&quot;));
        assertTrue(names.contains(&quot;foo&quot;));

        Settings fooSettings = settings.getAsSettings(&quot;foo&quot;);
        names = fooSettings.names();
        assertThat(names.size(), equalTo(2));
        assertTrue(names.contains(&quot;bar&quot;));
        assertTrue(names.contains(&quot;baz&quot;));
    }

    @Test
    public void testThatArraysAreOverriddenCorrectly() throws IOException {
        // overriding a single value with an array
        Settings settings = Settings.builder()
            .put(Settings.builder().putList(&quot;value&quot;, &quot;1&quot;).build())
            .put(Settings.builder().putList(&quot;value&quot;, &quot;2&quot;, &quot;3&quot;).build())
            .build();
        assertThat(settings.getAsList(&quot;value&quot;), contains(&quot;2&quot;, &quot;3&quot;));

        settings = Settings.builder()
            .put(Settings.builder().put(&quot;value&quot;, &quot;1&quot;).build())
            .put(Settings.builder().putList(&quot;value&quot;, &quot;2&quot;, &quot;3&quot;).build())
            .build();
        assertThat(settings.getAsList(&quot;value&quot;), contains(&quot;2&quot;, &quot;3&quot;));
        settings = Settings.builder().loadFromSource(&quot;value: 1&quot;, XContentType.YAML)
            .loadFromSource(&quot;value: [ 2, 3 ]&quot;, XContentType.YAML)
            .build();
        assertThat(settings.getAsList(&quot;value&quot;), contains(&quot;2&quot;, &quot;3&quot;));

        settings = Settings.builder()
            .put(Settings.builder().put(&quot;value.with.deep.key&quot;, &quot;1&quot;).build())
            .put(Settings.builder().putList(&quot;value.with.deep.key&quot;, &quot;2&quot;, &quot;3&quot;).build())
            .build();
        assertThat(settings.getAsList(&quot;value.with.deep.key&quot;), contains(&quot;2&quot;, &quot;3&quot;));

        // overriding an array with a shorter array
        settings = Settings.builder()
            .put(Settings.builder().putList(&quot;value&quot;, &quot;1&quot;, &quot;2&quot;).build())
            .put(Settings.builder().putList(&quot;value&quot;, &quot;3&quot;).build())
            .build();
        assertThat(settings.getAsList(&quot;value&quot;), contains(&quot;3&quot;));

        settings = Settings.builder()
            .put(Settings.builder().putList(&quot;value&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;).build())
            .put(Settings.builder().putList(&quot;value&quot;, &quot;4&quot;, &quot;5&quot;).build())
            .build();
        assertThat(settings.getAsList(&quot;value&quot;), contains(&quot;4&quot;, &quot;5&quot;));

        settings = Settings.builder()
            .put(Settings.builder().putList(&quot;value.deep.key&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;).build())
            .put(Settings.builder().putList(&quot;value.deep.key&quot;, &quot;4&quot;, &quot;5&quot;).build())
            .build();
        assertThat(settings.getAsList(&quot;value.deep.key&quot;), contains(&quot;4&quot;, &quot;5&quot;));

        // overriding an array with a longer array
        settings = Settings.builder()
            .put(Settings.builder().putList(&quot;value&quot;, &quot;1&quot;, &quot;2&quot;).build())
            .put(Settings.builder().putList(&quot;value&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;).build())
            .build();
        assertThat(settings.getAsList(&quot;value&quot;), contains(&quot;3&quot;, &quot;4&quot;, &quot;5&quot;));

        settings = Settings.builder()
            .put(Settings.builder().putList(&quot;value.deep.key&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;).build())
            .put(Settings.builder().putList(&quot;value.deep.key&quot;, &quot;4&quot;, &quot;5&quot;).build())
            .build();
        assertThat(settings.getAsList(&quot;value.deep.key&quot;), contains(&quot;4&quot;, &quot;5&quot;));

        // overriding an array with a single value
        settings = Settings.builder()
            .put(Settings.builder().putList(&quot;value&quot;, &quot;1&quot;, &quot;2&quot;).build())
            .put(Settings.builder().put(&quot;value&quot;, &quot;3&quot;).build())
            .build();
        assertThat(settings.getAsList(&quot;value&quot;), contains(&quot;3&quot;));

        settings = Settings.builder()
            .put(Settings.builder().putList(&quot;value.deep.key&quot;, &quot;1&quot;, &quot;2&quot;).build())
            .put(Settings.builder().put(&quot;value.deep.key&quot;, &quot;3&quot;).build())
            .build();
        assertThat(settings.getAsList(&quot;value.deep.key&quot;), contains(&quot;3&quot;));

        // test that other arrays are not overridden
        settings = Settings.builder()
            .put(Settings.builder().putList(&quot;value&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;).putList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;).build())
            .put(Settings.builder().putList(&quot;value&quot;, &quot;4&quot;, &quot;5&quot;).putList(&quot;d&quot;, &quot;e&quot;, &quot;f&quot;).build())
            .build();
        assertThat(settings.getAsList(&quot;value&quot;), contains(&quot;4&quot;, &quot;5&quot;));
        assertThat(settings.getAsList(&quot;a&quot;), contains(&quot;b&quot;, &quot;c&quot;));
        assertThat(settings.getAsList(&quot;d&quot;), contains(&quot;e&quot;, &quot;f&quot;));

        settings = Settings.builder()
            .put(Settings.builder().putList(&quot;value.deep.key&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;).putList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;).build())
            .put(Settings.builder().putList(&quot;value.deep.key&quot;, &quot;4&quot;, &quot;5&quot;).putList(&quot;d&quot;, &quot;e&quot;, &quot;f&quot;).build())
            .build();
        assertThat(settings.getAsList(&quot;value.deep.key&quot;), contains(&quot;4&quot;, &quot;5&quot;));
        assertThat(settings.getAsList(&quot;a&quot;), notNullValue());
        assertThat(settings.getAsList(&quot;d&quot;), notNullValue());

        // overriding a deeper structure with an array
        settings = Settings.builder()
            .put(Settings.builder().put(&quot;value.data&quot;, &quot;1&quot;).build())
            .put(Settings.builder().putList(&quot;value&quot;, &quot;4&quot;, &quot;5&quot;).build())
            .build();
        assertThat(settings.getAsList(&quot;value&quot;), contains(&quot;4&quot;, &quot;5&quot;));

<A NAME="4"></A>        // overriding an array with a deeper structure
        settings = Settings.builder()
            .put(Settings.builder().putList(&quot;value&quot;, &quot;4&quot;, &quot;5&quot;).build())
            .put(<FONT color="#6cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#4',2,'match438370-top.html#4',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>Settings.builder().put(&quot;value.data&quot;, &quot;1&quot;).build())
            .build();
        assertThat(settings.get(&quot;value.data&quot;), is(&quot;1&quot;));
        assertThat(settings.get(&quot;value&quot;), is(&quot;[4, 5]&quot;));
    }

    @Test
    public void testPrefixNormalization() {</B></FONT>
        Settings settings = Settings.builder().normalizePrefix(&quot;foo.&quot;).build();

        assertThat(settings.names().size(), equalTo(0));

        settings = Settings.builder()
            .put(&quot;bar&quot;, &quot;baz&quot;)
            .normalizePrefix(&quot;foo.&quot;)
            .build();

        assertThat(settings.size(), equalTo(1));
        assertThat(settings.get(&quot;bar&quot;), nullValue());
        assertThat(settings.get(&quot;foo.bar&quot;), equalTo(&quot;baz&quot;));


        settings = Settings.builder()
            .put(&quot;bar&quot;, &quot;baz&quot;)
            .put(&quot;foo.test&quot;, &quot;test&quot;)
            .normalizePrefix(&quot;foo.&quot;)
            .build();

        assertThat(settings.size(), equalTo(2));
        assertThat(settings.get(&quot;bar&quot;), nullValue());
        assertThat(settings.get(&quot;foo.bar&quot;), equalTo(&quot;baz&quot;));
        assertThat(settings.get(&quot;foo.test&quot;), equalTo(&quot;test&quot;));

        settings = Settings.builder()
            .put(&quot;foo.test&quot;, &quot;test&quot;)
            .normalizePrefix(&quot;foo.&quot;)
            .build();


        assertThat(settings.size(), equalTo(1));
        assertThat(settings.get(&quot;foo.test&quot;), equalTo(&quot;test&quot;));
    }

    @Test
    public void testFilteredMap() {
        Settings.Builder builder = Settings.builder();
        builder.put(&quot;a&quot;, &quot;a1&quot;);
        builder.put(&quot;a.b&quot;, &quot;ab1&quot;);
        builder.put(&quot;a.b.c&quot;, &quot;ab2&quot;);
        builder.put(&quot;a.c&quot;, &quot;ac1&quot;);
        builder.put(&quot;a.b.c.d&quot;, &quot;ab3&quot;);


        Settings filteredSettings = builder.build().filter((k) -&gt; k.startsWith(&quot;a.b&quot;));
        assertEquals(3, filteredSettings.size());
        int numKeys = 0;
        for (String k : filteredSettings.keySet()) {
            numKeys++;
            assertTrue(k.startsWith(&quot;a.b&quot;));
        }

        assertEquals(3, numKeys);
        assertFalse(filteredSettings.keySet().contains(&quot;a.c&quot;));
        assertFalse(filteredSettings.keySet().contains(&quot;a&quot;));
        assertTrue(filteredSettings.keySet().contains(&quot;a.b&quot;));
        assertTrue(filteredSettings.keySet().contains(&quot;a.b.c&quot;));
        assertTrue(filteredSettings.keySet().contains(&quot;a.b.c.d&quot;));
        expectThrows(UnsupportedOperationException.class, () -&gt;
            filteredSettings.keySet().remove(&quot;a.b&quot;));
        assertEquals(&quot;ab1&quot;, filteredSettings.get(&quot;a.b&quot;));
        assertEquals(&quot;ab2&quot;, filteredSettings.get(&quot;a.b.c&quot;));
        assertEquals(&quot;ab3&quot;, filteredSettings.get(&quot;a.b.c.d&quot;));

        Iterator&lt;String&gt; iterator = filteredSettings.keySet().iterator();
        for (int i = 0; i &lt; 10; i++) {
            assertTrue(iterator.hasNext());
        }
        assertEquals(&quot;a.b&quot;, iterator.next());
        if (randomBoolean()) {
            assertTrue(iterator.hasNext());
        }
        assertEquals(&quot;a.b.c&quot;, iterator.next());
        if (randomBoolean()) {
            assertTrue(iterator.hasNext());
        }
        assertEquals(&quot;a.b.c.d&quot;, iterator.next());
        assertFalse(iterator.hasNext());
        expectThrows(NoSuchElementException.class, () -&gt; iterator.next());

    }

    @Test
    public void testPrefixMap() {
        Settings.Builder builder = Settings.builder();
        builder.put(&quot;a&quot;, &quot;a1&quot;);
        builder.put(&quot;a.b&quot;, &quot;ab1&quot;);
        builder.put(&quot;a.b.c&quot;, &quot;ab2&quot;);
        builder.put(&quot;a.c&quot;, &quot;ac1&quot;);
        builder.put(&quot;a.b.c.d&quot;, &quot;ab3&quot;);

        Settings prefixMap = builder.build().getByPrefix(&quot;a.&quot;);
        assertEquals(4, prefixMap.size());
        int numKeys = 0;
        for (String k : prefixMap.keySet()) {
            numKeys++;
            assertTrue(k, k.startsWith(&quot;b&quot;) || k.startsWith(&quot;c&quot;));
        }

        assertEquals(4, numKeys);

        assertFalse(prefixMap.keySet().contains(&quot;a&quot;));
        assertTrue(prefixMap.keySet().contains(&quot;c&quot;));
        assertTrue(prefixMap.keySet().contains(&quot;b&quot;));
        assertTrue(prefixMap.keySet().contains(&quot;b.c&quot;));
        assertTrue(prefixMap.keySet().contains(&quot;b.c.d&quot;));
        expectThrows(UnsupportedOperationException.class, () -&gt;
            prefixMap.keySet().remove(&quot;a.b&quot;));
        assertEquals(&quot;ab1&quot;, prefixMap.get(&quot;b&quot;));
        assertEquals(&quot;ab2&quot;, prefixMap.get(&quot;b.c&quot;));
        assertEquals(&quot;ab3&quot;, prefixMap.get(&quot;b.c.d&quot;));
        Iterator&lt;String&gt; prefixIterator = prefixMap.keySet().iterator();
        for (int i = 0; i &lt; 10; i++) {
            assertTrue(prefixIterator.hasNext());
        }
        assertEquals(&quot;b&quot;, prefixIterator.next());
        if (randomBoolean()) {
            assertTrue(prefixIterator.hasNext());
        }
        assertEquals(&quot;b.c&quot;, prefixIterator.next());
        if (randomBoolean()) {
            assertTrue(prefixIterator.hasNext());
        }
        assertEquals(&quot;b.c.d&quot;, prefixIterator.next());
        if (randomBoolean()) {
            assertTrue(prefixIterator.hasNext());
        }
        assertEquals(&quot;c&quot;, prefixIterator.next());
        assertFalse(prefixIterator.hasNext());
        expectThrows(NoSuchElementException.class, () -&gt; prefixIterator.next());
    }

    @Test
    public void testGroupPrefix() {
        Settings.Builder builder = Settings.builder();
        builder.put(&quot;test.key1.baz&quot;, &quot;blah1&quot;);
        builder.put(&quot;test.key1.other&quot;, &quot;blah2&quot;);
        builder.put(&quot;test.key2.baz&quot;, &quot;blah3&quot;);
        builder.put(&quot;test.key2.else&quot;, &quot;blah4&quot;);
        Settings settings = builder.build();
        Map&lt;String, Settings&gt; groups = settings.getGroups(&quot;test&quot;);
        assertEquals(2, groups.size());
        Settings key1 = groups.get(&quot;key1&quot;);
        assertNotNull(key1);
        assertThat(key1.names(), containsInAnyOrder(&quot;baz&quot;, &quot;other&quot;));
        Settings key2 = groups.get(&quot;key2&quot;);
        assertNotNull(key2);
        assertThat(key2.names(), containsInAnyOrder(&quot;baz&quot;, &quot;else&quot;));
    }

    @Test
    public void testEmptyFilterMap() {
        Settings.Builder builder = Settings.builder();
        builder.put(&quot;a&quot;, &quot;a1&quot;);
<A NAME="10"></A>        builder.put(&quot;a.b&quot;, &quot;ab1&quot;);
        builder.put(&quot;a.b.c&quot;, &quot;ab2&quot;);
        builder.put(&quot;a.c&quot;, &quot;ac1&quot;);
        <FONT color="#ad5910"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#10',2,'match438370-top.html#10',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>builder.put(&quot;a.b.c.d&quot;, &quot;ab3&quot;);

        Settings filteredSettings = builder.build().filter((k) -&gt; false);
        assertEquals(0, filteredSettings.size());

        assertFalse(filteredSettings.keySet().contains</B></FONT>(&quot;a.c&quot;));
        assertFalse(filteredSettings.keySet().contains(&quot;a&quot;));
        assertFalse(filteredSettings.keySet().contains(&quot;a.b&quot;));
        assertFalse(filteredSettings.keySet().contains(&quot;a.b.c&quot;));
        assertFalse(filteredSettings.keySet().contains(&quot;a.b.c.d&quot;));
        expectThrows(UnsupportedOperationException.class, () -&gt;
            filteredSettings.keySet().remove(&quot;a.b&quot;));
        assertNull(filteredSettings.get(&quot;a.b&quot;));
        assertNull(filteredSettings.get(&quot;a.b.c&quot;));
        assertNull(filteredSettings.get(&quot;a.b.c.d&quot;));

        Iterator&lt;String&gt; iterator = filteredSettings.keySet().iterator();
        for (int i = 0; i &lt; 10; i++) {
            assertFalse(iterator.hasNext());
        }
<A NAME="12"></A>        expectThrows(NoSuchElementException.class, () -&gt; iterator.next());
    }

    <FONT color="#571b7e"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#12',2,'match438370-top.html#12',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>@Test
    public void testEmpty() {
        assertTrue(Settings.EMPTY.isEmpty());
    }

    @Test
    public void testWriteSettingsToStream() throws IOException {</B></FONT>
        BytesStreamOutput out = new BytesStreamOutput();
        Settings.Builder builder = Settings.builder();
        builder.put(&quot;test.key1.baz&quot;, &quot;blah1&quot;);
        builder.putNull(&quot;test.key3.bar&quot;);
        builder.putList(&quot;test.key4.foo&quot;, &quot;1&quot;, &quot;2&quot;);
        assertEquals(3, builder.build().size());
        Settings.writeSettingsToStream(builder.build(), out);
        StreamInput in = StreamInput.wrap(out.bytes().toBytesRef().bytes);
        Settings settings = Settings.readSettingsFromStream(in);
        assertEquals(3, settings.size());
        assertEquals(&quot;blah1&quot;, settings.get(&quot;test.key1.baz&quot;));
        assertNull(settings.get(&quot;test.key3.bar&quot;));
        assertTrue(settings.keySet().contains(&quot;test.key3.bar&quot;));
        assertEquals(Arrays.asList(&quot;1&quot;, &quot;2&quot;), settings.getAsList(&quot;test.key4.foo&quot;));
    }
<A NAME="3"></A>
    @Test
    public void testGetAsArrayFailsOnDuplicates() {
        <FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#3',2,'match438370-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>final IllegalStateException e = expectThrows(IllegalStateException.class, () -&gt; Settings.builder()
            .put(&quot;foobar.0&quot;, &quot;bar&quot;)
            .put(&quot;foobar.1&quot;, &quot;baz&quot;)
            .put(&quot;foobar&quot;, &quot;foo&quot;)
            .build());
        assertThat(e,
                   hasToString(containsString(
                       &quot;settings builder can't contain values for [foobar=foo] and [foobar.0=bar]&quot;)));
    }

    @Test
    public void testToAndFromXContent() throws IOException {</B></FONT>
        Settings settings = Settings.builder()
            .putList(&quot;foo.bar.baz&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;)
            .put(&quot;foo.foobar&quot;, 2)
            .put(&quot;rootfoo&quot;, &quot;test&quot;)
            .put(&quot;foo.baz&quot;, &quot;1,2,3,4&quot;)
            .putNull(&quot;foo.null.baz&quot;)
            .build();
        final boolean flatSettings = randomBoolean();
        XContentBuilder builder = XContentBuilder.builder(XContentType.JSON.xContent());
        builder.startObject();
        settings.toXContent(builder,
                            new ToXContent.MapParams(Collections.singletonMap(&quot;flat_settings&quot;, &quot;&quot; + flatSettings)));
        builder.endObject();
        XContentParser parser = createParser(builder);
<A NAME="2"></A>        Settings build = Settings.fromXContent(parser);
        assertEquals(5, build.size());
        assertEquals(Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;), build.getAsList(&quot;foo.bar.baz&quot;));
        assertEquals(2, <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#2',2,'match438370-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>build.getAsInt(&quot;foo.foobar&quot;, 0).intValue());
        assertEquals(&quot;test&quot;, build.get(&quot;rootfoo&quot;));
        assertEquals(&quot;1,2,3,4&quot;, build.get(&quot;foo.baz&quot;));
        assertNull(build.get(&quot;foo.null.baz&quot;));
    }

    @Test
    public void testSimpleJsonSettings() throws Exception {
        final String json = &quot;/org/elasticsearch/common/settings/loader/test-settings.json&quot;;
        final Settings settings = Settings.builder()</B></FONT>
            .loadFromStream(json, getClass().getResourceAsStream(json), false)
            .build();

        assertThat(settings.get(&quot;test1.value1&quot;), equalTo(&quot;value1&quot;));
        assertThat(settings.get(&quot;test1.test2.value2&quot;), equalTo(&quot;value2&quot;));
        assertThat(settings.getAsInt(&quot;test1.test2.value3&quot;, -1), equalTo(2));

        // check array
        assertNull(settings.get(&quot;test1.test3.0&quot;));
        assertNull(settings.get(&quot;test1.test3.1&quot;));
        assertThat(settings.getAsList(&quot;test1.test3&quot;).size(), equalTo(2));
        assertThat(settings.getAsList(&quot;test1.test3&quot;).get(0), equalTo(&quot;test3-1&quot;));
        assertThat(settings.getAsList(&quot;test1.test3&quot;).get(1), equalTo(&quot;test3-2&quot;));
    }

<A NAME="9"></A>    @Test
    public void testToXContent() throws IOException {
        // this is just terrible but it's the existing behavior!
        <FONT color="#83a33a"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#9',2,'match438370-top.html#9',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>Settings test = Settings.builder().putList(&quot;foo.bar&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;).put(&quot;foo.bar.baz&quot;, &quot;test&quot;).build();
        XContentBuilder builder = XContentBuilder.builder(XContentType.JSON.xContent());
        builder.startObject();
        test.toXContent</B></FONT>(builder, new ToXContent.MapParams(Collections.emptyMap()));
        builder.endObject();
<A NAME="13"></A>        assertEquals(&quot;{\&quot;foo\&quot;:{\&quot;bar.baz\&quot;:\&quot;test\&quot;,\&quot;bar\&quot;:[\&quot;1\&quot;,\&quot;2\&quot;,\&quot;3\&quot;]}}&quot;, Strings.toString(builder));

        test = Settings.builder().putList(&quot;foo.bar&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;).build();
        builder = <FONT color="#3b9c9c"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match438370-0.html#13',2,'match438370-top.html#13',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>XContentBuilder.builder(XContentType.JSON.xContent());
        builder.startObject();
        test.toXContent(builder, new ToXContent.MapParams(Collections.emptyMap()));
        builder.endObject();
        assertEquals(&quot;{\&quot;foo\&quot;:{\&quot;bar\&quot;:[\&quot;1\&quot;,\&quot;2\&quot;,\&quot;3\&quot;]}}&quot;, Strings.toString</B></FONT>(builder));

        builder = XContentBuilder.builder(XContentType.JSON.xContent());
        builder.startObject();
        test.toXContent(builder, new ToXContent.MapParams(Collections.singletonMap(&quot;flat_settings&quot;, &quot;true&quot;)));
        builder.endObject();
        assertEquals(&quot;{\&quot;foo.bar\&quot;:[\&quot;1\&quot;,\&quot;2\&quot;,\&quot;3\&quot;]}&quot;, Strings.toString(builder));
    }

    @Test
    public void testLoadEmptyStream() throws IOException {
        Settings test = Settings.builder().loadFromStream(&quot;test.json&quot;,
                                                          new ByteArrayInputStream(new byte[0]),
                                                          false)
            .build();
        assertEquals(0, test.size());
    }

    @Test
    public void testReadWriteArray() throws IOException {
        BytesStreamOutput output = new BytesStreamOutput();
        //output.setVersion(randomFrom(Version.CURRENT, Version.V_7_0_0));
        output.setVersion(Version.CURRENT);
        Settings settings = Settings.builder().putList(&quot;foo.bar&quot;, &quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;).put(&quot;foo.bar.baz&quot;, &quot;baz&quot;).build();
        Settings.writeSettingsToStream(settings, output);
        StreamInput in = StreamInput.wrap(BytesReference.toBytes(output.bytes()));
        Settings build = Settings.readSettingsFromStream(in);
        assertEquals(2, build.size());
        assertEquals(build.getAsList(&quot;foo.bar&quot;), Arrays.asList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;));
        assertEquals(build.get(&quot;foo.bar.baz&quot;), &quot;baz&quot;);
    }

    @Test
    public void testCopy() {
        Settings settings = Settings.builder().putList(&quot;foo.bar&quot;, &quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;).put(&quot;foo.bar.baz&quot;, &quot;baz&quot;).putNull(
            &quot;test&quot;).build();
        assertEquals(Arrays.asList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;),
                     Settings.builder().copy(&quot;foo.bar&quot;, settings).build().getAsList(&quot;foo.bar&quot;));
        assertEquals(&quot;baz&quot;, Settings.builder().copy(&quot;foo.bar.baz&quot;, settings).build().get(&quot;foo.bar.baz&quot;));
        assertNull(Settings.builder().copy(&quot;foo.bar.baz&quot;, settings).build().get(&quot;test&quot;));
        assertTrue(Settings.builder().copy(&quot;test&quot;, settings).build().keySet().contains(&quot;test&quot;));
        IllegalArgumentException iae = expectThrows(IllegalArgumentException.class,
                                                    () -&gt; Settings.builder().copy(&quot;not_there&quot;, settings));
        assertEquals(&quot;source key not found in the source settings&quot;, iae.getMessage());
    }

    @Test
    public void testGetAsStructuredMapNoSettingToMask() {
        Settings settings = Settings.builder()
            .put(&quot;masked&quot;, &quot;masked_value&quot;)
            .build();

        Map&lt;String, Object&gt; map = settings.getAsStructuredMap(Set.of());
        assertThat(map, hasEntry(&quot;masked&quot;, &quot;masked_value&quot;));
    }

    @Test
    public void testGetAsStructuredMapMaskingValues() {
        Settings settings = Settings.builder()
            .put(&quot;masked&quot;, &quot;masked_value&quot;)
            .build();

        Map&lt;String, Object&gt; map = settings.getAsStructuredMap(Set.of(&quot;masked&quot;));
        assertThat(map, hasEntry(&quot;masked&quot;, Settings.MASKED_VALUE));
    }
}
</PRE>
</div>
  </div>
</body>
</html>
