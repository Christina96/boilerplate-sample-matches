<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for TransportVerifyShardBeforeCloseActionTests.java &amp; SettingsTests.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for TransportVerifyShardBeforeCloseActionTests.java &amp; SettingsTests.java
      </h3>
<h1 align="center">
        23.2%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>TransportVerifyShardBeforeCloseActionTests.java (35.192307%)<th>SettingsTests.java (17.362429%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(21-50)<td><a href="#" name="0">(22-53)</a><td align="center"><font color="#ff0000">29</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(333-339)<td><a href="#" name="1">(140-148)</a><td align="center"><font color="#830000">15</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(251-259)<td><a href="#" name="2">(508-517)</a><td align="center"><font color="#830000">15</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(224-231)<td><a href="#" name="3">(479-490)</a><td align="center"><font color="#830000">15</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(234-242)<td><a href="#" name="4">(265-272)</a><td align="center"><font color="#7b0000">14</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(209-215)<td><a href="#" name="5">(110-117)</a><td align="center"><font color="#7b0000">14</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(243-249)<td><a href="#" name="6">(61-70)</a><td align="center"><font color="#720000">13</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(319-322)<td><a href="#" name="7">(118-127)</a><td align="center"><font color="#600000">11</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(202-207)<td><a href="#" name="8">(99-103)</a><td align="center"><font color="#600000">11</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(312-315)<td><a href="#" name="9">(536-539)</a><td align="center"><font color="#570000">10</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(263-267)<td><a href="#" name="10">(431-436)</a><td align="center"><font color="#4f0000">9</font>
<tr onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b041ff"><font color="#b041ff">-</font><td><a href="#" name="11">(216-221)<td><a href="#" name="11">(75-81)</a><td align="center"><font color="#4f0000">9</font>
<tr onclick='openModal("#571b7e")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#571b7e"><font color="#571b7e">-</font><td><a href="#" name="12">(162-169)<td><a href="#" name="12">(454-460)</a><td align="center"><font color="#4f0000">9</font>
<tr onclick='openModal("#3b9c9c")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3b9c9c"><font color="#3b9c9c">-</font><td><a href="#" name="13">(122-128)<td><a href="#" name="13">(544-548)</a><td align="center"><font color="#4f0000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>TransportVerifyShardBeforeCloseActionTests.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18 <a name="0"></a> * with Crate these terms will supersede the license and you may use the
19  * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>package org.elasticsearch.action.admin.indices.close;
22 import org.apache.lucene.util.SetOnce;
23 import org.elasticsearch.action.ActionListener;
24 import org.elasticsearch.action.admin.indices.flush.FlushRequest;
25 import org.elasticsearch.action.support.PlainActionFuture;
26 import org.elasticsearch.action.support.replication.ReplicationOperation;
27 import org.elasticsearch.action.support.replication.ReplicationResponse;
28 import org.elasticsearch.action.support.replication.TransportReplicationAction;
29 import org.elasticsearch.action.support.replication.TransportReplicationAction.ConcreteShardRequest;
30 import org.elasticsearch.cluster.ClusterName;
31 import org.elasticsearch.cluster.ClusterState;
32 import org.elasticsearch.cluster.action.shard.ShardStateAction;
33 import org.elasticsearch.cluster.block.ClusterBlock;
34 import org.elasticsearch.cluster.block.ClusterBlockLevel;
35 import org.elasticsearch.cluster.block.ClusterBlocks;
36 import org.elasticsearch.cluster.metadata.IndexMetadata;
37 import org.elasticsearch.cluster.routing.IndexShardRoutingTable;
38 import org.elasticsearch.cluster.routing.ShardRouting;
39 import org.elasticsearch.cluster.routing.ShardRoutingState;
40 import org.elasticsearch.cluster.service.ClusterService;
41 import org.elasticsearch.common.UUIDs;
42 import org.elasticsearch.common.settings.Settings;
43 import org.elasticsearch.index.engine.Engine;
44 import org.elasticsearch.index.shard.IndexShard;
45 import org.elasticsearch.index.shard.ReplicationGroup;
46 import org.elasticsearch.index.shard.ShardId;
47 import org.elasticsearch.indices.IndicesService;
48 import org.elasticsearch.rest.RestStatus;
49 import</b></font> org.elasticsearch.test.ESTestCase;
50 import org.elasticsearch.test.transport.CapturingTransport;
51 import org.elasticsearch.threadpool.TestThreadPool;
52 import org.elasticsearch.threadpool.ThreadPool;
53 import org.elasticsearch.transport.TransportResponse;
54 import org.elasticsearch.transport.TransportService;
55 import org.junit.After;
56 import org.junit.AfterClass;
57 import org.junit.Before;
58 import org.junit.BeforeClass;
59 import org.junit.Test;
60 import org.mockito.ArgumentCaptor;
61 import java.util.Arrays;
62 import java.util.EnumSet;
63 import java.util.List;
64 import java.util.Set;
65 import java.util.concurrent.ExecutionException;
66 import java.util.concurrent.TimeUnit;
67 import static io.crate.execution.ddl.tables.TransportCloseTable.INDEX_CLOSED_BLOCK_ID;
68 import static org.elasticsearch.action.support.replication.ClusterStateCreationUtils.state;
69 import static org.elasticsearch.test.ClusterServiceUtils.createClusterService;
70 import static org.elasticsearch.test.ClusterServiceUtils.setState;
71 import static org.hamcrest.Matchers.arrayWithSize;
72 import static org.hamcrest.Matchers.equalTo;
73 import static org.hamcrest.Matchers.greaterThan;
74 import static org.hamcrest.Matchers.instanceOf;
75 import static org.hamcrest.Matchers.is;
76 import static org.mockito.Matchers.any;
77 import static org.mockito.Mockito.doThrow;
78 import static org.mockito.Mockito.mock;
79 import static org.mockito.Mockito.times;
80 import static org.mockito.Mockito.verify;
81 import static org.mockito.Mockito.when;
82 public class TransportVerifyShardBeforeCloseActionTests extends ESTestCase {
83     private static ThreadPool threadPool;
84     private IndexShard indexShard;
85     private TransportVerifyShardBeforeCloseAction action;
86     private ClusterService clusterService;
87     private ClusterBlock clusterBlock;
88     private CapturingTransport transport;
89     @BeforeClass
90     public static void beforeClass() {
91         threadPool = new TestThreadPool(getTestClass().getName());
92     }
93     @Override
94     @Before
95     public void setUp() throws Exception {
96         super.setUp();
97         indexShard = mock(IndexShard.class);
98         when(indexShard.getActiveOperationsCount()).thenReturn(IndexShard.OPERATIONS_BLOCKED);
99         ShardId shardId = new ShardId("index", "_na_", randomIntBetween(0, 3));
100         when(indexShard.shardId()).thenReturn(shardId);
101         clusterService = createClusterService(threadPool);
102         clusterBlock = new ClusterBlock(
103             INDEX_CLOSED_BLOCK_ID,
104             UUIDs.randomBase64UUID(),
105             "index preparing to close. Reopen the index to allow " +
106             "writes again or retry closing the index to fully close the index.",
107             false,
108 <a name="13"></a>            false,
109             false,
110             RestStatus.FORBIDDEN,
111             <font color="#3b9c9c"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>EnumSet.of(ClusterBlockLevel.WRITE));
112         setState(
113             clusterService,
114             new ClusterState.Builder(clusterService.state())
115                 .blocks(
116                     ClusterBlocks</b></font>
117                         .builder().blocks(clusterService.state().blocks())
118                         .addIndexBlock("index", clusterBlock)
119                         .build())
120                 .build()
121         );
122         transport = new CapturingTransport();
123         TransportService transportService = transport.createTransportService(
124             Settings.EMPTY,
125             threadPool,
126             x -&gt; clusterService.localNode(),
127             null
128         );
129         transportService.start();
130         transportService.acceptIncomingRequests();
131         ShardStateAction shardStateAction = new ShardStateAction(
132             clusterService,
133             transportService,
134             null,
135             null);
136         action = new TransportVerifyShardBeforeCloseAction(
137             Settings.EMPTY,
138             transportService,
139             clusterService,
140             mock(
141                 IndicesService.class),
142             mock(ThreadPool.class),
143             shardStateAction
144         );
145 <a name="12"></a>    }
146     @Override
147     <font color="#571b7e"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>@After
148     public void tearDown() throws Exception {
149         super.tearDown();
150         clusterService.close();
151     }
152     @AfterClass
153     public static void afterClass() {</b></font>
154         ThreadPool.terminate(threadPool, 30, TimeUnit.SECONDS);
155         threadPool = null;
156     }
157     public void executeOnPrimaryOrReplica() throws Throwable {
158         executeOnPrimaryOrReplica(false);
159     }
160     public void executeOnPrimaryOrReplica(boolean phase1) throws Throwable {
161         var request = new TransportVerifyShardBeforeCloseAction.ShardRequest(
162             indexShard.shardId(),
163             phase1,
164             clusterBlock
165         );
166         PlainActionFuture&lt;Void&gt; res = PlainActionFuture.newFuture();
167         action.shardOperationOnPrimary(
168             request,
169             indexShard,
170             ActionListener.wrap(
171                 r -&gt; {
172                     assertNotNull(r);
173                     res.onResponse(null);
174                 },
175                 res::onFailure
176             ));
177         try {
178             res.get();
179         } catch (InterruptedException e) {
180             throw new AssertionError(e);
181 <a name="8"></a>        } catch (ExecutionException e) {
182             throw e.getCause();
183         }
184     <font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
185     @Test
186     public void testShardIsFlushed() throws Throwable {
187 <a name="5"></a>        final ArgumentCaptor&lt;FlushRequest&gt; flushRequest = ArgumentCaptor.forClass(FlushRequest.class);
188         when(indexShard.flush(flushRequest.capture</b></font>())).thenReturn(new Engine.CommitId(new byte[0]));
189         <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>executeOnPrimaryOrReplica();
190         verify(indexShard, times(1)).flush(any(FlushRequest.class));
191         assertThat(flushRequest.getValue().force(), is(true));
192     }
193 <a name="11"></a>
194     @Test
195     public void testShardIsSynced() throws Throwable {</b></font>
196         <font color="#b041ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>executeOnPrimaryOrReplica(true);
197         verify(indexShard, times(1)).sync();
198     }
199     @Test
200 <a name="3"></a>    public void testOperationFailsWhenNotBlocked() {</b></font>
201         when(indexShard.getActiveOperationsCount()).thenReturn(randomIntBetween(0, 10));
202         <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>IllegalStateException exception = expectThrows(IllegalStateException.class, this::executeOnPrimaryOrReplica);
203         assertThat(exception.getMessage(),
204                    equalTo("Index shard " + indexShard.shardId() + " is not blocking all operations during closing"));
205         verify(indexShard, times(0)).flush(any(FlushRequest.class));
206     }
207     @Test
208 <a name="4"></a>    public void testOperationFailsWithNoBlock() {</b></font>
209         setState(clusterService, new ClusterState.Builder(new ClusterName("test")).build());
210         IllegalStateException exception = <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>expectThrows(IllegalStateException.class, this::executeOnPrimaryOrReplica);
211         assertThat(exception.getMessage(),
212                    equalTo("Index shard " + indexShard.shardId() + " must be blocked by " + clusterBlock +
213                            " before closing"));
214         verify(indexShard, times(0)).flush(any(FlushRequest.class));
215     }
216 <a name="6"></a>
217     @Test
218     public void testVerifyShardBeforeIndexClosing() throws Throwable {</b></font>
219         <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>executeOnPrimaryOrReplica();
220         verify(indexShard, times(1)).verifyShardBeforeIndexClosing();
221         verify(indexShard, times(1)).flush(any(FlushRequest.class));
222     }
223 <a name="2"></a>    @Test
224     public void testVerifyShardBeforeIndexClosingFailed() {</b></font>
225         doThrow(new IllegalStateException("test")).when(indexShard).verifyShardBeforeIndexClosing();
226         <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>expectThrows(IllegalStateException.class, this::executeOnPrimaryOrReplica);
227         verify(indexShard, times(1)).verifyShardBeforeIndexClosing();
228         verify(indexShard, times(0)).flush(any(FlushRequest.class));
229     }
230     @Test
231     public void testUnavailableShardsMarkedAsStale() throws Exception {
232         String index = "test";
233         ShardId shardId = new ShardId(index, "_na_", 0)</b></font>;
234 <a name="10"></a>
235         int nbReplicas = randomIntBetween(1, 10);
236         ShardRoutingState[] replicaStates = new ShardRoutingState[nbReplicas];
237         <font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Arrays.fill(replicaStates, ShardRoutingState.STARTED);
238         final ClusterState clusterState = state(index, true, ShardRoutingState.STARTED, replicaStates);
239         setState(clusterService, clusterState);
240         IndexShardRoutingTable shardRoutingTable = clusterState.routingTable().index(index).shard(shardId.id</b></font>());
241         IndexMetadata indexMetaData = clusterState.getMetadata().index(index);
242         ShardRouting primaryRouting = shardRoutingTable.primaryShard();
243         long primaryTerm = indexMetaData.primaryTerm(0);
244         Set&lt;String&gt; inSyncAllocationIds = indexMetaData.inSyncAllocationIds(0);
245         Set&lt;String&gt; trackedShards = shardRoutingTable.getAllAllocationIds();
246         List&lt;ShardRouting&gt; unavailableShards = randomSubsetOf(
247             randomIntBetween(1, nbReplicas),
248             shardRoutingTable.replicaShards());
249         IndexShardRoutingTable.Builder shardRoutingTableBuilder = new IndexShardRoutingTable.Builder(shardRoutingTable);
250         unavailableShards.forEach(shardRoutingTableBuilder::removeShard);
251         shardRoutingTable = shardRoutingTableBuilder.build();
252         ReplicationGroup replicationGroup = new ReplicationGroup(
253             shardRoutingTable,
254             inSyncAllocationIds,
255             trackedShards);
256         assertThat(replicationGroup.getUnavailableInSyncShards().size(), greaterThan(0));
257         PlainActionFuture&lt;PrimaryResult&gt; listener = new PlainActionFuture&lt;&gt;();
258         TransportVerifyShardBeforeCloseAction.ShardRequest request =
259             new TransportVerifyShardBeforeCloseAction.ShardRequest(shardId, false, clusterBlock);
260         ReplicationOperation.Replicas&lt;TransportVerifyShardBeforeCloseAction.ShardRequest&gt; proxy =
261             action.newReplicasProxy();
262         ReplicationOperation&lt;TransportVerifyShardBeforeCloseAction.ShardRequest,
263             TransportVerifyShardBeforeCloseAction.ShardRequest, PrimaryResult&gt; operation = new ReplicationOperation&lt;&gt;(
264             request,
265             createPrimary(primaryRouting, replicationGroup),
266             listener,
267             proxy,
268             logger,
269             "test",
270             primaryTerm
271         );
272         operation.execute();
273         CapturingTransport.CapturedRequest[] capturedRequests = transport.getCapturedRequestsAndClear();
274         assertThat(capturedRequests.length, equalTo(nbReplicas));
275         for (CapturingTransport.CapturedRequest capturedRequest : capturedRequests) {
276 <a name="9"></a>            String actionName = capturedRequest.action;
277             if (actionName.startsWith(ShardStateAction.SHARD_FAILED_ACTION_NAME)) {
278                 assertThat(capturedRequest.request, instanceOf(ShardStateAction.FailedShardEntry.class));
279                 <font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>String allocationId = ((ShardStateAction.FailedShardEntry) capturedRequest.request).getAllocationId();
280                 assertTrue(unavailableShards.stream()
281                                .anyMatch(shardRouting -&gt; shardRouting.allocationId().getId().equals(allocationId)));
282                 transport.handleResponse</b></font>(capturedRequest.requestId, TransportResponse.Empty.INSTANCE);
283 <a name="7"></a>
284             } else if (actionName.startsWith(TransportVerifyShardBeforeCloseAction.NAME)) {
285                 assertThat(capturedRequest.request, instanceOf(ConcreteShardRequest.class));
286                 String allocationId = <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>((ConcreteShardRequest) capturedRequest.request).getTargetAllocationID();
287                 assertFalse(unavailableShards.stream()
288                                 .anyMatch(shardRouting -&gt; shardRouting.allocationId().getId().equals(allocationId)));
289                 assertTrue(inSyncAllocationIds.stream</b></font>()
290                                .anyMatch(inSyncAllocationId -&gt; inSyncAllocationId.equals(allocationId)));
291                 transport.handleResponse(
292                     capturedRequest.requestId,
293                     new TransportReplicationAction.ReplicaResponse(0L, 0L));
294             } else {
295                 fail("Test does not support action " + capturedRequest.action);
296 <a name="1"></a>            }
297         }
298         ReplicationResponse.ShardInfo shardInfo = <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>listener.get().getShardInfo();
299         assertThat(shardInfo.getFailed(), equalTo(0));
300         assertThat(shardInfo.getFailures(), arrayWithSize(0));
301         assertThat(shardInfo.getSuccessful(), equalTo(1 + nbReplicas - unavailableShards.size()));
302     }
303     private stati</b></font>c ReplicationOperation.Primary&lt;
304         TransportVerifyShardBeforeCloseAction.ShardRequest,
305         TransportVerifyShardBeforeCloseAction.ShardRequest,
306         PrimaryResult&gt;
307     createPrimary(final ShardRouting primary, final ReplicationGroup replicationGroup) {
308         return new ReplicationOperation.Primary&lt;&gt;() {
309             @Override
310             public ShardRouting routingEntry() {
311                 return primary;
312             }
313             @Override
314             public ReplicationGroup getReplicationGroup() {
315                 return replicationGroup;
316             }
317             @Override
318             public void perform(
319                 TransportVerifyShardBeforeCloseAction.ShardRequest request, ActionListener&lt;PrimaryResult&gt; listener) {
320                 listener.onResponse(new PrimaryResult(request));
321             }
322             @Override
323             public void failShard(String message, Exception exception) {
324             }
325             @Override
326             public void updateLocalCheckpointForShard(String allocationId, long checkpoint) {
327             }
328             @Override
329             public void updateGlobalCheckpointForShard(String allocationId, long globalCheckpoint) {
330             }
331             @Override
332             public long localCheckpoint() {
333                 return 0;
334             }
335             @Override
336             public long computedGlobalCheckpoint() {
337                 return 0;
338             }
339             @Override
340             public long globalCheckpoint() {
341                 return 0;
342             }
343             @Override
344             public long maxSeqNoOfUpdatesOrDeletes() {
345                 return 0;
346             }
347         };
348     }
349     private static class PrimaryResult implements ReplicationOperation.PrimaryResult&lt;TransportVerifyShardBeforeCloseAction.ShardRequest&gt; {
350         private final TransportVerifyShardBeforeCloseAction.ShardRequest replicaRequest;
351         private final SetOnce&lt;ReplicationResponse.ShardInfo&gt; shardInfo;
352         private PrimaryResult(final TransportVerifyShardBeforeCloseAction.ShardRequest replicaRequest) {
353             this.replicaRequest = replicaRequest;
354             this.shardInfo = new SetOnce&lt;&gt;();
355         }
356         @Override
357         public TransportVerifyShardBeforeCloseAction.ShardRequest replicaRequest() {
358             return replicaRequest;
359         }
360         @Override
361         public void setShardInfo(ReplicationResponse.ShardInfo shardInfo) {
362             this.shardInfo.set(shardInfo);
363         }
364         @Override
365         public void runPostReplicationActions(ActionListener&lt;Void&gt; listener) {
366             listener.onResponse(null);
367         }
368         public ReplicationResponse.ShardInfo getShardInfo() {
369             return shardInfo.get();
370         }
371     }
372 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>SettingsTests.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19 <a name="0"></a> * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>package org.elasticsearch.common.settings;
22 import org.elasticsearch.Version;
23 import org.elasticsearch.common.Strings;
24 import org.elasticsearch.common.bytes.BytesReference;
25 import org.elasticsearch.common.io.stream.BytesStreamOutput;
26 import org.elasticsearch.common.io.stream.StreamInput;
27 import org.elasticsearch.common.xcontent.ToXContent;
28 import org.elasticsearch.common.xcontent.XContentBuilder;
29 import org.elasticsearch.common.xcontent.XContentParser;
30 import org.elasticsearch.common.xcontent.XContentType;
31 import org.elasticsearch.test.ESTestCase;
32 import org.junit.Test;
33 import java.io.ByteArrayInputStream;
34 import java.io.IOException;
35 import java.util.Arrays;
36 import java.util.Collections;
37 import java.util.Iterator;
38 import java.util.Map;
39 import java.util.NoSuchElementException;
40 import java.util.Set;
41 import static org.hamcrest.Matchers.contains;
42 import static org.hamcrest.Matchers.containsInAnyOrder;
43 import static org.hamcrest.Matchers.containsString;
44 import static org.hamcrest.Matchers.equalTo;
45 import static org.hamcrest.Matchers.hasEntry;
46 import static org.hamcrest.Matchers.hasToString;
47 import static org.hamcrest.Matchers.is;
48 import static org.hamcrest.Matchers.notNullValue;
49 import</b></font> static org.hamcrest.Matchers.nullValue;
50 public class SettingsTests extends ESTestCase {
51     @Test
52 <a name="6"></a>    public void testReplacePropertiesPlaceholderSystemProperty() {
53         String value = System.getProperty("java.home");
54         assertFalse(value.isEmpty());
55         Settings settings = <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>Settings.builder()
56             .put("property.placeholder", value)
57             .put("setting1", "${property.placeholder}")
58             .replacePropertyPlaceholders()
59             .build();
60         assertThat(settings.get("setting1"), equalTo(value));
61     }
62     @Test
63     public void testReplacePropertiesPlaceholderSystemPropertyList() {</b></font>
64         final String hostname = randomAlphaOfLength(16);
65 <a name="11"></a>        final String hostip = randomAlphaOfLength(16);
66         final Settings settings = Settings.builder()
67             .putList("setting1", "${HOSTNAME}", "${HOSTIP}")
68             .replacePropertyPlaceholders(name -&gt; name.equals("HOSTNAME") ? hostname : <font color="#b041ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>name.equals("HOSTIP") ? hostip : null)
69             .build();
70         assertThat(settings.getAsList("setting1"), contains(hostname, hostip));
71     }
72     @Test
73     public void testReplacePropertiesPlaceholderSystemVariablesHaveNoEffect() {</b></font>
74         final String value = System.getProperty("java.home");
75         assertNotNull(value);
76         final IllegalArgumentException e = expectThrows(IllegalArgumentException.class, () -&gt; Settings.builder()
77             .put("setting1", "${java.home}")
78             .replacePropertyPlaceholders()
79             .build());
80         assertThat(e, hasToString(containsString("Could not resolve placeholder 'java.home'")));
81     }
82     @Test
83     public void testReplacePropertiesPlaceholderByEnvironmentVariables() {
84         final String hostname = randomAlphaOfLength(16);
85         final Settings implicitEnvSettings = Settings.builder()
86             .put("setting1", "${HOSTNAME}")
87 <a name="8"></a>            .replacePropertyPlaceholders(name -&gt; "HOSTNAME".equals(name) ? hostname : null)
88             .build();
89         assertThat(implicitEnvSettings.get("setting1"), equalTo(hostname));
90     <font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}
91     @Test
92     public void testGetAsSettings() {
93         Settings settings = Settings.builder()</b></font>
94             .put("bar", "hello world")
95             .put("foo", "abc")
96             .put("foo.bar", "def")
97 <a name="5"></a>            .put("foo.baz", "ghi").build();
98         Settings fooSettings = settings.getAsSettings("foo");
99         assertFalse(<font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>fooSettings.isEmpty());
100         assertEquals(2, fooSettings.size());
101         assertThat(fooSettings.get("bar"), equalTo("def"));
102         assertThat(fooSettings.get("baz"), equalTo("ghi"));
103     }
104 <a name="7"></a>
105     @Test
106     public void testMultLevelGetPrefix() {</b></font>
107         Settings settings = <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>Settings.builder()
108             .put("1.2.3", "hello world")
109             .put("1.2.3.4", "abc")
110             .put("2.3.4", "def")
111             .put("3.4", "ghi").build();
112         Settings firstLevelSettings = settings.getByPrefix("1.");
113         assertFalse(firstLevelSettings.isEmpty());
114         assertEquals(2, firstLevelSettings.size());
115         assertThat</b></font>(firstLevelSettings.get("2.3.4"), equalTo("abc"));
116         assertThat(firstLevelSettings.get("2.3"), equalTo("hello world"));
117         Settings secondLevelSetting = firstLevelSettings.getByPrefix("2.");
118         assertFalse(secondLevelSetting.isEmpty());
119         assertEquals(2, secondLevelSetting.size());
120         assertNull(secondLevelSetting.get("2.3.4"));
121         assertNull(secondLevelSetting.get("1.2.3.4"));
122         assertNull(secondLevelSetting.get("1.2.3"));
123         assertThat(secondLevelSetting.get("3.4"), equalTo("abc"));
124 <a name="1"></a>        assertThat(secondLevelSetting.get("3"), equalTo("hello world"));
125         Settings thirdLevelSetting = secondLevelSetting.getByPrefix("3.");
126         assertFalse(<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>thirdLevelSetting.isEmpty());
127         assertEquals(1, thirdLevelSetting.size());
128         assertNull(thirdLevelSetting.get("2.3.4"));
129         assertNull(thirdLevelSetting.get("3.4"));
130         assertNull(thirdLevelSetting.get("1.2.3"));
131         assertThat(thirdLevelSetting.get("4"), equalTo("abc"));
132     }
133     @Test</b></font>
134     public void testNames() {
135         Settings settings = Settings.builder()
136             .put("bar", "baz")
137             .put("foo", "abc")
138             .put("foo.bar", "def")
139             .put("foo.baz", "ghi").build();
140         Set&lt;String&gt; names = settings.names();
141         assertThat(names.size(), equalTo(2));
142         assertTrue(names.contains("bar"));
143         assertTrue(names.contains("foo"));
144         Settings fooSettings = settings.getAsSettings("foo");
145         names = fooSettings.names();
146         assertThat(names.size(), equalTo(2));
147         assertTrue(names.contains("bar"));
148         assertTrue(names.contains("baz"));
149     }
150     @Test
151     public void testThatArraysAreOverriddenCorrectly() throws IOException {
152         Settings settings = Settings.builder()
153             .put(Settings.builder().putList("value", "1").build())
154             .put(Settings.builder().putList("value", "2", "3").build())
155             .build();
156         assertThat(settings.getAsList("value"), contains("2", "3"));
157         settings = Settings.builder()
158             .put(Settings.builder().put("value", "1").build())
159             .put(Settings.builder().putList("value", "2", "3").build())
160             .build();
161         assertThat(settings.getAsList("value"), contains("2", "3"));
162         settings = Settings.builder().loadFromSource("value: 1", XContentType.YAML)
163             .loadFromSource("value: [ 2, 3 ]", XContentType.YAML)
164             .build();
165         assertThat(settings.getAsList("value"), contains("2", "3"));
166         settings = Settings.builder()
167             .put(Settings.builder().put("value.with.deep.key", "1").build())
168             .put(Settings.builder().putList("value.with.deep.key", "2", "3").build())
169             .build();
170         assertThat(settings.getAsList("value.with.deep.key"), contains("2", "3"));
171         settings = Settings.builder()
172             .put(Settings.builder().putList("value", "1", "2").build())
173             .put(Settings.builder().putList("value", "3").build())
174             .build();
175         assertThat(settings.getAsList("value"), contains("3"));
176         settings = Settings.builder()
177             .put(Settings.builder().putList("value", "1", "2", "3").build())
178             .put(Settings.builder().putList("value", "4", "5").build())
179             .build();
180         assertThat(settings.getAsList("value"), contains("4", "5"));
181         settings = Settings.builder()
182             .put(Settings.builder().putList("value.deep.key", "1", "2", "3").build())
183             .put(Settings.builder().putList("value.deep.key", "4", "5").build())
184             .build();
185         assertThat(settings.getAsList("value.deep.key"), contains("4", "5"));
186         settings = Settings.builder()
187             .put(Settings.builder().putList("value", "1", "2").build())
188             .put(Settings.builder().putList("value", "3", "4", "5").build())
189             .build();
190         assertThat(settings.getAsList("value"), contains("3", "4", "5"));
191         settings = Settings.builder()
192             .put(Settings.builder().putList("value.deep.key", "1", "2", "3").build())
193             .put(Settings.builder().putList("value.deep.key", "4", "5").build())
194             .build();
195         assertThat(settings.getAsList("value.deep.key"), contains("4", "5"));
196         settings = Settings.builder()
197             .put(Settings.builder().putList("value", "1", "2").build())
198             .put(Settings.builder().put("value", "3").build())
199             .build();
200         assertThat(settings.getAsList("value"), contains("3"));
201         settings = Settings.builder()
202             .put(Settings.builder().putList("value.deep.key", "1", "2").build())
203             .put(Settings.builder().put("value.deep.key", "3").build())
204             .build();
205         assertThat(settings.getAsList("value.deep.key"), contains("3"));
206         settings = Settings.builder()
207             .put(Settings.builder().putList("value", "1", "2", "3").putList("a", "b", "c").build())
208             .put(Settings.builder().putList("value", "4", "5").putList("d", "e", "f").build())
209             .build();
210         assertThat(settings.getAsList("value"), contains("4", "5"));
211         assertThat(settings.getAsList("a"), contains("b", "c"));
212         assertThat(settings.getAsList("d"), contains("e", "f"));
213         settings = Settings.builder()
214             .put(Settings.builder().putList("value.deep.key", "1", "2", "3").putList("a", "b", "c").build())
215             .put(Settings.builder().putList("value.deep.key", "4", "5").putList("d", "e", "f").build())
216             .build();
217         assertThat(settings.getAsList("value.deep.key"), contains("4", "5"));
218         assertThat(settings.getAsList("a"), notNullValue());
219         assertThat(settings.getAsList("d"), notNullValue());
220         settings = Settings.builder()
221             .put(Settings.builder().put("value.data", "1").build())
222             .put(Settings.builder().putList("value", "4", "5").build())
223             .build();
224         assertThat(settings.getAsList("value"), contains("4", "5"));
225 <a name="4"></a>                settings = Settings.builder()
226             .put(Settings.builder().putList("value", "4", "5").build())
227             .put(<font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>Settings.builder().put("value.data", "1").build())
228             .build();
229         assertThat(settings.get("value.data"), is("1"));
230         assertThat(settings.get("value"), is("[4, 5]"));
231     }
232     @Test
233     public void testPrefixNormalization() {</b></font>
234         Settings settings = Settings.builder().normalizePrefix("foo.").build();
235         assertThat(settings.names().size(), equalTo(0));
236         settings = Settings.builder()
237             .put("bar", "baz")
238             .normalizePrefix("foo.")
239             .build();
240         assertThat(settings.size(), equalTo(1));
241         assertThat(settings.get("bar"), nullValue());
242         assertThat(settings.get("foo.bar"), equalTo("baz"));
243         settings = Settings.builder()
244             .put("bar", "baz")
245             .put("foo.test", "test")
246             .normalizePrefix("foo.")
247             .build();
248         assertThat(settings.size(), equalTo(2));
249         assertThat(settings.get("bar"), nullValue());
250         assertThat(settings.get("foo.bar"), equalTo("baz"));
251         assertThat(settings.get("foo.test"), equalTo("test"));
252         settings = Settings.builder()
253             .put("foo.test", "test")
254             .normalizePrefix("foo.")
255             .build();
256         assertThat(settings.size(), equalTo(1));
257         assertThat(settings.get("foo.test"), equalTo("test"));
258     }
259     @Test
260     public void testFilteredMap() {
261         Settings.Builder builder = Settings.builder();
262         builder.put("a", "a1");
263         builder.put("a.b", "ab1");
264         builder.put("a.b.c", "ab2");
265         builder.put("a.c", "ac1");
266         builder.put("a.b.c.d", "ab3");
267         Settings filteredSettings = builder.build().filter((k) -&gt; k.startsWith("a.b"));
268         assertEquals(3, filteredSettings.size());
269         int numKeys = 0;
270         for (String k : filteredSettings.keySet()) {
271             numKeys++;
272             assertTrue(k.startsWith("a.b"));
273         }
274         assertEquals(3, numKeys);
275         assertFalse(filteredSettings.keySet().contains("a.c"));
276         assertFalse(filteredSettings.keySet().contains("a"));
277         assertTrue(filteredSettings.keySet().contains("a.b"));
278         assertTrue(filteredSettings.keySet().contains("a.b.c"));
279         assertTrue(filteredSettings.keySet().contains("a.b.c.d"));
280         expectThrows(UnsupportedOperationException.class, () -&gt;
281             filteredSettings.keySet().remove("a.b"));
282         assertEquals("ab1", filteredSettings.get("a.b"));
283         assertEquals("ab2", filteredSettings.get("a.b.c"));
284         assertEquals("ab3", filteredSettings.get("a.b.c.d"));
285         Iterator&lt;String&gt; iterator = filteredSettings.keySet().iterator();
286         for (int i = 0; i &lt; 10; i++) {
287             assertTrue(iterator.hasNext());
288         }
289         assertEquals("a.b", iterator.next());
290         if (randomBoolean()) {
291             assertTrue(iterator.hasNext());
292         }
293         assertEquals("a.b.c", iterator.next());
294         if (randomBoolean()) {
295             assertTrue(iterator.hasNext());
296         }
297         assertEquals("a.b.c.d", iterator.next());
298         assertFalse(iterator.hasNext());
299         expectThrows(NoSuchElementException.class, () -&gt; iterator.next());
300     }
301     @Test
302     public void testPrefixMap() {
303         Settings.Builder builder = Settings.builder();
304         builder.put("a", "a1");
305         builder.put("a.b", "ab1");
306         builder.put("a.b.c", "ab2");
307         builder.put("a.c", "ac1");
308         builder.put("a.b.c.d", "ab3");
309         Settings prefixMap = builder.build().getByPrefix("a.");
310         assertEquals(4, prefixMap.size());
311         int numKeys = 0;
312         for (String k : prefixMap.keySet()) {
313             numKeys++;
314             assertTrue(k, k.startsWith("b") || k.startsWith("c"));
315         }
316         assertEquals(4, numKeys);
317         assertFalse(prefixMap.keySet().contains("a"));
318         assertTrue(prefixMap.keySet().contains("c"));
319         assertTrue(prefixMap.keySet().contains("b"));
320         assertTrue(prefixMap.keySet().contains("b.c"));
321         assertTrue(prefixMap.keySet().contains("b.c.d"));
322         expectThrows(UnsupportedOperationException.class, () -&gt;
323             prefixMap.keySet().remove("a.b"));
324         assertEquals("ab1", prefixMap.get("b"));
325         assertEquals("ab2", prefixMap.get("b.c"));
326         assertEquals("ab3", prefixMap.get("b.c.d"));
327         Iterator&lt;String&gt; prefixIterator = prefixMap.keySet().iterator();
328         for (int i = 0; i &lt; 10; i++) {
329             assertTrue(prefixIterator.hasNext());
330         }
331         assertEquals("b", prefixIterator.next());
332         if (randomBoolean()) {
333             assertTrue(prefixIterator.hasNext());
334         }
335         assertEquals("b.c", prefixIterator.next());
336         if (randomBoolean()) {
337             assertTrue(prefixIterator.hasNext());
338         }
339         assertEquals("b.c.d", prefixIterator.next());
340         if (randomBoolean()) {
341             assertTrue(prefixIterator.hasNext());
342         }
343         assertEquals("c", prefixIterator.next());
344         assertFalse(prefixIterator.hasNext());
345         expectThrows(NoSuchElementException.class, () -&gt; prefixIterator.next());
346     }
347     @Test
348     public void testGroupPrefix() {
349         Settings.Builder builder = Settings.builder();
350         builder.put("test.key1.baz", "blah1");
351         builder.put("test.key1.other", "blah2");
352         builder.put("test.key2.baz", "blah3");
353         builder.put("test.key2.else", "blah4");
354         Settings settings = builder.build();
355         Map&lt;String, Settings&gt; groups = settings.getGroups("test");
356         assertEquals(2, groups.size());
357         Settings key1 = groups.get("key1");
358         assertNotNull(key1);
359         assertThat(key1.names(), containsInAnyOrder("baz", "other"));
360         Settings key2 = groups.get("key2");
361         assertNotNull(key2);
362         assertThat(key2.names(), containsInAnyOrder("baz", "else"));
363     }
364     @Test
365     public void testEmptyFilterMap() {
366         Settings.Builder builder = Settings.builder();
367         builder.put("a", "a1");
368 <a name="10"></a>        builder.put("a.b", "ab1");
369         builder.put("a.b.c", "ab2");
370         builder.put("a.c", "ac1");
371         <font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>builder.put("a.b.c.d", "ab3");
372         Settings filteredSettings = builder.build().filter((k) -&gt; false);
373         assertEquals(0, filteredSettings.size());
374         assertFalse(filteredSettings.keySet().contains</b></font>("a.c"));
375         assertFalse(filteredSettings.keySet().contains("a"));
376         assertFalse(filteredSettings.keySet().contains("a.b"));
377         assertFalse(filteredSettings.keySet().contains("a.b.c"));
378         assertFalse(filteredSettings.keySet().contains("a.b.c.d"));
379         expectThrows(UnsupportedOperationException.class, () -&gt;
380             filteredSettings.keySet().remove("a.b"));
381         assertNull(filteredSettings.get("a.b"));
382         assertNull(filteredSettings.get("a.b.c"));
383         assertNull(filteredSettings.get("a.b.c.d"));
384         Iterator&lt;String&gt; iterator = filteredSettings.keySet().iterator();
385         for (int i = 0; i &lt; 10; i++) {
386             assertFalse(iterator.hasNext());
387         }
388 <a name="12"></a>        expectThrows(NoSuchElementException.class, () -&gt; iterator.next());
389     }
390     <font color="#571b7e"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>@Test
391     public void testEmpty() {
392         assertTrue(Settings.EMPTY.isEmpty());
393     }
394     @Test
395     public void testWriteSettingsToStream() throws IOException {</b></font>
396         BytesStreamOutput out = new BytesStreamOutput();
397         Settings.Builder builder = Settings.builder();
398         builder.put("test.key1.baz", "blah1");
399         builder.putNull("test.key3.bar");
400         builder.putList("test.key4.foo", "1", "2");
401         assertEquals(3, builder.build().size());
402         Settings.writeSettingsToStream(builder.build(), out);
403         StreamInput in = StreamInput.wrap(out.bytes().toBytesRef().bytes);
404         Settings settings = Settings.readSettingsFromStream(in);
405         assertEquals(3, settings.size());
406         assertEquals("blah1", settings.get("test.key1.baz"));
407         assertNull(settings.get("test.key3.bar"));
408         assertTrue(settings.keySet().contains("test.key3.bar"));
409         assertEquals(Arrays.asList("1", "2"), settings.getAsList("test.key4.foo"));
410     }
411 <a name="3"></a>
412     @Test
413     public void testGetAsArrayFailsOnDuplicates() {
414         <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>final IllegalStateException e = expectThrows(IllegalStateException.class, () -&gt; Settings.builder()
415             .put("foobar.0", "bar")
416             .put("foobar.1", "baz")
417             .put("foobar", "foo")
418             .build());
419         assertThat(e,
420                    hasToString(containsString(
421                        "settings builder can't contain values for [foobar=foo] and [foobar.0=bar]")));
422     }
423     @Test
424     public void testToAndFromXContent() throws IOException {</b></font>
425         Settings settings = Settings.builder()
426             .putList("foo.bar.baz", "1", "2", "3")
427             .put("foo.foobar", 2)
428             .put("rootfoo", "test")
429             .put("foo.baz", "1,2,3,4")
430             .putNull("foo.null.baz")
431             .build();
432         final boolean flatSettings = randomBoolean();
433         XContentBuilder builder = XContentBuilder.builder(XContentType.JSON.xContent());
434         builder.startObject();
435         settings.toXContent(builder,
436                             new ToXContent.MapParams(Collections.singletonMap("flat_settings", "" + flatSettings)));
437         builder.endObject();
438         XContentParser parser = createParser(builder);
439 <a name="2"></a>        Settings build = Settings.fromXContent(parser);
440         assertEquals(5, build.size());
441         assertEquals(Arrays.asList("1", "2", "3"), build.getAsList("foo.bar.baz"));
442         assertEquals(2, <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>build.getAsInt("foo.foobar", 0).intValue());
443         assertEquals("test", build.get("rootfoo"));
444         assertEquals("1,2,3,4", build.get("foo.baz"));
445         assertNull(build.get("foo.null.baz"));
446     }
447     @Test
448     public void testSimpleJsonSettings() throws Exception {
449         final String json = "/org/elasticsearch/common/settings/loader/test-settings.json";
450         final Settings settings = Settings.builder()</b></font>
451             .loadFromStream(json, getClass().getResourceAsStream(json), false)
452             .build();
453         assertThat(settings.get("test1.value1"), equalTo("value1"));
454         assertThat(settings.get("test1.test2.value2"), equalTo("value2"));
455         assertThat(settings.getAsInt("test1.test2.value3", -1), equalTo(2));
456         assertNull(settings.get("test1.test3.0"));
457         assertNull(settings.get("test1.test3.1"));
458         assertThat(settings.getAsList("test1.test3").size(), equalTo(2));
459         assertThat(settings.getAsList("test1.test3").get(0), equalTo("test3-1"));
460         assertThat(settings.getAsList("test1.test3").get(1), equalTo("test3-2"));
461     }
462 <a name="9"></a>    @Test
463     public void testToXContent() throws IOException {
464         <font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>Settings test = Settings.builder().putList("foo.bar", "1", "2", "3").put("foo.bar.baz", "test").build();
465         XContentBuilder builder = XContentBuilder.builder(XContentType.JSON.xContent());
466         builder.startObject();
467         test.toXContent</b></font>(builder, new ToXContent.MapParams(Collections.emptyMap()));
468         builder.endObject();
469 <a name="13"></a>        assertEquals("{\"foo\":{\"bar.baz\":\"test\",\"bar\":[\"1\",\"2\",\"3\"]}}", Strings.toString(builder));
470         test = Settings.builder().putList("foo.bar", "1", "2", "3").build();
471         builder = <font color="#3b9c9c"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>XContentBuilder.builder(XContentType.JSON.xContent());
472         builder.startObject();
473         test.toXContent(builder, new ToXContent.MapParams(Collections.emptyMap()));
474         builder.endObject();
475         assertEquals("{\"foo\":{\"bar\":[\"1\",\"2\",\"3\"]}}", Strings.toString</b></font>(builder));
476         builder = XContentBuilder.builder(XContentType.JSON.xContent());
477         builder.startObject();
478         test.toXContent(builder, new ToXContent.MapParams(Collections.singletonMap("flat_settings", "true")));
479         builder.endObject();
480         assertEquals("{\"foo.bar\":[\"1\",\"2\",\"3\"]}", Strings.toString(builder));
481     }
482     @Test
483     public void testLoadEmptyStream() throws IOException {
484         Settings test = Settings.builder().loadFromStream("test.json",
485                                                           new ByteArrayInputStream(new byte[0]),
486                                                           false)
487             .build();
488         assertEquals(0, test.size());
489     }
490     @Test
491     public void testReadWriteArray() throws IOException {
492         BytesStreamOutput output = new BytesStreamOutput();
493         //output.setVersion(randomFrom(Version.CURRENT, Version.V_7_0_0));
494         output.setVersion(Version.CURRENT);
495         Settings settings = Settings.builder().putList("foo.bar", "0", "1", "2", "3").put("foo.bar.baz", "baz").build();
496         Settings.writeSettingsToStream(settings, output);
497         StreamInput in = StreamInput.wrap(BytesReference.toBytes(output.bytes()));
498         Settings build = Settings.readSettingsFromStream(in);
499         assertEquals(2, build.size());
500         assertEquals(build.getAsList("foo.bar"), Arrays.asList("0", "1", "2", "3"));
501         assertEquals(build.get("foo.bar.baz"), "baz");
502     }
503     @Test
504     public void testCopy() {
505         Settings settings = Settings.builder().putList("foo.bar", "0", "1", "2", "3").put("foo.bar.baz", "baz").putNull(
506             "test").build();
507         assertEquals(Arrays.asList("0", "1", "2", "3"),
508                      Settings.builder().copy("foo.bar", settings).build().getAsList("foo.bar"));
509         assertEquals("baz", Settings.builder().copy("foo.bar.baz", settings).build().get("foo.bar.baz"));
510         assertNull(Settings.builder().copy("foo.bar.baz", settings).build().get("test"));
511         assertTrue(Settings.builder().copy("test", settings).build().keySet().contains("test"));
512         IllegalArgumentException iae = expectThrows(IllegalArgumentException.class,
513                                                     () -&gt; Settings.builder().copy("not_there", settings));
514         assertEquals("source key not found in the source settings", iae.getMessage());
515     }
516     @Test
517     public void testGetAsStructuredMapNoSettingToMask() {
518         Settings settings = Settings.builder()
519             .put("masked", "masked_value")
520             .build();
521         Map&lt;String, Object&gt; map = settings.getAsStructuredMap(Set.of());
522         assertThat(map, hasEntry("masked", "masked_value"));
523     }
524     @Test
525     public void testGetAsStructuredMapMaskingValues() {
526         Settings settings = Settings.builder()
527             .put("masked", "masked_value")
528             .build();
529         Map&lt;String, Object&gt; map = settings.getAsStructuredMap(Set.of("masked"));
530         assertThat(map, hasEntry("masked", Settings.MASKED_VALUE));
531     }
532 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
