<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for DDLIntegrationTest.java & PublicationTests.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for DDLIntegrationTest.java & PublicationTests.java
      </h3>
      <h1 align="center">
        22.3%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>DDLIntegrationTest.java (23.529411%)<TH>PublicationTests.java (21.205822%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#0',2,'match485023-1.html#0',3)" NAME="0">(22-62)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#0',2,'match485023-1.html#0',3)" NAME="0">(20-58)</A><TD ALIGN=center><FONT COLOR="#ff0000">37</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#1',2,'match485023-1.html#1',3)" NAME="1">(419-438)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#1',2,'match485023-1.html#1',3)" NAME="1">(343-349)</A><TD ALIGN=center><FONT COLOR="#6e0000">16</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#2',2,'match485023-1.html#2',3)" NAME="2">(381-394)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#2',2,'match485023-1.html#2',3)" NAME="2">(290-296)</A><TD ALIGN=center><FONT COLOR="#6e0000">16</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#3',2,'match485023-1.html#3',3)" NAME="3">(754-758)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#3',2,'match485023-1.html#3',3)" NAME="3">(182-187)</A><TD ALIGN=center><FONT COLOR="#600000">14</FONT>
<TR><TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#4',2,'match485023-1.html#4',3)" NAME="4">(342-354)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#4',2,'match485023-1.html#4',3)" NAME="4">(222-225)</A><TD ALIGN=center><FONT COLOR="#600000">14</FONT>
<TR><TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#5',2,'match485023-1.html#5',3)" NAME="5">(362-375)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#5',2,'match485023-1.html#5',3)" NAME="5">(203-207)</A><TD ALIGN=center><FONT COLOR="#590000">13</FONT>
<TR><TD BGCOLOR="#8c8774"><FONT COLOR="#8c8774">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#6',2,'match485023-1.html#6',3)" NAME="6">(453-464)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#6',2,'match485023-1.html#6',3)" NAME="6">(237-244)</A><TD ALIGN=center><FONT COLOR="#520000">12</FONT>
<TR><TD BGCOLOR="#38a4a5"><FONT COLOR="#38a4a5">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#7',2,'match485023-1.html#7',3)" NAME="7">(81-96)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#7',2,'match485023-1.html#7',3)" NAME="7">(380-383)</A><TD ALIGN=center><FONT COLOR="#520000">12</FONT>
<TR><TD BGCOLOR="#c58917"><FONT COLOR="#c58917">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#8',2,'match485023-1.html#8',3)" NAME="8">(575-588)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#8',2,'match485023-1.html#8',3)" NAME="8">(195-199)</A><TD ALIGN=center><FONT COLOR="#4b0000">11</FONT>
<TR><TD BGCOLOR="#83a33a"><FONT COLOR="#83a33a">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#9',2,'match485023-1.html#9',3)" NAME="9">(473-481)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#9',2,'match485023-1.html#9',3)" NAME="9">(246-253)</A><TD ALIGN=center><FONT COLOR="#4b0000">11</FONT>
<TR><TD BGCOLOR="#ad5910"><FONT COLOR="#ad5910">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#10',2,'match485023-1.html#10',3)" NAME="10">(441-451)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#10',2,'match485023-1.html#10',3)" NAME="10">(171-177)</A><TD ALIGN=center><FONT COLOR="#4b0000">11</FONT>
<TR><TD BGCOLOR="#b041ff"><FONT COLOR="#b041ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#11',2,'match485023-1.html#11',3)" NAME="11">(111-131)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#11',2,'match485023-1.html#11',3)" NAME="11">(354-359)</A><TD ALIGN=center><FONT COLOR="#440000">10</FONT>
<TR><TD BGCOLOR="#571b7e"><FONT COLOR="#571b7e">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#12',2,'match485023-1.html#12',3)" NAME="12">(552-562)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#12',2,'match485023-1.html#12',3)" NAME="12">(258-260)</A><TD ALIGN=center><FONT COLOR="#3e0000">9</FONT>
<TR><TD BGCOLOR="#3b9c9c"><FONT COLOR="#3b9c9c">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#13',2,'match485023-1.html#13',3)" NAME="13">(496-504)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#13',2,'match485023-1.html#13',3)" NAME="13">(405-407)</A><TD ALIGN=center><FONT COLOR="#3e0000">9</FONT>
<TR><TD BGCOLOR="#842dce"><FONT COLOR="#842dce">-</FONT><TD><A HREF="javascript:ZweiFrames('match485023-0.html#14',2,'match485023-1.html#14',3)" NAME="14">(395-404)<TD><A HREF="javascript:ZweiFrames('match485023-0.html#14',2,'match485023-1.html#14',3)" NAME="14">(225-230)</A><TD ALIGN=center><FONT COLOR="#3e0000">9</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>DDLIntegrationTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<A NAME="0"></A> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match485023-1.html#0',3,'match485023-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>package io.crate.integrationtests;

import static com.carrotsearch.randomizedtesting.RandomizedTest.$;
import static io.crate.protocols.postgres.PGErrorStatus.DUPLICATE_TABLE;
import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_TABLE;
import static io.crate.testing.Asserts.assertThrowsMatches;
import static io.crate.testing.SQLErrorMatcher.isSQLError;
import static io.crate.testing.TestingHelpers.printedTable;
import static io.netty.handler.codec.http.HttpResponseStatus.BAD_REQUEST;
import static io.netty.handler.codec.http.HttpResponseStatus.CONFLICT;
import static io.netty.handler.codec.http.HttpResponseStatus.NOT_FOUND;
import static io.netty.handler.codec.rtsp.RtspResponseStatuses.INTERNAL_SERVER_ERROR;
import static org.hamcrest.CoreMatchers.startsWith;
import static org.hamcrest.Matchers.containsString;
import static org.hamcrest.core.Is.is;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;

import org.elasticsearch.Version;
import org.elasticsearch.action.admin.indices.template.get.GetIndexTemplatesResponse;
import org.elasticsearch.cluster.metadata.IndexMetadata;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.test.ESIntegTestCase;
import org.hamcrest.Matchers;
import org.junit.Test;
import org.skyscreamer.jsonassert.JSONAssert;
import org.skyscreamer.jsonassert.JSONCompareMode;

import io.crate.metadata.PartitionName;
import io.crate.metadata.RelationName;
import io.crate.metadata.Schemas;
import io.crate.protocols.postgres.PGErrorStatus;
import io.crate.testing.Asserts;
import io.crate.testing.SQLErrorMatcher;
import io.crate.testing.TestingHelpers;
import io.crate.testing.UseRandomizedSchema;
import</B></FONT> io.netty.handler.codec.http.HttpResponseStatus;

@ESIntegTestCase.ClusterScope()
@UseRandomizedSchema(random = false)
public class DDLIntegrationTest extends SQLIntegrationTestCase {

    @Test
    public void testCreateTable() throws Exception {
        execute(&quot;create table test (col1 integer primary key, col2 string) &quot; +
                &quot;clustered into 5 shards with (number_of_replicas = 1, \&quot;write.wait_for_active_shards\&quot;=1)&quot;);
        String expectedMapping = &quot;{\&quot;default\&quot;:{&quot; +
                                 &quot;\&quot;dynamic\&quot;:\&quot;strict\&quot;,\&quot;_meta\&quot;:{&quot; +
                                 &quot;\&quot;primary_keys\&quot;:[\&quot;col1\&quot;]},&quot; +
                                 &quot;\&quot;properties\&quot;:{&quot; +
                                 // doc_values: true is default and not included
                                 &quot;\&quot;col1\&quot;:{\&quot;type\&quot;:\&quot;integer\&quot;,\&quot;position\&quot;:1},&quot; +
<A NAME="7"></A>                                 &quot;\&quot;col2\&quot;:{\&quot;type\&quot;:\&quot;keyword\&quot;,\&quot;position\&quot;:2}&quot; +
                                 &quot;}}}&quot;;

        <FONT color="#38a4a5"><A HREF="javascript:ZweiFrames('match485023-1.html#7',3,'match485023-top.html#7',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>String expectedSettings = &quot;{\&quot;test\&quot;:{&quot; +
                                  &quot;\&quot;settings\&quot;:{&quot; +
                                  &quot;\&quot;index.number_of_replicas\&quot;:\&quot;1\&quot;,&quot; +
                                  &quot;\&quot;index.number_of_shards\&quot;:\&quot;5\&quot;,&quot; +
                                  &quot;\&quot;index.version.created\&quot;:\&quot;&quot; + Version.CURRENT.internalId + &quot;\&quot;&quot; +
                                  &quot;}}}&quot;;

        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));
        JSONAssert.assertEquals(expectedSettings, getIndexSettings(&quot;test&quot;), false);

        // test index usage
        execute(&quot;insert into test (col1, col2) values (1, 'foo')&quot;);
        assertEquals(1, response.rowCount());
        refresh();
        execute(&quot;SELECT * FROM test&quot;);
        assertEquals(1L, response.rowCount</B></FONT>());
    }

    @Test
    public void testCreateTableWithRefreshIntervalDisableRefresh() throws Exception {
        execute(&quot;create table test (id int primary key, content string) &quot; +
                &quot;clustered into 5 shards &quot; +
                &quot;with (refresh_interval=0, number_of_replicas = 0)&quot;);
        String expectedSettings = &quot;{\&quot;test\&quot;:{&quot; +
                                  &quot;\&quot;settings\&quot;:{&quot; +
                                  &quot;\&quot;index.number_of_replicas\&quot;:\&quot;0\&quot;,&quot; +
                                  &quot;\&quot;index.number_of_shards\&quot;:\&quot;5\&quot;,&quot; +
<A NAME="11"></A>                                  &quot;\&quot;index.refresh_interval\&quot;:\&quot;0s\&quot;,&quot; +
                                  &quot;\&quot;index.version.created\&quot;:\&quot;&quot; + Version.CURRENT.internalId + &quot;\&quot;&quot; +
                                  &quot;}}}&quot;;
        <FONT color="#b041ff"><A HREF="javascript:ZweiFrames('match485023-1.html#11',3,'match485023-top.html#11',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>JSONAssert.assertEquals(expectedSettings, getIndexSettings(&quot;test&quot;), false);

        execute(&quot;ALTER TABLE test SET (refresh_interval = '5000ms')&quot;);
        String expectedSetSettings = &quot;{\&quot;test\&quot;:{&quot; +
                                     &quot;\&quot;settings\&quot;:{&quot; +
                                     &quot;\&quot;index.number_of_replicas\&quot;:\&quot;0\&quot;,&quot; +
                                     &quot;\&quot;index.number_of_shards\&quot;:\&quot;5\&quot;,&quot; +
                                     &quot;\&quot;index.refresh_interval\&quot;:\&quot;5s\&quot;,&quot; +
                                     &quot;\&quot;index.version.created\&quot;:\&quot;&quot; + Version.CURRENT.internalId + &quot;\&quot;&quot; +
                                     &quot;}}}&quot;;
        JSONAssert.assertEquals(expectedSetSettings, getIndexSettings(&quot;test&quot;), false);

        execute(&quot;ALTER TABLE test RESET (refresh_interval)&quot;);
        String expectedResetSettings = &quot;{\&quot;test\&quot;:{&quot; +
                                       &quot;\&quot;settings\&quot;:{&quot; +
                                       &quot;\&quot;index.number_of_replicas\&quot;:\&quot;0\&quot;,&quot; +
                                       &quot;\&quot;index.number_of_shards\&quot;:\&quot;5\&quot;,&quot; +
                                       &quot;\&quot;index.refresh_interval\&quot;:\&quot;1s\&quot;,&quot; +
                                       &quot;\&quot;index.version.created\&quot;:\&quot;&quot; + Version.CURRENT.internalId + &quot;\&quot;&quot; +
                                       &quot;}}}&quot;;
        JSONAssert.assertEquals(expectedResetSettings, getIndexSettings</B></FONT>(&quot;test&quot;), false);
    }


    @Test
    public void testCreateTableAlreadyExistsException() throws Exception {
        execute(&quot;create table test (col1 integer primary key, col2 string)&quot;);
        ensureYellow();
        assertThrowsMatches(() -&gt; execute(&quot;create table test (col1 integer primary key, col2 string)&quot;),
                     isSQLError(is(&quot;Relation 'doc.test' already exists.&quot;),
                                DUPLICATE_TABLE,
                                CONFLICT,
                                4093)
        );
    }

    @Test
    public void testCreateTableWithReplicasAndShards() throws Exception {
        execute(&quot;create table test (col1 integer primary key, col2 string)&quot; +
                &quot;clustered by (col1) into 10 shards with (number_of_replicas=2, \&quot;write.wait_for_active_shards\&quot;=1)&quot;);
        String expectedMapping = &quot;{\&quot;default\&quot;:{&quot; +
                                 &quot;\&quot;dynamic\&quot;:\&quot;strict\&quot;,&quot; +
                                 &quot;\&quot;_meta\&quot;:{&quot; +
                                 &quot;\&quot;primary_keys\&quot;:[\&quot;col1\&quot;],&quot; +
                                 &quot;\&quot;routing\&quot;:\&quot;col1\&quot;},&quot; +
                                 &quot;\&quot;properties\&quot;:{&quot; +
                                 &quot;\&quot;col1\&quot;:{\&quot;type\&quot;:\&quot;integer\&quot;},&quot; +
                                 &quot;\&quot;col2\&quot;:{\&quot;type\&quot;:\&quot;keyword\&quot;}&quot; +
                                 &quot;}}}&quot;;

        String expectedSettings = &quot;{\&quot;test\&quot;:{&quot; +
                                  &quot;\&quot;settings\&quot;:{&quot; +
                                  &quot;\&quot;index.number_of_replicas\&quot;:\&quot;2\&quot;,&quot; +
                                  &quot;\&quot;index.number_of_shards\&quot;:\&quot;10\&quot;,&quot; +
                                  &quot;\&quot;index.version.created\&quot;:\&quot;&quot; + Version.CURRENT.internalId + &quot;\&quot;&quot; +
                                  &quot;}}}&quot;;

        JSONAssert.assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;), JSONCompareMode.LENIENT);
        JSONAssert.assertEquals(expectedSettings, getIndexSettings(&quot;test&quot;), JSONCompareMode.LENIENT);
    }

    @Test
    public void testCreateTableWithStrictColumnPolicy() throws Exception {
        execute(&quot;create table test (col1 integer primary key, col2 string) &quot; +
                &quot;clustered into 5 shards &quot; +
                &quot;with (column_policy='strict', number_of_replicas = 0)&quot;);
        String expectedMapping = &quot;{\&quot;default\&quot;:{&quot; +
                                 &quot;\&quot;dynamic\&quot;:\&quot;strict\&quot;,\&quot;_meta\&quot;:{&quot; +
                                 &quot;\&quot;primary_keys\&quot;:[\&quot;col1\&quot;]},&quot; +
                                 &quot;\&quot;properties\&quot;:{&quot; +
                                 &quot;\&quot;col1\&quot;:{\&quot;type\&quot;:\&quot;integer\&quot;,\&quot;position\&quot;:1},&quot; +
                                 &quot;\&quot;col2\&quot;:{\&quot;type\&quot;:\&quot;keyword\&quot;,\&quot;position\&quot;:2}&quot; +
                                 &quot;}}}&quot;;

        String expectedSettings = &quot;{\&quot;test\&quot;:{&quot; +
                                  &quot;\&quot;settings\&quot;:{&quot; +
                                  &quot;\&quot;index.number_of_replicas\&quot;:\&quot;0\&quot;,&quot; +
                                  &quot;\&quot;index.number_of_shards\&quot;:\&quot;5\&quot;,&quot; +
                                  &quot;\&quot;index.version.created\&quot;:\&quot;&quot; + Version.CURRENT.internalId + &quot;\&quot;&quot; +
                                  &quot;}}}&quot;;


        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));
        JSONAssert.assertEquals(expectedSettings, getIndexSettings(&quot;test&quot;), false);
    }

    @Test
    public void testCreateGeoShapeExplicitIndex() throws Exception {
        execute(&quot;create table test (col1 geo_shape INDEX using QUADTREE with (precision='1m', distance_error_pct='0.25'))&quot;);
        ensureYellow();
        String expectedMapping = &quot;{\&quot;default\&quot;:{&quot; +
                                 &quot;\&quot;dynamic\&quot;:\&quot;strict\&quot;,\&quot;_meta\&quot;:{},&quot; +
                                 &quot;\&quot;properties\&quot;:{&quot; +
                                 &quot;\&quot;col1\&quot;:{\&quot;type\&quot;:\&quot;geo_shape\&quot;,\&quot;tree\&quot;:\&quot;quadtree\&quot;,\&quot;position\&quot;:1,\&quot;precision\&quot;:\&quot;1.0m\&quot;,\&quot;distance_error_pct\&quot;:0.25}}}}&quot;;
        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));
    }

    @Test
    public void testCreateColumnWithDefaultExpression() throws Exception {
        execute(&quot;create table test (col1 text default 'foo')&quot;);
        String expectedMapping = &quot;{\&quot;default\&quot;:{&quot; +
                                 &quot;\&quot;dynamic\&quot;:\&quot;strict\&quot;,\&quot;_meta\&quot;:{},&quot; +
                                 &quot;\&quot;properties\&quot;:{\&quot;col1\&quot;:{\&quot;type\&quot;:\&quot;keyword\&quot;,\&quot;position\&quot;:1,\&quot;default_expr\&quot;:\&quot;'foo'\&quot;}}}}&quot;;
        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));

    }

    @Test
    public void testCreateGeoShape() throws Exception {
        execute(&quot;create table test (col1 geo_shape)&quot;);
        ensureYellow();
        String expectedMapping = &quot;{\&quot;default\&quot;:{&quot; +
                                 &quot;\&quot;dynamic\&quot;:\&quot;strict\&quot;,\&quot;_meta\&quot;:{},&quot; +
                                 &quot;\&quot;properties\&quot;:{\&quot;col1\&quot;:{\&quot;type\&quot;:\&quot;geo_shape\&quot;,\&quot;position\&quot;:1}}}}&quot;;
        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));

    }

    @Test
    public void testGeoShapeInvalidPrecision() throws Exception {
        assertThrowsMatches(() -&gt; execute(&quot;create table test (col1 geo_shape INDEX using QUADTREE with (precision='10%'))&quot;),
                     isSQLError(is(&quot;Value '10%' of setting precision is not a valid distance unit&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000)
        );
    }

    @Test
    public void testGeoShapeInvalidDistance() throws Exception {
        assertThrowsMatches(() -&gt; execute(
            &quot;create table test (col1 geo_shape INDEX using QUADTREE with (distance_error_pct=true))&quot;),
                     isSQLError(is(&quot;Value 'true' of setting distance_error_pct is not a float value&quot;),
                         INTERNAL_ERROR,
                         BAD_REQUEST,
                         4000)
        );
    }

    @Test
    public void testUnknownGeoShapeSetting() throws Exception {
        assertThrowsMatches(() -&gt; execute(&quot;create table test (col1 geo_shape INDEX using QUADTREE with (does_not_exist=false))&quot;),
                     isSQLError(is(&quot;Setting \&quot;does_not_exist\&quot; ist not supported on geo_shape index&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000)
        );
    }

    @Test
    public void testCreateTableWithInlineDefaultIndex() throws Exception {
        execute(&quot;create table quotes (quote string index using plain) with (number_of_replicas = 0)&quot;);
        String quote = &quot;Would it save you a lot of time if I just gave up and went mad now?&quot;;
        execute(&quot;insert into quotes values (?)&quot;, new Object[]{quote});
        refresh();

        // matching does not work on plain indexes
        execute(&quot;select quote from quotes where match(quote, 'time')&quot;);
        assertEquals(0, response.rowCount());

        // filtering on the actual value does work
        execute(&quot;select quote from quotes where quote = ?&quot;, new Object[]{quote});
        assertEquals(1L, response.rowCount());
        assertEquals(quote, response.rows()[0][0]);
    }

    @Test
    public void testCreateTableWithInlineIndex() throws Exception {
        execute(&quot;create table quotes (quote string index using fulltext) with (number_of_replicas = 0)&quot;);
        String quote = &quot;Would it save you a lot of time if I just gave up and went mad now?&quot;;
        execute(&quot;insert into quotes values (?)&quot;, new Object[]{quote});
        execute(&quot;refresh table quotes&quot;);

        execute(&quot;select quote from quotes where match(quote, 'time')&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(quote, response.rows()[0][0]);

        // filtering on the actual value does not work anymore because its now indexed using the
        // standard analyzer
        execute(&quot;select quote from quotes where quote = ?&quot;, new Object[]{quote});
        assertEquals(0, response.rowCount());
    }

    @Test
    public void testCreateTableWithIndexOff() throws Exception {
        execute(&quot;create table quotes (id int, quote string index off) with (number_of_replicas = 0)&quot;);
        String quote = &quot;Would it save you a lot of time if I just gave up and went mad now?&quot;;
        execute(&quot;insert into quotes (id, quote) values (?, ?)&quot;, new Object[]{1, quote});
        execute(&quot;refresh table quotes&quot;);

        assertThrowsMatches(
            () -&gt; execute(&quot;select quote from quotes where quote = ?&quot;, new Object[]{quote}),
            isSQLError(
                containsString(&quot;Cannot search on field [quote] since it is not indexed.&quot;),
                INTERNAL_ERROR,
                BAD_REQUEST,
                4000
            )
        );
    }

    @Test
    public void testCreateTableWithIndex() throws Exception {
        execute(&quot;create table quotes (quote string, &quot; +
                &quot;index quote_fulltext using fulltext(quote) with (analyzer='stop')) with (number_of_replicas = 0)&quot;);
        String quote = &quot;Would it save you a lot of time if I just gave up and went mad now?&quot;;
        execute(&quot;insert into quotes values (?)&quot;, new Object[]{quote});
        execute(&quot;refresh table quotes&quot;);

        execute(&quot;select quote from quotes where match(quote_fulltext, 'time')&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(quote, response.rows()[0][0]);

        // filtering on the actual value does still work
        execute(&quot;select quote from quotes where quote = ?&quot;, new Object[]{quote});
        assertEquals(1L, response.rowCount());
    }

    @Test
    public void testCreateTableWithCompositeIndex() throws Exception {
        execute(&quot;create table novels (title string, description string, &quot; +
                &quot;index title_desc_fulltext using fulltext(title, description) &quot; +
                &quot;with(analyzer='stop')) with (number_of_replicas = 0)&quot;);

        String title = &quot;So Long, and Thanks for All the Fish&quot;;
        String description = &quot;Many were increasingly of the opinion that they'd all made a big &quot; +
                             &quot;mistake in coming down from the trees in the first place. And some said that &quot; +
                             &quot;even the trees had been a bad move, and that no one should ever have left &quot; +
<A NAME="4"></A>                             &quot;the oceans.&quot;;
        execute(&quot;insert into novels (title, description) values(?, ?)&quot;,
            new Object[]{title, description});
        <FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match485023-1.html#4',3,'match485023-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>refresh();

        // match token existing at field `title`
        execute(&quot;select title, description from novels where match(title_desc_fulltext, 'fish')&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(title, response.rows()[0][0]);
        assertEquals(description, response.rows()[0][1]);

        // match token existing at field `description`
        execute(&quot;select title, description from novels where match(title_desc_fulltext, 'oceans')&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(title, response.rows()[0][0]);
        assertEquals</B></FONT>(description, response.rows()[0][1]);

        // filtering on the actual values does still work
        execute(&quot;select title from novels where title = ?&quot;, new Object[]{title});
        assertEquals(1L, response.rowCount());
<A NAME="5"></A>    }

    @Test
    public void test_create_table_with_check_fail_on_insert() <FONT color="#151b8d"><A HREF="javascript:ZweiFrames('match485023-1.html#5',3,'match485023-top.html#5',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
        execute(&quot;create table t (id integer primary key, qty integer, constraint check_1 check (qty &gt; 0))&quot;);
        execute(&quot;insert into t(id, qty) values(0, null), (1, 1)&quot;);
        refresh();
        execute(&quot;select id, qty from t order by id&quot;);
        assertEquals(printedTable(response.rows()),
                     &quot;0| NULL\n&quot; +
                     &quot;1| 1\n&quot;);
        assertThrowsMatches(() -&gt; execute(&quot;insert into t(id, qty) values(2, -1)&quot;),
                     isSQLError(containsString(&quot;Failed CONSTRAINT check_1 CHECK (\&quot;qty\&quot; &gt; 0) and values&quot;),
                     INTERNAL_ERROR,
                     BAD_REQUEST,
                     4000));
    }</B></FONT>

    @Test
<A NAME="2"></A>    public void test_create_table_with_check_fail_on_update() {
        execute(&quot;create table t (id integer primary key, qty integer constraint check_1 check (qty &gt; 0))&quot;);
        execute(&quot;insert into t(id, qty) values(0, 1)&quot;);
        <FONT color="#980517"><A HREF="javascript:ZweiFrames('match485023-1.html#2',3,'match485023-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>refresh();
        execute(&quot;select id, qty from t order by id&quot;);
        assertEquals(printedTable(response.rows()), &quot;0| 1\n&quot;);
        execute(&quot;update t set qty = 1 where id = 0 returning id, qty&quot;);
        assertEquals(printedTable(response.rows()), &quot;0| 1\n&quot;);
        assertThrowsMatches(() -&gt; execute(&quot;update t set qty = -1 where id = 0&quot;),
                     isSQLError(containsString(&quot;Failed CONSTRAINT check_1 CHECK (\&quot;qty\&quot; &gt; 0) and values&quot;),
                                INTERNAL_ERROR,
                                INTERNAL_SERVER_ERROR,
                                5000));

<A NAME="14"></A>    }

    @Test</B></FONT>
    public void test_alter_table_add_column_succedds_because_check_constaint_refers_to_self_columns() <FONT color="#842dce"><A HREF="javascript:ZweiFrames('match485023-1.html#14',3,'match485023-top.html#14',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
        execute(&quot;create table t (id integer primary key, qty integer constraint check_1 check (qty &gt; 0))&quot;);
        execute(&quot;alter table t add column bazinga integer constraint bazinga_check check(bazinga &lt;&gt; 42)&quot;);
        execute(&quot;insert into t(id, qty, bazinga) values(0, 1, 100)&quot;);
        assertThrowsMatches(() -&gt; execute(&quot;insert into t(id, qty, bazinga) values(0, 1, 42)&quot;),
                     isSQLError(containsString(&quot;Failed CONSTRAINT bazinga_check CHECK (\&quot;bazinga\&quot; &lt;&gt; 42) and values {qty=1, id=0, bazinga=42}&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000));
    }</B></FONT>

    @Test
    public void test_alter_table_drop_constraint_removes_the_constraint_and_leaves_other_constraints_in_place() {
        execute(&quot;create table t (&quot; +
                      &quot;    id int primary key, &quot; +
                      &quot;    qty int constraint check_qty_gt_zero check(qty &gt; 0), &quot; +
                      &quot;    constraint check_id_ge_zero check (id &gt;= 0)&quot; +
                      &quot;)&quot;);
        String selectCheckConstraintsStmt =
            &quot;select table_schema, table_name, constraint_type, constraint_name &quot; +
            &quot;from information_schema.table_constraints &quot; +
<A NAME="1"></A>            &quot;where table_name='t'&quot; +
            &quot;order by constraint_name&quot;;
        execute(selectCheckConstraintsStmt);
        assertThat(printedTable(<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match485023-1.html#1',3,'match485023-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>response.rows()), is(
            &quot;doc| t| CHECK| check_id_ge_zero\n&quot; +
            &quot;doc| t| CHECK| check_qty_gt_zero\n&quot; +
            &quot;doc| t| PRIMARY KEY| t_pk\n&quot;
        ));
        execute(&quot;alter table t drop constraint check_id_ge_zero&quot;);
        execute(selectCheckConstraintsStmt);
        assertThat(printedTable(response.rows()), is(
            &quot;doc| t| CHECK| check_qty_gt_zero\n&quot; +
            &quot;doc| t| PRIMARY KEY| t_pk\n&quot;
        ));
        execute(&quot;insert into t(id, qty) values(-42, 100)&quot;);
        assertThrowsMatches(() -&gt; execute(&quot;insert into t(id, qty) values(0, 0)&quot;),
                     isSQLError(is(&quot;Failed CONSTRAINT check_qty_gt_zero CHECK (\&quot;qty\&quot; &gt; 0) and values {qty=0, id=0}&quot;),
                         INTERNAL_ERROR,
                         BAD_REQUEST,
                         4000));
    }

<A NAME="10"></A>    @Test</B></FONT>
    public void testAlterTable() throws Exception {
        execute(&quot;create table test (col1 int) with (number_of_replicas='0-all')&quot;);
        <FONT color="#ad5910"><A HREF="javascript:ZweiFrames('match485023-1.html#10',3,'match485023-top.html#10',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>ensureYellow();

        execute(&quot;select number_of_replicas from information_schema.tables where table_name = 'test'&quot;);
        assertEquals(&quot;0-all&quot;, response.rows()[0][0]);

        execute(&quot;alter table test set (number_of_replicas=0)&quot;);
        execute(&quot;select number_of_replicas from information_schema.tables where table_name = 'test'&quot;);
        assertEquals(&quot;0&quot;, response.rows()[0][0]);
    }
<A NAME="6"></A>
    @Test</B></FONT>
    public void testAlterTableAddColumn() {
        <FONT color="#8c8774"><A HREF="javascript:ZweiFrames('match485023-1.html#6',3,'match485023-top.html#6',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>execute(&quot;create table t (id int primary key) with (number_of_replicas=0)&quot;);
        execute(&quot;alter table t add column name string&quot;);

        execute(&quot;select data_type from information_schema.columns where &quot; +
                &quot;table_name = 't' and column_name = 'name'&quot;);
        assertThat(response.rows()[0][0], is(&quot;text&quot;));

        execute(&quot;alter table t add column o object as (age int)&quot;);
        execute(&quot;select data_type from information_schema.columns where &quot; +
                &quot;table_name = 't' and column_name = 'o'&quot;);
        assertThat((String) response.rows()[0][0], is(&quot;object&quot;));
    }</B></FONT>


    @Test
    public void testAlterTableAddColumnAsPrimaryKey() throws Exception {
        execute(&quot;create table t (id int primary key) &quot; +
<A NAME="9"></A>                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        <FONT color="#83a33a"><A HREF="javascript:ZweiFrames('match485023-1.html#9',3,'match485023-top.html#9',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>execute(&quot;alter table t add column name string primary key&quot;);
        execute(&quot;select constraint_name from information_schema.table_constraints &quot; +
                &quot;where table_name = 't' and table_schema = 'doc' and constraint_type = 'PRIMARY KEY'&quot;);

        assertThat(response.rowCount(), is(1L));
        assertThat(response.rows()[0][0], is(&quot;t_pk&quot;));
    }

    @Test</B></FONT>
    public void testAlterTableWithRecordsAddColumnAsPrimaryKey() throws Exception {
        execute(&quot;create table t (id int primary key) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (id) values(1)&quot;);
        refresh();

        assertThrowsMatches(() -&gt; execute(&quot;alter table t add column name string primary key&quot;),
        isSQLError(is(&quot;Cannot add a primary key column to a table that isn't empty&quot;), INTERNAL_ERROR, BAD_REQUEST, 4004));
    }
<A NAME="13"></A>
    @Test
    public void testAlterTableWithoutRecordsAddGeneratedColumn() throws Exception {
        <FONT color="#3b9c9c"><A HREF="javascript:ZweiFrames('match485023-1.html#13',3,'match485023-top.html#13',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>execute(&quot;create table t (id int) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;alter table t add column id_generated as (id + 1)&quot;);
        execute(&quot;insert into t (id) values(1)&quot;);
        refresh();
        execute(&quot;select id, id_generated from t&quot;);
        assertThat(response.rows()[0][0], is</B></FONT>(1));
        assertThat(response.rows()[0][1], is(2));
    }

    @Test
    public void testAlterTableWithRecordsAddGeneratedColumn() throws Exception {
        execute(&quot;create table t (id int) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (id) values(1)&quot;);
        refresh();

        assertThrowsMatches(() -&gt; execute(&quot;alter table t add column id_generated as (id + 1)&quot;),
                     isSQLError(is(&quot;Cannot add a generated column to a table that isn't empty&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4004));
    }

    @Test
    public void testAlterTableAddDotExpression() {
        execute(&quot;create table t (id int) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        assertThrowsMatches(() -&gt; execute(&quot;alter table t add \&quot;o.x\&quot; int&quot;),
                     isSQLError(is(&quot;\&quot;o.x\&quot; contains a dot&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4008));
    }

    @Test
    public void testAlterTableAddDotExpressionInSubscript() {
        execute(&quot;create table t (id int) clustered into 1 shards with (number_of_replicas=0)&quot;);
        ensureYellow();

        assertThrowsMatches(() -&gt;  execute(&quot;alter table t add \&quot;o['x.y']\&quot; int&quot;),
                     isSQLError(is(&quot;\&quot;o['x.y']\&quot; contains a dot&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4008));

    }
<A NAME="12"></A>
    @Test
    public void testAlterTableAddObjectColumnToNonExistingObject() {
        <FONT color="#571b7e"><A HREF="javascript:ZweiFrames('match485023-1.html#12',3,'match485023-top.html#12',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>execute(&quot;create table t (id int) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;alter table t add o['x'] int&quot;);
        execute(&quot;select column_name from information_schema.columns where &quot; +
                &quot;table_name = 't' and table_schema='doc'&quot; +
                &quot;order by column_name asc&quot;);
        assertThat(response.rowCount(), is(3L));

        List&lt;String&gt; fqColumnNames = new</B></FONT> ArrayList&lt;&gt;();
        for (Object[] row : response.rows()) {
            fqColumnNames.add((String) row[0]);
        }
        assertThat(fqColumnNames, Matchers.contains(&quot;id&quot;, &quot;o&quot;, &quot;o['x']&quot;));
    }

    @Test
    public void testAlterTableAddObjectColumnToExistingObject() {
        execute(&quot;create table t (o object as (x string)) &quot; +
<A NAME="8"></A>                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        <FONT color="#c58917"><A HREF="javascript:ZweiFrames('match485023-1.html#8',3,'match485023-top.html#8',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>execute(&quot;alter table t add o['y'] int&quot;);
        // column o exists already
        assertThrowsMatches(() -&gt; execute(&quot;alter table t add o object as (z string)&quot;),
                     isSQLError(containsString(&quot;The table doc.t already has a column named o&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000));

        execute(&quot;select column_name from information_schema.columns where &quot; +
                &quot;table_name = 't' and table_schema='doc'&quot; +
                &quot;order by column_name asc&quot;);
        assertThat(response.rowCount(), is(3L));

        List&lt;String&gt; fqColumnNames = new</B></FONT> ArrayList&lt;&gt;();
        for (Object[] row : response.rows()) {
            fqColumnNames.add((String) row[0]);
        }
        assertThat(fqColumnNames, Matchers.contains(&quot;o&quot;, &quot;o['x']&quot;, &quot;o['y']&quot;));
    }

    @Test
    public void testAlterTableAddObjectColumnToExistingObjectNested() throws Exception {
        execute(&quot;CREATE TABLE my_table (&quot; +
                &quot;  name string, &quot; +
                &quot;  age integer,&quot; +
                &quot;  book object as (isbn string)&quot; +
                &quot;)&quot;);
        ensureYellow();
        execute(&quot;alter table my_table add column book['author'] object as (\&quot;authorId\&quot; integer)&quot;);
        waitNoPendingTasksOnAll();
        execute(&quot;select column_name from information_schema.columns where &quot; +
                &quot;table_name = 'my_table' and table_schema='doc'&quot; +
                &quot;order by column_name asc&quot;);
        assertThat(response.rowCount(), is(6L));
        assertThat(TestingHelpers.getColumn(response.rows(), 0),
            is(Matchers.&lt;Object&gt;arrayContaining(&quot;age&quot;, &quot;book&quot;, &quot;book['author']&quot;, &quot;book['author']['authorId']&quot;, &quot;book['isbn']&quot;, &quot;name&quot;)));
        execute(&quot;alter table my_table add column book['author']['authorName'] string&quot;);
        waitNoPendingTasksOnAll();
        execute(&quot;select column_name from information_schema.columns where &quot; +
                &quot;table_name = 'my_table' and table_schema='doc'&quot; +
                &quot;order by column_name asc&quot;);
        assertThat(response.rowCount(), is(7L));
        assertThat(TestingHelpers.getColumn(response.rows(), 0),
            is(Matchers.&lt;Object&gt;arrayContaining(&quot;age&quot;, &quot;book&quot;, &quot;book['author']&quot;, &quot;book['author']['authorId']&quot;, &quot;book['author']['authorName']&quot;, &quot;book['isbn']&quot;, &quot;name&quot;)));

    }

    @Test
    public void testAlterTableAddNestedObjectWithArrayToExistingObject() throws Exception {
        execute(&quot;CREATE TABLE my_table (col1 object)&quot;);
        ensureYellow();
        execute(&quot;ALTER TABLE my_table ADD COLUMN col1['col2'] object as (col3 array(string))&quot;);
        waitNoPendingTasksOnAll();
        execute(&quot;SELECT column_name, data_type FROM information_schema.columns &quot; +
                &quot;WHERE table_name = 'my_table' AND table_schema = 'doc' &quot; +
                &quot;ORDER BY column_name asc&quot;);
        assertThat(TestingHelpers.getColumn(response.rows(), 0),
            is(Matchers.&lt;Object&gt;arrayContaining(&quot;col1&quot;, &quot;col1['col2']&quot;, &quot;col1['col2']['col3']&quot;)));
        assertThat(TestingHelpers.getColumn(response.rows(), 1),
            is(Matchers.arrayContaining(&quot;object&quot;, &quot;object&quot;, &quot;text_array&quot;)));

        execute(&quot;DROP TABLE my_table&quot;);
        ensureYellow();

        execute(&quot;CREATE TABLE my_table (col1 object as (col2 object))&quot;);
        ensureYellow();
        execute(&quot;ALTER TABLE my_table ADD COLUMN col1['col2']['col3'] object as (col4 array(long))&quot;);
        waitNoPendingTasksOnAll();
        execute(&quot;SELECT column_name, data_type FROM information_schema.columns &quot; +
                &quot;WHERE table_name = 'my_table' AND table_schema = 'doc' &quot; +
                &quot;ORDER BY column_name asc&quot;);
        assertThat(TestingHelpers.getColumn(response.rows(), 0),
            is(Matchers.&lt;Object&gt;arrayContaining(&quot;col1&quot;, &quot;col1['col2']&quot;, &quot;col1['col2']['col3']&quot;, &quot;col1['col2']['col3']['col4']&quot;)));
        assertThat(TestingHelpers.getColumn(response.rows(), 1),
            is(Matchers.arrayContaining(&quot;object&quot;, &quot;object&quot;, &quot;object&quot;, &quot;bigint_array&quot;)));
    }

    @Test
    public void testAlterTableAddObjectToObjectArray() throws Exception {
        execute(&quot;CREATE TABLE t (&quot; +
                &quot;   attributes ARRAY(&quot; +
                &quot;       OBJECT (STRICT) as (&quot; +
                &quot;           name STRING&quot; +
                &quot;       )&quot; +
                &quot;   )&quot; +
                &quot;)&quot;);
        ensureYellow();
        execute(&quot;ALTER TABLE t ADD column attributes['is_nice'] BOOLEAN&quot;);
        execute(&quot;INSERT INTO t (attributes) values ([{name='Trillian', is_nice=True}])&quot;);
        refresh();
        execute(&quot;select attributes from t&quot;);
        assertThat(((List&lt;Object&gt;)response.rows()[0][0]).get(0), is(Map.of(&quot;name&quot;, &quot;Trillian&quot;, &quot;is_nice&quot;, true)));
    }

    @Test
    public void testDropTable() throws Exception {
        execute(&quot;create table test (col1 integer primary key, col2 string)&quot;);

        assertThat(internalCluster().clusterService().state().metadata().hasIndex(&quot;test&quot;), is(true));

        execute(&quot;drop table test&quot;);
        assertThat(response.rowCount(), is(1L));

        assertThat(internalCluster().clusterService().state().metadata().hasIndex(&quot;test&quot;), is(false));
    }

    @Test
    public void testDropTableIfExistsRaceCondition() throws Exception {
        execute(&quot;create table test (name string)&quot;);
        execute(&quot;drop table test&quot;);
        // could fail if the meta data update triggered by the previous drop table wasn't fully propagated in the cluster
        execute(&quot;drop table if exists test&quot;);
    }

    @Test
    public void testDropUnknownTable() throws Exception {
        assertThrowsMatches(() -&gt; execute(&quot;drop table test&quot;),
                     isSQLError(is(&quot;Relation 'test' unknown&quot;), UNDEFINED_TABLE, NOT_FOUND, 4041));
    }

    @Test
    public void testDropTableIfExists() {
        execute(&quot;create table test (col1 integer primary key, col2 string)&quot;);

        assertThat(internalCluster().clusterService().state().metadata().hasIndex(&quot;test&quot;), is(true));
        execute(&quot;drop table if exists test&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat(internalCluster().clusterService().state().metadata().hasIndex(&quot;test&quot;), is(false));
    }

    @Test
    public void testDropIfExistsUnknownTable() throws Exception {
        execute(&quot;drop table if exists nonexistent&quot;);
        assertThat(response.rowCount(), is(0L));
    }

    @Test
    public void testCreateAlterAndDropBlobTable() throws Exception {
        execute(&quot;create blob table screenshots with (number_of_replicas=0)&quot;);
        execute(&quot;alter blob table screenshots set (number_of_replicas=1)&quot;);
        execute(&quot;select number_of_replicas from information_schema.tables &quot; +
                &quot;where table_schema = 'blob' and table_name = 'screenshots'&quot;);
        assertEquals(&quot;1&quot;, response.rows()[0][0]);
        execute(&quot;drop blob table screenshots&quot;);
    }

    @Test
    public void testDropIfExistsBlobTable() throws Exception {
        execute(&quot;create blob table screenshots with (number_of_replicas=0)&quot;);
        execute(&quot;drop blob table if exists screenshots&quot;);
        assertEquals(response.rowCount(), 1);
    }

    @Test
    public void testDropBlobTableIfExistsUnknownTable() throws Exception {
        execute(&quot;drop blob table if exists nonexistent&quot;);
        assertThat(response.rowCount(), is(0L));
    }

    @Test
    public void testAlterShardsOfPartitionedTableAffectsNewPartitions() {
        execute(
            &quot;create table quotes (&quot; +
            &quot;   id integer,&quot; +
            &quot;   quote string,&quot; +
            &quot;   date timestamp with time zone&quot; +
            &quot;) partitioned by(date) &quot; +
            &quot;clustered into 3 shards with (number_of_replicas='0-all')&quot;);
        ensureYellow();

        execute(&quot;insert into quotes (id, quote, date) values (?, ?, ?), (?, ?, ?)&quot;,
            new Object[]{
                1, &quot;Don't panic&quot;, 1395874800000L,
                2, &quot;Now panic&quot;, 1395961200000L}
        );
        execute(&quot;alter table quotes set (number_of_shards=5)&quot;);
<A NAME="3"></A>
        String templateName = PartitionName.templateName(Schemas.DOC_SCHEMA_NAME, &quot;quotes&quot;);
        GetIndexTemplatesResponse templatesResponse =
            <FONT color="#53858b"><A HREF="javascript:ZweiFrames('match485023-1.html#3',3,'match485023-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>client().admin().indices().prepareGetTemplates(templateName).execute().actionGet();
        Settings templateSettings = templatesResponse.getIndexTemplates().get(0).getSettings();
        assertThat(templateSettings.getAsInt(IndexMetadata.SETTING_NUMBER_OF_SHARDS, 0), is(5));

        execute</B></FONT>(&quot;insert into quotes (id, quote, date) values (?, ?, ?)&quot;,
            new Object[]{3, &quot;Time is a illusion. Lunchtime doubles so&quot;, 1495961200000L}
        );
        PartitionName partitionName = new PartitionName(
            new RelationName(&quot;doc&quot;, &quot;quotes&quot;), Arrays.asList(&quot;1495961200000&quot;));

        execute(&quot;select number_of_shards from information_schema.table_partitions where partition_ident = ? and table_name = ?&quot;,
            $(partitionName.ident(), partitionName.relationName().name()));
        assertThat(response.rows()[0][0], is(5));
    }

    @Test
    public void testAlterShardsTableCombinedWithOtherSettingsIsInvalid() {
        execute(
            &quot;create table quotes (&quot; +
            &quot;   id integer,&quot; +
            &quot;   quote string,&quot; +
            &quot;   date timestamp with time zone&quot; +
            &quot;) clustered into 3 shards with (number_of_replicas='0-all')&quot;);

        assertThrowsMatches(() -&gt; execute(&quot;alter table quotes set (number_of_shards=1, number_of_replicas='1-all')&quot;),
                     isSQLError(is(&quot;Setting [number_of_shards] cannot be combined with other settings&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000));
    }

    @Test
    public void testAlterShardsPartitionCombinedWithOtherSettingsIsInvalid() {
        execute(
            &quot;create table quotes (&quot; +
            &quot;   id integer,&quot; +
            &quot;   quote string,&quot; +
            &quot;   date timestamp with time zone&quot; +
            &quot;) partitioned by(date) &quot; +
            &quot;clustered into 3 shards with (number_of_replicas='0-all')&quot;);

        execute(&quot;insert into quotes (id, quote, date) values (?, ?, ?), (?, ?, ?)&quot;,
            new Object[]{
                1, &quot;Don't panic&quot;, 1395874800000L,
                2, &quot;Now panic&quot;, 1395961200000L}
        );

        assertThrowsMatches(() -&gt; execute(&quot;alter table quotes partition (date=1395874800000) &quot; +
                                   &quot;set (number_of_shards=1, number_of_replicas='1-all')&quot;),
                     isSQLError(is(&quot;Setting [number_of_shards] cannot be combined with other settings&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000));
    }

    @Test
    public void testCreateTableWithCustomSchema() throws Exception {
        execute(&quot;create table a.t (name string) with (number_of_replicas=0)&quot;);
        ensureYellow();

        execute(&quot;insert into a.t (name) values ('Ford')&quot;);
        assertThat(response.rowCount(), is(1L));
        refresh();

        execute(&quot;select name from a.t&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat((String) response.rows()[0][0], is(&quot;Ford&quot;));

        execute(&quot;select table_schema from information_schema.tables where table_name = 't'&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat((String) response.rows()[0][0], is(&quot;a&quot;));
    }

    @Test
    public void testCreateTableWithIllegalCustomSchemaCheckedByES() throws Exception {
        assertThrowsMatches(() -&gt; execute(&quot;create table \&quot;AAA\&quot;.t (name string) with (number_of_replicas=0)&quot;),
                     isSQLError(is(&quot;Relation name \&quot;AAA.t\&quot; is invalid.&quot;), INTERNAL_ERROR, BAD_REQUEST, 4002));

    }

    @Test
    public void testDropTableWithCustomSchema() throws Exception {
        execute(&quot;create table a.t (name string) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;drop table a.t&quot;);
        assertThat(response.rowCount(), is(1L));

        execute(&quot;select table_schema from information_schema.tables where table_name = 't'&quot;);
        assertThat(response.rowCount(), is(0L));
    }

    @Test
    public void testCreateTableWithGeneratedColumn() throws Exception {
        execute(
            &quot;create table test (&quot; +
            &quot;   ts timestamp with time zone,&quot; +
            &quot;   day as date_trunc('day', ts)) with (number_of_replicas=0)&quot;);
        ensureYellow();
        String expectedMapping = &quot;{\&quot;default\&quot;:&quot; +
                                 &quot;{\&quot;dynamic\&quot;:\&quot;strict\&quot;,&quot; +
                                 &quot;\&quot;_meta\&quot;:{&quot; +
                                 &quot;\&quot;generated_columns\&quot;:{\&quot;day\&quot;:\&quot;date_trunc('day', ts)\&quot;}},&quot; +
                                 &quot;\&quot;properties\&quot;:{&quot; +
                                 &quot;\&quot;day\&quot;:{\&quot;type\&quot;:\&quot;date\&quot;,\&quot;position\&quot;:2,\&quot;format\&quot;:\&quot;epoch_millis||strict_date_optional_time\&quot;},&quot; +
                                 &quot;\&quot;ts\&quot;:{\&quot;type\&quot;:\&quot;date\&quot;,\&quot;position\&quot;:1,\&quot;format\&quot;:\&quot;epoch_millis||strict_date_optional_time\&quot;}&quot; +
                                 &quot;}}}&quot;;

        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));
    }

    @Test
    public void testAddGeneratedColumnToTableWithExistingGeneratedColumns() throws Exception {
        execute(
            &quot;create table test (&quot; +
            &quot;   ts timestamp with time zone,&quot; +
            &quot;   day as date_trunc('day', ts)) with (number_of_replicas=0)&quot;);
        execute(&quot;alter table test add column added timestamp generated always as date_trunc('day', ts)&quot;);
        ensureYellow();
        String expectedMapping = &quot;{\&quot;default\&quot;:&quot; +
                                 &quot;{\&quot;dynamic\&quot;:\&quot;strict\&quot;,&quot; +
                                 &quot;\&quot;_meta\&quot;:{&quot; +
                                 &quot;\&quot;generated_columns\&quot;:{&quot; +
                                 &quot;\&quot;added\&quot;:\&quot;date_trunc('day', ts)\&quot;,&quot; +
                                 &quot;\&quot;day\&quot;:\&quot;date_trunc('day', ts)\&quot;}},&quot; +
                                 &quot;\&quot;properties\&quot;:{&quot; +
                                 &quot;\&quot;added\&quot;:{\&quot;type\&quot;:\&quot;date\&quot;,\&quot;position\&quot;:3,\&quot;format\&quot;:\&quot;epoch_millis||strict_date_optional_time\&quot;},&quot; +
                                 &quot;\&quot;day\&quot;:{\&quot;type\&quot;:\&quot;date\&quot;,\&quot;position\&quot;:2,\&quot;format\&quot;:\&quot;epoch_millis||strict_date_optional_time\&quot;},&quot; +
                                 &quot;\&quot;ts\&quot;:{\&quot;type\&quot;:\&quot;date\&quot;,\&quot;position\&quot;:1,\&quot;format\&quot;:\&quot;epoch_millis||strict_date_optional_time\&quot;}&quot; +
                                 &quot;}}}&quot;;

        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));
    }


    @Test
    public void test_alter_table_cannot_add_broken_generated_column() throws Exception {
        execute(&quot;create table tbl (x int)&quot;);

        Asserts.assertThrowsMatches(
            () -&gt; execute(&quot;alter table tbl add column ts timestamp without time zone generated always as 'foobar'&quot;),
            SQLErrorMatcher.isSQLError(
                is(&quot;Cannot cast `'foobar'` of type `text` to type `timestamp without time zone`&quot;),
                PGErrorStatus.INTERNAL_ERROR,
                HttpResponseStatus.BAD_REQUEST,
                4000
            )
        );
    }

    @Test
    public void test_alter_table_add_column_keeps_existing_meta_information() throws Exception {
        execute(&quot;&quot;&quot;
            CREATE TABLE tbl (
                author TEXT NOT NULL,
                INDEX author_ft USING FULLTEXT (author) WITH (analyzer = 'standard')
            )
        &quot;&quot;&quot;);

        execute(&quot;ALTER TABLE tbl ADD COLUMN dummy text NOT NULL&quot;);

        execute(&quot;show create table tbl&quot;);
        assertThat((String) response.rows()[0][0], startsWith(&quot;&quot;&quot;
            CREATE TABLE IF NOT EXISTS &quot;doc&quot;.&quot;tbl&quot; (
               &quot;author&quot; TEXT NOT NULL,
               &quot;dummy&quot; TEXT NOT NULL,
               INDEX &quot;author_ft&quot; USING FULLTEXT (&quot;author&quot;) WITH (
                  analyzer = 'standard'
               )
            )
            &quot;&quot;&quot;.stripIndent()
        ));
    }
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>PublicationTests.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Elasticsearch under one or more contributor
 * license agreements. See the NOTICE file distributed with
 * this work for additional information regarding copyright
 * ownership. Elasticsearch licenses this file to you under
 * the Apache License, Version 2.0 (the &quot;License&quot;); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
<A NAME="0"></A> * under the License.
 */

<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#0',2,'match485023-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>package org.elasticsearch.cluster.coordination;

import org.elasticsearch.Version;
import org.elasticsearch.action.ActionListener;
import org.elasticsearch.cluster.ClusterState;
import org.elasticsearch.cluster.coordination.CoordinationMetadata.VotingConfiguration;
import org.elasticsearch.cluster.node.DiscoveryNode;
import org.elasticsearch.cluster.node.DiscoveryNodeRole;
import org.elasticsearch.cluster.node.DiscoveryNodes;
import javax.annotation.Nullable;
import io.crate.common.collections.Tuple;
import org.elasticsearch.common.settings.Settings;
import io.crate.common.unit.TimeValue;
import io.crate.common.collections.Sets;
import org.elasticsearch.discovery.Discovery;
import org.elasticsearch.test.ESTestCase;
import org.elasticsearch.transport.TransportException;
import org.elasticsearch.transport.TransportResponse;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.concurrent.CopyOnWriteArrayList;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.function.Function;
import java.util.function.LongSupplier;
import java.util.stream.Collector;
import</B></FONT> java.util.stream.Collectors;
import java.util.stream.Stream;

import static org.hamcrest.Matchers.containsInAnyOrder;
import static org.hamcrest.Matchers.containsString;
import static org.hamcrest.Matchers.empty;
import static org.hamcrest.Matchers.emptyIterable;
import static org.hamcrest.Matchers.equalTo;

public class PublicationTests extends ESTestCase {

    class MockNode {

        MockNode(Settings settings, DiscoveryNode localNode) {
            this.localNode = localNode;
            ClusterState initialState = CoordinationStateTests.clusterState(0L, 0L, localNode,
                CoordinationMetadata.VotingConfiguration.EMPTY_CONFIG, CoordinationMetadata.VotingConfiguration.EMPTY_CONFIG, 0L);
            coordinationState = new CoordinationState(settings, localNode, new InMemoryPersistedState(0L, initialState));
        }

        final DiscoveryNode localNode;

        final CoordinationState coordinationState;

        public MockPublication publish(ClusterState clusterState, Discovery.AckListener ackListener, Set&lt;DiscoveryNode&gt; faultyNodes) {
            PublishRequest publishRequest = coordinationState.handleClientValue(clusterState);
            MockPublication currentPublication = new MockPublication(publishRequest, ackListener, () -&gt; 0L) {
                @Override
                protected boolean isPublishQuorum(CoordinationState.VoteCollection votes) {
                    return coordinationState.isPublishQuorum(votes);
                }

                @Override
                protected Optional&lt;ApplyCommitRequest&gt; handlePublishResponse(DiscoveryNode sourceNode, PublishResponse publishResponse) {
                    return coordinationState.handlePublishResponse(sourceNode, publishResponse);
                }
            };
            currentPublication.start(faultyNodes);
            return currentPublication;
        }
    }

    abstract class MockPublication extends Publication {

        final PublishRequest publishRequest;

        ApplyCommitRequest applyCommit;

        boolean completed;

        boolean committed;

        Map&lt;DiscoveryNode, ActionListener&lt;PublishWithJoinResponse&gt;&gt; pendingPublications = new LinkedHashMap&lt;&gt;();
        Map&lt;DiscoveryNode, ActionListener&lt;TransportResponse.Empty&gt;&gt; pendingCommits = new LinkedHashMap&lt;&gt;();
        Map&lt;DiscoveryNode, Join&gt; joins = new HashMap&lt;&gt;();
        Set&lt;DiscoveryNode&gt; missingJoins = new HashSet&lt;&gt;();

        MockPublication(PublishRequest publishRequest, Discovery.AckListener ackListener, LongSupplier currentTimeSupplier) {
            super(publishRequest, ackListener, currentTimeSupplier);
            this.publishRequest = publishRequest;
        }

        @Override
        protected void onCompletion(boolean committed) {
            assertFalse(completed);
            completed = true;
            this.committed = committed;
        }

        @Override
        protected void onJoin(Join join) {
            assertNull(joins.put(join.getSourceNode(), join));
        }

        @Override
        protected void onMissingJoin(DiscoveryNode discoveryNode) {
            assertTrue(missingJoins.add(discoveryNode));
        }

        @Override
        protected void sendPublishRequest(DiscoveryNode destination, PublishRequest publishRequest,
                                          ActionListener&lt;PublishWithJoinResponse&gt; responseActionListener) {
            assertSame(publishRequest, this.publishRequest);
            assertNull(pendingPublications.put(destination, responseActionListener));
        }

        @Override
        protected void sendApplyCommit(DiscoveryNode destination, ApplyCommitRequest applyCommit,
                                       ActionListener&lt;TransportResponse.Empty&gt; responseActionListener) {
            if (this.applyCommit == null) {
                this.applyCommit = applyCommit;
            } else {
                assertSame(applyCommit, this.applyCommit);
            }
            assertNull(pendingCommits.put(destination, responseActionListener));
        }
    }

    DiscoveryNode n1 = CoordinationStateTests.createNode(&quot;node1&quot;);
    DiscoveryNode n2 = CoordinationStateTests.createNode(&quot;node2&quot;);
    DiscoveryNode n3 = CoordinationStateTests.createNode(&quot;node3&quot;);
    Set&lt;DiscoveryNode&gt; discoNodes = Set.of(n1, n2, n3);

    MockNode node1 = new MockNode(Settings.EMPTY, n1);
    MockNode node2 = new MockNode(Settings.EMPTY, n2);
    MockNode node3 = new MockNode(Settings.EMPTY, n3);
    List&lt;MockNode&gt; nodes = Arrays.asList(node1, node2, node3);

    Function&lt;DiscoveryNode, MockNode&gt; nodeResolver = dn -&gt; nodes.stream().filter(mn -&gt; mn.localNode.equals(dn)).findFirst().get();

<A NAME="10"></A>    private void initializeCluster(VotingConfiguration initialConfig) {
        node1.coordinationState.setInitialState(CoordinationStateTests.clusterState(0L, 0L, n1, initialConfig, initialConfig, 0L));
        StartJoinRequest startJoinRequest = new StartJoinRequest(n1, 1L);
        <FONT color="#ad5910"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#10',2,'match485023-top.html#10',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>node1.coordinationState.handleJoin(node1.coordinationState.handleStartJoin(startJoinRequest));
        node1.coordinationState.handleJoin(node2.coordinationState.handleStartJoin(startJoinRequest));
        node1.coordinationState.handleJoin(node3.coordinationState.handleStartJoin(startJoinRequest));
        assertTrue(node1.coordinationState.electionWon());
    }

    public void testSimpleClusterSta</B></FONT>tePublishing() throws InterruptedException {
        VotingConfiguration singleNodeConfig = new VotingConfiguration(Set.of(n1.getId()));
<A NAME="3"></A>        initializeCluster(singleNodeConfig);

        AssertingAckListener ackListener = new AssertingAckListener(nodes.size());
        DiscoveryNodes discoveryNodes = <FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#3',2,'match485023-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>DiscoveryNodes.builder().add(n1).add(n2).add(n3).localNodeId(n1.getId()).build();
        MockPublication publication = node1.publish(CoordinationStateTests.clusterState(1L, 2L,
            discoveryNodes, singleNodeConfig, singleNodeConfig, 42L), ackListener, Collections.emptySet());

        assertThat(publication.pendingPublications.keySet(), equalTo(discoNodes));
        assertThat</B></FONT>(publication.completedNodes(), empty());
        assertTrue(publication.pendingCommits.isEmpty());
        AtomicBoolean processedNode1PublishResponse = new AtomicBoolean();
        boolean delayProcessingNode2PublishResponse = randomBoolean();
        publication.pendingPublications.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
<A NAME="8"></A>            if (delayProcessingNode2PublishResponse &amp;&amp; e.getKey().equals(n2)) {
                return;
            }
            PublishResponse publishResponse = <FONT color="#c58917"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#8',2,'match485023-top.html#8',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>nodeResolver.apply(e.getKey()).coordinationState.handlePublishRequest(
                publication.publishRequest);
            assertNotEquals(processedNode1PublishResponse.get(), publication.pendingCommits.isEmpty());
            assertFalse(publication.joins.containsKey(e.getKey()));
            PublishWithJoinResponse publishWithJoinResponse = new</B></FONT> PublishWithJoinResponse(publishResponse,
<A NAME="5"></A>                randomBoolean() ? Optional.empty() : Optional.of(new Join(e.getKey(), randomFrom(n1, n2, n3), publishResponse.getTerm(),
                    randomNonNegativeLong(), randomNonNegativeLong())));
            e.getValue().onResponse(publishWithJoinResponse);
            if (publishWithJoinResponse.getJoin().isPresent()) <FONT color="#151b8d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#5',2,'match485023-top.html#5',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>{
                assertTrue(publication.joins.containsKey(e.getKey()));
                assertFalse(publication.missingJoins.contains(e.getKey()));
                assertEquals(publishWithJoinResponse.getJoin().get(), publication.joins.get(e.getKey()));
            }</B></FONT> else {
                assertFalse(publication.joins.containsKey(e.getKey()));
                assertTrue(publication.missingJoins.contains(e.getKey()));
            }
            if (e.getKey().equals(n1)) {
                processedNode1PublishResponse.set(true);
            }
            assertNotEquals(processedNode1PublishResponse.get(), publication.pendingCommits.isEmpty());
        });

        if (delayProcessingNode2PublishResponse) {
            assertThat(publication.pendingCommits.keySet(), equalTo(Set.of(n1, n3)));
<A NAME="4"></A>        } else {
            assertThat(publication.pendingCommits.keySet(), equalTo(discoNodes));
        }
<A NAME="14"></A>        <FONT color="#6cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#4',2,'match485023-top.html#4',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertNotNull(publication.applyCommit);
        assertEquals(publication.applyCommit.getTerm(), publication.publishRequest.getAcceptedState().term());
        assertEquals(publication.applyCommit.getVersion(), publication.publishRequest.getAcceptedState().version());
        publication.pendingCommits.entrySet().stream().collect(shuffle</B></FONT>()).forEach(e -&gt; <FONT color="#842dce"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#14',2,'match485023-top.html#14',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>{
            assertFalse(publication.completed);
            assertFalse(publication.committed);
            nodeResolver.apply(e.getKey()).coordinationState.handleCommit(publication.applyCommit);
            e.getValue().onResponse(TransportResponse.Empty.INSTANCE);
        }</B></FONT>);

        if (delayProcessingNode2PublishResponse) {
            assertFalse(publication.completed);
<A NAME="6"></A>            assertFalse(publication.committed);
            PublishResponse publishResponse = nodeResolver.apply(n2).coordinationState.handlePublishRequest(
                publication.publishRequest);
            publication.pendingPublications.get(n2).onResponse(new PublishWithJoinResponse(publishResponse, <FONT color="#8c8774"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#6',2,'match485023-top.html#6',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>Optional.empty()));
            assertThat(publication.pendingCommits.keySet(), equalTo(discoNodes));

            assertFalse(publication.completed);
            assertFalse(publication.committed);
            assertThat(publication.completedNodes(), containsInAnyOrder(n1, n3));
<A NAME="9"></A>            publication.pendingCommits.get(n2).onResponse(TransportResponse.Empty.INSTANCE);
        }</B></FONT>

        <FONT color="#83a33a"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#9',2,'match485023-top.html#9',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertTrue(publication.completed);
        assertThat(publication.completedNodes(), containsInAnyOrder(n1, n2, n3));
        assertTrue(publication.committed);

        assertThat(ackListener.await(0L, TimeUnit.SECONDS), containsInAnyOrder(n1, n2, n3));
    }

    public void testClusterStatePublishingWithFaultyNode</B></FONT>BeforeCommit() throws InterruptedException {
        VotingConfiguration singleNodeConfig = new VotingConfiguration(Set.of(n1.getId()));
<A NAME="12"></A>        initializeCluster(singleNodeConfig);

        AssertingAckListener ackListener = new AssertingAckListener(nodes.size());
        DiscoveryNodes discoveryNodes = <FONT color="#571b7e"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#12',2,'match485023-top.html#12',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>DiscoveryNodes.builder().add(n1).add(n2).add(n3).localNodeId(n1.getId()).build();

        AtomicInteger remainingActions = new</B></FONT> AtomicInteger(4); // number of publish actions + initial faulty nodes injection
        int injectFaultAt = randomInt(remainingActions.get() - 1);
        logger.info(&quot;Injecting fault at: {}&quot;, injectFaultAt);

        Set&lt;DiscoveryNode&gt; initialFaultyNodes = remainingActions.decrementAndGet() == injectFaultAt ?
            Collections.singleton(n2) : Collections.emptySet();
        MockPublication publication = node1.publish(CoordinationStateTests.clusterState(1L, 2L,
            discoveryNodes, singleNodeConfig, singleNodeConfig, 42L), ackListener, initialFaultyNodes);

        publication.pendingPublications.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
            if (remainingActions.decrementAndGet() == injectFaultAt) {
                publication.onFaultyNode(n2);
            }
            if (e.getKey().equals(n2) == false || randomBoolean()) {
                PublishResponse publishResponse = nodeResolver.apply(e.getKey()).coordinationState.handlePublishRequest(
                    publication.publishRequest);
                e.getValue().onResponse(new PublishWithJoinResponse(publishResponse, Optional.empty()));
            }
        });

        publication.pendingCommits.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
            nodeResolver.apply(e.getKey()).coordinationState.handleCommit(publication.applyCommit);
            e.getValue().onResponse(TransportResponse.Empty.INSTANCE);
        });

        assertTrue(publication.completed);
        assertTrue(publication.committed);
<A NAME="2"></A>
        publication.onFaultyNode(randomFrom(n1, n3)); // has no influence

        List&lt;Tuple&lt;DiscoveryNode, Throwable&gt;&gt; errors = <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#2',2,'match485023-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>ackListener.awaitErrors(0L, TimeUnit.SECONDS);
        assertThat(errors.size(), equalTo(1));
        assertThat(errors.get(0).v1(), equalTo(n2));
        assertThat(errors.get(0).v2().getMessage(), containsString(&quot;faulty node&quot;));
    }

    public void testClusterStatePublishingWithFaultyNod</B></FONT>eAfterCommit() throws InterruptedException {
        VotingConfiguration singleNodeConfig = new VotingConfiguration(Set.of(n1.getId()));
        initializeCluster(singleNodeConfig);

        AssertingAckListener ackListener = new AssertingAckListener(nodes.size());
        DiscoveryNodes discoveryNodes = DiscoveryNodes.builder().add(n1).add(n2).add(n3).localNodeId(n1.getId()).build();

        boolean publicationDidNotMakeItToNode2 = randomBoolean();
        AtomicInteger remainingActions = new AtomicInteger(publicationDidNotMakeItToNode2 ? 2 : 3);
        int injectFaultAt = randomInt(remainingActions.get() - 1);
        logger.info(&quot;Injecting fault at: {}, publicationDidNotMakeItToNode2: {}&quot;, injectFaultAt, publicationDidNotMakeItToNode2);

        MockPublication publication = node1.publish(CoordinationStateTests.clusterState(1L, 2L,
            discoveryNodes, singleNodeConfig, singleNodeConfig, 42L), ackListener, Collections.emptySet());

        publication.pendingPublications.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
            if (e.getKey().equals(n2) == false || publicationDidNotMakeItToNode2 == false) {
                PublishResponse publishResponse = nodeResolver.apply(e.getKey()).coordinationState.handlePublishRequest(
                    publication.publishRequest);
                e.getValue().onResponse(new PublishWithJoinResponse(publishResponse, Optional.empty()));
            }
        });

        publication.pendingCommits.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
            if (e.getKey().equals(n2)) {
                // we must fail node before committing for the node, otherwise failing the node is ignored
                publication.onFaultyNode(n2);
            }
            if (remainingActions.decrementAndGet() == injectFaultAt) {
                publication.onFaultyNode(n2);
            }
            if (e.getKey().equals(n2) == false || randomBoolean()) {
                nodeResolver.apply(e.getKey()).coordinationState.handleCommit(publication.applyCommit);
                e.getValue().onResponse(TransportResponse.Empty.INSTANCE);
            }
        });

        // we need to complete publication by failing the node
        if (publicationDidNotMakeItToNode2 &amp;&amp; remainingActions.get() &gt; injectFaultAt) {
            publication.onFaultyNode(n2);
        }

        assertTrue(publication.completed);
        assertTrue(publication.committed);
<A NAME="1"></A>
        publication.onFaultyNode(randomFrom(n1, n3)); // has no influence

        List&lt;Tuple&lt;DiscoveryNode, Throwable&gt;&gt; errors = <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#1',2,'match485023-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>ackListener.awaitErrors(0L, TimeUnit.SECONDS);
        assertThat(errors.size(), equalTo(1));
        assertThat(errors.get(0).v1(), equalTo(n2));
        assertThat(errors.get(0).v2().getMessage(), containsString(&quot;faulty node&quot;));
    }

    public void testClusterStatePublishingFailsOrTimesOut</B></FONT>BeforeCommit() throws InterruptedException {
        VotingConfiguration config = new VotingConfiguration(Set.of(n1.getId(), n2.getId()));
<A NAME="11"></A>        initializeCluster(config);

        AssertingAckListener ackListener = new AssertingAckListener(nodes.size());
        DiscoveryNodes discoveryNodes = <FONT color="#b041ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#11',2,'match485023-top.html#11',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>DiscoveryNodes.builder().add(n1).add(n2).add(n3).localNodeId(n1.getId()).build();
        MockPublication publication = node1.publish(CoordinationStateTests.clusterState(1L, 2L,
            discoveryNodes, config, config, 42L), ackListener, Collections.emptySet());

        boolean timeOut = randomBoolean();
        publication.pendingPublications.entrySet().stream().collect(shuffle()).forEach</B></FONT>(e -&gt; {
            if (e.getKey().equals(n2)) {
                if (timeOut) {
                    publication.cancel(&quot;timed out&quot;);
                } else {
                    e.getValue().onFailure(new TransportException(new Exception(&quot;dummy failure&quot;)));
                }
                assertTrue(publication.completed);
                assertFalse(publication.committed);
            } else if (randomBoolean()) {
                PublishResponse publishResponse = nodeResolver.apply(e.getKey()).coordinationState.handlePublishRequest(
                    publication.publishRequest);
                e.getValue().onResponse(new PublishWithJoinResponse(publishResponse, Optional.empty()));
            }
        });

        assertThat(publication.pendingCommits.keySet(), equalTo(Collections.emptySet()));
        assertNull(publication.applyCommit);
<A NAME="7"></A>        assertTrue(publication.completed);
        assertFalse(publication.committed);

        <FONT color="#38a4a5"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#7',2,'match485023-top.html#7',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>List&lt;Tuple&lt;DiscoveryNode, Throwable&gt;&gt; errors = ackListener.awaitErrors(0L, TimeUnit.SECONDS);
        assertThat(errors.size(), equalTo(3));
        assertThat(errors.stream().map(Tuple::v1).collect(Collectors.toList()), containsInAnyOrder(n1, n2, n3));
        errors.stream().forEach</B></FONT>(tuple -&gt;
            assertThat(tuple.v2().getMessage(), containsString(timeOut ? &quot;timed out&quot; :
                tuple.v1().equals(n2) ? &quot;dummy failure&quot; : &quot;non-failed nodes do not form a quorum&quot;)));
    }

    public void testPublishingToMastersFirst() {
        VotingConfiguration singleNodeConfig = new VotingConfiguration(Set.of(n1.getId()));
        initializeCluster(singleNodeConfig);

        DiscoveryNodes.Builder discoNodesBuilder = DiscoveryNodes.builder();
        randomNodes(10).forEach(dn -&gt; discoNodesBuilder.add(dn));
        DiscoveryNodes discoveryNodes = discoNodesBuilder.add(n1).localNodeId(n1.getId()).build();
        MockPublication publication = node1.publish(CoordinationStateTests.clusterState(1L, 2L,
            discoveryNodes, singleNodeConfig, singleNodeConfig, 42L), null, Collections.emptySet());

        List&lt;DiscoveryNode&gt; publicationTargets = new ArrayList&lt;&gt;(publication.pendingPublications.keySet());
        List&lt;DiscoveryNode&gt; sortedPublicationTargets = new ArrayList&lt;&gt;(publicationTargets);
        Collections.sort(sortedPublicationTargets, Comparator.comparing(n -&gt; n.isMasterEligibleNode() == false));
        assertEquals(sortedPublicationTargets, publicationTargets);
<A NAME="13"></A>    }

    public void testClusterStatePublishingTimesOutAfterCommit() throws InterruptedException {
        VotingConfiguration config = new VotingConfiguration(<FONT color="#3b9c9c"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match485023-0.html#13',2,'match485023-top.html#13',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>randomBoolean() ?
            Set.of(n1.getId(), n2.getId()) : Set.of(n1.getId(), n2.getId(), n3.getId()));
        initializeCluster</B></FONT>(config);

        AssertingAckListener ackListener = new AssertingAckListener(nodes.size());
        DiscoveryNodes discoveryNodes = DiscoveryNodes.builder().add(n1).add(n2).add(n3).localNodeId(n1.getId()).build();
        MockPublication publication = node1.publish(CoordinationStateTests.clusterState(1L, 2L,
            discoveryNodes, config, config, 42L), ackListener, Collections.emptySet());

        boolean publishedToN3 = randomBoolean();
        publication.pendingPublications.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
            if (e.getKey().equals(n3) == false || publishedToN3) {
                PublishResponse publishResponse = nodeResolver.apply(e.getKey()).coordinationState.handlePublishRequest(
                    publication.publishRequest);
                e.getValue().onResponse(new PublishWithJoinResponse(publishResponse, Optional.empty()));
            }
        });

        assertNotNull(publication.applyCommit);

        Set&lt;DiscoveryNode&gt; committingNodes = new HashSet&lt;&gt;(randomSubsetOf(discoNodes));
        if (publishedToN3 == false) {
            committingNodes.remove(n3);
        }

        logger.info(&quot;Committing nodes: {}&quot;, committingNodes);

        publication.pendingCommits.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
            if (committingNodes.contains(e.getKey())) {
                nodeResolver.apply(e.getKey()).coordinationState.handleCommit(publication.applyCommit);
                e.getValue().onResponse(TransportResponse.Empty.INSTANCE);
            }
        });

        publication.cancel(&quot;timed out&quot;);
        assertTrue(publication.completed);
        assertTrue(publication.committed);
        assertEquals(committingNodes, ackListener.await(0L, TimeUnit.SECONDS));

        // check that acking still works after publication completed
        if (publishedToN3 == false) {
            publication.pendingPublications.get(n3).onResponse(
                new PublishWithJoinResponse(node3.coordinationState.handlePublishRequest(publication.publishRequest), Optional.empty()));
        }

        assertEquals(discoNodes, publication.pendingCommits.keySet());

        Set&lt;DiscoveryNode&gt; nonCommittedNodes = Sets.difference(discoNodes, committingNodes);
        logger.info(&quot;Non-committed nodes: {}&quot;, nonCommittedNodes);
        nonCommittedNodes.stream().collect(shuffle()).forEach(n -&gt;
            publication.pendingCommits.get(n).onResponse(TransportResponse.Empty.INSTANCE));

        assertEquals(discoNodes, ackListener.await(0L, TimeUnit.SECONDS));
    }

    private static List&lt;DiscoveryNode&gt; randomNodes(final int numNodes) {
        List&lt;DiscoveryNode&gt; nodesList = new ArrayList&lt;&gt;();
        for (int i = 0; i &lt; numNodes; i++) {
            Map&lt;String, String&gt; attributes = new HashMap&lt;&gt;();
            if (frequently()) {
                attributes.put(&quot;custom&quot;, randomBoolean() ? &quot;match&quot; : randomAlphaOfLengthBetween(3, 5));
            }
            final DiscoveryNode node = newNode(i, attributes,
                new HashSet&lt;&gt;(randomSubsetOf(DiscoveryNodeRole.BUILT_IN_ROLES)));
            nodesList.add(node);
        }
        return nodesList;
    }

    private static DiscoveryNode newNode(int nodeId, Map&lt;String, String&gt; attributes, Set&lt;DiscoveryNodeRole&gt; roles) {
        return new DiscoveryNode(&quot;name_&quot; + nodeId, &quot;node_&quot; + nodeId, buildNewFakeTransportAddress(), attributes, roles,
            Version.CURRENT);
    }

    public static &lt;T&gt; Collector&lt;T, ?, Stream&lt;T&gt;&gt; shuffle() {
        return Collectors.collectingAndThen(Collectors.toList(),
            ts -&gt; {
                Collections.shuffle(ts, random());
                return ts.stream();
            });
    }

    public static class AssertingAckListener implements Discovery.AckListener {
        private final List&lt;Tuple&lt;DiscoveryNode, Throwable&gt;&gt; errors = new CopyOnWriteArrayList&lt;&gt;();
        private final Set&lt;DiscoveryNode&gt; successfulAcks = Collections.synchronizedSet(new HashSet&lt;&gt;());
        private final CountDownLatch countDown;
        private final CountDownLatch commitCountDown;

        public AssertingAckListener(int nodeCount) {
            countDown = new CountDownLatch(nodeCount);
            commitCountDown = new CountDownLatch(1);
        }

        @Override
        public void onCommit(TimeValue commitTime) {
            commitCountDown.countDown();
        }

        @Override
        public void onNodeAck(DiscoveryNode node, @Nullable Exception e) {
            if (e != null) {
                errors.add(new Tuple&lt;&gt;(node, e));
            } else {
                successfulAcks.add(node);
            }
            countDown.countDown();
        }

        public Set&lt;DiscoveryNode&gt; await(long timeout, TimeUnit unit) throws InterruptedException {
            assertThat(awaitErrors(timeout, unit), emptyIterable());
            assertTrue(commitCountDown.await(timeout, unit));
            return new HashSet&lt;&gt;(successfulAcks);
        }

        public List&lt;Tuple&lt;DiscoveryNode, Throwable&gt;&gt; awaitErrors(long timeout, TimeUnit unit) throws InterruptedException {
            countDown.await(timeout, unit);
            return errors;
        }

    }
}
</PRE>
</div>
  </div>
</body>
</html>
