<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for DDLIntegrationTest.java &amp; PublicationTests.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for DDLIntegrationTest.java &amp; PublicationTests.java
      </h3>
<h1 align="center">
        22.3%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>DDLIntegrationTest.java (23.529411%)<th>PublicationTests.java (21.205822%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(22-62)<td><a href="#" name="0">(20-58)</a><td align="center"><font color="#ff0000">37</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(419-438)<td><a href="#" name="1">(343-349)</a><td align="center"><font color="#6e0000">16</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(381-394)<td><a href="#" name="2">(290-296)</a><td align="center"><font color="#6e0000">16</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(754-758)<td><a href="#" name="3">(182-187)</a><td align="center"><font color="#600000">14</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(342-354)<td><a href="#" name="4">(222-225)</a><td align="center"><font color="#600000">14</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(362-375)<td><a href="#" name="5">(203-207)</a><td align="center"><font color="#590000">13</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(453-464)<td><a href="#" name="6">(237-244)</a><td align="center"><font color="#520000">12</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(81-96)<td><a href="#" name="7">(380-383)</a><td align="center"><font color="#520000">12</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(575-588)<td><a href="#" name="8">(195-199)</a><td align="center"><font color="#4b0000">11</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(473-481)<td><a href="#" name="9">(246-253)</a><td align="center"><font color="#4b0000">11</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(441-451)<td><a href="#" name="10">(171-177)</a><td align="center"><font color="#4b0000">11</font>
<tr onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b041ff"><font color="#b041ff">-</font><td><a href="#" name="11">(111-131)<td><a href="#" name="11">(354-359)</a><td align="center"><font color="#440000">10</font>
<tr onclick='openModal("#571b7e")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#571b7e"><font color="#571b7e">-</font><td><a href="#" name="12">(552-562)<td><a href="#" name="12">(258-260)</a><td align="center"><font color="#3e0000">9</font>
<tr onclick='openModal("#3b9c9c")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3b9c9c"><font color="#3b9c9c">-</font><td><a href="#" name="13">(496-504)<td><a href="#" name="13">(405-407)</a><td align="center"><font color="#3e0000">9</font>
<tr onclick='openModal("#842dce")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#842dce"><font color="#842dce">-</font><td><a href="#" name="14">(395-404)<td><a href="#" name="14">(225-230)</a><td align="center"><font color="#3e0000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>DDLIntegrationTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19 <a name="0"></a> * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>package io.crate.integrationtests;
22 import static com.carrotsearch.randomizedtesting.RandomizedTest.$;
23 import static io.crate.protocols.postgres.PGErrorStatus.DUPLICATE_TABLE;
24 import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
25 import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_TABLE;
26 import static io.crate.testing.Asserts.assertThrowsMatches;
27 import static io.crate.testing.SQLErrorMatcher.isSQLError;
28 import static io.crate.testing.TestingHelpers.printedTable;
29 import static io.netty.handler.codec.http.HttpResponseStatus.BAD_REQUEST;
30 import static io.netty.handler.codec.http.HttpResponseStatus.CONFLICT;
31 import static io.netty.handler.codec.http.HttpResponseStatus.NOT_FOUND;
32 import static io.netty.handler.codec.rtsp.RtspResponseStatuses.INTERNAL_SERVER_ERROR;
33 import static org.hamcrest.CoreMatchers.startsWith;
34 import static org.hamcrest.Matchers.containsString;
35 import static org.hamcrest.core.Is.is;
36 import java.util.ArrayList;
37 import java.util.Arrays;
38 import java.util.List;
39 import java.util.Map;
40 import org.elasticsearch.Version;
41 import org.elasticsearch.action.admin.indices.template.get.GetIndexTemplatesResponse;
42 import org.elasticsearch.cluster.metadata.IndexMetadata;
43 import org.elasticsearch.common.settings.Settings;
44 import org.elasticsearch.test.ESIntegTestCase;
45 import org.hamcrest.Matchers;
46 import org.junit.Test;
47 import org.skyscreamer.jsonassert.JSONAssert;
48 import org.skyscreamer.jsonassert.JSONCompareMode;
49 import io.crate.metadata.PartitionName;
50 import io.crate.metadata.RelationName;
51 import io.crate.metadata.Schemas;
52 import io.crate.protocols.postgres.PGErrorStatus;
53 import io.crate.testing.Asserts;
54 import io.crate.testing.SQLErrorMatcher;
55 import io.crate.testing.TestingHelpers;
56 import io.crate.testing.UseRandomizedSchema;
57 import</b></font> io.netty.handler.codec.http.HttpResponseStatus;
58 @ESIntegTestCase.ClusterScope()
59 @UseRandomizedSchema(random = false)
60 public class DDLIntegrationTest extends SQLIntegrationTestCase {
61     @Test
62     public void testCreateTable() throws Exception {
63         execute("create table test (col1 integer primary key, col2 string) " +
64                 "clustered into 5 shards with (number_of_replicas = 1, \"write.wait_for_active_shards\"=1)");
65         String expectedMapping = "{\"default\":{" +
66                                  "\"dynamic\":\"strict\",\"_meta\":{" +
67                                  "\"primary_keys\":[\"col1\"]}," +
68                                  "\"properties\":{" +
69                                  "\"col1\":{\"type\":\"integer\",\"position\":1}," +
70 <a name="7"></a>                                 "\"col2\":{\"type\":\"keyword\",\"position\":2}" +
71                                  "}}}";
72         <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>String expectedSettings = "{\"test\":{" +
73                                   "\"settings\":{" +
74                                   "\"index.number_of_replicas\":\"1\"," +
75                                   "\"index.number_of_shards\":\"5\"," +
76                                   "\"index.version.created\":\"" + Version.CURRENT.internalId + "\"" +
77                                   "}}}";
78         assertEquals(expectedMapping, getIndexMapping("test"));
79         JSONAssert.assertEquals(expectedSettings, getIndexSettings("test"), false);
80         execute("insert into test (col1, col2) values (1, 'foo')");
81         assertEquals(1, response.rowCount());
82         refresh();
83         execute("SELECT * FROM test");
84         assertEquals(1L, response.rowCount</b></font>());
85     }
86     @Test
87     public void testCreateTableWithRefreshIntervalDisableRefresh() throws Exception {
88         execute("create table test (id int primary key, content string) " +
89                 "clustered into 5 shards " +
90                 "with (refresh_interval=0, number_of_replicas = 0)");
91         String expectedSettings = "{\"test\":{" +
92                                   "\"settings\":{" +
93                                   "\"index.number_of_replicas\":\"0\"," +
94                                   "\"index.number_of_shards\":\"5\"," +
95 <a name="11"></a>                                  "\"index.refresh_interval\":\"0s\"," +
96                                   "\"index.version.created\":\"" + Version.CURRENT.internalId + "\"" +
97                                   "}}}";
98         <font color="#b041ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>JSONAssert.assertEquals(expectedSettings, getIndexSettings("test"), false);
99         execute("ALTER TABLE test SET (refresh_interval = '5000ms')");
100         String expectedSetSettings = "{\"test\":{" +
101                                      "\"settings\":{" +
102                                      "\"index.number_of_replicas\":\"0\"," +
103                                      "\"index.number_of_shards\":\"5\"," +
104                                      "\"index.refresh_interval\":\"5s\"," +
105                                      "\"index.version.created\":\"" + Version.CURRENT.internalId + "\"" +
106                                      "}}}";
107         JSONAssert.assertEquals(expectedSetSettings, getIndexSettings("test"), false);
108         execute("ALTER TABLE test RESET (refresh_interval)");
109         String expectedResetSettings = "{\"test\":{" +
110                                        "\"settings\":{" +
111                                        "\"index.number_of_replicas\":\"0\"," +
112                                        "\"index.number_of_shards\":\"5\"," +
113                                        "\"index.refresh_interval\":\"1s\"," +
114                                        "\"index.version.created\":\"" + Version.CURRENT.internalId + "\"" +
115                                        "}}}";
116         JSONAssert.assertEquals(expectedResetSettings, getIndexSettings</b></font>("test"), false);
117     }
118     @Test
119     public void testCreateTableAlreadyExistsException() throws Exception {
120         execute("create table test (col1 integer primary key, col2 string)");
121         ensureYellow();
122         assertThrowsMatches(() -&gt; execute("create table test (col1 integer primary key, col2 string)"),
123                      isSQLError(is("Relation 'doc.test' already exists."),
124                                 DUPLICATE_TABLE,
125                                 CONFLICT,
126                                 4093)
127         );
128     }
129     @Test
130     public void testCreateTableWithReplicasAndShards() throws Exception {
131         execute("create table test (col1 integer primary key, col2 string)" +
132                 "clustered by (col1) into 10 shards with (number_of_replicas=2, \"write.wait_for_active_shards\"=1)");
133         String expectedMapping = "{\"default\":{" +
134                                  "\"dynamic\":\"strict\"," +
135                                  "\"_meta\":{" +
136                                  "\"primary_keys\":[\"col1\"]," +
137                                  "\"routing\":\"col1\"}," +
138                                  "\"properties\":{" +
139                                  "\"col1\":{\"type\":\"integer\"}," +
140                                  "\"col2\":{\"type\":\"keyword\"}" +
141                                  "}}}";
142         String expectedSettings = "{\"test\":{" +
143                                   "\"settings\":{" +
144                                   "\"index.number_of_replicas\":\"2\"," +
145                                   "\"index.number_of_shards\":\"10\"," +
146                                   "\"index.version.created\":\"" + Version.CURRENT.internalId + "\"" +
147                                   "}}}";
148         JSONAssert.assertEquals(expectedMapping, getIndexMapping("test"), JSONCompareMode.LENIENT);
149         JSONAssert.assertEquals(expectedSettings, getIndexSettings("test"), JSONCompareMode.LENIENT);
150     }
151     @Test
152     public void testCreateTableWithStrictColumnPolicy() throws Exception {
153         execute("create table test (col1 integer primary key, col2 string) " +
154                 "clustered into 5 shards " +
155                 "with (column_policy='strict', number_of_replicas = 0)");
156         String expectedMapping = "{\"default\":{" +
157                                  "\"dynamic\":\"strict\",\"_meta\":{" +
158                                  "\"primary_keys\":[\"col1\"]}," +
159                                  "\"properties\":{" +
160                                  "\"col1\":{\"type\":\"integer\",\"position\":1}," +
161                                  "\"col2\":{\"type\":\"keyword\",\"position\":2}" +
162                                  "}}}";
163         String expectedSettings = "{\"test\":{" +
164                                   "\"settings\":{" +
165                                   "\"index.number_of_replicas\":\"0\"," +
166                                   "\"index.number_of_shards\":\"5\"," +
167                                   "\"index.version.created\":\"" + Version.CURRENT.internalId + "\"" +
168                                   "}}}";
169         assertEquals(expectedMapping, getIndexMapping("test"));
170         JSONAssert.assertEquals(expectedSettings, getIndexSettings("test"), false);
171     }
172     @Test
173     public void testCreateGeoShapeExplicitIndex() throws Exception {
174         execute("create table test (col1 geo_shape INDEX using QUADTREE with (precision='1m', distance_error_pct='0.25'))");
175         ensureYellow();
176         String expectedMapping = "{\"default\":{" +
177                                  "\"dynamic\":\"strict\",\"_meta\":{}," +
178                                  "\"properties\":{" +
179                                  "\"col1\":{\"type\":\"geo_shape\",\"tree\":\"quadtree\",\"position\":1,\"precision\":\"1.0m\",\"distance_error_pct\":0.25}}}}";
180         assertEquals(expectedMapping, getIndexMapping("test"));
181     }
182     @Test
183     public void testCreateColumnWithDefaultExpression() throws Exception {
184         execute("create table test (col1 text default 'foo')");
185         String expectedMapping = "{\"default\":{" +
186                                  "\"dynamic\":\"strict\",\"_meta\":{}," +
187                                  "\"properties\":{\"col1\":{\"type\":\"keyword\",\"position\":1,\"default_expr\":\"'foo'\"}}}}";
188         assertEquals(expectedMapping, getIndexMapping("test"));
189     }
190     @Test
191     public void testCreateGeoShape() throws Exception {
192         execute("create table test (col1 geo_shape)");
193         ensureYellow();
194         String expectedMapping = "{\"default\":{" +
195                                  "\"dynamic\":\"strict\",\"_meta\":{}," +
196                                  "\"properties\":{\"col1\":{\"type\":\"geo_shape\",\"position\":1}}}}";
197         assertEquals(expectedMapping, getIndexMapping("test"));
198     }
199     @Test
200     public void testGeoShapeInvalidPrecision() throws Exception {
201         assertThrowsMatches(() -&gt; execute("create table test (col1 geo_shape INDEX using QUADTREE with (precision='10%'))"),
202                      isSQLError(is("Value '10%' of setting precision is not a valid distance unit"),
203                                 INTERNAL_ERROR,
204                                 BAD_REQUEST,
205                                 4000)
206         );
207     }
208     @Test
209     public void testGeoShapeInvalidDistance() throws Exception {
210         assertThrowsMatches(() -&gt; execute(
211             "create table test (col1 geo_shape INDEX using QUADTREE with (distance_error_pct=true))"),
212                      isSQLError(is("Value 'true' of setting distance_error_pct is not a float value"),
213                          INTERNAL_ERROR,
214                          BAD_REQUEST,
215                          4000)
216         );
217     }
218     @Test
219     public void testUnknownGeoShapeSetting() throws Exception {
220         assertThrowsMatches(() -&gt; execute("create table test (col1 geo_shape INDEX using QUADTREE with (does_not_exist=false))"),
221                      isSQLError(is("Setting \"does_not_exist\" ist not supported on geo_shape index"),
222                                 INTERNAL_ERROR,
223                                 BAD_REQUEST,
224                                 4000)
225         );
226     }
227     @Test
228     public void testCreateTableWithInlineDefaultIndex() throws Exception {
229         execute("create table quotes (quote string index using plain) with (number_of_replicas = 0)");
230         String quote = "Would it save you a lot of time if I just gave up and went mad now?";
231         execute("insert into quotes values (?)", new Object[]{quote});
232         refresh();
233         execute("select quote from quotes where match(quote, 'time')");
234         assertEquals(0, response.rowCount());
235         execute("select quote from quotes where quote = ?", new Object[]{quote});
236         assertEquals(1L, response.rowCount());
237         assertEquals(quote, response.rows()[0][0]);
238     }
239     @Test
240     public void testCreateTableWithInlineIndex() throws Exception {
241         execute("create table quotes (quote string index using fulltext) with (number_of_replicas = 0)");
242         String quote = "Would it save you a lot of time if I just gave up and went mad now?";
243         execute("insert into quotes values (?)", new Object[]{quote});
244         execute("refresh table quotes");
245         execute("select quote from quotes where match(quote, 'time')");
246         assertEquals(1L, response.rowCount());
247         assertEquals(quote, response.rows()[0][0]);
248         execute("select quote from quotes where quote = ?", new Object[]{quote});
249         assertEquals(0, response.rowCount());
250     }
251     @Test
252     public void testCreateTableWithIndexOff() throws Exception {
253         execute("create table quotes (id int, quote string index off) with (number_of_replicas = 0)");
254         String quote = "Would it save you a lot of time if I just gave up and went mad now?";
255         execute("insert into quotes (id, quote) values (?, ?)", new Object[]{1, quote});
256         execute("refresh table quotes");
257         assertThrowsMatches(
258             () -&gt; execute("select quote from quotes where quote = ?", new Object[]{quote}),
259             isSQLError(
260                 containsString("Cannot search on field [quote] since it is not indexed."),
261                 INTERNAL_ERROR,
262                 BAD_REQUEST,
263                 4000
264             )
265         );
266     }
267     @Test
268     public void testCreateTableWithIndex() throws Exception {
269         execute("create table quotes (quote string, " +
270                 "index quote_fulltext using fulltext(quote) with (analyzer='stop')) with (number_of_replicas = 0)");
271         String quote = "Would it save you a lot of time if I just gave up and went mad now?";
272         execute("insert into quotes values (?)", new Object[]{quote});
273         execute("refresh table quotes");
274         execute("select quote from quotes where match(quote_fulltext, 'time')");
275         assertEquals(1L, response.rowCount());
276         assertEquals(quote, response.rows()[0][0]);
277         execute("select quote from quotes where quote = ?", new Object[]{quote});
278         assertEquals(1L, response.rowCount());
279     }
280     @Test
281     public void testCreateTableWithCompositeIndex() throws Exception {
282         execute("create table novels (title string, description string, " +
283                 "index title_desc_fulltext using fulltext(title, description) " +
284                 "with(analyzer='stop')) with (number_of_replicas = 0)");
285         String title = "So Long, and Thanks for All the Fish";
286         String description = "Many were increasingly of the opinion that they'd all made a big " +
287                              "mistake in coming down from the trees in the first place. And some said that " +
288                              "even the trees had been a bad move, and that no one should ever have left " +
289 <a name="4"></a>                             "the oceans.";
290         execute("insert into novels (title, description) values(?, ?)",
291             new Object[]{title, description});
292         <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>refresh();
293         execute("select title, description from novels where match(title_desc_fulltext, 'fish')");
294         assertEquals(1L, response.rowCount());
295         assertEquals(title, response.rows()[0][0]);
296         assertEquals(description, response.rows()[0][1]);
297         execute("select title, description from novels where match(title_desc_fulltext, 'oceans')");
298         assertEquals(1L, response.rowCount());
299         assertEquals(title, response.rows()[0][0]);
300         assertEquals</b></font>(description, response.rows()[0][1]);
301         execute("select title from novels where title = ?", new Object[]{title});
302         assertEquals(1L, response.rowCount());
303 <a name="5"></a>    }
304     @Test
305     public void test_create_table_with_check_fail_on_insert() <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
306         execute("create table t (id integer primary key, qty integer, constraint check_1 check (qty &gt; 0))");
307         execute("insert into t(id, qty) values(0, null), (1, 1)");
308         refresh();
309         execute("select id, qty from t order by id");
310         assertEquals(printedTable(response.rows()),
311                      "0| NULL\n" +
312                      "1| 1\n");
313         assertThrowsMatches(() -&gt; execute("insert into t(id, qty) values(2, -1)"),
314                      isSQLError(containsString("Failed CONSTRAINT check_1 CHECK (\"qty\" &gt; 0) and values"),
315                      INTERNAL_ERROR,
316                      BAD_REQUEST,
317                      4000));
318     }</b></font>
319     @Test
320 <a name="2"></a>    public void test_create_table_with_check_fail_on_update() {
321         execute("create table t (id integer primary key, qty integer constraint check_1 check (qty &gt; 0))");
322         execute("insert into t(id, qty) values(0, 1)");
323         <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>refresh();
324         execute("select id, qty from t order by id");
325         assertEquals(printedTable(response.rows()), "0| 1\n");
326         execute("update t set qty = 1 where id = 0 returning id, qty");
327         assertEquals(printedTable(response.rows()), "0| 1\n");
328         assertThrowsMatches(() -&gt; execute("update t set qty = -1 where id = 0"),
329                      isSQLError(containsString("Failed CONSTRAINT check_1 CHECK (\"qty\" &gt; 0) and values"),
330                                 INTERNAL_ERROR,
331                                 INTERNAL_SERVER_ERROR,
332                                 5000));
333 <a name="14"></a>    }
334     @Test</b></font>
335     public void test_alter_table_add_column_succedds_because_check_constaint_refers_to_self_columns() <font color="#842dce"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
336         execute("create table t (id integer primary key, qty integer constraint check_1 check (qty &gt; 0))");
337         execute("alter table t add column bazinga integer constraint bazinga_check check(bazinga &lt;&gt; 42)");
338         execute("insert into t(id, qty, bazinga) values(0, 1, 100)");
339         assertThrowsMatches(() -&gt; execute("insert into t(id, qty, bazinga) values(0, 1, 42)"),
340                      isSQLError(containsString("Failed CONSTRAINT bazinga_check CHECK (\"bazinga\" &lt;&gt; 42) and values {qty=1, id=0, bazinga=42}"),
341                                 INTERNAL_ERROR,
342                                 BAD_REQUEST,
343                                 4000));
344     }</b></font>
345     @Test
346     public void test_alter_table_drop_constraint_removes_the_constraint_and_leaves_other_constraints_in_place() {
347         execute("create table t (" +
348                       "    id int primary key, " +
349                       "    qty int constraint check_qty_gt_zero check(qty &gt; 0), " +
350                       "    constraint check_id_ge_zero check (id &gt;= 0)" +
351                       ")");
352         String selectCheckConstraintsStmt =
353             "select table_schema, table_name, constraint_type, constraint_name " +
354             "from information_schema.table_constraints " +
355 <a name="1"></a>            "where table_name='t'" +
356             "order by constraint_name";
357         execute(selectCheckConstraintsStmt);
358         assertThat(printedTable(<font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>response.rows()), is(
359             "doc| t| CHECK| check_id_ge_zero\n" +
360             "doc| t| CHECK| check_qty_gt_zero\n" +
361             "doc| t| PRIMARY KEY| t_pk\n"
362         ));
363         execute("alter table t drop constraint check_id_ge_zero");
364         execute(selectCheckConstraintsStmt);
365         assertThat(printedTable(response.rows()), is(
366             "doc| t| CHECK| check_qty_gt_zero\n" +
367             "doc| t| PRIMARY KEY| t_pk\n"
368         ));
369         execute("insert into t(id, qty) values(-42, 100)");
370         assertThrowsMatches(() -&gt; execute("insert into t(id, qty) values(0, 0)"),
371                      isSQLError(is("Failed CONSTRAINT check_qty_gt_zero CHECK (\"qty\" &gt; 0) and values {qty=0, id=0}"),
372                          INTERNAL_ERROR,
373                          BAD_REQUEST,
374                          4000));
375     }
376 <a name="10"></a>    @Test</b></font>
377     public void testAlterTable() throws Exception {
378         execute("create table test (col1 int) with (number_of_replicas='0-all')");
379         <font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>ensureYellow();
380         execute("select number_of_replicas from information_schema.tables where table_name = 'test'");
381         assertEquals("0-all", response.rows()[0][0]);
382         execute("alter table test set (number_of_replicas=0)");
383         execute("select number_of_replicas from information_schema.tables where table_name = 'test'");
384         assertEquals("0", response.rows()[0][0]);
385     }
386 <a name="6"></a>
387     @Test</b></font>
388     public void testAlterTableAddColumn() {
389         <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>execute("create table t (id int primary key) with (number_of_replicas=0)");
390         execute("alter table t add column name string");
391         execute("select data_type from information_schema.columns where " +
392                 "table_name = 't' and column_name = 'name'");
393         assertThat(response.rows()[0][0], is("text"));
394         execute("alter table t add column o object as (age int)");
395         execute("select data_type from information_schema.columns where " +
396                 "table_name = 't' and column_name = 'o'");
397         assertThat((String) response.rows()[0][0], is("object"));
398     }</b></font>
399     @Test
400     public void testAlterTableAddColumnAsPrimaryKey() throws Exception {
401         execute("create table t (id int primary key) " +
402 <a name="9"></a>                "clustered into 1 shards " +
403                 "with (number_of_replicas=0)");
404         ensureYellow();
405         <font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>execute("alter table t add column name string primary key");
406         execute("select constraint_name from information_schema.table_constraints " +
407                 "where table_name = 't' and table_schema = 'doc' and constraint_type = 'PRIMARY KEY'");
408         assertThat(response.rowCount(), is(1L));
409         assertThat(response.rows()[0][0], is("t_pk"));
410     }
411     @Test</b></font>
412     public void testAlterTableWithRecordsAddColumnAsPrimaryKey() throws Exception {
413         execute("create table t (id int primary key) " +
414                 "clustered into 1 shards " +
415                 "with (number_of_replicas=0)");
416         ensureYellow();
417         execute("insert into t (id) values(1)");
418         refresh();
419         assertThrowsMatches(() -&gt; execute("alter table t add column name string primary key"),
420         isSQLError(is("Cannot add a primary key column to a table that isn't empty"), INTERNAL_ERROR, BAD_REQUEST, 4004));
421     }
422 <a name="13"></a>
423     @Test
424     public void testAlterTableWithoutRecordsAddGeneratedColumn() throws Exception {
425         <font color="#3b9c9c"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>execute("create table t (id int) " +
426                 "clustered into 1 shards " +
427                 "with (number_of_replicas=0)");
428         ensureYellow();
429         execute("alter table t add column id_generated as (id + 1)");
430         execute("insert into t (id) values(1)");
431         refresh();
432         execute("select id, id_generated from t");
433         assertThat(response.rows()[0][0], is</b></font>(1));
434         assertThat(response.rows()[0][1], is(2));
435     }
436     @Test
437     public void testAlterTableWithRecordsAddGeneratedColumn() throws Exception {
438         execute("create table t (id int) " +
439                 "clustered into 1 shards " +
440                 "with (number_of_replicas=0)");
441         ensureYellow();
442         execute("insert into t (id) values(1)");
443         refresh();
444         assertThrowsMatches(() -&gt; execute("alter table t add column id_generated as (id + 1)"),
445                      isSQLError(is("Cannot add a generated column to a table that isn't empty"),
446                                 INTERNAL_ERROR,
447                                 BAD_REQUEST,
448                                 4004));
449     }
450     @Test
451     public void testAlterTableAddDotExpression() {
452         execute("create table t (id int) " +
453                 "clustered into 1 shards " +
454                 "with (number_of_replicas=0)");
455         ensureYellow();
456         assertThrowsMatches(() -&gt; execute("alter table t add \"o.x\" int"),
457                      isSQLError(is("\"o.x\" contains a dot"),
458                                 INTERNAL_ERROR,
459                                 BAD_REQUEST,
460                                 4008));
461     }
462     @Test
463     public void testAlterTableAddDotExpressionInSubscript() {
464         execute("create table t (id int) clustered into 1 shards with (number_of_replicas=0)");
465         ensureYellow();
466         assertThrowsMatches(() -&gt;  execute("alter table t add \"o['x.y']\" int"),
467                      isSQLError(is("\"o['x.y']\" contains a dot"),
468                                 INTERNAL_ERROR,
469                                 BAD_REQUEST,
470                                 4008));
471     }
472 <a name="12"></a>
473     @Test
474     public void testAlterTableAddObjectColumnToNonExistingObject() {
475         <font color="#571b7e"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>execute("create table t (id int) " +
476                 "clustered into 1 shards " +
477                 "with (number_of_replicas=0)");
478         ensureYellow();
479         execute("alter table t add o['x'] int");
480         execute("select column_name from information_schema.columns where " +
481                 "table_name = 't' and table_schema='doc'" +
482                 "order by column_name asc");
483         assertThat(response.rowCount(), is(3L));
484         List&lt;String&gt; fqColumnNames = new</b></font> ArrayList&lt;&gt;();
485         for (Object[] row : response.rows()) {
486             fqColumnNames.add((String) row[0]);
487         }
488         assertThat(fqColumnNames, Matchers.contains("id", "o", "o['x']"));
489     }
490     @Test
491     public void testAlterTableAddObjectColumnToExistingObject() {
492         execute("create table t (o object as (x string)) " +
493 <a name="8"></a>                "clustered into 1 shards " +
494                 "with (number_of_replicas=0)");
495         ensureYellow();
496         <font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>execute("alter table t add o['y'] int");
497         assertThrowsMatches(() -&gt; execute("alter table t add o object as (z string)"),
498                      isSQLError(containsString("The table doc.t already has a column named o"),
499                                 INTERNAL_ERROR,
500                                 BAD_REQUEST,
501                                 4000));
502         execute("select column_name from information_schema.columns where " +
503                 "table_name = 't' and table_schema='doc'" +
504                 "order by column_name asc");
505         assertThat(response.rowCount(), is(3L));
506         List&lt;String&gt; fqColumnNames = new</b></font> ArrayList&lt;&gt;();
507         for (Object[] row : response.rows()) {
508             fqColumnNames.add((String) row[0]);
509         }
510         assertThat(fqColumnNames, Matchers.contains("o", "o['x']", "o['y']"));
511     }
512     @Test
513     public void testAlterTableAddObjectColumnToExistingObjectNested() throws Exception {
514         execute("CREATE TABLE my_table (" +
515                 "  name string, " +
516                 "  age integer," +
517                 "  book object as (isbn string)" +
518                 ")");
519         ensureYellow();
520         execute("alter table my_table add column book['author'] object as (\"authorId\" integer)");
521         waitNoPendingTasksOnAll();
522         execute("select column_name from information_schema.columns where " +
523                 "table_name = 'my_table' and table_schema='doc'" +
524                 "order by column_name asc");
525         assertThat(response.rowCount(), is(6L));
526         assertThat(TestingHelpers.getColumn(response.rows(), 0),
527             is(Matchers.&lt;Object&gt;arrayContaining("age", "book", "book['author']", "book['author']['authorId']", "book['isbn']", "name")));
528         execute("alter table my_table add column book['author']['authorName'] string");
529         waitNoPendingTasksOnAll();
530         execute("select column_name from information_schema.columns where " +
531                 "table_name = 'my_table' and table_schema='doc'" +
532                 "order by column_name asc");
533         assertThat(response.rowCount(), is(7L));
534         assertThat(TestingHelpers.getColumn(response.rows(), 0),
535             is(Matchers.&lt;Object&gt;arrayContaining("age", "book", "book['author']", "book['author']['authorId']", "book['author']['authorName']", "book['isbn']", "name")));
536     }
537     @Test
538     public void testAlterTableAddNestedObjectWithArrayToExistingObject() throws Exception {
539         execute("CREATE TABLE my_table (col1 object)");
540         ensureYellow();
541         execute("ALTER TABLE my_table ADD COLUMN col1['col2'] object as (col3 array(string))");
542         waitNoPendingTasksOnAll();
543         execute("SELECT column_name, data_type FROM information_schema.columns " +
544                 "WHERE table_name = 'my_table' AND table_schema = 'doc' " +
545                 "ORDER BY column_name asc");
546         assertThat(TestingHelpers.getColumn(response.rows(), 0),
547             is(Matchers.&lt;Object&gt;arrayContaining("col1", "col1['col2']", "col1['col2']['col3']")));
548         assertThat(TestingHelpers.getColumn(response.rows(), 1),
549             is(Matchers.arrayContaining("object", "object", "text_array")));
550         execute("DROP TABLE my_table");
551         ensureYellow();
552         execute("CREATE TABLE my_table (col1 object as (col2 object))");
553         ensureYellow();
554         execute("ALTER TABLE my_table ADD COLUMN col1['col2']['col3'] object as (col4 array(long))");
555         waitNoPendingTasksOnAll();
556         execute("SELECT column_name, data_type FROM information_schema.columns " +
557                 "WHERE table_name = 'my_table' AND table_schema = 'doc' " +
558                 "ORDER BY column_name asc");
559         assertThat(TestingHelpers.getColumn(response.rows(), 0),
560             is(Matchers.&lt;Object&gt;arrayContaining("col1", "col1['col2']", "col1['col2']['col3']", "col1['col2']['col3']['col4']")));
561         assertThat(TestingHelpers.getColumn(response.rows(), 1),
562             is(Matchers.arrayContaining("object", "object", "object", "bigint_array")));
563     }
564     @Test
565     public void testAlterTableAddObjectToObjectArray() throws Exception {
566         execute("CREATE TABLE t (" +
567                 "   attributes ARRAY(" +
568                 "       OBJECT (STRICT) as (" +
569                 "           name STRING" +
570                 "       )" +
571                 "   )" +
572                 ")");
573         ensureYellow();
574         execute("ALTER TABLE t ADD column attributes['is_nice'] BOOLEAN");
575         execute("INSERT INTO t (attributes) values ([{name='Trillian', is_nice=True}])");
576         refresh();
577         execute("select attributes from t");
578         assertThat(((List&lt;Object&gt;)response.rows()[0][0]).get(0), is(Map.of("name", "Trillian", "is_nice", true)));
579     }
580     @Test
581     public void testDropTable() throws Exception {
582         execute("create table test (col1 integer primary key, col2 string)");
583         assertThat(internalCluster().clusterService().state().metadata().hasIndex("test"), is(true));
584         execute("drop table test");
585         assertThat(response.rowCount(), is(1L));
586         assertThat(internalCluster().clusterService().state().metadata().hasIndex("test"), is(false));
587     }
588     @Test
589     public void testDropTableIfExistsRaceCondition() throws Exception {
590         execute("create table test (name string)");
591         execute("drop table test");
592         execute("drop table if exists test");
593     }
594     @Test
595     public void testDropUnknownTable() throws Exception {
596         assertThrowsMatches(() -&gt; execute("drop table test"),
597                      isSQLError(is("Relation 'test' unknown"), UNDEFINED_TABLE, NOT_FOUND, 4041));
598     }
599     @Test
600     public void testDropTableIfExists() {
601         execute("create table test (col1 integer primary key, col2 string)");
602         assertThat(internalCluster().clusterService().state().metadata().hasIndex("test"), is(true));
603         execute("drop table if exists test");
604         assertThat(response.rowCount(), is(1L));
605         assertThat(internalCluster().clusterService().state().metadata().hasIndex("test"), is(false));
606     }
607     @Test
608     public void testDropIfExistsUnknownTable() throws Exception {
609         execute("drop table if exists nonexistent");
610         assertThat(response.rowCount(), is(0L));
611     }
612     @Test
613     public void testCreateAlterAndDropBlobTable() throws Exception {
614         execute("create blob table screenshots with (number_of_replicas=0)");
615         execute("alter blob table screenshots set (number_of_replicas=1)");
616         execute("select number_of_replicas from information_schema.tables " +
617                 "where table_schema = 'blob' and table_name = 'screenshots'");
618         assertEquals("1", response.rows()[0][0]);
619         execute("drop blob table screenshots");
620     }
621     @Test
622     public void testDropIfExistsBlobTable() throws Exception {
623         execute("create blob table screenshots with (number_of_replicas=0)");
624         execute("drop blob table if exists screenshots");
625         assertEquals(response.rowCount(), 1);
626     }
627     @Test
628     public void testDropBlobTableIfExistsUnknownTable() throws Exception {
629         execute("drop blob table if exists nonexistent");
630         assertThat(response.rowCount(), is(0L));
631     }
632     @Test
633     public void testAlterShardsOfPartitionedTableAffectsNewPartitions() {
634         execute(
635             "create table quotes (" +
636             "   id integer," +
637             "   quote string," +
638             "   date timestamp with time zone" +
639             ") partitioned by(date) " +
640             "clustered into 3 shards with (number_of_replicas='0-all')");
641         ensureYellow();
642         execute("insert into quotes (id, quote, date) values (?, ?, ?), (?, ?, ?)",
643             new Object[]{
644                 1, "Don't panic", 1395874800000L,
645                 2, "Now panic", 1395961200000L}
646         );
647         execute("alter table quotes set (number_of_shards=5)");
648 <a name="3"></a>
649         String templateName = PartitionName.templateName(Schemas.DOC_SCHEMA_NAME, "quotes");
650         GetIndexTemplatesResponse templatesResponse =
651             <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>client().admin().indices().prepareGetTemplates(templateName).execute().actionGet();
652         Settings templateSettings = templatesResponse.getIndexTemplates().get(0).getSettings();
653         assertThat(templateSettings.getAsInt(IndexMetadata.SETTING_NUMBER_OF_SHARDS, 0), is(5));
654         execute</b></font>("insert into quotes (id, quote, date) values (?, ?, ?)",
655             new Object[]{3, "Time is a illusion. Lunchtime doubles so", 1495961200000L}
656         );
657         PartitionName partitionName = new PartitionName(
658             new RelationName("doc", "quotes"), Arrays.asList("1495961200000"));
659         execute("select number_of_shards from information_schema.table_partitions where partition_ident = ? and table_name = ?",
660             $(partitionName.ident(), partitionName.relationName().name()));
661         assertThat(response.rows()[0][0], is(5));
662     }
663     @Test
664     public void testAlterShardsTableCombinedWithOtherSettingsIsInvalid() {
665         execute(
666             "create table quotes (" +
667             "   id integer," +
668             "   quote string," +
669             "   date timestamp with time zone" +
670             ") clustered into 3 shards with (number_of_replicas='0-all')");
671         assertThrowsMatches(() -&gt; execute("alter table quotes set (number_of_shards=1, number_of_replicas='1-all')"),
672                      isSQLError(is("Setting [number_of_shards] cannot be combined with other settings"),
673                                 INTERNAL_ERROR,
674                                 BAD_REQUEST,
675                                 4000));
676     }
677     @Test
678     public void testAlterShardsPartitionCombinedWithOtherSettingsIsInvalid() {
679         execute(
680             "create table quotes (" +
681             "   id integer," +
682             "   quote string," +
683             "   date timestamp with time zone" +
684             ") partitioned by(date) " +
685             "clustered into 3 shards with (number_of_replicas='0-all')");
686         execute("insert into quotes (id, quote, date) values (?, ?, ?), (?, ?, ?)",
687             new Object[]{
688                 1, "Don't panic", 1395874800000L,
689                 2, "Now panic", 1395961200000L}
690         );
691         assertThrowsMatches(() -&gt; execute("alter table quotes partition (date=1395874800000) " +
692                                    "set (number_of_shards=1, number_of_replicas='1-all')"),
693                      isSQLError(is("Setting [number_of_shards] cannot be combined with other settings"),
694                                 INTERNAL_ERROR,
695                                 BAD_REQUEST,
696                                 4000));
697     }
698     @Test
699     public void testCreateTableWithCustomSchema() throws Exception {
700         execute("create table a.t (name string) with (number_of_replicas=0)");
701         ensureYellow();
702         execute("insert into a.t (name) values ('Ford')");
703         assertThat(response.rowCount(), is(1L));
704         refresh();
705         execute("select name from a.t");
706         assertThat(response.rowCount(), is(1L));
707         assertThat((String) response.rows()[0][0], is("Ford"));
708         execute("select table_schema from information_schema.tables where table_name = 't'");
709         assertThat(response.rowCount(), is(1L));
710         assertThat((String) response.rows()[0][0], is("a"));
711     }
712     @Test
713     public void testCreateTableWithIllegalCustomSchemaCheckedByES() throws Exception {
714         assertThrowsMatches(() -&gt; execute("create table \"AAA\".t (name string) with (number_of_replicas=0)"),
715                      isSQLError(is("Relation name \"AAA.t\" is invalid."), INTERNAL_ERROR, BAD_REQUEST, 4002));
716     }
717     @Test
718     public void testDropTableWithCustomSchema() throws Exception {
719         execute("create table a.t (name string) with (number_of_replicas=0)");
720         ensureYellow();
721         execute("drop table a.t");
722         assertThat(response.rowCount(), is(1L));
723         execute("select table_schema from information_schema.tables where table_name = 't'");
724         assertThat(response.rowCount(), is(0L));
725     }
726     @Test
727     public void testCreateTableWithGeneratedColumn() throws Exception {
728         execute(
729             "create table test (" +
730             "   ts timestamp with time zone," +
731             "   day as date_trunc('day', ts)) with (number_of_replicas=0)");
732         ensureYellow();
733         String expectedMapping = "{\"default\":" +
734                                  "{\"dynamic\":\"strict\"," +
735                                  "\"_meta\":{" +
736                                  "\"generated_columns\":{\"day\":\"date_trunc('day', ts)\"}}," +
737                                  "\"properties\":{" +
738                                  "\"day\":{\"type\":\"date\",\"position\":2,\"format\":\"epoch_millis||strict_date_optional_time\"}," +
739                                  "\"ts\":{\"type\":\"date\",\"position\":1,\"format\":\"epoch_millis||strict_date_optional_time\"}" +
740                                  "}}}";
741         assertEquals(expectedMapping, getIndexMapping("test"));
742     }
743     @Test
744     public void testAddGeneratedColumnToTableWithExistingGeneratedColumns() throws Exception {
745         execute(
746             "create table test (" +
747             "   ts timestamp with time zone," +
748             "   day as date_trunc('day', ts)) with (number_of_replicas=0)");
749         execute("alter table test add column added timestamp generated always as date_trunc('day', ts)");
750         ensureYellow();
751         String expectedMapping = "{\"default\":" +
752                                  "{\"dynamic\":\"strict\"," +
753                                  "\"_meta\":{" +
754                                  "\"generated_columns\":{" +
755                                  "\"added\":\"date_trunc('day', ts)\"," +
756                                  "\"day\":\"date_trunc('day', ts)\"}}," +
757                                  "\"properties\":{" +
758                                  "\"added\":{\"type\":\"date\",\"position\":3,\"format\":\"epoch_millis||strict_date_optional_time\"}," +
759                                  "\"day\":{\"type\":\"date\",\"position\":2,\"format\":\"epoch_millis||strict_date_optional_time\"}," +
760                                  "\"ts\":{\"type\":\"date\",\"position\":1,\"format\":\"epoch_millis||strict_date_optional_time\"}" +
761                                  "}}}";
762         assertEquals(expectedMapping, getIndexMapping("test"));
763     }
764     @Test
765     public void test_alter_table_cannot_add_broken_generated_column() throws Exception {
766         execute("create table tbl (x int)");
767         Asserts.assertThrowsMatches(
768             () -&gt; execute("alter table tbl add column ts timestamp without time zone generated always as 'foobar'"),
769             SQLErrorMatcher.isSQLError(
770                 is("Cannot cast `'foobar'` of type `text` to type `timestamp without time zone`"),
771                 PGErrorStatus.INTERNAL_ERROR,
772                 HttpResponseStatus.BAD_REQUEST,
773                 4000
774             )
775         );
776     }
777     @Test
778     public void test_alter_table_add_column_keeps_existing_meta_information() throws Exception {
779         execute("""
780             CREATE TABLE tbl (
781                 author TEXT NOT NULL,
782                 INDEX author_ft USING FULLTEXT (author) WITH (analyzer = 'standard')
783             )
784         """);
785         execute("ALTER TABLE tbl ADD COLUMN dummy text NOT NULL");
786         execute("show create table tbl");
787         assertThat((String) response.rows()[0][0], startsWith("""
788             CREATE TABLE IF NOT EXISTS "doc"."tbl" (
789                "author" TEXT NOT NULL,
790                "dummy" TEXT NOT NULL,
791                INDEX "author_ft" USING FULLTEXT ("author") WITH (
792                   analyzer = 'standard'
793                )
794             )
795             """.stripIndent()
796         ));
797     }
798 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>PublicationTests.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Elasticsearch under one or more contributor
3  * license agreements. See the NOTICE file distributed with
4  * this work for additional information regarding copyright
5  * ownership. Elasticsearch licenses this file to you under
6  * the Apache License, Version 2.0 (the "License"); you may
7  * not use this file except in compliance with the License.
8  * You may obtain a copy of the License at
9  *
10  *    http://www.apache.org/licenses/LICENSE-2.0
11  *
12  * Unless required by applicable law or agreed to in writing,
13  * software distributed under the License is distributed on an
14  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
15  * KIND, either express or implied.  See the License for the
16  * specific language governing permissions and limitations
17 <a name="0"></a> * under the License.
18  */
19 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>package org.elasticsearch.cluster.coordination;
20 import org.elasticsearch.Version;
21 import org.elasticsearch.action.ActionListener;
22 import org.elasticsearch.cluster.ClusterState;
23 import org.elasticsearch.cluster.coordination.CoordinationMetadata.VotingConfiguration;
24 import org.elasticsearch.cluster.node.DiscoveryNode;
25 import org.elasticsearch.cluster.node.DiscoveryNodeRole;
26 import org.elasticsearch.cluster.node.DiscoveryNodes;
27 import javax.annotation.Nullable;
28 import io.crate.common.collections.Tuple;
29 import org.elasticsearch.common.settings.Settings;
30 import io.crate.common.unit.TimeValue;
31 import io.crate.common.collections.Sets;
32 import org.elasticsearch.discovery.Discovery;
33 import org.elasticsearch.test.ESTestCase;
34 import org.elasticsearch.transport.TransportException;
35 import org.elasticsearch.transport.TransportResponse;
36 import java.util.ArrayList;
37 import java.util.Arrays;
38 import java.util.Collections;
39 import java.util.Comparator;
40 import java.util.HashMap;
41 import java.util.HashSet;
42 import java.util.LinkedHashMap;
43 import java.util.List;
44 import java.util.Map;
45 import java.util.Optional;
46 import java.util.Set;
47 import java.util.concurrent.CopyOnWriteArrayList;
48 import java.util.concurrent.CountDownLatch;
49 import java.util.concurrent.TimeUnit;
50 import java.util.concurrent.atomic.AtomicBoolean;
51 import java.util.concurrent.atomic.AtomicInteger;
52 import java.util.function.Function;
53 import java.util.function.LongSupplier;
54 import java.util.stream.Collector;
55 import</b></font> java.util.stream.Collectors;
56 import java.util.stream.Stream;
57 import static org.hamcrest.Matchers.containsInAnyOrder;
58 import static org.hamcrest.Matchers.containsString;
59 import static org.hamcrest.Matchers.empty;
60 import static org.hamcrest.Matchers.emptyIterable;
61 import static org.hamcrest.Matchers.equalTo;
62 public class PublicationTests extends ESTestCase {
63     class MockNode {
64         MockNode(Settings settings, DiscoveryNode localNode) {
65             this.localNode = localNode;
66             ClusterState initialState = CoordinationStateTests.clusterState(0L, 0L, localNode,
67                 CoordinationMetadata.VotingConfiguration.EMPTY_CONFIG, CoordinationMetadata.VotingConfiguration.EMPTY_CONFIG, 0L);
68             coordinationState = new CoordinationState(settings, localNode, new InMemoryPersistedState(0L, initialState));
69         }
70         final DiscoveryNode localNode;
71         final CoordinationState coordinationState;
72         public MockPublication publish(ClusterState clusterState, Discovery.AckListener ackListener, Set&lt;DiscoveryNode&gt; faultyNodes) {
73             PublishRequest publishRequest = coordinationState.handleClientValue(clusterState);
74             MockPublication currentPublication = new MockPublication(publishRequest, ackListener, () -&gt; 0L) {
75                 @Override
76                 protected boolean isPublishQuorum(CoordinationState.VoteCollection votes) {
77                     return coordinationState.isPublishQuorum(votes);
78                 }
79                 @Override
80                 protected Optional&lt;ApplyCommitRequest&gt; handlePublishResponse(DiscoveryNode sourceNode, PublishResponse publishResponse) {
81                     return coordinationState.handlePublishResponse(sourceNode, publishResponse);
82                 }
83             };
84             currentPublication.start(faultyNodes);
85             return currentPublication;
86         }
87     }
88     abstract class MockPublication extends Publication {
89         final PublishRequest publishRequest;
90         ApplyCommitRequest applyCommit;
91         boolean completed;
92         boolean committed;
93         Map&lt;DiscoveryNode, ActionListener&lt;PublishWithJoinResponse&gt;&gt; pendingPublications = new LinkedHashMap&lt;&gt;();
94         Map&lt;DiscoveryNode, ActionListener&lt;TransportResponse.Empty&gt;&gt; pendingCommits = new LinkedHashMap&lt;&gt;();
95         Map&lt;DiscoveryNode, Join&gt; joins = new HashMap&lt;&gt;();
96         Set&lt;DiscoveryNode&gt; missingJoins = new HashSet&lt;&gt;();
97         MockPublication(PublishRequest publishRequest, Discovery.AckListener ackListener, LongSupplier currentTimeSupplier) {
98             super(publishRequest, ackListener, currentTimeSupplier);
99             this.publishRequest = publishRequest;
100         }
101         @Override
102         protected void onCompletion(boolean committed) {
103             assertFalse(completed);
104             completed = true;
105             this.committed = committed;
106         }
107         @Override
108         protected void onJoin(Join join) {
109             assertNull(joins.put(join.getSourceNode(), join));
110         }
111         @Override
112         protected void onMissingJoin(DiscoveryNode discoveryNode) {
113             assertTrue(missingJoins.add(discoveryNode));
114         }
115         @Override
116         protected void sendPublishRequest(DiscoveryNode destination, PublishRequest publishRequest,
117                                           ActionListener&lt;PublishWithJoinResponse&gt; responseActionListener) {
118             assertSame(publishRequest, this.publishRequest);
119             assertNull(pendingPublications.put(destination, responseActionListener));
120         }
121         @Override
122         protected void sendApplyCommit(DiscoveryNode destination, ApplyCommitRequest applyCommit,
123                                        ActionListener&lt;TransportResponse.Empty&gt; responseActionListener) {
124             if (this.applyCommit == null) {
125                 this.applyCommit = applyCommit;
126             } else {
127                 assertSame(applyCommit, this.applyCommit);
128             }
129             assertNull(pendingCommits.put(destination, responseActionListener));
130         }
131     }
132     DiscoveryNode n1 = CoordinationStateTests.createNode("node1");
133     DiscoveryNode n2 = CoordinationStateTests.createNode("node2");
134     DiscoveryNode n3 = CoordinationStateTests.createNode("node3");
135     Set&lt;DiscoveryNode&gt; discoNodes = Set.of(n1, n2, n3);
136     MockNode node1 = new MockNode(Settings.EMPTY, n1);
137     MockNode node2 = new MockNode(Settings.EMPTY, n2);
138     MockNode node3 = new MockNode(Settings.EMPTY, n3);
139     List&lt;MockNode&gt; nodes = Arrays.asList(node1, node2, node3);
140     Function&lt;DiscoveryNode, MockNode&gt; nodeResolver = dn -&gt; nodes.stream().filter(mn -&gt; mn.localNode.equals(dn)).findFirst().get();
141 <a name="10"></a>    private void initializeCluster(VotingConfiguration initialConfig) {
142         node1.coordinationState.setInitialState(CoordinationStateTests.clusterState(0L, 0L, n1, initialConfig, initialConfig, 0L));
143         StartJoinRequest startJoinRequest = new StartJoinRequest(n1, 1L);
144         <font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>node1.coordinationState.handleJoin(node1.coordinationState.handleStartJoin(startJoinRequest));
145         node1.coordinationState.handleJoin(node2.coordinationState.handleStartJoin(startJoinRequest));
146         node1.coordinationState.handleJoin(node3.coordinationState.handleStartJoin(startJoinRequest));
147         assertTrue(node1.coordinationState.electionWon());
148     }
149     public void testSimpleClusterSta</b></font>tePublishing() throws InterruptedException {
150         VotingConfiguration singleNodeConfig = new VotingConfiguration(Set.of(n1.getId()));
151 <a name="3"></a>        initializeCluster(singleNodeConfig);
152         AssertingAckListener ackListener = new AssertingAckListener(nodes.size());
153         DiscoveryNodes discoveryNodes = <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>DiscoveryNodes.builder().add(n1).add(n2).add(n3).localNodeId(n1.getId()).build();
154         MockPublication publication = node1.publish(CoordinationStateTests.clusterState(1L, 2L,
155             discoveryNodes, singleNodeConfig, singleNodeConfig, 42L), ackListener, Collections.emptySet());
156         assertThat(publication.pendingPublications.keySet(), equalTo(discoNodes));
157         assertThat</b></font>(publication.completedNodes(), empty());
158         assertTrue(publication.pendingCommits.isEmpty());
159         AtomicBoolean processedNode1PublishResponse = new AtomicBoolean();
160         boolean delayProcessingNode2PublishResponse = randomBoolean();
161         publication.pendingPublications.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
162 <a name="8"></a>            if (delayProcessingNode2PublishResponse &amp;&amp; e.getKey().equals(n2)) {
163                 return;
164             }
165             PublishResponse publishResponse = <font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>nodeResolver.apply(e.getKey()).coordinationState.handlePublishRequest(
166                 publication.publishRequest);
167             assertNotEquals(processedNode1PublishResponse.get(), publication.pendingCommits.isEmpty());
168             assertFalse(publication.joins.containsKey(e.getKey()));
169             PublishWithJoinResponse publishWithJoinResponse = new</b></font> PublishWithJoinResponse(publishResponse,
170 <a name="5"></a>                randomBoolean() ? Optional.empty() : Optional.of(new Join(e.getKey(), randomFrom(n1, n2, n3), publishResponse.getTerm(),
171                     randomNonNegativeLong(), randomNonNegativeLong())));
172             e.getValue().onResponse(publishWithJoinResponse);
173             if (publishWithJoinResponse.getJoin().isPresent()) <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
174                 assertTrue(publication.joins.containsKey(e.getKey()));
175                 assertFalse(publication.missingJoins.contains(e.getKey()));
176                 assertEquals(publishWithJoinResponse.getJoin().get(), publication.joins.get(e.getKey()));
177             }</b></font> else {
178                 assertFalse(publication.joins.containsKey(e.getKey()));
179                 assertTrue(publication.missingJoins.contains(e.getKey()));
180             }
181             if (e.getKey().equals(n1)) {
182                 processedNode1PublishResponse.set(true);
183             }
184             assertNotEquals(processedNode1PublishResponse.get(), publication.pendingCommits.isEmpty());
185         });
186         if (delayProcessingNode2PublishResponse) {
187             assertThat(publication.pendingCommits.keySet(), equalTo(Set.of(n1, n3)));
188 <a name="4"></a>        } else {
189             assertThat(publication.pendingCommits.keySet(), equalTo(discoNodes));
190         }
191 <a name="14"></a>        <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertNotNull(publication.applyCommit);
192         assertEquals(publication.applyCommit.getTerm(), publication.publishRequest.getAcceptedState().term());
193         assertEquals(publication.applyCommit.getVersion(), publication.publishRequest.getAcceptedState().version());
194         publication.pendingCommits.entrySet().stream().collect(shuffle</b></font>()).forEach(e -&gt; <font color="#842dce"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
195             assertFalse(publication.completed);
196             assertFalse(publication.committed);
197             nodeResolver.apply(e.getKey()).coordinationState.handleCommit(publication.applyCommit);
198             e.getValue().onResponse(TransportResponse.Empty.INSTANCE);
199         }</b></font>);
200         if (delayProcessingNode2PublishResponse) {
201             assertFalse(publication.completed);
202 <a name="6"></a>            assertFalse(publication.committed);
203             PublishResponse publishResponse = nodeResolver.apply(n2).coordinationState.handlePublishRequest(
204                 publication.publishRequest);
205             publication.pendingPublications.get(n2).onResponse(new PublishWithJoinResponse(publishResponse, <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>Optional.empty()));
206             assertThat(publication.pendingCommits.keySet(), equalTo(discoNodes));
207             assertFalse(publication.completed);
208             assertFalse(publication.committed);
209             assertThat(publication.completedNodes(), containsInAnyOrder(n1, n3));
210 <a name="9"></a>            publication.pendingCommits.get(n2).onResponse(TransportResponse.Empty.INSTANCE);
211         }</b></font>
212         <font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertTrue(publication.completed);
213         assertThat(publication.completedNodes(), containsInAnyOrder(n1, n2, n3));
214         assertTrue(publication.committed);
215         assertThat(ackListener.await(0L, TimeUnit.SECONDS), containsInAnyOrder(n1, n2, n3));
216     }
217     public void testClusterStatePublishingWithFaultyNode</b></font>BeforeCommit() throws InterruptedException {
218         VotingConfiguration singleNodeConfig = new VotingConfiguration(Set.of(n1.getId()));
219 <a name="12"></a>        initializeCluster(singleNodeConfig);
220         AssertingAckListener ackListener = new AssertingAckListener(nodes.size());
221         DiscoveryNodes discoveryNodes = <font color="#571b7e"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>DiscoveryNodes.builder().add(n1).add(n2).add(n3).localNodeId(n1.getId()).build();
222         AtomicInteger remainingActions = new</b></font> AtomicInteger(4);         int injectFaultAt = randomInt(remainingActions.get() - 1);
223         logger.info("Injecting fault at: {}", injectFaultAt);
224         Set&lt;DiscoveryNode&gt; initialFaultyNodes = remainingActions.decrementAndGet() == injectFaultAt ?
225             Collections.singleton(n2) : Collections.emptySet();
226         MockPublication publication = node1.publish(CoordinationStateTests.clusterState(1L, 2L,
227             discoveryNodes, singleNodeConfig, singleNodeConfig, 42L), ackListener, initialFaultyNodes);
228         publication.pendingPublications.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
229             if (remainingActions.decrementAndGet() == injectFaultAt) {
230                 publication.onFaultyNode(n2);
231             }
232             if (e.getKey().equals(n2) == false || randomBoolean()) {
233                 PublishResponse publishResponse = nodeResolver.apply(e.getKey()).coordinationState.handlePublishRequest(
234                     publication.publishRequest);
235                 e.getValue().onResponse(new PublishWithJoinResponse(publishResponse, Optional.empty()));
236             }
237         });
238         publication.pendingCommits.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
239             nodeResolver.apply(e.getKey()).coordinationState.handleCommit(publication.applyCommit);
240             e.getValue().onResponse(TransportResponse.Empty.INSTANCE);
241         });
242         assertTrue(publication.completed);
243         assertTrue(publication.committed);
244 <a name="2"></a>
245         publication.onFaultyNode(randomFrom(n1, n3)); 
246         List&lt;Tuple&lt;DiscoveryNode, Throwable&gt;&gt; errors = <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>ackListener.awaitErrors(0L, TimeUnit.SECONDS);
247         assertThat(errors.size(), equalTo(1));
248         assertThat(errors.get(0).v1(), equalTo(n2));
249         assertThat(errors.get(0).v2().getMessage(), containsString("faulty node"));
250     }
251     public void testClusterStatePublishingWithFaultyNod</b></font>eAfterCommit() throws InterruptedException {
252         VotingConfiguration singleNodeConfig = new VotingConfiguration(Set.of(n1.getId()));
253         initializeCluster(singleNodeConfig);
254         AssertingAckListener ackListener = new AssertingAckListener(nodes.size());
255         DiscoveryNodes discoveryNodes = DiscoveryNodes.builder().add(n1).add(n2).add(n3).localNodeId(n1.getId()).build();
256         boolean publicationDidNotMakeItToNode2 = randomBoolean();
257         AtomicInteger remainingActions = new AtomicInteger(publicationDidNotMakeItToNode2 ? 2 : 3);
258         int injectFaultAt = randomInt(remainingActions.get() - 1);
259         logger.info("Injecting fault at: {}, publicationDidNotMakeItToNode2: {}", injectFaultAt, publicationDidNotMakeItToNode2);
260         MockPublication publication = node1.publish(CoordinationStateTests.clusterState(1L, 2L,
261             discoveryNodes, singleNodeConfig, singleNodeConfig, 42L), ackListener, Collections.emptySet());
262         publication.pendingPublications.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
263             if (e.getKey().equals(n2) == false || publicationDidNotMakeItToNode2 == false) {
264                 PublishResponse publishResponse = nodeResolver.apply(e.getKey()).coordinationState.handlePublishRequest(
265                     publication.publishRequest);
266                 e.getValue().onResponse(new PublishWithJoinResponse(publishResponse, Optional.empty()));
267             }
268         });
269         publication.pendingCommits.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
270             if (e.getKey().equals(n2)) {
271                 publication.onFaultyNode(n2);
272             }
273             if (remainingActions.decrementAndGet() == injectFaultAt) {
274                 publication.onFaultyNode(n2);
275             }
276             if (e.getKey().equals(n2) == false || randomBoolean()) {
277                 nodeResolver.apply(e.getKey()).coordinationState.handleCommit(publication.applyCommit);
278                 e.getValue().onResponse(TransportResponse.Empty.INSTANCE);
279             }
280         });
281         if (publicationDidNotMakeItToNode2 &amp;&amp; remainingActions.get() &gt; injectFaultAt) {
282             publication.onFaultyNode(n2);
283         }
284         assertTrue(publication.completed);
285         assertTrue(publication.committed);
286 <a name="1"></a>
287         publication.onFaultyNode(randomFrom(n1, n3)); 
288         List&lt;Tuple&lt;DiscoveryNode, Throwable&gt;&gt; errors = <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>ackListener.awaitErrors(0L, TimeUnit.SECONDS);
289         assertThat(errors.size(), equalTo(1));
290         assertThat(errors.get(0).v1(), equalTo(n2));
291         assertThat(errors.get(0).v2().getMessage(), containsString("faulty node"));
292     }
293     public void testClusterStatePublishingFailsOrTimesOut</b></font>BeforeCommit() throws InterruptedException {
294         VotingConfiguration config = new VotingConfiguration(Set.of(n1.getId(), n2.getId()));
295 <a name="11"></a>        initializeCluster(config);
296         AssertingAckListener ackListener = new AssertingAckListener(nodes.size());
297         DiscoveryNodes discoveryNodes = <font color="#b041ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>DiscoveryNodes.builder().add(n1).add(n2).add(n3).localNodeId(n1.getId()).build();
298         MockPublication publication = node1.publish(CoordinationStateTests.clusterState(1L, 2L,
299             discoveryNodes, config, config, 42L), ackListener, Collections.emptySet());
300         boolean timeOut = randomBoolean();
301         publication.pendingPublications.entrySet().stream().collect(shuffle()).forEach</b></font>(e -&gt; {
302             if (e.getKey().equals(n2)) {
303                 if (timeOut) {
304                     publication.cancel("timed out");
305                 } else {
306                     e.getValue().onFailure(new TransportException(new Exception("dummy failure")));
307                 }
308                 assertTrue(publication.completed);
309                 assertFalse(publication.committed);
310             } else if (randomBoolean()) {
311                 PublishResponse publishResponse = nodeResolver.apply(e.getKey()).coordinationState.handlePublishRequest(
312                     publication.publishRequest);
313                 e.getValue().onResponse(new PublishWithJoinResponse(publishResponse, Optional.empty()));
314             }
315         });
316         assertThat(publication.pendingCommits.keySet(), equalTo(Collections.emptySet()));
317         assertNull(publication.applyCommit);
318 <a name="7"></a>        assertTrue(publication.completed);
319         assertFalse(publication.committed);
320         <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>List&lt;Tuple&lt;DiscoveryNode, Throwable&gt;&gt; errors = ackListener.awaitErrors(0L, TimeUnit.SECONDS);
321         assertThat(errors.size(), equalTo(3));
322         assertThat(errors.stream().map(Tuple::v1).collect(Collectors.toList()), containsInAnyOrder(n1, n2, n3));
323         errors.stream().forEach</b></font>(tuple -&gt;
324             assertThat(tuple.v2().getMessage(), containsString(timeOut ? "timed out" :
325                 tuple.v1().equals(n2) ? "dummy failure" : "non-failed nodes do not form a quorum")));
326     }
327     public void testPublishingToMastersFirst() {
328         VotingConfiguration singleNodeConfig = new VotingConfiguration(Set.of(n1.getId()));
329         initializeCluster(singleNodeConfig);
330         DiscoveryNodes.Builder discoNodesBuilder = DiscoveryNodes.builder();
331         randomNodes(10).forEach(dn -&gt; discoNodesBuilder.add(dn));
332         DiscoveryNodes discoveryNodes = discoNodesBuilder.add(n1).localNodeId(n1.getId()).build();
333         MockPublication publication = node1.publish(CoordinationStateTests.clusterState(1L, 2L,
334             discoveryNodes, singleNodeConfig, singleNodeConfig, 42L), null, Collections.emptySet());
335         List&lt;DiscoveryNode&gt; publicationTargets = new ArrayList&lt;&gt;(publication.pendingPublications.keySet());
336         List&lt;DiscoveryNode&gt; sortedPublicationTargets = new ArrayList&lt;&gt;(publicationTargets);
337         Collections.sort(sortedPublicationTargets, Comparator.comparing(n -&gt; n.isMasterEligibleNode() == false));
338         assertEquals(sortedPublicationTargets, publicationTargets);
339 <a name="13"></a>    }
340     public void testClusterStatePublishingTimesOutAfterCommit() throws InterruptedException {
341         VotingConfiguration config = new VotingConfiguration(<font color="#3b9c9c"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>randomBoolean() ?
342             Set.of(n1.getId(), n2.getId()) : Set.of(n1.getId(), n2.getId(), n3.getId()));
343         initializeCluster</b></font>(config);
344         AssertingAckListener ackListener = new AssertingAckListener(nodes.size());
345         DiscoveryNodes discoveryNodes = DiscoveryNodes.builder().add(n1).add(n2).add(n3).localNodeId(n1.getId()).build();
346         MockPublication publication = node1.publish(CoordinationStateTests.clusterState(1L, 2L,
347             discoveryNodes, config, config, 42L), ackListener, Collections.emptySet());
348         boolean publishedToN3 = randomBoolean();
349         publication.pendingPublications.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
350             if (e.getKey().equals(n3) == false || publishedToN3) {
351                 PublishResponse publishResponse = nodeResolver.apply(e.getKey()).coordinationState.handlePublishRequest(
352                     publication.publishRequest);
353                 e.getValue().onResponse(new PublishWithJoinResponse(publishResponse, Optional.empty()));
354             }
355         });
356         assertNotNull(publication.applyCommit);
357         Set&lt;DiscoveryNode&gt; committingNodes = new HashSet&lt;&gt;(randomSubsetOf(discoNodes));
358         if (publishedToN3 == false) {
359             committingNodes.remove(n3);
360         }
361         logger.info("Committing nodes: {}", committingNodes);
362         publication.pendingCommits.entrySet().stream().collect(shuffle()).forEach(e -&gt; {
363             if (committingNodes.contains(e.getKey())) {
364                 nodeResolver.apply(e.getKey()).coordinationState.handleCommit(publication.applyCommit);
365                 e.getValue().onResponse(TransportResponse.Empty.INSTANCE);
366             }
367         });
368         publication.cancel("timed out");
369         assertTrue(publication.completed);
370         assertTrue(publication.committed);
371         assertEquals(committingNodes, ackListener.await(0L, TimeUnit.SECONDS));
372         if (publishedToN3 == false) {
373             publication.pendingPublications.get(n3).onResponse(
374                 new PublishWithJoinResponse(node3.coordinationState.handlePublishRequest(publication.publishRequest), Optional.empty()));
375         }
376         assertEquals(discoNodes, publication.pendingCommits.keySet());
377         Set&lt;DiscoveryNode&gt; nonCommittedNodes = Sets.difference(discoNodes, committingNodes);
378         logger.info("Non-committed nodes: {}", nonCommittedNodes);
379         nonCommittedNodes.stream().collect(shuffle()).forEach(n -&gt;
380             publication.pendingCommits.get(n).onResponse(TransportResponse.Empty.INSTANCE));
381         assertEquals(discoNodes, ackListener.await(0L, TimeUnit.SECONDS));
382     }
383     private static List&lt;DiscoveryNode&gt; randomNodes(final int numNodes) {
384         List&lt;DiscoveryNode&gt; nodesList = new ArrayList&lt;&gt;();
385         for (int i = 0; i &lt; numNodes; i++) {
386             Map&lt;String, String&gt; attributes = new HashMap&lt;&gt;();
387             if (frequently()) {
388                 attributes.put("custom", randomBoolean() ? "match" : randomAlphaOfLengthBetween(3, 5));
389             }
390             final DiscoveryNode node = newNode(i, attributes,
391                 new HashSet&lt;&gt;(randomSubsetOf(DiscoveryNodeRole.BUILT_IN_ROLES)));
392             nodesList.add(node);
393         }
394         return nodesList;
395     }
396     private static DiscoveryNode newNode(int nodeId, Map&lt;String, String&gt; attributes, Set&lt;DiscoveryNodeRole&gt; roles) {
397         return new DiscoveryNode("name_" + nodeId, "node_" + nodeId, buildNewFakeTransportAddress(), attributes, roles,
398             Version.CURRENT);
399     }
400     public static &lt;T&gt; Collector&lt;T, ?, Stream&lt;T&gt;&gt; shuffle() {
401         return Collectors.collectingAndThen(Collectors.toList(),
402             ts -&gt; {
403                 Collections.shuffle(ts, random());
404                 return ts.stream();
405             });
406     }
407     public static class AssertingAckListener implements Discovery.AckListener {
408         private final List&lt;Tuple&lt;DiscoveryNode, Throwable&gt;&gt; errors = new CopyOnWriteArrayList&lt;&gt;();
409         private final Set&lt;DiscoveryNode&gt; successfulAcks = Collections.synchronizedSet(new HashSet&lt;&gt;());
410         private final CountDownLatch countDown;
411         private final CountDownLatch commitCountDown;
412         public AssertingAckListener(int nodeCount) {
413             countDown = new CountDownLatch(nodeCount);
414             commitCountDown = new CountDownLatch(1);
415         }
416         @Override
417         public void onCommit(TimeValue commitTime) {
418             commitCountDown.countDown();
419         }
420         @Override
421         public void onNodeAck(DiscoveryNode node, @Nullable Exception e) {
422             if (e != null) {
423                 errors.add(new Tuple&lt;&gt;(node, e));
424             } else {
425                 successfulAcks.add(node);
426             }
427             countDown.countDown();
428         }
429         public Set&lt;DiscoveryNode&gt; await(long timeout, TimeUnit unit) throws InterruptedException {
430             assertThat(awaitErrors(timeout, unit), emptyIterable());
431             assertTrue(commitCountDown.await(timeout, unit));
432             return new HashSet&lt;&gt;(successfulAcks);
433         }
434         public List&lt;Tuple&lt;DiscoveryNode, Throwable&gt;&gt; awaitErrors(long timeout, TimeUnit unit) throws InterruptedException {
435             countDown.await(timeout, unit);
436             return errors;
437         }
438     }
439 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
