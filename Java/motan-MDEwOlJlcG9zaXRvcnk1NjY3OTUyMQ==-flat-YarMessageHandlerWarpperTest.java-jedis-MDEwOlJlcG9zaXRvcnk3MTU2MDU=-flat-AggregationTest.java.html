
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 13.730569948186528%, Tokens: 10</h2>
        <div class="column">
            <h3>motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-YarMessageHandlerWarpperTest.java</h3>
            <pre><code>1  package com.weibo.api.motan.transport.netty4.yar;
2  import static org.junit.Assert.*;
3  import io.netty.buffer.ByteBuf;
4  import io.netty.buffer.PooledByteBufAllocator;
5  import io.netty.handler.codec.http.DefaultFullHttpRequest;
6  import io.netty.handler.codec.http.FullHttpRequest;
7  import io.netty.handler.codec.http.FullHttpResponse;
8  import io.netty.handler.codec.http.HttpMethod;
9  import io.netty.handler.codec.http.HttpResponseStatus;
10  import io.netty.handler.codec.http.HttpVersion;
11  import java.util.Map;
12  import org.junit.After;
13  import org.junit.Before;
14  import org.junit.Test;
15  import com.weibo.api.motan.protocol.yar.AttachmentRequest;
16  import com.weibo.api.motan.protocol.yar.YarMessageRouter;
17  import com.weibo.api.motan.protocol.yar.YarProtocolUtil;
18  import com.weibo.api.motan.rpc.DefaultResponse;
19  import com.weibo.api.motan.rpc.Request;
20  import com.weibo.api.motan.rpc.Response;
21  import com.weibo.api.motan.rpc.URL;
22  import com.weibo.api.motan.transport.Channel;
23  import com.weibo.api.motan.transport.MessageHandler;
24  import com.weibo.api.motan.transport.TransportException;
25  import com.weibo.api.motan.transport.netty4.http.Netty4HttpServer;
26  import com.weibo.yar.YarProtocol;
27  import com.weibo.yar.YarRequest;
28  import com.weibo.yar.YarResponse;
29  public class YarMessageHandlerWarpperTest {
30      public String uri = "/testpath?param1=a&param2=b&param3=c";
31      @Before
32      public void setUp() throws Exception {}
33      @After
34      public void tearDown() throws Exception {}
35      @Test
36      public void testHandle() throws Exception {
37          YarRequest yarRequest = new YarRequest(123, "JSON", "testmethod", new Object[] {"params", 456});
38          final YarResponse yarResponse = YarProtocolUtil.buildDefaultErrorResponse("test err", "JSON");
39          YarMessageHandlerWarpper handler = new YarMessageHandlerWarpper(new YarMessageRouter() {
40              @Override
41              public Object handle(Channel channel, Object message) {
42                  AttachmentRequest request = (AttachmentRequest) message;
43                  verifyAttachments(request.getAttachments());
44                  return yarResponse;
45              }
46          });
47          FullHttpResponse httpResponse = (FullHttpResponse) handler.handle(new MockChannel(), buildHttpRequest(yarRequest, uri));
48          assertNotNull(httpResponse);
<span onclick='openModal()' class='match'>49          assertNotNull(httpResponse.content());
50          YarResponse retYarResponse = getYarResponse(httpResponse);
51          assertNotNull(retYarResponse);
52          assertEquals(yarResponse, retYarResponse);
53      }
54      @Test
55      public void testAbnormal() throws Exception {
56          final String errmsg = "rpc process error";
</span>57          YarMessageHandlerWarpper handler = new YarMessageHandlerWarpper(new YarMessageRouter() {
58              @Override
59              public Object handle(Channel channel, Object message) {
60                  throw new RuntimeException(errmsg);
61              }
62          });
63          FullHttpResponse httpResponse = (FullHttpResponse) handler.handle(new MockChannel(), buildHttpRequest(null, uri));
64          assertNotNull(httpResponse);
65          assertEquals(HttpResponseStatus.OK, httpResponse.getStatus());
66          YarResponse retYarResponse = getYarResponse(httpResponse);
67          assertNotNull(retYarResponse);
68          assertNotNull(retYarResponse.getError());
69          YarRequest yarRequest = new YarRequest(123, "JSON", "testmethod", new Object[] {"params", 456});
70          httpResponse = (FullHttpResponse) handler.handle(new MockChannel(), buildHttpRequest(yarRequest, uri));
71          assertNotNull(httpResponse);
72          assertEquals(HttpResponseStatus.OK, httpResponse.getStatus());
73          retYarResponse = getYarResponse(httpResponse);
74          assertNotNull(retYarResponse);
75          assertEquals(errmsg, retYarResponse.getError());
76      }
77      private void verifyAttachments(Map<String, String> attachments) {
78          String[] params = uri.substring(uri.indexOf("?") + 1).split("&");
79          for (String param : params) {
80              String k = param.split("=")[0];
81              String v = param.split("=")[1];
82              assertTrue(attachments.containsKey(k));
83              assertEquals(v, attachments.get(k));
84          }
85      }
86      private YarResponse getYarResponse(FullHttpResponse httpResponse) throws Exception {
87          ByteBuf buf = httpResponse.content();
88          final byte[] contentBytes = new byte[buf.readableBytes()];
89          buf.getBytes(0, contentBytes);
90          YarResponse yarResponse = YarProtocol.buildResponse(contentBytes);
91          return yarResponse;
92      }
93      private FullHttpRequest buildHttpRequest(YarRequest yarRequest, String requestPath) throws Exception {
94          PooledByteBufAllocator allocator = new PooledByteBufAllocator();
95          ByteBuf buf = allocator.buffer(2048, 1024 * 1024);
96          if (yarRequest != null) {
97              buf.writeBytes(YarProtocol.toProtocolBytes(yarRequest));
98          }
99          FullHttpRequest httpReqeust = new DefaultFullHttpRequest(HttpVersion.HTTP_1_1, HttpMethod.POST, requestPath, buf);
100          return httpReqeust;
101      }
102      class MockChannel extends Netty4HttpServer {
103          public MockChannel() {
104              super(null, null);
105          }
106          public MockChannel(URL url, MessageHandler messageHandler) {
107              super(url, messageHandler);
108          }
109          @Override
110          public Response request(Request request) throws TransportException {
111              return new DefaultResponse();
112          }
113      }
114  }
</code></pre>
        </div>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-AggregationTest.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.search;
2  import static org.junit.Assert.assertEquals;
3  import static org.junit.Assert.assertNotNull;
4  import static org.junit.Assert.assertNull;
5  import static org.junit.Assert.assertThat;
6  import static org.junit.Assert.fail;
7  import org.hamcrest.Matchers;
8  import org.junit.BeforeClass;
9  import org.junit.Test;
10  import java.util.ArrayList;
11  import java.util.HashMap;
12  import java.util.LinkedHashMap;
13  import java.util.List;
14  import java.util.Map;
15  import redis.clients.jedis.exceptions.JedisDataException;
16  import redis.clients.jedis.search.Document;
17  import redis.clients.jedis.search.FieldName;
18  import redis.clients.jedis.search.IndexOptions;
19  import redis.clients.jedis.search.Schema;
20  import redis.clients.jedis.search.aggr.AggregationBuilder;
21  import redis.clients.jedis.search.aggr.AggregationResult;
22  import redis.clients.jedis.search.aggr.Reducers;
23  import redis.clients.jedis.search.aggr.Row;
24  import redis.clients.jedis.search.aggr.SortedField;
25  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
26  import redis.clients.jedis.search.aggr.FtAggregateIteration;
27  import redis.clients.jedis.search.schemafields.NumericField;
28  import redis.clients.jedis.search.schemafields.TextField;
29  public class AggregationTest extends RedisModuleCommandsTestBase {
30    private static final String index = "aggbindex";
31    @BeforeClass
32    public static void prepare() {
33      RedisModuleCommandsTestBase.prepare();
34    }
35    private void addDocument(Document doc) {
36      String key = doc.getId();
37      Map<String, String> map = new LinkedHashMap<>();
38      doc.getProperties().forEach(entry -> map.put(entry.getKey(), String.valueOf(entry.getValue())));
39      client.hset(key, map);
40    }
41    private void addDocument(String key, Map<String, Object> objMap) {
42      Map<String, String> strMap = new HashMap<>();
43      objMap.entrySet().forEach(entry -> strMap.put(entry.getKey(), String.valueOf(entry.getValue())));
44      client.hset(key, strMap);
45    }
46    @Test
47    public void testAggregations() {
48      Schema sc = new Schema();
49      sc.addSortableTextField("name", 1.0);
50      sc.addSortableNumericField("count");
51      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
52      addDocument(new Document("data1").set("name", "abc").set("count", 10));
53      addDocument(new Document("data2").set("name", "def").set("count", 5));
54      addDocument(new Document("data3").set("name", "def").set("count", 25));
55      AggregationBuilder r = new AggregationBuilder()
56          .groupBy("@name", Reducers.sum("@count").as("sum"))
57          .sortBy(10, SortedField.desc("@sum"));
58      AggregationResult res = client.ftAggregate(index, r);
59      assertEquals(2, res.getTotalResults());
60      Row r1 = res.getRow(0);
61      assertNotNull(r1);
62      assertEquals("def", r1.getString("name"));
63      assertEquals(30, r1.getLong("sum"));
64      assertEquals(30., r1.getDouble("sum"), 0);
65      assertEquals(0L, r1.getLong("nosuchcol"));
66      assertEquals(0.0, r1.getDouble("nosuchcol"), 0);
67      assertEquals("", r1.getString("nosuchcol"));
68      Row r2 = res.getRow(1);
69      assertNotNull(r2);
70      assertEquals("abc", r2.getString("name"));
71      assertEquals(10, r2.getLong("sum"));
72    }
73    @Test
74    public void testAggregations2() {
75      Schema sc = new Schema();
76      sc.addSortableTextField("name", 1.0);
77      sc.addSortableNumericField("count");
78      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
79      addDocument(new Document("data1").set("name", "abc").set("count", 10));
80      addDocument(new Document("data2").set("name", "def").set("count", 5));
81      addDocument(new Document("data3").set("name", "def").set("count", 25));
82      AggregationBuilder r = new AggregationBuilder()
83          .groupBy("@name", Reducers.sum("@count").as("sum"))
84          .sortBy(10, SortedField.desc("@sum"));
85      AggregationResult res = client.ftAggregate(index, r);
86      assertEquals(2, res.getTotalResults());
87      List<Row> rows = res.getRows();
88      assertEquals("def", rows.get(0).get("name"));
89      assertEquals("30", rows.get(0).get("sum"));
90      assertNull(rows.get(0).get("nosuchcol"));
91      assertEquals("abc", rows.get(1).get("name"));
92      assertEquals("10", rows.get(1).get("sum"));
93    }
94    @Test
95    public void testAggregationBuilderVerbatim() {
96      Schema sc = new Schema();
97      sc.addSortableTextField("name", 1.0);
98      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
99      addDocument(new Document("data1").set("name", "hello kitty"));
100      AggregationBuilder r = new AggregationBuilder("kitti");
101      AggregationResult res = client.ftAggregate(index, r);
102      assertEquals(1, res.getTotalResults());
103      r = new AggregationBuilder("kitti")
104              .verbatim();
105      res = client.ftAggregate(index, r);
106      assertEquals(0, res.getTotalResults());
107    }
108    @Test
109    public void testAggregationBuilderTimeout() {
110      Schema sc = new Schema();
111      sc.addSortableTextField("name", 1.0);
112      sc.addSortableNumericField("count");
113      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
114      addDocument(new Document("data1").set("name", "abc").set("count", 10));
115      addDocument(new Document("data2").set("name", "def").set("count", 5));
116      addDocument(new Document("data3").set("name", "def").set("count", 25));
117      AggregationBuilder r = new AggregationBuilder()
<span onclick='openModal()' class='match'>118              .groupBy("@name", Reducers.sum("@count").as("sum"))
119              .timeout(5000);
120      AggregationResult res = client.ftAggregate(index, r);
121      assertEquals(2, res.getTotalResults());
122    }
123    @Test
124    public void testAggregationBuilderParamsDialect() {
125      Schema sc = new Schema();
</span>126      sc.addSortableTextField("name", 1.0);
127      sc.addSortableNumericField("count");
128      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
129      addDocument(new Document("data1").set("name", "abc").set("count", 10));
130      addDocument(new Document("data2").set("name", "def").set("count", 5));
131      addDocument(new Document("data3").set("name", "def").set("count", 25));
132      Map<String, Object> params = new HashMap<>();
133      params.put("name", "abc");
134      AggregationBuilder r = new AggregationBuilder("$name")
135              .groupBy("@name", Reducers.sum("@count").as("sum"))
136              .params(params)
137              .dialect(2); 
138      AggregationResult res = client.ftAggregate(index, r);
139      assertEquals(1, res.getTotalResults());
140      Row r1 = res.getRow(0);
141      assertNotNull(r1);
142      assertEquals("abc", r1.getString("name"));
143      assertEquals(10, r1.getLong("sum"));
144    }
145    @Test
146    public void testApplyAndFilterAggregations() {
147      Schema sc = new Schema();
148      sc.addSortableTextField("name", 1.0);
149      sc.addSortableNumericField("subj1");
150      sc.addSortableNumericField("subj2");
151      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
152      addDocument(new Document("data1").set("name", "abc").set("subj1", 20).set("subj2", 70));
153      addDocument(new Document("data2").set("name", "def").set("subj1", 60).set("subj2", 40));
154      addDocument(new Document("data3").set("name", "ghi").set("subj1", 50).set("subj2", 80));
155      addDocument(new Document("data4").set("name", "abc").set("subj1", 30).set("subj2", 20));
156      addDocument(new Document("data5").set("name", "def").set("subj1", 65).set("subj2", 45));
157      addDocument(new Document("data6").set("name", "ghi").set("subj1", 70).set("subj2", 70));
158      AggregationBuilder r = new AggregationBuilder().apply("(@subj1+@subj2)/2", "attemptavg")
159          .groupBy("@name", Reducers.avg("@attemptavg").as("avgscore"))
160          .filter("@avgscore>=50")
161          .sortBy(10, SortedField.asc("@name"));
162      AggregationResult res = client.ftAggregate(index, r);
163      assertEquals(3, res.getTotalResults());
164      Row r1 = res.getRow(0);
165      assertNotNull(r1);
166      assertEquals("def", r1.getString("name"));
167      assertEquals(52.5, r1.getDouble("avgscore"), 0);
168      Row r2 = res.getRow(1);
169      assertNotNull(r2);
170      assertEquals("ghi", r2.getString("name"));
171      assertEquals(67.5, r2.getDouble("avgscore"), 0);
172    }
173    @Test
174    public void load() {
175      Schema sc = new Schema();
176      sc.addSortableTextField("name", 1.0);
177      sc.addSortableNumericField("subj1");
178      sc.addSortableNumericField("subj2");
179      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
180      addDocument(new Document("data1").set("name", "abc").set("subj1", 20).set("subj2", 70));
181      addDocument(new Document("data2").set("name", "def").set("subj1", 60).set("subj2", 40));
182      AggregationBuilder builder = new AggregationBuilder()
183          .load(FieldName.of("@subj1").as("a"), FieldName.of("@subj2").as("b"))
184          .apply("(@a+@b)/2", "avg").sortByDesc("@avg");
185      AggregationResult result = client.ftAggregate(index, builder);
186      assertEquals(50.0, result.getRow(0).getDouble("avg"), 0d);
187      assertEquals(45.0, result.getRow(1).getDouble("avg"), 0d);
188    }
189    @Test
190    public void loadAll() {
191      Schema sc = new Schema();
192      sc.addSortableTextField("name", 1.0);
193      sc.addSortableNumericField("subj1");
194      sc.addSortableNumericField("subj2");
195      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
196      addDocument(new Document("data1").set("name", "abc").set("subj1", 20).set("subj2", 70));
197      addDocument(new Document("data2").set("name", "def").set("subj1", 60).set("subj2", 40));
198      AggregationBuilder builder = new AggregationBuilder()
199          .loadAll()
200          .apply("(@subj1+@subj2)/2", "avg").sortByDesc("@avg");
201      AggregationResult result = client.ftAggregate(index, builder);
202      assertEquals(50.0, result.getRow(0).getDouble("avg"), 0d);
203      assertEquals(45.0, result.getRow(1).getDouble("avg"), 0d);
204    }
205    @Test
206    public void cursor() {
207      Schema sc = new Schema();
208      sc.addSortableTextField("name", 1.0);
209      sc.addSortableNumericField("count");
210      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
211      addDocument(new Document("data1").set("name", "abc").set("count", 10));
212      addDocument(new Document("data2").set("name", "def").set("count", 5));
213      addDocument(new Document("data3").set("name", "def").set("count", 25));
214      AggregationBuilder r = new AggregationBuilder()
215          .groupBy("@name", Reducers.sum("@count").as("sum"))
216          .sortBy(10, SortedField.desc("@sum"))
217          .cursor(1, 3000);
218      AggregationResult res = client.ftAggregate(index, r);
219      assertEquals(2, res.getTotalResults());
220      Row row = res.getRow(0);
221      assertNotNull(row);
222      assertEquals("def", row.getString("name"));
223      assertEquals(30, row.getLong("sum"));
224      assertEquals(30., row.getDouble("sum"), 0);
225      assertEquals(0L, row.getLong("nosuchcol"));
226      assertEquals(0.0, row.getDouble("nosuchcol"), 0);
227      assertEquals("", row.getString("nosuchcol"));
228      res = client.ftCursorRead(index, res.getCursorId(), 1);
229      Row row2 = res.getRow(0);
230      assertNotNull(row2);
231      assertEquals("abc", row2.getString("name"));
232      assertEquals(10, row2.getLong("sum"));
233      assertEquals("OK", client.ftCursorDel(index, res.getCursorId()));
234      try {
235        client.ftCursorRead(index, res.getCursorId(), 1);
236        fail();
237      } catch (JedisDataException e) {
238      }
239    }
240    @Test
241    public void aggregateIteration() {
242      client.ftCreate(index, TextField.of("name").sortable(), NumericField.of("count"));
243      addDocument(new Document("data1").set("name", "abc").set("count", 10));
244      addDocument(new Document("data2").set("name", "def").set("count", 5));
245      addDocument(new Document("data3").set("name", "def").set("count", 25));
246      addDocument(new Document("data4").set("name", "ghi").set("count", 15));
247      addDocument(new Document("data5").set("name", "jkl").set("count", 20));
248      AggregationBuilder agg = new AggregationBuilder()
249          .groupBy("@name", Reducers.sum("@count").as("sum"))
250          .sortBy(10, SortedField.desc("@sum"))
251          .cursor(2, 10000);
252      FtAggregateIteration rr = client.ftAggregateIteration(index, agg);
253      int total = 0;
254      while (!rr.isIterationCompleted()) {
255        AggregationResult res = rr.nextBatch();
256        int count = res.getRows().size();
257        assertThat(count, Matchers.lessThanOrEqualTo(2));
258        total += count;
259      }
260      assertEquals(4, total);
261    }
262    @Test
263    public void aggregateIterationCollect() {
264      client.ftCreate(index, TextField.of("name").sortable(), NumericField.of("count"));
265      addDocument(new Document("data1").set("name", "abc").set("count", 10));
266      addDocument(new Document("data2").set("name", "def").set("count", 5));
267      addDocument(new Document("data3").set("name", "def").set("count", 25));
268      addDocument(new Document("data4").set("name", "ghi").set("count", 15));
269      addDocument(new Document("data5").set("name", "jkl").set("count", 20));
270      AggregationBuilder agg = new AggregationBuilder()
271          .groupBy("@name", Reducers.sum("@count").as("sum"))
272          .sortBy(10, SortedField.desc("@sum"))
273          .cursor(2, 10000);
274      assertEquals(4, client.ftAggregateIteration(index, agg).collect(new ArrayList<>()).size());
275    }
276    @Test
277    public void testWrongAggregation() throws InterruptedException {
278      Schema sc = new Schema()
279          .addTextField("title", 5.0)
280          .addTextField("body", 1.0)
281          .addTextField("state", 1.0)
282          .addNumericField("price");
283      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
284      Map<String, Object> fields = new HashMap<>();
285      fields.put("title", "hello world");
286      fields.put("state", "NY");
287      fields.put("body", "lorem ipsum");
288      fields.put("price", "1337");
289      addDocument("doc1", fields);
290      AggregationBuilder builder = new AggregationBuilder("hello")
291          .apply("@price/1000", "k")
292          .groupBy("@state", Reducers.avg("@k").as("avgprice"))
293          .filter("@avgprice>=2")
294          .sortBy(10, SortedField.asc("@state"));
295      try {
296        client.ftAggregate(index, builder);
297        fail();
298      } catch (JedisDataException e) {
299      }
300    }
301  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-YarMessageHandlerWarpperTest.java</div>
                <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-AggregationTest.java</div>
                <div class="column column_space"><pre><code>49          assertNotNull(httpResponse.content());
50          YarResponse retYarResponse = getYarResponse(httpResponse);
51          assertNotNull(retYarResponse);
52          assertEquals(yarResponse, retYarResponse);
53      }
54      @Test
55      public void testAbnormal() throws Exception {
56          final String errmsg = "rpc process error";
</pre></code></div>
                <div class="column column_space"><pre><code>118              .groupBy("@name", Reducers.sum("@count").as("sum"))
119              .timeout(5000);
120      AggregationResult res = client.ftAggregate(index, r);
121      assertEquals(2, res.getTotalResults());
122    }
123    @Test
124    public void testAggregationBuilderParamsDialect() {
125      Schema sc = new Schema();
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    