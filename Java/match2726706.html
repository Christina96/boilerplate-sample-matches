<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for SwapAndDropIndexExecutor.java & JavascriptUserDefinedFunctionTest.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for SwapAndDropIndexExecutor.java & JavascriptUserDefinedFunctionTest.java
      </h3>
      <h1 align="center">
        8.3%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>SwapAndDropIndexExecutor.java (26.470589%)<TH>JavascriptUserDefinedFunctionTest.java (4.9315066%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match2726706-0.html#0',2,'match2726706-1.html#0',3)" NAME="0">(67-75)<TD><A HREF="javascript:ZweiFrames('match2726706-0.html#0',2,'match2726706-1.html#0',3)" NAME="0">(159-164)</A><TD ALIGN=center><FONT COLOR="#ff0000">9</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match2726706-0.html#1',2,'match2726706-1.html#1',3)" NAME="1">(24-34)<TD><A HREF="javascript:ZweiFrames('match2726706-0.html#1',2,'match2726706-1.html#1',3)" NAME="1">(49-59)</A><TD ALIGN=center><FONT COLOR="#ff0000">9</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>SwapAndDropIndexExecutor.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial agreement.
 */
<A NAME="1"></A>
package io.crate.metadata.cluster;

<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match2726706-1.html#1',3,'match2726706-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>import io.crate.execution.ddl.index.SwapAndDropIndexRequest;
import org.elasticsearch.cluster.ClusterState;
import org.elasticsearch.cluster.block.ClusterBlocks;
import org.elasticsearch.cluster.metadata.IndexMetadata;
import org.elasticsearch.cluster.metadata.Metadata;
import org.elasticsearch.cluster.routing.RoutingTable;
import org.elasticsearch.cluster.routing.allocation.AllocationService;

public class SwapAndDropIndexExecutor extends DDLClusterStateTaskExecutor&lt;SwapAndDropIndexRequest&gt; {

    private final AllocationService allocationService</B></FONT>;

    public SwapAndDropIndexExecutor(AllocationService allocationService) {
        this.allocationService = allocationService;
    }

    @Override
    public ClusterState execute(ClusterState currentState, SwapAndDropIndexRequest request) throws Exception {
        final Metadata metadata = currentState.getMetadata();
        final ClusterBlocks.Builder blocksBuilder = ClusterBlocks.builder().blocks(currentState.blocks());
        final Metadata.Builder mdBuilder = Metadata.builder(metadata);
        final RoutingTable.Builder routingBuilder = RoutingTable.builder(currentState.routingTable());

        String sourceIndexName = request.source();
        String targetIndexName = request.target();

        mdBuilder.remove(sourceIndexName);
        mdBuilder.remove(targetIndexName);
        routingBuilder.remove(sourceIndexName);
        routingBuilder.remove(targetIndexName);
        blocksBuilder.removeIndexBlocks(sourceIndexName);
        blocksBuilder.removeIndexBlocks(targetIndexName);

        IndexMetadata sourceIndex = metadata.index(sourceIndexName);
        if (sourceIndex == null) {
            throw new IllegalArgumentException(&quot;Source index must exist: &quot; + sourceIndexName);
        }

        IndexMetadata newIndexMetadata = IndexMetadata.builder(sourceIndex).index(targetIndexName).build();
        mdBuilder.put(newIndexMetadata, true);
<A NAME="0"></A>        routingBuilder.addAsFromCloseToOpen(newIndexMetadata);
        blocksBuilder.addBlocks(newIndexMetadata);

        return <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match2726706-1.html#0',3,'match2726706-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>allocationService.reroute(
            ClusterState.builder(currentState)
                .metadata(mdBuilder)
                .routingTable(routingBuilder.build())
                .blocks(blocksBuilder)
                .build(),
            &quot;swap and drop index&quot;
        );
    }</B></FONT>
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>JavascriptUserDefinedFunctionTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial agreement.
 */

package io.crate.operation.language;

import io.crate.analyze.FunctionArgumentDefinition;
import io.crate.expression.scalar.ScalarTestCase;
import io.crate.expression.symbol.Literal;
import io.crate.expression.udf.UserDefinedFunctionMetadata;
import io.crate.expression.udf.UserDefinedFunctionService;
import io.crate.metadata.FunctionProvider;
import io.crate.metadata.FunctionName;
import io.crate.metadata.Schemas;
import io.crate.types.DataType;
import io.crate.types.DataTypes;
import org.elasticsearch.cluster.service.ClusterService;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.locationtech.spatial4j.context.jts.JtsSpatialContext;
import org.locationtech.spatial4j.shape.impl.PointImpl;

import javax.script.ScriptException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
<A NAME="1"></A>import java.util.Map;
import java.util.stream.Collectors;

<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match2726706-0.html#1',2,'match2726706-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>import static io.crate.testing.SymbolMatchers.isLiteral;
import static org.hamcrest.Matchers.containsString;
import static org.hamcrest.Matchers.endsWith;
import static org.hamcrest.Matchers.is;
import static org.hamcrest.Matchers.nullValue;
import static org.hamcrest.Matchers.startsWith;
import static org.mockito.Mockito.mock;

public class JavascriptUserDefinedFunctionTest extends ScalarTestCase {

    private static final String JS = JavaScriptLanguage.NAME</B></FONT>;

    private final Map&lt;FunctionName, List&lt;FunctionProvider&gt;&gt; functionImplementations = new HashMap&lt;&gt;();
    private UserDefinedFunctionService udfService;

    @Override
    @Before
    public void setUp() throws Exception {
        super.setUp();
        udfService = new UserDefinedFunctionService(
            mock(ClusterService.class),
            sqlExpressions.nodeCtx);
        udfService.registerLanguage(new JavaScriptLanguage(udfService));
    }

    private void registerUserDefinedFunction(String name,
                                             DataType&lt;?&gt; returnType,
                                             List&lt;DataType&lt;?&gt;&gt; types,
                                             String definition) throws ScriptException {
        UserDefinedFunctionMetadata udf = new UserDefinedFunctionMetadata(
            Schemas.DOC_SCHEMA_NAME,
            name,
            types.stream().map(FunctionArgumentDefinition::of).collect(Collectors.toList()),
            returnType,
            JS,
            definition);

        String validation = udfService.getLanguage(JS).validate(udf);
        if (validation == null) {
            var functionName = new FunctionName(Schemas.DOC_SCHEMA_NAME, udf.name());
            var resolvers = functionImplementations.computeIfAbsent(
                functionName, k -&gt; new ArrayList&lt;&gt;());
            resolvers.add(udfService.buildFunctionResolver(udf));
            sqlExpressions.nodeCtx.functions().registerUdfFunctionImplementationsForSchema(
                Schemas.DOC_SCHEMA_NAME,
                functionImplementations);
        } else {
            throw new ScriptException(validation);
        }
    }

    @After
    public void afterTest() {
        functionImplementations.clear();
    }

    @Test
    public void testObjectReturnType() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.UNTYPED_OBJECT,
            List.of(),
            &quot;function f() { return JSON.parse('{\&quot;foo\&quot;: \&quot;bar\&quot;}'); }&quot;);
        assertEvaluate(&quot;f()&quot;, Map.of(&quot;foo&quot;, &quot;bar&quot;));
    }

    @Test
    public void testValidateCatchesScriptException() {
        var udfMeta = new UserDefinedFunctionMetadata(
            Schemas.DOC_SCHEMA_NAME,
            &quot;f&quot;,
            Collections.singletonList(FunctionArgumentDefinition.of(DataTypes.DOUBLE)),
            DataTypes.DOUBLE_ARRAY,
            JS,
            &quot;function f(a) { return a[0]1*#?; }&quot;);

        assertThat(
            udfService.getLanguage(JS).validate(udfMeta),
            containsString(
                &quot;Invalid JavaScript in function 'doc.f(double precision)' AS 'function f(a) &quot; +
                &quot;{ return a[0]1*#?; }': SyntaxError: f:1:27 Expected ; but found 1&quot;));
    }

    @Test
    public void testValidateCatchesAssertionError() {
        var udfMeta = new UserDefinedFunctionMetadata(
            Schemas.DOC_SCHEMA_NAME,
            &quot;f&quot;,
            Collections.singletonList(FunctionArgumentDefinition.of(DataTypes.DOUBLE)),
            DataTypes.DOUBLE_ARRAY,
            JS,
            &quot;var f = (a) =&gt; a * a;&quot;);

        String validation = udfService.getLanguage(JS).validate(udfMeta);
        String javaVersion = System.getProperty(&quot;java.specification.version&quot;);
        try {
            if (Integer.parseInt(javaVersion) &gt;= 9) {
                assertThat(validation, is(nullValue()));
            }
        } catch (NumberFormatException e) {
            assertThat(validation, startsWith(&quot;Invalid JavaScript in function 'doc.f(double)'&quot;));
            assertThat(validation, endsWith(&quot;Failed generating bytecode for &lt;eval&gt;:1&quot;));
        }
    }

    @Test
    public void testValidJavascript() {
<A NAME="0"></A>        var udfMeta = new UserDefinedFunctionMetadata(
            Schemas.DOC_SCHEMA_NAME,
            &quot;f&quot;,
            <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match2726706-0.html#0',2,'match2726706-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>Collections.singletonList(FunctionArgumentDefinition.of(DataTypes.DOUBLE_ARRAY)),
            DataTypes.DOUBLE,
            JS,
            &quot;function f(a) { return a[0]; }&quot;);
        assertThat(udfService.getLanguage(JS).validate(udfMeta), is(nullValue()));
    }</B></FONT>

    @Test
    public void testArrayReturnType() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.DOUBLE_ARRAY,
            List.of(),
            &quot;function f() { return [1, 2]; }&quot;);
        assertEvaluate(&quot;f()&quot;, List.of(1.0, 2.0));
    }

    @Test
    public void testTimestampReturnType() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.TIMESTAMPZ,
            List.of(),
            &quot;function f() { return \&quot;1990-01-01T00:00:00\&quot;; }&quot;);
        assertEvaluate(&quot;f()&quot;, 631152000000L);
    }

    @Test
    public void testIpReturnType() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.IP,
            List.of(),
            &quot;function f() { return \&quot;127.0.0.1\&quot;; }&quot;);
        assertEvaluate(&quot;f()&quot;, DataTypes.IP.sanitizeValue(&quot;127.0.0.1&quot;));
    }

    @Test
    public void testPrimitiveReturnType() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.INTEGER,
            List.of(),
            &quot;function f() { return 10; }&quot;);
        assertEvaluate(&quot;f()&quot;, 10);
    }

    @Test
    public void testObjectReturnTypeAndInputArguments() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.FLOAT,
            List.of(DataTypes.DOUBLE, DataTypes.SHORT),
            &quot;function f(x, y) { return x + y; }&quot;);
        assertEvaluate(&quot;f(double_val, short_val)&quot;, 3.0f, Literal.of(1), Literal.of(2));
    }

    @Test
    public void testPrimitiveReturnTypeAndInputArguments() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.FLOAT,
            List.of(DataTypes.DOUBLE, DataTypes.SHORT),
            &quot;function f(x, y) { return x + y; }&quot;);
        assertEvaluate(&quot;f(double_val, short_val)&quot;, 3.0f, Literal.of(1), Literal.of(2));
    }

    @Test
    public void testGeoTypeReturnTypeWithDoubleArray() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.GEO_POINT,
            List.of(),
            &quot;function f() { return [1, 1]; }&quot;);
        assertEvaluate(&quot;f()&quot;, new PointImpl(1.0, 1.0, JtsSpatialContext.GEO));
    }

    @Test
    public void testGeoTypeReturnTypeWithWKT() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.GEO_POINT,
            List.of(),
            &quot;function f() { return \&quot;POINT (1.0 2.0)\&quot;; }&quot;);
        assertEvaluate(&quot;f()&quot;, new PointImpl(1.0, 2.0, JtsSpatialContext.GEO));
    }

    @Test
    public void testOverloadingUserDefinedFunctions() throws Exception {
        registerUserDefinedFunction(&quot;f&quot;, DataTypes.LONG, List.of(), &quot;function f() { return 1; }&quot;);
        registerUserDefinedFunction(&quot;f&quot;, DataTypes.LONG, List.of(DataTypes.LONG), &quot;function f(x) { return x; }&quot;);
        registerUserDefinedFunction(&quot;f&quot;, DataTypes.LONG, List.of(DataTypes.LONG, DataTypes.INTEGER),
            &quot;function f(x, y) { return x + y; }&quot;);
        assertEvaluate(&quot;f()&quot;, 1L);
        assertEvaluate(&quot;f(x)&quot;, 2L, Literal.of(2));
        assertEvaluate(&quot;f(x, a)&quot;, 3L, Literal.of(2), Literal.of(1));
    }

    @Test
    public void testFunctionWrongNameInFunctionBody() {
        var udfMeta = new UserDefinedFunctionMetadata(
            Schemas.DOC_SCHEMA_NAME,
            &quot;f&quot;,
            Collections.singletonList(FunctionArgumentDefinition.of(DataTypes.DOUBLE)),
            DataTypes.DOUBLE_ARRAY,
            JS,
            &quot;function test() { return 1; }&quot;);

        assertThat(
            udfService.getLanguage(JS).validate(udfMeta),
            containsString(
                &quot;The name of the function signature 'f' doesn't &quot; +
                &quot;match the function name in the function definition&quot;));
    }

    @Test
    public void testNormalizeOnObjectInput() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.UNTYPED_OBJECT,
            List.of(DataTypes.UNTYPED_OBJECT),
            &quot;function f(x) { return x; }&quot;);
        assertNormalize(&quot;f({})&quot;, isLiteral(Map.of()));
    }

    @Test
    public void testNormalizeOnArrayInput() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.LONG,
            List.of(DataTypes.DOUBLE_ARRAY),
            &quot;function f(x) { return x[1]; }&quot;);
        assertNormalize(&quot;f([1.0, 2.0])&quot;, isLiteral(2L));
    }

    @Test
    public void testNormalizeOnStringInputs() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.STRING,
            List.of(DataTypes.STRING),
            &quot;function f(x) { return x; }&quot;);
        assertNormalize(&quot;f('bar')&quot;, isLiteral(&quot;bar&quot;));
    }

    @Test
    public void testAccessJavaClasses() throws Exception {
        expectedException.expect(io.crate.exceptions.ScriptException.class);
        expectedException.expectMessage(containsString(&quot;Java is not defined&quot;));
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.LONG,
            List.of(DataTypes.LONG),
            &quot;function f(x) { var File = Java.type(\&quot;java.io.File\&quot;); return x; }&quot;);
        assertEvaluate(&quot;f(x)&quot;, 1L, Literal.of(1L));
    }

    @Test
    public void testEvaluateBytesRefConvertedToString() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.STRING,
            List.of(DataTypes.STRING),
            &quot;function f(name) { return 'foo' + name; }&quot;);
        assertEvaluate(&quot;f(name)&quot;, &quot;foobar&quot;, Literal.of(&quot;bar&quot;));
    }

    @Test
    public void testJavaScriptFunctionReturnsUndefined() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.STRING,
            List.of(DataTypes.STRING),
            &quot;function f(name) { }&quot;);
        assertEvaluate(&quot;f(name)&quot;, null, Literal.of(&quot;bar&quot;));
    }

    @Test
    public void testJavaScriptFunctionReturnsNull() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.STRING,
            List.of(),
            &quot;function f() { return null; }&quot;);
        assertEvaluate(&quot;f()&quot;, null);
    }

    @Test
    public void testStringArrayTypeArgument() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.STRING,
            List.of(DataTypes.STRING_ARRAY),
            &quot;function f(a) { return a.join('.'); }&quot;);
        assertEvaluate(&quot;f(['a', 'b'])&quot;, is(&quot;a.b&quot;));
        assertEvaluate(&quot;f(['a', 'b'])&quot;, is(&quot;a.b&quot;), Literal.of(List.of(&quot;a&quot;, &quot;b&quot;), DataTypes.STRING_ARRAY));
    }

    @Test
    public void test_access_object_type_argument_properties_in_function_body() throws Exception {
        registerUserDefinedFunction(
            &quot;f_dot&quot;,
            DataTypes.INTEGER,
            List.of(DataTypes.UNTYPED_OBJECT),
            &quot;function f_dot(a) { return a.y; }&quot;);
        assertEvaluate(&quot;f_dot('{\&quot;x\&quot;:1,\&quot;y\&quot;:2}')&quot;, is(2));

        registerUserDefinedFunction(
            &quot;f_brackets&quot;,
            DataTypes.INTEGER,
            List.of(DataTypes.UNTYPED_OBJECT),
            &quot;function f_brackets(a) { return a[\&quot;x\&quot;]; }&quot;);
        assertEvaluate(&quot;f_brackets('{\&quot;x\&quot;:1,\&quot;y\&quot;:2}')&quot;, is(1));
    }

    @Test
    public void test_access_geo_shape_type_argument_properties_in_function_body() throws Exception {
        registerUserDefinedFunction(
            &quot;f&quot;,
            DataTypes.STRING,
            List.of(DataTypes.GEO_SHAPE),
            &quot;function f(a) { return a.type; }&quot;);
        assertEvaluate(&quot;f('POINT(1 2)')&quot;, is(&quot;Point&quot;));
    }
}
</PRE>
</div>
  </div>
</body>
</html>
