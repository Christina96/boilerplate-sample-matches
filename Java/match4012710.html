<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for FulltextIntegrationTest.java & BlobIndicesService.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for FulltextIntegrationTest.java & BlobIndicesService.java
      </h3>
      <h1 align="center">
        4.2%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>FulltextIntegrationTest.java (6.081081%)<TH>BlobIndicesService.java (3.2608695%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match4012710-0.html#0',2,'match4012710-1.html#0',3)" NAME="0">(22-33)<TD><A HREF="javascript:ZweiFrames('match4012710-0.html#0',2,'match4012710-1.html#0',3)" NAME="0">(22-33)</A><TD ALIGN=center><FONT COLOR="#ff0000">9</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>FulltextIntegrationTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<A NAME="0"></A> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match4012710-1.html#0',3,'match4012710-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>package io.crate.integrationtests;

import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
import static io.crate.testing.Asserts.assertThrowsMatches;
import static io.crate.testing.SQLErrorMatcher.isSQLError;
import static io.netty.handler.codec.http.HttpResponseStatus.BAD_REQUEST;
import static org.hamcrest.Matchers.greaterThanOrEqualTo;
import static org.hamcrest.Matchers.is;

import org.junit.Test;

import</B></FONT> io.crate.testing.TestingHelpers;

public class FulltextIntegrationTest extends SQLIntegrationTestCase  {

    @Test
    public void testSelectMatch() throws Exception {
        execute(&quot;create table quotes (quote string)&quot;);

        execute(&quot;insert into quotes values (?)&quot;, new Object[]{&quot;don't panic&quot;});
        refresh();

        execute(&quot;select quote from quotes where match(quote, ?)&quot;, new Object[]{&quot;don't panic&quot;});
        assertEquals(1L, response.rowCount());
        assertEquals(&quot;don't panic&quot;, response.rows()[0][0]);
    }

    @Test
    public void testSelectNotMatch() throws Exception {
        execute(&quot;create table quotes (quote string) with (number_of_replicas = 0)&quot;);

        execute(&quot;insert into quotes values (?), (?)&quot;, new Object[]{&quot;don't panic&quot;, &quot;hello&quot;});
        refresh();

        execute(&quot;select quote from quotes where not match(quote, ?)&quot;,
            new Object[]{&quot;don't panic&quot;});
        assertEquals(1L, response.rowCount());
        assertEquals(&quot;hello&quot;, response.rows()[0][0]);
    }

    @Test
    public void testMatchUnsupportedInSelect() {
        execute(&quot;create table quotes (quote string)&quot;);
        assertThrowsMatches(() -&gt; execute(&quot;select match(quote, 'the quote') from quotes&quot;),
                     isSQLError(is(&quot;match predicate cannot be selected&quot;),
                                INTERNAL_ERROR, BAD_REQUEST, 4004));
    }

    @Test
    public void testSelectOrderByScore() throws Exception {
        execute(&quot;create table quotes (quote string index off,&quot; +
                &quot;index quote_ft using fulltext(quote)) clustered into 1 shards&quot;);
        execute(&quot;insert into quotes values (?)&quot;,
            new Object[]{&quot;Would it save you a lot of time if I just gave up and went mad now?&quot;}
        );
        execute(&quot;insert into quotes values (?)&quot;,
            new Object[]{&quot;Time is an illusion. Lunchtime doubly so&quot;}
        );
        refresh();

        execute(&quot;select * from quotes&quot;);
        execute(&quot;select quote, \&quot;_score\&quot; from quotes where match(quote_ft, ?) &quot; +
                &quot;order by \&quot;_score\&quot; desc&quot;,
            new Object[]{&quot;time&quot;}
        );
        assertEquals(2L, response.rowCount());
        assertEquals(&quot;Time is an illusion. Lunchtime doubly so&quot;, response.rows()[0][0]);
    }

    @Test
    public void testSelectScoreMatchAll() throws Exception {
        execute(&quot;create table quotes (quote string) with (number_of_replicas = 0)&quot;);

        execute(&quot;insert into quotes values (?), (?)&quot;,
            new Object[]{&quot;Would it save you a lot of time if I just gave up and went mad now?&quot;,
                &quot;Time is an illusion. Lunchtime doubly so&quot;}
        );
        execute(&quot;refresh table quotes&quot;);

        execute(&quot;select quote, \&quot;_score\&quot; from quotes&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(1.0f, response.rows()[0][1]);
        assertEquals(1.0f, response.rows()[1][1]);
    }

    @Test
    public void testSelectWhereScore() throws Exception {
        execute(&quot;create table quotes (quote string, &quot; +
                &quot;index quote_ft using fulltext(quote)) clustered into 1 shards with (number_of_replicas = 0)&quot;);

        execute(&quot;insert into quotes values (?), (?)&quot;,
            new Object[]{&quot;Would it save you a lot of time if I just gave up and went mad now?&quot;,
                &quot;Time is an illusion. Lunchtime doubly so. Take your time.&quot;}
        );
        refresh();

        execute(&quot;select quote, \&quot;_score\&quot; from quotes where match(quote_ft, 'time') &quot; +
                &quot;and \&quot;_score\&quot; &gt;= 1.12&quot;);
        assertEquals(1L, response.rowCount());
        assertThat((Float) response.rows()[0][1], greaterThanOrEqualTo(1.12f));

        execute(&quot;select quote, \&quot;_score\&quot; from quotes where match(quote_ft, 'time') &quot; +
                &quot;and \&quot;_score\&quot; &gt;= 1.12 order by quote&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(false, Float.isNaN((Float) response.rows()[0][1]));
        assertThat((Float) response.rows()[0][1], greaterThanOrEqualTo(1.12f));
    }

    @Test
    public void testCopyValuesFromStringArrayToIndex() throws Exception {
        execute(&quot;CREATE TABLE t_string_array (&quot; +
                &quot;  id INTEGER PRIMARY KEY,&quot; +
                &quot;  keywords ARRAY(STRING) INDEX USING FULLTEXT,&quot; +
                &quot;  INDEX keywords_ft USING FULLTEXT(keywords)&quot; +
                &quot;)&quot;);

        execute(&quot;INSERT INTO t_string_array (id, keywords) VALUES (1, ['foo bar'])&quot;);
        refresh();
        // matching a term must work
        execute(&quot;SELECT id, keywords FROM t_string_array WHERE match(keywords_ft, 'foo')&quot;);
        assertThat(response.rowCount(), is(1L));
        // also equals term must work
        execute(&quot;SELECT id, keywords FROM t_string_array WHERE keywords_ft = 'foo'&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()), is(
            &quot;1| [foo bar]\n&quot;
        ));

        // equals original whole string must not work
        execute(&quot;SELECT id, keywords FROM t_string_array WHERE keywords_ft = 'foo bar'&quot;);
        assertThat(response.rowCount(), is(0L));
    }
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>BlobIndicesService.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<A NAME="0"></A> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match4012710-0.html#0',2,'match4012710-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>package io.crate.blob.v2;

import static io.crate.blob.v2.BlobIndex.isBlobIndex;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Locale;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

import</B></FONT> javax.annotation.Nullable;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.elasticsearch.cluster.routing.ShardIterator;
import org.elasticsearch.cluster.service.ClusterService;
import org.elasticsearch.common.Strings;
import org.elasticsearch.common.inject.Inject;
import org.elasticsearch.common.io.PathUtils;
import org.elasticsearch.common.settings.Setting;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.common.settings.SettingsException;
import org.elasticsearch.index.Index;
import org.elasticsearch.index.IndexService;
import org.elasticsearch.index.IndexSettings;
import org.elasticsearch.index.shard.IndexEventListener;
import org.elasticsearch.index.shard.IndexShard;
import org.elasticsearch.index.shard.IndexShardState;
import org.elasticsearch.index.shard.ShardId;
import org.elasticsearch.index.shard.ShardNotFoundException;
import org.elasticsearch.indices.cluster.IndicesClusterStateService;

/**
 * Manages the creation and deletion of BlobIndex and BlobShard instances.
 */
public class BlobIndicesService implements IndexEventListener {

    private static final Logger LOGGER = LogManager.getLogger(BlobIndicesService.class);

    public static final Setting&lt;Boolean&gt; SETTING_INDEX_BLOBS_ENABLED = Setting.boolSetting(
        &quot;index.blobs.enabled&quot;, false, Setting.Property.IndexScope);
    public static final Setting&lt;String&gt; SETTING_INDEX_BLOBS_PATH = Setting.simpleString(
        &quot;index.blobs.path&quot;, Setting.Property.IndexScope);
    public static final Setting&lt;String&gt; SETTING_BLOBS_PATH = Setting.simpleString(
        &quot;blobs.path&quot;, Setting.Property.NodeScope);

    private final ClusterService clusterService;

    final Map&lt;String, BlobIndex&gt; indices = new ConcurrentHashMap&lt;&gt;();

    @Nullable
    private final Path globalBlobPath;

    @Inject
    public BlobIndicesService(Settings settings, ClusterService clusterService) {
        this.clusterService = clusterService;
        globalBlobPath = getGlobalBlobPath(settings);
    }

    @Nullable
    public static Path getGlobalBlobPath(Settings settings) {
        String customGlobalBlobPathSetting = SETTING_BLOBS_PATH.get(settings);
        if (Strings.isNullOrEmpty(customGlobalBlobPathSetting)) {
            return null;
        }
        Path globalBlobPath = PathUtils.get(customGlobalBlobPathSetting);
        ensureExistsAndWritable(globalBlobPath);
        return globalBlobPath;
    }


    @Override
    public void afterIndexCreated(IndexService indexService) {
        String indexName = indexService.index().getName();
        if (isBlobIndex(indexName)) {
            BlobIndex oldBlobIndex = indices.put(indexName, new BlobIndex(LOGGER, globalBlobPath));
            assert oldBlobIndex == null : &quot;There must not be an index present if a new index is created&quot;;
        }
    }

    @Override
    public void afterIndexRemoved(Index index,
                                  IndexSettings indexSettings,
                                  IndicesClusterStateService.AllocatedIndices.IndexRemovalReason reason) {
        String indexName = index.getName();
        if (isBlobIndex(indexName)) {
            BlobIndex blobIndex = indices.remove(indexName);
            assert blobIndex != null : &quot;BlobIndex not found on afterIndexDeleted&quot;;
        }
    }

    @Override
    public void afterIndexShardCreated(IndexShard indexShard) {
        String index = indexShard.shardId().getIndexName();
        if (isBlobIndex(index)) {
            BlobIndex blobIndex = indices.get(index);
            assert blobIndex != null : &quot;blobIndex must exists if a shard is created in it&quot;;
            blobIndex.createShard(indexShard);
        }
    }

    @Override
    public void indexShardStateChanged(IndexShard indexShard,
                                       @Nullable IndexShardState previousState,
                                       IndexShardState currentState,
                                       @Nullable String reason) {
        if (currentState == IndexShardState.POST_RECOVERY) {
            String index = indexShard.shardId().getIndexName();
            if (isBlobIndex(index)) {
                BlobIndex blobIndex = indices.get(index);
                blobIndex.initializeShard(indexShard);
            }
        }
    }

    @Override
    public void afterIndexShardDeleted(ShardId shardId, Settings indexSettings) {
        String index = shardId.getIndexName();
        if (isBlobIndex(index)) {
            BlobIndex blobIndex = indices.get(index);
            if (blobIndex != null) {
                blobIndex.removeShard(shardId);
            }
        }
    }

    @Nullable
    public BlobShard blobShard(ShardId shardId) {
        BlobIndex blobIndex = indices.get(shardId.getIndexName());
        if (blobIndex == null) {
            return null;
        }
        return blobIndex.getShard(shardId.id());
    }

    public BlobShard blobShardSafe(ShardId shardId) {
        String index = shardId.getIndexName();
        if (isBlobIndex(index)) {
            BlobShard blobShard = blobShard(shardId);
            if (blobShard == null) {
                throw new ShardNotFoundException(shardId);
            }
            return blobShard;
        }
        throw new BlobsDisabledException(shardId.getIndex());
    }

    public BlobShard localBlobShard(String index, String digest) {
        return blobShardSafe(localShardId(index, digest));
    }

    private ShardId localShardId(String index, String digest) {
        ShardIterator si = clusterService.operationRouting().getShards(
            clusterService.state(), index, null, digest, &quot;_only_local&quot;);
        return si.shardId();
    }

    static boolean ensureExistsAndWritable(Path blobsPath) {
        if (Files.exists(blobsPath)) {
            if (!Files.isDirectory(blobsPath)) {
                throw new SettingsException(
                    String.format(Locale.ENGLISH, &quot;blobs path '%s' is a file, must be a directory&quot;, blobsPath));
            }
            if (!Files.isWritable(blobsPath)) {
                throw new SettingsException(
                    String.format(Locale.ENGLISH, &quot;blobs path '%s' is not writable&quot;, blobsPath));
            }
        } else {
            try {
                Files.createDirectories(blobsPath);
            } catch (IOException e) {
                throw new SettingsException(
                    String.format(Locale.ENGLISH, &quot;blobs path '%s' could not be created&quot;, blobsPath));
            }
        }
        return true;
    }
}
</PRE>
</div>
  </div>
</body>
</html>
