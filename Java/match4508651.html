<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for Optimizer_1.java & TransportSQLActionTest.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for Optimizer_1.java & TransportSQLActionTest.java
      </h3>
      <h1 align="center">
        1.8%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>Optimizer_1.java (13.77551%)<TH>TransportSQLActionTest.java (1.0173323%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match4508651-0.html#0',2,'match4508651-1.html#0',3)" NAME="0">(22-51)<TD><A HREF="javascript:ZweiFrames('match4508651-0.html#0',2,'match4508651-1.html#0',3)" NAME="0">(22-50)</A><TD ALIGN=center><FONT COLOR="#ff0000">27</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>Optimizer_1.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<A NAME="0"></A> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match4508651-1.html#0',3,'match4508651-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>package io.crate.planner.optimizer.symbol;

import java.util.ArrayDeque;
import java.util.Deque;
import java.util.List;
import java.util.function.Function;
import java.util.function.Supplier;

import io.crate.expression.symbol.AliasResolver;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.elasticsearch.Version;

import io.crate.analyze.expressions.ExpressionAnalyzer;
import io.crate.common.collections.Lists2;
import io.crate.exceptions.ConversionException;
import io.crate.expression.symbol.FunctionCopyVisitor;
import io.crate.expression.symbol.Symbol;
import io.crate.metadata.CoordinatorTxnCtx;
import io.crate.metadata.NodeContext;
import io.crate.planner.PlannerContext;
import io.crate.planner.optimizer.matcher.Captures;
import io.crate.planner.optimizer.matcher.Match;
import io.crate.planner.optimizer.symbol.rule.MoveArrayLengthOnReferenceCastToLiteralCastInsideOperators;
import io.crate.planner.optimizer.symbol.rule.MoveReferenceCastToLiteralCastOnAnyOperatorsWhenLeftIsReference;
import io.crate.planner.optimizer.symbol.rule.MoveReferenceCastToLiteralCastOnAnyOperatorsWhenRightIsReference;
import io.crate.planner.optimizer.symbol.rule.MoveSubscriptOnReferenceCastToLiteralCastInsideOperators;
import io.crate.planner.optimizer.symbol.rule.SimplifyEqualsOperationOnIdenticalReferences;
import io.crate.planner.optimizer.symbol.rule.SwapCastsInComparisonOperators;
import</B></FONT> io.crate.planner.optimizer.symbol.rule.SwapCastsInLikeOperators;

public class Optimizer {

    public static Symbol optimizeCasts(Symbol query, PlannerContext plannerContext) {
        Optimizer optimizer = new Optimizer(
            plannerContext.transactionContext(),
            plannerContext.nodeContext(),
            () -&gt; plannerContext.clusterState().nodes().getMinNodeVersion(),
            List.of(
                SwapCastsInComparisonOperators::new,
                SwapCastsInLikeOperators::new,
                MoveReferenceCastToLiteralCastOnAnyOperatorsWhenRightIsReference::new,
                MoveReferenceCastToLiteralCastOnAnyOperatorsWhenLeftIsReference::new,
                MoveSubscriptOnReferenceCastToLiteralCastInsideOperators::new,
                MoveArrayLengthOnReferenceCastToLiteralCastInsideOperators::new,
                SimplifyEqualsOperationOnIdenticalReferences::new
            )
        );
        return optimizer.optimize(query);
    }

    private static final Logger LOGGER = LogManager.getLogger(Optimizer.class);

    private final List&lt;Rule&lt;?&gt;&gt; rules;
    private final Supplier&lt;Version&gt; minNodeVersionInCluster;
    private final NodeContext nodeCtx;
    private final Visitor visitor = new Visitor();

    public Optimizer(CoordinatorTxnCtx coordinatorTxnCtx,
                     NodeContext nodeCtx,
                     Supplier&lt;Version&gt; minNodeVersionInCluster,
                     List&lt;Function&lt;FunctionSymbolResolver, Rule&lt;?&gt;&gt;&gt; rules) {
        FunctionSymbolResolver functionResolver =
            (f, args) -&gt; {
                try {
                    return ExpressionAnalyzer.allocateFunction(
                        f,
                        args,
                        null,
                        null,
                        coordinatorTxnCtx,
                        nodeCtx);
                } catch (ConversionException e) {
                    return null;
                }
            };
        this.rules = Lists2.map(rules, r -&gt; r.apply(functionResolver));
        this.minNodeVersionInCluster = minNodeVersionInCluster;
        this.nodeCtx = nodeCtx;
    }

    public Symbol optimize(Symbol node) {
        return node.accept(visitor, null);
    }

    public Symbol tryApplyRules(Symbol node) {
        final boolean isTraceEnabled = LOGGER.isTraceEnabled();
        // Some rules may only become applicable after another rule triggered, so we keep
        // trying to re-apply the rules as long as at least one plan was transformed.
        boolean done = false;
        int numIterations = 0;
        while (!done &amp;&amp; numIterations &lt; 10_000) {
            done = true;
            Version minVersion = minNodeVersionInCluster.get();
            for (Rule rule : rules) {
                if (minVersion.before(rule.requiredVersion())) {
                    continue;
                }
                Match&lt;?&gt; match = rule.pattern().accept(node, Captures.empty());
                if (match.isPresent()) {
                    if (isTraceEnabled) {
                        LOGGER.trace(&quot;Rule '&quot; + rule.getClass().getSimpleName() + &quot;' matched&quot;);
                    }
                    Symbol transformedNode = rule.apply(match.value(), match.captures(), nodeCtx, visitor.getParentFunction());
                    if (transformedNode != null) {
                        if (isTraceEnabled) {
                            LOGGER.trace(&quot;Rule '&quot; + rule.getClass().getSimpleName() + &quot;' transformed the symbol&quot;);
                        }
                        node = transformedNode;
                        done = false;
                    }
                }
            }
            numIterations++;
        }
        assert numIterations &lt; 10_000
            : &quot;Optimizer reached 10_000 iterations safety guard. This is an indication of a broken rule that matches again and again&quot;;
        return node;
    }

    private class Visitor extends FunctionCopyVisitor&lt;Void&gt; {
        private Deque&lt;io.crate.expression.symbol.Function&gt; visitedFunctions = new ArrayDeque&lt;&gt;();

        @Override
        public Symbol visitFunction(io.crate.expression.symbol.Function symbol, Void context) {
            symbol = (io.crate.expression.symbol.Function) symbol.accept(AliasResolver.INSTANCE, null);
            visitedFunctions.push(symbol);
            var maybeTransformedSymbol = tryApplyRules(symbol);
            if (symbol.equals(maybeTransformedSymbol) == false) {
                visitedFunctions.pop();
                return maybeTransformedSymbol;
            }
            var sym = super.visitFunction(symbol, context);
            visitedFunctions.pop();
            return sym;
        }

        public Symbol getParentFunction() {
            if (visitedFunctions.size() &lt; 2) {
                return null;
            }
            var current = visitedFunctions.pop();
            var parent = visitedFunctions.peek();
            visitedFunctions.push(current);
            return parent;
        }
    }

}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>TransportSQLActionTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<A NAME="0"></A> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match4508651-0.html#0',2,'match4508651-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>package io.crate.integrationtests;

import com.carrotsearch.randomizedtesting.RandomizedContext;
import com.carrotsearch.randomizedtesting.generators.RandomPicks;
import io.crate.common.collections.Lists2;
import io.crate.exceptions.SQLExceptions;
import io.crate.testing.DataTypeTesting;
import io.crate.testing.TestingHelpers;
import io.crate.testing.UseJdbc;
import io.crate.testing.UseRandomizedSchema;
import io.crate.types.DataType;
import io.crate.types.DataTypes;
import org.elasticsearch.common.xcontent.DeprecationHandler;
import org.elasticsearch.common.xcontent.NamedXContentRegistry;
import org.elasticsearch.common.xcontent.json.JsonXContent;
import org.elasticsearch.index.IndexNotFoundException;
import org.elasticsearch.test.ESIntegTestCase;
import org.hamcrest.Matchers;
import org.junit.Rule;
import org.junit.Test;
import org.junit.rules.TemporaryFolder;
import org.locationtech.spatial4j.shape.Point;

import java.io.File;
import java.nio.file.Paths;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.Statement;
import</B></FONT> java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Properties;
import java.util.Random;
import java.util.UUID;
import java.util.stream.Collectors;

import static com.carrotsearch.randomizedtesting.RandomizedTest.$;
import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_TABLE;
import static io.crate.testing.Asserts.assertThrowsMatches;
import static io.crate.testing.SQLErrorMatcher.isSQLError;
import static io.crate.testing.TestingHelpers.printedTable;
import static io.netty.handler.codec.http.HttpResponseStatus.BAD_REQUEST;
import static io.netty.handler.codec.http.HttpResponseStatus.NOT_FOUND;
import static org.hamcrest.Matchers.arrayContaining;
import static org.hamcrest.Matchers.closeTo;
import static org.hamcrest.Matchers.containsInAnyOrder;
import static org.hamcrest.Matchers.containsString;
import static org.hamcrest.Matchers.greaterThan;
import static org.hamcrest.Matchers.hasItems;
import static org.hamcrest.Matchers.instanceOf;
import static org.hamcrest.Matchers.lessThanOrEqualTo;
import static org.hamcrest.Matchers.nullValue;
import static org.hamcrest.core.Is.is;

@ESIntegTestCase.ClusterScope(minNumDataNodes = 2)
public class TransportSQLActionTest extends SQLIntegrationTestCase {

    private Setup setup = new Setup(sqlExecutor);

    @Rule
    public TemporaryFolder folder = new TemporaryFolder();

    private &lt;T&gt; List&lt;T&gt; getCol(Object[][] result, int idx) {
        ArrayList&lt;T&gt; res = new ArrayList&lt;&gt;(result.length);
        for (Object[] row : result) {
            res.add((T) row[idx]);
        }
        return res;
    }

    @Test
    public void testSelectResultContainsColumnsInTheOrderOfTheSelectListInTheQuery() throws Exception {
        execute(&quot;create table test (id string primary key)&quot;);
        execute(&quot;insert into test (id) values ('id1')&quot;);
        execute(&quot;refresh table test&quot;);

        execute(&quot;select \&quot;_id\&quot; as b, \&quot;_version\&quot; as a from test&quot;);
        assertArrayEquals(new String[]{&quot;b&quot;, &quot;a&quot;}, response.cols());
        assertEquals(1, response.rowCount());
    }

    @Test
    public void testIndexNotFoundExceptionIsRaisedIfDeletedAfterPlan() throws Throwable {
        execute(&quot;create table t (name string)&quot;);
        ensureYellow();

        PlanForNode plan = plan(&quot;select * from t&quot;);
        execute(&quot;drop table t&quot;);

        assertThrowsMatches(() -&gt; execute(plan).getResult(), instanceOf(IndexNotFoundException.class));
    }

    @Test
    public void testDeletePartitionAfterPlan() throws Throwable {
        execute(&quot;CREATE TABLE parted_table (id long, text string, day timestamp with time zone) &quot; +
                &quot;PARTITIONED BY (day)&quot;);
        execute(&quot;INSERT INTO parted_table (id, text, day) values(1, 'test', '2016-06-07')&quot;);
        ensureYellow();

        PlanForNode plan = plan(&quot;delete from parted_table where day='2016-06-07'&quot;);
        execute(&quot;delete from parted_table where day='2016-06-07'&quot;);
        try {
            execute(plan).getResult();
        } catch (Throwable t) {
            throw SQLExceptions.unwrap(t);
        }
    }

    @Test
    public void testSelectCountStar() throws Exception {
        execute(&quot;create table test (name string) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into test (name) values (?)&quot;, new Object[]{&quot;Arthur&quot;});
        execute(&quot;insert into test (name) values (?)&quot;, new Object[]{&quot;Trillian&quot;});
        refresh();
        execute(&quot;select count(*) from test&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(2L, response.rows()[0][0]);
    }

    @Test
    public void testSelectZeroLimit() throws Exception {
        execute(&quot;create table test (name string) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into test (name) values (?)&quot;, new Object[]{&quot;Arthur&quot;});
        execute(&quot;insert into test (name) values (?)&quot;, new Object[]{&quot;Trillian&quot;});
        refresh();
        execute(&quot;select * from test limit 0&quot;);
        assertEquals(0L, response.rowCount());
    }

    @Test
    public void testSelectZeroLimitOrderBy() throws Exception {
        execute(&quot;create table test (name string) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into test (name) values (?)&quot;, new Object[]{&quot;Arthur&quot;});
        execute(&quot;insert into test (name) values (?)&quot;, new Object[]{&quot;Trillian&quot;});
        refresh();
        execute(&quot;select * from test order by name limit 0&quot;);
        assertEquals(0L, response.rowCount());
    }

    @Test
    public void testSelectCountStarWithWhereClause() throws Exception {
        execute(&quot;create table test (name string) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into test (name) values (?)&quot;, new Object[]{&quot;Arthur&quot;});
        execute(&quot;insert into test (name) values (?)&quot;, new Object[]{&quot;Trillian&quot;});
        refresh();
        execute(&quot;select count(*) from test where name = 'Trillian'&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(1L, response.rows()[0][0]);
    }

    @Test
    public void testSelectStar() throws Exception {
        execute(&quot;create table test (\&quot;firstName\&quot; string, \&quot;lastName\&quot; string)&quot;);
        ensureYellow();
        execute(&quot;select * from test&quot;);
        assertArrayEquals(new String[]{&quot;firstName&quot;, &quot;lastName&quot;}, response.cols());
        assertEquals(0, response.rowCount());
    }

    @Test
    public void testSelectStarEmptyMapping() throws Exception {
        execute(&quot;select * from unnest()&quot;);
        assertArrayEquals(new String[]{}, response.cols());
        assertEquals(0, response.rowCount());
    }

    @Test
    public void testGroupByOnAnalyzedColumn() throws Exception {
        execute(&quot;create table test1 (col1 string index using fulltext)&quot;);
        execute(&quot;insert into test1 (col1) values ('abc def, ghi. jkl')&quot;);
        refresh();
        assertThat(
            printedTable(execute(&quot;select count(col1) from test1 group by col1&quot;).rows()),
            is(&quot;1\n&quot;)
        );
    }

    @Test
    public void testSelectStarWithOther() throws Exception {
        execute(&quot;create table test (id string primary key, first_name string, last_name string)&quot;);
        execute(&quot;insert into test (id, first_name, last_name) values ('id1', 'Youri', 'Zoon')&quot;);
        execute(&quot;refresh table test&quot;);

        execute(&quot;select \&quot;_version\&quot;, *, \&quot;_id\&quot; from test&quot;);
        assertThat(response.cols(), arrayContaining(&quot;_version&quot;, &quot;id&quot;, &quot;first_name&quot;, &quot;last_name&quot;, &quot;_id&quot;));
        assertEquals(1, response.rowCount());
        assertArrayEquals(new Object[]{1L, &quot;id1&quot;, &quot;Youri&quot;, &quot;Zoon&quot;, &quot;id1&quot;}, response.rows()[0]);
    }

    @Test
    @UseJdbc(0) // $1 style parameter substitution not supported
    public void testSelectWithParams() throws Exception {
        execute(&quot;create table test (id string primary key, first_name string, last_name string, age double) &quot; +
                &quot;with (number_of_replicas = 0)&quot;);

        execute(&quot;insert into test (id, first_name, last_name, age) values ('id1', 'Youri', 'Zoon', 38)&quot;);
        execute(&quot;refresh table test&quot;);

        Object[] args = new Object[]{&quot;id1&quot;};
        execute(&quot;select first_name, last_name from test where \&quot;_id\&quot; = $1&quot;, args);
        assertArrayEquals(new Object[]{&quot;Youri&quot;, &quot;Zoon&quot;}, response.rows()[0]);

        args = new Object[]{&quot;Zoon&quot;};
        execute(&quot;select first_name, last_name from test where last_name = $1&quot;, args);
        assertArrayEquals(new Object[]{&quot;Youri&quot;, &quot;Zoon&quot;}, response.rows()[0]);

        args = new Object[]{38, &quot;Zoon&quot;};
        execute(&quot;select first_name, last_name from test where age = $1 and last_name = $2&quot;, args);
        assertArrayEquals(new Object[]{&quot;Youri&quot;, &quot;Zoon&quot;}, response.rows()[0]);

        args = new Object[]{38, &quot;Zoon&quot;};
        execute(&quot;select first_name, last_name from test where age = ? and last_name = ?&quot;, args);
        assertArrayEquals(new Object[]{&quot;Youri&quot;, &quot;Zoon&quot;}, response.rows()[0]);
    }

    @Test
    public void testSelectStarWithOtherAndAlias() throws Exception {
        execute(&quot;create table test (first_name string, last_name string)&quot;);
        execute(&quot;insert into test (first_name, last_name) values ('Youri', 'Zoon')&quot;);
        execute(&quot;refresh table test&quot;);
        execute(&quot;select *, \&quot;_version\&quot;, \&quot;_version\&quot; as v from test&quot;);
        assertArrayEquals(new String[]{&quot;first_name&quot;, &quot;last_name&quot;, &quot;_version&quot;, &quot;v&quot;}, response.cols());
        assertEquals(1, response.rowCount());
        assertArrayEquals(new Object[]{&quot;Youri&quot;, &quot;Zoon&quot;, 1L, 1L}, response.rows()[0]);
    }

    @Test
    public void testFilterByEmptyString() throws Exception {
        execute(&quot;create table test (name string)&quot;);
        execute(&quot;insert into test (name) values (''), ('Ruben Lenten')&quot;);
        execute(&quot;refresh table test&quot;);

        execute(&quot;select name from test where name = ''&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(&quot;&quot;, response.rows()[0][0]);

        execute(&quot;select name from test where name != ''&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(&quot;Ruben Lenten&quot;, response.rows()[0][0]);

    }

    @Test
    public void testFilterByNull() throws Exception {
        execute(&quot;create table test (id int, name string, o object(ignored))&quot;);
        ensureYellow();

        execute(&quot;insert into test (id) values (1)&quot;);
        execute(&quot;insert into test (id, name) values (2, 'Ruben Lenten'), (3, '')&quot;);
        refresh();

        execute(&quot;select id from test where name is null&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(1, response.rows()[0][0]);

        execute(&quot;select id from test where name is not null order by id&quot;);
        assertEquals(2, response.rowCount());
        assertEquals(2, response.rows()[0][0]);

        execute(&quot;select id from test where o['invalid'] is null&quot;);
        assertEquals(3, response.rowCount());

        execute(&quot;select name from test where name is not null and name != ''&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(&quot;Ruben Lenten&quot;, response.rows()[0][0]);
    }

    @Test
    public void testFilterByBoolean() throws Exception {
        execute(&quot;create table test (sunshine boolean)&quot;);
        execute(&quot;insert into test values (?)&quot;, new Object[]{true});
        refresh();

        execute(&quot;select sunshine from test where sunshine = true&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(true, response.rows()[0][0]);

        execute(&quot;update test set sunshine=false where sunshine = true&quot;);
        assertEquals(1, response.rowCount());
        refresh();

        execute(&quot;select sunshine from test where sunshine = ?&quot;, new Object[]{false});
        assertEquals(1, response.rowCount());
        assertEquals(false, response.rows()[0][0]);
    }


    /**
     * Queries are case sensitive by default, however column names without quotes are converted
     * to lowercase which is the same behaviour as in postgres
     * see also http://www.thenextage.com/wordpress/postgresql-case-sensitivity-part-1-the-ddl/
     *
     */
    @Test
    public void testColsAreCaseSensitive() throws Exception {
        execute(&quot;create table test (\&quot;firstname\&quot; string, \&quot;firstName\&quot; string) &quot; +
                &quot;with (number_of_replicas = 0)&quot;);
        ensureYellow();
        execute(&quot;insert into test (\&quot;firstname\&quot;, \&quot;firstName\&quot;) values ('LowerCase', 'CamelCase')&quot;);
        refresh();

        execute(&quot;select FIRSTNAME, \&quot;firstname\&quot;, \&quot;firstName\&quot; from test&quot;);
        assertArrayEquals(new String[]{&quot;firstname&quot;, &quot;firstname&quot;, &quot;firstName&quot;}, response.cols());
        assertEquals(1, response.rowCount());
        assertEquals(&quot;LowerCase&quot;, response.rows()[0][0]);
        assertEquals(&quot;LowerCase&quot;, response.rows()[0][1]);
        assertEquals(&quot;CamelCase&quot;, response.rows()[0][2]);
    }


    @Test
    public void testIdSelectWithResult() throws Exception {
        execute(&quot;create table test (id string primary key)&quot;);
        execute(&quot;insert into test (id) values ('id1')&quot;);
        execute(&quot;refresh table test&quot;);

        execute(&quot;select \&quot;_id\&quot; from test&quot;);
        assertArrayEquals(new String[]{&quot;_id&quot;}, response.cols());
        assertEquals(1, response.rowCount());
        assertEquals(1, response.rows()[0].length);
        assertEquals(&quot;id1&quot;, response.rows()[0][0]);
    }

    @Test
    public void testSqlRequestWithLimit() throws Exception {
        execute(&quot;create table test (id string primary key)&quot;);
        execute(&quot;insert into test (id) values ('id1'), ('id2')&quot;);
        execute(&quot;refresh table test&quot;);
        execute(&quot;select \&quot;_id\&quot; from test limit 1&quot;);
        assertEquals(1, response.rowCount());
    }


    @Test
    public void testSqlRequestWithLimitAndOffset() throws Exception {
        execute(&quot;create table test (id string primary key) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into test (id) values (?), (?), (?)&quot;, new Object[]{&quot;id1&quot;, &quot;id2&quot;, &quot;id3&quot;});
        refresh();
        execute(&quot;select \&quot;id\&quot; from test order by id limit 1 offset 1&quot;);
        assertEquals(1, response.rowCount());
        assertThat(
            printedTable(response.rows()),
            is(&quot;id2\n&quot;)
        );
    }


    @Test
    public void testSqlRequestWithFilter() throws Exception {
        execute(&quot;create table test (id string primary key)&quot;);
        execute(&quot;insert into test (id) values ('id1'), ('id2')&quot;);
        execute(&quot;select _id from test where id = 'id1'&quot;);
        assertEquals(1, response.rowCount());
        assertThat(
            printedTable(response.rows()),
            is(&quot;id1\n&quot;)
        );
    }

    @Test
    public void testSqlRequestWithNotEqual() throws Exception {
        execute(&quot;create table test (id string primary key) with (number_of_replicas = 0)&quot;);
        ensureYellow();
        execute(&quot;insert into test (id) values (?)&quot;, new Object[][]{
            new Object[]{&quot;id1&quot;},
            new Object[]{&quot;id2&quot;}
        });
        refresh();
        execute(&quot;select id from test where id != 'id1'&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(&quot;id2&quot;, response.rows()[0][0]);
    }


    @Test
    public void testSqlRequestWithOneOrFilter() throws Exception {
        execute(&quot;create table test (id string) with (number_of_replicas = 0)&quot;);
        ensureYellow();
        execute(&quot;insert into test (id) values ('id1'), ('id2'), ('id3')&quot;);
        refresh();
        execute(&quot;select id from test where id='id1' or id='id3'&quot;);
        assertEquals(2, response.rowCount());
        assertThat(this.&lt;String&gt;getCol(response.rows(), 0), containsInAnyOrder(&quot;id1&quot;, &quot;id3&quot;));
    }

    @Test
    public void testSqlRequestWithOneMultipleOrFilter() throws Exception {
        execute(&quot;create table test (id string) with (number_of_replicas = 0)&quot;);
        ensureYellow();
        execute(&quot;insert into test (id) values ('id1'), ('id2'), ('id3'), ('id4')&quot;);
        refresh();
        execute(&quot;select id from test where id='id1' or id='id2' or id='id4'&quot;);
        assertEquals(3, response.rowCount());
        List&lt;String&gt; col1 = this.getCol(response.rows(), 0);
        assertThat(col1, containsInAnyOrder(&quot;id1&quot;, &quot;id2&quot;, &quot;id4&quot;));
    }

    @Test
    public void testSqlRequestWithDateFilter() {
        execute(&quot;create table test (date timestamp with time zone)&quot;);
        execute(&quot;insert into test (date) values ('2013-10-01'), ('2013-10-02')&quot;);
        execute(&quot;refresh table test&quot;);
        execute(&quot;select date from test where date = '2013-10-01'&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(1380585600000L, response.rows()[0][0]);
    }

    @Test
    public void testSqlRequestWithDateGtFilter() {
        execute(&quot;create table test (date timestamp with time zone)&quot;);
        execute(&quot;insert into test (date) values ('2013-10-01'), ('2013-10-02')&quot;);
        execute(&quot;refresh table test&quot;);
        execute(
            &quot;select date from test where date &gt; '2013-10-01'&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(1380672000000L, response.rows()[0][0]);
    }

    @Test
    public void testSqlRequestWithNumericGtFilter() throws Exception {
        execute(&quot;create table test (i long)&quot;);
        execute(&quot;insert into test (i) values (10), (20)&quot;);
        execute(&quot;refresh table test&quot;);
        execute(
            &quot;select i from test where i &gt; 10&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(20L, response.rows()[0][0]);
    }


    @Test
    public void testArraySupport() throws Exception {
        execute(&quot;create table t1 (id int primary key, strings array(string), integers array(integer)) with (number_of_replicas=0)&quot;);
        ensureYellow();

        execute(&quot;insert into t1 (id, strings, integers) values (?, ?, ?)&quot;,
            new Object[]{
                1,
                new String[]{&quot;foo&quot;, &quot;bar&quot;},
                new Integer[]{1, 2, 3}
            }
        );
        refresh();

        execute(&quot;select id, strings, integers from t1&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat(response.rows()[0][0], is(1));
        assertThat(((List) response.rows()[0][1]).get(0), is(&quot;foo&quot;));
        assertThat(((List) response.rows()[0][1]).get(1), is(&quot;bar&quot;));
        assertThat(((List) response.rows()[0][2]).get(0), is(1));
        assertThat(((List) response.rows()[0][2]).get(1), is(2));
        assertThat(((List) response.rows()[0][2]).get(2), is(3));
    }

    @Test
    @SuppressWarnings(&quot;unchecked&quot;)
    public void testArrayInsideObject() throws Exception {
        execute(&quot;create table t1 (id int primary key, details object as (names array(string))) with (number_of_replicas=0)&quot;);
        ensureYellow();

        Map&lt;String, Object&gt; details = new HashMap&lt;&gt;();
        details.put(&quot;names&quot;, new Object[]{&quot;Arthur&quot;, &quot;Trillian&quot;});
        execute(&quot;insert into t1 (id, details) values (?, ?)&quot;, new Object[]{1, details});
        refresh();

        execute(&quot;select details['names'] from t1&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat(((List) response.rows()[0][0]).get(0), is(&quot;Arthur&quot;));
        assertThat(((List) response.rows()[0][0]).get(1), is(&quot;Trillian&quot;));
    }

    @Test
    public void testArrayInsideObjectArrayOutputAndQueryBehaviour() throws Exception {
        execute(&quot;create table t1 (id int primary key, details array(object as (names array(string)))) with (number_of_replicas=0)&quot;);
        ensureYellow();

        Map&lt;String, Object&gt; detail1 = new HashMap&lt;&gt;();
        detail1.put(&quot;names&quot;, new Object[]{&quot;Arthur&quot;, &quot;Trillian&quot;});

        Map&lt;String, Object&gt; detail2 = new HashMap&lt;&gt;();
        detail2.put(&quot;names&quot;, new Object[]{&quot;Ford&quot;, &quot;Slarti&quot;, &quot;Ford&quot;});

        List&lt;Map&lt;String, Object&gt;&gt; details = Arrays.asList(detail1, detail2);

        execute(&quot;insert into t1 (id, details) values (?, ?)&quot;, new Object[]{1, details});
        refresh();

        execute(&quot;select &quot; +
                &quot;details['names'], ['Arthur', 'Trillian'] = ANY (details['names']) &quot; +
                &quot;from t1 &quot; +
                &quot;where ['Ford', 'Slarti', 'Ford'] = ANY (details['names'])&quot;);
        assertThat(
            printedTable(response.rows()),
            is(&quot;[[Arthur, Trillian], [Ford, Slarti, Ford]]| true\n&quot;)
        );
    }

    @Test
    public void testFullPathRequirement() throws Exception {
        // verifies that the &quot;fullPath&quot; setting in the es mapping is no longer required
        execute(&quot;create table t1 (id int primary key, details object as (id int, more_details object as (id int))) with (number_of_replicas=0)&quot;);
        ensureYellow();

        Map&lt;String, Object&gt; more_details = new HashMap&lt;&gt;();
        more_details.put(&quot;id&quot;, 2);

        Map&lt;String, Object&gt; details = new HashMap&lt;&gt;();
        details.put(&quot;id&quot;, 1);
        details.put(&quot;more_details&quot;, more_details);

        execute(&quot;insert into t1 (id, details) values (2, ?)&quot;, new Object[]{details});
        execute(&quot;refresh table t1&quot;);

        execute(&quot;select details from t1 where details['id'] = 2&quot;);
        assertThat(response.rowCount(), is(0L));
    }

    @Test
    @SuppressWarnings(&quot;unchecked&quot;)
    public void testArraySupportWithNullValues() throws Exception {
        execute(&quot;create table t1 (id int primary key, strings array(string)) with (number_of_replicas=0)&quot;);
        ensureYellow();

        execute(&quot;insert into t1 (id, strings) values (?, ?)&quot;,
            new Object[]{
                1,
                new String[]{&quot;foo&quot;, null, &quot;bar&quot;},
            }
        );
        refresh();

        execute(&quot;select id, strings from t1&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat(response.rows()[0][0], is(1));
        assertThat(((List) response.rows()[0][1]).get(0), is(&quot;foo&quot;));
        assertThat(((List) response.rows()[0][1]).get(1), nullValue());
        assertThat(((List) response.rows()[0][1]).get(2), is(&quot;bar&quot;));
    }

    @Test
    public void testObjectArrayInsertAndSelect() throws Exception {
        execute(&quot;create table t1 (&quot; +
                &quot;  id int primary key, &quot; +
                &quot;  objects array(&quot; +
                &quot;   object as (&quot; +
                &quot;     name string, &quot; +
                &quot;     age int&quot; +
                &quot;   )&quot; +
                &quot;  )&quot; +
                &quot;) with (number_of_replicas=0)&quot;);
        ensureYellow();

        Map&lt;String, Object&gt; obj1 = Map.of(&quot;name&quot;, &quot;foo&quot;, &quot;age&quot;, 1);
        Map&lt;String, Object&gt; obj2 = Map.of(&quot;name&quot;, &quot;bar&quot;, &quot;age&quot;, 2);

        Object[] args = new Object[]{1, new Object[]{obj1, obj2}};
        execute(&quot;insert into t1 (id, objects) values (?, ?)&quot;, args);
        refresh();

        execute(&quot;select objects from t1&quot;);
        assertThat(response.rowCount(), is(1L));

        List objResults = (List) response.rows()[0][0];
        Map&lt;String, Object&gt; obj1Result = (Map) objResults.get(0);
        assertThat(obj1Result.get(&quot;name&quot;), is(&quot;foo&quot;));
        assertThat(obj1Result.get(&quot;age&quot;), is(1));

        Map&lt;String, Object&gt; obj2Result = (Map) objResults.get(1);
        assertThat(obj2Result.get(&quot;name&quot;), is(&quot;bar&quot;));
        assertThat(obj2Result.get(&quot;age&quot;), is(2));

        execute(&quot;select objects['name'] from t1&quot;);
        assertThat(response.rowCount(), is(1L));

        List names = (List) response.rows()[0][0];

        assertThat(names.get(0), is(&quot;foo&quot;));
        assertThat(names.get(1), is(&quot;bar&quot;));

        execute(&quot;select objects['name'] from t1 where ? = ANY (objects['name'])&quot;, new Object[]{&quot;foo&quot;});
        assertThat(response.rowCount(), is(1L));
    }

    @Test
    public void testGetResponseWithObjectColumn() throws Exception {
        execute(&quot;create table test (&quot; +
                &quot;   id text primary key,&quot; +
                &quot;   data object &quot; +
                &quot;)&quot;);

        Map&lt;String, Object&gt; data = new HashMap&lt;&gt;();
        data.put(&quot;foo&quot;, &quot;bar&quot;);
        execute(&quot;insert into test (id, data) values (?, ?)&quot;, new Object[]{&quot;1&quot;, data});
        refresh();

        execute(&quot;select data from test where id = ?&quot;, new Object[]{&quot;1&quot;});
        assertEquals(data, response.rows()[0][0]);
    }

    @Test
    public void testSelectToGetRequestByPlanner() throws Exception {
        this.setup.createTestTableWithPrimaryKey();

        execute(&quot;insert into test (pk_col, message) values ('124', 'bar1')&quot;);
        assertEquals(1, response.rowCount());
        refresh();
        waitNoPendingTasksOnAll(); // wait for mapping update as foo is being added

        execute(&quot;select pk_col, message from test where pk_col='124'&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(&quot;124&quot;, response.rows()[0][0]);
    }

    @Test
    public void testSelectToRoutedRequestByPlanner() throws Exception {
        this.setup.createTestTableWithPrimaryKey();

        execute(&quot;insert into test (pk_col, message) values ('1', 'foo')&quot;);
        execute(&quot;insert into test (pk_col, message) values ('2', 'bar')&quot;);
        execute(&quot;insert into test (pk_col, message) values ('3', 'baz')&quot;);

        execute(&quot;SELECT * FROM test WHERE pk_col='1' OR pk_col='2'&quot;);
        assertThat(response.rowCount(), is(2L));

        execute(&quot;SELECT * FROM test WHERE pk_col=? OR pk_col=?&quot;, new Object[]{&quot;1&quot;, &quot;2&quot;});
        assertThat(response.rowCount(), is(2L));

        execute(&quot;SELECT * FROM test WHERE (pk_col=? OR pk_col=?) OR pk_col=?&quot;, new Object[]{&quot;1&quot;, &quot;2&quot;, &quot;3&quot;});
        assertThat(response.rowCount(), is(3L));
        assertThat(String.join(&quot;, &quot;, List.of(response.cols())), is(&quot;pk_col, message&quot;));
    }

    @Test
    public void testSelectToRoutedRequestByPlannerMissingDocuments() throws Exception {
        this.setup.createTestTableWithPrimaryKey();

        execute(&quot;insert into test (pk_col, message) values ('1', 'foo')&quot;);
        execute(&quot;insert into test (pk_col, message) values ('2', 'bar')&quot;);
        execute(&quot;insert into test (pk_col, message) values ('3', 'baz')&quot;);
        refresh();

        execute(&quot;SELECT pk_col, message FROM test WHERE pk_col='4' OR pk_col='3'&quot;);
        assertEquals(1, response.rowCount());
        assertThat(Arrays.asList(response.rows()[0]), hasItems(new Object[]{&quot;3&quot;, &quot;baz&quot;}));

        execute(&quot;SELECT pk_col, message FROM test WHERE pk_col='4' OR pk_col='99'&quot;);
        assertEquals(0, response.rowCount());
    }

    @Test
    public void testSelectToRoutedRequestByPlannerWhereIn() throws Exception {
        this.setup.createTestTableWithPrimaryKey();

        execute(&quot;insert into test (pk_col, message) values ('1', 'foo')&quot;);
        execute(&quot;insert into test (pk_col, message) values ('2', 'bar')&quot;);
        execute(&quot;insert into test (pk_col, message) values ('3', 'baz')&quot;);
        refresh();

        execute(&quot;SELECT * FROM test WHERE pk_col IN (?,?,?)&quot;, new Object[]{&quot;1&quot;, &quot;2&quot;, &quot;3&quot;});
        assertEquals(3, response.rowCount());
    }

    @Test
    public void testUpdateToRoutedRequestByPlannerWhereOr() throws Exception {
        this.setup.createTestTableWithPrimaryKey();
        execute(&quot;insert into test (pk_col, message) values ('1', 'foo'), ('2', 'bar'), ('3', 'baz')&quot;);
        refresh();
        execute(&quot;update test set message='new' WHERE pk_col='1' or pk_col='2' or pk_col='4'&quot;);
        assertThat(response.rowCount(), is(2L));
        refresh();
        execute(&quot;SELECT distinct message FROM test&quot;);
        assertThat(response.rowCount(), is(2L));
    }

    @Test
    public void testSelectWithWhereLike() throws Exception {
        this.setup.groupBySetup();

        execute(&quot;select name from characters where name like '%ltz'&quot;);
        assertEquals(2L, response.rowCount());

        execute(&quot;select count(*) from characters where name like 'Jeltz'&quot;);
        assertEquals(1L, response.rows()[0][0]);

        execute(&quot;select count(*) from characters where race like '%o%'&quot;);
        assertEquals(3L, response.rows()[0][0]);

        Map&lt;String, Object&gt; emptyMap = new HashMap&lt;&gt;();
        Map&lt;String, Object&gt; details = new HashMap&lt;&gt;();
        details.put(&quot;age&quot;, 30);
        details.put(&quot;job&quot;, &quot;soldier&quot;);
        execute(&quot;insert into characters (race, gender, name, details) values (?, ?, ?, ?)&quot;,
            new Object[]{&quot;Vo*&quot;, &quot;male&quot;, &quot;Kwaltzz&quot;, emptyMap}
        );
        execute(&quot;insert into characters (race, gender, name, details) values (?, ?, ?, ?)&quot;,
            new Object[]{&quot;Vo?&quot;, &quot;male&quot;, &quot;Kwaltzzz&quot;, emptyMap}
        );
        execute(&quot;insert into characters (race, gender, name, details) values (?, ?, ?, ?)&quot;,
            new Object[]{&quot;Vo!&quot;, &quot;male&quot;, &quot;Kwaltzzzz&quot;, details}
        );
        execute(&quot;insert into characters (race, gender, name, details) values (?, ?, ?, ?)&quot;,
            new Object[]{&quot;Vo%&quot;, &quot;male&quot;, &quot;Kwaltzzzz&quot;, details}
        );
        refresh();

        execute(&quot;select race from characters where race like 'Vo*'&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(&quot;Vo*&quot;, response.rows()[0][0]);

        execute(&quot;select race from characters where race like ?&quot;, new Object[]{&quot;Vo?&quot;});
        assertEquals(1L, response.rowCount());
        assertEquals(&quot;Vo?&quot;, response.rows()[0][0]);

        execute(&quot;select race from characters where race like 'Vo!'&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(&quot;Vo!&quot;, response.rows()[0][0]);

        execute(&quot;select race from characters where race like 'Vo\\%'&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(&quot;Vo%&quot;, response.rows()[0][0]);

        execute(&quot;select race from characters where race like 'Vo_'&quot;);
        assertEquals(4L, response.rowCount());

        execute(&quot;select race from characters where details['job'] like 'sol%'&quot;);
        assertEquals(2L, response.rowCount());
    }

    private void nonExistingColumnSetup() {
        execute(&quot;create table quotes (&quot; +
                &quot;id integer primary key, &quot; +
                &quot;quote string index off, &quot; +
                &quot;o object(ignored) &quot; +
                &quot;) clustered by (id) into 3 shards with (number_of_replicas = 0)&quot;);
        execute(&quot;insert into quotes (id, quote) values (1, '\&quot;Nothing particularly exciting,&quot; +
                &quot;\&quot; it admitted, \&quot;but they are alternatives.\&quot;')&quot;);
        execute(&quot;insert into quotes (id, quote) values (2, '\&quot;Have another drink,&quot; +
                &quot;\&quot; said Trillian. \&quot;Enjoy yourself.\&quot;')&quot;);
        refresh();
    }

    @Test
    public void selectNonExistingColumn() throws Exception {
        nonExistingColumnSetup();
        execute(&quot;select o['notExisting'] from quotes&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(&quot;o['notExisting']&quot;, response.cols()[0]);
        assertNull(response.rows()[0][0]);
        assertNull(response.rows()[1][0]);
    }

    @Test
    public void selectNonExistingAndExistingColumns() throws Exception {
        nonExistingColumnSetup();
        execute(&quot;select o['unknown'], id from quotes order by id asc&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(&quot;o['unknown']&quot;, response.cols()[0]);
        assertEquals(&quot;id&quot;, response.cols()[1]);
        assertNull(response.rows()[0][0]);
        assertEquals(1, response.rows()[0][1]);
        assertNull(response.rows()[1][0]);
        assertEquals(2, response.rows()[1][1]);
    }

    @Test
    public void selectWhereNonExistingColumn() throws Exception {
        nonExistingColumnSetup();
        execute(&quot;select * from quotes where o['something'] &gt; 0&quot;);
        assertEquals(0L, response.rowCount());
    }

    @Test
    public void selectWhereDynamicColumnIsNull() throws Exception {
        nonExistingColumnSetup();
        execute(&quot;select * from quotes where o['something'] IS NULL&quot;);
        assertEquals(2, response.rowCount());
    }

    @Test
    public void selectWhereNonExistingColumnWhereIn() throws Exception {
        nonExistingColumnSetup();
        execute(&quot;select * from quotes where o['something'] IN (1,2,3)&quot;);
        assertEquals(0L, response.rowCount());
    }

    @Test
    public void selectWhereNonExistingColumnLike() throws Exception {
        nonExistingColumnSetup();
        execute(&quot;select * from quotes where o['something'] Like '%bla'&quot;);
        assertEquals(0L, response.rowCount());
    }

    @Test
    public void selectWhereNonExistingColumnMatchFunction() throws Exception {
        nonExistingColumnSetup();

        assertThrowsMatches(() -&gt; execute(&quot;select * from quotes where match(o['something'], 'bla')&quot;),
                     isSQLError(is(&quot;Can only use MATCH on columns of type STRING or GEO_SHAPE, not on 'undefined'&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000));
    }

    @Test
    public void testSelectCountDistinctZero() throws Exception {
        execute(&quot;create table test (col1 int) with (number_of_replicas=0)&quot;);
        ensureYellow();

        execute(&quot;select count(distinct col1) from test&quot;);

        assertEquals(1, response.rowCount());
        assertEquals(0L, response.rows()[0][0]);
    }

    @Test
    public void testRefresh() throws Exception {
        execute(&quot;create table test (id int primary key, name string) with (refresh_interval = 0)&quot;);
        ensureYellow();
        execute(&quot;insert into test (id, name) values (0, 'Trillian'), (1, 'Ford'), (2, 'Zaphod')&quot;);
        execute(&quot;select count(*) from test&quot;);
        assertThat((long) response.rows()[0][0], lessThanOrEqualTo(3L));

        execute(&quot;refresh table test&quot;);
        assertThat(response.rowCount(), is(1L));

        execute(&quot;select count(*) from test&quot;);
        assertThat((Long) response.rows()[0][0], is(3L));
    }

    @Test
    public void testInsertSelectWithClusteredBy() throws Exception {
        execute(&quot;create table quotes (id integer, quote string) clustered by(id) &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into quotes (id, quote) values(?, ?)&quot;,
            new Object[]{1, &quot;I'd far rather be happy than right any day.&quot;});
        assertEquals(1L, response.rowCount());
        refresh();

        execute(&quot;select \&quot;_id\&quot;, id, quote from quotes where id=1&quot;);
        assertEquals(1L, response.rowCount());

        // Validate generated _id, must be: &lt;generatedRandom&gt;
        assertNotNull(response.rows()[0][0]);
        assertThat(((String) response.rows()[0][0]).length(), greaterThan(0));
    }

    @Test
    public void testInsertSelectWithAutoGeneratedId() throws Exception {
        execute(&quot;create table quotes (id integer, quote string)&quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into quotes (id, quote) values(?, ?)&quot;,
            new Object[]{1, &quot;I'd far rather be happy than right any day.&quot;});
        assertEquals(1L, response.rowCount());
        refresh();

        execute(&quot;select \&quot;_id\&quot;, id, quote from quotes where id=1&quot;);
        assertEquals(1L, response.rowCount());

        // Validate generated _id, must be: &lt;generatedRandom&gt;
        assertNotNull(response.rows()[0][0]);
        assertThat(((String) response.rows()[0][0]).length(), greaterThan(0));
    }

    @Test
    public void testInsertSelectWithPrimaryKey() throws Exception {
        execute(&quot;create table quotes (id integer primary key, quote string)&quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into quotes (id, quote) values(?, ?)&quot;,
            new Object[]{1, &quot;I'd far rather be happy than right any day.&quot;});
        assertEquals(1L, response.rowCount());
        refresh();

        execute(&quot;select \&quot;_id\&quot;, id, quote from quotes where id=1&quot;);
        assertEquals(1L, response.rowCount());

        // Validate generated _id.
        // Must equal to id because its the primary key
        String _id = (String) response.rows()[0][0];
        Integer id = (Integer) response.rows()[0][1];
        assertEquals(id.toString(), _id);
    }

    @Test
    public void testInsertSelectWithMultiplePrimaryKey() throws Exception {
        execute(&quot;create table quotes (id integer primary key, author string primary key, &quot; +
                &quot;quote string) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into quotes (id, author, quote) values(?, ?, ?)&quot;,
            new Object[]{1, &quot;Ford&quot;, &quot;I'd far rather be happy than right any day.&quot;});
        assertEquals(1L, response.rowCount());
        refresh();

        execute(&quot;select \&quot;_id\&quot;, id from quotes where id=1 and author='Ford'&quot;);
        assertEquals(1L, response.rowCount());
        assertThat((String) response.rows()[0][0], is(&quot;AgExBEZvcmQ=&quot;));
        assertThat((Integer) response.rows()[0][1], is(1));
    }

    @Test
    public void testInsertSelectWithMultiplePrimaryKeyAndClusteredBy() throws Exception {
        execute(&quot;create table quotes (id integer primary key, author string primary key, &quot; +
                &quot;quote string) clustered by(author) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into quotes (id, author, quote) values(?, ?, ?)&quot;,
            new Object[]{1, &quot;Ford&quot;, &quot;I'd far rather be happy than right any day.&quot;});
        assertEquals(1L, response.rowCount());
        refresh();

        execute(&quot;select \&quot;_id\&quot;, id from quotes where id=1 and author='Ford'&quot;);
        assertEquals(1L, response.rowCount());
        assertThat((String) response.rows()[0][0], is(&quot;AgRGb3JkATE=&quot;));
        assertThat((Integer) response.rows()[0][1], is(1));
    }

    @Test
    public void testInsertSelectWithMultiplePrimaryOnePkSame() throws Exception {
        execute(&quot;create table quotes (id integer primary key, author string primary key, &quot; +
                &quot;quote string) clustered by(author) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into quotes (id, author, quote) values (?, ?, ?), (?, ?, ?)&quot;,
            new Object[]{1, &quot;Ford&quot;, &quot;I'd far rather be happy than right any day.&quot;,
                1, &quot;Douglas&quot;, &quot;Don't panic&quot;}
        );
        assertEquals(2L, response.rowCount());
        refresh();

        execute(&quot;select \&quot;_id\&quot;, id from quotes where id=1 order by author&quot;);
        assertEquals(2L, response.rowCount());
        assertThat((String) response.rows()[0][0], is(&quot;AgdEb3VnbGFzATE=&quot;));
        assertThat((Integer) response.rows()[0][1], is(1));
        assertThat((String) response.rows()[1][0], is(&quot;AgRGb3JkATE=&quot;));
        assertThat((Integer) response.rows()[1][1], is(1));
    }

    @Test
    public void testSelectWhereBoolean() {
        execute(&quot;create table a (v boolean)&quot;);
        ensureYellow();

        execute(&quot;insert into a values (true)&quot;);
        execute(&quot;insert into a values (true)&quot;);
        execute(&quot;insert into a values (true)&quot;);
        execute(&quot;insert into a values (false)&quot;);
        execute(&quot;insert into a values (false)&quot;);
        refresh();

        execute(&quot;select v from a where v&quot;);
        assertEquals(3L, response.rowCount());

        execute(&quot;select v from a where not v&quot;);
        assertEquals(2L, response.rowCount());

        execute(&quot;select v from a where v or not v&quot;);
        assertEquals(5L, response.rowCount());

        execute(&quot;select v from a where v and not v&quot;);
        assertEquals(0L, response.rowCount());
    }

    @Test
    public void testSelectWhereBooleanPK() {
        execute(&quot;create table b (v boolean primary key) clustered by (v)&quot;);
        ensureYellow();

        execute(&quot;insert into b values (true)&quot;);
        execute(&quot;insert into b values (false)&quot;);
        refresh();

        execute(&quot;select v from b where v&quot;);
        assertEquals(1L, response.rowCount());

        execute(&quot;select v from b where not v&quot;);
        assertEquals(1L, response.rowCount());

        execute(&quot;select v from b where v or not v&quot;);
        assertEquals(2L, response.rowCount());

        execute(&quot;select v from b where v and not v&quot;);
        assertEquals(0L, response.rowCount());
    }


    @Test
    public void testBulkOperations() throws Exception {
        execute(&quot;create table test (id integer primary key, name string) with (number_of_replicas = 0)&quot;);
        ensureYellow();
        long[] rowCounts = execute(&quot;insert into test (id, name) values (?, ?), (?, ?)&quot;,
            new Object[][]{
                {1, &quot;Earth&quot;, 2, &quot;Saturn&quot;},    // bulk row 1
                {3, &quot;Moon&quot;, 4, &quot;Mars&quot;}        // bulk row 2
            });
        assertThat(rowCounts.length, is(2));
        for (long rowCount : rowCounts) {
            assertThat(rowCount, is(2L));
        }
        refresh();

        rowCounts = execute(&quot;insert into test (id, name) values (?, ?), (?, ?)&quot;,
            new Object[][]{
                {1, &quot;Earth&quot;, 2, &quot;Saturn&quot;},    // bulk row 1
                {3, &quot;Moon&quot;, 4, &quot;Mars&quot;}        // bulk row 2
            });
        assertThat(rowCounts.length, is(2));
        for (long rowCount : rowCounts) {
            assertThat(rowCount, is(-2L));
        }

        execute(&quot;select name from test order by id asc&quot;);
        assertEquals(&quot;Earth\nSaturn\nMoon\nMars\n&quot;, printedTable(response.rows()));

        // test bulk update-by-id
        rowCounts = execute(&quot;update test set name = concat(name, '-updated') where id = ?&quot;, new Object[][]{
            new Object[]{2},
            new Object[]{3},
            new Object[]{4},
        });
        assertThat(rowCounts.length, is(3));
        for (long rowCount : rowCounts) {
            assertThat(rowCount, is(1L));
        }
        refresh();

        execute(&quot;select count(*) from test where name like '%-updated'&quot;);
        assertThat(response.rows()[0][0], is(3L));

        // test bulk of delete-by-id
        rowCounts = execute(&quot;delete from test where id = ?&quot;, new Object[][]{
            new Object[]{1},
            new Object[]{3}
        });
        assertThat(rowCounts.length, is(2));
        for (long rowCount : rowCounts) {
            assertThat(rowCount, is(1L));
        }
        refresh();

        execute(&quot;select count(*) from test&quot;);
        assertThat(response.rows()[0][0], is(2L));

        // test bulk of delete-by-query
        rowCounts = execute(&quot;delete from test where name = ?&quot;, new Object[][]{
            new Object[]{&quot;Saturn-updated&quot;},
            new Object[]{&quot;Mars-updated&quot;}
        });
        assertThat(rowCounts.length, is(2));
        for (long rowCount : rowCounts) {
            assertThat(rowCount, is(1L));
        }
        refresh();

        execute(&quot;select count(*) from test&quot;);
        assertThat(response.rows()[0][0], is(0L));

    }

    @Test
    public void testSelectFormatFunction() throws Exception {
        execute(&quot;create table tbl (name text, kind text)&quot;);
        execute(&quot;insert into tbl (name, kind) values ('', 'Planet'), ('Aldebaran', 'Star System'), ('Algol', 'Star System')&quot;);
        execute(&quot;refresh table tbl&quot;);
        execute(&quot;select format('%s is a %s', name, kind) as sentence from tbl order by name&quot;);
        assertThat(response.cols(), Matchers.arrayContaining(&quot;sentence&quot;));
        assertThat(printedTable(response.rows()), is(
            &quot; is a Planet\n&quot; +
            &quot;Aldebaran is a Star System\n&quot; +
            &quot;Algol is a Star System\n&quot;
        ));

    }

    @Test
    public void testAnyArray() throws Exception {
        this.setup.setUpArrayTables();

        execute(&quot;select count(*) from any_table where 'Berlin' = ANY (names)&quot;);
        assertThat((Long) response.rows()[0][0], is(2L));

        execute(&quot;select id, names from any_table where 'Berlin' = ANY (names) order by id&quot;);
        assertThat(response.rowCount(), is(2L));
        assertThat((Integer) response.rows()[0][0], is(1));
        assertThat((Integer) response.rows()[1][0], is(3));

        execute(&quot;select id from any_table where 'Berlin' != ANY (names) order by id&quot;);
        assertThat(response.rowCount(), is(3L));
        assertThat((Integer) response.rows()[0][0], is(1));
        assertThat((Integer) response.rows()[1][0], is(2));
        assertThat((Integer) response.rows()[2][0], is(3));

        execute(&quot;select count(id) from any_table where 0.0 &lt; ANY (temps)&quot;);
        assertThat((Long) response.rows()[0][0], is(2L));

        execute(&quot;select id, names from any_table where 0.0 &lt; ANY (temps) order by id&quot;);
        assertThat(response.rowCount(), is(2L));
        assertThat((Integer) response.rows()[0][0], is(2));
        assertThat((Integer) response.rows()[1][0], is(3));

        execute(&quot;select count(*) from any_table where 0.0 &gt; ANY (temps)&quot;);
        assertThat((Long) response.rows()[0][0], is(2L));

        execute(&quot;select id, names from any_table where 0.0 &gt; ANY (temps) order by id&quot;);
        assertThat(response.rowCount(), is(2L));
        assertThat((Integer) response.rows()[0][0], is(2));
        assertThat((Integer) response.rows()[1][0], is(3));

        execute(&quot;select id, names from any_table where 'Ber%' LIKE ANY (names) order by id&quot;);
        assertThat(response.rowCount(), is(2L));
        assertThat((Integer) response.rows()[0][0], is(1));
        assertThat((Integer) response.rows()[1][0], is(3));

    }

    @Test
    public void testNotAnyArray() throws Exception {
        this.setup.setUpArrayTables();

        execute(&quot;select id from any_table where NOT 'Hangelsberg' = ANY (names) order by id&quot;);
        assertThat(response.rowCount(), is(2L));
        assertThat((Integer) response.rows()[0][0], is(1));
        assertThat((Integer) response.rows()[1][0], is(2));

        execute(&quot;select id from any_table where 'Hangelsberg' != ANY (names) order by id&quot;);
        assertThat(response.rowCount(), is(3L));
        assertThat((Integer) response.rows()[0][0], is(1));
        assertThat((Integer) response.rows()[1][0], is(2));
        assertThat((Integer) response.rows()[2][0], is(3));
    }

    @Test
    public void testAnyLike() throws Exception {
        this.setup.setUpArrayTables();

        execute(&quot;select id from any_table where 'kuh%' LIKE ANY (tags) order by id&quot;);
        assertThat(response.rowCount(), is(2L));
        assertThat((Integer) response.rows()[0][0], is(3));
        assertThat((Integer) response.rows()[1][0], is(4));

        execute(&quot;select id from any_table where 'kuh%' NOT LIKE ANY (tags) order by id&quot;);
        assertThat(response.rowCount(), is(3L));
        assertThat((Integer) response.rows()[0][0], is(1));
        assertThat((Integer) response.rows()[1][0], is(2));
        assertThat((Integer) response.rows()[2][0], is(3));

    }

    @Test
    public void testInsertAndSelectIpType() throws Exception {
        execute(&quot;create table ip_table (fqdn string, addr ip) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into ip_table (fqdn, addr) values ('localhost', '127.0.0.1'), ('crate.io', '23.235.33.143')&quot;);
        execute(&quot;refresh table ip_table&quot;);

        execute(&quot;select addr from ip_table where addr = '23.235.33.143'&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat((String) response.rows()[0][0], is(&quot;23.235.33.143&quot;));

        execute(&quot;select addr from ip_table where addr &gt; '127.0.0.1'&quot;);
        assertThat(response.rowCount(), is(0L));
        execute(&quot;select addr from ip_table where addr &gt; 2130706433&quot;); // 2130706433 == 127.0.0.1
        assertThat(response.rowCount(), is(0L));

        execute(&quot;select addr from ip_table where addr &lt; '127.0.0.1'&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat((String) response.rows()[0][0], is(&quot;23.235.33.143&quot;));
        execute(&quot;select addr from ip_table where addr &lt; 2130706433&quot;); // 2130706433 == 127.0.0.1
        assertThat(response.rowCount(), is(1L));
        assertThat((String) response.rows()[0][0], is(&quot;23.235.33.143&quot;));

        execute(&quot;select addr from ip_table where addr &lt;= '127.0.0.1'&quot;);
        assertThat(response.rowCount(), is(2L));

        execute(&quot;select addr from ip_table where addr &gt;= '23.235.33.143'&quot;);
        assertThat(response.rowCount(), is(2L));

        execute(&quot;select addr from ip_table where addr IS NULL&quot;);
        assertThat(response.rowCount(), is(0L));

        execute(&quot;select addr from ip_table where addr IS NOT NULL&quot;);
        assertThat(response.rowCount(), is(2L));

    }

    @Test
    public void testGroupByOnIpType() throws Exception {
        execute(&quot;create table t (i ip) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (i) values ('192.168.1.2'), ('192.168.1.2'), ('192.168.1.3')&quot;);
        execute(&quot;refresh table t&quot;);
        execute(&quot;select i, count(*) from t group by 1 order by count(*) desc&quot;);

        assertThat(response.rowCount(), is(2L));
        assertThat((String) response.rows()[0][0], is(&quot;192.168.1.2&quot;));
        assertThat((Long) response.rows()[0][1], is(2L));
        assertThat((String) response.rows()[1][0], is(&quot;192.168.1.3&quot;));
        assertThat((Long) response.rows()[1][1], is(1L));
    }

    @Test
    public void testInsertAndSelectGeoType() throws Exception {
        execute(&quot;create table geo_point_table (id int primary key, p geo_point) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into geo_point_table (id, p) values (?, ?)&quot;, new Object[]{1, new Double[]{47.22, 12.09}});
        execute(&quot;insert into geo_point_table (id, p) values (?, ?)&quot;, new Object[]{2, new Double[]{57.22, 7.12}});
        refresh();

        execute(&quot;select p from geo_point_table order by id desc&quot;);

        assertThat(response.rowCount(), is(2L));
        Point p1 = (Point) response.rows()[0][0];
        assertThat(p1.getX(), closeTo(57.22, 0.01));
        assertThat(p1.getY(), closeTo(7.12, 0.01));

        Point p2 = (Point) response.rows()[1][0];
        assertThat(p2.getX(), closeTo(47.22, 0.01));
        assertThat(p2.getY(), closeTo(12.09, 0.01));
    }

    @Test
    public void testGeoTypeQueries() throws Exception {
        // setup
        execute(&quot;create table t (id int primary key, i int, p geo_point) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (id, i, p) values (1, 1, 'POINT (10 20)')&quot;);
        execute(&quot;insert into t (id, i, p) values (2, 1, 'POINT (11 21)')&quot;);
        refresh();

        // order by
        execute(&quot;select distance(p, 'POINT (11 21)') from t order by 1&quot;);
        assertThat(response.rowCount(), is(2L));

        Double result1 = (Double) response.rows()[0][0];
        Double result2 = (Double) response.rows()[1][0];

        assertThat(result1, is(0.0d));
        assertThat(result2, is(152354.32308347954));

        String stmtOrderBy = &quot;SELECT id &quot; +
                             &quot;FROM t &quot; +
                             &quot;ORDER BY distance(p, 'POINT(30.0 30.0)')&quot;;
        execute(stmtOrderBy);
        assertThat(response.rowCount(), is(2L));
        String expectedOrderBy =
            &quot;2\n&quot; +
            &quot;1\n&quot;;
        assertEquals(expectedOrderBy, printedTable(response.rows()));

        // aggregation (max())
        String stmtAggregate = &quot;SELECT i, max(distance(p, 'POINT(30.0 30.0)')) &quot; +
                               &quot;FROM t &quot; +
                               &quot;GROUP BY i&quot;;
        execute(stmtAggregate);
        assertThat(response.rowCount(), is(1L));
        String expectedAggregate = &quot;1| 2296582.8899438097\n&quot;;
        assertEquals(expectedAggregate, printedTable(response.rows()));

        Point point;
        // queries
        execute(&quot;select p from t where distance(p, 'POINT (11 21)') &gt; 0.0&quot;);
        assertThat(response.rowCount(), is(1L));
        point = (Point) response.rows()[0][0];
        assertThat(point.getX(), closeTo(10.0d, 0.01));
        assertThat(point.getY(), closeTo(20.0d, 0.02));

        execute(&quot;select p from t where distance(p, 'POINT (11 21)') &lt; 10.0&quot;);
        assertThat(response.rowCount(), is(1L));
        point = (Point) response.rows()[0][0];
        assertThat(point.getX(), closeTo(11.0d, 0.01));
        assertThat(point.getY(), closeTo(21.0d, 0.01));

        execute(&quot;select p from t where distance(p, 'POINT (11 21)') &lt; 10.0 or distance(p, 'POINT (11 21)') &gt; 10.0&quot;);
        assertThat(response.rowCount(), is(2L));

        execute(&quot;select p from t where distance(p, 'POINT (10 20)') &gt;= 0.0 and distance(p, 'POINT (10 20)') &lt;= 0.1&quot;);
        assertThat(response.rowCount(), is(1L));
        point = (Point) response.rows()[0][0];
        assertThat(point.getX(), closeTo(10.0d, 0.01));
        assertThat(point.getY(), closeTo(20.0d, 0.01));

        execute(&quot;select p from t where distance(p, 'POINT (10 20)') = 0.0&quot;);
        assertThat(response.rowCount(), is(1L));
        point = (Point) response.rows()[0][0];
        assertThat(point.getX(), closeTo(10.0d, 0.01));
        assertThat(point.getY(), closeTo(20.0d, 0.01));

        execute(&quot;select p from t where distance(p, 'POINT (10 20)') = 152354.3209044634&quot;);
        Point p = (Point) response.rows()[0][0];
        assertThat(p.getX(), closeTo(11.0, 0.01));
        assertThat(p.getY(), closeTo(21.0, 0.01));
    }

    @Test
    @UseJdbc(0) // test-layer converts Map to string, but for geo-shape strings should be WKT, not JSON.
    public void testWithinQuery() throws Exception {
        execute(&quot;create table t (id int primary key, p geo_point) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (id, p) values (1, 'POINT (10 10)')&quot;);
        refresh();

        execute(&quot;select within(p, 'POLYGON (( 5 5, 30 5, 30 30, 5 30, 5 5 ))') from t&quot;);
        assertThat((Boolean) response.rows()[0][0], is(true));

        execute(&quot;select * from t where within(p, 'POLYGON (( 5 5, 30 5, 30 30, 5 30, 5 5 ))')&quot;);
        assertThat(response.rowCount(), is(1L));
        execute(&quot;select * from t where within(p, ?)&quot;, $(Map.of(
            &quot;type&quot;, &quot;Polygon&quot;,
            &quot;coordinates&quot;, new double[][][]{
                {
                    {5.0, 5.0},
                    {30.0, 5.0},
                    {30.0, 30.0},
                    {5.0, 30.0},
                    {5.0, 5.0}
                }
            }
        )));
        assertThat(response.rowCount(), is(1L));

        execute(&quot;select * from t where within(p, 'POLYGON (( 5 5, 30 5, 30 30, 5 30, 5 5 ))') = false&quot;);
        assertThat(response.rowCount(), is(0L));
    }

    @Test
    public void testTwoSubStrOnSameColumn() throws Exception {
        execute(&quot;select substr(name, 0, 4), substr(name, 4, 8) from sys.cluster&quot;);
        assertThat(printedTable(response.rows()), is(&quot;SUIT| TE-TEST_\n&quot;));
    }


    @Test
    public void testSelectArithMetricOperatorInOrderBy() throws Exception {
        execute(&quot;create table t (i integer, l long, d double) clustered into 3 shards with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (i, l, d) values (1, 2, 90.5), (2, 5, 90.5), (193384, 31234594433, 99.0), (10, 21, 99.0), (-1, 4, 99.0)&quot;);
        refresh();

        execute(&quot;select i, i%3 from t order by i%3, l&quot;);
        assertThat(response.rowCount(), is(5L));
        assertThat(printedTable(response.rows()), is(
            &quot;-1| -1\n&quot; +
            &quot;1| 1\n&quot; +
            &quot;10| 1\n&quot; +
            &quot;193384| 1\n&quot; +
            &quot;2| 2\n&quot;));
    }

    @Test
    public void testSelectFailingSearchScript() throws Exception {
        execute(&quot;create table t (i integer, l long, d double) clustered into 1 shards with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (i, l, d) values (1, 2, 90.5)&quot;);
        refresh();

        assertThrowsMatches(() -&gt; execute(&quot;select log(d, l) from t where log(d, -1) &gt;= 0&quot;),
                     isSQLError(is(&quot;log(x, b): given arguments would result in: 'NaN'&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000));
    }

    @Test
    public void testSelectGroupByFailingSearchScript() throws Exception {
        execute(&quot;create table t (i integer, l long, d double) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (i, l, d) values (1, 2, 90.5), (0, 4, 100)&quot;);
        execute(&quot;refresh table t&quot;);

        assertThrowsMatches(() -&gt; execute(&quot;select log(d, l) from t where log(d, -1) &gt;= 0 group by log(d, l)&quot;),
                     isSQLError(is(&quot;log(x, b): given arguments would result in: 'NaN'&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000));

    }

    @Test
    public void testNumericScriptOnAllTypes() {
        // this test validates that no exception is thrown
        execute(
            &quot;create table t (&quot; +
            &quot;   b byte,&quot; +
            &quot;   s short,&quot; +
            &quot;   i integer,&quot; +
            &quot;   l long,&quot; +
            &quot;   f float,&quot; +
            &quot;   d double,&quot; +
            &quot;   t timestamp with time zone&quot; +
            &quot;) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (b, s, i, l, f, d, t) values (1, 2, 3, 4, 5.7, 6.3, '2014-07-30')&quot;);
        refresh();

        String[] functionCalls = new String[]{
            &quot;abs(%s)&quot;,
            &quot;ceil(%s)&quot;,
            &quot;floor(%s)&quot;,
            &quot;ln(%s)&quot;,
            &quot;log(%s)&quot;,
            &quot;log(%s, 2)&quot;,
            &quot;random()&quot;,
            &quot;round(%s)&quot;,
            &quot;sqrt(%s)&quot;
        };

        for (String functionCall : functionCalls) {
            String byteCall = String.format(Locale.ENGLISH, functionCall, &quot;b&quot;);
            execute(String.format(Locale.ENGLISH, &quot;select %s, b from t where %s &lt; 2&quot;, byteCall, byteCall));

            String shortCall = String.format(Locale.ENGLISH, functionCall, &quot;s&quot;);
            execute(String.format(Locale.ENGLISH, &quot;select %s, s from t where %s &lt; 2&quot;, shortCall, shortCall));

            String intCall = String.format(Locale.ENGLISH, functionCall, &quot;i&quot;);
            execute(String.format(Locale.ENGLISH, &quot;select %s, i from t where %s &lt; 2&quot;, intCall, intCall));

            String longCall = String.format(Locale.ENGLISH, functionCall, &quot;l&quot;);
            execute(String.format(Locale.ENGLISH, &quot;select %s, l from t where %s &lt; 2&quot;, longCall, longCall));

            String floatCall = String.format(Locale.ENGLISH, functionCall, &quot;f&quot;);
            execute(String.format(Locale.ENGLISH, &quot;select %s, f from t where %s &lt; 2&quot;, floatCall, floatCall));

            String doubleCall = String.format(Locale.ENGLISH, functionCall, &quot;d&quot;);
            execute(String.format(Locale.ENGLISH, &quot;select %s, d from t where %s &lt; 2&quot;, doubleCall, doubleCall));
        }
    }

    @Test
    public void testWhereColumnEqColumnAndFunctionEqFunction() throws Exception {
        execute(&quot;create table tbl (name text)&quot;);
        execute(&quot;insert into tbl (name) values ('Arthur'), ('Trillian')&quot;);
        execute(&quot;refresh table tbl&quot;);

        execute(&quot;select name from tbl where name = name&quot;);
        assertThat(response.rowCount(), is(2L));

        execute(&quot;select name from tbl where substr(name, 1, 1) = substr(name, 1, 1)&quot;);
        assertThat(response.rowCount(), is(2L));
    }

    @Test
    public void testNewColumn() throws Exception {
        execute(&quot;create table t (name string) with (number_of_replicas=0, column_policy = 'dynamic')&quot;);
        execute(&quot;insert into t (name, score) values ('Ford', 1.2)&quot;);
    }

    @Test
    public void testESGetSourceColumns() throws Exception {
        this.setup.setUpLocations();
        ensureYellow();
        refresh();

        execute(&quot;select _id, _version from locations where id=2&quot;);
        assertNotNull(response.rows()[0][0]);
        assertNotNull(response.rows()[0][1]);

        execute(&quot;select _id, name from locations where id=2&quot;);
        assertNotNull(response.rows()[0][0]);
        assertNotNull(response.rows()[0][1]);

        execute(&quot;select _id, _doc from locations where id=2&quot;);
        assertNotNull(response.rows()[0][0]);
        assertNotNull(response.rows()[0][1]);

        execute(&quot;select _doc, id from locations where id in (2,3) order by id&quot;);
        Map&lt;String, Object&gt; _doc1 = (Map&lt;String, Object&gt;) response.rows()[0][0];
        Map&lt;String, Object&gt; _doc2 = (Map&lt;String, Object&gt;) response.rows()[1][0];
        assertEquals(_doc1.get(&quot;id&quot;), &quot;2&quot;);
        assertEquals(_doc2.get(&quot;id&quot;), &quot;3&quot;);

        execute(&quot;select name, kind from locations where id in (2,3) order by id&quot;);
        assertEquals(printedTable(response.rows()), &quot;Outer Eastern Rim| Galaxy\n&quot; +
                                                    &quot;Galactic Sector QQ7 Active J Gamma| Galaxy\n&quot;);

        execute(&quot;select name, kind, _id from locations where id in (2,3) order by id&quot;);
        assertEquals(printedTable(response.rows()), &quot;Outer Eastern Rim| Galaxy| 2\n&quot; +
                                                    &quot;Galactic Sector QQ7 Active J Gamma| Galaxy| 3\n&quot;);

        execute(&quot;select _raw, id from locations where id in (2,3) order by id&quot;);
        Map&lt;String, Object&gt; firstRaw = JsonXContent.JSON_XCONTENT.createParser(
            NamedXContentRegistry.EMPTY,
            DeprecationHandler.THROW_UNSUPPORTED_OPERATION,
            (String) response.rows()[0][0]).map();

        assertThat(response.rows()[0][1], is(&quot;2&quot;));
        assertThat(firstRaw.get(&quot;id&quot;), is(&quot;2&quot;));
        assertThat(firstRaw.get(&quot;name&quot;), is(&quot;Outer Eastern Rim&quot;));
        assertThat(firstRaw.get(&quot;date&quot;), is(308534400000L));
        assertThat(firstRaw.get(&quot;kind&quot;), is(&quot;Galaxy&quot;));

        Map&lt;String, Object&gt; secondRaw = JsonXContent.JSON_XCONTENT.createParser(
            NamedXContentRegistry.EMPTY,
            DeprecationHandler.THROW_UNSUPPORTED_OPERATION,
            (String) response.rows()[1][0]).map();
        assertThat(response.rows()[1][1], is(&quot;3&quot;));
        assertThat(secondRaw.get(&quot;id&quot;), is(&quot;3&quot;));
        assertThat(secondRaw.get(&quot;name&quot;), is(&quot;Galactic Sector QQ7 Active J Gamma&quot;));
        assertThat(secondRaw.get(&quot;date&quot;), is(1367366400000L));
        assertThat(secondRaw.get(&quot;kind&quot;), is(&quot;Galaxy&quot;));
    }

    @Test
    @UseRandomizedSchema(random = false)
    public void testUnknownTableJobGetsRemoved() throws Exception {
        String uniqueId = UUID.randomUUID().toString();
        String stmtStr = &quot;select '&quot; + uniqueId + &quot;' from foobar&quot;;
        String stmtStrWhere = &quot;select ''&quot; + uniqueId + &quot;'' from foobar&quot;;
        assertThrowsMatches(() -&gt; execute(stmtStr),
                     isSQLError(containsString(&quot;Relation 'foobar' unknown&quot;),
                                UNDEFINED_TABLE,
                                NOT_FOUND,
                                4041));
        execute(&quot;select stmt from sys.jobs where stmt='&quot; + stmtStrWhere + &quot;'&quot;);
        assertEquals(response.rowCount(), 0L);
    }

    @Test
    public void testInsertAndCopyHaveSameIdGeneration() throws Exception {
        execute(&quot;create table t (&quot; +
                &quot;id1 long primary key,&quot; +
                &quot;id2 long primary key,&quot; +
                &quot;ts timestamp with time zone primary key,&quot; +
                &quot;n string) &quot; +
                &quot;clustered by (id2)&quot;);
        ensureYellow();

        execute(&quot;insert into t (id1, id2, ts, n) values (176406344, 1825712027, 1433635200000, 'foo')&quot;);
        try {
            execute(&quot;insert into t (id1, id2, ts, n) values (176406344, 1825712027, 1433635200000, 'bar')&quot;);
            fail(&quot;should fail because document exists already&quot;);
        } catch (Exception e) {
            // good
        }
        execute(&quot;refresh table t&quot;);

        File file = folder.newFolder();
        String uriTemplate = Paths.get(file.toURI()).toUri().toString();
        execute(&quot;copy t to directory ?&quot;, new Object[]{uriTemplate});
        execute(&quot;copy t from ? with (shared=true)&quot;, new Object[]{uriTemplate + &quot;/*&quot;});
        execute(&quot;refresh table t&quot;);

        execute(&quot;select _id, * from t&quot;);
        assertThat(response.rowCount(), is(1L));
    }


    @Test
    public void testSelectFrom_Doc() throws Exception {
        execute(&quot;create table t (name string) with (number_of_replicas = 0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (name) values ('Marvin')&quot;);
        execute(&quot;refresh table t&quot;);

        execute(&quot;select _doc['name'] from t&quot;);
        assertThat(((String) response.rows()[0][0]), is(&quot;Marvin&quot;));
    }

    @Test
    public void testSelectWithSingleBulkArgRaisesUnsupportedError() {
        assertThrowsMatches(() -&gt;  execute(&quot;select * from sys.cluster&quot;, new Object[0][]),
                     isSQLError(is(&quot;Bulk operations for statements that return result sets is not supported&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4004));
    }

    @Test
    public void testSelectWithBulkArgsRaisesUnsupportedError() {
        assertThrowsMatches(() -&gt; execute(&quot;select * from sys.cluster&quot;, new Object[][]{new Object[]{1}, new Object[]{2}}),
                     isSQLError(is(&quot;Bulk operations for statements that return result sets is not supported&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4004));
    }

    @Test
    public void testWeirdIdentifiersAndLiterals() throws Exception {
        execute(&quot;CREATE TABLE with_quote (\&quot;\&quot;\&quot;\&quot; string) clustered into 1 shards with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;INSERT INTO with_quote (\&quot;\&quot;\&quot;\&quot;) VALUES ('''')&quot;);
        execute(&quot;REFRESH TABLE with_quote&quot;);
        execute(&quot;SELECT * FROM with_quote&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat(response.cols(), is(arrayContaining(&quot;\&quot;&quot;)));
        assertThat((String) response.rows()[0][0], is(&quot;'&quot;));
    }

    @Test
    public void testWhereNotNull() throws Exception {
        execute(&quot;create table t (b boolean, i int) with (number_of_replicas=0)&quot;);
        execute(&quot;insert into t (b, i) values (true, 1), (false, 2), (null, null)&quot;);
        execute(&quot;refresh table t&quot;);

        execute(&quot;select b, not b, not (b &gt; i::boolean) from t order by b&quot;);
        Object[][] rows = response.rows();
        assertThat((Boolean) rows[0][0], is(false));
        assertThat((Boolean) rows[0][1], is(true));
        assertThat((Boolean) rows[0][2], is(true));
        assertThat((Boolean) rows[1][0], is(true));
        assertThat((Boolean) rows[1][1], is(false));
        assertThat((Boolean) rows[1][2], is(true));
        assertThat(rows[2][0], nullValue());
        assertThat(rows[2][1], nullValue());
        assertThat(rows[2][2], nullValue());

        execute(&quot;select b, i from t where not b&quot;);
        assertThat(response.rowCount(), is(1L));

        execute(&quot;select b, i from t where not b &gt; i::boolean&quot;);
        assertThat(response.rowCount(), is(2L));

        execute(&quot;SELECt b, i FROM t WHERE NOT (i = 1 AND b = TRUE)&quot;);
        assertThat(response.rowCount(), is(1L));

        execute(&quot;SELECT b, i FROM t WHERE NOT (i IS NULL OR b IS NULL)&quot;);
        assertThat(response.rowCount(), is(2L));

        execute(&quot;SELECT b FROM t WHERE NOT (coalesce(b, true))&quot;);
        assertThat(response.rowCount(), is(1L));

        execute(&quot;SELECT b, i FROM t WHERE NOT (coalesce(b, false) = true AND i IS NULL)&quot;);
        assertThat(response.rowCount(), is(2L));

    }

    @Test
    public void testScalarEvaluatesInErrorOnDocTable() throws Exception {
        execute(&quot;create table t1 (id int) with (number_of_replicas=0)&quot;);
        ensureYellow();
        // we need at least 1 row, otherwise the table is empty and no evaluation occurs
        execute(&quot;insert into t1 (id) values (1)&quot;);
        refresh();

        assertThrowsMatches(() -&gt; execute(&quot;select 1/0 from t1&quot;),
                     isSQLError(is(&quot;/ by zero&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000));
    }

    /**
     * If the WHERE CLAUSE results in a NO MATCH, no expression evaluation error will be thrown as nothing is evaluated.
     * This is different from e.g. postgres where evaluation always occurs.
     */
    @Test
    public void testScalarEvaluatesInErrorOnDocTableNoMatch() throws Exception {
        execute(&quot;create table t1 (id int) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;select 1/0 from t1 where true = false&quot;);
        assertThat(response.rowCount(), is(0L));
    }

    @Test
    public void testOrderByWorksOnSymbolWithLateNormalization() throws Exception {
        execute(&quot;create table t (x int) with (number_of_replicas = 0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (x) values (5), (10), (3)&quot;);
        execute(&quot;refresh table t&quot;);

        // cast is added to have a to_int(2) after the subquery is inserted
        // this causes a normalization on the map-side which used to remove the order by
        execute(&quot;select cast((select 2) as integer) * x from t order by 1&quot;);
        assertThat(printedTable(response.rows()),
            is(&quot;6\n&quot; +
               &quot;10\n&quot; +
               &quot;20\n&quot;));
    }

    @Test
    public void testOrderOnAnalyzedColumn() {
        execute(&quot;create table t (text string index using fulltext) with (number_of_replicas = 0)&quot;);
        execute(&quot;insert into t (text) values ('Hello World'), ('The End')&quot;);
        execute(&quot;refresh table t&quot;);

        assertThat(
            printedTable(execute(&quot;select text from t order by 1 desc&quot;).rows()),
            is(&quot;The End\n&quot; +
               &quot;Hello World\n&quot;)
        );
    }

    @Test
    public void test_values_as_top_level_relation() {
        execute(&quot;VALUES (1, 'a'), (2, 'b'), (3, (SELECT 'c'))&quot;);
        assertThat(
            printedTable(response.rows()),
            is(&quot;1| a\n&quot; +
               &quot;2| b\n&quot; +
               &quot;3| c\n&quot;)
        );
    }


    @Test
    public void test_select_with_explicit_high_limit_and_query_that_does_not_match_anything_to_trigger_batch_size_optimization() {
        execute(&quot;create table tbl (x int) clustered into 1 shards&quot;);
        Object[][] values = new Object[1001][];
        for (int i = 0; i &lt; values.length; i++) {
            values[i] = new Object[] { i };
        }
        execute(&quot;insert into tbl (x) values (?)&quot;, values);
        execute(&quot;refresh table tbl&quot;);

        // This tests a regression where we optimized the internal batchSize down to 0, which caused a failure as this is
        // not supported by the TopFieldCollector
        execute(&quot;select x from tbl where x &gt; 5000 order by x limit 1500&quot;);
    }

    @Test
    public void test_select_from_virtual_table_with_window_function_and_column_pruning() throws Exception {
        // push down of columns used in WHERE on top of join results in column pruning
        // This triggered a bug in the prune implementation of the WindowAgg operator
        execute(&quot;create table doc.metrics (id int primary key, x int)&quot;);
        execute(&quot;SELECT&quot;
            + &quot;    * &quot;
            + &quot; FROM (&quot;
            + &quot;     SELECT&quot;
            + &quot;         n.nspname,&quot;
            + &quot;         c.relname,&quot;
            + &quot;         a.attname,&quot;
            + &quot;         a.atttypid,&quot;
            + &quot;         a.attnotnull&quot;
            + &quot;         OR (t.typtype = 'd'&quot;
            + &quot;             AND t.typnotnull) AS attnotnull,&quot;
            + &quot;         a.atttypmod,&quot;
            + &quot;         a.attlen,&quot;
            + &quot;         row_number() OVER (PARTITION BY a.attrelid ORDER BY a.attnum) AS attnum,&quot;
            + &quot;         pg_catalog.pg_get_expr(def.adbin, def.adrelid) AS adsrc,&quot;
            + &quot;         dsc.description,&quot;
            + &quot;         t.typbasetype,&quot;
            + &quot;         t.typtype&quot;
            + &quot;     FROM&quot;
            + &quot;         pg_catalog.pg_namespace n&quot;
            + &quot;         JOIN pg_catalog.pg_class c ON (c.relnamespace = n.oid)&quot;
            + &quot;         JOIN pg_catalog.pg_attribute a ON (a.attrelid = c.oid)&quot;
            + &quot;         JOIN pg_catalog.pg_type t ON (a.atttypid = t.oid)&quot;
            + &quot;         LEFT JOIN pg_catalog.pg_attrdef def ON (a.attrelid = def.adrelid&quot;
            + &quot;                 AND a.attnum = def.adnum)&quot;
            + &quot;         LEFT JOIN pg_catalog.pg_description dsc ON (c.oid = dsc.objoid&quot;
            + &quot;                 AND a.attnum = dsc.objsubid)&quot;
            + &quot;         LEFT JOIN pg_catalog.pg_class dc ON (dc.oid = dsc.classoid&quot;
            + &quot;                 AND dc.relname = 'pg_class')&quot;
            + &quot;         LEFT JOIN pg_catalog.pg_namespace dn ON (dc.relnamespace = dn.oid&quot;
            + &quot;                 AND dn.nspname = 'pg_catalog')&quot;
            + &quot;     WHERE&quot;
            + &quot;         c.relkind IN ('r', 'v', 'f', 'm')&quot;
            + &quot;         AND a.attnum &gt; 0&quot;
            + &quot;         AND NOT a.attisdropped&quot;
            + &quot;         AND c.relname LIKE E'metrics') c&quot;
            + &quot; WHERE&quot;
            + &quot;     TRUE&quot;
            + &quot; ORDER BY&quot;
            + &quot;     nspname,&quot;
            + &quot;     c.relname,&quot;
            + &quot;     attnum&quot;);
        assertThat(printedTable(response.rows()),
            is(&quot;doc| metrics| id| 23| false| -1| 4| 1| NULL| NULL| 0| b\n&quot; +
               &quot;doc| metrics| x| 23| false| -1| 4| 2| NULL| NULL| 0| b\n&quot;)
        );
    }

    @Test
    public void test_subscript_on_ignored_object_does_not_raise_missing_key_error() throws Exception {
        execute(&quot;create table tbl (obj object (ignored))&quot;);
        execute(&quot;insert into tbl (obj) values ({a = 10})&quot;);
        execute(&quot;refresh table tbl&quot;);

        execute(&quot;select * from tbl where obj['b'] = 10&quot;);
        assertThat(printedTable(response.rows()), is(&quot;&quot;));

        execute(&quot;select * from (select * from tbl) as t where obj['b'] = 10&quot;);
        assertThat(printedTable(response.rows()), is(&quot;&quot;));
    }


    @Test
    public void test_primary_key_lookup_on_multiple_columns() throws Exception {
        execute(
            &quot;CREATE TABLE doc.test (&quot; +
            &quot;   id TEXT, &quot; +
            &quot;   region_level_1 TEXT, &quot; +
            &quot;   marker_type TEXT, &quot; +
            &quot;   is_auto BOOLEAN,&quot; +
            &quot;   PRIMARY KEY (id, region_level_1, marker_type, is_auto) &quot; +
            &quot;) clustered into 1 shards &quot;
        );
        execute(&quot;insert into doc.test (id, region_level_1, marker_type, is_auto) values ('1', '2', '3', false)&quot;);
        execute(&quot;refresh table doc.test&quot;);
        execute(&quot;explain select id from doc.test where id = '1' and region_level_1 = '2' and marker_type = '3' and is_auto = false;&quot;);
        assertThat(printedTable(response.rows()), is(
            &quot;Get[doc.test | id | DocKeys{'1', '2', '3', false} | ((((id = '1') AND (region_level_1 = '2')) AND (marker_type = '3')) AND (is_auto = false))]\n&quot;
        ));
        execute(&quot;select id from doc.test where id = '1' and region_level_1 = '2' and marker_type = '3' and is_auto = false;&quot;);
        assertThat(printedTable(response.rows()), is(
            &quot;1\n&quot;
        ));
    }

    @Test
    public void test_primary_key_lookup_with_param_that_requires_cast_to_column_type() throws Exception {
        execute(&quot;create table tbl (ts timestamp with time zone primary key, path text primary key)&quot;);
        execute(&quot;INSERT INTO tbl (ts, path) VALUES ('2017-06-21T00:00:00.000000Z', 'c1')&quot;);

        execute(&quot;select _id, path from tbl where ts = '2017-06-21' and path = 'c1'&quot;);
        assertThat(printedTable(response.rows()), is(
            &quot;Ag0xNDk4MDAzMjAwMDAwAmMx| c1\n&quot;
        ));
        execute(&quot;select _id, path from tbl where ts = ? and path = ?&quot;, new Object[] { &quot;2017-06-21&quot;, &quot;c1&quot; });
        assertThat(printedTable(response.rows()), is(
            &quot;Ag0xNDk4MDAzMjAwMDAwAmMx| c1\n&quot;
        ));
    }

    @Test
    public void test_primary_key_lookups_returns_inserted_records() throws Exception {
        int numKeys = randomIntBetween(1, 3);
        Random random = RandomizedContext.current().getRandom();
        StringBuilder createTable = new StringBuilder(&quot;CREATE TABLE tbl (&quot;);
        ArrayList&lt;DataType&lt;?&gt;&gt; types = new ArrayList&lt;&gt;();
        List&lt;DataType&lt;?&gt;&gt; typeCandidates = DataTypes.PRIMITIVE_TYPES.stream()
            .filter(x -&gt; x.storageSupport() != null)
            .collect(Collectors.toList());
        for (int i = 0; i &lt; numKeys; i++) {
            var type = RandomPicks.randomFrom(random, typeCandidates);
            types.add(type);
            createTable.append(&quot;col&quot;);
            createTable.append(i);
            createTable.append(' ');
            createTable.append(type.getName());
            createTable.append(&quot; PRIMARY KEY&quot;);
            if (i + 1 &lt; numKeys) {
                createTable.append(&quot;, &quot;);
            }
        }
        createTable.append(&quot;)&quot;);
        execute(createTable.toString());

        String insert = &quot;INSERT INTO tbl VALUES (&quot;
            + String.join(&quot;, &quot;, Lists2.map(types, ignored -&gt; &quot;?&quot;))
            + &quot;)&quot;;
        Object[] args = new Object[types.size()];
        for (int i = 0; i &lt; types.size(); i++) {
            var type = types.get(i);
            args[i] = DataTypeTesting.getDataGenerator(type).get();
        }
        execute(insert, args);

        StringBuilder selectInlineValues = new StringBuilder(&quot;SELECT 1 FROM tbl WHERE &quot;);
        StringBuilder selectParams = new StringBuilder(&quot;SELECT 1 FROM tbl WHERE &quot;);
        for (int i = 0; i &lt; args.length; i++) {
            var arg = args[i];
            selectInlineValues.append(&quot;col&quot;);
            selectParams.append(&quot;col&quot;);

            selectInlineValues.append(i);
            selectParams.append(i);

            selectInlineValues.append(&quot; = &quot;);
            if (arg instanceof String) {
                selectInlineValues.append(&quot;'&quot;);
                selectInlineValues.append(arg);
                selectInlineValues.append(&quot;'&quot;);
            } else {
                selectInlineValues.append(arg);
            }
            selectParams.append(&quot; = ?&quot;);

            if (i + 1 &lt; args.length) {
                selectInlineValues.append(&quot; AND &quot;);
                selectParams.append(&quot; AND &quot;);
            }
        }

        execute(selectParams.toString(), args);
        assertThat(
            selectParams.toString() + &quot; with values &quot; + Arrays.toString(args) + &quot; must return a record&quot;,
            response.rowCount(),
            is(1L)
        );

        execute(selectInlineValues.toString());
        assertThat(
            selectInlineValues.toString() + &quot; must return a record&quot;,
            response.rowCount(),
            is(1L)
        );
    }


    @Test
    public void test_query_then_fetch_result_order_of_all_columns_matches() throws Exception {
        int numItems = 40;
        Object[][] args = new Object[numItems][];
        for (int i = 0; i &lt; numItems; i++) {
            args[i] = new Object[] { Integer.toString(i), i };
        }
        execute(&quot;create table tbl (x text, y int) clustered into 2 shards&quot;);
        execute(&quot;insert into tbl (x, y) values (?, ?)&quot;, args);
        execute(&quot;refresh table tbl&quot;);
        Object[][] rows = execute(&quot;select x, y from tbl order by y desc&quot;).rows();
        assertThat(
            rows[0],
            Matchers.arrayContaining(Integer.toString(numItems - 1), numItems - 1)
        );
        assertThat(
            rows[1],
            Matchers.arrayContaining(Integer.toString(numItems - 2), numItems - 2)
        );
    }


    @Test
    @UseJdbc(0)
    @UseRandomizedSchema(random = false)
    public void test_bit_string_can_be_inserted_and_queried() throws Exception {
        execute(&quot;create table tbl (xs bit(4))&quot;);
        execute(&quot;insert into tbl (xs) values (B'0000'), (B'0001'), (B'0011'), (B'0111'), (B'1111'), (B'1001')&quot;);
        assertThat(response.rowCount(), is(6L));
        execute(&quot;refresh table tbl&quot;);

        execute(&quot;SELECT _doc['xs'], xs, _raw, xs::bit(3) FROM tbl WHERE xs = B'1001'&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()), is(
            &quot;B'1001'| B'1001'| {\&quot;xs\&quot;:\&quot;CQ==\&quot;}| B'100'\n&quot;
        ));
        // use LIMIT 1 to hit a different execution path that should load `xs` differently
        execute(&quot;SELECT _doc['xs'], xs, _raw, xs::bit(3) FROM tbl WHERE xs = B'1001' LIMIT 1&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()), is(
            &quot;B'1001'| B'1001'| {\&quot;xs\&quot;:\&quot;CQ==\&quot;}| B'100'\n&quot;
        ));

        var properties = new Properties();
        properties.put(&quot;user&quot;, &quot;crate&quot;);
        properties.put(&quot;password&quot;, &quot;&quot;);
        ArrayList&lt;String&gt; results = new ArrayList&lt;&gt;();
        try (var conn = DriverManager.getConnection(sqlExecutor.jdbcUrl(), properties)) {
            Statement stmt = conn.createStatement();
            ResultSet result = stmt.executeQuery(&quot;select xs from tbl order by xs&quot;);
            while (result.next()) {
                String string = result.getString(1);
                results.add(string);
            }
        }
        assertThat(results, Matchers.contains(
            &quot;B'0000'&quot;,
            &quot;B'0001'&quot;,
            &quot;B'0011'&quot;,
            &quot;B'0111'&quot;,
            &quot;B'1001'&quot;,
            &quot;B'1111'&quot;
        ));
    }

    @Test
    public void test_can_insert_and_select_bit_string_arrays() throws Exception {
        execute(&quot;create table tbl (xs array(bit(3)))&quot;);
        execute(&quot;insert into tbl (xs) values ([B'010', B'110'])&quot;);
        execute(&quot;refresh table tbl&quot;);
        execute(&quot;select xs from tbl&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()), is(
            &quot;[B'010', B'110']\n&quot;
        ));
    }

    @Test
    public void test_can_select_and_order_by_doc_expression() throws Exception {
        execute(&quot;create table tbl (x int)&quot;);
        execute(&quot;insert into tbl (x) values (1), (2), (3)&quot;);
        execute(&quot;refresh table tbl&quot;);
        execute(&quot;select _doc['x'] from tbl order by 1&quot;);
        assertThat(printedTable(response.rows()), is(
            &quot;1\n&quot; +
            &quot;2\n&quot; +
            &quot;3\n&quot;
        ));

    }

    /**
     * Test a regression resulting in unusable object type column/table
     */
    @Test
    public void test_can_use_object_with_inner_column_containing_spaces_and_quotes() {
        execute(&quot;CREATE TABLE t1 (o object as (\&quot;my first \&quot;\&quot; field\&quot; text))&quot;);
        execute(&quot;INSERT INTO t1 (o) VALUES ({\&quot;my first \&quot;\&quot; field\&quot; = 'foo'})&quot;);
        refresh();
        execute(&quot;SELECT o FROM t1&quot;);
        assertThat(printedTable(response.rows()), Matchers.is(&quot;{my first \&quot; field=foo}\n&quot;));
        execute(&quot;SELECT o['my first \&quot; field'] FROM t1&quot;);
        assertThat(printedTable(response.rows()), Matchers.is(&quot;foo\n&quot;));
    }

    /**
     * https://github.com/crate/crate/issues/12081
     */
    @Test
    public void test_subcolumn_can_contain_brackets_in_inserts() {
        execute(&quot;create table doc.obj (obj OBJECT);&quot;);
        execute(&quot;insert into doc.obj (obj) VALUES ('{\&quot;(\&quot;: 1.0}');&quot;);
        execute(&quot;insert into doc.obj (obj) VALUES ('{\&quot;(\&quot;: 1.0}');&quot;);
        refresh();
        execute(&quot;SELECT count(*) FROM doc.obj&quot;);
        assertThat(printedTable(response.rows()), Matchers.is(&quot;2\n&quot;));
        execute(&quot;SELECT obj FROM doc.obj limit 1&quot;);
        assertThat(printedTable(response.rows()), Matchers.is(&quot;{(=1.0}\n&quot;));
    }


    @Test
    public void test_double_quotes_in_column_names_and_insert_values() {
        execute(&quot;create table doc.test (\&quot;\&quot;\&quot;\&quot; text);&quot;);
        execute(&quot;insert into doc.test VALUES ('\&quot;\&quot;')&quot;);
        refresh();
        execute(&quot;SELECT \&quot;\&quot;\&quot;\&quot; FROM doc.test&quot;);
        assertThat(printedTable(response.rows()), Matchers.is(&quot;\&quot;\&quot;\n&quot;));
    }

}
</PRE>
</div>
  </div>
</body>
</html>
