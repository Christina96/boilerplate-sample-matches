<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for Optimizer_1.java &amp; TransportSQLActionTest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for Optimizer_1.java &amp; TransportSQLActionTest.java
      </h3>
<h1 align="center">
        1.8%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>Optimizer_1.java (13.77551%)<th>TransportSQLActionTest.java (1.0173323%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(22-51)<td><a href="#" name="0">(22-50)</a><td align="center"><font color="#ff0000">27</font>
</td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>Optimizer_1.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>package io.crate.planner.optimizer.symbol;
2 import java.util.ArrayDeque;
3 import java.util.Deque;
4 import java.util.List;
5 import java.util.function.Function;
6 import java.util.function.Supplier;
7 import io.crate.expression.symbol.AliasResolver;
8 import org.apache.logging.log4j.LogManager;
9 import org.apache.logging.log4j.Logger;
10 import org.elasticsearch.Version;
11 import io.crate.analyze.expressions.ExpressionAnalyzer;
12 import io.crate.common.collections.Lists2;
13 import io.crate.exceptions.ConversionException;
14 import io.crate.expression.symbol.FunctionCopyVisitor;
15 import io.crate.expression.symbol.Symbol;
16 import io.crate.metadata.CoordinatorTxnCtx;
17 import io.crate.metadata.NodeContext;
18 import io.crate.planner.PlannerContext;
19 import io.crate.planner.optimizer.matcher.Captures;
20 import io.crate.planner.optimizer.matcher.Match;
21 import io.crate.planner.optimizer.symbol.rule.MoveArrayLengthOnReferenceCastToLiteralCastInsideOperators;
22 import io.crate.planner.optimizer.symbol.rule.MoveReferenceCastToLiteralCastOnAnyOperatorsWhenLeftIsReference;
23 import io.crate.planner.optimizer.symbol.rule.MoveReferenceCastToLiteralCastOnAnyOperatorsWhenRightIsReference;
24 import io.crate.planner.optimizer.symbol.rule.MoveSubscriptOnReferenceCastToLiteralCastInsideOperators;
25 import io.crate.planner.optimizer.symbol.rule.SimplifyEqualsOperationOnIdenticalReferences;
26 import io.crate.planner.optimizer.symbol.rule.SwapCastsInComparisonOperators;
27 import</b></font> io.crate.planner.optimizer.symbol.rule.SwapCastsInLikeOperators;
28 public class Optimizer {
29     public static Symbol optimizeCasts(Symbol query, PlannerContext plannerContext) {
30         Optimizer optimizer = new Optimizer(
31             plannerContext.transactionContext(),
32             plannerContext.nodeContext(),
33             () -&gt; plannerContext.clusterState().nodes().getMinNodeVersion(),
34             List.of(
35                 SwapCastsInComparisonOperators::new,
36                 SwapCastsInLikeOperators::new,
37                 MoveReferenceCastToLiteralCastOnAnyOperatorsWhenRightIsReference::new,
38                 MoveReferenceCastToLiteralCastOnAnyOperatorsWhenLeftIsReference::new,
39                 MoveSubscriptOnReferenceCastToLiteralCastInsideOperators::new,
40                 MoveArrayLengthOnReferenceCastToLiteralCastInsideOperators::new,
41                 SimplifyEqualsOperationOnIdenticalReferences::new
42             )
43         );
44         return optimizer.optimize(query);
45     }
46     private static final Logger LOGGER = LogManager.getLogger(Optimizer.class);
47     private final List&lt;Rule&lt;?&gt;&gt; rules;
48     private final Supplier&lt;Version&gt; minNodeVersionInCluster;
49     private final NodeContext nodeCtx;
50     private final Visitor visitor = new Visitor();
51     public Optimizer(CoordinatorTxnCtx coordinatorTxnCtx,
52                      NodeContext nodeCtx,
53                      Supplier&lt;Version&gt; minNodeVersionInCluster,
54                      List&lt;Function&lt;FunctionSymbolResolver, Rule&lt;?&gt;&gt;&gt; rules) {
55         FunctionSymbolResolver functionResolver =
56             (f, args) -&gt; {
57                 try {
58                     return ExpressionAnalyzer.allocateFunction(
59                         f,
60                         args,
61                         null,
62                         null,
63                         coordinatorTxnCtx,
64                         nodeCtx);
65                 } catch (ConversionException e) {
66                     return null;
67                 }
68             };
69         this.rules = Lists2.map(rules, r -&gt; r.apply(functionResolver));
70         this.minNodeVersionInCluster = minNodeVersionInCluster;
71         this.nodeCtx = nodeCtx;
72     }
73     public Symbol optimize(Symbol node) {
74         return node.accept(visitor, null);
75     }
76     public Symbol tryApplyRules(Symbol node) {
77         final boolean isTraceEnabled = LOGGER.isTraceEnabled();
78         boolean done = false;
79         int numIterations = 0;
80         while (!done &amp;&amp; numIterations &lt; 10_000) {
81             done = true;
82             Version minVersion = minNodeVersionInCluster.get();
83             for (Rule rule : rules) {
84                 if (minVersion.before(rule.requiredVersion())) {
85                     continue;
86                 }
87                 Match&lt;?&gt; match = rule.pattern().accept(node, Captures.empty());
88                 if (match.isPresent()) {
89                     if (isTraceEnabled) {
90                         LOGGER.trace("Rule '" + rule.getClass().getSimpleName() + "' matched");
91                     }
92                     Symbol transformedNode = rule.apply(match.value(), match.captures(), nodeCtx, visitor.getParentFunction());
93                     if (transformedNode != null) {
94                         if (isTraceEnabled) {
95                             LOGGER.trace("Rule '" + rule.getClass().getSimpleName() + "' transformed the symbol");
96                         }
97                         node = transformedNode;
98                         done = false;
99                     }
100                 }
101             }
102             numIterations++;
103         }
104         assert numIterations &lt; 10_000
105             : "Optimizer reached 10_000 iterations safety guard. This is an indication of a broken rule that matches again and again";
106         return node;
107     }
108     private class Visitor extends FunctionCopyVisitor&lt;Void&gt; {
109         private Deque&lt;io.crate.expression.symbol.Function&gt; visitedFunctions = new ArrayDeque&lt;&gt;();
110         @Override
111         public Symbol visitFunction(io.crate.expression.symbol.Function symbol, Void context) {
112             symbol = (io.crate.expression.symbol.Function) symbol.accept(AliasResolver.INSTANCE, null);
113             visitedFunctions.push(symbol);
114             var maybeTransformedSymbol = tryApplyRules(symbol);
115             if (symbol.equals(maybeTransformedSymbol) == false) {
116                 visitedFunctions.pop();
117                 return maybeTransformedSymbol;
118             }
119             var sym = super.visitFunction(symbol, context);
120             visitedFunctions.pop();
121             return sym;
122         }
123         public Symbol getParentFunction() {
124             if (visitedFunctions.size() &lt; 2) {
125                 return null;
126             }
127             var current = visitedFunctions.pop();
128             var parent = visitedFunctions.peek();
129             visitedFunctions.push(current);
130             return parent;
131         }
132     }
133 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>TransportSQLActionTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>package io.crate.integrationtests;
2 import com.carrotsearch.randomizedtesting.RandomizedContext;
3 import com.carrotsearch.randomizedtesting.generators.RandomPicks;
4 import io.crate.common.collections.Lists2;
5 import io.crate.exceptions.SQLExceptions;
6 import io.crate.testing.DataTypeTesting;
7 import io.crate.testing.TestingHelpers;
8 import io.crate.testing.UseJdbc;
9 import io.crate.testing.UseRandomizedSchema;
10 import io.crate.types.DataType;
11 import io.crate.types.DataTypes;
12 import org.elasticsearch.common.xcontent.DeprecationHandler;
13 import org.elasticsearch.common.xcontent.NamedXContentRegistry;
14 import org.elasticsearch.common.xcontent.json.JsonXContent;
15 import org.elasticsearch.index.IndexNotFoundException;
16 import org.elasticsearch.test.ESIntegTestCase;
17 import org.hamcrest.Matchers;
18 import org.junit.Rule;
19 import org.junit.Test;
20 import org.junit.rules.TemporaryFolder;
21 import org.locationtech.spatial4j.shape.Point;
22 import java.io.File;
23 import java.nio.file.Paths;
24 import java.sql.DriverManager;
25 import java.sql.ResultSet;
26 import java.sql.Statement;
27 import</b></font> java.util.ArrayList;
28 import java.util.Arrays;
29 import java.util.HashMap;
30 import java.util.List;
31 import java.util.Locale;
32 import java.util.Map;
33 import java.util.Properties;
34 import java.util.Random;
35 import java.util.UUID;
36 import java.util.stream.Collectors;
37 import static com.carrotsearch.randomizedtesting.RandomizedTest.$;
38 import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
39 import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_TABLE;
40 import static io.crate.testing.Asserts.assertThrowsMatches;
41 import static io.crate.testing.SQLErrorMatcher.isSQLError;
42 import static io.crate.testing.TestingHelpers.printedTable;
43 import static io.netty.handler.codec.http.HttpResponseStatus.BAD_REQUEST;
44 import static io.netty.handler.codec.http.HttpResponseStatus.NOT_FOUND;
45 import static org.hamcrest.Matchers.arrayContaining;
46 import static org.hamcrest.Matchers.closeTo;
47 import static org.hamcrest.Matchers.containsInAnyOrder;
48 import static org.hamcrest.Matchers.containsString;
49 import static org.hamcrest.Matchers.greaterThan;
50 import static org.hamcrest.Matchers.hasItems;
51 import static org.hamcrest.Matchers.instanceOf;
52 import static org.hamcrest.Matchers.lessThanOrEqualTo;
53 import static org.hamcrest.Matchers.nullValue;
54 import static org.hamcrest.core.Is.is;
55 @ESIntegTestCase.ClusterScope(minNumDataNodes = 2)
56 public class TransportSQLActionTest extends SQLIntegrationTestCase {
57     private Setup setup = new Setup(sqlExecutor);
58     @Rule
59     public TemporaryFolder folder = new TemporaryFolder();
60     private &lt;T&gt; List&lt;T&gt; getCol(Object[][] result, int idx) {
61         ArrayList&lt;T&gt; res = new ArrayList&lt;&gt;(result.length);
62         for (Object[] row : result) {
63             res.add((T) row[idx]);
64         }
65         return res;
66     }
67     @Test
68     public void testSelectResultContainsColumnsInTheOrderOfTheSelectListInTheQuery() throws Exception {
69         execute("create table test (id string primary key)");
70         execute("insert into test (id) values ('id1')");
71         execute("refresh table test");
72         execute("select \"_id\" as b, \"_version\" as a from test");
73         assertArrayEquals(new String[]{"b", "a"}, response.cols());
74         assertEquals(1, response.rowCount());
75     }
76     @Test
77     public void testIndexNotFoundExceptionIsRaisedIfDeletedAfterPlan() throws Throwable {
78         execute("create table t (name string)");
79         ensureYellow();
80         PlanForNode plan = plan("select * from t");
81         execute("drop table t");
82         assertThrowsMatches(() -&gt; execute(plan).getResult(), instanceOf(IndexNotFoundException.class));
83     }
84     @Test
85     public void testDeletePartitionAfterPlan() throws Throwable {
86         execute("CREATE TABLE parted_table (id long, text string, day timestamp with time zone) " +
87                 "PARTITIONED BY (day)");
88         execute("INSERT INTO parted_table (id, text, day) values(1, 'test', '2016-06-07')");
89         ensureYellow();
90         PlanForNode plan = plan("delete from parted_table where day='2016-06-07'");
91         execute("delete from parted_table where day='2016-06-07'");
92         try {
93             execute(plan).getResult();
94         } catch (Throwable t) {
95             throw SQLExceptions.unwrap(t);
96         }
97     }
98     @Test
99     public void testSelectCountStar() throws Exception {
100         execute("create table test (name string) with (number_of_replicas=0)");
101         ensureYellow();
102         execute("insert into test (name) values (?)", new Object[]{"Arthur"});
103         execute("insert into test (name) values (?)", new Object[]{"Trillian"});
104         refresh();
105         execute("select count(*) from test");
106         assertEquals(1, response.rowCount());
107         assertEquals(2L, response.rows()[0][0]);
108     }
109     @Test
110     public void testSelectZeroLimit() throws Exception {
111         execute("create table test (name string) with (number_of_replicas=0)");
112         ensureYellow();
113         execute("insert into test (name) values (?)", new Object[]{"Arthur"});
114         execute("insert into test (name) values (?)", new Object[]{"Trillian"});
115         refresh();
116         execute("select * from test limit 0");
117         assertEquals(0L, response.rowCount());
118     }
119     @Test
120     public void testSelectZeroLimitOrderBy() throws Exception {
121         execute("create table test (name string) with (number_of_replicas=0)");
122         ensureYellow();
123         execute("insert into test (name) values (?)", new Object[]{"Arthur"});
124         execute("insert into test (name) values (?)", new Object[]{"Trillian"});
125         refresh();
126         execute("select * from test order by name limit 0");
127         assertEquals(0L, response.rowCount());
128     }
129     @Test
130     public void testSelectCountStarWithWhereClause() throws Exception {
131         execute("create table test (name string) with (number_of_replicas=0)");
132         ensureYellow();
133         execute("insert into test (name) values (?)", new Object[]{"Arthur"});
134         execute("insert into test (name) values (?)", new Object[]{"Trillian"});
135         refresh();
136         execute("select count(*) from test where name = 'Trillian'");
137         assertEquals(1, response.rowCount());
138         assertEquals(1L, response.rows()[0][0]);
139     }
140     @Test
141     public void testSelectStar() throws Exception {
142         execute("create table test (\"firstName\" string, \"lastName\" string)");
143         ensureYellow();
144         execute("select * from test");
145         assertArrayEquals(new String[]{"firstName", "lastName"}, response.cols());
146         assertEquals(0, response.rowCount());
147     }
148     @Test
149     public void testSelectStarEmptyMapping() throws Exception {
150         execute("select * from unnest()");
151         assertArrayEquals(new String[]{}, response.cols());
152         assertEquals(0, response.rowCount());
153     }
154     @Test
155     public void testGroupByOnAnalyzedColumn() throws Exception {
156         execute("create table test1 (col1 string index using fulltext)");
157         execute("insert into test1 (col1) values ('abc def, ghi. jkl')");
158         refresh();
159         assertThat(
160             printedTable(execute("select count(col1) from test1 group by col1").rows()),
161             is("1\n")
162         );
163     }
164     @Test
165     public void testSelectStarWithOther() throws Exception {
166         execute("create table test (id string primary key, first_name string, last_name string)");
167         execute("insert into test (id, first_name, last_name) values ('id1', 'Youri', 'Zoon')");
168         execute("refresh table test");
169         execute("select \"_version\", *, \"_id\" from test");
170         assertThat(response.cols(), arrayContaining("_version", "id", "first_name", "last_name", "_id"));
171         assertEquals(1, response.rowCount());
172         assertArrayEquals(new Object[]{1L, "id1", "Youri", "Zoon", "id1"}, response.rows()[0]);
173     }
174     @Test
175     @UseJdbc(0)     public void testSelectWithParams() throws Exception {
176         execute("create table test (id string primary key, first_name string, last_name string, age double) " +
177                 "with (number_of_replicas = 0)");
178         execute("insert into test (id, first_name, last_name, age) values ('id1', 'Youri', 'Zoon', 38)");
179         execute("refresh table test");
180         Object[] args = new Object[]{"id1"};
181         execute("select first_name, last_name from test where \"_id\" = $1", args);
182         assertArrayEquals(new Object[]{"Youri", "Zoon"}, response.rows()[0]);
183         args = new Object[]{"Zoon"};
184         execute("select first_name, last_name from test where last_name = $1", args);
185         assertArrayEquals(new Object[]{"Youri", "Zoon"}, response.rows()[0]);
186         args = new Object[]{38, "Zoon"};
187         execute("select first_name, last_name from test where age = $1 and last_name = $2", args);
188         assertArrayEquals(new Object[]{"Youri", "Zoon"}, response.rows()[0]);
189         args = new Object[]{38, "Zoon"};
190         execute("select first_name, last_name from test where age = ? and last_name = ?", args);
191         assertArrayEquals(new Object[]{"Youri", "Zoon"}, response.rows()[0]);
192     }
193     @Test
194     public void testSelectStarWithOtherAndAlias() throws Exception {
195         execute("create table test (first_name string, last_name string)");
196         execute("insert into test (first_name, last_name) values ('Youri', 'Zoon')");
197         execute("refresh table test");
198         execute("select *, \"_version\", \"_version\" as v from test");
199         assertArrayEquals(new String[]{"first_name", "last_name", "_version", "v"}, response.cols());
200         assertEquals(1, response.rowCount());
201         assertArrayEquals(new Object[]{"Youri", "Zoon", 1L, 1L}, response.rows()[0]);
202     }
203     @Test
204     public void testFilterByEmptyString() throws Exception {
205         execute("create table test (name string)");
206         execute("insert into test (name) values (''), ('Ruben Lenten')");
207         execute("refresh table test");
208         execute("select name from test where name = ''");
209         assertEquals(1, response.rowCount());
210         assertEquals("", response.rows()[0][0]);
211         execute("select name from test where name != ''");
212         assertEquals(1, response.rowCount());
213         assertEquals("Ruben Lenten", response.rows()[0][0]);
214     }
215     @Test
216     public void testFilterByNull() throws Exception {
217         execute("create table test (id int, name string, o object(ignored))");
218         ensureYellow();
219         execute("insert into test (id) values (1)");
220         execute("insert into test (id, name) values (2, 'Ruben Lenten'), (3, '')");
221         refresh();
222         execute("select id from test where name is null");
223         assertEquals(1, response.rowCount());
224         assertEquals(1, response.rows()[0][0]);
225         execute("select id from test where name is not null order by id");
226         assertEquals(2, response.rowCount());
227         assertEquals(2, response.rows()[0][0]);
228         execute("select id from test where o['invalid'] is null");
229         assertEquals(3, response.rowCount());
230         execute("select name from test where name is not null and name != ''");
231         assertEquals(1, response.rowCount());
232         assertEquals("Ruben Lenten", response.rows()[0][0]);
233     }
234     @Test
235     public void testFilterByBoolean() throws Exception {
236         execute("create table test (sunshine boolean)");
237         execute("insert into test values (?)", new Object[]{true});
238         refresh();
239         execute("select sunshine from test where sunshine = true");
240         assertEquals(1, response.rowCount());
241         assertEquals(true, response.rows()[0][0]);
242         execute("update test set sunshine=false where sunshine = true");
243         assertEquals(1, response.rowCount());
244         refresh();
245         execute("select sunshine from test where sunshine = ?", new Object[]{false});
246         assertEquals(1, response.rowCount());
247         assertEquals(false, response.rows()[0][0]);
248     }
249     @Test
250     public void testColsAreCaseSensitive() throws Exception {
251         execute("create table test (\"firstname\" string, \"firstName\" string) " +
252                 "with (number_of_replicas = 0)");
253         ensureYellow();
254         execute("insert into test (\"firstname\", \"firstName\") values ('LowerCase', 'CamelCase')");
255         refresh();
256         execute("select FIRSTNAME, \"firstname\", \"firstName\" from test");
257         assertArrayEquals(new String[]{"firstname", "firstname", "firstName"}, response.cols());
258         assertEquals(1, response.rowCount());
259         assertEquals("LowerCase", response.rows()[0][0]);
260         assertEquals("LowerCase", response.rows()[0][1]);
261         assertEquals("CamelCase", response.rows()[0][2]);
262     }
263     @Test
264     public void testIdSelectWithResult() throws Exception {
265         execute("create table test (id string primary key)");
266         execute("insert into test (id) values ('id1')");
267         execute("refresh table test");
268         execute("select \"_id\" from test");
269         assertArrayEquals(new String[]{"_id"}, response.cols());
270         assertEquals(1, response.rowCount());
271         assertEquals(1, response.rows()[0].length);
272         assertEquals("id1", response.rows()[0][0]);
273     }
274     @Test
275     public void testSqlRequestWithLimit() throws Exception {
276         execute("create table test (id string primary key)");
277         execute("insert into test (id) values ('id1'), ('id2')");
278         execute("refresh table test");
279         execute("select \"_id\" from test limit 1");
280         assertEquals(1, response.rowCount());
281     }
282     @Test
283     public void testSqlRequestWithLimitAndOffset() throws Exception {
284         execute("create table test (id string primary key) with (number_of_replicas=0)");
285         ensureYellow();
286         execute("insert into test (id) values (?), (?), (?)", new Object[]{"id1", "id2", "id3"});
287         refresh();
288         execute("select \"id\" from test order by id limit 1 offset 1");
289         assertEquals(1, response.rowCount());
290         assertThat(
291             printedTable(response.rows()),
292             is("id2\n")
293         );
294     }
295     @Test
296     public void testSqlRequestWithFilter() throws Exception {
297         execute("create table test (id string primary key)");
298         execute("insert into test (id) values ('id1'), ('id2')");
299         execute("select _id from test where id = 'id1'");
300         assertEquals(1, response.rowCount());
301         assertThat(
302             printedTable(response.rows()),
303             is("id1\n")
304         );
305     }
306     @Test
307     public void testSqlRequestWithNotEqual() throws Exception {
308         execute("create table test (id string primary key) with (number_of_replicas = 0)");
309         ensureYellow();
310         execute("insert into test (id) values (?)", new Object[][]{
311             new Object[]{"id1"},
312             new Object[]{"id2"}
313         });
314         refresh();
315         execute("select id from test where id != 'id1'");
316         assertEquals(1, response.rowCount());
317         assertEquals("id2", response.rows()[0][0]);
318     }
319     @Test
320     public void testSqlRequestWithOneOrFilter() throws Exception {
321         execute("create table test (id string) with (number_of_replicas = 0)");
322         ensureYellow();
323         execute("insert into test (id) values ('id1'), ('id2'), ('id3')");
324         refresh();
325         execute("select id from test where id='id1' or id='id3'");
326         assertEquals(2, response.rowCount());
327         assertThat(this.&lt;String&gt;getCol(response.rows(), 0), containsInAnyOrder("id1", "id3"));
328     }
329     @Test
330     public void testSqlRequestWithOneMultipleOrFilter() throws Exception {
331         execute("create table test (id string) with (number_of_replicas = 0)");
332         ensureYellow();
333         execute("insert into test (id) values ('id1'), ('id2'), ('id3'), ('id4')");
334         refresh();
335         execute("select id from test where id='id1' or id='id2' or id='id4'");
336         assertEquals(3, response.rowCount());
337         List&lt;String&gt; col1 = this.getCol(response.rows(), 0);
338         assertThat(col1, containsInAnyOrder("id1", "id2", "id4"));
339     }
340     @Test
341     public void testSqlRequestWithDateFilter() {
342         execute("create table test (date timestamp with time zone)");
343         execute("insert into test (date) values ('2013-10-01'), ('2013-10-02')");
344         execute("refresh table test");
345         execute("select date from test where date = '2013-10-01'");
346         assertEquals(1, response.rowCount());
347         assertEquals(1380585600000L, response.rows()[0][0]);
348     }
349     @Test
350     public void testSqlRequestWithDateGtFilter() {
351         execute("create table test (date timestamp with time zone)");
352         execute("insert into test (date) values ('2013-10-01'), ('2013-10-02')");
353         execute("refresh table test");
354         execute(
355             "select date from test where date &gt; '2013-10-01'");
356         assertEquals(1, response.rowCount());
357         assertEquals(1380672000000L, response.rows()[0][0]);
358     }
359     @Test
360     public void testSqlRequestWithNumericGtFilter() throws Exception {
361         execute("create table test (i long)");
362         execute("insert into test (i) values (10), (20)");
363         execute("refresh table test");
364         execute(
365             "select i from test where i &gt; 10");
366         assertEquals(1, response.rowCount());
367         assertEquals(20L, response.rows()[0][0]);
368     }
369     @Test
370     public void testArraySupport() throws Exception {
371         execute("create table t1 (id int primary key, strings array(string), integers array(integer)) with (number_of_replicas=0)");
372         ensureYellow();
373         execute("insert into t1 (id, strings, integers) values (?, ?, ?)",
374             new Object[]{
375                 1,
376                 new String[]{"foo", "bar"},
377                 new Integer[]{1, 2, 3}
378             }
379         );
380         refresh();
381         execute("select id, strings, integers from t1");
382         assertThat(response.rowCount(), is(1L));
383         assertThat(response.rows()[0][0], is(1));
384         assertThat(((List) response.rows()[0][1]).get(0), is("foo"));
385         assertThat(((List) response.rows()[0][1]).get(1), is("bar"));
386         assertThat(((List) response.rows()[0][2]).get(0), is(1));
387         assertThat(((List) response.rows()[0][2]).get(1), is(2));
388         assertThat(((List) response.rows()[0][2]).get(2), is(3));
389     }
390     @Test
391     @SuppressWarnings("unchecked")
392     public void testArrayInsideObject() throws Exception {
393         execute("create table t1 (id int primary key, details object as (names array(string))) with (number_of_replicas=0)");
394         ensureYellow();
395         Map&lt;String, Object&gt; details = new HashMap&lt;&gt;();
396         details.put("names", new Object[]{"Arthur", "Trillian"});
397         execute("insert into t1 (id, details) values (?, ?)", new Object[]{1, details});
398         refresh();
399         execute("select details['names'] from t1");
400         assertThat(response.rowCount(), is(1L));
401         assertThat(((List) response.rows()[0][0]).get(0), is("Arthur"));
402         assertThat(((List) response.rows()[0][0]).get(1), is("Trillian"));
403     }
404     @Test
405     public void testArrayInsideObjectArrayOutputAndQueryBehaviour() throws Exception {
406         execute("create table t1 (id int primary key, details array(object as (names array(string)))) with (number_of_replicas=0)");
407         ensureYellow();
408         Map&lt;String, Object&gt; detail1 = new HashMap&lt;&gt;();
409         detail1.put("names", new Object[]{"Arthur", "Trillian"});
410         Map&lt;String, Object&gt; detail2 = new HashMap&lt;&gt;();
411         detail2.put("names", new Object[]{"Ford", "Slarti", "Ford"});
412         List&lt;Map&lt;String, Object&gt;&gt; details = Arrays.asList(detail1, detail2);
413         execute("insert into t1 (id, details) values (?, ?)", new Object[]{1, details});
414         refresh();
415         execute("select " +
416                 "details['names'], ['Arthur', 'Trillian'] = ANY (details['names']) " +
417                 "from t1 " +
418                 "where ['Ford', 'Slarti', 'Ford'] = ANY (details['names'])");
419         assertThat(
420             printedTable(response.rows()),
421             is("[[Arthur, Trillian], [Ford, Slarti, Ford]]| true\n")
422         );
423     }
424     @Test
425     public void testFullPathRequirement() throws Exception {
426         execute("create table t1 (id int primary key, details object as (id int, more_details object as (id int))) with (number_of_replicas=0)");
427         ensureYellow();
428         Map&lt;String, Object&gt; more_details = new HashMap&lt;&gt;();
429         more_details.put("id", 2);
430         Map&lt;String, Object&gt; details = new HashMap&lt;&gt;();
431         details.put("id", 1);
432         details.put("more_details", more_details);
433         execute("insert into t1 (id, details) values (2, ?)", new Object[]{details});
434         execute("refresh table t1");
435         execute("select details from t1 where details['id'] = 2");
436         assertThat(response.rowCount(), is(0L));
437     }
438     @Test
439     @SuppressWarnings("unchecked")
440     public void testArraySupportWithNullValues() throws Exception {
441         execute("create table t1 (id int primary key, strings array(string)) with (number_of_replicas=0)");
442         ensureYellow();
443         execute("insert into t1 (id, strings) values (?, ?)",
444             new Object[]{
445                 1,
446                 new String[]{"foo", null, "bar"},
447             }
448         );
449         refresh();
450         execute("select id, strings from t1");
451         assertThat(response.rowCount(), is(1L));
452         assertThat(response.rows()[0][0], is(1));
453         assertThat(((List) response.rows()[0][1]).get(0), is("foo"));
454         assertThat(((List) response.rows()[0][1]).get(1), nullValue());
455         assertThat(((List) response.rows()[0][1]).get(2), is("bar"));
456     }
457     @Test
458     public void testObjectArrayInsertAndSelect() throws Exception {
459         execute("create table t1 (" +
460                 "  id int primary key, " +
461                 "  objects array(" +
462                 "   object as (" +
463                 "     name string, " +
464                 "     age int" +
465                 "   )" +
466                 "  )" +
467                 ") with (number_of_replicas=0)");
468         ensureYellow();
469         Map&lt;String, Object&gt; obj1 = Map.of("name", "foo", "age", 1);
470         Map&lt;String, Object&gt; obj2 = Map.of("name", "bar", "age", 2);
471         Object[] args = new Object[]{1, new Object[]{obj1, obj2}};
472         execute("insert into t1 (id, objects) values (?, ?)", args);
473         refresh();
474         execute("select objects from t1");
475         assertThat(response.rowCount(), is(1L));
476         List objResults = (List) response.rows()[0][0];
477         Map&lt;String, Object&gt; obj1Result = (Map) objResults.get(0);
478         assertThat(obj1Result.get("name"), is("foo"));
479         assertThat(obj1Result.get("age"), is(1));
480         Map&lt;String, Object&gt; obj2Result = (Map) objResults.get(1);
481         assertThat(obj2Result.get("name"), is("bar"));
482         assertThat(obj2Result.get("age"), is(2));
483         execute("select objects['name'] from t1");
484         assertThat(response.rowCount(), is(1L));
485         List names = (List) response.rows()[0][0];
486         assertThat(names.get(0), is("foo"));
487         assertThat(names.get(1), is("bar"));
488         execute("select objects['name'] from t1 where ? = ANY (objects['name'])", new Object[]{"foo"});
489         assertThat(response.rowCount(), is(1L));
490     }
491     @Test
492     public void testGetResponseWithObjectColumn() throws Exception {
493         execute("create table test (" +
494                 "   id text primary key," +
495                 "   data object " +
496                 ")");
497         Map&lt;String, Object&gt; data = new HashMap&lt;&gt;();
498         data.put("foo", "bar");
499         execute("insert into test (id, data) values (?, ?)", new Object[]{"1", data});
500         refresh();
501         execute("select data from test where id = ?", new Object[]{"1"});
502         assertEquals(data, response.rows()[0][0]);
503     }
504     @Test
505     public void testSelectToGetRequestByPlanner() throws Exception {
506         this.setup.createTestTableWithPrimaryKey();
507         execute("insert into test (pk_col, message) values ('124', 'bar1')");
508         assertEquals(1, response.rowCount());
509         refresh();
510         waitNoPendingTasksOnAll(); 
511         execute("select pk_col, message from test where pk_col='124'");
512         assertEquals(1, response.rowCount());
513         assertEquals("124", response.rows()[0][0]);
514     }
515     @Test
516     public void testSelectToRoutedRequestByPlanner() throws Exception {
517         this.setup.createTestTableWithPrimaryKey();
518         execute("insert into test (pk_col, message) values ('1', 'foo')");
519         execute("insert into test (pk_col, message) values ('2', 'bar')");
520         execute("insert into test (pk_col, message) values ('3', 'baz')");
521         execute("SELECT * FROM test WHERE pk_col='1' OR pk_col='2'");
522         assertThat(response.rowCount(), is(2L));
523         execute("SELECT * FROM test WHERE pk_col=? OR pk_col=?", new Object[]{"1", "2"});
524         assertThat(response.rowCount(), is(2L));
525         execute("SELECT * FROM test WHERE (pk_col=? OR pk_col=?) OR pk_col=?", new Object[]{"1", "2", "3"});
526         assertThat(response.rowCount(), is(3L));
527         assertThat(String.join(", ", List.of(response.cols())), is("pk_col, message"));
528     }
529     @Test
530     public void testSelectToRoutedRequestByPlannerMissingDocuments() throws Exception {
531         this.setup.createTestTableWithPrimaryKey();
532         execute("insert into test (pk_col, message) values ('1', 'foo')");
533         execute("insert into test (pk_col, message) values ('2', 'bar')");
534         execute("insert into test (pk_col, message) values ('3', 'baz')");
535         refresh();
536         execute("SELECT pk_col, message FROM test WHERE pk_col='4' OR pk_col='3'");
537         assertEquals(1, response.rowCount());
538         assertThat(Arrays.asList(response.rows()[0]), hasItems(new Object[]{"3", "baz"}));
539         execute("SELECT pk_col, message FROM test WHERE pk_col='4' OR pk_col='99'");
540         assertEquals(0, response.rowCount());
541     }
542     @Test
543     public void testSelectToRoutedRequestByPlannerWhereIn() throws Exception {
544         this.setup.createTestTableWithPrimaryKey();
545         execute("insert into test (pk_col, message) values ('1', 'foo')");
546         execute("insert into test (pk_col, message) values ('2', 'bar')");
547         execute("insert into test (pk_col, message) values ('3', 'baz')");
548         refresh();
549         execute("SELECT * FROM test WHERE pk_col IN (?,?,?)", new Object[]{"1", "2", "3"});
550         assertEquals(3, response.rowCount());
551     }
552     @Test
553     public void testUpdateToRoutedRequestByPlannerWhereOr() throws Exception {
554         this.setup.createTestTableWithPrimaryKey();
555         execute("insert into test (pk_col, message) values ('1', 'foo'), ('2', 'bar'), ('3', 'baz')");
556         refresh();
557         execute("update test set message='new' WHERE pk_col='1' or pk_col='2' or pk_col='4'");
558         assertThat(response.rowCount(), is(2L));
559         refresh();
560         execute("SELECT distinct message FROM test");
561         assertThat(response.rowCount(), is(2L));
562     }
563     @Test
564     public void testSelectWithWhereLike() throws Exception {
565         this.setup.groupBySetup();
566         execute("select name from characters where name like '%ltz'");
567         assertEquals(2L, response.rowCount());
568         execute("select count(*) from characters where name like 'Jeltz'");
569         assertEquals(1L, response.rows()[0][0]);
570         execute("select count(*) from characters where race like '%o%'");
571         assertEquals(3L, response.rows()[0][0]);
572         Map&lt;String, Object&gt; emptyMap = new HashMap&lt;&gt;();
573         Map&lt;String, Object&gt; details = new HashMap&lt;&gt;();
574         details.put("age", 30);
575         details.put("job", "soldier");
576         execute("insert into characters (race, gender, name, details) values (?, ?, ?, ?)",
577             new Object[]{"Vo*", "male", "Kwaltzz", emptyMap}
578         );
579         execute("insert into characters (race, gender, name, details) values (?, ?, ?, ?)",
580             new Object[]{"Vo?", "male", "Kwaltzzz", emptyMap}
581         );
582         execute("insert into characters (race, gender, name, details) values (?, ?, ?, ?)",
583             new Object[]{"Vo!", "male", "Kwaltzzzz", details}
584         );
585         execute("insert into characters (race, gender, name, details) values (?, ?, ?, ?)",
586             new Object[]{"Vo%", "male", "Kwaltzzzz", details}
587         );
588         refresh();
589         execute("select race from characters where race like 'Vo*'");
590         assertEquals(1L, response.rowCount());
591         assertEquals("Vo*", response.rows()[0][0]);
592         execute("select race from characters where race like ?", new Object[]{"Vo?"});
593         assertEquals(1L, response.rowCount());
594         assertEquals("Vo?", response.rows()[0][0]);
595         execute("select race from characters where race like 'Vo!'");
596         assertEquals(1L, response.rowCount());
597         assertEquals("Vo!", response.rows()[0][0]);
598         execute("select race from characters where race like 'Vo\\%'");
599         assertEquals(1L, response.rowCount());
600         assertEquals("Vo%", response.rows()[0][0]);
601         execute("select race from characters where race like 'Vo_'");
602         assertEquals(4L, response.rowCount());
603         execute("select race from characters where details['job'] like 'sol%'");
604         assertEquals(2L, response.rowCount());
605     }
606     private void nonExistingColumnSetup() {
607         execute("create table quotes (" +
608                 "id integer primary key, " +
609                 "quote string index off, " +
610                 "o object(ignored) " +
611                 ") clustered by (id) into 3 shards with (number_of_replicas = 0)");
612         execute("insert into quotes (id, quote) values (1, '\"Nothing particularly exciting," +
613                 "\" it admitted, \"but they are alternatives.\"')");
614         execute("insert into quotes (id, quote) values (2, '\"Have another drink," +
615                 "\" said Trillian. \"Enjoy yourself.\"')");
616         refresh();
617     }
618     @Test
619     public void selectNonExistingColumn() throws Exception {
620         nonExistingColumnSetup();
621         execute("select o['notExisting'] from quotes");
622         assertEquals(2L, response.rowCount());
623         assertEquals("o['notExisting']", response.cols()[0]);
624         assertNull(response.rows()[0][0]);
625         assertNull(response.rows()[1][0]);
626     }
627     @Test
628     public void selectNonExistingAndExistingColumns() throws Exception {
629         nonExistingColumnSetup();
630         execute("select o['unknown'], id from quotes order by id asc");
631         assertEquals(2L, response.rowCount());
632         assertEquals("o['unknown']", response.cols()[0]);
633         assertEquals("id", response.cols()[1]);
634         assertNull(response.rows()[0][0]);
635         assertEquals(1, response.rows()[0][1]);
636         assertNull(response.rows()[1][0]);
637         assertEquals(2, response.rows()[1][1]);
638     }
639     @Test
640     public void selectWhereNonExistingColumn() throws Exception {
641         nonExistingColumnSetup();
642         execute("select * from quotes where o['something'] &gt; 0");
643         assertEquals(0L, response.rowCount());
644     }
645     @Test
646     public void selectWhereDynamicColumnIsNull() throws Exception {
647         nonExistingColumnSetup();
648         execute("select * from quotes where o['something'] IS NULL");
649         assertEquals(2, response.rowCount());
650     }
651     @Test
652     public void selectWhereNonExistingColumnWhereIn() throws Exception {
653         nonExistingColumnSetup();
654         execute("select * from quotes where o['something'] IN (1,2,3)");
655         assertEquals(0L, response.rowCount());
656     }
657     @Test
658     public void selectWhereNonExistingColumnLike() throws Exception {
659         nonExistingColumnSetup();
660         execute("select * from quotes where o['something'] Like '%bla'");
661         assertEquals(0L, response.rowCount());
662     }
663     @Test
664     public void selectWhereNonExistingColumnMatchFunction() throws Exception {
665         nonExistingColumnSetup();
666         assertThrowsMatches(() -&gt; execute("select * from quotes where match(o['something'], 'bla')"),
667                      isSQLError(is("Can only use MATCH on columns of type STRING or GEO_SHAPE, not on 'undefined'"),
668                                 INTERNAL_ERROR,
669                                 BAD_REQUEST,
670                                 4000));
671     }
672     @Test
673     public void testSelectCountDistinctZero() throws Exception {
674         execute("create table test (col1 int) with (number_of_replicas=0)");
675         ensureYellow();
676         execute("select count(distinct col1) from test");
677         assertEquals(1, response.rowCount());
678         assertEquals(0L, response.rows()[0][0]);
679     }
680     @Test
681     public void testRefresh() throws Exception {
682         execute("create table test (id int primary key, name string) with (refresh_interval = 0)");
683         ensureYellow();
684         execute("insert into test (id, name) values (0, 'Trillian'), (1, 'Ford'), (2, 'Zaphod')");
685         execute("select count(*) from test");
686         assertThat((long) response.rows()[0][0], lessThanOrEqualTo(3L));
687         execute("refresh table test");
688         assertThat(response.rowCount(), is(1L));
689         execute("select count(*) from test");
690         assertThat((Long) response.rows()[0][0], is(3L));
691     }
692     @Test
693     public void testInsertSelectWithClusteredBy() throws Exception {
694         execute("create table quotes (id integer, quote string) clustered by(id) " +
695                 "with (number_of_replicas=0)");
696         ensureYellow();
697         execute("insert into quotes (id, quote) values(?, ?)",
698             new Object[]{1, "I'd far rather be happy than right any day."});
699         assertEquals(1L, response.rowCount());
700         refresh();
701         execute("select \"_id\", id, quote from quotes where id=1");
702         assertEquals(1L, response.rowCount());
703         assertNotNull(response.rows()[0][0]);
704         assertThat(((String) response.rows()[0][0]).length(), greaterThan(0));
705     }
706     @Test
707     public void testInsertSelectWithAutoGeneratedId() throws Exception {
708         execute("create table quotes (id integer, quote string)" +
709                 "with (number_of_replicas=0)");
710         ensureYellow();
711         execute("insert into quotes (id, quote) values(?, ?)",
712             new Object[]{1, "I'd far rather be happy than right any day."});
713         assertEquals(1L, response.rowCount());
714         refresh();
715         execute("select \"_id\", id, quote from quotes where id=1");
716         assertEquals(1L, response.rowCount());
717         assertNotNull(response.rows()[0][0]);
718         assertThat(((String) response.rows()[0][0]).length(), greaterThan(0));
719     }
720     @Test
721     public void testInsertSelectWithPrimaryKey() throws Exception {
722         execute("create table quotes (id integer primary key, quote string)" +
723                 "with (number_of_replicas=0)");
724         ensureYellow();
725         execute("insert into quotes (id, quote) values(?, ?)",
726             new Object[]{1, "I'd far rather be happy than right any day."});
727         assertEquals(1L, response.rowCount());
728         refresh();
729         execute("select \"_id\", id, quote from quotes where id=1");
730         assertEquals(1L, response.rowCount());
731         String _id = (String) response.rows()[0][0];
732         Integer id = (Integer) response.rows()[0][1];
733         assertEquals(id.toString(), _id);
734     }
735     @Test
736     public void testInsertSelectWithMultiplePrimaryKey() throws Exception {
737         execute("create table quotes (id integer primary key, author string primary key, " +
738                 "quote string) with (number_of_replicas=0)");
739         ensureYellow();
740         execute("insert into quotes (id, author, quote) values(?, ?, ?)",
741             new Object[]{1, "Ford", "I'd far rather be happy than right any day."});
742         assertEquals(1L, response.rowCount());
743         refresh();
744         execute("select \"_id\", id from quotes where id=1 and author='Ford'");
745         assertEquals(1L, response.rowCount());
746         assertThat((String) response.rows()[0][0], is("AgExBEZvcmQ="));
747         assertThat((Integer) response.rows()[0][1], is(1));
748     }
749     @Test
750     public void testInsertSelectWithMultiplePrimaryKeyAndClusteredBy() throws Exception {
751         execute("create table quotes (id integer primary key, author string primary key, " +
752                 "quote string) clustered by(author) with (number_of_replicas=0)");
753         ensureYellow();
754         execute("insert into quotes (id, author, quote) values(?, ?, ?)",
755             new Object[]{1, "Ford", "I'd far rather be happy than right any day."});
756         assertEquals(1L, response.rowCount());
757         refresh();
758         execute("select \"_id\", id from quotes where id=1 and author='Ford'");
759         assertEquals(1L, response.rowCount());
760         assertThat((String) response.rows()[0][0], is("AgRGb3JkATE="));
761         assertThat((Integer) response.rows()[0][1], is(1));
762     }
763     @Test
764     public void testInsertSelectWithMultiplePrimaryOnePkSame() throws Exception {
765         execute("create table quotes (id integer primary key, author string primary key, " +
766                 "quote string) clustered by(author) with (number_of_replicas=0)");
767         ensureYellow();
768         execute("insert into quotes (id, author, quote) values (?, ?, ?), (?, ?, ?)",
769             new Object[]{1, "Ford", "I'd far rather be happy than right any day.",
770                 1, "Douglas", "Don't panic"}
771         );
772         assertEquals(2L, response.rowCount());
773         refresh();
774         execute("select \"_id\", id from quotes where id=1 order by author");
775         assertEquals(2L, response.rowCount());
776         assertThat((String) response.rows()[0][0], is("AgdEb3VnbGFzATE="));
777         assertThat((Integer) response.rows()[0][1], is(1));
778         assertThat((String) response.rows()[1][0], is("AgRGb3JkATE="));
779         assertThat((Integer) response.rows()[1][1], is(1));
780     }
781     @Test
782     public void testSelectWhereBoolean() {
783         execute("create table a (v boolean)");
784         ensureYellow();
785         execute("insert into a values (true)");
786         execute("insert into a values (true)");
787         execute("insert into a values (true)");
788         execute("insert into a values (false)");
789         execute("insert into a values (false)");
790         refresh();
791         execute("select v from a where v");
792         assertEquals(3L, response.rowCount());
793         execute("select v from a where not v");
794         assertEquals(2L, response.rowCount());
795         execute("select v from a where v or not v");
796         assertEquals(5L, response.rowCount());
797         execute("select v from a where v and not v");
798         assertEquals(0L, response.rowCount());
799     }
800     @Test
801     public void testSelectWhereBooleanPK() {
802         execute("create table b (v boolean primary key) clustered by (v)");
803         ensureYellow();
804         execute("insert into b values (true)");
805         execute("insert into b values (false)");
806         refresh();
807         execute("select v from b where v");
808         assertEquals(1L, response.rowCount());
809         execute("select v from b where not v");
810         assertEquals(1L, response.rowCount());
811         execute("select v from b where v or not v");
812         assertEquals(2L, response.rowCount());
813         execute("select v from b where v and not v");
814         assertEquals(0L, response.rowCount());
815     }
816     @Test
817     public void testBulkOperations() throws Exception {
818         execute("create table test (id integer primary key, name string) with (number_of_replicas = 0)");
819         ensureYellow();
820         long[] rowCounts = execute("insert into test (id, name) values (?, ?), (?, ?)",
821             new Object[][]{
822                 {1, "Earth", 2, "Saturn"},                    {3, "Moon", 4, "Mars"}                    });
823         assertThat(rowCounts.length, is(2));
824         for (long rowCount : rowCounts) {
825             assertThat(rowCount, is(2L));
826         }
827         refresh();
828         rowCounts = execute("insert into test (id, name) values (?, ?), (?, ?)",
829             new Object[][]{
830                 {1, "Earth", 2, "Saturn"},                    {3, "Moon", 4, "Mars"}                    });
831         assertThat(rowCounts.length, is(2));
832         for (long rowCount : rowCounts) {
833             assertThat(rowCount, is(-2L));
834         }
835         execute("select name from test order by id asc");
836         assertEquals("Earth\nSaturn\nMoon\nMars\n", printedTable(response.rows()));
837         rowCounts = execute("update test set name = concat(name, '-updated') where id = ?", new Object[][]{
838             new Object[]{2},
839             new Object[]{3},
840             new Object[]{4},
841         });
842         assertThat(rowCounts.length, is(3));
843         for (long rowCount : rowCounts) {
844             assertThat(rowCount, is(1L));
845         }
846         refresh();
847         execute("select count(*) from test where name like '%-updated'");
848         assertThat(response.rows()[0][0], is(3L));
849         rowCounts = execute("delete from test where id = ?", new Object[][]{
850             new Object[]{1},
851             new Object[]{3}
852         });
853         assertThat(rowCounts.length, is(2));
854         for (long rowCount : rowCounts) {
855             assertThat(rowCount, is(1L));
856         }
857         refresh();
858         execute("select count(*) from test");
859         assertThat(response.rows()[0][0], is(2L));
860         rowCounts = execute("delete from test where name = ?", new Object[][]{
861             new Object[]{"Saturn-updated"},
862             new Object[]{"Mars-updated"}
863         });
864         assertThat(rowCounts.length, is(2));
865         for (long rowCount : rowCounts) {
866             assertThat(rowCount, is(1L));
867         }
868         refresh();
869         execute("select count(*) from test");
870         assertThat(response.rows()[0][0], is(0L));
871     }
872     @Test
873     public void testSelectFormatFunction() throws Exception {
874         execute("create table tbl (name text, kind text)");
875         execute("insert into tbl (name, kind) values ('', 'Planet'), ('Aldebaran', 'Star System'), ('Algol', 'Star System')");
876         execute("refresh table tbl");
877         execute("select format('%s is a %s', name, kind) as sentence from tbl order by name");
878         assertThat(response.cols(), Matchers.arrayContaining("sentence"));
879         assertThat(printedTable(response.rows()), is(
880             " is a Planet\n" +
881             "Aldebaran is a Star System\n" +
882             "Algol is a Star System\n"
883         ));
884     }
885     @Test
886     public void testAnyArray() throws Exception {
887         this.setup.setUpArrayTables();
888         execute("select count(*) from any_table where 'Berlin' = ANY (names)");
889         assertThat((Long) response.rows()[0][0], is(2L));
890         execute("select id, names from any_table where 'Berlin' = ANY (names) order by id");
891         assertThat(response.rowCount(), is(2L));
892         assertThat((Integer) response.rows()[0][0], is(1));
893         assertThat((Integer) response.rows()[1][0], is(3));
894         execute("select id from any_table where 'Berlin' != ANY (names) order by id");
895         assertThat(response.rowCount(), is(3L));
896         assertThat((Integer) response.rows()[0][0], is(1));
897         assertThat((Integer) response.rows()[1][0], is(2));
898         assertThat((Integer) response.rows()[2][0], is(3));
899         execute("select count(id) from any_table where 0.0 &lt; ANY (temps)");
900         assertThat((Long) response.rows()[0][0], is(2L));
901         execute("select id, names from any_table where 0.0 &lt; ANY (temps) order by id");
902         assertThat(response.rowCount(), is(2L));
903         assertThat((Integer) response.rows()[0][0], is(2));
904         assertThat((Integer) response.rows()[1][0], is(3));
905         execute("select count(*) from any_table where 0.0 &gt; ANY (temps)");
906         assertThat((Long) response.rows()[0][0], is(2L));
907         execute("select id, names from any_table where 0.0 &gt; ANY (temps) order by id");
908         assertThat(response.rowCount(), is(2L));
909         assertThat((Integer) response.rows()[0][0], is(2));
910         assertThat((Integer) response.rows()[1][0], is(3));
911         execute("select id, names from any_table where 'Ber%' LIKE ANY (names) order by id");
912         assertThat(response.rowCount(), is(2L));
913         assertThat((Integer) response.rows()[0][0], is(1));
914         assertThat((Integer) response.rows()[1][0], is(3));
915     }
916     @Test
917     public void testNotAnyArray() throws Exception {
918         this.setup.setUpArrayTables();
919         execute("select id from any_table where NOT 'Hangelsberg' = ANY (names) order by id");
920         assertThat(response.rowCount(), is(2L));
921         assertThat((Integer) response.rows()[0][0], is(1));
922         assertThat((Integer) response.rows()[1][0], is(2));
923         execute("select id from any_table where 'Hangelsberg' != ANY (names) order by id");
924         assertThat(response.rowCount(), is(3L));
925         assertThat((Integer) response.rows()[0][0], is(1));
926         assertThat((Integer) response.rows()[1][0], is(2));
927         assertThat((Integer) response.rows()[2][0], is(3));
928     }
929     @Test
930     public void testAnyLike() throws Exception {
931         this.setup.setUpArrayTables();
932         execute("select id from any_table where 'kuh%' LIKE ANY (tags) order by id");
933         assertThat(response.rowCount(), is(2L));
934         assertThat((Integer) response.rows()[0][0], is(3));
935         assertThat((Integer) response.rows()[1][0], is(4));
936         execute("select id from any_table where 'kuh%' NOT LIKE ANY (tags) order by id");
937         assertThat(response.rowCount(), is(3L));
938         assertThat((Integer) response.rows()[0][0], is(1));
939         assertThat((Integer) response.rows()[1][0], is(2));
940         assertThat((Integer) response.rows()[2][0], is(3));
941     }
942     @Test
943     public void testInsertAndSelectIpType() throws Exception {
944         execute("create table ip_table (fqdn string, addr ip) with (number_of_replicas=0)");
945         ensureYellow();
946         execute("insert into ip_table (fqdn, addr) values ('localhost', '127.0.0.1'), ('crate.io', '23.235.33.143')");
947         execute("refresh table ip_table");
948         execute("select addr from ip_table where addr = '23.235.33.143'");
949         assertThat(response.rowCount(), is(1L));
950         assertThat((String) response.rows()[0][0], is("23.235.33.143"));
951         execute("select addr from ip_table where addr &gt; '127.0.0.1'");
952         assertThat(response.rowCount(), is(0L));
953         execute("select addr from ip_table where addr &gt; 2130706433");         assertThat(response.rowCount(), is(0L));
954         execute("select addr from ip_table where addr &lt; '127.0.0.1'");
955         assertThat(response.rowCount(), is(1L));
956         assertThat((String) response.rows()[0][0], is("23.235.33.143"));
957         execute("select addr from ip_table where addr &lt; 2130706433");         assertThat(response.rowCount(), is(1L));
958         assertThat((String) response.rows()[0][0], is("23.235.33.143"));
959         execute("select addr from ip_table where addr &lt;= '127.0.0.1'");
960         assertThat(response.rowCount(), is(2L));
961         execute("select addr from ip_table where addr &gt;= '23.235.33.143'");
962         assertThat(response.rowCount(), is(2L));
963         execute("select addr from ip_table where addr IS NULL");
964         assertThat(response.rowCount(), is(0L));
965         execute("select addr from ip_table where addr IS NOT NULL");
966         assertThat(response.rowCount(), is(2L));
967     }
968     @Test
969     public void testGroupByOnIpType() throws Exception {
970         execute("create table t (i ip) with (number_of_replicas=0)");
971         ensureYellow();
972         execute("insert into t (i) values ('192.168.1.2'), ('192.168.1.2'), ('192.168.1.3')");
973         execute("refresh table t");
974         execute("select i, count(*) from t group by 1 order by count(*) desc");
975         assertThat(response.rowCount(), is(2L));
976         assertThat((String) response.rows()[0][0], is("192.168.1.2"));
977         assertThat((Long) response.rows()[0][1], is(2L));
978         assertThat((String) response.rows()[1][0], is("192.168.1.3"));
979         assertThat((Long) response.rows()[1][1], is(1L));
980     }
981     @Test
982     public void testInsertAndSelectGeoType() throws Exception {
983         execute("create table geo_point_table (id int primary key, p geo_point) with (number_of_replicas=0)");
984         ensureYellow();
985         execute("insert into geo_point_table (id, p) values (?, ?)", new Object[]{1, new Double[]{47.22, 12.09}});
986         execute("insert into geo_point_table (id, p) values (?, ?)", new Object[]{2, new Double[]{57.22, 7.12}});
987         refresh();
988         execute("select p from geo_point_table order by id desc");
989         assertThat(response.rowCount(), is(2L));
990         Point p1 = (Point) response.rows()[0][0];
991         assertThat(p1.getX(), closeTo(57.22, 0.01));
992         assertThat(p1.getY(), closeTo(7.12, 0.01));
993         Point p2 = (Point) response.rows()[1][0];
994         assertThat(p2.getX(), closeTo(47.22, 0.01));
995         assertThat(p2.getY(), closeTo(12.09, 0.01));
996     }
997     @Test
998     public void testGeoTypeQueries() throws Exception {
999         execute("create table t (id int primary key, i int, p geo_point) " +
1000                 "clustered into 1 shards " +
1001                 "with (number_of_replicas=0)");
1002         ensureYellow();
1003         execute("insert into t (id, i, p) values (1, 1, 'POINT (10 20)')");
1004         execute("insert into t (id, i, p) values (2, 1, 'POINT (11 21)')");
1005         refresh();
1006         execute("select distance(p, 'POINT (11 21)') from t order by 1");
1007         assertThat(response.rowCount(), is(2L));
1008         Double result1 = (Double) response.rows()[0][0];
1009         Double result2 = (Double) response.rows()[1][0];
1010         assertThat(result1, is(0.0d));
1011         assertThat(result2, is(152354.32308347954));
1012         String stmtOrderBy = "SELECT id " +
1013                              "FROM t " +
1014                              "ORDER BY distance(p, 'POINT(30.0 30.0)')";
1015         execute(stmtOrderBy);
1016         assertThat(response.rowCount(), is(2L));
1017         String expectedOrderBy =
1018             "2\n" +
1019             "1\n";
1020         assertEquals(expectedOrderBy, printedTable(response.rows()));
1021         String stmtAggregate = "SELECT i, max(distance(p, 'POINT(30.0 30.0)')) " +
1022                                "FROM t " +
1023                                "GROUP BY i";
1024         execute(stmtAggregate);
1025         assertThat(response.rowCount(), is(1L));
1026         String expectedAggregate = "1| 2296582.8899438097\n";
1027         assertEquals(expectedAggregate, printedTable(response.rows()));
1028         Point point;
1029         execute("select p from t where distance(p, 'POINT (11 21)') &gt; 0.0");
1030         assertThat(response.rowCount(), is(1L));
1031         point = (Point) response.rows()[0][0];
1032         assertThat(point.getX(), closeTo(10.0d, 0.01));
1033         assertThat(point.getY(), closeTo(20.0d, 0.02));
1034         execute("select p from t where distance(p, 'POINT (11 21)') &lt; 10.0");
1035         assertThat(response.rowCount(), is(1L));
1036         point = (Point) response.rows()[0][0];
1037         assertThat(point.getX(), closeTo(11.0d, 0.01));
1038         assertThat(point.getY(), closeTo(21.0d, 0.01));
1039         execute("select p from t where distance(p, 'POINT (11 21)') &lt; 10.0 or distance(p, 'POINT (11 21)') &gt; 10.0");
1040         assertThat(response.rowCount(), is(2L));
1041         execute("select p from t where distance(p, 'POINT (10 20)') &gt;= 0.0 and distance(p, 'POINT (10 20)') &lt;= 0.1");
1042         assertThat(response.rowCount(), is(1L));
1043         point = (Point) response.rows()[0][0];
1044         assertThat(point.getX(), closeTo(10.0d, 0.01));
1045         assertThat(point.getY(), closeTo(20.0d, 0.01));
1046         execute("select p from t where distance(p, 'POINT (10 20)') = 0.0");
1047         assertThat(response.rowCount(), is(1L));
1048         point = (Point) response.rows()[0][0];
1049         assertThat(point.getX(), closeTo(10.0d, 0.01));
1050         assertThat(point.getY(), closeTo(20.0d, 0.01));
1051         execute("select p from t where distance(p, 'POINT (10 20)') = 152354.3209044634");
1052         Point p = (Point) response.rows()[0][0];
1053         assertThat(p.getX(), closeTo(11.0, 0.01));
1054         assertThat(p.getY(), closeTo(21.0, 0.01));
1055     }
1056     @Test
1057     @UseJdbc(0)     public void testWithinQuery() throws Exception {
1058         execute("create table t (id int primary key, p geo_point) " +
1059                 "clustered into 1 shards " +
1060                 "with (number_of_replicas=0)");
1061         ensureYellow();
1062         execute("insert into t (id, p) values (1, 'POINT (10 10)')");
1063         refresh();
1064         execute("select within(p, 'POLYGON (( 5 5, 30 5, 30 30, 5 30, 5 5 ))') from t");
1065         assertThat((Boolean) response.rows()[0][0], is(true));
1066         execute("select * from t where within(p, 'POLYGON (( 5 5, 30 5, 30 30, 5 30, 5 5 ))')");
1067         assertThat(response.rowCount(), is(1L));
1068         execute("select * from t where within(p, ?)", $(Map.of(
1069             "type", "Polygon",
1070             "coordinates", new double[][][]{
1071                 {
1072                     {5.0, 5.0},
1073                     {30.0, 5.0},
1074                     {30.0, 30.0},
1075                     {5.0, 30.0},
1076                     {5.0, 5.0}
1077                 }
1078             }
1079         )));
1080         assertThat(response.rowCount(), is(1L));
1081         execute("select * from t where within(p, 'POLYGON (( 5 5, 30 5, 30 30, 5 30, 5 5 ))') = false");
1082         assertThat(response.rowCount(), is(0L));
1083     }
1084     @Test
1085     public void testTwoSubStrOnSameColumn() throws Exception {
1086         execute("select substr(name, 0, 4), substr(name, 4, 8) from sys.cluster");
1087         assertThat(printedTable(response.rows()), is("SUIT| TE-TEST_\n"));
1088     }
1089     @Test
1090     public void testSelectArithMetricOperatorInOrderBy() throws Exception {
1091         execute("create table t (i integer, l long, d double) clustered into 3 shards with (number_of_replicas=0)");
1092         ensureYellow();
1093         execute("insert into t (i, l, d) values (1, 2, 90.5), (2, 5, 90.5), (193384, 31234594433, 99.0), (10, 21, 99.0), (-1, 4, 99.0)");
1094         refresh();
1095         execute("select i, i%3 from t order by i%3, l");
1096         assertThat(response.rowCount(), is(5L));
1097         assertThat(printedTable(response.rows()), is(
1098             "-1| -1\n" +
1099             "1| 1\n" +
1100             "10| 1\n" +
1101             "193384| 1\n" +
1102             "2| 2\n"));
1103     }
1104     @Test
1105     public void testSelectFailingSearchScript() throws Exception {
1106         execute("create table t (i integer, l long, d double) clustered into 1 shards with (number_of_replicas=0)");
1107         ensureYellow();
1108         execute("insert into t (i, l, d) values (1, 2, 90.5)");
1109         refresh();
1110         assertThrowsMatches(() -&gt; execute("select log(d, l) from t where log(d, -1) &gt;= 0"),
1111                      isSQLError(is("log(x, b): given arguments would result in: 'NaN'"),
1112                                 INTERNAL_ERROR,
1113                                 BAD_REQUEST,
1114                                 4000));
1115     }
1116     @Test
1117     public void testSelectGroupByFailingSearchScript() throws Exception {
1118         execute("create table t (i integer, l long, d double) with (number_of_replicas=0)");
1119         ensureYellow();
1120         execute("insert into t (i, l, d) values (1, 2, 90.5), (0, 4, 100)");
1121         execute("refresh table t");
1122         assertThrowsMatches(() -&gt; execute("select log(d, l) from t where log(d, -1) &gt;= 0 group by log(d, l)"),
1123                      isSQLError(is("log(x, b): given arguments would result in: 'NaN'"),
1124                                 INTERNAL_ERROR,
1125                                 BAD_REQUEST,
1126                                 4000));
1127     }
1128     @Test
1129     public void testNumericScriptOnAllTypes() {
1130         execute(
1131             "create table t (" +
1132             "   b byte," +
1133             "   s short," +
1134             "   i integer," +
1135             "   l long," +
1136             "   f float," +
1137             "   d double," +
1138             "   t timestamp with time zone" +
1139             ") with (number_of_replicas=0)");
1140         ensureYellow();
1141         execute("insert into t (b, s, i, l, f, d, t) values (1, 2, 3, 4, 5.7, 6.3, '2014-07-30')");
1142         refresh();
1143         String[] functionCalls = new String[]{
1144             "abs(%s)",
1145             "ceil(%s)",
1146             "floor(%s)",
1147             "ln(%s)",
1148             "log(%s)",
1149             "log(%s, 2)",
1150             "random()",
1151             "round(%s)",
1152             "sqrt(%s)"
1153         };
1154         for (String functionCall : functionCalls) {
1155             String byteCall = String.format(Locale.ENGLISH, functionCall, "b");
1156             execute(String.format(Locale.ENGLISH, "select %s, b from t where %s &lt; 2", byteCall, byteCall));
1157             String shortCall = String.format(Locale.ENGLISH, functionCall, "s");
1158             execute(String.format(Locale.ENGLISH, "select %s, s from t where %s &lt; 2", shortCall, shortCall));
1159             String intCall = String.format(Locale.ENGLISH, functionCall, "i");
1160             execute(String.format(Locale.ENGLISH, "select %s, i from t where %s &lt; 2", intCall, intCall));
1161             String longCall = String.format(Locale.ENGLISH, functionCall, "l");
1162             execute(String.format(Locale.ENGLISH, "select %s, l from t where %s &lt; 2", longCall, longCall));
1163             String floatCall = String.format(Locale.ENGLISH, functionCall, "f");
1164             execute(String.format(Locale.ENGLISH, "select %s, f from t where %s &lt; 2", floatCall, floatCall));
1165             String doubleCall = String.format(Locale.ENGLISH, functionCall, "d");
1166             execute(String.format(Locale.ENGLISH, "select %s, d from t where %s &lt; 2", doubleCall, doubleCall));
1167         }
1168     }
1169     @Test
1170     public void testWhereColumnEqColumnAndFunctionEqFunction() throws Exception {
1171         execute("create table tbl (name text)");
1172         execute("insert into tbl (name) values ('Arthur'), ('Trillian')");
1173         execute("refresh table tbl");
1174         execute("select name from tbl where name = name");
1175         assertThat(response.rowCount(), is(2L));
1176         execute("select name from tbl where substr(name, 1, 1) = substr(name, 1, 1)");
1177         assertThat(response.rowCount(), is(2L));
1178     }
1179     @Test
1180     public void testNewColumn() throws Exception {
1181         execute("create table t (name string) with (number_of_replicas=0, column_policy = 'dynamic')");
1182         execute("insert into t (name, score) values ('Ford', 1.2)");
1183     }
1184     @Test
1185     public void testESGetSourceColumns() throws Exception {
1186         this.setup.setUpLocations();
1187         ensureYellow();
1188         refresh();
1189         execute("select _id, _version from locations where id=2");
1190         assertNotNull(response.rows()[0][0]);
1191         assertNotNull(response.rows()[0][1]);
1192         execute("select _id, name from locations where id=2");
1193         assertNotNull(response.rows()[0][0]);
1194         assertNotNull(response.rows()[0][1]);
1195         execute("select _id, _doc from locations where id=2");
1196         assertNotNull(response.rows()[0][0]);
1197         assertNotNull(response.rows()[0][1]);
1198         execute("select _doc, id from locations where id in (2,3) order by id");
1199         Map&lt;String, Object&gt; _doc1 = (Map&lt;String, Object&gt;) response.rows()[0][0];
1200         Map&lt;String, Object&gt; _doc2 = (Map&lt;String, Object&gt;) response.rows()[1][0];
1201         assertEquals(_doc1.get("id"), "2");
1202         assertEquals(_doc2.get("id"), "3");
1203         execute("select name, kind from locations where id in (2,3) order by id");
1204         assertEquals(printedTable(response.rows()), "Outer Eastern Rim| Galaxy\n" +
1205                                                     "Galactic Sector QQ7 Active J Gamma| Galaxy\n");
1206         execute("select name, kind, _id from locations where id in (2,3) order by id");
1207         assertEquals(printedTable(response.rows()), "Outer Eastern Rim| Galaxy| 2\n" +
1208                                                     "Galactic Sector QQ7 Active J Gamma| Galaxy| 3\n");
1209         execute("select _raw, id from locations where id in (2,3) order by id");
1210         Map&lt;String, Object&gt; firstRaw = JsonXContent.JSON_XCONTENT.createParser(
1211             NamedXContentRegistry.EMPTY,
1212             DeprecationHandler.THROW_UNSUPPORTED_OPERATION,
1213             (String) response.rows()[0][0]).map();
1214         assertThat(response.rows()[0][1], is("2"));
1215         assertThat(firstRaw.get("id"), is("2"));
1216         assertThat(firstRaw.get("name"), is("Outer Eastern Rim"));
1217         assertThat(firstRaw.get("date"), is(308534400000L));
1218         assertThat(firstRaw.get("kind"), is("Galaxy"));
1219         Map&lt;String, Object&gt; secondRaw = JsonXContent.JSON_XCONTENT.createParser(
1220             NamedXContentRegistry.EMPTY,
1221             DeprecationHandler.THROW_UNSUPPORTED_OPERATION,
1222             (String) response.rows()[1][0]).map();
1223         assertThat(response.rows()[1][1], is("3"));
1224         assertThat(secondRaw.get("id"), is("3"));
1225         assertThat(secondRaw.get("name"), is("Galactic Sector QQ7 Active J Gamma"));
1226         assertThat(secondRaw.get("date"), is(1367366400000L));
1227         assertThat(secondRaw.get("kind"), is("Galaxy"));
1228     }
1229     @Test
1230     @UseRandomizedSchema(random = false)
1231     public void testUnknownTableJobGetsRemoved() throws Exception {
1232         String uniqueId = UUID.randomUUID().toString();
1233         String stmtStr = "select '" + uniqueId + "' from foobar";
1234         String stmtStrWhere = "select ''" + uniqueId + "'' from foobar";
1235         assertThrowsMatches(() -&gt; execute(stmtStr),
1236                      isSQLError(containsString("Relation 'foobar' unknown"),
1237                                 UNDEFINED_TABLE,
1238                                 NOT_FOUND,
1239                                 4041));
1240         execute("select stmt from sys.jobs where stmt='" + stmtStrWhere + "'");
1241         assertEquals(response.rowCount(), 0L);
1242     }
1243     @Test
1244     public void testInsertAndCopyHaveSameIdGeneration() throws Exception {
1245         execute("create table t (" +
1246                 "id1 long primary key," +
1247                 "id2 long primary key," +
1248                 "ts timestamp with time zone primary key," +
1249                 "n string) " +
1250                 "clustered by (id2)");
1251         ensureYellow();
1252         execute("insert into t (id1, id2, ts, n) values (176406344, 1825712027, 1433635200000, 'foo')");
1253         try {
1254             execute("insert into t (id1, id2, ts, n) values (176406344, 1825712027, 1433635200000, 'bar')");
1255             fail("should fail because document exists already");
1256         } catch (Exception e) {
1257         }
1258         execute("refresh table t");
1259         File file = folder.newFolder();
1260         String uriTemplate = Paths.get(file.toURI()).toUri().toString();
1261         execute("copy t to directory ?", new Object[]{uriTemplate});
1262         execute("copy t from ? with (shared=true)", new Object[]{uriTemplate + "/*"});
1263         execute("refresh table t");
1264         execute("select _id, * from t");
1265         assertThat(response.rowCount(), is(1L));
1266     }
1267     @Test
1268     public void testSelectFrom_Doc() throws Exception {
1269         execute("create table t (name string) with (number_of_replicas = 0)");
1270         ensureYellow();
1271         execute("insert into t (name) values ('Marvin')");
1272         execute("refresh table t");
1273         execute("select _doc['name'] from t");
1274         assertThat(((String) response.rows()[0][0]), is("Marvin"));
1275     }
1276     @Test
1277     public void testSelectWithSingleBulkArgRaisesUnsupportedError() {
1278         assertThrowsMatches(() -&gt;  execute("select * from sys.cluster", new Object[0][]),
1279                      isSQLError(is("Bulk operations for statements that return result sets is not supported"),
1280                                 INTERNAL_ERROR,
1281                                 BAD_REQUEST,
1282                                 4004));
1283     }
1284     @Test
1285     public void testSelectWithBulkArgsRaisesUnsupportedError() {
1286         assertThrowsMatches(() -&gt; execute("select * from sys.cluster", new Object[][]{new Object[]{1}, new Object[]{2}}),
1287                      isSQLError(is("Bulk operations for statements that return result sets is not supported"),
1288                                 INTERNAL_ERROR,
1289                                 BAD_REQUEST,
1290                                 4004));
1291     }
1292     @Test
1293     public void testWeirdIdentifiersAndLiterals() throws Exception {
1294         execute("CREATE TABLE with_quote (\"\"\"\" string) clustered into 1 shards with (number_of_replicas=0)");
1295         ensureYellow();
1296         execute("INSERT INTO with_quote (\"\"\"\") VALUES ('''')");
1297         execute("REFRESH TABLE with_quote");
1298         execute("SELECT * FROM with_quote");
1299         assertThat(response.rowCount(), is(1L));
1300         assertThat(response.cols(), is(arrayContaining("\"")));
1301         assertThat((String) response.rows()[0][0], is("'"));
1302     }
1303     @Test
1304     public void testWhereNotNull() throws Exception {
1305         execute("create table t (b boolean, i int) with (number_of_replicas=0)");
1306         execute("insert into t (b, i) values (true, 1), (false, 2), (null, null)");
1307         execute("refresh table t");
1308         execute("select b, not b, not (b &gt; i::boolean) from t order by b");
1309         Object[][] rows = response.rows();
1310         assertThat((Boolean) rows[0][0], is(false));
1311         assertThat((Boolean) rows[0][1], is(true));
1312         assertThat((Boolean) rows[0][2], is(true));
1313         assertThat((Boolean) rows[1][0], is(true));
1314         assertThat((Boolean) rows[1][1], is(false));
1315         assertThat((Boolean) rows[1][2], is(true));
1316         assertThat(rows[2][0], nullValue());
1317         assertThat(rows[2][1], nullValue());
1318         assertThat(rows[2][2], nullValue());
1319         execute("select b, i from t where not b");
1320         assertThat(response.rowCount(), is(1L));
1321         execute("select b, i from t where not b &gt; i::boolean");
1322         assertThat(response.rowCount(), is(2L));
1323         execute("SELECt b, i FROM t WHERE NOT (i = 1 AND b = TRUE)");
1324         assertThat(response.rowCount(), is(1L));
1325         execute("SELECT b, i FROM t WHERE NOT (i IS NULL OR b IS NULL)");
1326         assertThat(response.rowCount(), is(2L));
1327         execute("SELECT b FROM t WHERE NOT (coalesce(b, true))");
1328         assertThat(response.rowCount(), is(1L));
1329         execute("SELECT b, i FROM t WHERE NOT (coalesce(b, false) = true AND i IS NULL)");
1330         assertThat(response.rowCount(), is(2L));
1331     }
1332     @Test
1333     public void testScalarEvaluatesInErrorOnDocTable() throws Exception {
1334         execute("create table t1 (id int) with (number_of_replicas=0)");
1335         ensureYellow();
1336         execute("insert into t1 (id) values (1)");
1337         refresh();
1338         assertThrowsMatches(() -&gt; execute("select 1/0 from t1"),
1339                      isSQLError(is("/ by zero"),
1340                                 INTERNAL_ERROR,
1341                                 BAD_REQUEST,
1342                                 4000));
1343     }
1344     @Test
1345     public void testScalarEvaluatesInErrorOnDocTableNoMatch() throws Exception {
1346         execute("create table t1 (id int) with (number_of_replicas=0)");
1347         ensureYellow();
1348         execute("select 1/0 from t1 where true = false");
1349         assertThat(response.rowCount(), is(0L));
1350     }
1351     @Test
1352     public void testOrderByWorksOnSymbolWithLateNormalization() throws Exception {
1353         execute("create table t (x int) with (number_of_replicas = 0)");
1354         ensureYellow();
1355         execute("insert into t (x) values (5), (10), (3)");
1356         execute("refresh table t");
1357         execute("select cast((select 2) as integer) * x from t order by 1");
1358         assertThat(printedTable(response.rows()),
1359             is("6\n" +
1360                "10\n" +
1361                "20\n"));
1362     }
1363     @Test
1364     public void testOrderOnAnalyzedColumn() {
1365         execute("create table t (text string index using fulltext) with (number_of_replicas = 0)");
1366         execute("insert into t (text) values ('Hello World'), ('The End')");
1367         execute("refresh table t");
1368         assertThat(
1369             printedTable(execute("select text from t order by 1 desc").rows()),
1370             is("The End\n" +
1371                "Hello World\n")
1372         );
1373     }
1374     @Test
1375     public void test_values_as_top_level_relation() {
1376         execute("VALUES (1, 'a'), (2, 'b'), (3, (SELECT 'c'))");
1377         assertThat(
1378             printedTable(response.rows()),
1379             is("1| a\n" +
1380                "2| b\n" +
1381                "3| c\n")
1382         );
1383     }
1384     @Test
1385     public void test_select_with_explicit_high_limit_and_query_that_does_not_match_anything_to_trigger_batch_size_optimization() {
1386         execute("create table tbl (x int) clustered into 1 shards");
1387         Object[][] values = new Object[1001][];
1388         for (int i = 0; i &lt; values.length; i++) {
1389             values[i] = new Object[] { i };
1390         }
1391         execute("insert into tbl (x) values (?)", values);
1392         execute("refresh table tbl");
1393         execute("select x from tbl where x &gt; 5000 order by x limit 1500");
1394     }
1395     @Test
1396     public void test_select_from_virtual_table_with_window_function_and_column_pruning() throws Exception {
1397         execute("create table doc.metrics (id int primary key, x int)");
1398         execute("SELECT"
1399             + "    * "
1400             + " FROM ("
1401             + "     SELECT"
1402             + "         n.nspname,"
1403             + "         c.relname,"
1404             + "         a.attname,"
1405             + "         a.atttypid,"
1406             + "         a.attnotnull"
1407             + "         OR (t.typtype = 'd'"
1408             + "             AND t.typnotnull) AS attnotnull,"
1409             + "         a.atttypmod,"
1410             + "         a.attlen,"
1411             + "         row_number() OVER (PARTITION BY a.attrelid ORDER BY a.attnum) AS attnum,"
1412             + "         pg_catalog.pg_get_expr(def.adbin, def.adrelid) AS adsrc,"
1413             + "         dsc.description,"
1414             + "         t.typbasetype,"
1415             + "         t.typtype"
1416             + "     FROM"
1417             + "         pg_catalog.pg_namespace n"
1418             + "         JOIN pg_catalog.pg_class c ON (c.relnamespace = n.oid)"
1419             + "         JOIN pg_catalog.pg_attribute a ON (a.attrelid = c.oid)"
1420             + "         JOIN pg_catalog.pg_type t ON (a.atttypid = t.oid)"
1421             + "         LEFT JOIN pg_catalog.pg_attrdef def ON (a.attrelid = def.adrelid"
1422             + "                 AND a.attnum = def.adnum)"
1423             + "         LEFT JOIN pg_catalog.pg_description dsc ON (c.oid = dsc.objoid"
1424             + "                 AND a.attnum = dsc.objsubid)"
1425             + "         LEFT JOIN pg_catalog.pg_class dc ON (dc.oid = dsc.classoid"
1426             + "                 AND dc.relname = 'pg_class')"
1427             + "         LEFT JOIN pg_catalog.pg_namespace dn ON (dc.relnamespace = dn.oid"
1428             + "                 AND dn.nspname = 'pg_catalog')"
1429             + "     WHERE"
1430             + "         c.relkind IN ('r', 'v', 'f', 'm')"
1431             + "         AND a.attnum &gt; 0"
1432             + "         AND NOT a.attisdropped"
1433             + "         AND c.relname LIKE E'metrics') c"
1434             + " WHERE"
1435             + "     TRUE"
1436             + " ORDER BY"
1437             + "     nspname,"
1438             + "     c.relname,"
1439             + "     attnum");
1440         assertThat(printedTable(response.rows()),
1441             is("doc| metrics| id| 23| false| -1| 4| 1| NULL| NULL| 0| b\n" +
1442                "doc| metrics| x| 23| false| -1| 4| 2| NULL| NULL| 0| b\n")
1443         );
1444     }
1445     @Test
1446     public void test_subscript_on_ignored_object_does_not_raise_missing_key_error() throws Exception {
1447         execute("create table tbl (obj object (ignored))");
1448         execute("insert into tbl (obj) values ({a = 10})");
1449         execute("refresh table tbl");
1450         execute("select * from tbl where obj['b'] = 10");
1451         assertThat(printedTable(response.rows()), is(""));
1452         execute("select * from (select * from tbl) as t where obj['b'] = 10");
1453         assertThat(printedTable(response.rows()), is(""));
1454     }
1455     @Test
1456     public void test_primary_key_lookup_on_multiple_columns() throws Exception {
1457         execute(
1458             "CREATE TABLE doc.test (" +
1459             "   id TEXT, " +
1460             "   region_level_1 TEXT, " +
1461             "   marker_type TEXT, " +
1462             "   is_auto BOOLEAN," +
1463             "   PRIMARY KEY (id, region_level_1, marker_type, is_auto) " +
1464             ") clustered into 1 shards "
1465         );
1466         execute("insert into doc.test (id, region_level_1, marker_type, is_auto) values ('1', '2', '3', false)");
1467         execute("refresh table doc.test");
1468         execute("explain select id from doc.test where id = '1' and region_level_1 = '2' and marker_type = '3' and is_auto = false;");
1469         assertThat(printedTable(response.rows()), is(
1470             "Get[doc.test | id | DocKeys{'1', '2', '3', false} | ((((id = '1') AND (region_level_1 = '2')) AND (marker_type = '3')) AND (is_auto = false))]\n"
1471         ));
1472         execute("select id from doc.test where id = '1' and region_level_1 = '2' and marker_type = '3' and is_auto = false;");
1473         assertThat(printedTable(response.rows()), is(
1474             "1\n"
1475         ));
1476     }
1477     @Test
1478     public void test_primary_key_lookup_with_param_that_requires_cast_to_column_type() throws Exception {
1479         execute("create table tbl (ts timestamp with time zone primary key, path text primary key)");
1480         execute("INSERT INTO tbl (ts, path) VALUES ('2017-06-21T00:00:00.000000Z', 'c1')");
1481         execute("select _id, path from tbl where ts = '2017-06-21' and path = 'c1'");
1482         assertThat(printedTable(response.rows()), is(
1483             "Ag0xNDk4MDAzMjAwMDAwAmMx| c1\n"
1484         ));
1485         execute("select _id, path from tbl where ts = ? and path = ?", new Object[] { "2017-06-21", "c1" });
1486         assertThat(printedTable(response.rows()), is(
1487             "Ag0xNDk4MDAzMjAwMDAwAmMx| c1\n"
1488         ));
1489     }
1490     @Test
1491     public void test_primary_key_lookups_returns_inserted_records() throws Exception {
1492         int numKeys = randomIntBetween(1, 3);
1493         Random random = RandomizedContext.current().getRandom();
1494         StringBuilder createTable = new StringBuilder("CREATE TABLE tbl (");
1495         ArrayList&lt;DataType&lt;?&gt;&gt; types = new ArrayList&lt;&gt;();
1496         List&lt;DataType&lt;?&gt;&gt; typeCandidates = DataTypes.PRIMITIVE_TYPES.stream()
1497             .filter(x -&gt; x.storageSupport() != null)
1498             .collect(Collectors.toList());
1499         for (int i = 0; i &lt; numKeys; i++) {
1500             var type = RandomPicks.randomFrom(random, typeCandidates);
1501             types.add(type);
1502             createTable.append("col");
1503             createTable.append(i);
1504             createTable.append(' ');
1505             createTable.append(type.getName());
1506             createTable.append(" PRIMARY KEY");
1507             if (i + 1 &lt; numKeys) {
1508                 createTable.append(", ");
1509             }
1510         }
1511         createTable.append(")");
1512         execute(createTable.toString());
1513         String insert = "INSERT INTO tbl VALUES ("
1514             + String.join(", ", Lists2.map(types, ignored -&gt; "?"))
1515             + ")";
1516         Object[] args = new Object[types.size()];
1517         for (int i = 0; i &lt; types.size(); i++) {
1518             var type = types.get(i);
1519             args[i] = DataTypeTesting.getDataGenerator(type).get();
1520         }
1521         execute(insert, args);
1522         StringBuilder selectInlineValues = new StringBuilder("SELECT 1 FROM tbl WHERE ");
1523         StringBuilder selectParams = new StringBuilder("SELECT 1 FROM tbl WHERE ");
1524         for (int i = 0; i &lt; args.length; i++) {
1525             var arg = args[i];
1526             selectInlineValues.append("col");
1527             selectParams.append("col");
1528             selectInlineValues.append(i);
1529             selectParams.append(i);
1530             selectInlineValues.append(" = ");
1531             if (arg instanceof String) {
1532                 selectInlineValues.append("'");
1533                 selectInlineValues.append(arg);
1534                 selectInlineValues.append("'");
1535             } else {
1536                 selectInlineValues.append(arg);
1537             }
1538             selectParams.append(" = ?");
1539             if (i + 1 &lt; args.length) {
1540                 selectInlineValues.append(" AND ");
1541                 selectParams.append(" AND ");
1542             }
1543         }
1544         execute(selectParams.toString(), args);
1545         assertThat(
1546             selectParams.toString() + " with values " + Arrays.toString(args) + " must return a record",
1547             response.rowCount(),
1548             is(1L)
1549         );
1550         execute(selectInlineValues.toString());
1551         assertThat(
1552             selectInlineValues.toString() + " must return a record",
1553             response.rowCount(),
1554             is(1L)
1555         );
1556     }
1557     @Test
1558     public void test_query_then_fetch_result_order_of_all_columns_matches() throws Exception {
1559         int numItems = 40;
1560         Object[][] args = new Object[numItems][];
1561         for (int i = 0; i &lt; numItems; i++) {
1562             args[i] = new Object[] { Integer.toString(i), i };
1563         }
1564         execute("create table tbl (x text, y int) clustered into 2 shards");
1565         execute("insert into tbl (x, y) values (?, ?)", args);
1566         execute("refresh table tbl");
1567         Object[][] rows = execute("select x, y from tbl order by y desc").rows();
1568         assertThat(
1569             rows[0],
1570             Matchers.arrayContaining(Integer.toString(numItems - 1), numItems - 1)
1571         );
1572         assertThat(
1573             rows[1],
1574             Matchers.arrayContaining(Integer.toString(numItems - 2), numItems - 2)
1575         );
1576     }
1577     @Test
1578     @UseJdbc(0)
1579     @UseRandomizedSchema(random = false)
1580     public void test_bit_string_can_be_inserted_and_queried() throws Exception {
1581         execute("create table tbl (xs bit(4))");
1582         execute("insert into tbl (xs) values (B'0000'), (B'0001'), (B'0011'), (B'0111'), (B'1111'), (B'1001')");
1583         assertThat(response.rowCount(), is(6L));
1584         execute("refresh table tbl");
1585         execute("SELECT _doc['xs'], xs, _raw, xs::bit(3) FROM tbl WHERE xs = B'1001'");
1586         assertThat(TestingHelpers.printedTable(response.rows()), is(
1587             "B'1001'| B'1001'| {\"xs\":\"CQ==\"}| B'100'\n"
1588         ));
1589         execute("SELECT _doc['xs'], xs, _raw, xs::bit(3) FROM tbl WHERE xs = B'1001' LIMIT 1");
1590         assertThat(TestingHelpers.printedTable(response.rows()), is(
1591             "B'1001'| B'1001'| {\"xs\":\"CQ==\"}| B'100'\n"
1592         ));
1593         var properties = new Properties();
1594         properties.put("user", "crate");
1595         properties.put("password", "");
1596         ArrayList&lt;String&gt; results = new ArrayList&lt;&gt;();
1597         try (var conn = DriverManager.getConnection(sqlExecutor.jdbcUrl(), properties)) {
1598             Statement stmt = conn.createStatement();
1599             ResultSet result = stmt.executeQuery("select xs from tbl order by xs");
1600             while (result.next()) {
1601                 String string = result.getString(1);
1602                 results.add(string);
1603             }
1604         }
1605         assertThat(results, Matchers.contains(
1606             "B'0000'",
1607             "B'0001'",
1608             "B'0011'",
1609             "B'0111'",
1610             "B'1001'",
1611             "B'1111'"
1612         ));
1613     }
1614     @Test
1615     public void test_can_insert_and_select_bit_string_arrays() throws Exception {
1616         execute("create table tbl (xs array(bit(3)))");
1617         execute("insert into tbl (xs) values ([B'010', B'110'])");
1618         execute("refresh table tbl");
1619         execute("select xs from tbl");
1620         assertThat(TestingHelpers.printedTable(response.rows()), is(
1621             "[B'010', B'110']\n"
1622         ));
1623     }
1624     @Test
1625     public void test_can_select_and_order_by_doc_expression() throws Exception {
1626         execute("create table tbl (x int)");
1627         execute("insert into tbl (x) values (1), (2), (3)");
1628         execute("refresh table tbl");
1629         execute("select _doc['x'] from tbl order by 1");
1630         assertThat(printedTable(response.rows()), is(
1631             "1\n" +
1632             "2\n" +
1633             "3\n"
1634         ));
1635     }
1636     @Test
1637     public void test_can_use_object_with_inner_column_containing_spaces_and_quotes() {
1638         execute("CREATE TABLE t1 (o object as (\"my first \"\" field\" text))");
1639         execute("INSERT INTO t1 (o) VALUES ({\"my first \"\" field\" = 'foo'})");
1640         refresh();
1641         execute("SELECT o FROM t1");
1642         assertThat(printedTable(response.rows()), Matchers.is("{my first \" field=foo}\n"));
1643         execute("SELECT o['my first \" field'] FROM t1");
1644         assertThat(printedTable(response.rows()), Matchers.is("foo\n"));
1645     }
1646     @Test
1647     public void test_subcolumn_can_contain_brackets_in_inserts() {
1648         execute("create table doc.obj (obj OBJECT);");
1649         execute("insert into doc.obj (obj) VALUES ('{\"(\": 1.0}');");
1650         execute("insert into doc.obj (obj) VALUES ('{\"(\": 1.0}');");
1651         refresh();
1652         execute("SELECT count(*) FROM doc.obj");
1653         assertThat(printedTable(response.rows()), Matchers.is("2\n"));
1654         execute("SELECT obj FROM doc.obj limit 1");
1655         assertThat(printedTable(response.rows()), Matchers.is("{(=1.0}\n"));
1656     }
1657     @Test
1658     public void test_double_quotes_in_column_names_and_insert_values() {
1659         execute("create table doc.test (\"\"\"\" text);");
1660         execute("insert into doc.test VALUES ('\"\"')");
1661         refresh();
1662         execute("SELECT \"\"\"\" FROM doc.test");
1663         assertThat(printedTable(response.rows()), Matchers.is("\"\"\n"));
1664     }
1665 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
